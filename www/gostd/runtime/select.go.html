<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html" class="current">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1598481">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1598536">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1598590">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1598641">package</span>&nbsp;<span class="ident" id="1598649">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1598658">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598725">import</span>&nbsp;<span class="string" id="1598732">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1598742">const</span>&nbsp;<span class="op" id="1598748">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598751">debugSelect</span>&nbsp;<span class="op" id="1598763">=</span>&nbsp;<span class="builtintype" id="1598765">false</span><br>
<span class="lineno"></span><span class="op" id="1598771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1598774">var</span>&nbsp;<span class="op" id="1598778">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598781">chansendpc</span>&nbsp;<span class="op" id="1598792">=</span>&nbsp;<span class="ident" id="1598794">funcPC</span><span class="op" id="1598800">(</span><span class="ident" id="1598801">chansend</span><span class="op" id="1598809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598812">chanrecvpc</span>&nbsp;<span class="op" id="1598823">=</span>&nbsp;<span class="ident" id="1598825">funcPC</span><span class="op" id="1598831">(</span><span class="ident" id="1598832">chanrecv</span><span class="op" id="1598840">)</span><br>
<span class="lineno"></span><span class="op" id="1598842">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1598845">func</span>&nbsp;<span class="ident" id="1598850">selectsize</span><span class="op" id="1598860">(</span><span class="ident" id="1598861">size</span>&nbsp;<span class="builtintype" id="1598866">uintptr</span><span class="op" id="1598873">)</span>&nbsp;<span class="builtintype" id="1598875">uintptr</span>&nbsp;<span class="op" id="1598883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598886">selsize</span>&nbsp;<span class="op" id="1598894">:=</span>&nbsp;<span class="ident" id="1598897">unsafe</span><span class="op" id="1598903">.</span><span class="ident" id="1598904">Sizeof</span><span class="op" id="1598910">(</span><span class="ident" id="1598911">_select</span><span class="op" id="1598918">{</span><span class="op" id="1598919">}</span><span class="op" id="1598920">)</span>&nbsp;<span class="op" id="1598922">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1598926">(</span><span class="ident" id="1598927">size</span><span class="op" id="1598931">-</span><span class="num" id="1598932">1</span><span class="op" id="1598933">)</span><span class="op" id="1598934">*</span><span class="ident" id="1598935">unsafe</span><span class="op" id="1598941">.</span><span class="ident" id="1598942">Sizeof</span><span class="op" id="1598948">(</span><span class="ident" id="1598949">_select</span><span class="op" id="1598956">{</span><span class="op" id="1598957">}</span><span class="op" id="1598958">.</span><span class="ident" id="1598959">scase</span><span class="op" id="1598964">[</span><span class="num" id="1598965">0</span><span class="op" id="1598966">]</span><span class="op" id="1598967">)</span>&nbsp;<span class="op" id="1598969">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598973">size</span><span class="op" id="1598977">*</span><span class="ident" id="1598978">unsafe</span><span class="op" id="1598984">.</span><span class="ident" id="1598985">Sizeof</span><span class="op" id="1598991">(</span><span class="op" id="1598992">*</span><span class="ident" id="1598993">_select</span><span class="op" id="1599000">{</span><span class="op" id="1599001">}</span><span class="op" id="1599002">.</span><span class="ident" id="1599003">lockorder</span><span class="op" id="1599012">)</span>&nbsp;<span class="op" id="1599014">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599018">size</span><span class="op" id="1599022">*</span><span class="ident" id="1599023">unsafe</span><span class="op" id="1599029">.</span><span class="ident" id="1599030">Sizeof</span><span class="op" id="1599036">(</span><span class="op" id="1599037">*</span><span class="ident" id="1599038">_select</span><span class="op" id="1599045">{</span><span class="op" id="1599046">}</span><span class="op" id="1599047">.</span><span class="ident" id="1599048">pollorder</span><span class="op" id="1599057">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599060">return</span>&nbsp;<span class="ident" id="1599067">round</span><span class="op" id="1599072">(</span><span class="ident" id="1599073">selsize</span><span class="op" id="1599080">,</span>&nbsp;<span class="ident" id="1599082">_Int64Align</span><span class="op" id="1599093">)</span><br>
<span class="lineno"></span><span class="op" id="1599095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599098">func</span>&nbsp;<span class="ident" id="1599103">newselect</span><span class="op" id="1599112">(</span><span class="ident" id="1599113">sel</span>&nbsp;<span class="op" id="1599117">*</span><span class="ident" id="1599118">_select</span><span class="op" id="1599125">,</span>&nbsp;<span class="ident" id="1599127">selsize</span>&nbsp;<span class="builtintype" id="1599135">int64</span><span class="op" id="1599140">,</span>&nbsp;<span class="ident" id="1599142">size</span>&nbsp;<span class="builtintype" id="1599147">int32</span><span class="op" id="1599152">)</span>&nbsp;<span class="op" id="1599154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599157">if</span>&nbsp;<span class="ident" id="1599160">selsize</span>&nbsp;<span class="op" id="1599168">!=</span>&nbsp;<span class="builtintype" id="1599171">int64</span><span class="op" id="1599176">(</span><span class="ident" id="1599177">selectsize</span><span class="op" id="1599187">(</span><span class="builtintype" id="1599188">uintptr</span><span class="op" id="1599195">(</span><span class="ident" id="1599196">size</span><span class="op" id="1599200">)</span><span class="op" id="1599201">)</span><span class="op" id="1599202">)</span>&nbsp;<span class="op" id="1599204">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1599208">print</span><span class="op" id="1599213">(</span><span class="string" id="1599214">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1599241">,</span>&nbsp;<span class="ident" id="1599243">selsize</span><span class="op" id="1599250">,</span>&nbsp;<span class="string" id="1599252">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1599261">,</span>&nbsp;<span class="ident" id="1599263">selectsize</span><span class="op" id="1599273">(</span><span class="builtintype" id="1599274">uintptr</span><span class="op" id="1599281">(</span><span class="ident" id="1599282">size</span><span class="op" id="1599286">)</span><span class="op" id="1599287">)</span><span class="op" id="1599288">,</span>&nbsp;<span class="string" id="1599290">&#34;\n&#34;</span><span class="op" id="1599294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599298">gothrow</span><span class="op" id="1599305">(</span><span class="string" id="1599306">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1599323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599329">sel</span><span class="op" id="1599332">.</span><span class="ident" id="1599333">tcase</span>&nbsp;<span class="op" id="1599339">=</span>&nbsp;<span class="builtintype" id="1599341">uint16</span><span class="op" id="1599347">(</span><span class="ident" id="1599348">size</span><span class="op" id="1599352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599355">sel</span><span class="op" id="1599358">.</span><span class="ident" id="1599359">ncase</span>&nbsp;<span class="op" id="1599365">=</span>&nbsp;<span class="num" id="1599367">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599370">sel</span><span class="op" id="1599373">.</span><span class="ident" id="1599374">lockorder</span>&nbsp;<span class="op" id="1599384">=</span>&nbsp;<span class="op" id="1599386">(</span><span class="op" id="1599387">*</span><span class="op" id="1599388">*</span><span class="ident" id="1599389">hchan</span><span class="op" id="1599394">)</span><span class="op" id="1599395">(</span><span class="ident" id="1599396">add</span><span class="op" id="1599399">(</span><span class="ident" id="1599400">unsafe</span><span class="op" id="1599406">.</span><span class="ident" id="1599407">Pointer</span><span class="op" id="1599414">(</span><span class="op" id="1599415">&amp;</span><span class="ident" id="1599416">sel</span><span class="op" id="1599419">.</span><span class="ident" id="1599420">scase</span><span class="op" id="1599425">)</span><span class="op" id="1599426">,</span>&nbsp;<span class="builtintype" id="1599428">uintptr</span><span class="op" id="1599435">(</span><span class="ident" id="1599436">size</span><span class="op" id="1599440">)</span><span class="op" id="1599441">*</span><span class="ident" id="1599442">unsafe</span><span class="op" id="1599448">.</span><span class="ident" id="1599449">Sizeof</span><span class="op" id="1599455">(</span><span class="ident" id="1599456">_select</span><span class="op" id="1599463">{</span><span class="op" id="1599464">}</span><span class="op" id="1599465">.</span><span class="ident" id="1599466">scase</span><span class="op" id="1599471">[</span><span class="num" id="1599472">0</span><span class="op" id="1599473">]</span><span class="op" id="1599474">)</span><span class="op" id="1599475">)</span><span class="op" id="1599476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599479">sel</span><span class="op" id="1599482">.</span><span class="ident" id="1599483">pollorder</span>&nbsp;<span class="op" id="1599493">=</span>&nbsp;<span class="op" id="1599495">(</span><span class="op" id="1599496">*</span><span class="builtintype" id="1599497">uint16</span><span class="op" id="1599503">)</span><span class="op" id="1599504">(</span><span class="ident" id="1599505">add</span><span class="op" id="1599508">(</span><span class="ident" id="1599509">unsafe</span><span class="op" id="1599515">.</span><span class="ident" id="1599516">Pointer</span><span class="op" id="1599523">(</span><span class="ident" id="1599524">sel</span><span class="op" id="1599527">.</span><span class="ident" id="1599528">lockorder</span><span class="op" id="1599537">)</span><span class="op" id="1599538">,</span>&nbsp;<span class="builtintype" id="1599540">uintptr</span><span class="op" id="1599547">(</span><span class="ident" id="1599548">size</span><span class="op" id="1599552">)</span><span class="op" id="1599553">*</span><span class="ident" id="1599554">unsafe</span><span class="op" id="1599560">.</span><span class="ident" id="1599561">Sizeof</span><span class="op" id="1599567">(</span><span class="op" id="1599568">*</span><span class="ident" id="1599569">_select</span><span class="op" id="1599576">{</span><span class="op" id="1599577">}</span><span class="op" id="1599578">.</span><span class="ident" id="1599579">lockorder</span><span class="op" id="1599588">)</span><span class="op" id="1599589">)</span><span class="op" id="1599590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599594">if</span>&nbsp;<span class="ident" id="1599597">debugSelect</span>&nbsp;<span class="op" id="1599609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1599613">print</span><span class="op" id="1599618">(</span><span class="string" id="1599619">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1599633">,</span>&nbsp;<span class="ident" id="1599635">sel</span><span class="op" id="1599638">,</span>&nbsp;<span class="string" id="1599640">&#34;&nbsp;size=&#34;</span><span class="op" id="1599648">,</span>&nbsp;<span class="ident" id="1599650">size</span><span class="op" id="1599654">,</span>&nbsp;<span class="string" id="1599656">&#34;\n&#34;</span><span class="op" id="1599660">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599663">}</span><br>
<span class="lineno"></span><span class="op" id="1599665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1599668">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1599681">func</span>&nbsp;<span class="ident" id="1599686">selectsend</span><span class="op" id="1599696">(</span><span class="ident" id="1599697">sel</span>&nbsp;<span class="op" id="1599701">*</span><span class="ident" id="1599702">_select</span><span class="op" id="1599709">,</span>&nbsp;<span class="ident" id="1599711">c</span>&nbsp;<span class="op" id="1599713">*</span><span class="ident" id="1599714">hchan</span><span class="op" id="1599719">,</span>&nbsp;<span class="ident" id="1599721">elem</span>&nbsp;<span class="ident" id="1599726">unsafe</span><span class="op" id="1599732">.</span><span class="ident" id="1599733">Pointer</span><span class="op" id="1599740">)</span>&nbsp;<span class="op" id="1599742">(</span><span class="ident" id="1599743">selected</span>&nbsp;<span class="builtintype" id="1599752">bool</span><span class="op" id="1599756">)</span>&nbsp;<span class="op" id="1599758">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599761">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599790">if</span>&nbsp;<span class="ident" id="1599793">c</span>&nbsp;<span class="op" id="1599795">!=</span>&nbsp;<span class="builtintype" id="1599798">nil</span>&nbsp;<span class="op" id="1599802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599806">selectsendImpl</span><span class="op" id="1599820">(</span><span class="ident" id="1599821">sel</span><span class="op" id="1599824">,</span>&nbsp;<span class="ident" id="1599826">c</span><span class="op" id="1599827">,</span>&nbsp;<span class="ident" id="1599829">getcallerpc</span><span class="op" id="1599840">(</span><span class="ident" id="1599841">unsafe</span><span class="op" id="1599847">.</span><span class="ident" id="1599848">Pointer</span><span class="op" id="1599855">(</span><span class="op" id="1599856">&amp;</span><span class="ident" id="1599857">sel</span><span class="op" id="1599860">)</span><span class="op" id="1599861">)</span><span class="op" id="1599862">,</span>&nbsp;<span class="ident" id="1599864">elem</span><span class="op" id="1599868">,</span>&nbsp;<span class="builtintype" id="1599870">uintptr</span><span class="op" id="1599877">(</span><span class="ident" id="1599878">unsafe</span><span class="op" id="1599884">.</span><span class="ident" id="1599885">Pointer</span><span class="op" id="1599892">(</span><span class="op" id="1599893">&amp;</span><span class="ident" id="1599894">selected</span><span class="op" id="1599902">)</span><span class="op" id="1599903">)</span><span class="op" id="1599904">-</span><span class="builtintype" id="1599905">uintptr</span><span class="op" id="1599912">(</span><span class="ident" id="1599913">unsafe</span><span class="op" id="1599919">.</span><span class="ident" id="1599920">Pointer</span><span class="op" id="1599927">(</span><span class="op" id="1599928">&amp;</span><span class="ident" id="1599929">sel</span><span class="op" id="1599932">)</span><span class="op" id="1599933">)</span><span class="op" id="1599934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599940">return</span><br>
<span class="lineno">50</span><span class="op" id="1599947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1599950">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1599997">func</span>&nbsp;<span class="ident" id="1600002">selectsendImpl</span><span class="op" id="1600016">(</span><span class="ident" id="1600017">sel</span>&nbsp;<span class="op" id="1600021">*</span><span class="ident" id="1600022">_select</span><span class="op" id="1600029">,</span>&nbsp;<span class="ident" id="1600031">c</span>&nbsp;<span class="op" id="1600033">*</span><span class="ident" id="1600034">hchan</span><span class="op" id="1600039">,</span>&nbsp;<span class="ident" id="1600041">pc</span>&nbsp;<span class="builtintype" id="1600044">uintptr</span><span class="op" id="1600051">,</span>&nbsp;<span class="ident" id="1600053">elem</span>&nbsp;<span class="ident" id="1600058">unsafe</span><span class="op" id="1600064">.</span><span class="ident" id="1600065">Pointer</span><span class="op" id="1600072">,</span>&nbsp;<span class="ident" id="1600074">so</span>&nbsp;<span class="builtintype" id="1600077">uintptr</span><span class="op" id="1600084">)</span>&nbsp;<span class="op" id="1600086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600089">i</span>&nbsp;<span class="op" id="1600091">:=</span>&nbsp;<span class="ident" id="1600094">sel</span><span class="op" id="1600097">.</span><span class="ident" id="1600098">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600105">if</span>&nbsp;<span class="ident" id="1600108">i</span>&nbsp;<span class="op" id="1600110">&gt;=</span>&nbsp;<span class="ident" id="1600113">sel</span><span class="op" id="1600116">.</span><span class="ident" id="1600117">tcase</span>&nbsp;<span class="op" id="1600123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600127">gothrow</span><span class="op" id="1600134">(</span><span class="string" id="1600135">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1600163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600169">sel</span><span class="op" id="1600172">.</span><span class="ident" id="1600173">ncase</span>&nbsp;<span class="op" id="1600179">=</span>&nbsp;<span class="ident" id="1600181">i</span>&nbsp;<span class="op" id="1600183">+</span>&nbsp;<span class="num" id="1600185">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600188">cas</span>&nbsp;<span class="op" id="1600192">:=</span>&nbsp;<span class="op" id="1600195">(</span><span class="op" id="1600196">*</span><span class="ident" id="1600197">scase</span><span class="op" id="1600202">)</span><span class="op" id="1600203">(</span><span class="ident" id="1600204">add</span><span class="op" id="1600207">(</span><span class="ident" id="1600208">unsafe</span><span class="op" id="1600214">.</span><span class="ident" id="1600215">Pointer</span><span class="op" id="1600222">(</span><span class="op" id="1600223">&amp;</span><span class="ident" id="1600224">sel</span><span class="op" id="1600227">.</span><span class="ident" id="1600228">scase</span><span class="op" id="1600233">)</span><span class="op" id="1600234">,</span>&nbsp;<span class="builtintype" id="1600236">uintptr</span><span class="op" id="1600243">(</span><span class="ident" id="1600244">i</span><span class="op" id="1600245">)</span><span class="op" id="1600246">*</span><span class="ident" id="1600247">unsafe</span><span class="op" id="1600253">.</span><span class="ident" id="1600254">Sizeof</span><span class="op" id="1600260">(</span><span class="ident" id="1600261">sel</span><span class="op" id="1600264">.</span><span class="ident" id="1600265">scase</span><span class="op" id="1600270">[</span><span class="num" id="1600271">0</span><span class="op" id="1600272">]</span><span class="op" id="1600273">)</span><span class="op" id="1600274">)</span><span class="op" id="1600275">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600279">cas</span><span class="op" id="1600282">.</span><span class="ident" id="1600283">pc</span>&nbsp;<span class="op" id="1600286">=</span>&nbsp;<span class="ident" id="1600288">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600292">cas</span><span class="op" id="1600295">.</span><span class="ident" id="1600296">_chan</span>&nbsp;<span class="op" id="1600302">=</span>&nbsp;<span class="ident" id="1600304">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600307">cas</span><span class="op" id="1600310">.</span><span class="ident" id="1600311">so</span>&nbsp;<span class="op" id="1600314">=</span>&nbsp;<span class="builtintype" id="1600316">uint16</span><span class="op" id="1600322">(</span><span class="ident" id="1600323">so</span><span class="op" id="1600325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600328">cas</span><span class="op" id="1600331">.</span><span class="ident" id="1600332">kind</span>&nbsp;<span class="op" id="1600337">=</span>&nbsp;<span class="ident" id="1600339">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600350">cas</span><span class="op" id="1600353">.</span><span class="ident" id="1600354">elem</span>&nbsp;<span class="op" id="1600359">=</span>&nbsp;<span class="ident" id="1600361">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600368">if</span>&nbsp;<span class="ident" id="1600371">debugSelect</span>&nbsp;<span class="op" id="1600383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1600387">print</span><span class="op" id="1600392">(</span><span class="string" id="1600393">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1600408">,</span>&nbsp;<span class="ident" id="1600410">sel</span><span class="op" id="1600413">,</span>&nbsp;<span class="string" id="1600415">&#34;&nbsp;pc=&#34;</span><span class="op" id="1600421">,</span>&nbsp;<span class="ident" id="1600423">hex</span><span class="op" id="1600426">(</span><span class="ident" id="1600427">cas</span><span class="op" id="1600430">.</span><span class="ident" id="1600431">pc</span><span class="op" id="1600433">)</span><span class="op" id="1600434">,</span>&nbsp;<span class="string" id="1600436">&#34;&nbsp;chan=&#34;</span><span class="op" id="1600444">,</span>&nbsp;<span class="ident" id="1600446">cas</span><span class="op" id="1600449">.</span><span class="ident" id="1600450">_chan</span><span class="op" id="1600455">,</span>&nbsp;<span class="string" id="1600457">&#34;&nbsp;so=&#34;</span><span class="op" id="1600463">,</span>&nbsp;<span class="ident" id="1600465">cas</span><span class="op" id="1600468">.</span><span class="ident" id="1600469">so</span><span class="op" id="1600471">,</span>&nbsp;<span class="string" id="1600473">&#34;\n&#34;</span><span class="op" id="1600477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600480">}</span><br>
<span class="lineno">70</span><span class="op" id="1600482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1600485">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1600498">func</span>&nbsp;<span class="ident" id="1600503">selectrecv</span><span class="op" id="1600513">(</span><span class="ident" id="1600514">sel</span>&nbsp;<span class="op" id="1600518">*</span><span class="ident" id="1600519">_select</span><span class="op" id="1600526">,</span>&nbsp;<span class="ident" id="1600528">c</span>&nbsp;<span class="op" id="1600530">*</span><span class="ident" id="1600531">hchan</span><span class="op" id="1600536">,</span>&nbsp;<span class="ident" id="1600538">elem</span>&nbsp;<span class="ident" id="1600543">unsafe</span><span class="op" id="1600549">.</span><span class="ident" id="1600550">Pointer</span><span class="op" id="1600557">)</span>&nbsp;<span class="op" id="1600559">(</span><span class="ident" id="1600560">selected</span>&nbsp;<span class="builtintype" id="1600569">bool</span><span class="op" id="1600573">)</span>&nbsp;<span class="op" id="1600575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600578">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600607">if</span>&nbsp;<span class="ident" id="1600610">c</span>&nbsp;<span class="op" id="1600612">!=</span>&nbsp;<span class="builtintype" id="1600615">nil</span>&nbsp;<span class="op" id="1600619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600623">selectrecvImpl</span><span class="op" id="1600637">(</span><span class="ident" id="1600638">sel</span><span class="op" id="1600641">,</span>&nbsp;<span class="ident" id="1600643">c</span><span class="op" id="1600644">,</span>&nbsp;<span class="ident" id="1600646">getcallerpc</span><span class="op" id="1600657">(</span><span class="ident" id="1600658">unsafe</span><span class="op" id="1600664">.</span><span class="ident" id="1600665">Pointer</span><span class="op" id="1600672">(</span><span class="op" id="1600673">&amp;</span><span class="ident" id="1600674">sel</span><span class="op" id="1600677">)</span><span class="op" id="1600678">)</span><span class="op" id="1600679">,</span>&nbsp;<span class="ident" id="1600681">elem</span><span class="op" id="1600685">,</span>&nbsp;<span class="builtintype" id="1600687">nil</span><span class="op" id="1600690">,</span>&nbsp;<span class="builtintype" id="1600692">uintptr</span><span class="op" id="1600699">(</span><span class="ident" id="1600700">unsafe</span><span class="op" id="1600706">.</span><span class="ident" id="1600707">Pointer</span><span class="op" id="1600714">(</span><span class="op" id="1600715">&amp;</span><span class="ident" id="1600716">selected</span><span class="op" id="1600724">)</span><span class="op" id="1600725">)</span><span class="op" id="1600726">-</span><span class="builtintype" id="1600727">uintptr</span><span class="op" id="1600734">(</span><span class="ident" id="1600735">unsafe</span><span class="op" id="1600741">.</span><span class="ident" id="1600742">Pointer</span><span class="op" id="1600749">(</span><span class="op" id="1600750">&amp;</span><span class="ident" id="1600751">sel</span><span class="op" id="1600754">)</span><span class="op" id="1600755">)</span><span class="op" id="1600756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600762">return</span><br>
<span class="lineno"></span><span class="op" id="1600769">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1600772">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1600785">func</span>&nbsp;<span class="ident" id="1600790">selectrecv2</span><span class="op" id="1600801">(</span><span class="ident" id="1600802">sel</span>&nbsp;<span class="op" id="1600806">*</span><span class="ident" id="1600807">_select</span><span class="op" id="1600814">,</span>&nbsp;<span class="ident" id="1600816">c</span>&nbsp;<span class="op" id="1600818">*</span><span class="ident" id="1600819">hchan</span><span class="op" id="1600824">,</span>&nbsp;<span class="ident" id="1600826">elem</span>&nbsp;<span class="ident" id="1600831">unsafe</span><span class="op" id="1600837">.</span><span class="ident" id="1600838">Pointer</span><span class="op" id="1600845">,</span>&nbsp;<span class="ident" id="1600847">received</span>&nbsp;<span class="op" id="1600856">*</span><span class="builtintype" id="1600857">bool</span><span class="op" id="1600861">)</span>&nbsp;<span class="op" id="1600863">(</span><span class="ident" id="1600864">selected</span>&nbsp;<span class="builtintype" id="1600873">bool</span><span class="op" id="1600877">)</span>&nbsp;<span class="op" id="1600879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600882">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600911">if</span>&nbsp;<span class="ident" id="1600914">c</span>&nbsp;<span class="op" id="1600916">!=</span>&nbsp;<span class="builtintype" id="1600919">nil</span>&nbsp;<span class="op" id="1600923">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600927">selectrecvImpl</span><span class="op" id="1600941">(</span><span class="ident" id="1600942">sel</span><span class="op" id="1600945">,</span>&nbsp;<span class="ident" id="1600947">c</span><span class="op" id="1600948">,</span>&nbsp;<span class="ident" id="1600950">getcallerpc</span><span class="op" id="1600961">(</span><span class="ident" id="1600962">unsafe</span><span class="op" id="1600968">.</span><span class="ident" id="1600969">Pointer</span><span class="op" id="1600976">(</span><span class="op" id="1600977">&amp;</span><span class="ident" id="1600978">sel</span><span class="op" id="1600981">)</span><span class="op" id="1600982">)</span><span class="op" id="1600983">,</span>&nbsp;<span class="ident" id="1600985">elem</span><span class="op" id="1600989">,</span>&nbsp;<span class="ident" id="1600991">received</span><span class="op" id="1600999">,</span>&nbsp;<span class="builtintype" id="1601001">uintptr</span><span class="op" id="1601008">(</span><span class="ident" id="1601009">unsafe</span><span class="op" id="1601015">.</span><span class="ident" id="1601016">Pointer</span><span class="op" id="1601023">(</span><span class="op" id="1601024">&amp;</span><span class="ident" id="1601025">selected</span><span class="op" id="1601033">)</span><span class="op" id="1601034">)</span><span class="op" id="1601035">-</span><span class="builtintype" id="1601036">uintptr</span><span class="op" id="1601043">(</span><span class="ident" id="1601044">unsafe</span><span class="op" id="1601050">.</span><span class="ident" id="1601051">Pointer</span><span class="op" id="1601058">(</span><span class="op" id="1601059">&amp;</span><span class="ident" id="1601060">sel</span><span class="op" id="1601063">)</span><span class="op" id="1601064">)</span><span class="op" id="1601065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601071">return</span><br>
<span class="lineno"></span><span class="op" id="1601078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1601081">func</span>&nbsp;<span class="ident" id="1601086">selectrecvImpl</span><span class="op" id="1601100">(</span><span class="ident" id="1601101">sel</span>&nbsp;<span class="op" id="1601105">*</span><span class="ident" id="1601106">_select</span><span class="op" id="1601113">,</span>&nbsp;<span class="ident" id="1601115">c</span>&nbsp;<span class="op" id="1601117">*</span><span class="ident" id="1601118">hchan</span><span class="op" id="1601123">,</span>&nbsp;<span class="ident" id="1601125">pc</span>&nbsp;<span class="builtintype" id="1601128">uintptr</span><span class="op" id="1601135">,</span>&nbsp;<span class="ident" id="1601137">elem</span>&nbsp;<span class="ident" id="1601142">unsafe</span><span class="op" id="1601148">.</span><span class="ident" id="1601149">Pointer</span><span class="op" id="1601156">,</span>&nbsp;<span class="ident" id="1601158">received</span>&nbsp;<span class="op" id="1601167">*</span><span class="builtintype" id="1601168">bool</span><span class="op" id="1601172">,</span>&nbsp;<span class="ident" id="1601174">so</span>&nbsp;<span class="builtintype" id="1601177">uintptr</span><span class="op" id="1601184">)</span>&nbsp;<span class="op" id="1601186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601189">i</span>&nbsp;<span class="op" id="1601191">:=</span>&nbsp;<span class="ident" id="1601194">sel</span><span class="op" id="1601197">.</span><span class="ident" id="1601198">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601205">if</span>&nbsp;<span class="ident" id="1601208">i</span>&nbsp;<span class="op" id="1601210">&gt;=</span>&nbsp;<span class="ident" id="1601213">sel</span><span class="op" id="1601216">.</span><span class="ident" id="1601217">tcase</span>&nbsp;<span class="op" id="1601223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601227">gothrow</span><span class="op" id="1601234">(</span><span class="string" id="1601235">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1601263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601266">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601269">sel</span><span class="op" id="1601272">.</span><span class="ident" id="1601273">ncase</span>&nbsp;<span class="op" id="1601279">=</span>&nbsp;<span class="ident" id="1601281">i</span>&nbsp;<span class="op" id="1601283">+</span>&nbsp;<span class="num" id="1601285">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601288">cas</span>&nbsp;<span class="op" id="1601292">:=</span>&nbsp;<span class="op" id="1601295">(</span><span class="op" id="1601296">*</span><span class="ident" id="1601297">scase</span><span class="op" id="1601302">)</span><span class="op" id="1601303">(</span><span class="ident" id="1601304">add</span><span class="op" id="1601307">(</span><span class="ident" id="1601308">unsafe</span><span class="op" id="1601314">.</span><span class="ident" id="1601315">Pointer</span><span class="op" id="1601322">(</span><span class="op" id="1601323">&amp;</span><span class="ident" id="1601324">sel</span><span class="op" id="1601327">.</span><span class="ident" id="1601328">scase</span><span class="op" id="1601333">)</span><span class="op" id="1601334">,</span>&nbsp;<span class="builtintype" id="1601336">uintptr</span><span class="op" id="1601343">(</span><span class="ident" id="1601344">i</span><span class="op" id="1601345">)</span><span class="op" id="1601346">*</span><span class="ident" id="1601347">unsafe</span><span class="op" id="1601353">.</span><span class="ident" id="1601354">Sizeof</span><span class="op" id="1601360">(</span><span class="ident" id="1601361">sel</span><span class="op" id="1601364">.</span><span class="ident" id="1601365">scase</span><span class="op" id="1601370">[</span><span class="num" id="1601371">0</span><span class="op" id="1601372">]</span><span class="op" id="1601373">)</span><span class="op" id="1601374">)</span><span class="op" id="1601375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601378">cas</span><span class="op" id="1601381">.</span><span class="ident" id="1601382">pc</span>&nbsp;<span class="op" id="1601385">=</span>&nbsp;<span class="ident" id="1601387">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601391">cas</span><span class="op" id="1601394">.</span><span class="ident" id="1601395">_chan</span>&nbsp;<span class="op" id="1601401">=</span>&nbsp;<span class="ident" id="1601403">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601406">cas</span><span class="op" id="1601409">.</span><span class="ident" id="1601410">so</span>&nbsp;<span class="op" id="1601413">=</span>&nbsp;<span class="builtintype" id="1601415">uint16</span><span class="op" id="1601421">(</span><span class="ident" id="1601422">so</span><span class="op" id="1601424">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601427">cas</span><span class="op" id="1601430">.</span><span class="ident" id="1601431">kind</span>&nbsp;<span class="op" id="1601436">=</span>&nbsp;<span class="ident" id="1601438">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601449">cas</span><span class="op" id="1601452">.</span><span class="ident" id="1601453">elem</span>&nbsp;<span class="op" id="1601458">=</span>&nbsp;<span class="ident" id="1601460">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601466">cas</span><span class="op" id="1601469">.</span><span class="ident" id="1601470">receivedp</span>&nbsp;<span class="op" id="1601480">=</span>&nbsp;<span class="ident" id="1601482">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601493">if</span>&nbsp;<span class="ident" id="1601496">debugSelect</span>&nbsp;<span class="op" id="1601508">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1601512">print</span><span class="op" id="1601517">(</span><span class="string" id="1601518">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1601533">,</span>&nbsp;<span class="ident" id="1601535">sel</span><span class="op" id="1601538">,</span>&nbsp;<span class="string" id="1601540">&#34;&nbsp;pc=&#34;</span><span class="op" id="1601546">,</span>&nbsp;<span class="ident" id="1601548">hex</span><span class="op" id="1601551">(</span><span class="ident" id="1601552">cas</span><span class="op" id="1601555">.</span><span class="ident" id="1601556">pc</span><span class="op" id="1601558">)</span><span class="op" id="1601559">,</span>&nbsp;<span class="string" id="1601561">&#34;&nbsp;chan=&#34;</span><span class="op" id="1601569">,</span>&nbsp;<span class="ident" id="1601571">cas</span><span class="op" id="1601574">.</span><span class="ident" id="1601575">_chan</span><span class="op" id="1601580">,</span>&nbsp;<span class="string" id="1601582">&#34;&nbsp;so=&#34;</span><span class="op" id="1601588">,</span>&nbsp;<span class="ident" id="1601590">cas</span><span class="op" id="1601593">.</span><span class="ident" id="1601594">so</span><span class="op" id="1601596">,</span>&nbsp;<span class="string" id="1601598">&#34;\n&#34;</span><span class="op" id="1601602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601605">}</span><br>
<span class="lineno"></span><span class="op" id="1601607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1601610">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1601623">func</span>&nbsp;<span class="ident" id="1601628">selectdefault</span><span class="op" id="1601641">(</span><span class="ident" id="1601642">sel</span>&nbsp;<span class="op" id="1601646">*</span><span class="ident" id="1601647">_select</span><span class="op" id="1601654">)</span>&nbsp;<span class="op" id="1601656">(</span><span class="ident" id="1601657">selected</span>&nbsp;<span class="builtintype" id="1601666">bool</span><span class="op" id="1601670">)</span>&nbsp;<span class="op" id="1601672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601675">selectdefaultImpl</span><span class="op" id="1601692">(</span><span class="ident" id="1601693">sel</span><span class="op" id="1601696">,</span>&nbsp;<span class="ident" id="1601698">getcallerpc</span><span class="op" id="1601709">(</span><span class="ident" id="1601710">unsafe</span><span class="op" id="1601716">.</span><span class="ident" id="1601717">Pointer</span><span class="op" id="1601724">(</span><span class="op" id="1601725">&amp;</span><span class="ident" id="1601726">sel</span><span class="op" id="1601729">)</span><span class="op" id="1601730">)</span><span class="op" id="1601731">,</span>&nbsp;<span class="builtintype" id="1601733">uintptr</span><span class="op" id="1601740">(</span><span class="ident" id="1601741">unsafe</span><span class="op" id="1601747">.</span><span class="ident" id="1601748">Pointer</span><span class="op" id="1601755">(</span><span class="op" id="1601756">&amp;</span><span class="ident" id="1601757">selected</span><span class="op" id="1601765">)</span><span class="op" id="1601766">)</span><span class="op" id="1601767">-</span><span class="builtintype" id="1601768">uintptr</span><span class="op" id="1601775">(</span><span class="ident" id="1601776">unsafe</span><span class="op" id="1601782">.</span><span class="ident" id="1601783">Pointer</span><span class="op" id="1601790">(</span><span class="op" id="1601791">&amp;</span><span class="ident" id="1601792">sel</span><span class="op" id="1601795">)</span><span class="op" id="1601796">)</span><span class="op" id="1601797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601800">return</span><br>
<span class="lineno"></span><span class="op" id="1601807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1601810">func</span>&nbsp;<span class="ident" id="1601815">selectdefaultImpl</span><span class="op" id="1601832">(</span><span class="ident" id="1601833">sel</span>&nbsp;<span class="op" id="1601837">*</span><span class="ident" id="1601838">_select</span><span class="op" id="1601845">,</span>&nbsp;<span class="ident" id="1601847">callerpc</span>&nbsp;<span class="builtintype" id="1601856">uintptr</span><span class="op" id="1601863">,</span>&nbsp;<span class="ident" id="1601865">so</span>&nbsp;<span class="builtintype" id="1601868">uintptr</span><span class="op" id="1601875">)</span>&nbsp;<span class="op" id="1601877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601880">i</span>&nbsp;<span class="op" id="1601882">:=</span>&nbsp;<span class="ident" id="1601885">sel</span><span class="op" id="1601888">.</span><span class="ident" id="1601889">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601896">if</span>&nbsp;<span class="ident" id="1601899">i</span>&nbsp;<span class="op" id="1601901">&gt;=</span>&nbsp;<span class="ident" id="1601904">sel</span><span class="op" id="1601907">.</span><span class="ident" id="1601908">tcase</span>&nbsp;<span class="op" id="1601914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601918">gothrow</span><span class="op" id="1601925">(</span><span class="string" id="1601926">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1601957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601960">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601963">sel</span><span class="op" id="1601966">.</span><span class="ident" id="1601967">ncase</span>&nbsp;<span class="op" id="1601973">=</span>&nbsp;<span class="ident" id="1601975">i</span>&nbsp;<span class="op" id="1601977">+</span>&nbsp;<span class="num" id="1601979">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601982">cas</span>&nbsp;<span class="op" id="1601986">:=</span>&nbsp;<span class="op" id="1601989">(</span><span class="op" id="1601990">*</span><span class="ident" id="1601991">scase</span><span class="op" id="1601996">)</span><span class="op" id="1601997">(</span><span class="ident" id="1601998">add</span><span class="op" id="1602001">(</span><span class="ident" id="1602002">unsafe</span><span class="op" id="1602008">.</span><span class="ident" id="1602009">Pointer</span><span class="op" id="1602016">(</span><span class="op" id="1602017">&amp;</span><span class="ident" id="1602018">sel</span><span class="op" id="1602021">.</span><span class="ident" id="1602022">scase</span><span class="op" id="1602027">)</span><span class="op" id="1602028">,</span>&nbsp;<span class="builtintype" id="1602030">uintptr</span><span class="op" id="1602037">(</span><span class="ident" id="1602038">i</span><span class="op" id="1602039">)</span><span class="op" id="1602040">*</span><span class="ident" id="1602041">unsafe</span><span class="op" id="1602047">.</span><span class="ident" id="1602048">Sizeof</span><span class="op" id="1602054">(</span><span class="ident" id="1602055">sel</span><span class="op" id="1602058">.</span><span class="ident" id="1602059">scase</span><span class="op" id="1602064">[</span><span class="num" id="1602065">0</span><span class="op" id="1602066">]</span><span class="op" id="1602067">)</span><span class="op" id="1602068">)</span><span class="op" id="1602069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602072">cas</span><span class="op" id="1602075">.</span><span class="ident" id="1602076">pc</span>&nbsp;<span class="op" id="1602079">=</span>&nbsp;<span class="ident" id="1602081">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602091">cas</span><span class="op" id="1602094">.</span><span class="ident" id="1602095">_chan</span>&nbsp;<span class="op" id="1602101">=</span>&nbsp;<span class="builtintype" id="1602103">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602108">cas</span><span class="op" id="1602111">.</span><span class="ident" id="1602112">so</span>&nbsp;<span class="op" id="1602115">=</span>&nbsp;<span class="builtintype" id="1602117">uint16</span><span class="op" id="1602123">(</span><span class="ident" id="1602124">so</span><span class="op" id="1602126">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602129">cas</span><span class="op" id="1602132">.</span><span class="ident" id="1602133">kind</span>&nbsp;<span class="op" id="1602138">=</span>&nbsp;<span class="ident" id="1602140">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602155">if</span>&nbsp;<span class="ident" id="1602158">debugSelect</span>&nbsp;<span class="op" id="1602170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1602174">print</span><span class="op" id="1602179">(</span><span class="string" id="1602180">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1602198">,</span>&nbsp;<span class="ident" id="1602200">sel</span><span class="op" id="1602203">,</span>&nbsp;<span class="string" id="1602205">&#34;&nbsp;pc=&#34;</span><span class="op" id="1602211">,</span>&nbsp;<span class="ident" id="1602213">hex</span><span class="op" id="1602216">(</span><span class="ident" id="1602217">cas</span><span class="op" id="1602220">.</span><span class="ident" id="1602221">pc</span><span class="op" id="1602223">)</span><span class="op" id="1602224">,</span>&nbsp;<span class="string" id="1602226">&#34;&nbsp;so=&#34;</span><span class="op" id="1602232">,</span>&nbsp;<span class="ident" id="1602234">cas</span><span class="op" id="1602237">.</span><span class="ident" id="1602238">so</span><span class="op" id="1602240">,</span>&nbsp;<span class="string" id="1602242">&#34;\n&#34;</span><span class="op" id="1602246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602249">}</span><br>
<span class="lineno">130</span><span class="op" id="1602251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602254">func</span>&nbsp;<span class="ident" id="1602259">sellock</span><span class="op" id="1602266">(</span><span class="ident" id="1602267">sel</span>&nbsp;<span class="op" id="1602271">*</span><span class="ident" id="1602272">_select</span><span class="op" id="1602279">)</span>&nbsp;<span class="op" id="1602281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602284">lockslice</span>&nbsp;<span class="op" id="1602294">:=</span>&nbsp;<span class="ident" id="1602297">sliceStruct</span><span class="op" id="1602308">{</span><span class="ident" id="1602309">unsafe</span><span class="op" id="1602315">.</span><span class="ident" id="1602316">Pointer</span><span class="op" id="1602323">(</span><span class="ident" id="1602324">sel</span><span class="op" id="1602327">.</span><span class="ident" id="1602328">lockorder</span><span class="op" id="1602337">)</span><span class="op" id="1602338">,</span>&nbsp;<span class="builtintype" id="1602340">int</span><span class="op" id="1602343">(</span><span class="ident" id="1602344">sel</span><span class="op" id="1602347">.</span><span class="ident" id="1602348">ncase</span><span class="op" id="1602353">)</span><span class="op" id="1602354">,</span>&nbsp;<span class="builtintype" id="1602356">int</span><span class="op" id="1602359">(</span><span class="ident" id="1602360">sel</span><span class="op" id="1602363">.</span><span class="ident" id="1602364">ncase</span><span class="op" id="1602369">)</span><span class="op" id="1602370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602373">lockorder</span>&nbsp;<span class="op" id="1602383">:=</span>&nbsp;<span class="op" id="1602386">*</span><span class="op" id="1602387">(</span><span class="op" id="1602388">*</span><span class="op" id="1602389">[</span><span class="op" id="1602390">]</span><span class="op" id="1602391">*</span><span class="ident" id="1602392">hchan</span><span class="op" id="1602397">)</span><span class="op" id="1602398">(</span><span class="ident" id="1602399">unsafe</span><span class="op" id="1602405">.</span><span class="ident" id="1602406">Pointer</span><span class="op" id="1602413">(</span><span class="op" id="1602414">&amp;</span><span class="ident" id="1602415">lockslice</span><span class="op" id="1602424">)</span><span class="op" id="1602425">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602428">var</span>&nbsp;<span class="ident" id="1602432">c</span>&nbsp;<span class="op" id="1602434">*</span><span class="ident" id="1602435">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602442">for</span>&nbsp;<span class="ident" id="1602446">_</span><span class="op" id="1602447">,</span>&nbsp;<span class="ident" id="1602449">c0</span>&nbsp;<span class="op" id="1602452">:=</span>&nbsp;<span class="keyword" id="1602455">range</span>&nbsp;<span class="ident" id="1602461">lockorder</span>&nbsp;<span class="op" id="1602471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602475">if</span>&nbsp;<span class="ident" id="1602478">c0</span>&nbsp;<span class="op" id="1602481">!=</span>&nbsp;<span class="builtintype" id="1602484">nil</span>&nbsp;<span class="op" id="1602488">&amp;&amp;</span>&nbsp;<span class="ident" id="1602491">c0</span>&nbsp;<span class="op" id="1602494">!=</span>&nbsp;<span class="ident" id="1602497">c</span>&nbsp;<span class="op" id="1602499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602504">c</span>&nbsp;<span class="op" id="1602506">=</span>&nbsp;<span class="ident" id="1602508">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602514">lock</span><span class="op" id="1602518">(</span><span class="op" id="1602519">&amp;</span><span class="ident" id="1602520">c</span><span class="op" id="1602521">.</span><span class="ident" id="1602522">lock</span><span class="op" id="1602526">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602533">}</span><br>
<span class="lineno"></span><span class="op" id="1602535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602538">func</span>&nbsp;<span class="ident" id="1602543">selunlock</span><span class="op" id="1602552">(</span><span class="ident" id="1602553">sel</span>&nbsp;<span class="op" id="1602557">*</span><span class="ident" id="1602558">_select</span><span class="op" id="1602565">)</span>&nbsp;<span class="op" id="1602567">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602570">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602643">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602716">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602754">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602828">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602897">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602972">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1603044">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603109">n</span>&nbsp;<span class="op" id="1603111">:=</span>&nbsp;<span class="builtintype" id="1603114">int</span><span class="op" id="1603117">(</span><span class="ident" id="1603118">sel</span><span class="op" id="1603121">.</span><span class="ident" id="1603122">ncase</span><span class="op" id="1603127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603130">r</span>&nbsp;<span class="op" id="1603132">:=</span>&nbsp;<span class="num" id="1603135">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603138">lockslice</span>&nbsp;<span class="op" id="1603148">:=</span>&nbsp;<span class="ident" id="1603151">sliceStruct</span><span class="op" id="1603162">{</span><span class="ident" id="1603163">unsafe</span><span class="op" id="1603169">.</span><span class="ident" id="1603170">Pointer</span><span class="op" id="1603177">(</span><span class="ident" id="1603178">sel</span><span class="op" id="1603181">.</span><span class="ident" id="1603182">lockorder</span><span class="op" id="1603191">)</span><span class="op" id="1603192">,</span>&nbsp;<span class="ident" id="1603194">n</span><span class="op" id="1603195">,</span>&nbsp;<span class="ident" id="1603197">n</span><span class="op" id="1603198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603201">lockorder</span>&nbsp;<span class="op" id="1603211">:=</span>&nbsp;<span class="op" id="1603214">*</span><span class="op" id="1603215">(</span><span class="op" id="1603216">*</span><span class="op" id="1603217">[</span><span class="op" id="1603218">]</span><span class="op" id="1603219">*</span><span class="ident" id="1603220">hchan</span><span class="op" id="1603225">)</span><span class="op" id="1603226">(</span><span class="ident" id="1603227">unsafe</span><span class="op" id="1603233">.</span><span class="ident" id="1603234">Pointer</span><span class="op" id="1603241">(</span><span class="op" id="1603242">&amp;</span><span class="ident" id="1603243">lockslice</span><span class="op" id="1603252">)</span><span class="op" id="1603253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1603256">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603282">if</span>&nbsp;<span class="ident" id="1603285">n</span>&nbsp;<span class="op" id="1603287">&gt;</span>&nbsp;<span class="num" id="1603289">0</span>&nbsp;<span class="op" id="1603291">&amp;&amp;</span>&nbsp;<span class="ident" id="1603294">lockorder</span><span class="op" id="1603303">[</span><span class="num" id="1603304">0</span><span class="op" id="1603305">]</span>&nbsp;<span class="op" id="1603307">==</span>&nbsp;<span class="builtintype" id="1603310">nil</span>&nbsp;<span class="op" id="1603314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603318">r</span>&nbsp;<span class="op" id="1603320">=</span>&nbsp;<span class="num" id="1603322">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603328">for</span>&nbsp;<span class="ident" id="1603332">i</span>&nbsp;<span class="op" id="1603334">:=</span>&nbsp;<span class="ident" id="1603337">n</span>&nbsp;<span class="op" id="1603339">-</span>&nbsp;<span class="num" id="1603341">1</span><span class="op" id="1603342">;</span>&nbsp;<span class="ident" id="1603344">i</span>&nbsp;<span class="op" id="1603346">&gt;=</span>&nbsp;<span class="ident" id="1603349">r</span><span class="op" id="1603350">;</span>&nbsp;<span class="ident" id="1603352">i</span><span class="op" id="1603353">--</span>&nbsp;<span class="op" id="1603356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603360">c</span>&nbsp;<span class="op" id="1603362">:=</span>&nbsp;<span class="ident" id="1603365">lockorder</span><span class="op" id="1603374">[</span><span class="ident" id="1603375">i</span><span class="op" id="1603376">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603380">if</span>&nbsp;<span class="ident" id="1603383">i</span>&nbsp;<span class="op" id="1603385">&gt;</span>&nbsp;<span class="num" id="1603387">0</span>&nbsp;<span class="op" id="1603389">&amp;&amp;</span>&nbsp;<span class="ident" id="1603392">c</span>&nbsp;<span class="op" id="1603394">==</span>&nbsp;<span class="ident" id="1603397">lockorder</span><span class="op" id="1603406">[</span><span class="ident" id="1603407">i</span><span class="op" id="1603408">-</span><span class="num" id="1603409">1</span><span class="op" id="1603410">]</span>&nbsp;<span class="op" id="1603412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603417">continue</span>&nbsp;<span class="comment" id="1603426">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603472">unlock</span><span class="op" id="1603478">(</span><span class="op" id="1603479">&amp;</span><span class="ident" id="1603480">c</span><span class="op" id="1603481">.</span><span class="ident" id="1603482">lock</span><span class="op" id="1603486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603489">}</span><br>
<span class="lineno"></span><span class="op" id="1603491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1603494">func</span>&nbsp;<span class="ident" id="1603499">selparkcommit</span><span class="op" id="1603512">(</span><span class="ident" id="1603513">gp</span>&nbsp;<span class="op" id="1603516">*</span><span class="ident" id="1603517">g</span><span class="op" id="1603518">,</span>&nbsp;<span class="ident" id="1603520">sel</span>&nbsp;<span class="op" id="1603524">*</span><span class="ident" id="1603525">_select</span><span class="op" id="1603532">)</span>&nbsp;<span class="builtintype" id="1603534">bool</span>&nbsp;<span class="op" id="1603539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603542">selunlock</span><span class="op" id="1603551">(</span><span class="ident" id="1603552">sel</span><span class="op" id="1603555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603558">return</span>&nbsp;<span class="builtintype" id="1603565">true</span><br>
<span class="lineno"></span><span class="op" id="1603570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1603573">func</span>&nbsp;<span class="ident" id="1603578">block</span><span class="op" id="1603583">(</span><span class="op" id="1603584">)</span>&nbsp;<span class="op" id="1603586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603589">gopark</span><span class="op" id="1603595">(</span><span class="builtintype" id="1603596">nil</span><span class="op" id="1603599">,</span>&nbsp;<span class="builtintype" id="1603601">nil</span><span class="op" id="1603604">,</span>&nbsp;<span class="string" id="1603606">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1603625">)</span>&nbsp;<span class="comment" id="1603627">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1603638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603641">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1603709">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1603766">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1603779">func</span>&nbsp;<span class="ident" id="1603784">selectgo</span><span class="op" id="1603792">(</span><span class="ident" id="1603793">sel</span>&nbsp;<span class="op" id="1603797">*</span><span class="ident" id="1603798">_select</span><span class="op" id="1603805">)</span>&nbsp;<span class="op" id="1603807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603810">pc</span><span class="op" id="1603812">,</span>&nbsp;<span class="ident" id="1603814">offset</span>&nbsp;<span class="op" id="1603821">:=</span>&nbsp;<span class="ident" id="1603824">selectgoImpl</span><span class="op" id="1603836">(</span><span class="ident" id="1603837">sel</span><span class="op" id="1603840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603843">*</span><span class="op" id="1603844">(</span><span class="op" id="1603845">*</span><span class="builtintype" id="1603846">bool</span><span class="op" id="1603850">)</span><span class="op" id="1603851">(</span><span class="ident" id="1603852">add</span><span class="op" id="1603855">(</span><span class="ident" id="1603856">unsafe</span><span class="op" id="1603862">.</span><span class="ident" id="1603863">Pointer</span><span class="op" id="1603870">(</span><span class="op" id="1603871">&amp;</span><span class="ident" id="1603872">sel</span><span class="op" id="1603875">)</span><span class="op" id="1603876">,</span>&nbsp;<span class="builtintype" id="1603878">uintptr</span><span class="op" id="1603885">(</span><span class="ident" id="1603886">offset</span><span class="op" id="1603892">)</span><span class="op" id="1603893">)</span><span class="op" id="1603894">)</span>&nbsp;<span class="op" id="1603896">=</span>&nbsp;<span class="builtintype" id="1603898">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603904">setcallerpc</span><span class="op" id="1603915">(</span><span class="ident" id="1603916">unsafe</span><span class="op" id="1603922">.</span><span class="ident" id="1603923">Pointer</span><span class="op" id="1603930">(</span><span class="op" id="1603931">&amp;</span><span class="ident" id="1603932">sel</span><span class="op" id="1603935">)</span><span class="op" id="1603936">,</span>&nbsp;<span class="ident" id="1603938">pc</span><span class="op" id="1603940">)</span><br>
<span class="lineno"></span><span class="op" id="1603942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603945">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1604006">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1604027">func</span>&nbsp;<span class="ident" id="1604032">selectgoImpl</span><span class="op" id="1604044">(</span><span class="ident" id="1604045">sel</span>&nbsp;<span class="op" id="1604049">*</span><span class="ident" id="1604050">_select</span><span class="op" id="1604057">)</span>&nbsp;<span class="op" id="1604059">(</span><span class="builtintype" id="1604060">uintptr</span><span class="op" id="1604067">,</span>&nbsp;<span class="builtintype" id="1604069">uint16</span><span class="op" id="1604075">)</span>&nbsp;<span class="op" id="1604077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604080">if</span>&nbsp;<span class="ident" id="1604083">debugSelect</span>&nbsp;<span class="op" id="1604095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1604099">print</span><span class="op" id="1604104">(</span><span class="string" id="1604105">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1604119">,</span>&nbsp;<span class="ident" id="1604121">sel</span><span class="op" id="1604124">,</span>&nbsp;<span class="string" id="1604126">&#34;\n&#34;</span><span class="op" id="1604130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604137">scaseslice</span>&nbsp;<span class="op" id="1604148">:=</span>&nbsp;<span class="ident" id="1604151">sliceStruct</span><span class="op" id="1604162">{</span><span class="ident" id="1604163">unsafe</span><span class="op" id="1604169">.</span><span class="ident" id="1604170">Pointer</span><span class="op" id="1604177">(</span><span class="op" id="1604178">&amp;</span><span class="ident" id="1604179">sel</span><span class="op" id="1604182">.</span><span class="ident" id="1604183">scase</span><span class="op" id="1604188">)</span><span class="op" id="1604189">,</span>&nbsp;<span class="builtintype" id="1604191">int</span><span class="op" id="1604194">(</span><span class="ident" id="1604195">sel</span><span class="op" id="1604198">.</span><span class="ident" id="1604199">ncase</span><span class="op" id="1604204">)</span><span class="op" id="1604205">,</span>&nbsp;<span class="builtintype" id="1604207">int</span><span class="op" id="1604210">(</span><span class="ident" id="1604211">sel</span><span class="op" id="1604214">.</span><span class="ident" id="1604215">ncase</span><span class="op" id="1604220">)</span><span class="op" id="1604221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604224">scases</span>&nbsp;<span class="op" id="1604231">:=</span>&nbsp;<span class="op" id="1604234">*</span><span class="op" id="1604235">(</span><span class="op" id="1604236">*</span><span class="op" id="1604237">[</span><span class="op" id="1604238">]</span><span class="ident" id="1604239">scase</span><span class="op" id="1604244">)</span><span class="op" id="1604245">(</span><span class="ident" id="1604246">unsafe</span><span class="op" id="1604252">.</span><span class="ident" id="1604253">Pointer</span><span class="op" id="1604260">(</span><span class="op" id="1604261">&amp;</span><span class="ident" id="1604262">scaseslice</span><span class="op" id="1604272">)</span><span class="op" id="1604273">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604277">var</span>&nbsp;<span class="ident" id="1604281">t0</span>&nbsp;<span class="builtintype" id="1604284">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604291">if</span>&nbsp;<span class="ident" id="1604294">blockprofilerate</span>&nbsp;<span class="op" id="1604311">&gt;</span>&nbsp;<span class="num" id="1604313">0</span>&nbsp;<span class="op" id="1604315">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604319">t0</span>&nbsp;<span class="op" id="1604322">=</span>&nbsp;<span class="ident" id="1604324">cputicks</span><span class="op" id="1604332">(</span><span class="op" id="1604333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604337">for</span>&nbsp;<span class="ident" id="1604341">i</span>&nbsp;<span class="op" id="1604343">:=</span>&nbsp;<span class="num" id="1604346">0</span><span class="op" id="1604347">;</span>&nbsp;<span class="ident" id="1604349">i</span>&nbsp;<span class="op" id="1604351">&lt;</span>&nbsp;<span class="builtintype" id="1604353">int</span><span class="op" id="1604356">(</span><span class="ident" id="1604357">sel</span><span class="op" id="1604360">.</span><span class="ident" id="1604361">ncase</span><span class="op" id="1604366">)</span><span class="op" id="1604367">;</span>&nbsp;<span class="ident" id="1604369">i</span><span class="op" id="1604370">++</span>&nbsp;<span class="op" id="1604373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604378">scases</span><span class="op" id="1604384">[</span><span class="ident" id="1604385">i</span><span class="op" id="1604386">]</span><span class="op" id="1604387">.</span><span class="ident" id="1604388">releasetime</span>&nbsp;<span class="op" id="1604400">=</span>&nbsp;<span class="op" id="1604402">-</span><span class="num" id="1604403">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604410">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604414">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604469">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604529">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604586">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604648">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604706">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604766">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604805">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604833">pollslice</span>&nbsp;<span class="op" id="1604843">:=</span>&nbsp;<span class="ident" id="1604846">sliceStruct</span><span class="op" id="1604857">{</span><span class="ident" id="1604858">unsafe</span><span class="op" id="1604864">.</span><span class="ident" id="1604865">Pointer</span><span class="op" id="1604872">(</span><span class="ident" id="1604873">sel</span><span class="op" id="1604876">.</span><span class="ident" id="1604877">pollorder</span><span class="op" id="1604886">)</span><span class="op" id="1604887">,</span>&nbsp;<span class="builtintype" id="1604889">int</span><span class="op" id="1604892">(</span><span class="ident" id="1604893">sel</span><span class="op" id="1604896">.</span><span class="ident" id="1604897">ncase</span><span class="op" id="1604902">)</span><span class="op" id="1604903">,</span>&nbsp;<span class="builtintype" id="1604905">int</span><span class="op" id="1604908">(</span><span class="ident" id="1604909">sel</span><span class="op" id="1604912">.</span><span class="ident" id="1604913">ncase</span><span class="op" id="1604918">)</span><span class="op" id="1604919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604922">pollorder</span>&nbsp;<span class="op" id="1604932">:=</span>&nbsp;<span class="op" id="1604935">*</span><span class="op" id="1604936">(</span><span class="op" id="1604937">*</span><span class="op" id="1604938">[</span><span class="op" id="1604939">]</span><span class="builtintype" id="1604940">uint16</span><span class="op" id="1604946">)</span><span class="op" id="1604947">(</span><span class="ident" id="1604948">unsafe</span><span class="op" id="1604954">.</span><span class="ident" id="1604955">Pointer</span><span class="op" id="1604962">(</span><span class="op" id="1604963">&amp;</span><span class="ident" id="1604964">pollslice</span><span class="op" id="1604973">)</span><span class="op" id="1604974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604977">for</span>&nbsp;<span class="ident" id="1604981">i</span>&nbsp;<span class="op" id="1604983">:=</span>&nbsp;<span class="num" id="1604986">0</span><span class="op" id="1604987">;</span>&nbsp;<span class="ident" id="1604989">i</span>&nbsp;<span class="op" id="1604991">&lt;</span>&nbsp;<span class="builtintype" id="1604993">int</span><span class="op" id="1604996">(</span><span class="ident" id="1604997">sel</span><span class="op" id="1605000">.</span><span class="ident" id="1605001">ncase</span><span class="op" id="1605006">)</span><span class="op" id="1605007">;</span>&nbsp;<span class="ident" id="1605009">i</span><span class="op" id="1605010">++</span>&nbsp;<span class="op" id="1605013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605017">pollorder</span><span class="op" id="1605026">[</span><span class="ident" id="1605027">i</span><span class="op" id="1605028">]</span>&nbsp;<span class="op" id="1605030">=</span>&nbsp;<span class="builtintype" id="1605032">uint16</span><span class="op" id="1605038">(</span><span class="ident" id="1605039">i</span><span class="op" id="1605040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605043">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605046">for</span>&nbsp;<span class="ident" id="1605050">i</span>&nbsp;<span class="op" id="1605052">:=</span>&nbsp;<span class="num" id="1605055">1</span><span class="op" id="1605056">;</span>&nbsp;<span class="ident" id="1605058">i</span>&nbsp;<span class="op" id="1605060">&lt;</span>&nbsp;<span class="builtintype" id="1605062">int</span><span class="op" id="1605065">(</span><span class="ident" id="1605066">sel</span><span class="op" id="1605069">.</span><span class="ident" id="1605070">ncase</span><span class="op" id="1605075">)</span><span class="op" id="1605076">;</span>&nbsp;<span class="ident" id="1605078">i</span><span class="op" id="1605079">++</span>&nbsp;<span class="op" id="1605082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605086">o</span>&nbsp;<span class="op" id="1605088">:=</span>&nbsp;<span class="ident" id="1605091">pollorder</span><span class="op" id="1605100">[</span><span class="ident" id="1605101">i</span><span class="op" id="1605102">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605106">j</span>&nbsp;<span class="op" id="1605108">:=</span>&nbsp;<span class="builtintype" id="1605111">int</span><span class="op" id="1605114">(</span><span class="ident" id="1605115">fastrand1</span><span class="op" id="1605124">(</span><span class="op" id="1605125">)</span><span class="op" id="1605126">)</span>&nbsp;<span class="op" id="1605128">%</span>&nbsp;<span class="op" id="1605130">(</span><span class="ident" id="1605131">i</span>&nbsp;<span class="op" id="1605133">+</span>&nbsp;<span class="num" id="1605135">1</span><span class="op" id="1605136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605140">pollorder</span><span class="op" id="1605149">[</span><span class="ident" id="1605150">i</span><span class="op" id="1605151">]</span>&nbsp;<span class="op" id="1605153">=</span>&nbsp;<span class="ident" id="1605155">pollorder</span><span class="op" id="1605164">[</span><span class="ident" id="1605165">j</span><span class="op" id="1605166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605170">pollorder</span><span class="op" id="1605179">[</span><span class="ident" id="1605180">j</span><span class="op" id="1605181">]</span>&nbsp;<span class="op" id="1605183">=</span>&nbsp;<span class="ident" id="1605185">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605192">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605254">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605332">lockslice</span>&nbsp;<span class="op" id="1605342">:=</span>&nbsp;<span class="ident" id="1605345">sliceStruct</span><span class="op" id="1605356">{</span><span class="ident" id="1605357">unsafe</span><span class="op" id="1605363">.</span><span class="ident" id="1605364">Pointer</span><span class="op" id="1605371">(</span><span class="ident" id="1605372">sel</span><span class="op" id="1605375">.</span><span class="ident" id="1605376">lockorder</span><span class="op" id="1605385">)</span><span class="op" id="1605386">,</span>&nbsp;<span class="builtintype" id="1605388">int</span><span class="op" id="1605391">(</span><span class="ident" id="1605392">sel</span><span class="op" id="1605395">.</span><span class="ident" id="1605396">ncase</span><span class="op" id="1605401">)</span><span class="op" id="1605402">,</span>&nbsp;<span class="builtintype" id="1605404">int</span><span class="op" id="1605407">(</span><span class="ident" id="1605408">sel</span><span class="op" id="1605411">.</span><span class="ident" id="1605412">ncase</span><span class="op" id="1605417">)</span><span class="op" id="1605418">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605421">lockorder</span>&nbsp;<span class="op" id="1605431">:=</span>&nbsp;<span class="op" id="1605434">*</span><span class="op" id="1605435">(</span><span class="op" id="1605436">*</span><span class="op" id="1605437">[</span><span class="op" id="1605438">]</span><span class="op" id="1605439">*</span><span class="ident" id="1605440">hchan</span><span class="op" id="1605445">)</span><span class="op" id="1605446">(</span><span class="ident" id="1605447">unsafe</span><span class="op" id="1605453">.</span><span class="ident" id="1605454">Pointer</span><span class="op" id="1605461">(</span><span class="op" id="1605462">&amp;</span><span class="ident" id="1605463">lockslice</span><span class="op" id="1605472">)</span><span class="op" id="1605473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605476">for</span>&nbsp;<span class="ident" id="1605480">i</span>&nbsp;<span class="op" id="1605482">:=</span>&nbsp;<span class="num" id="1605485">0</span><span class="op" id="1605486">;</span>&nbsp;<span class="ident" id="1605488">i</span>&nbsp;<span class="op" id="1605490">&lt;</span>&nbsp;<span class="builtintype" id="1605492">int</span><span class="op" id="1605495">(</span><span class="ident" id="1605496">sel</span><span class="op" id="1605499">.</span><span class="ident" id="1605500">ncase</span><span class="op" id="1605505">)</span><span class="op" id="1605506">;</span>&nbsp;<span class="ident" id="1605508">i</span><span class="op" id="1605509">++</span>&nbsp;<span class="op" id="1605512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605516">j</span>&nbsp;<span class="op" id="1605518">:=</span>&nbsp;<span class="ident" id="1605521">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605525">c</span>&nbsp;<span class="op" id="1605527">:=</span>&nbsp;<span class="ident" id="1605530">scases</span><span class="op" id="1605536">[</span><span class="ident" id="1605537">j</span><span class="op" id="1605538">]</span><span class="op" id="1605539">.</span><span class="ident" id="1605540">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605548">for</span>&nbsp;<span class="ident" id="1605552">j</span>&nbsp;<span class="op" id="1605554">&gt;</span>&nbsp;<span class="num" id="1605556">0</span>&nbsp;<span class="op" id="1605558">&amp;&amp;</span>&nbsp;<span class="ident" id="1605561">lockorder</span><span class="op" id="1605570">[</span><span class="op" id="1605571">(</span><span class="ident" id="1605572">j</span><span class="op" id="1605573">-</span><span class="num" id="1605574">1</span><span class="op" id="1605575">)</span><span class="op" id="1605576">/</span><span class="num" id="1605577">2</span><span class="op" id="1605578">]</span><span class="op" id="1605579">.</span><span class="ident" id="1605580">sortkey</span><span class="op" id="1605587">(</span><span class="op" id="1605588">)</span>&nbsp;<span class="op" id="1605590">&lt;</span>&nbsp;<span class="ident" id="1605592">c</span><span class="op" id="1605593">.</span><span class="ident" id="1605594">sortkey</span><span class="op" id="1605601">(</span><span class="op" id="1605602">)</span>&nbsp;<span class="op" id="1605604">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605609">k</span>&nbsp;<span class="op" id="1605611">:=</span>&nbsp;<span class="op" id="1605614">(</span><span class="ident" id="1605615">j</span>&nbsp;<span class="op" id="1605617">-</span>&nbsp;<span class="num" id="1605619">1</span><span class="op" id="1605620">)</span>&nbsp;<span class="op" id="1605622">/</span>&nbsp;<span class="num" id="1605624">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605629">lockorder</span><span class="op" id="1605638">[</span><span class="ident" id="1605639">j</span><span class="op" id="1605640">]</span>&nbsp;<span class="op" id="1605642">=</span>&nbsp;<span class="ident" id="1605644">lockorder</span><span class="op" id="1605653">[</span><span class="ident" id="1605654">k</span><span class="op" id="1605655">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605660">j</span>&nbsp;<span class="op" id="1605662">=</span>&nbsp;<span class="ident" id="1605664">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605672">lockorder</span><span class="op" id="1605681">[</span><span class="ident" id="1605682">j</span><span class="op" id="1605683">]</span>&nbsp;<span class="op" id="1605685">=</span>&nbsp;<span class="ident" id="1605687">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605693">for</span>&nbsp;<span class="ident" id="1605697">i</span>&nbsp;<span class="op" id="1605699">:=</span>&nbsp;<span class="builtintype" id="1605702">int</span><span class="op" id="1605705">(</span><span class="ident" id="1605706">sel</span><span class="op" id="1605709">.</span><span class="ident" id="1605710">ncase</span><span class="op" id="1605715">)</span>&nbsp;<span class="op" id="1605717">-</span>&nbsp;<span class="num" id="1605719">1</span><span class="op" id="1605720">;</span>&nbsp;<span class="ident" id="1605722">i</span>&nbsp;<span class="op" id="1605724">&gt;=</span>&nbsp;<span class="num" id="1605727">0</span><span class="op" id="1605728">;</span>&nbsp;<span class="ident" id="1605730">i</span><span class="op" id="1605731">--</span>&nbsp;<span class="op" id="1605734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605738">c</span>&nbsp;<span class="op" id="1605740">:=</span>&nbsp;<span class="ident" id="1605743">lockorder</span><span class="op" id="1605752">[</span><span class="ident" id="1605753">i</span><span class="op" id="1605754">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605758">lockorder</span><span class="op" id="1605767">[</span><span class="ident" id="1605768">i</span><span class="op" id="1605769">]</span>&nbsp;<span class="op" id="1605771">=</span>&nbsp;<span class="ident" id="1605773">lockorder</span><span class="op" id="1605782">[</span><span class="num" id="1605783">0</span><span class="op" id="1605784">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605788">j</span>&nbsp;<span class="op" id="1605790">:=</span>&nbsp;<span class="num" id="1605793">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605797">for</span>&nbsp;<span class="op" id="1605801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605806">k</span>&nbsp;<span class="op" id="1605808">:=</span>&nbsp;<span class="ident" id="1605811">j</span><span class="op" id="1605812">*</span><span class="num" id="1605813">2</span>&nbsp;<span class="op" id="1605815">+</span>&nbsp;<span class="num" id="1605817">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605822">if</span>&nbsp;<span class="ident" id="1605825">k</span>&nbsp;<span class="op" id="1605827">&gt;=</span>&nbsp;<span class="ident" id="1605830">i</span>&nbsp;<span class="op" id="1605832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605838">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605847">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605852">if</span>&nbsp;<span class="ident" id="1605855">k</span><span class="op" id="1605856">+</span><span class="num" id="1605857">1</span>&nbsp;<span class="op" id="1605859">&lt;</span>&nbsp;<span class="ident" id="1605861">i</span>&nbsp;<span class="op" id="1605863">&amp;&amp;</span>&nbsp;<span class="ident" id="1605866">lockorder</span><span class="op" id="1605875">[</span><span class="ident" id="1605876">k</span><span class="op" id="1605877">]</span><span class="op" id="1605878">.</span><span class="ident" id="1605879">sortkey</span><span class="op" id="1605886">(</span><span class="op" id="1605887">)</span>&nbsp;<span class="op" id="1605889">&lt;</span>&nbsp;<span class="ident" id="1605891">lockorder</span><span class="op" id="1605900">[</span><span class="ident" id="1605901">k</span><span class="op" id="1605902">+</span><span class="num" id="1605903">1</span><span class="op" id="1605904">]</span><span class="op" id="1605905">.</span><span class="ident" id="1605906">sortkey</span><span class="op" id="1605913">(</span><span class="op" id="1605914">)</span>&nbsp;<span class="op" id="1605916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605922">k</span><span class="op" id="1605923">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605934">if</span>&nbsp;<span class="ident" id="1605937">c</span><span class="op" id="1605938">.</span><span class="ident" id="1605939">sortkey</span><span class="op" id="1605946">(</span><span class="op" id="1605947">)</span>&nbsp;<span class="op" id="1605949">&lt;</span>&nbsp;<span class="ident" id="1605951">lockorder</span><span class="op" id="1605960">[</span><span class="ident" id="1605961">k</span><span class="op" id="1605962">]</span><span class="op" id="1605963">.</span><span class="ident" id="1605964">sortkey</span><span class="op" id="1605971">(</span><span class="op" id="1605972">)</span>&nbsp;<span class="op" id="1605974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605980">lockorder</span><span class="op" id="1605989">[</span><span class="ident" id="1605990">j</span><span class="op" id="1605991">]</span>&nbsp;<span class="op" id="1605993">=</span>&nbsp;<span class="ident" id="1605995">lockorder</span><span class="op" id="1606004">[</span><span class="ident" id="1606005">k</span><span class="op" id="1606006">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606012">j</span>&nbsp;<span class="op" id="1606014">=</span>&nbsp;<span class="ident" id="1606016">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606022">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606039">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606047">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606051">lockorder</span><span class="op" id="1606060">[</span><span class="ident" id="1606061">j</span><span class="op" id="1606062">]</span>&nbsp;<span class="op" id="1606064">=</span>&nbsp;<span class="ident" id="1606066">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606072">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606294">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606343">sellock</span><span class="op" id="1606350">(</span><span class="ident" id="1606351">sel</span><span class="op" id="1606354">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606358">var</span>&nbsp;<span class="op" id="1606362">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606366">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606373">*</span><span class="ident" id="1606374">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606378">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1606385">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606394">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606401">*</span><span class="ident" id="1606402">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606410">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606417">*</span><span class="ident" id="1606418">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606426">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606433">*</span><span class="ident" id="1606434">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606442">sglist</span>&nbsp;<span class="op" id="1606449">*</span><span class="ident" id="1606450">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606458">sgnext</span>&nbsp;<span class="op" id="1606465">*</span><span class="ident" id="1606466">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606473">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1606476">loop</span><span class="op" id="1606480">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606483">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606531">var</span>&nbsp;<span class="ident" id="1606535">dfl</span>&nbsp;<span class="op" id="1606539">*</span><span class="ident" id="1606540">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606547">var</span>&nbsp;<span class="ident" id="1606551">cas</span>&nbsp;<span class="op" id="1606555">*</span><span class="ident" id="1606556">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606563">for</span>&nbsp;<span class="ident" id="1606567">i</span>&nbsp;<span class="op" id="1606569">:=</span>&nbsp;<span class="num" id="1606572">0</span><span class="op" id="1606573">;</span>&nbsp;<span class="ident" id="1606575">i</span>&nbsp;<span class="op" id="1606577">&lt;</span>&nbsp;<span class="builtintype" id="1606579">int</span><span class="op" id="1606582">(</span><span class="ident" id="1606583">sel</span><span class="op" id="1606586">.</span><span class="ident" id="1606587">ncase</span><span class="op" id="1606592">)</span><span class="op" id="1606593">;</span>&nbsp;<span class="ident" id="1606595">i</span><span class="op" id="1606596">++</span>&nbsp;<span class="op" id="1606599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606603">cas</span>&nbsp;<span class="op" id="1606607">=</span>&nbsp;<span class="op" id="1606609">&amp;</span><span class="ident" id="1606610">scases</span><span class="op" id="1606616">[</span><span class="ident" id="1606617">pollorder</span><span class="op" id="1606626">[</span><span class="ident" id="1606627">i</span><span class="op" id="1606628">]</span><span class="op" id="1606629">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606633">c</span>&nbsp;<span class="op" id="1606635">=</span>&nbsp;<span class="ident" id="1606637">cas</span><span class="op" id="1606640">.</span><span class="ident" id="1606641">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606650">switch</span>&nbsp;<span class="ident" id="1606657">cas</span><span class="op" id="1606660">.</span><span class="ident" id="1606661">kind</span>&nbsp;<span class="op" id="1606666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606670">case</span>&nbsp;<span class="ident" id="1606675">_CaseRecv</span><span class="op" id="1606684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606689">if</span>&nbsp;<span class="ident" id="1606692">c</span><span class="op" id="1606693">.</span><span class="ident" id="1606694">dataqsiz</span>&nbsp;<span class="op" id="1606703">&gt;</span>&nbsp;<span class="num" id="1606705">0</span>&nbsp;<span class="op" id="1606707">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606713">if</span>&nbsp;<span class="ident" id="1606716">c</span><span class="op" id="1606717">.</span><span class="ident" id="1606718">qcount</span>&nbsp;<span class="op" id="1606725">&gt;</span>&nbsp;<span class="num" id="1606727">0</span>&nbsp;<span class="op" id="1606729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606736">goto</span>&nbsp;<span class="ident" id="1606741">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606760">}</span>&nbsp;<span class="keyword" id="1606762">else</span>&nbsp;<span class="op" id="1606767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606773">sg</span>&nbsp;<span class="op" id="1606776">=</span>&nbsp;<span class="ident" id="1606778">c</span><span class="op" id="1606779">.</span><span class="ident" id="1606780">sendq</span><span class="op" id="1606785">.</span><span class="ident" id="1606786">dequeue</span><span class="op" id="1606793">(</span><span class="op" id="1606794">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606800">if</span>&nbsp;<span class="ident" id="1606803">sg</span>&nbsp;<span class="op" id="1606806">!=</span>&nbsp;<span class="builtintype" id="1606809">nil</span>&nbsp;<span class="op" id="1606813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606820">goto</span>&nbsp;<span class="ident" id="1606825">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606848">if</span>&nbsp;<span class="ident" id="1606851">c</span><span class="op" id="1606852">.</span><span class="ident" id="1606853">closed</span>&nbsp;<span class="op" id="1606860">!=</span>&nbsp;<span class="num" id="1606863">0</span>&nbsp;<span class="op" id="1606865">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606871">goto</span>&nbsp;<span class="ident" id="1606876">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606891">case</span>&nbsp;<span class="ident" id="1606896">_CaseSend</span><span class="op" id="1606905">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606910">if</span>&nbsp;<span class="ident" id="1606913">raceenabled</span>&nbsp;<span class="op" id="1606925">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606931">racereadpc</span><span class="op" id="1606941">(</span><span class="ident" id="1606942">unsafe</span><span class="op" id="1606948">.</span><span class="ident" id="1606949">Pointer</span><span class="op" id="1606956">(</span><span class="ident" id="1606957">c</span><span class="op" id="1606958">)</span><span class="op" id="1606959">,</span>&nbsp;<span class="ident" id="1606961">cas</span><span class="op" id="1606964">.</span><span class="ident" id="1606965">pc</span><span class="op" id="1606967">,</span>&nbsp;<span class="ident" id="1606969">chansendpc</span><span class="op" id="1606979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606989">if</span>&nbsp;<span class="ident" id="1606992">c</span><span class="op" id="1606993">.</span><span class="ident" id="1606994">closed</span>&nbsp;<span class="op" id="1607001">!=</span>&nbsp;<span class="num" id="1607004">0</span>&nbsp;<span class="op" id="1607006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607012">goto</span>&nbsp;<span class="ident" id="1607017">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607027">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607032">if</span>&nbsp;<span class="ident" id="1607035">c</span><span class="op" id="1607036">.</span><span class="ident" id="1607037">dataqsiz</span>&nbsp;<span class="op" id="1607046">&gt;</span>&nbsp;<span class="num" id="1607048">0</span>&nbsp;<span class="op" id="1607050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607056">if</span>&nbsp;<span class="ident" id="1607059">c</span><span class="op" id="1607060">.</span><span class="ident" id="1607061">qcount</span>&nbsp;<span class="op" id="1607068">&lt;</span>&nbsp;<span class="ident" id="1607070">c</span><span class="op" id="1607071">.</span><span class="ident" id="1607072">dataqsiz</span>&nbsp;<span class="op" id="1607081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607088">goto</span>&nbsp;<span class="ident" id="1607093">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607112">}</span>&nbsp;<span class="keyword" id="1607114">else</span>&nbsp;<span class="op" id="1607119">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607125">sg</span>&nbsp;<span class="op" id="1607128">=</span>&nbsp;<span class="ident" id="1607130">c</span><span class="op" id="1607131">.</span><span class="ident" id="1607132">recvq</span><span class="op" id="1607137">.</span><span class="ident" id="1607138">dequeue</span><span class="op" id="1607145">(</span><span class="op" id="1607146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607152">if</span>&nbsp;<span class="ident" id="1607155">sg</span>&nbsp;<span class="op" id="1607158">!=</span>&nbsp;<span class="builtintype" id="1607161">nil</span>&nbsp;<span class="op" id="1607165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607172">goto</span>&nbsp;<span class="ident" id="1607177">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607195">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607200">case</span>&nbsp;<span class="ident" id="1607205">_CaseDefault</span><span class="op" id="1607217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607222">dfl</span>&nbsp;<span class="op" id="1607226">=</span>&nbsp;<span class="ident" id="1607228">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607237">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607241">if</span>&nbsp;<span class="ident" id="1607244">dfl</span>&nbsp;<span class="op" id="1607248">!=</span>&nbsp;<span class="builtintype" id="1607251">nil</span>&nbsp;<span class="op" id="1607255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607259">selunlock</span><span class="op" id="1607268">(</span><span class="ident" id="1607269">sel</span><span class="op" id="1607272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607276">cas</span>&nbsp;<span class="op" id="1607280">=</span>&nbsp;<span class="ident" id="1607282">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607288">goto</span>&nbsp;<span class="ident" id="1607293">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607303">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607337">gp</span>&nbsp;<span class="op" id="1607340">=</span>&nbsp;<span class="ident" id="1607342">getg</span><span class="op" id="1607346">(</span><span class="op" id="1607347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607350">done</span>&nbsp;<span class="op" id="1607355">=</span>&nbsp;<span class="num" id="1607357">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607360">for</span>&nbsp;<span class="ident" id="1607364">i</span>&nbsp;<span class="op" id="1607366">:=</span>&nbsp;<span class="num" id="1607369">0</span><span class="op" id="1607370">;</span>&nbsp;<span class="ident" id="1607372">i</span>&nbsp;<span class="op" id="1607374">&lt;</span>&nbsp;<span class="builtintype" id="1607376">int</span><span class="op" id="1607379">(</span><span class="ident" id="1607380">sel</span><span class="op" id="1607383">.</span><span class="ident" id="1607384">ncase</span><span class="op" id="1607389">)</span><span class="op" id="1607390">;</span>&nbsp;<span class="ident" id="1607392">i</span><span class="op" id="1607393">++</span>&nbsp;<span class="op" id="1607396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607400">cas</span>&nbsp;<span class="op" id="1607404">=</span>&nbsp;<span class="op" id="1607406">&amp;</span><span class="ident" id="1607407">scases</span><span class="op" id="1607413">[</span><span class="ident" id="1607414">pollorder</span><span class="op" id="1607423">[</span><span class="ident" id="1607424">i</span><span class="op" id="1607425">]</span><span class="op" id="1607426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607430">c</span>&nbsp;<span class="op" id="1607432">=</span>&nbsp;<span class="ident" id="1607434">cas</span><span class="op" id="1607437">.</span><span class="ident" id="1607438">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607446">sg</span>&nbsp;<span class="op" id="1607449">:=</span>&nbsp;<span class="ident" id="1607452">acquireSudog</span><span class="op" id="1607464">(</span><span class="op" id="1607465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607469">sg</span><span class="op" id="1607471">.</span><span class="ident" id="1607472">g</span>&nbsp;<span class="op" id="1607474">=</span>&nbsp;<span class="ident" id="1607476">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607481">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607556">sg</span><span class="op" id="1607558">.</span><span class="ident" id="1607559">selectdone</span>&nbsp;<span class="op" id="1607570">=</span>&nbsp;<span class="op" id="1607572">(</span><span class="op" id="1607573">*</span><span class="builtintype" id="1607574">uint32</span><span class="op" id="1607580">)</span><span class="op" id="1607581">(</span><span class="ident" id="1607582">noescape</span><span class="op" id="1607590">(</span><span class="ident" id="1607591">unsafe</span><span class="op" id="1607597">.</span><span class="ident" id="1607598">Pointer</span><span class="op" id="1607605">(</span><span class="op" id="1607606">&amp;</span><span class="ident" id="1607607">done</span><span class="op" id="1607611">)</span><span class="op" id="1607612">)</span><span class="op" id="1607613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607617">sg</span><span class="op" id="1607619">.</span><span class="ident" id="1607620">elem</span>&nbsp;<span class="op" id="1607625">=</span>&nbsp;<span class="ident" id="1607627">cas</span><span class="op" id="1607630">.</span><span class="ident" id="1607631">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607638">sg</span><span class="op" id="1607640">.</span><span class="ident" id="1607641">releasetime</span>&nbsp;<span class="op" id="1607653">=</span>&nbsp;<span class="num" id="1607655">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607659">if</span>&nbsp;<span class="ident" id="1607662">t0</span>&nbsp;<span class="op" id="1607665">!=</span>&nbsp;<span class="num" id="1607668">0</span>&nbsp;<span class="op" id="1607670">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607675">sg</span><span class="op" id="1607677">.</span><span class="ident" id="1607678">releasetime</span>&nbsp;<span class="op" id="1607690">=</span>&nbsp;<span class="op" id="1607692">-</span><span class="num" id="1607693">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607701">sg</span><span class="op" id="1607703">.</span><span class="ident" id="1607704">waitlink</span>&nbsp;<span class="op" id="1607713">=</span>&nbsp;<span class="ident" id="1607715">gp</span><span class="op" id="1607717">.</span><span class="ident" id="1607718">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607728">gp</span><span class="op" id="1607730">.</span><span class="ident" id="1607731">waiting</span>&nbsp;<span class="op" id="1607739">=</span>&nbsp;<span class="ident" id="1607741">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607747">switch</span>&nbsp;<span class="ident" id="1607754">cas</span><span class="op" id="1607757">.</span><span class="ident" id="1607758">kind</span>&nbsp;<span class="op" id="1607763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607767">case</span>&nbsp;<span class="ident" id="1607772">_CaseRecv</span><span class="op" id="1607781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607786">c</span><span class="op" id="1607787">.</span><span class="ident" id="1607788">recvq</span><span class="op" id="1607793">.</span><span class="ident" id="1607794">enqueue</span><span class="op" id="1607801">(</span><span class="ident" id="1607802">sg</span><span class="op" id="1607804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607809">case</span>&nbsp;<span class="ident" id="1607814">_CaseSend</span><span class="op" id="1607823">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607828">c</span><span class="op" id="1607829">.</span><span class="ident" id="1607830">sendq</span><span class="op" id="1607835">.</span><span class="ident" id="1607836">enqueue</span><span class="op" id="1607843">(</span><span class="ident" id="1607844">sg</span><span class="op" id="1607846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607857">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607892">gp</span><span class="op" id="1607894">.</span><span class="ident" id="1607895">param</span>&nbsp;<span class="op" id="1607901">=</span>&nbsp;<span class="builtintype" id="1607903">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607908">gopark</span><span class="op" id="1607914">(</span><span class="ident" id="1607915">unsafe</span><span class="op" id="1607921">.</span><span class="ident" id="1607922">Pointer</span><span class="op" id="1607929">(</span><span class="ident" id="1607930">funcPC</span><span class="op" id="1607936">(</span><span class="ident" id="1607937">selparkcommit</span><span class="op" id="1607950">)</span><span class="op" id="1607951">)</span><span class="op" id="1607952">,</span>&nbsp;<span class="ident" id="1607954">unsafe</span><span class="op" id="1607960">.</span><span class="ident" id="1607961">Pointer</span><span class="op" id="1607968">(</span><span class="ident" id="1607969">sel</span><span class="op" id="1607972">)</span><span class="op" id="1607973">,</span>&nbsp;<span class="string" id="1607975">&#34;select&#34;</span><span class="op" id="1607983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607987">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608010">sellock</span><span class="op" id="1608017">(</span><span class="ident" id="1608018">sel</span><span class="op" id="1608021">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608024">sg</span>&nbsp;<span class="op" id="1608027">=</span>&nbsp;<span class="op" id="1608029">(</span><span class="op" id="1608030">*</span><span class="ident" id="1608031">sudog</span><span class="op" id="1608036">)</span><span class="op" id="1608037">(</span><span class="ident" id="1608038">gp</span><span class="op" id="1608040">.</span><span class="ident" id="1608041">param</span><span class="op" id="1608046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608049">gp</span><span class="op" id="1608051">.</span><span class="ident" id="1608052">param</span>&nbsp;<span class="op" id="1608058">=</span>&nbsp;<span class="builtintype" id="1608060">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608066">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608111">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608157">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608197">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608255">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608320">cas</span>&nbsp;<span class="op" id="1608324">=</span>&nbsp;<span class="builtintype" id="1608326">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608331">sglist</span>&nbsp;<span class="op" id="1608338">=</span>&nbsp;<span class="ident" id="1608340">gp</span><span class="op" id="1608342">.</span><span class="ident" id="1608343">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608352">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608420">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608489">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608567">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608642">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608708">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608731">for</span>&nbsp;<span class="ident" id="1608735">sg1</span>&nbsp;<span class="op" id="1608739">:=</span>&nbsp;<span class="ident" id="1608742">gp</span><span class="op" id="1608744">.</span><span class="ident" id="1608745">waiting</span><span class="op" id="1608752">;</span>&nbsp;<span class="ident" id="1608754">sg1</span>&nbsp;<span class="op" id="1608758">!=</span>&nbsp;<span class="builtintype" id="1608761">nil</span><span class="op" id="1608764">;</span>&nbsp;<span class="ident" id="1608766">sg1</span>&nbsp;<span class="op" id="1608770">=</span>&nbsp;<span class="ident" id="1608772">sg1</span><span class="op" id="1608775">.</span><span class="ident" id="1608776">waitlink</span>&nbsp;<span class="op" id="1608785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608789">sg1</span><span class="op" id="1608792">.</span><span class="ident" id="1608793">selectdone</span>&nbsp;<span class="op" id="1608804">=</span>&nbsp;<span class="builtintype" id="1608806">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608812">sg1</span><span class="op" id="1608815">.</span><span class="ident" id="1608816">elem</span>&nbsp;<span class="op" id="1608821">=</span>&nbsp;<span class="builtintype" id="1608823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608828">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608831">gp</span><span class="op" id="1608833">.</span><span class="ident" id="1608834">waiting</span>&nbsp;<span class="op" id="1608842">=</span>&nbsp;<span class="builtintype" id="1608844">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608849">for</span>&nbsp;<span class="ident" id="1608853">i</span>&nbsp;<span class="op" id="1608855">:=</span>&nbsp;<span class="builtintype" id="1608858">int</span><span class="op" id="1608861">(</span><span class="ident" id="1608862">sel</span><span class="op" id="1608865">.</span><span class="ident" id="1608866">ncase</span><span class="op" id="1608871">)</span>&nbsp;<span class="op" id="1608873">-</span>&nbsp;<span class="num" id="1608875">1</span><span class="op" id="1608876">;</span>&nbsp;<span class="ident" id="1608878">i</span>&nbsp;<span class="op" id="1608880">&gt;=</span>&nbsp;<span class="num" id="1608883">0</span><span class="op" id="1608884">;</span>&nbsp;<span class="ident" id="1608886">i</span><span class="op" id="1608887">--</span>&nbsp;<span class="op" id="1608890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608894">k</span>&nbsp;<span class="op" id="1608896">=</span>&nbsp;<span class="op" id="1608898">&amp;</span><span class="ident" id="1608899">scases</span><span class="op" id="1608905">[</span><span class="ident" id="1608906">pollorder</span><span class="op" id="1608915">[</span><span class="ident" id="1608916">i</span><span class="op" id="1608917">]</span><span class="op" id="1608918">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608922">if</span>&nbsp;<span class="ident" id="1608925">sglist</span><span class="op" id="1608931">.</span><span class="ident" id="1608932">releasetime</span>&nbsp;<span class="op" id="1608944">&gt;</span>&nbsp;<span class="num" id="1608946">0</span>&nbsp;<span class="op" id="1608948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608953">k</span><span class="op" id="1608954">.</span><span class="ident" id="1608955">releasetime</span>&nbsp;<span class="op" id="1608967">=</span>&nbsp;<span class="ident" id="1608969">sglist</span><span class="op" id="1608975">.</span><span class="ident" id="1608976">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608994">if</span>&nbsp;<span class="ident" id="1608997">sg</span>&nbsp;<span class="op" id="1609000">==</span>&nbsp;<span class="ident" id="1609003">sglist</span>&nbsp;<span class="op" id="1609010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609015">cas</span>&nbsp;<span class="op" id="1609019">=</span>&nbsp;<span class="ident" id="1609021">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609025">}</span>&nbsp;<span class="keyword" id="1609027">else</span>&nbsp;<span class="op" id="1609032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609037">c</span>&nbsp;<span class="op" id="1609039">=</span>&nbsp;<span class="ident" id="1609041">k</span><span class="op" id="1609042">.</span><span class="ident" id="1609043">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609052">if</span>&nbsp;<span class="ident" id="1609055">k</span><span class="op" id="1609056">.</span><span class="ident" id="1609057">kind</span>&nbsp;<span class="op" id="1609062">==</span>&nbsp;<span class="ident" id="1609065">_CaseSend</span>&nbsp;<span class="op" id="1609075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609081">c</span><span class="op" id="1609082">.</span><span class="ident" id="1609083">sendq</span><span class="op" id="1609088">.</span><span class="ident" id="1609089">dequeueSudoG</span><span class="op" id="1609101">(</span><span class="ident" id="1609102">sglist</span><span class="op" id="1609108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609113">}</span>&nbsp;<span class="keyword" id="1609115">else</span>&nbsp;<span class="op" id="1609120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609126">c</span><span class="op" id="1609127">.</span><span class="ident" id="1609128">recvq</span><span class="op" id="1609133">.</span><span class="ident" id="1609134">dequeueSudoG</span><span class="op" id="1609146">(</span><span class="ident" id="1609147">sglist</span><span class="op" id="1609153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609158">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609166">sgnext</span>&nbsp;<span class="op" id="1609173">=</span>&nbsp;<span class="ident" id="1609175">sglist</span><span class="op" id="1609181">.</span><span class="ident" id="1609182">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609193">sglist</span><span class="op" id="1609199">.</span><span class="ident" id="1609200">waitlink</span>&nbsp;<span class="op" id="1609209">=</span>&nbsp;<span class="builtintype" id="1609211">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609217">releaseSudog</span><span class="op" id="1609229">(</span><span class="ident" id="1609230">sglist</span><span class="op" id="1609236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609240">sglist</span>&nbsp;<span class="op" id="1609247">=</span>&nbsp;<span class="ident" id="1609249">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609261">if</span>&nbsp;<span class="ident" id="1609264">cas</span>&nbsp;<span class="op" id="1609268">==</span>&nbsp;<span class="builtintype" id="1609271">nil</span>&nbsp;<span class="op" id="1609275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609279">goto</span>&nbsp;<span class="ident" id="1609284">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609290">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609294">c</span>&nbsp;<span class="op" id="1609296">=</span>&nbsp;<span class="ident" id="1609298">cas</span><span class="op" id="1609301">.</span><span class="ident" id="1609302">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609310">if</span>&nbsp;<span class="ident" id="1609313">c</span><span class="op" id="1609314">.</span><span class="ident" id="1609315">dataqsiz</span>&nbsp;<span class="op" id="1609324">&gt;</span>&nbsp;<span class="num" id="1609326">0</span>&nbsp;<span class="op" id="1609328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609332">gothrow</span><span class="op" id="1609339">(</span><span class="string" id="1609340">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1609368">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609375">if</span>&nbsp;<span class="ident" id="1609378">debugSelect</span>&nbsp;<span class="op" id="1609390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1609394">print</span><span class="op" id="1609399">(</span><span class="string" id="1609400">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1609419">,</span>&nbsp;<span class="ident" id="1609421">sel</span><span class="op" id="1609424">,</span>&nbsp;<span class="string" id="1609426">&#34;&nbsp;c=&#34;</span><span class="op" id="1609431">,</span>&nbsp;<span class="ident" id="1609433">c</span><span class="op" id="1609434">,</span>&nbsp;<span class="string" id="1609436">&#34;&nbsp;cas=&#34;</span><span class="op" id="1609443">,</span>&nbsp;<span class="ident" id="1609445">cas</span><span class="op" id="1609448">,</span>&nbsp;<span class="string" id="1609450">&#34;&nbsp;kind=&#34;</span><span class="op" id="1609458">,</span>&nbsp;<span class="ident" id="1609460">cas</span><span class="op" id="1609463">.</span><span class="ident" id="1609464">kind</span><span class="op" id="1609468">,</span>&nbsp;<span class="string" id="1609470">&#34;\n&#34;</span><span class="op" id="1609474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609477">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609481">if</span>&nbsp;<span class="ident" id="1609484">cas</span><span class="op" id="1609487">.</span><span class="ident" id="1609488">kind</span>&nbsp;<span class="op" id="1609493">==</span>&nbsp;<span class="ident" id="1609496">_CaseRecv</span>&nbsp;<span class="op" id="1609506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609510">if</span>&nbsp;<span class="ident" id="1609513">cas</span><span class="op" id="1609516">.</span><span class="ident" id="1609517">receivedp</span>&nbsp;<span class="op" id="1609527">!=</span>&nbsp;<span class="builtintype" id="1609530">nil</span>&nbsp;<span class="op" id="1609534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609539">*</span><span class="ident" id="1609540">cas</span><span class="op" id="1609543">.</span><span class="ident" id="1609544">receivedp</span>&nbsp;<span class="op" id="1609554">=</span>&nbsp;<span class="builtintype" id="1609556">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609563">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609570">if</span>&nbsp;<span class="ident" id="1609573">raceenabled</span>&nbsp;<span class="op" id="1609585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609589">if</span>&nbsp;<span class="ident" id="1609592">cas</span><span class="op" id="1609595">.</span><span class="ident" id="1609596">kind</span>&nbsp;<span class="op" id="1609601">==</span>&nbsp;<span class="ident" id="1609604">_CaseRecv</span>&nbsp;<span class="op" id="1609614">&amp;&amp;</span>&nbsp;<span class="ident" id="1609617">cas</span><span class="op" id="1609620">.</span><span class="ident" id="1609621">elem</span>&nbsp;<span class="op" id="1609626">!=</span>&nbsp;<span class="builtintype" id="1609629">nil</span>&nbsp;<span class="op" id="1609633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609638">raceWriteObjectPC</span><span class="op" id="1609655">(</span><span class="ident" id="1609656">c</span><span class="op" id="1609657">.</span><span class="ident" id="1609658">elemtype</span><span class="op" id="1609666">,</span>&nbsp;<span class="ident" id="1609668">cas</span><span class="op" id="1609671">.</span><span class="ident" id="1609672">elem</span><span class="op" id="1609676">,</span>&nbsp;<span class="ident" id="1609678">cas</span><span class="op" id="1609681">.</span><span class="ident" id="1609682">pc</span><span class="op" id="1609684">,</span>&nbsp;<span class="ident" id="1609686">chanrecvpc</span><span class="op" id="1609696">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609700">}</span>&nbsp;<span class="keyword" id="1609702">else</span>&nbsp;<span class="keyword" id="1609707">if</span>&nbsp;<span class="ident" id="1609710">cas</span><span class="op" id="1609713">.</span><span class="ident" id="1609714">kind</span>&nbsp;<span class="op" id="1609719">==</span>&nbsp;<span class="ident" id="1609722">_CaseSend</span>&nbsp;<span class="op" id="1609732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609737">raceReadObjectPC</span><span class="op" id="1609753">(</span><span class="ident" id="1609754">c</span><span class="op" id="1609755">.</span><span class="ident" id="1609756">elemtype</span><span class="op" id="1609764">,</span>&nbsp;<span class="ident" id="1609766">cas</span><span class="op" id="1609769">.</span><span class="ident" id="1609770">elem</span><span class="op" id="1609774">,</span>&nbsp;<span class="ident" id="1609776">cas</span><span class="op" id="1609779">.</span><span class="ident" id="1609780">pc</span><span class="op" id="1609782">,</span>&nbsp;<span class="ident" id="1609784">chansendpc</span><span class="op" id="1609794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609805">selunlock</span><span class="op" id="1609814">(</span><span class="ident" id="1609815">sel</span><span class="op" id="1609818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609821">goto</span>&nbsp;<span class="ident" id="1609826">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1609832">asyncrecv</span><span class="op" id="1609841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1609844">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609872">if</span>&nbsp;<span class="ident" id="1609875">raceenabled</span>&nbsp;<span class="op" id="1609887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609891">if</span>&nbsp;<span class="ident" id="1609894">cas</span><span class="op" id="1609897">.</span><span class="ident" id="1609898">elem</span>&nbsp;<span class="op" id="1609903">!=</span>&nbsp;<span class="builtintype" id="1609906">nil</span>&nbsp;<span class="op" id="1609910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609915">raceWriteObjectPC</span><span class="op" id="1609932">(</span><span class="ident" id="1609933">c</span><span class="op" id="1609934">.</span><span class="ident" id="1609935">elemtype</span><span class="op" id="1609943">,</span>&nbsp;<span class="ident" id="1609945">cas</span><span class="op" id="1609948">.</span><span class="ident" id="1609949">elem</span><span class="op" id="1609953">,</span>&nbsp;<span class="ident" id="1609955">cas</span><span class="op" id="1609958">.</span><span class="ident" id="1609959">pc</span><span class="op" id="1609961">,</span>&nbsp;<span class="ident" id="1609963">chanrecvpc</span><span class="op" id="1609973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609981">raceacquire</span><span class="op" id="1609992">(</span><span class="ident" id="1609993">chanbuf</span><span class="op" id="1610000">(</span><span class="ident" id="1610001">c</span><span class="op" id="1610002">,</span>&nbsp;<span class="ident" id="1610004">c</span><span class="op" id="1610005">.</span><span class="ident" id="1610006">recvx</span><span class="op" id="1610011">)</span><span class="op" id="1610012">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610016">racerelease</span><span class="op" id="1610027">(</span><span class="ident" id="1610028">chanbuf</span><span class="op" id="1610035">(</span><span class="ident" id="1610036">c</span><span class="op" id="1610037">,</span>&nbsp;<span class="ident" id="1610039">c</span><span class="op" id="1610040">.</span><span class="ident" id="1610041">recvx</span><span class="op" id="1610046">)</span><span class="op" id="1610047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610053">if</span>&nbsp;<span class="ident" id="1610056">cas</span><span class="op" id="1610059">.</span><span class="ident" id="1610060">receivedp</span>&nbsp;<span class="op" id="1610070">!=</span>&nbsp;<span class="builtintype" id="1610073">nil</span>&nbsp;<span class="op" id="1610077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610081">*</span><span class="ident" id="1610082">cas</span><span class="op" id="1610085">.</span><span class="ident" id="1610086">receivedp</span>&nbsp;<span class="op" id="1610096">=</span>&nbsp;<span class="builtintype" id="1610098">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610104">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610107">if</span>&nbsp;<span class="ident" id="1610110">cas</span><span class="op" id="1610113">.</span><span class="ident" id="1610114">elem</span>&nbsp;<span class="op" id="1610119">!=</span>&nbsp;<span class="builtintype" id="1610122">nil</span>&nbsp;<span class="op" id="1610126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610130">memmove</span><span class="op" id="1610137">(</span><span class="ident" id="1610138">cas</span><span class="op" id="1610141">.</span><span class="ident" id="1610142">elem</span><span class="op" id="1610146">,</span>&nbsp;<span class="ident" id="1610148">chanbuf</span><span class="op" id="1610155">(</span><span class="ident" id="1610156">c</span><span class="op" id="1610157">,</span>&nbsp;<span class="ident" id="1610159">c</span><span class="op" id="1610160">.</span><span class="ident" id="1610161">recvx</span><span class="op" id="1610166">)</span><span class="op" id="1610167">,</span>&nbsp;<span class="builtintype" id="1610169">uintptr</span><span class="op" id="1610176">(</span><span class="ident" id="1610177">c</span><span class="op" id="1610178">.</span><span class="ident" id="1610179">elemsize</span><span class="op" id="1610187">)</span><span class="op" id="1610188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610194">memclr</span><span class="op" id="1610200">(</span><span class="ident" id="1610201">chanbuf</span><span class="op" id="1610208">(</span><span class="ident" id="1610209">c</span><span class="op" id="1610210">,</span>&nbsp;<span class="ident" id="1610212">c</span><span class="op" id="1610213">.</span><span class="ident" id="1610214">recvx</span><span class="op" id="1610219">)</span><span class="op" id="1610220">,</span>&nbsp;<span class="builtintype" id="1610222">uintptr</span><span class="op" id="1610229">(</span><span class="ident" id="1610230">c</span><span class="op" id="1610231">.</span><span class="ident" id="1610232">elemsize</span><span class="op" id="1610240">)</span><span class="op" id="1610241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610244">c</span><span class="op" id="1610245">.</span><span class="ident" id="1610246">recvx</span><span class="op" id="1610251">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610255">if</span>&nbsp;<span class="ident" id="1610258">c</span><span class="op" id="1610259">.</span><span class="ident" id="1610260">recvx</span>&nbsp;<span class="op" id="1610266">==</span>&nbsp;<span class="ident" id="1610269">c</span><span class="op" id="1610270">.</span><span class="ident" id="1610271">dataqsiz</span>&nbsp;<span class="op" id="1610280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610284">c</span><span class="op" id="1610285">.</span><span class="ident" id="1610286">recvx</span>&nbsp;<span class="op" id="1610292">=</span>&nbsp;<span class="num" id="1610294">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610300">c</span><span class="op" id="1610301">.</span><span class="ident" id="1610302">qcount</span><span class="op" id="1610308">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610312">sg</span>&nbsp;<span class="op" id="1610315">=</span>&nbsp;<span class="ident" id="1610317">c</span><span class="op" id="1610318">.</span><span class="ident" id="1610319">sendq</span><span class="op" id="1610324">.</span><span class="ident" id="1610325">dequeue</span><span class="op" id="1610332">(</span><span class="op" id="1610333">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610336">if</span>&nbsp;<span class="ident" id="1610339">sg</span>&nbsp;<span class="op" id="1610342">!=</span>&nbsp;<span class="builtintype" id="1610345">nil</span>&nbsp;<span class="op" id="1610349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610353">gp</span>&nbsp;<span class="op" id="1610356">=</span>&nbsp;<span class="ident" id="1610358">sg</span><span class="op" id="1610360">.</span><span class="ident" id="1610361">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610365">selunlock</span><span class="op" id="1610374">(</span><span class="ident" id="1610375">sel</span><span class="op" id="1610378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610382">if</span>&nbsp;<span class="ident" id="1610385">sg</span><span class="op" id="1610387">.</span><span class="ident" id="1610388">releasetime</span>&nbsp;<span class="op" id="1610400">!=</span>&nbsp;<span class="num" id="1610403">0</span>&nbsp;<span class="op" id="1610405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610410">sg</span><span class="op" id="1610412">.</span><span class="ident" id="1610413">releasetime</span>&nbsp;<span class="op" id="1610425">=</span>&nbsp;<span class="ident" id="1610427">cputicks</span><span class="op" id="1610435">(</span><span class="op" id="1610436">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610444">goready</span><span class="op" id="1610451">(</span><span class="ident" id="1610452">gp</span><span class="op" id="1610454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610457">}</span>&nbsp;<span class="keyword" id="1610459">else</span>&nbsp;<span class="op" id="1610464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610468">selunlock</span><span class="op" id="1610477">(</span><span class="ident" id="1610478">sel</span><span class="op" id="1610481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610484">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610487">goto</span>&nbsp;<span class="ident" id="1610492">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1610498">asyncsend</span><span class="op" id="1610507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610510">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610533">if</span>&nbsp;<span class="ident" id="1610536">raceenabled</span>&nbsp;<span class="op" id="1610548">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610552">raceacquire</span><span class="op" id="1610563">(</span><span class="ident" id="1610564">chanbuf</span><span class="op" id="1610571">(</span><span class="ident" id="1610572">c</span><span class="op" id="1610573">,</span>&nbsp;<span class="ident" id="1610575">c</span><span class="op" id="1610576">.</span><span class="ident" id="1610577">sendx</span><span class="op" id="1610582">)</span><span class="op" id="1610583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610587">racerelease</span><span class="op" id="1610598">(</span><span class="ident" id="1610599">chanbuf</span><span class="op" id="1610606">(</span><span class="ident" id="1610607">c</span><span class="op" id="1610608">,</span>&nbsp;<span class="ident" id="1610610">c</span><span class="op" id="1610611">.</span><span class="ident" id="1610612">sendx</span><span class="op" id="1610617">)</span><span class="op" id="1610618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610622">raceReadObjectPC</span><span class="op" id="1610638">(</span><span class="ident" id="1610639">c</span><span class="op" id="1610640">.</span><span class="ident" id="1610641">elemtype</span><span class="op" id="1610649">,</span>&nbsp;<span class="ident" id="1610651">cas</span><span class="op" id="1610654">.</span><span class="ident" id="1610655">elem</span><span class="op" id="1610659">,</span>&nbsp;<span class="ident" id="1610661">cas</span><span class="op" id="1610664">.</span><span class="ident" id="1610665">pc</span><span class="op" id="1610667">,</span>&nbsp;<span class="ident" id="1610669">chansendpc</span><span class="op" id="1610679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610685">memmove</span><span class="op" id="1610692">(</span><span class="ident" id="1610693">chanbuf</span><span class="op" id="1610700">(</span><span class="ident" id="1610701">c</span><span class="op" id="1610702">,</span>&nbsp;<span class="ident" id="1610704">c</span><span class="op" id="1610705">.</span><span class="ident" id="1610706">sendx</span><span class="op" id="1610711">)</span><span class="op" id="1610712">,</span>&nbsp;<span class="ident" id="1610714">cas</span><span class="op" id="1610717">.</span><span class="ident" id="1610718">elem</span><span class="op" id="1610722">,</span>&nbsp;<span class="builtintype" id="1610724">uintptr</span><span class="op" id="1610731">(</span><span class="ident" id="1610732">c</span><span class="op" id="1610733">.</span><span class="ident" id="1610734">elemsize</span><span class="op" id="1610742">)</span><span class="op" id="1610743">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610746">c</span><span class="op" id="1610747">.</span><span class="ident" id="1610748">sendx</span><span class="op" id="1610753">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610757">if</span>&nbsp;<span class="ident" id="1610760">c</span><span class="op" id="1610761">.</span><span class="ident" id="1610762">sendx</span>&nbsp;<span class="op" id="1610768">==</span>&nbsp;<span class="ident" id="1610771">c</span><span class="op" id="1610772">.</span><span class="ident" id="1610773">dataqsiz</span>&nbsp;<span class="op" id="1610782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610786">c</span><span class="op" id="1610787">.</span><span class="ident" id="1610788">sendx</span>&nbsp;<span class="op" id="1610794">=</span>&nbsp;<span class="num" id="1610796">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610802">c</span><span class="op" id="1610803">.</span><span class="ident" id="1610804">qcount</span><span class="op" id="1610810">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610814">sg</span>&nbsp;<span class="op" id="1610817">=</span>&nbsp;<span class="ident" id="1610819">c</span><span class="op" id="1610820">.</span><span class="ident" id="1610821">recvq</span><span class="op" id="1610826">.</span><span class="ident" id="1610827">dequeue</span><span class="op" id="1610834">(</span><span class="op" id="1610835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610838">if</span>&nbsp;<span class="ident" id="1610841">sg</span>&nbsp;<span class="op" id="1610844">!=</span>&nbsp;<span class="builtintype" id="1610847">nil</span>&nbsp;<span class="op" id="1610851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610855">gp</span>&nbsp;<span class="op" id="1610858">=</span>&nbsp;<span class="ident" id="1610860">sg</span><span class="op" id="1610862">.</span><span class="ident" id="1610863">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610867">selunlock</span><span class="op" id="1610876">(</span><span class="ident" id="1610877">sel</span><span class="op" id="1610880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610884">if</span>&nbsp;<span class="ident" id="1610887">sg</span><span class="op" id="1610889">.</span><span class="ident" id="1610890">releasetime</span>&nbsp;<span class="op" id="1610902">!=</span>&nbsp;<span class="num" id="1610905">0</span>&nbsp;<span class="op" id="1610907">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610912">sg</span><span class="op" id="1610914">.</span><span class="ident" id="1610915">releasetime</span>&nbsp;<span class="op" id="1610927">=</span>&nbsp;<span class="ident" id="1610929">cputicks</span><span class="op" id="1610937">(</span><span class="op" id="1610938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610946">goready</span><span class="op" id="1610953">(</span><span class="ident" id="1610954">gp</span><span class="op" id="1610956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610959">}</span>&nbsp;<span class="keyword" id="1610961">else</span>&nbsp;<span class="op" id="1610966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610970">selunlock</span><span class="op" id="1610979">(</span><span class="ident" id="1610980">sel</span><span class="op" id="1610983">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610989">goto</span>&nbsp;<span class="ident" id="1610994">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1611000">syncrecv</span><span class="op" id="1611008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611011">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611053">if</span>&nbsp;<span class="ident" id="1611056">raceenabled</span>&nbsp;<span class="op" id="1611068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611072">if</span>&nbsp;<span class="ident" id="1611075">cas</span><span class="op" id="1611078">.</span><span class="ident" id="1611079">elem</span>&nbsp;<span class="op" id="1611084">!=</span>&nbsp;<span class="builtintype" id="1611087">nil</span>&nbsp;<span class="op" id="1611091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611096">raceWriteObjectPC</span><span class="op" id="1611113">(</span><span class="ident" id="1611114">c</span><span class="op" id="1611115">.</span><span class="ident" id="1611116">elemtype</span><span class="op" id="1611124">,</span>&nbsp;<span class="ident" id="1611126">cas</span><span class="op" id="1611129">.</span><span class="ident" id="1611130">elem</span><span class="op" id="1611134">,</span>&nbsp;<span class="ident" id="1611136">cas</span><span class="op" id="1611139">.</span><span class="ident" id="1611140">pc</span><span class="op" id="1611142">,</span>&nbsp;<span class="ident" id="1611144">chanrecvpc</span><span class="op" id="1611154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611162">racesync</span><span class="op" id="1611170">(</span><span class="ident" id="1611171">c</span><span class="op" id="1611172">,</span>&nbsp;<span class="ident" id="1611174">sg</span><span class="op" id="1611176">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611182">selunlock</span><span class="op" id="1611191">(</span><span class="ident" id="1611192">sel</span><span class="op" id="1611195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611198">if</span>&nbsp;<span class="ident" id="1611201">debugSelect</span>&nbsp;<span class="op" id="1611213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1611217">print</span><span class="op" id="1611222">(</span><span class="string" id="1611223">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1611239">,</span>&nbsp;<span class="ident" id="1611241">sel</span><span class="op" id="1611244">,</span>&nbsp;<span class="string" id="1611246">&#34;&nbsp;c=&#34;</span><span class="op" id="1611251">,</span>&nbsp;<span class="ident" id="1611253">c</span><span class="op" id="1611254">,</span>&nbsp;<span class="string" id="1611256">&#34;\n&#34;</span><span class="op" id="1611260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611263">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611266">if</span>&nbsp;<span class="ident" id="1611269">cas</span><span class="op" id="1611272">.</span><span class="ident" id="1611273">receivedp</span>&nbsp;<span class="op" id="1611283">!=</span>&nbsp;<span class="builtintype" id="1611286">nil</span>&nbsp;<span class="op" id="1611290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611294">*</span><span class="ident" id="1611295">cas</span><span class="op" id="1611298">.</span><span class="ident" id="1611299">receivedp</span>&nbsp;<span class="op" id="1611309">=</span>&nbsp;<span class="builtintype" id="1611311">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611320">if</span>&nbsp;<span class="ident" id="1611323">cas</span><span class="op" id="1611326">.</span><span class="ident" id="1611327">elem</span>&nbsp;<span class="op" id="1611332">!=</span>&nbsp;<span class="builtintype" id="1611335">nil</span>&nbsp;<span class="op" id="1611339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611343">memmove</span><span class="op" id="1611350">(</span><span class="ident" id="1611351">cas</span><span class="op" id="1611354">.</span><span class="ident" id="1611355">elem</span><span class="op" id="1611359">,</span>&nbsp;<span class="ident" id="1611361">sg</span><span class="op" id="1611363">.</span><span class="ident" id="1611364">elem</span><span class="op" id="1611368">,</span>&nbsp;<span class="builtintype" id="1611370">uintptr</span><span class="op" id="1611377">(</span><span class="ident" id="1611378">c</span><span class="op" id="1611379">.</span><span class="ident" id="1611380">elemsize</span><span class="op" id="1611388">)</span><span class="op" id="1611389">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611395">sg</span><span class="op" id="1611397">.</span><span class="ident" id="1611398">elem</span>&nbsp;<span class="op" id="1611403">=</span>&nbsp;<span class="builtintype" id="1611405">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611410">gp</span>&nbsp;<span class="op" id="1611413">=</span>&nbsp;<span class="ident" id="1611415">sg</span><span class="op" id="1611417">.</span><span class="ident" id="1611418">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611421">gp</span><span class="op" id="1611423">.</span><span class="ident" id="1611424">param</span>&nbsp;<span class="op" id="1611430">=</span>&nbsp;<span class="ident" id="1611432">unsafe</span><span class="op" id="1611438">.</span><span class="ident" id="1611439">Pointer</span><span class="op" id="1611446">(</span><span class="ident" id="1611447">sg</span><span class="op" id="1611449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611452">if</span>&nbsp;<span class="ident" id="1611455">sg</span><span class="op" id="1611457">.</span><span class="ident" id="1611458">releasetime</span>&nbsp;<span class="op" id="1611470">!=</span>&nbsp;<span class="num" id="1611473">0</span>&nbsp;<span class="op" id="1611475">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611479">sg</span><span class="op" id="1611481">.</span><span class="ident" id="1611482">releasetime</span>&nbsp;<span class="op" id="1611494">=</span>&nbsp;<span class="ident" id="1611496">cputicks</span><span class="op" id="1611504">(</span><span class="op" id="1611505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611511">goready</span><span class="op" id="1611518">(</span><span class="ident" id="1611519">gp</span><span class="op" id="1611521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611524">goto</span>&nbsp;<span class="ident" id="1611529">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1611535">rclose</span><span class="op" id="1611541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611544">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611578">selunlock</span><span class="op" id="1611587">(</span><span class="ident" id="1611588">sel</span><span class="op" id="1611591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611594">if</span>&nbsp;<span class="ident" id="1611597">cas</span><span class="op" id="1611600">.</span><span class="ident" id="1611601">receivedp</span>&nbsp;<span class="op" id="1611611">!=</span>&nbsp;<span class="builtintype" id="1611614">nil</span>&nbsp;<span class="op" id="1611618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611622">*</span><span class="ident" id="1611623">cas</span><span class="op" id="1611626">.</span><span class="ident" id="1611627">receivedp</span>&nbsp;<span class="op" id="1611637">=</span>&nbsp;<span class="builtintype" id="1611639">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611649">if</span>&nbsp;<span class="ident" id="1611652">cas</span><span class="op" id="1611655">.</span><span class="ident" id="1611656">elem</span>&nbsp;<span class="op" id="1611661">!=</span>&nbsp;<span class="builtintype" id="1611664">nil</span>&nbsp;<span class="op" id="1611668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611672">memclr</span><span class="op" id="1611678">(</span><span class="ident" id="1611679">cas</span><span class="op" id="1611682">.</span><span class="ident" id="1611683">elem</span><span class="op" id="1611687">,</span>&nbsp;<span class="builtintype" id="1611689">uintptr</span><span class="op" id="1611696">(</span><span class="ident" id="1611697">c</span><span class="op" id="1611698">.</span><span class="ident" id="1611699">elemsize</span><span class="op" id="1611707">)</span><span class="op" id="1611708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611714">if</span>&nbsp;<span class="ident" id="1611717">raceenabled</span>&nbsp;<span class="op" id="1611729">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611733">raceacquire</span><span class="op" id="1611744">(</span><span class="ident" id="1611745">unsafe</span><span class="op" id="1611751">.</span><span class="ident" id="1611752">Pointer</span><span class="op" id="1611759">(</span><span class="ident" id="1611760">c</span><span class="op" id="1611761">)</span><span class="op" id="1611762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611768">goto</span>&nbsp;<span class="ident" id="1611773">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1611779">syncsend</span><span class="op" id="1611787">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611790">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611829">if</span>&nbsp;<span class="ident" id="1611832">raceenabled</span>&nbsp;<span class="op" id="1611844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611848">raceReadObjectPC</span><span class="op" id="1611864">(</span><span class="ident" id="1611865">c</span><span class="op" id="1611866">.</span><span class="ident" id="1611867">elemtype</span><span class="op" id="1611875">,</span>&nbsp;<span class="ident" id="1611877">cas</span><span class="op" id="1611880">.</span><span class="ident" id="1611881">elem</span><span class="op" id="1611885">,</span>&nbsp;<span class="ident" id="1611887">cas</span><span class="op" id="1611890">.</span><span class="ident" id="1611891">pc</span><span class="op" id="1611893">,</span>&nbsp;<span class="ident" id="1611895">chansendpc</span><span class="op" id="1611905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611909">racesync</span><span class="op" id="1611917">(</span><span class="ident" id="1611918">c</span><span class="op" id="1611919">,</span>&nbsp;<span class="ident" id="1611921">sg</span><span class="op" id="1611923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611926">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611929">selunlock</span><span class="op" id="1611938">(</span><span class="ident" id="1611939">sel</span><span class="op" id="1611942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611945">if</span>&nbsp;<span class="ident" id="1611948">debugSelect</span>&nbsp;<span class="op" id="1611960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1611964">print</span><span class="op" id="1611969">(</span><span class="string" id="1611970">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1611986">,</span>&nbsp;<span class="ident" id="1611988">sel</span><span class="op" id="1611991">,</span>&nbsp;<span class="string" id="1611993">&#34;&nbsp;c=&#34;</span><span class="op" id="1611998">,</span>&nbsp;<span class="ident" id="1612000">c</span><span class="op" id="1612001">,</span>&nbsp;<span class="string" id="1612003">&#34;\n&#34;</span><span class="op" id="1612007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612013">if</span>&nbsp;<span class="ident" id="1612016">sg</span><span class="op" id="1612018">.</span><span class="ident" id="1612019">elem</span>&nbsp;<span class="op" id="1612024">!=</span>&nbsp;<span class="builtintype" id="1612027">nil</span>&nbsp;<span class="op" id="1612031">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612035">memmove</span><span class="op" id="1612042">(</span><span class="ident" id="1612043">sg</span><span class="op" id="1612045">.</span><span class="ident" id="1612046">elem</span><span class="op" id="1612050">,</span>&nbsp;<span class="ident" id="1612052">cas</span><span class="op" id="1612055">.</span><span class="ident" id="1612056">elem</span><span class="op" id="1612060">,</span>&nbsp;<span class="builtintype" id="1612062">uintptr</span><span class="op" id="1612069">(</span><span class="ident" id="1612070">c</span><span class="op" id="1612071">.</span><span class="ident" id="1612072">elemsize</span><span class="op" id="1612080">)</span><span class="op" id="1612081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612087">sg</span><span class="op" id="1612089">.</span><span class="ident" id="1612090">elem</span>&nbsp;<span class="op" id="1612095">=</span>&nbsp;<span class="builtintype" id="1612097">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612102">gp</span>&nbsp;<span class="op" id="1612105">=</span>&nbsp;<span class="ident" id="1612107">sg</span><span class="op" id="1612109">.</span><span class="ident" id="1612110">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612113">gp</span><span class="op" id="1612115">.</span><span class="ident" id="1612116">param</span>&nbsp;<span class="op" id="1612122">=</span>&nbsp;<span class="ident" id="1612124">unsafe</span><span class="op" id="1612130">.</span><span class="ident" id="1612131">Pointer</span><span class="op" id="1612138">(</span><span class="ident" id="1612139">sg</span><span class="op" id="1612141">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612144">if</span>&nbsp;<span class="ident" id="1612147">sg</span><span class="op" id="1612149">.</span><span class="ident" id="1612150">releasetime</span>&nbsp;<span class="op" id="1612162">!=</span>&nbsp;<span class="num" id="1612165">0</span>&nbsp;<span class="op" id="1612167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612171">sg</span><span class="op" id="1612173">.</span><span class="ident" id="1612174">releasetime</span>&nbsp;<span class="op" id="1612186">=</span>&nbsp;<span class="ident" id="1612188">cputicks</span><span class="op" id="1612196">(</span><span class="op" id="1612197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612203">goready</span><span class="op" id="1612210">(</span><span class="ident" id="1612211">gp</span><span class="op" id="1612213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1612216">retc</span><span class="op" id="1612220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612223">if</span>&nbsp;<span class="ident" id="1612226">cas</span><span class="op" id="1612229">.</span><span class="ident" id="1612230">releasetime</span>&nbsp;<span class="op" id="1612242">&gt;</span>&nbsp;<span class="num" id="1612244">0</span>&nbsp;<span class="op" id="1612246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612250">blockevent</span><span class="op" id="1612260">(</span><span class="ident" id="1612261">cas</span><span class="op" id="1612264">.</span><span class="ident" id="1612265">releasetime</span><span class="op" id="1612276">-</span><span class="ident" id="1612277">t0</span><span class="op" id="1612279">,</span>&nbsp;<span class="num" id="1612281">2</span><span class="op" id="1612282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612288">return</span>&nbsp;<span class="ident" id="1612295">cas</span><span class="op" id="1612298">.</span><span class="ident" id="1612299">pc</span><span class="op" id="1612301">,</span>&nbsp;<span class="ident" id="1612303">cas</span><span class="op" id="1612306">.</span><span class="ident" id="1612307">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1612311">sclose</span><span class="op" id="1612317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1612320">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612347">selunlock</span><span class="op" id="1612356">(</span><span class="ident" id="1612357">sel</span><span class="op" id="1612360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1612363">panic</span><span class="op" id="1612368">(</span><span class="string" id="1612369">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1612393">)</span><br>
<span class="lineno">575</span><span class="op" id="1612395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1612398">func</span>&nbsp;<span class="op" id="1612403">(</span><span class="ident" id="1612404">c</span>&nbsp;<span class="op" id="1612406">*</span><span class="ident" id="1612407">hchan</span><span class="op" id="1612412">)</span>&nbsp;<span class="ident" id="1612414">sortkey</span><span class="op" id="1612421">(</span><span class="op" id="1612422">)</span>&nbsp;<span class="builtintype" id="1612424">uintptr</span>&nbsp;<span class="op" id="1612432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1612435">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1612503">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612529">return</span>&nbsp;<span class="builtintype" id="1612536">uintptr</span><span class="op" id="1612543">(</span><span class="ident" id="1612544">unsafe</span><span class="op" id="1612550">.</span><span class="ident" id="1612551">Pointer</span><span class="op" id="1612558">(</span><span class="ident" id="1612559">c</span><span class="op" id="1612560">)</span><span class="op" id="1612561">)</span><br>
<span class="lineno"></span><span class="op" id="1612563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612566">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1612621">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1612675">type</span>&nbsp;<span class="ident" id="1612680">runtimeSelect</span>&nbsp;<span class="keyword" id="1612694">struct</span>&nbsp;<span class="op" id="1612701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612704">dir</span>&nbsp;<span class="ident" id="1612708">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612719">typ</span>&nbsp;<span class="ident" id="1612723">unsafe</span><span class="op" id="1612729">.</span><span class="ident" id="1612730">Pointer</span>&nbsp;<span class="comment" id="1612738">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612771">ch</span>&nbsp;&nbsp;<span class="op" id="1612775">*</span><span class="ident" id="1612776">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1612790">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612802">val</span>&nbsp;<span class="ident" id="1612806">unsafe</span><span class="op" id="1612812">.</span><span class="ident" id="1612813">Pointer</span>&nbsp;<span class="comment" id="1612821">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1612881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612884">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1612943">type</span>&nbsp;<span class="ident" id="1612948">selectDir</span>&nbsp;<span class="builtintype" id="1612958">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1612963">const</span>&nbsp;<span class="op" id="1612969">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612972">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612986">selectDir</span>&nbsp;<span class="op" id="1612996">=</span>&nbsp;<span class="ident" id="1612998">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613004">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1613028">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613050">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1613074">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613091">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1613115">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1613126">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1613129">func</span>&nbsp;<span class="ident" id="1613134">reflect_rselect</span><span class="op" id="1613149">(</span><span class="ident" id="1613150">cases</span>&nbsp;<span class="op" id="1613156">[</span><span class="op" id="1613157">]</span><span class="ident" id="1613158">runtimeSelect</span><span class="op" id="1613171">)</span>&nbsp;<span class="op" id="1613173">(</span><span class="ident" id="1613174">chosen</span>&nbsp;<span class="builtintype" id="1613181">int</span><span class="op" id="1613184">,</span>&nbsp;<span class="ident" id="1613186">recvOK</span>&nbsp;<span class="builtintype" id="1613193">bool</span><span class="op" id="1613197">)</span>&nbsp;<span class="op" id="1613199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1613202">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613283">size</span>&nbsp;<span class="op" id="1613288">:=</span>&nbsp;<span class="ident" id="1613291">selectsize</span><span class="op" id="1613301">(</span><span class="builtintype" id="1613302">uintptr</span><span class="op" id="1613309">(</span><span class="builtinfunc" id="1613310">len</span><span class="op" id="1613313">(</span><span class="ident" id="1613314">cases</span><span class="op" id="1613319">)</span><span class="op" id="1613320">)</span><span class="op" id="1613321">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613324">sel</span>&nbsp;<span class="op" id="1613328">:=</span>&nbsp;<span class="op" id="1613331">(</span><span class="op" id="1613332">*</span><span class="ident" id="1613333">_select</span><span class="op" id="1613340">)</span><span class="op" id="1613341">(</span><span class="ident" id="1613342">mallocgc</span><span class="op" id="1613350">(</span><span class="ident" id="1613351">size</span><span class="op" id="1613355">,</span>&nbsp;<span class="builtintype" id="1613357">nil</span><span class="op" id="1613360">,</span>&nbsp;<span class="ident" id="1613362">flagNoScan</span><span class="op" id="1613372">)</span><span class="op" id="1613373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613376">newselect</span><span class="op" id="1613385">(</span><span class="ident" id="1613386">sel</span><span class="op" id="1613389">,</span>&nbsp;<span class="builtintype" id="1613391">int64</span><span class="op" id="1613396">(</span><span class="ident" id="1613397">size</span><span class="op" id="1613401">)</span><span class="op" id="1613402">,</span>&nbsp;<span class="builtintype" id="1613404">int32</span><span class="op" id="1613409">(</span><span class="builtinfunc" id="1613410">len</span><span class="op" id="1613413">(</span><span class="ident" id="1613414">cases</span><span class="op" id="1613419">)</span><span class="op" id="1613420">)</span><span class="op" id="1613421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613424">r</span>&nbsp;<span class="op" id="1613426">:=</span>&nbsp;<span class="builtinfunc" id="1613429">new</span><span class="op" id="1613432">(</span><span class="builtintype" id="1613433">bool</span><span class="op" id="1613437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613440">for</span>&nbsp;<span class="ident" id="1613444">i</span>&nbsp;<span class="op" id="1613446">:=</span>&nbsp;<span class="keyword" id="1613449">range</span>&nbsp;<span class="ident" id="1613455">cases</span>&nbsp;<span class="op" id="1613461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613465">rc</span>&nbsp;<span class="op" id="1613468">:=</span>&nbsp;<span class="op" id="1613471">&amp;</span><span class="ident" id="1613472">cases</span><span class="op" id="1613477">[</span><span class="ident" id="1613478">i</span><span class="op" id="1613479">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613483">switch</span>&nbsp;<span class="ident" id="1613490">rc</span><span class="op" id="1613492">.</span><span class="ident" id="1613493">dir</span>&nbsp;<span class="op" id="1613497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613501">case</span>&nbsp;<span class="ident" id="1613506">selectDefault</span><span class="op" id="1613519">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613524">selectdefaultImpl</span><span class="op" id="1613541">(</span><span class="ident" id="1613542">sel</span><span class="op" id="1613545">,</span>&nbsp;<span class="builtintype" id="1613547">uintptr</span><span class="op" id="1613554">(</span><span class="ident" id="1613555">i</span><span class="op" id="1613556">)</span><span class="op" id="1613557">,</span>&nbsp;<span class="num" id="1613559">0</span><span class="op" id="1613560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613564">case</span>&nbsp;<span class="ident" id="1613569">selectSend</span><span class="op" id="1613579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613584">if</span>&nbsp;<span class="ident" id="1613587">rc</span><span class="op" id="1613589">.</span><span class="ident" id="1613590">ch</span>&nbsp;<span class="op" id="1613593">==</span>&nbsp;<span class="builtintype" id="1613596">nil</span>&nbsp;<span class="op" id="1613600">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613606">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613620">selectsendImpl</span><span class="op" id="1613634">(</span><span class="ident" id="1613635">sel</span><span class="op" id="1613638">,</span>&nbsp;<span class="ident" id="1613640">rc</span><span class="op" id="1613642">.</span><span class="ident" id="1613643">ch</span><span class="op" id="1613645">,</span>&nbsp;<span class="builtintype" id="1613647">uintptr</span><span class="op" id="1613654">(</span><span class="ident" id="1613655">i</span><span class="op" id="1613656">)</span><span class="op" id="1613657">,</span>&nbsp;<span class="ident" id="1613659">rc</span><span class="op" id="1613661">.</span><span class="ident" id="1613662">val</span><span class="op" id="1613665">,</span>&nbsp;<span class="num" id="1613667">0</span><span class="op" id="1613668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613672">case</span>&nbsp;<span class="ident" id="1613677">selectRecv</span><span class="op" id="1613687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613692">if</span>&nbsp;<span class="ident" id="1613695">rc</span><span class="op" id="1613697">.</span><span class="ident" id="1613698">ch</span>&nbsp;<span class="op" id="1613701">==</span>&nbsp;<span class="builtintype" id="1613704">nil</span>&nbsp;<span class="op" id="1613708">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613714">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613728">selectrecvImpl</span><span class="op" id="1613742">(</span><span class="ident" id="1613743">sel</span><span class="op" id="1613746">,</span>&nbsp;<span class="ident" id="1613748">rc</span><span class="op" id="1613750">.</span><span class="ident" id="1613751">ch</span><span class="op" id="1613753">,</span>&nbsp;<span class="builtintype" id="1613755">uintptr</span><span class="op" id="1613762">(</span><span class="ident" id="1613763">i</span><span class="op" id="1613764">)</span><span class="op" id="1613765">,</span>&nbsp;<span class="ident" id="1613767">rc</span><span class="op" id="1613769">.</span><span class="ident" id="1613770">val</span><span class="op" id="1613773">,</span>&nbsp;<span class="ident" id="1613775">r</span><span class="op" id="1613776">,</span>&nbsp;<span class="num" id="1613778">0</span><span class="op" id="1613779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613786">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613790">pc</span><span class="op" id="1613792">,</span>&nbsp;<span class="ident" id="1613794">_</span>&nbsp;<span class="op" id="1613796">:=</span>&nbsp;<span class="ident" id="1613799">selectgoImpl</span><span class="op" id="1613811">(</span><span class="ident" id="1613812">sel</span><span class="op" id="1613815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613818">chosen</span>&nbsp;<span class="op" id="1613825">=</span>&nbsp;<span class="builtintype" id="1613827">int</span><span class="op" id="1613830">(</span><span class="ident" id="1613831">pc</span><span class="op" id="1613833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613836">recvOK</span>&nbsp;<span class="op" id="1613843">=</span>&nbsp;<span class="op" id="1613845">*</span><span class="ident" id="1613846">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613849">return</span><br>
<span class="lineno">630</span><span class="op" id="1613856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1613859">func</span>&nbsp;<span class="op" id="1613864">(</span><span class="ident" id="1613865">q</span>&nbsp;<span class="op" id="1613867">*</span><span class="ident" id="1613868">waitq</span><span class="op" id="1613873">)</span>&nbsp;<span class="ident" id="1613875">dequeueSudoG</span><span class="op" id="1613887">(</span><span class="ident" id="1613888">s</span>&nbsp;<span class="op" id="1613890">*</span><span class="ident" id="1613891">sudog</span><span class="op" id="1613896">)</span>&nbsp;<span class="op" id="1613898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613901">var</span>&nbsp;<span class="ident" id="1613905">prevsgp</span>&nbsp;<span class="op" id="1613913">*</span><span class="ident" id="1613914">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613921">l</span>&nbsp;<span class="op" id="1613923">:=</span>&nbsp;<span class="op" id="1613926">&amp;</span><span class="ident" id="1613927">q</span><span class="op" id="1613928">.</span><span class="ident" id="1613929">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613936">for</span>&nbsp;<span class="op" id="1613940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613944">sgp</span>&nbsp;<span class="op" id="1613948">:=</span>&nbsp;<span class="op" id="1613951">*</span><span class="ident" id="1613952">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613956">if</span>&nbsp;<span class="ident" id="1613959">sgp</span>&nbsp;<span class="op" id="1613963">==</span>&nbsp;<span class="builtintype" id="1613966">nil</span>&nbsp;<span class="op" id="1613970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613975">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613984">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613988">if</span>&nbsp;<span class="ident" id="1613991">sgp</span>&nbsp;<span class="op" id="1613995">==</span>&nbsp;<span class="ident" id="1613998">s</span>&nbsp;<span class="op" id="1614000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1614005">*</span><span class="ident" id="1614006">l</span>&nbsp;<span class="op" id="1614008">=</span>&nbsp;<span class="ident" id="1614010">sgp</span><span class="op" id="1614013">.</span><span class="ident" id="1614014">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1614022">if</span>&nbsp;<span class="ident" id="1614025">q</span><span class="op" id="1614026">.</span><span class="ident" id="1614027">last</span>&nbsp;<span class="op" id="1614032">==</span>&nbsp;<span class="ident" id="1614035">sgp</span>&nbsp;<span class="op" id="1614039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1614045">q</span><span class="op" id="1614046">.</span><span class="ident" id="1614047">last</span>&nbsp;<span class="op" id="1614052">=</span>&nbsp;<span class="ident" id="1614054">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1614065">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1614070">s</span><span class="op" id="1614071">.</span><span class="ident" id="1614072">next</span>&nbsp;<span class="op" id="1614077">=</span>&nbsp;<span class="builtintype" id="1614079">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1614086">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1614095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1614099">l</span>&nbsp;<span class="op" id="1614101">=</span>&nbsp;<span class="op" id="1614103">&amp;</span><span class="ident" id="1614104">sgp</span><span class="op" id="1614107">.</span><span class="ident" id="1614108">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1614115">prevsgp</span>&nbsp;<span class="op" id="1614123">=</span>&nbsp;<span class="ident" id="1614125">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1614130">}</span><br>
<span class="lineno"></span><span class="op" id="1614132">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
