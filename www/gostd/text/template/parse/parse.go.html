<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html" class="current">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3111630">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3111685">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3111739">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3111790">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="3111868">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="3111947">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3112023">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3112052">package</span>&nbsp;<span class="ident" id="3112060">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3112067">import</span>&nbsp;<span class="op" id="3112074">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3112077">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3112086">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3112093">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3112104">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3112115">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3112125">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112128">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="3112187">type</span>&nbsp;<span class="ident" id="3112192">Tree</span>&nbsp;<span class="keyword" id="3112197">struct</span>&nbsp;<span class="op" id="3112204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112207">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3112217">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3112227">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112277">ParseName</span>&nbsp;<span class="builtintype" id="3112287">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3112297">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112368">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112378">*</span><span class="ident" id="3112379">ListNode</span>&nbsp;<span class="comment" id="3112388">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112420">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3112430">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3112440">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3112495">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112534">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112544">[</span><span class="op" id="3112545">]</span><span class="keyword" id="3112546">map</span><span class="op" id="3112549">[</span><span class="builtintype" id="3112550">string</span><span class="op" id="3112556">]</span><span class="keyword" id="3112557">interface</span><span class="op" id="3112566">{</span><span class="op" id="3112567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112570">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112580">*</span><span class="ident" id="3112581">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112588">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112598">[</span><span class="num" id="3112599">3</span><span class="op" id="3112600">]</span><span class="ident" id="3112601">item</span>&nbsp;<span class="comment" id="3112606">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112644">peekCount</span>&nbsp;<span class="builtintype" id="3112654">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112659">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112669">[</span><span class="op" id="3112670">]</span><span class="builtintype" id="3112671">string</span>&nbsp;<span class="comment" id="3112678">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="3112714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112717">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="3112785">func</span>&nbsp;<span class="op" id="3112790">(</span><span class="ident" id="3112791">t</span>&nbsp;<span class="op" id="3112793">*</span><span class="ident" id="3112794">Tree</span><span class="op" id="3112798">)</span>&nbsp;<span class="ident" id="3112800">Copy</span><span class="op" id="3112804">(</span><span class="op" id="3112805">)</span>&nbsp;<span class="op" id="3112807">*</span><span class="ident" id="3112808">Tree</span>&nbsp;<span class="op" id="3112813">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112816">if</span>&nbsp;<span class="ident" id="3112819">t</span>&nbsp;<span class="op" id="3112821">==</span>&nbsp;<span class="builtintype" id="3112824">nil</span>&nbsp;<span class="op" id="3112828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112832">return</span>&nbsp;<span class="builtintype" id="3112839">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112847">return</span>&nbsp;<span class="op" id="3112854">&amp;</span><span class="ident" id="3112855">Tree</span><span class="op" id="3112859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112863">Name</span><span class="op" id="3112867">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112874">t</span><span class="op" id="3112875">.</span><span class="ident" id="3112876">Name</span><span class="op" id="3112880">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112884">ParseName</span><span class="op" id="3112893">:</span>&nbsp;<span class="ident" id="3112895">t</span><span class="op" id="3112896">.</span><span class="ident" id="3112897">ParseName</span><span class="op" id="3112906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112910">Root</span><span class="op" id="3112914">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112921">t</span><span class="op" id="3112922">.</span><span class="ident" id="3112923">Root</span><span class="op" id="3112927">.</span><span class="ident" id="3112928">CopyList</span><span class="op" id="3112936">(</span><span class="op" id="3112937">)</span><span class="op" id="3112938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112942">text</span><span class="op" id="3112946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112953">t</span><span class="op" id="3112954">.</span><span class="ident" id="3112955">text</span><span class="op" id="3112959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112962">}</span><br>
<span class="lineno"></span><span class="op" id="3112964">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3112967">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3113047">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3113125">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3113203">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="3113244">func</span>&nbsp;<span class="ident" id="3113249">Parse</span><span class="op" id="3113254">(</span><span class="ident" id="3113255">name</span><span class="op" id="3113259">,</span>&nbsp;<span class="ident" id="3113261">text</span><span class="op" id="3113265">,</span>&nbsp;<span class="ident" id="3113267">leftDelim</span><span class="op" id="3113276">,</span>&nbsp;<span class="ident" id="3113278">rightDelim</span>&nbsp;<span class="builtintype" id="3113289">string</span><span class="op" id="3113295">,</span>&nbsp;<span class="ident" id="3113297">funcs</span>&nbsp;<span class="op" id="3113303">...</span><span class="keyword" id="3113306">map</span><span class="op" id="3113309">[</span><span class="builtintype" id="3113310">string</span><span class="op" id="3113316">]</span><span class="keyword" id="3113317">interface</span><span class="op" id="3113326">{</span><span class="op" id="3113327">}</span><span class="op" id="3113328">)</span>&nbsp;<span class="op" id="3113330">(</span><span class="ident" id="3113331">treeSet</span>&nbsp;<span class="keyword" id="3113339">map</span><span class="op" id="3113342">[</span><span class="builtintype" id="3113343">string</span><span class="op" id="3113349">]</span><span class="op" id="3113350">*</span><span class="ident" id="3113351">Tree</span><span class="op" id="3113355">,</span>&nbsp;<span class="ident" id="3113357">err</span>&nbsp;<span class="builtintype" id="3113361">error</span><span class="op" id="3113366">)</span>&nbsp;<span class="op" id="3113368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113371">treeSet</span>&nbsp;<span class="op" id="3113379">=</span>&nbsp;<span class="builtinfunc" id="3113381">make</span><span class="op" id="3113385">(</span><span class="keyword" id="3113386">map</span><span class="op" id="3113389">[</span><span class="builtintype" id="3113390">string</span><span class="op" id="3113396">]</span><span class="op" id="3113397">*</span><span class="ident" id="3113398">Tree</span><span class="op" id="3113402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113405">t</span>&nbsp;<span class="op" id="3113407">:=</span>&nbsp;<span class="ident" id="3113410">New</span><span class="op" id="3113413">(</span><span class="ident" id="3113414">name</span><span class="op" id="3113418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113421">t</span><span class="op" id="3113422">.</span><span class="ident" id="3113423">text</span>&nbsp;<span class="op" id="3113428">=</span>&nbsp;<span class="ident" id="3113430">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113436">_</span><span class="op" id="3113437">,</span>&nbsp;<span class="ident" id="3113439">err</span>&nbsp;<span class="op" id="3113443">=</span>&nbsp;<span class="ident" id="3113445">t</span><span class="op" id="3113446">.</span><span class="ident" id="3113447">Parse</span><span class="op" id="3113452">(</span><span class="ident" id="3113453">text</span><span class="op" id="3113457">,</span>&nbsp;<span class="ident" id="3113459">leftDelim</span><span class="op" id="3113468">,</span>&nbsp;<span class="ident" id="3113470">rightDelim</span><span class="op" id="3113480">,</span>&nbsp;<span class="ident" id="3113482">treeSet</span><span class="op" id="3113489">,</span>&nbsp;<span class="ident" id="3113491">funcs</span><span class="op" id="3113496">...</span><span class="op" id="3113499">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113502">return</span><br>
<span class="lineno"></span><span class="op" id="3113509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3113512">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3113544">func</span>&nbsp;<span class="op" id="3113549">(</span><span class="ident" id="3113550">t</span>&nbsp;<span class="op" id="3113552">*</span><span class="ident" id="3113553">Tree</span><span class="op" id="3113557">)</span>&nbsp;<span class="ident" id="3113559">next</span><span class="op" id="3113563">(</span><span class="op" id="3113564">)</span>&nbsp;<span class="ident" id="3113566">item</span>&nbsp;<span class="op" id="3113571">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113574">if</span>&nbsp;<span class="ident" id="3113577">t</span><span class="op" id="3113578">.</span><span class="ident" id="3113579">peekCount</span>&nbsp;<span class="op" id="3113589">&gt;</span>&nbsp;<span class="num" id="3113591">0</span>&nbsp;<span class="op" id="3113593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113597">t</span><span class="op" id="3113598">.</span><span class="ident" id="3113599">peekCount</span><span class="op" id="3113608">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113612">}</span>&nbsp;<span class="keyword" id="3113614">else</span>&nbsp;<span class="op" id="3113619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113623">t</span><span class="op" id="3113624">.</span><span class="ident" id="3113625">token</span><span class="op" id="3113630">[</span><span class="num" id="3113631">0</span><span class="op" id="3113632">]</span>&nbsp;<span class="op" id="3113634">=</span>&nbsp;<span class="ident" id="3113636">t</span><span class="op" id="3113637">.</span><span class="ident" id="3113638">lex</span><span class="op" id="3113641">.</span><span class="ident" id="3113642">nextItem</span><span class="op" id="3113650">(</span><span class="op" id="3113651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113654">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113657">return</span>&nbsp;<span class="ident" id="3113664">t</span><span class="op" id="3113665">.</span><span class="ident" id="3113666">token</span><span class="op" id="3113671">[</span><span class="ident" id="3113672">t</span><span class="op" id="3113673">.</span><span class="ident" id="3113674">peekCount</span><span class="op" id="3113683">]</span><br>
<span class="lineno"></span><span class="op" id="3113685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3113688">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3113735">func</span>&nbsp;<span class="op" id="3113740">(</span><span class="ident" id="3113741">t</span>&nbsp;<span class="op" id="3113743">*</span><span class="ident" id="3113744">Tree</span><span class="op" id="3113748">)</span>&nbsp;<span class="ident" id="3113750">backup</span><span class="op" id="3113756">(</span><span class="op" id="3113757">)</span>&nbsp;<span class="op" id="3113759">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113762">t</span><span class="op" id="3113763">.</span><span class="ident" id="3113764">peekCount</span><span class="op" id="3113773">++</span><br>
<span class="lineno"></span><span class="op" id="3113776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3113779">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="3113828">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="3113866">func</span>&nbsp;<span class="op" id="3113871">(</span><span class="ident" id="3113872">t</span>&nbsp;<span class="op" id="3113874">*</span><span class="ident" id="3113875">Tree</span><span class="op" id="3113879">)</span>&nbsp;<span class="ident" id="3113881">backup2</span><span class="op" id="3113888">(</span><span class="ident" id="3113889">t1</span>&nbsp;<span class="ident" id="3113892">item</span><span class="op" id="3113896">)</span>&nbsp;<span class="op" id="3113898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113901">t</span><span class="op" id="3113902">.</span><span class="ident" id="3113903">token</span><span class="op" id="3113908">[</span><span class="num" id="3113909">1</span><span class="op" id="3113910">]</span>&nbsp;<span class="op" id="3113912">=</span>&nbsp;<span class="ident" id="3113914">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113918">t</span><span class="op" id="3113919">.</span><span class="ident" id="3113920">peekCount</span>&nbsp;<span class="op" id="3113930">=</span>&nbsp;<span class="num" id="3113932">2</span><br>
<span class="lineno"></span><span class="op" id="3113934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3113937">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="3113987">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="3114025">func</span>&nbsp;<span class="op" id="3114030">(</span><span class="ident" id="3114031">t</span>&nbsp;<span class="op" id="3114033">*</span><span class="ident" id="3114034">Tree</span><span class="op" id="3114038">)</span>&nbsp;<span class="ident" id="3114040">backup3</span><span class="op" id="3114047">(</span><span class="ident" id="3114048">t2</span><span class="op" id="3114050">,</span>&nbsp;<span class="ident" id="3114052">t1</span>&nbsp;<span class="ident" id="3114055">item</span><span class="op" id="3114059">)</span>&nbsp;<span class="op" id="3114061">{</span>&nbsp;<span class="comment" id="3114063">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114102">t</span><span class="op" id="3114103">.</span><span class="ident" id="3114104">token</span><span class="op" id="3114109">[</span><span class="num" id="3114110">1</span><span class="op" id="3114111">]</span>&nbsp;<span class="op" id="3114113">=</span>&nbsp;<span class="ident" id="3114115">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114119">t</span><span class="op" id="3114120">.</span><span class="ident" id="3114121">token</span><span class="op" id="3114126">[</span><span class="num" id="3114127">2</span><span class="op" id="3114128">]</span>&nbsp;<span class="op" id="3114130">=</span>&nbsp;<span class="ident" id="3114132">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114136">t</span><span class="op" id="3114137">.</span><span class="ident" id="3114138">peekCount</span>&nbsp;<span class="op" id="3114148">=</span>&nbsp;<span class="num" id="3114150">3</span><br>
<span class="lineno"></span><span class="op" id="3114152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3114155">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3114208">func</span>&nbsp;<span class="op" id="3114213">(</span><span class="ident" id="3114214">t</span>&nbsp;<span class="op" id="3114216">*</span><span class="ident" id="3114217">Tree</span><span class="op" id="3114221">)</span>&nbsp;<span class="ident" id="3114223">peek</span><span class="op" id="3114227">(</span><span class="op" id="3114228">)</span>&nbsp;<span class="ident" id="3114230">item</span>&nbsp;<span class="op" id="3114235">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114238">if</span>&nbsp;<span class="ident" id="3114241">t</span><span class="op" id="3114242">.</span><span class="ident" id="3114243">peekCount</span>&nbsp;<span class="op" id="3114253">&gt;</span>&nbsp;<span class="num" id="3114255">0</span>&nbsp;<span class="op" id="3114257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114261">return</span>&nbsp;<span class="ident" id="3114268">t</span><span class="op" id="3114269">.</span><span class="ident" id="3114270">token</span><span class="op" id="3114275">[</span><span class="ident" id="3114276">t</span><span class="op" id="3114277">.</span><span class="ident" id="3114278">peekCount</span><span class="op" id="3114287">-</span><span class="num" id="3114288">1</span><span class="op" id="3114289">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114295">t</span><span class="op" id="3114296">.</span><span class="ident" id="3114297">peekCount</span>&nbsp;<span class="op" id="3114307">=</span>&nbsp;<span class="num" id="3114309">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114312">t</span><span class="op" id="3114313">.</span><span class="ident" id="3114314">token</span><span class="op" id="3114319">[</span><span class="num" id="3114320">0</span><span class="op" id="3114321">]</span>&nbsp;<span class="op" id="3114323">=</span>&nbsp;<span class="ident" id="3114325">t</span><span class="op" id="3114326">.</span><span class="ident" id="3114327">lex</span><span class="op" id="3114330">.</span><span class="ident" id="3114331">nextItem</span><span class="op" id="3114339">(</span><span class="op" id="3114340">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114343">return</span>&nbsp;<span class="ident" id="3114350">t</span><span class="op" id="3114351">.</span><span class="ident" id="3114352">token</span><span class="op" id="3114357">[</span><span class="num" id="3114358">0</span><span class="op" id="3114359">]</span><br>
<span class="lineno"></span><span class="op" id="3114361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3114364">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3114414">func</span>&nbsp;<span class="op" id="3114419">(</span><span class="ident" id="3114420">t</span>&nbsp;<span class="op" id="3114422">*</span><span class="ident" id="3114423">Tree</span><span class="op" id="3114427">)</span>&nbsp;<span class="ident" id="3114429">nextNonSpace</span><span class="op" id="3114441">(</span><span class="op" id="3114442">)</span>&nbsp;<span class="op" id="3114444">(</span><span class="ident" id="3114445">token</span>&nbsp;<span class="ident" id="3114451">item</span><span class="op" id="3114455">)</span>&nbsp;<span class="op" id="3114457">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114460">for</span>&nbsp;<span class="op" id="3114464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114468">token</span>&nbsp;<span class="op" id="3114474">=</span>&nbsp;<span class="ident" id="3114476">t</span><span class="op" id="3114477">.</span><span class="ident" id="3114478">next</span><span class="op" id="3114482">(</span><span class="op" id="3114483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114487">if</span>&nbsp;<span class="ident" id="3114490">token</span><span class="op" id="3114495">.</span><span class="ident" id="3114496">typ</span>&nbsp;<span class="op" id="3114500">!=</span>&nbsp;<span class="ident" id="3114503">itemSpace</span>&nbsp;<span class="op" id="3114513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114518">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114526">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114532">return</span>&nbsp;<span class="ident" id="3114539">token</span><br>
<span class="lineno"></span><span class="op" id="3114545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3114548">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="3114619">func</span>&nbsp;<span class="op" id="3114624">(</span><span class="ident" id="3114625">t</span>&nbsp;<span class="op" id="3114627">*</span><span class="ident" id="3114628">Tree</span><span class="op" id="3114632">)</span>&nbsp;<span class="ident" id="3114634">peekNonSpace</span><span class="op" id="3114646">(</span><span class="op" id="3114647">)</span>&nbsp;<span class="op" id="3114649">(</span><span class="ident" id="3114650">token</span>&nbsp;<span class="ident" id="3114656">item</span><span class="op" id="3114660">)</span>&nbsp;<span class="op" id="3114662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114665">for</span>&nbsp;<span class="op" id="3114669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114673">token</span>&nbsp;<span class="op" id="3114679">=</span>&nbsp;<span class="ident" id="3114681">t</span><span class="op" id="3114682">.</span><span class="ident" id="3114683">next</span><span class="op" id="3114687">(</span><span class="op" id="3114688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114692">if</span>&nbsp;<span class="ident" id="3114695">token</span><span class="op" id="3114700">.</span><span class="ident" id="3114701">typ</span>&nbsp;<span class="op" id="3114705">!=</span>&nbsp;<span class="ident" id="3114708">itemSpace</span>&nbsp;<span class="op" id="3114718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114723">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114737">t</span><span class="op" id="3114738">.</span><span class="ident" id="3114739">backup</span><span class="op" id="3114745">(</span><span class="op" id="3114746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114749">return</span>&nbsp;<span class="ident" id="3114756">token</span><br>
<span class="lineno"></span><span class="op" id="3114762">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3114765">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3114778">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3114833">func</span>&nbsp;<span class="ident" id="3114838">New</span><span class="op" id="3114841">(</span><span class="ident" id="3114842">name</span>&nbsp;<span class="builtintype" id="3114847">string</span><span class="op" id="3114853">,</span>&nbsp;<span class="ident" id="3114855">funcs</span>&nbsp;<span class="op" id="3114861">...</span><span class="keyword" id="3114864">map</span><span class="op" id="3114867">[</span><span class="builtintype" id="3114868">string</span><span class="op" id="3114874">]</span><span class="keyword" id="3114875">interface</span><span class="op" id="3114884">{</span><span class="op" id="3114885">}</span><span class="op" id="3114886">)</span>&nbsp;<span class="op" id="3114888">*</span><span class="ident" id="3114889">Tree</span>&nbsp;<span class="op" id="3114894">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114897">return</span>&nbsp;<span class="op" id="3114904">&amp;</span><span class="ident" id="3114905">Tree</span><span class="op" id="3114909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114913">Name</span><span class="op" id="3114917">:</span>&nbsp;&nbsp;<span class="ident" id="3114920">name</span><span class="op" id="3114924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114928">funcs</span><span class="op" id="3114933">:</span>&nbsp;<span class="ident" id="3114935">funcs</span><span class="op" id="3114940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114943">}</span><br>
<span class="lineno"></span><span class="op" id="3114945">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3114948">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="3115044">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="3115131">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="3115163">func</span>&nbsp;<span class="op" id="3115168">(</span><span class="ident" id="3115169">t</span>&nbsp;<span class="op" id="3115171">*</span><span class="ident" id="3115172">Tree</span><span class="op" id="3115176">)</span>&nbsp;<span class="ident" id="3115178">ErrorContext</span><span class="op" id="3115190">(</span><span class="ident" id="3115191">n</span>&nbsp;<span class="ident" id="3115193">Node</span><span class="op" id="3115197">)</span>&nbsp;<span class="op" id="3115199">(</span><span class="ident" id="3115200">location</span><span class="op" id="3115208">,</span>&nbsp;<span class="ident" id="3115210">context</span>&nbsp;<span class="builtintype" id="3115218">string</span><span class="op" id="3115224">)</span>&nbsp;<span class="op" id="3115226">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115229">pos</span>&nbsp;<span class="op" id="3115233">:=</span>&nbsp;<span class="builtintype" id="3115236">int</span><span class="op" id="3115239">(</span><span class="ident" id="3115240">n</span><span class="op" id="3115241">.</span><span class="ident" id="3115242">Position</span><span class="op" id="3115250">(</span><span class="op" id="3115251">)</span><span class="op" id="3115252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115255">tree</span>&nbsp;<span class="op" id="3115260">:=</span>&nbsp;<span class="ident" id="3115263">n</span><span class="op" id="3115264">.</span><span class="ident" id="3115265">tree</span><span class="op" id="3115269">(</span><span class="op" id="3115270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115273">if</span>&nbsp;<span class="ident" id="3115276">tree</span>&nbsp;<span class="op" id="3115281">==</span>&nbsp;<span class="builtintype" id="3115284">nil</span>&nbsp;<span class="op" id="3115288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115292">tree</span>&nbsp;<span class="op" id="3115297">=</span>&nbsp;<span class="ident" id="3115299">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115302">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115305">text</span>&nbsp;<span class="op" id="3115310">:=</span>&nbsp;<span class="ident" id="3115313">tree</span><span class="op" id="3115317">.</span><span class="ident" id="3115318">text</span><span class="op" id="3115322">[</span><span class="op" id="3115323">:</span><span class="ident" id="3115324">pos</span><span class="op" id="3115327">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115330">byteNum</span>&nbsp;<span class="op" id="3115338">:=</span>&nbsp;<span class="ident" id="3115341">strings</span><span class="op" id="3115348">.</span><span class="ident" id="3115349">LastIndex</span><span class="op" id="3115358">(</span><span class="ident" id="3115359">text</span><span class="op" id="3115363">,</span>&nbsp;<span class="string" id="3115365">&#34;\n&#34;</span><span class="op" id="3115369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115372">if</span>&nbsp;<span class="ident" id="3115375">byteNum</span>&nbsp;<span class="op" id="3115383">==</span>&nbsp;<span class="op" id="3115386">-</span><span class="num" id="3115387">1</span>&nbsp;<span class="op" id="3115389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115393">byteNum</span>&nbsp;<span class="op" id="3115401">=</span>&nbsp;<span class="ident" id="3115403">pos</span>&nbsp;<span class="comment" id="3115407">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115426">}</span>&nbsp;<span class="keyword" id="3115428">else</span>&nbsp;<span class="op" id="3115433">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115437">byteNum</span><span class="op" id="3115444">++</span>&nbsp;<span class="comment" id="3115447">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115471">byteNum</span>&nbsp;<span class="op" id="3115479">=</span>&nbsp;<span class="ident" id="3115481">pos</span>&nbsp;<span class="op" id="3115485">-</span>&nbsp;<span class="ident" id="3115487">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115499">lineNum</span>&nbsp;<span class="op" id="3115507">:=</span>&nbsp;<span class="num" id="3115510">1</span>&nbsp;<span class="op" id="3115512">+</span>&nbsp;<span class="ident" id="3115514">strings</span><span class="op" id="3115521">.</span><span class="ident" id="3115522">Count</span><span class="op" id="3115527">(</span><span class="ident" id="3115528">text</span><span class="op" id="3115532">,</span>&nbsp;<span class="string" id="3115534">&#34;\n&#34;</span><span class="op" id="3115538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115541">context</span>&nbsp;<span class="op" id="3115549">=</span>&nbsp;<span class="ident" id="3115551">n</span><span class="op" id="3115552">.</span><span class="ident" id="3115553">String</span><span class="op" id="3115559">(</span><span class="op" id="3115560">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115563">if</span>&nbsp;<span class="builtinfunc" id="3115566">len</span><span class="op" id="3115569">(</span><span class="ident" id="3115570">context</span><span class="op" id="3115577">)</span>&nbsp;<span class="op" id="3115579">&gt;</span>&nbsp;<span class="num" id="3115581">20</span>&nbsp;<span class="op" id="3115584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115588">context</span>&nbsp;<span class="op" id="3115596">=</span>&nbsp;<span class="ident" id="3115598">fmt</span><span class="op" id="3115601">.</span><span class="ident" id="3115602">Sprintf</span><span class="op" id="3115609">(</span><span class="string" id="3115610">&#34;%.20s...&#34;</span><span class="op" id="3115620">,</span>&nbsp;<span class="ident" id="3115622">context</span><span class="op" id="3115629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115635">return</span>&nbsp;<span class="ident" id="3115642">fmt</span><span class="op" id="3115645">.</span><span class="ident" id="3115646">Sprintf</span><span class="op" id="3115653">(</span><span class="string" id="3115654">&#34;%s:%d:%d&#34;</span><span class="op" id="3115664">,</span>&nbsp;<span class="ident" id="3115666">tree</span><span class="op" id="3115670">.</span><span class="ident" id="3115671">ParseName</span><span class="op" id="3115680">,</span>&nbsp;<span class="ident" id="3115682">lineNum</span><span class="op" id="3115689">,</span>&nbsp;<span class="ident" id="3115691">byteNum</span><span class="op" id="3115698">)</span><span class="op" id="3115699">,</span>&nbsp;<span class="ident" id="3115701">context</span><br>
<span class="lineno"></span><span class="op" id="3115709">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3115712">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3115767">func</span>&nbsp;<span class="op" id="3115772">(</span><span class="ident" id="3115773">t</span>&nbsp;<span class="op" id="3115775">*</span><span class="ident" id="3115776">Tree</span><span class="op" id="3115780">)</span>&nbsp;<span class="ident" id="3115782">errorf</span><span class="op" id="3115788">(</span><span class="ident" id="3115789">format</span>&nbsp;<span class="builtintype" id="3115796">string</span><span class="op" id="3115802">,</span>&nbsp;<span class="ident" id="3115804">args</span>&nbsp;<span class="op" id="3115809">...</span><span class="keyword" id="3115812">interface</span><span class="op" id="3115821">{</span><span class="op" id="3115822">}</span><span class="op" id="3115823">)</span>&nbsp;<span class="op" id="3115825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115828">t</span><span class="op" id="3115829">.</span><span class="ident" id="3115830">Root</span>&nbsp;<span class="op" id="3115835">=</span>&nbsp;<span class="builtintype" id="3115837">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115842">format</span>&nbsp;<span class="op" id="3115849">=</span>&nbsp;<span class="ident" id="3115851">fmt</span><span class="op" id="3115854">.</span><span class="ident" id="3115855">Sprintf</span><span class="op" id="3115862">(</span><span class="string" id="3115863">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="3115884">,</span>&nbsp;<span class="ident" id="3115886">t</span><span class="op" id="3115887">.</span><span class="ident" id="3115888">ParseName</span><span class="op" id="3115897">,</span>&nbsp;<span class="ident" id="3115899">t</span><span class="op" id="3115900">.</span><span class="ident" id="3115901">lex</span><span class="op" id="3115904">.</span><span class="ident" id="3115905">lineNumber</span><span class="op" id="3115915">(</span><span class="op" id="3115916">)</span><span class="op" id="3115917">,</span>&nbsp;<span class="ident" id="3115919">format</span><span class="op" id="3115925">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3115928">panic</span><span class="op" id="3115933">(</span><span class="ident" id="3115934">fmt</span><span class="op" id="3115937">.</span><span class="ident" id="3115938">Errorf</span><span class="op" id="3115944">(</span><span class="ident" id="3115945">format</span><span class="op" id="3115951">,</span>&nbsp;<span class="ident" id="3115953">args</span><span class="op" id="3115957">...</span><span class="op" id="3115960">)</span><span class="op" id="3115961">)</span><br>
<span class="lineno"></span><span class="op" id="3115963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3115966">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3115998">func</span>&nbsp;<span class="op" id="3116003">(</span><span class="ident" id="3116004">t</span>&nbsp;<span class="op" id="3116006">*</span><span class="ident" id="3116007">Tree</span><span class="op" id="3116011">)</span>&nbsp;<span class="builtintype" id="3116013">error</span><span class="op" id="3116018">(</span><span class="ident" id="3116019">err</span>&nbsp;<span class="builtintype" id="3116023">error</span><span class="op" id="3116028">)</span>&nbsp;<span class="op" id="3116030">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116033">t</span><span class="op" id="3116034">.</span><span class="ident" id="3116035">errorf</span><span class="op" id="3116041">(</span><span class="string" id="3116042">&#34;%s&#34;</span><span class="op" id="3116046">,</span>&nbsp;<span class="ident" id="3116048">err</span><span class="op" id="3116051">)</span><br>
<span class="lineno"></span><span class="op" id="3116053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3116056">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3116131">func</span>&nbsp;<span class="op" id="3116136">(</span><span class="ident" id="3116137">t</span>&nbsp;<span class="op" id="3116139">*</span><span class="ident" id="3116140">Tree</span><span class="op" id="3116144">)</span>&nbsp;<span class="ident" id="3116146">expect</span><span class="op" id="3116152">(</span><span class="ident" id="3116153">expected</span>&nbsp;<span class="ident" id="3116162">itemType</span><span class="op" id="3116170">,</span>&nbsp;<span class="ident" id="3116172">context</span>&nbsp;<span class="builtintype" id="3116180">string</span><span class="op" id="3116186">)</span>&nbsp;<span class="ident" id="3116188">item</span>&nbsp;<span class="op" id="3116193">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116196">token</span>&nbsp;<span class="op" id="3116202">:=</span>&nbsp;<span class="ident" id="3116205">t</span><span class="op" id="3116206">.</span><span class="ident" id="3116207">nextNonSpace</span><span class="op" id="3116219">(</span><span class="op" id="3116220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116223">if</span>&nbsp;<span class="ident" id="3116226">token</span><span class="op" id="3116231">.</span><span class="ident" id="3116232">typ</span>&nbsp;<span class="op" id="3116236">!=</span>&nbsp;<span class="ident" id="3116239">expected</span>&nbsp;<span class="op" id="3116248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116252">t</span><span class="op" id="3116253">.</span><span class="ident" id="3116254">unexpected</span><span class="op" id="3116264">(</span><span class="ident" id="3116265">token</span><span class="op" id="3116270">,</span>&nbsp;<span class="ident" id="3116272">context</span><span class="op" id="3116279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116285">return</span>&nbsp;<span class="ident" id="3116292">token</span><br>
<span class="lineno">175</span><span class="op" id="3116298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3116301">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="3116389">func</span>&nbsp;<span class="op" id="3116394">(</span><span class="ident" id="3116395">t</span>&nbsp;<span class="op" id="3116397">*</span><span class="ident" id="3116398">Tree</span><span class="op" id="3116402">)</span>&nbsp;<span class="ident" id="3116404">expectOneOf</span><span class="op" id="3116415">(</span><span class="ident" id="3116416">expected1</span><span class="op" id="3116425">,</span>&nbsp;<span class="ident" id="3116427">expected2</span>&nbsp;<span class="ident" id="3116437">itemType</span><span class="op" id="3116445">,</span>&nbsp;<span class="ident" id="3116447">context</span>&nbsp;<span class="builtintype" id="3116455">string</span><span class="op" id="3116461">)</span>&nbsp;<span class="ident" id="3116463">item</span>&nbsp;<span class="op" id="3116468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116471">token</span>&nbsp;<span class="op" id="3116477">:=</span>&nbsp;<span class="ident" id="3116480">t</span><span class="op" id="3116481">.</span><span class="ident" id="3116482">nextNonSpace</span><span class="op" id="3116494">(</span><span class="op" id="3116495">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116498">if</span>&nbsp;<span class="ident" id="3116501">token</span><span class="op" id="3116506">.</span><span class="ident" id="3116507">typ</span>&nbsp;<span class="op" id="3116511">!=</span>&nbsp;<span class="ident" id="3116514">expected1</span>&nbsp;<span class="op" id="3116524">&amp;&amp;</span>&nbsp;<span class="ident" id="3116527">token</span><span class="op" id="3116532">.</span><span class="ident" id="3116533">typ</span>&nbsp;<span class="op" id="3116537">!=</span>&nbsp;<span class="ident" id="3116540">expected2</span>&nbsp;<span class="op" id="3116550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116554">t</span><span class="op" id="3116555">.</span><span class="ident" id="3116556">unexpected</span><span class="op" id="3116566">(</span><span class="ident" id="3116567">token</span><span class="op" id="3116572">,</span>&nbsp;<span class="ident" id="3116574">context</span><span class="op" id="3116581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116587">return</span>&nbsp;<span class="ident" id="3116594">token</span><br>
<span class="lineno"></span><span class="op" id="3116600">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="3116603">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3116670">func</span>&nbsp;<span class="op" id="3116675">(</span><span class="ident" id="3116676">t</span>&nbsp;<span class="op" id="3116678">*</span><span class="ident" id="3116679">Tree</span><span class="op" id="3116683">)</span>&nbsp;<span class="ident" id="3116685">unexpected</span><span class="op" id="3116695">(</span><span class="ident" id="3116696">token</span>&nbsp;<span class="ident" id="3116702">item</span><span class="op" id="3116706">,</span>&nbsp;<span class="ident" id="3116708">context</span>&nbsp;<span class="builtintype" id="3116716">string</span><span class="op" id="3116722">)</span>&nbsp;<span class="op" id="3116724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116727">t</span><span class="op" id="3116728">.</span><span class="ident" id="3116729">errorf</span><span class="op" id="3116735">(</span><span class="string" id="3116736">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3116757">,</span>&nbsp;<span class="ident" id="3116759">token</span><span class="op" id="3116764">,</span>&nbsp;<span class="ident" id="3116766">context</span><span class="op" id="3116773">)</span><br>
<span class="lineno"></span><span class="op" id="3116775">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3116778">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="3116864">func</span>&nbsp;<span class="op" id="3116869">(</span><span class="ident" id="3116870">t</span>&nbsp;<span class="op" id="3116872">*</span><span class="ident" id="3116873">Tree</span><span class="op" id="3116877">)</span>&nbsp;<span class="builtinfunc" id="3116879">recover</span><span class="op" id="3116886">(</span><span class="ident" id="3116887">errp</span>&nbsp;<span class="op" id="3116892">*</span><span class="builtintype" id="3116893">error</span><span class="op" id="3116898">)</span>&nbsp;<span class="op" id="3116900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3116903">e</span>&nbsp;<span class="op" id="3116905">:=</span>&nbsp;<span class="builtinfunc" id="3116908">recover</span><span class="op" id="3116915">(</span><span class="op" id="3116916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116919">if</span>&nbsp;<span class="ident" id="3116922">e</span>&nbsp;<span class="op" id="3116924">!=</span>&nbsp;<span class="builtintype" id="3116927">nil</span>&nbsp;<span class="op" id="3116931">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116935">if</span>&nbsp;<span class="ident" id="3116938">_</span><span class="op" id="3116939">,</span>&nbsp;<span class="ident" id="3116941">ok</span>&nbsp;<span class="op" id="3116944">:=</span>&nbsp;<span class="ident" id="3116947">e</span><span class="op" id="3116948">.</span><span class="op" id="3116949">(</span><span class="ident" id="3116950">runtime</span><span class="op" id="3116957">.</span><span class="ident" id="3116958">Error</span><span class="op" id="3116963">)</span><span class="op" id="3116964">;</span>&nbsp;<span class="ident" id="3116966">ok</span>&nbsp;<span class="op" id="3116969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3116974">panic</span><span class="op" id="3116979">(</span><span class="ident" id="3116980">e</span><span class="op" id="3116981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3116985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3116989">if</span>&nbsp;<span class="ident" id="3116992">t</span>&nbsp;<span class="op" id="3116994">!=</span>&nbsp;<span class="builtintype" id="3116997">nil</span>&nbsp;<span class="op" id="3117001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117006">t</span><span class="op" id="3117007">.</span><span class="ident" id="3117008">stopParse</span><span class="op" id="3117017">(</span><span class="op" id="3117018">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117026">*</span><span class="ident" id="3117027">errp</span>&nbsp;<span class="op" id="3117032">=</span>&nbsp;<span class="ident" id="3117034">e</span><span class="op" id="3117035">.</span><span class="op" id="3117036">(</span><span class="builtintype" id="3117037">error</span><span class="op" id="3117042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3117045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117048">return</span><br>
<span class="lineno"></span><span class="op" id="3117055">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="3117058">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="3117113">func</span>&nbsp;<span class="op" id="3117118">(</span><span class="ident" id="3117119">t</span>&nbsp;<span class="op" id="3117121">*</span><span class="ident" id="3117122">Tree</span><span class="op" id="3117126">)</span>&nbsp;<span class="ident" id="3117128">startParse</span><span class="op" id="3117138">(</span><span class="ident" id="3117139">funcs</span>&nbsp;<span class="op" id="3117145">[</span><span class="op" id="3117146">]</span><span class="keyword" id="3117147">map</span><span class="op" id="3117150">[</span><span class="builtintype" id="3117151">string</span><span class="op" id="3117157">]</span><span class="keyword" id="3117158">interface</span><span class="op" id="3117167">{</span><span class="op" id="3117168">}</span><span class="op" id="3117169">,</span>&nbsp;<span class="ident" id="3117171">lex</span>&nbsp;<span class="op" id="3117175">*</span><span class="ident" id="3117176">lexer</span><span class="op" id="3117181">)</span>&nbsp;<span class="op" id="3117183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117186">t</span><span class="op" id="3117187">.</span><span class="ident" id="3117188">Root</span>&nbsp;<span class="op" id="3117193">=</span>&nbsp;<span class="builtintype" id="3117195">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117200">t</span><span class="op" id="3117201">.</span><span class="ident" id="3117202">lex</span>&nbsp;<span class="op" id="3117206">=</span>&nbsp;<span class="ident" id="3117208">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117213">t</span><span class="op" id="3117214">.</span><span class="ident" id="3117215">vars</span>&nbsp;<span class="op" id="3117220">=</span>&nbsp;<span class="op" id="3117222">[</span><span class="op" id="3117223">]</span><span class="builtintype" id="3117224">string</span><span class="op" id="3117230">{</span><span class="string" id="3117231">&#34;$&#34;</span><span class="op" id="3117234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117237">t</span><span class="op" id="3117238">.</span><span class="ident" id="3117239">funcs</span>&nbsp;<span class="op" id="3117245">=</span>&nbsp;<span class="ident" id="3117247">funcs</span><br>
<span class="lineno"></span><span class="op" id="3117253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3117256">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="3117289">func</span>&nbsp;<span class="op" id="3117294">(</span><span class="ident" id="3117295">t</span>&nbsp;<span class="op" id="3117297">*</span><span class="ident" id="3117298">Tree</span><span class="op" id="3117302">)</span>&nbsp;<span class="ident" id="3117304">stopParse</span><span class="op" id="3117313">(</span><span class="op" id="3117314">)</span>&nbsp;<span class="op" id="3117316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117319">t</span><span class="op" id="3117320">.</span><span class="ident" id="3117321">lex</span>&nbsp;<span class="op" id="3117325">=</span>&nbsp;<span class="builtintype" id="3117327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117332">t</span><span class="op" id="3117333">.</span><span class="ident" id="3117334">vars</span>&nbsp;<span class="op" id="3117339">=</span>&nbsp;<span class="builtintype" id="3117341">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117346">t</span><span class="op" id="3117347">.</span><span class="ident" id="3117348">funcs</span>&nbsp;<span class="op" id="3117354">=</span>&nbsp;<span class="builtintype" id="3117356">nil</span><br>
<span class="lineno"></span><span class="op" id="3117360">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3117363">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3117443">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3117522">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3117600">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="3117620">func</span>&nbsp;<span class="op" id="3117625">(</span><span class="ident" id="3117626">t</span>&nbsp;<span class="op" id="3117628">*</span><span class="ident" id="3117629">Tree</span><span class="op" id="3117633">)</span>&nbsp;<span class="ident" id="3117635">Parse</span><span class="op" id="3117640">(</span><span class="ident" id="3117641">text</span><span class="op" id="3117645">,</span>&nbsp;<span class="ident" id="3117647">leftDelim</span><span class="op" id="3117656">,</span>&nbsp;<span class="ident" id="3117658">rightDelim</span>&nbsp;<span class="builtintype" id="3117669">string</span><span class="op" id="3117675">,</span>&nbsp;<span class="ident" id="3117677">treeSet</span>&nbsp;<span class="keyword" id="3117685">map</span><span class="op" id="3117688">[</span><span class="builtintype" id="3117689">string</span><span class="op" id="3117695">]</span><span class="op" id="3117696">*</span><span class="ident" id="3117697">Tree</span><span class="op" id="3117701">,</span>&nbsp;<span class="ident" id="3117703">funcs</span>&nbsp;<span class="op" id="3117709">...</span><span class="keyword" id="3117712">map</span><span class="op" id="3117715">[</span><span class="builtintype" id="3117716">string</span><span class="op" id="3117722">]</span><span class="keyword" id="3117723">interface</span><span class="op" id="3117732">{</span><span class="op" id="3117733">}</span><span class="op" id="3117734">)</span>&nbsp;<span class="op" id="3117736">(</span><span class="ident" id="3117737">tree</span>&nbsp;<span class="op" id="3117742">*</span><span class="ident" id="3117743">Tree</span><span class="op" id="3117747">,</span>&nbsp;<span class="ident" id="3117749">err</span>&nbsp;<span class="builtintype" id="3117753">error</span><span class="op" id="3117758">)</span>&nbsp;<span class="op" id="3117760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117763">defer</span>&nbsp;<span class="ident" id="3117769">t</span><span class="op" id="3117770">.</span><span class="builtinfunc" id="3117771">recover</span><span class="op" id="3117778">(</span><span class="op" id="3117779">&amp;</span><span class="ident" id="3117780">err</span><span class="op" id="3117783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117786">t</span><span class="op" id="3117787">.</span><span class="ident" id="3117788">ParseName</span>&nbsp;<span class="op" id="3117798">=</span>&nbsp;<span class="ident" id="3117800">t</span><span class="op" id="3117801">.</span><span class="ident" id="3117802">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117808">t</span><span class="op" id="3117809">.</span><span class="ident" id="3117810">startParse</span><span class="op" id="3117820">(</span><span class="ident" id="3117821">funcs</span><span class="op" id="3117826">,</span>&nbsp;<span class="ident" id="3117828">lex</span><span class="op" id="3117831">(</span><span class="ident" id="3117832">t</span><span class="op" id="3117833">.</span><span class="ident" id="3117834">Name</span><span class="op" id="3117838">,</span>&nbsp;<span class="ident" id="3117840">text</span><span class="op" id="3117844">,</span>&nbsp;<span class="ident" id="3117846">leftDelim</span><span class="op" id="3117855">,</span>&nbsp;<span class="ident" id="3117857">rightDelim</span><span class="op" id="3117867">)</span><span class="op" id="3117868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117871">t</span><span class="op" id="3117872">.</span><span class="ident" id="3117873">text</span>&nbsp;<span class="op" id="3117878">=</span>&nbsp;<span class="ident" id="3117880">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117886">t</span><span class="op" id="3117887">.</span><span class="ident" id="3117888">parse</span><span class="op" id="3117893">(</span><span class="ident" id="3117894">treeSet</span><span class="op" id="3117901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117904">t</span><span class="op" id="3117905">.</span><span class="ident" id="3117906">add</span><span class="op" id="3117909">(</span><span class="ident" id="3117910">treeSet</span><span class="op" id="3117917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3117920">t</span><span class="op" id="3117921">.</span><span class="ident" id="3117922">stopParse</span><span class="op" id="3117931">(</span><span class="op" id="3117932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3117935">return</span>&nbsp;<span class="ident" id="3117942">t</span><span class="op" id="3117943">,</span>&nbsp;<span class="builtintype" id="3117945">nil</span><br>
<span class="lineno"></span><span class="op" id="3117949">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3117952">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="3117985">func</span>&nbsp;<span class="op" id="3117990">(</span><span class="ident" id="3117991">t</span>&nbsp;<span class="op" id="3117993">*</span><span class="ident" id="3117994">Tree</span><span class="op" id="3117998">)</span>&nbsp;<span class="ident" id="3118000">add</span><span class="op" id="3118003">(</span><span class="ident" id="3118004">treeSet</span>&nbsp;<span class="keyword" id="3118012">map</span><span class="op" id="3118015">[</span><span class="builtintype" id="3118016">string</span><span class="op" id="3118022">]</span><span class="op" id="3118023">*</span><span class="ident" id="3118024">Tree</span><span class="op" id="3118028">)</span>&nbsp;<span class="op" id="3118030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118033">tree</span>&nbsp;<span class="op" id="3118038">:=</span>&nbsp;<span class="ident" id="3118041">treeSet</span><span class="op" id="3118048">[</span><span class="ident" id="3118049">t</span><span class="op" id="3118050">.</span><span class="ident" id="3118051">Name</span><span class="op" id="3118055">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118058">if</span>&nbsp;<span class="ident" id="3118061">tree</span>&nbsp;<span class="op" id="3118066">==</span>&nbsp;<span class="builtintype" id="3118069">nil</span>&nbsp;<span class="op" id="3118073">||</span>&nbsp;<span class="ident" id="3118076">IsEmptyTree</span><span class="op" id="3118087">(</span><span class="ident" id="3118088">tree</span><span class="op" id="3118092">.</span><span class="ident" id="3118093">Root</span><span class="op" id="3118097">)</span>&nbsp;<span class="op" id="3118099">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118103">treeSet</span><span class="op" id="3118110">[</span><span class="ident" id="3118111">t</span><span class="op" id="3118112">.</span><span class="ident" id="3118113">Name</span><span class="op" id="3118117">]</span>&nbsp;<span class="op" id="3118119">=</span>&nbsp;<span class="ident" id="3118121">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118125">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118136">if</span>&nbsp;<span class="op" id="3118139">!</span><span class="ident" id="3118140">IsEmptyTree</span><span class="op" id="3118151">(</span><span class="ident" id="3118152">t</span><span class="op" id="3118153">.</span><span class="ident" id="3118154">Root</span><span class="op" id="3118158">)</span>&nbsp;<span class="op" id="3118160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118164">t</span><span class="op" id="3118165">.</span><span class="ident" id="3118166">errorf</span><span class="op" id="3118172">(</span><span class="string" id="3118173">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3118219">,</span>&nbsp;<span class="ident" id="3118221">t</span><span class="op" id="3118222">.</span><span class="ident" id="3118223">Name</span><span class="op" id="3118227">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118230">}</span><br>
<span class="lineno"></span><span class="op" id="3118232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3118235">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="3118317">func</span>&nbsp;<span class="ident" id="3118322">IsEmptyTree</span><span class="op" id="3118333">(</span><span class="ident" id="3118334">n</span>&nbsp;<span class="ident" id="3118336">Node</span><span class="op" id="3118340">)</span>&nbsp;<span class="builtintype" id="3118342">bool</span>&nbsp;<span class="op" id="3118347">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118350">switch</span>&nbsp;<span class="ident" id="3118357">n</span>&nbsp;<span class="op" id="3118359">:=</span>&nbsp;<span class="ident" id="3118362">n</span><span class="op" id="3118363">.</span><span class="op" id="3118364">(</span><span class="keyword" id="3118365">type</span><span class="op" id="3118369">)</span>&nbsp;<span class="op" id="3118371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118374">case</span>&nbsp;<span class="builtintype" id="3118379">nil</span><span class="op" id="3118382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118386">return</span>&nbsp;<span class="builtintype" id="3118393">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118399">case</span>&nbsp;<span class="op" id="3118404">*</span><span class="ident" id="3118405">ActionNode</span><span class="op" id="3118415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118418">case</span>&nbsp;<span class="op" id="3118423">*</span><span class="ident" id="3118424">IfNode</span><span class="op" id="3118430">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118433">case</span>&nbsp;<span class="op" id="3118438">*</span><span class="ident" id="3118439">ListNode</span><span class="op" id="3118447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118451">for</span>&nbsp;<span class="ident" id="3118455">_</span><span class="op" id="3118456">,</span>&nbsp;<span class="ident" id="3118458">node</span>&nbsp;<span class="op" id="3118463">:=</span>&nbsp;<span class="keyword" id="3118466">range</span>&nbsp;<span class="ident" id="3118472">n</span><span class="op" id="3118473">.</span><span class="ident" id="3118474">Nodes</span>&nbsp;<span class="op" id="3118480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118485">if</span>&nbsp;<span class="op" id="3118488">!</span><span class="ident" id="3118489">IsEmptyTree</span><span class="op" id="3118500">(</span><span class="ident" id="3118501">node</span><span class="op" id="3118505">)</span>&nbsp;<span class="op" id="3118507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118513">return</span>&nbsp;<span class="builtintype" id="3118520">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118529">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118537">return</span>&nbsp;<span class="builtintype" id="3118544">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118550">case</span>&nbsp;<span class="op" id="3118555">*</span><span class="ident" id="3118556">RangeNode</span><span class="op" id="3118565">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118568">case</span>&nbsp;<span class="op" id="3118573">*</span><span class="ident" id="3118574">TemplateNode</span><span class="op" id="3118586">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118589">case</span>&nbsp;<span class="op" id="3118594">*</span><span class="ident" id="3118595">TextNode</span><span class="op" id="3118603">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118607">return</span>&nbsp;<span class="builtinfunc" id="3118614">len</span><span class="op" id="3118617">(</span><span class="ident" id="3118618">bytes</span><span class="op" id="3118623">.</span><span class="ident" id="3118624">TrimSpace</span><span class="op" id="3118633">(</span><span class="ident" id="3118634">n</span><span class="op" id="3118635">.</span><span class="ident" id="3118636">Text</span><span class="op" id="3118640">)</span><span class="op" id="3118641">)</span>&nbsp;<span class="op" id="3118643">==</span>&nbsp;<span class="num" id="3118646">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118649">case</span>&nbsp;<span class="op" id="3118654">*</span><span class="ident" id="3118655">WithNode</span><span class="op" id="3118663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118666">default</span><span class="op" id="3118673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3118677">panic</span><span class="op" id="3118682">(</span><span class="string" id="3118683">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="3118700">+</span>&nbsp;<span class="ident" id="3118702">n</span><span class="op" id="3118703">.</span><span class="ident" id="3118704">String</span><span class="op" id="3118710">(</span><span class="op" id="3118711">)</span><span class="op" id="3118712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3118715">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118718">return</span>&nbsp;<span class="builtintype" id="3118725">false</span><br>
<span class="lineno"></span><span class="op" id="3118731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3118734">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3118804">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="3118861">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3118880">func</span>&nbsp;<span class="op" id="3118885">(</span><span class="ident" id="3118886">t</span>&nbsp;<span class="op" id="3118888">*</span><span class="ident" id="3118889">Tree</span><span class="op" id="3118893">)</span>&nbsp;<span class="ident" id="3118895">parse</span><span class="op" id="3118900">(</span><span class="ident" id="3118901">treeSet</span>&nbsp;<span class="keyword" id="3118909">map</span><span class="op" id="3118912">[</span><span class="builtintype" id="3118913">string</span><span class="op" id="3118919">]</span><span class="op" id="3118920">*</span><span class="ident" id="3118921">Tree</span><span class="op" id="3118925">)</span>&nbsp;<span class="op" id="3118927">(</span><span class="ident" id="3118928">next</span>&nbsp;<span class="ident" id="3118933">Node</span><span class="op" id="3118937">)</span>&nbsp;<span class="op" id="3118939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3118942">t</span><span class="op" id="3118943">.</span><span class="ident" id="3118944">Root</span>&nbsp;<span class="op" id="3118949">=</span>&nbsp;<span class="ident" id="3118951">t</span><span class="op" id="3118952">.</span><span class="ident" id="3118953">newList</span><span class="op" id="3118960">(</span><span class="ident" id="3118961">t</span><span class="op" id="3118962">.</span><span class="ident" id="3118963">peek</span><span class="op" id="3118967">(</span><span class="op" id="3118968">)</span><span class="op" id="3118969">.</span><span class="ident" id="3118970">pos</span><span class="op" id="3118973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3118976">for</span>&nbsp;<span class="ident" id="3118980">t</span><span class="op" id="3118981">.</span><span class="ident" id="3118982">peek</span><span class="op" id="3118986">(</span><span class="op" id="3118987">)</span><span class="op" id="3118988">.</span><span class="ident" id="3118989">typ</span>&nbsp;<span class="op" id="3118993">!=</span>&nbsp;<span class="ident" id="3118996">itemEOF</span>&nbsp;<span class="op" id="3119004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119008">if</span>&nbsp;<span class="ident" id="3119011">t</span><span class="op" id="3119012">.</span><span class="ident" id="3119013">peek</span><span class="op" id="3119017">(</span><span class="op" id="3119018">)</span><span class="op" id="3119019">.</span><span class="ident" id="3119020">typ</span>&nbsp;<span class="op" id="3119024">==</span>&nbsp;<span class="ident" id="3119027">itemLeftDelim</span>&nbsp;<span class="op" id="3119041">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119046">delim</span>&nbsp;<span class="op" id="3119052">:=</span>&nbsp;<span class="ident" id="3119055">t</span><span class="op" id="3119056">.</span><span class="ident" id="3119057">next</span><span class="op" id="3119061">(</span><span class="op" id="3119062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119067">if</span>&nbsp;<span class="ident" id="3119070">t</span><span class="op" id="3119071">.</span><span class="ident" id="3119072">nextNonSpace</span><span class="op" id="3119084">(</span><span class="op" id="3119085">)</span><span class="op" id="3119086">.</span><span class="ident" id="3119087">typ</span>&nbsp;<span class="op" id="3119091">==</span>&nbsp;<span class="ident" id="3119094">itemDefine</span>&nbsp;<span class="op" id="3119105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119111">newT</span>&nbsp;<span class="op" id="3119116">:=</span>&nbsp;<span class="ident" id="3119119">New</span><span class="op" id="3119122">(</span><span class="string" id="3119123">&#34;definition&#34;</span><span class="op" id="3119135">)</span>&nbsp;<span class="comment" id="3119137">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119182">newT</span><span class="op" id="3119186">.</span><span class="ident" id="3119187">text</span>&nbsp;<span class="op" id="3119192">=</span>&nbsp;<span class="ident" id="3119194">t</span><span class="op" id="3119195">.</span><span class="ident" id="3119196">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119205">newT</span><span class="op" id="3119209">.</span><span class="ident" id="3119210">ParseName</span>&nbsp;<span class="op" id="3119220">=</span>&nbsp;<span class="ident" id="3119222">t</span><span class="op" id="3119223">.</span><span class="ident" id="3119224">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119238">newT</span><span class="op" id="3119242">.</span><span class="ident" id="3119243">startParse</span><span class="op" id="3119253">(</span><span class="ident" id="3119254">t</span><span class="op" id="3119255">.</span><span class="ident" id="3119256">funcs</span><span class="op" id="3119261">,</span>&nbsp;<span class="ident" id="3119263">t</span><span class="op" id="3119264">.</span><span class="ident" id="3119265">lex</span><span class="op" id="3119268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119274">newT</span><span class="op" id="3119278">.</span><span class="ident" id="3119279">parseDefinition</span><span class="op" id="3119294">(</span><span class="ident" id="3119295">treeSet</span><span class="op" id="3119302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119308">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119325">t</span><span class="op" id="3119326">.</span><span class="ident" id="3119327">backup2</span><span class="op" id="3119334">(</span><span class="ident" id="3119335">delim</span><span class="op" id="3119340">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119348">n</span>&nbsp;<span class="op" id="3119350">:=</span>&nbsp;<span class="ident" id="3119353">t</span><span class="op" id="3119354">.</span><span class="ident" id="3119355">textOrAction</span><span class="op" id="3119367">(</span><span class="op" id="3119368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119372">if</span>&nbsp;<span class="ident" id="3119375">n</span><span class="op" id="3119376">.</span><span class="ident" id="3119377">Type</span><span class="op" id="3119381">(</span><span class="op" id="3119382">)</span>&nbsp;<span class="op" id="3119384">==</span>&nbsp;<span class="ident" id="3119387">nodeEnd</span>&nbsp;<span class="op" id="3119395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119400">t</span><span class="op" id="3119401">.</span><span class="ident" id="3119402">errorf</span><span class="op" id="3119408">(</span><span class="string" id="3119409">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="3119424">,</span>&nbsp;<span class="ident" id="3119426">n</span><span class="op" id="3119427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119431">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119435">t</span><span class="op" id="3119436">.</span><span class="ident" id="3119437">Root</span><span class="op" id="3119441">.</span><span class="builtinfunc" id="3119442">append</span><span class="op" id="3119448">(</span><span class="ident" id="3119449">n</span><span class="op" id="3119450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119456">return</span>&nbsp;<span class="builtintype" id="3119463">nil</span><br>
<span class="lineno"></span><span class="op" id="3119467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="3119470">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3119546">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="3119627">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="3119644">func</span>&nbsp;<span class="op" id="3119649">(</span><span class="ident" id="3119650">t</span>&nbsp;<span class="op" id="3119652">*</span><span class="ident" id="3119653">Tree</span><span class="op" id="3119657">)</span>&nbsp;<span class="ident" id="3119659">parseDefinition</span><span class="op" id="3119674">(</span><span class="ident" id="3119675">treeSet</span>&nbsp;<span class="keyword" id="3119683">map</span><span class="op" id="3119686">[</span><span class="builtintype" id="3119687">string</span><span class="op" id="3119693">]</span><span class="op" id="3119694">*</span><span class="ident" id="3119695">Tree</span><span class="op" id="3119699">)</span>&nbsp;<span class="op" id="3119701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119704">const</span>&nbsp;<span class="ident" id="3119710">context</span>&nbsp;<span class="op" id="3119718">=</span>&nbsp;<span class="string" id="3119720">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119737">name</span>&nbsp;<span class="op" id="3119742">:=</span>&nbsp;<span class="ident" id="3119745">t</span><span class="op" id="3119746">.</span><span class="ident" id="3119747">expectOneOf</span><span class="op" id="3119758">(</span><span class="ident" id="3119759">itemString</span><span class="op" id="3119769">,</span>&nbsp;<span class="ident" id="3119771">itemRawString</span><span class="op" id="3119784">,</span>&nbsp;<span class="ident" id="3119786">context</span><span class="op" id="3119793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119796">var</span>&nbsp;<span class="ident" id="3119800">err</span>&nbsp;<span class="builtintype" id="3119804">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119811">t</span><span class="op" id="3119812">.</span><span class="ident" id="3119813">Name</span><span class="op" id="3119817">,</span>&nbsp;<span class="ident" id="3119819">err</span>&nbsp;<span class="op" id="3119823">=</span>&nbsp;<span class="ident" id="3119825">strconv</span><span class="op" id="3119832">.</span><span class="ident" id="3119833">Unquote</span><span class="op" id="3119840">(</span><span class="ident" id="3119841">name</span><span class="op" id="3119845">.</span><span class="ident" id="3119846">val</span><span class="op" id="3119849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119852">if</span>&nbsp;<span class="ident" id="3119855">err</span>&nbsp;<span class="op" id="3119859">!=</span>&nbsp;<span class="builtintype" id="3119862">nil</span>&nbsp;<span class="op" id="3119866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119870">t</span><span class="op" id="3119871">.</span><span class="builtintype" id="3119872">error</span><span class="op" id="3119877">(</span><span class="ident" id="3119878">err</span><span class="op" id="3119881">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3119884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119887">t</span><span class="op" id="3119888">.</span><span class="ident" id="3119889">expect</span><span class="op" id="3119895">(</span><span class="ident" id="3119896">itemRightDelim</span><span class="op" id="3119910">,</span>&nbsp;<span class="ident" id="3119912">context</span><span class="op" id="3119919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119922">var</span>&nbsp;<span class="ident" id="3119926">end</span>&nbsp;<span class="ident" id="3119930">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119936">t</span><span class="op" id="3119937">.</span><span class="ident" id="3119938">Root</span><span class="op" id="3119942">,</span>&nbsp;<span class="ident" id="3119944">end</span>&nbsp;<span class="op" id="3119948">=</span>&nbsp;<span class="ident" id="3119950">t</span><span class="op" id="3119951">.</span><span class="ident" id="3119952">itemList</span><span class="op" id="3119960">(</span><span class="op" id="3119961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3119964">if</span>&nbsp;<span class="ident" id="3119967">end</span><span class="op" id="3119970">.</span><span class="ident" id="3119971">Type</span><span class="op" id="3119975">(</span><span class="op" id="3119976">)</span>&nbsp;<span class="op" id="3119978">!=</span>&nbsp;<span class="ident" id="3119981">nodeEnd</span>&nbsp;<span class="op" id="3119989">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3119993">t</span><span class="op" id="3119994">.</span><span class="ident" id="3119995">errorf</span><span class="op" id="3120001">(</span><span class="string" id="3120002">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3120023">,</span>&nbsp;<span class="ident" id="3120025">end</span><span class="op" id="3120028">,</span>&nbsp;<span class="ident" id="3120030">context</span><span class="op" id="3120037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120043">t</span><span class="op" id="3120044">.</span><span class="ident" id="3120045">add</span><span class="op" id="3120048">(</span><span class="ident" id="3120049">treeSet</span><span class="op" id="3120056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120059">t</span><span class="op" id="3120060">.</span><span class="ident" id="3120061">stopParse</span><span class="op" id="3120070">(</span><span class="op" id="3120071">)</span><br>
<span class="lineno"></span><span class="op" id="3120073">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="3120076">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="3120089">//&nbsp;&nbsp;&nbsp;&nbsp;textOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="3120106">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="3120165">func</span>&nbsp;<span class="op" id="3120170">(</span><span class="ident" id="3120171">t</span>&nbsp;<span class="op" id="3120173">*</span><span class="ident" id="3120174">Tree</span><span class="op" id="3120178">)</span>&nbsp;<span class="ident" id="3120180">itemList</span><span class="op" id="3120188">(</span><span class="op" id="3120189">)</span>&nbsp;<span class="op" id="3120191">(</span><span class="ident" id="3120192">list</span>&nbsp;<span class="op" id="3120197">*</span><span class="ident" id="3120198">ListNode</span><span class="op" id="3120206">,</span>&nbsp;<span class="ident" id="3120208">next</span>&nbsp;<span class="ident" id="3120213">Node</span><span class="op" id="3120217">)</span>&nbsp;<span class="op" id="3120219">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120222">list</span>&nbsp;<span class="op" id="3120227">=</span>&nbsp;<span class="ident" id="3120229">t</span><span class="op" id="3120230">.</span><span class="ident" id="3120231">newList</span><span class="op" id="3120238">(</span><span class="ident" id="3120239">t</span><span class="op" id="3120240">.</span><span class="ident" id="3120241">peekNonSpace</span><span class="op" id="3120253">(</span><span class="op" id="3120254">)</span><span class="op" id="3120255">.</span><span class="ident" id="3120256">pos</span><span class="op" id="3120259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120262">for</span>&nbsp;<span class="ident" id="3120266">t</span><span class="op" id="3120267">.</span><span class="ident" id="3120268">peekNonSpace</span><span class="op" id="3120280">(</span><span class="op" id="3120281">)</span><span class="op" id="3120282">.</span><span class="ident" id="3120283">typ</span>&nbsp;<span class="op" id="3120287">!=</span>&nbsp;<span class="ident" id="3120290">itemEOF</span>&nbsp;<span class="op" id="3120298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120302">n</span>&nbsp;<span class="op" id="3120304">:=</span>&nbsp;<span class="ident" id="3120307">t</span><span class="op" id="3120308">.</span><span class="ident" id="3120309">textOrAction</span><span class="op" id="3120321">(</span><span class="op" id="3120322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120326">switch</span>&nbsp;<span class="ident" id="3120333">n</span><span class="op" id="3120334">.</span><span class="ident" id="3120335">Type</span><span class="op" id="3120339">(</span><span class="op" id="3120340">)</span>&nbsp;<span class="op" id="3120342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120346">case</span>&nbsp;<span class="ident" id="3120351">nodeEnd</span><span class="op" id="3120358">,</span>&nbsp;<span class="ident" id="3120360">nodeElse</span><span class="op" id="3120368">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120373">return</span>&nbsp;<span class="ident" id="3120380">list</span><span class="op" id="3120384">,</span>&nbsp;<span class="ident" id="3120386">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120394">list</span><span class="op" id="3120398">.</span><span class="builtinfunc" id="3120399">append</span><span class="op" id="3120405">(</span><span class="ident" id="3120406">n</span><span class="op" id="3120407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120413">t</span><span class="op" id="3120414">.</span><span class="ident" id="3120415">errorf</span><span class="op" id="3120421">(</span><span class="string" id="3120422">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="3120438">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120441">return</span><br>
<span class="lineno"></span><span class="op" id="3120448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3120451">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="3120468">//&nbsp;&nbsp;&nbsp;&nbsp;text&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="3120485">func</span>&nbsp;<span class="op" id="3120490">(</span><span class="ident" id="3120491">t</span>&nbsp;<span class="op" id="3120493">*</span><span class="ident" id="3120494">Tree</span><span class="op" id="3120498">)</span>&nbsp;<span class="ident" id="3120500">textOrAction</span><span class="op" id="3120512">(</span><span class="op" id="3120513">)</span>&nbsp;<span class="ident" id="3120515">Node</span>&nbsp;<span class="op" id="3120520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120523">switch</span>&nbsp;<span class="ident" id="3120530">token</span>&nbsp;<span class="op" id="3120536">:=</span>&nbsp;<span class="ident" id="3120539">t</span><span class="op" id="3120540">.</span><span class="ident" id="3120541">nextNonSpace</span><span class="op" id="3120553">(</span><span class="op" id="3120554">)</span><span class="op" id="3120555">;</span>&nbsp;<span class="ident" id="3120557">token</span><span class="op" id="3120562">.</span><span class="ident" id="3120563">typ</span>&nbsp;<span class="op" id="3120567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120570">case</span>&nbsp;<span class="ident" id="3120575">itemText</span><span class="op" id="3120583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120587">return</span>&nbsp;<span class="ident" id="3120594">t</span><span class="op" id="3120595">.</span><span class="ident" id="3120596">newText</span><span class="op" id="3120603">(</span><span class="ident" id="3120604">token</span><span class="op" id="3120609">.</span><span class="ident" id="3120610">pos</span><span class="op" id="3120613">,</span>&nbsp;<span class="ident" id="3120615">token</span><span class="op" id="3120620">.</span><span class="ident" id="3120621">val</span><span class="op" id="3120624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120627">case</span>&nbsp;<span class="ident" id="3120632">itemLeftDelim</span><span class="op" id="3120645">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120649">return</span>&nbsp;<span class="ident" id="3120656">t</span><span class="op" id="3120657">.</span><span class="ident" id="3120658">action</span><span class="op" id="3120664">(</span><span class="op" id="3120665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120668">default</span><span class="op" id="3120675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3120679">t</span><span class="op" id="3120680">.</span><span class="ident" id="3120681">unexpected</span><span class="op" id="3120691">(</span><span class="ident" id="3120692">token</span><span class="op" id="3120697">,</span>&nbsp;<span class="string" id="3120699">&#34;input&#34;</span><span class="op" id="3120706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3120709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120712">return</span>&nbsp;<span class="builtintype" id="3120719">nil</span><br>
<span class="lineno">350</span><span class="op" id="3120723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3120726">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="3120737">//&nbsp;&nbsp;&nbsp;&nbsp;control</span><br>
<span class="lineno"></span><span class="comment" id="3120748">//&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="3120774">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="3120814">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="3120862">func</span>&nbsp;<span class="op" id="3120867">(</span><span class="ident" id="3120868">t</span>&nbsp;<span class="op" id="3120870">*</span><span class="ident" id="3120871">Tree</span><span class="op" id="3120875">)</span>&nbsp;<span class="ident" id="3120877">action</span><span class="op" id="3120883">(</span><span class="op" id="3120884">)</span>&nbsp;<span class="op" id="3120886">(</span><span class="ident" id="3120887">n</span>&nbsp;<span class="ident" id="3120889">Node</span><span class="op" id="3120893">)</span>&nbsp;<span class="op" id="3120895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120898">switch</span>&nbsp;<span class="ident" id="3120905">token</span>&nbsp;<span class="op" id="3120911">:=</span>&nbsp;<span class="ident" id="3120914">t</span><span class="op" id="3120915">.</span><span class="ident" id="3120916">nextNonSpace</span><span class="op" id="3120928">(</span><span class="op" id="3120929">)</span><span class="op" id="3120930">;</span>&nbsp;<span class="ident" id="3120932">token</span><span class="op" id="3120937">.</span><span class="ident" id="3120938">typ</span>&nbsp;<span class="op" id="3120942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120945">case</span>&nbsp;<span class="ident" id="3120950">itemElse</span><span class="op" id="3120958">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120962">return</span>&nbsp;<span class="ident" id="3120969">t</span><span class="op" id="3120970">.</span><span class="ident" id="3120971">elseControl</span><span class="op" id="3120982">(</span><span class="op" id="3120983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3120986">case</span>&nbsp;<span class="ident" id="3120991">itemEnd</span><span class="op" id="3120998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121002">return</span>&nbsp;<span class="ident" id="3121009">t</span><span class="op" id="3121010">.</span><span class="ident" id="3121011">endControl</span><span class="op" id="3121021">(</span><span class="op" id="3121022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121025">case</span>&nbsp;<span class="ident" id="3121030">itemIf</span><span class="op" id="3121036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121040">return</span>&nbsp;<span class="ident" id="3121047">t</span><span class="op" id="3121048">.</span><span class="ident" id="3121049">ifControl</span><span class="op" id="3121058">(</span><span class="op" id="3121059">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121062">case</span>&nbsp;<span class="ident" id="3121067">itemRange</span><span class="op" id="3121076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121080">return</span>&nbsp;<span class="ident" id="3121087">t</span><span class="op" id="3121088">.</span><span class="ident" id="3121089">rangeControl</span><span class="op" id="3121101">(</span><span class="op" id="3121102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121105">case</span>&nbsp;<span class="ident" id="3121110">itemTemplate</span><span class="op" id="3121122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121126">return</span>&nbsp;<span class="ident" id="3121133">t</span><span class="op" id="3121134">.</span><span class="ident" id="3121135">templateControl</span><span class="op" id="3121150">(</span><span class="op" id="3121151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121154">case</span>&nbsp;<span class="ident" id="3121159">itemWith</span><span class="op" id="3121167">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121171">return</span>&nbsp;<span class="ident" id="3121178">t</span><span class="op" id="3121179">.</span><span class="ident" id="3121180">withControl</span><span class="op" id="3121191">(</span><span class="op" id="3121192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3121195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121198">t</span><span class="op" id="3121199">.</span><span class="ident" id="3121200">backup</span><span class="op" id="3121206">(</span><span class="op" id="3121207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3121210">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121262">return</span>&nbsp;<span class="ident" id="3121269">t</span><span class="op" id="3121270">.</span><span class="ident" id="3121271">newAction</span><span class="op" id="3121280">(</span><span class="ident" id="3121281">t</span><span class="op" id="3121282">.</span><span class="ident" id="3121283">peek</span><span class="op" id="3121287">(</span><span class="op" id="3121288">)</span><span class="op" id="3121289">.</span><span class="ident" id="3121290">pos</span><span class="op" id="3121293">,</span>&nbsp;<span class="ident" id="3121295">t</span><span class="op" id="3121296">.</span><span class="ident" id="3121297">lex</span><span class="op" id="3121300">.</span><span class="ident" id="3121301">lineNumber</span><span class="op" id="3121311">(</span><span class="op" id="3121312">)</span><span class="op" id="3121313">,</span>&nbsp;<span class="ident" id="3121315">t</span><span class="op" id="3121316">.</span><span class="ident" id="3121317">pipeline</span><span class="op" id="3121325">(</span><span class="string" id="3121326">&#34;command&#34;</span><span class="op" id="3121335">)</span><span class="op" id="3121336">)</span><br>
<span class="lineno">375</span><span class="op" id="3121338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3121341">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="3121354">//&nbsp;&nbsp;&nbsp;&nbsp;declarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="3121394">func</span>&nbsp;<span class="op" id="3121399">(</span><span class="ident" id="3121400">t</span>&nbsp;<span class="op" id="3121402">*</span><span class="ident" id="3121403">Tree</span><span class="op" id="3121407">)</span>&nbsp;<span class="ident" id="3121409">pipeline</span><span class="op" id="3121417">(</span><span class="ident" id="3121418">context</span>&nbsp;<span class="builtintype" id="3121426">string</span><span class="op" id="3121432">)</span>&nbsp;<span class="op" id="3121434">(</span><span class="ident" id="3121435">pipe</span>&nbsp;<span class="op" id="3121440">*</span><span class="ident" id="3121441">PipeNode</span><span class="op" id="3121449">)</span>&nbsp;<span class="op" id="3121451">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121454">var</span>&nbsp;<span class="ident" id="3121458">decl</span>&nbsp;<span class="op" id="3121463">[</span><span class="op" id="3121464">]</span><span class="op" id="3121465">*</span><span class="ident" id="3121466">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121480">pos</span>&nbsp;<span class="op" id="3121484">:=</span>&nbsp;<span class="ident" id="3121487">t</span><span class="op" id="3121488">.</span><span class="ident" id="3121489">peekNonSpace</span><span class="op" id="3121501">(</span><span class="op" id="3121502">)</span><span class="op" id="3121503">.</span><span class="ident" id="3121504">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3121509">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121537">for</span>&nbsp;<span class="op" id="3121541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121545">if</span>&nbsp;<span class="ident" id="3121548">v</span>&nbsp;<span class="op" id="3121550">:=</span>&nbsp;<span class="ident" id="3121553">t</span><span class="op" id="3121554">.</span><span class="ident" id="3121555">peekNonSpace</span><span class="op" id="3121567">(</span><span class="op" id="3121568">)</span><span class="op" id="3121569">;</span>&nbsp;<span class="ident" id="3121571">v</span><span class="op" id="3121572">.</span><span class="ident" id="3121573">typ</span>&nbsp;<span class="op" id="3121577">==</span>&nbsp;<span class="ident" id="3121580">itemVariable</span>&nbsp;<span class="op" id="3121593">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121598">t</span><span class="op" id="3121599">.</span><span class="ident" id="3121600">next</span><span class="op" id="3121604">(</span><span class="op" id="3121605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3121610">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3121691">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3121774">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3121847">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3121915">tokenAfterVariable</span>&nbsp;<span class="op" id="3121934">:=</span>&nbsp;<span class="ident" id="3121937">t</span><span class="op" id="3121938">.</span><span class="ident" id="3121939">peek</span><span class="op" id="3121943">(</span><span class="op" id="3121944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3121949">if</span>&nbsp;<span class="ident" id="3121952">next</span>&nbsp;<span class="op" id="3121957">:=</span>&nbsp;<span class="ident" id="3121960">t</span><span class="op" id="3121961">.</span><span class="ident" id="3121962">peekNonSpace</span><span class="op" id="3121974">(</span><span class="op" id="3121975">)</span><span class="op" id="3121976">;</span>&nbsp;<span class="ident" id="3121978">next</span><span class="op" id="3121982">.</span><span class="ident" id="3121983">typ</span>&nbsp;<span class="op" id="3121987">==</span>&nbsp;<span class="ident" id="3121990">itemColonEquals</span>&nbsp;<span class="op" id="3122006">||</span>&nbsp;<span class="op" id="3122009">(</span><span class="ident" id="3122010">next</span><span class="op" id="3122014">.</span><span class="ident" id="3122015">typ</span>&nbsp;<span class="op" id="3122019">==</span>&nbsp;<span class="ident" id="3122022">itemChar</span>&nbsp;<span class="op" id="3122031">&amp;&amp;</span>&nbsp;<span class="ident" id="3122034">next</span><span class="op" id="3122038">.</span><span class="ident" id="3122039">val</span>&nbsp;<span class="op" id="3122043">==</span>&nbsp;<span class="string" id="3122046">&#34;,&#34;</span><span class="op" id="3122049">)</span>&nbsp;<span class="op" id="3122051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122057">t</span><span class="op" id="3122058">.</span><span class="ident" id="3122059">nextNonSpace</span><span class="op" id="3122071">(</span><span class="op" id="3122072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122078">variable</span>&nbsp;<span class="op" id="3122087">:=</span>&nbsp;<span class="ident" id="3122090">t</span><span class="op" id="3122091">.</span><span class="ident" id="3122092">newVariable</span><span class="op" id="3122103">(</span><span class="ident" id="3122104">v</span><span class="op" id="3122105">.</span><span class="ident" id="3122106">pos</span><span class="op" id="3122109">,</span>&nbsp;<span class="ident" id="3122111">v</span><span class="op" id="3122112">.</span><span class="ident" id="3122113">val</span><span class="op" id="3122116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122122">decl</span>&nbsp;<span class="op" id="3122127">=</span>&nbsp;<span class="builtinfunc" id="3122129">append</span><span class="op" id="3122135">(</span><span class="ident" id="3122136">decl</span><span class="op" id="3122140">,</span>&nbsp;<span class="ident" id="3122142">variable</span><span class="op" id="3122150">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122156">t</span><span class="op" id="3122157">.</span><span class="ident" id="3122158">vars</span>&nbsp;<span class="op" id="3122163">=</span>&nbsp;<span class="builtinfunc" id="3122165">append</span><span class="op" id="3122171">(</span><span class="ident" id="3122172">t</span><span class="op" id="3122173">.</span><span class="ident" id="3122174">vars</span><span class="op" id="3122178">,</span>&nbsp;<span class="ident" id="3122180">v</span><span class="op" id="3122181">.</span><span class="ident" id="3122182">val</span><span class="op" id="3122185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122191">if</span>&nbsp;<span class="ident" id="3122194">next</span><span class="op" id="3122198">.</span><span class="ident" id="3122199">typ</span>&nbsp;<span class="op" id="3122203">==</span>&nbsp;<span class="ident" id="3122206">itemChar</span>&nbsp;<span class="op" id="3122215">&amp;&amp;</span>&nbsp;<span class="ident" id="3122218">next</span><span class="op" id="3122222">.</span><span class="ident" id="3122223">val</span>&nbsp;<span class="op" id="3122227">==</span>&nbsp;<span class="string" id="3122230">&#34;,&#34;</span>&nbsp;<span class="op" id="3122234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122241">if</span>&nbsp;<span class="ident" id="3122244">context</span>&nbsp;<span class="op" id="3122252">==</span>&nbsp;<span class="string" id="3122255">&#34;range&#34;</span>&nbsp;<span class="op" id="3122263">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3122266">len</span><span class="op" id="3122269">(</span><span class="ident" id="3122270">decl</span><span class="op" id="3122274">)</span>&nbsp;<span class="op" id="3122276">&lt;</span>&nbsp;<span class="num" id="3122278">2</span>&nbsp;<span class="op" id="3122280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122288">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122302">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122309">t</span><span class="op" id="3122310">.</span><span class="ident" id="3122311">errorf</span><span class="op" id="3122317">(</span><span class="string" id="3122318">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3122347">,</span>&nbsp;<span class="ident" id="3122349">context</span><span class="op" id="3122356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122367">}</span>&nbsp;<span class="keyword" id="3122369">else</span>&nbsp;<span class="keyword" id="3122374">if</span>&nbsp;<span class="ident" id="3122377">tokenAfterVariable</span><span class="op" id="3122395">.</span><span class="ident" id="3122396">typ</span>&nbsp;<span class="op" id="3122400">==</span>&nbsp;<span class="ident" id="3122403">itemSpace</span>&nbsp;<span class="op" id="3122413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122419">t</span><span class="op" id="3122420">.</span><span class="ident" id="3122421">backup3</span><span class="op" id="3122428">(</span><span class="ident" id="3122429">v</span><span class="op" id="3122430">,</span>&nbsp;<span class="ident" id="3122432">tokenAfterVariable</span><span class="op" id="3122450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122455">}</span>&nbsp;<span class="keyword" id="3122457">else</span>&nbsp;<span class="op" id="3122462">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122468">t</span><span class="op" id="3122469">.</span><span class="ident" id="3122470">backup2</span><span class="op" id="3122477">(</span><span class="ident" id="3122478">v</span><span class="op" id="3122479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122492">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122499">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122502">pipe</span>&nbsp;<span class="op" id="3122507">=</span>&nbsp;<span class="ident" id="3122509">t</span><span class="op" id="3122510">.</span><span class="ident" id="3122511">newPipeline</span><span class="op" id="3122522">(</span><span class="ident" id="3122523">pos</span><span class="op" id="3122526">,</span>&nbsp;<span class="ident" id="3122528">t</span><span class="op" id="3122529">.</span><span class="ident" id="3122530">lex</span><span class="op" id="3122533">.</span><span class="ident" id="3122534">lineNumber</span><span class="op" id="3122544">(</span><span class="op" id="3122545">)</span><span class="op" id="3122546">,</span>&nbsp;<span class="ident" id="3122548">decl</span><span class="op" id="3122552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122555">for</span>&nbsp;<span class="op" id="3122559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122563">switch</span>&nbsp;<span class="ident" id="3122570">token</span>&nbsp;<span class="op" id="3122576">:=</span>&nbsp;<span class="ident" id="3122579">t</span><span class="op" id="3122580">.</span><span class="ident" id="3122581">nextNonSpace</span><span class="op" id="3122593">(</span><span class="op" id="3122594">)</span><span class="op" id="3122595">;</span>&nbsp;<span class="ident" id="3122597">token</span><span class="op" id="3122602">.</span><span class="ident" id="3122603">typ</span>&nbsp;<span class="op" id="3122607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122611">case</span>&nbsp;<span class="ident" id="3122616">itemRightDelim</span><span class="op" id="3122630">,</span>&nbsp;<span class="ident" id="3122632">itemRightParen</span><span class="op" id="3122646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122651">if</span>&nbsp;<span class="builtinfunc" id="3122654">len</span><span class="op" id="3122657">(</span><span class="ident" id="3122658">pipe</span><span class="op" id="3122662">.</span><span class="ident" id="3122663">Cmds</span><span class="op" id="3122667">)</span>&nbsp;<span class="op" id="3122669">==</span>&nbsp;<span class="num" id="3122672">0</span>&nbsp;<span class="op" id="3122674">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122680">t</span><span class="op" id="3122681">.</span><span class="ident" id="3122682">errorf</span><span class="op" id="3122688">(</span><span class="string" id="3122689">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="3122711">,</span>&nbsp;<span class="ident" id="3122713">context</span><span class="op" id="3122720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122730">if</span>&nbsp;<span class="ident" id="3122733">token</span><span class="op" id="3122738">.</span><span class="ident" id="3122739">typ</span>&nbsp;<span class="op" id="3122743">==</span>&nbsp;<span class="ident" id="3122746">itemRightParen</span>&nbsp;<span class="op" id="3122761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122767">t</span><span class="op" id="3122768">.</span><span class="ident" id="3122769">backup</span><span class="op" id="3122775">(</span><span class="op" id="3122776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3122781">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122786">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3122795">case</span>&nbsp;<span class="ident" id="3122800">itemBool</span><span class="op" id="3122808">,</span>&nbsp;<span class="ident" id="3122810">itemCharConstant</span><span class="op" id="3122826">,</span>&nbsp;<span class="ident" id="3122828">itemComplex</span><span class="op" id="3122839">,</span>&nbsp;<span class="ident" id="3122841">itemDot</span><span class="op" id="3122848">,</span>&nbsp;<span class="ident" id="3122850">itemField</span><span class="op" id="3122859">,</span>&nbsp;<span class="ident" id="3122861">itemIdentifier</span><span class="op" id="3122875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122880">itemNumber</span><span class="op" id="3122890">,</span>&nbsp;<span class="ident" id="3122892">itemNil</span><span class="op" id="3122899">,</span>&nbsp;<span class="ident" id="3122901">itemRawString</span><span class="op" id="3122914">,</span>&nbsp;<span class="ident" id="3122916">itemString</span><span class="op" id="3122926">,</span>&nbsp;<span class="ident" id="3122928">itemVariable</span><span class="op" id="3122940">,</span>&nbsp;<span class="ident" id="3122942">itemLeftParen</span><span class="op" id="3122955">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122960">t</span><span class="op" id="3122961">.</span><span class="ident" id="3122962">backup</span><span class="op" id="3122968">(</span><span class="op" id="3122969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3122974">pipe</span><span class="op" id="3122978">.</span><span class="builtinfunc" id="3122979">append</span><span class="op" id="3122985">(</span><span class="ident" id="3122986">t</span><span class="op" id="3122987">.</span><span class="ident" id="3122988">command</span><span class="op" id="3122995">(</span><span class="op" id="3122996">)</span><span class="op" id="3122997">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123001">default</span><span class="op" id="3123008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123013">t</span><span class="op" id="3123014">.</span><span class="ident" id="3123015">unexpected</span><span class="op" id="3123025">(</span><span class="ident" id="3123026">token</span><span class="op" id="3123031">,</span>&nbsp;<span class="ident" id="3123033">context</span><span class="op" id="3123040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3123047">}</span><br>
<span class="lineno"></span><span class="op" id="3123049">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3123052">func</span>&nbsp;<span class="op" id="3123057">(</span><span class="ident" id="3123058">t</span>&nbsp;<span class="op" id="3123060">*</span><span class="ident" id="3123061">Tree</span><span class="op" id="3123065">)</span>&nbsp;<span class="ident" id="3123067">parseControl</span><span class="op" id="3123079">(</span><span class="ident" id="3123080">allowElseIf</span>&nbsp;<span class="builtintype" id="3123092">bool</span><span class="op" id="3123096">,</span>&nbsp;<span class="ident" id="3123098">context</span>&nbsp;<span class="builtintype" id="3123106">string</span><span class="op" id="3123112">)</span>&nbsp;<span class="op" id="3123114">(</span><span class="ident" id="3123115">pos</span>&nbsp;<span class="ident" id="3123119">Pos</span><span class="op" id="3123122">,</span>&nbsp;<span class="ident" id="3123124">line</span>&nbsp;<span class="builtintype" id="3123129">int</span><span class="op" id="3123132">,</span>&nbsp;<span class="ident" id="3123134">pipe</span>&nbsp;<span class="op" id="3123139">*</span><span class="ident" id="3123140">PipeNode</span><span class="op" id="3123148">,</span>&nbsp;<span class="ident" id="3123150">list</span><span class="op" id="3123154">,</span>&nbsp;<span class="ident" id="3123156">elseList</span>&nbsp;<span class="op" id="3123165">*</span><span class="ident" id="3123166">ListNode</span><span class="op" id="3123174">)</span>&nbsp;<span class="op" id="3123176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123179">defer</span>&nbsp;<span class="ident" id="3123185">t</span><span class="op" id="3123186">.</span><span class="ident" id="3123187">popVars</span><span class="op" id="3123194">(</span><span class="builtinfunc" id="3123195">len</span><span class="op" id="3123198">(</span><span class="ident" id="3123199">t</span><span class="op" id="3123200">.</span><span class="ident" id="3123201">vars</span><span class="op" id="3123205">)</span><span class="op" id="3123206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123209">line</span>&nbsp;<span class="op" id="3123214">=</span>&nbsp;<span class="ident" id="3123216">t</span><span class="op" id="3123217">.</span><span class="ident" id="3123218">lex</span><span class="op" id="3123221">.</span><span class="ident" id="3123222">lineNumber</span><span class="op" id="3123232">(</span><span class="op" id="3123233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123236">pipe</span>&nbsp;<span class="op" id="3123241">=</span>&nbsp;<span class="ident" id="3123243">t</span><span class="op" id="3123244">.</span><span class="ident" id="3123245">pipeline</span><span class="op" id="3123253">(</span><span class="ident" id="3123254">context</span><span class="op" id="3123261">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123264">var</span>&nbsp;<span class="ident" id="3123268">next</span>&nbsp;<span class="ident" id="3123273">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123279">list</span><span class="op" id="3123283">,</span>&nbsp;<span class="ident" id="3123285">next</span>&nbsp;<span class="op" id="3123290">=</span>&nbsp;<span class="ident" id="3123292">t</span><span class="op" id="3123293">.</span><span class="ident" id="3123294">itemList</span><span class="op" id="3123302">(</span><span class="op" id="3123303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123306">switch</span>&nbsp;<span class="ident" id="3123313">next</span><span class="op" id="3123317">.</span><span class="ident" id="3123318">Type</span><span class="op" id="3123322">(</span><span class="op" id="3123323">)</span>&nbsp;<span class="op" id="3123325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123328">case</span>&nbsp;<span class="ident" id="3123333">nodeEnd</span><span class="op" id="3123340">:</span>&nbsp;<span class="comment" id="3123342">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123350">case</span>&nbsp;<span class="ident" id="3123355">nodeElse</span><span class="op" id="3123363">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123367">if</span>&nbsp;<span class="ident" id="3123370">allowElseIf</span>&nbsp;<span class="op" id="3123382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123387">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123471">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123538">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123575">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123584">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123632">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123718">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123790">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3123845">if</span>&nbsp;<span class="ident" id="3123848">t</span><span class="op" id="3123849">.</span><span class="ident" id="3123850">peek</span><span class="op" id="3123854">(</span><span class="op" id="3123855">)</span><span class="op" id="3123856">.</span><span class="ident" id="3123857">typ</span>&nbsp;<span class="op" id="3123861">==</span>&nbsp;<span class="ident" id="3123864">itemIf</span>&nbsp;<span class="op" id="3123871">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123877">t</span><span class="op" id="3123878">.</span><span class="ident" id="3123879">next</span><span class="op" id="3123883">(</span><span class="op" id="3123884">)</span>&nbsp;<span class="comment" id="3123886">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123917">elseList</span>&nbsp;<span class="op" id="3123926">=</span>&nbsp;<span class="ident" id="3123928">t</span><span class="op" id="3123929">.</span><span class="ident" id="3123930">newList</span><span class="op" id="3123937">(</span><span class="ident" id="3123938">next</span><span class="op" id="3123942">.</span><span class="ident" id="3123943">Position</span><span class="op" id="3123951">(</span><span class="op" id="3123952">)</span><span class="op" id="3123953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123959">elseList</span><span class="op" id="3123967">.</span><span class="builtinfunc" id="3123968">append</span><span class="op" id="3123974">(</span><span class="ident" id="3123975">t</span><span class="op" id="3123976">.</span><span class="ident" id="3123977">ifControl</span><span class="op" id="3123986">(</span><span class="op" id="3123987">)</span><span class="op" id="3123988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3123994">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124059">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124076">elseList</span><span class="op" id="3124084">,</span>&nbsp;<span class="ident" id="3124086">next</span>&nbsp;<span class="op" id="3124091">=</span>&nbsp;<span class="ident" id="3124093">t</span><span class="op" id="3124094">.</span><span class="ident" id="3124095">itemList</span><span class="op" id="3124103">(</span><span class="op" id="3124104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124108">if</span>&nbsp;<span class="ident" id="3124111">next</span><span class="op" id="3124115">.</span><span class="ident" id="3124116">Type</span><span class="op" id="3124120">(</span><span class="op" id="3124121">)</span>&nbsp;<span class="op" id="3124123">!=</span>&nbsp;<span class="ident" id="3124126">nodeEnd</span>&nbsp;<span class="op" id="3124134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124139">t</span><span class="op" id="3124140">.</span><span class="ident" id="3124141">errorf</span><span class="op" id="3124147">(</span><span class="string" id="3124148">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="3124172">,</span>&nbsp;<span class="ident" id="3124174">next</span><span class="op" id="3124178">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124188">return</span>&nbsp;<span class="ident" id="3124195">pipe</span><span class="op" id="3124199">.</span><span class="ident" id="3124200">Position</span><span class="op" id="3124208">(</span><span class="op" id="3124209">)</span><span class="op" id="3124210">,</span>&nbsp;<span class="ident" id="3124212">line</span><span class="op" id="3124216">,</span>&nbsp;<span class="ident" id="3124218">pipe</span><span class="op" id="3124222">,</span>&nbsp;<span class="ident" id="3124224">list</span><span class="op" id="3124228">,</span>&nbsp;<span class="ident" id="3124230">elseList</span><br>
<span class="lineno"></span><span class="op" id="3124239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="3124242">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="3124249">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3124285">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3124339">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3124362">func</span>&nbsp;<span class="op" id="3124367">(</span><span class="ident" id="3124368">t</span>&nbsp;<span class="op" id="3124370">*</span><span class="ident" id="3124371">Tree</span><span class="op" id="3124375">)</span>&nbsp;<span class="ident" id="3124377">ifControl</span><span class="op" id="3124386">(</span><span class="op" id="3124387">)</span>&nbsp;<span class="ident" id="3124389">Node</span>&nbsp;<span class="op" id="3124394">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124397">return</span>&nbsp;<span class="ident" id="3124404">t</span><span class="op" id="3124405">.</span><span class="ident" id="3124406">newIf</span><span class="op" id="3124411">(</span><span class="ident" id="3124412">t</span><span class="op" id="3124413">.</span><span class="ident" id="3124414">parseControl</span><span class="op" id="3124426">(</span><span class="builtintype" id="3124427">true</span><span class="op" id="3124431">,</span>&nbsp;<span class="string" id="3124433">&#34;if&#34;</span><span class="op" id="3124437">)</span><span class="op" id="3124438">)</span><br>
<span class="lineno"></span><span class="op" id="3124440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3124443">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="3124453">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="3124492">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3124549">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3124575">func</span>&nbsp;<span class="op" id="3124580">(</span><span class="ident" id="3124581">t</span>&nbsp;<span class="op" id="3124583">*</span><span class="ident" id="3124584">Tree</span><span class="op" id="3124588">)</span>&nbsp;<span class="ident" id="3124590">rangeControl</span><span class="op" id="3124602">(</span><span class="op" id="3124603">)</span>&nbsp;<span class="ident" id="3124605">Node</span>&nbsp;<span class="op" id="3124610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124613">return</span>&nbsp;<span class="ident" id="3124620">t</span><span class="op" id="3124621">.</span><span class="ident" id="3124622">newRange</span><span class="op" id="3124630">(</span><span class="ident" id="3124631">t</span><span class="op" id="3124632">.</span><span class="ident" id="3124633">parseControl</span><span class="op" id="3124645">(</span><span class="builtintype" id="3124646">false</span><span class="op" id="3124651">,</span>&nbsp;<span class="string" id="3124653">&#34;range&#34;</span><span class="op" id="3124660">)</span><span class="op" id="3124661">)</span><br>
<span class="lineno"></span><span class="op" id="3124663">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3124666">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="3124675">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3124713">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3124769">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="3124792">func</span>&nbsp;<span class="op" id="3124797">(</span><span class="ident" id="3124798">t</span>&nbsp;<span class="op" id="3124800">*</span><span class="ident" id="3124801">Tree</span><span class="op" id="3124805">)</span>&nbsp;<span class="ident" id="3124807">withControl</span><span class="op" id="3124818">(</span><span class="op" id="3124819">)</span>&nbsp;<span class="ident" id="3124821">Node</span>&nbsp;<span class="op" id="3124826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124829">return</span>&nbsp;<span class="ident" id="3124836">t</span><span class="op" id="3124837">.</span><span class="ident" id="3124838">newWith</span><span class="op" id="3124845">(</span><span class="ident" id="3124846">t</span><span class="op" id="3124847">.</span><span class="ident" id="3124848">parseControl</span><span class="op" id="3124860">(</span><span class="builtintype" id="3124861">false</span><span class="op" id="3124866">,</span>&nbsp;<span class="string" id="3124868">&#34;with&#34;</span><span class="op" id="3124874">)</span><span class="op" id="3124875">)</span><br>
<span class="lineno"></span><span class="op" id="3124877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3124880">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="3124888">//&nbsp;&nbsp;&nbsp;&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3124899">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3124923">func</span>&nbsp;<span class="op" id="3124928">(</span><span class="ident" id="3124929">t</span>&nbsp;<span class="op" id="3124931">*</span><span class="ident" id="3124932">Tree</span><span class="op" id="3124936">)</span>&nbsp;<span class="ident" id="3124938">endControl</span><span class="op" id="3124948">(</span><span class="op" id="3124949">)</span>&nbsp;<span class="ident" id="3124951">Node</span>&nbsp;<span class="op" id="3124956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124959">return</span>&nbsp;<span class="ident" id="3124966">t</span><span class="op" id="3124967">.</span><span class="ident" id="3124968">newEnd</span><span class="op" id="3124974">(</span><span class="ident" id="3124975">t</span><span class="op" id="3124976">.</span><span class="ident" id="3124977">expect</span><span class="op" id="3124983">(</span><span class="ident" id="3124984">itemRightDelim</span><span class="op" id="3124998">,</span>&nbsp;<span class="string" id="3125000">&#34;end&#34;</span><span class="op" id="3125005">)</span><span class="op" id="3125006">.</span><span class="ident" id="3125007">pos</span><span class="op" id="3125010">)</span><br>
<span class="lineno"></span><span class="op" id="3125012">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="3125015">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="3125024">//&nbsp;&nbsp;&nbsp;&nbsp;{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="3125036">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3125061">func</span>&nbsp;<span class="op" id="3125066">(</span><span class="ident" id="3125067">t</span>&nbsp;<span class="op" id="3125069">*</span><span class="ident" id="3125070">Tree</span><span class="op" id="3125074">)</span>&nbsp;<span class="ident" id="3125076">elseControl</span><span class="op" id="3125087">(</span><span class="op" id="3125088">)</span>&nbsp;<span class="ident" id="3125090">Node</span>&nbsp;<span class="op" id="3125095">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125098">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125130">peek</span>&nbsp;<span class="op" id="3125135">:=</span>&nbsp;<span class="ident" id="3125138">t</span><span class="op" id="3125139">.</span><span class="ident" id="3125140">peekNonSpace</span><span class="op" id="3125152">(</span><span class="op" id="3125153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125156">if</span>&nbsp;<span class="ident" id="3125159">peek</span><span class="op" id="3125163">.</span><span class="ident" id="3125164">typ</span>&nbsp;<span class="op" id="3125168">==</span>&nbsp;<span class="ident" id="3125171">itemIf</span>&nbsp;<span class="op" id="3125178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125182">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125259">return</span>&nbsp;<span class="ident" id="3125266">t</span><span class="op" id="3125267">.</span><span class="ident" id="3125268">newElse</span><span class="op" id="3125275">(</span><span class="ident" id="3125276">peek</span><span class="op" id="3125280">.</span><span class="ident" id="3125281">pos</span><span class="op" id="3125284">,</span>&nbsp;<span class="ident" id="3125286">t</span><span class="op" id="3125287">.</span><span class="ident" id="3125288">lex</span><span class="op" id="3125291">.</span><span class="ident" id="3125292">lineNumber</span><span class="op" id="3125302">(</span><span class="op" id="3125303">)</span><span class="op" id="3125304">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125310">return</span>&nbsp;<span class="ident" id="3125317">t</span><span class="op" id="3125318">.</span><span class="ident" id="3125319">newElse</span><span class="op" id="3125326">(</span><span class="ident" id="3125327">t</span><span class="op" id="3125328">.</span><span class="ident" id="3125329">expect</span><span class="op" id="3125335">(</span><span class="ident" id="3125336">itemRightDelim</span><span class="op" id="3125350">,</span>&nbsp;<span class="string" id="3125352">&#34;else&#34;</span><span class="op" id="3125358">)</span><span class="op" id="3125359">.</span><span class="ident" id="3125360">pos</span><span class="op" id="3125363">,</span>&nbsp;<span class="ident" id="3125365">t</span><span class="op" id="3125366">.</span><span class="ident" id="3125367">lex</span><span class="op" id="3125370">.</span><span class="ident" id="3125371">lineNumber</span><span class="op" id="3125381">(</span><span class="op" id="3125382">)</span><span class="op" id="3125383">)</span><br>
<span class="lineno"></span><span class="op" id="3125385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3125388">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="3125401">//&nbsp;&nbsp;&nbsp;&nbsp;{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="3125438">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="3125513">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3125529">func</span>&nbsp;<span class="op" id="3125534">(</span><span class="ident" id="3125535">t</span>&nbsp;<span class="op" id="3125537">*</span><span class="ident" id="3125538">Tree</span><span class="op" id="3125542">)</span>&nbsp;<span class="ident" id="3125544">templateControl</span><span class="op" id="3125559">(</span><span class="op" id="3125560">)</span>&nbsp;<span class="ident" id="3125562">Node</span>&nbsp;<span class="op" id="3125567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125570">var</span>&nbsp;<span class="ident" id="3125574">name</span>&nbsp;<span class="builtintype" id="3125579">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125587">token</span>&nbsp;<span class="op" id="3125593">:=</span>&nbsp;<span class="ident" id="3125596">t</span><span class="op" id="3125597">.</span><span class="ident" id="3125598">nextNonSpace</span><span class="op" id="3125610">(</span><span class="op" id="3125611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125614">switch</span>&nbsp;<span class="ident" id="3125621">token</span><span class="op" id="3125626">.</span><span class="ident" id="3125627">typ</span>&nbsp;<span class="op" id="3125631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125634">case</span>&nbsp;<span class="ident" id="3125639">itemString</span><span class="op" id="3125649">,</span>&nbsp;<span class="ident" id="3125651">itemRawString</span><span class="op" id="3125664">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125668">s</span><span class="op" id="3125669">,</span>&nbsp;<span class="ident" id="3125671">err</span>&nbsp;<span class="op" id="3125675">:=</span>&nbsp;<span class="ident" id="3125678">strconv</span><span class="op" id="3125685">.</span><span class="ident" id="3125686">Unquote</span><span class="op" id="3125693">(</span><span class="ident" id="3125694">token</span><span class="op" id="3125699">.</span><span class="ident" id="3125700">val</span><span class="op" id="3125703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125707">if</span>&nbsp;<span class="ident" id="3125710">err</span>&nbsp;<span class="op" id="3125714">!=</span>&nbsp;<span class="builtintype" id="3125717">nil</span>&nbsp;<span class="op" id="3125721">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125726">t</span><span class="op" id="3125727">.</span><span class="builtintype" id="3125728">error</span><span class="op" id="3125733">(</span><span class="ident" id="3125734">err</span><span class="op" id="3125737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125745">name</span>&nbsp;<span class="op" id="3125750">=</span>&nbsp;<span class="ident" id="3125752">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125755">default</span><span class="op" id="3125762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125766">t</span><span class="op" id="3125767">.</span><span class="ident" id="3125768">unexpected</span><span class="op" id="3125778">(</span><span class="ident" id="3125779">token</span><span class="op" id="3125784">,</span>&nbsp;<span class="string" id="3125786">&#34;template&nbsp;invocation&#34;</span><span class="op" id="3125807">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125813">var</span>&nbsp;<span class="ident" id="3125817">pipe</span>&nbsp;<span class="op" id="3125822">*</span><span class="ident" id="3125823">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125833">if</span>&nbsp;<span class="ident" id="3125836">t</span><span class="op" id="3125837">.</span><span class="ident" id="3125838">nextNonSpace</span><span class="op" id="3125850">(</span><span class="op" id="3125851">)</span><span class="op" id="3125852">.</span><span class="ident" id="3125853">typ</span>&nbsp;<span class="op" id="3125857">!=</span>&nbsp;<span class="ident" id="3125860">itemRightDelim</span>&nbsp;<span class="op" id="3125875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125879">t</span><span class="op" id="3125880">.</span><span class="ident" id="3125881">backup</span><span class="op" id="3125887">(</span><span class="op" id="3125888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125892">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125945">pipe</span>&nbsp;<span class="op" id="3125950">=</span>&nbsp;<span class="ident" id="3125952">t</span><span class="op" id="3125953">.</span><span class="ident" id="3125954">pipeline</span><span class="op" id="3125962">(</span><span class="string" id="3125963">&#34;template&#34;</span><span class="op" id="3125973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125979">return</span>&nbsp;<span class="ident" id="3125986">t</span><span class="op" id="3125987">.</span><span class="ident" id="3125988">newTemplate</span><span class="op" id="3125999">(</span><span class="ident" id="3126000">token</span><span class="op" id="3126005">.</span><span class="ident" id="3126006">pos</span><span class="op" id="3126009">,</span>&nbsp;<span class="ident" id="3126011">t</span><span class="op" id="3126012">.</span><span class="ident" id="3126013">lex</span><span class="op" id="3126016">.</span><span class="ident" id="3126017">lineNumber</span><span class="op" id="3126027">(</span><span class="op" id="3126028">)</span><span class="op" id="3126029">,</span>&nbsp;<span class="ident" id="3126031">name</span><span class="op" id="3126035">,</span>&nbsp;<span class="ident" id="3126037">pipe</span><span class="op" id="3126041">)</span><br>
<span class="lineno"></span><span class="op" id="3126043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="3126046">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="3126058">//&nbsp;&nbsp;&nbsp;&nbsp;operand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="3126086">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3126162">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="3126246">func</span>&nbsp;<span class="op" id="3126251">(</span><span class="ident" id="3126252">t</span>&nbsp;<span class="op" id="3126254">*</span><span class="ident" id="3126255">Tree</span><span class="op" id="3126259">)</span>&nbsp;<span class="ident" id="3126261">command</span><span class="op" id="3126268">(</span><span class="op" id="3126269">)</span>&nbsp;<span class="op" id="3126271">*</span><span class="ident" id="3126272">CommandNode</span>&nbsp;<span class="op" id="3126284">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126287">cmd</span>&nbsp;<span class="op" id="3126291">:=</span>&nbsp;<span class="ident" id="3126294">t</span><span class="op" id="3126295">.</span><span class="ident" id="3126296">newCommand</span><span class="op" id="3126306">(</span><span class="ident" id="3126307">t</span><span class="op" id="3126308">.</span><span class="ident" id="3126309">peekNonSpace</span><span class="op" id="3126321">(</span><span class="op" id="3126322">)</span><span class="op" id="3126323">.</span><span class="ident" id="3126324">pos</span><span class="op" id="3126327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126330">for</span>&nbsp;<span class="op" id="3126334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126338">t</span><span class="op" id="3126339">.</span><span class="ident" id="3126340">peekNonSpace</span><span class="op" id="3126352">(</span><span class="op" id="3126353">)</span>&nbsp;<span class="comment" id="3126355">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126381">operand</span>&nbsp;<span class="op" id="3126389">:=</span>&nbsp;<span class="ident" id="3126392">t</span><span class="op" id="3126393">.</span><span class="ident" id="3126394">operand</span><span class="op" id="3126401">(</span><span class="op" id="3126402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126406">if</span>&nbsp;<span class="ident" id="3126409">operand</span>&nbsp;<span class="op" id="3126417">!=</span>&nbsp;<span class="builtintype" id="3126420">nil</span>&nbsp;<span class="op" id="3126424">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126429">cmd</span><span class="op" id="3126432">.</span><span class="builtinfunc" id="3126433">append</span><span class="op" id="3126439">(</span><span class="ident" id="3126440">operand</span><span class="op" id="3126447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126455">switch</span>&nbsp;<span class="ident" id="3126462">token</span>&nbsp;<span class="op" id="3126468">:=</span>&nbsp;<span class="ident" id="3126471">t</span><span class="op" id="3126472">.</span><span class="ident" id="3126473">next</span><span class="op" id="3126477">(</span><span class="op" id="3126478">)</span><span class="op" id="3126479">;</span>&nbsp;<span class="ident" id="3126481">token</span><span class="op" id="3126486">.</span><span class="ident" id="3126487">typ</span>&nbsp;<span class="op" id="3126491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126495">case</span>&nbsp;<span class="ident" id="3126500">itemSpace</span><span class="op" id="3126509">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126514">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126525">case</span>&nbsp;<span class="ident" id="3126530">itemError</span><span class="op" id="3126539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126544">t</span><span class="op" id="3126545">.</span><span class="ident" id="3126546">errorf</span><span class="op" id="3126552">(</span><span class="string" id="3126553">&#34;%s&#34;</span><span class="op" id="3126557">,</span>&nbsp;<span class="ident" id="3126559">token</span><span class="op" id="3126564">.</span><span class="ident" id="3126565">val</span><span class="op" id="3126568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126572">case</span>&nbsp;<span class="ident" id="3126577">itemRightDelim</span><span class="op" id="3126591">,</span>&nbsp;<span class="ident" id="3126593">itemRightParen</span><span class="op" id="3126607">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126612">t</span><span class="op" id="3126613">.</span><span class="ident" id="3126614">backup</span><span class="op" id="3126620">(</span><span class="op" id="3126621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126625">case</span>&nbsp;<span class="ident" id="3126630">itemPipe</span><span class="op" id="3126638">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126642">default</span><span class="op" id="3126649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126654">t</span><span class="op" id="3126655">.</span><span class="ident" id="3126656">errorf</span><span class="op" id="3126662">(</span><span class="string" id="3126663">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="3126705">,</span>&nbsp;<span class="ident" id="3126707">token</span><span class="op" id="3126712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126720">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126727">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126730">if</span>&nbsp;<span class="builtinfunc" id="3126733">len</span><span class="op" id="3126736">(</span><span class="ident" id="3126737">cmd</span><span class="op" id="3126740">.</span><span class="ident" id="3126741">Args</span><span class="op" id="3126745">)</span>&nbsp;<span class="op" id="3126747">==</span>&nbsp;<span class="num" id="3126750">0</span>&nbsp;<span class="op" id="3126752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126756">t</span><span class="op" id="3126757">.</span><span class="ident" id="3126758">errorf</span><span class="op" id="3126764">(</span><span class="string" id="3126765">&#34;empty&nbsp;command&#34;</span><span class="op" id="3126780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3126786">return</span>&nbsp;<span class="ident" id="3126793">cmd</span><br>
<span class="lineno"></span><span class="op" id="3126797">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="3126800">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="3126812">//&nbsp;&nbsp;&nbsp;&nbsp;term&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="3126828">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="3126887">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="3126934">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="3126989">func</span>&nbsp;<span class="op" id="3126994">(</span><span class="ident" id="3126995">t</span>&nbsp;<span class="op" id="3126997">*</span><span class="ident" id="3126998">Tree</span><span class="op" id="3127002">)</span>&nbsp;<span class="ident" id="3127004">operand</span><span class="op" id="3127011">(</span><span class="op" id="3127012">)</span>&nbsp;<span class="ident" id="3127014">Node</span>&nbsp;<span class="op" id="3127019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127022">node</span>&nbsp;<span class="op" id="3127027">:=</span>&nbsp;<span class="ident" id="3127030">t</span><span class="op" id="3127031">.</span><span class="ident" id="3127032">term</span><span class="op" id="3127036">(</span><span class="op" id="3127037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127040">if</span>&nbsp;<span class="ident" id="3127043">node</span>&nbsp;<span class="op" id="3127048">==</span>&nbsp;<span class="builtintype" id="3127051">nil</span>&nbsp;<span class="op" id="3127055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127059">return</span>&nbsp;<span class="builtintype" id="3127066">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127074">if</span>&nbsp;<span class="ident" id="3127077">t</span><span class="op" id="3127078">.</span><span class="ident" id="3127079">peek</span><span class="op" id="3127083">(</span><span class="op" id="3127084">)</span><span class="op" id="3127085">.</span><span class="ident" id="3127086">typ</span>&nbsp;<span class="op" id="3127090">==</span>&nbsp;<span class="ident" id="3127093">itemField</span>&nbsp;<span class="op" id="3127103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127107">chain</span>&nbsp;<span class="op" id="3127113">:=</span>&nbsp;<span class="ident" id="3127116">t</span><span class="op" id="3127117">.</span><span class="ident" id="3127118">newChain</span><span class="op" id="3127126">(</span><span class="ident" id="3127127">t</span><span class="op" id="3127128">.</span><span class="ident" id="3127129">peek</span><span class="op" id="3127133">(</span><span class="op" id="3127134">)</span><span class="op" id="3127135">.</span><span class="ident" id="3127136">pos</span><span class="op" id="3127139">,</span>&nbsp;<span class="ident" id="3127141">node</span><span class="op" id="3127145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127149">for</span>&nbsp;<span class="ident" id="3127153">t</span><span class="op" id="3127154">.</span><span class="ident" id="3127155">peek</span><span class="op" id="3127159">(</span><span class="op" id="3127160">)</span><span class="op" id="3127161">.</span><span class="ident" id="3127162">typ</span>&nbsp;<span class="op" id="3127166">==</span>&nbsp;<span class="ident" id="3127169">itemField</span>&nbsp;<span class="op" id="3127179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127184">chain</span><span class="op" id="3127189">.</span><span class="ident" id="3127190">Add</span><span class="op" id="3127193">(</span><span class="ident" id="3127194">t</span><span class="op" id="3127195">.</span><span class="ident" id="3127196">next</span><span class="op" id="3127200">(</span><span class="op" id="3127201">)</span><span class="op" id="3127202">.</span><span class="ident" id="3127203">val</span><span class="op" id="3127206">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127214">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127285">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127345">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127382">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127430">switch</span>&nbsp;<span class="ident" id="3127437">node</span><span class="op" id="3127441">.</span><span class="ident" id="3127442">Type</span><span class="op" id="3127446">(</span><span class="op" id="3127447">)</span>&nbsp;<span class="op" id="3127449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127453">case</span>&nbsp;<span class="ident" id="3127458">NodeField</span><span class="op" id="3127467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127472">node</span>&nbsp;<span class="op" id="3127477">=</span>&nbsp;<span class="ident" id="3127479">t</span><span class="op" id="3127480">.</span><span class="ident" id="3127481">newField</span><span class="op" id="3127489">(</span><span class="ident" id="3127490">chain</span><span class="op" id="3127495">.</span><span class="ident" id="3127496">Position</span><span class="op" id="3127504">(</span><span class="op" id="3127505">)</span><span class="op" id="3127506">,</span>&nbsp;<span class="ident" id="3127508">chain</span><span class="op" id="3127513">.</span><span class="ident" id="3127514">String</span><span class="op" id="3127520">(</span><span class="op" id="3127521">)</span><span class="op" id="3127522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127526">case</span>&nbsp;<span class="ident" id="3127531">NodeVariable</span><span class="op" id="3127543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127548">node</span>&nbsp;<span class="op" id="3127553">=</span>&nbsp;<span class="ident" id="3127555">t</span><span class="op" id="3127556">.</span><span class="ident" id="3127557">newVariable</span><span class="op" id="3127568">(</span><span class="ident" id="3127569">chain</span><span class="op" id="3127574">.</span><span class="ident" id="3127575">Position</span><span class="op" id="3127583">(</span><span class="op" id="3127584">)</span><span class="op" id="3127585">,</span>&nbsp;<span class="ident" id="3127587">chain</span><span class="op" id="3127592">.</span><span class="ident" id="3127593">String</span><span class="op" id="3127599">(</span><span class="op" id="3127600">)</span><span class="op" id="3127601">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127605">default</span><span class="op" id="3127612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127617">node</span>&nbsp;<span class="op" id="3127622">=</span>&nbsp;<span class="ident" id="3127624">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127638">return</span>&nbsp;<span class="ident" id="3127645">node</span><br>
<span class="lineno">595</span><span class="op" id="3127650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3127653">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="3127662">//&nbsp;&nbsp;&nbsp;&nbsp;literal&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="3127704">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="3127729">//&nbsp;&nbsp;&nbsp;&nbsp;.</span><br>
<span class="lineno"></span><span class="comment" id="3127734">//&nbsp;&nbsp;&nbsp;&nbsp;.Field</span><br>
<span class="lineno"></span><span class="comment" id="3127744">//&nbsp;&nbsp;&nbsp;&nbsp;$</span><br>
<span class="lineno"></span><span class="comment" id="3127749">//&nbsp;&nbsp;&nbsp;&nbsp;&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="3127769">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="3127805">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="3127856">func</span>&nbsp;<span class="op" id="3127861">(</span><span class="ident" id="3127862">t</span>&nbsp;<span class="op" id="3127864">*</span><span class="ident" id="3127865">Tree</span><span class="op" id="3127869">)</span>&nbsp;<span class="ident" id="3127871">term</span><span class="op" id="3127875">(</span><span class="op" id="3127876">)</span>&nbsp;<span class="ident" id="3127878">Node</span>&nbsp;<span class="op" id="3127883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127886">switch</span>&nbsp;<span class="ident" id="3127893">token</span>&nbsp;<span class="op" id="3127899">:=</span>&nbsp;<span class="ident" id="3127902">t</span><span class="op" id="3127903">.</span><span class="ident" id="3127904">nextNonSpace</span><span class="op" id="3127916">(</span><span class="op" id="3127917">)</span><span class="op" id="3127918">;</span>&nbsp;<span class="ident" id="3127920">token</span><span class="op" id="3127925">.</span><span class="ident" id="3127926">typ</span>&nbsp;<span class="op" id="3127930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127933">case</span>&nbsp;<span class="ident" id="3127938">itemError</span><span class="op" id="3127947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127951">t</span><span class="op" id="3127952">.</span><span class="ident" id="3127953">errorf</span><span class="op" id="3127959">(</span><span class="string" id="3127960">&#34;%s&#34;</span><span class="op" id="3127964">,</span>&nbsp;<span class="ident" id="3127966">token</span><span class="op" id="3127971">.</span><span class="ident" id="3127972">val</span><span class="op" id="3127975">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127978">case</span>&nbsp;<span class="ident" id="3127983">itemIdentifier</span><span class="op" id="3127997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128001">if</span>&nbsp;<span class="op" id="3128004">!</span><span class="ident" id="3128005">t</span><span class="op" id="3128006">.</span><span class="ident" id="3128007">hasFunction</span><span class="op" id="3128018">(</span><span class="ident" id="3128019">token</span><span class="op" id="3128024">.</span><span class="ident" id="3128025">val</span><span class="op" id="3128028">)</span>&nbsp;<span class="op" id="3128030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128035">t</span><span class="op" id="3128036">.</span><span class="ident" id="3128037">errorf</span><span class="op" id="3128043">(</span><span class="string" id="3128044">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="3128069">,</span>&nbsp;<span class="ident" id="3128071">token</span><span class="op" id="3128076">.</span><span class="ident" id="3128077">val</span><span class="op" id="3128080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128088">return</span>&nbsp;<span class="ident" id="3128095">NewIdentifier</span><span class="op" id="3128108">(</span><span class="ident" id="3128109">token</span><span class="op" id="3128114">.</span><span class="ident" id="3128115">val</span><span class="op" id="3128118">)</span><span class="op" id="3128119">.</span><span class="ident" id="3128120">SetTree</span><span class="op" id="3128127">(</span><span class="ident" id="3128128">t</span><span class="op" id="3128129">)</span><span class="op" id="3128130">.</span><span class="ident" id="3128131">SetPos</span><span class="op" id="3128137">(</span><span class="ident" id="3128138">token</span><span class="op" id="3128143">.</span><span class="ident" id="3128144">pos</span><span class="op" id="3128147">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128150">case</span>&nbsp;<span class="ident" id="3128155">itemDot</span><span class="op" id="3128162">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128166">return</span>&nbsp;<span class="ident" id="3128173">t</span><span class="op" id="3128174">.</span><span class="ident" id="3128175">newDot</span><span class="op" id="3128181">(</span><span class="ident" id="3128182">token</span><span class="op" id="3128187">.</span><span class="ident" id="3128188">pos</span><span class="op" id="3128191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128194">case</span>&nbsp;<span class="ident" id="3128199">itemNil</span><span class="op" id="3128206">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128210">return</span>&nbsp;<span class="ident" id="3128217">t</span><span class="op" id="3128218">.</span><span class="ident" id="3128219">newNil</span><span class="op" id="3128225">(</span><span class="ident" id="3128226">token</span><span class="op" id="3128231">.</span><span class="ident" id="3128232">pos</span><span class="op" id="3128235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128238">case</span>&nbsp;<span class="ident" id="3128243">itemVariable</span><span class="op" id="3128255">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128259">return</span>&nbsp;<span class="ident" id="3128266">t</span><span class="op" id="3128267">.</span><span class="ident" id="3128268">useVar</span><span class="op" id="3128274">(</span><span class="ident" id="3128275">token</span><span class="op" id="3128280">.</span><span class="ident" id="3128281">pos</span><span class="op" id="3128284">,</span>&nbsp;<span class="ident" id="3128286">token</span><span class="op" id="3128291">.</span><span class="ident" id="3128292">val</span><span class="op" id="3128295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128298">case</span>&nbsp;<span class="ident" id="3128303">itemField</span><span class="op" id="3128312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128316">return</span>&nbsp;<span class="ident" id="3128323">t</span><span class="op" id="3128324">.</span><span class="ident" id="3128325">newField</span><span class="op" id="3128333">(</span><span class="ident" id="3128334">token</span><span class="op" id="3128339">.</span><span class="ident" id="3128340">pos</span><span class="op" id="3128343">,</span>&nbsp;<span class="ident" id="3128345">token</span><span class="op" id="3128350">.</span><span class="ident" id="3128351">val</span><span class="op" id="3128354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128357">case</span>&nbsp;<span class="ident" id="3128362">itemBool</span><span class="op" id="3128370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128374">return</span>&nbsp;<span class="ident" id="3128381">t</span><span class="op" id="3128382">.</span><span class="ident" id="3128383">newBool</span><span class="op" id="3128390">(</span><span class="ident" id="3128391">token</span><span class="op" id="3128396">.</span><span class="ident" id="3128397">pos</span><span class="op" id="3128400">,</span>&nbsp;<span class="ident" id="3128402">token</span><span class="op" id="3128407">.</span><span class="ident" id="3128408">val</span>&nbsp;<span class="op" id="3128412">==</span>&nbsp;<span class="string" id="3128415">&#34;true&#34;</span><span class="op" id="3128421">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128424">case</span>&nbsp;<span class="ident" id="3128429">itemCharConstant</span><span class="op" id="3128445">,</span>&nbsp;<span class="ident" id="3128447">itemComplex</span><span class="op" id="3128458">,</span>&nbsp;<span class="ident" id="3128460">itemNumber</span><span class="op" id="3128470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128474">number</span><span class="op" id="3128480">,</span>&nbsp;<span class="ident" id="3128482">err</span>&nbsp;<span class="op" id="3128486">:=</span>&nbsp;<span class="ident" id="3128489">t</span><span class="op" id="3128490">.</span><span class="ident" id="3128491">newNumber</span><span class="op" id="3128500">(</span><span class="ident" id="3128501">token</span><span class="op" id="3128506">.</span><span class="ident" id="3128507">pos</span><span class="op" id="3128510">,</span>&nbsp;<span class="ident" id="3128512">token</span><span class="op" id="3128517">.</span><span class="ident" id="3128518">val</span><span class="op" id="3128521">,</span>&nbsp;<span class="ident" id="3128523">token</span><span class="op" id="3128528">.</span><span class="ident" id="3128529">typ</span><span class="op" id="3128532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128536">if</span>&nbsp;<span class="ident" id="3128539">err</span>&nbsp;<span class="op" id="3128543">!=</span>&nbsp;<span class="builtintype" id="3128546">nil</span>&nbsp;<span class="op" id="3128550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128555">t</span><span class="op" id="3128556">.</span><span class="builtintype" id="3128557">error</span><span class="op" id="3128562">(</span><span class="ident" id="3128563">err</span><span class="op" id="3128566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128570">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128574">return</span>&nbsp;<span class="ident" id="3128581">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128589">case</span>&nbsp;<span class="ident" id="3128594">itemLeftParen</span><span class="op" id="3128607">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128611">pipe</span>&nbsp;<span class="op" id="3128616">:=</span>&nbsp;<span class="ident" id="3128619">t</span><span class="op" id="3128620">.</span><span class="ident" id="3128621">pipeline</span><span class="op" id="3128629">(</span><span class="string" id="3128630">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="3128654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128658">if</span>&nbsp;<span class="ident" id="3128661">token</span>&nbsp;<span class="op" id="3128667">:=</span>&nbsp;<span class="ident" id="3128670">t</span><span class="op" id="3128671">.</span><span class="ident" id="3128672">next</span><span class="op" id="3128676">(</span><span class="op" id="3128677">)</span><span class="op" id="3128678">;</span>&nbsp;<span class="ident" id="3128680">token</span><span class="op" id="3128685">.</span><span class="ident" id="3128686">typ</span>&nbsp;<span class="op" id="3128690">!=</span>&nbsp;<span class="ident" id="3128693">itemRightParen</span>&nbsp;<span class="op" id="3128708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128713">t</span><span class="op" id="3128714">.</span><span class="ident" id="3128715">errorf</span><span class="op" id="3128721">(</span><span class="string" id="3128722">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="3128759">,</span>&nbsp;<span class="ident" id="3128761">token</span><span class="op" id="3128766">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128774">return</span>&nbsp;<span class="ident" id="3128781">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128787">case</span>&nbsp;<span class="ident" id="3128792">itemString</span><span class="op" id="3128802">,</span>&nbsp;<span class="ident" id="3128804">itemRawString</span><span class="op" id="3128817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128821">s</span><span class="op" id="3128822">,</span>&nbsp;<span class="ident" id="3128824">err</span>&nbsp;<span class="op" id="3128828">:=</span>&nbsp;<span class="ident" id="3128831">strconv</span><span class="op" id="3128838">.</span><span class="ident" id="3128839">Unquote</span><span class="op" id="3128846">(</span><span class="ident" id="3128847">token</span><span class="op" id="3128852">.</span><span class="ident" id="3128853">val</span><span class="op" id="3128856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128860">if</span>&nbsp;<span class="ident" id="3128863">err</span>&nbsp;<span class="op" id="3128867">!=</span>&nbsp;<span class="builtintype" id="3128870">nil</span>&nbsp;<span class="op" id="3128874">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128879">t</span><span class="op" id="3128880">.</span><span class="builtintype" id="3128881">error</span><span class="op" id="3128886">(</span><span class="ident" id="3128887">err</span><span class="op" id="3128890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128898">return</span>&nbsp;<span class="ident" id="3128905">t</span><span class="op" id="3128906">.</span><span class="ident" id="3128907">newString</span><span class="op" id="3128916">(</span><span class="ident" id="3128917">token</span><span class="op" id="3128922">.</span><span class="ident" id="3128923">pos</span><span class="op" id="3128926">,</span>&nbsp;<span class="ident" id="3128928">token</span><span class="op" id="3128933">.</span><span class="ident" id="3128934">val</span><span class="op" id="3128937">,</span>&nbsp;<span class="ident" id="3128939">s</span><span class="op" id="3128940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128946">t</span><span class="op" id="3128947">.</span><span class="ident" id="3128948">backup</span><span class="op" id="3128954">(</span><span class="op" id="3128955">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128958">return</span>&nbsp;<span class="builtintype" id="3128965">nil</span><br>
<span class="lineno"></span><span class="op" id="3128969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3128972">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="3129041">func</span>&nbsp;<span class="op" id="3129046">(</span><span class="ident" id="3129047">t</span>&nbsp;<span class="op" id="3129049">*</span><span class="ident" id="3129050">Tree</span><span class="op" id="3129054">)</span>&nbsp;<span class="ident" id="3129056">hasFunction</span><span class="op" id="3129067">(</span><span class="ident" id="3129068">name</span>&nbsp;<span class="builtintype" id="3129073">string</span><span class="op" id="3129079">)</span>&nbsp;<span class="builtintype" id="3129081">bool</span>&nbsp;<span class="op" id="3129086">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129089">for</span>&nbsp;<span class="ident" id="3129093">_</span><span class="op" id="3129094">,</span>&nbsp;<span class="ident" id="3129096">funcMap</span>&nbsp;<span class="op" id="3129104">:=</span>&nbsp;<span class="keyword" id="3129107">range</span>&nbsp;<span class="ident" id="3129113">t</span><span class="op" id="3129114">.</span><span class="ident" id="3129115">funcs</span>&nbsp;<span class="op" id="3129121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129125">if</span>&nbsp;<span class="ident" id="3129128">funcMap</span>&nbsp;<span class="op" id="3129136">==</span>&nbsp;<span class="builtintype" id="3129139">nil</span>&nbsp;<span class="op" id="3129143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129148">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129163">if</span>&nbsp;<span class="ident" id="3129166">funcMap</span><span class="op" id="3129173">[</span><span class="ident" id="3129174">name</span><span class="op" id="3129178">]</span>&nbsp;<span class="op" id="3129180">!=</span>&nbsp;<span class="builtintype" id="3129183">nil</span>&nbsp;<span class="op" id="3129187">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129192">return</span>&nbsp;<span class="builtintype" id="3129199">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129212">return</span>&nbsp;<span class="builtintype" id="3129219">false</span><br>
<span class="lineno"></span><span class="op" id="3129225">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="3129228">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="3129287">func</span>&nbsp;<span class="op" id="3129292">(</span><span class="ident" id="3129293">t</span>&nbsp;<span class="op" id="3129295">*</span><span class="ident" id="3129296">Tree</span><span class="op" id="3129300">)</span>&nbsp;<span class="ident" id="3129302">popVars</span><span class="op" id="3129309">(</span><span class="ident" id="3129310">n</span>&nbsp;<span class="builtintype" id="3129312">int</span><span class="op" id="3129315">)</span>&nbsp;<span class="op" id="3129317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129320">t</span><span class="op" id="3129321">.</span><span class="ident" id="3129322">vars</span>&nbsp;<span class="op" id="3129327">=</span>&nbsp;<span class="ident" id="3129329">t</span><span class="op" id="3129330">.</span><span class="ident" id="3129331">vars</span><span class="op" id="3129335">[</span><span class="op" id="3129336">:</span><span class="ident" id="3129337">n</span><span class="op" id="3129338">]</span><br>
<span class="lineno"></span><span class="op" id="3129340">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3129343">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3129411">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3129439">func</span>&nbsp;<span class="op" id="3129444">(</span><span class="ident" id="3129445">t</span>&nbsp;<span class="op" id="3129447">*</span><span class="ident" id="3129448">Tree</span><span class="op" id="3129452">)</span>&nbsp;<span class="ident" id="3129454">useVar</span><span class="op" id="3129460">(</span><span class="ident" id="3129461">pos</span>&nbsp;<span class="ident" id="3129465">Pos</span><span class="op" id="3129468">,</span>&nbsp;<span class="ident" id="3129470">name</span>&nbsp;<span class="builtintype" id="3129475">string</span><span class="op" id="3129481">)</span>&nbsp;<span class="ident" id="3129483">Node</span>&nbsp;<span class="op" id="3129488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129491">v</span>&nbsp;<span class="op" id="3129493">:=</span>&nbsp;<span class="ident" id="3129496">t</span><span class="op" id="3129497">.</span><span class="ident" id="3129498">newVariable</span><span class="op" id="3129509">(</span><span class="ident" id="3129510">pos</span><span class="op" id="3129513">,</span>&nbsp;<span class="ident" id="3129515">name</span><span class="op" id="3129519">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129522">for</span>&nbsp;<span class="ident" id="3129526">_</span><span class="op" id="3129527">,</span>&nbsp;<span class="ident" id="3129529">varName</span>&nbsp;<span class="op" id="3129537">:=</span>&nbsp;<span class="keyword" id="3129540">range</span>&nbsp;<span class="ident" id="3129546">t</span><span class="op" id="3129547">.</span><span class="ident" id="3129548">vars</span>&nbsp;<span class="op" id="3129553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129557">if</span>&nbsp;<span class="ident" id="3129560">varName</span>&nbsp;<span class="op" id="3129568">==</span>&nbsp;<span class="ident" id="3129571">v</span><span class="op" id="3129572">.</span><span class="ident" id="3129573">Ident</span><span class="op" id="3129578">[</span><span class="num" id="3129579">0</span><span class="op" id="3129580">]</span>&nbsp;<span class="op" id="3129582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129587">return</span>&nbsp;<span class="ident" id="3129594">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129601">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129604">t</span><span class="op" id="3129605">.</span><span class="ident" id="3129606">errorf</span><span class="op" id="3129612">(</span><span class="string" id="3129613">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="3129636">,</span>&nbsp;<span class="ident" id="3129638">v</span><span class="op" id="3129639">.</span><span class="ident" id="3129640">Ident</span><span class="op" id="3129645">[</span><span class="num" id="3129646">0</span><span class="op" id="3129647">]</span><span class="op" id="3129648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129651">return</span>&nbsp;<span class="builtintype" id="3129658">nil</span><br>
<span class="lineno"></span><span class="op" id="3129662">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
