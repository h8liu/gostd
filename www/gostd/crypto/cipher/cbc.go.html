<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html" class="current">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3575712">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3575767">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3575821">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3575872">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3575910">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3575984">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3576057">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576091">package</span>&nbsp;<span class="ident" id="3576099">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576107">type</span>&nbsp;<span class="ident" id="3576112">cbc</span>&nbsp;<span class="keyword" id="3576116">struct</span>&nbsp;<span class="op" id="3576123">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576126">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576136">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576143">blockSize</span>&nbsp;<span class="builtintype" id="3576153">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576158">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576168">[</span><span class="op" id="3576169">]</span><span class="builtintype" id="3576170">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576176">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576186">[</span><span class="op" id="3576187">]</span><span class="builtintype" id="3576188">byte</span><br>
<span class="lineno"></span><span class="op" id="3576193">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3576196">func</span>&nbsp;<span class="ident" id="3576201">newCBC</span><span class="op" id="3576207">(</span><span class="ident" id="3576208">b</span>&nbsp;<span class="ident" id="3576210">Block</span><span class="op" id="3576215">,</span>&nbsp;<span class="ident" id="3576217">iv</span>&nbsp;<span class="op" id="3576220">[</span><span class="op" id="3576221">]</span><span class="builtintype" id="3576222">byte</span><span class="op" id="3576226">)</span>&nbsp;<span class="op" id="3576228">*</span><span class="ident" id="3576229">cbc</span>&nbsp;<span class="op" id="3576233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576236">return</span>&nbsp;<span class="op" id="3576243">&amp;</span><span class="ident" id="3576244">cbc</span><span class="op" id="3576247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576251">b</span><span class="op" id="3576252">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576262">b</span><span class="op" id="3576263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576267">blockSize</span><span class="op" id="3576276">:</span>&nbsp;<span class="ident" id="3576278">b</span><span class="op" id="3576279">.</span><span class="ident" id="3576280">BlockSize</span><span class="op" id="3576289">(</span><span class="op" id="3576290">)</span><span class="op" id="3576291">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576295">iv</span><span class="op" id="3576297">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576306">dup</span><span class="op" id="3576309">(</span><span class="ident" id="3576310">iv</span><span class="op" id="3576312">)</span><span class="op" id="3576313">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576317">tmp</span><span class="op" id="3576320">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3576328">make</span><span class="op" id="3576332">(</span><span class="op" id="3576333">[</span><span class="op" id="3576334">]</span><span class="builtintype" id="3576335">byte</span><span class="op" id="3576339">,</span>&nbsp;<span class="ident" id="3576341">b</span><span class="op" id="3576342">.</span><span class="ident" id="3576343">BlockSize</span><span class="op" id="3576352">(</span><span class="op" id="3576353">)</span><span class="op" id="3576354">)</span><span class="op" id="3576355">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576358">}</span><br>
<span class="lineno"></span><span class="op" id="3576360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3576363">type</span>&nbsp;<span class="ident" id="3576368">cbcEncrypter</span>&nbsp;<span class="ident" id="3576381">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3576386">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3576465">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3576538">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3576561">func</span>&nbsp;<span class="ident" id="3576566">NewCBCEncrypter</span><span class="op" id="3576581">(</span><span class="ident" id="3576582">b</span>&nbsp;<span class="ident" id="3576584">Block</span><span class="op" id="3576589">,</span>&nbsp;<span class="ident" id="3576591">iv</span>&nbsp;<span class="op" id="3576594">[</span><span class="op" id="3576595">]</span><span class="builtintype" id="3576596">byte</span><span class="op" id="3576600">)</span>&nbsp;<span class="ident" id="3576602">BlockMode</span>&nbsp;<span class="op" id="3576612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576615">if</span>&nbsp;<span class="builtinfunc" id="3576618">len</span><span class="op" id="3576621">(</span><span class="ident" id="3576622">iv</span><span class="op" id="3576624">)</span>&nbsp;<span class="op" id="3576626">!=</span>&nbsp;<span class="ident" id="3576629">b</span><span class="op" id="3576630">.</span><span class="ident" id="3576631">BlockSize</span><span class="op" id="3576640">(</span><span class="op" id="3576641">)</span>&nbsp;<span class="op" id="3576643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3576647">panic</span><span class="op" id="3576652">(</span><span class="string" id="3576653">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3576710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576716">return</span>&nbsp;<span class="op" id="3576723">(</span><span class="op" id="3576724">*</span><span class="ident" id="3576725">cbcEncrypter</span><span class="op" id="3576737">)</span><span class="op" id="3576738">(</span><span class="ident" id="3576739">newCBC</span><span class="op" id="3576745">(</span><span class="ident" id="3576746">b</span><span class="op" id="3576747">,</span>&nbsp;<span class="ident" id="3576749">iv</span><span class="op" id="3576751">)</span><span class="op" id="3576752">)</span><br>
<span class="lineno">40</span><span class="op" id="3576754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576757">func</span>&nbsp;<span class="op" id="3576762">(</span><span class="ident" id="3576763">x</span>&nbsp;<span class="op" id="3576765">*</span><span class="ident" id="3576766">cbcEncrypter</span><span class="op" id="3576778">)</span>&nbsp;<span class="ident" id="3576780">BlockSize</span><span class="op" id="3576789">(</span><span class="op" id="3576790">)</span>&nbsp;<span class="builtintype" id="3576792">int</span>&nbsp;<span class="op" id="3576796">{</span>&nbsp;<span class="keyword" id="3576798">return</span>&nbsp;<span class="ident" id="3576805">x</span><span class="op" id="3576806">.</span><span class="ident" id="3576807">blockSize</span>&nbsp;<span class="op" id="3576817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576820">func</span>&nbsp;<span class="op" id="3576825">(</span><span class="ident" id="3576826">x</span>&nbsp;<span class="op" id="3576828">*</span><span class="ident" id="3576829">cbcEncrypter</span><span class="op" id="3576841">)</span>&nbsp;<span class="ident" id="3576843">CryptBlocks</span><span class="op" id="3576854">(</span><span class="ident" id="3576855">dst</span><span class="op" id="3576858">,</span>&nbsp;<span class="ident" id="3576860">src</span>&nbsp;<span class="op" id="3576864">[</span><span class="op" id="3576865">]</span><span class="builtintype" id="3576866">byte</span><span class="op" id="3576870">)</span>&nbsp;<span class="op" id="3576872">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576875">if</span>&nbsp;<span class="builtinfunc" id="3576878">len</span><span class="op" id="3576881">(</span><span class="ident" id="3576882">src</span><span class="op" id="3576885">)</span><span class="op" id="3576886">%</span><span class="ident" id="3576887">x</span><span class="op" id="3576888">.</span><span class="ident" id="3576889">blockSize</span>&nbsp;<span class="op" id="3576899">!=</span>&nbsp;<span class="num" id="3576902">0</span>&nbsp;<span class="op" id="3576904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3576908">panic</span><span class="op" id="3576913">(</span><span class="string" id="3576914">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3576952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3576958">if</span>&nbsp;<span class="builtinfunc" id="3576961">len</span><span class="op" id="3576964">(</span><span class="ident" id="3576965">dst</span><span class="op" id="3576968">)</span>&nbsp;<span class="op" id="3576970">&lt;</span>&nbsp;<span class="builtinfunc" id="3576972">len</span><span class="op" id="3576975">(</span><span class="ident" id="3576976">src</span><span class="op" id="3576979">)</span>&nbsp;<span class="op" id="3576981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3576985">panic</span><span class="op" id="3576990">(</span><span class="string" id="3576991">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3577033">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3577036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577040">iv</span>&nbsp;<span class="op" id="3577043">:=</span>&nbsp;<span class="ident" id="3577046">x</span><span class="op" id="3577047">.</span><span class="ident" id="3577048">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577053">for</span>&nbsp;<span class="builtinfunc" id="3577057">len</span><span class="op" id="3577060">(</span><span class="ident" id="3577061">src</span><span class="op" id="3577064">)</span>&nbsp;<span class="op" id="3577066">&gt;</span>&nbsp;<span class="num" id="3577068">0</span>&nbsp;<span class="op" id="3577070">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3577074">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577124">xorBytes</span><span class="op" id="3577132">(</span><span class="ident" id="3577133">dst</span><span class="op" id="3577136">[</span><span class="op" id="3577137">:</span><span class="ident" id="3577138">x</span><span class="op" id="3577139">.</span><span class="ident" id="3577140">blockSize</span><span class="op" id="3577149">]</span><span class="op" id="3577150">,</span>&nbsp;<span class="ident" id="3577152">src</span><span class="op" id="3577155">[</span><span class="op" id="3577156">:</span><span class="ident" id="3577157">x</span><span class="op" id="3577158">.</span><span class="ident" id="3577159">blockSize</span><span class="op" id="3577168">]</span><span class="op" id="3577169">,</span>&nbsp;<span class="ident" id="3577171">iv</span><span class="op" id="3577173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577177">x</span><span class="op" id="3577178">.</span><span class="ident" id="3577179">b</span><span class="op" id="3577180">.</span><span class="ident" id="3577181">Encrypt</span><span class="op" id="3577188">(</span><span class="ident" id="3577189">dst</span><span class="op" id="3577192">[</span><span class="op" id="3577193">:</span><span class="ident" id="3577194">x</span><span class="op" id="3577195">.</span><span class="ident" id="3577196">blockSize</span><span class="op" id="3577205">]</span><span class="op" id="3577206">,</span>&nbsp;<span class="ident" id="3577208">dst</span><span class="op" id="3577211">[</span><span class="op" id="3577212">:</span><span class="ident" id="3577213">x</span><span class="op" id="3577214">.</span><span class="ident" id="3577215">blockSize</span><span class="op" id="3577224">]</span><span class="op" id="3577225">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3577230">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577290">iv</span>&nbsp;<span class="op" id="3577293">=</span>&nbsp;<span class="ident" id="3577295">dst</span><span class="op" id="3577298">[</span><span class="op" id="3577299">:</span><span class="ident" id="3577300">x</span><span class="op" id="3577301">.</span><span class="ident" id="3577302">blockSize</span><span class="op" id="3577311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577315">src</span>&nbsp;<span class="op" id="3577319">=</span>&nbsp;<span class="ident" id="3577321">src</span><span class="op" id="3577324">[</span><span class="ident" id="3577325">x</span><span class="op" id="3577326">.</span><span class="ident" id="3577327">blockSize</span><span class="op" id="3577336">:</span><span class="op" id="3577337">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3577341">dst</span>&nbsp;<span class="op" id="3577345">=</span>&nbsp;<span class="ident" id="3577347">dst</span><span class="op" id="3577350">[</span><span class="ident" id="3577351">x</span><span class="op" id="3577352">.</span><span class="ident" id="3577353">blockSize</span><span class="op" id="3577362">:</span><span class="op" id="3577363">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3577366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3577370">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3577417">copy</span><span class="op" id="3577421">(</span><span class="ident" id="3577422">x</span><span class="op" id="3577423">.</span><span class="ident" id="3577424">iv</span><span class="op" id="3577426">,</span>&nbsp;<span class="ident" id="3577428">iv</span><span class="op" id="3577430">)</span><br>
<span class="lineno"></span><span class="op" id="3577432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3577435">func</span>&nbsp;<span class="op" id="3577440">(</span><span class="ident" id="3577441">x</span>&nbsp;<span class="op" id="3577443">*</span><span class="ident" id="3577444">cbcEncrypter</span><span class="op" id="3577456">)</span>&nbsp;<span class="ident" id="3577458">SetIV</span><span class="op" id="3577463">(</span><span class="ident" id="3577464">iv</span>&nbsp;<span class="op" id="3577467">[</span><span class="op" id="3577468">]</span><span class="builtintype" id="3577469">byte</span><span class="op" id="3577473">)</span>&nbsp;<span class="op" id="3577475">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577478">if</span>&nbsp;<span class="builtinfunc" id="3577481">len</span><span class="op" id="3577484">(</span><span class="ident" id="3577485">iv</span><span class="op" id="3577487">)</span>&nbsp;<span class="op" id="3577489">!=</span>&nbsp;<span class="builtinfunc" id="3577492">len</span><span class="op" id="3577495">(</span><span class="ident" id="3577496">x</span><span class="op" id="3577497">.</span><span class="ident" id="3577498">iv</span><span class="op" id="3577500">)</span>&nbsp;<span class="op" id="3577502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3577506">panic</span><span class="op" id="3577511">(</span><span class="string" id="3577512">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3577541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3577544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3577547">copy</span><span class="op" id="3577551">(</span><span class="ident" id="3577552">x</span><span class="op" id="3577553">.</span><span class="ident" id="3577554">iv</span><span class="op" id="3577556">,</span>&nbsp;<span class="ident" id="3577558">iv</span><span class="op" id="3577560">)</span><br>
<span class="lineno"></span><span class="op" id="3577562">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3577565">type</span>&nbsp;<span class="ident" id="3577570">cbcDecrypter</span>&nbsp;<span class="ident" id="3577583">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3577588">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3577667">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3577740">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3577810">func</span>&nbsp;<span class="ident" id="3577815">NewCBCDecrypter</span><span class="op" id="3577830">(</span><span class="ident" id="3577831">b</span>&nbsp;<span class="ident" id="3577833">Block</span><span class="op" id="3577838">,</span>&nbsp;<span class="ident" id="3577840">iv</span>&nbsp;<span class="op" id="3577843">[</span><span class="op" id="3577844">]</span><span class="builtintype" id="3577845">byte</span><span class="op" id="3577849">)</span>&nbsp;<span class="ident" id="3577851">BlockMode</span>&nbsp;<span class="op" id="3577861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577864">if</span>&nbsp;<span class="builtinfunc" id="3577867">len</span><span class="op" id="3577870">(</span><span class="ident" id="3577871">iv</span><span class="op" id="3577873">)</span>&nbsp;<span class="op" id="3577875">!=</span>&nbsp;<span class="ident" id="3577878">b</span><span class="op" id="3577879">.</span><span class="ident" id="3577880">BlockSize</span><span class="op" id="3577889">(</span><span class="op" id="3577890">)</span>&nbsp;<span class="op" id="3577892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3577896">panic</span><span class="op" id="3577901">(</span><span class="string" id="3577902">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3577959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3577962">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3577965">return</span>&nbsp;<span class="op" id="3577972">(</span><span class="op" id="3577973">*</span><span class="ident" id="3577974">cbcDecrypter</span><span class="op" id="3577986">)</span><span class="op" id="3577987">(</span><span class="ident" id="3577988">newCBC</span><span class="op" id="3577994">(</span><span class="ident" id="3577995">b</span><span class="op" id="3577996">,</span>&nbsp;<span class="ident" id="3577998">iv</span><span class="op" id="3578000">)</span><span class="op" id="3578001">)</span><br>
<span class="lineno"></span><span class="op" id="3578003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3578006">func</span>&nbsp;<span class="op" id="3578011">(</span><span class="ident" id="3578012">x</span>&nbsp;<span class="op" id="3578014">*</span><span class="ident" id="3578015">cbcDecrypter</span><span class="op" id="3578027">)</span>&nbsp;<span class="ident" id="3578029">BlockSize</span><span class="op" id="3578038">(</span><span class="op" id="3578039">)</span>&nbsp;<span class="builtintype" id="3578041">int</span>&nbsp;<span class="op" id="3578045">{</span>&nbsp;<span class="keyword" id="3578047">return</span>&nbsp;<span class="ident" id="3578054">x</span><span class="op" id="3578055">.</span><span class="ident" id="3578056">blockSize</span>&nbsp;<span class="op" id="3578066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3578069">func</span>&nbsp;<span class="op" id="3578074">(</span><span class="ident" id="3578075">x</span>&nbsp;<span class="op" id="3578077">*</span><span class="ident" id="3578078">cbcDecrypter</span><span class="op" id="3578090">)</span>&nbsp;<span class="ident" id="3578092">CryptBlocks</span><span class="op" id="3578103">(</span><span class="ident" id="3578104">dst</span><span class="op" id="3578107">,</span>&nbsp;<span class="ident" id="3578109">src</span>&nbsp;<span class="op" id="3578113">[</span><span class="op" id="3578114">]</span><span class="builtintype" id="3578115">byte</span><span class="op" id="3578119">)</span>&nbsp;<span class="op" id="3578121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578124">if</span>&nbsp;<span class="builtinfunc" id="3578127">len</span><span class="op" id="3578130">(</span><span class="ident" id="3578131">src</span><span class="op" id="3578134">)</span><span class="op" id="3578135">%</span><span class="ident" id="3578136">x</span><span class="op" id="3578137">.</span><span class="ident" id="3578138">blockSize</span>&nbsp;<span class="op" id="3578148">!=</span>&nbsp;<span class="num" id="3578151">0</span>&nbsp;<span class="op" id="3578153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3578157">panic</span><span class="op" id="3578162">(</span><span class="string" id="3578163">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3578201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578207">if</span>&nbsp;<span class="builtinfunc" id="3578210">len</span><span class="op" id="3578213">(</span><span class="ident" id="3578214">dst</span><span class="op" id="3578217">)</span>&nbsp;<span class="op" id="3578219">&lt;</span>&nbsp;<span class="builtinfunc" id="3578221">len</span><span class="op" id="3578224">(</span><span class="ident" id="3578225">src</span><span class="op" id="3578228">)</span>&nbsp;<span class="op" id="3578230">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3578234">panic</span><span class="op" id="3578239">(</span><span class="string" id="3578240">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3578282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578288">if</span>&nbsp;<span class="builtinfunc" id="3578291">len</span><span class="op" id="3578294">(</span><span class="ident" id="3578295">src</span><span class="op" id="3578298">)</span>&nbsp;<span class="op" id="3578300">==</span>&nbsp;<span class="num" id="3578303">0</span>&nbsp;<span class="op" id="3578305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578309">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578317">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578321">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578422">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578495">end</span>&nbsp;<span class="op" id="3578499">:=</span>&nbsp;<span class="builtinfunc" id="3578502">len</span><span class="op" id="3578505">(</span><span class="ident" id="3578506">src</span><span class="op" id="3578509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578512">start</span>&nbsp;<span class="op" id="3578518">:=</span>&nbsp;<span class="ident" id="3578521">end</span>&nbsp;<span class="op" id="3578525">-</span>&nbsp;<span class="ident" id="3578527">x</span><span class="op" id="3578528">.</span><span class="ident" id="3578529">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578540">prev</span>&nbsp;<span class="op" id="3578545">:=</span>&nbsp;<span class="ident" id="3578548">start</span>&nbsp;<span class="op" id="3578554">-</span>&nbsp;<span class="ident" id="3578556">x</span><span class="op" id="3578557">.</span><span class="ident" id="3578558">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578570">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3578638">copy</span><span class="op" id="3578642">(</span><span class="ident" id="3578643">x</span><span class="op" id="3578644">.</span><span class="ident" id="3578645">tmp</span><span class="op" id="3578648">,</span>&nbsp;<span class="ident" id="3578650">src</span><span class="op" id="3578653">[</span><span class="ident" id="3578654">start</span><span class="op" id="3578659">:</span><span class="ident" id="3578660">end</span><span class="op" id="3578663">]</span><span class="op" id="3578664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578668">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3578707">for</span>&nbsp;<span class="ident" id="3578711">start</span>&nbsp;<span class="op" id="3578717">&gt;</span>&nbsp;<span class="num" id="3578719">0</span>&nbsp;<span class="op" id="3578721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578725">x</span><span class="op" id="3578726">.</span><span class="ident" id="3578727">b</span><span class="op" id="3578728">.</span><span class="ident" id="3578729">Decrypt</span><span class="op" id="3578736">(</span><span class="ident" id="3578737">dst</span><span class="op" id="3578740">[</span><span class="ident" id="3578741">start</span><span class="op" id="3578746">:</span><span class="ident" id="3578747">end</span><span class="op" id="3578750">]</span><span class="op" id="3578751">,</span>&nbsp;<span class="ident" id="3578753">src</span><span class="op" id="3578756">[</span><span class="ident" id="3578757">start</span><span class="op" id="3578762">:</span><span class="ident" id="3578763">end</span><span class="op" id="3578766">]</span><span class="op" id="3578767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578771">xorBytes</span><span class="op" id="3578779">(</span><span class="ident" id="3578780">dst</span><span class="op" id="3578783">[</span><span class="ident" id="3578784">start</span><span class="op" id="3578789">:</span><span class="ident" id="3578790">end</span><span class="op" id="3578793">]</span><span class="op" id="3578794">,</span>&nbsp;<span class="ident" id="3578796">dst</span><span class="op" id="3578799">[</span><span class="ident" id="3578800">start</span><span class="op" id="3578805">:</span><span class="ident" id="3578806">end</span><span class="op" id="3578809">]</span><span class="op" id="3578810">,</span>&nbsp;<span class="ident" id="3578812">src</span><span class="op" id="3578815">[</span><span class="ident" id="3578816">prev</span><span class="op" id="3578820">:</span><span class="ident" id="3578821">start</span><span class="op" id="3578826">]</span><span class="op" id="3578827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578832">end</span>&nbsp;<span class="op" id="3578836">=</span>&nbsp;<span class="ident" id="3578838">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578846">start</span>&nbsp;<span class="op" id="3578852">=</span>&nbsp;<span class="ident" id="3578854">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578861">prev</span>&nbsp;<span class="op" id="3578866">-=</span>&nbsp;<span class="ident" id="3578869">x</span><span class="op" id="3578870">.</span><span class="ident" id="3578871">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3578882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3578886">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578947">x</span><span class="op" id="3578948">.</span><span class="ident" id="3578949">b</span><span class="op" id="3578950">.</span><span class="ident" id="3578951">Decrypt</span><span class="op" id="3578958">(</span><span class="ident" id="3578959">dst</span><span class="op" id="3578962">[</span><span class="ident" id="3578963">start</span><span class="op" id="3578968">:</span><span class="ident" id="3578969">end</span><span class="op" id="3578972">]</span><span class="op" id="3578973">,</span>&nbsp;<span class="ident" id="3578975">src</span><span class="op" id="3578978">[</span><span class="ident" id="3578979">start</span><span class="op" id="3578984">:</span><span class="ident" id="3578985">end</span><span class="op" id="3578988">]</span><span class="op" id="3578989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3578992">xorBytes</span><span class="op" id="3579000">(</span><span class="ident" id="3579001">dst</span><span class="op" id="3579004">[</span><span class="ident" id="3579005">start</span><span class="op" id="3579010">:</span><span class="ident" id="3579011">end</span><span class="op" id="3579014">]</span><span class="op" id="3579015">,</span>&nbsp;<span class="ident" id="3579017">dst</span><span class="op" id="3579020">[</span><span class="ident" id="3579021">start</span><span class="op" id="3579026">:</span><span class="ident" id="3579027">end</span><span class="op" id="3579030">]</span><span class="op" id="3579031">,</span>&nbsp;<span class="ident" id="3579033">x</span><span class="op" id="3579034">.</span><span class="ident" id="3579035">iv</span><span class="op" id="3579037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3579041">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3579098">x</span><span class="op" id="3579099">.</span><span class="ident" id="3579100">iv</span><span class="op" id="3579102">,</span>&nbsp;<span class="ident" id="3579104">x</span><span class="op" id="3579105">.</span><span class="ident" id="3579106">tmp</span>&nbsp;<span class="op" id="3579110">=</span>&nbsp;<span class="ident" id="3579112">x</span><span class="op" id="3579113">.</span><span class="ident" id="3579114">tmp</span><span class="op" id="3579117">,</span>&nbsp;<span class="ident" id="3579119">x</span><span class="op" id="3579120">.</span><span class="ident" id="3579121">iv</span><br>
<span class="lineno"></span><span class="op" id="3579124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3579127">func</span>&nbsp;<span class="op" id="3579132">(</span><span class="ident" id="3579133">x</span>&nbsp;<span class="op" id="3579135">*</span><span class="ident" id="3579136">cbcDecrypter</span><span class="op" id="3579148">)</span>&nbsp;<span class="ident" id="3579150">SetIV</span><span class="op" id="3579155">(</span><span class="ident" id="3579156">iv</span>&nbsp;<span class="op" id="3579159">[</span><span class="op" id="3579160">]</span><span class="builtintype" id="3579161">byte</span><span class="op" id="3579165">)</span>&nbsp;<span class="op" id="3579167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3579170">if</span>&nbsp;<span class="builtinfunc" id="3579173">len</span><span class="op" id="3579176">(</span><span class="ident" id="3579177">iv</span><span class="op" id="3579179">)</span>&nbsp;<span class="op" id="3579181">!=</span>&nbsp;<span class="builtinfunc" id="3579184">len</span><span class="op" id="3579187">(</span><span class="ident" id="3579188">x</span><span class="op" id="3579189">.</span><span class="ident" id="3579190">iv</span><span class="op" id="3579192">)</span>&nbsp;<span class="op" id="3579194">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3579198">panic</span><span class="op" id="3579203">(</span><span class="string" id="3579204">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3579233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3579239">copy</span><span class="op" id="3579243">(</span><span class="ident" id="3579244">x</span><span class="op" id="3579245">.</span><span class="ident" id="3579246">iv</span><span class="op" id="3579248">,</span>&nbsp;<span class="ident" id="3579250">iv</span><span class="op" id="3579252">)</span><br>
<span class="lineno"></span><span class="op" id="3579254">}</span>
</div>
</body>
</html>
