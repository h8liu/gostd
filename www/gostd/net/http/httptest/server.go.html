<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4654402">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4654457">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4654511">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4654562">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4654591">package</span>&nbsp;<span class="ident" id="4654599">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4654609">import</span>&nbsp;<span class="op" id="4654616">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654619">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654633">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654641">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654648">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654655">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654667">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4654673">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4654680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4654683">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="4654754">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="4654817">type</span>&nbsp;<span class="ident" id="4654822">Server</span>&nbsp;<span class="keyword" id="4654829">struct</span>&nbsp;<span class="op" id="4654836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654839">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4654848">string</span>&nbsp;<span class="comment" id="4654855">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654918">Listener</span>&nbsp;<span class="ident" id="4654927">net</span><span class="op" id="4654930">.</span><span class="ident" id="4654931">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4654942">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4655013">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4655085">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655148">TLS</span>&nbsp;<span class="op" id="4655152">*</span><span class="ident" id="4655153">tls</span><span class="op" id="4655156">.</span><span class="ident" id="4655157">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4655166">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4655229">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655259">Config</span>&nbsp;<span class="op" id="4655266">*</span><span class="ident" id="4655267">http</span><span class="op" id="4655271">.</span><span class="ident" id="4655272">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4655281">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4655351">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655401">wg</span>&nbsp;<span class="ident" id="4655404">sync</span><span class="op" id="4655408">.</span><span class="ident" id="4655409">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="4655419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4655422">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="4655487">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="4655500">type</span>&nbsp;<span class="ident" id="4655505">historyListener</span>&nbsp;<span class="keyword" id="4655521">struct</span>&nbsp;<span class="op" id="4655528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655531">net</span><span class="op" id="4655534">.</span><span class="ident" id="4655535">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655545">sync</span><span class="op" id="4655549">.</span><span class="ident" id="4655550">Mutex</span>&nbsp;<span class="comment" id="4655556">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655577">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4655588">[</span><span class="op" id="4655589">]</span><span class="ident" id="4655590">net</span><span class="op" id="4655593">.</span><span class="ident" id="4655594">Conn</span><br>
<span class="lineno">45</span><span class="op" id="4655599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4655602">func</span>&nbsp;<span class="op" id="4655607">(</span><span class="ident" id="4655608">hs</span>&nbsp;<span class="op" id="4655611">*</span><span class="ident" id="4655612">historyListener</span><span class="op" id="4655627">)</span>&nbsp;<span class="ident" id="4655629">Accept</span><span class="op" id="4655635">(</span><span class="op" id="4655636">)</span>&nbsp;<span class="op" id="4655638">(</span><span class="ident" id="4655639">c</span>&nbsp;<span class="ident" id="4655641">net</span><span class="op" id="4655644">.</span><span class="ident" id="4655645">Conn</span><span class="op" id="4655649">,</span>&nbsp;<span class="ident" id="4655651">err</span>&nbsp;<span class="builtintype" id="4655655">error</span><span class="op" id="4655660">)</span>&nbsp;<span class="op" id="4655662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655665">c</span><span class="op" id="4655666">,</span>&nbsp;<span class="ident" id="4655668">err</span>&nbsp;<span class="op" id="4655672">=</span>&nbsp;<span class="ident" id="4655674">hs</span><span class="op" id="4655676">.</span><span class="ident" id="4655677">Listener</span><span class="op" id="4655685">.</span><span class="ident" id="4655686">Accept</span><span class="op" id="4655692">(</span><span class="op" id="4655693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655696">if</span>&nbsp;<span class="ident" id="4655699">err</span>&nbsp;<span class="op" id="4655703">==</span>&nbsp;<span class="ident" id="4655706">nil</span>&nbsp;<span class="op" id="4655710">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655714">hs</span><span class="op" id="4655716">.</span><span class="ident" id="4655717">Lock</span><span class="op" id="4655721">(</span><span class="op" id="4655722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655726">hs</span><span class="op" id="4655728">.</span><span class="ident" id="4655729">history</span>&nbsp;<span class="op" id="4655737">=</span>&nbsp;<span class="builtinfunc" id="4655739">append</span><span class="op" id="4655745">(</span><span class="ident" id="4655746">hs</span><span class="op" id="4655748">.</span><span class="ident" id="4655749">history</span><span class="op" id="4655756">,</span>&nbsp;<span class="ident" id="4655758">c</span><span class="op" id="4655759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655763">hs</span><span class="op" id="4655765">.</span><span class="ident" id="4655766">Unlock</span><span class="op" id="4655772">(</span><span class="op" id="4655773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4655776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655779">return</span><br>
<span class="lineno">55</span><span class="op" id="4655786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4655789">func</span>&nbsp;<span class="ident" id="4655794">newLocalListener</span><span class="op" id="4655810">(</span><span class="op" id="4655811">)</span>&nbsp;<span class="ident" id="4655813">net</span><span class="op" id="4655816">.</span><span class="ident" id="4655817">Listener</span>&nbsp;<span class="op" id="4655826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655829">if</span>&nbsp;<span class="op" id="4655832">*</span><span class="ident" id="4655833">serve</span>&nbsp;<span class="op" id="4655839">!=</span>&nbsp;<span class="string" id="4655842">&#34;&#34;</span>&nbsp;<span class="op" id="4655845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655849">l</span><span class="op" id="4655850">,</span>&nbsp;<span class="ident" id="4655852">err</span>&nbsp;<span class="op" id="4655856">:=</span>&nbsp;<span class="ident" id="4655859">net</span><span class="op" id="4655862">.</span><span class="ident" id="4655863">Listen</span><span class="op" id="4655869">(</span><span class="string" id="4655870">&#34;tcp&#34;</span><span class="op" id="4655875">,</span>&nbsp;<span class="op" id="4655877">*</span><span class="ident" id="4655878">serve</span><span class="op" id="4655883">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655887">if</span>&nbsp;<span class="ident" id="4655890">err</span>&nbsp;<span class="op" id="4655894">!=</span>&nbsp;<span class="ident" id="4655897">nil</span>&nbsp;<span class="op" id="4655901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4655906">panic</span><span class="op" id="4655911">(</span><span class="ident" id="4655912">fmt</span><span class="op" id="4655915">.</span><span class="ident" id="4655916">Sprintf</span><span class="op" id="4655923">(</span><span class="string" id="4655924">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="4655962">,</span>&nbsp;<span class="op" id="4655964">*</span><span class="ident" id="4655965">serve</span><span class="op" id="4655970">,</span>&nbsp;<span class="ident" id="4655972">err</span><span class="op" id="4655975">)</span><span class="op" id="4655976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4655980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655984">return</span>&nbsp;<span class="ident" id="4655991">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4655994">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655997">l</span><span class="op" id="4655998">,</span>&nbsp;<span class="ident" id="4656000">err</span>&nbsp;<span class="op" id="4656004">:=</span>&nbsp;<span class="ident" id="4656007">net</span><span class="op" id="4656010">.</span><span class="ident" id="4656011">Listen</span><span class="op" id="4656017">(</span><span class="string" id="4656018">&#34;tcp&#34;</span><span class="op" id="4656023">,</span>&nbsp;<span class="string" id="4656025">&#34;127.0.0.1:0&#34;</span><span class="op" id="4656038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4656041">if</span>&nbsp;<span class="ident" id="4656044">err</span>&nbsp;<span class="op" id="4656048">!=</span>&nbsp;<span class="ident" id="4656051">nil</span>&nbsp;<span class="op" id="4656055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4656059">if</span>&nbsp;<span class="ident" id="4656062">l</span><span class="op" id="4656063">,</span>&nbsp;<span class="ident" id="4656065">err</span>&nbsp;<span class="op" id="4656069">=</span>&nbsp;<span class="ident" id="4656071">net</span><span class="op" id="4656074">.</span><span class="ident" id="4656075">Listen</span><span class="op" id="4656081">(</span><span class="string" id="4656082">&#34;tcp6&#34;</span><span class="op" id="4656088">,</span>&nbsp;<span class="string" id="4656090">&#34;[::1]:0&#34;</span><span class="op" id="4656099">)</span><span class="op" id="4656100">;</span>&nbsp;<span class="ident" id="4656102">err</span>&nbsp;<span class="op" id="4656106">!=</span>&nbsp;<span class="ident" id="4656109">nil</span>&nbsp;<span class="op" id="4656113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4656118">panic</span><span class="op" id="4656123">(</span><span class="ident" id="4656124">fmt</span><span class="op" id="4656127">.</span><span class="ident" id="4656128">Sprintf</span><span class="op" id="4656135">(</span><span class="string" id="4656136">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="4656178">,</span>&nbsp;<span class="ident" id="4656180">err</span><span class="op" id="4656183">)</span><span class="op" id="4656184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4656188">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4656191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4656194">return</span>&nbsp;<span class="ident" id="4656201">l</span><br>
<span class="lineno"></span><span class="op" id="4656203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4656206">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="4656261">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="4656287">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="4656345">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="4656413">var</span>&nbsp;<span class="ident" id="4656417">serve</span>&nbsp;<span class="op" id="4656423">=</span>&nbsp;<span class="ident" id="4656425">flag</span><span class="op" id="4656429">.</span><span class="ident" id="4656430">String</span><span class="op" id="4656436">(</span><span class="string" id="4656437">&#34;httptest.serve&#34;</span><span class="op" id="4656453">,</span>&nbsp;<span class="string" id="4656455">&#34;&#34;</span><span class="op" id="4656457">,</span>&nbsp;<span class="string" id="4656459">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="4656527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="4656530">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4656576">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="4656640">func</span>&nbsp;<span class="ident" id="4656645">NewServer</span><span class="op" id="4656654">(</span><span class="ident" id="4656655">handler</span>&nbsp;<span class="ident" id="4656663">http</span><span class="op" id="4656667">.</span><span class="ident" id="4656668">Handler</span><span class="op" id="4656675">)</span>&nbsp;<span class="op" id="4656677">*</span><span class="ident" id="4656678">Server</span>&nbsp;<span class="op" id="4656685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4656688">ts</span>&nbsp;<span class="op" id="4656691">:=</span>&nbsp;<span class="ident" id="4656694">NewUnstartedServer</span><span class="op" id="4656712">(</span><span class="ident" id="4656713">handler</span><span class="op" id="4656720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4656723">ts</span><span class="op" id="4656725">.</span><span class="ident" id="4656726">Start</span><span class="op" id="4656731">(</span><span class="op" id="4656732">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4656735">return</span>&nbsp;<span class="ident" id="4656742">ts</span><br>
<span class="lineno"></span><span class="op" id="4656745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4656748">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="4656813">//</span><br>
<span class="lineno">90</span><span class="comment" id="4656816">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4656885">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="4656898">//</span><br>
<span class="lineno"></span><span class="comment" id="4656901">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="4656965">func</span>&nbsp;<span class="ident" id="4656970">NewUnstartedServer</span><span class="op" id="4656988">(</span><span class="ident" id="4656989">handler</span>&nbsp;<span class="ident" id="4656997">http</span><span class="op" id="4657001">.</span><span class="ident" id="4657002">Handler</span><span class="op" id="4657009">)</span>&nbsp;<span class="op" id="4657011">*</span><span class="ident" id="4657012">Server</span>&nbsp;<span class="op" id="4657019">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657022">return</span>&nbsp;<span class="op" id="4657029">&amp;</span><span class="ident" id="4657030">Server</span><span class="op" id="4657036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657040">Listener</span><span class="op" id="4657048">:</span>&nbsp;<span class="ident" id="4657050">newLocalListener</span><span class="op" id="4657066">(</span><span class="op" id="4657067">)</span><span class="op" id="4657068">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657072">Config</span><span class="op" id="4657078">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4657082">&amp;</span><span class="ident" id="4657083">http</span><span class="op" id="4657087">.</span><span class="ident" id="4657088">Server</span><span class="op" id="4657094">{</span><span class="ident" id="4657095">Handler</span><span class="op" id="4657102">:</span>&nbsp;<span class="ident" id="4657104">handler</span><span class="op" id="4657111">}</span><span class="op" id="4657112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657115">}</span><br>
<span class="lineno"></span><span class="op" id="4657117">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4657120">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="4657170">func</span>&nbsp;<span class="op" id="4657175">(</span><span class="ident" id="4657176">s</span>&nbsp;<span class="op" id="4657178">*</span><span class="ident" id="4657179">Server</span><span class="op" id="4657185">)</span>&nbsp;<span class="ident" id="4657187">Start</span><span class="op" id="4657192">(</span><span class="op" id="4657193">)</span>&nbsp;<span class="op" id="4657195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657198">if</span>&nbsp;<span class="ident" id="4657201">s</span><span class="op" id="4657202">.</span><span class="ident" id="4657203">URL</span>&nbsp;<span class="op" id="4657207">!=</span>&nbsp;<span class="string" id="4657210">&#34;&#34;</span>&nbsp;<span class="op" id="4657213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4657217">panic</span><span class="op" id="4657222">(</span><span class="string" id="4657223">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="4657247">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657253">s</span><span class="op" id="4657254">.</span><span class="ident" id="4657255">Listener</span>&nbsp;<span class="op" id="4657264">=</span>&nbsp;<span class="op" id="4657266">&amp;</span><span class="ident" id="4657267">historyListener</span><span class="op" id="4657282">{</span><span class="ident" id="4657283">Listener</span><span class="op" id="4657291">:</span>&nbsp;<span class="ident" id="4657293">s</span><span class="op" id="4657294">.</span><span class="ident" id="4657295">Listener</span><span class="op" id="4657303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657306">s</span><span class="op" id="4657307">.</span><span class="ident" id="4657308">URL</span>&nbsp;<span class="op" id="4657312">=</span>&nbsp;<span class="string" id="4657314">&#34;http://&#34;</span>&nbsp;<span class="op" id="4657324">+</span>&nbsp;<span class="ident" id="4657326">s</span><span class="op" id="4657327">.</span><span class="ident" id="4657328">Listener</span><span class="op" id="4657336">.</span><span class="ident" id="4657337">Addr</span><span class="op" id="4657341">(</span><span class="op" id="4657342">)</span><span class="op" id="4657343">.</span><span class="ident" id="4657344">String</span><span class="op" id="4657350">(</span><span class="op" id="4657351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657354">s</span><span class="op" id="4657355">.</span><span class="ident" id="4657356">wrapHandler</span><span class="op" id="4657367">(</span><span class="op" id="4657368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657371">go</span>&nbsp;<span class="ident" id="4657374">s</span><span class="op" id="4657375">.</span><span class="ident" id="4657376">Config</span><span class="op" id="4657382">.</span><span class="ident" id="4657383">Serve</span><span class="op" id="4657388">(</span><span class="ident" id="4657389">s</span><span class="op" id="4657390">.</span><span class="ident" id="4657391">Listener</span><span class="op" id="4657399">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657402">if</span>&nbsp;<span class="op" id="4657405">*</span><span class="ident" id="4657406">serve</span>&nbsp;<span class="op" id="4657412">!=</span>&nbsp;<span class="string" id="4657415">&#34;&#34;</span>&nbsp;<span class="op" id="4657418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657422">fmt</span><span class="op" id="4657425">.</span><span class="ident" id="4657426">Fprintln</span><span class="op" id="4657434">(</span><span class="ident" id="4657435">os</span><span class="op" id="4657437">.</span><span class="ident" id="4657438">Stderr</span><span class="op" id="4657444">,</span>&nbsp;<span class="string" id="4657446">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="4657468">,</span>&nbsp;<span class="ident" id="4657470">s</span><span class="op" id="4657471">.</span><span class="ident" id="4657472">URL</span><span class="op" id="4657475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657479">select</span>&nbsp;<span class="op" id="4657486">{</span><span class="op" id="4657487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657490">}</span><br>
<span class="lineno"></span><span class="op" id="4657492">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4657495">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="4657555">func</span>&nbsp;<span class="op" id="4657560">(</span><span class="ident" id="4657561">s</span>&nbsp;<span class="op" id="4657563">*</span><span class="ident" id="4657564">Server</span><span class="op" id="4657570">)</span>&nbsp;<span class="ident" id="4657572">StartTLS</span><span class="op" id="4657580">(</span><span class="op" id="4657581">)</span>&nbsp;<span class="op" id="4657583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657586">if</span>&nbsp;<span class="ident" id="4657589">s</span><span class="op" id="4657590">.</span><span class="ident" id="4657591">URL</span>&nbsp;<span class="op" id="4657595">!=</span>&nbsp;<span class="string" id="4657598">&#34;&#34;</span>&nbsp;<span class="op" id="4657601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4657605">panic</span><span class="op" id="4657610">(</span><span class="string" id="4657611">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="4657635">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657641">cert</span><span class="op" id="4657645">,</span>&nbsp;<span class="ident" id="4657647">err</span>&nbsp;<span class="op" id="4657651">:=</span>&nbsp;<span class="ident" id="4657654">tls</span><span class="op" id="4657657">.</span><span class="ident" id="4657658">X509KeyPair</span><span class="op" id="4657669">(</span><span class="ident" id="4657670">localhostCert</span><span class="op" id="4657683">,</span>&nbsp;<span class="ident" id="4657685">localhostKey</span><span class="op" id="4657697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657700">if</span>&nbsp;<span class="ident" id="4657703">err</span>&nbsp;<span class="op" id="4657707">!=</span>&nbsp;<span class="ident" id="4657710">nil</span>&nbsp;<span class="op" id="4657714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4657718">panic</span><span class="op" id="4657723">(</span><span class="ident" id="4657724">fmt</span><span class="op" id="4657727">.</span><span class="ident" id="4657728">Sprintf</span><span class="op" id="4657735">(</span><span class="string" id="4657736">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="4657764">,</span>&nbsp;<span class="ident" id="4657766">err</span><span class="op" id="4657769">)</span><span class="op" id="4657770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657773">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657777">existingConfig</span>&nbsp;<span class="op" id="4657792">:=</span>&nbsp;<span class="ident" id="4657795">s</span><span class="op" id="4657796">.</span><span class="ident" id="4657797">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657802">s</span><span class="op" id="4657803">.</span><span class="ident" id="4657804">TLS</span>&nbsp;<span class="op" id="4657808">=</span>&nbsp;<span class="builtinfunc" id="4657810">new</span><span class="op" id="4657813">(</span><span class="ident" id="4657814">tls</span><span class="op" id="4657817">.</span><span class="ident" id="4657818">Config</span><span class="op" id="4657824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657827">if</span>&nbsp;<span class="ident" id="4657830">existingConfig</span>&nbsp;<span class="op" id="4657845">!=</span>&nbsp;<span class="ident" id="4657848">nil</span>&nbsp;<span class="op" id="4657852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657856">*</span><span class="ident" id="4657857">s</span><span class="op" id="4657858">.</span><span class="ident" id="4657859">TLS</span>&nbsp;<span class="op" id="4657863">=</span>&nbsp;<span class="op" id="4657865">*</span><span class="ident" id="4657866">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657885">if</span>&nbsp;<span class="ident" id="4657888">s</span><span class="op" id="4657889">.</span><span class="ident" id="4657890">TLS</span><span class="op" id="4657893">.</span><span class="ident" id="4657894">NextProtos</span>&nbsp;<span class="op" id="4657905">==</span>&nbsp;<span class="ident" id="4657908">nil</span>&nbsp;<span class="op" id="4657912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657916">s</span><span class="op" id="4657917">.</span><span class="ident" id="4657918">TLS</span><span class="op" id="4657921">.</span><span class="ident" id="4657922">NextProtos</span>&nbsp;<span class="op" id="4657933">=</span>&nbsp;<span class="op" id="4657935">[</span><span class="op" id="4657936">]</span><span class="builtintype" id="4657937">string</span><span class="op" id="4657943">{</span><span class="string" id="4657944">&#34;http/1.1&#34;</span><span class="op" id="4657954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4657957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4657960">if</span>&nbsp;<span class="builtinfunc" id="4657963">len</span><span class="op" id="4657966">(</span><span class="ident" id="4657967">s</span><span class="op" id="4657968">.</span><span class="ident" id="4657969">TLS</span><span class="op" id="4657972">.</span><span class="ident" id="4657973">Certificates</span><span class="op" id="4657985">)</span>&nbsp;<span class="op" id="4657987">==</span>&nbsp;<span class="num" id="4657990">0</span>&nbsp;<span class="op" id="4657992">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4657996">s</span><span class="op" id="4657997">.</span><span class="ident" id="4657998">TLS</span><span class="op" id="4658001">.</span><span class="ident" id="4658002">Certificates</span>&nbsp;<span class="op" id="4658015">=</span>&nbsp;<span class="op" id="4658017">[</span><span class="op" id="4658018">]</span><span class="ident" id="4658019">tls</span><span class="op" id="4658022">.</span><span class="ident" id="4658023">Certificate</span><span class="op" id="4658034">{</span><span class="ident" id="4658035">cert</span><span class="op" id="4658039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4658042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658045">tlsListener</span>&nbsp;<span class="op" id="4658057">:=</span>&nbsp;<span class="ident" id="4658060">tls</span><span class="op" id="4658063">.</span><span class="ident" id="4658064">NewListener</span><span class="op" id="4658075">(</span><span class="ident" id="4658076">s</span><span class="op" id="4658077">.</span><span class="ident" id="4658078">Listener</span><span class="op" id="4658086">,</span>&nbsp;<span class="ident" id="4658088">s</span><span class="op" id="4658089">.</span><span class="ident" id="4658090">TLS</span><span class="op" id="4658093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658097">s</span><span class="op" id="4658098">.</span><span class="ident" id="4658099">Listener</span>&nbsp;<span class="op" id="4658108">=</span>&nbsp;<span class="op" id="4658110">&amp;</span><span class="ident" id="4658111">historyListener</span><span class="op" id="4658126">{</span><span class="ident" id="4658127">Listener</span><span class="op" id="4658135">:</span>&nbsp;<span class="ident" id="4658137">tlsListener</span><span class="op" id="4658148">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658151">s</span><span class="op" id="4658152">.</span><span class="ident" id="4658153">URL</span>&nbsp;<span class="op" id="4658157">=</span>&nbsp;<span class="string" id="4658159">&#34;https://&#34;</span>&nbsp;<span class="op" id="4658170">+</span>&nbsp;<span class="ident" id="4658172">s</span><span class="op" id="4658173">.</span><span class="ident" id="4658174">Listener</span><span class="op" id="4658182">.</span><span class="ident" id="4658183">Addr</span><span class="op" id="4658187">(</span><span class="op" id="4658188">)</span><span class="op" id="4658189">.</span><span class="ident" id="4658190">String</span><span class="op" id="4658196">(</span><span class="op" id="4658197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658200">s</span><span class="op" id="4658201">.</span><span class="ident" id="4658202">wrapHandler</span><span class="op" id="4658213">(</span><span class="op" id="4658214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4658217">go</span>&nbsp;<span class="ident" id="4658220">s</span><span class="op" id="4658221">.</span><span class="ident" id="4658222">Config</span><span class="op" id="4658228">.</span><span class="ident" id="4658229">Serve</span><span class="op" id="4658234">(</span><span class="ident" id="4658235">s</span><span class="op" id="4658236">.</span><span class="ident" id="4658237">Listener</span><span class="op" id="4658245">)</span><br>
<span class="lineno"></span><span class="op" id="4658247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="4658250">func</span>&nbsp;<span class="op" id="4658255">(</span><span class="ident" id="4658256">s</span>&nbsp;<span class="op" id="4658258">*</span><span class="ident" id="4658259">Server</span><span class="op" id="4658265">)</span>&nbsp;<span class="ident" id="4658267">wrapHandler</span><span class="op" id="4658278">(</span><span class="op" id="4658279">)</span>&nbsp;<span class="op" id="4658281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658284">h</span>&nbsp;<span class="op" id="4658286">:=</span>&nbsp;<span class="ident" id="4658289">s</span><span class="op" id="4658290">.</span><span class="ident" id="4658291">Config</span><span class="op" id="4658297">.</span><span class="ident" id="4658298">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4658307">if</span>&nbsp;<span class="ident" id="4658310">h</span>&nbsp;<span class="op" id="4658312">==</span>&nbsp;<span class="ident" id="4658315">nil</span>&nbsp;<span class="op" id="4658319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658323">h</span>&nbsp;<span class="op" id="4658325">=</span>&nbsp;<span class="ident" id="4658327">http</span><span class="op" id="4658331">.</span><span class="ident" id="4658332">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4658349">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658352">s</span><span class="op" id="4658353">.</span><span class="ident" id="4658354">Config</span><span class="op" id="4658360">.</span><span class="ident" id="4658361">Handler</span>&nbsp;<span class="op" id="4658369">=</span>&nbsp;<span class="op" id="4658371">&amp;</span><span class="ident" id="4658372">waitGroupHandler</span><span class="op" id="4658388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658392">s</span><span class="op" id="4658393">:</span>&nbsp;<span class="ident" id="4658395">s</span><span class="op" id="4658396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658400">h</span><span class="op" id="4658401">:</span>&nbsp;<span class="ident" id="4658403">h</span><span class="op" id="4658404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4658407">}</span><br>
<span class="lineno"></span><span class="op" id="4658409">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4658412">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="4658471">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="4658535">func</span>&nbsp;<span class="ident" id="4658540">NewTLSServer</span><span class="op" id="4658552">(</span><span class="ident" id="4658553">handler</span>&nbsp;<span class="ident" id="4658561">http</span><span class="op" id="4658565">.</span><span class="ident" id="4658566">Handler</span><span class="op" id="4658573">)</span>&nbsp;<span class="op" id="4658575">*</span><span class="ident" id="4658576">Server</span>&nbsp;<span class="op" id="4658583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658586">ts</span>&nbsp;<span class="op" id="4658589">:=</span>&nbsp;<span class="ident" id="4658592">NewUnstartedServer</span><span class="op" id="4658610">(</span><span class="ident" id="4658611">handler</span><span class="op" id="4658618">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658621">ts</span><span class="op" id="4658623">.</span><span class="ident" id="4658624">StartTLS</span><span class="op" id="4658632">(</span><span class="op" id="4658633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4658636">return</span>&nbsp;<span class="ident" id="4658643">ts</span><br>
<span class="lineno"></span><span class="op" id="4658646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4658649">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="4658713">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4658756">func</span>&nbsp;<span class="op" id="4658761">(</span><span class="ident" id="4658762">s</span>&nbsp;<span class="op" id="4658764">*</span><span class="ident" id="4658765">Server</span><span class="op" id="4658771">)</span>&nbsp;<span class="ident" id="4658773">Close</span><span class="op" id="4658778">(</span><span class="op" id="4658779">)</span>&nbsp;<span class="op" id="4658781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658784">s</span><span class="op" id="4658785">.</span><span class="ident" id="4658786">Listener</span><span class="op" id="4658794">.</span><span class="ident" id="4658795">Close</span><span class="op" id="4658800">(</span><span class="op" id="4658801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658804">s</span><span class="op" id="4658805">.</span><span class="ident" id="4658806">wg</span><span class="op" id="4658808">.</span><span class="ident" id="4658809">Wait</span><span class="op" id="4658813">(</span><span class="op" id="4658814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658817">s</span><span class="op" id="4658818">.</span><span class="ident" id="4658819">CloseClientConnections</span><span class="op" id="4658841">(</span><span class="op" id="4658842">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4658845">if</span>&nbsp;<span class="ident" id="4658848">t</span><span class="op" id="4658849">,</span>&nbsp;<span class="ident" id="4658851">ok</span>&nbsp;<span class="op" id="4658854">:=</span>&nbsp;<span class="ident" id="4658857">http</span><span class="op" id="4658861">.</span><span class="ident" id="4658862">DefaultTransport</span><span class="op" id="4658878">.</span><span class="op" id="4658879">(</span><span class="op" id="4658880">*</span><span class="ident" id="4658881">http</span><span class="op" id="4658885">.</span><span class="ident" id="4658886">Transport</span><span class="op" id="4658895">)</span><span class="op" id="4658896">;</span>&nbsp;<span class="ident" id="4658898">ok</span>&nbsp;<span class="op" id="4658901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4658905">t</span><span class="op" id="4658906">.</span><span class="ident" id="4658907">CloseIdleConnections</span><span class="op" id="4658927">(</span><span class="op" id="4658928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4658931">}</span><br>
<span class="lineno"></span><span class="op" id="4658933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="4658936">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="4659005">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4659028">func</span>&nbsp;<span class="op" id="4659033">(</span><span class="ident" id="4659034">s</span>&nbsp;<span class="op" id="4659036">*</span><span class="ident" id="4659037">Server</span><span class="op" id="4659043">)</span>&nbsp;<span class="ident" id="4659045">CloseClientConnections</span><span class="op" id="4659067">(</span><span class="op" id="4659068">)</span>&nbsp;<span class="op" id="4659070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659073">hl</span><span class="op" id="4659075">,</span>&nbsp;<span class="ident" id="4659077">ok</span>&nbsp;<span class="op" id="4659080">:=</span>&nbsp;<span class="ident" id="4659083">s</span><span class="op" id="4659084">.</span><span class="ident" id="4659085">Listener</span><span class="op" id="4659093">.</span><span class="op" id="4659094">(</span><span class="op" id="4659095">*</span><span class="ident" id="4659096">historyListener</span><span class="op" id="4659111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4659114">if</span>&nbsp;<span class="op" id="4659117">!</span><span class="ident" id="4659118">ok</span>&nbsp;<span class="op" id="4659121">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4659125">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4659133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659136">hl</span><span class="op" id="4659138">.</span><span class="ident" id="4659139">Lock</span><span class="op" id="4659143">(</span><span class="op" id="4659144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4659147">for</span>&nbsp;<span class="ident" id="4659151">_</span><span class="op" id="4659152">,</span>&nbsp;<span class="ident" id="4659154">conn</span>&nbsp;<span class="op" id="4659159">:=</span>&nbsp;<span class="keyword" id="4659162">range</span>&nbsp;<span class="ident" id="4659168">hl</span><span class="op" id="4659170">.</span><span class="ident" id="4659171">history</span>&nbsp;<span class="op" id="4659179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659183">conn</span><span class="op" id="4659187">.</span><span class="ident" id="4659188">Close</span><span class="op" id="4659193">(</span><span class="op" id="4659194">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4659197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659200">hl</span><span class="op" id="4659202">.</span><span class="ident" id="4659203">Unlock</span><span class="op" id="4659209">(</span><span class="op" id="4659210">)</span><br>
<span class="lineno"></span><span class="op" id="4659212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4659215">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="4659284">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="4659351">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="4659395">type</span>&nbsp;<span class="ident" id="4659400">waitGroupHandler</span>&nbsp;<span class="keyword" id="4659417">struct</span>&nbsp;<span class="op" id="4659424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659427">s</span>&nbsp;<span class="op" id="4659429">*</span><span class="ident" id="4659430">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659438">h</span>&nbsp;<span class="ident" id="4659440">http</span><span class="op" id="4659444">.</span><span class="ident" id="4659445">Handler</span>&nbsp;<span class="comment" id="4659453">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="4659464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4659467">func</span>&nbsp;<span class="op" id="4659472">(</span><span class="ident" id="4659473">h</span>&nbsp;<span class="op" id="4659475">*</span><span class="ident" id="4659476">waitGroupHandler</span><span class="op" id="4659492">)</span>&nbsp;<span class="ident" id="4659494">ServeHTTP</span><span class="op" id="4659503">(</span><span class="ident" id="4659504">w</span>&nbsp;<span class="ident" id="4659506">http</span><span class="op" id="4659510">.</span><span class="ident" id="4659511">ResponseWriter</span><span class="op" id="4659525">,</span>&nbsp;<span class="ident" id="4659527">r</span>&nbsp;<span class="op" id="4659529">*</span><span class="ident" id="4659530">http</span><span class="op" id="4659534">.</span><span class="ident" id="4659535">Request</span><span class="op" id="4659542">)</span>&nbsp;<span class="op" id="4659544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659547">h</span><span class="op" id="4659548">.</span><span class="ident" id="4659549">s</span><span class="op" id="4659550">.</span><span class="ident" id="4659551">wg</span><span class="op" id="4659553">.</span><span class="ident" id="4659554">Add</span><span class="op" id="4659557">(</span><span class="num" id="4659558">1</span><span class="op" id="4659559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4659562">defer</span>&nbsp;<span class="ident" id="4659568">h</span><span class="op" id="4659569">.</span><span class="ident" id="4659570">s</span><span class="op" id="4659571">.</span><span class="ident" id="4659572">wg</span><span class="op" id="4659574">.</span><span class="ident" id="4659575">Done</span><span class="op" id="4659579">(</span><span class="op" id="4659580">)</span>&nbsp;<span class="comment" id="4659582">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4659626">h</span><span class="op" id="4659627">.</span><span class="ident" id="4659628">h</span><span class="op" id="4659629">.</span><span class="ident" id="4659630">ServeHTTP</span><span class="op" id="4659639">(</span><span class="ident" id="4659640">w</span><span class="op" id="4659641">,</span>&nbsp;<span class="ident" id="4659643">r</span><span class="op" id="4659644">)</span><br>
<span class="lineno"></span><span class="op" id="4659646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4659649">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="4659705">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="4659778">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="4659797">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="4659831">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="4659967">var</span>&nbsp;<span class="ident" id="4659971">localhostCert</span>&nbsp;<span class="op" id="4659985">=</span>&nbsp;<span class="op" id="4659987">[</span><span class="op" id="4659988">]</span><span class="builtintype" id="4659989">byte</span><span class="op" id="4659993">(</span><span class="string" id="4659994">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="4660565">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4660568">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="4660622">var</span>&nbsp;<span class="ident" id="4660626">localhostKey</span>&nbsp;<span class="op" id="4660639">=</span>&nbsp;<span class="op" id="4660641">[</span><span class="op" id="4660642">]</span><span class="builtintype" id="4660643">byte</span><span class="op" id="4660647">(</span><span class="string" id="4660648">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="4661146">)</span>
</div>
</body>
</html>
