<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3145190">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3145245">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3145299">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3145350">package</span>&nbsp;<span class="ident" id="3145358">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3145363">import</span>&nbsp;<span class="op" id="3145370">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145373">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145379">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3145390">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3145397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3145400">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3145475">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="3145506">type</span>&nbsp;<span class="ident" id="3145511">Encoder</span>&nbsp;<span class="keyword" id="3145519">struct</span>&nbsp;<span class="op" id="3145526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145529">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3145540">sync</span><span class="op" id="3145544">.</span><span class="ident" id="3145545">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3145564">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145602">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3145613">[</span><span class="op" id="3145614">]</span><span class="ident" id="3145615">io</span><span class="op" id="3145617">.</span><span class="ident" id="3145618">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3145637">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145664">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3145675">map</span><span class="op" id="3145678">[</span><span class="ident" id="3145679">reflect</span><span class="op" id="3145686">.</span><span class="ident" id="3145687">Type</span><span class="op" id="3145691">]</span><span class="ident" id="3145692">typeId</span>&nbsp;<span class="comment" id="3145699">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145734">countState</span>&nbsp;<span class="op" id="3145745">*</span><span class="ident" id="3145746">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3145769">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145798">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3145809">*</span><span class="ident" id="3145810">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3145833">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145885">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3145896">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3145920">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145958">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3145969">error</span><br>
<span class="lineno"></span><span class="op" id="3145975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3145978">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3146045">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3146112">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3146174">const</span>&nbsp;<span class="ident" id="3146180">maxLength</span>&nbsp;<span class="op" id="3146190">=</span>&nbsp;<span class="num" id="3146192">9</span>&nbsp;<span class="comment" id="3146194">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="3146232">var</span>&nbsp;<span class="ident" id="3146236">spaceForLength</span>&nbsp;<span class="op" id="3146251">=</span>&nbsp;<span class="builtinfunc" id="3146253">make</span><span class="op" id="3146257">(</span><span class="op" id="3146258">[</span><span class="op" id="3146259">]</span><span class="builtintype" id="3146260">byte</span><span class="op" id="3146264">,</span>&nbsp;<span class="ident" id="3146266">maxLength</span><span class="op" id="3146275">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="3146278">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3146351">func</span>&nbsp;<span class="ident" id="3146356">NewEncoder</span><span class="op" id="3146366">(</span><span class="ident" id="3146367">w</span>&nbsp;<span class="ident" id="3146369">io</span><span class="op" id="3146371">.</span><span class="ident" id="3146372">Writer</span><span class="op" id="3146378">)</span>&nbsp;<span class="op" id="3146380">*</span><span class="ident" id="3146381">Encoder</span>&nbsp;<span class="op" id="3146389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146392">enc</span>&nbsp;<span class="op" id="3146396">:=</span>&nbsp;<span class="builtinfunc" id="3146399">new</span><span class="op" id="3146402">(</span><span class="ident" id="3146403">Encoder</span><span class="op" id="3146410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146413">enc</span><span class="op" id="3146416">.</span><span class="ident" id="3146417">w</span>&nbsp;<span class="op" id="3146419">=</span>&nbsp;<span class="op" id="3146421">[</span><span class="op" id="3146422">]</span><span class="ident" id="3146423">io</span><span class="op" id="3146425">.</span><span class="ident" id="3146426">Writer</span><span class="op" id="3146432">{</span><span class="ident" id="3146433">w</span><span class="op" id="3146434">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146437">enc</span><span class="op" id="3146440">.</span><span class="ident" id="3146441">sent</span>&nbsp;<span class="op" id="3146446">=</span>&nbsp;<span class="builtinfunc" id="3146448">make</span><span class="op" id="3146452">(</span><span class="keyword" id="3146453">map</span><span class="op" id="3146456">[</span><span class="ident" id="3146457">reflect</span><span class="op" id="3146464">.</span><span class="ident" id="3146465">Type</span><span class="op" id="3146469">]</span><span class="ident" id="3146470">typeId</span><span class="op" id="3146476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146479">enc</span><span class="op" id="3146482">.</span><span class="ident" id="3146483">countState</span>&nbsp;<span class="op" id="3146494">=</span>&nbsp;<span class="ident" id="3146496">enc</span><span class="op" id="3146499">.</span><span class="ident" id="3146500">newEncoderState</span><span class="op" id="3146515">(</span><span class="builtinfunc" id="3146516">new</span><span class="op" id="3146519">(</span><span class="ident" id="3146520">encBuffer</span><span class="op" id="3146529">)</span><span class="op" id="3146530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146533">return</span>&nbsp;<span class="ident" id="3146540">enc</span><br>
<span class="lineno"></span><span class="op" id="3146544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3146547">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="3146609">func</span>&nbsp;<span class="op" id="3146614">(</span><span class="ident" id="3146615">enc</span>&nbsp;<span class="op" id="3146619">*</span><span class="ident" id="3146620">Encoder</span><span class="op" id="3146627">)</span>&nbsp;<span class="ident" id="3146629">writer</span><span class="op" id="3146635">(</span><span class="op" id="3146636">)</span>&nbsp;<span class="ident" id="3146638">io</span><span class="op" id="3146640">.</span><span class="ident" id="3146641">Writer</span>&nbsp;<span class="op" id="3146648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146651">return</span>&nbsp;<span class="ident" id="3146658">enc</span><span class="op" id="3146661">.</span><span class="ident" id="3146662">w</span><span class="op" id="3146663">[</span><span class="builtinfunc" id="3146664">len</span><span class="op" id="3146667">(</span><span class="ident" id="3146668">enc</span><span class="op" id="3146671">.</span><span class="ident" id="3146672">w</span><span class="op" id="3146673">)</span><span class="op" id="3146674">-</span><span class="num" id="3146675">1</span><span class="op" id="3146676">]</span><br>
<span class="lineno"></span><span class="op" id="3146678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3146681">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="3146725">func</span>&nbsp;<span class="op" id="3146730">(</span><span class="ident" id="3146731">enc</span>&nbsp;<span class="op" id="3146735">*</span><span class="ident" id="3146736">Encoder</span><span class="op" id="3146743">)</span>&nbsp;<span class="ident" id="3146745">pushWriter</span><span class="op" id="3146755">(</span><span class="ident" id="3146756">w</span>&nbsp;<span class="ident" id="3146758">io</span><span class="op" id="3146760">.</span><span class="ident" id="3146761">Writer</span><span class="op" id="3146767">)</span>&nbsp;<span class="op" id="3146769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146772">enc</span><span class="op" id="3146775">.</span><span class="ident" id="3146776">w</span>&nbsp;<span class="op" id="3146778">=</span>&nbsp;<span class="builtinfunc" id="3146780">append</span><span class="op" id="3146786">(</span><span class="ident" id="3146787">enc</span><span class="op" id="3146790">.</span><span class="ident" id="3146791">w</span><span class="op" id="3146792">,</span>&nbsp;<span class="ident" id="3146794">w</span><span class="op" id="3146795">)</span><br>
<span class="lineno"></span><span class="op" id="3146797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3146800">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3146840">func</span>&nbsp;<span class="op" id="3146845">(</span><span class="ident" id="3146846">enc</span>&nbsp;<span class="op" id="3146850">*</span><span class="ident" id="3146851">Encoder</span><span class="op" id="3146858">)</span>&nbsp;<span class="ident" id="3146860">popWriter</span><span class="op" id="3146869">(</span><span class="op" id="3146870">)</span>&nbsp;<span class="op" id="3146872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146875">enc</span><span class="op" id="3146878">.</span><span class="ident" id="3146879">w</span>&nbsp;<span class="op" id="3146881">=</span>&nbsp;<span class="ident" id="3146883">enc</span><span class="op" id="3146886">.</span><span class="ident" id="3146887">w</span><span class="op" id="3146888">[</span><span class="num" id="3146889">0</span>&nbsp;<span class="op" id="3146891">:</span>&nbsp;<span class="builtinfunc" id="3146893">len</span><span class="op" id="3146896">(</span><span class="ident" id="3146897">enc</span><span class="op" id="3146900">.</span><span class="ident" id="3146901">w</span><span class="op" id="3146902">)</span><span class="op" id="3146903">-</span><span class="num" id="3146904">1</span><span class="op" id="3146905">]</span><br>
<span class="lineno"></span><span class="op" id="3146907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="3146910">func</span>&nbsp;<span class="op" id="3146915">(</span><span class="ident" id="3146916">enc</span>&nbsp;<span class="op" id="3146920">*</span><span class="ident" id="3146921">Encoder</span><span class="op" id="3146928">)</span>&nbsp;<span class="ident" id="3146930">setError</span><span class="op" id="3146938">(</span><span class="ident" id="3146939">err</span>&nbsp;<span class="builtintype" id="3146943">error</span><span class="op" id="3146948">)</span>&nbsp;<span class="op" id="3146950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3146953">if</span>&nbsp;<span class="ident" id="3146956">enc</span><span class="op" id="3146959">.</span><span class="ident" id="3146960">err</span>&nbsp;<span class="op" id="3146964">==</span>&nbsp;<span class="ident" id="3146967">nil</span>&nbsp;<span class="op" id="3146971">{</span>&nbsp;<span class="comment" id="3146973">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3146998">enc</span><span class="op" id="3147001">.</span><span class="ident" id="3147002">err</span>&nbsp;<span class="op" id="3147006">=</span>&nbsp;<span class="ident" id="3147008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147013">}</span><br>
<span class="lineno"></span><span class="op" id="3147015">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3147018">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="3147098">func</span>&nbsp;<span class="op" id="3147103">(</span><span class="ident" id="3147104">enc</span>&nbsp;<span class="op" id="3147108">*</span><span class="ident" id="3147109">Encoder</span><span class="op" id="3147116">)</span>&nbsp;<span class="ident" id="3147118">writeMessage</span><span class="op" id="3147130">(</span><span class="ident" id="3147131">w</span>&nbsp;<span class="ident" id="3147133">io</span><span class="op" id="3147135">.</span><span class="ident" id="3147136">Writer</span><span class="op" id="3147142">,</span>&nbsp;<span class="ident" id="3147144">b</span>&nbsp;<span class="op" id="3147146">*</span><span class="ident" id="3147147">encBuffer</span><span class="op" id="3147156">)</span>&nbsp;<span class="op" id="3147158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147161">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147232">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147312">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147328">message</span>&nbsp;<span class="op" id="3147336">:=</span>&nbsp;<span class="ident" id="3147339">b</span><span class="op" id="3147340">.</span><span class="ident" id="3147341">Bytes</span><span class="op" id="3147346">(</span><span class="op" id="3147347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147350">messageLen</span>&nbsp;<span class="op" id="3147361">:=</span>&nbsp;<span class="builtinfunc" id="3147364">len</span><span class="op" id="3147367">(</span><span class="ident" id="3147368">message</span><span class="op" id="3147375">)</span>&nbsp;<span class="op" id="3147377">-</span>&nbsp;<span class="ident" id="3147379">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147390">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147413">enc</span><span class="op" id="3147416">.</span><span class="ident" id="3147417">countState</span><span class="op" id="3147427">.</span><span class="ident" id="3147428">b</span><span class="op" id="3147429">.</span><span class="ident" id="3147430">Reset</span><span class="op" id="3147435">(</span><span class="op" id="3147436">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147439">enc</span><span class="op" id="3147442">.</span><span class="ident" id="3147443">countState</span><span class="op" id="3147453">.</span><span class="ident" id="3147454">encodeUint</span><span class="op" id="3147464">(</span><span class="ident" id="3147465">uint64</span><span class="op" id="3147471">(</span><span class="ident" id="3147472">messageLen</span><span class="op" id="3147482">)</span><span class="op" id="3147483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147486">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147537">offset</span>&nbsp;<span class="op" id="3147544">:=</span>&nbsp;<span class="ident" id="3147547">maxLength</span>&nbsp;<span class="op" id="3147557">-</span>&nbsp;<span class="ident" id="3147559">enc</span><span class="op" id="3147562">.</span><span class="ident" id="3147563">countState</span><span class="op" id="3147573">.</span><span class="ident" id="3147574">b</span><span class="op" id="3147575">.</span><span class="ident" id="3147576">Len</span><span class="op" id="3147579">(</span><span class="op" id="3147580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3147583">copy</span><span class="op" id="3147587">(</span><span class="ident" id="3147588">message</span><span class="op" id="3147595">[</span><span class="ident" id="3147596">offset</span><span class="op" id="3147602">:</span><span class="op" id="3147603">]</span><span class="op" id="3147604">,</span>&nbsp;<span class="ident" id="3147606">enc</span><span class="op" id="3147609">.</span><span class="ident" id="3147610">countState</span><span class="op" id="3147620">.</span><span class="ident" id="3147621">b</span><span class="op" id="3147622">.</span><span class="ident" id="3147623">Bytes</span><span class="op" id="3147628">(</span><span class="op" id="3147629">)</span><span class="op" id="3147630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147633">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147653">_</span><span class="op" id="3147654">,</span>&nbsp;<span class="ident" id="3147656">err</span>&nbsp;<span class="op" id="3147660">:=</span>&nbsp;<span class="ident" id="3147663">w</span><span class="op" id="3147664">.</span><span class="ident" id="3147665">Write</span><span class="op" id="3147670">(</span><span class="ident" id="3147671">message</span><span class="op" id="3147678">[</span><span class="ident" id="3147679">offset</span><span class="op" id="3147685">:</span><span class="op" id="3147686">]</span><span class="op" id="3147687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3147690">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147781">b</span><span class="op" id="3147782">.</span><span class="ident" id="3147783">Reset</span><span class="op" id="3147788">(</span><span class="op" id="3147789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147792">b</span><span class="op" id="3147793">.</span><span class="ident" id="3147794">Write</span><span class="op" id="3147799">(</span><span class="ident" id="3147800">spaceForLength</span><span class="op" id="3147814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3147817">if</span>&nbsp;<span class="ident" id="3147820">err</span>&nbsp;<span class="op" id="3147824">!=</span>&nbsp;<span class="ident" id="3147827">nil</span>&nbsp;<span class="op" id="3147831">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3147835">enc</span><span class="op" id="3147838">.</span><span class="ident" id="3147839">setError</span><span class="op" id="3147847">(</span><span class="ident" id="3147848">err</span><span class="op" id="3147851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3147854">}</span><br>
<span class="lineno"></span><span class="op" id="3147856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3147859">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="3147941">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="3147967">func</span>&nbsp;<span class="op" id="3147972">(</span><span class="ident" id="3147973">enc</span>&nbsp;<span class="op" id="3147977">*</span><span class="ident" id="3147978">Encoder</span><span class="op" id="3147985">)</span>&nbsp;<span class="ident" id="3147987">sendActualType</span><span class="op" id="3148001">(</span><span class="ident" id="3148002">w</span>&nbsp;<span class="ident" id="3148004">io</span><span class="op" id="3148006">.</span><span class="ident" id="3148007">Writer</span><span class="op" id="3148013">,</span>&nbsp;<span class="ident" id="3148015">state</span>&nbsp;<span class="op" id="3148021">*</span><span class="ident" id="3148022">encoderState</span><span class="op" id="3148034">,</span>&nbsp;<span class="ident" id="3148036">ut</span>&nbsp;<span class="op" id="3148039">*</span><span class="ident" id="3148040">userTypeInfo</span><span class="op" id="3148052">,</span>&nbsp;<span class="ident" id="3148054">actual</span>&nbsp;<span class="ident" id="3148061">reflect</span><span class="op" id="3148068">.</span><span class="ident" id="3148069">Type</span><span class="op" id="3148073">)</span>&nbsp;<span class="op" id="3148075">(</span><span class="ident" id="3148076">sent</span>&nbsp;<span class="builtintype" id="3148081">bool</span><span class="op" id="3148085">)</span>&nbsp;<span class="op" id="3148087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148090">if</span>&nbsp;<span class="ident" id="3148093">_</span><span class="op" id="3148094">,</span>&nbsp;<span class="ident" id="3148096">alreadySent</span>&nbsp;<span class="op" id="3148108">:=</span>&nbsp;<span class="ident" id="3148111">enc</span><span class="op" id="3148114">.</span><span class="ident" id="3148115">sent</span><span class="op" id="3148119">[</span><span class="ident" id="3148120">actual</span><span class="op" id="3148126">]</span><span class="op" id="3148127">;</span>&nbsp;<span class="ident" id="3148129">alreadySent</span>&nbsp;<span class="op" id="3148141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148145">return</span>&nbsp;<span class="builtintype" id="3148152">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148159">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148162">info</span><span class="op" id="3148166">,</span>&nbsp;<span class="ident" id="3148168">err</span>&nbsp;<span class="op" id="3148172">:=</span>&nbsp;<span class="ident" id="3148175">getTypeInfo</span><span class="op" id="3148186">(</span><span class="ident" id="3148187">ut</span><span class="op" id="3148189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148192">if</span>&nbsp;<span class="ident" id="3148195">err</span>&nbsp;<span class="op" id="3148199">!=</span>&nbsp;<span class="ident" id="3148202">nil</span>&nbsp;<span class="op" id="3148206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148210">enc</span><span class="op" id="3148213">.</span><span class="ident" id="3148214">setError</span><span class="op" id="3148222">(</span><span class="ident" id="3148223">err</span><span class="op" id="3148226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148230">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148238">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148241">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148271">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148279">state</span><span class="op" id="3148284">.</span><span class="ident" id="3148285">encodeInt</span><span class="op" id="3148294">(</span><span class="op" id="3148295">-</span><span class="ident" id="3148296">int64</span><span class="op" id="3148301">(</span><span class="ident" id="3148302">info</span><span class="op" id="3148306">.</span><span class="ident" id="3148307">id</span><span class="op" id="3148309">)</span><span class="op" id="3148310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148313">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148323">enc</span><span class="op" id="3148326">.</span><span class="ident" id="3148327">encode</span><span class="op" id="3148333">(</span><span class="ident" id="3148334">state</span><span class="op" id="3148339">.</span><span class="ident" id="3148340">b</span><span class="op" id="3148341">,</span>&nbsp;<span class="ident" id="3148343">reflect</span><span class="op" id="3148350">.</span><span class="ident" id="3148351">ValueOf</span><span class="op" id="3148358">(</span><span class="ident" id="3148359">info</span><span class="op" id="3148363">.</span><span class="ident" id="3148364">wire</span><span class="op" id="3148368">)</span><span class="op" id="3148369">,</span>&nbsp;<span class="ident" id="3148371">wireTypeUserInfo</span><span class="op" id="3148387">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148390">enc</span><span class="op" id="3148393">.</span><span class="ident" id="3148394">writeMessage</span><span class="op" id="3148406">(</span><span class="ident" id="3148407">w</span><span class="op" id="3148408">,</span>&nbsp;<span class="ident" id="3148410">state</span><span class="op" id="3148415">.</span><span class="ident" id="3148416">b</span><span class="op" id="3148417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148420">if</span>&nbsp;<span class="ident" id="3148423">enc</span><span class="op" id="3148426">.</span><span class="ident" id="3148427">err</span>&nbsp;<span class="op" id="3148431">!=</span>&nbsp;<span class="ident" id="3148434">nil</span>&nbsp;<span class="op" id="3148438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148442">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148454">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148535">enc</span><span class="op" id="3148538">.</span><span class="ident" id="3148539">sent</span><span class="op" id="3148543">[</span><span class="ident" id="3148544">ut</span><span class="op" id="3148546">.</span><span class="ident" id="3148547">base</span><span class="op" id="3148551">]</span>&nbsp;<span class="op" id="3148553">=</span>&nbsp;<span class="ident" id="3148555">info</span><span class="op" id="3148559">.</span><span class="ident" id="3148560">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148564">if</span>&nbsp;<span class="ident" id="3148567">ut</span><span class="op" id="3148569">.</span><span class="ident" id="3148570">user</span>&nbsp;<span class="op" id="3148575">!=</span>&nbsp;<span class="ident" id="3148578">ut</span><span class="op" id="3148580">.</span><span class="ident" id="3148581">base</span>&nbsp;<span class="op" id="3148586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148590">enc</span><span class="op" id="3148593">.</span><span class="ident" id="3148594">sent</span><span class="op" id="3148598">[</span><span class="ident" id="3148599">ut</span><span class="op" id="3148601">.</span><span class="ident" id="3148602">user</span><span class="op" id="3148606">]</span>&nbsp;<span class="op" id="3148608">=</span>&nbsp;<span class="ident" id="3148610">info</span><span class="op" id="3148614">.</span><span class="ident" id="3148615">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148619">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3148622">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148651">switch</span>&nbsp;<span class="ident" id="3148658">st</span>&nbsp;<span class="op" id="3148661">:=</span>&nbsp;<span class="ident" id="3148664">actual</span><span class="op" id="3148670">;</span>&nbsp;<span class="ident" id="3148672">st</span><span class="op" id="3148674">.</span><span class="ident" id="3148675">Kind</span><span class="op" id="3148679">(</span><span class="op" id="3148680">)</span>&nbsp;<span class="op" id="3148682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148685">case</span>&nbsp;<span class="ident" id="3148690">reflect</span><span class="op" id="3148697">.</span><span class="ident" id="3148698">Struct</span><span class="op" id="3148704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148708">for</span>&nbsp;<span class="ident" id="3148712">i</span>&nbsp;<span class="op" id="3148714">:=</span>&nbsp;<span class="num" id="3148717">0</span><span class="op" id="3148718">;</span>&nbsp;<span class="ident" id="3148720">i</span>&nbsp;<span class="op" id="3148722">&lt;</span>&nbsp;<span class="ident" id="3148724">st</span><span class="op" id="3148726">.</span><span class="ident" id="3148727">NumField</span><span class="op" id="3148735">(</span><span class="op" id="3148736">)</span><span class="op" id="3148737">;</span>&nbsp;<span class="ident" id="3148739">i</span><span class="op" id="3148740">++</span>&nbsp;<span class="op" id="3148743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148748">if</span>&nbsp;<span class="ident" id="3148751">isExported</span><span class="op" id="3148761">(</span><span class="ident" id="3148762">st</span><span class="op" id="3148764">.</span><span class="ident" id="3148765">Field</span><span class="op" id="3148770">(</span><span class="ident" id="3148771">i</span><span class="op" id="3148772">)</span><span class="op" id="3148773">.</span><span class="ident" id="3148774">Name</span><span class="op" id="3148778">)</span>&nbsp;<span class="op" id="3148780">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148786">enc</span><span class="op" id="3148789">.</span><span class="ident" id="3148790">sendType</span><span class="op" id="3148798">(</span><span class="ident" id="3148799">w</span><span class="op" id="3148800">,</span>&nbsp;<span class="ident" id="3148802">state</span><span class="op" id="3148807">,</span>&nbsp;<span class="ident" id="3148809">st</span><span class="op" id="3148811">.</span><span class="ident" id="3148812">Field</span><span class="op" id="3148817">(</span><span class="ident" id="3148818">i</span><span class="op" id="3148819">)</span><span class="op" id="3148820">.</span><span class="ident" id="3148821">Type</span><span class="op" id="3148825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148837">case</span>&nbsp;<span class="ident" id="3148842">reflect</span><span class="op" id="3148849">.</span><span class="ident" id="3148850">Array</span><span class="op" id="3148855">,</span>&nbsp;<span class="ident" id="3148857">reflect</span><span class="op" id="3148864">.</span><span class="ident" id="3148865">Slice</span><span class="op" id="3148870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148874">enc</span><span class="op" id="3148877">.</span><span class="ident" id="3148878">sendType</span><span class="op" id="3148886">(</span><span class="ident" id="3148887">w</span><span class="op" id="3148888">,</span>&nbsp;<span class="ident" id="3148890">state</span><span class="op" id="3148895">,</span>&nbsp;<span class="ident" id="3148897">st</span><span class="op" id="3148899">.</span><span class="ident" id="3148900">Elem</span><span class="op" id="3148904">(</span><span class="op" id="3148905">)</span><span class="op" id="3148906">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3148909">case</span>&nbsp;<span class="ident" id="3148914">reflect</span><span class="op" id="3148921">.</span><span class="ident" id="3148922">Map</span><span class="op" id="3148925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148929">enc</span><span class="op" id="3148932">.</span><span class="ident" id="3148933">sendType</span><span class="op" id="3148941">(</span><span class="ident" id="3148942">w</span><span class="op" id="3148943">,</span>&nbsp;<span class="ident" id="3148945">state</span><span class="op" id="3148950">,</span>&nbsp;<span class="ident" id="3148952">st</span><span class="op" id="3148954">.</span><span class="ident" id="3148955">Key</span><span class="op" id="3148958">(</span><span class="op" id="3148959">)</span><span class="op" id="3148960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3148964">enc</span><span class="op" id="3148967">.</span><span class="ident" id="3148968">sendType</span><span class="op" id="3148976">(</span><span class="ident" id="3148977">w</span><span class="op" id="3148978">,</span>&nbsp;<span class="ident" id="3148980">state</span><span class="op" id="3148985">,</span>&nbsp;<span class="ident" id="3148987">st</span><span class="op" id="3148989">.</span><span class="ident" id="3148990">Elem</span><span class="op" id="3148994">(</span><span class="op" id="3148995">)</span><span class="op" id="3148996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3148999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149002">return</span>&nbsp;<span class="builtintype" id="3149009">true</span><br>
<span class="lineno">125</span><span class="op" id="3149014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3149017">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3149082">func</span>&nbsp;<span class="op" id="3149087">(</span><span class="ident" id="3149088">enc</span>&nbsp;<span class="op" id="3149092">*</span><span class="ident" id="3149093">Encoder</span><span class="op" id="3149100">)</span>&nbsp;<span class="ident" id="3149102">sendType</span><span class="op" id="3149110">(</span><span class="ident" id="3149111">w</span>&nbsp;<span class="ident" id="3149113">io</span><span class="op" id="3149115">.</span><span class="ident" id="3149116">Writer</span><span class="op" id="3149122">,</span>&nbsp;<span class="ident" id="3149124">state</span>&nbsp;<span class="op" id="3149130">*</span><span class="ident" id="3149131">encoderState</span><span class="op" id="3149143">,</span>&nbsp;<span class="ident" id="3149145">origt</span>&nbsp;<span class="ident" id="3149151">reflect</span><span class="op" id="3149158">.</span><span class="ident" id="3149159">Type</span><span class="op" id="3149163">)</span>&nbsp;<span class="op" id="3149165">(</span><span class="ident" id="3149166">sent</span>&nbsp;<span class="builtintype" id="3149171">bool</span><span class="op" id="3149175">)</span>&nbsp;<span class="op" id="3149177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3149180">ut</span>&nbsp;<span class="op" id="3149183">:=</span>&nbsp;<span class="ident" id="3149186">userType</span><span class="op" id="3149194">(</span><span class="ident" id="3149195">origt</span><span class="op" id="3149200">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149203">if</span>&nbsp;<span class="ident" id="3149206">ut</span><span class="op" id="3149208">.</span><span class="ident" id="3149209">externalEnc</span>&nbsp;<span class="op" id="3149221">!=</span>&nbsp;<span class="num" id="3149224">0</span>&nbsp;<span class="op" id="3149226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149230">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149312">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149384">return</span>&nbsp;<span class="ident" id="3149391">enc</span><span class="op" id="3149394">.</span><span class="ident" id="3149395">sendActualType</span><span class="op" id="3149409">(</span><span class="ident" id="3149410">w</span><span class="op" id="3149411">,</span>&nbsp;<span class="ident" id="3149413">state</span><span class="op" id="3149418">,</span>&nbsp;<span class="ident" id="3149420">ut</span><span class="op" id="3149422">,</span>&nbsp;<span class="ident" id="3149424">ut</span><span class="op" id="3149426">.</span><span class="ident" id="3149427">base</span><span class="op" id="3149431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149434">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149438">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149497">switch</span>&nbsp;<span class="ident" id="3149504">rt</span>&nbsp;<span class="op" id="3149507">:=</span>&nbsp;<span class="ident" id="3149510">ut</span><span class="op" id="3149512">.</span><span class="ident" id="3149513">base</span><span class="op" id="3149517">;</span>&nbsp;<span class="ident" id="3149519">rt</span><span class="op" id="3149521">.</span><span class="ident" id="3149522">Kind</span><span class="op" id="3149526">(</span><span class="op" id="3149527">)</span>&nbsp;<span class="op" id="3149529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149532">default</span><span class="op" id="3149539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149543">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149604">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149612">case</span>&nbsp;<span class="ident" id="3149617">reflect</span><span class="op" id="3149624">.</span><span class="ident" id="3149625">Slice</span><span class="op" id="3149630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149634">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149691">if</span>&nbsp;<span class="ident" id="3149694">rt</span><span class="op" id="3149696">.</span><span class="ident" id="3149697">Elem</span><span class="op" id="3149701">(</span><span class="op" id="3149702">)</span><span class="op" id="3149703">.</span><span class="ident" id="3149704">Kind</span><span class="op" id="3149708">(</span><span class="op" id="3149709">)</span>&nbsp;<span class="op" id="3149711">==</span>&nbsp;<span class="ident" id="3149714">reflect</span><span class="op" id="3149721">.</span><span class="ident" id="3149722">Uint8</span>&nbsp;<span class="op" id="3149728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149733">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3149742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149746">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149773">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149780">case</span>&nbsp;<span class="ident" id="3149785">reflect</span><span class="op" id="3149792">.</span><span class="ident" id="3149793">Array</span><span class="op" id="3149798">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149802">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149871">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149878">case</span>&nbsp;<span class="ident" id="3149883">reflect</span><span class="op" id="3149890">.</span><span class="ident" id="3149891">Map</span><span class="op" id="3149894">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149898">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149967">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3149974">case</span>&nbsp;<span class="ident" id="3149979">reflect</span><span class="op" id="3149986">.</span><span class="ident" id="3149987">Struct</span><span class="op" id="3149993">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3149997">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150048">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150055">case</span>&nbsp;<span class="ident" id="3150060">reflect</span><span class="op" id="3150067">.</span><span class="ident" id="3150068">Chan</span><span class="op" id="3150072">,</span>&nbsp;<span class="ident" id="3150074">reflect</span><span class="op" id="3150081">.</span><span class="ident" id="3150082">Func</span><span class="op" id="3150086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150090">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150148">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150160">return</span>&nbsp;<span class="ident" id="3150167">enc</span><span class="op" id="3150170">.</span><span class="ident" id="3150171">sendActualType</span><span class="op" id="3150185">(</span><span class="ident" id="3150186">w</span><span class="op" id="3150187">,</span>&nbsp;<span class="ident" id="3150189">state</span><span class="op" id="3150194">,</span>&nbsp;<span class="ident" id="3150196">ut</span><span class="op" id="3150198">,</span>&nbsp;<span class="ident" id="3150200">ut</span><span class="op" id="3150202">.</span><span class="ident" id="3150203">base</span><span class="op" id="3150207">)</span><br>
<span class="lineno"></span><span class="op" id="3150209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3150212">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="3150288">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="3150368">func</span>&nbsp;<span class="op" id="3150373">(</span><span class="ident" id="3150374">enc</span>&nbsp;<span class="op" id="3150378">*</span><span class="ident" id="3150379">Encoder</span><span class="op" id="3150386">)</span>&nbsp;<span class="ident" id="3150388">Encode</span><span class="op" id="3150394">(</span><span class="ident" id="3150395">e</span>&nbsp;<span class="keyword" id="3150397">interface</span><span class="op" id="3150406">{</span><span class="op" id="3150407">}</span><span class="op" id="3150408">)</span>&nbsp;<span class="builtintype" id="3150410">error</span>&nbsp;<span class="op" id="3150416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150419">return</span>&nbsp;<span class="ident" id="3150426">enc</span><span class="op" id="3150429">.</span><span class="ident" id="3150430">EncodeValue</span><span class="op" id="3150441">(</span><span class="ident" id="3150442">reflect</span><span class="op" id="3150449">.</span><span class="ident" id="3150450">ValueOf</span><span class="op" id="3150457">(</span><span class="ident" id="3150458">e</span><span class="op" id="3150459">)</span><span class="op" id="3150460">)</span><br>
<span class="lineno"></span><span class="op" id="3150462">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="3150465">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3150537">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="3150610">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="3150619">func</span>&nbsp;<span class="op" id="3150624">(</span><span class="ident" id="3150625">enc</span>&nbsp;<span class="op" id="3150629">*</span><span class="ident" id="3150630">Encoder</span><span class="op" id="3150637">)</span>&nbsp;<span class="ident" id="3150639">sendTypeDescriptor</span><span class="op" id="3150657">(</span><span class="ident" id="3150658">w</span>&nbsp;<span class="ident" id="3150660">io</span><span class="op" id="3150662">.</span><span class="ident" id="3150663">Writer</span><span class="op" id="3150669">,</span>&nbsp;<span class="ident" id="3150671">state</span>&nbsp;<span class="op" id="3150677">*</span><span class="ident" id="3150678">encoderState</span><span class="op" id="3150690">,</span>&nbsp;<span class="ident" id="3150692">ut</span>&nbsp;<span class="op" id="3150695">*</span><span class="ident" id="3150696">userTypeInfo</span><span class="op" id="3150708">)</span>&nbsp;<span class="op" id="3150710">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150713">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150764">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150807">rt</span>&nbsp;<span class="op" id="3150810">:=</span>&nbsp;<span class="ident" id="3150813">ut</span><span class="op" id="3150815">.</span><span class="ident" id="3150816">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150822">if</span>&nbsp;<span class="ident" id="3150825">ut</span><span class="op" id="3150827">.</span><span class="ident" id="3150828">externalEnc</span>&nbsp;<span class="op" id="3150840">!=</span>&nbsp;<span class="num" id="3150843">0</span>&nbsp;<span class="op" id="3150845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150849">rt</span>&nbsp;<span class="op" id="3150852">=</span>&nbsp;<span class="ident" id="3150854">ut</span><span class="op" id="3150856">.</span><span class="ident" id="3150857">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3150863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150866">if</span>&nbsp;<span class="ident" id="3150869">_</span><span class="op" id="3150870">,</span>&nbsp;<span class="ident" id="3150872">alreadySent</span>&nbsp;<span class="op" id="3150884">:=</span>&nbsp;<span class="ident" id="3150887">enc</span><span class="op" id="3150890">.</span><span class="ident" id="3150891">sent</span><span class="op" id="3150895">[</span><span class="ident" id="3150896">rt</span><span class="op" id="3150898">]</span><span class="op" id="3150899">;</span>&nbsp;<span class="op" id="3150901">!</span><span class="ident" id="3150902">alreadySent</span>&nbsp;<span class="op" id="3150914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3150918">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3150939">sent</span>&nbsp;<span class="op" id="3150944">:=</span>&nbsp;<span class="ident" id="3150947">enc</span><span class="op" id="3150950">.</span><span class="ident" id="3150951">sendType</span><span class="op" id="3150959">(</span><span class="ident" id="3150960">w</span><span class="op" id="3150961">,</span>&nbsp;<span class="ident" id="3150963">state</span><span class="op" id="3150968">,</span>&nbsp;<span class="ident" id="3150970">rt</span><span class="op" id="3150972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150976">if</span>&nbsp;<span class="ident" id="3150979">enc</span><span class="op" id="3150982">.</span><span class="ident" id="3150983">err</span>&nbsp;<span class="op" id="3150987">!=</span>&nbsp;<span class="ident" id="3150990">nil</span>&nbsp;<span class="op" id="3150994">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3150999">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151012">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151083">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151154">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151221">if</span>&nbsp;<span class="op" id="3151224">!</span><span class="ident" id="3151225">sent</span>&nbsp;<span class="op" id="3151230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151235">info</span><span class="op" id="3151239">,</span>&nbsp;<span class="ident" id="3151241">err</span>&nbsp;<span class="op" id="3151245">:=</span>&nbsp;<span class="ident" id="3151248">getTypeInfo</span><span class="op" id="3151259">(</span><span class="ident" id="3151260">ut</span><span class="op" id="3151262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151267">if</span>&nbsp;<span class="ident" id="3151270">err</span>&nbsp;<span class="op" id="3151274">!=</span>&nbsp;<span class="ident" id="3151277">nil</span>&nbsp;<span class="op" id="3151281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151287">enc</span><span class="op" id="3151290">.</span><span class="ident" id="3151291">setError</span><span class="op" id="3151299">(</span><span class="ident" id="3151300">err</span><span class="op" id="3151303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151309">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151324">enc</span><span class="op" id="3151327">.</span><span class="ident" id="3151328">sent</span><span class="op" id="3151332">[</span><span class="ident" id="3151333">rt</span><span class="op" id="3151335">]</span>&nbsp;<span class="op" id="3151337">=</span>&nbsp;<span class="ident" id="3151339">info</span><span class="op" id="3151343">.</span><span class="ident" id="3151344">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3151352">}</span><br>
<span class="lineno"></span><span class="op" id="3151354">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3151357">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3151423">func</span>&nbsp;<span class="op" id="3151428">(</span><span class="ident" id="3151429">enc</span>&nbsp;<span class="op" id="3151433">*</span><span class="ident" id="3151434">Encoder</span><span class="op" id="3151441">)</span>&nbsp;<span class="ident" id="3151443">sendTypeId</span><span class="op" id="3151453">(</span><span class="ident" id="3151454">state</span>&nbsp;<span class="op" id="3151460">*</span><span class="ident" id="3151461">encoderState</span><span class="op" id="3151473">,</span>&nbsp;<span class="ident" id="3151475">ut</span>&nbsp;<span class="op" id="3151478">*</span><span class="ident" id="3151479">userTypeInfo</span><span class="op" id="3151491">)</span>&nbsp;<span class="op" id="3151493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151496">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3151543">state</span><span class="op" id="3151548">.</span><span class="ident" id="3151549">encodeInt</span><span class="op" id="3151558">(</span><span class="ident" id="3151559">int64</span><span class="op" id="3151564">(</span><span class="ident" id="3151565">enc</span><span class="op" id="3151568">.</span><span class="ident" id="3151569">sent</span><span class="op" id="3151573">[</span><span class="ident" id="3151574">ut</span><span class="op" id="3151576">.</span><span class="ident" id="3151577">base</span><span class="op" id="3151581">]</span><span class="op" id="3151582">)</span><span class="op" id="3151583">)</span><br>
<span class="lineno">205</span><span class="op" id="3151585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3151588">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="3151664">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="3151744">func</span>&nbsp;<span class="op" id="3151749">(</span><span class="ident" id="3151750">enc</span>&nbsp;<span class="op" id="3151754">*</span><span class="ident" id="3151755">Encoder</span><span class="op" id="3151762">)</span>&nbsp;<span class="ident" id="3151764">EncodeValue</span><span class="op" id="3151775">(</span><span class="ident" id="3151776">value</span>&nbsp;<span class="ident" id="3151782">reflect</span><span class="op" id="3151789">.</span><span class="ident" id="3151790">Value</span><span class="op" id="3151795">)</span>&nbsp;<span class="builtintype" id="3151797">error</span>&nbsp;<span class="op" id="3151803">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151806">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3151873">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3151902">if</span>&nbsp;<span class="ident" id="3151905">value</span><span class="op" id="3151910">.</span><span class="ident" id="3151911">Kind</span><span class="op" id="3151915">(</span><span class="op" id="3151916">)</span>&nbsp;<span class="op" id="3151918">==</span>&nbsp;<span class="ident" id="3151921">reflect</span><span class="op" id="3151928">.</span><span class="ident" id="3151929">Ptr</span>&nbsp;<span class="op" id="3151933">&amp;&amp;</span>&nbsp;<span class="ident" id="3151936">value</span><span class="op" id="3151941">.</span><span class="ident" id="3151942">IsNil</span><span class="op" id="3151947">(</span><span class="op" id="3151948">)</span>&nbsp;<span class="op" id="3151950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3151954">panic</span><span class="op" id="3151959">(</span><span class="string" id="3151960">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3152002">+</span>&nbsp;<span class="ident" id="3152004">value</span><span class="op" id="3152009">.</span><span class="ident" id="3152010">Type</span><span class="op" id="3152014">(</span><span class="op" id="3152015">)</span><span class="op" id="3152016">.</span><span class="ident" id="3152017">String</span><span class="op" id="3152023">(</span><span class="op" id="3152024">)</span><span class="op" id="3152025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152028">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152032">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152094">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152131">enc</span><span class="op" id="3152134">.</span><span class="ident" id="3152135">mutex</span><span class="op" id="3152140">.</span><span class="ident" id="3152141">Lock</span><span class="op" id="3152145">(</span><span class="op" id="3152146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152149">defer</span>&nbsp;<span class="ident" id="3152155">enc</span><span class="op" id="3152158">.</span><span class="ident" id="3152159">mutex</span><span class="op" id="3152164">.</span><span class="ident" id="3152165">Unlock</span><span class="op" id="3152171">(</span><span class="op" id="3152172">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152176">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152240">enc</span><span class="op" id="3152243">.</span><span class="ident" id="3152244">w</span>&nbsp;<span class="op" id="3152246">=</span>&nbsp;<span class="ident" id="3152248">enc</span><span class="op" id="3152251">.</span><span class="ident" id="3152252">w</span><span class="op" id="3152253">[</span><span class="num" id="3152254">0</span><span class="op" id="3152255">:</span><span class="num" id="3152256">1</span><span class="op" id="3152257">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152261">ut</span><span class="op" id="3152263">,</span>&nbsp;<span class="ident" id="3152265">err</span>&nbsp;<span class="op" id="3152269">:=</span>&nbsp;<span class="ident" id="3152272">validUserType</span><span class="op" id="3152285">(</span><span class="ident" id="3152286">value</span><span class="op" id="3152291">.</span><span class="ident" id="3152292">Type</span><span class="op" id="3152296">(</span><span class="op" id="3152297">)</span><span class="op" id="3152298">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152301">if</span>&nbsp;<span class="ident" id="3152304">err</span>&nbsp;<span class="op" id="3152308">!=</span>&nbsp;<span class="ident" id="3152311">nil</span>&nbsp;<span class="op" id="3152315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152319">return</span>&nbsp;<span class="ident" id="3152326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152335">enc</span><span class="op" id="3152338">.</span><span class="ident" id="3152339">err</span>&nbsp;<span class="op" id="3152343">=</span>&nbsp;<span class="ident" id="3152345">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152350">enc</span><span class="op" id="3152353">.</span><span class="ident" id="3152354">byteBuf</span><span class="op" id="3152361">.</span><span class="ident" id="3152362">Reset</span><span class="op" id="3152367">(</span><span class="op" id="3152368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152371">enc</span><span class="op" id="3152374">.</span><span class="ident" id="3152375">byteBuf</span><span class="op" id="3152382">.</span><span class="ident" id="3152383">Write</span><span class="op" id="3152388">(</span><span class="ident" id="3152389">spaceForLength</span><span class="op" id="3152403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152406">state</span>&nbsp;<span class="op" id="3152412">:=</span>&nbsp;<span class="ident" id="3152415">enc</span><span class="op" id="3152418">.</span><span class="ident" id="3152419">newEncoderState</span><span class="op" id="3152434">(</span><span class="op" id="3152435">&amp;</span><span class="ident" id="3152436">enc</span><span class="op" id="3152439">.</span><span class="ident" id="3152440">byteBuf</span><span class="op" id="3152447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152451">enc</span><span class="op" id="3152454">.</span><span class="ident" id="3152455">sendTypeDescriptor</span><span class="op" id="3152473">(</span><span class="ident" id="3152474">enc</span><span class="op" id="3152477">.</span><span class="ident" id="3152478">writer</span><span class="op" id="3152484">(</span><span class="op" id="3152485">)</span><span class="op" id="3152486">,</span>&nbsp;<span class="ident" id="3152488">state</span><span class="op" id="3152493">,</span>&nbsp;<span class="ident" id="3152495">ut</span><span class="op" id="3152497">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152500">enc</span><span class="op" id="3152503">.</span><span class="ident" id="3152504">sendTypeId</span><span class="op" id="3152514">(</span><span class="ident" id="3152515">state</span><span class="op" id="3152520">,</span>&nbsp;<span class="ident" id="3152522">ut</span><span class="op" id="3152524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152527">if</span>&nbsp;<span class="ident" id="3152530">enc</span><span class="op" id="3152533">.</span><span class="ident" id="3152534">err</span>&nbsp;<span class="op" id="3152538">!=</span>&nbsp;<span class="ident" id="3152541">nil</span>&nbsp;<span class="op" id="3152545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152549">return</span>&nbsp;<span class="ident" id="3152556">enc</span><span class="op" id="3152559">.</span><span class="ident" id="3152560">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3152569">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152592">enc</span><span class="op" id="3152595">.</span><span class="ident" id="3152596">encode</span><span class="op" id="3152602">(</span><span class="ident" id="3152603">state</span><span class="op" id="3152608">.</span><span class="ident" id="3152609">b</span><span class="op" id="3152610">,</span>&nbsp;<span class="ident" id="3152612">value</span><span class="op" id="3152617">,</span>&nbsp;<span class="ident" id="3152619">ut</span><span class="op" id="3152621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152624">if</span>&nbsp;<span class="ident" id="3152627">enc</span><span class="op" id="3152630">.</span><span class="ident" id="3152631">err</span>&nbsp;<span class="op" id="3152635">==</span>&nbsp;<span class="ident" id="3152638">nil</span>&nbsp;<span class="op" id="3152642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152646">enc</span><span class="op" id="3152649">.</span><span class="ident" id="3152650">writeMessage</span><span class="op" id="3152662">(</span><span class="ident" id="3152663">enc</span><span class="op" id="3152666">.</span><span class="ident" id="3152667">writer</span><span class="op" id="3152673">(</span><span class="op" id="3152674">)</span><span class="op" id="3152675">,</span>&nbsp;<span class="ident" id="3152677">state</span><span class="op" id="3152682">.</span><span class="ident" id="3152683">b</span><span class="op" id="3152684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3152687">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3152691">enc</span><span class="op" id="3152694">.</span><span class="ident" id="3152695">freeEncoderState</span><span class="op" id="3152711">(</span><span class="ident" id="3152712">state</span><span class="op" id="3152717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3152720">return</span>&nbsp;<span class="ident" id="3152727">enc</span><span class="op" id="3152730">.</span><span class="ident" id="3152731">err</span><br>
<span class="lineno"></span><span class="op" id="3152735">}</span>
</div>
</body>
</html>
