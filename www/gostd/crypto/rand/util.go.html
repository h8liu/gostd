<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4836354">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4836410">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4836464">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4836515">package</span>&nbsp;<span class="ident" id="4836523">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4836529">import</span>&nbsp;<span class="op" id="4836536">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4836539">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4836549">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4836555">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4836566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4836569">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="4836644">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="4836721">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="4836800">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4836879">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="4836903">var</span>&nbsp;<span class="ident" id="4836907">smallPrimes</span>&nbsp;<span class="op" id="4836919">=</span>&nbsp;<span class="op" id="4836921">[</span><span class="op" id="4836922">]</span><span class="builtintype" id="4836923">uint8</span><span class="op" id="4836928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4836931">3</span><span class="op" id="4836932">,</span>&nbsp;<span class="num" id="4836934">5</span><span class="op" id="4836935">,</span>&nbsp;<span class="num" id="4836937">7</span><span class="op" id="4836938">,</span>&nbsp;<span class="num" id="4836940">11</span><span class="op" id="4836942">,</span>&nbsp;<span class="num" id="4836944">13</span><span class="op" id="4836946">,</span>&nbsp;<span class="num" id="4836948">17</span><span class="op" id="4836950">,</span>&nbsp;<span class="num" id="4836952">19</span><span class="op" id="4836954">,</span>&nbsp;<span class="num" id="4836956">23</span><span class="op" id="4836958">,</span>&nbsp;<span class="num" id="4836960">29</span><span class="op" id="4836962">,</span>&nbsp;<span class="num" id="4836964">31</span><span class="op" id="4836966">,</span>&nbsp;<span class="num" id="4836968">37</span><span class="op" id="4836970">,</span>&nbsp;<span class="num" id="4836972">41</span><span class="op" id="4836974">,</span>&nbsp;<span class="num" id="4836976">43</span><span class="op" id="4836978">,</span>&nbsp;<span class="num" id="4836980">47</span><span class="op" id="4836982">,</span>&nbsp;<span class="num" id="4836984">53</span><span class="op" id="4836986">,</span><br>
<span class="lineno">20</span><span class="op" id="4836988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4836991">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="4837071">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4837149">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="4837219">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="4837234">var</span>&nbsp;<span class="ident" id="4837238">smallPrimesProduct</span>&nbsp;<span class="op" id="4837257">=</span>&nbsp;<span class="builtinfunc" id="4837259">new</span><span class="op" id="4837262">(</span><span class="ident" id="4837263">big</span><span class="op" id="4837266">.</span><span class="ident" id="4837267">Int</span><span class="op" id="4837270">)</span><span class="op" id="4837271">.</span><span class="ident" id="4837272">SetUint64</span><span class="op" id="4837281">(</span><span class="num" id="4837282">16294579238595022365</span><span class="op" id="4837302">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4837305">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="4837375">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="4837401">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="4837480">func</span>&nbsp;<span class="ident" id="4837485">Prime</span><span class="op" id="4837490">(</span><span class="ident" id="4837491">rand</span>&nbsp;<span class="ident" id="4837496">io</span><span class="op" id="4837498">.</span><span class="ident" id="4837499">Reader</span><span class="op" id="4837505">,</span>&nbsp;<span class="ident" id="4837507">bits</span>&nbsp;<span class="builtintype" id="4837512">int</span><span class="op" id="4837515">)</span>&nbsp;<span class="op" id="4837517">(</span><span class="ident" id="4837518">p</span>&nbsp;<span class="op" id="4837520">*</span><span class="ident" id="4837521">big</span><span class="op" id="4837524">.</span><span class="ident" id="4837525">Int</span><span class="op" id="4837528">,</span>&nbsp;<span class="ident" id="4837530">err</span>&nbsp;<span class="builtintype" id="4837534">error</span><span class="op" id="4837539">)</span>&nbsp;<span class="op" id="4837541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837544">if</span>&nbsp;<span class="ident" id="4837547">bits</span>&nbsp;<span class="op" id="4837552">&lt;</span>&nbsp;<span class="num" id="4837554">2</span>&nbsp;<span class="op" id="4837556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837560">err</span>&nbsp;<span class="op" id="4837564">=</span>&nbsp;<span class="ident" id="4837566">errors</span><span class="op" id="4837572">.</span><span class="ident" id="4837573">New</span><span class="op" id="4837576">(</span><span class="string" id="4837577">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="4837625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837629">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837641">b</span>&nbsp;<span class="op" id="4837643">:=</span>&nbsp;<span class="builtintype" id="4837646">uint</span><span class="op" id="4837650">(</span><span class="ident" id="4837651">bits</span>&nbsp;<span class="op" id="4837656">%</span>&nbsp;<span class="num" id="4837658">8</span><span class="op" id="4837659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837662">if</span>&nbsp;<span class="ident" id="4837665">b</span>&nbsp;<span class="op" id="4837667">==</span>&nbsp;<span class="num" id="4837670">0</span>&nbsp;<span class="op" id="4837672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837676">b</span>&nbsp;<span class="op" id="4837678">=</span>&nbsp;<span class="num" id="4837680">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837687">bytes</span>&nbsp;<span class="op" id="4837693">:=</span>&nbsp;<span class="builtinfunc" id="4837696">make</span><span class="op" id="4837700">(</span><span class="op" id="4837701">[</span><span class="op" id="4837702">]</span><span class="builtintype" id="4837703">byte</span><span class="op" id="4837707">,</span>&nbsp;<span class="op" id="4837709">(</span><span class="ident" id="4837710">bits</span><span class="op" id="4837714">+</span><span class="num" id="4837715">7</span><span class="op" id="4837716">)</span><span class="op" id="4837717">/</span><span class="num" id="4837718">8</span><span class="op" id="4837719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837722">p</span>&nbsp;<span class="op" id="4837724">=</span>&nbsp;<span class="builtinfunc" id="4837726">new</span><span class="op" id="4837729">(</span><span class="ident" id="4837730">big</span><span class="op" id="4837733">.</span><span class="ident" id="4837734">Int</span><span class="op" id="4837737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837741">bigMod</span>&nbsp;<span class="op" id="4837748">:=</span>&nbsp;<span class="builtinfunc" id="4837751">new</span><span class="op" id="4837754">(</span><span class="ident" id="4837755">big</span><span class="op" id="4837758">.</span><span class="ident" id="4837759">Int</span><span class="op" id="4837762">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837766">for</span>&nbsp;<span class="op" id="4837770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837774">_</span><span class="op" id="4837775">,</span>&nbsp;<span class="ident" id="4837777">err</span>&nbsp;<span class="op" id="4837781">=</span>&nbsp;<span class="ident" id="4837783">io</span><span class="op" id="4837785">.</span><span class="ident" id="4837786">ReadFull</span><span class="op" id="4837794">(</span><span class="ident" id="4837795">rand</span><span class="op" id="4837799">,</span>&nbsp;<span class="ident" id="4837801">bytes</span><span class="op" id="4837806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837810">if</span>&nbsp;<span class="ident" id="4837813">err</span>&nbsp;<span class="op" id="4837817">!=</span>&nbsp;<span class="ident" id="4837820">nil</span>&nbsp;<span class="op" id="4837824">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837829">return</span>&nbsp;<span class="ident" id="4837836">nil</span><span class="op" id="4837839">,</span>&nbsp;<span class="ident" id="4837841">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837852">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837933">bytes</span><span class="op" id="4837938">[</span><span class="num" id="4837939">0</span><span class="op" id="4837940">]</span>&nbsp;<span class="op" id="4837942">&amp;=</span>&nbsp;<span class="builtintype" id="4837945">uint8</span><span class="op" id="4837950">(</span><span class="builtintype" id="4837951">int</span><span class="op" id="4837954">(</span><span class="num" id="4837955">1</span><span class="op" id="4837956">&lt;&lt;</span><span class="ident" id="4837958">b</span><span class="op" id="4837959">)</span>&nbsp;<span class="op" id="4837961">-</span>&nbsp;<span class="num" id="4837963">1</span><span class="op" id="4837964">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4837968">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838047">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838108">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838174">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838216">if</span>&nbsp;<span class="ident" id="4838219">b</span>&nbsp;<span class="op" id="4838221">&gt;=</span>&nbsp;<span class="num" id="4838224">2</span>&nbsp;<span class="op" id="4838226">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838231">bytes</span><span class="op" id="4838236">[</span><span class="num" id="4838237">0</span><span class="op" id="4838238">]</span>&nbsp;<span class="op" id="4838240">|=</span>&nbsp;<span class="num" id="4838243">3</span>&nbsp;<span class="op" id="4838245">&lt;&lt;</span>&nbsp;<span class="op" id="4838248">(</span><span class="ident" id="4838249">b</span>&nbsp;<span class="op" id="4838251">-</span>&nbsp;<span class="num" id="4838253">2</span><span class="op" id="4838254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838258">}</span>&nbsp;<span class="keyword" id="4838260">else</span>&nbsp;<span class="op" id="4838265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838270">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838313">bytes</span><span class="op" id="4838318">[</span><span class="num" id="4838319">0</span><span class="op" id="4838320">]</span>&nbsp;<span class="op" id="4838322">|=</span>&nbsp;<span class="num" id="4838325">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838330">if</span>&nbsp;<span class="builtinfunc" id="4838333">len</span><span class="op" id="4838336">(</span><span class="ident" id="4838337">bytes</span><span class="op" id="4838342">)</span>&nbsp;<span class="op" id="4838344">&gt;</span>&nbsp;<span class="num" id="4838346">1</span>&nbsp;<span class="op" id="4838348">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838354">bytes</span><span class="op" id="4838359">[</span><span class="num" id="4838360">1</span><span class="op" id="4838361">]</span>&nbsp;<span class="op" id="4838363">|=</span>&nbsp;<span class="num" id="4838366">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838382">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838461">bytes</span><span class="op" id="4838466">[</span><span class="builtinfunc" id="4838467">len</span><span class="op" id="4838470">(</span><span class="ident" id="4838471">bytes</span><span class="op" id="4838476">)</span><span class="op" id="4838477">-</span><span class="num" id="4838478">1</span><span class="op" id="4838479">]</span>&nbsp;<span class="op" id="4838481">|=</span>&nbsp;<span class="num" id="4838484">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838489">p</span><span class="op" id="4838490">.</span><span class="ident" id="4838491">SetBytes</span><span class="op" id="4838499">(</span><span class="ident" id="4838500">bytes</span><span class="op" id="4838505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838510">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838576">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838642">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4838708">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838772">bigMod</span><span class="op" id="4838778">.</span><span class="ident" id="4838779">Mod</span><span class="op" id="4838782">(</span><span class="ident" id="4838783">p</span><span class="op" id="4838784">,</span>&nbsp;<span class="ident" id="4838786">smallPrimesProduct</span><span class="op" id="4838804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838808">mod</span>&nbsp;<span class="op" id="4838812">:=</span>&nbsp;<span class="ident" id="4838815">bigMod</span><span class="op" id="4838821">.</span><span class="ident" id="4838822">Uint64</span><span class="op" id="4838828">(</span><span class="op" id="4838829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838833">NextDelta</span><span class="op" id="4838842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838846">for</span>&nbsp;<span class="ident" id="4838850">delta</span>&nbsp;<span class="op" id="4838856">:=</span>&nbsp;<span class="ident" id="4838859">uint64</span><span class="op" id="4838865">(</span><span class="num" id="4838866">0</span><span class="op" id="4838867">)</span><span class="op" id="4838868">;</span>&nbsp;<span class="ident" id="4838870">delta</span>&nbsp;<span class="op" id="4838876">&lt;</span>&nbsp;<span class="num" id="4838878">1</span><span class="op" id="4838879">&lt;&lt;</span><span class="num" id="4838881">20</span><span class="op" id="4838883">;</span>&nbsp;<span class="ident" id="4838885">delta</span>&nbsp;<span class="op" id="4838891">+=</span>&nbsp;<span class="num" id="4838894">2</span>&nbsp;<span class="op" id="4838896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838901">m</span>&nbsp;<span class="op" id="4838903">:=</span>&nbsp;<span class="ident" id="4838906">mod</span>&nbsp;<span class="op" id="4838910">+</span>&nbsp;<span class="ident" id="4838912">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838921">for</span>&nbsp;<span class="ident" id="4838925">_</span><span class="op" id="4838926">,</span>&nbsp;<span class="ident" id="4838928">prime</span>&nbsp;<span class="op" id="4838934">:=</span>&nbsp;<span class="keyword" id="4838937">range</span>&nbsp;<span class="ident" id="4838943">smallPrimes</span>&nbsp;<span class="op" id="4838955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838961">if</span>&nbsp;<span class="ident" id="4838964">m</span><span class="op" id="4838965">%</span><span class="ident" id="4838966">uint64</span><span class="op" id="4838972">(</span><span class="ident" id="4838973">prime</span><span class="op" id="4838978">)</span>&nbsp;<span class="op" id="4838980">==</span>&nbsp;<span class="num" id="4838983">0</span>&nbsp;<span class="op" id="4838985">&amp;&amp;</span>&nbsp;<span class="op" id="4838988">(</span><span class="ident" id="4838989">bits</span>&nbsp;<span class="op" id="4838994">&gt;</span>&nbsp;<span class="num" id="4838996">6</span>&nbsp;<span class="op" id="4838998">||</span>&nbsp;<span class="ident" id="4839001">m</span>&nbsp;<span class="op" id="4839003">!=</span>&nbsp;<span class="ident" id="4839006">uint64</span><span class="op" id="4839012">(</span><span class="ident" id="4839013">prime</span><span class="op" id="4839018">)</span><span class="op" id="4839019">)</span>&nbsp;<span class="op" id="4839021">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839028">continue</span>&nbsp;<span class="ident" id="4839037">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839062">if</span>&nbsp;<span class="ident" id="4839065">delta</span>&nbsp;<span class="op" id="4839071">&gt;</span>&nbsp;<span class="num" id="4839073">0</span>&nbsp;<span class="op" id="4839075">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839081">bigMod</span><span class="op" id="4839087">.</span><span class="ident" id="4839088">SetUint64</span><span class="op" id="4839097">(</span><span class="ident" id="4839098">delta</span><span class="op" id="4839103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839109">p</span><span class="op" id="4839110">.</span><span class="ident" id="4839111">Add</span><span class="op" id="4839114">(</span><span class="ident" id="4839115">p</span><span class="op" id="4839116">,</span>&nbsp;<span class="ident" id="4839118">bigMod</span><span class="op" id="4839124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839134">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839142">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839147">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839213">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839274">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839285">if</span>&nbsp;<span class="ident" id="4839288">p</span><span class="op" id="4839289">.</span><span class="ident" id="4839290">ProbablyPrime</span><span class="op" id="4839303">(</span><span class="num" id="4839304">20</span><span class="op" id="4839306">)</span>&nbsp;<span class="op" id="4839308">&amp;&amp;</span>&nbsp;<span class="ident" id="4839311">p</span><span class="op" id="4839312">.</span><span class="ident" id="4839313">BitLen</span><span class="op" id="4839319">(</span><span class="op" id="4839320">)</span>&nbsp;<span class="op" id="4839322">==</span>&nbsp;<span class="ident" id="4839325">bits</span>&nbsp;<span class="op" id="4839330">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839335">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839347">}</span><br>
<span class="lineno"></span><span class="op" id="4839349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4839352">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4839426">func</span>&nbsp;<span class="ident" id="4839431">Int</span><span class="op" id="4839434">(</span><span class="ident" id="4839435">rand</span>&nbsp;<span class="ident" id="4839440">io</span><span class="op" id="4839442">.</span><span class="ident" id="4839443">Reader</span><span class="op" id="4839449">,</span>&nbsp;<span class="ident" id="4839451">max</span>&nbsp;<span class="op" id="4839455">*</span><span class="ident" id="4839456">big</span><span class="op" id="4839459">.</span><span class="ident" id="4839460">Int</span><span class="op" id="4839463">)</span>&nbsp;<span class="op" id="4839465">(</span><span class="ident" id="4839466">n</span>&nbsp;<span class="op" id="4839468">*</span><span class="ident" id="4839469">big</span><span class="op" id="4839472">.</span><span class="ident" id="4839473">Int</span><span class="op" id="4839476">,</span>&nbsp;<span class="ident" id="4839478">err</span>&nbsp;<span class="builtintype" id="4839482">error</span><span class="op" id="4839487">)</span>&nbsp;<span class="op" id="4839489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839492">if</span>&nbsp;<span class="ident" id="4839495">max</span><span class="op" id="4839498">.</span><span class="ident" id="4839499">Sign</span><span class="op" id="4839503">(</span><span class="op" id="4839504">)</span>&nbsp;<span class="op" id="4839506">&lt;=</span>&nbsp;<span class="num" id="4839509">0</span>&nbsp;<span class="op" id="4839511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4839515">panic</span><span class="op" id="4839520">(</span><span class="string" id="4839521">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="4839559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839562">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839565">k</span>&nbsp;<span class="op" id="4839567">:=</span>&nbsp;<span class="op" id="4839570">(</span><span class="ident" id="4839571">max</span><span class="op" id="4839574">.</span><span class="ident" id="4839575">BitLen</span><span class="op" id="4839581">(</span><span class="op" id="4839582">)</span>&nbsp;<span class="op" id="4839584">+</span>&nbsp;<span class="num" id="4839586">7</span><span class="op" id="4839587">)</span>&nbsp;<span class="op" id="4839589">/</span>&nbsp;<span class="num" id="4839591">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839595">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839660">b</span>&nbsp;<span class="op" id="4839662">:=</span>&nbsp;<span class="builtintype" id="4839665">uint</span><span class="op" id="4839669">(</span><span class="ident" id="4839670">max</span><span class="op" id="4839673">.</span><span class="ident" id="4839674">BitLen</span><span class="op" id="4839680">(</span><span class="op" id="4839681">)</span>&nbsp;<span class="op" id="4839683">%</span>&nbsp;<span class="num" id="4839685">8</span><span class="op" id="4839686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839689">if</span>&nbsp;<span class="ident" id="4839692">b</span>&nbsp;<span class="op" id="4839694">==</span>&nbsp;<span class="num" id="4839697">0</span>&nbsp;<span class="op" id="4839699">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839703">b</span>&nbsp;<span class="op" id="4839705">=</span>&nbsp;<span class="num" id="4839707">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839714">bytes</span>&nbsp;<span class="op" id="4839720">:=</span>&nbsp;<span class="builtinfunc" id="4839723">make</span><span class="op" id="4839727">(</span><span class="op" id="4839728">[</span><span class="op" id="4839729">]</span><span class="builtintype" id="4839730">byte</span><span class="op" id="4839734">,</span>&nbsp;<span class="ident" id="4839736">k</span><span class="op" id="4839737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839740">n</span>&nbsp;<span class="op" id="4839742">=</span>&nbsp;<span class="builtinfunc" id="4839744">new</span><span class="op" id="4839747">(</span><span class="ident" id="4839748">big</span><span class="op" id="4839751">.</span><span class="ident" id="4839752">Int</span><span class="op" id="4839755">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839759">for</span>&nbsp;<span class="op" id="4839763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839767">_</span><span class="op" id="4839768">,</span>&nbsp;<span class="ident" id="4839770">err</span>&nbsp;<span class="op" id="4839774">=</span>&nbsp;<span class="ident" id="4839776">io</span><span class="op" id="4839778">.</span><span class="ident" id="4839779">ReadFull</span><span class="op" id="4839787">(</span><span class="ident" id="4839788">rand</span><span class="op" id="4839792">,</span>&nbsp;<span class="ident" id="4839794">bytes</span><span class="op" id="4839799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839803">if</span>&nbsp;<span class="ident" id="4839806">err</span>&nbsp;<span class="op" id="4839810">!=</span>&nbsp;<span class="ident" id="4839813">nil</span>&nbsp;<span class="op" id="4839817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839822">return</span>&nbsp;<span class="ident" id="4839829">nil</span><span class="op" id="4839832">,</span>&nbsp;<span class="ident" id="4839834">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839845">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839907">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839941">bytes</span><span class="op" id="4839946">[</span><span class="num" id="4839947">0</span><span class="op" id="4839948">]</span>&nbsp;<span class="op" id="4839950">&amp;=</span>&nbsp;<span class="builtintype" id="4839953">uint8</span><span class="op" id="4839958">(</span><span class="builtintype" id="4839959">int</span><span class="op" id="4839962">(</span><span class="num" id="4839963">1</span><span class="op" id="4839964">&lt;&lt;</span><span class="ident" id="4839966">b</span><span class="op" id="4839967">)</span>&nbsp;<span class="op" id="4839969">-</span>&nbsp;<span class="num" id="4839971">1</span><span class="op" id="4839972">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839977">n</span><span class="op" id="4839978">.</span><span class="ident" id="4839979">SetBytes</span><span class="op" id="4839987">(</span><span class="ident" id="4839988">bytes</span><span class="op" id="4839993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839997">if</span>&nbsp;<span class="ident" id="4840000">n</span><span class="op" id="4840001">.</span><span class="ident" id="4840002">Cmp</span><span class="op" id="4840005">(</span><span class="ident" id="4840006">max</span><span class="op" id="4840009">)</span>&nbsp;<span class="op" id="4840011">&lt;</span>&nbsp;<span class="num" id="4840013">0</span>&nbsp;<span class="op" id="4840015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840029">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840032">}</span><br>
<span class="lineno"></span><span class="op" id="4840034">}</span>
</div>
</body>
</html>
