<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html" class="current">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7929384">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7929439">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7929493">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7929544">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7929607">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7929671">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7929728">package</span>&nbsp;<span class="ident" id="7929736">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7929741">import</span>&nbsp;<span class="op" id="7929748">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929751">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929760">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929770">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929777">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929783">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929795">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929816">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929822">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929833">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929844">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7929851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7929854">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7929924">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7929988">func</span>&nbsp;<span class="ident" id="7929993">TestHostingOurselves</span><span class="op" id="7930013">(</span><span class="ident" id="7930014">t</span>&nbsp;<span class="op" id="7930016">*</span><span class="ident" id="7930017">testing</span><span class="op" id="7930024">.</span><span class="ident" id="7930025">T</span><span class="op" id="7930026">)</span>&nbsp;<span class="op" id="7930028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7930031">if</span>&nbsp;<span class="ident" id="7930034">runtime</span><span class="op" id="7930041">.</span><span class="ident" id="7930042">GOOS</span>&nbsp;<span class="op" id="7930047">==</span>&nbsp;<span class="string" id="7930050">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7930057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930061">t</span><span class="op" id="7930062">.</span><span class="ident" id="7930063">Skip</span><span class="op" id="7930067">(</span><span class="string" id="7930068">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7930086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7930089">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930093">h</span>&nbsp;<span class="op" id="7930095">:=</span>&nbsp;<span class="op" id="7930098">&amp;</span><span class="ident" id="7930099">Handler</span><span class="op" id="7930106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930110">Path</span><span class="op" id="7930114">:</span>&nbsp;<span class="ident" id="7930116">os</span><span class="op" id="7930118">.</span><span class="ident" id="7930119">Args</span><span class="op" id="7930123">[</span><span class="num" id="7930124">0</span><span class="op" id="7930125">]</span><span class="op" id="7930126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930130">Root</span><span class="op" id="7930134">:</span>&nbsp;<span class="string" id="7930136">&#34;/test.go&#34;</span><span class="op" id="7930146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930150">Args</span><span class="op" id="7930154">:</span>&nbsp;<span class="op" id="7930156">[</span><span class="op" id="7930157">]</span><span class="builtintype" id="7930158">string</span><span class="op" id="7930164">{</span><span class="string" id="7930165">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7930198">}</span><span class="op" id="7930199">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7930202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930205">expectedMap</span>&nbsp;<span class="op" id="7930217">:=</span>&nbsp;<span class="keyword" id="7930220">map</span><span class="op" id="7930223">[</span><span class="builtintype" id="7930224">string</span><span class="op" id="7930230">]</span><span class="builtintype" id="7930231">string</span><span class="op" id="7930237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930241">&#34;test&#34;</span><span class="op" id="7930247">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930266">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7930284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930288">&#34;param-a&#34;</span><span class="op" id="7930297">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930313">&#34;b&#34;</span><span class="op" id="7930316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930320">&#34;param-foo&#34;</span><span class="op" id="7930331">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930345">&#34;bar&#34;</span><span class="op" id="7930350">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930354">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7930377">:</span>&nbsp;<span class="string" id="7930379">&#34;CGI/1.1&#34;</span><span class="op" id="7930388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930392">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7930407">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930417">&#34;example.com&#34;</span><span class="op" id="7930430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930434">&#34;env-PATH_INFO&#34;</span><span class="op" id="7930449">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930459">&#34;&#34;</span><span class="op" id="7930461">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930465">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7930483">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930490">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7930503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930507">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7930524">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930532">&#34;1.2.3.4&#34;</span><span class="op" id="7930541">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930545">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7930562">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930570">&#34;1.2.3.4&#34;</span><span class="op" id="7930579">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930583">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7930603">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930608">&#34;GET&#34;</span><span class="op" id="7930613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930617">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7930634">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930642">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7930664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930668">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7930689">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7930693">os</span><span class="op" id="7930695">.</span><span class="ident" id="7930696">Args</span><span class="op" id="7930700">[</span><span class="num" id="7930701">0</span><span class="op" id="7930702">]</span><span class="op" id="7930703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930707">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7930724">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930732">&#34;/test.go&#34;</span><span class="op" id="7930742">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930746">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7930763">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930771">&#34;example.com&#34;</span><span class="op" id="7930784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930788">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7930805">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930813">&#34;80&#34;</span><span class="op" id="7930817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7930821">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7930842">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7930846">&#34;go&#34;</span><span class="op" id="7930850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7930853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7930856">replay</span>&nbsp;<span class="op" id="7930863">:=</span>&nbsp;<span class="ident" id="7930866">runCgiTest</span><span class="op" id="7930876">(</span><span class="ident" id="7930877">t</span><span class="op" id="7930878">,</span>&nbsp;<span class="ident" id="7930880">h</span><span class="op" id="7930881">,</span>&nbsp;<span class="string" id="7930883">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7930941">,</span>&nbsp;<span class="ident" id="7930943">expectedMap</span><span class="op" id="7930954">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7930958">if</span>&nbsp;<span class="ident" id="7930961">expected</span><span class="op" id="7930969">,</span>&nbsp;<span class="ident" id="7930971">got</span>&nbsp;<span class="op" id="7930975">:=</span>&nbsp;<span class="string" id="7930978">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7931004">,</span>&nbsp;<span class="ident" id="7931006">replay</span><span class="op" id="7931012">.</span><span class="ident" id="7931013">Header</span><span class="op" id="7931019">(</span><span class="op" id="7931020">)</span><span class="op" id="7931021">.</span><span class="ident" id="7931022">Get</span><span class="op" id="7931025">(</span><span class="string" id="7931026">&#34;Content-Type&#34;</span><span class="op" id="7931040">)</span><span class="op" id="7931041">;</span>&nbsp;<span class="ident" id="7931043">got</span>&nbsp;<span class="op" id="7931047">!=</span>&nbsp;<span class="ident" id="7931050">expected</span>&nbsp;<span class="op" id="7931059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931063">t</span><span class="op" id="7931064">.</span><span class="ident" id="7931065">Errorf</span><span class="op" id="7931071">(</span><span class="string" id="7931072">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7931111">,</span>&nbsp;<span class="ident" id="7931113">got</span><span class="op" id="7931116">,</span>&nbsp;<span class="ident" id="7931118">expected</span><span class="op" id="7931126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931132">if</span>&nbsp;<span class="ident" id="7931135">expected</span><span class="op" id="7931143">,</span>&nbsp;<span class="ident" id="7931145">got</span>&nbsp;<span class="op" id="7931149">:=</span>&nbsp;<span class="string" id="7931152">&#34;X-Test-Value&#34;</span><span class="op" id="7931166">,</span>&nbsp;<span class="ident" id="7931168">replay</span><span class="op" id="7931174">.</span><span class="ident" id="7931175">Header</span><span class="op" id="7931181">(</span><span class="op" id="7931182">)</span><span class="op" id="7931183">.</span><span class="ident" id="7931184">Get</span><span class="op" id="7931187">(</span><span class="string" id="7931188">&#34;X-Test-Header&#34;</span><span class="op" id="7931203">)</span><span class="op" id="7931204">;</span>&nbsp;<span class="ident" id="7931206">got</span>&nbsp;<span class="op" id="7931210">!=</span>&nbsp;<span class="ident" id="7931213">expected</span>&nbsp;<span class="op" id="7931222">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931226">t</span><span class="op" id="7931227">.</span><span class="ident" id="7931228">Errorf</span><span class="op" id="7931234">(</span><span class="string" id="7931235">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7931275">,</span>&nbsp;<span class="ident" id="7931277">got</span><span class="op" id="7931280">,</span>&nbsp;<span class="ident" id="7931282">expected</span><span class="op" id="7931290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931293">}</span><br>
<span class="lineno"></span><span class="op" id="7931295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7931298">type</span>&nbsp;<span class="ident" id="7931303">customWriterRecorder</span>&nbsp;<span class="keyword" id="7931324">struct</span>&nbsp;<span class="op" id="7931331">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931334">w</span>&nbsp;<span class="ident" id="7931336">io</span><span class="op" id="7931338">.</span><span class="ident" id="7931339">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931347">*</span><span class="ident" id="7931348">httptest</span><span class="op" id="7931356">.</span><span class="ident" id="7931357">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7931374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7931377">func</span>&nbsp;<span class="op" id="7931382">(</span><span class="ident" id="7931383">r</span>&nbsp;<span class="op" id="7931385">*</span><span class="ident" id="7931386">customWriterRecorder</span><span class="op" id="7931406">)</span>&nbsp;<span class="ident" id="7931408">Write</span><span class="op" id="7931413">(</span><span class="ident" id="7931414">p</span>&nbsp;<span class="op" id="7931416">[</span><span class="op" id="7931417">]</span><span class="builtintype" id="7931418">byte</span><span class="op" id="7931422">)</span>&nbsp;<span class="op" id="7931424">(</span><span class="ident" id="7931425">n</span>&nbsp;<span class="builtintype" id="7931427">int</span><span class="op" id="7931430">,</span>&nbsp;<span class="ident" id="7931432">err</span>&nbsp;<span class="builtintype" id="7931436">error</span><span class="op" id="7931441">)</span>&nbsp;<span class="op" id="7931443">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931446">return</span>&nbsp;<span class="ident" id="7931453">r</span><span class="op" id="7931454">.</span><span class="ident" id="7931455">w</span><span class="op" id="7931456">.</span><span class="ident" id="7931457">Write</span><span class="op" id="7931462">(</span><span class="ident" id="7931463">p</span><span class="op" id="7931464">)</span><br>
<span class="lineno"></span><span class="op" id="7931466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7931469">type</span>&nbsp;<span class="ident" id="7931474">limitWriter</span>&nbsp;<span class="keyword" id="7931486">struct</span>&nbsp;<span class="op" id="7931493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931496">w</span>&nbsp;<span class="ident" id="7931498">io</span><span class="op" id="7931500">.</span><span class="ident" id="7931501">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931509">n</span>&nbsp;<span class="builtintype" id="7931511">int</span><br>
<span class="lineno"></span><span class="op" id="7931515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7931518">func</span>&nbsp;<span class="op" id="7931523">(</span><span class="ident" id="7931524">w</span>&nbsp;<span class="op" id="7931526">*</span><span class="ident" id="7931527">limitWriter</span><span class="op" id="7931538">)</span>&nbsp;<span class="ident" id="7931540">Write</span><span class="op" id="7931545">(</span><span class="ident" id="7931546">p</span>&nbsp;<span class="op" id="7931548">[</span><span class="op" id="7931549">]</span><span class="builtintype" id="7931550">byte</span><span class="op" id="7931554">)</span>&nbsp;<span class="op" id="7931556">(</span><span class="ident" id="7931557">n</span>&nbsp;<span class="builtintype" id="7931559">int</span><span class="op" id="7931562">,</span>&nbsp;<span class="ident" id="7931564">err</span>&nbsp;<span class="builtintype" id="7931568">error</span><span class="op" id="7931573">)</span>&nbsp;<span class="op" id="7931575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931578">if</span>&nbsp;<span class="builtinfunc" id="7931581">len</span><span class="op" id="7931584">(</span><span class="ident" id="7931585">p</span><span class="op" id="7931586">)</span>&nbsp;<span class="op" id="7931588">&gt;</span>&nbsp;<span class="ident" id="7931590">w</span><span class="op" id="7931591">.</span><span class="ident" id="7931592">n</span>&nbsp;<span class="op" id="7931594">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931598">p</span>&nbsp;<span class="op" id="7931600">=</span>&nbsp;<span class="ident" id="7931602">p</span><span class="op" id="7931603">[</span><span class="op" id="7931604">:</span><span class="ident" id="7931605">w</span><span class="op" id="7931606">.</span><span class="ident" id="7931607">n</span><span class="op" id="7931608">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931614">if</span>&nbsp;<span class="builtinfunc" id="7931617">len</span><span class="op" id="7931620">(</span><span class="ident" id="7931621">p</span><span class="op" id="7931622">)</span>&nbsp;<span class="op" id="7931624">&gt;</span>&nbsp;<span class="num" id="7931626">0</span>&nbsp;<span class="op" id="7931628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931632">n</span><span class="op" id="7931633">,</span>&nbsp;<span class="ident" id="7931635">err</span>&nbsp;<span class="op" id="7931639">=</span>&nbsp;<span class="ident" id="7931641">w</span><span class="op" id="7931642">.</span><span class="ident" id="7931643">w</span><span class="op" id="7931644">.</span><span class="ident" id="7931645">Write</span><span class="op" id="7931650">(</span><span class="ident" id="7931651">p</span><span class="op" id="7931652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931656">w</span><span class="op" id="7931657">.</span><span class="ident" id="7931658">n</span>&nbsp;<span class="op" id="7931660">-=</span>&nbsp;<span class="ident" id="7931663">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931669">if</span>&nbsp;<span class="ident" id="7931672">w</span><span class="op" id="7931673">.</span><span class="ident" id="7931674">n</span>&nbsp;<span class="op" id="7931676">==</span>&nbsp;<span class="num" id="7931679">0</span>&nbsp;<span class="op" id="7931681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931685">err</span>&nbsp;<span class="op" id="7931689">=</span>&nbsp;<span class="ident" id="7931691">errors</span><span class="op" id="7931697">.</span><span class="ident" id="7931698">New</span><span class="op" id="7931701">(</span><span class="string" id="7931702">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7931720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931726">return</span><br>
<span class="lineno">90</span><span class="op" id="7931733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7931736">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7931806">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7931833">func</span>&nbsp;<span class="ident" id="7931838">TestKillChildAfterCopyError</span><span class="op" id="7931865">(</span><span class="ident" id="7931866">t</span>&nbsp;<span class="op" id="7931868">*</span><span class="ident" id="7931869">testing</span><span class="op" id="7931876">.</span><span class="ident" id="7931877">T</span><span class="op" id="7931878">)</span>&nbsp;<span class="op" id="7931880">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931883">if</span>&nbsp;<span class="ident" id="7931886">runtime</span><span class="op" id="7931893">.</span><span class="ident" id="7931894">GOOS</span>&nbsp;<span class="op" id="7931899">==</span>&nbsp;<span class="string" id="7931902">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7931909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931913">t</span><span class="op" id="7931914">.</span><span class="ident" id="7931915">Skip</span><span class="op" id="7931919">(</span><span class="string" id="7931920">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7931938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7931941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7931945">defer</span>&nbsp;<span class="keyword" id="7931951">func</span><span class="op" id="7931955">(</span><span class="op" id="7931956">)</span>&nbsp;<span class="op" id="7931958">{</span>&nbsp;<span class="ident" id="7931960">testHookStartProcess</span>&nbsp;<span class="op" id="7931981">=</span>&nbsp;<span class="builtintype" id="7931983">nil</span>&nbsp;<span class="op" id="7931987">}</span><span class="op" id="7931988">(</span><span class="op" id="7931989">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7931992">proc</span>&nbsp;<span class="op" id="7931997">:=</span>&nbsp;<span class="builtinfunc" id="7932000">make</span><span class="op" id="7932004">(</span><span class="keyword" id="7932005">chan</span>&nbsp;<span class="op" id="7932010">*</span><span class="ident" id="7932011">os</span><span class="op" id="7932013">.</span><span class="ident" id="7932014">Process</span><span class="op" id="7932021">,</span>&nbsp;<span class="num" id="7932023">1</span><span class="op" id="7932024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932027">testHookStartProcess</span>&nbsp;<span class="op" id="7932048">=</span>&nbsp;<span class="keyword" id="7932050">func</span><span class="op" id="7932054">(</span><span class="ident" id="7932055">p</span>&nbsp;<span class="op" id="7932057">*</span><span class="ident" id="7932058">os</span><span class="op" id="7932060">.</span><span class="ident" id="7932061">Process</span><span class="op" id="7932068">)</span>&nbsp;<span class="op" id="7932070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932074">proc</span>&nbsp;<span class="op" id="7932079">&lt;-</span>&nbsp;<span class="ident" id="7932082">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7932085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932089">h</span>&nbsp;<span class="op" id="7932091">:=</span>&nbsp;<span class="op" id="7932094">&amp;</span><span class="ident" id="7932095">Handler</span><span class="op" id="7932102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932106">Path</span><span class="op" id="7932110">:</span>&nbsp;<span class="ident" id="7932112">os</span><span class="op" id="7932114">.</span><span class="ident" id="7932115">Args</span><span class="op" id="7932119">[</span><span class="num" id="7932120">0</span><span class="op" id="7932121">]</span><span class="op" id="7932122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932126">Root</span><span class="op" id="7932130">:</span>&nbsp;<span class="string" id="7932132">&#34;/test.go&#34;</span><span class="op" id="7932142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932146">Args</span><span class="op" id="7932150">:</span>&nbsp;<span class="op" id="7932152">[</span><span class="op" id="7932153">]</span><span class="builtintype" id="7932154">string</span><span class="op" id="7932160">{</span><span class="string" id="7932161">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7932194">}</span><span class="op" id="7932195">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7932198">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932201">req</span><span class="op" id="7932204">,</span>&nbsp;<span class="ident" id="7932206">_</span>&nbsp;<span class="op" id="7932208">:=</span>&nbsp;<span class="ident" id="7932211">http</span><span class="op" id="7932215">.</span><span class="ident" id="7932216">NewRequest</span><span class="op" id="7932226">(</span><span class="string" id="7932227">&#34;GET&#34;</span><span class="op" id="7932232">,</span>&nbsp;<span class="string" id="7932234">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7932279">,</span>&nbsp;<span class="builtintype" id="7932281">nil</span><span class="op" id="7932284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932287">rec</span>&nbsp;<span class="op" id="7932291">:=</span>&nbsp;<span class="ident" id="7932294">httptest</span><span class="op" id="7932302">.</span><span class="ident" id="7932303">NewRecorder</span><span class="op" id="7932314">(</span><span class="op" id="7932315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932318">var</span>&nbsp;<span class="ident" id="7932322">out</span>&nbsp;<span class="ident" id="7932326">bytes</span><span class="op" id="7932331">.</span><span class="ident" id="7932332">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932340">const</span>&nbsp;<span class="ident" id="7932346">writeLen</span>&nbsp;<span class="op" id="7932355">=</span>&nbsp;<span class="num" id="7932357">50</span>&nbsp;<span class="op" id="7932360">&lt;&lt;</span>&nbsp;<span class="num" id="7932363">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932367">rw</span>&nbsp;<span class="op" id="7932370">:=</span>&nbsp;<span class="op" id="7932373">&amp;</span><span class="ident" id="7932374">customWriterRecorder</span><span class="op" id="7932394">{</span><span class="op" id="7932395">&amp;</span><span class="ident" id="7932396">limitWriter</span><span class="op" id="7932407">{</span><span class="op" id="7932408">&amp;</span><span class="ident" id="7932409">out</span><span class="op" id="7932412">,</span>&nbsp;<span class="ident" id="7932414">writeLen</span><span class="op" id="7932422">}</span><span class="op" id="7932423">,</span>&nbsp;<span class="ident" id="7932425">rec</span><span class="op" id="7932428">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932432">donec</span>&nbsp;<span class="op" id="7932438">:=</span>&nbsp;<span class="builtinfunc" id="7932441">make</span><span class="op" id="7932445">(</span><span class="keyword" id="7932446">chan</span>&nbsp;<span class="builtintype" id="7932451">bool</span><span class="op" id="7932455">,</span>&nbsp;<span class="num" id="7932457">1</span><span class="op" id="7932458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932461">go</span>&nbsp;<span class="keyword" id="7932464">func</span><span class="op" id="7932468">(</span><span class="op" id="7932469">)</span>&nbsp;<span class="op" id="7932471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932475">h</span><span class="op" id="7932476">.</span><span class="ident" id="7932477">ServeHTTP</span><span class="op" id="7932486">(</span><span class="ident" id="7932487">rw</span><span class="op" id="7932489">,</span>&nbsp;<span class="ident" id="7932491">req</span><span class="op" id="7932494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932498">donec</span>&nbsp;<span class="op" id="7932504">&lt;-</span>&nbsp;<span class="builtintype" id="7932507">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7932513">}</span><span class="op" id="7932514">(</span><span class="op" id="7932515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932519">select</span>&nbsp;<span class="op" id="7932526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932529">case</span>&nbsp;<span class="op" id="7932534">&lt;-</span><span class="ident" id="7932536">donec</span><span class="op" id="7932541">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932545">if</span>&nbsp;<span class="ident" id="7932548">out</span><span class="op" id="7932551">.</span><span class="ident" id="7932552">Len</span><span class="op" id="7932555">(</span><span class="op" id="7932556">)</span>&nbsp;<span class="op" id="7932558">!=</span>&nbsp;<span class="ident" id="7932561">writeLen</span>&nbsp;<span class="op" id="7932570">||</span>&nbsp;<span class="ident" id="7932573">out</span><span class="op" id="7932576">.</span><span class="ident" id="7932577">Bytes</span><span class="op" id="7932582">(</span><span class="op" id="7932583">)</span><span class="op" id="7932584">[</span><span class="num" id="7932585">0</span><span class="op" id="7932586">]</span>&nbsp;<span class="op" id="7932588">!=</span>&nbsp;<span class="string" id="7932591">&#39;a&#39;</span>&nbsp;<span class="op" id="7932595">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932600">t</span><span class="op" id="7932601">.</span><span class="ident" id="7932602">Errorf</span><span class="op" id="7932608">(</span><span class="string" id="7932609">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7932632">,</span>&nbsp;<span class="ident" id="7932634">out</span><span class="op" id="7932637">.</span><span class="ident" id="7932638">Bytes</span><span class="op" id="7932643">(</span><span class="op" id="7932644">)</span><span class="op" id="7932645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7932649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932652">case</span>&nbsp;<span class="op" id="7932657">&lt;-</span><span class="ident" id="7932659">time</span><span class="op" id="7932663">.</span><span class="ident" id="7932664">After</span><span class="op" id="7932669">(</span><span class="num" id="7932670">5</span>&nbsp;<span class="op" id="7932672">*</span>&nbsp;<span class="ident" id="7932674">time</span><span class="op" id="7932678">.</span><span class="ident" id="7932679">Second</span><span class="op" id="7932685">)</span><span class="op" id="7932686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932690">t</span><span class="op" id="7932691">.</span><span class="ident" id="7932692">Errorf</span><span class="op" id="7932698">(</span><span class="string" id="7932699">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7932759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932763">select</span>&nbsp;<span class="op" id="7932770">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932774">case</span>&nbsp;<span class="ident" id="7932779">p</span>&nbsp;<span class="op" id="7932781">:=</span>&nbsp;<span class="op" id="7932784">&lt;-</span><span class="ident" id="7932786">proc</span><span class="op" id="7932790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932795">p</span><span class="op" id="7932796">.</span><span class="ident" id="7932797">Kill</span><span class="op" id="7932801">(</span><span class="op" id="7932802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932807">t</span><span class="op" id="7932808">.</span><span class="ident" id="7932809">Logf</span><span class="op" id="7932813">(</span><span class="string" id="7932814">&#34;killed&nbsp;process&#34;</span><span class="op" id="7932830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7932834">default</span><span class="op" id="7932841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7932846">t</span><span class="op" id="7932847">.</span><span class="ident" id="7932848">Logf</span><span class="op" id="7932852">(</span><span class="string" id="7932853">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7932874">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7932878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7932881">}</span><br>
<span class="lineno"></span><span class="op" id="7932883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7932886">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7932943">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7932968">func</span>&nbsp;<span class="ident" id="7932973">TestChildOnlyHeaders</span><span class="op" id="7932993">(</span><span class="ident" id="7932994">t</span>&nbsp;<span class="op" id="7932996">*</span><span class="ident" id="7932997">testing</span><span class="op" id="7933004">.</span><span class="ident" id="7933005">T</span><span class="op" id="7933006">)</span>&nbsp;<span class="op" id="7933008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7933011">if</span>&nbsp;<span class="ident" id="7933014">runtime</span><span class="op" id="7933021">.</span><span class="ident" id="7933022">GOOS</span>&nbsp;<span class="op" id="7933027">==</span>&nbsp;<span class="string" id="7933030">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7933037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933041">t</span><span class="op" id="7933042">.</span><span class="ident" id="7933043">Skip</span><span class="op" id="7933047">(</span><span class="string" id="7933048">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7933066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933069">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933073">h</span>&nbsp;<span class="op" id="7933075">:=</span>&nbsp;<span class="op" id="7933078">&amp;</span><span class="ident" id="7933079">Handler</span><span class="op" id="7933086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933090">Path</span><span class="op" id="7933094">:</span>&nbsp;<span class="ident" id="7933096">os</span><span class="op" id="7933098">.</span><span class="ident" id="7933099">Args</span><span class="op" id="7933103">[</span><span class="num" id="7933104">0</span><span class="op" id="7933105">]</span><span class="op" id="7933106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933110">Root</span><span class="op" id="7933114">:</span>&nbsp;<span class="string" id="7933116">&#34;/test.go&#34;</span><span class="op" id="7933126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933130">Args</span><span class="op" id="7933134">:</span>&nbsp;<span class="op" id="7933136">[</span><span class="op" id="7933137">]</span><span class="builtintype" id="7933138">string</span><span class="op" id="7933144">{</span><span class="string" id="7933145">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7933178">}</span><span class="op" id="7933179">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933185">expectedMap</span>&nbsp;<span class="op" id="7933197">:=</span>&nbsp;<span class="keyword" id="7933200">map</span><span class="op" id="7933203">[</span><span class="builtintype" id="7933204">string</span><span class="op" id="7933210">]</span><span class="builtintype" id="7933211">string</span><span class="op" id="7933217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7933221">&#34;_body&#34;</span><span class="op" id="7933228">:</span>&nbsp;<span class="string" id="7933230">&#34;&#34;</span><span class="op" id="7933232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933238">replay</span>&nbsp;<span class="op" id="7933245">:=</span>&nbsp;<span class="ident" id="7933248">runCgiTest</span><span class="op" id="7933258">(</span><span class="ident" id="7933259">t</span><span class="op" id="7933260">,</span>&nbsp;<span class="ident" id="7933262">h</span><span class="op" id="7933263">,</span>&nbsp;<span class="string" id="7933265">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7933321">,</span>&nbsp;<span class="ident" id="7933323">expectedMap</span><span class="op" id="7933334">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7933337">if</span>&nbsp;<span class="ident" id="7933340">expected</span><span class="op" id="7933348">,</span>&nbsp;<span class="ident" id="7933350">got</span>&nbsp;<span class="op" id="7933354">:=</span>&nbsp;<span class="string" id="7933357">&#34;X-Test-Value&#34;</span><span class="op" id="7933371">,</span>&nbsp;<span class="ident" id="7933373">replay</span><span class="op" id="7933379">.</span><span class="ident" id="7933380">Header</span><span class="op" id="7933386">(</span><span class="op" id="7933387">)</span><span class="op" id="7933388">.</span><span class="ident" id="7933389">Get</span><span class="op" id="7933392">(</span><span class="string" id="7933393">&#34;X-Test-Header&#34;</span><span class="op" id="7933408">)</span><span class="op" id="7933409">;</span>&nbsp;<span class="ident" id="7933411">got</span>&nbsp;<span class="op" id="7933415">!=</span>&nbsp;<span class="ident" id="7933418">expected</span>&nbsp;<span class="op" id="7933427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933431">t</span><span class="op" id="7933432">.</span><span class="ident" id="7933433">Errorf</span><span class="op" id="7933439">(</span><span class="string" id="7933440">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7933480">,</span>&nbsp;<span class="ident" id="7933482">got</span><span class="op" id="7933485">,</span>&nbsp;<span class="ident" id="7933487">expected</span><span class="op" id="7933495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933498">}</span><br>
<span class="lineno"></span><span class="op" id="7933500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7933503">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7933528">func</span>&nbsp;<span class="ident" id="7933533">Test500WithNoHeaders</span><span class="op" id="7933553">(</span><span class="ident" id="7933554">t</span>&nbsp;<span class="op" id="7933556">*</span><span class="ident" id="7933557">testing</span><span class="op" id="7933564">.</span><span class="ident" id="7933565">T</span><span class="op" id="7933566">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933572">{</span>&nbsp;<span class="ident" id="7933574">want500Test</span><span class="op" id="7933585">(</span><span class="ident" id="7933586">t</span><span class="op" id="7933587">,</span>&nbsp;<span class="string" id="7933589">&#34;/immediate-disconnect&#34;</span><span class="op" id="7933612">)</span>&nbsp;<span class="op" id="7933614">}</span><br>
<span class="lineno"></span><span class="keyword" id="7933616">func</span>&nbsp;<span class="ident" id="7933621">Test500WithNoContentType</span><span class="op" id="7933645">(</span><span class="ident" id="7933646">t</span>&nbsp;<span class="op" id="7933648">*</span><span class="ident" id="7933649">testing</span><span class="op" id="7933656">.</span><span class="ident" id="7933657">T</span><span class="op" id="7933658">)</span>&nbsp;<span class="op" id="7933660">{</span>&nbsp;<span class="ident" id="7933662">want500Test</span><span class="op" id="7933673">(</span><span class="ident" id="7933674">t</span><span class="op" id="7933675">,</span>&nbsp;<span class="string" id="7933677">&#34;/no-content-type&#34;</span><span class="op" id="7933695">)</span>&nbsp;<span class="op" id="7933697">}</span><br>
<span class="lineno"></span><span class="keyword" id="7933699">func</span>&nbsp;<span class="ident" id="7933704">Test500WithEmptyHeaders</span><span class="op" id="7933727">(</span><span class="ident" id="7933728">t</span>&nbsp;<span class="op" id="7933730">*</span><span class="ident" id="7933731">testing</span><span class="op" id="7933738">.</span><span class="ident" id="7933739">T</span><span class="op" id="7933740">)</span>&nbsp;&nbsp;<span class="op" id="7933743">{</span>&nbsp;<span class="ident" id="7933745">want500Test</span><span class="op" id="7933756">(</span><span class="ident" id="7933757">t</span><span class="op" id="7933758">,</span>&nbsp;<span class="string" id="7933760">&#34;/empty-headers&#34;</span><span class="op" id="7933776">)</span>&nbsp;<span class="op" id="7933778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7933781">func</span>&nbsp;<span class="ident" id="7933786">want500Test</span><span class="op" id="7933797">(</span><span class="ident" id="7933798">t</span>&nbsp;<span class="op" id="7933800">*</span><span class="ident" id="7933801">testing</span><span class="op" id="7933808">.</span><span class="ident" id="7933809">T</span><span class="op" id="7933810">,</span>&nbsp;<span class="ident" id="7933812">path</span>&nbsp;<span class="builtintype" id="7933817">string</span><span class="op" id="7933823">)</span>&nbsp;<span class="op" id="7933825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933828">h</span>&nbsp;<span class="op" id="7933830">:=</span>&nbsp;<span class="op" id="7933833">&amp;</span><span class="ident" id="7933834">Handler</span><span class="op" id="7933841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933845">Path</span><span class="op" id="7933849">:</span>&nbsp;<span class="ident" id="7933851">os</span><span class="op" id="7933853">.</span><span class="ident" id="7933854">Args</span><span class="op" id="7933858">[</span><span class="num" id="7933859">0</span><span class="op" id="7933860">]</span><span class="op" id="7933861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933865">Root</span><span class="op" id="7933869">:</span>&nbsp;<span class="string" id="7933871">&#34;/test.go&#34;</span><span class="op" id="7933881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933885">Args</span><span class="op" id="7933889">:</span>&nbsp;<span class="op" id="7933891">[</span><span class="op" id="7933892">]</span><span class="builtintype" id="7933893">string</span><span class="op" id="7933899">{</span><span class="string" id="7933900">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7933933">}</span><span class="op" id="7933934">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933940">expectedMap</span>&nbsp;<span class="op" id="7933952">:=</span>&nbsp;<span class="keyword" id="7933955">map</span><span class="op" id="7933958">[</span><span class="builtintype" id="7933959">string</span><span class="op" id="7933965">]</span><span class="builtintype" id="7933966">string</span><span class="op" id="7933972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7933976">&#34;_body&#34;</span><span class="op" id="7933983">:</span>&nbsp;<span class="string" id="7933985">&#34;&#34;</span><span class="op" id="7933987">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7933990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7933993">replay</span>&nbsp;<span class="op" id="7934000">:=</span>&nbsp;<span class="ident" id="7934003">runCgiTest</span><span class="op" id="7934013">(</span><span class="ident" id="7934014">t</span><span class="op" id="7934015">,</span>&nbsp;<span class="ident" id="7934017">h</span><span class="op" id="7934018">,</span>&nbsp;<span class="string" id="7934020">&#34;GET&nbsp;&#34;</span><span class="op" id="7934026">+</span><span class="ident" id="7934027">path</span><span class="op" id="7934031">+</span><span class="string" id="7934032">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7934066">,</span>&nbsp;<span class="ident" id="7934068">expectedMap</span><span class="op" id="7934079">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934082">if</span>&nbsp;<span class="ident" id="7934085">replay</span><span class="op" id="7934091">.</span><span class="ident" id="7934092">Code</span>&nbsp;<span class="op" id="7934097">!=</span>&nbsp;<span class="num" id="7934100">500</span>&nbsp;<span class="op" id="7934104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934108">t</span><span class="op" id="7934109">.</span><span class="ident" id="7934110">Errorf</span><span class="op" id="7934116">(</span><span class="string" id="7934117">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7934140">,</span>&nbsp;<span class="ident" id="7934142">replay</span><span class="op" id="7934148">.</span><span class="ident" id="7934149">Code</span><span class="op" id="7934153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7934156">}</span><br>
<span class="lineno"></span><span class="op" id="7934158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7934161">type</span>&nbsp;<span class="ident" id="7934166">neverEnding</span>&nbsp;<span class="builtintype" id="7934178">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7934184">func</span>&nbsp;<span class="op" id="7934189">(</span><span class="ident" id="7934190">b</span>&nbsp;<span class="ident" id="7934192">neverEnding</span><span class="op" id="7934203">)</span>&nbsp;<span class="ident" id="7934205">Read</span><span class="op" id="7934209">(</span><span class="ident" id="7934210">p</span>&nbsp;<span class="op" id="7934212">[</span><span class="op" id="7934213">]</span><span class="builtintype" id="7934214">byte</span><span class="op" id="7934218">)</span>&nbsp;<span class="op" id="7934220">(</span><span class="ident" id="7934221">n</span>&nbsp;<span class="builtintype" id="7934223">int</span><span class="op" id="7934226">,</span>&nbsp;<span class="ident" id="7934228">err</span>&nbsp;<span class="builtintype" id="7934232">error</span><span class="op" id="7934237">)</span>&nbsp;<span class="op" id="7934239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934242">for</span>&nbsp;<span class="ident" id="7934246">i</span>&nbsp;<span class="op" id="7934248">:=</span>&nbsp;<span class="keyword" id="7934251">range</span>&nbsp;<span class="ident" id="7934257">p</span>&nbsp;<span class="op" id="7934259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934263">p</span><span class="op" id="7934264">[</span><span class="ident" id="7934265">i</span><span class="op" id="7934266">]</span>&nbsp;<span class="op" id="7934268">=</span>&nbsp;<span class="builtintype" id="7934270">byte</span><span class="op" id="7934274">(</span><span class="ident" id="7934275">b</span><span class="op" id="7934276">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7934279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934282">return</span>&nbsp;<span class="builtinfunc" id="7934289">len</span><span class="op" id="7934292">(</span><span class="ident" id="7934293">p</span><span class="op" id="7934294">)</span><span class="op" id="7934295">,</span>&nbsp;<span class="builtintype" id="7934297">nil</span><br>
<span class="lineno"></span><span class="op" id="7934301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7934304">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7934334">func</span>&nbsp;<span class="ident" id="7934339">TestBeChildCGIProcess</span><span class="op" id="7934360">(</span><span class="ident" id="7934361">t</span>&nbsp;<span class="op" id="7934363">*</span><span class="ident" id="7934364">testing</span><span class="op" id="7934371">.</span><span class="ident" id="7934372">T</span><span class="op" id="7934373">)</span>&nbsp;<span class="op" id="7934375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934378">if</span>&nbsp;<span class="ident" id="7934381">os</span><span class="op" id="7934383">.</span><span class="ident" id="7934384">Getenv</span><span class="op" id="7934390">(</span><span class="string" id="7934391">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7934407">)</span>&nbsp;<span class="op" id="7934409">==</span>&nbsp;<span class="string" id="7934412">&#34;&#34;</span>&nbsp;<span class="op" id="7934415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7934419">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934465">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7934473">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934476">switch</span>&nbsp;<span class="ident" id="7934483">os</span><span class="op" id="7934485">.</span><span class="ident" id="7934486">Getenv</span><span class="op" id="7934492">(</span><span class="string" id="7934493">&#34;REQUEST_URI&#34;</span><span class="op" id="7934506">)</span>&nbsp;<span class="op" id="7934508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934511">case</span>&nbsp;<span class="string" id="7934516">&#34;/immediate-disconnect&#34;</span><span class="op" id="7934539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934543">os</span><span class="op" id="7934545">.</span><span class="ident" id="7934546">Exit</span><span class="op" id="7934550">(</span><span class="num" id="7934551">0</span><span class="op" id="7934552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934555">case</span>&nbsp;<span class="string" id="7934560">&#34;/no-content-type&#34;</span><span class="op" id="7934578">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934582">fmt</span><span class="op" id="7934585">.</span><span class="ident" id="7934586">Printf</span><span class="op" id="7934592">(</span><span class="string" id="7934593">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7934623">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934627">os</span><span class="op" id="7934629">.</span><span class="ident" id="7934630">Exit</span><span class="op" id="7934634">(</span><span class="num" id="7934635">0</span><span class="op" id="7934636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934639">case</span>&nbsp;<span class="string" id="7934644">&#34;/empty-headers&#34;</span><span class="op" id="7934660">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934664">fmt</span><span class="op" id="7934667">.</span><span class="ident" id="7934668">Printf</span><span class="op" id="7934674">(</span><span class="string" id="7934675">&#34;\nHello&#34;</span><span class="op" id="7934684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934688">os</span><span class="op" id="7934690">.</span><span class="ident" id="7934691">Exit</span><span class="op" id="7934695">(</span><span class="num" id="7934696">0</span><span class="op" id="7934697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7934700">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934703">Serve</span><span class="op" id="7934708">(</span><span class="ident" id="7934709">http</span><span class="op" id="7934713">.</span><span class="ident" id="7934714">HandlerFunc</span><span class="op" id="7934725">(</span><span class="keyword" id="7934726">func</span><span class="op" id="7934730">(</span><span class="ident" id="7934731">rw</span>&nbsp;<span class="ident" id="7934734">http</span><span class="op" id="7934738">.</span><span class="ident" id="7934739">ResponseWriter</span><span class="op" id="7934753">,</span>&nbsp;<span class="ident" id="7934755">req</span>&nbsp;<span class="op" id="7934759">*</span><span class="ident" id="7934760">http</span><span class="op" id="7934764">.</span><span class="ident" id="7934765">Request</span><span class="op" id="7934772">)</span>&nbsp;<span class="op" id="7934774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934778">rw</span><span class="op" id="7934780">.</span><span class="ident" id="7934781">Header</span><span class="op" id="7934787">(</span><span class="op" id="7934788">)</span><span class="op" id="7934789">.</span><span class="ident" id="7934790">Set</span><span class="op" id="7934793">(</span><span class="string" id="7934794">&#34;X-Test-Header&#34;</span><span class="op" id="7934809">,</span>&nbsp;<span class="string" id="7934811">&#34;X-Test-Value&#34;</span><span class="op" id="7934825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934829">req</span><span class="op" id="7934832">.</span><span class="ident" id="7934833">ParseForm</span><span class="op" id="7934842">(</span><span class="op" id="7934843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934847">if</span>&nbsp;<span class="ident" id="7934850">req</span><span class="op" id="7934853">.</span><span class="ident" id="7934854">FormValue</span><span class="op" id="7934863">(</span><span class="string" id="7934864">&#34;no-body&#34;</span><span class="op" id="7934873">)</span>&nbsp;<span class="op" id="7934875">==</span>&nbsp;<span class="string" id="7934878">&#34;1&#34;</span>&nbsp;<span class="op" id="7934882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934887">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7934896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934900">if</span>&nbsp;<span class="ident" id="7934903">req</span><span class="op" id="7934906">.</span><span class="ident" id="7934907">FormValue</span><span class="op" id="7934916">(</span><span class="string" id="7934917">&#34;write-forever&#34;</span><span class="op" id="7934932">)</span>&nbsp;<span class="op" id="7934934">==</span>&nbsp;<span class="string" id="7934937">&#34;1&#34;</span>&nbsp;<span class="op" id="7934941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934946">io</span><span class="op" id="7934948">.</span><span class="ident" id="7934949">Copy</span><span class="op" id="7934953">(</span><span class="ident" id="7934954">rw</span><span class="op" id="7934956">,</span>&nbsp;<span class="ident" id="7934958">neverEnding</span><span class="op" id="7934969">(</span><span class="string" id="7934970">&#39;a&#39;</span><span class="op" id="7934973">)</span><span class="op" id="7934974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7934979">for</span>&nbsp;<span class="op" id="7934983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7934989">time</span><span class="op" id="7934993">.</span><span class="ident" id="7934994">Sleep</span><span class="op" id="7934999">(</span><span class="num" id="7935000">5</span>&nbsp;<span class="op" id="7935002">*</span>&nbsp;<span class="ident" id="7935004">time</span><span class="op" id="7935008">.</span><span class="ident" id="7935009">Second</span><span class="op" id="7935015">)</span>&nbsp;<span class="comment" id="7935017">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7935050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7935054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7935058">fmt</span><span class="op" id="7935061">.</span><span class="ident" id="7935062">Fprintf</span><span class="op" id="7935069">(</span><span class="ident" id="7935070">rw</span><span class="op" id="7935072">,</span>&nbsp;<span class="string" id="7935074">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7935099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7935103">for</span>&nbsp;<span class="ident" id="7935107">k</span><span class="op" id="7935108">,</span>&nbsp;<span class="ident" id="7935110">vv</span>&nbsp;<span class="op" id="7935113">:=</span>&nbsp;<span class="keyword" id="7935116">range</span>&nbsp;<span class="ident" id="7935122">req</span><span class="op" id="7935125">.</span><span class="ident" id="7935126">Form</span>&nbsp;<span class="op" id="7935131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7935136">for</span>&nbsp;<span class="ident" id="7935140">_</span><span class="op" id="7935141">,</span>&nbsp;<span class="ident" id="7935143">v</span>&nbsp;<span class="op" id="7935145">:=</span>&nbsp;<span class="keyword" id="7935148">range</span>&nbsp;<span class="ident" id="7935154">vv</span>&nbsp;<span class="op" id="7935157">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7935163">fmt</span><span class="op" id="7935166">.</span><span class="ident" id="7935167">Fprintf</span><span class="op" id="7935174">(</span><span class="ident" id="7935175">rw</span><span class="op" id="7935177">,</span>&nbsp;<span class="string" id="7935179">&#34;param-%s=%s\n&#34;</span><span class="op" id="7935194">,</span>&nbsp;<span class="ident" id="7935196">k</span><span class="op" id="7935197">,</span>&nbsp;<span class="ident" id="7935199">v</span><span class="op" id="7935200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7935205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7935209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7935213">for</span>&nbsp;<span class="ident" id="7935217">_</span><span class="op" id="7935218">,</span>&nbsp;<span class="ident" id="7935220">kv</span>&nbsp;<span class="op" id="7935223">:=</span>&nbsp;<span class="keyword" id="7935226">range</span>&nbsp;<span class="ident" id="7935232">os</span><span class="op" id="7935234">.</span><span class="ident" id="7935235">Environ</span><span class="op" id="7935242">(</span><span class="op" id="7935243">)</span>&nbsp;<span class="op" id="7935245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7935250">fmt</span><span class="op" id="7935253">.</span><span class="ident" id="7935254">Fprintf</span><span class="op" id="7935261">(</span><span class="ident" id="7935262">rw</span><span class="op" id="7935264">,</span>&nbsp;<span class="string" id="7935266">&#34;env-%s\n&#34;</span><span class="op" id="7935276">,</span>&nbsp;<span class="ident" id="7935278">kv</span><span class="op" id="7935280">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7935284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7935287">}</span><span class="op" id="7935288">)</span><span class="op" id="7935289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7935292">os</span><span class="op" id="7935294">.</span><span class="ident" id="7935295">Exit</span><span class="op" id="7935299">(</span><span class="num" id="7935300">0</span><span class="op" id="7935301">)</span><br>
<span class="lineno"></span><span class="op" id="7935303">}</span>
</div>
</body>
</html>
