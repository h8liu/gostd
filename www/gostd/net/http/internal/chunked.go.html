<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5107960">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5108015">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5108069">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5108120">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5108182">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5108249">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="5108271">package</span>&nbsp;<span class="ident" id="5108279">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5108289">import</span>&nbsp;<span class="op" id="5108296">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5108299">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5108308">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5108317">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5108327">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5108334">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5108339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5108342">const</span>&nbsp;<span class="ident" id="5108348">maxLineLength</span>&nbsp;<span class="op" id="5108362">=</span>&nbsp;<span class="num" id="5108364">4096</span>&nbsp;<span class="comment" id="5108369">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5108405">var</span>&nbsp;<span class="ident" id="5108409">ErrLineTooLong</span>&nbsp;<span class="op" id="5108424">=</span>&nbsp;<span class="ident" id="5108426">errors</span><span class="op" id="5108432">.</span><span class="ident" id="5108433">New</span><span class="op" id="5108436">(</span><span class="string" id="5108437">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="5108459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5108462">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5108547">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="5108600">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="5108675">//</span><br>
<span class="lineno"></span><span class="comment" id="5108678">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5108753">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="5108817">func</span>&nbsp;<span class="ident" id="5108822">NewChunkedReader</span><span class="op" id="5108838">(</span><span class="ident" id="5108839">r</span>&nbsp;<span class="ident" id="5108841">io</span><span class="op" id="5108843">.</span><span class="ident" id="5108844">Reader</span><span class="op" id="5108850">)</span>&nbsp;<span class="ident" id="5108852">io</span><span class="op" id="5108854">.</span><span class="ident" id="5108855">Reader</span>&nbsp;<span class="op" id="5108862">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108865">br</span><span class="op" id="5108867">,</span>&nbsp;<span class="ident" id="5108869">ok</span>&nbsp;<span class="op" id="5108872">:=</span>&nbsp;<span class="ident" id="5108875">r</span><span class="op" id="5108876">.</span><span class="op" id="5108877">(</span><span class="op" id="5108878">*</span><span class="ident" id="5108879">bufio</span><span class="op" id="5108884">.</span><span class="ident" id="5108885">Reader</span><span class="op" id="5108891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108894">if</span>&nbsp;<span class="op" id="5108897">!</span><span class="ident" id="5108898">ok</span>&nbsp;<span class="op" id="5108901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108905">br</span>&nbsp;<span class="op" id="5108908">=</span>&nbsp;<span class="ident" id="5108910">bufio</span><span class="op" id="5108915">.</span><span class="ident" id="5108916">NewReader</span><span class="op" id="5108925">(</span><span class="ident" id="5108926">r</span><span class="op" id="5108927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5108930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108933">return</span>&nbsp;<span class="op" id="5108940">&amp;</span><span class="ident" id="5108941">chunkedReader</span><span class="op" id="5108954">{</span><span class="ident" id="5108955">r</span><span class="op" id="5108956">:</span>&nbsp;<span class="ident" id="5108958">br</span><span class="op" id="5108960">}</span><br>
<span class="lineno">35</span><span class="op" id="5108962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5108965">type</span>&nbsp;<span class="ident" id="5108970">chunkedReader</span>&nbsp;<span class="keyword" id="5108984">struct</span>&nbsp;<span class="op" id="5108991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108994">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5108998">*</span><span class="ident" id="5108999">bufio</span><span class="op" id="5109004">.</span><span class="ident" id="5109005">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109013">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5109017">uint64</span>&nbsp;<span class="comment" id="5109024">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109050">err</span>&nbsp;<span class="builtintype" id="5109054">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109061">buf</span>&nbsp;<span class="op" id="5109065">[</span><span class="num" id="5109066">2</span><span class="op" id="5109067">]</span><span class="builtintype" id="5109068">byte</span><br>
<span class="lineno"></span><span class="op" id="5109073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5109076">func</span>&nbsp;<span class="op" id="5109081">(</span><span class="ident" id="5109082">cr</span>&nbsp;<span class="op" id="5109085">*</span><span class="ident" id="5109086">chunkedReader</span><span class="op" id="5109099">)</span>&nbsp;<span class="ident" id="5109101">beginChunk</span><span class="op" id="5109111">(</span><span class="op" id="5109112">)</span>&nbsp;<span class="op" id="5109114">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5109117">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109137">var</span>&nbsp;<span class="ident" id="5109141">line</span>&nbsp;<span class="op" id="5109146">[</span><span class="op" id="5109147">]</span><span class="builtintype" id="5109148">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109154">line</span><span class="op" id="5109158">,</span>&nbsp;<span class="ident" id="5109160">cr</span><span class="op" id="5109162">.</span><span class="ident" id="5109163">err</span>&nbsp;<span class="op" id="5109167">=</span>&nbsp;<span class="ident" id="5109169">readLine</span><span class="op" id="5109177">(</span><span class="ident" id="5109178">cr</span><span class="op" id="5109180">.</span><span class="ident" id="5109181">r</span><span class="op" id="5109182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109185">if</span>&nbsp;<span class="ident" id="5109188">cr</span><span class="op" id="5109190">.</span><span class="ident" id="5109191">err</span>&nbsp;<span class="op" id="5109195">!=</span>&nbsp;<span class="ident" id="5109198">nil</span>&nbsp;<span class="op" id="5109202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109206">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109217">cr</span><span class="op" id="5109219">.</span><span class="ident" id="5109220">n</span><span class="op" id="5109221">,</span>&nbsp;<span class="ident" id="5109223">cr</span><span class="op" id="5109225">.</span><span class="ident" id="5109226">err</span>&nbsp;<span class="op" id="5109230">=</span>&nbsp;<span class="ident" id="5109232">parseHexUint</span><span class="op" id="5109244">(</span><span class="ident" id="5109245">line</span><span class="op" id="5109249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109252">if</span>&nbsp;<span class="ident" id="5109255">cr</span><span class="op" id="5109257">.</span><span class="ident" id="5109258">err</span>&nbsp;<span class="op" id="5109262">!=</span>&nbsp;<span class="ident" id="5109265">nil</span>&nbsp;<span class="op" id="5109269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109273">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109281">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109284">if</span>&nbsp;<span class="ident" id="5109287">cr</span><span class="op" id="5109289">.</span><span class="ident" id="5109290">n</span>&nbsp;<span class="op" id="5109292">==</span>&nbsp;<span class="num" id="5109295">0</span>&nbsp;<span class="op" id="5109297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109301">cr</span><span class="op" id="5109303">.</span><span class="ident" id="5109304">err</span>&nbsp;<span class="op" id="5109308">=</span>&nbsp;<span class="ident" id="5109310">io</span><span class="op" id="5109312">.</span><span class="ident" id="5109313">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109318">}</span><br>
<span class="lineno"></span><span class="op" id="5109320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5109323">func</span>&nbsp;<span class="op" id="5109328">(</span><span class="ident" id="5109329">cr</span>&nbsp;<span class="op" id="5109332">*</span><span class="ident" id="5109333">chunkedReader</span><span class="op" id="5109346">)</span>&nbsp;<span class="ident" id="5109348">chunkHeaderAvailable</span><span class="op" id="5109368">(</span><span class="op" id="5109369">)</span>&nbsp;<span class="builtintype" id="5109371">bool</span>&nbsp;<span class="op" id="5109376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109379">n</span>&nbsp;<span class="op" id="5109381">:=</span>&nbsp;<span class="ident" id="5109384">cr</span><span class="op" id="5109386">.</span><span class="ident" id="5109387">r</span><span class="op" id="5109388">.</span><span class="ident" id="5109389">Buffered</span><span class="op" id="5109397">(</span><span class="op" id="5109398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109401">if</span>&nbsp;<span class="ident" id="5109404">n</span>&nbsp;<span class="op" id="5109406">&gt;</span>&nbsp;<span class="num" id="5109408">0</span>&nbsp;<span class="op" id="5109410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109414">peek</span><span class="op" id="5109418">,</span>&nbsp;<span class="ident" id="5109420">_</span>&nbsp;<span class="op" id="5109422">:=</span>&nbsp;<span class="ident" id="5109425">cr</span><span class="op" id="5109427">.</span><span class="ident" id="5109428">r</span><span class="op" id="5109429">.</span><span class="ident" id="5109430">Peek</span><span class="op" id="5109434">(</span><span class="ident" id="5109435">n</span><span class="op" id="5109436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109440">return</span>&nbsp;<span class="ident" id="5109447">bytes</span><span class="op" id="5109452">.</span><span class="ident" id="5109453">IndexByte</span><span class="op" id="5109462">(</span><span class="ident" id="5109463">peek</span><span class="op" id="5109467">,</span>&nbsp;<span class="string" id="5109469">&#39;\n&#39;</span><span class="op" id="5109473">)</span>&nbsp;<span class="op" id="5109475">&gt;=</span>&nbsp;<span class="num" id="5109478">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109484">return</span>&nbsp;<span class="builtintype" id="5109491">false</span><br>
<span class="lineno"></span><span class="op" id="5109497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5109500">func</span>&nbsp;<span class="op" id="5109505">(</span><span class="ident" id="5109506">cr</span>&nbsp;<span class="op" id="5109509">*</span><span class="ident" id="5109510">chunkedReader</span><span class="op" id="5109523">)</span>&nbsp;<span class="ident" id="5109525">Read</span><span class="op" id="5109529">(</span><span class="ident" id="5109530">b</span>&nbsp;<span class="op" id="5109532">[</span><span class="op" id="5109533">]</span><span class="builtintype" id="5109534">uint8</span><span class="op" id="5109539">)</span>&nbsp;<span class="op" id="5109541">(</span><span class="ident" id="5109542">n</span>&nbsp;<span class="builtintype" id="5109544">int</span><span class="op" id="5109547">,</span>&nbsp;<span class="ident" id="5109549">err</span>&nbsp;<span class="builtintype" id="5109553">error</span><span class="op" id="5109558">)</span>&nbsp;<span class="op" id="5109560">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109563">for</span>&nbsp;<span class="ident" id="5109567">cr</span><span class="op" id="5109569">.</span><span class="ident" id="5109570">err</span>&nbsp;<span class="op" id="5109574">==</span>&nbsp;<span class="ident" id="5109577">nil</span>&nbsp;<span class="op" id="5109581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109585">if</span>&nbsp;<span class="ident" id="5109588">cr</span><span class="op" id="5109590">.</span><span class="ident" id="5109591">n</span>&nbsp;<span class="op" id="5109593">==</span>&nbsp;<span class="num" id="5109596">0</span>&nbsp;<span class="op" id="5109598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109603">if</span>&nbsp;<span class="ident" id="5109606">n</span>&nbsp;<span class="op" id="5109608">&gt;</span>&nbsp;<span class="num" id="5109610">0</span>&nbsp;<span class="op" id="5109612">&amp;&amp;</span>&nbsp;<span class="op" id="5109615">!</span><span class="ident" id="5109616">cr</span><span class="op" id="5109618">.</span><span class="ident" id="5109619">chunkHeaderAvailable</span><span class="op" id="5109639">(</span><span class="op" id="5109640">)</span>&nbsp;<span class="op" id="5109642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5109648">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5109698">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109733">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109747">cr</span><span class="op" id="5109749">.</span><span class="ident" id="5109750">beginChunk</span><span class="op" id="5109760">(</span><span class="op" id="5109761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109766">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109777">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109781">if</span>&nbsp;<span class="builtinfunc" id="5109784">len</span><span class="op" id="5109787">(</span><span class="ident" id="5109788">b</span><span class="op" id="5109789">)</span>&nbsp;<span class="op" id="5109791">==</span>&nbsp;<span class="num" id="5109794">0</span>&nbsp;<span class="op" id="5109796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109801">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109813">rbuf</span>&nbsp;<span class="op" id="5109818">:=</span>&nbsp;<span class="ident" id="5109821">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109825">if</span>&nbsp;<span class="ident" id="5109828">uint64</span><span class="op" id="5109834">(</span><span class="builtinfunc" id="5109835">len</span><span class="op" id="5109838">(</span><span class="ident" id="5109839">rbuf</span><span class="op" id="5109843">)</span><span class="op" id="5109844">)</span>&nbsp;<span class="op" id="5109846">&gt;</span>&nbsp;<span class="ident" id="5109848">cr</span><span class="op" id="5109850">.</span><span class="ident" id="5109851">n</span>&nbsp;<span class="op" id="5109853">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109858">rbuf</span>&nbsp;<span class="op" id="5109863">=</span>&nbsp;<span class="ident" id="5109865">rbuf</span><span class="op" id="5109869">[</span><span class="op" id="5109870">:</span><span class="ident" id="5109871">cr</span><span class="op" id="5109873">.</span><span class="ident" id="5109874">n</span><span class="op" id="5109875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109883">var</span>&nbsp;<span class="ident" id="5109887">n0</span>&nbsp;<span class="builtintype" id="5109890">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109896">n0</span><span class="op" id="5109898">,</span>&nbsp;<span class="ident" id="5109900">cr</span><span class="op" id="5109902">.</span><span class="ident" id="5109903">err</span>&nbsp;<span class="op" id="5109907">=</span>&nbsp;<span class="ident" id="5109909">cr</span><span class="op" id="5109911">.</span><span class="ident" id="5109912">r</span><span class="op" id="5109913">.</span><span class="ident" id="5109914">Read</span><span class="op" id="5109918">(</span><span class="ident" id="5109919">rbuf</span><span class="op" id="5109923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109927">n</span>&nbsp;<span class="op" id="5109929">+=</span>&nbsp;<span class="ident" id="5109932">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109937">b</span>&nbsp;<span class="op" id="5109939">=</span>&nbsp;<span class="ident" id="5109941">b</span><span class="op" id="5109942">[</span><span class="ident" id="5109943">n0</span><span class="op" id="5109945">:</span><span class="op" id="5109946">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109950">cr</span><span class="op" id="5109952">.</span><span class="ident" id="5109953">n</span>&nbsp;<span class="op" id="5109955">-=</span>&nbsp;<span class="ident" id="5109958">uint64</span><span class="op" id="5109964">(</span><span class="ident" id="5109965">n0</span><span class="op" id="5109967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5109971">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5110026">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110064">if</span>&nbsp;<span class="ident" id="5110067">cr</span><span class="op" id="5110069">.</span><span class="ident" id="5110070">n</span>&nbsp;<span class="op" id="5110072">==</span>&nbsp;<span class="num" id="5110075">0</span>&nbsp;<span class="op" id="5110077">&amp;&amp;</span>&nbsp;<span class="ident" id="5110080">cr</span><span class="op" id="5110082">.</span><span class="ident" id="5110083">err</span>&nbsp;<span class="op" id="5110087">==</span>&nbsp;<span class="ident" id="5110090">nil</span>&nbsp;<span class="op" id="5110094">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110099">if</span>&nbsp;<span class="ident" id="5110102">_</span><span class="op" id="5110103">,</span>&nbsp;<span class="ident" id="5110105">cr</span><span class="op" id="5110107">.</span><span class="ident" id="5110108">err</span>&nbsp;<span class="op" id="5110112">=</span>&nbsp;<span class="ident" id="5110114">io</span><span class="op" id="5110116">.</span><span class="ident" id="5110117">ReadFull</span><span class="op" id="5110125">(</span><span class="ident" id="5110126">cr</span><span class="op" id="5110128">.</span><span class="ident" id="5110129">r</span><span class="op" id="5110130">,</span>&nbsp;<span class="ident" id="5110132">cr</span><span class="op" id="5110134">.</span><span class="ident" id="5110135">buf</span><span class="op" id="5110138">[</span><span class="op" id="5110139">:</span><span class="num" id="5110140">2</span><span class="op" id="5110141">]</span><span class="op" id="5110142">)</span><span class="op" id="5110143">;</span>&nbsp;<span class="ident" id="5110145">cr</span><span class="op" id="5110147">.</span><span class="ident" id="5110148">err</span>&nbsp;<span class="op" id="5110152">==</span>&nbsp;<span class="ident" id="5110155">nil</span>&nbsp;<span class="op" id="5110159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110165">if</span>&nbsp;<span class="ident" id="5110168">cr</span><span class="op" id="5110170">.</span><span class="ident" id="5110171">buf</span><span class="op" id="5110174">[</span><span class="num" id="5110175">0</span><span class="op" id="5110176">]</span>&nbsp;<span class="op" id="5110178">!=</span>&nbsp;<span class="string" id="5110181">&#39;\r&#39;</span>&nbsp;<span class="op" id="5110186">||</span>&nbsp;<span class="ident" id="5110189">cr</span><span class="op" id="5110191">.</span><span class="ident" id="5110192">buf</span><span class="op" id="5110195">[</span><span class="num" id="5110196">1</span><span class="op" id="5110197">]</span>&nbsp;<span class="op" id="5110199">!=</span>&nbsp;<span class="string" id="5110202">&#39;\n&#39;</span>&nbsp;<span class="op" id="5110207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110214">cr</span><span class="op" id="5110216">.</span><span class="ident" id="5110217">err</span>&nbsp;<span class="op" id="5110221">=</span>&nbsp;<span class="ident" id="5110223">errors</span><span class="op" id="5110229">.</span><span class="ident" id="5110230">New</span><span class="op" id="5110233">(</span><span class="string" id="5110234">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="5110262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110273">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110283">return</span>&nbsp;<span class="ident" id="5110290">n</span><span class="op" id="5110291">,</span>&nbsp;<span class="ident" id="5110293">cr</span><span class="op" id="5110295">.</span><span class="ident" id="5110296">err</span><br>
<span class="lineno"></span><span class="op" id="5110300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5110303">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5110346">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="5110392">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5110444">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="5110508">func</span>&nbsp;<span class="ident" id="5110513">readLine</span><span class="op" id="5110521">(</span><span class="ident" id="5110522">b</span>&nbsp;<span class="op" id="5110524">*</span><span class="ident" id="5110525">bufio</span><span class="op" id="5110530">.</span><span class="ident" id="5110531">Reader</span><span class="op" id="5110537">)</span>&nbsp;<span class="op" id="5110539">(</span><span class="ident" id="5110540">p</span>&nbsp;<span class="op" id="5110542">[</span><span class="op" id="5110543">]</span><span class="builtintype" id="5110544">byte</span><span class="op" id="5110548">,</span>&nbsp;<span class="ident" id="5110550">err</span>&nbsp;<span class="builtintype" id="5110554">error</span><span class="op" id="5110559">)</span>&nbsp;<span class="op" id="5110561">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110564">if</span>&nbsp;<span class="ident" id="5110567">p</span><span class="op" id="5110568">,</span>&nbsp;<span class="ident" id="5110570">err</span>&nbsp;<span class="op" id="5110574">=</span>&nbsp;<span class="ident" id="5110576">b</span><span class="op" id="5110577">.</span><span class="ident" id="5110578">ReadSlice</span><span class="op" id="5110587">(</span><span class="string" id="5110588">&#39;\n&#39;</span><span class="op" id="5110592">)</span><span class="op" id="5110593">;</span>&nbsp;<span class="ident" id="5110595">err</span>&nbsp;<span class="op" id="5110599">!=</span>&nbsp;<span class="ident" id="5110602">nil</span>&nbsp;<span class="op" id="5110606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5110610">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5110650">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110711">if</span>&nbsp;<span class="ident" id="5110714">err</span>&nbsp;<span class="op" id="5110718">==</span>&nbsp;<span class="ident" id="5110721">io</span><span class="op" id="5110723">.</span><span class="ident" id="5110724">EOF</span>&nbsp;<span class="op" id="5110728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110733">err</span>&nbsp;<span class="op" id="5110737">=</span>&nbsp;<span class="ident" id="5110739">io</span><span class="op" id="5110741">.</span><span class="ident" id="5110742">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110761">}</span>&nbsp;<span class="keyword" id="5110763">else</span>&nbsp;<span class="keyword" id="5110768">if</span>&nbsp;<span class="ident" id="5110771">err</span>&nbsp;<span class="op" id="5110775">==</span>&nbsp;<span class="ident" id="5110778">bufio</span><span class="op" id="5110783">.</span><span class="ident" id="5110784">ErrBufferFull</span>&nbsp;<span class="op" id="5110798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110803">err</span>&nbsp;<span class="op" id="5110807">=</span>&nbsp;<span class="ident" id="5110809">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110830">return</span>&nbsp;<span class="ident" id="5110837">nil</span><span class="op" id="5110840">,</span>&nbsp;<span class="ident" id="5110842">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110847">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110850">if</span>&nbsp;<span class="builtinfunc" id="5110853">len</span><span class="op" id="5110856">(</span><span class="ident" id="5110857">p</span><span class="op" id="5110858">)</span>&nbsp;<span class="op" id="5110860">&gt;=</span>&nbsp;<span class="ident" id="5110863">maxLineLength</span>&nbsp;<span class="op" id="5110877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110881">return</span>&nbsp;<span class="ident" id="5110888">nil</span><span class="op" id="5110891">,</span>&nbsp;<span class="ident" id="5110893">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5110909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110912">return</span>&nbsp;<span class="ident" id="5110919">trimTrailingWhitespace</span><span class="op" id="5110941">(</span><span class="ident" id="5110942">p</span><span class="op" id="5110943">)</span><span class="op" id="5110944">,</span>&nbsp;<span class="ident" id="5110946">nil</span><br>
<span class="lineno"></span><span class="op" id="5110950">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="5110953">func</span>&nbsp;<span class="ident" id="5110958">trimTrailingWhitespace</span><span class="op" id="5110980">(</span><span class="ident" id="5110981">b</span>&nbsp;<span class="op" id="5110983">[</span><span class="op" id="5110984">]</span><span class="builtintype" id="5110985">byte</span><span class="op" id="5110989">)</span>&nbsp;<span class="op" id="5110991">[</span><span class="op" id="5110992">]</span><span class="builtintype" id="5110993">byte</span>&nbsp;<span class="op" id="5110998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111001">for</span>&nbsp;<span class="builtinfunc" id="5111005">len</span><span class="op" id="5111008">(</span><span class="ident" id="5111009">b</span><span class="op" id="5111010">)</span>&nbsp;<span class="op" id="5111012">&gt;</span>&nbsp;<span class="num" id="5111014">0</span>&nbsp;<span class="op" id="5111016">&amp;&amp;</span>&nbsp;<span class="ident" id="5111019">isASCIISpace</span><span class="op" id="5111031">(</span><span class="ident" id="5111032">b</span><span class="op" id="5111033">[</span><span class="builtinfunc" id="5111034">len</span><span class="op" id="5111037">(</span><span class="ident" id="5111038">b</span><span class="op" id="5111039">)</span><span class="op" id="5111040">-</span><span class="num" id="5111041">1</span><span class="op" id="5111042">]</span><span class="op" id="5111043">)</span>&nbsp;<span class="op" id="5111045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111049">b</span>&nbsp;<span class="op" id="5111051">=</span>&nbsp;<span class="ident" id="5111053">b</span><span class="op" id="5111054">[</span><span class="op" id="5111055">:</span><span class="builtinfunc" id="5111056">len</span><span class="op" id="5111059">(</span><span class="ident" id="5111060">b</span><span class="op" id="5111061">)</span><span class="op" id="5111062">-</span><span class="num" id="5111063">1</span><span class="op" id="5111064">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111067">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111070">return</span>&nbsp;<span class="ident" id="5111077">b</span><br>
<span class="lineno"></span><span class="op" id="5111079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5111082">func</span>&nbsp;<span class="ident" id="5111087">isASCIISpace</span><span class="op" id="5111099">(</span><span class="ident" id="5111100">b</span>&nbsp;<span class="builtintype" id="5111102">byte</span><span class="op" id="5111106">)</span>&nbsp;<span class="builtintype" id="5111108">bool</span>&nbsp;<span class="op" id="5111113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111116">return</span>&nbsp;<span class="ident" id="5111123">b</span>&nbsp;<span class="op" id="5111125">==</span>&nbsp;<span class="string" id="5111128">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5111132">||</span>&nbsp;<span class="ident" id="5111135">b</span>&nbsp;<span class="op" id="5111137">==</span>&nbsp;<span class="string" id="5111140">&#39;\t&#39;</span>&nbsp;<span class="op" id="5111145">||</span>&nbsp;<span class="ident" id="5111148">b</span>&nbsp;<span class="op" id="5111150">==</span>&nbsp;<span class="string" id="5111153">&#39;\n&#39;</span>&nbsp;<span class="op" id="5111158">||</span>&nbsp;<span class="ident" id="5111161">b</span>&nbsp;<span class="op" id="5111163">==</span>&nbsp;<span class="string" id="5111166">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="5111171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5111174">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="5111255">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="5111336">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="5111404">//</span><br>
<span class="lineno"></span><span class="comment" id="5111407">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="5111474">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5111537">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5111603">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="5111672">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="5111708">func</span>&nbsp;<span class="ident" id="5111713">NewChunkedWriter</span><span class="op" id="5111729">(</span><span class="ident" id="5111730">w</span>&nbsp;<span class="ident" id="5111732">io</span><span class="op" id="5111734">.</span><span class="ident" id="5111735">Writer</span><span class="op" id="5111741">)</span>&nbsp;<span class="ident" id="5111743">io</span><span class="op" id="5111745">.</span><span class="ident" id="5111746">WriteCloser</span>&nbsp;<span class="op" id="5111758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111761">return</span>&nbsp;<span class="op" id="5111768">&amp;</span><span class="ident" id="5111769">chunkedWriter</span><span class="op" id="5111782">{</span><span class="ident" id="5111783">w</span><span class="op" id="5111784">}</span><br>
<span class="lineno"></span><span class="op" id="5111786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="5111789">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="5111864">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5111926">type</span>&nbsp;<span class="ident" id="5111931">chunkedWriter</span>&nbsp;<span class="keyword" id="5111945">struct</span>&nbsp;<span class="op" id="5111952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111955">Wire</span>&nbsp;<span class="ident" id="5111960">io</span><span class="op" id="5111962">.</span><span class="ident" id="5111963">Writer</span><br>
<span class="lineno"></span><span class="op" id="5111970">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5111973">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="5112025">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5112104">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="5112167">func</span>&nbsp;<span class="op" id="5112172">(</span><span class="ident" id="5112173">cw</span>&nbsp;<span class="op" id="5112176">*</span><span class="ident" id="5112177">chunkedWriter</span><span class="op" id="5112190">)</span>&nbsp;<span class="ident" id="5112192">Write</span><span class="op" id="5112197">(</span><span class="ident" id="5112198">data</span>&nbsp;<span class="op" id="5112203">[</span><span class="op" id="5112204">]</span><span class="builtintype" id="5112205">byte</span><span class="op" id="5112209">)</span>&nbsp;<span class="op" id="5112211">(</span><span class="ident" id="5112212">n</span>&nbsp;<span class="builtintype" id="5112214">int</span><span class="op" id="5112217">,</span>&nbsp;<span class="ident" id="5112219">err</span>&nbsp;<span class="builtintype" id="5112223">error</span><span class="op" id="5112228">)</span>&nbsp;<span class="op" id="5112230">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5112234">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112304">if</span>&nbsp;<span class="builtinfunc" id="5112307">len</span><span class="op" id="5112310">(</span><span class="ident" id="5112311">data</span><span class="op" id="5112315">)</span>&nbsp;<span class="op" id="5112317">==</span>&nbsp;<span class="num" id="5112320">0</span>&nbsp;<span class="op" id="5112322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112326">return</span>&nbsp;<span class="num" id="5112333">0</span><span class="op" id="5112334">,</span>&nbsp;<span class="ident" id="5112336">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112341">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112345">if</span>&nbsp;<span class="ident" id="5112348">_</span><span class="op" id="5112349">,</span>&nbsp;<span class="ident" id="5112351">err</span>&nbsp;<span class="op" id="5112355">=</span>&nbsp;<span class="ident" id="5112357">fmt</span><span class="op" id="5112360">.</span><span class="ident" id="5112361">Fprintf</span><span class="op" id="5112368">(</span><span class="ident" id="5112369">cw</span><span class="op" id="5112371">.</span><span class="ident" id="5112372">Wire</span><span class="op" id="5112376">,</span>&nbsp;<span class="string" id="5112378">&#34;%x\r\n&#34;</span><span class="op" id="5112386">,</span>&nbsp;<span class="builtinfunc" id="5112388">len</span><span class="op" id="5112391">(</span><span class="ident" id="5112392">data</span><span class="op" id="5112396">)</span><span class="op" id="5112397">)</span><span class="op" id="5112398">;</span>&nbsp;<span class="ident" id="5112400">err</span>&nbsp;<span class="op" id="5112404">!=</span>&nbsp;<span class="ident" id="5112407">nil</span>&nbsp;<span class="op" id="5112411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112415">return</span>&nbsp;<span class="num" id="5112422">0</span><span class="op" id="5112423">,</span>&nbsp;<span class="ident" id="5112425">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112433">if</span>&nbsp;<span class="ident" id="5112436">n</span><span class="op" id="5112437">,</span>&nbsp;<span class="ident" id="5112439">err</span>&nbsp;<span class="op" id="5112443">=</span>&nbsp;<span class="ident" id="5112445">cw</span><span class="op" id="5112447">.</span><span class="ident" id="5112448">Wire</span><span class="op" id="5112452">.</span><span class="ident" id="5112453">Write</span><span class="op" id="5112458">(</span><span class="ident" id="5112459">data</span><span class="op" id="5112463">)</span><span class="op" id="5112464">;</span>&nbsp;<span class="ident" id="5112466">err</span>&nbsp;<span class="op" id="5112470">!=</span>&nbsp;<span class="ident" id="5112473">nil</span>&nbsp;<span class="op" id="5112477">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112481">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112492">if</span>&nbsp;<span class="ident" id="5112495">n</span>&nbsp;<span class="op" id="5112497">!=</span>&nbsp;<span class="builtinfunc" id="5112500">len</span><span class="op" id="5112503">(</span><span class="ident" id="5112504">data</span><span class="op" id="5112508">)</span>&nbsp;<span class="op" id="5112510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112514">err</span>&nbsp;<span class="op" id="5112518">=</span>&nbsp;<span class="ident" id="5112520">io</span><span class="op" id="5112522">.</span><span class="ident" id="5112523">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112539">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112550">_</span><span class="op" id="5112551">,</span>&nbsp;<span class="ident" id="5112553">err</span>&nbsp;<span class="op" id="5112557">=</span>&nbsp;<span class="ident" id="5112559">io</span><span class="op" id="5112561">.</span><span class="ident" id="5112562">WriteString</span><span class="op" id="5112573">(</span><span class="ident" id="5112574">cw</span><span class="op" id="5112576">.</span><span class="ident" id="5112577">Wire</span><span class="op" id="5112581">,</span>&nbsp;<span class="string" id="5112583">&#34;\r\n&#34;</span><span class="op" id="5112589">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112593">return</span><br>
<span class="lineno"></span><span class="op" id="5112600">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="5112603">func</span>&nbsp;<span class="op" id="5112608">(</span><span class="ident" id="5112609">cw</span>&nbsp;<span class="op" id="5112612">*</span><span class="ident" id="5112613">chunkedWriter</span><span class="op" id="5112626">)</span>&nbsp;<span class="ident" id="5112628">Close</span><span class="op" id="5112633">(</span><span class="op" id="5112634">)</span>&nbsp;<span class="builtintype" id="5112636">error</span>&nbsp;<span class="op" id="5112642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112645">_</span><span class="op" id="5112646">,</span>&nbsp;<span class="ident" id="5112648">err</span>&nbsp;<span class="op" id="5112652">:=</span>&nbsp;<span class="ident" id="5112655">io</span><span class="op" id="5112657">.</span><span class="ident" id="5112658">WriteString</span><span class="op" id="5112669">(</span><span class="ident" id="5112670">cw</span><span class="op" id="5112672">.</span><span class="ident" id="5112673">Wire</span><span class="op" id="5112677">,</span>&nbsp;<span class="string" id="5112679">&#34;0\r\n&#34;</span><span class="op" id="5112686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112689">return</span>&nbsp;<span class="ident" id="5112696">err</span><br>
<span class="lineno"></span><span class="op" id="5112700">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="5112703">func</span>&nbsp;<span class="ident" id="5112708">parseHexUint</span><span class="op" id="5112720">(</span><span class="ident" id="5112721">v</span>&nbsp;<span class="op" id="5112723">[</span><span class="op" id="5112724">]</span><span class="builtintype" id="5112725">byte</span><span class="op" id="5112729">)</span>&nbsp;<span class="op" id="5112731">(</span><span class="ident" id="5112732">n</span>&nbsp;<span class="ident" id="5112734">uint64</span><span class="op" id="5112740">,</span>&nbsp;<span class="ident" id="5112742">err</span>&nbsp;<span class="builtintype" id="5112746">error</span><span class="op" id="5112751">)</span>&nbsp;<span class="op" id="5112753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112756">for</span>&nbsp;<span class="ident" id="5112760">_</span><span class="op" id="5112761">,</span>&nbsp;<span class="ident" id="5112763">b</span>&nbsp;<span class="op" id="5112765">:=</span>&nbsp;<span class="keyword" id="5112768">range</span>&nbsp;<span class="ident" id="5112774">v</span>&nbsp;<span class="op" id="5112776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112780">n</span>&nbsp;<span class="op" id="5112782">&lt;&lt;=</span>&nbsp;<span class="num" id="5112786">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112790">switch</span>&nbsp;<span class="op" id="5112797">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112801">case</span>&nbsp;<span class="string" id="5112806">&#39;0&#39;</span>&nbsp;<span class="op" id="5112810">&lt;=</span>&nbsp;<span class="ident" id="5112813">b</span>&nbsp;<span class="op" id="5112815">&amp;&amp;</span>&nbsp;<span class="ident" id="5112818">b</span>&nbsp;<span class="op" id="5112820">&lt;=</span>&nbsp;<span class="string" id="5112823">&#39;9&#39;</span><span class="op" id="5112826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112831">b</span>&nbsp;<span class="op" id="5112833">=</span>&nbsp;<span class="ident" id="5112835">b</span>&nbsp;<span class="op" id="5112837">-</span>&nbsp;<span class="string" id="5112839">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112845">case</span>&nbsp;<span class="string" id="5112850">&#39;a&#39;</span>&nbsp;<span class="op" id="5112854">&lt;=</span>&nbsp;<span class="ident" id="5112857">b</span>&nbsp;<span class="op" id="5112859">&amp;&amp;</span>&nbsp;<span class="ident" id="5112862">b</span>&nbsp;<span class="op" id="5112864">&lt;=</span>&nbsp;<span class="string" id="5112867">&#39;f&#39;</span><span class="op" id="5112870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112875">b</span>&nbsp;<span class="op" id="5112877">=</span>&nbsp;<span class="ident" id="5112879">b</span>&nbsp;<span class="op" id="5112881">-</span>&nbsp;<span class="string" id="5112883">&#39;a&#39;</span>&nbsp;<span class="op" id="5112887">+</span>&nbsp;<span class="num" id="5112889">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112894">case</span>&nbsp;<span class="string" id="5112899">&#39;A&#39;</span>&nbsp;<span class="op" id="5112903">&lt;=</span>&nbsp;<span class="ident" id="5112906">b</span>&nbsp;<span class="op" id="5112908">&amp;&amp;</span>&nbsp;<span class="ident" id="5112911">b</span>&nbsp;<span class="op" id="5112913">&lt;=</span>&nbsp;<span class="string" id="5112916">&#39;F&#39;</span><span class="op" id="5112919">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112924">b</span>&nbsp;<span class="op" id="5112926">=</span>&nbsp;<span class="ident" id="5112928">b</span>&nbsp;<span class="op" id="5112930">-</span>&nbsp;<span class="string" id="5112932">&#39;A&#39;</span>&nbsp;<span class="op" id="5112936">+</span>&nbsp;<span class="num" id="5112938">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112943">default</span><span class="op" id="5112950">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112955">return</span>&nbsp;<span class="num" id="5112962">0</span><span class="op" id="5112963">,</span>&nbsp;<span class="ident" id="5112965">errors</span><span class="op" id="5112971">.</span><span class="ident" id="5112972">New</span><span class="op" id="5112975">(</span><span class="string" id="5112976">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="5113006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113014">n</span>&nbsp;<span class="op" id="5113016">|=</span>&nbsp;<span class="ident" id="5113019">uint64</span><span class="op" id="5113025">(</span><span class="ident" id="5113026">b</span><span class="op" id="5113027">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113033">return</span><br>
<span class="lineno"></span><span class="op" id="5113040">}</span>
</div>
</body>
</html>
