<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html" class="current">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5568744">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5568799">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5568853">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5568904">package</span>&nbsp;<span class="ident" id="5568912">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5568918">import</span>&nbsp;<span class="op" id="5568925">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5568928">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5568933">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="5568936">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5569014">const</span>&nbsp;<span class="ident" id="5569020">maxCodeLength</span>&nbsp;<span class="op" id="5569034">=</span>&nbsp;<span class="num" id="5569036">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5569040">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="5569115">const</span>&nbsp;<span class="ident" id="5569121">maxNCodes</span>&nbsp;<span class="op" id="5569131">=</span>&nbsp;<span class="num" id="5569133">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5569138">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="5569207">const</span>&nbsp;<span class="ident" id="5569213">lutSize</span>&nbsp;<span class="op" id="5569221">=</span>&nbsp;<span class="num" id="5569223">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5569226">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="5569283">type</span>&nbsp;<span class="ident" id="5569288">huffman</span>&nbsp;<span class="keyword" id="5569296">struct</span>&nbsp;<span class="op" id="5569303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569306">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5569353">nCodes</span>&nbsp;<span class="builtintype" id="5569360">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569367">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569441">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569513">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569586">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5569604">lut</span>&nbsp;<span class="op" id="5569608">[</span><span class="num" id="5569609">1</span>&nbsp;<span class="op" id="5569611">&lt;&lt;</span>&nbsp;<span class="ident" id="5569614">lutSize</span><span class="op" id="5569621">]</span><span class="builtintype" id="5569622">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569630">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5569689">vals</span>&nbsp;<span class="op" id="5569694">[</span><span class="ident" id="5569695">maxNCodes</span><span class="op" id="5569704">]</span><span class="builtintype" id="5569705">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569712">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569783">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5569809">minCodes</span>&nbsp;<span class="op" id="5569818">[</span><span class="ident" id="5569819">maxCodeLength</span><span class="op" id="5569832">]</span><span class="builtintype" id="5569833">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569840">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569911">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5569937">maxCodes</span>&nbsp;<span class="op" id="5569946">[</span><span class="ident" id="5569947">maxCodeLength</span><span class="op" id="5569960">]</span><span class="builtintype" id="5569961">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5569968">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570026">valsIndices</span>&nbsp;<span class="op" id="5570038">[</span><span class="ident" id="5570039">maxCodeLength</span><span class="op" id="5570052">]</span><span class="builtintype" id="5570053">int32</span><br>
<span class="lineno"></span><span class="op" id="5570059">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5570062">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="5570138">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5570155">var</span>&nbsp;<span class="ident" id="5570159">errShortHuffmanData</span>&nbsp;<span class="op" id="5570179">=</span>&nbsp;<span class="ident" id="5570181">FormatError</span><span class="op" id="5570192">(</span><span class="string" id="5570193">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="5570213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5570216">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5570294">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="5570371">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="5570446">func</span>&nbsp;<span class="op" id="5570451">(</span><span class="ident" id="5570452">d</span>&nbsp;<span class="op" id="5570454">*</span><span class="ident" id="5570455">decoder</span><span class="op" id="5570462">)</span>&nbsp;<span class="ident" id="5570464">ensureNBits</span><span class="op" id="5570475">(</span><span class="ident" id="5570476">n</span>&nbsp;<span class="builtintype" id="5570478">int32</span><span class="op" id="5570483">)</span>&nbsp;<span class="builtintype" id="5570485">error</span>&nbsp;<span class="op" id="5570491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570494">for</span>&nbsp;<span class="op" id="5570498">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570502">c</span><span class="op" id="5570503">,</span>&nbsp;<span class="ident" id="5570505">err</span>&nbsp;<span class="op" id="5570509">:=</span>&nbsp;<span class="ident" id="5570512">d</span><span class="op" id="5570513">.</span><span class="ident" id="5570514">readByteStuffedByte</span><span class="op" id="5570533">(</span><span class="op" id="5570534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570538">if</span>&nbsp;<span class="ident" id="5570541">err</span>&nbsp;<span class="op" id="5570545">!=</span>&nbsp;<span class="builtintype" id="5570548">nil</span>&nbsp;<span class="op" id="5570552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570557">if</span>&nbsp;<span class="ident" id="5570560">err</span>&nbsp;<span class="op" id="5570564">==</span>&nbsp;<span class="ident" id="5570567">io</span><span class="op" id="5570569">.</span><span class="ident" id="5570570">EOF</span>&nbsp;<span class="op" id="5570574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570580">return</span>&nbsp;<span class="ident" id="5570587">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570610">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570615">return</span>&nbsp;<span class="ident" id="5570622">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570632">d</span><span class="op" id="5570633">.</span><span class="ident" id="5570634">bits</span><span class="op" id="5570638">.</span><span class="ident" id="5570639">a</span>&nbsp;<span class="op" id="5570641">=</span>&nbsp;<span class="ident" id="5570643">d</span><span class="op" id="5570644">.</span><span class="ident" id="5570645">bits</span><span class="op" id="5570649">.</span><span class="ident" id="5570650">a</span><span class="op" id="5570651">&lt;&lt;</span><span class="num" id="5570653">8</span>&nbsp;<span class="op" id="5570655">|</span>&nbsp;<span class="builtintype" id="5570657">uint32</span><span class="op" id="5570663">(</span><span class="ident" id="5570664">c</span><span class="op" id="5570665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570669">d</span><span class="op" id="5570670">.</span><span class="ident" id="5570671">bits</span><span class="op" id="5570675">.</span><span class="ident" id="5570676">n</span>&nbsp;<span class="op" id="5570678">+=</span>&nbsp;<span class="num" id="5570681">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570685">if</span>&nbsp;<span class="ident" id="5570688">d</span><span class="op" id="5570689">.</span><span class="ident" id="5570690">bits</span><span class="op" id="5570694">.</span><span class="ident" id="5570695">m</span>&nbsp;<span class="op" id="5570697">==</span>&nbsp;<span class="num" id="5570700">0</span>&nbsp;<span class="op" id="5570702">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570707">d</span><span class="op" id="5570708">.</span><span class="ident" id="5570709">bits</span><span class="op" id="5570713">.</span><span class="ident" id="5570714">m</span>&nbsp;<span class="op" id="5570716">=</span>&nbsp;<span class="num" id="5570718">1</span>&nbsp;<span class="op" id="5570720">&lt;&lt;</span>&nbsp;<span class="num" id="5570723">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570727">}</span>&nbsp;<span class="keyword" id="5570729">else</span>&nbsp;<span class="op" id="5570734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5570739">d</span><span class="op" id="5570740">.</span><span class="ident" id="5570741">bits</span><span class="op" id="5570745">.</span><span class="ident" id="5570746">m</span>&nbsp;<span class="op" id="5570748">&lt;&lt;=</span>&nbsp;<span class="num" id="5570752">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570760">if</span>&nbsp;<span class="ident" id="5570763">d</span><span class="op" id="5570764">.</span><span class="ident" id="5570765">bits</span><span class="op" id="5570769">.</span><span class="ident" id="5570770">n</span>&nbsp;<span class="op" id="5570772">&gt;=</span>&nbsp;<span class="ident" id="5570775">n</span>&nbsp;<span class="op" id="5570777">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570782">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5570793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570796">return</span>&nbsp;<span class="builtintype" id="5570803">nil</span><br>
<span class="lineno"></span><span class="op" id="5570807">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5570810">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="5570890">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="5570902">func</span>&nbsp;<span class="op" id="5570907">(</span><span class="ident" id="5570908">d</span>&nbsp;<span class="op" id="5570910">*</span><span class="ident" id="5570911">decoder</span><span class="op" id="5570918">)</span>&nbsp;<span class="ident" id="5570920">receiveExtend</span><span class="op" id="5570933">(</span><span class="ident" id="5570934">t</span>&nbsp;<span class="builtintype" id="5570936">uint8</span><span class="op" id="5570941">)</span>&nbsp;<span class="op" id="5570943">(</span><span class="builtintype" id="5570944">int32</span><span class="op" id="5570949">,</span>&nbsp;<span class="builtintype" id="5570951">error</span><span class="op" id="5570956">)</span>&nbsp;<span class="op" id="5570958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570961">if</span>&nbsp;<span class="ident" id="5570964">d</span><span class="op" id="5570965">.</span><span class="ident" id="5570966">bits</span><span class="op" id="5570970">.</span><span class="ident" id="5570971">n</span>&nbsp;<span class="op" id="5570973">&lt;</span>&nbsp;<span class="builtintype" id="5570975">int32</span><span class="op" id="5570980">(</span><span class="ident" id="5570981">t</span><span class="op" id="5570982">)</span>&nbsp;<span class="op" id="5570984">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5570988">if</span>&nbsp;<span class="ident" id="5570991">err</span>&nbsp;<span class="op" id="5570995">:=</span>&nbsp;<span class="ident" id="5570998">d</span><span class="op" id="5570999">.</span><span class="ident" id="5571000">ensureNBits</span><span class="op" id="5571011">(</span><span class="builtintype" id="5571012">int32</span><span class="op" id="5571017">(</span><span class="ident" id="5571018">t</span><span class="op" id="5571019">)</span><span class="op" id="5571020">)</span><span class="op" id="5571021">;</span>&nbsp;<span class="ident" id="5571023">err</span>&nbsp;<span class="op" id="5571027">!=</span>&nbsp;<span class="builtintype" id="5571030">nil</span>&nbsp;<span class="op" id="5571034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571039">return</span>&nbsp;<span class="num" id="5571046">0</span><span class="op" id="5571047">,</span>&nbsp;<span class="ident" id="5571049">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571061">d</span><span class="op" id="5571062">.</span><span class="ident" id="5571063">bits</span><span class="op" id="5571067">.</span><span class="ident" id="5571068">n</span>&nbsp;<span class="op" id="5571070">-=</span>&nbsp;<span class="builtintype" id="5571073">int32</span><span class="op" id="5571078">(</span><span class="ident" id="5571079">t</span><span class="op" id="5571080">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571083">d</span><span class="op" id="5571084">.</span><span class="ident" id="5571085">bits</span><span class="op" id="5571089">.</span><span class="ident" id="5571090">m</span>&nbsp;<span class="op" id="5571092">&gt;&gt;=</span>&nbsp;<span class="ident" id="5571096">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571099">s</span>&nbsp;<span class="op" id="5571101">:=</span>&nbsp;<span class="builtintype" id="5571104">int32</span><span class="op" id="5571109">(</span><span class="num" id="5571110">1</span><span class="op" id="5571111">)</span>&nbsp;<span class="op" id="5571113">&lt;&lt;</span>&nbsp;<span class="ident" id="5571116">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571119">x</span>&nbsp;<span class="op" id="5571121">:=</span>&nbsp;<span class="builtintype" id="5571124">int32</span><span class="op" id="5571129">(</span><span class="ident" id="5571130">d</span><span class="op" id="5571131">.</span><span class="ident" id="5571132">bits</span><span class="op" id="5571136">.</span><span class="ident" id="5571137">a</span><span class="op" id="5571138">&gt;&gt;</span><span class="builtintype" id="5571140">uint8</span><span class="op" id="5571145">(</span><span class="ident" id="5571146">d</span><span class="op" id="5571147">.</span><span class="ident" id="5571148">bits</span><span class="op" id="5571152">.</span><span class="ident" id="5571153">n</span><span class="op" id="5571154">)</span><span class="op" id="5571155">)</span>&nbsp;<span class="op" id="5571157">&amp;</span>&nbsp;<span class="op" id="5571159">(</span><span class="ident" id="5571160">s</span>&nbsp;<span class="op" id="5571162">-</span>&nbsp;<span class="num" id="5571164">1</span><span class="op" id="5571165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571168">if</span>&nbsp;<span class="ident" id="5571171">x</span>&nbsp;<span class="op" id="5571173">&lt;</span>&nbsp;<span class="ident" id="5571175">s</span><span class="op" id="5571176">&gt;&gt;</span><span class="num" id="5571178">1</span>&nbsp;<span class="op" id="5571180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571184">x</span>&nbsp;<span class="op" id="5571186">+=</span>&nbsp;<span class="op" id="5571189">(</span><span class="op" id="5571190">(</span><span class="op" id="5571191">-</span><span class="num" id="5571192">1</span><span class="op" id="5571193">)</span>&nbsp;<span class="op" id="5571195">&lt;&lt;</span>&nbsp;<span class="ident" id="5571198">t</span><span class="op" id="5571199">)</span>&nbsp;<span class="op" id="5571201">+</span>&nbsp;<span class="num" id="5571203">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571209">return</span>&nbsp;<span class="ident" id="5571216">x</span><span class="op" id="5571217">,</span>&nbsp;<span class="builtintype" id="5571219">nil</span><br>
<span class="lineno"></span><span class="op" id="5571223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5571226">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="5571307">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5571366">func</span>&nbsp;<span class="op" id="5571371">(</span><span class="ident" id="5571372">d</span>&nbsp;<span class="op" id="5571374">*</span><span class="ident" id="5571375">decoder</span><span class="op" id="5571382">)</span>&nbsp;<span class="ident" id="5571384">processDHT</span><span class="op" id="5571394">(</span><span class="ident" id="5571395">n</span>&nbsp;<span class="builtintype" id="5571397">int</span><span class="op" id="5571400">)</span>&nbsp;<span class="builtintype" id="5571402">error</span>&nbsp;<span class="op" id="5571408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571411">for</span>&nbsp;<span class="ident" id="5571415">n</span>&nbsp;<span class="op" id="5571417">&gt;</span>&nbsp;<span class="num" id="5571419">0</span>&nbsp;<span class="op" id="5571421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571425">if</span>&nbsp;<span class="ident" id="5571428">n</span>&nbsp;<span class="op" id="5571430">&lt;</span>&nbsp;<span class="num" id="5571432">17</span>&nbsp;<span class="op" id="5571435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571440">return</span>&nbsp;<span class="ident" id="5571447">FormatError</span><span class="op" id="5571458">(</span><span class="string" id="5571459">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5571481">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571489">if</span>&nbsp;<span class="ident" id="5571492">err</span>&nbsp;<span class="op" id="5571496">:=</span>&nbsp;<span class="ident" id="5571499">d</span><span class="op" id="5571500">.</span><span class="ident" id="5571501">readFull</span><span class="op" id="5571509">(</span><span class="ident" id="5571510">d</span><span class="op" id="5571511">.</span><span class="ident" id="5571512">tmp</span><span class="op" id="5571515">[</span><span class="op" id="5571516">:</span><span class="num" id="5571517">17</span><span class="op" id="5571519">]</span><span class="op" id="5571520">)</span><span class="op" id="5571521">;</span>&nbsp;<span class="ident" id="5571523">err</span>&nbsp;<span class="op" id="5571527">!=</span>&nbsp;<span class="builtintype" id="5571530">nil</span>&nbsp;<span class="op" id="5571534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571539">return</span>&nbsp;<span class="ident" id="5571546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571556">tc</span>&nbsp;<span class="op" id="5571559">:=</span>&nbsp;<span class="ident" id="5571562">d</span><span class="op" id="5571563">.</span><span class="ident" id="5571564">tmp</span><span class="op" id="5571567">[</span><span class="num" id="5571568">0</span><span class="op" id="5571569">]</span>&nbsp;<span class="op" id="5571571">&gt;&gt;</span>&nbsp;<span class="num" id="5571574">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571578">if</span>&nbsp;<span class="ident" id="5571581">tc</span>&nbsp;<span class="op" id="5571584">&gt;</span>&nbsp;<span class="ident" id="5571586">maxTc</span>&nbsp;<span class="op" id="5571592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571597">return</span>&nbsp;<span class="ident" id="5571604">FormatError</span><span class="op" id="5571615">(</span><span class="string" id="5571616">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="5571630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571638">th</span>&nbsp;<span class="op" id="5571641">:=</span>&nbsp;<span class="ident" id="5571644">d</span><span class="op" id="5571645">.</span><span class="ident" id="5571646">tmp</span><span class="op" id="5571649">[</span><span class="num" id="5571650">0</span><span class="op" id="5571651">]</span>&nbsp;<span class="op" id="5571653">&amp;</span>&nbsp;<span class="num" id="5571655">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571662">if</span>&nbsp;<span class="ident" id="5571665">th</span>&nbsp;<span class="op" id="5571668">&gt;</span>&nbsp;<span class="ident" id="5571670">maxTh</span>&nbsp;<span class="op" id="5571676">||</span>&nbsp;<span class="op" id="5571679">!</span><span class="ident" id="5571680">d</span><span class="op" id="5571681">.</span><span class="ident" id="5571682">progressive</span>&nbsp;<span class="op" id="5571694">&amp;&amp;</span>&nbsp;<span class="ident" id="5571697">th</span>&nbsp;<span class="op" id="5571700">&gt;</span>&nbsp;<span class="num" id="5571702">1</span>&nbsp;<span class="op" id="5571704">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571709">return</span>&nbsp;<span class="ident" id="5571716">FormatError</span><span class="op" id="5571727">(</span><span class="string" id="5571728">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="5571742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5571746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571750">h</span>&nbsp;<span class="op" id="5571752">:=</span>&nbsp;<span class="op" id="5571755">&amp;</span><span class="ident" id="5571756">d</span><span class="op" id="5571757">.</span><span class="ident" id="5571758">huff</span><span class="op" id="5571762">[</span><span class="ident" id="5571763">tc</span><span class="op" id="5571765">]</span><span class="op" id="5571766">[</span><span class="ident" id="5571767">th</span><span class="op" id="5571769">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571774">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571825">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5571883">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5571927">h</span><span class="op" id="5571928">.</span><span class="ident" id="5571929">nCodes</span>&nbsp;<span class="op" id="5571936">=</span>&nbsp;<span class="num" id="5571938">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571942">var</span>&nbsp;<span class="ident" id="5571946">nCodes</span>&nbsp;<span class="op" id="5571953">[</span><span class="ident" id="5571954">maxCodeLength</span><span class="op" id="5571967">]</span><span class="builtintype" id="5571968">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5571976">for</span>&nbsp;<span class="ident" id="5571980">i</span>&nbsp;<span class="op" id="5571982">:=</span>&nbsp;<span class="keyword" id="5571985">range</span>&nbsp;<span class="ident" id="5571991">nCodes</span>&nbsp;<span class="op" id="5571998">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572003">nCodes</span><span class="op" id="5572009">[</span><span class="ident" id="5572010">i</span><span class="op" id="5572011">]</span>&nbsp;<span class="op" id="5572013">=</span>&nbsp;<span class="builtintype" id="5572015">int32</span><span class="op" id="5572020">(</span><span class="ident" id="5572021">d</span><span class="op" id="5572022">.</span><span class="ident" id="5572023">tmp</span><span class="op" id="5572026">[</span><span class="ident" id="5572027">i</span><span class="op" id="5572028">+</span><span class="num" id="5572029">1</span><span class="op" id="5572030">]</span><span class="op" id="5572031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572036">h</span><span class="op" id="5572037">.</span><span class="ident" id="5572038">nCodes</span>&nbsp;<span class="op" id="5572045">+=</span>&nbsp;<span class="ident" id="5572048">nCodes</span><span class="op" id="5572054">[</span><span class="ident" id="5572055">i</span><span class="op" id="5572056">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572064">if</span>&nbsp;<span class="ident" id="5572067">h</span><span class="op" id="5572068">.</span><span class="ident" id="5572069">nCodes</span>&nbsp;<span class="op" id="5572076">==</span>&nbsp;<span class="num" id="5572079">0</span>&nbsp;<span class="op" id="5572081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572086">return</span>&nbsp;<span class="ident" id="5572093">FormatError</span><span class="op" id="5572104">(</span><span class="string" id="5572105">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="5572136">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572144">if</span>&nbsp;<span class="ident" id="5572147">h</span><span class="op" id="5572148">.</span><span class="ident" id="5572149">nCodes</span>&nbsp;<span class="op" id="5572156">&gt;</span>&nbsp;<span class="ident" id="5572158">maxNCodes</span>&nbsp;<span class="op" id="5572168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572173">return</span>&nbsp;<span class="ident" id="5572180">FormatError</span><span class="op" id="5572191">(</span><span class="string" id="5572192">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="5572228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572236">n</span>&nbsp;<span class="op" id="5572238">-=</span>&nbsp;<span class="builtintype" id="5572241">int</span><span class="op" id="5572244">(</span><span class="ident" id="5572245">h</span><span class="op" id="5572246">.</span><span class="ident" id="5572247">nCodes</span><span class="op" id="5572253">)</span>&nbsp;<span class="op" id="5572255">+</span>&nbsp;<span class="num" id="5572257">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572262">if</span>&nbsp;<span class="ident" id="5572265">n</span>&nbsp;<span class="op" id="5572267">&lt;</span>&nbsp;<span class="num" id="5572269">0</span>&nbsp;<span class="op" id="5572271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572276">return</span>&nbsp;<span class="ident" id="5572283">FormatError</span><span class="op" id="5572294">(</span><span class="string" id="5572295">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5572317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572325">if</span>&nbsp;<span class="ident" id="5572328">err</span>&nbsp;<span class="op" id="5572332">:=</span>&nbsp;<span class="ident" id="5572335">d</span><span class="op" id="5572336">.</span><span class="ident" id="5572337">readFull</span><span class="op" id="5572345">(</span><span class="ident" id="5572346">h</span><span class="op" id="5572347">.</span><span class="ident" id="5572348">vals</span><span class="op" id="5572352">[</span><span class="op" id="5572353">:</span><span class="ident" id="5572354">h</span><span class="op" id="5572355">.</span><span class="ident" id="5572356">nCodes</span><span class="op" id="5572362">]</span><span class="op" id="5572363">)</span><span class="op" id="5572364">;</span>&nbsp;<span class="ident" id="5572366">err</span>&nbsp;<span class="op" id="5572370">!=</span>&nbsp;<span class="builtintype" id="5572373">nil</span>&nbsp;<span class="op" id="5572377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572382">return</span>&nbsp;<span class="ident" id="5572389">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572400">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572431">for</span>&nbsp;<span class="ident" id="5572435">i</span>&nbsp;<span class="op" id="5572437">:=</span>&nbsp;<span class="keyword" id="5572440">range</span>&nbsp;<span class="ident" id="5572446">h</span><span class="op" id="5572447">.</span><span class="ident" id="5572448">lut</span>&nbsp;<span class="op" id="5572452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572457">h</span><span class="op" id="5572458">.</span><span class="ident" id="5572459">lut</span><span class="op" id="5572462">[</span><span class="ident" id="5572463">i</span><span class="op" id="5572464">]</span>&nbsp;<span class="op" id="5572466">=</span>&nbsp;<span class="num" id="5572468">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5572472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572476">var</span>&nbsp;<span class="ident" id="5572480">x</span><span class="op" id="5572481">,</span>&nbsp;<span class="ident" id="5572483">code</span>&nbsp;<span class="builtintype" id="5572488">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572497">for</span>&nbsp;<span class="ident" id="5572501">i</span>&nbsp;<span class="op" id="5572503">:=</span>&nbsp;<span class="builtintype" id="5572506">uint32</span><span class="op" id="5572512">(</span><span class="num" id="5572513">0</span><span class="op" id="5572514">)</span><span class="op" id="5572515">;</span>&nbsp;<span class="ident" id="5572517">i</span>&nbsp;<span class="op" id="5572519">&lt;</span>&nbsp;<span class="ident" id="5572521">lutSize</span><span class="op" id="5572528">;</span>&nbsp;<span class="ident" id="5572530">i</span><span class="op" id="5572531">++</span>&nbsp;<span class="op" id="5572534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572539">code</span>&nbsp;<span class="op" id="5572544">&lt;&lt;=</span>&nbsp;<span class="num" id="5572548">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572553">for</span>&nbsp;<span class="ident" id="5572557">j</span>&nbsp;<span class="op" id="5572559">:=</span>&nbsp;<span class="builtintype" id="5572562">int32</span><span class="op" id="5572567">(</span><span class="num" id="5572568">0</span><span class="op" id="5572569">)</span><span class="op" id="5572570">;</span>&nbsp;<span class="ident" id="5572572">j</span>&nbsp;<span class="op" id="5572574">&lt;</span>&nbsp;<span class="ident" id="5572576">nCodes</span><span class="op" id="5572582">[</span><span class="ident" id="5572583">i</span><span class="op" id="5572584">]</span><span class="op" id="5572585">;</span>&nbsp;<span class="ident" id="5572587">j</span><span class="op" id="5572588">++</span>&nbsp;<span class="op" id="5572591">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572597">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572655">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572711">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572761">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5572819">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572868">base</span>&nbsp;<span class="op" id="5572873">:=</span>&nbsp;<span class="builtintype" id="5572876">uint8</span><span class="op" id="5572881">(</span><span class="ident" id="5572882">code</span>&nbsp;<span class="op" id="5572887">&lt;&lt;</span>&nbsp;<span class="op" id="5572890">(</span><span class="num" id="5572891">7</span>&nbsp;<span class="op" id="5572893">-</span>&nbsp;<span class="ident" id="5572895">i</span><span class="op" id="5572896">)</span><span class="op" id="5572897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572903">lutValue</span>&nbsp;<span class="op" id="5572912">:=</span>&nbsp;<span class="builtintype" id="5572915">uint16</span><span class="op" id="5572921">(</span><span class="ident" id="5572922">h</span><span class="op" id="5572923">.</span><span class="ident" id="5572924">vals</span><span class="op" id="5572928">[</span><span class="ident" id="5572929">x</span><span class="op" id="5572930">]</span><span class="op" id="5572931">)</span><span class="op" id="5572932">&lt;&lt;</span><span class="num" id="5572934">8</span>&nbsp;<span class="op" id="5572936">|</span>&nbsp;<span class="builtintype" id="5572938">uint16</span><span class="op" id="5572944">(</span><span class="num" id="5572945">2</span><span class="op" id="5572946">+</span><span class="ident" id="5572947">i</span><span class="op" id="5572948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5572954">for</span>&nbsp;<span class="ident" id="5572958">k</span>&nbsp;<span class="op" id="5572960">:=</span>&nbsp;<span class="builtintype" id="5572963">uint8</span><span class="op" id="5572968">(</span><span class="num" id="5572969">0</span><span class="op" id="5572970">)</span><span class="op" id="5572971">;</span>&nbsp;<span class="ident" id="5572973">k</span>&nbsp;<span class="op" id="5572975">&lt;</span>&nbsp;<span class="num" id="5572977">1</span><span class="op" id="5572978">&lt;&lt;</span><span class="op" id="5572980">(</span><span class="num" id="5572981">7</span><span class="op" id="5572982">-</span><span class="ident" id="5572983">i</span><span class="op" id="5572984">)</span><span class="op" id="5572985">;</span>&nbsp;<span class="ident" id="5572987">k</span><span class="op" id="5572988">++</span>&nbsp;<span class="op" id="5572991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5572998">h</span><span class="op" id="5572999">.</span><span class="ident" id="5573000">lut</span><span class="op" id="5573003">[</span><span class="ident" id="5573004">base</span><span class="op" id="5573008">|</span><span class="ident" id="5573009">k</span><span class="op" id="5573010">]</span>&nbsp;<span class="op" id="5573012">=</span>&nbsp;<span class="ident" id="5573014">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573027">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573033">code</span><span class="op" id="5573037">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573044">x</span><span class="op" id="5573045">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5573060">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573109">var</span>&nbsp;<span class="ident" id="5573113">c</span><span class="op" id="5573114">,</span>&nbsp;<span class="ident" id="5573116">index</span>&nbsp;<span class="builtintype" id="5573122">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573130">for</span>&nbsp;<span class="ident" id="5573134">i</span><span class="op" id="5573135">,</span>&nbsp;<span class="ident" id="5573137">n</span>&nbsp;<span class="op" id="5573139">:=</span>&nbsp;<span class="keyword" id="5573142">range</span>&nbsp;<span class="ident" id="5573148">nCodes</span>&nbsp;<span class="op" id="5573155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573160">if</span>&nbsp;<span class="ident" id="5573163">n</span>&nbsp;<span class="op" id="5573165">==</span>&nbsp;<span class="num" id="5573168">0</span>&nbsp;<span class="op" id="5573170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573176">h</span><span class="op" id="5573177">.</span><span class="ident" id="5573178">minCodes</span><span class="op" id="5573186">[</span><span class="ident" id="5573187">i</span><span class="op" id="5573188">]</span>&nbsp;<span class="op" id="5573190">=</span>&nbsp;<span class="op" id="5573192">-</span><span class="num" id="5573193">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573199">h</span><span class="op" id="5573200">.</span><span class="ident" id="5573201">maxCodes</span><span class="op" id="5573209">[</span><span class="ident" id="5573210">i</span><span class="op" id="5573211">]</span>&nbsp;<span class="op" id="5573213">=</span>&nbsp;<span class="op" id="5573215">-</span><span class="num" id="5573216">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573222">h</span><span class="op" id="5573223">.</span><span class="ident" id="5573224">valsIndices</span><span class="op" id="5573235">[</span><span class="ident" id="5573236">i</span><span class="op" id="5573237">]</span>&nbsp;<span class="op" id="5573239">=</span>&nbsp;<span class="op" id="5573241">-</span><span class="num" id="5573242">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573247">}</span>&nbsp;<span class="keyword" id="5573249">else</span>&nbsp;<span class="op" id="5573254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573260">h</span><span class="op" id="5573261">.</span><span class="ident" id="5573262">minCodes</span><span class="op" id="5573270">[</span><span class="ident" id="5573271">i</span><span class="op" id="5573272">]</span>&nbsp;<span class="op" id="5573274">=</span>&nbsp;<span class="ident" id="5573276">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573282">h</span><span class="op" id="5573283">.</span><span class="ident" id="5573284">maxCodes</span><span class="op" id="5573292">[</span><span class="ident" id="5573293">i</span><span class="op" id="5573294">]</span>&nbsp;<span class="op" id="5573296">=</span>&nbsp;<span class="ident" id="5573298">c</span>&nbsp;<span class="op" id="5573300">+</span>&nbsp;<span class="ident" id="5573302">n</span>&nbsp;<span class="op" id="5573304">-</span>&nbsp;<span class="num" id="5573306">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573312">h</span><span class="op" id="5573313">.</span><span class="ident" id="5573314">valsIndices</span><span class="op" id="5573325">[</span><span class="ident" id="5573326">i</span><span class="op" id="5573327">]</span>&nbsp;<span class="op" id="5573329">=</span>&nbsp;<span class="ident" id="5573331">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573341">c</span>&nbsp;<span class="op" id="5573343">+=</span>&nbsp;<span class="ident" id="5573346">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573352">index</span>&nbsp;<span class="op" id="5573358">+=</span>&nbsp;<span class="ident" id="5573361">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573371">c</span>&nbsp;<span class="op" id="5573373">&lt;&lt;=</span>&nbsp;<span class="num" id="5573377">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573387">return</span>&nbsp;<span class="builtintype" id="5573394">nil</span><br>
<span class="lineno"></span><span class="op" id="5573398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5573401">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="5573476">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="5573503">func</span>&nbsp;<span class="op" id="5573508">(</span><span class="ident" id="5573509">d</span>&nbsp;<span class="op" id="5573511">*</span><span class="ident" id="5573512">decoder</span><span class="op" id="5573519">)</span>&nbsp;<span class="ident" id="5573521">decodeHuffman</span><span class="op" id="5573534">(</span><span class="ident" id="5573535">h</span>&nbsp;<span class="op" id="5573537">*</span><span class="ident" id="5573538">huffman</span><span class="op" id="5573545">)</span>&nbsp;<span class="op" id="5573547">(</span><span class="builtintype" id="5573548">uint8</span><span class="op" id="5573553">,</span>&nbsp;<span class="builtintype" id="5573555">error</span><span class="op" id="5573560">)</span>&nbsp;<span class="op" id="5573562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573565">if</span>&nbsp;<span class="ident" id="5573568">h</span><span class="op" id="5573569">.</span><span class="ident" id="5573570">nCodes</span>&nbsp;<span class="op" id="5573577">==</span>&nbsp;<span class="num" id="5573580">0</span>&nbsp;<span class="op" id="5573582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573586">return</span>&nbsp;<span class="num" id="5573593">0</span><span class="op" id="5573594">,</span>&nbsp;<span class="ident" id="5573596">FormatError</span><span class="op" id="5573607">(</span><span class="string" id="5573608">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="5573637">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573644">if</span>&nbsp;<span class="ident" id="5573647">d</span><span class="op" id="5573648">.</span><span class="ident" id="5573649">bits</span><span class="op" id="5573653">.</span><span class="ident" id="5573654">n</span>&nbsp;<span class="op" id="5573656">&lt;</span>&nbsp;<span class="num" id="5573658">8</span>&nbsp;<span class="op" id="5573660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573664">if</span>&nbsp;<span class="ident" id="5573667">err</span>&nbsp;<span class="op" id="5573671">:=</span>&nbsp;<span class="ident" id="5573674">d</span><span class="op" id="5573675">.</span><span class="ident" id="5573676">ensureNBits</span><span class="op" id="5573687">(</span><span class="num" id="5573688">8</span><span class="op" id="5573689">)</span><span class="op" id="5573690">;</span>&nbsp;<span class="ident" id="5573692">err</span>&nbsp;<span class="op" id="5573696">!=</span>&nbsp;<span class="builtintype" id="5573699">nil</span>&nbsp;<span class="op" id="5573703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573708">if</span>&nbsp;<span class="ident" id="5573711">err</span>&nbsp;<span class="op" id="5573715">!=</span>&nbsp;<span class="ident" id="5573718">errMissingFF00</span>&nbsp;<span class="op" id="5573733">&amp;&amp;</span>&nbsp;<span class="ident" id="5573736">err</span>&nbsp;<span class="op" id="5573740">!=</span>&nbsp;<span class="ident" id="5573743">errShortHuffmanData</span>&nbsp;<span class="op" id="5573763">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5573769">return</span>&nbsp;<span class="num" id="5573776">0</span><span class="op" id="5573777">,</span>&nbsp;<span class="ident" id="5573779">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5573786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5573791">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5573863">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5573934">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5573997">d</span><span class="op" id="5573998">.</span><span class="ident" id="5573999">unreadByteStuffedByte</span><span class="op" id="5574020">(</span><span class="op" id="5574021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574026">goto</span>&nbsp;<span class="ident" id="5574031">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574048">if</span>&nbsp;<span class="ident" id="5574051">v</span>&nbsp;<span class="op" id="5574053">:=</span>&nbsp;<span class="ident" id="5574056">h</span><span class="op" id="5574057">.</span><span class="ident" id="5574058">lut</span><span class="op" id="5574061">[</span><span class="op" id="5574062">(</span><span class="ident" id="5574063">d</span><span class="op" id="5574064">.</span><span class="ident" id="5574065">bits</span><span class="op" id="5574069">.</span><span class="ident" id="5574070">a</span><span class="op" id="5574071">&gt;&gt;</span><span class="builtintype" id="5574073">uint32</span><span class="op" id="5574079">(</span><span class="ident" id="5574080">d</span><span class="op" id="5574081">.</span><span class="ident" id="5574082">bits</span><span class="op" id="5574086">.</span><span class="ident" id="5574087">n</span><span class="op" id="5574088">-</span><span class="ident" id="5574089">lutSize</span><span class="op" id="5574096">)</span><span class="op" id="5574097">)</span><span class="op" id="5574098">&amp;</span><span class="num" id="5574099">0xff</span><span class="op" id="5574103">]</span><span class="op" id="5574104">;</span>&nbsp;<span class="ident" id="5574106">v</span>&nbsp;<span class="op" id="5574108">!=</span>&nbsp;<span class="num" id="5574111">0</span>&nbsp;<span class="op" id="5574113">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574117">n</span>&nbsp;<span class="op" id="5574119">:=</span>&nbsp;<span class="op" id="5574122">(</span><span class="ident" id="5574123">v</span>&nbsp;<span class="op" id="5574125">&amp;</span>&nbsp;<span class="num" id="5574127">0xff</span><span class="op" id="5574131">)</span>&nbsp;<span class="op" id="5574133">-</span>&nbsp;<span class="num" id="5574135">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574139">d</span><span class="op" id="5574140">.</span><span class="ident" id="5574141">bits</span><span class="op" id="5574145">.</span><span class="ident" id="5574146">n</span>&nbsp;<span class="op" id="5574148">-=</span>&nbsp;<span class="builtintype" id="5574151">int32</span><span class="op" id="5574156">(</span><span class="ident" id="5574157">n</span><span class="op" id="5574158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574162">d</span><span class="op" id="5574163">.</span><span class="ident" id="5574164">bits</span><span class="op" id="5574168">.</span><span class="ident" id="5574169">m</span>&nbsp;<span class="op" id="5574171">&gt;&gt;=</span>&nbsp;<span class="ident" id="5574175">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574179">return</span>&nbsp;<span class="builtintype" id="5574186">uint8</span><span class="op" id="5574191">(</span><span class="ident" id="5574192">v</span>&nbsp;<span class="op" id="5574194">&gt;&gt;</span>&nbsp;<span class="num" id="5574197">8</span><span class="op" id="5574198">)</span><span class="op" id="5574199">,</span>&nbsp;<span class="builtintype" id="5574201">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574206">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="5574209">slowPath</span><span class="op" id="5574217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574220">for</span>&nbsp;<span class="ident" id="5574224">i</span><span class="op" id="5574225">,</span>&nbsp;<span class="ident" id="5574227">code</span>&nbsp;<span class="op" id="5574232">:=</span>&nbsp;<span class="num" id="5574235">0</span><span class="op" id="5574236">,</span>&nbsp;<span class="builtintype" id="5574238">int32</span><span class="op" id="5574243">(</span><span class="num" id="5574244">0</span><span class="op" id="5574245">)</span><span class="op" id="5574246">;</span>&nbsp;<span class="ident" id="5574248">i</span>&nbsp;<span class="op" id="5574250">&lt;</span>&nbsp;<span class="ident" id="5574252">maxCodeLength</span><span class="op" id="5574265">;</span>&nbsp;<span class="ident" id="5574267">i</span><span class="op" id="5574268">++</span>&nbsp;<span class="op" id="5574271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574275">if</span>&nbsp;<span class="ident" id="5574278">d</span><span class="op" id="5574279">.</span><span class="ident" id="5574280">bits</span><span class="op" id="5574284">.</span><span class="ident" id="5574285">n</span>&nbsp;<span class="op" id="5574287">==</span>&nbsp;<span class="num" id="5574290">0</span>&nbsp;<span class="op" id="5574292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574297">if</span>&nbsp;<span class="ident" id="5574300">err</span>&nbsp;<span class="op" id="5574304">:=</span>&nbsp;<span class="ident" id="5574307">d</span><span class="op" id="5574308">.</span><span class="ident" id="5574309">ensureNBits</span><span class="op" id="5574320">(</span><span class="num" id="5574321">1</span><span class="op" id="5574322">)</span><span class="op" id="5574323">;</span>&nbsp;<span class="ident" id="5574325">err</span>&nbsp;<span class="op" id="5574329">!=</span>&nbsp;<span class="builtintype" id="5574332">nil</span>&nbsp;<span class="op" id="5574336">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574342">return</span>&nbsp;<span class="num" id="5574349">0</span><span class="op" id="5574350">,</span>&nbsp;<span class="ident" id="5574352">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574367">if</span>&nbsp;<span class="ident" id="5574370">d</span><span class="op" id="5574371">.</span><span class="ident" id="5574372">bits</span><span class="op" id="5574376">.</span><span class="ident" id="5574377">a</span><span class="op" id="5574378">&amp;</span><span class="ident" id="5574379">d</span><span class="op" id="5574380">.</span><span class="ident" id="5574381">bits</span><span class="op" id="5574385">.</span><span class="ident" id="5574386">m</span>&nbsp;<span class="op" id="5574388">!=</span>&nbsp;<span class="num" id="5574391">0</span>&nbsp;<span class="op" id="5574393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574398">code</span>&nbsp;<span class="op" id="5574403">|=</span>&nbsp;<span class="num" id="5574406">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574414">d</span><span class="op" id="5574415">.</span><span class="ident" id="5574416">bits</span><span class="op" id="5574420">.</span><span class="ident" id="5574421">n</span><span class="op" id="5574422">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574427">d</span><span class="op" id="5574428">.</span><span class="ident" id="5574429">bits</span><span class="op" id="5574433">.</span><span class="ident" id="5574434">m</span>&nbsp;<span class="op" id="5574436">&gt;&gt;=</span>&nbsp;<span class="num" id="5574440">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574444">if</span>&nbsp;<span class="ident" id="5574447">code</span>&nbsp;<span class="op" id="5574452">&lt;=</span>&nbsp;<span class="ident" id="5574455">h</span><span class="op" id="5574456">.</span><span class="ident" id="5574457">maxCodes</span><span class="op" id="5574465">[</span><span class="ident" id="5574466">i</span><span class="op" id="5574467">]</span>&nbsp;<span class="op" id="5574469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574474">return</span>&nbsp;<span class="ident" id="5574481">h</span><span class="op" id="5574482">.</span><span class="ident" id="5574483">vals</span><span class="op" id="5574487">[</span><span class="ident" id="5574488">h</span><span class="op" id="5574489">.</span><span class="ident" id="5574490">valsIndices</span><span class="op" id="5574501">[</span><span class="ident" id="5574502">i</span><span class="op" id="5574503">]</span><span class="op" id="5574504">+</span><span class="ident" id="5574505">code</span><span class="op" id="5574509">-</span><span class="ident" id="5574510">h</span><span class="op" id="5574511">.</span><span class="ident" id="5574512">minCodes</span><span class="op" id="5574520">[</span><span class="ident" id="5574521">i</span><span class="op" id="5574522">]</span><span class="op" id="5574523">]</span><span class="op" id="5574524">,</span>&nbsp;<span class="builtintype" id="5574526">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574536">code</span>&nbsp;<span class="op" id="5574541">&lt;&lt;=</span>&nbsp;<span class="num" id="5574545">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574551">return</span>&nbsp;<span class="num" id="5574558">0</span><span class="op" id="5574559">,</span>&nbsp;<span class="ident" id="5574561">FormatError</span><span class="op" id="5574572">(</span><span class="string" id="5574573">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="5574591">)</span><br>
<span class="lineno"></span><span class="op" id="5574593">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="5574596">func</span>&nbsp;<span class="op" id="5574601">(</span><span class="ident" id="5574602">d</span>&nbsp;<span class="op" id="5574604">*</span><span class="ident" id="5574605">decoder</span><span class="op" id="5574612">)</span>&nbsp;<span class="ident" id="5574614">decodeBit</span><span class="op" id="5574623">(</span><span class="op" id="5574624">)</span>&nbsp;<span class="op" id="5574626">(</span><span class="builtintype" id="5574627">bool</span><span class="op" id="5574631">,</span>&nbsp;<span class="builtintype" id="5574633">error</span><span class="op" id="5574638">)</span>&nbsp;<span class="op" id="5574640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574643">if</span>&nbsp;<span class="ident" id="5574646">d</span><span class="op" id="5574647">.</span><span class="ident" id="5574648">bits</span><span class="op" id="5574652">.</span><span class="ident" id="5574653">n</span>&nbsp;<span class="op" id="5574655">==</span>&nbsp;<span class="num" id="5574658">0</span>&nbsp;<span class="op" id="5574660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574664">if</span>&nbsp;<span class="ident" id="5574667">err</span>&nbsp;<span class="op" id="5574671">:=</span>&nbsp;<span class="ident" id="5574674">d</span><span class="op" id="5574675">.</span><span class="ident" id="5574676">ensureNBits</span><span class="op" id="5574687">(</span><span class="num" id="5574688">1</span><span class="op" id="5574689">)</span><span class="op" id="5574690">;</span>&nbsp;<span class="ident" id="5574692">err</span>&nbsp;<span class="op" id="5574696">!=</span>&nbsp;<span class="builtintype" id="5574699">nil</span>&nbsp;<span class="op" id="5574703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574708">return</span>&nbsp;<span class="builtintype" id="5574715">false</span><span class="op" id="5574720">,</span>&nbsp;<span class="ident" id="5574722">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574734">ret</span>&nbsp;<span class="op" id="5574738">:=</span>&nbsp;<span class="ident" id="5574741">d</span><span class="op" id="5574742">.</span><span class="ident" id="5574743">bits</span><span class="op" id="5574747">.</span><span class="ident" id="5574748">a</span><span class="op" id="5574749">&amp;</span><span class="ident" id="5574750">d</span><span class="op" id="5574751">.</span><span class="ident" id="5574752">bits</span><span class="op" id="5574756">.</span><span class="ident" id="5574757">m</span>&nbsp;<span class="op" id="5574759">!=</span>&nbsp;<span class="num" id="5574762">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574765">d</span><span class="op" id="5574766">.</span><span class="ident" id="5574767">bits</span><span class="op" id="5574771">.</span><span class="ident" id="5574772">n</span><span class="op" id="5574773">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574777">d</span><span class="op" id="5574778">.</span><span class="ident" id="5574779">bits</span><span class="op" id="5574783">.</span><span class="ident" id="5574784">m</span>&nbsp;<span class="op" id="5574786">&gt;&gt;=</span>&nbsp;<span class="num" id="5574790">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574793">return</span>&nbsp;<span class="ident" id="5574800">ret</span><span class="op" id="5574803">,</span>&nbsp;<span class="builtintype" id="5574805">nil</span><br>
<span class="lineno"></span><span class="op" id="5574809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5574812">func</span>&nbsp;<span class="op" id="5574817">(</span><span class="ident" id="5574818">d</span>&nbsp;<span class="op" id="5574820">*</span><span class="ident" id="5574821">decoder</span><span class="op" id="5574828">)</span>&nbsp;<span class="ident" id="5574830">decodeBits</span><span class="op" id="5574840">(</span><span class="ident" id="5574841">n</span>&nbsp;<span class="builtintype" id="5574843">int32</span><span class="op" id="5574848">)</span>&nbsp;<span class="op" id="5574850">(</span><span class="builtintype" id="5574851">uint32</span><span class="op" id="5574857">,</span>&nbsp;<span class="builtintype" id="5574859">error</span><span class="op" id="5574864">)</span>&nbsp;<span class="op" id="5574866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574869">if</span>&nbsp;<span class="ident" id="5574872">d</span><span class="op" id="5574873">.</span><span class="ident" id="5574874">bits</span><span class="op" id="5574878">.</span><span class="ident" id="5574879">n</span>&nbsp;<span class="op" id="5574881">&lt;</span>&nbsp;<span class="ident" id="5574883">n</span>&nbsp;<span class="op" id="5574885">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574889">if</span>&nbsp;<span class="ident" id="5574892">err</span>&nbsp;<span class="op" id="5574896">:=</span>&nbsp;<span class="ident" id="5574899">d</span><span class="op" id="5574900">.</span><span class="ident" id="5574901">ensureNBits</span><span class="op" id="5574912">(</span><span class="ident" id="5574913">n</span><span class="op" id="5574914">)</span><span class="op" id="5574915">;</span>&nbsp;<span class="ident" id="5574917">err</span>&nbsp;<span class="op" id="5574921">!=</span>&nbsp;<span class="builtintype" id="5574924">nil</span>&nbsp;<span class="op" id="5574928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5574933">return</span>&nbsp;<span class="num" id="5574940">0</span><span class="op" id="5574941">,</span>&nbsp;<span class="ident" id="5574943">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5574952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574955">ret</span>&nbsp;<span class="op" id="5574959">:=</span>&nbsp;<span class="ident" id="5574962">d</span><span class="op" id="5574963">.</span><span class="ident" id="5574964">bits</span><span class="op" id="5574968">.</span><span class="ident" id="5574969">a</span>&nbsp;<span class="op" id="5574971">&gt;&gt;</span>&nbsp;<span class="builtintype" id="5574974">uint32</span><span class="op" id="5574980">(</span><span class="ident" id="5574981">d</span><span class="op" id="5574982">.</span><span class="ident" id="5574983">bits</span><span class="op" id="5574987">.</span><span class="ident" id="5574988">n</span><span class="op" id="5574989">-</span><span class="ident" id="5574990">n</span><span class="op" id="5574991">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5574994">ret</span>&nbsp;<span class="op" id="5574998">&amp;=</span>&nbsp;<span class="op" id="5575001">(</span><span class="num" id="5575002">1</span>&nbsp;<span class="op" id="5575004">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5575007">uint32</span><span class="op" id="5575013">(</span><span class="ident" id="5575014">n</span><span class="op" id="5575015">)</span><span class="op" id="5575016">)</span>&nbsp;<span class="op" id="5575018">-</span>&nbsp;<span class="num" id="5575020">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5575023">d</span><span class="op" id="5575024">.</span><span class="ident" id="5575025">bits</span><span class="op" id="5575029">.</span><span class="ident" id="5575030">n</span>&nbsp;<span class="op" id="5575032">-=</span>&nbsp;<span class="ident" id="5575035">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5575038">d</span><span class="op" id="5575039">.</span><span class="ident" id="5575040">bits</span><span class="op" id="5575044">.</span><span class="ident" id="5575045">m</span>&nbsp;<span class="op" id="5575047">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="5575051">uint32</span><span class="op" id="5575057">(</span><span class="ident" id="5575058">n</span><span class="op" id="5575059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5575062">return</span>&nbsp;<span class="ident" id="5575069">ret</span><span class="op" id="5575072">,</span>&nbsp;<span class="builtintype" id="5575074">nil</span><br>
<span class="lineno"></span><span class="op" id="5575078">}</span>
</div>
</body>
</html>
