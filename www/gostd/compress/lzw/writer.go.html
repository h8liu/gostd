<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6094537">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6094592">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6094646">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6094697">package</span>&nbsp;<span class="ident" id="6094705">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6094710">import</span>&nbsp;<span class="op" id="6094717">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6094720">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6094729">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6094739">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6094746">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6094751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6094754">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="6094799">type</span>&nbsp;<span class="ident" id="6094804">writer</span>&nbsp;<span class="keyword" id="6094811">interface</span>&nbsp;<span class="op" id="6094821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6094824">io</span><span class="op" id="6094826">.</span><span class="ident" id="6094827">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6094839">Flush</span><span class="op" id="6094844">(</span><span class="op" id="6094845">)</span>&nbsp;<span class="builtintype" id="6094847">error</span><br>
<span class="lineno"></span><span class="op" id="6094853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6094856">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6094933">type</span>&nbsp;<span class="ident" id="6094938">errWriteCloser</span>&nbsp;<span class="keyword" id="6094953">struct</span>&nbsp;<span class="op" id="6094960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6094963">err</span>&nbsp;<span class="builtintype" id="6094967">error</span><br>
<span class="lineno"></span><span class="op" id="6094973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6094976">func</span>&nbsp;<span class="op" id="6094981">(</span><span class="ident" id="6094982">e</span>&nbsp;<span class="op" id="6094984">*</span><span class="ident" id="6094985">errWriteCloser</span><span class="op" id="6094999">)</span>&nbsp;<span class="ident" id="6095001">Write</span><span class="op" id="6095006">(</span><span class="op" id="6095007">[</span><span class="op" id="6095008">]</span><span class="builtintype" id="6095009">byte</span><span class="op" id="6095013">)</span>&nbsp;<span class="op" id="6095015">(</span><span class="builtintype" id="6095016">int</span><span class="op" id="6095019">,</span>&nbsp;<span class="builtintype" id="6095021">error</span><span class="op" id="6095026">)</span>&nbsp;<span class="op" id="6095028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6095031">return</span>&nbsp;<span class="num" id="6095038">0</span><span class="op" id="6095039">,</span>&nbsp;<span class="ident" id="6095041">e</span><span class="op" id="6095042">.</span><span class="ident" id="6095043">err</span><br>
<span class="lineno"></span><span class="op" id="6095047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6095050">func</span>&nbsp;<span class="op" id="6095055">(</span><span class="ident" id="6095056">e</span>&nbsp;<span class="op" id="6095058">*</span><span class="ident" id="6095059">errWriteCloser</span><span class="op" id="6095073">)</span>&nbsp;<span class="ident" id="6095075">Close</span><span class="op" id="6095080">(</span><span class="op" id="6095081">)</span>&nbsp;<span class="builtintype" id="6095083">error</span>&nbsp;<span class="op" id="6095089">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6095092">return</span>&nbsp;<span class="ident" id="6095099">e</span><span class="op" id="6095100">.</span><span class="ident" id="6095101">err</span><br>
<span class="lineno"></span><span class="op" id="6095105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6095108">const</span>&nbsp;<span class="op" id="6095114">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095117">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095189">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095230">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6095242">=</span>&nbsp;<span class="num" id="6095244">1</span><span class="op" id="6095245">&lt;&lt;</span><span class="num" id="6095247">12</span>&nbsp;<span class="op" id="6095250">-</span>&nbsp;<span class="num" id="6095252">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095255">invalidCode</span>&nbsp;<span class="op" id="6095267">=</span>&nbsp;<span class="num" id="6095269">1</span><span class="op" id="6095270">&lt;&lt;</span><span class="num" id="6095272">32</span>&nbsp;<span class="op" id="6095275">-</span>&nbsp;<span class="num" id="6095277">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095280">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095357">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095436">tableSize</span>&nbsp;<span class="op" id="6095446">=</span>&nbsp;<span class="num" id="6095448">4</span>&nbsp;<span class="op" id="6095450">*</span>&nbsp;<span class="num" id="6095452">1</span>&nbsp;<span class="op" id="6095454">&lt;&lt;</span>&nbsp;<span class="num" id="6095457">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095461">tableMask</span>&nbsp;<span class="op" id="6095471">=</span>&nbsp;<span class="ident" id="6095473">tableSize</span>&nbsp;<span class="op" id="6095483">-</span>&nbsp;<span class="num" id="6095485">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095488">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095559">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095622">invalidEntry</span>&nbsp;<span class="op" id="6095635">=</span>&nbsp;<span class="num" id="6095637">0</span><br>
<span class="lineno">45</span><span class="op" id="6095639">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6095642">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="6095672">type</span>&nbsp;<span class="ident" id="6095677">encoder</span>&nbsp;<span class="keyword" id="6095685">struct</span>&nbsp;<span class="op" id="6095692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095695">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095753">w</span>&nbsp;<span class="ident" id="6095755">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095763">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095821">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095870">order</span>&nbsp;<span class="ident" id="6095876">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095883">write</span>&nbsp;<span class="keyword" id="6095889">func</span><span class="op" id="6095893">(</span><span class="op" id="6095894">*</span><span class="ident" id="6095895">encoder</span><span class="op" id="6095902">,</span>&nbsp;<span class="builtintype" id="6095904">uint32</span><span class="op" id="6095910">)</span>&nbsp;<span class="builtintype" id="6095912">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095919">bits</span>&nbsp;&nbsp;<span class="builtintype" id="6095925">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095933">nBits</span>&nbsp;<span class="builtintype" id="6095939">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6095945">width</span>&nbsp;<span class="builtintype" id="6095951">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6095957">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096009">litWidth</span>&nbsp;<span class="builtintype" id="6096018">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096024">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096078">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096141">hi</span><span class="op" id="6096143">,</span>&nbsp;<span class="ident" id="6096145">overflow</span>&nbsp;<span class="builtintype" id="6096154">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096162">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096236">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096300">savedCode</span>&nbsp;<span class="builtintype" id="6096310">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096318">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096393">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096447">err</span>&nbsp;<span class="builtintype" id="6096451">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096458">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096532">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096605">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6096676">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096710">table</span>&nbsp;<span class="op" id="6096716">[</span><span class="ident" id="6096717">tableSize</span><span class="op" id="6096726">]</span><span class="builtintype" id="6096727">uint32</span><br>
<span class="lineno"></span><span class="op" id="6096734">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="6096737">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6096808">func</span>&nbsp;<span class="op" id="6096813">(</span><span class="ident" id="6096814">e</span>&nbsp;<span class="op" id="6096816">*</span><span class="ident" id="6096817">encoder</span><span class="op" id="6096824">)</span>&nbsp;<span class="ident" id="6096826">writeLSB</span><span class="op" id="6096834">(</span><span class="ident" id="6096835">c</span>&nbsp;<span class="builtintype" id="6096837">uint32</span><span class="op" id="6096843">)</span>&nbsp;<span class="builtintype" id="6096845">error</span>&nbsp;<span class="op" id="6096851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096854">e</span><span class="op" id="6096855">.</span><span class="ident" id="6096856">bits</span>&nbsp;<span class="op" id="6096861">|=</span>&nbsp;<span class="ident" id="6096864">c</span>&nbsp;<span class="op" id="6096866">&lt;&lt;</span>&nbsp;<span class="ident" id="6096869">e</span><span class="op" id="6096870">.</span><span class="ident" id="6096871">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096878">e</span><span class="op" id="6096879">.</span><span class="ident" id="6096880">nBits</span>&nbsp;<span class="op" id="6096886">+=</span>&nbsp;<span class="ident" id="6096889">e</span><span class="op" id="6096890">.</span><span class="ident" id="6096891">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6096898">for</span>&nbsp;<span class="ident" id="6096902">e</span><span class="op" id="6096903">.</span><span class="ident" id="6096904">nBits</span>&nbsp;<span class="op" id="6096910">&gt;=</span>&nbsp;<span class="num" id="6096913">8</span>&nbsp;<span class="op" id="6096915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6096919">if</span>&nbsp;<span class="ident" id="6096922">err</span>&nbsp;<span class="op" id="6096926">:=</span>&nbsp;<span class="ident" id="6096929">e</span><span class="op" id="6096930">.</span><span class="ident" id="6096931">w</span><span class="op" id="6096932">.</span><span class="ident" id="6096933">WriteByte</span><span class="op" id="6096942">(</span><span class="builtintype" id="6096943">uint8</span><span class="op" id="6096948">(</span><span class="ident" id="6096949">e</span><span class="op" id="6096950">.</span><span class="ident" id="6096951">bits</span><span class="op" id="6096955">)</span><span class="op" id="6096956">)</span><span class="op" id="6096957">;</span>&nbsp;<span class="ident" id="6096959">err</span>&nbsp;<span class="op" id="6096963">!=</span>&nbsp;<span class="builtintype" id="6096966">nil</span>&nbsp;<span class="op" id="6096970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6096975">return</span>&nbsp;<span class="ident" id="6096982">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6096988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6096992">e</span><span class="op" id="6096993">.</span><span class="ident" id="6096994">bits</span>&nbsp;<span class="op" id="6096999">&gt;&gt;=</span>&nbsp;<span class="num" id="6097003">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097007">e</span><span class="op" id="6097008">.</span><span class="ident" id="6097009">nBits</span>&nbsp;<span class="op" id="6097015">-=</span>&nbsp;<span class="num" id="6097018">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6097021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097024">return</span>&nbsp;<span class="builtintype" id="6097031">nil</span><br>
<span class="lineno"></span><span class="op" id="6097035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6097038">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6097108">func</span>&nbsp;<span class="op" id="6097113">(</span><span class="ident" id="6097114">e</span>&nbsp;<span class="op" id="6097116">*</span><span class="ident" id="6097117">encoder</span><span class="op" id="6097124">)</span>&nbsp;<span class="ident" id="6097126">writeMSB</span><span class="op" id="6097134">(</span><span class="ident" id="6097135">c</span>&nbsp;<span class="builtintype" id="6097137">uint32</span><span class="op" id="6097143">)</span>&nbsp;<span class="builtintype" id="6097145">error</span>&nbsp;<span class="op" id="6097151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097154">e</span><span class="op" id="6097155">.</span><span class="ident" id="6097156">bits</span>&nbsp;<span class="op" id="6097161">|=</span>&nbsp;<span class="ident" id="6097164">c</span>&nbsp;<span class="op" id="6097166">&lt;&lt;</span>&nbsp;<span class="op" id="6097169">(</span><span class="num" id="6097170">32</span>&nbsp;<span class="op" id="6097173">-</span>&nbsp;<span class="ident" id="6097175">e</span><span class="op" id="6097176">.</span><span class="ident" id="6097177">width</span>&nbsp;<span class="op" id="6097183">-</span>&nbsp;<span class="ident" id="6097185">e</span><span class="op" id="6097186">.</span><span class="ident" id="6097187">nBits</span><span class="op" id="6097192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097195">e</span><span class="op" id="6097196">.</span><span class="ident" id="6097197">nBits</span>&nbsp;<span class="op" id="6097203">+=</span>&nbsp;<span class="ident" id="6097206">e</span><span class="op" id="6097207">.</span><span class="ident" id="6097208">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097215">for</span>&nbsp;<span class="ident" id="6097219">e</span><span class="op" id="6097220">.</span><span class="ident" id="6097221">nBits</span>&nbsp;<span class="op" id="6097227">&gt;=</span>&nbsp;<span class="num" id="6097230">8</span>&nbsp;<span class="op" id="6097232">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097236">if</span>&nbsp;<span class="ident" id="6097239">err</span>&nbsp;<span class="op" id="6097243">:=</span>&nbsp;<span class="ident" id="6097246">e</span><span class="op" id="6097247">.</span><span class="ident" id="6097248">w</span><span class="op" id="6097249">.</span><span class="ident" id="6097250">WriteByte</span><span class="op" id="6097259">(</span><span class="builtintype" id="6097260">uint8</span><span class="op" id="6097265">(</span><span class="ident" id="6097266">e</span><span class="op" id="6097267">.</span><span class="ident" id="6097268">bits</span>&nbsp;<span class="op" id="6097273">&gt;&gt;</span>&nbsp;<span class="num" id="6097276">24</span><span class="op" id="6097278">)</span><span class="op" id="6097279">)</span><span class="op" id="6097280">;</span>&nbsp;<span class="ident" id="6097282">err</span>&nbsp;<span class="op" id="6097286">!=</span>&nbsp;<span class="builtintype" id="6097289">nil</span>&nbsp;<span class="op" id="6097293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097298">return</span>&nbsp;<span class="ident" id="6097305">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6097311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097315">e</span><span class="op" id="6097316">.</span><span class="ident" id="6097317">bits</span>&nbsp;<span class="op" id="6097322">&lt;&lt;=</span>&nbsp;<span class="num" id="6097326">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097330">e</span><span class="op" id="6097331">.</span><span class="ident" id="6097332">nBits</span>&nbsp;<span class="op" id="6097338">-=</span>&nbsp;<span class="num" id="6097341">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6097344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097347">return</span>&nbsp;<span class="builtintype" id="6097354">nil</span><br>
<span class="lineno"></span><span class="op" id="6097358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6097361">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="6097439">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="6097498">var</span>&nbsp;<span class="ident" id="6097502">errOutOfCodes</span>&nbsp;<span class="op" id="6097516">=</span>&nbsp;<span class="ident" id="6097518">errors</span><span class="op" id="6097524">.</span><span class="ident" id="6097525">New</span><span class="op" id="6097528">(</span><span class="string" id="6097529">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="6097548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6097551">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6097624">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="6097698">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="6097742">func</span>&nbsp;<span class="op" id="6097747">(</span><span class="ident" id="6097748">e</span>&nbsp;<span class="op" id="6097750">*</span><span class="ident" id="6097751">encoder</span><span class="op" id="6097758">)</span>&nbsp;<span class="ident" id="6097760">incHi</span><span class="op" id="6097765">(</span><span class="op" id="6097766">)</span>&nbsp;<span class="builtintype" id="6097768">error</span>&nbsp;<span class="op" id="6097774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097777">e</span><span class="op" id="6097778">.</span><span class="ident" id="6097779">hi</span><span class="op" id="6097781">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097785">if</span>&nbsp;<span class="ident" id="6097788">e</span><span class="op" id="6097789">.</span><span class="ident" id="6097790">hi</span>&nbsp;<span class="op" id="6097793">==</span>&nbsp;<span class="ident" id="6097796">e</span><span class="op" id="6097797">.</span><span class="ident" id="6097798">overflow</span>&nbsp;<span class="op" id="6097807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097811">e</span><span class="op" id="6097812">.</span><span class="ident" id="6097813">width</span><span class="op" id="6097818">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097823">e</span><span class="op" id="6097824">.</span><span class="ident" id="6097825">overflow</span>&nbsp;<span class="op" id="6097834">&lt;&lt;=</span>&nbsp;<span class="num" id="6097838">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6097841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097844">if</span>&nbsp;<span class="ident" id="6097847">e</span><span class="op" id="6097848">.</span><span class="ident" id="6097849">hi</span>&nbsp;<span class="op" id="6097852">==</span>&nbsp;<span class="ident" id="6097855">maxCode</span>&nbsp;<span class="op" id="6097863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097867">clear</span>&nbsp;<span class="op" id="6097873">:=</span>&nbsp;<span class="builtintype" id="6097876">uint32</span><span class="op" id="6097882">(</span><span class="num" id="6097883">1</span><span class="op" id="6097884">)</span>&nbsp;<span class="op" id="6097886">&lt;&lt;</span>&nbsp;<span class="ident" id="6097889">e</span><span class="op" id="6097890">.</span><span class="ident" id="6097891">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097902">if</span>&nbsp;<span class="ident" id="6097905">err</span>&nbsp;<span class="op" id="6097909">:=</span>&nbsp;<span class="ident" id="6097912">e</span><span class="op" id="6097913">.</span><span class="ident" id="6097914">write</span><span class="op" id="6097919">(</span><span class="ident" id="6097920">e</span><span class="op" id="6097921">,</span>&nbsp;<span class="ident" id="6097923">clear</span><span class="op" id="6097928">)</span><span class="op" id="6097929">;</span>&nbsp;<span class="ident" id="6097931">err</span>&nbsp;<span class="op" id="6097935">!=</span>&nbsp;<span class="builtintype" id="6097938">nil</span>&nbsp;<span class="op" id="6097942">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6097947">return</span>&nbsp;<span class="ident" id="6097954">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6097960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097964">e</span><span class="op" id="6097965">.</span><span class="ident" id="6097966">width</span>&nbsp;<span class="op" id="6097972">=</span>&nbsp;<span class="builtintype" id="6097974">uint</span><span class="op" id="6097978">(</span><span class="ident" id="6097979">e</span><span class="op" id="6097980">.</span><span class="ident" id="6097981">litWidth</span><span class="op" id="6097989">)</span>&nbsp;<span class="op" id="6097991">+</span>&nbsp;<span class="num" id="6097993">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6097997">e</span><span class="op" id="6097998">.</span><span class="ident" id="6097999">hi</span>&nbsp;<span class="op" id="6098002">=</span>&nbsp;<span class="ident" id="6098004">clear</span>&nbsp;<span class="op" id="6098010">+</span>&nbsp;<span class="num" id="6098012">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098016">e</span><span class="op" id="6098017">.</span><span class="ident" id="6098018">overflow</span>&nbsp;<span class="op" id="6098027">=</span>&nbsp;<span class="ident" id="6098029">clear</span>&nbsp;<span class="op" id="6098035">&lt;&lt;</span>&nbsp;<span class="num" id="6098038">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098042">for</span>&nbsp;<span class="ident" id="6098046">i</span>&nbsp;<span class="op" id="6098048">:=</span>&nbsp;<span class="keyword" id="6098051">range</span>&nbsp;<span class="ident" id="6098057">e</span><span class="op" id="6098058">.</span><span class="ident" id="6098059">table</span>&nbsp;<span class="op" id="6098065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098070">e</span><span class="op" id="6098071">.</span><span class="ident" id="6098072">table</span><span class="op" id="6098077">[</span><span class="ident" id="6098078">i</span><span class="op" id="6098079">]</span>&nbsp;<span class="op" id="6098081">=</span>&nbsp;<span class="ident" id="6098083">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098102">return</span>&nbsp;<span class="ident" id="6098109">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098124">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098127">return</span>&nbsp;<span class="builtintype" id="6098134">nil</span><br>
<span class="lineno"></span><span class="op" id="6098138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6098141">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6098216">func</span>&nbsp;<span class="op" id="6098221">(</span><span class="ident" id="6098222">e</span>&nbsp;<span class="op" id="6098224">*</span><span class="ident" id="6098225">encoder</span><span class="op" id="6098232">)</span>&nbsp;<span class="ident" id="6098234">Write</span><span class="op" id="6098239">(</span><span class="ident" id="6098240">p</span>&nbsp;<span class="op" id="6098242">[</span><span class="op" id="6098243">]</span><span class="builtintype" id="6098244">byte</span><span class="op" id="6098248">)</span>&nbsp;<span class="op" id="6098250">(</span><span class="ident" id="6098251">n</span>&nbsp;<span class="builtintype" id="6098253">int</span><span class="op" id="6098256">,</span>&nbsp;<span class="ident" id="6098258">err</span>&nbsp;<span class="builtintype" id="6098262">error</span><span class="op" id="6098267">)</span>&nbsp;<span class="op" id="6098269">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098272">if</span>&nbsp;<span class="ident" id="6098275">e</span><span class="op" id="6098276">.</span><span class="ident" id="6098277">err</span>&nbsp;<span class="op" id="6098281">!=</span>&nbsp;<span class="builtintype" id="6098284">nil</span>&nbsp;<span class="op" id="6098288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098292">return</span>&nbsp;<span class="num" id="6098299">0</span><span class="op" id="6098300">,</span>&nbsp;<span class="ident" id="6098302">e</span><span class="op" id="6098303">.</span><span class="ident" id="6098304">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098312">if</span>&nbsp;<span class="builtinfunc" id="6098315">len</span><span class="op" id="6098318">(</span><span class="ident" id="6098319">p</span><span class="op" id="6098320">)</span>&nbsp;<span class="op" id="6098322">==</span>&nbsp;<span class="num" id="6098325">0</span>&nbsp;<span class="op" id="6098327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098331">return</span>&nbsp;<span class="num" id="6098338">0</span><span class="op" id="6098339">,</span>&nbsp;<span class="builtintype" id="6098341">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098349">n</span>&nbsp;<span class="op" id="6098351">=</span>&nbsp;<span class="builtinfunc" id="6098353">len</span><span class="op" id="6098356">(</span><span class="ident" id="6098357">p</span><span class="op" id="6098358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098361">litMask</span>&nbsp;<span class="op" id="6098369">:=</span>&nbsp;<span class="builtintype" id="6098372">uint32</span><span class="op" id="6098378">(</span><span class="num" id="6098379">1</span><span class="op" id="6098380">&lt;&lt;</span><span class="ident" id="6098382">e</span><span class="op" id="6098383">.</span><span class="ident" id="6098384">litWidth</span>&nbsp;<span class="op" id="6098393">-</span>&nbsp;<span class="num" id="6098395">1</span><span class="op" id="6098396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098399">code</span>&nbsp;<span class="op" id="6098404">:=</span>&nbsp;<span class="ident" id="6098407">e</span><span class="op" id="6098408">.</span><span class="ident" id="6098409">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098420">if</span>&nbsp;<span class="ident" id="6098423">code</span>&nbsp;<span class="op" id="6098428">==</span>&nbsp;<span class="ident" id="6098431">invalidCode</span>&nbsp;<span class="op" id="6098443">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6098447">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098498">code</span><span class="op" id="6098502">,</span>&nbsp;<span class="ident" id="6098504">p</span>&nbsp;<span class="op" id="6098506">=</span>&nbsp;<span class="builtintype" id="6098508">uint32</span><span class="op" id="6098514">(</span><span class="ident" id="6098515">p</span><span class="op" id="6098516">[</span><span class="num" id="6098517">0</span><span class="op" id="6098518">]</span><span class="op" id="6098519">)</span><span class="op" id="6098520">&amp;</span><span class="ident" id="6098521">litMask</span><span class="op" id="6098528">,</span>&nbsp;<span class="ident" id="6098530">p</span><span class="op" id="6098531">[</span><span class="num" id="6098532">1</span><span class="op" id="6098533">:</span><span class="op" id="6098534">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098537">}</span><br>
<span class="lineno"></span><span class="ident" id="6098539">loop</span><span class="op" id="6098543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098546">for</span>&nbsp;<span class="ident" id="6098550">_</span><span class="op" id="6098551">,</span>&nbsp;<span class="ident" id="6098553">x</span>&nbsp;<span class="op" id="6098555">:=</span>&nbsp;<span class="keyword" id="6098558">range</span>&nbsp;<span class="ident" id="6098564">p</span>&nbsp;<span class="op" id="6098566">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098570">literal</span>&nbsp;<span class="op" id="6098578">:=</span>&nbsp;<span class="builtintype" id="6098581">uint32</span><span class="op" id="6098587">(</span><span class="ident" id="6098588">x</span><span class="op" id="6098589">)</span>&nbsp;<span class="op" id="6098591">&amp;</span>&nbsp;<span class="ident" id="6098593">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098603">key</span>&nbsp;<span class="op" id="6098607">:=</span>&nbsp;<span class="ident" id="6098610">code</span><span class="op" id="6098614">&lt;&lt;</span><span class="num" id="6098616">8</span>&nbsp;<span class="op" id="6098618">|</span>&nbsp;<span class="ident" id="6098620">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6098630">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6098703">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098736">hash</span>&nbsp;<span class="op" id="6098741">:=</span>&nbsp;<span class="op" id="6098744">(</span><span class="ident" id="6098745">key</span><span class="op" id="6098748">&gt;&gt;</span><span class="num" id="6098750">12</span>&nbsp;<span class="op" id="6098753">^</span>&nbsp;<span class="ident" id="6098755">key</span><span class="op" id="6098758">)</span>&nbsp;<span class="op" id="6098760">&amp;</span>&nbsp;<span class="ident" id="6098762">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098774">for</span>&nbsp;<span class="ident" id="6098778">h</span><span class="op" id="6098779">,</span>&nbsp;<span class="ident" id="6098781">t</span>&nbsp;<span class="op" id="6098783">:=</span>&nbsp;<span class="ident" id="6098786">hash</span><span class="op" id="6098790">,</span>&nbsp;<span class="ident" id="6098792">e</span><span class="op" id="6098793">.</span><span class="ident" id="6098794">table</span><span class="op" id="6098799">[</span><span class="ident" id="6098800">hash</span><span class="op" id="6098804">]</span><span class="op" id="6098805">;</span>&nbsp;<span class="ident" id="6098807">t</span>&nbsp;<span class="op" id="6098809">!=</span>&nbsp;<span class="ident" id="6098812">invalidEntry</span><span class="op" id="6098824">;</span>&nbsp;<span class="op" id="6098826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098831">if</span>&nbsp;<span class="ident" id="6098834">key</span>&nbsp;<span class="op" id="6098838">==</span>&nbsp;<span class="ident" id="6098841">t</span><span class="op" id="6098842">&gt;&gt;</span><span class="num" id="6098844">12</span>&nbsp;<span class="op" id="6098847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098853">code</span>&nbsp;<span class="op" id="6098858">=</span>&nbsp;<span class="ident" id="6098860">t</span>&nbsp;<span class="op" id="6098862">&amp;</span>&nbsp;<span class="ident" id="6098864">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6098876">continue</span>&nbsp;<span class="ident" id="6098885">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098893">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098898">h</span>&nbsp;<span class="op" id="6098900">=</span>&nbsp;<span class="op" id="6098902">(</span><span class="ident" id="6098903">h</span>&nbsp;<span class="op" id="6098905">+</span>&nbsp;<span class="num" id="6098907">1</span><span class="op" id="6098908">)</span>&nbsp;<span class="op" id="6098910">&amp;</span>&nbsp;<span class="ident" id="6098912">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6098925">t</span>&nbsp;<span class="op" id="6098927">=</span>&nbsp;<span class="ident" id="6098929">e</span><span class="op" id="6098930">.</span><span class="ident" id="6098931">table</span><span class="op" id="6098936">[</span><span class="ident" id="6098937">h</span><span class="op" id="6098938">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6098942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6098946">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6099019">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099047">if</span>&nbsp;<span class="ident" id="6099050">e</span><span class="op" id="6099051">.</span><span class="ident" id="6099052">err</span>&nbsp;<span class="op" id="6099056">=</span>&nbsp;<span class="ident" id="6099058">e</span><span class="op" id="6099059">.</span><span class="ident" id="6099060">write</span><span class="op" id="6099065">(</span><span class="ident" id="6099066">e</span><span class="op" id="6099067">,</span>&nbsp;<span class="ident" id="6099069">code</span><span class="op" id="6099073">)</span><span class="op" id="6099074">;</span>&nbsp;<span class="ident" id="6099076">e</span><span class="op" id="6099077">.</span><span class="ident" id="6099078">err</span>&nbsp;<span class="op" id="6099082">!=</span>&nbsp;<span class="builtintype" id="6099085">nil</span>&nbsp;<span class="op" id="6099089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099094">return</span>&nbsp;<span class="num" id="6099101">0</span><span class="op" id="6099102">,</span>&nbsp;<span class="ident" id="6099104">e</span><span class="op" id="6099105">.</span><span class="ident" id="6099106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6099116">code</span>&nbsp;<span class="op" id="6099121">=</span>&nbsp;<span class="ident" id="6099123">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6099133">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6099207">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099280">if</span>&nbsp;<span class="ident" id="6099283">err1</span>&nbsp;<span class="op" id="6099288">:=</span>&nbsp;<span class="ident" id="6099291">e</span><span class="op" id="6099292">.</span><span class="ident" id="6099293">incHi</span><span class="op" id="6099298">(</span><span class="op" id="6099299">)</span><span class="op" id="6099300">;</span>&nbsp;<span class="ident" id="6099302">err1</span>&nbsp;<span class="op" id="6099307">!=</span>&nbsp;<span class="builtintype" id="6099310">nil</span>&nbsp;<span class="op" id="6099314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099319">if</span>&nbsp;<span class="ident" id="6099322">err1</span>&nbsp;<span class="op" id="6099327">==</span>&nbsp;<span class="ident" id="6099330">errOutOfCodes</span>&nbsp;<span class="op" id="6099344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099350">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099362">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6099367">e</span><span class="op" id="6099368">.</span><span class="ident" id="6099369">err</span>&nbsp;<span class="op" id="6099373">=</span>&nbsp;<span class="ident" id="6099375">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099383">return</span>&nbsp;<span class="num" id="6099390">0</span><span class="op" id="6099391">,</span>&nbsp;<span class="ident" id="6099393">e</span><span class="op" id="6099394">.</span><span class="ident" id="6099395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6099405">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099478">for</span>&nbsp;<span class="op" id="6099482">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099487">if</span>&nbsp;<span class="ident" id="6099490">e</span><span class="op" id="6099491">.</span><span class="ident" id="6099492">table</span><span class="op" id="6099497">[</span><span class="ident" id="6099498">hash</span><span class="op" id="6099502">]</span>&nbsp;<span class="op" id="6099504">==</span>&nbsp;<span class="ident" id="6099507">invalidEntry</span>&nbsp;<span class="op" id="6099520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6099526">e</span><span class="op" id="6099527">.</span><span class="ident" id="6099528">table</span><span class="op" id="6099533">[</span><span class="ident" id="6099534">hash</span><span class="op" id="6099538">]</span>&nbsp;<span class="op" id="6099540">=</span>&nbsp;<span class="op" id="6099542">(</span><span class="ident" id="6099543">key</span>&nbsp;<span class="op" id="6099547">&lt;&lt;</span>&nbsp;<span class="num" id="6099550">12</span><span class="op" id="6099552">)</span>&nbsp;<span class="op" id="6099554">|</span>&nbsp;<span class="ident" id="6099556">e</span><span class="op" id="6099557">.</span><span class="ident" id="6099558">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099565">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6099579">hash</span>&nbsp;<span class="op" id="6099584">=</span>&nbsp;<span class="op" id="6099586">(</span><span class="ident" id="6099587">hash</span>&nbsp;<span class="op" id="6099592">+</span>&nbsp;<span class="num" id="6099594">1</span><span class="op" id="6099595">)</span>&nbsp;<span class="op" id="6099597">&amp;</span>&nbsp;<span class="ident" id="6099599">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6099617">e</span><span class="op" id="6099618">.</span><span class="ident" id="6099619">savedCode</span>&nbsp;<span class="op" id="6099629">=</span>&nbsp;<span class="ident" id="6099631">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099637">return</span>&nbsp;<span class="ident" id="6099644">n</span><span class="op" id="6099645">,</span>&nbsp;<span class="builtintype" id="6099647">nil</span><br>
<span class="lineno"></span><span class="op" id="6099651">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="6099654">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6099733">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6099765">func</span>&nbsp;<span class="op" id="6099770">(</span><span class="ident" id="6099771">e</span>&nbsp;<span class="op" id="6099773">*</span><span class="ident" id="6099774">encoder</span><span class="op" id="6099781">)</span>&nbsp;<span class="ident" id="6099783">Close</span><span class="op" id="6099788">(</span><span class="op" id="6099789">)</span>&nbsp;<span class="builtintype" id="6099791">error</span>&nbsp;<span class="op" id="6099797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099800">if</span>&nbsp;<span class="ident" id="6099803">e</span><span class="op" id="6099804">.</span><span class="ident" id="6099805">err</span>&nbsp;<span class="op" id="6099809">!=</span>&nbsp;<span class="builtintype" id="6099812">nil</span>&nbsp;<span class="op" id="6099816">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099820">if</span>&nbsp;<span class="ident" id="6099823">e</span><span class="op" id="6099824">.</span><span class="ident" id="6099825">err</span>&nbsp;<span class="op" id="6099829">==</span>&nbsp;<span class="ident" id="6099832">errClosed</span>&nbsp;<span class="op" id="6099842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099847">return</span>&nbsp;<span class="builtintype" id="6099854">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099864">return</span>&nbsp;<span class="ident" id="6099871">e</span><span class="op" id="6099872">.</span><span class="ident" id="6099873">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6099878">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6099881">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6099934">e</span><span class="op" id="6099935">.</span><span class="ident" id="6099936">err</span>&nbsp;<span class="op" id="6099940">=</span>&nbsp;<span class="ident" id="6099942">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6099953">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6099987">if</span>&nbsp;<span class="ident" id="6099990">e</span><span class="op" id="6099991">.</span><span class="ident" id="6099992">savedCode</span>&nbsp;<span class="op" id="6100002">!=</span>&nbsp;<span class="ident" id="6100005">invalidCode</span>&nbsp;<span class="op" id="6100017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100021">if</span>&nbsp;<span class="ident" id="6100024">err</span>&nbsp;<span class="op" id="6100028">:=</span>&nbsp;<span class="ident" id="6100031">e</span><span class="op" id="6100032">.</span><span class="ident" id="6100033">write</span><span class="op" id="6100038">(</span><span class="ident" id="6100039">e</span><span class="op" id="6100040">,</span>&nbsp;<span class="ident" id="6100042">e</span><span class="op" id="6100043">.</span><span class="ident" id="6100044">savedCode</span><span class="op" id="6100053">)</span><span class="op" id="6100054">;</span>&nbsp;<span class="ident" id="6100056">err</span>&nbsp;<span class="op" id="6100060">!=</span>&nbsp;<span class="builtintype" id="6100063">nil</span>&nbsp;<span class="op" id="6100067">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100072">return</span>&nbsp;<span class="ident" id="6100079">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100089">if</span>&nbsp;<span class="ident" id="6100092">err</span>&nbsp;<span class="op" id="6100096">:=</span>&nbsp;<span class="ident" id="6100099">e</span><span class="op" id="6100100">.</span><span class="ident" id="6100101">incHi</span><span class="op" id="6100106">(</span><span class="op" id="6100107">)</span><span class="op" id="6100108">;</span>&nbsp;<span class="ident" id="6100110">err</span>&nbsp;<span class="op" id="6100114">!=</span>&nbsp;<span class="builtintype" id="6100117">nil</span>&nbsp;<span class="op" id="6100121">&amp;&amp;</span>&nbsp;<span class="ident" id="6100124">err</span>&nbsp;<span class="op" id="6100128">!=</span>&nbsp;<span class="ident" id="6100131">errOutOfCodes</span>&nbsp;<span class="op" id="6100145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100150">return</span>&nbsp;<span class="ident" id="6100157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100163">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6100169">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6100193">eof</span>&nbsp;<span class="op" id="6100197">:=</span>&nbsp;<span class="builtintype" id="6100200">uint32</span><span class="op" id="6100206">(</span><span class="num" id="6100207">1</span><span class="op" id="6100208">)</span><span class="op" id="6100209">&lt;&lt;</span><span class="ident" id="6100211">e</span><span class="op" id="6100212">.</span><span class="ident" id="6100213">litWidth</span>&nbsp;<span class="op" id="6100222">+</span>&nbsp;<span class="num" id="6100224">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100227">if</span>&nbsp;<span class="ident" id="6100230">err</span>&nbsp;<span class="op" id="6100234">:=</span>&nbsp;<span class="ident" id="6100237">e</span><span class="op" id="6100238">.</span><span class="ident" id="6100239">write</span><span class="op" id="6100244">(</span><span class="ident" id="6100245">e</span><span class="op" id="6100246">,</span>&nbsp;<span class="ident" id="6100248">eof</span><span class="op" id="6100251">)</span><span class="op" id="6100252">;</span>&nbsp;<span class="ident" id="6100254">err</span>&nbsp;<span class="op" id="6100258">!=</span>&nbsp;<span class="builtintype" id="6100261">nil</span>&nbsp;<span class="op" id="6100265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100269">return</span>&nbsp;<span class="ident" id="6100276">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6100284">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100310">if</span>&nbsp;<span class="ident" id="6100313">e</span><span class="op" id="6100314">.</span><span class="ident" id="6100315">nBits</span>&nbsp;<span class="op" id="6100321">&gt;</span>&nbsp;<span class="num" id="6100323">0</span>&nbsp;<span class="op" id="6100325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100329">if</span>&nbsp;<span class="ident" id="6100332">e</span><span class="op" id="6100333">.</span><span class="ident" id="6100334">order</span>&nbsp;<span class="op" id="6100340">==</span>&nbsp;<span class="ident" id="6100343">MSB</span>&nbsp;<span class="op" id="6100347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6100352">e</span><span class="op" id="6100353">.</span><span class="ident" id="6100354">bits</span>&nbsp;<span class="op" id="6100359">&gt;&gt;=</span>&nbsp;<span class="num" id="6100363">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100372">if</span>&nbsp;<span class="ident" id="6100375">err</span>&nbsp;<span class="op" id="6100379">:=</span>&nbsp;<span class="ident" id="6100382">e</span><span class="op" id="6100383">.</span><span class="ident" id="6100384">w</span><span class="op" id="6100385">.</span><span class="ident" id="6100386">WriteByte</span><span class="op" id="6100395">(</span><span class="builtintype" id="6100396">uint8</span><span class="op" id="6100401">(</span><span class="ident" id="6100402">e</span><span class="op" id="6100403">.</span><span class="ident" id="6100404">bits</span><span class="op" id="6100408">)</span><span class="op" id="6100409">)</span><span class="op" id="6100410">;</span>&nbsp;<span class="ident" id="6100412">err</span>&nbsp;<span class="op" id="6100416">!=</span>&nbsp;<span class="builtintype" id="6100419">nil</span>&nbsp;<span class="op" id="6100423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100428">return</span>&nbsp;<span class="ident" id="6100435">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6100444">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100447">return</span>&nbsp;<span class="ident" id="6100454">e</span><span class="op" id="6100455">.</span><span class="ident" id="6100456">w</span><span class="op" id="6100457">.</span><span class="ident" id="6100458">Flush</span><span class="op" id="6100463">(</span><span class="op" id="6100464">)</span><br>
<span class="lineno"></span><span class="op" id="6100466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6100469">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="6100512">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="6100586">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6100661">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="6100682">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6100755">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="6100790">func</span>&nbsp;<span class="ident" id="6100795">NewWriter</span><span class="op" id="6100804">(</span><span class="ident" id="6100805">w</span>&nbsp;<span class="ident" id="6100807">io</span><span class="op" id="6100809">.</span><span class="ident" id="6100810">Writer</span><span class="op" id="6100816">,</span>&nbsp;<span class="ident" id="6100818">order</span>&nbsp;<span class="ident" id="6100824">Order</span><span class="op" id="6100829">,</span>&nbsp;<span class="ident" id="6100831">litWidth</span>&nbsp;<span class="builtintype" id="6100840">int</span><span class="op" id="6100843">)</span>&nbsp;<span class="ident" id="6100845">io</span><span class="op" id="6100847">.</span><span class="ident" id="6100848">WriteCloser</span>&nbsp;<span class="op" id="6100860">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100863">var</span>&nbsp;<span class="ident" id="6100867">write</span>&nbsp;<span class="keyword" id="6100873">func</span><span class="op" id="6100877">(</span><span class="op" id="6100878">*</span><span class="ident" id="6100879">encoder</span><span class="op" id="6100886">,</span>&nbsp;<span class="builtintype" id="6100888">uint32</span><span class="op" id="6100894">)</span>&nbsp;<span class="builtintype" id="6100896">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100903">switch</span>&nbsp;<span class="ident" id="6100910">order</span>&nbsp;<span class="op" id="6100916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100919">case</span>&nbsp;<span class="ident" id="6100924">LSB</span><span class="op" id="6100927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6100931">write</span>&nbsp;<span class="op" id="6100937">=</span>&nbsp;<span class="op" id="6100939">(</span><span class="op" id="6100940">*</span><span class="ident" id="6100941">encoder</span><span class="op" id="6100948">)</span><span class="op" id="6100949">.</span><span class="ident" id="6100950">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6100960">case</span>&nbsp;<span class="ident" id="6100965">MSB</span><span class="op" id="6100968">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6100972">write</span>&nbsp;<span class="op" id="6100978">=</span>&nbsp;<span class="op" id="6100980">(</span><span class="op" id="6100981">*</span><span class="ident" id="6100982">encoder</span><span class="op" id="6100989">)</span><span class="op" id="6100990">.</span><span class="ident" id="6100991">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6101001">default</span><span class="op" id="6101008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6101012">return</span>&nbsp;<span class="op" id="6101019">&amp;</span><span class="ident" id="6101020">errWriteCloser</span><span class="op" id="6101034">{</span><span class="ident" id="6101035">errors</span><span class="op" id="6101041">.</span><span class="ident" id="6101042">New</span><span class="op" id="6101045">(</span><span class="string" id="6101046">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="6101066">)</span><span class="op" id="6101067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6101070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6101073">if</span>&nbsp;<span class="ident" id="6101076">litWidth</span>&nbsp;<span class="op" id="6101085">&lt;</span>&nbsp;<span class="num" id="6101087">2</span>&nbsp;<span class="op" id="6101089">||</span>&nbsp;<span class="num" id="6101092">8</span>&nbsp;<span class="op" id="6101094">&lt;</span>&nbsp;<span class="ident" id="6101096">litWidth</span>&nbsp;<span class="op" id="6101105">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6101109">return</span>&nbsp;<span class="op" id="6101116">&amp;</span><span class="ident" id="6101117">errWriteCloser</span><span class="op" id="6101131">{</span><span class="ident" id="6101132">fmt</span><span class="op" id="6101135">.</span><span class="ident" id="6101136">Errorf</span><span class="op" id="6101142">(</span><span class="string" id="6101143">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6101174">,</span>&nbsp;<span class="ident" id="6101176">litWidth</span><span class="op" id="6101184">)</span><span class="op" id="6101185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6101188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101191">bw</span><span class="op" id="6101193">,</span>&nbsp;<span class="ident" id="6101195">ok</span>&nbsp;<span class="op" id="6101198">:=</span>&nbsp;<span class="ident" id="6101201">w</span><span class="op" id="6101202">.</span><span class="op" id="6101203">(</span><span class="ident" id="6101204">writer</span><span class="op" id="6101210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6101213">if</span>&nbsp;<span class="op" id="6101216">!</span><span class="ident" id="6101217">ok</span>&nbsp;<span class="op" id="6101220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101224">bw</span>&nbsp;<span class="op" id="6101227">=</span>&nbsp;<span class="ident" id="6101229">bufio</span><span class="op" id="6101234">.</span><span class="ident" id="6101235">NewWriter</span><span class="op" id="6101244">(</span><span class="ident" id="6101245">w</span><span class="op" id="6101246">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6101249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101252">lw</span>&nbsp;<span class="op" id="6101255">:=</span>&nbsp;<span class="builtintype" id="6101258">uint</span><span class="op" id="6101262">(</span><span class="ident" id="6101263">litWidth</span><span class="op" id="6101271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6101274">return</span>&nbsp;<span class="op" id="6101281">&amp;</span><span class="ident" id="6101282">encoder</span><span class="op" id="6101289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101293">w</span><span class="op" id="6101294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101304">bw</span><span class="op" id="6101306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101310">order</span><span class="op" id="6101315">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101321">order</span><span class="op" id="6101326">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101330">write</span><span class="op" id="6101335">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101341">write</span><span class="op" id="6101346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101350">width</span><span class="op" id="6101355">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6101361">1</span>&nbsp;<span class="op" id="6101363">+</span>&nbsp;<span class="ident" id="6101365">lw</span><span class="op" id="6101367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101371">litWidth</span><span class="op" id="6101379">:</span>&nbsp;&nbsp;<span class="ident" id="6101382">lw</span><span class="op" id="6101384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101388">hi</span><span class="op" id="6101390">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6101399">1</span><span class="op" id="6101400">&lt;&lt;</span><span class="ident" id="6101402">lw</span>&nbsp;<span class="op" id="6101405">+</span>&nbsp;<span class="num" id="6101407">1</span><span class="op" id="6101408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101412">overflow</span><span class="op" id="6101420">:</span>&nbsp;&nbsp;<span class="num" id="6101423">1</span>&nbsp;<span class="op" id="6101425">&lt;&lt;</span>&nbsp;<span class="op" id="6101428">(</span><span class="ident" id="6101429">lw</span>&nbsp;<span class="op" id="6101432">+</span>&nbsp;<span class="num" id="6101434">1</span><span class="op" id="6101435">)</span><span class="op" id="6101436">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6101440">savedCode</span><span class="op" id="6101449">:</span>&nbsp;<span class="ident" id="6101451">invalidCode</span><span class="op" id="6101462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6101465">}</span><br>
<span class="lineno"></span><span class="op" id="6101467">}</span>
</div>
</body>
</html>
