<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3938087">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3938142">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3938196">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3938247">package</span>&nbsp;<span class="ident" id="3938255">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3938260">import</span>&nbsp;<span class="op" id="3938267">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938270">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938280">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938296">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938315">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938329">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938343">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938358">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938375">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938390">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938407">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938417">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3938423">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3938434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3938437">var</span>&nbsp;<span class="ident" id="3938441">errClientKeyExchange</span>&nbsp;<span class="op" id="3938462">=</span>&nbsp;<span class="ident" id="3938464"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3938470">.</span><span class="ident" id="3938471">New</span><span class="op" id="3938474">(</span><span class="string" id="3938475">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3938515">)</span><br>
<span class="lineno"></span><span class="keyword" id="3938517">var</span>&nbsp;<span class="ident" id="3938521">errServerKeyExchange</span>&nbsp;<span class="op" id="3938542">=</span>&nbsp;<span class="ident" id="3938544"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3938550">.</span><span class="ident" id="3938551">New</span><span class="op" id="3938554">(</span><span class="string" id="3938555">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3938595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3938598">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3938676">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3938738">type</span>&nbsp;<span class="ident" id="3938743">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3938759">struct</span><span class="op" id="3938765">{</span><span class="op" id="3938766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3938769">func</span>&nbsp;<span class="op" id="3938774">(</span><span class="ident" id="3938775">ka</span>&nbsp;<span class="ident" id="3938778"><a href="/crypto/tls/key_agreement.go.html#3938743">rsaKeyAgreement</a></span><span class="op" id="3938793">)</span>&nbsp;<span class="ident" id="3938795">generateServerKeyExchange</span><span class="op" id="3938820">(</span><span class="ident" id="3938821">config</span>&nbsp;<span class="op" id="3938828">*</span><span class="ident" id="3938829"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3938835">,</span>&nbsp;<span class="ident" id="3938837">cert</span>&nbsp;<span class="op" id="3938842">*</span><span class="ident" id="3938843"><a href="/crypto/tls/common.go.html#3838319">Certificate</a></span><span class="op" id="3938854">,</span>&nbsp;<span class="ident" id="3938856">clientHello</span>&nbsp;<span class="op" id="3938868">*</span><span class="ident" id="3938869"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3938883">,</span>&nbsp;<span class="ident" id="3938885">hello</span>&nbsp;<span class="op" id="3938891">*</span><span class="ident" id="3938892"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><span class="op" id="3938906">)</span>&nbsp;<span class="op" id="3938908">(</span><span class="op" id="3938909">*</span><span class="ident" id="3938910"><a href="/crypto/tls/handshake_messages.go.html#3906795">serverKeyExchangeMsg</a></span><span class="op" id="3938930">,</span>&nbsp;<span class="builtintype" id="3938932">error</span><span class="op" id="3938937">)</span>&nbsp;<span class="op" id="3938939">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938942">return</span>&nbsp;<span class="ident" id="3938949">nil</span><span class="op" id="3938952">,</span>&nbsp;<span class="ident" id="3938954">nil</span><br>
<span class="lineno"></span><span class="op" id="3938958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3938961">func</span>&nbsp;<span class="op" id="3938966">(</span><span class="ident" id="3938967">ka</span>&nbsp;<span class="ident" id="3938970"><a href="/crypto/tls/key_agreement.go.html#3938743">rsaKeyAgreement</a></span><span class="op" id="3938985">)</span>&nbsp;<span class="ident" id="3938987">processClientKeyExchange</span><span class="op" id="3939011">(</span><span class="ident" id="3939012">config</span>&nbsp;<span class="op" id="3939019">*</span><span class="ident" id="3939020"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3939026">,</span>&nbsp;<span class="ident" id="3939028">cert</span>&nbsp;<span class="op" id="3939033">*</span><span class="ident" id="3939034"><a href="/crypto/tls/common.go.html#3838319">Certificate</a></span><span class="op" id="3939045">,</span>&nbsp;<span class="ident" id="3939047">ckx</span>&nbsp;<span class="op" id="3939051">*</span><span class="ident" id="3939052"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3939072">,</span>&nbsp;<span class="ident" id="3939074">version</span>&nbsp;<span class="builtintype" id="3939082">uint16</span><span class="op" id="3939088">)</span>&nbsp;<span class="op" id="3939090">(</span><span class="op" id="3939091">[</span><span class="op" id="3939092">]</span><span class="builtintype" id="3939093">byte</span><span class="op" id="3939097">,</span>&nbsp;<span class="builtintype" id="3939099">error</span><span class="op" id="3939104">)</span>&nbsp;<span class="op" id="3939106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939109">preMasterSecret</span>&nbsp;<span class="op" id="3939125">:=</span>&nbsp;<span class="builtinfunc" id="3939128">make</span><span class="op" id="3939132">(</span><span class="op" id="3939133">[</span><span class="op" id="3939134">]</span><span class="builtintype" id="3939135">byte</span><span class="op" id="3939139">,</span>&nbsp;<span class="num" id="3939141">48</span><span class="op" id="3939143">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939146">_</span><span class="op" id="3939147">,</span>&nbsp;<span class="ident" id="3939149">err</span>&nbsp;<span class="op" id="3939153">:=</span>&nbsp;<span class="ident" id="3939156"><a href="/crypto/tls/key_agreement.go.html#3938417">io</a></span><span class="op" id="3939158">.</span><span class="ident" id="3939159">ReadFull</span><span class="op" id="3939167">(</span><span class="ident" id="3939168"><a href="/crypto/tls/key_agreement.go.html#3939012">config</a></span><span class="op" id="3939174">.</span><span class="ident" id="3939175">rand</span><span class="op" id="3939179">(</span><span class="op" id="3939180">)</span><span class="op" id="3939181">,</span>&nbsp;<span class="ident" id="3939183"><a href="/crypto/tls/key_agreement.go.html#3939109">preMasterSecret</a></span><span class="op" id="3939198">[</span><span class="num" id="3939199">2</span><span class="op" id="3939200">:</span><span class="op" id="3939201">]</span><span class="op" id="3939202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939205">if</span>&nbsp;<span class="ident" id="3939208"><a href="/crypto/tls/key_agreement.go.html#3939149">err</a></span>&nbsp;<span class="op" id="3939212">!=</span>&nbsp;<span class="ident" id="3939215">nil</span>&nbsp;<span class="op" id="3939219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939223">return</span>&nbsp;<span class="ident" id="3939230">nil</span><span class="op" id="3939233">,</span>&nbsp;<span class="ident" id="3939235"><a href="/crypto/tls/key_agreement.go.html#3939149">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939244">if</span>&nbsp;<span class="builtinfunc" id="3939247">len</span><span class="op" id="3939250">(</span><span class="ident" id="3939251"><a href="/crypto/tls/key_agreement.go.html#3939047">ckx</a></span><span class="op" id="3939254">.</span><span class="ident" id="3939255">ciphertext</span><span class="op" id="3939265">)</span>&nbsp;<span class="op" id="3939267">&lt;</span>&nbsp;<span class="num" id="3939269">2</span>&nbsp;<span class="op" id="3939271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939275">return</span>&nbsp;<span class="ident" id="3939282">nil</span><span class="op" id="3939285">,</span>&nbsp;<span class="ident" id="3939287"><a href="/crypto/tls/key_agreement.go.html#3938441">errClientKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939313">ciphertext</span>&nbsp;<span class="op" id="3939324">:=</span>&nbsp;<span class="ident" id="3939327"><a href="/crypto/tls/key_agreement.go.html#3939047">ckx</a></span><span class="op" id="3939330">.</span><span class="ident" id="3939331">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939343">if</span>&nbsp;<span class="ident" id="3939346"><a href="/crypto/tls/key_agreement.go.html#3939074">version</a></span>&nbsp;<span class="op" id="3939354">!=</span>&nbsp;<span class="ident" id="3939357"><a href="/crypto/tls/common.go.html#3822772">VersionSSL30</a></span>&nbsp;<span class="op" id="3939370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939374">ciphertextLen</span>&nbsp;<span class="op" id="3939388">:=</span>&nbsp;<span class="builtintype" id="3939391">int</span><span class="op" id="3939394">(</span><span class="ident" id="3939395"><a href="/crypto/tls/key_agreement.go.html#3939047">ckx</a></span><span class="op" id="3939398">.</span><span class="ident" id="3939399">ciphertext</span><span class="op" id="3939409">[</span><span class="num" id="3939410">0</span><span class="op" id="3939411">]</span><span class="op" id="3939412">)</span><span class="op" id="3939413">&lt;&lt;</span><span class="num" id="3939415">8</span>&nbsp;<span class="op" id="3939417">|</span>&nbsp;<span class="builtintype" id="3939419">int</span><span class="op" id="3939422">(</span><span class="ident" id="3939423"><a href="/crypto/tls/key_agreement.go.html#3939047">ckx</a></span><span class="op" id="3939426">.</span><span class="ident" id="3939427">ciphertext</span><span class="op" id="3939437">[</span><span class="num" id="3939438">1</span><span class="op" id="3939439">]</span><span class="op" id="3939440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939444">if</span>&nbsp;<span class="ident" id="3939447"><a href="/crypto/tls/key_agreement.go.html#3939374">ciphertextLen</a></span>&nbsp;<span class="op" id="3939461">!=</span>&nbsp;<span class="builtinfunc" id="3939464">len</span><span class="op" id="3939467">(</span><span class="ident" id="3939468"><a href="/crypto/tls/key_agreement.go.html#3939047">ckx</a></span><span class="op" id="3939471">.</span><span class="ident" id="3939472">ciphertext</span><span class="op" id="3939482">)</span><span class="op" id="3939483">-</span><span class="num" id="3939484">2</span>&nbsp;<span class="op" id="3939486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939491">return</span>&nbsp;<span class="ident" id="3939498">nil</span><span class="op" id="3939501">,</span>&nbsp;<span class="ident" id="3939503"><a href="/crypto/tls/key_agreement.go.html#3938441">errClientKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939526">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939530"><a href="/crypto/tls/key_agreement.go.html#3939313">ciphertext</a></span>&nbsp;<span class="op" id="3939541">=</span>&nbsp;<span class="ident" id="3939543"><a href="/crypto/tls/key_agreement.go.html#3939047">ckx</a></span><span class="op" id="3939546">.</span><span class="ident" id="3939547">ciphertext</span><span class="op" id="3939557">[</span><span class="num" id="3939558">2</span><span class="op" id="3939559">:</span><span class="op" id="3939560">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939567"><a href="/crypto/tls/key_agreement.go.html#3939149">err</a></span>&nbsp;<span class="op" id="3939571">=</span>&nbsp;<span class="ident" id="3939573"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3939576">.</span><span class="ident" id="3939577">DecryptPKCS1v15SessionKey</span><span class="op" id="3939602">(</span><span class="ident" id="3939603"><a href="/crypto/tls/key_agreement.go.html#3939012">config</a></span><span class="op" id="3939609">.</span><span class="ident" id="3939610">rand</span><span class="op" id="3939614">(</span><span class="op" id="3939615">)</span><span class="op" id="3939616">,</span>&nbsp;<span class="ident" id="3939618"><a href="/crypto/tls/key_agreement.go.html#3939028">cert</a></span><span class="op" id="3939622">.</span><span class="ident" id="3939623">PrivateKey</span><span class="op" id="3939633">.</span><span class="op" id="3939634">(</span><span class="op" id="3939635">*</span><span class="ident" id="3939636"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3939639">.</span><span class="ident" id="3939640">PrivateKey</span><span class="op" id="3939650">)</span><span class="op" id="3939651">,</span>&nbsp;<span class="ident" id="3939653"><a href="/crypto/tls/key_agreement.go.html#3939313">ciphertext</a></span><span class="op" id="3939663">,</span>&nbsp;<span class="ident" id="3939665"><a href="/crypto/tls/key_agreement.go.html#3939109">preMasterSecret</a></span><span class="op" id="3939680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939683">if</span>&nbsp;<span class="ident" id="3939686"><a href="/crypto/tls/key_agreement.go.html#3939149">err</a></span>&nbsp;<span class="op" id="3939690">!=</span>&nbsp;<span class="ident" id="3939693">nil</span>&nbsp;<span class="op" id="3939697">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939701">return</span>&nbsp;<span class="ident" id="3939708">nil</span><span class="op" id="3939711">,</span>&nbsp;<span class="ident" id="3939713"><a href="/crypto/tls/key_agreement.go.html#3939149">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939721">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939794">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939866">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939934">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3940007">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3940074">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940099">return</span>&nbsp;<span class="ident" id="3940106"><a href="/crypto/tls/key_agreement.go.html#3939109">preMasterSecret</a></span><span class="op" id="3940121">,</span>&nbsp;<span class="ident" id="3940123">nil</span><br>
<span class="lineno"></span><span class="op" id="3940127">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3940130">func</span>&nbsp;<span class="op" id="3940135">(</span><span class="ident" id="3940136">ka</span>&nbsp;<span class="ident" id="3940139"><a href="/crypto/tls/key_agreement.go.html#3938743">rsaKeyAgreement</a></span><span class="op" id="3940154">)</span>&nbsp;<span class="ident" id="3940156">processServerKeyExchange</span><span class="op" id="3940180">(</span><span class="ident" id="3940181">config</span>&nbsp;<span class="op" id="3940188">*</span><span class="ident" id="3940189"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3940195">,</span>&nbsp;<span class="ident" id="3940197">clientHello</span>&nbsp;<span class="op" id="3940209">*</span><span class="ident" id="3940210"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3940224">,</span>&nbsp;<span class="ident" id="3940226">serverHello</span>&nbsp;<span class="op" id="3940238">*</span><span class="ident" id="3940239"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><span class="op" id="3940253">,</span>&nbsp;<span class="ident" id="3940255">cert</span>&nbsp;<span class="op" id="3940260">*</span><span class="ident" id="3940261"><a href="/crypto/tls/key_agreement.go.html#3938375">x509</a></span><span class="op" id="3940265">.</span><span class="ident" id="3940266">Certificate</span><span class="op" id="3940277">,</span>&nbsp;<span class="ident" id="3940279">skx</span>&nbsp;<span class="op" id="3940283">*</span><span class="ident" id="3940284"><a href="/crypto/tls/handshake_messages.go.html#3906795">serverKeyExchangeMsg</a></span><span class="op" id="3940304">)</span>&nbsp;<span class="builtintype" id="3940306">error</span>&nbsp;<span class="op" id="3940312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940315">return</span>&nbsp;<span class="ident" id="3940322"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3940328">.</span><span class="ident" id="3940329">New</span><span class="op" id="3940332">(</span><span class="string" id="3940333">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="3940368">)</span><br>
<span class="lineno"></span><span class="op" id="3940370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3940373">func</span>&nbsp;<span class="op" id="3940378">(</span><span class="ident" id="3940379">ka</span>&nbsp;<span class="ident" id="3940382"><a href="/crypto/tls/key_agreement.go.html#3938743">rsaKeyAgreement</a></span><span class="op" id="3940397">)</span>&nbsp;<span class="ident" id="3940399">generateClientKeyExchange</span><span class="op" id="3940424">(</span><span class="ident" id="3940425">config</span>&nbsp;<span class="op" id="3940432">*</span><span class="ident" id="3940433"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3940439">,</span>&nbsp;<span class="ident" id="3940441">clientHello</span>&nbsp;<span class="op" id="3940453">*</span><span class="ident" id="3940454"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3940468">,</span>&nbsp;<span class="ident" id="3940470">cert</span>&nbsp;<span class="op" id="3940475">*</span><span class="ident" id="3940476"><a href="/crypto/tls/key_agreement.go.html#3938375">x509</a></span><span class="op" id="3940480">.</span><span class="ident" id="3940481">Certificate</span><span class="op" id="3940492">)</span>&nbsp;<span class="op" id="3940494">(</span><span class="op" id="3940495">[</span><span class="op" id="3940496">]</span><span class="builtintype" id="3940497">byte</span><span class="op" id="3940501">,</span>&nbsp;<span class="op" id="3940503">*</span><span class="ident" id="3940504"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3940524">,</span>&nbsp;<span class="builtintype" id="3940526">error</span><span class="op" id="3940531">)</span>&nbsp;<span class="op" id="3940533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940536">preMasterSecret</span>&nbsp;<span class="op" id="3940552">:=</span>&nbsp;<span class="builtinfunc" id="3940555">make</span><span class="op" id="3940559">(</span><span class="op" id="3940560">[</span><span class="op" id="3940561">]</span><span class="builtintype" id="3940562">byte</span><span class="op" id="3940566">,</span>&nbsp;<span class="num" id="3940568">48</span><span class="op" id="3940570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940573"><a href="/crypto/tls/key_agreement.go.html#3940536">preMasterSecret</a></span><span class="op" id="3940588">[</span><span class="num" id="3940589">0</span><span class="op" id="3940590">]</span>&nbsp;<span class="op" id="3940592">=</span>&nbsp;<span class="builtintype" id="3940594">byte</span><span class="op" id="3940598">(</span><span class="ident" id="3940599"><a href="/crypto/tls/key_agreement.go.html#3940441">clientHello</a></span><span class="op" id="3940610">.</span><span class="ident" id="3940611">vers</span>&nbsp;<span class="op" id="3940616">&gt;&gt;</span>&nbsp;<span class="num" id="3940619">8</span><span class="op" id="3940620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940623"><a href="/crypto/tls/key_agreement.go.html#3940536">preMasterSecret</a></span><span class="op" id="3940638">[</span><span class="num" id="3940639">1</span><span class="op" id="3940640">]</span>&nbsp;<span class="op" id="3940642">=</span>&nbsp;<span class="builtintype" id="3940644">byte</span><span class="op" id="3940648">(</span><span class="ident" id="3940649"><a href="/crypto/tls/key_agreement.go.html#3940441">clientHello</a></span><span class="op" id="3940660">.</span><span class="ident" id="3940661">vers</span><span class="op" id="3940665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940668">_</span><span class="op" id="3940669">,</span>&nbsp;<span class="ident" id="3940671">err</span>&nbsp;<span class="op" id="3940675">:=</span>&nbsp;<span class="ident" id="3940678"><a href="/crypto/tls/key_agreement.go.html#3938417">io</a></span><span class="op" id="3940680">.</span><span class="ident" id="3940681">ReadFull</span><span class="op" id="3940689">(</span><span class="ident" id="3940690"><a href="/crypto/tls/key_agreement.go.html#3940425">config</a></span><span class="op" id="3940696">.</span><span class="ident" id="3940697">rand</span><span class="op" id="3940701">(</span><span class="op" id="3940702">)</span><span class="op" id="3940703">,</span>&nbsp;<span class="ident" id="3940705"><a href="/crypto/tls/key_agreement.go.html#3940536">preMasterSecret</a></span><span class="op" id="3940720">[</span><span class="num" id="3940721">2</span><span class="op" id="3940722">:</span><span class="op" id="3940723">]</span><span class="op" id="3940724">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940727">if</span>&nbsp;<span class="ident" id="3940730"><a href="/crypto/tls/key_agreement.go.html#3940671">err</a></span>&nbsp;<span class="op" id="3940734">!=</span>&nbsp;<span class="ident" id="3940737">nil</span>&nbsp;<span class="op" id="3940741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940745">return</span>&nbsp;<span class="ident" id="3940752">nil</span><span class="op" id="3940755">,</span>&nbsp;<span class="ident" id="3940757">nil</span><span class="op" id="3940760">,</span>&nbsp;<span class="ident" id="3940762"><a href="/crypto/tls/key_agreement.go.html#3940671">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940771">encrypted</span><span class="op" id="3940780">,</span>&nbsp;<span class="ident" id="3940782"><a href="/crypto/tls/key_agreement.go.html#3940671">err</a></span>&nbsp;<span class="op" id="3940786">:=</span>&nbsp;<span class="ident" id="3940789"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3940792">.</span><span class="ident" id="3940793">EncryptPKCS1v15</span><span class="op" id="3940808">(</span><span class="ident" id="3940809"><a href="/crypto/tls/key_agreement.go.html#3940425">config</a></span><span class="op" id="3940815">.</span><span class="ident" id="3940816">rand</span><span class="op" id="3940820">(</span><span class="op" id="3940821">)</span><span class="op" id="3940822">,</span>&nbsp;<span class="ident" id="3940824"><a href="/crypto/tls/key_agreement.go.html#3940470">cert</a></span><span class="op" id="3940828">.</span><span class="ident" id="3940829">PublicKey</span><span class="op" id="3940838">.</span><span class="op" id="3940839">(</span><span class="op" id="3940840">*</span><span class="ident" id="3940841"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3940844">.</span><span class="ident" id="3940845">PublicKey</span><span class="op" id="3940854">)</span><span class="op" id="3940855">,</span>&nbsp;<span class="ident" id="3940857"><a href="/crypto/tls/key_agreement.go.html#3940536">preMasterSecret</a></span><span class="op" id="3940872">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940875">if</span>&nbsp;<span class="ident" id="3940878"><a href="/crypto/tls/key_agreement.go.html#3940671">err</a></span>&nbsp;<span class="op" id="3940882">!=</span>&nbsp;<span class="ident" id="3940885">nil</span>&nbsp;<span class="op" id="3940889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940893">return</span>&nbsp;<span class="ident" id="3940900">nil</span><span class="op" id="3940903">,</span>&nbsp;<span class="ident" id="3940905">nil</span><span class="op" id="3940908">,</span>&nbsp;<span class="ident" id="3940910"><a href="/crypto/tls/key_agreement.go.html#3940671">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940918">ckx</span>&nbsp;<span class="op" id="3940922">:=</span>&nbsp;<span class="builtinfunc" id="3940925">new</span><span class="op" id="3940928">(</span><span class="ident" id="3940929"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3940949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940952"><a href="/crypto/tls/key_agreement.go.html#3940918">ckx</a></span><span class="op" id="3940955">.</span><span class="ident" id="3940956">ciphertext</span>&nbsp;<span class="op" id="3940967">=</span>&nbsp;<span class="builtinfunc" id="3940969">make</span><span class="op" id="3940973">(</span><span class="op" id="3940974">[</span><span class="op" id="3940975">]</span><span class="builtintype" id="3940976">byte</span><span class="op" id="3940980">,</span>&nbsp;<span class="builtinfunc" id="3940982">len</span><span class="op" id="3940985">(</span><span class="ident" id="3940986"><a href="/crypto/tls/key_agreement.go.html#3940771">encrypted</a></span><span class="op" id="3940995">)</span><span class="op" id="3940996">+</span><span class="num" id="3940997">2</span><span class="op" id="3940998">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941001"><a href="/crypto/tls/key_agreement.go.html#3940918">ckx</a></span><span class="op" id="3941004">.</span><span class="ident" id="3941005">ciphertext</span><span class="op" id="3941015">[</span><span class="num" id="3941016">0</span><span class="op" id="3941017">]</span>&nbsp;<span class="op" id="3941019">=</span>&nbsp;<span class="builtintype" id="3941021">byte</span><span class="op" id="3941025">(</span><span class="builtinfunc" id="3941026">len</span><span class="op" id="3941029">(</span><span class="ident" id="3941030"><a href="/crypto/tls/key_agreement.go.html#3940771">encrypted</a></span><span class="op" id="3941039">)</span>&nbsp;<span class="op" id="3941041">&gt;&gt;</span>&nbsp;<span class="num" id="3941044">8</span><span class="op" id="3941045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941048"><a href="/crypto/tls/key_agreement.go.html#3940918">ckx</a></span><span class="op" id="3941051">.</span><span class="ident" id="3941052">ciphertext</span><span class="op" id="3941062">[</span><span class="num" id="3941063">1</span><span class="op" id="3941064">]</span>&nbsp;<span class="op" id="3941066">=</span>&nbsp;<span class="builtintype" id="3941068">byte</span><span class="op" id="3941072">(</span><span class="builtinfunc" id="3941073">len</span><span class="op" id="3941076">(</span><span class="ident" id="3941077"><a href="/crypto/tls/key_agreement.go.html#3940771">encrypted</a></span><span class="op" id="3941086">)</span><span class="op" id="3941087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3941090">copy</span><span class="op" id="3941094">(</span><span class="ident" id="3941095"><a href="/crypto/tls/key_agreement.go.html#3940918">ckx</a></span><span class="op" id="3941098">.</span><span class="ident" id="3941099">ciphertext</span><span class="op" id="3941109">[</span><span class="num" id="3941110">2</span><span class="op" id="3941111">:</span><span class="op" id="3941112">]</span><span class="op" id="3941113">,</span>&nbsp;<span class="ident" id="3941115"><a href="/crypto/tls/key_agreement.go.html#3940771">encrypted</a></span><span class="op" id="3941124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941127">return</span>&nbsp;<span class="ident" id="3941134"><a href="/crypto/tls/key_agreement.go.html#3940536">preMasterSecret</a></span><span class="op" id="3941149">,</span>&nbsp;<span class="ident" id="3941151"><a href="/crypto/tls/key_agreement.go.html#3940918">ckx</a></span><span class="op" id="3941154">,</span>&nbsp;<span class="ident" id="3941156">nil</span><br>
<span class="lineno"></span><span class="op" id="3941160">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3941163">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="3941226">func</span>&nbsp;<span class="ident" id="3941231">sha1Hash</span><span class="op" id="3941239">(</span><span class="ident" id="3941240">slices</span>&nbsp;<span class="op" id="3941247">[</span><span class="op" id="3941248">]</span><span class="op" id="3941249">[</span><span class="op" id="3941250">]</span><span class="builtintype" id="3941251">byte</span><span class="op" id="3941255">)</span>&nbsp;<span class="op" id="3941257">[</span><span class="op" id="3941258">]</span><span class="builtintype" id="3941259">byte</span>&nbsp;<span class="op" id="3941264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941267">hsha1</span>&nbsp;<span class="op" id="3941273">:=</span>&nbsp;<span class="ident" id="3941276"><a href="/crypto/tls/key_agreement.go.html#3938343">sha1</a></span><span class="op" id="3941280">.</span><span class="ident" id="3941281">New</span><span class="op" id="3941284">(</span><span class="op" id="3941285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941288">for</span>&nbsp;<span class="ident" id="3941292">_</span><span class="op" id="3941293">,</span>&nbsp;<span class="ident" id="3941295">slice</span>&nbsp;<span class="op" id="3941301">:=</span>&nbsp;<span class="keyword" id="3941304">range</span>&nbsp;<span class="ident" id="3941310"><a href="/crypto/tls/key_agreement.go.html#3941240">slices</a></span>&nbsp;<span class="op" id="3941317">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941321"><a href="/crypto/tls/key_agreement.go.html#3941267">hsha1</a></span><span class="op" id="3941326">.</span><span class="ident" id="3941327">Write</span><span class="op" id="3941332">(</span><span class="ident" id="3941333"><a href="/crypto/tls/key_agreement.go.html#3941295">slice</a></span><span class="op" id="3941338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941344">return</span>&nbsp;<span class="ident" id="3941351"><a href="/crypto/tls/key_agreement.go.html#3941267">hsha1</a></span><span class="op" id="3941356">.</span><span class="ident" id="3941357">Sum</span><span class="op" id="3941360">(</span><span class="ident" id="3941361">nil</span><span class="op" id="3941364">)</span><br>
<span class="lineno"></span><span class="op" id="3941366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="3941369">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3941448">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="3941490">func</span>&nbsp;<span class="ident" id="3941495">md5SHA1Hash</span><span class="op" id="3941506">(</span><span class="ident" id="3941507">slices</span>&nbsp;<span class="op" id="3941514">[</span><span class="op" id="3941515">]</span><span class="op" id="3941516">[</span><span class="op" id="3941517">]</span><span class="builtintype" id="3941518">byte</span><span class="op" id="3941522">)</span>&nbsp;<span class="op" id="3941524">[</span><span class="op" id="3941525">]</span><span class="builtintype" id="3941526">byte</span>&nbsp;<span class="op" id="3941531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941534">md5sha1</span>&nbsp;<span class="op" id="3941542">:=</span>&nbsp;<span class="builtinfunc" id="3941545">make</span><span class="op" id="3941549">(</span><span class="op" id="3941550">[</span><span class="op" id="3941551">]</span><span class="builtintype" id="3941552">byte</span><span class="op" id="3941556">,</span>&nbsp;<span class="ident" id="3941558"><a href="/crypto/tls/key_agreement.go.html#3938315">md5</a></span><span class="op" id="3941561">.</span><span class="ident" id="3941562">Size</span><span class="op" id="3941566">+</span><span class="ident" id="3941567"><a href="/crypto/tls/key_agreement.go.html#3938343">sha1</a></span><span class="op" id="3941571">.</span><span class="ident" id="3941572">Size</span><span class="op" id="3941576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941579">hmd5</span>&nbsp;<span class="op" id="3941584">:=</span>&nbsp;<span class="ident" id="3941587"><a href="/crypto/tls/key_agreement.go.html#3938315">md5</a></span><span class="op" id="3941590">.</span><span class="ident" id="3941591">New</span><span class="op" id="3941594">(</span><span class="op" id="3941595">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941598">for</span>&nbsp;<span class="ident" id="3941602">_</span><span class="op" id="3941603">,</span>&nbsp;<span class="ident" id="3941605">slice</span>&nbsp;<span class="op" id="3941611">:=</span>&nbsp;<span class="keyword" id="3941614">range</span>&nbsp;<span class="ident" id="3941620"><a href="/crypto/tls/key_agreement.go.html#3941507">slices</a></span>&nbsp;<span class="op" id="3941627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941631"><a href="/crypto/tls/key_agreement.go.html#3941579">hmd5</a></span><span class="op" id="3941635">.</span><span class="ident" id="3941636">Write</span><span class="op" id="3941641">(</span><span class="ident" id="3941642"><a href="/crypto/tls/key_agreement.go.html#3941605">slice</a></span><span class="op" id="3941647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3941653">copy</span><span class="op" id="3941657">(</span><span class="ident" id="3941658"><a href="/crypto/tls/key_agreement.go.html#3941534">md5sha1</a></span><span class="op" id="3941665">,</span>&nbsp;<span class="ident" id="3941667"><a href="/crypto/tls/key_agreement.go.html#3941579">hmd5</a></span><span class="op" id="3941671">.</span><span class="ident" id="3941672">Sum</span><span class="op" id="3941675">(</span><span class="ident" id="3941676">nil</span><span class="op" id="3941679">)</span><span class="op" id="3941680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3941683">copy</span><span class="op" id="3941687">(</span><span class="ident" id="3941688"><a href="/crypto/tls/key_agreement.go.html#3941534">md5sha1</a></span><span class="op" id="3941695">[</span><span class="ident" id="3941696"><a href="/crypto/tls/key_agreement.go.html#3938315">md5</a></span><span class="op" id="3941699">.</span><span class="ident" id="3941700">Size</span><span class="op" id="3941704">:</span><span class="op" id="3941705">]</span><span class="op" id="3941706">,</span>&nbsp;<span class="ident" id="3941708"><a href="/crypto/tls/key_agreement.go.html#3941231">sha1Hash</a></span><span class="op" id="3941716">(</span><span class="ident" id="3941717"><a href="/crypto/tls/key_agreement.go.html#3941507">slices</a></span><span class="op" id="3941723">)</span><span class="op" id="3941724">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941727">return</span>&nbsp;<span class="ident" id="3941734"><a href="/crypto/tls/key_agreement.go.html#3941534">md5sha1</a></span><br>
<span class="lineno"></span><span class="op" id="3941742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3941745">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3941795">func</span>&nbsp;<span class="ident" id="3941800">sha256Hash</span><span class="op" id="3941810">(</span><span class="ident" id="3941811">slices</span>&nbsp;<span class="op" id="3941818">[</span><span class="op" id="3941819">]</span><span class="op" id="3941820">[</span><span class="op" id="3941821">]</span><span class="builtintype" id="3941822">byte</span><span class="op" id="3941826">)</span>&nbsp;<span class="op" id="3941828">[</span><span class="op" id="3941829">]</span><span class="builtintype" id="3941830">byte</span>&nbsp;<span class="op" id="3941835">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941838">h</span>&nbsp;<span class="op" id="3941840">:=</span>&nbsp;<span class="ident" id="3941843"><a href="/crypto/tls/key_agreement.go.html#3938358">sha256</a></span><span class="op" id="3941849">.</span><span class="ident" id="3941850">New</span><span class="op" id="3941853">(</span><span class="op" id="3941854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941857">for</span>&nbsp;<span class="ident" id="3941861">_</span><span class="op" id="3941862">,</span>&nbsp;<span class="ident" id="3941864">slice</span>&nbsp;<span class="op" id="3941870">:=</span>&nbsp;<span class="keyword" id="3941873">range</span>&nbsp;<span class="ident" id="3941879"><a href="/crypto/tls/key_agreement.go.html#3941811">slices</a></span>&nbsp;<span class="op" id="3941886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941890"><a href="/crypto/tls/key_agreement.go.html#3941838">h</a></span><span class="op" id="3941891">.</span><span class="ident" id="3941892">Write</span><span class="op" id="3941897">(</span><span class="ident" id="3941898"><a href="/crypto/tls/key_agreement.go.html#3941864">slice</a></span><span class="op" id="3941903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941909">return</span>&nbsp;<span class="ident" id="3941916"><a href="/crypto/tls/key_agreement.go.html#3941838">h</a></span><span class="op" id="3941917">.</span><span class="ident" id="3941918">Sum</span><span class="op" id="3941921">(</span><span class="ident" id="3941922">nil</span><span class="op" id="3941925">)</span><br>
<span class="lineno">120</span><span class="op" id="3941927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3941930">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="3942007">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3942086">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="3942160">func</span>&nbsp;<span class="ident" id="3942165">hashForServerKeyExchange</span><span class="op" id="3942189">(</span><span class="ident" id="3942190">sigType</span><span class="op" id="3942197">,</span>&nbsp;<span class="ident" id="3942199">hashFunc</span>&nbsp;<span class="builtintype" id="3942208">uint8</span><span class="op" id="3942213">,</span>&nbsp;<span class="ident" id="3942215">version</span>&nbsp;<span class="builtintype" id="3942223">uint16</span><span class="op" id="3942229">,</span>&nbsp;<span class="ident" id="3942231">slices</span>&nbsp;<span class="op" id="3942238">...</span><span class="op" id="3942241">[</span><span class="op" id="3942242">]</span><span class="builtintype" id="3942243">byte</span><span class="op" id="3942247">)</span>&nbsp;<span class="op" id="3942249">(</span><span class="op" id="3942250">[</span><span class="op" id="3942251">]</span><span class="builtintype" id="3942252">byte</span><span class="op" id="3942256">,</span>&nbsp;<span class="ident" id="3942258"><a href="/crypto/tls/key_agreement.go.html#3938270">crypto</a></span><span class="op" id="3942264">.</span><span class="ident" id="3942265">Hash</span><span class="op" id="3942269">,</span>&nbsp;<span class="builtintype" id="3942271">error</span><span class="op" id="3942276">)</span>&nbsp;<span class="op" id="3942278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942281">if</span>&nbsp;<span class="ident" id="3942284"><a href="/crypto/tls/key_agreement.go.html#3942215">version</a></span>&nbsp;<span class="op" id="3942292">&gt;=</span>&nbsp;<span class="ident" id="3942295"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3942308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942312">switch</span>&nbsp;<span class="ident" id="3942319"><a href="/crypto/tls/key_agreement.go.html#3942199">hashFunc</a></span>&nbsp;<span class="op" id="3942328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942332">case</span>&nbsp;<span class="ident" id="3942337"><a href="/crypto/tls/common.go.html#3825825">hashSHA256</a></span><span class="op" id="3942347">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942352">return</span>&nbsp;<span class="ident" id="3942359"><a href="/crypto/tls/key_agreement.go.html#3941800">sha256Hash</a></span><span class="op" id="3942369">(</span><span class="ident" id="3942370"><a href="/crypto/tls/key_agreement.go.html#3942231">slices</a></span><span class="op" id="3942376">)</span><span class="op" id="3942377">,</span>&nbsp;<span class="ident" id="3942379"><a href="/crypto/tls/key_agreement.go.html#3938270">crypto</a></span><span class="op" id="3942385">.</span><span class="ident" id="3942386">SHA256</span><span class="op" id="3942392">,</span>&nbsp;<span class="ident" id="3942394">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942400">case</span>&nbsp;<span class="ident" id="3942405"><a href="/crypto/tls/common.go.html#3825803">hashSHA1</a></span><span class="op" id="3942413">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942418">return</span>&nbsp;<span class="ident" id="3942425"><a href="/crypto/tls/key_agreement.go.html#3941231">sha1Hash</a></span><span class="op" id="3942433">(</span><span class="ident" id="3942434"><a href="/crypto/tls/key_agreement.go.html#3942231">slices</a></span><span class="op" id="3942440">)</span><span class="op" id="3942441">,</span>&nbsp;<span class="ident" id="3942443"><a href="/crypto/tls/key_agreement.go.html#3938270">crypto</a></span><span class="op" id="3942449">.</span><span class="ident" id="3942450">SHA1</span><span class="op" id="3942454">,</span>&nbsp;<span class="ident" id="3942456">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942462">default</span><span class="op" id="3942469">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942474">return</span>&nbsp;<span class="ident" id="3942481">nil</span><span class="op" id="3942484">,</span>&nbsp;<span class="ident" id="3942486"><a href="/crypto/tls/key_agreement.go.html#3938270">crypto</a></span><span class="op" id="3942492">.</span><span class="ident" id="3942493">Hash</span><span class="op" id="3942497">(</span><span class="num" id="3942498">0</span><span class="op" id="3942499">)</span><span class="op" id="3942500">,</span>&nbsp;<span class="ident" id="3942502"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3942508">.</span><span class="ident" id="3942509">New</span><span class="op" id="3942512">(</span><span class="string" id="3942513">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="3942554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3942558">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3942561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942564">if</span>&nbsp;<span class="ident" id="3942567"><a href="/crypto/tls/key_agreement.go.html#3942190">sigType</a></span>&nbsp;<span class="op" id="3942575">==</span>&nbsp;<span class="ident" id="3942578"><a href="/crypto/tls/common.go.html#3825950">signatureECDSA</a></span>&nbsp;<span class="op" id="3942593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942597">return</span>&nbsp;<span class="ident" id="3942604"><a href="/crypto/tls/key_agreement.go.html#3941231">sha1Hash</a></span><span class="op" id="3942612">(</span><span class="ident" id="3942613"><a href="/crypto/tls/key_agreement.go.html#3942231">slices</a></span><span class="op" id="3942619">)</span><span class="op" id="3942620">,</span>&nbsp;<span class="ident" id="3942622"><a href="/crypto/tls/key_agreement.go.html#3938270">crypto</a></span><span class="op" id="3942628">.</span><span class="ident" id="3942629">SHA1</span><span class="op" id="3942633">,</span>&nbsp;<span class="ident" id="3942635">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3942640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942643">return</span>&nbsp;<span class="ident" id="3942650"><a href="/crypto/tls/key_agreement.go.html#3941495">md5SHA1Hash</a></span><span class="op" id="3942661">(</span><span class="ident" id="3942662"><a href="/crypto/tls/key_agreement.go.html#3942231">slices</a></span><span class="op" id="3942668">)</span><span class="op" id="3942669">,</span>&nbsp;<span class="ident" id="3942671"><a href="/crypto/tls/key_agreement.go.html#3938270">crypto</a></span><span class="op" id="3942677">.</span><span class="ident" id="3942678">MD5SHA1</span><span class="op" id="3942685">,</span>&nbsp;<span class="ident" id="3942687">nil</span><br>
<span class="lineno">140</span><span class="op" id="3942691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3942694">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3942771">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3942845">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="3942910">func</span>&nbsp;<span class="ident" id="3942915">pickTLS12HashForSignature</span><span class="op" id="3942940">(</span><span class="ident" id="3942941">sigType</span>&nbsp;<span class="builtintype" id="3942949">uint8</span><span class="op" id="3942954">,</span>&nbsp;<span class="ident" id="3942956">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3942981">[</span><span class="op" id="3942982">]</span><span class="ident" id="3942983"><a href="/crypto/tls/common.go.html#3826090">signatureAndHash</a></span><span class="op" id="3942999">)</span>&nbsp;<span class="op" id="3943001">(</span><span class="builtintype" id="3943002">uint8</span><span class="op" id="3943007">,</span>&nbsp;<span class="builtintype" id="3943009">error</span><span class="op" id="3943014">)</span>&nbsp;<span class="op" id="3943016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943019">if</span>&nbsp;<span class="builtinfunc" id="3943022">len</span><span class="op" id="3943025">(</span><span class="ident" id="3943026"><a href="/crypto/tls/key_agreement.go.html#3942956">clientSignatureAndHashes</a></span><span class="op" id="3943050">)</span>&nbsp;<span class="op" id="3943052">==</span>&nbsp;<span class="num" id="3943055">0</span>&nbsp;<span class="op" id="3943057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3943061">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3943120">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3943181">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943239">return</span>&nbsp;<span class="ident" id="3943246"><a href="/crypto/tls/common.go.html#3825803">hashSHA1</a></span><span class="op" id="3943254">,</span>&nbsp;<span class="ident" id="3943256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943265">for</span>&nbsp;<span class="ident" id="3943269">_</span><span class="op" id="3943270">,</span>&nbsp;<span class="ident" id="3943272">sigAndHash</span>&nbsp;<span class="op" id="3943283">:=</span>&nbsp;<span class="keyword" id="3943286">range</span>&nbsp;<span class="ident" id="3943292"><a href="/crypto/tls/key_agreement.go.html#3942956">clientSignatureAndHashes</a></span>&nbsp;<span class="op" id="3943317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943321">if</span>&nbsp;<span class="ident" id="3943324"><a href="/crypto/tls/key_agreement.go.html#3943272">sigAndHash</a></span><span class="op" id="3943334">.</span><span class="ident" id="3943335">signature</span>&nbsp;<span class="op" id="3943345">!=</span>&nbsp;<span class="ident" id="3943348"><a href="/crypto/tls/key_agreement.go.html#3942941">sigType</a></span>&nbsp;<span class="op" id="3943356">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943361">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943376">switch</span>&nbsp;<span class="ident" id="3943383"><a href="/crypto/tls/key_agreement.go.html#3943272">sigAndHash</a></span><span class="op" id="3943393">.</span><span class="ident" id="3943394">hash</span>&nbsp;<span class="op" id="3943399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943403">case</span>&nbsp;<span class="ident" id="3943408"><a href="/crypto/tls/common.go.html#3825803">hashSHA1</a></span><span class="op" id="3943416">,</span>&nbsp;<span class="ident" id="3943418"><a href="/crypto/tls/common.go.html#3825825">hashSHA256</a></span><span class="op" id="3943428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943433">return</span>&nbsp;<span class="ident" id="3943440"><a href="/crypto/tls/key_agreement.go.html#3943272">sigAndHash</a></span><span class="op" id="3943450">.</span><span class="ident" id="3943451">hash</span><span class="op" id="3943455">,</span>&nbsp;<span class="ident" id="3943457">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943470">return</span>&nbsp;<span class="num" id="3943477">0</span><span class="op" id="3943478">,</span>&nbsp;<span class="ident" id="3943480"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3943486">.</span><span class="ident" id="3943487">New</span><span class="op" id="3943490">(</span><span class="string" id="3943491">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="3943546">)</span><br>
<span class="lineno"></span><span class="op" id="3943548">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3943551">func</span>&nbsp;<span class="ident" id="3943556">curveForCurveID</span><span class="op" id="3943571">(</span><span class="ident" id="3943572">id</span>&nbsp;<span class="ident" id="3943575"><a href="/crypto/tls/common.go.html#3824673">CurveID</a></span><span class="op" id="3943582">)</span>&nbsp;<span class="op" id="3943584">(</span><span class="ident" id="3943585"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3943593">.</span><span class="ident" id="3943594">Curve</span><span class="op" id="3943599">,</span>&nbsp;<span class="builtintype" id="3943601">bool</span><span class="op" id="3943605">)</span>&nbsp;<span class="op" id="3943607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943610">switch</span>&nbsp;<span class="ident" id="3943617"><a href="/crypto/tls/key_agreement.go.html#3943572">id</a></span>&nbsp;<span class="op" id="3943620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943623">case</span>&nbsp;<span class="ident" id="3943628"><a href="/crypto/tls/common.go.html#3824698">CurveP256</a></span><span class="op" id="3943637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943641">return</span>&nbsp;<span class="ident" id="3943648"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3943656">.</span><span class="ident" id="3943657">P256</span><span class="op" id="3943661">(</span><span class="op" id="3943662">)</span><span class="op" id="3943663">,</span>&nbsp;<span class="builtintype" id="3943665">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943671">case</span>&nbsp;<span class="ident" id="3943676"><a href="/crypto/tls/common.go.html#3824722">CurveP384</a></span><span class="op" id="3943685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943689">return</span>&nbsp;<span class="ident" id="3943696"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3943704">.</span><span class="ident" id="3943705">P384</span><span class="op" id="3943709">(</span><span class="op" id="3943710">)</span><span class="op" id="3943711">,</span>&nbsp;<span class="builtintype" id="3943713">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943719">case</span>&nbsp;<span class="ident" id="3943724"><a href="/crypto/tls/common.go.html#3824746">CurveP521</a></span><span class="op" id="3943733">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943737">return</span>&nbsp;<span class="ident" id="3943744"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3943752">.</span><span class="ident" id="3943753">P521</span><span class="op" id="3943757">(</span><span class="op" id="3943758">)</span><span class="op" id="3943759">,</span>&nbsp;<span class="builtintype" id="3943761">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943767">default</span><span class="op" id="3943774">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943778">return</span>&nbsp;<span class="ident" id="3943785">nil</span><span class="op" id="3943788">,</span>&nbsp;<span class="builtintype" id="3943790">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3943800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3943803">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3943875">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3943945">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="3944015">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="3944042">type</span>&nbsp;<span class="ident" id="3944047">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="3944065">struct</span>&nbsp;<span class="op" id="3944072">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944075">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3944086">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944094">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3944105">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944112">privateKey</span>&nbsp;<span class="op" id="3944123">[</span><span class="op" id="3944124">]</span><span class="builtintype" id="3944125">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944131">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3944142"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3944150">.</span><span class="ident" id="3944151">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944158">x</span><span class="op" id="3944159">,</span>&nbsp;<span class="ident" id="3944161">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3944169">*</span><span class="ident" id="3944170"><a href="/crypto/tls/key_agreement.go.html#3938423">big</a></span><span class="op" id="3944173">.</span><span class="ident" id="3944174">Int</span><br>
<span class="lineno">190</span><span class="op" id="3944178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3944181">func</span>&nbsp;<span class="op" id="3944186">(</span><span class="ident" id="3944187">ka</span>&nbsp;<span class="op" id="3944190">*</span><span class="ident" id="3944191"><a href="/crypto/tls/key_agreement.go.html#3944047">ecdheKeyAgreement</a></span><span class="op" id="3944208">)</span>&nbsp;<span class="ident" id="3944210">generateServerKeyExchange</span><span class="op" id="3944235">(</span><span class="ident" id="3944236">config</span>&nbsp;<span class="op" id="3944243">*</span><span class="ident" id="3944244"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3944250">,</span>&nbsp;<span class="ident" id="3944252">cert</span>&nbsp;<span class="op" id="3944257">*</span><span class="ident" id="3944258"><a href="/crypto/tls/common.go.html#3838319">Certificate</a></span><span class="op" id="3944269">,</span>&nbsp;<span class="ident" id="3944271">clientHello</span>&nbsp;<span class="op" id="3944283">*</span><span class="ident" id="3944284"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3944298">,</span>&nbsp;<span class="ident" id="3944300">hello</span>&nbsp;<span class="op" id="3944306">*</span><span class="ident" id="3944307"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><span class="op" id="3944321">)</span>&nbsp;<span class="op" id="3944323">(</span><span class="op" id="3944324">*</span><span class="ident" id="3944325"><a href="/crypto/tls/handshake_messages.go.html#3906795">serverKeyExchangeMsg</a></span><span class="op" id="3944345">,</span>&nbsp;<span class="builtintype" id="3944347">error</span><span class="op" id="3944352">)</span>&nbsp;<span class="op" id="3944354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944357">var</span>&nbsp;<span class="ident" id="3944361">curveid</span>&nbsp;<span class="ident" id="3944369"><a href="/crypto/tls/common.go.html#3824673">CurveID</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944378">preferredCurves</span>&nbsp;<span class="op" id="3944394">:=</span>&nbsp;<span class="ident" id="3944397"><a href="/crypto/tls/key_agreement.go.html#3944236">config</a></span><span class="op" id="3944403">.</span><span class="ident" id="3944404">curvePreferences</span><span class="op" id="3944420">(</span><span class="op" id="3944421">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="3944424">NextCandidate</span><span class="op" id="3944437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944440">for</span>&nbsp;<span class="ident" id="3944444">_</span><span class="op" id="3944445">,</span>&nbsp;<span class="ident" id="3944447">candidate</span>&nbsp;<span class="op" id="3944457">:=</span>&nbsp;<span class="keyword" id="3944460">range</span>&nbsp;<span class="ident" id="3944466"><a href="/crypto/tls/key_agreement.go.html#3944378">preferredCurves</a></span>&nbsp;<span class="op" id="3944482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944486">for</span>&nbsp;<span class="ident" id="3944490">_</span><span class="op" id="3944491">,</span>&nbsp;<span class="ident" id="3944493">c</span>&nbsp;<span class="op" id="3944495">:=</span>&nbsp;<span class="keyword" id="3944498">range</span>&nbsp;<span class="ident" id="3944504"><a href="/crypto/tls/key_agreement.go.html#3944271">clientHello</a></span><span class="op" id="3944515">.</span><span class="ident" id="3944516">supportedCurves</span>&nbsp;<span class="op" id="3944532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944537">if</span>&nbsp;<span class="ident" id="3944540"><a href="/crypto/tls/key_agreement.go.html#3944447">candidate</a></span>&nbsp;<span class="op" id="3944550">==</span>&nbsp;<span class="ident" id="3944553"><a href="/crypto/tls/key_agreement.go.html#3944493">c</a></span>&nbsp;<span class="op" id="3944555">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944561"><a href="/crypto/tls/key_agreement.go.html#3944361">curveid</a></span>&nbsp;<span class="op" id="3944569">=</span>&nbsp;<span class="ident" id="3944571"><a href="/crypto/tls/key_agreement.go.html#3944493">c</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944577">break</span>&nbsp;<span class="ident" id="3944583">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944607">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944611">if</span>&nbsp;<span class="ident" id="3944614"><a href="/crypto/tls/key_agreement.go.html#3944361">curveid</a></span>&nbsp;<span class="op" id="3944622">==</span>&nbsp;<span class="num" id="3944625">0</span>&nbsp;<span class="op" id="3944627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944631">return</span>&nbsp;<span class="ident" id="3944638">nil</span><span class="op" id="3944641">,</span>&nbsp;<span class="ident" id="3944643"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3944649">.</span><span class="ident" id="3944650">New</span><span class="op" id="3944653">(</span><span class="string" id="3944654">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="3944697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944704">var</span>&nbsp;<span class="ident" id="3944708">ok</span>&nbsp;<span class="builtintype" id="3944711">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944717">if</span>&nbsp;<span class="ident" id="3944720"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3944722">.</span><span class="ident" id="3944723">curve</span><span class="op" id="3944728">,</span>&nbsp;<span class="ident" id="3944730"><a href="/crypto/tls/key_agreement.go.html#3944708">ok</a></span>&nbsp;<span class="op" id="3944733">=</span>&nbsp;<span class="ident" id="3944735"><a href="/crypto/tls/key_agreement.go.html#3943556">curveForCurveID</a></span><span class="op" id="3944750">(</span><span class="ident" id="3944751"><a href="/crypto/tls/key_agreement.go.html#3944361">curveid</a></span><span class="op" id="3944758">)</span><span class="op" id="3944759">;</span>&nbsp;<span class="op" id="3944761">!</span><span class="ident" id="3944762"><a href="/crypto/tls/key_agreement.go.html#3944708">ok</a></span>&nbsp;<span class="op" id="3944765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944769">return</span>&nbsp;<span class="ident" id="3944776">nil</span><span class="op" id="3944779">,</span>&nbsp;<span class="ident" id="3944781"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3944787">.</span><span class="ident" id="3944788">New</span><span class="op" id="3944791">(</span><span class="string" id="3944792">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3944841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944848">var</span>&nbsp;<span class="ident" id="3944852">x</span><span class="op" id="3944853">,</span>&nbsp;<span class="ident" id="3944855">y</span>&nbsp;<span class="op" id="3944857">*</span><span class="ident" id="3944858"><a href="/crypto/tls/key_agreement.go.html#3938423">big</a></span><span class="op" id="3944861">.</span><span class="ident" id="3944862">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944867">var</span>&nbsp;<span class="ident" id="3944871">err</span>&nbsp;<span class="builtintype" id="3944875">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944882"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3944884">.</span><span class="ident" id="3944885">privateKey</span><span class="op" id="3944895">,</span>&nbsp;<span class="ident" id="3944897"><a href="/crypto/tls/key_agreement.go.html#3944852">x</a></span><span class="op" id="3944898">,</span>&nbsp;<span class="ident" id="3944900"><a href="/crypto/tls/key_agreement.go.html#3944855">y</a></span><span class="op" id="3944901">,</span>&nbsp;<span class="ident" id="3944903"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3944907">=</span>&nbsp;<span class="ident" id="3944909"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3944917">.</span><span class="ident" id="3944918">GenerateKey</span><span class="op" id="3944929">(</span><span class="ident" id="3944930"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3944932">.</span><span class="ident" id="3944933">curve</span><span class="op" id="3944938">,</span>&nbsp;<span class="ident" id="3944940"><a href="/crypto/tls/key_agreement.go.html#3944236">config</a></span><span class="op" id="3944946">.</span><span class="ident" id="3944947">rand</span><span class="op" id="3944951">(</span><span class="op" id="3944952">)</span><span class="op" id="3944953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944956">if</span>&nbsp;<span class="ident" id="3944959"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3944963">!=</span>&nbsp;<span class="ident" id="3944966">nil</span>&nbsp;<span class="op" id="3944970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944974">return</span>&nbsp;<span class="ident" id="3944981">nil</span><span class="op" id="3944984">,</span>&nbsp;<span class="ident" id="3944986"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944994">ecdhePublic</span>&nbsp;<span class="op" id="3945006">:=</span>&nbsp;<span class="ident" id="3945009"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3945017">.</span><span class="ident" id="3945018">Marshal</span><span class="op" id="3945025">(</span><span class="ident" id="3945026"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3945028">.</span><span class="ident" id="3945029">curve</span><span class="op" id="3945034">,</span>&nbsp;<span class="ident" id="3945036"><a href="/crypto/tls/key_agreement.go.html#3944852">x</a></span><span class="op" id="3945037">,</span>&nbsp;<span class="ident" id="3945039"><a href="/crypto/tls/key_agreement.go.html#3944855">y</a></span><span class="op" id="3945040">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3945044">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945095">serverECDHParams</span>&nbsp;<span class="op" id="3945112">:=</span>&nbsp;<span class="builtinfunc" id="3945115">make</span><span class="op" id="3945119">(</span><span class="op" id="3945120">[</span><span class="op" id="3945121">]</span><span class="builtintype" id="3945122">byte</span><span class="op" id="3945126">,</span>&nbsp;<span class="num" id="3945128">1</span><span class="op" id="3945129">+</span><span class="num" id="3945130">2</span><span class="op" id="3945131">+</span><span class="num" id="3945132">1</span><span class="op" id="3945133">+</span><span class="builtinfunc" id="3945134">len</span><span class="op" id="3945137">(</span><span class="ident" id="3945138"><a href="/crypto/tls/key_agreement.go.html#3944994">ecdhePublic</a></span><span class="op" id="3945149">)</span><span class="op" id="3945150">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945153"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3945169">[</span><span class="num" id="3945170">0</span><span class="op" id="3945171">]</span>&nbsp;<span class="op" id="3945173">=</span>&nbsp;<span class="num" id="3945175">3</span>&nbsp;<span class="comment" id="3945177">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945193"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3945209">[</span><span class="num" id="3945210">1</span><span class="op" id="3945211">]</span>&nbsp;<span class="op" id="3945213">=</span>&nbsp;<span class="builtintype" id="3945215">byte</span><span class="op" id="3945219">(</span><span class="ident" id="3945220"><a href="/crypto/tls/key_agreement.go.html#3944361">curveid</a></span>&nbsp;<span class="op" id="3945228">&gt;&gt;</span>&nbsp;<span class="num" id="3945231">8</span><span class="op" id="3945232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945235"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3945251">[</span><span class="num" id="3945252">2</span><span class="op" id="3945253">]</span>&nbsp;<span class="op" id="3945255">=</span>&nbsp;<span class="builtintype" id="3945257">byte</span><span class="op" id="3945261">(</span><span class="ident" id="3945262"><a href="/crypto/tls/key_agreement.go.html#3944361">curveid</a></span><span class="op" id="3945269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945272"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3945288">[</span><span class="num" id="3945289">3</span><span class="op" id="3945290">]</span>&nbsp;<span class="op" id="3945292">=</span>&nbsp;<span class="builtintype" id="3945294">byte</span><span class="op" id="3945298">(</span><span class="builtinfunc" id="3945299">len</span><span class="op" id="3945302">(</span><span class="ident" id="3945303"><a href="/crypto/tls/key_agreement.go.html#3944994">ecdhePublic</a></span><span class="op" id="3945314">)</span><span class="op" id="3945315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3945318">copy</span><span class="op" id="3945322">(</span><span class="ident" id="3945323"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3945339">[</span><span class="num" id="3945340">4</span><span class="op" id="3945341">:</span><span class="op" id="3945342">]</span><span class="op" id="3945343">,</span>&nbsp;<span class="ident" id="3945345"><a href="/crypto/tls/key_agreement.go.html#3944994">ecdhePublic</a></span><span class="op" id="3945356">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945360">var</span>&nbsp;<span class="ident" id="3945364">tls12HashId</span>&nbsp;<span class="builtintype" id="3945376">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945383">if</span>&nbsp;<span class="ident" id="3945386"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3945388">.</span><span class="ident" id="3945389">version</span>&nbsp;<span class="op" id="3945397">&gt;=</span>&nbsp;<span class="ident" id="3945400"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3945413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945417">if</span>&nbsp;<span class="ident" id="3945420"><a href="/crypto/tls/key_agreement.go.html#3945364">tls12HashId</a></span><span class="op" id="3945431">,</span>&nbsp;<span class="ident" id="3945433"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3945437">=</span>&nbsp;<span class="ident" id="3945439"><a href="/crypto/tls/key_agreement.go.html#3942915">pickTLS12HashForSignature</a></span><span class="op" id="3945464">(</span><span class="ident" id="3945465"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3945467">.</span><span class="ident" id="3945468">sigType</span><span class="op" id="3945475">,</span>&nbsp;<span class="ident" id="3945477"><a href="/crypto/tls/key_agreement.go.html#3944271">clientHello</a></span><span class="op" id="3945488">.</span><span class="ident" id="3945489">signatureAndHashes</span><span class="op" id="3945507">)</span><span class="op" id="3945508">;</span>&nbsp;<span class="ident" id="3945510"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3945514">!=</span>&nbsp;<span class="ident" id="3945517">nil</span>&nbsp;<span class="op" id="3945521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945526">return</span>&nbsp;<span class="ident" id="3945533">nil</span><span class="op" id="3945536">,</span>&nbsp;<span class="ident" id="3945538"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945551">digest</span><span class="op" id="3945557">,</span>&nbsp;<span class="ident" id="3945559">hashFunc</span><span class="op" id="3945567">,</span>&nbsp;<span class="ident" id="3945569"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3945573">:=</span>&nbsp;<span class="ident" id="3945576"><a href="/crypto/tls/key_agreement.go.html#3942165">hashForServerKeyExchange</a></span><span class="op" id="3945600">(</span><span class="ident" id="3945601"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3945603">.</span><span class="ident" id="3945604">sigType</span><span class="op" id="3945611">,</span>&nbsp;<span class="ident" id="3945613"><a href="/crypto/tls/key_agreement.go.html#3945364">tls12HashId</a></span><span class="op" id="3945624">,</span>&nbsp;<span class="ident" id="3945626"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3945628">.</span><span class="ident" id="3945629">version</span><span class="op" id="3945636">,</span>&nbsp;<span class="ident" id="3945638"><a href="/crypto/tls/key_agreement.go.html#3944271">clientHello</a></span><span class="op" id="3945649">.</span><span class="ident" id="3945650">random</span><span class="op" id="3945656">,</span>&nbsp;<span class="ident" id="3945658"><a href="/crypto/tls/key_agreement.go.html#3944300">hello</a></span><span class="op" id="3945663">.</span><span class="ident" id="3945664">random</span><span class="op" id="3945670">,</span>&nbsp;<span class="ident" id="3945672"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3945688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945691">if</span>&nbsp;<span class="ident" id="3945694"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3945698">!=</span>&nbsp;<span class="ident" id="3945701">nil</span>&nbsp;<span class="op" id="3945705">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945709">return</span>&nbsp;<span class="ident" id="3945716">nil</span><span class="op" id="3945719">,</span>&nbsp;<span class="ident" id="3945721"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945729">var</span>&nbsp;<span class="ident" id="3945733">sig</span>&nbsp;<span class="op" id="3945737">[</span><span class="op" id="3945738">]</span><span class="builtintype" id="3945739">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945745">switch</span>&nbsp;<span class="ident" id="3945752"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3945754">.</span><span class="ident" id="3945755">sigType</span>&nbsp;<span class="op" id="3945763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945766">case</span>&nbsp;<span class="ident" id="3945771"><a href="/crypto/tls/common.go.html#3825950">signatureECDSA</a></span><span class="op" id="3945785">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945789">privKey</span><span class="op" id="3945796">,</span>&nbsp;<span class="ident" id="3945798">ok</span>&nbsp;<span class="op" id="3945801">:=</span>&nbsp;<span class="ident" id="3945804"><a href="/crypto/tls/key_agreement.go.html#3944252">cert</a></span><span class="op" id="3945808">.</span><span class="ident" id="3945809">PrivateKey</span><span class="op" id="3945819">.</span><span class="op" id="3945820">(</span><span class="op" id="3945821">*</span><span class="ident" id="3945822"><a href="/crypto/tls/key_agreement.go.html#3938280">ecdsa</a></span><span class="op" id="3945827">.</span><span class="ident" id="3945828">PrivateKey</span><span class="op" id="3945838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945842">if</span>&nbsp;<span class="op" id="3945845">!</span><span class="ident" id="3945846"><a href="/crypto/tls/key_agreement.go.html#3945798">ok</a></span>&nbsp;<span class="op" id="3945849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945854">return</span>&nbsp;<span class="ident" id="3945861">nil</span><span class="op" id="3945864">,</span>&nbsp;<span class="ident" id="3945866"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3945872">.</span><span class="ident" id="3945873">New</span><span class="op" id="3945876">(</span><span class="string" id="3945877">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3945927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945935">r</span><span class="op" id="3945936">,</span>&nbsp;<span class="ident" id="3945938">s</span><span class="op" id="3945939">,</span>&nbsp;<span class="ident" id="3945941">err</span>&nbsp;<span class="op" id="3945945">:=</span>&nbsp;<span class="ident" id="3945948"><a href="/crypto/tls/key_agreement.go.html#3938280">ecdsa</a></span><span class="op" id="3945953">.</span><span class="ident" id="3945954">Sign</span><span class="op" id="3945958">(</span><span class="ident" id="3945959"><a href="/crypto/tls/key_agreement.go.html#3944236">config</a></span><span class="op" id="3945965">.</span><span class="ident" id="3945966">rand</span><span class="op" id="3945970">(</span><span class="op" id="3945971">)</span><span class="op" id="3945972">,</span>&nbsp;<span class="ident" id="3945974"><a href="/crypto/tls/key_agreement.go.html#3945789">privKey</a></span><span class="op" id="3945981">,</span>&nbsp;<span class="ident" id="3945983"><a href="/crypto/tls/key_agreement.go.html#3945551">digest</a></span><span class="op" id="3945989">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945993">if</span>&nbsp;<span class="ident" id="3945996"><a href="/crypto/tls/key_agreement.go.html#3945941">err</a></span>&nbsp;<span class="op" id="3946000">!=</span>&nbsp;<span class="ident" id="3946003">nil</span>&nbsp;<span class="op" id="3946007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946012">return</span>&nbsp;<span class="ident" id="3946019">nil</span><span class="op" id="3946022">,</span>&nbsp;<span class="ident" id="3946024"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3946030">.</span><span class="ident" id="3946031">New</span><span class="op" id="3946034">(</span><span class="string" id="3946035">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3946071">+</span>&nbsp;<span class="ident" id="3946073"><a href="/crypto/tls/key_agreement.go.html#3945941">err</a></span><span class="op" id="3946076">.</span><span class="ident" id="3946077">Error</span><span class="op" id="3946082">(</span><span class="op" id="3946083">)</span><span class="op" id="3946084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946092"><a href="/crypto/tls/key_agreement.go.html#3945733">sig</a></span><span class="op" id="3946095">,</span>&nbsp;<span class="ident" id="3946097"><a href="/crypto/tls/key_agreement.go.html#3945941">err</a></span>&nbsp;<span class="op" id="3946101">=</span>&nbsp;<span class="ident" id="3946103"><a href="/crypto/tls/key_agreement.go.html#3938390">asn1</a></span><span class="op" id="3946107">.</span><span class="ident" id="3946108">Marshal</span><span class="op" id="3946115">(</span><span class="ident" id="3946116"><a href="/crypto/tls/common.go.html#3841172">ecdsaSignature</a></span><span class="op" id="3946130">{</span><span class="ident" id="3946131"><a href="/crypto/tls/key_agreement.go.html#3945935">r</a></span><span class="op" id="3946132">,</span>&nbsp;<span class="ident" id="3946134"><a href="/crypto/tls/key_agreement.go.html#3945938">s</a></span><span class="op" id="3946135">}</span><span class="op" id="3946136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946139">case</span>&nbsp;<span class="ident" id="3946144"><a href="/crypto/tls/common.go.html#3825924">signatureRSA</a></span><span class="op" id="3946156">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946160">privKey</span><span class="op" id="3946167">,</span>&nbsp;<span class="ident" id="3946169">ok</span>&nbsp;<span class="op" id="3946172">:=</span>&nbsp;<span class="ident" id="3946175"><a href="/crypto/tls/key_agreement.go.html#3944252">cert</a></span><span class="op" id="3946179">.</span><span class="ident" id="3946180">PrivateKey</span><span class="op" id="3946190">.</span><span class="op" id="3946191">(</span><span class="op" id="3946192">*</span><span class="ident" id="3946193"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3946196">.</span><span class="ident" id="3946197">PrivateKey</span><span class="op" id="3946207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946211">if</span>&nbsp;<span class="op" id="3946214">!</span><span class="ident" id="3946215"><a href="/crypto/tls/key_agreement.go.html#3946169">ok</a></span>&nbsp;<span class="op" id="3946218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946223">return</span>&nbsp;<span class="ident" id="3946230">nil</span><span class="op" id="3946233">,</span>&nbsp;<span class="ident" id="3946235"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3946241">.</span><span class="ident" id="3946242">New</span><span class="op" id="3946245">(</span><span class="string" id="3946246">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3946291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946299"><a href="/crypto/tls/key_agreement.go.html#3945733">sig</a></span><span class="op" id="3946302">,</span>&nbsp;<span class="ident" id="3946304"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3946308">=</span>&nbsp;<span class="ident" id="3946310"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3946313">.</span><span class="ident" id="3946314">SignPKCS1v15</span><span class="op" id="3946326">(</span><span class="ident" id="3946327"><a href="/crypto/tls/key_agreement.go.html#3944236">config</a></span><span class="op" id="3946333">.</span><span class="ident" id="3946334">rand</span><span class="op" id="3946338">(</span><span class="op" id="3946339">)</span><span class="op" id="3946340">,</span>&nbsp;<span class="ident" id="3946342"><a href="/crypto/tls/key_agreement.go.html#3946160">privKey</a></span><span class="op" id="3946349">,</span>&nbsp;<span class="ident" id="3946351"><a href="/crypto/tls/key_agreement.go.html#3945559">hashFunc</a></span><span class="op" id="3946359">,</span>&nbsp;<span class="ident" id="3946361"><a href="/crypto/tls/key_agreement.go.html#3945551">digest</a></span><span class="op" id="3946367">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946371">if</span>&nbsp;<span class="ident" id="3946374"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span>&nbsp;<span class="op" id="3946378">!=</span>&nbsp;<span class="ident" id="3946381">nil</span>&nbsp;<span class="op" id="3946385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946390">return</span>&nbsp;<span class="ident" id="3946397">nil</span><span class="op" id="3946400">,</span>&nbsp;<span class="ident" id="3946402"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3946408">.</span><span class="ident" id="3946409">New</span><span class="op" id="3946412">(</span><span class="string" id="3946413">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3946449">+</span>&nbsp;<span class="ident" id="3946451"><a href="/crypto/tls/key_agreement.go.html#3944871">err</a></span><span class="op" id="3946454">.</span><span class="ident" id="3946455">Error</span><span class="op" id="3946460">(</span><span class="op" id="3946461">)</span><span class="op" id="3946462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946469">default</span><span class="op" id="3946476">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946480">return</span>&nbsp;<span class="ident" id="3946487">nil</span><span class="op" id="3946490">,</span>&nbsp;<span class="ident" id="3946492"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3946498">.</span><span class="ident" id="3946499">New</span><span class="op" id="3946502">(</span><span class="string" id="3946503">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3946538">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946545">skx</span>&nbsp;<span class="op" id="3946549">:=</span>&nbsp;<span class="builtinfunc" id="3946552">new</span><span class="op" id="3946555">(</span><span class="ident" id="3946556"><a href="/crypto/tls/handshake_messages.go.html#3906795">serverKeyExchangeMsg</a></span><span class="op" id="3946576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946579">sigAndHashLen</span>&nbsp;<span class="op" id="3946593">:=</span>&nbsp;<span class="num" id="3946596">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946599">if</span>&nbsp;<span class="ident" id="3946602"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3946604">.</span><span class="ident" id="3946605">version</span>&nbsp;<span class="op" id="3946613">&gt;=</span>&nbsp;<span class="ident" id="3946616"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3946629">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946633"><a href="/crypto/tls/key_agreement.go.html#3946579">sigAndHashLen</a></span>&nbsp;<span class="op" id="3946647">=</span>&nbsp;<span class="num" id="3946649">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946655"><a href="/crypto/tls/key_agreement.go.html#3946545">skx</a></span><span class="op" id="3946658">.</span><span class="ident" id="3946659">key</span>&nbsp;<span class="op" id="3946663">=</span>&nbsp;<span class="builtinfunc" id="3946665">make</span><span class="op" id="3946669">(</span><span class="op" id="3946670">[</span><span class="op" id="3946671">]</span><span class="builtintype" id="3946672">byte</span><span class="op" id="3946676">,</span>&nbsp;<span class="builtinfunc" id="3946678">len</span><span class="op" id="3946681">(</span><span class="ident" id="3946682"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3946698">)</span><span class="op" id="3946699">+</span><span class="ident" id="3946700"><a href="/crypto/tls/key_agreement.go.html#3946579">sigAndHashLen</a></span><span class="op" id="3946713">+</span><span class="num" id="3946714">2</span><span class="op" id="3946715">+</span><span class="builtinfunc" id="3946716">len</span><span class="op" id="3946719">(</span><span class="ident" id="3946720"><a href="/crypto/tls/key_agreement.go.html#3945733">sig</a></span><span class="op" id="3946723">)</span><span class="op" id="3946724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3946727">copy</span><span class="op" id="3946731">(</span><span class="ident" id="3946732"><a href="/crypto/tls/key_agreement.go.html#3946545">skx</a></span><span class="op" id="3946735">.</span><span class="ident" id="3946736">key</span><span class="op" id="3946739">,</span>&nbsp;<span class="ident" id="3946741"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3946757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946760">k</span>&nbsp;<span class="op" id="3946762">:=</span>&nbsp;<span class="ident" id="3946765"><a href="/crypto/tls/key_agreement.go.html#3946545">skx</a></span><span class="op" id="3946768">.</span><span class="ident" id="3946769">key</span><span class="op" id="3946772">[</span><span class="builtinfunc" id="3946773">len</span><span class="op" id="3946776">(</span><span class="ident" id="3946777"><a href="/crypto/tls/key_agreement.go.html#3945095">serverECDHParams</a></span><span class="op" id="3946793">)</span><span class="op" id="3946794">:</span><span class="op" id="3946795">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946798">if</span>&nbsp;<span class="ident" id="3946801"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3946803">.</span><span class="ident" id="3946804">version</span>&nbsp;<span class="op" id="3946812">&gt;=</span>&nbsp;<span class="ident" id="3946815"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3946828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946832"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span><span class="op" id="3946833">[</span><span class="num" id="3946834">0</span><span class="op" id="3946835">]</span>&nbsp;<span class="op" id="3946837">=</span>&nbsp;<span class="ident" id="3946839"><a href="/crypto/tls/key_agreement.go.html#3945364">tls12HashId</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946853"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span><span class="op" id="3946854">[</span><span class="num" id="3946855">1</span><span class="op" id="3946856">]</span>&nbsp;<span class="op" id="3946858">=</span>&nbsp;<span class="ident" id="3946860"><a href="/crypto/tls/key_agreement.go.html#3944187">ka</a></span><span class="op" id="3946862">.</span><span class="ident" id="3946863">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946873"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span>&nbsp;<span class="op" id="3946875">=</span>&nbsp;<span class="ident" id="3946877"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span><span class="op" id="3946878">[</span><span class="num" id="3946879">2</span><span class="op" id="3946880">:</span><span class="op" id="3946881">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946884">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946887"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span><span class="op" id="3946888">[</span><span class="num" id="3946889">0</span><span class="op" id="3946890">]</span>&nbsp;<span class="op" id="3946892">=</span>&nbsp;<span class="builtintype" id="3946894">byte</span><span class="op" id="3946898">(</span><span class="builtinfunc" id="3946899">len</span><span class="op" id="3946902">(</span><span class="ident" id="3946903"><a href="/crypto/tls/key_agreement.go.html#3945733">sig</a></span><span class="op" id="3946906">)</span>&nbsp;<span class="op" id="3946908">&gt;&gt;</span>&nbsp;<span class="num" id="3946911">8</span><span class="op" id="3946912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946915"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span><span class="op" id="3946916">[</span><span class="num" id="3946917">1</span><span class="op" id="3946918">]</span>&nbsp;<span class="op" id="3946920">=</span>&nbsp;<span class="builtintype" id="3946922">byte</span><span class="op" id="3946926">(</span><span class="builtinfunc" id="3946927">len</span><span class="op" id="3946930">(</span><span class="ident" id="3946931"><a href="/crypto/tls/key_agreement.go.html#3945733">sig</a></span><span class="op" id="3946934">)</span><span class="op" id="3946935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3946938">copy</span><span class="op" id="3946942">(</span><span class="ident" id="3946943"><a href="/crypto/tls/key_agreement.go.html#3946760">k</a></span><span class="op" id="3946944">[</span><span class="num" id="3946945">2</span><span class="op" id="3946946">:</span><span class="op" id="3946947">]</span><span class="op" id="3946948">,</span>&nbsp;<span class="ident" id="3946950"><a href="/crypto/tls/key_agreement.go.html#3945733">sig</a></span><span class="op" id="3946953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946957">return</span>&nbsp;<span class="ident" id="3946964"><a href="/crypto/tls/key_agreement.go.html#3946545">skx</a></span><span class="op" id="3946967">,</span>&nbsp;<span class="ident" id="3946969">nil</span><br>
<span class="lineno">285</span><span class="op" id="3946973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3946976">func</span>&nbsp;<span class="op" id="3946981">(</span><span class="ident" id="3946982">ka</span>&nbsp;<span class="op" id="3946985">*</span><span class="ident" id="3946986"><a href="/crypto/tls/key_agreement.go.html#3944047">ecdheKeyAgreement</a></span><span class="op" id="3947003">)</span>&nbsp;<span class="ident" id="3947005">processClientKeyExchange</span><span class="op" id="3947029">(</span><span class="ident" id="3947030">config</span>&nbsp;<span class="op" id="3947037">*</span><span class="ident" id="3947038"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3947044">,</span>&nbsp;<span class="ident" id="3947046">cert</span>&nbsp;<span class="op" id="3947051">*</span><span class="ident" id="3947052"><a href="/crypto/tls/common.go.html#3838319">Certificate</a></span><span class="op" id="3947063">,</span>&nbsp;<span class="ident" id="3947065">ckx</span>&nbsp;<span class="op" id="3947069">*</span><span class="ident" id="3947070"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3947090">,</span>&nbsp;<span class="ident" id="3947092">version</span>&nbsp;<span class="builtintype" id="3947100">uint16</span><span class="op" id="3947106">)</span>&nbsp;<span class="op" id="3947108">(</span><span class="op" id="3947109">[</span><span class="op" id="3947110">]</span><span class="builtintype" id="3947111">byte</span><span class="op" id="3947115">,</span>&nbsp;<span class="builtintype" id="3947117">error</span><span class="op" id="3947122">)</span>&nbsp;<span class="op" id="3947124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947127">if</span>&nbsp;<span class="builtinfunc" id="3947130">len</span><span class="op" id="3947133">(</span><span class="ident" id="3947134"><a href="/crypto/tls/key_agreement.go.html#3947065">ckx</a></span><span class="op" id="3947137">.</span><span class="ident" id="3947138">ciphertext</span><span class="op" id="3947148">)</span>&nbsp;<span class="op" id="3947150">==</span>&nbsp;<span class="num" id="3947153">0</span>&nbsp;<span class="op" id="3947155">||</span>&nbsp;<span class="builtintype" id="3947158">int</span><span class="op" id="3947161">(</span><span class="ident" id="3947162"><a href="/crypto/tls/key_agreement.go.html#3947065">ckx</a></span><span class="op" id="3947165">.</span><span class="ident" id="3947166">ciphertext</span><span class="op" id="3947176">[</span><span class="num" id="3947177">0</span><span class="op" id="3947178">]</span><span class="op" id="3947179">)</span>&nbsp;<span class="op" id="3947181">!=</span>&nbsp;<span class="builtinfunc" id="3947184">len</span><span class="op" id="3947187">(</span><span class="ident" id="3947188"><a href="/crypto/tls/key_agreement.go.html#3947065">ckx</a></span><span class="op" id="3947191">.</span><span class="ident" id="3947192">ciphertext</span><span class="op" id="3947202">)</span><span class="op" id="3947203">-</span><span class="num" id="3947204">1</span>&nbsp;<span class="op" id="3947206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947210">return</span>&nbsp;<span class="ident" id="3947217">nil</span><span class="op" id="3947220">,</span>&nbsp;<span class="ident" id="3947222"><a href="/crypto/tls/key_agreement.go.html#3938441">errClientKeyExchange</a></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3947244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947247">x</span><span class="op" id="3947248">,</span>&nbsp;<span class="ident" id="3947250">y</span>&nbsp;<span class="op" id="3947252">:=</span>&nbsp;<span class="ident" id="3947255"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3947263">.</span><span class="ident" id="3947264">Unmarshal</span><span class="op" id="3947273">(</span><span class="ident" id="3947274"><a href="/crypto/tls/key_agreement.go.html#3946982">ka</a></span><span class="op" id="3947276">.</span><span class="ident" id="3947277">curve</span><span class="op" id="3947282">,</span>&nbsp;<span class="ident" id="3947284"><a href="/crypto/tls/key_agreement.go.html#3947065">ckx</a></span><span class="op" id="3947287">.</span><span class="ident" id="3947288">ciphertext</span><span class="op" id="3947298">[</span><span class="num" id="3947299">1</span><span class="op" id="3947300">:</span><span class="op" id="3947301">]</span><span class="op" id="3947302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947305">if</span>&nbsp;<span class="ident" id="3947308"><a href="/crypto/tls/key_agreement.go.html#3947247">x</a></span>&nbsp;<span class="op" id="3947310">==</span>&nbsp;<span class="ident" id="3947313">nil</span>&nbsp;<span class="op" id="3947317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947321">return</span>&nbsp;<span class="ident" id="3947328">nil</span><span class="op" id="3947331">,</span>&nbsp;<span class="ident" id="3947333"><a href="/crypto/tls/key_agreement.go.html#3938441">errClientKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3947355">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947358">if</span>&nbsp;<span class="op" id="3947361">!</span><span class="ident" id="3947362"><a href="/crypto/tls/key_agreement.go.html#3946982">ka</a></span><span class="op" id="3947364">.</span><span class="ident" id="3947365">curve</span><span class="op" id="3947370">.</span><span class="ident" id="3947371">IsOnCurve</span><span class="op" id="3947380">(</span><span class="ident" id="3947381"><a href="/crypto/tls/key_agreement.go.html#3947247">x</a></span><span class="op" id="3947382">,</span>&nbsp;<span class="ident" id="3947384"><a href="/crypto/tls/key_agreement.go.html#3947250">y</a></span><span class="op" id="3947385">)</span>&nbsp;<span class="op" id="3947387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947391">return</span>&nbsp;<span class="ident" id="3947398">nil</span><span class="op" id="3947401">,</span>&nbsp;<span class="ident" id="3947403"><a href="/crypto/tls/key_agreement.go.html#3938441">errClientKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3947425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947428"><a href="/crypto/tls/key_agreement.go.html#3947247">x</a></span><span class="op" id="3947429">,</span>&nbsp;<span class="ident" id="3947431">_</span>&nbsp;<span class="op" id="3947433">=</span>&nbsp;<span class="ident" id="3947435"><a href="/crypto/tls/key_agreement.go.html#3946982">ka</a></span><span class="op" id="3947437">.</span><span class="ident" id="3947438">curve</span><span class="op" id="3947443">.</span><span class="ident" id="3947444">ScalarMult</span><span class="op" id="3947454">(</span><span class="ident" id="3947455"><a href="/crypto/tls/key_agreement.go.html#3947247">x</a></span><span class="op" id="3947456">,</span>&nbsp;<span class="ident" id="3947458"><a href="/crypto/tls/key_agreement.go.html#3947250">y</a></span><span class="op" id="3947459">,</span>&nbsp;<span class="ident" id="3947461"><a href="/crypto/tls/key_agreement.go.html#3946982">ka</a></span><span class="op" id="3947463">.</span><span class="ident" id="3947464">privateKey</span><span class="op" id="3947474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947477">preMasterSecret</span>&nbsp;<span class="op" id="3947493">:=</span>&nbsp;<span class="builtinfunc" id="3947496">make</span><span class="op" id="3947500">(</span><span class="op" id="3947501">[</span><span class="op" id="3947502">]</span><span class="builtintype" id="3947503">byte</span><span class="op" id="3947507">,</span>&nbsp;<span class="op" id="3947509">(</span><span class="ident" id="3947510"><a href="/crypto/tls/key_agreement.go.html#3946982">ka</a></span><span class="op" id="3947512">.</span><span class="ident" id="3947513">curve</span><span class="op" id="3947518">.</span><span class="ident" id="3947519">Params</span><span class="op" id="3947525">(</span><span class="op" id="3947526">)</span><span class="op" id="3947527">.</span><span class="ident" id="3947528">BitSize</span><span class="op" id="3947535">+</span><span class="num" id="3947536">7</span><span class="op" id="3947537">)</span><span class="op" id="3947538">&gt;&gt;</span><span class="num" id="3947540">3</span><span class="op" id="3947541">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947544">xBytes</span>&nbsp;<span class="op" id="3947551">:=</span>&nbsp;<span class="ident" id="3947554"><a href="/crypto/tls/key_agreement.go.html#3947247">x</a></span><span class="op" id="3947555">.</span><span class="ident" id="3947556">Bytes</span><span class="op" id="3947561">(</span><span class="op" id="3947562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3947565">copy</span><span class="op" id="3947569">(</span><span class="ident" id="3947570"><a href="/crypto/tls/key_agreement.go.html#3947477">preMasterSecret</a></span><span class="op" id="3947585">[</span><span class="builtinfunc" id="3947586">len</span><span class="op" id="3947589">(</span><span class="ident" id="3947590"><a href="/crypto/tls/key_agreement.go.html#3947477">preMasterSecret</a></span><span class="op" id="3947605">)</span><span class="op" id="3947606">-</span><span class="builtinfunc" id="3947607">len</span><span class="op" id="3947610">(</span><span class="ident" id="3947611"><a href="/crypto/tls/key_agreement.go.html#3947544">xBytes</a></span><span class="op" id="3947617">)</span><span class="op" id="3947618">:</span><span class="op" id="3947619">]</span><span class="op" id="3947620">,</span>&nbsp;<span class="ident" id="3947622"><a href="/crypto/tls/key_agreement.go.html#3947544">xBytes</a></span><span class="op" id="3947628">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947632">return</span>&nbsp;<span class="ident" id="3947639"><a href="/crypto/tls/key_agreement.go.html#3947477">preMasterSecret</a></span><span class="op" id="3947654">,</span>&nbsp;<span class="ident" id="3947656">nil</span><br>
<span class="lineno"></span><span class="op" id="3947660">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="3947663">func</span>&nbsp;<span class="op" id="3947668">(</span><span class="ident" id="3947669">ka</span>&nbsp;<span class="op" id="3947672">*</span><span class="ident" id="3947673"><a href="/crypto/tls/key_agreement.go.html#3944047">ecdheKeyAgreement</a></span><span class="op" id="3947690">)</span>&nbsp;<span class="ident" id="3947692">processServerKeyExchange</span><span class="op" id="3947716">(</span><span class="ident" id="3947717">config</span>&nbsp;<span class="op" id="3947724">*</span><span class="ident" id="3947725"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3947731">,</span>&nbsp;<span class="ident" id="3947733">clientHello</span>&nbsp;<span class="op" id="3947745">*</span><span class="ident" id="3947746"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3947760">,</span>&nbsp;<span class="ident" id="3947762">serverHello</span>&nbsp;<span class="op" id="3947774">*</span><span class="ident" id="3947775"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><span class="op" id="3947789">,</span>&nbsp;<span class="ident" id="3947791">cert</span>&nbsp;<span class="op" id="3947796">*</span><span class="ident" id="3947797"><a href="/crypto/tls/key_agreement.go.html#3938375">x509</a></span><span class="op" id="3947801">.</span><span class="ident" id="3947802">Certificate</span><span class="op" id="3947813">,</span>&nbsp;<span class="ident" id="3947815">skx</span>&nbsp;<span class="op" id="3947819">*</span><span class="ident" id="3947820"><a href="/crypto/tls/handshake_messages.go.html#3906795">serverKeyExchangeMsg</a></span><span class="op" id="3947840">)</span>&nbsp;<span class="builtintype" id="3947842">error</span>&nbsp;<span class="op" id="3947848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947851">if</span>&nbsp;<span class="builtinfunc" id="3947854">len</span><span class="op" id="3947857">(</span><span class="ident" id="3947858"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3947861">.</span><span class="ident" id="3947862">key</span><span class="op" id="3947865">)</span>&nbsp;<span class="op" id="3947867">&lt;</span>&nbsp;<span class="num" id="3947869">4</span>&nbsp;<span class="op" id="3947871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947875">return</span>&nbsp;<span class="ident" id="3947882"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3947904">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947907">if</span>&nbsp;<span class="ident" id="3947910"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3947913">.</span><span class="ident" id="3947914">key</span><span class="op" id="3947917">[</span><span class="num" id="3947918">0</span><span class="op" id="3947919">]</span>&nbsp;<span class="op" id="3947921">!=</span>&nbsp;<span class="num" id="3947924">3</span>&nbsp;<span class="op" id="3947926">{</span>&nbsp;<span class="comment" id="3947928">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947945">return</span>&nbsp;<span class="ident" id="3947952"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3947958">.</span><span class="ident" id="3947959">New</span><span class="op" id="3947962">(</span><span class="string" id="3947963">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3948003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948009">curveid</span>&nbsp;<span class="op" id="3948017">:=</span>&nbsp;<span class="ident" id="3948020"><a href="/crypto/tls/common.go.html#3824673">CurveID</a></span><span class="op" id="3948027">(</span><span class="ident" id="3948028"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948031">.</span><span class="ident" id="3948032">key</span><span class="op" id="3948035">[</span><span class="num" id="3948036">1</span><span class="op" id="3948037">]</span><span class="op" id="3948038">)</span><span class="op" id="3948039">&lt;&lt;</span><span class="num" id="3948041">8</span>&nbsp;<span class="op" id="3948043">|</span>&nbsp;<span class="ident" id="3948045"><a href="/crypto/tls/common.go.html#3824673">CurveID</a></span><span class="op" id="3948052">(</span><span class="ident" id="3948053"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948056">.</span><span class="ident" id="3948057">key</span><span class="op" id="3948060">[</span><span class="num" id="3948061">2</span><span class="op" id="3948062">]</span><span class="op" id="3948063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948067">var</span>&nbsp;<span class="ident" id="3948071">ok</span>&nbsp;<span class="builtintype" id="3948074">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948080">if</span>&nbsp;<span class="ident" id="3948083"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948085">.</span><span class="ident" id="3948086">curve</span><span class="op" id="3948091">,</span>&nbsp;<span class="ident" id="3948093"><a href="/crypto/tls/key_agreement.go.html#3948071">ok</a></span>&nbsp;<span class="op" id="3948096">=</span>&nbsp;<span class="ident" id="3948098"><a href="/crypto/tls/key_agreement.go.html#3943556">curveForCurveID</a></span><span class="op" id="3948113">(</span><span class="ident" id="3948114"><a href="/crypto/tls/key_agreement.go.html#3948009">curveid</a></span><span class="op" id="3948121">)</span><span class="op" id="3948122">;</span>&nbsp;<span class="op" id="3948124">!</span><span class="ident" id="3948125"><a href="/crypto/tls/key_agreement.go.html#3948071">ok</a></span>&nbsp;<span class="op" id="3948128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948132">return</span>&nbsp;<span class="ident" id="3948139"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3948145">.</span><span class="ident" id="3948146">New</span><span class="op" id="3948149">(</span><span class="string" id="3948150">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3948190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948197">publicLen</span>&nbsp;<span class="op" id="3948207">:=</span>&nbsp;<span class="builtintype" id="3948210">int</span><span class="op" id="3948213">(</span><span class="ident" id="3948214"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948217">.</span><span class="ident" id="3948218">key</span><span class="op" id="3948221">[</span><span class="num" id="3948222">3</span><span class="op" id="3948223">]</span><span class="op" id="3948224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948227">if</span>&nbsp;<span class="ident" id="3948230"><a href="/crypto/tls/key_agreement.go.html#3948197">publicLen</a></span><span class="op" id="3948239">+</span><span class="num" id="3948240">4</span>&nbsp;<span class="op" id="3948242">&gt;</span>&nbsp;<span class="builtinfunc" id="3948244">len</span><span class="op" id="3948247">(</span><span class="ident" id="3948248"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948251">.</span><span class="ident" id="3948252">key</span><span class="op" id="3948255">)</span>&nbsp;<span class="op" id="3948257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948261">return</span>&nbsp;<span class="ident" id="3948268"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948293"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948295">.</span><span class="ident" id="3948296">x</span><span class="op" id="3948297">,</span>&nbsp;<span class="ident" id="3948299"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948301">.</span><span class="ident" id="3948302">y</span>&nbsp;<span class="op" id="3948304">=</span>&nbsp;<span class="ident" id="3948306"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3948314">.</span><span class="ident" id="3948315">Unmarshal</span><span class="op" id="3948324">(</span><span class="ident" id="3948325"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948327">.</span><span class="ident" id="3948328">curve</span><span class="op" id="3948333">,</span>&nbsp;<span class="ident" id="3948335"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948338">.</span><span class="ident" id="3948339">key</span><span class="op" id="3948342">[</span><span class="num" id="3948343">4</span><span class="op" id="3948344">:</span><span class="num" id="3948345">4</span><span class="op" id="3948346">+</span><span class="ident" id="3948347"><a href="/crypto/tls/key_agreement.go.html#3948197">publicLen</a></span><span class="op" id="3948356">]</span><span class="op" id="3948357">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948360">if</span>&nbsp;<span class="ident" id="3948363"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948365">.</span><span class="ident" id="3948366">x</span>&nbsp;<span class="op" id="3948368">==</span>&nbsp;<span class="ident" id="3948371">nil</span>&nbsp;<span class="op" id="3948375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948379">return</span>&nbsp;<span class="ident" id="3948386"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948411">if</span>&nbsp;<span class="op" id="3948414">!</span><span class="ident" id="3948415"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948417">.</span><span class="ident" id="3948418">curve</span><span class="op" id="3948423">.</span><span class="ident" id="3948424">IsOnCurve</span><span class="op" id="3948433">(</span><span class="ident" id="3948434"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948436">.</span><span class="ident" id="3948437">x</span><span class="op" id="3948438">,</span>&nbsp;<span class="ident" id="3948440"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948442">.</span><span class="ident" id="3948443">y</span><span class="op" id="3948444">)</span>&nbsp;<span class="op" id="3948446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948450">return</span>&nbsp;<span class="ident" id="3948457"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948482">serverECDHParams</span>&nbsp;<span class="op" id="3948499">:=</span>&nbsp;<span class="ident" id="3948502"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948505">.</span><span class="ident" id="3948506">key</span><span class="op" id="3948509">[</span><span class="op" id="3948510">:</span><span class="num" id="3948511">4</span><span class="op" id="3948512">+</span><span class="ident" id="3948513"><a href="/crypto/tls/key_agreement.go.html#3948197">publicLen</a></span><span class="op" id="3948522">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948526">sig</span>&nbsp;<span class="op" id="3948530">:=</span>&nbsp;<span class="ident" id="3948533"><a href="/crypto/tls/key_agreement.go.html#3947815">skx</a></span><span class="op" id="3948536">.</span><span class="ident" id="3948537">key</span><span class="op" id="3948540">[</span><span class="num" id="3948541">4</span><span class="op" id="3948542">+</span><span class="ident" id="3948543"><a href="/crypto/tls/key_agreement.go.html#3948197">publicLen</a></span><span class="op" id="3948552">:</span><span class="op" id="3948553">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948556">if</span>&nbsp;<span class="builtinfunc" id="3948559">len</span><span class="op" id="3948562">(</span><span class="ident" id="3948563"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948566">)</span>&nbsp;<span class="op" id="3948568">&lt;</span>&nbsp;<span class="num" id="3948570">2</span>&nbsp;<span class="op" id="3948572">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948576">return</span>&nbsp;<span class="ident" id="3948583"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948609">var</span>&nbsp;<span class="ident" id="3948613">tls12HashId</span>&nbsp;<span class="builtintype" id="3948625">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948632">if</span>&nbsp;<span class="ident" id="3948635"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948637">.</span><span class="ident" id="3948638">version</span>&nbsp;<span class="op" id="3948646">&gt;=</span>&nbsp;<span class="ident" id="3948649"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span>&nbsp;<span class="op" id="3948662">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3948666">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948704">var</span>&nbsp;<span class="ident" id="3948708">sigAndHash</span>&nbsp;<span class="op" id="3948719">[</span><span class="op" id="3948720">]</span><span class="builtintype" id="3948721">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948729"><a href="/crypto/tls/key_agreement.go.html#3948708">sigAndHash</a></span><span class="op" id="3948739">,</span>&nbsp;<span class="ident" id="3948741"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span>&nbsp;<span class="op" id="3948745">=</span>&nbsp;<span class="ident" id="3948747"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948750">[</span><span class="op" id="3948751">:</span><span class="num" id="3948752">2</span><span class="op" id="3948753">]</span><span class="op" id="3948754">,</span>&nbsp;<span class="ident" id="3948756"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948759">[</span><span class="num" id="3948760">2</span><span class="op" id="3948761">:</span><span class="op" id="3948762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948766">if</span>&nbsp;<span class="ident" id="3948769"><a href="/crypto/tls/key_agreement.go.html#3948708">sigAndHash</a></span><span class="op" id="3948779">[</span><span class="num" id="3948780">1</span><span class="op" id="3948781">]</span>&nbsp;<span class="op" id="3948783">!=</span>&nbsp;<span class="ident" id="3948786"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3948788">.</span><span class="ident" id="3948789">sigType</span>&nbsp;<span class="op" id="3948797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948802">return</span>&nbsp;<span class="ident" id="3948809"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948836"><a href="/crypto/tls/key_agreement.go.html#3948613">tls12HashId</a></span>&nbsp;<span class="op" id="3948848">=</span>&nbsp;<span class="ident" id="3948850"><a href="/crypto/tls/key_agreement.go.html#3948708">sigAndHash</a></span><span class="op" id="3948860">[</span><span class="num" id="3948861">0</span><span class="op" id="3948862">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948866">if</span>&nbsp;<span class="builtinfunc" id="3948869">len</span><span class="op" id="3948872">(</span><span class="ident" id="3948873"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948876">)</span>&nbsp;<span class="op" id="3948878">&lt;</span>&nbsp;<span class="num" id="3948880">2</span>&nbsp;<span class="op" id="3948882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948887">return</span>&nbsp;<span class="ident" id="3948894"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948917">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948923">sigLen</span>&nbsp;<span class="op" id="3948930">:=</span>&nbsp;<span class="builtintype" id="3948933">int</span><span class="op" id="3948936">(</span><span class="ident" id="3948937"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948940">[</span><span class="num" id="3948941">0</span><span class="op" id="3948942">]</span><span class="op" id="3948943">)</span><span class="op" id="3948944">&lt;&lt;</span><span class="num" id="3948946">8</span>&nbsp;<span class="op" id="3948948">|</span>&nbsp;<span class="builtintype" id="3948950">int</span><span class="op" id="3948953">(</span><span class="ident" id="3948954"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948957">[</span><span class="num" id="3948958">1</span><span class="op" id="3948959">]</span><span class="op" id="3948960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948963">if</span>&nbsp;<span class="ident" id="3948966"><a href="/crypto/tls/key_agreement.go.html#3948923">sigLen</a></span><span class="op" id="3948972">+</span><span class="num" id="3948973">2</span>&nbsp;<span class="op" id="3948975">!=</span>&nbsp;<span class="builtinfunc" id="3948978">len</span><span class="op" id="3948981">(</span><span class="ident" id="3948982"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3948985">)</span>&nbsp;<span class="op" id="3948987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948991">return</span>&nbsp;<span class="ident" id="3948998"><a href="/crypto/tls/key_agreement.go.html#3938521">errServerKeyExchange</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949020">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949023"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span>&nbsp;<span class="op" id="3949027">=</span>&nbsp;<span class="ident" id="3949029"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3949032">[</span><span class="num" id="3949033">2</span><span class="op" id="3949034">:</span><span class="op" id="3949035">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949039">digest</span><span class="op" id="3949045">,</span>&nbsp;<span class="ident" id="3949047">hashFunc</span><span class="op" id="3949055">,</span>&nbsp;<span class="ident" id="3949057">err</span>&nbsp;<span class="op" id="3949061">:=</span>&nbsp;<span class="ident" id="3949064"><a href="/crypto/tls/key_agreement.go.html#3942165">hashForServerKeyExchange</a></span><span class="op" id="3949088">(</span><span class="ident" id="3949089"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3949091">.</span><span class="ident" id="3949092">sigType</span><span class="op" id="3949099">,</span>&nbsp;<span class="ident" id="3949101"><a href="/crypto/tls/key_agreement.go.html#3948613">tls12HashId</a></span><span class="op" id="3949112">,</span>&nbsp;<span class="ident" id="3949114"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3949116">.</span><span class="ident" id="3949117">version</span><span class="op" id="3949124">,</span>&nbsp;<span class="ident" id="3949126"><a href="/crypto/tls/key_agreement.go.html#3947733">clientHello</a></span><span class="op" id="3949137">.</span><span class="ident" id="3949138">random</span><span class="op" id="3949144">,</span>&nbsp;<span class="ident" id="3949146"><a href="/crypto/tls/key_agreement.go.html#3947762">serverHello</a></span><span class="op" id="3949157">.</span><span class="ident" id="3949158">random</span><span class="op" id="3949164">,</span>&nbsp;<span class="ident" id="3949166"><a href="/crypto/tls/key_agreement.go.html#3948482">serverECDHParams</a></span><span class="op" id="3949182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949185">if</span>&nbsp;<span class="ident" id="3949188"><a href="/crypto/tls/key_agreement.go.html#3949057">err</a></span>&nbsp;<span class="op" id="3949192">!=</span>&nbsp;<span class="ident" id="3949195">nil</span>&nbsp;<span class="op" id="3949199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949203">return</span>&nbsp;<span class="ident" id="3949210"><a href="/crypto/tls/key_agreement.go.html#3949057">err</a></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949218">switch</span>&nbsp;<span class="ident" id="3949225"><a href="/crypto/tls/key_agreement.go.html#3947669">ka</a></span><span class="op" id="3949227">.</span><span class="ident" id="3949228">sigType</span>&nbsp;<span class="op" id="3949236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949239">case</span>&nbsp;<span class="ident" id="3949244"><a href="/crypto/tls/common.go.html#3825950">signatureECDSA</a></span><span class="op" id="3949258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949262">pubKey</span><span class="op" id="3949268">,</span>&nbsp;<span class="ident" id="3949270">ok</span>&nbsp;<span class="op" id="3949273">:=</span>&nbsp;<span class="ident" id="3949276"><a href="/crypto/tls/key_agreement.go.html#3947791">cert</a></span><span class="op" id="3949280">.</span><span class="ident" id="3949281">PublicKey</span><span class="op" id="3949290">.</span><span class="op" id="3949291">(</span><span class="op" id="3949292">*</span><span class="ident" id="3949293"><a href="/crypto/tls/key_agreement.go.html#3938280">ecdsa</a></span><span class="op" id="3949298">.</span><span class="ident" id="3949299">PublicKey</span><span class="op" id="3949308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949312">if</span>&nbsp;<span class="op" id="3949315">!</span><span class="ident" id="3949316"><a href="/crypto/tls/key_agreement.go.html#3949270">ok</a></span>&nbsp;<span class="op" id="3949319">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949324">return</span>&nbsp;<span class="ident" id="3949331"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3949337">.</span><span class="ident" id="3949338">New</span><span class="op" id="3949341">(</span><span class="string" id="3949342">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3949390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949398">ecdsaSig</span>&nbsp;<span class="op" id="3949407">:=</span>&nbsp;<span class="builtinfunc" id="3949410">new</span><span class="op" id="3949413">(</span><span class="ident" id="3949414"><a href="/crypto/tls/common.go.html#3841172">ecdsaSignature</a></span><span class="op" id="3949428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949432">if</span>&nbsp;<span class="ident" id="3949435">_</span><span class="op" id="3949436">,</span>&nbsp;<span class="ident" id="3949438">err</span>&nbsp;<span class="op" id="3949442">:=</span>&nbsp;<span class="ident" id="3949445"><a href="/crypto/tls/key_agreement.go.html#3938390">asn1</a></span><span class="op" id="3949449">.</span><span class="ident" id="3949450">Unmarshal</span><span class="op" id="3949459">(</span><span class="ident" id="3949460"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3949463">,</span>&nbsp;<span class="ident" id="3949465"><a href="/crypto/tls/key_agreement.go.html#3949398">ecdsaSig</a></span><span class="op" id="3949473">)</span><span class="op" id="3949474">;</span>&nbsp;<span class="ident" id="3949476"><a href="/crypto/tls/key_agreement.go.html#3949438">err</a></span>&nbsp;<span class="op" id="3949480">!=</span>&nbsp;<span class="ident" id="3949483">nil</span>&nbsp;<span class="op" id="3949487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949492">return</span>&nbsp;<span class="ident" id="3949499"><a href="/crypto/tls/key_agreement.go.html#3949438">err</a></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949509">if</span>&nbsp;<span class="ident" id="3949512"><a href="/crypto/tls/key_agreement.go.html#3949398">ecdsaSig</a></span><span class="op" id="3949520">.</span><span class="ident" id="3949521">R</span><span class="op" id="3949522">.</span><span class="ident" id="3949523">Sign</span><span class="op" id="3949527">(</span><span class="op" id="3949528">)</span>&nbsp;<span class="op" id="3949530">&lt;=</span>&nbsp;<span class="num" id="3949533">0</span>&nbsp;<span class="op" id="3949535">||</span>&nbsp;<span class="ident" id="3949538"><a href="/crypto/tls/key_agreement.go.html#3949398">ecdsaSig</a></span><span class="op" id="3949546">.</span><span class="ident" id="3949547">S</span><span class="op" id="3949548">.</span><span class="ident" id="3949549">Sign</span><span class="op" id="3949553">(</span><span class="op" id="3949554">)</span>&nbsp;<span class="op" id="3949556">&lt;=</span>&nbsp;<span class="num" id="3949559">0</span>&nbsp;<span class="op" id="3949561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949566">return</span>&nbsp;<span class="ident" id="3949573"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3949579">.</span><span class="ident" id="3949580">New</span><span class="op" id="3949583">(</span><span class="string" id="3949584">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3949635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949643">if</span>&nbsp;<span class="op" id="3949646">!</span><span class="ident" id="3949647"><a href="/crypto/tls/key_agreement.go.html#3938280">ecdsa</a></span><span class="op" id="3949652">.</span><span class="ident" id="3949653">Verify</span><span class="op" id="3949659">(</span><span class="ident" id="3949660"><a href="/crypto/tls/key_agreement.go.html#3949262">pubKey</a></span><span class="op" id="3949666">,</span>&nbsp;<span class="ident" id="3949668"><a href="/crypto/tls/key_agreement.go.html#3949039">digest</a></span><span class="op" id="3949674">,</span>&nbsp;<span class="ident" id="3949676"><a href="/crypto/tls/key_agreement.go.html#3949398">ecdsaSig</a></span><span class="op" id="3949684">.</span><span class="ident" id="3949685">R</span><span class="op" id="3949686">,</span>&nbsp;<span class="ident" id="3949688"><a href="/crypto/tls/key_agreement.go.html#3949398">ecdsaSig</a></span><span class="op" id="3949696">.</span><span class="ident" id="3949697">S</span><span class="op" id="3949698">)</span>&nbsp;<span class="op" id="3949700">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949705">return</span>&nbsp;<span class="ident" id="3949712"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3949718">.</span><span class="ident" id="3949719">New</span><span class="op" id="3949722">(</span><span class="string" id="3949723">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3949751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949758">case</span>&nbsp;<span class="ident" id="3949763"><a href="/crypto/tls/common.go.html#3825924">signatureRSA</a></span><span class="op" id="3949775">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949779">pubKey</span><span class="op" id="3949785">,</span>&nbsp;<span class="ident" id="3949787">ok</span>&nbsp;<span class="op" id="3949790">:=</span>&nbsp;<span class="ident" id="3949793"><a href="/crypto/tls/key_agreement.go.html#3947791">cert</a></span><span class="op" id="3949797">.</span><span class="ident" id="3949798">PublicKey</span><span class="op" id="3949807">.</span><span class="op" id="3949808">(</span><span class="op" id="3949809">*</span><span class="ident" id="3949810"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3949813">.</span><span class="ident" id="3949814">PublicKey</span><span class="op" id="3949823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949827">if</span>&nbsp;<span class="op" id="3949830">!</span><span class="ident" id="3949831"><a href="/crypto/tls/key_agreement.go.html#3949787">ok</a></span>&nbsp;<span class="op" id="3949834">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949839">return</span>&nbsp;<span class="ident" id="3949846"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3949852">.</span><span class="ident" id="3949853">New</span><span class="op" id="3949856">(</span><span class="string" id="3949857">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3949901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949909">if</span>&nbsp;<span class="ident" id="3949912">err</span>&nbsp;<span class="op" id="3949916">:=</span>&nbsp;<span class="ident" id="3949919"><a href="/crypto/tls/key_agreement.go.html#3938329">rsa</a></span><span class="op" id="3949922">.</span><span class="ident" id="3949923">VerifyPKCS1v15</span><span class="op" id="3949937">(</span><span class="ident" id="3949938"><a href="/crypto/tls/key_agreement.go.html#3949779">pubKey</a></span><span class="op" id="3949944">,</span>&nbsp;<span class="ident" id="3949946"><a href="/crypto/tls/key_agreement.go.html#3949047">hashFunc</a></span><span class="op" id="3949954">,</span>&nbsp;<span class="ident" id="3949956"><a href="/crypto/tls/key_agreement.go.html#3949039">digest</a></span><span class="op" id="3949962">,</span>&nbsp;<span class="ident" id="3949964"><a href="/crypto/tls/key_agreement.go.html#3948526">sig</a></span><span class="op" id="3949967">)</span><span class="op" id="3949968">;</span>&nbsp;<span class="ident" id="3949970"><a href="/crypto/tls/key_agreement.go.html#3949912">err</a></span>&nbsp;<span class="op" id="3949974">!=</span>&nbsp;<span class="ident" id="3949977">nil</span>&nbsp;<span class="op" id="3949981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949986">return</span>&nbsp;<span class="ident" id="3949993"><a href="/crypto/tls/key_agreement.go.html#3949912">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949999">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950002">default</span><span class="op" id="3950009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950013">return</span>&nbsp;<span class="ident" id="3950020"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3950026">.</span><span class="ident" id="3950027">New</span><span class="op" id="3950030">(</span><span class="string" id="3950031">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3950066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950073">return</span>&nbsp;<span class="ident" id="3950080">nil</span><br>
<span class="lineno">390</span><span class="op" id="3950084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3950087">func</span>&nbsp;<span class="op" id="3950092">(</span><span class="ident" id="3950093">ka</span>&nbsp;<span class="op" id="3950096">*</span><span class="ident" id="3950097"><a href="/crypto/tls/key_agreement.go.html#3944047">ecdheKeyAgreement</a></span><span class="op" id="3950114">)</span>&nbsp;<span class="ident" id="3950116">generateClientKeyExchange</span><span class="op" id="3950141">(</span><span class="ident" id="3950142">config</span>&nbsp;<span class="op" id="3950149">*</span><span class="ident" id="3950150"><a href="/crypto/tls/common.go.html#3830813">Config</a></span><span class="op" id="3950156">,</span>&nbsp;<span class="ident" id="3950158">clientHello</span>&nbsp;<span class="op" id="3950170">*</span><span class="ident" id="3950171"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3950185">,</span>&nbsp;<span class="ident" id="3950187">cert</span>&nbsp;<span class="op" id="3950192">*</span><span class="ident" id="3950193"><a href="/crypto/tls/key_agreement.go.html#3938375">x509</a></span><span class="op" id="3950197">.</span><span class="ident" id="3950198">Certificate</span><span class="op" id="3950209">)</span>&nbsp;<span class="op" id="3950211">(</span><span class="op" id="3950212">[</span><span class="op" id="3950213">]</span><span class="builtintype" id="3950214">byte</span><span class="op" id="3950218">,</span>&nbsp;<span class="op" id="3950220">*</span><span class="ident" id="3950221"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3950241">,</span>&nbsp;<span class="builtintype" id="3950243">error</span><span class="op" id="3950248">)</span>&nbsp;<span class="op" id="3950250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950253">if</span>&nbsp;<span class="ident" id="3950256"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950258">.</span><span class="ident" id="3950259">curve</span>&nbsp;<span class="op" id="3950265">==</span>&nbsp;<span class="ident" id="3950268">nil</span>&nbsp;<span class="op" id="3950272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950276">return</span>&nbsp;<span class="ident" id="3950283">nil</span><span class="op" id="3950286">,</span>&nbsp;<span class="ident" id="3950288">nil</span><span class="op" id="3950291">,</span>&nbsp;<span class="ident" id="3950293"><a href="/crypto/tls/key_agreement.go.html#3938407">errors</a></span><span class="op" id="3950299">.</span><span class="ident" id="3950300">New</span><span class="op" id="3950303">(</span><span class="string" id="3950304">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3950339">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950345">priv</span><span class="op" id="3950349">,</span>&nbsp;<span class="ident" id="3950351">mx</span><span class="op" id="3950353">,</span>&nbsp;<span class="ident" id="3950355">my</span><span class="op" id="3950357">,</span>&nbsp;<span class="ident" id="3950359">err</span>&nbsp;<span class="op" id="3950363">:=</span>&nbsp;<span class="ident" id="3950366"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3950374">.</span><span class="ident" id="3950375">GenerateKey</span><span class="op" id="3950386">(</span><span class="ident" id="3950387"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950389">.</span><span class="ident" id="3950390">curve</span><span class="op" id="3950395">,</span>&nbsp;<span class="ident" id="3950397"><a href="/crypto/tls/key_agreement.go.html#3950142">config</a></span><span class="op" id="3950403">.</span><span class="ident" id="3950404">rand</span><span class="op" id="3950408">(</span><span class="op" id="3950409">)</span><span class="op" id="3950410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950413">if</span>&nbsp;<span class="ident" id="3950416"><a href="/crypto/tls/key_agreement.go.html#3950359">err</a></span>&nbsp;<span class="op" id="3950420">!=</span>&nbsp;<span class="ident" id="3950423">nil</span>&nbsp;<span class="op" id="3950427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950431">return</span>&nbsp;<span class="ident" id="3950438">nil</span><span class="op" id="3950441">,</span>&nbsp;<span class="ident" id="3950443">nil</span><span class="op" id="3950446">,</span>&nbsp;<span class="ident" id="3950448"><a href="/crypto/tls/key_agreement.go.html#3950359">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950453">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950456">x</span><span class="op" id="3950457">,</span>&nbsp;<span class="ident" id="3950459">_</span>&nbsp;<span class="op" id="3950461">:=</span>&nbsp;<span class="ident" id="3950464"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950466">.</span><span class="ident" id="3950467">curve</span><span class="op" id="3950472">.</span><span class="ident" id="3950473">ScalarMult</span><span class="op" id="3950483">(</span><span class="ident" id="3950484"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950486">.</span><span class="ident" id="3950487">x</span><span class="op" id="3950488">,</span>&nbsp;<span class="ident" id="3950490"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950492">.</span><span class="ident" id="3950493">y</span><span class="op" id="3950494">,</span>&nbsp;<span class="ident" id="3950496"><a href="/crypto/tls/key_agreement.go.html#3950345">priv</a></span><span class="op" id="3950500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950503">preMasterSecret</span>&nbsp;<span class="op" id="3950519">:=</span>&nbsp;<span class="builtinfunc" id="3950522">make</span><span class="op" id="3950526">(</span><span class="op" id="3950527">[</span><span class="op" id="3950528">]</span><span class="builtintype" id="3950529">byte</span><span class="op" id="3950533">,</span>&nbsp;<span class="op" id="3950535">(</span><span class="ident" id="3950536"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950538">.</span><span class="ident" id="3950539">curve</span><span class="op" id="3950544">.</span><span class="ident" id="3950545">Params</span><span class="op" id="3950551">(</span><span class="op" id="3950552">)</span><span class="op" id="3950553">.</span><span class="ident" id="3950554">BitSize</span><span class="op" id="3950561">+</span><span class="num" id="3950562">7</span><span class="op" id="3950563">)</span><span class="op" id="3950564">&gt;&gt;</span><span class="num" id="3950566">3</span><span class="op" id="3950567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950570">xBytes</span>&nbsp;<span class="op" id="3950577">:=</span>&nbsp;<span class="ident" id="3950580"><a href="/crypto/tls/key_agreement.go.html#3950456">x</a></span><span class="op" id="3950581">.</span><span class="ident" id="3950582">Bytes</span><span class="op" id="3950587">(</span><span class="op" id="3950588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3950591">copy</span><span class="op" id="3950595">(</span><span class="ident" id="3950596"><a href="/crypto/tls/key_agreement.go.html#3950503">preMasterSecret</a></span><span class="op" id="3950611">[</span><span class="builtinfunc" id="3950612">len</span><span class="op" id="3950615">(</span><span class="ident" id="3950616"><a href="/crypto/tls/key_agreement.go.html#3950503">preMasterSecret</a></span><span class="op" id="3950631">)</span><span class="op" id="3950632">-</span><span class="builtinfunc" id="3950633">len</span><span class="op" id="3950636">(</span><span class="ident" id="3950637"><a href="/crypto/tls/key_agreement.go.html#3950570">xBytes</a></span><span class="op" id="3950643">)</span><span class="op" id="3950644">:</span><span class="op" id="3950645">]</span><span class="op" id="3950646">,</span>&nbsp;<span class="ident" id="3950648"><a href="/crypto/tls/key_agreement.go.html#3950570">xBytes</a></span><span class="op" id="3950654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950658">serialized</span>&nbsp;<span class="op" id="3950669">:=</span>&nbsp;<span class="ident" id="3950672"><a href="/crypto/tls/key_agreement.go.html#3938296">elliptic</a></span><span class="op" id="3950680">.</span><span class="ident" id="3950681">Marshal</span><span class="op" id="3950688">(</span><span class="ident" id="3950689"><a href="/crypto/tls/key_agreement.go.html#3950093">ka</a></span><span class="op" id="3950691">.</span><span class="ident" id="3950692">curve</span><span class="op" id="3950697">,</span>&nbsp;<span class="ident" id="3950699"><a href="/crypto/tls/key_agreement.go.html#3950351">mx</a></span><span class="op" id="3950701">,</span>&nbsp;<span class="ident" id="3950703"><a href="/crypto/tls/key_agreement.go.html#3950355">my</a></span><span class="op" id="3950705">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950709">ckx</span>&nbsp;<span class="op" id="3950713">:=</span>&nbsp;<span class="builtinfunc" id="3950716">new</span><span class="op" id="3950719">(</span><span class="ident" id="3950720"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3950740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950743"><a href="/crypto/tls/key_agreement.go.html#3950709">ckx</a></span><span class="op" id="3950746">.</span><span class="ident" id="3950747">ciphertext</span>&nbsp;<span class="op" id="3950758">=</span>&nbsp;<span class="builtinfunc" id="3950760">make</span><span class="op" id="3950764">(</span><span class="op" id="3950765">[</span><span class="op" id="3950766">]</span><span class="builtintype" id="3950767">byte</span><span class="op" id="3950771">,</span>&nbsp;<span class="num" id="3950773">1</span><span class="op" id="3950774">+</span><span class="builtinfunc" id="3950775">len</span><span class="op" id="3950778">(</span><span class="ident" id="3950779"><a href="/crypto/tls/key_agreement.go.html#3950658">serialized</a></span><span class="op" id="3950789">)</span><span class="op" id="3950790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950793"><a href="/crypto/tls/key_agreement.go.html#3950709">ckx</a></span><span class="op" id="3950796">.</span><span class="ident" id="3950797">ciphertext</span><span class="op" id="3950807">[</span><span class="num" id="3950808">0</span><span class="op" id="3950809">]</span>&nbsp;<span class="op" id="3950811">=</span>&nbsp;<span class="builtintype" id="3950813">byte</span><span class="op" id="3950817">(</span><span class="builtinfunc" id="3950818">len</span><span class="op" id="3950821">(</span><span class="ident" id="3950822"><a href="/crypto/tls/key_agreement.go.html#3950658">serialized</a></span><span class="op" id="3950832">)</span><span class="op" id="3950833">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3950836">copy</span><span class="op" id="3950840">(</span><span class="ident" id="3950841"><a href="/crypto/tls/key_agreement.go.html#3950709">ckx</a></span><span class="op" id="3950844">.</span><span class="ident" id="3950845">ciphertext</span><span class="op" id="3950855">[</span><span class="num" id="3950856">1</span><span class="op" id="3950857">:</span><span class="op" id="3950858">]</span><span class="op" id="3950859">,</span>&nbsp;<span class="ident" id="3950861"><a href="/crypto/tls/key_agreement.go.html#3950658">serialized</a></span><span class="op" id="3950871">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950875">return</span>&nbsp;<span class="ident" id="3950882"><a href="/crypto/tls/key_agreement.go.html#3950503">preMasterSecret</a></span><span class="op" id="3950897">,</span>&nbsp;<span class="ident" id="3950899"><a href="/crypto/tls/key_agreement.go.html#3950709">ckx</a></span><span class="op" id="3950902">,</span>&nbsp;<span class="ident" id="3950904">nil</span><br>
<span class="lineno"></span><span class="op" id="3950908">}</span>
</div>
</body>
</html>
