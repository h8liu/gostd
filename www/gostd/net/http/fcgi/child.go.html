<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6323971">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6324026">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6324080">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6324131">package</span>&nbsp;<span class="ident" id="6324139">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6324145">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6324219">import</span>&nbsp;<span class="op" id="6324226">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324229">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324239">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324246">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324252">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324265">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324272">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324284">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324300">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324306">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324317">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6324325">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6324332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6324335">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6324416">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6324454">type</span>&nbsp;<span class="ident" id="6324459">request</span>&nbsp;<span class="keyword" id="6324467">struct</span>&nbsp;<span class="op" id="6324474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324477">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324487">*</span><span class="ident" id="6324488">io</span><span class="op" id="6324490">.</span><span class="ident" id="6324491">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324503">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6324513">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324521">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324531">map</span><span class="op" id="6324534">[</span><span class="builtintype" id="6324535">string</span><span class="op" id="6324541">]</span><span class="builtintype" id="6324542">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324550">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324560">[</span><span class="num" id="6324561">1024</span><span class="op" id="6324565">]</span><span class="builtintype" id="6324566">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324572">rawParams</span>&nbsp;<span class="op" id="6324582">[</span><span class="op" id="6324583">]</span><span class="builtintype" id="6324584">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324590">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6324600">bool</span><br>
<span class="lineno"></span><span class="op" id="6324605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6324608">func</span>&nbsp;<span class="ident" id="6324613">newRequest</span><span class="op" id="6324623">(</span><span class="ident" id="6324624">reqId</span>&nbsp;<span class="builtintype" id="6324630">uint16</span><span class="op" id="6324636">,</span>&nbsp;<span class="ident" id="6324638">flags</span>&nbsp;<span class="builtintype" id="6324644">uint8</span><span class="op" id="6324649">)</span>&nbsp;<span class="op" id="6324651">*</span><span class="ident" id="6324652">request</span>&nbsp;<span class="op" id="6324660">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324663">r</span>&nbsp;<span class="op" id="6324665">:=</span>&nbsp;<span class="op" id="6324668">&amp;</span><span class="ident" id="6324669">request</span><span class="op" id="6324676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324680">reqId</span><span class="op" id="6324685">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324690">reqId</span><span class="op" id="6324695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324699">params</span><span class="op" id="6324705">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324709">map</span><span class="op" id="6324712">[</span><span class="builtintype" id="6324713">string</span><span class="op" id="6324719">]</span><span class="builtintype" id="6324720">string</span><span class="op" id="6324726">{</span><span class="op" id="6324727">}</span><span class="op" id="6324728">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324732">keepConn</span><span class="op" id="6324740">:</span>&nbsp;<span class="ident" id="6324742">flags</span><span class="op" id="6324747">&amp;</span><span class="ident" id="6324748">flagKeepConn</span>&nbsp;<span class="op" id="6324761">!=</span>&nbsp;<span class="num" id="6324764">0</span><span class="op" id="6324765">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6324768">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324771">r</span><span class="op" id="6324772">.</span><span class="ident" id="6324773">rawParams</span>&nbsp;<span class="op" id="6324783">=</span>&nbsp;<span class="ident" id="6324785">r</span><span class="op" id="6324786">.</span><span class="ident" id="6324787">buf</span><span class="op" id="6324790">[</span><span class="op" id="6324791">:</span><span class="num" id="6324792">0</span><span class="op" id="6324793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324796">return</span>&nbsp;<span class="ident" id="6324803">r</span><br>
<span class="lineno"></span><span class="op" id="6324805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6324808">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6324860">func</span>&nbsp;<span class="op" id="6324865">(</span><span class="ident" id="6324866">r</span>&nbsp;<span class="op" id="6324868">*</span><span class="ident" id="6324869">request</span><span class="op" id="6324876">)</span>&nbsp;<span class="ident" id="6324878">parseParams</span><span class="op" id="6324889">(</span><span class="op" id="6324890">)</span>&nbsp;<span class="op" id="6324892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324895">text</span>&nbsp;<span class="op" id="6324900">:=</span>&nbsp;<span class="ident" id="6324903">r</span><span class="op" id="6324904">.</span><span class="ident" id="6324905">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324916">r</span><span class="op" id="6324917">.</span><span class="ident" id="6324918">rawParams</span>&nbsp;<span class="op" id="6324928">=</span>&nbsp;<span class="builtintype" id="6324930">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324935">for</span>&nbsp;<span class="builtinfunc" id="6324939">len</span><span class="op" id="6324942">(</span><span class="ident" id="6324943">text</span><span class="op" id="6324947">)</span>&nbsp;<span class="op" id="6324949">&gt;</span>&nbsp;<span class="num" id="6324951">0</span>&nbsp;<span class="op" id="6324953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6324957">keyLen</span><span class="op" id="6324963">,</span>&nbsp;<span class="ident" id="6324965">n</span>&nbsp;<span class="op" id="6324967">:=</span>&nbsp;<span class="ident" id="6324970">readSize</span><span class="op" id="6324978">(</span><span class="ident" id="6324979">text</span><span class="op" id="6324983">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6324987">if</span>&nbsp;<span class="ident" id="6324990">n</span>&nbsp;<span class="op" id="6324992">==</span>&nbsp;<span class="num" id="6324995">0</span>&nbsp;<span class="op" id="6324997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325002">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325015">text</span>&nbsp;<span class="op" id="6325020">=</span>&nbsp;<span class="ident" id="6325022">text</span><span class="op" id="6325026">[</span><span class="ident" id="6325027">n</span><span class="op" id="6325028">:</span><span class="op" id="6325029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325033">valLen</span><span class="op" id="6325039">,</span>&nbsp;<span class="ident" id="6325041">n</span>&nbsp;<span class="op" id="6325043">:=</span>&nbsp;<span class="ident" id="6325046">readSize</span><span class="op" id="6325054">(</span><span class="ident" id="6325055">text</span><span class="op" id="6325059">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325063">if</span>&nbsp;<span class="ident" id="6325066">n</span>&nbsp;<span class="op" id="6325068">==</span>&nbsp;<span class="num" id="6325071">0</span>&nbsp;<span class="op" id="6325073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325078">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325091">text</span>&nbsp;<span class="op" id="6325096">=</span>&nbsp;<span class="ident" id="6325098">text</span><span class="op" id="6325102">[</span><span class="ident" id="6325103">n</span><span class="op" id="6325104">:</span><span class="op" id="6325105">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325109">key</span>&nbsp;<span class="op" id="6325113">:=</span>&nbsp;<span class="ident" id="6325116">readString</span><span class="op" id="6325126">(</span><span class="ident" id="6325127">text</span><span class="op" id="6325131">,</span>&nbsp;<span class="ident" id="6325133">keyLen</span><span class="op" id="6325139">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325143">text</span>&nbsp;<span class="op" id="6325148">=</span>&nbsp;<span class="ident" id="6325150">text</span><span class="op" id="6325154">[</span><span class="ident" id="6325155">keyLen</span><span class="op" id="6325161">:</span><span class="op" id="6325162">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325166">val</span>&nbsp;<span class="op" id="6325170">:=</span>&nbsp;<span class="ident" id="6325173">readString</span><span class="op" id="6325183">(</span><span class="ident" id="6325184">text</span><span class="op" id="6325188">,</span>&nbsp;<span class="ident" id="6325190">valLen</span><span class="op" id="6325196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325200">text</span>&nbsp;<span class="op" id="6325205">=</span>&nbsp;<span class="ident" id="6325207">text</span><span class="op" id="6325211">[</span><span class="ident" id="6325212">valLen</span><span class="op" id="6325218">:</span><span class="op" id="6325219">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325223">r</span><span class="op" id="6325224">.</span><span class="ident" id="6325225">params</span><span class="op" id="6325231">[</span><span class="ident" id="6325232">key</span><span class="op" id="6325235">]</span>&nbsp;<span class="op" id="6325237">=</span>&nbsp;<span class="ident" id="6325239">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325244">}</span><br>
<span class="lineno">65</span><span class="op" id="6325246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6325249">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6325293">type</span>&nbsp;<span class="ident" id="6325298">response</span>&nbsp;<span class="keyword" id="6325307">struct</span>&nbsp;<span class="op" id="6325314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325317">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325329">*</span><span class="ident" id="6325330">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325339">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325351">http</span><span class="op" id="6325355">.</span><span class="ident" id="6325356">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325364">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325376">*</span><span class="ident" id="6325377">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325388">wroteHeader</span>&nbsp;<span class="builtintype" id="6325400">bool</span><br>
<span class="lineno"></span><span class="op" id="6325405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6325408">func</span>&nbsp;<span class="ident" id="6325413">newResponse</span><span class="op" id="6325424">(</span><span class="ident" id="6325425">c</span>&nbsp;<span class="op" id="6325427">*</span><span class="ident" id="6325428">child</span><span class="op" id="6325433">,</span>&nbsp;<span class="ident" id="6325435">req</span>&nbsp;<span class="op" id="6325439">*</span><span class="ident" id="6325440">request</span><span class="op" id="6325447">)</span>&nbsp;<span class="op" id="6325449">*</span><span class="ident" id="6325450">response</span>&nbsp;<span class="op" id="6325459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325462">return</span>&nbsp;<span class="op" id="6325469">&amp;</span><span class="ident" id="6325470">response</span><span class="op" id="6325478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325482">req</span><span class="op" id="6325485">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325490">req</span><span class="op" id="6325493">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325497">header</span><span class="op" id="6325503">:</span>&nbsp;<span class="ident" id="6325505">http</span><span class="op" id="6325509">.</span><span class="ident" id="6325510">Header</span><span class="op" id="6325516">{</span><span class="op" id="6325517">}</span><span class="op" id="6325518">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325522">w</span><span class="op" id="6325523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325530">newWriter</span><span class="op" id="6325539">(</span><span class="ident" id="6325540">c</span><span class="op" id="6325541">.</span><span class="ident" id="6325542">conn</span><span class="op" id="6325546">,</span>&nbsp;<span class="ident" id="6325548">typeStdout</span><span class="op" id="6325558">,</span>&nbsp;<span class="ident" id="6325560">req</span><span class="op" id="6325563">.</span><span class="ident" id="6325564">reqId</span><span class="op" id="6325569">)</span><span class="op" id="6325570">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325573">}</span><br>
<span class="lineno"></span><span class="op" id="6325575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6325578">func</span>&nbsp;<span class="op" id="6325583">(</span><span class="ident" id="6325584">r</span>&nbsp;<span class="op" id="6325586">*</span><span class="ident" id="6325587">response</span><span class="op" id="6325595">)</span>&nbsp;<span class="ident" id="6325597">Header</span><span class="op" id="6325603">(</span><span class="op" id="6325604">)</span>&nbsp;<span class="ident" id="6325606">http</span><span class="op" id="6325610">.</span><span class="ident" id="6325611">Header</span>&nbsp;<span class="op" id="6325618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325621">return</span>&nbsp;<span class="ident" id="6325628">r</span><span class="op" id="6325629">.</span><span class="ident" id="6325630">header</span><br>
<span class="lineno">85</span><span class="op" id="6325637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6325640">func</span>&nbsp;<span class="op" id="6325645">(</span><span class="ident" id="6325646">r</span>&nbsp;<span class="op" id="6325648">*</span><span class="ident" id="6325649">response</span><span class="op" id="6325657">)</span>&nbsp;<span class="ident" id="6325659">Write</span><span class="op" id="6325664">(</span><span class="ident" id="6325665">data</span>&nbsp;<span class="op" id="6325670">[</span><span class="op" id="6325671">]</span><span class="builtintype" id="6325672">byte</span><span class="op" id="6325676">)</span>&nbsp;<span class="op" id="6325678">(</span><span class="builtintype" id="6325679">int</span><span class="op" id="6325682">,</span>&nbsp;<span class="builtintype" id="6325684">error</span><span class="op" id="6325689">)</span>&nbsp;<span class="op" id="6325691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325694">if</span>&nbsp;<span class="op" id="6325697">!</span><span class="ident" id="6325698">r</span><span class="op" id="6325699">.</span><span class="ident" id="6325700">wroteHeader</span>&nbsp;<span class="op" id="6325712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325716">r</span><span class="op" id="6325717">.</span><span class="ident" id="6325718">WriteHeader</span><span class="op" id="6325729">(</span><span class="ident" id="6325730">http</span><span class="op" id="6325734">.</span><span class="ident" id="6325735">StatusOK</span><span class="op" id="6325743">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325749">return</span>&nbsp;<span class="ident" id="6325756">r</span><span class="op" id="6325757">.</span><span class="ident" id="6325758">w</span><span class="op" id="6325759">.</span><span class="ident" id="6325760">Write</span><span class="op" id="6325765">(</span><span class="ident" id="6325766">data</span><span class="op" id="6325770">)</span><br>
<span class="lineno"></span><span class="op" id="6325772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6325775">func</span>&nbsp;<span class="op" id="6325780">(</span><span class="ident" id="6325781">r</span>&nbsp;<span class="op" id="6325783">*</span><span class="ident" id="6325784">response</span><span class="op" id="6325792">)</span>&nbsp;<span class="ident" id="6325794">WriteHeader</span><span class="op" id="6325805">(</span><span class="ident" id="6325806">code</span>&nbsp;<span class="builtintype" id="6325811">int</span><span class="op" id="6325814">)</span>&nbsp;<span class="op" id="6325816">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325819">if</span>&nbsp;<span class="ident" id="6325822">r</span><span class="op" id="6325823">.</span><span class="ident" id="6325824">wroteHeader</span>&nbsp;<span class="op" id="6325836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325840">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6325848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325851">r</span><span class="op" id="6325852">.</span><span class="ident" id="6325853">wroteHeader</span>&nbsp;<span class="op" id="6325865">=</span>&nbsp;<span class="builtintype" id="6325867">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6325873">if</span>&nbsp;<span class="ident" id="6325876">code</span>&nbsp;<span class="op" id="6325881">==</span>&nbsp;<span class="ident" id="6325884">http</span><span class="op" id="6325888">.</span><span class="ident" id="6325889">StatusNotModified</span>&nbsp;<span class="op" id="6325907">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6325911">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325936">r</span><span class="op" id="6325937">.</span><span class="ident" id="6325938">header</span><span class="op" id="6325944">.</span><span class="ident" id="6325945">Del</span><span class="op" id="6325948">(</span><span class="string" id="6325949">&#34;Content-Type&#34;</span><span class="op" id="6325963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6325967">r</span><span class="op" id="6325968">.</span><span class="ident" id="6325969">header</span><span class="op" id="6325975">.</span><span class="ident" id="6325976">Del</span><span class="op" id="6325979">(</span><span class="string" id="6325980">&#34;Content-Length&#34;</span><span class="op" id="6325996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326000">r</span><span class="op" id="6326001">.</span><span class="ident" id="6326002">header</span><span class="op" id="6326008">.</span><span class="ident" id="6326009">Del</span><span class="op" id="6326012">(</span><span class="string" id="6326013">&#34;Transfer-Encoding&#34;</span><span class="op" id="6326032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326035">}</span>&nbsp;<span class="keyword" id="6326037">else</span>&nbsp;<span class="keyword" id="6326042">if</span>&nbsp;<span class="ident" id="6326045">r</span><span class="op" id="6326046">.</span><span class="ident" id="6326047">header</span><span class="op" id="6326053">.</span><span class="ident" id="6326054">Get</span><span class="op" id="6326057">(</span><span class="string" id="6326058">&#34;Content-Type&#34;</span><span class="op" id="6326072">)</span>&nbsp;<span class="op" id="6326074">==</span>&nbsp;<span class="string" id="6326077">&#34;&#34;</span>&nbsp;<span class="op" id="6326080">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326084">r</span><span class="op" id="6326085">.</span><span class="ident" id="6326086">header</span><span class="op" id="6326092">.</span><span class="ident" id="6326093">Set</span><span class="op" id="6326096">(</span><span class="string" id="6326097">&#34;Content-Type&#34;</span><span class="op" id="6326111">,</span>&nbsp;<span class="string" id="6326113">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6326139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326146">if</span>&nbsp;<span class="ident" id="6326149">r</span><span class="op" id="6326150">.</span><span class="ident" id="6326151">header</span><span class="op" id="6326157">.</span><span class="ident" id="6326158">Get</span><span class="op" id="6326161">(</span><span class="string" id="6326162">&#34;Date&#34;</span><span class="op" id="6326168">)</span>&nbsp;<span class="op" id="6326170">==</span>&nbsp;<span class="string" id="6326173">&#34;&#34;</span>&nbsp;<span class="op" id="6326176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326180">r</span><span class="op" id="6326181">.</span><span class="ident" id="6326182">header</span><span class="op" id="6326188">.</span><span class="ident" id="6326189">Set</span><span class="op" id="6326192">(</span><span class="string" id="6326193">&#34;Date&#34;</span><span class="op" id="6326199">,</span>&nbsp;<span class="ident" id="6326201">time</span><span class="op" id="6326205">.</span><span class="ident" id="6326206">Now</span><span class="op" id="6326209">(</span><span class="op" id="6326210">)</span><span class="op" id="6326211">.</span><span class="ident" id="6326212">UTC</span><span class="op" id="6326215">(</span><span class="op" id="6326216">)</span><span class="op" id="6326217">.</span><span class="ident" id="6326218">Format</span><span class="op" id="6326224">(</span><span class="ident" id="6326225">http</span><span class="op" id="6326229">.</span><span class="ident" id="6326230">TimeFormat</span><span class="op" id="6326240">)</span><span class="op" id="6326241">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326248">fmt</span><span class="op" id="6326251">.</span><span class="ident" id="6326252">Fprintf</span><span class="op" id="6326259">(</span><span class="ident" id="6326260">r</span><span class="op" id="6326261">.</span><span class="ident" id="6326262">w</span><span class="op" id="6326263">,</span>&nbsp;<span class="string" id="6326265">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6326284">,</span>&nbsp;<span class="ident" id="6326286">code</span><span class="op" id="6326290">,</span>&nbsp;<span class="ident" id="6326292">http</span><span class="op" id="6326296">.</span><span class="ident" id="6326297">StatusText</span><span class="op" id="6326307">(</span><span class="ident" id="6326308">code</span><span class="op" id="6326312">)</span><span class="op" id="6326313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326316">r</span><span class="op" id="6326317">.</span><span class="ident" id="6326318">header</span><span class="op" id="6326324">.</span><span class="ident" id="6326325">Write</span><span class="op" id="6326330">(</span><span class="ident" id="6326331">r</span><span class="op" id="6326332">.</span><span class="ident" id="6326333">w</span><span class="op" id="6326334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326337">r</span><span class="op" id="6326338">.</span><span class="ident" id="6326339">w</span><span class="op" id="6326340">.</span><span class="ident" id="6326341">WriteString</span><span class="op" id="6326352">(</span><span class="string" id="6326353">&#34;\r\n&#34;</span><span class="op" id="6326359">)</span><br>
<span class="lineno">115</span><span class="op" id="6326361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6326364">func</span>&nbsp;<span class="op" id="6326369">(</span><span class="ident" id="6326370">r</span>&nbsp;<span class="op" id="6326372">*</span><span class="ident" id="6326373">response</span><span class="op" id="6326381">)</span>&nbsp;<span class="ident" id="6326383">Flush</span><span class="op" id="6326388">(</span><span class="op" id="6326389">)</span>&nbsp;<span class="op" id="6326391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326394">if</span>&nbsp;<span class="op" id="6326397">!</span><span class="ident" id="6326398">r</span><span class="op" id="6326399">.</span><span class="ident" id="6326400">wroteHeader</span>&nbsp;<span class="op" id="6326412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326416">r</span><span class="op" id="6326417">.</span><span class="ident" id="6326418">WriteHeader</span><span class="op" id="6326429">(</span><span class="ident" id="6326430">http</span><span class="op" id="6326434">.</span><span class="ident" id="6326435">StatusOK</span><span class="op" id="6326443">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326449">r</span><span class="op" id="6326450">.</span><span class="ident" id="6326451">w</span><span class="op" id="6326452">.</span><span class="ident" id="6326453">Flush</span><span class="op" id="6326458">(</span><span class="op" id="6326459">)</span><br>
<span class="lineno"></span><span class="op" id="6326461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6326464">func</span>&nbsp;<span class="op" id="6326469">(</span><span class="ident" id="6326470">r</span>&nbsp;<span class="op" id="6326472">*</span><span class="ident" id="6326473">response</span><span class="op" id="6326481">)</span>&nbsp;<span class="ident" id="6326483">Close</span><span class="op" id="6326488">(</span><span class="op" id="6326489">)</span>&nbsp;<span class="builtintype" id="6326491">error</span>&nbsp;<span class="op" id="6326497">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326500">r</span><span class="op" id="6326501">.</span><span class="ident" id="6326502">Flush</span><span class="op" id="6326507">(</span><span class="op" id="6326508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326511">return</span>&nbsp;<span class="ident" id="6326518">r</span><span class="op" id="6326519">.</span><span class="ident" id="6326520">w</span><span class="op" id="6326521">.</span><span class="ident" id="6326522">Close</span><span class="op" id="6326527">(</span><span class="op" id="6326528">)</span><br>
<span class="lineno"></span><span class="op" id="6326530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6326533">type</span>&nbsp;<span class="ident" id="6326538">child</span>&nbsp;<span class="keyword" id="6326544">struct</span>&nbsp;<span class="op" id="6326551">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326554">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326562">*</span><span class="ident" id="6326563">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326569">handler</span>&nbsp;<span class="ident" id="6326577">http</span><span class="op" id="6326581">.</span><span class="ident" id="6326582">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326592">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326601">sync</span><span class="op" id="6326605">.</span><span class="ident" id="6326606">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6326621">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326644">requests</span>&nbsp;<span class="keyword" id="6326653">map</span><span class="op" id="6326656">[</span><span class="builtintype" id="6326657">uint16</span><span class="op" id="6326663">]</span><span class="op" id="6326664">*</span><span class="ident" id="6326665">request</span>&nbsp;<span class="comment" id="6326673">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6326696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6326699">func</span>&nbsp;<span class="ident" id="6326704">newChild</span><span class="op" id="6326712">(</span><span class="ident" id="6326713">rwc</span>&nbsp;<span class="ident" id="6326717">io</span><span class="op" id="6326719">.</span><span class="ident" id="6326720">ReadWriteCloser</span><span class="op" id="6326735">,</span>&nbsp;<span class="ident" id="6326737">handler</span>&nbsp;<span class="ident" id="6326745">http</span><span class="op" id="6326749">.</span><span class="ident" id="6326750">Handler</span><span class="op" id="6326757">)</span>&nbsp;<span class="op" id="6326759">*</span><span class="ident" id="6326760">child</span>&nbsp;<span class="op" id="6326766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326769">return</span>&nbsp;<span class="op" id="6326776">&amp;</span><span class="ident" id="6326777">child</span><span class="op" id="6326782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326786">conn</span><span class="op" id="6326790">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326796">newConn</span><span class="op" id="6326803">(</span><span class="ident" id="6326804">rwc</span><span class="op" id="6326807">)</span><span class="op" id="6326808">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326812">handler</span><span class="op" id="6326819">:</span>&nbsp;&nbsp;<span class="ident" id="6326822">handler</span><span class="op" id="6326829">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6326833">requests</span><span class="op" id="6326841">:</span>&nbsp;<span class="builtinfunc" id="6326843">make</span><span class="op" id="6326847">(</span><span class="keyword" id="6326848">map</span><span class="op" id="6326851">[</span><span class="builtintype" id="6326852">uint16</span><span class="op" id="6326858">]</span><span class="op" id="6326859">*</span><span class="ident" id="6326860">request</span><span class="op" id="6326867">)</span><span class="op" id="6326868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6326871">}</span><br>
<span class="lineno"></span><span class="op" id="6326873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6326876">func</span>&nbsp;<span class="op" id="6326881">(</span><span class="ident" id="6326882">c</span>&nbsp;<span class="op" id="6326884">*</span><span class="ident" id="6326885">child</span><span class="op" id="6326890">)</span>&nbsp;<span class="ident" id="6326892">serve</span><span class="op" id="6326897">(</span><span class="op" id="6326898">)</span>&nbsp;<span class="op" id="6326900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326903">defer</span>&nbsp;<span class="ident" id="6326909">c</span><span class="op" id="6326910">.</span><span class="ident" id="6326911">conn</span><span class="op" id="6326915">.</span><span class="ident" id="6326916">Close</span><span class="op" id="6326921">(</span><span class="op" id="6326922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326925">var</span>&nbsp;<span class="ident" id="6326929">rec</span>&nbsp;<span class="ident" id="6326933">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326941">for</span>&nbsp;<span class="op" id="6326945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326949">if</span>&nbsp;<span class="ident" id="6326952">err</span>&nbsp;<span class="op" id="6326956">:=</span>&nbsp;<span class="ident" id="6326959">rec</span><span class="op" id="6326962">.</span><span class="ident" id="6326963">read</span><span class="op" id="6326967">(</span><span class="ident" id="6326968">c</span><span class="op" id="6326969">.</span><span class="ident" id="6326970">conn</span><span class="op" id="6326974">.</span><span class="ident" id="6326975">rwc</span><span class="op" id="6326978">)</span><span class="op" id="6326979">;</span>&nbsp;<span class="ident" id="6326981">err</span>&nbsp;<span class="op" id="6326985">!=</span>&nbsp;<span class="builtintype" id="6326988">nil</span>&nbsp;<span class="op" id="6326992">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6326997">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327010">if</span>&nbsp;<span class="ident" id="6327013">err</span>&nbsp;<span class="op" id="6327017">:=</span>&nbsp;<span class="ident" id="6327020">c</span><span class="op" id="6327021">.</span><span class="ident" id="6327022">handleRecord</span><span class="op" id="6327034">(</span><span class="op" id="6327035">&amp;</span><span class="ident" id="6327036">rec</span><span class="op" id="6327039">)</span><span class="op" id="6327040">;</span>&nbsp;<span class="ident" id="6327042">err</span>&nbsp;<span class="op" id="6327046">!=</span>&nbsp;<span class="builtintype" id="6327049">nil</span>&nbsp;<span class="op" id="6327053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327058">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327067">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327070">}</span><br>
<span class="lineno"></span><span class="op" id="6327072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6327075">var</span>&nbsp;<span class="ident" id="6327079">errCloseConn</span>&nbsp;<span class="op" id="6327092">=</span>&nbsp;<span class="ident" id="6327094">errors</span><span class="op" id="6327100">.</span><span class="ident" id="6327101">New</span><span class="op" id="6327104">(</span><span class="string" id="6327105">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6327140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6327143">var</span>&nbsp;<span class="ident" id="6327147">emptyBody</span>&nbsp;<span class="op" id="6327157">=</span>&nbsp;<span class="ident" id="6327159">ioutil</span><span class="op" id="6327165">.</span><span class="ident" id="6327166">NopCloser</span><span class="op" id="6327175">(</span><span class="ident" id="6327176">strings</span><span class="op" id="6327183">.</span><span class="ident" id="6327184">NewReader</span><span class="op" id="6327193">(</span><span class="string" id="6327194">&#34;&#34;</span><span class="op" id="6327196">)</span><span class="op" id="6327197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6327200">func</span>&nbsp;<span class="op" id="6327205">(</span><span class="ident" id="6327206">c</span>&nbsp;<span class="op" id="6327208">*</span><span class="ident" id="6327209">child</span><span class="op" id="6327214">)</span>&nbsp;<span class="ident" id="6327216">handleRecord</span><span class="op" id="6327228">(</span><span class="ident" id="6327229">rec</span>&nbsp;<span class="op" id="6327233">*</span><span class="ident" id="6327234">record</span><span class="op" id="6327240">)</span>&nbsp;<span class="builtintype" id="6327242">error</span>&nbsp;<span class="op" id="6327248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327251">c</span><span class="op" id="6327252">.</span><span class="ident" id="6327253">mu</span><span class="op" id="6327255">.</span><span class="ident" id="6327256">Lock</span><span class="op" id="6327260">(</span><span class="op" id="6327261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327264">req</span><span class="op" id="6327267">,</span>&nbsp;<span class="ident" id="6327269">ok</span>&nbsp;<span class="op" id="6327272">:=</span>&nbsp;<span class="ident" id="6327275">c</span><span class="op" id="6327276">.</span><span class="ident" id="6327277">requests</span><span class="op" id="6327285">[</span><span class="ident" id="6327286">rec</span><span class="op" id="6327289">.</span><span class="ident" id="6327290">h</span><span class="op" id="6327291">.</span><span class="ident" id="6327292">Id</span><span class="op" id="6327294">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327297">c</span><span class="op" id="6327298">.</span><span class="ident" id="6327299">mu</span><span class="op" id="6327301">.</span><span class="ident" id="6327302">Unlock</span><span class="op" id="6327308">(</span><span class="op" id="6327309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327312">if</span>&nbsp;<span class="op" id="6327315">!</span><span class="ident" id="6327316">ok</span>&nbsp;<span class="op" id="6327319">&amp;&amp;</span>&nbsp;<span class="ident" id="6327322">rec</span><span class="op" id="6327325">.</span><span class="ident" id="6327326">h</span><span class="op" id="6327327">.</span><span class="ident" id="6327328">Type</span>&nbsp;<span class="op" id="6327333">!=</span>&nbsp;<span class="ident" id="6327336">typeBeginRequest</span>&nbsp;<span class="op" id="6327353">&amp;&amp;</span>&nbsp;<span class="ident" id="6327356">rec</span><span class="op" id="6327359">.</span><span class="ident" id="6327360">h</span><span class="op" id="6327361">.</span><span class="ident" id="6327362">Type</span>&nbsp;<span class="op" id="6327367">!=</span>&nbsp;<span class="ident" id="6327370">typeGetValues</span>&nbsp;<span class="op" id="6327384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6327388">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327438">return</span>&nbsp;<span class="builtintype" id="6327445">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327450">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327454">switch</span>&nbsp;<span class="ident" id="6327461">rec</span><span class="op" id="6327464">.</span><span class="ident" id="6327465">h</span><span class="op" id="6327466">.</span><span class="ident" id="6327467">Type</span>&nbsp;<span class="op" id="6327472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327475">case</span>&nbsp;<span class="ident" id="6327480">typeBeginRequest</span><span class="op" id="6327496">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327500">if</span>&nbsp;<span class="ident" id="6327503">req</span>&nbsp;<span class="op" id="6327507">!=</span>&nbsp;<span class="builtintype" id="6327510">nil</span>&nbsp;<span class="op" id="6327514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6327519">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6327582">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327633">return</span>&nbsp;<span class="ident" id="6327640">errors</span><span class="op" id="6327646">.</span><span class="ident" id="6327647">New</span><span class="op" id="6327650">(</span><span class="string" id="6327651">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6327696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327705">var</span>&nbsp;<span class="ident" id="6327709">br</span>&nbsp;<span class="ident" id="6327712">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327727">if</span>&nbsp;<span class="ident" id="6327730">err</span>&nbsp;<span class="op" id="6327734">:=</span>&nbsp;<span class="ident" id="6327737">br</span><span class="op" id="6327739">.</span><span class="ident" id="6327740">read</span><span class="op" id="6327744">(</span><span class="ident" id="6327745">rec</span><span class="op" id="6327748">.</span><span class="ident" id="6327749">content</span><span class="op" id="6327756">(</span><span class="op" id="6327757">)</span><span class="op" id="6327758">)</span><span class="op" id="6327759">;</span>&nbsp;<span class="ident" id="6327761">err</span>&nbsp;<span class="op" id="6327765">!=</span>&nbsp;<span class="builtintype" id="6327768">nil</span>&nbsp;<span class="op" id="6327772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327777">return</span>&nbsp;<span class="ident" id="6327784">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327794">if</span>&nbsp;<span class="ident" id="6327797">br</span><span class="op" id="6327799">.</span><span class="ident" id="6327800">role</span>&nbsp;<span class="op" id="6327805">!=</span>&nbsp;<span class="ident" id="6327808">roleResponder</span>&nbsp;<span class="op" id="6327822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327827">c</span><span class="op" id="6327828">.</span><span class="ident" id="6327829">conn</span><span class="op" id="6327833">.</span><span class="ident" id="6327834">writeEndRequest</span><span class="op" id="6327849">(</span><span class="ident" id="6327850">rec</span><span class="op" id="6327853">.</span><span class="ident" id="6327854">h</span><span class="op" id="6327855">.</span><span class="ident" id="6327856">Id</span><span class="op" id="6327858">,</span>&nbsp;<span class="num" id="6327860">0</span><span class="op" id="6327861">,</span>&nbsp;<span class="ident" id="6327863">statusUnknownRole</span><span class="op" id="6327880">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6327885">return</span>&nbsp;<span class="builtintype" id="6327892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6327898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327902">req</span>&nbsp;<span class="op" id="6327906">=</span>&nbsp;<span class="ident" id="6327908">newRequest</span><span class="op" id="6327918">(</span><span class="ident" id="6327919">rec</span><span class="op" id="6327922">.</span><span class="ident" id="6327923">h</span><span class="op" id="6327924">.</span><span class="ident" id="6327925">Id</span><span class="op" id="6327927">,</span>&nbsp;<span class="ident" id="6327929">br</span><span class="op" id="6327931">.</span><span class="ident" id="6327932">flags</span><span class="op" id="6327937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327941">c</span><span class="op" id="6327942">.</span><span class="ident" id="6327943">mu</span><span class="op" id="6327945">.</span><span class="ident" id="6327946">Lock</span><span class="op" id="6327950">(</span><span class="op" id="6327951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327955">c</span><span class="op" id="6327956">.</span><span class="ident" id="6327957">requests</span><span class="op" id="6327965">[</span><span class="ident" id="6327966">rec</span><span class="op" id="6327969">.</span><span class="ident" id="6327970">h</span><span class="op" id="6327971">.</span><span class="ident" id="6327972">Id</span><span class="op" id="6327974">]</span>&nbsp;<span class="op" id="6327976">=</span>&nbsp;<span class="ident" id="6327978">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6327984">c</span><span class="op" id="6327985">.</span><span class="ident" id="6327986">mu</span><span class="op" id="6327988">.</span><span class="ident" id="6327989">Unlock</span><span class="op" id="6327995">(</span><span class="op" id="6327996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328000">return</span>&nbsp;<span class="builtintype" id="6328007">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328012">case</span>&nbsp;<span class="ident" id="6328017">typeParams</span><span class="op" id="6328027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328031">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328102">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328175">if</span>&nbsp;<span class="builtinfunc" id="6328178">len</span><span class="op" id="6328181">(</span><span class="ident" id="6328182">rec</span><span class="op" id="6328185">.</span><span class="ident" id="6328186">content</span><span class="op" id="6328193">(</span><span class="op" id="6328194">)</span><span class="op" id="6328195">)</span>&nbsp;<span class="op" id="6328197">&gt;</span>&nbsp;<span class="num" id="6328199">0</span>&nbsp;<span class="op" id="6328201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328206">req</span><span class="op" id="6328209">.</span><span class="ident" id="6328210">rawParams</span>&nbsp;<span class="op" id="6328220">=</span>&nbsp;<span class="builtinfunc" id="6328222">append</span><span class="op" id="6328228">(</span><span class="ident" id="6328229">req</span><span class="op" id="6328232">.</span><span class="ident" id="6328233">rawParams</span><span class="op" id="6328242">,</span>&nbsp;<span class="ident" id="6328244">rec</span><span class="op" id="6328247">.</span><span class="ident" id="6328248">content</span><span class="op" id="6328255">(</span><span class="op" id="6328256">)</span><span class="op" id="6328257">...</span><span class="op" id="6328260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328265">return</span>&nbsp;<span class="builtintype" id="6328272">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328282">req</span><span class="op" id="6328285">.</span><span class="ident" id="6328286">parseParams</span><span class="op" id="6328297">(</span><span class="op" id="6328298">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328302">return</span>&nbsp;<span class="builtintype" id="6328309">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328314">case</span>&nbsp;<span class="ident" id="6328319">typeStdin</span><span class="op" id="6328328">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328332">content</span>&nbsp;<span class="op" id="6328340">:=</span>&nbsp;<span class="ident" id="6328343">rec</span><span class="op" id="6328346">.</span><span class="ident" id="6328347">content</span><span class="op" id="6328354">(</span><span class="op" id="6328355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328359">if</span>&nbsp;<span class="ident" id="6328362">req</span><span class="op" id="6328365">.</span><span class="ident" id="6328366">pw</span>&nbsp;<span class="op" id="6328369">==</span>&nbsp;<span class="builtintype" id="6328372">nil</span>&nbsp;<span class="op" id="6328376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328381">var</span>&nbsp;<span class="ident" id="6328385">body</span>&nbsp;<span class="ident" id="6328390">io</span><span class="op" id="6328392">.</span><span class="ident" id="6328393">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328407">if</span>&nbsp;<span class="builtinfunc" id="6328410">len</span><span class="op" id="6328413">(</span><span class="ident" id="6328414">content</span><span class="op" id="6328421">)</span>&nbsp;<span class="op" id="6328423">&gt;</span>&nbsp;<span class="num" id="6328425">0</span>&nbsp;<span class="op" id="6328427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328433">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328497">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328540">body</span><span class="op" id="6328544">,</span>&nbsp;<span class="ident" id="6328546">req</span><span class="op" id="6328549">.</span><span class="ident" id="6328550">pw</span>&nbsp;<span class="op" id="6328553">=</span>&nbsp;<span class="ident" id="6328555">io</span><span class="op" id="6328557">.</span><span class="ident" id="6328558">Pipe</span><span class="op" id="6328562">(</span><span class="op" id="6328563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328568">}</span>&nbsp;<span class="keyword" id="6328570">else</span>&nbsp;<span class="op" id="6328575">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328581">body</span>&nbsp;<span class="op" id="6328586">=</span>&nbsp;<span class="ident" id="6328588">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328606">go</span>&nbsp;<span class="ident" id="6328609">c</span><span class="op" id="6328610">.</span><span class="ident" id="6328611">serveRequest</span><span class="op" id="6328623">(</span><span class="ident" id="6328624">req</span><span class="op" id="6328627">,</span>&nbsp;<span class="ident" id="6328629">body</span><span class="op" id="6328633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328641">if</span>&nbsp;<span class="builtinfunc" id="6328644">len</span><span class="op" id="6328647">(</span><span class="ident" id="6328648">content</span><span class="op" id="6328655">)</span>&nbsp;<span class="op" id="6328657">&gt;</span>&nbsp;<span class="num" id="6328659">0</span>&nbsp;<span class="op" id="6328661">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328666">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6328734">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328797">req</span><span class="op" id="6328800">.</span><span class="ident" id="6328801">pw</span><span class="op" id="6328803">.</span><span class="ident" id="6328804">Write</span><span class="op" id="6328809">(</span><span class="ident" id="6328810">content</span><span class="op" id="6328817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328821">}</span>&nbsp;<span class="keyword" id="6328823">else</span>&nbsp;<span class="keyword" id="6328828">if</span>&nbsp;<span class="ident" id="6328831">req</span><span class="op" id="6328834">.</span><span class="ident" id="6328835">pw</span>&nbsp;<span class="op" id="6328838">!=</span>&nbsp;<span class="builtintype" id="6328841">nil</span>&nbsp;<span class="op" id="6328845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328850">req</span><span class="op" id="6328853">.</span><span class="ident" id="6328854">pw</span><span class="op" id="6328856">.</span><span class="ident" id="6328857">Close</span><span class="op" id="6328862">(</span><span class="op" id="6328863">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6328867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328871">return</span>&nbsp;<span class="builtintype" id="6328878">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6328883">case</span>&nbsp;<span class="ident" id="6328888">typeGetValues</span><span class="op" id="6328901">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328905">values</span>&nbsp;<span class="op" id="6328912">:=</span>&nbsp;<span class="keyword" id="6328915">map</span><span class="op" id="6328918">[</span><span class="builtintype" id="6328919">string</span><span class="op" id="6328925">]</span><span class="builtintype" id="6328926">string</span><span class="op" id="6328932">{</span><span class="string" id="6328933">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6328950">:</span>&nbsp;<span class="string" id="6328952">&#34;1&#34;</span><span class="op" id="6328955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6328959">c</span><span class="op" id="6328960">.</span><span class="ident" id="6328961">conn</span><span class="op" id="6328965">.</span><span class="ident" id="6328966">writePairs</span><span class="op" id="6328976">(</span><span class="ident" id="6328977">typeGetValuesResult</span><span class="op" id="6328996">,</span>&nbsp;<span class="num" id="6328998">0</span><span class="op" id="6328999">,</span>&nbsp;<span class="ident" id="6329001">values</span><span class="op" id="6329007">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329011">return</span>&nbsp;<span class="builtintype" id="6329018">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329023">case</span>&nbsp;<span class="ident" id="6329028">typeData</span><span class="op" id="6329036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6329040">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329107">return</span>&nbsp;<span class="builtintype" id="6329114">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329119">case</span>&nbsp;<span class="ident" id="6329124">typeAbortRequest</span><span class="op" id="6329140">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6329144">println</span><span class="op" id="6329151">(</span><span class="string" id="6329152">&#34;abort&#34;</span><span class="op" id="6329159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329163">c</span><span class="op" id="6329164">.</span><span class="ident" id="6329165">mu</span><span class="op" id="6329167">.</span><span class="ident" id="6329168">Lock</span><span class="op" id="6329172">(</span><span class="op" id="6329173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6329177">delete</span><span class="op" id="6329183">(</span><span class="ident" id="6329184">c</span><span class="op" id="6329185">.</span><span class="ident" id="6329186">requests</span><span class="op" id="6329194">,</span>&nbsp;<span class="ident" id="6329196">rec</span><span class="op" id="6329199">.</span><span class="ident" id="6329200">h</span><span class="op" id="6329201">.</span><span class="ident" id="6329202">Id</span><span class="op" id="6329204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329208">c</span><span class="op" id="6329209">.</span><span class="ident" id="6329210">mu</span><span class="op" id="6329212">.</span><span class="ident" id="6329213">Unlock</span><span class="op" id="6329219">(</span><span class="op" id="6329220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329224">c</span><span class="op" id="6329225">.</span><span class="ident" id="6329226">conn</span><span class="op" id="6329230">.</span><span class="ident" id="6329231">writeEndRequest</span><span class="op" id="6329246">(</span><span class="ident" id="6329247">rec</span><span class="op" id="6329250">.</span><span class="ident" id="6329251">h</span><span class="op" id="6329252">.</span><span class="ident" id="6329253">Id</span><span class="op" id="6329255">,</span>&nbsp;<span class="num" id="6329257">0</span><span class="op" id="6329258">,</span>&nbsp;<span class="ident" id="6329260">statusRequestComplete</span><span class="op" id="6329281">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329285">if</span>&nbsp;<span class="op" id="6329288">!</span><span class="ident" id="6329289">req</span><span class="op" id="6329292">.</span><span class="ident" id="6329293">keepConn</span>&nbsp;<span class="op" id="6329302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6329307">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329347">return</span>&nbsp;<span class="ident" id="6329354">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329373">return</span>&nbsp;<span class="builtintype" id="6329380">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329385">default</span><span class="op" id="6329392">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329396">b</span>&nbsp;<span class="op" id="6329398">:=</span>&nbsp;<span class="builtinfunc" id="6329401">make</span><span class="op" id="6329405">(</span><span class="op" id="6329406">[</span><span class="op" id="6329407">]</span><span class="builtintype" id="6329408">byte</span><span class="op" id="6329412">,</span>&nbsp;<span class="num" id="6329414">8</span><span class="op" id="6329415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329419">b</span><span class="op" id="6329420">[</span><span class="num" id="6329421">0</span><span class="op" id="6329422">]</span>&nbsp;<span class="op" id="6329424">=</span>&nbsp;<span class="builtintype" id="6329426">byte</span><span class="op" id="6329430">(</span><span class="ident" id="6329431">rec</span><span class="op" id="6329434">.</span><span class="ident" id="6329435">h</span><span class="op" id="6329436">.</span><span class="ident" id="6329437">Type</span><span class="op" id="6329441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329445">c</span><span class="op" id="6329446">.</span><span class="ident" id="6329447">conn</span><span class="op" id="6329451">.</span><span class="ident" id="6329452">writeRecord</span><span class="op" id="6329463">(</span><span class="ident" id="6329464">typeUnknownType</span><span class="op" id="6329479">,</span>&nbsp;<span class="num" id="6329481">0</span><span class="op" id="6329482">,</span>&nbsp;<span class="ident" id="6329484">b</span><span class="op" id="6329485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329489">return</span>&nbsp;<span class="builtintype" id="6329496">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329501">}</span><br>
<span class="lineno"></span><span class="op" id="6329503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6329506">func</span>&nbsp;<span class="op" id="6329511">(</span><span class="ident" id="6329512">c</span>&nbsp;<span class="op" id="6329514">*</span><span class="ident" id="6329515">child</span><span class="op" id="6329520">)</span>&nbsp;<span class="ident" id="6329522">serveRequest</span><span class="op" id="6329534">(</span><span class="ident" id="6329535">req</span>&nbsp;<span class="op" id="6329539">*</span><span class="ident" id="6329540">request</span><span class="op" id="6329547">,</span>&nbsp;<span class="ident" id="6329549">body</span>&nbsp;<span class="ident" id="6329554">io</span><span class="op" id="6329556">.</span><span class="ident" id="6329557">ReadCloser</span><span class="op" id="6329567">)</span>&nbsp;<span class="op" id="6329569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329572">r</span>&nbsp;<span class="op" id="6329574">:=</span>&nbsp;<span class="ident" id="6329577">newResponse</span><span class="op" id="6329588">(</span><span class="ident" id="6329589">c</span><span class="op" id="6329590">,</span>&nbsp;<span class="ident" id="6329592">req</span><span class="op" id="6329595">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329598">httpReq</span><span class="op" id="6329605">,</span>&nbsp;<span class="ident" id="6329607">err</span>&nbsp;<span class="op" id="6329611">:=</span>&nbsp;<span class="ident" id="6329614">cgi</span><span class="op" id="6329617">.</span><span class="ident" id="6329618">RequestFromMap</span><span class="op" id="6329632">(</span><span class="ident" id="6329633">req</span><span class="op" id="6329636">.</span><span class="ident" id="6329637">params</span><span class="op" id="6329643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6329646">if</span>&nbsp;<span class="ident" id="6329649">err</span>&nbsp;<span class="op" id="6329653">!=</span>&nbsp;<span class="builtintype" id="6329656">nil</span>&nbsp;<span class="op" id="6329660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6329664">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329708">r</span><span class="op" id="6329709">.</span><span class="ident" id="6329710">WriteHeader</span><span class="op" id="6329721">(</span><span class="ident" id="6329722">http</span><span class="op" id="6329726">.</span><span class="ident" id="6329727">StatusInternalServerError</span><span class="op" id="6329752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329756">c</span><span class="op" id="6329757">.</span><span class="ident" id="6329758">conn</span><span class="op" id="6329762">.</span><span class="ident" id="6329763">writeRecord</span><span class="op" id="6329774">(</span><span class="ident" id="6329775">typeStderr</span><span class="op" id="6329785">,</span>&nbsp;<span class="ident" id="6329787">req</span><span class="op" id="6329790">.</span><span class="ident" id="6329791">reqId</span><span class="op" id="6329796">,</span>&nbsp;<span class="op" id="6329798">[</span><span class="op" id="6329799">]</span><span class="builtintype" id="6329800">byte</span><span class="op" id="6329804">(</span><span class="ident" id="6329805">err</span><span class="op" id="6329808">.</span><span class="ident" id="6329809">Error</span><span class="op" id="6329814">(</span><span class="op" id="6329815">)</span><span class="op" id="6329816">)</span><span class="op" id="6329817">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329820">}</span>&nbsp;<span class="keyword" id="6329822">else</span>&nbsp;<span class="op" id="6329827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329831">httpReq</span><span class="op" id="6329838">.</span><span class="ident" id="6329839">Body</span>&nbsp;<span class="op" id="6329844">=</span>&nbsp;<span class="ident" id="6329846">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329853">c</span><span class="op" id="6329854">.</span><span class="ident" id="6329855">handler</span><span class="op" id="6329862">.</span><span class="ident" id="6329863">ServeHTTP</span><span class="op" id="6329872">(</span><span class="ident" id="6329873">r</span><span class="op" id="6329874">,</span>&nbsp;<span class="ident" id="6329876">httpReq</span><span class="op" id="6329883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6329886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329889">r</span><span class="op" id="6329890">.</span><span class="ident" id="6329891">Close</span><span class="op" id="6329896">(</span><span class="op" id="6329897">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329900">c</span><span class="op" id="6329901">.</span><span class="ident" id="6329902">mu</span><span class="op" id="6329904">.</span><span class="ident" id="6329905">Lock</span><span class="op" id="6329909">(</span><span class="op" id="6329910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6329913">delete</span><span class="op" id="6329919">(</span><span class="ident" id="6329920">c</span><span class="op" id="6329921">.</span><span class="ident" id="6329922">requests</span><span class="op" id="6329930">,</span>&nbsp;<span class="ident" id="6329932">req</span><span class="op" id="6329935">.</span><span class="ident" id="6329936">reqId</span><span class="op" id="6329941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329944">c</span><span class="op" id="6329945">.</span><span class="ident" id="6329946">mu</span><span class="op" id="6329948">.</span><span class="ident" id="6329949">Unlock</span><span class="op" id="6329955">(</span><span class="op" id="6329956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6329959">c</span><span class="op" id="6329960">.</span><span class="ident" id="6329961">conn</span><span class="op" id="6329965">.</span><span class="ident" id="6329966">writeEndRequest</span><span class="op" id="6329981">(</span><span class="ident" id="6329982">req</span><span class="op" id="6329985">.</span><span class="ident" id="6329986">reqId</span><span class="op" id="6329991">,</span>&nbsp;<span class="num" id="6329993">0</span><span class="op" id="6329994">,</span>&nbsp;<span class="ident" id="6329996">statusRequestComplete</span><span class="op" id="6330017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330021">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330085">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330146">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330201">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330259">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330315">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6330373">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330412">io</span><span class="op" id="6330414">.</span><span class="ident" id="6330415">CopyN</span><span class="op" id="6330420">(</span><span class="ident" id="6330421">ioutil</span><span class="op" id="6330427">.</span><span class="ident" id="6330428">Discard</span><span class="op" id="6330435">,</span>&nbsp;<span class="ident" id="6330437">body</span><span class="op" id="6330441">,</span>&nbsp;<span class="num" id="6330443">100</span><span class="op" id="6330446">&lt;&lt;</span><span class="num" id="6330448">20</span><span class="op" id="6330450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330453">body</span><span class="op" id="6330457">.</span><span class="ident" id="6330458">Close</span><span class="op" id="6330463">(</span><span class="op" id="6330464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330468">if</span>&nbsp;<span class="op" id="6330471">!</span><span class="ident" id="6330472">req</span><span class="op" id="6330475">.</span><span class="ident" id="6330476">keepConn</span>&nbsp;<span class="op" id="6330485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330489">c</span><span class="op" id="6330490">.</span><span class="ident" id="6330491">conn</span><span class="op" id="6330495">.</span><span class="ident" id="6330496">Close</span><span class="op" id="6330501">(</span><span class="op" id="6330502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330505">}</span><br>
<span class="lineno"></span><span class="op" id="6330507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6330510">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6330590">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6330665">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6330686">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6330743">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6330795">func</span>&nbsp;<span class="ident" id="6330800">Serve</span><span class="op" id="6330805">(</span><span class="ident" id="6330806">l</span>&nbsp;<span class="ident" id="6330808">net</span><span class="op" id="6330811">.</span><span class="ident" id="6330812">Listener</span><span class="op" id="6330820">,</span>&nbsp;<span class="ident" id="6330822">handler</span>&nbsp;<span class="ident" id="6330830">http</span><span class="op" id="6330834">.</span><span class="ident" id="6330835">Handler</span><span class="op" id="6330842">)</span>&nbsp;<span class="builtintype" id="6330844">error</span>&nbsp;<span class="op" id="6330850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330853">if</span>&nbsp;<span class="ident" id="6330856">l</span>&nbsp;<span class="op" id="6330858">==</span>&nbsp;<span class="builtintype" id="6330861">nil</span>&nbsp;<span class="op" id="6330865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330869">var</span>&nbsp;<span class="ident" id="6330873">err</span>&nbsp;<span class="builtintype" id="6330877">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6330885">l</span><span class="op" id="6330886">,</span>&nbsp;<span class="ident" id="6330888">err</span>&nbsp;<span class="op" id="6330892">=</span>&nbsp;<span class="ident" id="6330894">net</span><span class="op" id="6330897">.</span><span class="ident" id="6330898">FileListener</span><span class="op" id="6330910">(</span><span class="ident" id="6330911">os</span><span class="op" id="6330913">.</span><span class="ident" id="6330914">Stdin</span><span class="op" id="6330919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330923">if</span>&nbsp;<span class="ident" id="6330926">err</span>&nbsp;<span class="op" id="6330930">!=</span>&nbsp;<span class="builtintype" id="6330933">nil</span>&nbsp;<span class="op" id="6330937">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330942">return</span>&nbsp;<span class="ident" id="6330949">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330959">defer</span>&nbsp;<span class="ident" id="6330965">l</span><span class="op" id="6330966">.</span><span class="ident" id="6330967">Close</span><span class="op" id="6330972">(</span><span class="op" id="6330973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6330976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6330979">if</span>&nbsp;<span class="ident" id="6330982">handler</span>&nbsp;<span class="op" id="6330990">==</span>&nbsp;<span class="builtintype" id="6330993">nil</span>&nbsp;<span class="op" id="6330997">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331001">handler</span>&nbsp;<span class="op" id="6331009">=</span>&nbsp;<span class="ident" id="6331011">http</span><span class="op" id="6331015">.</span><span class="ident" id="6331016">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331036">for</span>&nbsp;<span class="op" id="6331040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331044">rw</span><span class="op" id="6331046">,</span>&nbsp;<span class="ident" id="6331048">err</span>&nbsp;<span class="op" id="6331052">:=</span>&nbsp;<span class="ident" id="6331055">l</span><span class="op" id="6331056">.</span><span class="ident" id="6331057">Accept</span><span class="op" id="6331063">(</span><span class="op" id="6331064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331068">if</span>&nbsp;<span class="ident" id="6331071">err</span>&nbsp;<span class="op" id="6331075">!=</span>&nbsp;<span class="builtintype" id="6331078">nil</span>&nbsp;<span class="op" id="6331082">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331087">return</span>&nbsp;<span class="ident" id="6331094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6331104">c</span>&nbsp;<span class="op" id="6331106">:=</span>&nbsp;<span class="ident" id="6331109">newChild</span><span class="op" id="6331117">(</span><span class="ident" id="6331118">rw</span><span class="op" id="6331120">,</span>&nbsp;<span class="ident" id="6331122">handler</span><span class="op" id="6331129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6331133">go</span>&nbsp;<span class="ident" id="6331136">c</span><span class="op" id="6331137">.</span><span class="ident" id="6331138">serve</span><span class="op" id="6331143">(</span><span class="op" id="6331144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6331147">}</span><br>
<span class="lineno">305</span><span class="op" id="6331149">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
