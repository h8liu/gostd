<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4130917">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4130972">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4131026">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4131077">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4131109">package</span>&nbsp;<span class="ident" id="4131117">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4131123">import</span>&nbsp;<span class="op" id="4131130">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131133">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131142">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131156">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131166">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131173">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131179">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131192">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131199">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131206">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131217">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131223">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131231">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131242">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131253">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131264">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131272">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4131287">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4131294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4131297">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="4131338">var</span>&nbsp;<span class="op" id="4131342">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4131345">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="4131364">=</span>&nbsp;<span class="ident" id="4131366">errors</span><span class="op" id="4131372">.</span><span class="ident" id="4131373">New</span><span class="op" id="4131376">(</span><span class="string" id="4131377">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="4131408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4131411">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="4131430">=</span>&nbsp;<span class="ident" id="4131432">errors</span><span class="op" id="4131438">.</span><span class="ident" id="4131439">New</span><span class="op" id="4131442">(</span><span class="string" id="4131443">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="4131509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4131512">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4131531">=</span>&nbsp;<span class="ident" id="4131533">errors</span><span class="op" id="4131539">.</span><span class="ident" id="4131540">New</span><span class="op" id="4131543">(</span><span class="string" id="4131544">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="4131568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4131571">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4131590">=</span>&nbsp;<span class="ident" id="4131592">errors</span><span class="op" id="4131598">.</span><span class="ident" id="4131599">New</span><span class="op" id="4131602">(</span><span class="string" id="4131603">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="4131659">)</span><br>
<span class="lineno">35</span><span class="op" id="4131661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4131664">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4131717">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="4131769">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="4131792">//</span><br>
<span class="lineno"></span><span class="comment" id="4131795">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4131866">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4131934">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4131997">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="4132016">//</span><br>
<span class="lineno"></span><span class="comment" id="4132019">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="4132088">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4132156">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="4132226">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="4132258">//</span><br>
<span class="lineno"></span><span class="keyword" id="4132261">type</span>&nbsp;<span class="ident" id="4132266">Handler</span>&nbsp;<span class="keyword" id="4132274">interface</span>&nbsp;<span class="op" id="4132284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4132287">ServeHTTP</span><span class="op" id="4132296">(</span><span class="ident" id="4132297">ResponseWriter</span><span class="op" id="4132311">,</span>&nbsp;<span class="op" id="4132313">*</span><span class="ident" id="4132314">Request</span><span class="op" id="4132321">)</span><br>
<span class="lineno"></span><span class="op" id="4132323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4132326">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4132386">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4132417">type</span>&nbsp;<span class="ident" id="4132422">ResponseWriter</span>&nbsp;<span class="keyword" id="4132437">interface</span>&nbsp;<span class="op" id="4132447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132450">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132518">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132585">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4132600">Header</span><span class="op" id="4132606">(</span><span class="op" id="4132607">)</span>&nbsp;<span class="ident" id="4132609">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132618">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132688">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132771">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132834">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4132912">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4132976">Write</span><span class="op" id="4132981">(</span><span class="op" id="4132982">[</span><span class="op" id="4132983">]</span><span class="builtintype" id="4132984">byte</span><span class="op" id="4132988">)</span>&nbsp;<span class="op" id="4132990">(</span><span class="builtintype" id="4132991">int</span><span class="op" id="4132994">,</span>&nbsp;<span class="builtintype" id="4132996">error</span><span class="op" id="4133001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133005">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133069">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133138">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133195">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133253">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4133275">WriteHeader</span><span class="op" id="4133286">(</span><span class="builtintype" id="4133287">int</span><span class="op" id="4133290">)</span><br>
<span class="lineno"></span><span class="op" id="4133292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4133295">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4133365">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="4133422">//</span><br>
<span class="lineno"></span><span class="comment" id="4133425">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="4133483">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="4133536">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="4133601">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="4133615">type</span>&nbsp;<span class="ident" id="4133620">Flusher</span>&nbsp;<span class="keyword" id="4133628">interface</span>&nbsp;<span class="op" id="4133638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133641">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4133690">Flush</span><span class="op" id="4133695">(</span><span class="op" id="4133696">)</span><br>
<span class="lineno"></span><span class="op" id="4133698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4133701">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4133772">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4133820">type</span>&nbsp;<span class="ident" id="4133825">Hijacker</span>&nbsp;<span class="keyword" id="4133834">interface</span>&nbsp;<span class="op" id="4133844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133847">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133900">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4133954">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134005">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134058">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134088">Hijack</span><span class="op" id="4134094">(</span><span class="op" id="4134095">)</span>&nbsp;<span class="op" id="4134097">(</span><span class="ident" id="4134098">net</span><span class="op" id="4134101">.</span><span class="ident" id="4134102">Conn</span><span class="op" id="4134106">,</span>&nbsp;<span class="op" id="4134108">*</span><span class="ident" id="4134109">bufio</span><span class="op" id="4134114">.</span><span class="ident" id="4134115">ReadWriter</span><span class="op" id="4134125">,</span>&nbsp;<span class="builtintype" id="4134127">error</span><span class="op" id="4134132">)</span><br>
<span class="lineno"></span><span class="op" id="4134134">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4134137">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4134208">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="4134273">//</span><br>
<span class="lineno"></span><span class="comment" id="4134276">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="4134346">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="4134410">type</span>&nbsp;<span class="ident" id="4134415">CloseNotifier</span>&nbsp;<span class="keyword" id="4134429">interface</span>&nbsp;<span class="op" id="4134439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134442">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134505">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134551">CloseNotify</span><span class="op" id="4134562">(</span><span class="op" id="4134563">)</span>&nbsp;<span class="op" id="4134565">&lt;-</span><span class="keyword" id="4134567">chan</span>&nbsp;<span class="builtintype" id="4134572">bool</span><br>
<span class="lineno">110</span><span class="op" id="4134577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4134580">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4134640">type</span>&nbsp;<span class="ident" id="4134645">conn</span>&nbsp;<span class="keyword" id="4134650">struct</span>&nbsp;<span class="op" id="4134657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134660">remoteAddr</span>&nbsp;<span class="builtintype" id="4134671">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134692">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134727">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4134738">*</span><span class="ident" id="4134739">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134759">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134806">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134817">net</span><span class="op" id="4134820">.</span><span class="ident" id="4134821">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134838">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134857">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134868">io</span><span class="op" id="4134870">.</span><span class="ident" id="4134871">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134889">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4134950">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4134961">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4134982">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135010">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135021">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4135042">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135096">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4135107">*</span><span class="ident" id="4135108">io</span><span class="op" id="4135110">.</span><span class="ident" id="4135111">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4135128">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135151">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4135162">*</span><span class="ident" id="4135163">bufio</span><span class="op" id="4135168">.</span><span class="ident" id="4135169">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4135183">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135246">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4135257">*</span><span class="ident" id="4135258">tls</span><span class="op" id="4135261">.</span><span class="ident" id="4135262">ConnectionState</span>&nbsp;<span class="comment" id="4135278">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135309">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135322">sync</span><span class="op" id="4135326">.</span><span class="ident" id="4135327">Mutex</span>&nbsp;<span class="comment" id="4135333">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135358">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4135371">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4135382">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135425">closeNotifyc</span>&nbsp;<span class="keyword" id="4135438">chan</span>&nbsp;<span class="builtintype" id="4135443">bool</span>&nbsp;&nbsp;<span class="comment" id="4135449">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135465">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4135478">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4135489">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="4135532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4135535">func</span>&nbsp;<span class="op" id="4135540">(</span><span class="ident" id="4135541">c</span>&nbsp;<span class="op" id="4135543">*</span><span class="ident" id="4135544">conn</span><span class="op" id="4135548">)</span>&nbsp;<span class="ident" id="4135550">hijacked</span><span class="op" id="4135558">(</span><span class="op" id="4135559">)</span>&nbsp;<span class="builtintype" id="4135561">bool</span>&nbsp;<span class="op" id="4135566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135569">c</span><span class="op" id="4135570">.</span><span class="ident" id="4135571">mu</span><span class="op" id="4135573">.</span><span class="ident" id="4135574">Lock</span><span class="op" id="4135578">(</span><span class="op" id="4135579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135582">defer</span>&nbsp;<span class="ident" id="4135588">c</span><span class="op" id="4135589">.</span><span class="ident" id="4135590">mu</span><span class="op" id="4135592">.</span><span class="ident" id="4135593">Unlock</span><span class="op" id="4135599">(</span><span class="op" id="4135600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135603">return</span>&nbsp;<span class="ident" id="4135610">c</span><span class="op" id="4135611">.</span><span class="ident" id="4135612">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="4135622">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="4135625">func</span>&nbsp;<span class="op" id="4135630">(</span><span class="ident" id="4135631">c</span>&nbsp;<span class="op" id="4135633">*</span><span class="ident" id="4135634">conn</span><span class="op" id="4135638">)</span>&nbsp;<span class="ident" id="4135640">hijack</span><span class="op" id="4135646">(</span><span class="op" id="4135647">)</span>&nbsp;<span class="op" id="4135649">(</span><span class="ident" id="4135650">rwc</span>&nbsp;<span class="ident" id="4135654">net</span><span class="op" id="4135657">.</span><span class="ident" id="4135658">Conn</span><span class="op" id="4135662">,</span>&nbsp;<span class="ident" id="4135664">buf</span>&nbsp;<span class="op" id="4135668">*</span><span class="ident" id="4135669">bufio</span><span class="op" id="4135674">.</span><span class="ident" id="4135675">ReadWriter</span><span class="op" id="4135685">,</span>&nbsp;<span class="ident" id="4135687">err</span>&nbsp;<span class="builtintype" id="4135691">error</span><span class="op" id="4135696">)</span>&nbsp;<span class="op" id="4135698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135701">c</span><span class="op" id="4135702">.</span><span class="ident" id="4135703">mu</span><span class="op" id="4135705">.</span><span class="ident" id="4135706">Lock</span><span class="op" id="4135710">(</span><span class="op" id="4135711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135714">defer</span>&nbsp;<span class="ident" id="4135720">c</span><span class="op" id="4135721">.</span><span class="ident" id="4135722">mu</span><span class="op" id="4135724">.</span><span class="ident" id="4135725">Unlock</span><span class="op" id="4135731">(</span><span class="op" id="4135732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135735">if</span>&nbsp;<span class="ident" id="4135738">c</span><span class="op" id="4135739">.</span><span class="ident" id="4135740">hijackedv</span>&nbsp;<span class="op" id="4135750">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135754">return</span>&nbsp;<span class="builtintype" id="4135761">nil</span><span class="op" id="4135764">,</span>&nbsp;<span class="builtintype" id="4135766">nil</span><span class="op" id="4135769">,</span>&nbsp;<span class="ident" id="4135771">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4135784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135787">if</span>&nbsp;<span class="ident" id="4135790">c</span><span class="op" id="4135791">.</span><span class="ident" id="4135792">closeNotifyc</span>&nbsp;<span class="op" id="4135805">!=</span>&nbsp;<span class="builtintype" id="4135808">nil</span>&nbsp;<span class="op" id="4135812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4135816">return</span>&nbsp;<span class="builtintype" id="4135823">nil</span><span class="op" id="4135826">,</span>&nbsp;<span class="builtintype" id="4135828">nil</span><span class="op" id="4135831">,</span>&nbsp;<span class="ident" id="4135833">errors</span><span class="op" id="4135839">.</span><span class="ident" id="4135840">New</span><span class="op" id="4135843">(</span><span class="string" id="4135844">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="4135900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4135903">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135906">c</span><span class="op" id="4135907">.</span><span class="ident" id="4135908">hijackedv</span>&nbsp;<span class="op" id="4135918">=</span>&nbsp;<span class="builtintype" id="4135920">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135926">rwc</span>&nbsp;<span class="op" id="4135930">=</span>&nbsp;<span class="ident" id="4135932">c</span><span class="op" id="4135933">.</span><span class="ident" id="4135934">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135939">buf</span>&nbsp;<span class="op" id="4135943">=</span>&nbsp;<span class="ident" id="4135945">c</span><span class="op" id="4135946">.</span><span class="ident" id="4135947">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135952">c</span><span class="op" id="4135953">.</span><span class="ident" id="4135954">rwc</span>&nbsp;<span class="op" id="4135958">=</span>&nbsp;<span class="builtintype" id="4135960">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135965">c</span><span class="op" id="4135966">.</span><span class="ident" id="4135967">buf</span>&nbsp;<span class="op" id="4135971">=</span>&nbsp;<span class="builtintype" id="4135973">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4135978">c</span><span class="op" id="4135979">.</span><span class="ident" id="4135980">setState</span><span class="op" id="4135988">(</span><span class="ident" id="4135989">rwc</span><span class="op" id="4135992">,</span>&nbsp;<span class="ident" id="4135994">StateHijacked</span><span class="op" id="4136007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136010">return</span><br>
<span class="lineno"></span><span class="op" id="4136017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4136020">func</span>&nbsp;<span class="op" id="4136025">(</span><span class="ident" id="4136026">c</span>&nbsp;<span class="op" id="4136028">*</span><span class="ident" id="4136029">conn</span><span class="op" id="4136033">)</span>&nbsp;<span class="ident" id="4136035">closeNotify</span><span class="op" id="4136046">(</span><span class="op" id="4136047">)</span>&nbsp;<span class="op" id="4136049">&lt;-</span><span class="keyword" id="4136051">chan</span>&nbsp;<span class="builtintype" id="4136056">bool</span>&nbsp;<span class="op" id="4136061">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136064">c</span><span class="op" id="4136065">.</span><span class="ident" id="4136066">mu</span><span class="op" id="4136068">.</span><span class="ident" id="4136069">Lock</span><span class="op" id="4136073">(</span><span class="op" id="4136074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136077">defer</span>&nbsp;<span class="ident" id="4136083">c</span><span class="op" id="4136084">.</span><span class="ident" id="4136085">mu</span><span class="op" id="4136087">.</span><span class="ident" id="4136088">Unlock</span><span class="op" id="4136094">(</span><span class="op" id="4136095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136098">if</span>&nbsp;<span class="ident" id="4136101">c</span><span class="op" id="4136102">.</span><span class="ident" id="4136103">closeNotifyc</span>&nbsp;<span class="op" id="4136116">==</span>&nbsp;<span class="builtintype" id="4136119">nil</span>&nbsp;<span class="op" id="4136123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136127">c</span><span class="op" id="4136128">.</span><span class="ident" id="4136129">closeNotifyc</span>&nbsp;<span class="op" id="4136142">=</span>&nbsp;<span class="builtinfunc" id="4136144">make</span><span class="op" id="4136148">(</span><span class="keyword" id="4136149">chan</span>&nbsp;<span class="builtintype" id="4136154">bool</span><span class="op" id="4136158">,</span>&nbsp;<span class="num" id="4136160">1</span><span class="op" id="4136161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136165">if</span>&nbsp;<span class="ident" id="4136168">c</span><span class="op" id="4136169">.</span><span class="ident" id="4136170">hijackedv</span>&nbsp;<span class="op" id="4136180">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4136185">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4136235">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136270">return</span>&nbsp;<span class="ident" id="4136277">c</span><span class="op" id="4136278">.</span><span class="ident" id="4136279">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4136294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136298">pr</span><span class="op" id="4136300">,</span>&nbsp;<span class="ident" id="4136302">pw</span>&nbsp;<span class="op" id="4136305">:=</span>&nbsp;<span class="ident" id="4136308">io</span><span class="op" id="4136310">.</span><span class="ident" id="4136311">Pipe</span><span class="op" id="4136315">(</span><span class="op" id="4136316">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136321">readSource</span>&nbsp;<span class="op" id="4136332">:=</span>&nbsp;<span class="ident" id="4136335">c</span><span class="op" id="4136336">.</span><span class="ident" id="4136337">sr</span><span class="op" id="4136339">.</span><span class="ident" id="4136340">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136344">c</span><span class="op" id="4136345">.</span><span class="ident" id="4136346">sr</span><span class="op" id="4136348">.</span><span class="ident" id="4136349">Lock</span><span class="op" id="4136353">(</span><span class="op" id="4136354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136358">c</span><span class="op" id="4136359">.</span><span class="ident" id="4136360">sr</span><span class="op" id="4136362">.</span><span class="ident" id="4136363">r</span>&nbsp;<span class="op" id="4136365">=</span>&nbsp;<span class="ident" id="4136367">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136372">c</span><span class="op" id="4136373">.</span><span class="ident" id="4136374">sr</span><span class="op" id="4136376">.</span><span class="ident" id="4136377">Unlock</span><span class="op" id="4136383">(</span><span class="op" id="4136384">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136388">go</span>&nbsp;<span class="keyword" id="4136391">func</span><span class="op" id="4136395">(</span><span class="op" id="4136396">)</span>&nbsp;<span class="op" id="4136398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136403">_</span><span class="op" id="4136404">,</span>&nbsp;<span class="ident" id="4136406">err</span>&nbsp;<span class="op" id="4136410">:=</span>&nbsp;<span class="ident" id="4136413">io</span><span class="op" id="4136415">.</span><span class="ident" id="4136416">Copy</span><span class="op" id="4136420">(</span><span class="ident" id="4136421">pw</span><span class="op" id="4136423">,</span>&nbsp;<span class="ident" id="4136425">readSource</span><span class="op" id="4136435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136440">if</span>&nbsp;<span class="ident" id="4136443">err</span>&nbsp;<span class="op" id="4136447">==</span>&nbsp;<span class="builtintype" id="4136450">nil</span>&nbsp;<span class="op" id="4136454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136460">err</span>&nbsp;<span class="op" id="4136464">=</span>&nbsp;<span class="ident" id="4136466">io</span><span class="op" id="4136468">.</span><span class="ident" id="4136469">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4136476">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136481">pw</span><span class="op" id="4136483">.</span><span class="ident" id="4136484">CloseWithError</span><span class="op" id="4136498">(</span><span class="ident" id="4136499">err</span><span class="op" id="4136502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136507">c</span><span class="op" id="4136508">.</span><span class="ident" id="4136509">noteClientGone</span><span class="op" id="4136523">(</span><span class="op" id="4136524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4136528">}</span><span class="op" id="4136529">(</span><span class="op" id="4136530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4136533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136536">return</span>&nbsp;<span class="ident" id="4136543">c</span><span class="op" id="4136544">.</span><span class="ident" id="4136545">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="4136558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4136561">func</span>&nbsp;<span class="op" id="4136566">(</span><span class="ident" id="4136567">c</span>&nbsp;<span class="op" id="4136569">*</span><span class="ident" id="4136570">conn</span><span class="op" id="4136574">)</span>&nbsp;<span class="ident" id="4136576">noteClientGone</span><span class="op" id="4136590">(</span><span class="op" id="4136591">)</span>&nbsp;<span class="op" id="4136593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136596">c</span><span class="op" id="4136597">.</span><span class="ident" id="4136598">mu</span><span class="op" id="4136600">.</span><span class="ident" id="4136601">Lock</span><span class="op" id="4136605">(</span><span class="op" id="4136606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136609">defer</span>&nbsp;<span class="ident" id="4136615">c</span><span class="op" id="4136616">.</span><span class="ident" id="4136617">mu</span><span class="op" id="4136619">.</span><span class="ident" id="4136620">Unlock</span><span class="op" id="4136626">(</span><span class="op" id="4136627">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4136630">if</span>&nbsp;<span class="ident" id="4136633">c</span><span class="op" id="4136634">.</span><span class="ident" id="4136635">closeNotifyc</span>&nbsp;<span class="op" id="4136648">!=</span>&nbsp;<span class="builtintype" id="4136651">nil</span>&nbsp;<span class="op" id="4136655">&amp;&amp;</span>&nbsp;<span class="op" id="4136658">!</span><span class="ident" id="4136659">c</span><span class="op" id="4136660">.</span><span class="ident" id="4136661">clientGone</span>&nbsp;<span class="op" id="4136672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136676">c</span><span class="op" id="4136677">.</span><span class="ident" id="4136678">closeNotifyc</span>&nbsp;<span class="op" id="4136691">&lt;-</span>&nbsp;<span class="builtintype" id="4136694">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4136700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136703">c</span><span class="op" id="4136704">.</span><span class="ident" id="4136705">clientGone</span>&nbsp;<span class="op" id="4136716">=</span>&nbsp;<span class="builtintype" id="4136718">true</span><br>
<span class="lineno"></span><span class="op" id="4136723">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4136726">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4136784">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4136836">type</span>&nbsp;<span class="ident" id="4136841">switchReader</span>&nbsp;<span class="keyword" id="4136854">struct</span>&nbsp;<span class="op" id="4136861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4136864">io</span><span class="op" id="4136866">.</span><span class="ident" id="4136867">Reader</span><br>
<span class="lineno">195</span><span class="op" id="4136874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4136877">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4136935">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4136988">type</span>&nbsp;<span class="ident" id="4136993">switchWriter</span>&nbsp;<span class="keyword" id="4137006">struct</span>&nbsp;<span class="op" id="4137013">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137016">io</span><span class="op" id="4137018">.</span><span class="ident" id="4137019">Writer</span><br>
<span class="lineno"></span><span class="op" id="4137026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4137029">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="4137096">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="4137141">type</span>&nbsp;<span class="ident" id="4137146">liveSwitchReader</span>&nbsp;<span class="keyword" id="4137163">struct</span>&nbsp;<span class="op" id="4137170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137173">sync</span><span class="op" id="4137177">.</span><span class="ident" id="4137178">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137185">r</span>&nbsp;<span class="ident" id="4137187">io</span><span class="op" id="4137189">.</span><span class="ident" id="4137190">Reader</span><br>
<span class="lineno"></span><span class="op" id="4137197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="4137200">func</span>&nbsp;<span class="op" id="4137205">(</span><span class="ident" id="4137206">sr</span>&nbsp;<span class="op" id="4137209">*</span><span class="ident" id="4137210">liveSwitchReader</span><span class="op" id="4137226">)</span>&nbsp;<span class="ident" id="4137228">Read</span><span class="op" id="4137232">(</span><span class="ident" id="4137233">p</span>&nbsp;<span class="op" id="4137235">[</span><span class="op" id="4137236">]</span><span class="builtintype" id="4137237">byte</span><span class="op" id="4137241">)</span>&nbsp;<span class="op" id="4137243">(</span><span class="ident" id="4137244">n</span>&nbsp;<span class="builtintype" id="4137246">int</span><span class="op" id="4137249">,</span>&nbsp;<span class="ident" id="4137251">err</span>&nbsp;<span class="builtintype" id="4137255">error</span><span class="op" id="4137260">)</span>&nbsp;<span class="op" id="4137262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137265">sr</span><span class="op" id="4137267">.</span><span class="ident" id="4137268">Lock</span><span class="op" id="4137272">(</span><span class="op" id="4137273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137276">r</span>&nbsp;<span class="op" id="4137278">:=</span>&nbsp;<span class="ident" id="4137281">sr</span><span class="op" id="4137283">.</span><span class="ident" id="4137284">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137287">sr</span><span class="op" id="4137289">.</span><span class="ident" id="4137290">Unlock</span><span class="op" id="4137296">(</span><span class="op" id="4137297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4137300">return</span>&nbsp;<span class="ident" id="4137307">r</span><span class="op" id="4137308">.</span><span class="ident" id="4137309">Read</span><span class="op" id="4137313">(</span><span class="ident" id="4137314">p</span><span class="op" id="4137315">)</span><br>
<span class="lineno">215</span><span class="op" id="4137317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4137320">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="4137374">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="4137416">const</span>&nbsp;<span class="ident" id="4137422">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="4137447">=</span>&nbsp;<span class="num" id="4137449">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4137455">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="4137524">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4137573">//</span><br>
<span class="lineno"></span><span class="comment" id="4137576">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="4137648">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="4137719">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4137791">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="4137865">//</span><br>
<span class="lineno"></span><span class="comment" id="4137868">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="4137938">type</span>&nbsp;<span class="ident" id="4137943">chunkWriter</span>&nbsp;<span class="keyword" id="4137955">struct</span>&nbsp;<span class="op" id="4137962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4137965">res</span>&nbsp;<span class="op" id="4137969">*</span><span class="ident" id="4137970">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4137981">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138043">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138101">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138159">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138199">header</span>&nbsp;<span class="ident" id="4138206">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138215">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138279">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138329">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138390">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138413">wroteHeader</span>&nbsp;<span class="builtintype" id="4138425">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138432">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138467">chunking</span>&nbsp;<span class="builtintype" id="4138476">bool</span>&nbsp;<span class="comment" id="4138481">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="4138531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4138534">var</span>&nbsp;<span class="op" id="4138538">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138541">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4138552">=</span>&nbsp;<span class="op" id="4138554">[</span><span class="op" id="4138555">]</span><span class="builtintype" id="4138556">byte</span><span class="op" id="4138560">(</span><span class="string" id="4138561">&#34;\r\n&#34;</span><span class="op" id="4138567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138570">colonSpace</span>&nbsp;<span class="op" id="4138581">=</span>&nbsp;<span class="op" id="4138583">[</span><span class="op" id="4138584">]</span><span class="builtintype" id="4138585">byte</span><span class="op" id="4138589">(</span><span class="string" id="4138590">&#34;:&nbsp;&#34;</span><span class="op" id="4138594">)</span><br>
<span class="lineno"></span><span class="op" id="4138596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4138599">func</span>&nbsp;<span class="op" id="4138604">(</span><span class="ident" id="4138605">cw</span>&nbsp;<span class="op" id="4138608">*</span><span class="ident" id="4138609">chunkWriter</span><span class="op" id="4138620">)</span>&nbsp;<span class="ident" id="4138622">Write</span><span class="op" id="4138627">(</span><span class="ident" id="4138628">p</span>&nbsp;<span class="op" id="4138630">[</span><span class="op" id="4138631">]</span><span class="builtintype" id="4138632">byte</span><span class="op" id="4138636">)</span>&nbsp;<span class="op" id="4138638">(</span><span class="ident" id="4138639">n</span>&nbsp;<span class="builtintype" id="4138641">int</span><span class="op" id="4138644">,</span>&nbsp;<span class="ident" id="4138646">err</span>&nbsp;<span class="builtintype" id="4138650">error</span><span class="op" id="4138655">)</span>&nbsp;<span class="op" id="4138657">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138660">if</span>&nbsp;<span class="op" id="4138663">!</span><span class="ident" id="4138664">cw</span><span class="op" id="4138666">.</span><span class="ident" id="4138667">wroteHeader</span>&nbsp;<span class="op" id="4138679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138683">cw</span><span class="op" id="4138685">.</span><span class="ident" id="4138686">writeHeader</span><span class="op" id="4138697">(</span><span class="ident" id="4138698">p</span><span class="op" id="4138699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4138702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138705">if</span>&nbsp;<span class="ident" id="4138708">cw</span><span class="op" id="4138710">.</span><span class="ident" id="4138711">res</span><span class="op" id="4138714">.</span><span class="ident" id="4138715">req</span><span class="op" id="4138718">.</span><span class="ident" id="4138719">Method</span>&nbsp;<span class="op" id="4138726">==</span>&nbsp;<span class="string" id="4138729">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4138736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4138740">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138757">return</span>&nbsp;<span class="builtinfunc" id="4138764">len</span><span class="op" id="4138767">(</span><span class="ident" id="4138768">p</span><span class="op" id="4138769">)</span><span class="op" id="4138770">,</span>&nbsp;<span class="builtintype" id="4138772">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4138777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138780">if</span>&nbsp;<span class="ident" id="4138783">cw</span><span class="op" id="4138785">.</span><span class="ident" id="4138786">chunking</span>&nbsp;<span class="op" id="4138795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138799">_</span><span class="op" id="4138800">,</span>&nbsp;<span class="ident" id="4138802">err</span>&nbsp;<span class="op" id="4138806">=</span>&nbsp;<span class="ident" id="4138808">fmt</span><span class="op" id="4138811">.</span><span class="ident" id="4138812">Fprintf</span><span class="op" id="4138819">(</span><span class="ident" id="4138820">cw</span><span class="op" id="4138822">.</span><span class="ident" id="4138823">res</span><span class="op" id="4138826">.</span><span class="ident" id="4138827">conn</span><span class="op" id="4138831">.</span><span class="ident" id="4138832">buf</span><span class="op" id="4138835">,</span>&nbsp;<span class="string" id="4138837">&#34;%x\r\n&#34;</span><span class="op" id="4138845">,</span>&nbsp;<span class="builtinfunc" id="4138847">len</span><span class="op" id="4138850">(</span><span class="ident" id="4138851">p</span><span class="op" id="4138852">)</span><span class="op" id="4138853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138857">if</span>&nbsp;<span class="ident" id="4138860">err</span>&nbsp;<span class="op" id="4138864">!=</span>&nbsp;<span class="builtintype" id="4138867">nil</span>&nbsp;<span class="op" id="4138871">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138876">cw</span><span class="op" id="4138878">.</span><span class="ident" id="4138879">res</span><span class="op" id="4138882">.</span><span class="ident" id="4138883">conn</span><span class="op" id="4138887">.</span><span class="ident" id="4138888">rwc</span><span class="op" id="4138891">.</span><span class="ident" id="4138892">Close</span><span class="op" id="4138897">(</span><span class="op" id="4138898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138903">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4138912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4138915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138918">n</span><span class="op" id="4138919">,</span>&nbsp;<span class="ident" id="4138921">err</span>&nbsp;<span class="op" id="4138925">=</span>&nbsp;<span class="ident" id="4138927">cw</span><span class="op" id="4138929">.</span><span class="ident" id="4138930">res</span><span class="op" id="4138933">.</span><span class="ident" id="4138934">conn</span><span class="op" id="4138938">.</span><span class="ident" id="4138939">buf</span><span class="op" id="4138942">.</span><span class="ident" id="4138943">Write</span><span class="op" id="4138948">(</span><span class="ident" id="4138949">p</span><span class="op" id="4138950">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4138953">if</span>&nbsp;<span class="ident" id="4138956">cw</span><span class="op" id="4138958">.</span><span class="ident" id="4138959">chunking</span>&nbsp;<span class="op" id="4138968">&amp;&amp;</span>&nbsp;<span class="ident" id="4138971">err</span>&nbsp;<span class="op" id="4138975">==</span>&nbsp;<span class="builtintype" id="4138978">nil</span>&nbsp;<span class="op" id="4138982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4138986">_</span><span class="op" id="4138987">,</span>&nbsp;<span class="ident" id="4138989">err</span>&nbsp;<span class="op" id="4138993">=</span>&nbsp;<span class="ident" id="4138995">cw</span><span class="op" id="4138997">.</span><span class="ident" id="4138998">res</span><span class="op" id="4139001">.</span><span class="ident" id="4139002">conn</span><span class="op" id="4139006">.</span><span class="ident" id="4139007">buf</span><span class="op" id="4139010">.</span><span class="ident" id="4139011">Write</span><span class="op" id="4139016">(</span><span class="ident" id="4139017">crlf</span><span class="op" id="4139021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4139027">if</span>&nbsp;<span class="ident" id="4139030">err</span>&nbsp;<span class="op" id="4139034">!=</span>&nbsp;<span class="builtintype" id="4139037">nil</span>&nbsp;<span class="op" id="4139041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139045">cw</span><span class="op" id="4139047">.</span><span class="ident" id="4139048">res</span><span class="op" id="4139051">.</span><span class="ident" id="4139052">conn</span><span class="op" id="4139056">.</span><span class="ident" id="4139057">rwc</span><span class="op" id="4139060">.</span><span class="ident" id="4139061">Close</span><span class="op" id="4139066">(</span><span class="op" id="4139067">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4139073">return</span><br>
<span class="lineno"></span><span class="op" id="4139080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4139083">func</span>&nbsp;<span class="op" id="4139088">(</span><span class="ident" id="4139089">cw</span>&nbsp;<span class="op" id="4139092">*</span><span class="ident" id="4139093">chunkWriter</span><span class="op" id="4139104">)</span>&nbsp;<span class="ident" id="4139106">flush</span><span class="op" id="4139111">(</span><span class="op" id="4139112">)</span>&nbsp;<span class="op" id="4139114">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4139117">if</span>&nbsp;<span class="op" id="4139120">!</span><span class="ident" id="4139121">cw</span><span class="op" id="4139123">.</span><span class="ident" id="4139124">wroteHeader</span>&nbsp;<span class="op" id="4139136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139140">cw</span><span class="op" id="4139142">.</span><span class="ident" id="4139143">writeHeader</span><span class="op" id="4139154">(</span><span class="builtintype" id="4139155">nil</span><span class="op" id="4139158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139164">cw</span><span class="op" id="4139166">.</span><span class="ident" id="4139167">res</span><span class="op" id="4139170">.</span><span class="ident" id="4139171">conn</span><span class="op" id="4139175">.</span><span class="ident" id="4139176">buf</span><span class="op" id="4139179">.</span><span class="ident" id="4139180">Flush</span><span class="op" id="4139185">(</span><span class="op" id="4139186">)</span><br>
<span class="lineno"></span><span class="op" id="4139188">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="4139191">func</span>&nbsp;<span class="op" id="4139196">(</span><span class="ident" id="4139197">cw</span>&nbsp;<span class="op" id="4139200">*</span><span class="ident" id="4139201">chunkWriter</span><span class="op" id="4139212">)</span>&nbsp;<span class="builtinfunc" id="4139214">close</span><span class="op" id="4139219">(</span><span class="op" id="4139220">)</span>&nbsp;<span class="op" id="4139222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4139225">if</span>&nbsp;<span class="op" id="4139228">!</span><span class="ident" id="4139229">cw</span><span class="op" id="4139231">.</span><span class="ident" id="4139232">wroteHeader</span>&nbsp;<span class="op" id="4139244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139248">cw</span><span class="op" id="4139250">.</span><span class="ident" id="4139251">writeHeader</span><span class="op" id="4139262">(</span><span class="builtintype" id="4139263">nil</span><span class="op" id="4139266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139269">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4139272">if</span>&nbsp;<span class="ident" id="4139275">cw</span><span class="op" id="4139277">.</span><span class="ident" id="4139278">chunking</span>&nbsp;<span class="op" id="4139287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139291">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139347">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139401">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139412">cw</span><span class="op" id="4139414">.</span><span class="ident" id="4139415">res</span><span class="op" id="4139418">.</span><span class="ident" id="4139419">conn</span><span class="op" id="4139423">.</span><span class="ident" id="4139424">buf</span><span class="op" id="4139427">.</span><span class="ident" id="4139428">WriteString</span><span class="op" id="4139439">(</span><span class="string" id="4139440">&#34;0\r\n\r\n&#34;</span><span class="op" id="4139451">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139454">}</span><br>
<span class="lineno"></span><span class="op" id="4139456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4139459">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4139521">type</span>&nbsp;<span class="ident" id="4139526">response</span>&nbsp;<span class="keyword" id="4139535">struct</span>&nbsp;<span class="op" id="4139542">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139545">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139559">*</span><span class="ident" id="4139560">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139566">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4139580">*</span><span class="ident" id="4139581">Request</span>&nbsp;<span class="comment" id="4139589">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139619">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4139633">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139642">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139688">wroteContinue</span>&nbsp;<span class="builtintype" id="4139702">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139711">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139750">w</span>&nbsp;&nbsp;<span class="op" id="4139753">*</span><span class="ident" id="4139754">bufio</span><span class="op" id="4139759">.</span><span class="ident" id="4139760">Writer</span>&nbsp;<span class="comment" id="4139767">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139811">cw</span>&nbsp;<span class="ident" id="4139814">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4139827">sw</span>&nbsp;<span class="op" id="4139830">*</span><span class="ident" id="4139831">switchWriter</span>&nbsp;<span class="comment" id="4139844">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139899">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4139960">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140022">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140080">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140124">handlerHeader</span>&nbsp;<span class="ident" id="4140138">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140146">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="4140160">bool</span>&nbsp;<span class="comment" id="4140165">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140212">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140226">int64</span>&nbsp;<span class="comment" id="4140232">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140268">contentLength</span>&nbsp;<span class="ident" id="4140282">int64</span>&nbsp;<span class="comment" id="4140288">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140334">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4140348">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4140354">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140393">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140452">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140505">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140556">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140576">closeAfterReply</span>&nbsp;<span class="builtintype" id="4140592">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140599">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140654">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140709">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140760">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140822">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140878">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4140938">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140957">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="4140977">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4140984">handlerDone</span>&nbsp;<span class="builtintype" id="4140996">bool</span>&nbsp;<span class="comment" id="4141001">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4141038">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141078">dateBuf</span>&nbsp;<span class="op" id="4141086">[</span><span class="builtinfunc" id="4141087">len</span><span class="op" id="4141090">(</span><span class="ident" id="4141091">TimeFormat</span><span class="op" id="4141101">)</span><span class="op" id="4141102">]</span><span class="builtintype" id="4141103">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141109">clenBuf</span>&nbsp;<span class="op" id="4141117">[</span><span class="num" id="4141118">10</span><span class="op" id="4141120">]</span><span class="builtintype" id="4141121">byte</span><br>
<span class="lineno">340</span><span class="op" id="4141126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4141129">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4141200">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4141230">func</span>&nbsp;<span class="op" id="4141235">(</span><span class="ident" id="4141236">w</span>&nbsp;<span class="op" id="4141238">*</span><span class="ident" id="4141239">response</span><span class="op" id="4141247">)</span>&nbsp;<span class="ident" id="4141249">requestTooLarge</span><span class="op" id="4141264">(</span><span class="op" id="4141265">)</span>&nbsp;<span class="op" id="4141267">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141270">w</span><span class="op" id="4141271">.</span><span class="ident" id="4141272">closeAfterReply</span>&nbsp;<span class="op" id="4141288">=</span>&nbsp;<span class="builtintype" id="4141290">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141296">w</span><span class="op" id="4141297">.</span><span class="ident" id="4141298">requestBodyLimitHit</span>&nbsp;<span class="op" id="4141318">=</span>&nbsp;<span class="builtintype" id="4141320">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141326">if</span>&nbsp;<span class="op" id="4141329">!</span><span class="ident" id="4141330">w</span><span class="op" id="4141331">.</span><span class="ident" id="4141332">wroteHeader</span>&nbsp;<span class="op" id="4141344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141348">w</span><span class="op" id="4141349">.</span><span class="ident" id="4141350">Header</span><span class="op" id="4141356">(</span><span class="op" id="4141357">)</span><span class="op" id="4141358">.</span><span class="ident" id="4141359">Set</span><span class="op" id="4141362">(</span><span class="string" id="4141363">&#34;Connection&#34;</span><span class="op" id="4141375">,</span>&nbsp;<span class="string" id="4141377">&#34;close&#34;</span><span class="op" id="4141384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4141387">}</span><br>
<span class="lineno">350</span><span class="op" id="4141389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4141392">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="4141464">func</span>&nbsp;<span class="op" id="4141469">(</span><span class="ident" id="4141470">w</span>&nbsp;<span class="op" id="4141472">*</span><span class="ident" id="4141473">response</span><span class="op" id="4141481">)</span>&nbsp;<span class="ident" id="4141483">needsSniff</span><span class="op" id="4141493">(</span><span class="op" id="4141494">)</span>&nbsp;<span class="builtintype" id="4141496">bool</span>&nbsp;<span class="op" id="4141501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141504">_</span><span class="op" id="4141505">,</span>&nbsp;<span class="ident" id="4141507">haveType</span>&nbsp;<span class="op" id="4141516">:=</span>&nbsp;<span class="ident" id="4141519">w</span><span class="op" id="4141520">.</span><span class="ident" id="4141521">handlerHeader</span><span class="op" id="4141534">[</span><span class="string" id="4141535">&#34;Content-Type&#34;</span><span class="op" id="4141549">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141552">return</span>&nbsp;<span class="op" id="4141559">!</span><span class="ident" id="4141560">w</span><span class="op" id="4141561">.</span><span class="ident" id="4141562">cw</span><span class="op" id="4141564">.</span><span class="ident" id="4141565">wroteHeader</span>&nbsp;<span class="op" id="4141577">&amp;&amp;</span>&nbsp;<span class="op" id="4141580">!</span><span class="ident" id="4141581">haveType</span>&nbsp;<span class="op" id="4141590">&amp;&amp;</span>&nbsp;<span class="ident" id="4141593">w</span><span class="op" id="4141594">.</span><span class="ident" id="4141595">written</span>&nbsp;<span class="op" id="4141603">&lt;</span>&nbsp;<span class="ident" id="4141605">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="4141614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4141617">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="4141683">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="4141700">type</span>&nbsp;<span class="ident" id="4141705">writerOnly</span>&nbsp;<span class="keyword" id="4141716">struct</span>&nbsp;<span class="op" id="4141723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141726">io</span><span class="op" id="4141728">.</span><span class="ident" id="4141729">Writer</span><br>
<span class="lineno"></span><span class="op" id="4141736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4141739">func</span>&nbsp;<span class="ident" id="4141744">srcIsRegularFile</span><span class="op" id="4141760">(</span><span class="ident" id="4141761">src</span>&nbsp;<span class="ident" id="4141765">io</span><span class="op" id="4141767">.</span><span class="ident" id="4141768">Reader</span><span class="op" id="4141774">)</span>&nbsp;<span class="op" id="4141776">(</span><span class="ident" id="4141777">isRegular</span>&nbsp;<span class="builtintype" id="4141787">bool</span><span class="op" id="4141791">,</span>&nbsp;<span class="ident" id="4141793">err</span>&nbsp;<span class="builtintype" id="4141797">error</span><span class="op" id="4141802">)</span>&nbsp;<span class="op" id="4141804">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141807">switch</span>&nbsp;<span class="ident" id="4141814">v</span>&nbsp;<span class="op" id="4141816">:=</span>&nbsp;<span class="ident" id="4141819">src</span><span class="op" id="4141822">.</span><span class="op" id="4141823">(</span><span class="keyword" id="4141824">type</span><span class="op" id="4141828">)</span>&nbsp;<span class="op" id="4141830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141833">case</span>&nbsp;<span class="op" id="4141838">*</span><span class="ident" id="4141839">os</span><span class="op" id="4141841">.</span><span class="ident" id="4141842">File</span><span class="op" id="4141846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4141850">fi</span><span class="op" id="4141852">,</span>&nbsp;<span class="ident" id="4141854">err</span>&nbsp;<span class="op" id="4141858">:=</span>&nbsp;<span class="ident" id="4141861">v</span><span class="op" id="4141862">.</span><span class="ident" id="4141863">Stat</span><span class="op" id="4141867">(</span><span class="op" id="4141868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141872">if</span>&nbsp;<span class="ident" id="4141875">err</span>&nbsp;<span class="op" id="4141879">!=</span>&nbsp;<span class="builtintype" id="4141882">nil</span>&nbsp;<span class="op" id="4141886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141891">return</span>&nbsp;<span class="builtintype" id="4141898">false</span><span class="op" id="4141903">,</span>&nbsp;<span class="ident" id="4141905">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4141911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141915">return</span>&nbsp;<span class="ident" id="4141922">fi</span><span class="op" id="4141924">.</span><span class="ident" id="4141925">Mode</span><span class="op" id="4141929">(</span><span class="op" id="4141930">)</span><span class="op" id="4141931">.</span><span class="ident" id="4141932">IsRegular</span><span class="op" id="4141941">(</span><span class="op" id="4141942">)</span><span class="op" id="4141943">,</span>&nbsp;<span class="builtintype" id="4141945">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141950">case</span>&nbsp;<span class="op" id="4141955">*</span><span class="ident" id="4141956">io</span><span class="op" id="4141958">.</span><span class="ident" id="4141959">LimitedReader</span><span class="op" id="4141972">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4141976">return</span>&nbsp;<span class="ident" id="4141983">srcIsRegularFile</span><span class="op" id="4141999">(</span><span class="ident" id="4142000">v</span><span class="op" id="4142001">.</span><span class="ident" id="4142002">R</span><span class="op" id="4142003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142006">default</span><span class="op" id="4142013">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142017">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4142025">}</span><br>
<span class="lineno"></span><span class="op" id="4142027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4142030">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="4142100">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="4142136">func</span>&nbsp;<span class="op" id="4142141">(</span><span class="ident" id="4142142">w</span>&nbsp;<span class="op" id="4142144">*</span><span class="ident" id="4142145">response</span><span class="op" id="4142153">)</span>&nbsp;<span class="ident" id="4142155">ReadFrom</span><span class="op" id="4142163">(</span><span class="ident" id="4142164">src</span>&nbsp;<span class="ident" id="4142168">io</span><span class="op" id="4142170">.</span><span class="ident" id="4142171">Reader</span><span class="op" id="4142177">)</span>&nbsp;<span class="op" id="4142179">(</span><span class="ident" id="4142180">n</span>&nbsp;<span class="ident" id="4142182">int64</span><span class="op" id="4142187">,</span>&nbsp;<span class="ident" id="4142189">err</span>&nbsp;<span class="builtintype" id="4142193">error</span><span class="op" id="4142198">)</span>&nbsp;<span class="op" id="4142200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4142203">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4142265">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4142329">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142381">rf</span><span class="op" id="4142383">,</span>&nbsp;<span class="ident" id="4142385">ok</span>&nbsp;<span class="op" id="4142388">:=</span>&nbsp;<span class="ident" id="4142391">w</span><span class="op" id="4142392">.</span><span class="ident" id="4142393">conn</span><span class="op" id="4142397">.</span><span class="ident" id="4142398">rwc</span><span class="op" id="4142401">.</span><span class="op" id="4142402">(</span><span class="ident" id="4142403">io</span><span class="op" id="4142405">.</span><span class="ident" id="4142406">ReaderFrom</span><span class="op" id="4142416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142419">regFile</span><span class="op" id="4142426">,</span>&nbsp;<span class="ident" id="4142428">err</span>&nbsp;<span class="op" id="4142432">:=</span>&nbsp;<span class="ident" id="4142435">srcIsRegularFile</span><span class="op" id="4142451">(</span><span class="ident" id="4142452">src</span><span class="op" id="4142455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142458">if</span>&nbsp;<span class="ident" id="4142461">err</span>&nbsp;<span class="op" id="4142465">!=</span>&nbsp;<span class="builtintype" id="4142468">nil</span>&nbsp;<span class="op" id="4142472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142476">return</span>&nbsp;<span class="num" id="4142483">0</span><span class="op" id="4142484">,</span>&nbsp;<span class="ident" id="4142486">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4142491">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142494">if</span>&nbsp;<span class="op" id="4142497">!</span><span class="ident" id="4142498">ok</span>&nbsp;<span class="op" id="4142501">||</span>&nbsp;<span class="op" id="4142504">!</span><span class="ident" id="4142505">regFile</span>&nbsp;<span class="op" id="4142513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142517">return</span>&nbsp;<span class="ident" id="4142524">io</span><span class="op" id="4142526">.</span><span class="ident" id="4142527">Copy</span><span class="op" id="4142531">(</span><span class="ident" id="4142532">writerOnly</span><span class="op" id="4142542">{</span><span class="ident" id="4142543">w</span><span class="op" id="4142544">}</span><span class="op" id="4142545">,</span>&nbsp;<span class="ident" id="4142547">src</span><span class="op" id="4142550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4142553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4142557">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142577">if</span>&nbsp;<span class="op" id="4142580">!</span><span class="ident" id="4142581">w</span><span class="op" id="4142582">.</span><span class="ident" id="4142583">wroteHeader</span>&nbsp;<span class="op" id="4142595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142599">w</span><span class="op" id="4142600">.</span><span class="ident" id="4142601">WriteHeader</span><span class="op" id="4142612">(</span><span class="ident" id="4142613">StatusOK</span><span class="op" id="4142621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4142624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142628">if</span>&nbsp;<span class="ident" id="4142631">w</span><span class="op" id="4142632">.</span><span class="ident" id="4142633">needsSniff</span><span class="op" id="4142643">(</span><span class="op" id="4142644">)</span>&nbsp;<span class="op" id="4142646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142650">n0</span><span class="op" id="4142652">,</span>&nbsp;<span class="ident" id="4142654">err</span>&nbsp;<span class="op" id="4142658">:=</span>&nbsp;<span class="ident" id="4142661">io</span><span class="op" id="4142663">.</span><span class="ident" id="4142664">Copy</span><span class="op" id="4142668">(</span><span class="ident" id="4142669">writerOnly</span><span class="op" id="4142679">{</span><span class="ident" id="4142680">w</span><span class="op" id="4142681">}</span><span class="op" id="4142682">,</span>&nbsp;<span class="ident" id="4142684">io</span><span class="op" id="4142686">.</span><span class="ident" id="4142687">LimitReader</span><span class="op" id="4142698">(</span><span class="ident" id="4142699">src</span><span class="op" id="4142702">,</span>&nbsp;<span class="ident" id="4142704">sniffLen</span><span class="op" id="4142712">)</span><span class="op" id="4142713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142717">n</span>&nbsp;<span class="op" id="4142719">+=</span>&nbsp;<span class="ident" id="4142722">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142727">if</span>&nbsp;<span class="ident" id="4142730">err</span>&nbsp;<span class="op" id="4142734">!=</span>&nbsp;<span class="builtintype" id="4142737">nil</span>&nbsp;<span class="op" id="4142741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142746">return</span>&nbsp;<span class="ident" id="4142753">n</span><span class="op" id="4142754">,</span>&nbsp;<span class="ident" id="4142756">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4142762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4142765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142769">w</span><span class="op" id="4142770">.</span><span class="ident" id="4142771">w</span><span class="op" id="4142772">.</span><span class="ident" id="4142773">Flush</span><span class="op" id="4142778">(</span><span class="op" id="4142779">)</span>&nbsp;&nbsp;<span class="comment" id="4142782">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4142817">w</span><span class="op" id="4142818">.</span><span class="ident" id="4142819">cw</span><span class="op" id="4142821">.</span><span class="ident" id="4142822">flush</span><span class="op" id="4142827">(</span><span class="op" id="4142828">)</span>&nbsp;<span class="comment" id="4142830">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4142882">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4142962">if</span>&nbsp;<span class="op" id="4142965">!</span><span class="ident" id="4142966">w</span><span class="op" id="4142967">.</span><span class="ident" id="4142968">cw</span><span class="op" id="4142970">.</span><span class="ident" id="4142971">chunking</span>&nbsp;<span class="op" id="4142980">&amp;&amp;</span>&nbsp;<span class="ident" id="4142983">w</span><span class="op" id="4142984">.</span><span class="ident" id="4142985">bodyAllowed</span><span class="op" id="4142996">(</span><span class="op" id="4142997">)</span>&nbsp;<span class="op" id="4142999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143003">n0</span><span class="op" id="4143005">,</span>&nbsp;<span class="ident" id="4143007">err</span>&nbsp;<span class="op" id="4143011">:=</span>&nbsp;<span class="ident" id="4143014">rf</span><span class="op" id="4143016">.</span><span class="ident" id="4143017">ReadFrom</span><span class="op" id="4143025">(</span><span class="ident" id="4143026">src</span><span class="op" id="4143029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143033">n</span>&nbsp;<span class="op" id="4143035">+=</span>&nbsp;<span class="ident" id="4143038">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143043">w</span><span class="op" id="4143044">.</span><span class="ident" id="4143045">written</span>&nbsp;<span class="op" id="4143053">+=</span>&nbsp;<span class="ident" id="4143056">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4143061">return</span>&nbsp;<span class="ident" id="4143068">n</span><span class="op" id="4143069">,</span>&nbsp;<span class="ident" id="4143071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4143076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143080">n0</span><span class="op" id="4143082">,</span>&nbsp;<span class="ident" id="4143084">err</span>&nbsp;<span class="op" id="4143088">:=</span>&nbsp;<span class="ident" id="4143091">io</span><span class="op" id="4143093">.</span><span class="ident" id="4143094">Copy</span><span class="op" id="4143098">(</span><span class="ident" id="4143099">writerOnly</span><span class="op" id="4143109">{</span><span class="ident" id="4143110">w</span><span class="op" id="4143111">}</span><span class="op" id="4143112">,</span>&nbsp;<span class="ident" id="4143114">src</span><span class="op" id="4143117">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143120">n</span>&nbsp;<span class="op" id="4143122">+=</span>&nbsp;<span class="ident" id="4143125">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4143129">return</span>&nbsp;<span class="ident" id="4143136">n</span><span class="op" id="4143137">,</span>&nbsp;<span class="ident" id="4143139">err</span><br>
<span class="lineno"></span><span class="op" id="4143143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4143146">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="4143215">const</span>&nbsp;<span class="ident" id="4143221">noLimit</span>&nbsp;<span class="ident" id="4143229">int64</span>&nbsp;<span class="op" id="4143235">=</span>&nbsp;<span class="op" id="4143237">(</span><span class="num" id="4143238">1</span>&nbsp;<span class="op" id="4143240">&lt;&lt;</span>&nbsp;<span class="num" id="4143243">63</span><span class="op" id="4143245">)</span>&nbsp;<span class="op" id="4143247">-</span>&nbsp;<span class="num" id="4143249">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4143252">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="4143330">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="4143365">const</span>&nbsp;<span class="ident" id="4143371">debugServerConnections</span>&nbsp;<span class="op" id="4143394">=</span>&nbsp;<span class="builtintype" id="4143396">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="4143403">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="4143438">func</span>&nbsp;<span class="op" id="4143443">(</span><span class="ident" id="4143444">srv</span>&nbsp;<span class="op" id="4143448">*</span><span class="ident" id="4143449">Server</span><span class="op" id="4143455">)</span>&nbsp;<span class="ident" id="4143457">newConn</span><span class="op" id="4143464">(</span><span class="ident" id="4143465">rwc</span>&nbsp;<span class="ident" id="4143469">net</span><span class="op" id="4143472">.</span><span class="ident" id="4143473">Conn</span><span class="op" id="4143477">)</span>&nbsp;<span class="op" id="4143479">(</span><span class="ident" id="4143480">c</span>&nbsp;<span class="op" id="4143482">*</span><span class="ident" id="4143483">conn</span><span class="op" id="4143487">,</span>&nbsp;<span class="ident" id="4143489">err</span>&nbsp;<span class="builtintype" id="4143493">error</span><span class="op" id="4143498">)</span>&nbsp;<span class="op" id="4143500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143503">c</span>&nbsp;<span class="op" id="4143505">=</span>&nbsp;<span class="builtinfunc" id="4143507">new</span><span class="op" id="4143510">(</span><span class="ident" id="4143511">conn</span><span class="op" id="4143515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143518">c</span><span class="op" id="4143519">.</span><span class="ident" id="4143520">remoteAddr</span>&nbsp;<span class="op" id="4143531">=</span>&nbsp;<span class="ident" id="4143533">rwc</span><span class="op" id="4143536">.</span><span class="ident" id="4143537">RemoteAddr</span><span class="op" id="4143547">(</span><span class="op" id="4143548">)</span><span class="op" id="4143549">.</span><span class="ident" id="4143550">String</span><span class="op" id="4143556">(</span><span class="op" id="4143557">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143560">c</span><span class="op" id="4143561">.</span><span class="ident" id="4143562">server</span>&nbsp;<span class="op" id="4143569">=</span>&nbsp;<span class="ident" id="4143571">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143576">c</span><span class="op" id="4143577">.</span><span class="ident" id="4143578">rwc</span>&nbsp;<span class="op" id="4143582">=</span>&nbsp;<span class="ident" id="4143584">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143589">c</span><span class="op" id="4143590">.</span><span class="ident" id="4143591">w</span>&nbsp;<span class="op" id="4143593">=</span>&nbsp;<span class="ident" id="4143595">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4143600">if</span>&nbsp;<span class="ident" id="4143603">debugServerConnections</span>&nbsp;<span class="op" id="4143626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143630">c</span><span class="op" id="4143631">.</span><span class="ident" id="4143632">rwc</span>&nbsp;<span class="op" id="4143636">=</span>&nbsp;<span class="ident" id="4143638">newLoggingConn</span><span class="op" id="4143652">(</span><span class="string" id="4143653">&#34;server&#34;</span><span class="op" id="4143661">,</span>&nbsp;<span class="ident" id="4143663">c</span><span class="op" id="4143664">.</span><span class="ident" id="4143665">rwc</span><span class="op" id="4143668">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4143671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143674">c</span><span class="op" id="4143675">.</span><span class="ident" id="4143676">sr</span>&nbsp;<span class="op" id="4143679">=</span>&nbsp;<span class="ident" id="4143681">liveSwitchReader</span><span class="op" id="4143697">{</span><span class="ident" id="4143698">r</span><span class="op" id="4143699">:</span>&nbsp;<span class="ident" id="4143701">c</span><span class="op" id="4143702">.</span><span class="ident" id="4143703">rwc</span><span class="op" id="4143706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143709">c</span><span class="op" id="4143710">.</span><span class="ident" id="4143711">lr</span>&nbsp;<span class="op" id="4143714">=</span>&nbsp;<span class="ident" id="4143716">io</span><span class="op" id="4143718">.</span><span class="ident" id="4143719">LimitReader</span><span class="op" id="4143730">(</span><span class="op" id="4143731">&amp;</span><span class="ident" id="4143732">c</span><span class="op" id="4143733">.</span><span class="ident" id="4143734">sr</span><span class="op" id="4143736">,</span>&nbsp;<span class="ident" id="4143738">noLimit</span><span class="op" id="4143745">)</span><span class="op" id="4143746">.</span><span class="op" id="4143747">(</span><span class="op" id="4143748">*</span><span class="ident" id="4143749">io</span><span class="op" id="4143751">.</span><span class="ident" id="4143752">LimitedReader</span><span class="op" id="4143765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143768">br</span>&nbsp;<span class="op" id="4143771">:=</span>&nbsp;<span class="ident" id="4143774">newBufioReader</span><span class="op" id="4143788">(</span><span class="ident" id="4143789">c</span><span class="op" id="4143790">.</span><span class="ident" id="4143791">lr</span><span class="op" id="4143793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143796">bw</span>&nbsp;<span class="op" id="4143799">:=</span>&nbsp;<span class="ident" id="4143802">newBufioWriterSize</span><span class="op" id="4143820">(</span><span class="ident" id="4143821">checkConnErrorWriter</span><span class="op" id="4143841">{</span><span class="ident" id="4143842">c</span><span class="op" id="4143843">}</span><span class="op" id="4143844">,</span>&nbsp;<span class="num" id="4143846">4</span><span class="op" id="4143847">&lt;&lt;</span><span class="num" id="4143849">10</span><span class="op" id="4143851">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143854">c</span><span class="op" id="4143855">.</span><span class="ident" id="4143856">buf</span>&nbsp;<span class="op" id="4143860">=</span>&nbsp;<span class="ident" id="4143862">bufio</span><span class="op" id="4143867">.</span><span class="ident" id="4143868">NewReadWriter</span><span class="op" id="4143881">(</span><span class="ident" id="4143882">br</span><span class="op" id="4143884">,</span>&nbsp;<span class="ident" id="4143886">bw</span><span class="op" id="4143888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4143891">return</span>&nbsp;<span class="ident" id="4143898">c</span><span class="op" id="4143899">,</span>&nbsp;<span class="builtintype" id="4143901">nil</span><br>
<span class="lineno"></span><span class="op" id="4143905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4143908">var</span>&nbsp;<span class="op" id="4143912">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143915">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4143933">sync</span><span class="op" id="4143937">.</span><span class="ident" id="4143938">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143944">bufioWriter2kPool</span>&nbsp;<span class="ident" id="4143962">sync</span><span class="op" id="4143966">.</span><span class="ident" id="4143967">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4143973">bufioWriter4kPool</span>&nbsp;<span class="ident" id="4143991">sync</span><span class="op" id="4143995">.</span><span class="ident" id="4143996">Pool</span><br>
<span class="lineno"></span><span class="op" id="4144001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="4144004">func</span>&nbsp;<span class="ident" id="4144009">bufioWriterPool</span><span class="op" id="4144024">(</span><span class="ident" id="4144025">size</span>&nbsp;<span class="builtintype" id="4144030">int</span><span class="op" id="4144033">)</span>&nbsp;<span class="op" id="4144035">*</span><span class="ident" id="4144036">sync</span><span class="op" id="4144040">.</span><span class="ident" id="4144041">Pool</span>&nbsp;<span class="op" id="4144046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144049">switch</span>&nbsp;<span class="ident" id="4144056">size</span>&nbsp;<span class="op" id="4144061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144064">case</span>&nbsp;<span class="num" id="4144069">2</span>&nbsp;<span class="op" id="4144071">&lt;&lt;</span>&nbsp;<span class="num" id="4144074">10</span><span class="op" id="4144076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144080">return</span>&nbsp;<span class="op" id="4144087">&amp;</span><span class="ident" id="4144088">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144107">case</span>&nbsp;<span class="num" id="4144112">4</span>&nbsp;<span class="op" id="4144114">&lt;&lt;</span>&nbsp;<span class="num" id="4144117">10</span><span class="op" id="4144119">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144123">return</span>&nbsp;<span class="op" id="4144130">&amp;</span><span class="ident" id="4144131">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4144150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144153">return</span>&nbsp;<span class="builtintype" id="4144160">nil</span><br>
<span class="lineno"></span><span class="op" id="4144164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="4144167">func</span>&nbsp;<span class="ident" id="4144172">newBufioReader</span><span class="op" id="4144186">(</span><span class="ident" id="4144187">r</span>&nbsp;<span class="ident" id="4144189">io</span><span class="op" id="4144191">.</span><span class="ident" id="4144192">Reader</span><span class="op" id="4144198">)</span>&nbsp;<span class="op" id="4144200">*</span><span class="ident" id="4144201">bufio</span><span class="op" id="4144206">.</span><span class="ident" id="4144207">Reader</span>&nbsp;<span class="op" id="4144214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144217">if</span>&nbsp;<span class="ident" id="4144220">v</span>&nbsp;<span class="op" id="4144222">:=</span>&nbsp;<span class="ident" id="4144225">bufioReaderPool</span><span class="op" id="4144240">.</span><span class="ident" id="4144241">Get</span><span class="op" id="4144244">(</span><span class="op" id="4144245">)</span><span class="op" id="4144246">;</span>&nbsp;<span class="ident" id="4144248">v</span>&nbsp;<span class="op" id="4144250">!=</span>&nbsp;<span class="builtintype" id="4144253">nil</span>&nbsp;<span class="op" id="4144257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144261">br</span>&nbsp;<span class="op" id="4144264">:=</span>&nbsp;<span class="ident" id="4144267">v</span><span class="op" id="4144268">.</span><span class="op" id="4144269">(</span><span class="op" id="4144270">*</span><span class="ident" id="4144271">bufio</span><span class="op" id="4144276">.</span><span class="ident" id="4144277">Reader</span><span class="op" id="4144283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144287">br</span><span class="op" id="4144289">.</span><span class="ident" id="4144290">Reset</span><span class="op" id="4144295">(</span><span class="ident" id="4144296">r</span><span class="op" id="4144297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144301">return</span>&nbsp;<span class="ident" id="4144308">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4144312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144315">return</span>&nbsp;<span class="ident" id="4144322">bufio</span><span class="op" id="4144327">.</span><span class="ident" id="4144328">NewReader</span><span class="op" id="4144337">(</span><span class="ident" id="4144338">r</span><span class="op" id="4144339">)</span><br>
<span class="lineno"></span><span class="op" id="4144341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4144344">func</span>&nbsp;<span class="ident" id="4144349">putBufioReader</span><span class="op" id="4144363">(</span><span class="ident" id="4144364">br</span>&nbsp;<span class="op" id="4144367">*</span><span class="ident" id="4144368">bufio</span><span class="op" id="4144373">.</span><span class="ident" id="4144374">Reader</span><span class="op" id="4144380">)</span>&nbsp;<span class="op" id="4144382">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144385">br</span><span class="op" id="4144387">.</span><span class="ident" id="4144388">Reset</span><span class="op" id="4144393">(</span><span class="builtintype" id="4144394">nil</span><span class="op" id="4144397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144400">bufioReaderPool</span><span class="op" id="4144415">.</span><span class="ident" id="4144416">Put</span><span class="op" id="4144419">(</span><span class="ident" id="4144420">br</span><span class="op" id="4144422">)</span><br>
<span class="lineno"></span><span class="op" id="4144424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4144427">func</span>&nbsp;<span class="ident" id="4144432">newBufioWriterSize</span><span class="op" id="4144450">(</span><span class="ident" id="4144451">w</span>&nbsp;<span class="ident" id="4144453">io</span><span class="op" id="4144455">.</span><span class="ident" id="4144456">Writer</span><span class="op" id="4144462">,</span>&nbsp;<span class="ident" id="4144464">size</span>&nbsp;<span class="builtintype" id="4144469">int</span><span class="op" id="4144472">)</span>&nbsp;<span class="op" id="4144474">*</span><span class="ident" id="4144475">bufio</span><span class="op" id="4144480">.</span><span class="ident" id="4144481">Writer</span>&nbsp;<span class="op" id="4144488">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144491">pool</span>&nbsp;<span class="op" id="4144496">:=</span>&nbsp;<span class="ident" id="4144499">bufioWriterPool</span><span class="op" id="4144514">(</span><span class="ident" id="4144515">size</span><span class="op" id="4144519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144522">if</span>&nbsp;<span class="ident" id="4144525">pool</span>&nbsp;<span class="op" id="4144530">!=</span>&nbsp;<span class="builtintype" id="4144533">nil</span>&nbsp;<span class="op" id="4144537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144541">if</span>&nbsp;<span class="ident" id="4144544">v</span>&nbsp;<span class="op" id="4144546">:=</span>&nbsp;<span class="ident" id="4144549">pool</span><span class="op" id="4144553">.</span><span class="ident" id="4144554">Get</span><span class="op" id="4144557">(</span><span class="op" id="4144558">)</span><span class="op" id="4144559">;</span>&nbsp;<span class="ident" id="4144561">v</span>&nbsp;<span class="op" id="4144563">!=</span>&nbsp;<span class="builtintype" id="4144566">nil</span>&nbsp;<span class="op" id="4144570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144575">bw</span>&nbsp;<span class="op" id="4144578">:=</span>&nbsp;<span class="ident" id="4144581">v</span><span class="op" id="4144582">.</span><span class="op" id="4144583">(</span><span class="op" id="4144584">*</span><span class="ident" id="4144585">bufio</span><span class="op" id="4144590">.</span><span class="ident" id="4144591">Writer</span><span class="op" id="4144597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144602">bw</span><span class="op" id="4144604">.</span><span class="ident" id="4144605">Reset</span><span class="op" id="4144610">(</span><span class="ident" id="4144611">w</span><span class="op" id="4144612">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144617">return</span>&nbsp;<span class="ident" id="4144624">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4144629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4144632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144635">return</span>&nbsp;<span class="ident" id="4144642">bufio</span><span class="op" id="4144647">.</span><span class="ident" id="4144648">NewWriterSize</span><span class="op" id="4144661">(</span><span class="ident" id="4144662">w</span><span class="op" id="4144663">,</span>&nbsp;<span class="ident" id="4144665">size</span><span class="op" id="4144669">)</span><br>
<span class="lineno"></span><span class="op" id="4144671">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="4144674">func</span>&nbsp;<span class="ident" id="4144679">putBufioWriter</span><span class="op" id="4144693">(</span><span class="ident" id="4144694">bw</span>&nbsp;<span class="op" id="4144697">*</span><span class="ident" id="4144698">bufio</span><span class="op" id="4144703">.</span><span class="ident" id="4144704">Writer</span><span class="op" id="4144710">)</span>&nbsp;<span class="op" id="4144712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144715">bw</span><span class="op" id="4144717">.</span><span class="ident" id="4144718">Reset</span><span class="op" id="4144723">(</span><span class="builtintype" id="4144724">nil</span><span class="op" id="4144727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4144730">if</span>&nbsp;<span class="ident" id="4144733">pool</span>&nbsp;<span class="op" id="4144738">:=</span>&nbsp;<span class="ident" id="4144741">bufioWriterPool</span><span class="op" id="4144756">(</span><span class="ident" id="4144757">bw</span><span class="op" id="4144759">.</span><span class="ident" id="4144760">Available</span><span class="op" id="4144769">(</span><span class="op" id="4144770">)</span><span class="op" id="4144771">)</span><span class="op" id="4144772">;</span>&nbsp;<span class="ident" id="4144774">pool</span>&nbsp;<span class="op" id="4144779">!=</span>&nbsp;<span class="builtintype" id="4144782">nil</span>&nbsp;<span class="op" id="4144786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4144790">pool</span><span class="op" id="4144794">.</span><span class="ident" id="4144795">Put</span><span class="op" id="4144798">(</span><span class="ident" id="4144799">bw</span><span class="op" id="4144801">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4144804">}</span><br>
<span class="lineno"></span><span class="op" id="4144806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4144809">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="4144879">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="4144902">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4144962">const</span>&nbsp;<span class="ident" id="4144968">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="4144990">=</span>&nbsp;<span class="num" id="4144992">1</span>&nbsp;<span class="op" id="4144994">&lt;&lt;</span>&nbsp;<span class="num" id="4144997">20</span>&nbsp;<span class="comment" id="4145000">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4145009">func</span>&nbsp;<span class="op" id="4145014">(</span><span class="ident" id="4145015">srv</span>&nbsp;<span class="op" id="4145019">*</span><span class="ident" id="4145020">Server</span><span class="op" id="4145026">)</span>&nbsp;<span class="ident" id="4145028">maxHeaderBytes</span><span class="op" id="4145042">(</span><span class="op" id="4145043">)</span>&nbsp;<span class="builtintype" id="4145045">int</span>&nbsp;<span class="op" id="4145049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145052">if</span>&nbsp;<span class="ident" id="4145055">srv</span><span class="op" id="4145058">.</span><span class="ident" id="4145059">MaxHeaderBytes</span>&nbsp;<span class="op" id="4145074">&gt;</span>&nbsp;<span class="num" id="4145076">0</span>&nbsp;<span class="op" id="4145078">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145082">return</span>&nbsp;<span class="ident" id="4145089">srv</span><span class="op" id="4145092">.</span><span class="ident" id="4145093">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4145109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145112">return</span>&nbsp;<span class="ident" id="4145119">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="4145141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="4145144">func</span>&nbsp;<span class="op" id="4145149">(</span><span class="ident" id="4145150">srv</span>&nbsp;<span class="op" id="4145154">*</span><span class="ident" id="4145155">Server</span><span class="op" id="4145161">)</span>&nbsp;<span class="ident" id="4145163">initialLimitedReaderSize</span><span class="op" id="4145187">(</span><span class="op" id="4145188">)</span>&nbsp;<span class="ident" id="4145190">int64</span>&nbsp;<span class="op" id="4145196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145199">return</span>&nbsp;<span class="ident" id="4145206">int64</span><span class="op" id="4145211">(</span><span class="ident" id="4145212">srv</span><span class="op" id="4145215">.</span><span class="ident" id="4145216">maxHeaderBytes</span><span class="op" id="4145230">(</span><span class="op" id="4145231">)</span><span class="op" id="4145232">)</span>&nbsp;<span class="op" id="4145234">+</span>&nbsp;<span class="num" id="4145236">4096</span>&nbsp;<span class="comment" id="4145241">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="4145255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4145258">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="4145322">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4145354">type</span>&nbsp;<span class="ident" id="4145359">expectContinueReader</span>&nbsp;<span class="keyword" id="4145380">struct</span>&nbsp;<span class="op" id="4145387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145390">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4145401">*</span><span class="ident" id="4145402">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145412">readCloser</span>&nbsp;<span class="ident" id="4145423">io</span><span class="op" id="4145425">.</span><span class="ident" id="4145426">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145438">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4145449">bool</span><br>
<span class="lineno">520</span><span class="op" id="4145454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4145457">func</span>&nbsp;<span class="op" id="4145462">(</span><span class="ident" id="4145463">ecr</span>&nbsp;<span class="op" id="4145467">*</span><span class="ident" id="4145468">expectContinueReader</span><span class="op" id="4145488">)</span>&nbsp;<span class="ident" id="4145490">Read</span><span class="op" id="4145494">(</span><span class="ident" id="4145495">p</span>&nbsp;<span class="op" id="4145497">[</span><span class="op" id="4145498">]</span><span class="builtintype" id="4145499">byte</span><span class="op" id="4145503">)</span>&nbsp;<span class="op" id="4145505">(</span><span class="ident" id="4145506">n</span>&nbsp;<span class="builtintype" id="4145508">int</span><span class="op" id="4145511">,</span>&nbsp;<span class="ident" id="4145513">err</span>&nbsp;<span class="builtintype" id="4145517">error</span><span class="op" id="4145522">)</span>&nbsp;<span class="op" id="4145524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145527">if</span>&nbsp;<span class="ident" id="4145530">ecr</span><span class="op" id="4145533">.</span><span class="ident" id="4145534">closed</span>&nbsp;<span class="op" id="4145541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145545">return</span>&nbsp;<span class="num" id="4145552">0</span><span class="op" id="4145553">,</span>&nbsp;<span class="ident" id="4145555">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4145578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145581">if</span>&nbsp;<span class="op" id="4145584">!</span><span class="ident" id="4145585">ecr</span><span class="op" id="4145588">.</span><span class="ident" id="4145589">resp</span><span class="op" id="4145593">.</span><span class="ident" id="4145594">wroteContinue</span>&nbsp;<span class="op" id="4145608">&amp;&amp;</span>&nbsp;<span class="op" id="4145611">!</span><span class="ident" id="4145612">ecr</span><span class="op" id="4145615">.</span><span class="ident" id="4145616">resp</span><span class="op" id="4145620">.</span><span class="ident" id="4145621">conn</span><span class="op" id="4145625">.</span><span class="ident" id="4145626">hijacked</span><span class="op" id="4145634">(</span><span class="op" id="4145635">)</span>&nbsp;<span class="op" id="4145637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145641">ecr</span><span class="op" id="4145644">.</span><span class="ident" id="4145645">resp</span><span class="op" id="4145649">.</span><span class="ident" id="4145650">wroteContinue</span>&nbsp;<span class="op" id="4145664">=</span>&nbsp;<span class="builtintype" id="4145666">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145673">ecr</span><span class="op" id="4145676">.</span><span class="ident" id="4145677">resp</span><span class="op" id="4145681">.</span><span class="ident" id="4145682">conn</span><span class="op" id="4145686">.</span><span class="ident" id="4145687">buf</span><span class="op" id="4145690">.</span><span class="ident" id="4145691">WriteString</span><span class="op" id="4145702">(</span><span class="string" id="4145703">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="4145734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145738">ecr</span><span class="op" id="4145741">.</span><span class="ident" id="4145742">resp</span><span class="op" id="4145746">.</span><span class="ident" id="4145747">conn</span><span class="op" id="4145751">.</span><span class="ident" id="4145752">buf</span><span class="op" id="4145755">.</span><span class="ident" id="4145756">Flush</span><span class="op" id="4145761">(</span><span class="op" id="4145762">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4145765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145768">return</span>&nbsp;<span class="ident" id="4145775">ecr</span><span class="op" id="4145778">.</span><span class="ident" id="4145779">readCloser</span><span class="op" id="4145789">.</span><span class="ident" id="4145790">Read</span><span class="op" id="4145794">(</span><span class="ident" id="4145795">p</span><span class="op" id="4145796">)</span><br>
<span class="lineno"></span><span class="op" id="4145798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4145801">func</span>&nbsp;<span class="op" id="4145806">(</span><span class="ident" id="4145807">ecr</span>&nbsp;<span class="op" id="4145811">*</span><span class="ident" id="4145812">expectContinueReader</span><span class="op" id="4145832">)</span>&nbsp;<span class="ident" id="4145834">Close</span><span class="op" id="4145839">(</span><span class="op" id="4145840">)</span>&nbsp;<span class="builtintype" id="4145842">error</span>&nbsp;<span class="op" id="4145848">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4145851">ecr</span><span class="op" id="4145854">.</span><span class="ident" id="4145855">closed</span>&nbsp;<span class="op" id="4145862">=</span>&nbsp;<span class="builtintype" id="4145864">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4145870">return</span>&nbsp;<span class="ident" id="4145877">ecr</span><span class="op" id="4145880">.</span><span class="ident" id="4145881">readCloser</span><span class="op" id="4145891">.</span><span class="ident" id="4145892">Close</span><span class="op" id="4145897">(</span><span class="op" id="4145898">)</span><br>
<span class="lineno"></span><span class="op" id="4145900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4145903">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="4145948">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="4145996">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="4146036">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="4146100">const</span>&nbsp;<span class="ident" id="4146106">TimeFormat</span>&nbsp;<span class="op" id="4146117">=</span>&nbsp;<span class="string" id="4146119">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="4146152">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="4146232">func</span>&nbsp;<span class="ident" id="4146237">appendTime</span><span class="op" id="4146247">(</span><span class="ident" id="4146248">b</span>&nbsp;<span class="op" id="4146250">[</span><span class="op" id="4146251">]</span><span class="builtintype" id="4146252">byte</span><span class="op" id="4146256">,</span>&nbsp;<span class="ident" id="4146258">t</span>&nbsp;<span class="ident" id="4146260">time</span><span class="op" id="4146264">.</span><span class="ident" id="4146265">Time</span><span class="op" id="4146269">)</span>&nbsp;<span class="op" id="4146271">[</span><span class="op" id="4146272">]</span><span class="builtintype" id="4146273">byte</span>&nbsp;<span class="op" id="4146278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4146281">const</span>&nbsp;<span class="ident" id="4146287">days</span>&nbsp;<span class="op" id="4146292">=</span>&nbsp;<span class="string" id="4146294">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4146319">const</span>&nbsp;<span class="ident" id="4146325">months</span>&nbsp;<span class="op" id="4146332">=</span>&nbsp;<span class="string" id="4146334">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146375">t</span>&nbsp;<span class="op" id="4146377">=</span>&nbsp;<span class="ident" id="4146379">t</span><span class="op" id="4146380">.</span><span class="ident" id="4146381">UTC</span><span class="op" id="4146384">(</span><span class="op" id="4146385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146388">yy</span><span class="op" id="4146390">,</span>&nbsp;<span class="ident" id="4146392">mm</span><span class="op" id="4146394">,</span>&nbsp;<span class="ident" id="4146396">dd</span>&nbsp;<span class="op" id="4146399">:=</span>&nbsp;<span class="ident" id="4146402">t</span><span class="op" id="4146403">.</span><span class="ident" id="4146404">Date</span><span class="op" id="4146408">(</span><span class="op" id="4146409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146412">hh</span><span class="op" id="4146414">,</span>&nbsp;<span class="ident" id="4146416">mn</span><span class="op" id="4146418">,</span>&nbsp;<span class="ident" id="4146420">ss</span>&nbsp;<span class="op" id="4146423">:=</span>&nbsp;<span class="ident" id="4146426">t</span><span class="op" id="4146427">.</span><span class="ident" id="4146428">Clock</span><span class="op" id="4146433">(</span><span class="op" id="4146434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146437">day</span>&nbsp;<span class="op" id="4146441">:=</span>&nbsp;<span class="ident" id="4146444">days</span><span class="op" id="4146448">[</span><span class="num" id="4146449">3</span><span class="op" id="4146450">*</span><span class="ident" id="4146451">t</span><span class="op" id="4146452">.</span><span class="ident" id="4146453">Weekday</span><span class="op" id="4146460">(</span><span class="op" id="4146461">)</span><span class="op" id="4146462">:</span><span class="op" id="4146463">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146466">mon</span>&nbsp;<span class="op" id="4146470">:=</span>&nbsp;<span class="ident" id="4146473">months</span><span class="op" id="4146479">[</span><span class="num" id="4146480">3</span><span class="op" id="4146481">*</span><span class="op" id="4146482">(</span><span class="ident" id="4146483">mm</span><span class="op" id="4146485">-</span><span class="num" id="4146486">1</span><span class="op" id="4146487">)</span><span class="op" id="4146488">:</span><span class="op" id="4146489">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4146493">return</span>&nbsp;<span class="builtinfunc" id="4146500">append</span><span class="op" id="4146506">(</span><span class="ident" id="4146507">b</span><span class="op" id="4146508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146512">day</span><span class="op" id="4146515">[</span><span class="num" id="4146516">0</span><span class="op" id="4146517">]</span><span class="op" id="4146518">,</span>&nbsp;<span class="ident" id="4146520">day</span><span class="op" id="4146523">[</span><span class="num" id="4146524">1</span><span class="op" id="4146525">]</span><span class="op" id="4146526">,</span>&nbsp;<span class="ident" id="4146528">day</span><span class="op" id="4146531">[</span><span class="num" id="4146532">2</span><span class="op" id="4146533">]</span><span class="op" id="4146534">,</span>&nbsp;<span class="string" id="4146536">&#39;,&#39;</span><span class="op" id="4146539">,</span>&nbsp;<span class="string" id="4146541">&#39;&nbsp;&#39;</span><span class="op" id="4146544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4146548">byte</span><span class="op" id="4146552">(</span><span class="string" id="4146553">&#39;0&#39;</span><span class="op" id="4146556">+</span><span class="ident" id="4146557">dd</span><span class="op" id="4146559">/</span><span class="num" id="4146560">10</span><span class="op" id="4146562">)</span><span class="op" id="4146563">,</span>&nbsp;<span class="builtintype" id="4146565">byte</span><span class="op" id="4146569">(</span><span class="string" id="4146570">&#39;0&#39;</span><span class="op" id="4146573">+</span><span class="ident" id="4146574">dd</span><span class="op" id="4146576">%</span><span class="num" id="4146577">10</span><span class="op" id="4146579">)</span><span class="op" id="4146580">,</span>&nbsp;<span class="string" id="4146582">&#39;&nbsp;&#39;</span><span class="op" id="4146585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4146589">mon</span><span class="op" id="4146592">[</span><span class="num" id="4146593">0</span><span class="op" id="4146594">]</span><span class="op" id="4146595">,</span>&nbsp;<span class="ident" id="4146597">mon</span><span class="op" id="4146600">[</span><span class="num" id="4146601">1</span><span class="op" id="4146602">]</span><span class="op" id="4146603">,</span>&nbsp;<span class="ident" id="4146605">mon</span><span class="op" id="4146608">[</span><span class="num" id="4146609">2</span><span class="op" id="4146610">]</span><span class="op" id="4146611">,</span>&nbsp;<span class="string" id="4146613">&#39;&nbsp;&#39;</span><span class="op" id="4146616">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4146620">byte</span><span class="op" id="4146624">(</span><span class="string" id="4146625">&#39;0&#39;</span><span class="op" id="4146628">+</span><span class="ident" id="4146629">yy</span><span class="op" id="4146631">/</span><span class="num" id="4146632">1000</span><span class="op" id="4146636">)</span><span class="op" id="4146637">,</span>&nbsp;<span class="builtintype" id="4146639">byte</span><span class="op" id="4146643">(</span><span class="string" id="4146644">&#39;0&#39;</span><span class="op" id="4146647">+</span><span class="op" id="4146648">(</span><span class="ident" id="4146649">yy</span><span class="op" id="4146651">/</span><span class="num" id="4146652">100</span><span class="op" id="4146655">)</span><span class="op" id="4146656">%</span><span class="num" id="4146657">10</span><span class="op" id="4146659">)</span><span class="op" id="4146660">,</span>&nbsp;<span class="builtintype" id="4146662">byte</span><span class="op" id="4146666">(</span><span class="string" id="4146667">&#39;0&#39;</span><span class="op" id="4146670">+</span><span class="op" id="4146671">(</span><span class="ident" id="4146672">yy</span><span class="op" id="4146674">/</span><span class="num" id="4146675">10</span><span class="op" id="4146677">)</span><span class="op" id="4146678">%</span><span class="num" id="4146679">10</span><span class="op" id="4146681">)</span><span class="op" id="4146682">,</span>&nbsp;<span class="builtintype" id="4146684">byte</span><span class="op" id="4146688">(</span><span class="string" id="4146689">&#39;0&#39;</span><span class="op" id="4146692">+</span><span class="ident" id="4146693">yy</span><span class="op" id="4146695">%</span><span class="num" id="4146696">10</span><span class="op" id="4146698">)</span><span class="op" id="4146699">,</span>&nbsp;<span class="string" id="4146701">&#39;&nbsp;&#39;</span><span class="op" id="4146704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4146708">byte</span><span class="op" id="4146712">(</span><span class="string" id="4146713">&#39;0&#39;</span><span class="op" id="4146716">+</span><span class="ident" id="4146717">hh</span><span class="op" id="4146719">/</span><span class="num" id="4146720">10</span><span class="op" id="4146722">)</span><span class="op" id="4146723">,</span>&nbsp;<span class="builtintype" id="4146725">byte</span><span class="op" id="4146729">(</span><span class="string" id="4146730">&#39;0&#39;</span><span class="op" id="4146733">+</span><span class="ident" id="4146734">hh</span><span class="op" id="4146736">%</span><span class="num" id="4146737">10</span><span class="op" id="4146739">)</span><span class="op" id="4146740">,</span>&nbsp;<span class="string" id="4146742">&#39;:&#39;</span><span class="op" id="4146745">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4146749">byte</span><span class="op" id="4146753">(</span><span class="string" id="4146754">&#39;0&#39;</span><span class="op" id="4146757">+</span><span class="ident" id="4146758">mn</span><span class="op" id="4146760">/</span><span class="num" id="4146761">10</span><span class="op" id="4146763">)</span><span class="op" id="4146764">,</span>&nbsp;<span class="builtintype" id="4146766">byte</span><span class="op" id="4146770">(</span><span class="string" id="4146771">&#39;0&#39;</span><span class="op" id="4146774">+</span><span class="ident" id="4146775">mn</span><span class="op" id="4146777">%</span><span class="num" id="4146778">10</span><span class="op" id="4146780">)</span><span class="op" id="4146781">,</span>&nbsp;<span class="string" id="4146783">&#39;:&#39;</span><span class="op" id="4146786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4146790">byte</span><span class="op" id="4146794">(</span><span class="string" id="4146795">&#39;0&#39;</span><span class="op" id="4146798">+</span><span class="ident" id="4146799">ss</span><span class="op" id="4146801">/</span><span class="num" id="4146802">10</span><span class="op" id="4146804">)</span><span class="op" id="4146805">,</span>&nbsp;<span class="builtintype" id="4146807">byte</span><span class="op" id="4146811">(</span><span class="string" id="4146812">&#39;0&#39;</span><span class="op" id="4146815">+</span><span class="ident" id="4146816">ss</span><span class="op" id="4146818">%</span><span class="num" id="4146819">10</span><span class="op" id="4146821">)</span><span class="op" id="4146822">,</span>&nbsp;<span class="string" id="4146824">&#39;&nbsp;&#39;</span><span class="op" id="4146827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4146831">&#39;G&#39;</span><span class="op" id="4146834">,</span>&nbsp;<span class="string" id="4146836">&#39;M&#39;</span><span class="op" id="4146839">,</span>&nbsp;<span class="string" id="4146841">&#39;T&#39;</span><span class="op" id="4146844">)</span><br>
<span class="lineno">565</span><span class="op" id="4146846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4146849">var</span>&nbsp;<span class="ident" id="4146853">errTooLarge</span>&nbsp;<span class="op" id="4146865">=</span>&nbsp;<span class="ident" id="4146867">errors</span><span class="op" id="4146873">.</span><span class="ident" id="4146874">New</span><span class="op" id="4146877">(</span><span class="string" id="4146878">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="4146903">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4146906">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="4146944">func</span>&nbsp;<span class="op" id="4146949">(</span><span class="ident" id="4146950">c</span>&nbsp;<span class="op" id="4146952">*</span><span class="ident" id="4146953">conn</span><span class="op" id="4146957">)</span>&nbsp;<span class="ident" id="4146959">readRequest</span><span class="op" id="4146970">(</span><span class="op" id="4146971">)</span>&nbsp;<span class="op" id="4146973">(</span><span class="ident" id="4146974">w</span>&nbsp;<span class="op" id="4146976">*</span><span class="ident" id="4146977">response</span><span class="op" id="4146985">,</span>&nbsp;<span class="ident" id="4146987">err</span>&nbsp;<span class="builtintype" id="4146991">error</span><span class="op" id="4146996">)</span>&nbsp;<span class="op" id="4146998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147001">if</span>&nbsp;<span class="ident" id="4147004">c</span><span class="op" id="4147005">.</span><span class="ident" id="4147006">hijacked</span><span class="op" id="4147014">(</span><span class="op" id="4147015">)</span>&nbsp;<span class="op" id="4147017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147021">return</span>&nbsp;<span class="builtintype" id="4147028">nil</span><span class="op" id="4147031">,</span>&nbsp;<span class="ident" id="4147033">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147050">if</span>&nbsp;<span class="ident" id="4147053">d</span>&nbsp;<span class="op" id="4147055">:=</span>&nbsp;<span class="ident" id="4147058">c</span><span class="op" id="4147059">.</span><span class="ident" id="4147060">server</span><span class="op" id="4147066">.</span><span class="ident" id="4147067">ReadTimeout</span><span class="op" id="4147078">;</span>&nbsp;<span class="ident" id="4147080">d</span>&nbsp;<span class="op" id="4147082">!=</span>&nbsp;<span class="num" id="4147085">0</span>&nbsp;<span class="op" id="4147087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147091">c</span><span class="op" id="4147092">.</span><span class="ident" id="4147093">rwc</span><span class="op" id="4147096">.</span><span class="ident" id="4147097">SetReadDeadline</span><span class="op" id="4147112">(</span><span class="ident" id="4147113">time</span><span class="op" id="4147117">.</span><span class="ident" id="4147118">Now</span><span class="op" id="4147121">(</span><span class="op" id="4147122">)</span><span class="op" id="4147123">.</span><span class="ident" id="4147124">Add</span><span class="op" id="4147127">(</span><span class="ident" id="4147128">d</span><span class="op" id="4147129">)</span><span class="op" id="4147130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147136">if</span>&nbsp;<span class="ident" id="4147139">d</span>&nbsp;<span class="op" id="4147141">:=</span>&nbsp;<span class="ident" id="4147144">c</span><span class="op" id="4147145">.</span><span class="ident" id="4147146">server</span><span class="op" id="4147152">.</span><span class="ident" id="4147153">WriteTimeout</span><span class="op" id="4147165">;</span>&nbsp;<span class="ident" id="4147167">d</span>&nbsp;<span class="op" id="4147169">!=</span>&nbsp;<span class="num" id="4147172">0</span>&nbsp;<span class="op" id="4147174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147178">defer</span>&nbsp;<span class="keyword" id="4147184">func</span><span class="op" id="4147188">(</span><span class="op" id="4147189">)</span>&nbsp;<span class="op" id="4147191">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147196">c</span><span class="op" id="4147197">.</span><span class="ident" id="4147198">rwc</span><span class="op" id="4147201">.</span><span class="ident" id="4147202">SetWriteDeadline</span><span class="op" id="4147218">(</span><span class="ident" id="4147219">time</span><span class="op" id="4147223">.</span><span class="ident" id="4147224">Now</span><span class="op" id="4147227">(</span><span class="op" id="4147228">)</span><span class="op" id="4147229">.</span><span class="ident" id="4147230">Add</span><span class="op" id="4147233">(</span><span class="ident" id="4147234">d</span><span class="op" id="4147235">)</span><span class="op" id="4147236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147240">}</span><span class="op" id="4147241">(</span><span class="op" id="4147242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147249">c</span><span class="op" id="4147250">.</span><span class="ident" id="4147251">lr</span><span class="op" id="4147253">.</span><span class="ident" id="4147254">N</span>&nbsp;<span class="op" id="4147256">=</span>&nbsp;<span class="ident" id="4147258">c</span><span class="op" id="4147259">.</span><span class="ident" id="4147260">server</span><span class="op" id="4147266">.</span><span class="ident" id="4147267">initialLimitedReaderSize</span><span class="op" id="4147291">(</span><span class="op" id="4147292">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147295">var</span>&nbsp;<span class="ident" id="4147299">req</span>&nbsp;<span class="op" id="4147303">*</span><span class="ident" id="4147304">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147313">if</span>&nbsp;<span class="ident" id="4147316">req</span><span class="op" id="4147319">,</span>&nbsp;<span class="ident" id="4147321">err</span>&nbsp;<span class="op" id="4147325">=</span>&nbsp;<span class="ident" id="4147327">ReadRequest</span><span class="op" id="4147338">(</span><span class="ident" id="4147339">c</span><span class="op" id="4147340">.</span><span class="ident" id="4147341">buf</span><span class="op" id="4147344">.</span><span class="ident" id="4147345">Reader</span><span class="op" id="4147351">)</span><span class="op" id="4147352">;</span>&nbsp;<span class="ident" id="4147354">err</span>&nbsp;<span class="op" id="4147358">!=</span>&nbsp;<span class="builtintype" id="4147361">nil</span>&nbsp;<span class="op" id="4147365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147369">if</span>&nbsp;<span class="ident" id="4147372">c</span><span class="op" id="4147373">.</span><span class="ident" id="4147374">lr</span><span class="op" id="4147376">.</span><span class="ident" id="4147377">N</span>&nbsp;<span class="op" id="4147379">==</span>&nbsp;<span class="num" id="4147382">0</span>&nbsp;<span class="op" id="4147384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147389">return</span>&nbsp;<span class="builtintype" id="4147396">nil</span><span class="op" id="4147399">,</span>&nbsp;<span class="ident" id="4147401">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147415">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147419">return</span>&nbsp;<span class="builtintype" id="4147426">nil</span><span class="op" id="4147429">,</span>&nbsp;<span class="ident" id="4147431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147439">c</span><span class="op" id="4147440">.</span><span class="ident" id="4147441">lr</span><span class="op" id="4147443">.</span><span class="ident" id="4147444">N</span>&nbsp;<span class="op" id="4147446">=</span>&nbsp;<span class="ident" id="4147448">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147458">req</span><span class="op" id="4147461">.</span><span class="ident" id="4147462">RemoteAddr</span>&nbsp;<span class="op" id="4147473">=</span>&nbsp;<span class="ident" id="4147475">c</span><span class="op" id="4147476">.</span><span class="ident" id="4147477">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147489">req</span><span class="op" id="4147492">.</span><span class="ident" id="4147493">TLS</span>&nbsp;<span class="op" id="4147497">=</span>&nbsp;<span class="ident" id="4147499">c</span><span class="op" id="4147500">.</span><span class="ident" id="4147501">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147512">w</span>&nbsp;<span class="op" id="4147514">=</span>&nbsp;<span class="op" id="4147516">&amp;</span><span class="ident" id="4147517">response</span><span class="op" id="4147525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147529">conn</span><span class="op" id="4147533">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147544">c</span><span class="op" id="4147545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147549">req</span><span class="op" id="4147552">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147564">req</span><span class="op" id="4147567">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147571">handlerHeader</span><span class="op" id="4147584">:</span>&nbsp;<span class="builtinfunc" id="4147586">make</span><span class="op" id="4147590">(</span><span class="ident" id="4147591">Header</span><span class="op" id="4147597">)</span><span class="op" id="4147598">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147602">contentLength</span><span class="op" id="4147615">:</span>&nbsp;<span class="op" id="4147617">-</span><span class="num" id="4147618">1</span><span class="op" id="4147619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4147622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147625">w</span><span class="op" id="4147626">.</span><span class="ident" id="4147627">cw</span><span class="op" id="4147629">.</span><span class="ident" id="4147630">res</span>&nbsp;<span class="op" id="4147634">=</span>&nbsp;<span class="ident" id="4147636">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147639">w</span><span class="op" id="4147640">.</span><span class="ident" id="4147641">w</span>&nbsp;<span class="op" id="4147643">=</span>&nbsp;<span class="ident" id="4147645">newBufioWriterSize</span><span class="op" id="4147663">(</span><span class="op" id="4147664">&amp;</span><span class="ident" id="4147665">w</span><span class="op" id="4147666">.</span><span class="ident" id="4147667">cw</span><span class="op" id="4147669">,</span>&nbsp;<span class="ident" id="4147671">bufferBeforeChunkingSize</span><span class="op" id="4147695">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147698">return</span>&nbsp;<span class="ident" id="4147705">w</span><span class="op" id="4147706">,</span>&nbsp;<span class="builtintype" id="4147708">nil</span><br>
<span class="lineno"></span><span class="op" id="4147712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4147715">func</span>&nbsp;<span class="op" id="4147720">(</span><span class="ident" id="4147721">w</span>&nbsp;<span class="op" id="4147723">*</span><span class="ident" id="4147724">response</span><span class="op" id="4147732">)</span>&nbsp;<span class="ident" id="4147734">Header</span><span class="op" id="4147740">(</span><span class="op" id="4147741">)</span>&nbsp;<span class="ident" id="4147743">Header</span>&nbsp;<span class="op" id="4147750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147753">if</span>&nbsp;<span class="ident" id="4147756">w</span><span class="op" id="4147757">.</span><span class="ident" id="4147758">cw</span><span class="op" id="4147760">.</span><span class="ident" id="4147761">header</span>&nbsp;<span class="op" id="4147768">==</span>&nbsp;<span class="builtintype" id="4147771">nil</span>&nbsp;<span class="op" id="4147775">&amp;&amp;</span>&nbsp;<span class="ident" id="4147778">w</span><span class="op" id="4147779">.</span><span class="ident" id="4147780">wroteHeader</span>&nbsp;<span class="op" id="4147792">&amp;&amp;</span>&nbsp;<span class="op" id="4147795">!</span><span class="ident" id="4147796">w</span><span class="op" id="4147797">.</span><span class="ident" id="4147798">cw</span><span class="op" id="4147800">.</span><span class="ident" id="4147801">wroteHeader</span>&nbsp;<span class="op" id="4147813">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4147817">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4147872">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4147929">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4147983">w</span><span class="op" id="4147984">.</span><span class="ident" id="4147985">cw</span><span class="op" id="4147987">.</span><span class="ident" id="4147988">header</span>&nbsp;<span class="op" id="4147995">=</span>&nbsp;<span class="ident" id="4147997">w</span><span class="op" id="4147998">.</span><span class="ident" id="4147999">handlerHeader</span><span class="op" id="4148012">.</span><span class="ident" id="4148013">clone</span><span class="op" id="4148018">(</span><span class="op" id="4148019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4148022">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4148025">w</span><span class="op" id="4148026">.</span><span class="ident" id="4148027">calledHeader</span>&nbsp;<span class="op" id="4148040">=</span>&nbsp;<span class="builtintype" id="4148042">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148048">return</span>&nbsp;<span class="ident" id="4148055">w</span><span class="op" id="4148056">.</span><span class="ident" id="4148057">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="4148071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4148074">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="4148145">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4148212">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="4148282">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="4148350">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4148370">//</span><br>
<span class="lineno">625</span><span class="comment" id="4148373">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4148441">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4148511">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="4148530">const</span>&nbsp;<span class="ident" id="4148536">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4148560">=</span>&nbsp;<span class="num" id="4148562">256</span>&nbsp;<span class="op" id="4148566">&lt;&lt;</span>&nbsp;<span class="num" id="4148569">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="4148573">func</span>&nbsp;<span class="op" id="4148578">(</span><span class="ident" id="4148579">w</span>&nbsp;<span class="op" id="4148581">*</span><span class="ident" id="4148582">response</span><span class="op" id="4148590">)</span>&nbsp;<span class="ident" id="4148592">WriteHeader</span><span class="op" id="4148603">(</span><span class="ident" id="4148604">code</span>&nbsp;<span class="builtintype" id="4148609">int</span><span class="op" id="4148612">)</span>&nbsp;<span class="op" id="4148614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148617">if</span>&nbsp;<span class="ident" id="4148620">w</span><span class="op" id="4148621">.</span><span class="ident" id="4148622">conn</span><span class="op" id="4148626">.</span><span class="ident" id="4148627">hijacked</span><span class="op" id="4148635">(</span><span class="op" id="4148636">)</span>&nbsp;<span class="op" id="4148638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4148642">w</span><span class="op" id="4148643">.</span><span class="ident" id="4148644">conn</span><span class="op" id="4148648">.</span><span class="ident" id="4148649">server</span><span class="op" id="4148655">.</span><span class="ident" id="4148656">logf</span><span class="op" id="4148660">(</span><span class="string" id="4148661">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4148712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148716">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4148724">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148727">if</span>&nbsp;<span class="ident" id="4148730">w</span><span class="op" id="4148731">.</span><span class="ident" id="4148732">wroteHeader</span>&nbsp;<span class="op" id="4148744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4148748">w</span><span class="op" id="4148749">.</span><span class="ident" id="4148750">conn</span><span class="op" id="4148754">.</span><span class="ident" id="4148755">server</span><span class="op" id="4148761">.</span><span class="ident" id="4148762">logf</span><span class="op" id="4148766">(</span><span class="string" id="4148767">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="4148810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148814">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4148822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4148825">w</span><span class="op" id="4148826">.</span><span class="ident" id="4148827">wroteHeader</span>&nbsp;<span class="op" id="4148839">=</span>&nbsp;<span class="builtintype" id="4148841">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4148847">w</span><span class="op" id="4148848">.</span><span class="ident" id="4148849">status</span>&nbsp;<span class="op" id="4148856">=</span>&nbsp;<span class="ident" id="4148858">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148865">if</span>&nbsp;<span class="ident" id="4148868">w</span><span class="op" id="4148869">.</span><span class="ident" id="4148870">calledHeader</span>&nbsp;<span class="op" id="4148883">&amp;&amp;</span>&nbsp;<span class="ident" id="4148886">w</span><span class="op" id="4148887">.</span><span class="ident" id="4148888">cw</span><span class="op" id="4148890">.</span><span class="ident" id="4148891">header</span>&nbsp;<span class="op" id="4148898">==</span>&nbsp;<span class="builtintype" id="4148901">nil</span>&nbsp;<span class="op" id="4148905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4148909">w</span><span class="op" id="4148910">.</span><span class="ident" id="4148911">cw</span><span class="op" id="4148913">.</span><span class="ident" id="4148914">header</span>&nbsp;<span class="op" id="4148921">=</span>&nbsp;<span class="ident" id="4148923">w</span><span class="op" id="4148924">.</span><span class="ident" id="4148925">handlerHeader</span><span class="op" id="4148938">.</span><span class="ident" id="4148939">clone</span><span class="op" id="4148944">(</span><span class="op" id="4148945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4148948">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4148952">if</span>&nbsp;<span class="ident" id="4148955">cl</span>&nbsp;<span class="op" id="4148958">:=</span>&nbsp;<span class="ident" id="4148961">w</span><span class="op" id="4148962">.</span><span class="ident" id="4148963">handlerHeader</span><span class="op" id="4148976">.</span><span class="ident" id="4148977">get</span><span class="op" id="4148980">(</span><span class="string" id="4148981">&#34;Content-Length&#34;</span><span class="op" id="4148997">)</span><span class="op" id="4148998">;</span>&nbsp;<span class="ident" id="4149000">cl</span>&nbsp;<span class="op" id="4149003">!=</span>&nbsp;<span class="string" id="4149006">&#34;&#34;</span>&nbsp;<span class="op" id="4149009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149013">v</span><span class="op" id="4149014">,</span>&nbsp;<span class="ident" id="4149016">err</span>&nbsp;<span class="op" id="4149020">:=</span>&nbsp;<span class="ident" id="4149023">strconv</span><span class="op" id="4149030">.</span><span class="ident" id="4149031">ParseInt</span><span class="op" id="4149039">(</span><span class="ident" id="4149040">cl</span><span class="op" id="4149042">,</span>&nbsp;<span class="num" id="4149044">10</span><span class="op" id="4149046">,</span>&nbsp;<span class="num" id="4149048">64</span><span class="op" id="4149050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4149054">if</span>&nbsp;<span class="ident" id="4149057">err</span>&nbsp;<span class="op" id="4149061">==</span>&nbsp;<span class="builtintype" id="4149064">nil</span>&nbsp;<span class="op" id="4149068">&amp;&amp;</span>&nbsp;<span class="ident" id="4149071">v</span>&nbsp;<span class="op" id="4149073">&gt;=</span>&nbsp;<span class="num" id="4149076">0</span>&nbsp;<span class="op" id="4149078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149083">w</span><span class="op" id="4149084">.</span><span class="ident" id="4149085">contentLength</span>&nbsp;<span class="op" id="4149099">=</span>&nbsp;<span class="ident" id="4149101">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149105">}</span>&nbsp;<span class="keyword" id="4149107">else</span>&nbsp;<span class="op" id="4149112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149117">w</span><span class="op" id="4149118">.</span><span class="ident" id="4149119">conn</span><span class="op" id="4149123">.</span><span class="ident" id="4149124">server</span><span class="op" id="4149130">.</span><span class="ident" id="4149131">logf</span><span class="op" id="4149135">(</span><span class="string" id="4149136">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="4149172">,</span>&nbsp;<span class="ident" id="4149174">cl</span><span class="op" id="4149176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149181">w</span><span class="op" id="4149182">.</span><span class="ident" id="4149183">handlerHeader</span><span class="op" id="4149196">.</span><span class="ident" id="4149197">Del</span><span class="op" id="4149200">(</span><span class="string" id="4149201">&#34;Content-Length&#34;</span><span class="op" id="4149217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149224">}</span><br>
<span class="lineno">655</span><span class="op" id="4149226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4149229">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="4149310">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="4149389">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="4149446">type</span>&nbsp;<span class="ident" id="4149451">extraHeader</span>&nbsp;<span class="keyword" id="4149463">struct</span>&nbsp;<span class="op" id="4149470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149473">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4149490">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149498">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4149515">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149523">transferEncoding</span>&nbsp;<span class="builtintype" id="4149540">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149548">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149565">[</span><span class="op" id="4149566">]</span><span class="builtintype" id="4149567">byte</span>&nbsp;<span class="comment" id="4149572">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149595">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149612">[</span><span class="op" id="4149613">]</span><span class="builtintype" id="4149614">byte</span>&nbsp;<span class="comment" id="4149619">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="4149641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4149644">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="4149692">var</span>&nbsp;<span class="ident" id="4149696">extraHeaderKeys</span>&nbsp;<span class="op" id="4149712">=</span>&nbsp;<span class="op" id="4149714">[</span><span class="op" id="4149715">]</span><span class="op" id="4149716">[</span><span class="op" id="4149717">]</span><span class="builtintype" id="4149718">byte</span><span class="op" id="4149722">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149725">[</span><span class="op" id="4149726">]</span><span class="builtintype" id="4149727">byte</span><span class="op" id="4149731">(</span><span class="string" id="4149732">&#34;Content-Type&#34;</span><span class="op" id="4149746">)</span><span class="op" id="4149747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149750">[</span><span class="op" id="4149751">]</span><span class="builtintype" id="4149752">byte</span><span class="op" id="4149756">(</span><span class="string" id="4149757">&#34;Connection&#34;</span><span class="op" id="4149769">)</span><span class="op" id="4149770">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149773">[</span><span class="op" id="4149774">]</span><span class="builtintype" id="4149775">byte</span><span class="op" id="4149779">(</span><span class="string" id="4149780">&#34;Transfer-Encoding&#34;</span><span class="op" id="4149799">)</span><span class="op" id="4149800">,</span><br>
<span class="lineno"></span><span class="op" id="4149802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="4149805">var</span>&nbsp;<span class="op" id="4149809">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149812">headerContentLength</span>&nbsp;<span class="op" id="4149832">=</span>&nbsp;<span class="op" id="4149834">[</span><span class="op" id="4149835">]</span><span class="builtintype" id="4149836">byte</span><span class="op" id="4149840">(</span><span class="string" id="4149841">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4149859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4149862">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4149882">=</span>&nbsp;<span class="op" id="4149884">[</span><span class="op" id="4149885">]</span><span class="builtintype" id="4149886">byte</span><span class="op" id="4149890">(</span><span class="string" id="4149891">&#34;Date:&nbsp;&#34;</span><span class="op" id="4149899">)</span><br>
<span class="lineno"></span><span class="op" id="4149901">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="4149904">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="4149953">//</span><br>
<span class="lineno"></span><span class="comment" id="4149956">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="4150025">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4150095">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="4150154">func</span>&nbsp;<span class="op" id="4150159">(</span><span class="ident" id="4150160">h</span>&nbsp;<span class="ident" id="4150162">extraHeader</span><span class="op" id="4150173">)</span>&nbsp;<span class="ident" id="4150175">Write</span><span class="op" id="4150180">(</span><span class="ident" id="4150181">w</span>&nbsp;<span class="op" id="4150183">*</span><span class="ident" id="4150184">bufio</span><span class="op" id="4150189">.</span><span class="ident" id="4150190">Writer</span><span class="op" id="4150196">)</span>&nbsp;<span class="op" id="4150198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150201">if</span>&nbsp;<span class="ident" id="4150204">h</span><span class="op" id="4150205">.</span><span class="ident" id="4150206">date</span>&nbsp;<span class="op" id="4150211">!=</span>&nbsp;<span class="builtintype" id="4150214">nil</span>&nbsp;<span class="op" id="4150218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150222">w</span><span class="op" id="4150223">.</span><span class="ident" id="4150224">Write</span><span class="op" id="4150229">(</span><span class="ident" id="4150230">headerDate</span><span class="op" id="4150240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150244">w</span><span class="op" id="4150245">.</span><span class="ident" id="4150246">Write</span><span class="op" id="4150251">(</span><span class="ident" id="4150252">h</span><span class="op" id="4150253">.</span><span class="ident" id="4150254">date</span><span class="op" id="4150258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150262">w</span><span class="op" id="4150263">.</span><span class="ident" id="4150264">Write</span><span class="op" id="4150269">(</span><span class="ident" id="4150270">crlf</span><span class="op" id="4150274">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150280">if</span>&nbsp;<span class="ident" id="4150283">h</span><span class="op" id="4150284">.</span><span class="ident" id="4150285">contentLength</span>&nbsp;<span class="op" id="4150299">!=</span>&nbsp;<span class="builtintype" id="4150302">nil</span>&nbsp;<span class="op" id="4150306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150310">w</span><span class="op" id="4150311">.</span><span class="ident" id="4150312">Write</span><span class="op" id="4150317">(</span><span class="ident" id="4150318">headerContentLength</span><span class="op" id="4150337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150341">w</span><span class="op" id="4150342">.</span><span class="ident" id="4150343">Write</span><span class="op" id="4150348">(</span><span class="ident" id="4150349">h</span><span class="op" id="4150350">.</span><span class="ident" id="4150351">contentLength</span><span class="op" id="4150364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150368">w</span><span class="op" id="4150369">.</span><span class="ident" id="4150370">Write</span><span class="op" id="4150375">(</span><span class="ident" id="4150376">crlf</span><span class="op" id="4150380">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150386">for</span>&nbsp;<span class="ident" id="4150390">i</span><span class="op" id="4150391">,</span>&nbsp;<span class="ident" id="4150393">v</span>&nbsp;<span class="op" id="4150395">:=</span>&nbsp;<span class="keyword" id="4150398">range</span>&nbsp;<span class="op" id="4150404">[</span><span class="op" id="4150405">]</span><span class="builtintype" id="4150406">string</span><span class="op" id="4150412">{</span><span class="ident" id="4150413">h</span><span class="op" id="4150414">.</span><span class="ident" id="4150415">contentType</span><span class="op" id="4150426">,</span>&nbsp;<span class="ident" id="4150428">h</span><span class="op" id="4150429">.</span><span class="ident" id="4150430">connection</span><span class="op" id="4150440">,</span>&nbsp;<span class="ident" id="4150442">h</span><span class="op" id="4150443">.</span><span class="ident" id="4150444">transferEncoding</span><span class="op" id="4150460">}</span>&nbsp;<span class="op" id="4150462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4150466">if</span>&nbsp;<span class="ident" id="4150469">v</span>&nbsp;<span class="op" id="4150471">!=</span>&nbsp;<span class="string" id="4150474">&#34;&#34;</span>&nbsp;<span class="op" id="4150477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150482">w</span><span class="op" id="4150483">.</span><span class="ident" id="4150484">Write</span><span class="op" id="4150489">(</span><span class="ident" id="4150490">extraHeaderKeys</span><span class="op" id="4150505">[</span><span class="ident" id="4150506">i</span><span class="op" id="4150507">]</span><span class="op" id="4150508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150513">w</span><span class="op" id="4150514">.</span><span class="ident" id="4150515">Write</span><span class="op" id="4150520">(</span><span class="ident" id="4150521">colonSpace</span><span class="op" id="4150531">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150536">w</span><span class="op" id="4150537">.</span><span class="ident" id="4150538">WriteString</span><span class="op" id="4150549">(</span><span class="ident" id="4150550">v</span><span class="op" id="4150551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4150556">w</span><span class="op" id="4150557">.</span><span class="ident" id="4150558">Write</span><span class="op" id="4150563">(</span><span class="ident" id="4150564">crlf</span><span class="op" id="4150568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4150575">}</span><br>
<span class="lineno"></span><span class="op" id="4150577">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="4150580">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4150649">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="4150672">//</span><br>
<span class="lineno"></span><span class="comment" id="4150675">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="4150746">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4150816">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4150885">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4150951">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="4150963">func</span>&nbsp;<span class="op" id="4150968">(</span><span class="ident" id="4150969">cw</span>&nbsp;<span class="op" id="4150972">*</span><span class="ident" id="4150973">chunkWriter</span><span class="op" id="4150984">)</span>&nbsp;<span class="ident" id="4150986">writeHeader</span><span class="op" id="4150997">(</span><span class="ident" id="4150998">p</span>&nbsp;<span class="op" id="4151000">[</span><span class="op" id="4151001">]</span><span class="builtintype" id="4151002">byte</span><span class="op" id="4151006">)</span>&nbsp;<span class="op" id="4151008">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151011">if</span>&nbsp;<span class="ident" id="4151014">cw</span><span class="op" id="4151016">.</span><span class="ident" id="4151017">wroteHeader</span>&nbsp;<span class="op" id="4151029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151033">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151044">cw</span><span class="op" id="4151046">.</span><span class="ident" id="4151047">wroteHeader</span>&nbsp;<span class="op" id="4151059">=</span>&nbsp;<span class="builtintype" id="4151061">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151068">w</span>&nbsp;<span class="op" id="4151070">:=</span>&nbsp;<span class="ident" id="4151073">cw</span><span class="op" id="4151075">.</span><span class="ident" id="4151076">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151081">keepAlivesEnabled</span>&nbsp;<span class="op" id="4151099">:=</span>&nbsp;<span class="ident" id="4151102">w</span><span class="op" id="4151103">.</span><span class="ident" id="4151104">conn</span><span class="op" id="4151108">.</span><span class="ident" id="4151109">server</span><span class="op" id="4151115">.</span><span class="ident" id="4151116">doKeepAlives</span><span class="op" id="4151128">(</span><span class="op" id="4151129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151132">isHEAD</span>&nbsp;<span class="op" id="4151139">:=</span>&nbsp;<span class="ident" id="4151142">w</span><span class="op" id="4151143">.</span><span class="ident" id="4151144">req</span><span class="op" id="4151147">.</span><span class="ident" id="4151148">Method</span>&nbsp;<span class="op" id="4151155">==</span>&nbsp;<span class="string" id="4151158">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151167">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151231">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151293">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151349">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151411">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151439">header</span>&nbsp;<span class="op" id="4151446">:=</span>&nbsp;<span class="ident" id="4151449">cw</span><span class="op" id="4151451">.</span><span class="ident" id="4151452">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151460">owned</span>&nbsp;<span class="op" id="4151466">:=</span>&nbsp;<span class="ident" id="4151469">header</span>&nbsp;<span class="op" id="4151476">!=</span>&nbsp;<span class="builtintype" id="4151479">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151484">if</span>&nbsp;<span class="op" id="4151487">!</span><span class="ident" id="4151488">owned</span>&nbsp;<span class="op" id="4151494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151498">header</span>&nbsp;<span class="op" id="4151505">=</span>&nbsp;<span class="ident" id="4151507">w</span><span class="op" id="4151508">.</span><span class="ident" id="4151509">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151527">var</span>&nbsp;<span class="ident" id="4151531">excludeHeader</span>&nbsp;<span class="keyword" id="4151545">map</span><span class="op" id="4151548">[</span><span class="builtintype" id="4151549">string</span><span class="op" id="4151555">]</span><span class="builtintype" id="4151556">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151562">delHeader</span>&nbsp;<span class="op" id="4151572">:=</span>&nbsp;<span class="keyword" id="4151575">func</span><span class="op" id="4151579">(</span><span class="ident" id="4151580">key</span>&nbsp;<span class="builtintype" id="4151584">string</span><span class="op" id="4151590">)</span>&nbsp;<span class="op" id="4151592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151596">if</span>&nbsp;<span class="ident" id="4151599">owned</span>&nbsp;<span class="op" id="4151605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151610">header</span><span class="op" id="4151616">.</span><span class="ident" id="4151617">Del</span><span class="op" id="4151620">(</span><span class="ident" id="4151621">key</span><span class="op" id="4151624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151629">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151638">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151642">if</span>&nbsp;<span class="ident" id="4151645">_</span><span class="op" id="4151646">,</span>&nbsp;<span class="ident" id="4151648">ok</span>&nbsp;<span class="op" id="4151651">:=</span>&nbsp;<span class="ident" id="4151654">header</span><span class="op" id="4151660">[</span><span class="ident" id="4151661">key</span><span class="op" id="4151664">]</span><span class="op" id="4151665">;</span>&nbsp;<span class="op" id="4151667">!</span><span class="ident" id="4151668">ok</span>&nbsp;<span class="op" id="4151671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151676">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151689">if</span>&nbsp;<span class="ident" id="4151692">excludeHeader</span>&nbsp;<span class="op" id="4151706">==</span>&nbsp;<span class="builtintype" id="4151709">nil</span>&nbsp;<span class="op" id="4151713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151718">excludeHeader</span>&nbsp;<span class="op" id="4151732">=</span>&nbsp;<span class="builtinfunc" id="4151734">make</span><span class="op" id="4151738">(</span><span class="keyword" id="4151739">map</span><span class="op" id="4151742">[</span><span class="builtintype" id="4151743">string</span><span class="op" id="4151749">]</span><span class="builtintype" id="4151750">bool</span><span class="op" id="4151754">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4151762">excludeHeader</span><span class="op" id="4151775">[</span><span class="ident" id="4151776">key</span><span class="op" id="4151779">]</span>&nbsp;<span class="op" id="4151781">=</span>&nbsp;<span class="builtintype" id="4151783">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4151789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4151792">var</span>&nbsp;<span class="ident" id="4151796">setHeader</span>&nbsp;<span class="ident" id="4151806">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151820">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151879">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4151943">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152004">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152040">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152111">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152175">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152237">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152301">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152365">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152425">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152487">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152521">if</span>&nbsp;<span class="ident" id="4152524">w</span><span class="op" id="4152525">.</span><span class="ident" id="4152526">handlerDone</span>&nbsp;<span class="op" id="4152538">&amp;&amp;</span>&nbsp;<span class="ident" id="4152541">bodyAllowedForStatus</span><span class="op" id="4152561">(</span><span class="ident" id="4152562">w</span><span class="op" id="4152563">.</span><span class="ident" id="4152564">status</span><span class="op" id="4152570">)</span>&nbsp;<span class="op" id="4152572">&amp;&amp;</span>&nbsp;<span class="ident" id="4152575">header</span><span class="op" id="4152581">.</span><span class="ident" id="4152582">get</span><span class="op" id="4152585">(</span><span class="string" id="4152586">&#34;Content-Length&#34;</span><span class="op" id="4152602">)</span>&nbsp;<span class="op" id="4152604">==</span>&nbsp;<span class="string" id="4152607">&#34;&#34;</span>&nbsp;<span class="op" id="4152610">&amp;&amp;</span>&nbsp;<span class="op" id="4152613">(</span><span class="op" id="4152614">!</span><span class="ident" id="4152615">isHEAD</span>&nbsp;<span class="op" id="4152622">||</span>&nbsp;<span class="builtinfunc" id="4152625">len</span><span class="op" id="4152628">(</span><span class="ident" id="4152629">p</span><span class="op" id="4152630">)</span>&nbsp;<span class="op" id="4152632">&gt;</span>&nbsp;<span class="num" id="4152634">0</span><span class="op" id="4152635">)</span>&nbsp;<span class="op" id="4152637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152641">w</span><span class="op" id="4152642">.</span><span class="ident" id="4152643">contentLength</span>&nbsp;<span class="op" id="4152657">=</span>&nbsp;<span class="ident" id="4152659">int64</span><span class="op" id="4152664">(</span><span class="builtinfunc" id="4152665">len</span><span class="op" id="4152668">(</span><span class="ident" id="4152669">p</span><span class="op" id="4152670">)</span><span class="op" id="4152671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152675">setHeader</span><span class="op" id="4152684">.</span><span class="ident" id="4152685">contentLength</span>&nbsp;<span class="op" id="4152699">=</span>&nbsp;<span class="ident" id="4152701">strconv</span><span class="op" id="4152708">.</span><span class="ident" id="4152709">AppendInt</span><span class="op" id="4152718">(</span><span class="ident" id="4152719">cw</span><span class="op" id="4152721">.</span><span class="ident" id="4152722">res</span><span class="op" id="4152725">.</span><span class="ident" id="4152726">clenBuf</span><span class="op" id="4152733">[</span><span class="op" id="4152734">:</span><span class="num" id="4152735">0</span><span class="op" id="4152736">]</span><span class="op" id="4152737">,</span>&nbsp;<span class="ident" id="4152739">int64</span><span class="op" id="4152744">(</span><span class="builtinfunc" id="4152745">len</span><span class="op" id="4152748">(</span><span class="ident" id="4152749">p</span><span class="op" id="4152750">)</span><span class="op" id="4152751">)</span><span class="op" id="4152752">,</span>&nbsp;<span class="num" id="4152754">10</span><span class="op" id="4152756">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4152759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152763">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152829">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4152897">if</span>&nbsp;<span class="ident" id="4152900">w</span><span class="op" id="4152901">.</span><span class="ident" id="4152902">req</span><span class="op" id="4152905">.</span><span class="ident" id="4152906">wantsHttp10KeepAlive</span><span class="op" id="4152926">(</span><span class="op" id="4152927">)</span>&nbsp;<span class="op" id="4152929">&amp;&amp;</span>&nbsp;<span class="ident" id="4152932">keepAlivesEnabled</span>&nbsp;<span class="op" id="4152950">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152954">sentLength</span>&nbsp;<span class="op" id="4152965">:=</span>&nbsp;<span class="ident" id="4152968">header</span><span class="op" id="4152974">.</span><span class="ident" id="4152975">get</span><span class="op" id="4152978">(</span><span class="string" id="4152979">&#34;Content-Length&#34;</span><span class="op" id="4152995">)</span>&nbsp;<span class="op" id="4152997">!=</span>&nbsp;<span class="string" id="4153000">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153005">if</span>&nbsp;<span class="ident" id="4153008">sentLength</span>&nbsp;<span class="op" id="4153019">&amp;&amp;</span>&nbsp;<span class="ident" id="4153022">header</span><span class="op" id="4153028">.</span><span class="ident" id="4153029">get</span><span class="op" id="4153032">(</span><span class="string" id="4153033">&#34;Connection&#34;</span><span class="op" id="4153045">)</span>&nbsp;<span class="op" id="4153047">==</span>&nbsp;<span class="string" id="4153050">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="4153063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153068">w</span><span class="op" id="4153069">.</span><span class="ident" id="4153070">closeAfterReply</span>&nbsp;<span class="op" id="4153086">=</span>&nbsp;<span class="builtintype" id="4153088">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153099">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153103">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153163">hasCL</span>&nbsp;<span class="op" id="4153169">:=</span>&nbsp;<span class="ident" id="4153172">w</span><span class="op" id="4153173">.</span><span class="ident" id="4153174">contentLength</span>&nbsp;<span class="op" id="4153188">!=</span>&nbsp;<span class="op" id="4153191">-</span><span class="num" id="4153192">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153196">if</span>&nbsp;<span class="ident" id="4153199">w</span><span class="op" id="4153200">.</span><span class="ident" id="4153201">req</span><span class="op" id="4153204">.</span><span class="ident" id="4153205">wantsHttp10KeepAlive</span><span class="op" id="4153225">(</span><span class="op" id="4153226">)</span>&nbsp;<span class="op" id="4153228">&amp;&amp;</span>&nbsp;<span class="op" id="4153231">(</span><span class="ident" id="4153232">isHEAD</span>&nbsp;<span class="op" id="4153239">||</span>&nbsp;<span class="ident" id="4153242">hasCL</span><span class="op" id="4153247">)</span>&nbsp;<span class="op" id="4153249">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153253">_</span><span class="op" id="4153254">,</span>&nbsp;<span class="ident" id="4153256">connectionHeaderSet</span>&nbsp;<span class="op" id="4153276">:=</span>&nbsp;<span class="ident" id="4153279">header</span><span class="op" id="4153285">[</span><span class="string" id="4153286">&#34;Connection&#34;</span><span class="op" id="4153298">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153302">if</span>&nbsp;<span class="op" id="4153305">!</span><span class="ident" id="4153306">connectionHeaderSet</span>&nbsp;<span class="op" id="4153326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153331">setHeader</span><span class="op" id="4153340">.</span><span class="ident" id="4153341">connection</span>&nbsp;<span class="op" id="4153352">=</span>&nbsp;<span class="string" id="4153354">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153372">}</span>&nbsp;<span class="keyword" id="4153374">else</span>&nbsp;<span class="keyword" id="4153379">if</span>&nbsp;<span class="op" id="4153382">!</span><span class="ident" id="4153383">w</span><span class="op" id="4153384">.</span><span class="ident" id="4153385">req</span><span class="op" id="4153388">.</span><span class="ident" id="4153389">ProtoAtLeast</span><span class="op" id="4153401">(</span><span class="num" id="4153402">1</span><span class="op" id="4153403">,</span>&nbsp;<span class="num" id="4153405">1</span><span class="op" id="4153406">)</span>&nbsp;<span class="op" id="4153408">||</span>&nbsp;<span class="ident" id="4153411">w</span><span class="op" id="4153412">.</span><span class="ident" id="4153413">req</span><span class="op" id="4153416">.</span><span class="ident" id="4153417">wantsClose</span><span class="op" id="4153427">(</span><span class="op" id="4153428">)</span>&nbsp;<span class="op" id="4153430">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153434">w</span><span class="op" id="4153435">.</span><span class="ident" id="4153436">closeAfterReply</span>&nbsp;<span class="op" id="4153452">=</span>&nbsp;<span class="builtintype" id="4153454">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153464">if</span>&nbsp;<span class="ident" id="4153467">header</span><span class="op" id="4153473">.</span><span class="ident" id="4153474">get</span><span class="op" id="4153477">(</span><span class="string" id="4153478">&#34;Connection&#34;</span><span class="op" id="4153490">)</span>&nbsp;<span class="op" id="4153492">==</span>&nbsp;<span class="string" id="4153495">&#34;close&#34;</span>&nbsp;<span class="op" id="4153503">||</span>&nbsp;<span class="op" id="4153506">!</span><span class="ident" id="4153507">keepAlivesEnabled</span>&nbsp;<span class="op" id="4153525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153529">w</span><span class="op" id="4153530">.</span><span class="ident" id="4153531">closeAfterReply</span>&nbsp;<span class="op" id="4153547">=</span>&nbsp;<span class="builtintype" id="4153549">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153559">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153619">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153680">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153741">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153792">if</span>&nbsp;<span class="ident" id="4153795">w</span><span class="op" id="4153796">.</span><span class="ident" id="4153797">req</span><span class="op" id="4153800">.</span><span class="ident" id="4153801">ContentLength</span>&nbsp;<span class="op" id="4153815">!=</span>&nbsp;<span class="num" id="4153818">0</span>&nbsp;<span class="op" id="4153820">&amp;&amp;</span>&nbsp;<span class="op" id="4153823">!</span><span class="ident" id="4153824">w</span><span class="op" id="4153825">.</span><span class="ident" id="4153826">closeAfterReply</span>&nbsp;<span class="op" id="4153842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153846">ecr</span><span class="op" id="4153849">,</span>&nbsp;<span class="ident" id="4153851">isExpecter</span>&nbsp;<span class="op" id="4153862">:=</span>&nbsp;<span class="ident" id="4153865">w</span><span class="op" id="4153866">.</span><span class="ident" id="4153867">req</span><span class="op" id="4153870">.</span><span class="ident" id="4153871">Body</span><span class="op" id="4153875">.</span><span class="op" id="4153876">(</span><span class="op" id="4153877">*</span><span class="ident" id="4153878">expectContinueReader</span><span class="op" id="4153898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4153902">if</span>&nbsp;<span class="op" id="4153905">!</span><span class="ident" id="4153906">isExpecter</span>&nbsp;<span class="op" id="4153917">||</span>&nbsp;<span class="ident" id="4153920">ecr</span><span class="op" id="4153923">.</span><span class="ident" id="4153924">resp</span><span class="op" id="4153928">.</span><span class="ident" id="4153929">wroteContinue</span>&nbsp;<span class="op" id="4153943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153948">n</span><span class="op" id="4153949">,</span>&nbsp;<span class="ident" id="4153951">_</span>&nbsp;<span class="op" id="4153953">:=</span>&nbsp;<span class="ident" id="4153956">io</span><span class="op" id="4153958">.</span><span class="ident" id="4153959">CopyN</span><span class="op" id="4153964">(</span><span class="ident" id="4153965">ioutil</span><span class="op" id="4153971">.</span><span class="ident" id="4153972">Discard</span><span class="op" id="4153979">,</span>&nbsp;<span class="ident" id="4153981">w</span><span class="op" id="4153982">.</span><span class="ident" id="4153983">req</span><span class="op" id="4153986">.</span><span class="ident" id="4153987">Body</span><span class="op" id="4153991">,</span>&nbsp;<span class="ident" id="4153993">maxPostHandlerReadBytes</span><span class="op" id="4154016">+</span><span class="num" id="4154017">1</span><span class="op" id="4154018">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154023">if</span>&nbsp;<span class="ident" id="4154026">n</span>&nbsp;<span class="op" id="4154028">&gt;=</span>&nbsp;<span class="ident" id="4154031">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4154055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154061">w</span><span class="op" id="4154062">.</span><span class="ident" id="4154063">requestTooLarge</span><span class="op" id="4154078">(</span><span class="op" id="4154079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154085">delHeader</span><span class="op" id="4154094">(</span><span class="string" id="4154095">&#34;Connection&#34;</span><span class="op" id="4154107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154113">setHeader</span><span class="op" id="4154122">.</span><span class="ident" id="4154123">connection</span>&nbsp;<span class="op" id="4154134">=</span>&nbsp;<span class="string" id="4154136">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154147">}</span>&nbsp;<span class="keyword" id="4154149">else</span>&nbsp;<span class="op" id="4154154">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154160">w</span><span class="op" id="4154161">.</span><span class="ident" id="4154162">req</span><span class="op" id="4154165">.</span><span class="ident" id="4154166">Body</span><span class="op" id="4154170">.</span><span class="ident" id="4154171">Close</span><span class="op" id="4154176">(</span><span class="op" id="4154177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154193">code</span>&nbsp;<span class="op" id="4154198">:=</span>&nbsp;<span class="ident" id="4154201">w</span><span class="op" id="4154202">.</span><span class="ident" id="4154203">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154211">if</span>&nbsp;<span class="ident" id="4154214">bodyAllowedForStatus</span><span class="op" id="4154234">(</span><span class="ident" id="4154235">code</span><span class="op" id="4154239">)</span>&nbsp;<span class="op" id="4154241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154245">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154304">_</span><span class="op" id="4154305">,</span>&nbsp;<span class="ident" id="4154307">haveType</span>&nbsp;<span class="op" id="4154316">:=</span>&nbsp;<span class="ident" id="4154319">header</span><span class="op" id="4154325">[</span><span class="string" id="4154326">&#34;Content-Type&#34;</span><span class="op" id="4154340">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154344">if</span>&nbsp;<span class="op" id="4154347">!</span><span class="ident" id="4154348">haveType</span>&nbsp;<span class="op" id="4154357">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154362">setHeader</span><span class="op" id="4154371">.</span><span class="ident" id="4154372">contentType</span>&nbsp;<span class="op" id="4154384">=</span>&nbsp;<span class="ident" id="4154386">DetectContentType</span><span class="op" id="4154403">(</span><span class="ident" id="4154404">p</span><span class="op" id="4154405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154412">}</span>&nbsp;<span class="keyword" id="4154414">else</span>&nbsp;<span class="op" id="4154419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154423">for</span>&nbsp;<span class="ident" id="4154427">_</span><span class="op" id="4154428">,</span>&nbsp;<span class="ident" id="4154430">k</span>&nbsp;<span class="op" id="4154432">:=</span>&nbsp;<span class="keyword" id="4154435">range</span>&nbsp;<span class="ident" id="4154441">suppressedHeaders</span><span class="op" id="4154458">(</span><span class="ident" id="4154459">code</span><span class="op" id="4154463">)</span>&nbsp;<span class="op" id="4154465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154470">delHeader</span><span class="op" id="4154479">(</span><span class="ident" id="4154480">k</span><span class="op" id="4154481">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154492">if</span>&nbsp;<span class="ident" id="4154495">_</span><span class="op" id="4154496">,</span>&nbsp;<span class="ident" id="4154498">ok</span>&nbsp;<span class="op" id="4154501">:=</span>&nbsp;<span class="ident" id="4154504">header</span><span class="op" id="4154510">[</span><span class="string" id="4154511">&#34;Date&#34;</span><span class="op" id="4154517">]</span><span class="op" id="4154518">;</span>&nbsp;<span class="op" id="4154520">!</span><span class="ident" id="4154521">ok</span>&nbsp;<span class="op" id="4154524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154528">setHeader</span><span class="op" id="4154537">.</span><span class="ident" id="4154538">date</span>&nbsp;<span class="op" id="4154543">=</span>&nbsp;<span class="ident" id="4154545">appendTime</span><span class="op" id="4154555">(</span><span class="ident" id="4154556">cw</span><span class="op" id="4154558">.</span><span class="ident" id="4154559">res</span><span class="op" id="4154562">.</span><span class="ident" id="4154563">dateBuf</span><span class="op" id="4154570">[</span><span class="op" id="4154571">:</span><span class="num" id="4154572">0</span><span class="op" id="4154573">]</span><span class="op" id="4154574">,</span>&nbsp;<span class="ident" id="4154576">time</span><span class="op" id="4154580">.</span><span class="ident" id="4154581">Now</span><span class="op" id="4154584">(</span><span class="op" id="4154585">)</span><span class="op" id="4154586">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154593">te</span>&nbsp;<span class="op" id="4154596">:=</span>&nbsp;<span class="ident" id="4154599">header</span><span class="op" id="4154605">.</span><span class="ident" id="4154606">get</span><span class="op" id="4154609">(</span><span class="string" id="4154610">&#34;Transfer-Encoding&#34;</span><span class="op" id="4154629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154632">hasTE</span>&nbsp;<span class="op" id="4154638">:=</span>&nbsp;<span class="ident" id="4154641">te</span>&nbsp;<span class="op" id="4154644">!=</span>&nbsp;<span class="string" id="4154647">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154651">if</span>&nbsp;<span class="ident" id="4154654">hasCL</span>&nbsp;<span class="op" id="4154660">&amp;&amp;</span>&nbsp;<span class="ident" id="4154663">hasTE</span>&nbsp;<span class="op" id="4154669">&amp;&amp;</span>&nbsp;<span class="ident" id="4154672">te</span>&nbsp;<span class="op" id="4154675">!=</span>&nbsp;<span class="string" id="4154678">&#34;identity&#34;</span>&nbsp;<span class="op" id="4154689">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154693">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4154759">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154804">w</span><span class="op" id="4154805">.</span><span class="ident" id="4154806">conn</span><span class="op" id="4154810">.</span><span class="ident" id="4154811">server</span><span class="op" id="4154817">.</span><span class="ident" id="4154818">logf</span><span class="op" id="4154822">(</span><span class="string" id="4154823">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="4154910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154915">te</span><span class="op" id="4154917">,</span>&nbsp;<span class="ident" id="4154919">w</span><span class="op" id="4154920">.</span><span class="ident" id="4154921">contentLength</span><span class="op" id="4154934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154938">delHeader</span><span class="op" id="4154947">(</span><span class="string" id="4154948">&#34;Content-Length&#34;</span><span class="op" id="4154964">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4154968">hasCL</span>&nbsp;<span class="op" id="4154974">=</span>&nbsp;<span class="builtintype" id="4154976">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4154983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4154987">if</span>&nbsp;<span class="ident" id="4154990">w</span><span class="op" id="4154991">.</span><span class="ident" id="4154992">req</span><span class="op" id="4154995">.</span><span class="ident" id="4154996">Method</span>&nbsp;<span class="op" id="4155003">==</span>&nbsp;<span class="string" id="4155006">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4155013">||</span>&nbsp;<span class="op" id="4155016">!</span><span class="ident" id="4155017">bodyAllowedForStatus</span><span class="op" id="4155037">(</span><span class="ident" id="4155038">code</span><span class="op" id="4155042">)</span>&nbsp;<span class="op" id="4155044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155048">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155063">}</span>&nbsp;<span class="keyword" id="4155065">else</span>&nbsp;<span class="keyword" id="4155070">if</span>&nbsp;<span class="ident" id="4155073">code</span>&nbsp;<span class="op" id="4155078">==</span>&nbsp;<span class="ident" id="4155081">StatusNoContent</span>&nbsp;<span class="op" id="4155097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155101">delHeader</span><span class="op" id="4155110">(</span><span class="string" id="4155111">&#34;Transfer-Encoding&#34;</span><span class="op" id="4155130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155133">}</span>&nbsp;<span class="keyword" id="4155135">else</span>&nbsp;<span class="keyword" id="4155140">if</span>&nbsp;<span class="ident" id="4155143">hasCL</span>&nbsp;<span class="op" id="4155149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155153">delHeader</span><span class="op" id="4155162">(</span><span class="string" id="4155163">&#34;Transfer-Encoding&#34;</span><span class="op" id="4155182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155185">}</span>&nbsp;<span class="keyword" id="4155187">else</span>&nbsp;<span class="keyword" id="4155192">if</span>&nbsp;<span class="ident" id="4155195">w</span><span class="op" id="4155196">.</span><span class="ident" id="4155197">req</span><span class="op" id="4155200">.</span><span class="ident" id="4155201">ProtoAtLeast</span><span class="op" id="4155213">(</span><span class="num" id="4155214">1</span><span class="op" id="4155215">,</span>&nbsp;<span class="num" id="4155217">1</span><span class="op" id="4155218">)</span>&nbsp;<span class="op" id="4155220">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155224">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155302">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155381">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155453">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155525">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4155541">if</span>&nbsp;<span class="ident" id="4155544">hasTE</span>&nbsp;<span class="op" id="4155550">&amp;&amp;</span>&nbsp;<span class="ident" id="4155553">te</span>&nbsp;<span class="op" id="4155556">==</span>&nbsp;<span class="string" id="4155559">&#34;identity&#34;</span>&nbsp;<span class="op" id="4155570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155575">cw</span><span class="op" id="4155577">.</span><span class="ident" id="4155578">chunking</span>&nbsp;<span class="op" id="4155587">=</span>&nbsp;<span class="builtintype" id="4155589">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155598">w</span><span class="op" id="4155599">.</span><span class="ident" id="4155600">closeAfterReply</span>&nbsp;<span class="op" id="4155616">=</span>&nbsp;<span class="builtintype" id="4155618">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155625">}</span>&nbsp;<span class="keyword" id="4155627">else</span>&nbsp;<span class="op" id="4155632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155637">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155694">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155740">cw</span><span class="op" id="4155742">.</span><span class="ident" id="4155743">chunking</span>&nbsp;<span class="op" id="4155752">=</span>&nbsp;<span class="builtintype" id="4155754">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155762">setHeader</span><span class="op" id="4155771">.</span><span class="ident" id="4155772">transferEncoding</span>&nbsp;<span class="op" id="4155789">=</span>&nbsp;<span class="string" id="4155791">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155806">}</span>&nbsp;<span class="keyword" id="4155808">else</span>&nbsp;<span class="op" id="4155813">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155817">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155869">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155923">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155962">w</span><span class="op" id="4155963">.</span><span class="ident" id="4155964">closeAfterReply</span>&nbsp;<span class="op" id="4155980">=</span>&nbsp;<span class="builtintype" id="4155982">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155989">delHeader</span><span class="op" id="4155998">(</span><span class="string" id="4155999">&#34;Transfer-Encoding&#34;</span><span class="op" id="4156018">)</span>&nbsp;<span class="comment" id="4156020">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4156048">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4156115">if</span>&nbsp;<span class="ident" id="4156118">cw</span><span class="op" id="4156120">.</span><span class="ident" id="4156121">chunking</span>&nbsp;<span class="op" id="4156130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156134">delHeader</span><span class="op" id="4156143">(</span><span class="string" id="4156144">&#34;Content-Length&#34;</span><span class="op" id="4156160">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4156166">if</span>&nbsp;<span class="op" id="4156169">!</span><span class="ident" id="4156170">w</span><span class="op" id="4156171">.</span><span class="ident" id="4156172">req</span><span class="op" id="4156175">.</span><span class="ident" id="4156176">ProtoAtLeast</span><span class="op" id="4156188">(</span><span class="num" id="4156189">1</span><span class="op" id="4156190">,</span>&nbsp;<span class="num" id="4156192">0</span><span class="op" id="4156193">)</span>&nbsp;<span class="op" id="4156195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4156199">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4156211">if</span>&nbsp;<span class="ident" id="4156214">w</span><span class="op" id="4156215">.</span><span class="ident" id="4156216">closeAfterReply</span>&nbsp;<span class="op" id="4156232">&amp;&amp;</span>&nbsp;<span class="op" id="4156235">(</span><span class="op" id="4156236">!</span><span class="ident" id="4156237">keepAlivesEnabled</span>&nbsp;<span class="op" id="4156255">||</span>&nbsp;<span class="op" id="4156258">!</span><span class="ident" id="4156259">hasToken</span><span class="op" id="4156267">(</span><span class="ident" id="4156268">cw</span><span class="op" id="4156270">.</span><span class="ident" id="4156271">header</span><span class="op" id="4156277">.</span><span class="ident" id="4156278">get</span><span class="op" id="4156281">(</span><span class="string" id="4156282">&#34;Connection&#34;</span><span class="op" id="4156294">)</span><span class="op" id="4156295">,</span>&nbsp;<span class="string" id="4156297">&#34;close&#34;</span><span class="op" id="4156304">)</span><span class="op" id="4156305">)</span>&nbsp;<span class="op" id="4156307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156311">delHeader</span><span class="op" id="4156320">(</span><span class="string" id="4156321">&#34;Connection&#34;</span><span class="op" id="4156333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4156337">if</span>&nbsp;<span class="ident" id="4156340">w</span><span class="op" id="4156341">.</span><span class="ident" id="4156342">req</span><span class="op" id="4156345">.</span><span class="ident" id="4156346">ProtoAtLeast</span><span class="op" id="4156358">(</span><span class="num" id="4156359">1</span><span class="op" id="4156360">,</span>&nbsp;<span class="num" id="4156362">1</span><span class="op" id="4156363">)</span>&nbsp;<span class="op" id="4156365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156370">setHeader</span><span class="op" id="4156379">.</span><span class="ident" id="4156380">connection</span>&nbsp;<span class="op" id="4156391">=</span>&nbsp;<span class="string" id="4156393">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156403">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4156406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156410">w</span><span class="op" id="4156411">.</span><span class="ident" id="4156412">conn</span><span class="op" id="4156416">.</span><span class="ident" id="4156417">buf</span><span class="op" id="4156420">.</span><span class="ident" id="4156421">WriteString</span><span class="op" id="4156432">(</span><span class="ident" id="4156433">statusLine</span><span class="op" id="4156443">(</span><span class="ident" id="4156444">w</span><span class="op" id="4156445">.</span><span class="ident" id="4156446">req</span><span class="op" id="4156449">,</span>&nbsp;<span class="ident" id="4156451">code</span><span class="op" id="4156455">)</span><span class="op" id="4156456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156459">cw</span><span class="op" id="4156461">.</span><span class="ident" id="4156462">header</span><span class="op" id="4156468">.</span><span class="ident" id="4156469">WriteSubset</span><span class="op" id="4156480">(</span><span class="ident" id="4156481">w</span><span class="op" id="4156482">.</span><span class="ident" id="4156483">conn</span><span class="op" id="4156487">.</span><span class="ident" id="4156488">buf</span><span class="op" id="4156491">,</span>&nbsp;<span class="ident" id="4156493">excludeHeader</span><span class="op" id="4156506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156509">setHeader</span><span class="op" id="4156518">.</span><span class="ident" id="4156519">Write</span><span class="op" id="4156524">(</span><span class="ident" id="4156525">w</span><span class="op" id="4156526">.</span><span class="ident" id="4156527">conn</span><span class="op" id="4156531">.</span><span class="ident" id="4156532">buf</span><span class="op" id="4156535">.</span><span class="ident" id="4156536">Writer</span><span class="op" id="4156542">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156545">w</span><span class="op" id="4156546">.</span><span class="ident" id="4156547">conn</span><span class="op" id="4156551">.</span><span class="ident" id="4156552">buf</span><span class="op" id="4156555">.</span><span class="ident" id="4156556">Write</span><span class="op" id="4156561">(</span><span class="ident" id="4156562">crlf</span><span class="op" id="4156566">)</span><br>
<span class="lineno"></span><span class="op" id="4156568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4156571">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="4156640">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="4156708">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="4156777">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="4156845">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="4156883">var</span>&nbsp;<span class="op" id="4156887">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156890">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156902">sync</span><span class="op" id="4156906">.</span><span class="ident" id="4156907">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4156916">statusLines</span>&nbsp;<span class="op" id="4156928">=</span>&nbsp;<span class="builtinfunc" id="4156930">make</span><span class="op" id="4156934">(</span><span class="keyword" id="4156935">map</span><span class="op" id="4156938">[</span><span class="builtintype" id="4156939">int</span><span class="op" id="4156942">]</span><span class="builtintype" id="4156943">string</span><span class="op" id="4156949">)</span><br>
<span class="lineno"></span><span class="op" id="4156951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4156954">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="4157022">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="4157073">func</span>&nbsp;<span class="ident" id="4157078">statusLine</span><span class="op" id="4157088">(</span><span class="ident" id="4157089">req</span>&nbsp;<span class="op" id="4157093">*</span><span class="ident" id="4157094">Request</span><span class="op" id="4157101">,</span>&nbsp;<span class="ident" id="4157103">code</span>&nbsp;<span class="builtintype" id="4157108">int</span><span class="op" id="4157111">)</span>&nbsp;<span class="builtintype" id="4157113">string</span>&nbsp;<span class="op" id="4157120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4157123">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157138">key</span>&nbsp;<span class="op" id="4157142">:=</span>&nbsp;<span class="ident" id="4157145">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157151">proto11</span>&nbsp;<span class="op" id="4157159">:=</span>&nbsp;<span class="ident" id="4157162">req</span><span class="op" id="4157165">.</span><span class="ident" id="4157166">ProtoAtLeast</span><span class="op" id="4157178">(</span><span class="num" id="4157179">1</span><span class="op" id="4157180">,</span>&nbsp;<span class="num" id="4157182">1</span><span class="op" id="4157183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157186">if</span>&nbsp;<span class="op" id="4157189">!</span><span class="ident" id="4157190">proto11</span>&nbsp;<span class="op" id="4157198">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157202">key</span>&nbsp;<span class="op" id="4157206">=</span>&nbsp;<span class="op" id="4157208">-</span><span class="ident" id="4157209">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157217">statusMu</span><span class="op" id="4157225">.</span><span class="ident" id="4157226">RLock</span><span class="op" id="4157231">(</span><span class="op" id="4157232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157235">line</span><span class="op" id="4157239">,</span>&nbsp;<span class="ident" id="4157241">ok</span>&nbsp;<span class="op" id="4157244">:=</span>&nbsp;<span class="ident" id="4157247">statusLines</span><span class="op" id="4157258">[</span><span class="ident" id="4157259">key</span><span class="op" id="4157262">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157265">statusMu</span><span class="op" id="4157273">.</span><span class="ident" id="4157274">RUnlock</span><span class="op" id="4157281">(</span><span class="op" id="4157282">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157285">if</span>&nbsp;<span class="ident" id="4157288">ok</span>&nbsp;<span class="op" id="4157291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157295">return</span>&nbsp;<span class="ident" id="4157302">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4157312">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157327">proto</span>&nbsp;<span class="op" id="4157333">:=</span>&nbsp;<span class="string" id="4157336">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157348">if</span>&nbsp;<span class="ident" id="4157351">proto11</span>&nbsp;<span class="op" id="4157359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157363">proto</span>&nbsp;<span class="op" id="4157369">=</span>&nbsp;<span class="string" id="4157371">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157386">codestring</span>&nbsp;<span class="op" id="4157397">:=</span>&nbsp;<span class="ident" id="4157400">strconv</span><span class="op" id="4157407">.</span><span class="ident" id="4157408">Itoa</span><span class="op" id="4157412">(</span><span class="ident" id="4157413">code</span><span class="op" id="4157417">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157420">text</span><span class="op" id="4157424">,</span>&nbsp;<span class="ident" id="4157426">ok</span>&nbsp;<span class="op" id="4157429">:=</span>&nbsp;<span class="ident" id="4157432">statusText</span><span class="op" id="4157442">[</span><span class="ident" id="4157443">code</span><span class="op" id="4157447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157450">if</span>&nbsp;<span class="op" id="4157453">!</span><span class="ident" id="4157454">ok</span>&nbsp;<span class="op" id="4157457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157461">text</span>&nbsp;<span class="op" id="4157466">=</span>&nbsp;<span class="string" id="4157468">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="4157483">+</span>&nbsp;<span class="ident" id="4157485">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157500">line</span>&nbsp;<span class="op" id="4157505">=</span>&nbsp;<span class="ident" id="4157507">proto</span>&nbsp;<span class="op" id="4157513">+</span>&nbsp;<span class="string" id="4157515">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4157519">+</span>&nbsp;<span class="ident" id="4157521">codestring</span>&nbsp;<span class="op" id="4157532">+</span>&nbsp;<span class="string" id="4157534">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4157538">+</span>&nbsp;<span class="ident" id="4157540">text</span>&nbsp;<span class="op" id="4157545">+</span>&nbsp;<span class="string" id="4157547">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157555">if</span>&nbsp;<span class="ident" id="4157558">ok</span>&nbsp;<span class="op" id="4157561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157565">statusMu</span><span class="op" id="4157573">.</span><span class="ident" id="4157574">Lock</span><span class="op" id="4157578">(</span><span class="op" id="4157579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157583">defer</span>&nbsp;<span class="ident" id="4157589">statusMu</span><span class="op" id="4157597">.</span><span class="ident" id="4157598">Unlock</span><span class="op" id="4157604">(</span><span class="op" id="4157605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4157609">statusLines</span><span class="op" id="4157620">[</span><span class="ident" id="4157621">key</span><span class="op" id="4157624">]</span>&nbsp;<span class="op" id="4157626">=</span>&nbsp;<span class="ident" id="4157628">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157634">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157637">return</span>&nbsp;<span class="ident" id="4157644">line</span><br>
<span class="lineno"></span><span class="op" id="4157649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4157652">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4157726">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="4157791">func</span>&nbsp;<span class="op" id="4157796">(</span><span class="ident" id="4157797">w</span>&nbsp;<span class="op" id="4157799">*</span><span class="ident" id="4157800">response</span><span class="op" id="4157808">)</span>&nbsp;<span class="ident" id="4157810">bodyAllowed</span><span class="op" id="4157821">(</span><span class="op" id="4157822">)</span>&nbsp;<span class="builtintype" id="4157824">bool</span>&nbsp;<span class="op" id="4157829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157832">if</span>&nbsp;<span class="op" id="4157835">!</span><span class="ident" id="4157836">w</span><span class="op" id="4157837">.</span><span class="ident" id="4157838">wroteHeader</span>&nbsp;<span class="op" id="4157850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4157854">panic</span><span class="op" id="4157859">(</span><span class="string" id="4157860">&#34;&#34;</span><span class="op" id="4157862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4157865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4157868">return</span>&nbsp;<span class="ident" id="4157875">bodyAllowedForStatus</span><span class="op" id="4157895">(</span><span class="ident" id="4157896">w</span><span class="op" id="4157897">.</span><span class="ident" id="4157898">status</span><span class="op" id="4157904">)</span><br>
<span class="lineno">940</span><span class="op" id="4157906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4157909">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="4157946">//</span><br>
<span class="lineno"></span><span class="comment" id="4157949">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="4158016">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="4158091">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4158135">//</span><br>
<span class="lineno"></span><span class="comment" id="4158138">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="4158208">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="4158276">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4158347">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="4158373">//</span><br>
<span class="lineno"></span><span class="comment" id="4158376">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4158445">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="4158482">//</span><br>
<span class="lineno"></span><span class="comment" id="4158485">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="4158525">//</span><br>
<span class="lineno"></span><span class="comment" id="4158528">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4158568">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="4158639">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="4158714">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="4158767">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4158836">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="4158906">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="4158973">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="4159002">//</span><br>
<span class="lineno"></span><span class="comment" id="4159005">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4159069">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="4159136">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="4159204">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="4159269">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4159339">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4159408">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="4159479">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="4159550">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4159572">func</span>&nbsp;<span class="op" id="4159577">(</span><span class="ident" id="4159578">w</span>&nbsp;<span class="op" id="4159580">*</span><span class="ident" id="4159581">response</span><span class="op" id="4159589">)</span>&nbsp;<span class="ident" id="4159591">Write</span><span class="op" id="4159596">(</span><span class="ident" id="4159597">data</span>&nbsp;<span class="op" id="4159602">[</span><span class="op" id="4159603">]</span><span class="builtintype" id="4159604">byte</span><span class="op" id="4159608">)</span>&nbsp;<span class="op" id="4159610">(</span><span class="ident" id="4159611">n</span>&nbsp;<span class="builtintype" id="4159613">int</span><span class="op" id="4159616">,</span>&nbsp;<span class="ident" id="4159618">err</span>&nbsp;<span class="builtintype" id="4159622">error</span><span class="op" id="4159627">)</span>&nbsp;<span class="op" id="4159629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159632">return</span>&nbsp;<span class="ident" id="4159639">w</span><span class="op" id="4159640">.</span><span class="ident" id="4159641">write</span><span class="op" id="4159646">(</span><span class="builtinfunc" id="4159647">len</span><span class="op" id="4159650">(</span><span class="ident" id="4159651">data</span><span class="op" id="4159655">)</span><span class="op" id="4159656">,</span>&nbsp;<span class="ident" id="4159658">data</span><span class="op" id="4159662">,</span>&nbsp;<span class="string" id="4159664">&#34;&#34;</span><span class="op" id="4159666">)</span><br>
<span class="lineno"></span><span class="op" id="4159668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="4159671">func</span>&nbsp;<span class="op" id="4159676">(</span><span class="ident" id="4159677">w</span>&nbsp;<span class="op" id="4159679">*</span><span class="ident" id="4159680">response</span><span class="op" id="4159688">)</span>&nbsp;<span class="ident" id="4159690">WriteString</span><span class="op" id="4159701">(</span><span class="ident" id="4159702">data</span>&nbsp;<span class="builtintype" id="4159707">string</span><span class="op" id="4159713">)</span>&nbsp;<span class="op" id="4159715">(</span><span class="ident" id="4159716">n</span>&nbsp;<span class="builtintype" id="4159718">int</span><span class="op" id="4159721">,</span>&nbsp;<span class="ident" id="4159723">err</span>&nbsp;<span class="builtintype" id="4159727">error</span><span class="op" id="4159732">)</span>&nbsp;<span class="op" id="4159734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159737">return</span>&nbsp;<span class="ident" id="4159744">w</span><span class="op" id="4159745">.</span><span class="ident" id="4159746">write</span><span class="op" id="4159751">(</span><span class="builtinfunc" id="4159752">len</span><span class="op" id="4159755">(</span><span class="ident" id="4159756">data</span><span class="op" id="4159760">)</span><span class="op" id="4159761">,</span>&nbsp;<span class="builtintype" id="4159763">nil</span><span class="op" id="4159766">,</span>&nbsp;<span class="ident" id="4159768">data</span><span class="op" id="4159772">)</span><br>
<span class="lineno"></span><span class="op" id="4159774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4159777">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="4159815">func</span>&nbsp;<span class="op" id="4159820">(</span><span class="ident" id="4159821">w</span>&nbsp;<span class="op" id="4159823">*</span><span class="ident" id="4159824">response</span><span class="op" id="4159832">)</span>&nbsp;<span class="ident" id="4159834">write</span><span class="op" id="4159839">(</span><span class="ident" id="4159840">lenData</span>&nbsp;<span class="builtintype" id="4159848">int</span><span class="op" id="4159851">,</span>&nbsp;<span class="ident" id="4159853">dataB</span>&nbsp;<span class="op" id="4159859">[</span><span class="op" id="4159860">]</span><span class="builtintype" id="4159861">byte</span><span class="op" id="4159865">,</span>&nbsp;<span class="ident" id="4159867">dataS</span>&nbsp;<span class="builtintype" id="4159873">string</span><span class="op" id="4159879">)</span>&nbsp;<span class="op" id="4159881">(</span><span class="ident" id="4159882">n</span>&nbsp;<span class="builtintype" id="4159884">int</span><span class="op" id="4159887">,</span>&nbsp;<span class="ident" id="4159889">err</span>&nbsp;<span class="builtintype" id="4159893">error</span><span class="op" id="4159898">)</span>&nbsp;<span class="op" id="4159900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159903">if</span>&nbsp;<span class="ident" id="4159906">w</span><span class="op" id="4159907">.</span><span class="ident" id="4159908">conn</span><span class="op" id="4159912">.</span><span class="ident" id="4159913">hijacked</span><span class="op" id="4159921">(</span><span class="op" id="4159922">)</span>&nbsp;<span class="op" id="4159924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4159928">w</span><span class="op" id="4159929">.</span><span class="ident" id="4159930">conn</span><span class="op" id="4159934">.</span><span class="ident" id="4159935">server</span><span class="op" id="4159941">.</span><span class="ident" id="4159942">logf</span><span class="op" id="4159946">(</span><span class="string" id="4159947">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4159992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4159996">return</span>&nbsp;<span class="num" id="4160003">0</span><span class="op" id="4160004">,</span>&nbsp;<span class="ident" id="4160006">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160019">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160022">if</span>&nbsp;<span class="op" id="4160025">!</span><span class="ident" id="4160026">w</span><span class="op" id="4160027">.</span><span class="ident" id="4160028">wroteHeader</span>&nbsp;<span class="op" id="4160040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160044">w</span><span class="op" id="4160045">.</span><span class="ident" id="4160046">WriteHeader</span><span class="op" id="4160057">(</span><span class="ident" id="4160058">StatusOK</span><span class="op" id="4160066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160072">if</span>&nbsp;<span class="ident" id="4160075">lenData</span>&nbsp;<span class="op" id="4160083">==</span>&nbsp;<span class="num" id="4160086">0</span>&nbsp;<span class="op" id="4160088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160092">return</span>&nbsp;<span class="num" id="4160099">0</span><span class="op" id="4160100">,</span>&nbsp;<span class="builtintype" id="4160102">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160110">if</span>&nbsp;<span class="op" id="4160113">!</span><span class="ident" id="4160114">w</span><span class="op" id="4160115">.</span><span class="ident" id="4160116">bodyAllowed</span><span class="op" id="4160127">(</span><span class="op" id="4160128">)</span>&nbsp;<span class="op" id="4160130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160134">return</span>&nbsp;<span class="num" id="4160141">0</span><span class="op" id="4160142">,</span>&nbsp;<span class="ident" id="4160144">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160167">w</span><span class="op" id="4160168">.</span><span class="ident" id="4160169">written</span>&nbsp;<span class="op" id="4160177">+=</span>&nbsp;<span class="ident" id="4160180">int64</span><span class="op" id="4160185">(</span><span class="ident" id="4160186">lenData</span><span class="op" id="4160193">)</span>&nbsp;<span class="comment" id="4160195">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160232">if</span>&nbsp;<span class="ident" id="4160235">w</span><span class="op" id="4160236">.</span><span class="ident" id="4160237">contentLength</span>&nbsp;<span class="op" id="4160251">!=</span>&nbsp;<span class="op" id="4160254">-</span><span class="num" id="4160255">1</span>&nbsp;<span class="op" id="4160257">&amp;&amp;</span>&nbsp;<span class="ident" id="4160260">w</span><span class="op" id="4160261">.</span><span class="ident" id="4160262">written</span>&nbsp;<span class="op" id="4160270">&gt;</span>&nbsp;<span class="ident" id="4160272">w</span><span class="op" id="4160273">.</span><span class="ident" id="4160274">contentLength</span>&nbsp;<span class="op" id="4160288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160292">return</span>&nbsp;<span class="num" id="4160299">0</span><span class="op" id="4160300">,</span>&nbsp;<span class="ident" id="4160302">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160323">if</span>&nbsp;<span class="ident" id="4160326">dataB</span>&nbsp;<span class="op" id="4160332">!=</span>&nbsp;<span class="builtintype" id="4160335">nil</span>&nbsp;<span class="op" id="4160339">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160343">return</span>&nbsp;<span class="ident" id="4160350">w</span><span class="op" id="4160351">.</span><span class="ident" id="4160352">w</span><span class="op" id="4160353">.</span><span class="ident" id="4160354">Write</span><span class="op" id="4160359">(</span><span class="ident" id="4160360">dataB</span><span class="op" id="4160365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160368">}</span>&nbsp;<span class="keyword" id="4160370">else</span>&nbsp;<span class="op" id="4160375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160379">return</span>&nbsp;<span class="ident" id="4160386">w</span><span class="op" id="4160387">.</span><span class="ident" id="4160388">w</span><span class="op" id="4160389">.</span><span class="ident" id="4160390">WriteString</span><span class="op" id="4160401">(</span><span class="ident" id="4160402">dataS</span><span class="op" id="4160407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160410">}</span><br>
<span class="lineno"></span><span class="op" id="4160412">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="4160415">func</span>&nbsp;<span class="op" id="4160420">(</span><span class="ident" id="4160421">w</span>&nbsp;<span class="op" id="4160423">*</span><span class="ident" id="4160424">response</span><span class="op" id="4160432">)</span>&nbsp;<span class="ident" id="4160434">finishRequest</span><span class="op" id="4160447">(</span><span class="op" id="4160448">)</span>&nbsp;<span class="op" id="4160450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160453">w</span><span class="op" id="4160454">.</span><span class="ident" id="4160455">handlerDone</span>&nbsp;<span class="op" id="4160467">=</span>&nbsp;<span class="builtintype" id="4160469">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160476">if</span>&nbsp;<span class="op" id="4160479">!</span><span class="ident" id="4160480">w</span><span class="op" id="4160481">.</span><span class="ident" id="4160482">wroteHeader</span>&nbsp;<span class="op" id="4160494">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160498">w</span><span class="op" id="4160499">.</span><span class="ident" id="4160500">WriteHeader</span><span class="op" id="4160511">(</span><span class="ident" id="4160512">StatusOK</span><span class="op" id="4160520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160527">w</span><span class="op" id="4160528">.</span><span class="ident" id="4160529">w</span><span class="op" id="4160530">.</span><span class="ident" id="4160531">Flush</span><span class="op" id="4160536">(</span><span class="op" id="4160537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160540">putBufioWriter</span><span class="op" id="4160554">(</span><span class="ident" id="4160555">w</span><span class="op" id="4160556">.</span><span class="ident" id="4160557">w</span><span class="op" id="4160558">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160561">w</span><span class="op" id="4160562">.</span><span class="ident" id="4160563">cw</span><span class="op" id="4160565">.</span><span class="builtinfunc" id="4160566">close</span><span class="op" id="4160571">(</span><span class="op" id="4160572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160575">w</span><span class="op" id="4160576">.</span><span class="ident" id="4160577">conn</span><span class="op" id="4160581">.</span><span class="ident" id="4160582">buf</span><span class="op" id="4160585">.</span><span class="ident" id="4160586">Flush</span><span class="op" id="4160591">(</span><span class="op" id="4160592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4160596">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4160659">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160701">w</span><span class="op" id="4160702">.</span><span class="ident" id="4160703">req</span><span class="op" id="4160706">.</span><span class="ident" id="4160707">Body</span><span class="op" id="4160711">.</span><span class="ident" id="4160712">Close</span><span class="op" id="4160717">(</span><span class="op" id="4160718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160722">if</span>&nbsp;<span class="ident" id="4160725">w</span><span class="op" id="4160726">.</span><span class="ident" id="4160727">req</span><span class="op" id="4160730">.</span><span class="ident" id="4160731">MultipartForm</span>&nbsp;<span class="op" id="4160745">!=</span>&nbsp;<span class="builtintype" id="4160748">nil</span>&nbsp;<span class="op" id="4160752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160756">w</span><span class="op" id="4160757">.</span><span class="ident" id="4160758">req</span><span class="op" id="4160761">.</span><span class="ident" id="4160762">MultipartForm</span><span class="op" id="4160775">.</span><span class="ident" id="4160776">RemoveAll</span><span class="op" id="4160785">(</span><span class="op" id="4160786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160789">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4160793">if</span>&nbsp;<span class="ident" id="4160796">w</span><span class="op" id="4160797">.</span><span class="ident" id="4160798">req</span><span class="op" id="4160801">.</span><span class="ident" id="4160802">Method</span>&nbsp;<span class="op" id="4160809">!=</span>&nbsp;<span class="string" id="4160812">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4160819">&amp;&amp;</span>&nbsp;<span class="ident" id="4160822">w</span><span class="op" id="4160823">.</span><span class="ident" id="4160824">contentLength</span>&nbsp;<span class="op" id="4160838">!=</span>&nbsp;<span class="op" id="4160841">-</span><span class="num" id="4160842">1</span>&nbsp;<span class="op" id="4160844">&amp;&amp;</span>&nbsp;<span class="ident" id="4160847">w</span><span class="op" id="4160848">.</span><span class="ident" id="4160849">bodyAllowed</span><span class="op" id="4160860">(</span><span class="op" id="4160861">)</span>&nbsp;<span class="op" id="4160863">&amp;&amp;</span>&nbsp;<span class="ident" id="4160866">w</span><span class="op" id="4160867">.</span><span class="ident" id="4160868">contentLength</span>&nbsp;<span class="op" id="4160882">!=</span>&nbsp;<span class="ident" id="4160885">w</span><span class="op" id="4160886">.</span><span class="ident" id="4160887">written</span>&nbsp;<span class="op" id="4160895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4160899">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4160953">w</span><span class="op" id="4160954">.</span><span class="ident" id="4160955">closeAfterReply</span>&nbsp;<span class="op" id="4160971">=</span>&nbsp;<span class="builtintype" id="4160973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4160979">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4160983">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4161045">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4161096">if</span>&nbsp;<span class="ident" id="4161099">w</span><span class="op" id="4161100">.</span><span class="ident" id="4161101">conn</span><span class="op" id="4161105">.</span><span class="ident" id="4161106">werr</span>&nbsp;<span class="op" id="4161111">!=</span>&nbsp;<span class="builtintype" id="4161114">nil</span>&nbsp;<span class="op" id="4161118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161122">w</span><span class="op" id="4161123">.</span><span class="ident" id="4161124">closeAfterReply</span>&nbsp;<span class="op" id="4161140">=</span>&nbsp;<span class="builtintype" id="4161142">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4161148">}</span><br>
<span class="lineno"></span><span class="op" id="4161150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4161153">func</span>&nbsp;<span class="op" id="4161158">(</span><span class="ident" id="4161159">w</span>&nbsp;<span class="op" id="4161161">*</span><span class="ident" id="4161162">response</span><span class="op" id="4161170">)</span>&nbsp;<span class="ident" id="4161172">Flush</span><span class="op" id="4161177">(</span><span class="op" id="4161178">)</span>&nbsp;<span class="op" id="4161180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4161183">if</span>&nbsp;<span class="op" id="4161186">!</span><span class="ident" id="4161187">w</span><span class="op" id="4161188">.</span><span class="ident" id="4161189">wroteHeader</span>&nbsp;<span class="op" id="4161201">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161205">w</span><span class="op" id="4161206">.</span><span class="ident" id="4161207">WriteHeader</span><span class="op" id="4161218">(</span><span class="ident" id="4161219">StatusOK</span><span class="op" id="4161227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4161230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161233">w</span><span class="op" id="4161234">.</span><span class="ident" id="4161235">w</span><span class="op" id="4161236">.</span><span class="ident" id="4161237">Flush</span><span class="op" id="4161242">(</span><span class="op" id="4161243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161246">w</span><span class="op" id="4161247">.</span><span class="ident" id="4161248">cw</span><span class="op" id="4161250">.</span><span class="ident" id="4161251">flush</span><span class="op" id="4161256">(</span><span class="op" id="4161257">)</span><br>
<span class="lineno"></span><span class="op" id="4161259">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="4161262">func</span>&nbsp;<span class="op" id="4161267">(</span><span class="ident" id="4161268">c</span>&nbsp;<span class="op" id="4161270">*</span><span class="ident" id="4161271">conn</span><span class="op" id="4161275">)</span>&nbsp;<span class="ident" id="4161277">finalFlush</span><span class="op" id="4161287">(</span><span class="op" id="4161288">)</span>&nbsp;<span class="op" id="4161290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4161293">if</span>&nbsp;<span class="ident" id="4161296">c</span><span class="op" id="4161297">.</span><span class="ident" id="4161298">buf</span>&nbsp;<span class="op" id="4161302">!=</span>&nbsp;<span class="builtintype" id="4161305">nil</span>&nbsp;<span class="op" id="4161309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161313">c</span><span class="op" id="4161314">.</span><span class="ident" id="4161315">buf</span><span class="op" id="4161318">.</span><span class="ident" id="4161319">Flush</span><span class="op" id="4161324">(</span><span class="op" id="4161325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4161330">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4161400">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161437">putBufioReader</span><span class="op" id="4161451">(</span><span class="ident" id="4161452">c</span><span class="op" id="4161453">.</span><span class="ident" id="4161454">buf</span><span class="op" id="4161457">.</span><span class="ident" id="4161458">Reader</span><span class="op" id="4161464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4161469">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4161539">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161576">putBufioWriter</span><span class="op" id="4161590">(</span><span class="ident" id="4161591">c</span><span class="op" id="4161592">.</span><span class="ident" id="4161593">buf</span><span class="op" id="4161596">.</span><span class="ident" id="4161597">Writer</span><span class="op" id="4161603">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161608">c</span><span class="op" id="4161609">.</span><span class="ident" id="4161610">buf</span>&nbsp;<span class="op" id="4161614">=</span>&nbsp;<span class="builtintype" id="4161616">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4161621">}</span><br>
<span class="lineno">1065</span><span class="op" id="4161623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4161626">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4161651">func</span>&nbsp;<span class="op" id="4161656">(</span><span class="ident" id="4161657">c</span>&nbsp;<span class="op" id="4161659">*</span><span class="ident" id="4161660">conn</span><span class="op" id="4161664">)</span>&nbsp;<span class="builtinfunc" id="4161666">close</span><span class="op" id="4161671">(</span><span class="op" id="4161672">)</span>&nbsp;<span class="op" id="4161674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161677">c</span><span class="op" id="4161678">.</span><span class="ident" id="4161679">finalFlush</span><span class="op" id="4161689">(</span><span class="op" id="4161690">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4161693">if</span>&nbsp;<span class="ident" id="4161696">c</span><span class="op" id="4161697">.</span><span class="ident" id="4161698">rwc</span>&nbsp;<span class="op" id="4161702">!=</span>&nbsp;<span class="builtintype" id="4161705">nil</span>&nbsp;<span class="op" id="4161709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161713">c</span><span class="op" id="4161714">.</span><span class="ident" id="4161715">rwc</span><span class="op" id="4161718">.</span><span class="ident" id="4161719">Close</span><span class="op" id="4161724">(</span><span class="op" id="4161725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4161729">c</span><span class="op" id="4161730">.</span><span class="ident" id="4161731">rwc</span>&nbsp;<span class="op" id="4161735">=</span>&nbsp;<span class="builtintype" id="4161737">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4161742">}</span><br>
<span class="lineno"></span><span class="op" id="4161744">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="4161747">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4161817">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="4161885">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="4161954">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="4162025">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="4162078">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="4162143">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="4162211">const</span>&nbsp;<span class="ident" id="4162217">rstAvoidanceDelay</span>&nbsp;<span class="op" id="4162235">=</span>&nbsp;<span class="num" id="4162237">500</span>&nbsp;<span class="op" id="4162241">*</span>&nbsp;<span class="ident" id="4162243">time</span><span class="op" id="4162247">.</span><span class="ident" id="4162248">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="4162261">type</span>&nbsp;<span class="ident" id="4162266">closeWriter</span>&nbsp;<span class="keyword" id="4162278">interface</span>&nbsp;<span class="op" id="4162288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4162291">CloseWrite</span><span class="op" id="4162301">(</span><span class="op" id="4162302">)</span>&nbsp;<span class="builtintype" id="4162304">error</span><br>
<span class="lineno"></span><span class="op" id="4162310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4162313">var</span>&nbsp;<span class="ident" id="4162317">_</span>&nbsp;<span class="ident" id="4162319">closeWriter</span>&nbsp;<span class="op" id="4162331">=</span>&nbsp;<span class="op" id="4162333">(</span><span class="op" id="4162334">*</span><span class="ident" id="4162335">net</span><span class="op" id="4162338">.</span><span class="ident" id="4162339">TCPConn</span><span class="op" id="4162346">)</span><span class="op" id="4162347">(</span><span class="builtintype" id="4162348">nil</span><span class="op" id="4162351">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="4162354">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="4162424">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4162494">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4162556">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="4162575">//</span><br>
<span class="lineno"></span><span class="comment" id="4162578">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="4162614">func</span>&nbsp;<span class="op" id="4162619">(</span><span class="ident" id="4162620">c</span>&nbsp;<span class="op" id="4162622">*</span><span class="ident" id="4162623">conn</span><span class="op" id="4162627">)</span>&nbsp;<span class="ident" id="4162629">closeWriteAndWait</span><span class="op" id="4162646">(</span><span class="op" id="4162647">)</span>&nbsp;<span class="op" id="4162649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4162652">c</span><span class="op" id="4162653">.</span><span class="ident" id="4162654">finalFlush</span><span class="op" id="4162664">(</span><span class="op" id="4162665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4162668">if</span>&nbsp;<span class="ident" id="4162671">tcp</span><span class="op" id="4162674">,</span>&nbsp;<span class="ident" id="4162676">ok</span>&nbsp;<span class="op" id="4162679">:=</span>&nbsp;<span class="ident" id="4162682">c</span><span class="op" id="4162683">.</span><span class="ident" id="4162684">rwc</span><span class="op" id="4162687">.</span><span class="op" id="4162688">(</span><span class="ident" id="4162689">closeWriter</span><span class="op" id="4162700">)</span><span class="op" id="4162701">;</span>&nbsp;<span class="ident" id="4162703">ok</span>&nbsp;<span class="op" id="4162706">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4162710">tcp</span><span class="op" id="4162713">.</span><span class="ident" id="4162714">CloseWrite</span><span class="op" id="4162724">(</span><span class="op" id="4162725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4162728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4162731">time</span><span class="op" id="4162735">.</span><span class="ident" id="4162736">Sleep</span><span class="op" id="4162741">(</span><span class="ident" id="4162742">rstAvoidanceDelay</span><span class="op" id="4162759">)</span><br>
<span class="lineno"></span><span class="op" id="4162761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="4162764">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="4162828">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="4162897">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="4162955">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="4162975">func</span>&nbsp;<span class="ident" id="4162980">validNPN</span><span class="op" id="4162988">(</span><span class="ident" id="4162989">proto</span>&nbsp;<span class="builtintype" id="4162995">string</span><span class="op" id="4163001">)</span>&nbsp;<span class="builtintype" id="4163003">bool</span>&nbsp;<span class="op" id="4163008">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163011">switch</span>&nbsp;<span class="ident" id="4163018">proto</span>&nbsp;<span class="op" id="4163024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163027">case</span>&nbsp;<span class="string" id="4163032">&#34;&#34;</span><span class="op" id="4163034">,</span>&nbsp;<span class="string" id="4163036">&#34;http/1.1&#34;</span><span class="op" id="4163046">,</span>&nbsp;<span class="string" id="4163048">&#34;http/1.0&#34;</span><span class="op" id="4163058">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163062">return</span>&nbsp;<span class="builtintype" id="4163069">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163079">return</span>&nbsp;<span class="builtintype" id="4163086">true</span><br>
<span class="lineno">1115</span><span class="op" id="4163091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4163094">func</span>&nbsp;<span class="op" id="4163099">(</span><span class="ident" id="4163100">c</span>&nbsp;<span class="op" id="4163102">*</span><span class="ident" id="4163103">conn</span><span class="op" id="4163107">)</span>&nbsp;<span class="ident" id="4163109">setState</span><span class="op" id="4163117">(</span><span class="ident" id="4163118">nc</span>&nbsp;<span class="ident" id="4163121">net</span><span class="op" id="4163124">.</span><span class="ident" id="4163125">Conn</span><span class="op" id="4163129">,</span>&nbsp;<span class="ident" id="4163131">state</span>&nbsp;<span class="ident" id="4163137">ConnState</span><span class="op" id="4163146">)</span>&nbsp;<span class="op" id="4163148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163151">if</span>&nbsp;<span class="ident" id="4163154">hook</span>&nbsp;<span class="op" id="4163159">:=</span>&nbsp;<span class="ident" id="4163162">c</span><span class="op" id="4163163">.</span><span class="ident" id="4163164">server</span><span class="op" id="4163170">.</span><span class="ident" id="4163171">ConnState</span><span class="op" id="4163180">;</span>&nbsp;<span class="ident" id="4163182">hook</span>&nbsp;<span class="op" id="4163187">!=</span>&nbsp;<span class="builtintype" id="4163190">nil</span>&nbsp;<span class="op" id="4163194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163198">hook</span><span class="op" id="4163202">(</span><span class="ident" id="4163203">nc</span><span class="op" id="4163205">,</span>&nbsp;<span class="ident" id="4163207">state</span><span class="op" id="4163212">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163215">}</span><br>
<span class="lineno"></span><span class="op" id="4163217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4163220">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4163247">func</span>&nbsp;<span class="op" id="4163252">(</span><span class="ident" id="4163253">c</span>&nbsp;<span class="op" id="4163255">*</span><span class="ident" id="4163256">conn</span><span class="op" id="4163260">)</span>&nbsp;<span class="ident" id="4163262">serve</span><span class="op" id="4163267">(</span><span class="op" id="4163268">)</span>&nbsp;<span class="op" id="4163270">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163273">origConn</span>&nbsp;<span class="op" id="4163282">:=</span>&nbsp;<span class="ident" id="4163285">c</span><span class="op" id="4163286">.</span><span class="ident" id="4163287">rwc</span>&nbsp;<span class="comment" id="4163291">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163342">defer</span>&nbsp;<span class="keyword" id="4163348">func</span><span class="op" id="4163352">(</span><span class="op" id="4163353">)</span>&nbsp;<span class="op" id="4163355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163359">if</span>&nbsp;<span class="ident" id="4163362">err</span>&nbsp;<span class="op" id="4163366">:=</span>&nbsp;<span class="builtinfunc" id="4163369">recover</span><span class="op" id="4163376">(</span><span class="op" id="4163377">)</span><span class="op" id="4163378">;</span>&nbsp;<span class="ident" id="4163380">err</span>&nbsp;<span class="op" id="4163384">!=</span>&nbsp;<span class="builtintype" id="4163387">nil</span>&nbsp;<span class="op" id="4163391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163396">const</span>&nbsp;<span class="ident" id="4163402">size</span>&nbsp;<span class="op" id="4163407">=</span>&nbsp;<span class="num" id="4163409">64</span>&nbsp;<span class="op" id="4163412">&lt;&lt;</span>&nbsp;<span class="num" id="4163415">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163421">buf</span>&nbsp;<span class="op" id="4163425">:=</span>&nbsp;<span class="builtinfunc" id="4163428">make</span><span class="op" id="4163432">(</span><span class="op" id="4163433">[</span><span class="op" id="4163434">]</span><span class="builtintype" id="4163435">byte</span><span class="op" id="4163439">,</span>&nbsp;<span class="ident" id="4163441">size</span><span class="op" id="4163445">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163450">buf</span>&nbsp;<span class="op" id="4163454">=</span>&nbsp;<span class="ident" id="4163456">buf</span><span class="op" id="4163459">[</span><span class="op" id="4163460">:</span><span class="ident" id="4163461">runtime</span><span class="op" id="4163468">.</span><span class="ident" id="4163469">Stack</span><span class="op" id="4163474">(</span><span class="ident" id="4163475">buf</span><span class="op" id="4163478">,</span>&nbsp;<span class="builtintype" id="4163480">false</span><span class="op" id="4163485">)</span><span class="op" id="4163486">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163491">c</span><span class="op" id="4163492">.</span><span class="ident" id="4163493">server</span><span class="op" id="4163499">.</span><span class="ident" id="4163500">logf</span><span class="op" id="4163504">(</span><span class="string" id="4163505">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="4163537">,</span>&nbsp;<span class="ident" id="4163539">c</span><span class="op" id="4163540">.</span><span class="ident" id="4163541">remoteAddr</span><span class="op" id="4163551">,</span>&nbsp;<span class="ident" id="4163553">err</span><span class="op" id="4163556">,</span>&nbsp;<span class="ident" id="4163558">buf</span><span class="op" id="4163561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163569">if</span>&nbsp;<span class="op" id="4163572">!</span><span class="ident" id="4163573">c</span><span class="op" id="4163574">.</span><span class="ident" id="4163575">hijacked</span><span class="op" id="4163583">(</span><span class="op" id="4163584">)</span>&nbsp;<span class="op" id="4163586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163591">c</span><span class="op" id="4163592">.</span><span class="builtinfunc" id="4163593">close</span><span class="op" id="4163598">(</span><span class="op" id="4163599">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163604">c</span><span class="op" id="4163605">.</span><span class="ident" id="4163606">setState</span><span class="op" id="4163614">(</span><span class="ident" id="4163615">origConn</span><span class="op" id="4163623">,</span>&nbsp;<span class="ident" id="4163625">StateClosed</span><span class="op" id="4163636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163643">}</span><span class="op" id="4163644">(</span><span class="op" id="4163645">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163649">if</span>&nbsp;<span class="ident" id="4163652">tlsConn</span><span class="op" id="4163659">,</span>&nbsp;<span class="ident" id="4163661">ok</span>&nbsp;<span class="op" id="4163664">:=</span>&nbsp;<span class="ident" id="4163667">c</span><span class="op" id="4163668">.</span><span class="ident" id="4163669">rwc</span><span class="op" id="4163672">.</span><span class="op" id="4163673">(</span><span class="op" id="4163674">*</span><span class="ident" id="4163675">tls</span><span class="op" id="4163678">.</span><span class="ident" id="4163679">Conn</span><span class="op" id="4163683">)</span><span class="op" id="4163684">;</span>&nbsp;<span class="ident" id="4163686">ok</span>&nbsp;<span class="op" id="4163689">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163693">if</span>&nbsp;<span class="ident" id="4163696">d</span>&nbsp;<span class="op" id="4163698">:=</span>&nbsp;<span class="ident" id="4163701">c</span><span class="op" id="4163702">.</span><span class="ident" id="4163703">server</span><span class="op" id="4163709">.</span><span class="ident" id="4163710">ReadTimeout</span><span class="op" id="4163721">;</span>&nbsp;<span class="ident" id="4163723">d</span>&nbsp;<span class="op" id="4163725">!=</span>&nbsp;<span class="num" id="4163728">0</span>&nbsp;<span class="op" id="4163730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163735">c</span><span class="op" id="4163736">.</span><span class="ident" id="4163737">rwc</span><span class="op" id="4163740">.</span><span class="ident" id="4163741">SetReadDeadline</span><span class="op" id="4163756">(</span><span class="ident" id="4163757">time</span><span class="op" id="4163761">.</span><span class="ident" id="4163762">Now</span><span class="op" id="4163765">(</span><span class="op" id="4163766">)</span><span class="op" id="4163767">.</span><span class="ident" id="4163768">Add</span><span class="op" id="4163771">(</span><span class="ident" id="4163772">d</span><span class="op" id="4163773">)</span><span class="op" id="4163774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163782">if</span>&nbsp;<span class="ident" id="4163785">d</span>&nbsp;<span class="op" id="4163787">:=</span>&nbsp;<span class="ident" id="4163790">c</span><span class="op" id="4163791">.</span><span class="ident" id="4163792">server</span><span class="op" id="4163798">.</span><span class="ident" id="4163799">WriteTimeout</span><span class="op" id="4163811">;</span>&nbsp;<span class="ident" id="4163813">d</span>&nbsp;<span class="op" id="4163815">!=</span>&nbsp;<span class="num" id="4163818">0</span>&nbsp;<span class="op" id="4163820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163825">c</span><span class="op" id="4163826">.</span><span class="ident" id="4163827">rwc</span><span class="op" id="4163830">.</span><span class="ident" id="4163831">SetWriteDeadline</span><span class="op" id="4163847">(</span><span class="ident" id="4163848">time</span><span class="op" id="4163852">.</span><span class="ident" id="4163853">Now</span><span class="op" id="4163856">(</span><span class="op" id="4163857">)</span><span class="op" id="4163858">.</span><span class="ident" id="4163859">Add</span><span class="op" id="4163862">(</span><span class="ident" id="4163863">d</span><span class="op" id="4163864">)</span><span class="op" id="4163865">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4163869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4163873">if</span>&nbsp;<span class="ident" id="4163876">err</span>&nbsp;<span class="op" id="4163880">:=</span>&nbsp;<span class="ident" id="4163883">tlsConn</span><span class="op" id="4163890">.</span><span class="ident" id="4163891">Handshake</span><span class="op" id="4163900">(</span><span class="op" id="4163901">)</span><span class="op" id="4163902">;</span>&nbsp;<span class="ident" id="4163904">err</span>&nbsp;<span class="op" id="4163908">!=</span>&nbsp;<span class="builtintype" id="4163911">nil</span>&nbsp;<span class="op" id="4163915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4163920">c</span><span class="op" id="4163921">.</span><span class="ident" id="4163922">server</span><span class="op" id="4163928">.</span><span class="ident" id="4163929">logf</span><span class="op" id="4163933">(</span><span class="string" id="4163934">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="4163973">,</span>&nbsp;<span class="ident" id="4163975">c</span><span class="op" id="4163976">.</span><span class="ident" id="4163977">rwc</span><span class="op" id="4163980">.</span><span class="ident" id="4163981">RemoteAddr</span><span class="op" id="4163991">(</span><span class="op" id="4163992">)</span><span class="op" id="4163993">,</span>&nbsp;<span class="ident" id="4163995">err</span><span class="op" id="4163998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164003">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164012">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164016">c</span><span class="op" id="4164017">.</span><span class="ident" id="4164018">tlsState</span>&nbsp;<span class="op" id="4164027">=</span>&nbsp;<span class="builtinfunc" id="4164029">new</span><span class="op" id="4164032">(</span><span class="ident" id="4164033">tls</span><span class="op" id="4164036">.</span><span class="ident" id="4164037">ConnectionState</span><span class="op" id="4164052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164056">*</span><span class="ident" id="4164057">c</span><span class="op" id="4164058">.</span><span class="ident" id="4164059">tlsState</span>&nbsp;<span class="op" id="4164068">=</span>&nbsp;<span class="ident" id="4164070">tlsConn</span><span class="op" id="4164077">.</span><span class="ident" id="4164078">ConnectionState</span><span class="op" id="4164093">(</span><span class="op" id="4164094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164098">if</span>&nbsp;<span class="ident" id="4164101">proto</span>&nbsp;<span class="op" id="4164107">:=</span>&nbsp;<span class="ident" id="4164110">c</span><span class="op" id="4164111">.</span><span class="ident" id="4164112">tlsState</span><span class="op" id="4164120">.</span><span class="ident" id="4164121">NegotiatedProtocol</span><span class="op" id="4164139">;</span>&nbsp;<span class="ident" id="4164141">validNPN</span><span class="op" id="4164149">(</span><span class="ident" id="4164150">proto</span><span class="op" id="4164155">)</span>&nbsp;<span class="op" id="4164157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164162">if</span>&nbsp;<span class="ident" id="4164165">fn</span>&nbsp;<span class="op" id="4164168">:=</span>&nbsp;<span class="ident" id="4164171">c</span><span class="op" id="4164172">.</span><span class="ident" id="4164173">server</span><span class="op" id="4164179">.</span><span class="ident" id="4164180">TLSNextProto</span><span class="op" id="4164192">[</span><span class="ident" id="4164193">proto</span><span class="op" id="4164198">]</span><span class="op" id="4164199">;</span>&nbsp;<span class="ident" id="4164201">fn</span>&nbsp;<span class="op" id="4164204">!=</span>&nbsp;<span class="builtintype" id="4164207">nil</span>&nbsp;<span class="op" id="4164211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164217">h</span>&nbsp;<span class="op" id="4164219">:=</span>&nbsp;<span class="ident" id="4164222">initNPNRequest</span><span class="op" id="4164236">{</span><span class="ident" id="4164237">tlsConn</span><span class="op" id="4164244">,</span>&nbsp;<span class="ident" id="4164246">serverHandler</span><span class="op" id="4164259">{</span><span class="ident" id="4164260">c</span><span class="op" id="4164261">.</span><span class="ident" id="4164262">server</span><span class="op" id="4164268">}</span><span class="op" id="4164269">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164275">fn</span><span class="op" id="4164277">(</span><span class="ident" id="4164278">c</span><span class="op" id="4164279">.</span><span class="ident" id="4164280">server</span><span class="op" id="4164286">,</span>&nbsp;<span class="ident" id="4164288">tlsConn</span><span class="op" id="4164295">,</span>&nbsp;<span class="ident" id="4164297">h</span><span class="op" id="4164298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164308">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164320">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164324">for</span>&nbsp;<span class="op" id="4164328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164332">w</span><span class="op" id="4164333">,</span>&nbsp;<span class="ident" id="4164335">err</span>&nbsp;<span class="op" id="4164339">:=</span>&nbsp;<span class="ident" id="4164342">c</span><span class="op" id="4164343">.</span><span class="ident" id="4164344">readRequest</span><span class="op" id="4164355">(</span><span class="op" id="4164356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164360">if</span>&nbsp;<span class="ident" id="4164363">c</span><span class="op" id="4164364">.</span><span class="ident" id="4164365">lr</span><span class="op" id="4164367">.</span><span class="ident" id="4164368">N</span>&nbsp;<span class="op" id="4164370">!=</span>&nbsp;<span class="ident" id="4164373">c</span><span class="op" id="4164374">.</span><span class="ident" id="4164375">server</span><span class="op" id="4164381">.</span><span class="ident" id="4164382">initialLimitedReaderSize</span><span class="op" id="4164406">(</span><span class="op" id="4164407">)</span>&nbsp;<span class="op" id="4164409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4164414">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164469">c</span><span class="op" id="4164470">.</span><span class="ident" id="4164471">setState</span><span class="op" id="4164479">(</span><span class="ident" id="4164480">c</span><span class="op" id="4164481">.</span><span class="ident" id="4164482">rwc</span><span class="op" id="4164485">,</span>&nbsp;<span class="ident" id="4164487">StateActive</span><span class="op" id="4164498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164506">if</span>&nbsp;<span class="ident" id="4164509">err</span>&nbsp;<span class="op" id="4164513">!=</span>&nbsp;<span class="builtintype" id="4164516">nil</span>&nbsp;<span class="op" id="4164520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164525">if</span>&nbsp;<span class="ident" id="4164528">err</span>&nbsp;<span class="op" id="4164532">==</span>&nbsp;<span class="ident" id="4164535">errTooLarge</span>&nbsp;<span class="op" id="4164547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4164553">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4164596">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4164630">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4164671">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4164712">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164749">io</span><span class="op" id="4164751">.</span><span class="ident" id="4164752">WriteString</span><span class="op" id="4164763">(</span><span class="ident" id="4164764">c</span><span class="op" id="4164765">.</span><span class="ident" id="4164766">rwc</span><span class="op" id="4164769">,</span>&nbsp;<span class="string" id="4164771">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="4164818">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4164824">c</span><span class="op" id="4164825">.</span><span class="ident" id="4164826">closeWriteAndWait</span><span class="op" id="4164843">(</span><span class="op" id="4164844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164850">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164859">}</span>&nbsp;<span class="keyword" id="4164861">else</span>&nbsp;<span class="keyword" id="4164866">if</span>&nbsp;<span class="ident" id="4164869">err</span>&nbsp;<span class="op" id="4164873">==</span>&nbsp;<span class="ident" id="4164876">io</span><span class="op" id="4164878">.</span><span class="ident" id="4164879">EOF</span>&nbsp;<span class="op" id="4164883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164889">break</span>&nbsp;<span class="comment" id="4164895">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4164913">}</span>&nbsp;<span class="keyword" id="4164915">else</span>&nbsp;<span class="keyword" id="4164920">if</span>&nbsp;<span class="ident" id="4164923">neterr</span><span class="op" id="4164929">,</span>&nbsp;<span class="ident" id="4164931">ok</span>&nbsp;<span class="op" id="4164934">:=</span>&nbsp;<span class="ident" id="4164937">err</span><span class="op" id="4164940">.</span><span class="op" id="4164941">(</span><span class="ident" id="4164942">net</span><span class="op" id="4164945">.</span><span class="ident" id="4164946">Error</span><span class="op" id="4164951">)</span><span class="op" id="4164952">;</span>&nbsp;<span class="ident" id="4164954">ok</span>&nbsp;<span class="op" id="4164957">&amp;&amp;</span>&nbsp;<span class="ident" id="4164960">neterr</span><span class="op" id="4164966">.</span><span class="ident" id="4164967">Timeout</span><span class="op" id="4164974">(</span><span class="op" id="4164975">)</span>&nbsp;<span class="op" id="4164977">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4164983">break</span>&nbsp;<span class="comment" id="4164989">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165012">io</span><span class="op" id="4165014">.</span><span class="ident" id="4165015">WriteString</span><span class="op" id="4165026">(</span><span class="ident" id="4165027">c</span><span class="op" id="4165028">.</span><span class="ident" id="4165029">rwc</span><span class="op" id="4165032">,</span>&nbsp;<span class="string" id="4165034">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="4165068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165073">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165081">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165086">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165119">req</span>&nbsp;<span class="op" id="4165123">:=</span>&nbsp;<span class="ident" id="4165126">w</span><span class="op" id="4165127">.</span><span class="ident" id="4165128">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165134">if</span>&nbsp;<span class="ident" id="4165137">req</span><span class="op" id="4165140">.</span><span class="ident" id="4165141">expectsContinue</span><span class="op" id="4165156">(</span><span class="op" id="4165157">)</span>&nbsp;<span class="op" id="4165159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165164">if</span>&nbsp;<span class="ident" id="4165167">req</span><span class="op" id="4165170">.</span><span class="ident" id="4165171">ProtoAtLeast</span><span class="op" id="4165183">(</span><span class="num" id="4165184">1</span><span class="op" id="4165185">,</span>&nbsp;<span class="num" id="4165187">1</span><span class="op" id="4165188">)</span>&nbsp;<span class="op" id="4165190">&amp;&amp;</span>&nbsp;<span class="ident" id="4165193">req</span><span class="op" id="4165196">.</span><span class="ident" id="4165197">ContentLength</span>&nbsp;<span class="op" id="4165211">!=</span>&nbsp;<span class="num" id="4165214">0</span>&nbsp;<span class="op" id="4165216">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165222">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165290">req</span><span class="op" id="4165293">.</span><span class="ident" id="4165294">Body</span>&nbsp;<span class="op" id="4165299">=</span>&nbsp;<span class="op" id="4165301">&amp;</span><span class="ident" id="4165302">expectContinueReader</span><span class="op" id="4165322">{</span><span class="ident" id="4165323">readCloser</span><span class="op" id="4165333">:</span>&nbsp;<span class="ident" id="4165335">req</span><span class="op" id="4165338">.</span><span class="ident" id="4165339">Body</span><span class="op" id="4165343">,</span>&nbsp;<span class="ident" id="4165345">resp</span><span class="op" id="4165349">:</span>&nbsp;<span class="ident" id="4165351">w</span><span class="op" id="4165352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165362">req</span><span class="op" id="4165365">.</span><span class="ident" id="4165366">Header</span><span class="op" id="4165372">.</span><span class="ident" id="4165373">Del</span><span class="op" id="4165376">(</span><span class="string" id="4165377">&#34;Expect&#34;</span><span class="op" id="4165385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165389">}</span>&nbsp;<span class="keyword" id="4165391">else</span>&nbsp;<span class="keyword" id="4165396">if</span>&nbsp;<span class="ident" id="4165399">req</span><span class="op" id="4165402">.</span><span class="ident" id="4165403">Header</span><span class="op" id="4165409">.</span><span class="ident" id="4165410">get</span><span class="op" id="4165413">(</span><span class="string" id="4165414">&#34;Expect&#34;</span><span class="op" id="4165422">)</span>&nbsp;<span class="op" id="4165424">!=</span>&nbsp;<span class="string" id="4165427">&#34;&#34;</span>&nbsp;<span class="op" id="4165430">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165435">w</span><span class="op" id="4165436">.</span><span class="ident" id="4165437">sendExpectationFailed</span><span class="op" id="4165458">(</span><span class="op" id="4165459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165464">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165477">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165541">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165611">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165671">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4165747">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165811">serverHandler</span><span class="op" id="4165824">{</span><span class="ident" id="4165825">c</span><span class="op" id="4165826">.</span><span class="ident" id="4165827">server</span><span class="op" id="4165833">}</span><span class="op" id="4165834">.</span><span class="ident" id="4165835">ServeHTTP</span><span class="op" id="4165844">(</span><span class="ident" id="4165845">w</span><span class="op" id="4165846">,</span>&nbsp;<span class="ident" id="4165848">w</span><span class="op" id="4165849">.</span><span class="ident" id="4165850">req</span><span class="op" id="4165853">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165857">if</span>&nbsp;<span class="ident" id="4165860">c</span><span class="op" id="4165861">.</span><span class="ident" id="4165862">hijacked</span><span class="op" id="4165870">(</span><span class="op" id="4165871">)</span>&nbsp;<span class="op" id="4165873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165878">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165891">w</span><span class="op" id="4165892">.</span><span class="ident" id="4165893">finishRequest</span><span class="op" id="4165906">(</span><span class="op" id="4165907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165911">if</span>&nbsp;<span class="ident" id="4165914">w</span><span class="op" id="4165915">.</span><span class="ident" id="4165916">closeAfterReply</span>&nbsp;<span class="op" id="4165932">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165937">if</span>&nbsp;<span class="ident" id="4165940">w</span><span class="op" id="4165941">.</span><span class="ident" id="4165942">requestBodyLimitHit</span>&nbsp;<span class="op" id="4165962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4165968">c</span><span class="op" id="4165969">.</span><span class="ident" id="4165970">closeWriteAndWait</span><span class="op" id="4165987">(</span><span class="op" id="4165988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4165993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4165998">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166006">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4166010">c</span><span class="op" id="4166011">.</span><span class="ident" id="4166012">setState</span><span class="op" id="4166020">(</span><span class="ident" id="4166021">c</span><span class="op" id="4166022">.</span><span class="ident" id="4166023">rwc</span><span class="op" id="4166026">,</span>&nbsp;<span class="ident" id="4166028">StateIdle</span><span class="op" id="4166037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166040">}</span><br>
<span class="lineno"></span><span class="op" id="4166042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4166045">func</span>&nbsp;<span class="op" id="4166050">(</span><span class="ident" id="4166051">w</span>&nbsp;<span class="op" id="4166053">*</span><span class="ident" id="4166054">response</span><span class="op" id="4166062">)</span>&nbsp;<span class="ident" id="4166064">sendExpectationFailed</span><span class="op" id="4166085">(</span><span class="op" id="4166086">)</span>&nbsp;<span class="op" id="4166088">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166091">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166141">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166194">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166244">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166294">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166334">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166378">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166382">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166436">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166486">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166533">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166581">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4166634">w</span><span class="op" id="4166635">.</span><span class="ident" id="4166636">Header</span><span class="op" id="4166642">(</span><span class="op" id="4166643">)</span><span class="op" id="4166644">.</span><span class="ident" id="4166645">Set</span><span class="op" id="4166648">(</span><span class="string" id="4166649">&#34;Connection&#34;</span><span class="op" id="4166661">,</span>&nbsp;<span class="string" id="4166663">&#34;close&#34;</span><span class="op" id="4166670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4166673">w</span><span class="op" id="4166674">.</span><span class="ident" id="4166675">WriteHeader</span><span class="op" id="4166686">(</span><span class="ident" id="4166687">StatusExpectationFailed</span><span class="op" id="4166710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4166713">w</span><span class="op" id="4166714">.</span><span class="ident" id="4166715">finishRequest</span><span class="op" id="4166728">(</span><span class="op" id="4166729">)</span><br>
<span class="lineno">1235</span><span class="op" id="4166731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4166734">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4166821">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="4166840">func</span>&nbsp;<span class="op" id="4166845">(</span><span class="ident" id="4166846">w</span>&nbsp;<span class="op" id="4166848">*</span><span class="ident" id="4166849">response</span><span class="op" id="4166857">)</span>&nbsp;<span class="ident" id="4166859">Hijack</span><span class="op" id="4166865">(</span><span class="op" id="4166866">)</span>&nbsp;<span class="op" id="4166868">(</span><span class="ident" id="4166869">rwc</span>&nbsp;<span class="ident" id="4166873">net</span><span class="op" id="4166876">.</span><span class="ident" id="4166877">Conn</span><span class="op" id="4166881">,</span>&nbsp;<span class="ident" id="4166883">buf</span>&nbsp;<span class="op" id="4166887">*</span><span class="ident" id="4166888">bufio</span><span class="op" id="4166893">.</span><span class="ident" id="4166894">ReadWriter</span><span class="op" id="4166904">,</span>&nbsp;<span class="ident" id="4166906">err</span>&nbsp;<span class="builtintype" id="4166910">error</span><span class="op" id="4166915">)</span>&nbsp;<span class="op" id="4166917">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4166920">if</span>&nbsp;<span class="ident" id="4166923">w</span><span class="op" id="4166924">.</span><span class="ident" id="4166925">wroteHeader</span>&nbsp;<span class="op" id="4166937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4166941">w</span><span class="op" id="4166942">.</span><span class="ident" id="4166943">cw</span><span class="op" id="4166945">.</span><span class="ident" id="4166946">flush</span><span class="op" id="4166951">(</span><span class="op" id="4166952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4166958">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4167029">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167076">rwc</span><span class="op" id="4167079">,</span>&nbsp;<span class="ident" id="4167081">buf</span><span class="op" id="4167084">,</span>&nbsp;<span class="ident" id="4167086">err</span>&nbsp;<span class="op" id="4167090">=</span>&nbsp;<span class="ident" id="4167092">w</span><span class="op" id="4167093">.</span><span class="ident" id="4167094">conn</span><span class="op" id="4167098">.</span><span class="ident" id="4167099">hijack</span><span class="op" id="4167105">(</span><span class="op" id="4167106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4167109">if</span>&nbsp;<span class="ident" id="4167112">err</span>&nbsp;<span class="op" id="4167116">==</span>&nbsp;<span class="builtintype" id="4167119">nil</span>&nbsp;<span class="op" id="4167123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167127">putBufioWriter</span><span class="op" id="4167141">(</span><span class="ident" id="4167142">w</span><span class="op" id="4167143">.</span><span class="ident" id="4167144">w</span><span class="op" id="4167145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167149">w</span><span class="op" id="4167150">.</span><span class="ident" id="4167151">w</span>&nbsp;<span class="op" id="4167153">=</span>&nbsp;<span class="builtintype" id="4167155">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4167160">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4167163">return</span>&nbsp;<span class="ident" id="4167170">rwc</span><span class="op" id="4167173">,</span>&nbsp;<span class="ident" id="4167175">buf</span><span class="op" id="4167178">,</span>&nbsp;<span class="ident" id="4167180">err</span><br>
<span class="lineno"></span><span class="op" id="4167184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4167187">func</span>&nbsp;<span class="op" id="4167192">(</span><span class="ident" id="4167193">w</span>&nbsp;<span class="op" id="4167195">*</span><span class="ident" id="4167196">response</span><span class="op" id="4167204">)</span>&nbsp;<span class="ident" id="4167206">CloseNotify</span><span class="op" id="4167217">(</span><span class="op" id="4167218">)</span>&nbsp;<span class="op" id="4167220">&lt;-</span><span class="keyword" id="4167222">chan</span>&nbsp;<span class="builtintype" id="4167227">bool</span>&nbsp;<span class="op" id="4167232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4167235">return</span>&nbsp;<span class="ident" id="4167242">w</span><span class="op" id="4167243">.</span><span class="ident" id="4167244">conn</span><span class="op" id="4167248">.</span><span class="ident" id="4167249">closeNotify</span><span class="op" id="4167260">(</span><span class="op" id="4167261">)</span><br>
<span class="lineno">1255</span><span class="op" id="4167263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4167266">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4167324">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="4167384">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="4167439">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="4167471">type</span>&nbsp;<span class="ident" id="4167476">HandlerFunc</span>&nbsp;<span class="keyword" id="4167488">func</span><span class="op" id="4167492">(</span><span class="ident" id="4167493">ResponseWriter</span><span class="op" id="4167507">,</span>&nbsp;<span class="op" id="4167509">*</span><span class="ident" id="4167510">Request</span><span class="op" id="4167517">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4167520">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="4167548">func</span>&nbsp;<span class="op" id="4167553">(</span><span class="ident" id="4167554">f</span>&nbsp;<span class="ident" id="4167556">HandlerFunc</span><span class="op" id="4167567">)</span>&nbsp;<span class="ident" id="4167569">ServeHTTP</span><span class="op" id="4167578">(</span><span class="ident" id="4167579">w</span>&nbsp;<span class="ident" id="4167581">ResponseWriter</span><span class="op" id="4167595">,</span>&nbsp;<span class="ident" id="4167597">r</span>&nbsp;<span class="op" id="4167599">*</span><span class="ident" id="4167600">Request</span><span class="op" id="4167607">)</span>&nbsp;<span class="op" id="4167609">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167612">f</span><span class="op" id="4167613">(</span><span class="ident" id="4167614">w</span><span class="op" id="4167615">,</span>&nbsp;<span class="ident" id="4167617">r</span><span class="op" id="4167618">)</span><br>
<span class="lineno"></span><span class="op" id="4167620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4167623">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="4167643">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="4167723">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="4167766">func</span>&nbsp;<span class="ident" id="4167771">Error</span><span class="op" id="4167776">(</span><span class="ident" id="4167777">w</span>&nbsp;<span class="ident" id="4167779">ResponseWriter</span><span class="op" id="4167793">,</span>&nbsp;<span class="builtintype" id="4167795">error</span>&nbsp;<span class="builtintype" id="4167801">string</span><span class="op" id="4167807">,</span>&nbsp;<span class="ident" id="4167809">code</span>&nbsp;<span class="builtintype" id="4167814">int</span><span class="op" id="4167817">)</span>&nbsp;<span class="op" id="4167819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167822">w</span><span class="op" id="4167823">.</span><span class="ident" id="4167824">Header</span><span class="op" id="4167830">(</span><span class="op" id="4167831">)</span><span class="op" id="4167832">.</span><span class="ident" id="4167833">Set</span><span class="op" id="4167836">(</span><span class="string" id="4167837">&#34;Content-Type&#34;</span><span class="op" id="4167851">,</span>&nbsp;<span class="string" id="4167853">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="4167880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167883">w</span><span class="op" id="4167884">.</span><span class="ident" id="4167885">WriteHeader</span><span class="op" id="4167896">(</span><span class="ident" id="4167897">code</span><span class="op" id="4167901">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4167904">fmt</span><span class="op" id="4167907">.</span><span class="ident" id="4167908">Fprintln</span><span class="op" id="4167916">(</span><span class="ident" id="4167917">w</span><span class="op" id="4167918">,</span>&nbsp;<span class="builtintype" id="4167920">error</span><span class="op" id="4167925">)</span><br>
<span class="lineno"></span><span class="op" id="4167927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4167930">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4167999">func</span>&nbsp;<span class="ident" id="4168004">NotFound</span><span class="op" id="4168012">(</span><span class="ident" id="4168013">w</span>&nbsp;<span class="ident" id="4168015">ResponseWriter</span><span class="op" id="4168029">,</span>&nbsp;<span class="ident" id="4168031">r</span>&nbsp;<span class="op" id="4168033">*</span><span class="ident" id="4168034">Request</span><span class="op" id="4168041">)</span>&nbsp;<span class="op" id="4168043">{</span>&nbsp;<span class="ident" id="4168045">Error</span><span class="op" id="4168050">(</span><span class="ident" id="4168051">w</span><span class="op" id="4168052">,</span>&nbsp;<span class="string" id="4168054">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="4168074">,</span>&nbsp;<span class="ident" id="4168076">StatusNotFound</span><span class="op" id="4168090">)</span>&nbsp;<span class="op" id="4168092">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="4168095">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4168147">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="4168216">func</span>&nbsp;<span class="ident" id="4168221">NotFoundHandler</span><span class="op" id="4168236">(</span><span class="op" id="4168237">)</span>&nbsp;<span class="ident" id="4168239">Handler</span>&nbsp;<span class="op" id="4168247">{</span>&nbsp;<span class="keyword" id="4168249">return</span>&nbsp;<span class="ident" id="4168256">HandlerFunc</span><span class="op" id="4168267">(</span><span class="ident" id="4168268">NotFound</span><span class="op" id="4168276">)</span>&nbsp;<span class="op" id="4168278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="4168281">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4168340">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="4168400">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4168453">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4168509">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="4168555">func</span>&nbsp;<span class="ident" id="4168560">StripPrefix</span><span class="op" id="4168571">(</span><span class="ident" id="4168572">prefix</span>&nbsp;<span class="builtintype" id="4168579">string</span><span class="op" id="4168585">,</span>&nbsp;<span class="ident" id="4168587">h</span>&nbsp;<span class="ident" id="4168589">Handler</span><span class="op" id="4168596">)</span>&nbsp;<span class="ident" id="4168598">Handler</span>&nbsp;<span class="op" id="4168606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4168609">if</span>&nbsp;<span class="ident" id="4168612">prefix</span>&nbsp;<span class="op" id="4168619">==</span>&nbsp;<span class="string" id="4168622">&#34;&#34;</span>&nbsp;<span class="op" id="4168625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4168629">return</span>&nbsp;<span class="ident" id="4168636">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4168639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4168642">return</span>&nbsp;<span class="ident" id="4168649">HandlerFunc</span><span class="op" id="4168660">(</span><span class="keyword" id="4168661">func</span><span class="op" id="4168665">(</span><span class="ident" id="4168666">w</span>&nbsp;<span class="ident" id="4168668">ResponseWriter</span><span class="op" id="4168682">,</span>&nbsp;<span class="ident" id="4168684">r</span>&nbsp;<span class="op" id="4168686">*</span><span class="ident" id="4168687">Request</span><span class="op" id="4168694">)</span>&nbsp;<span class="op" id="4168696">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4168700">if</span>&nbsp;<span class="ident" id="4168703">p</span>&nbsp;<span class="op" id="4168705">:=</span>&nbsp;<span class="ident" id="4168708">strings</span><span class="op" id="4168715">.</span><span class="ident" id="4168716">TrimPrefix</span><span class="op" id="4168726">(</span><span class="ident" id="4168727">r</span><span class="op" id="4168728">.</span><span class="ident" id="4168729">URL</span><span class="op" id="4168732">.</span><span class="ident" id="4168733">Path</span><span class="op" id="4168737">,</span>&nbsp;<span class="ident" id="4168739">prefix</span><span class="op" id="4168745">)</span><span class="op" id="4168746">;</span>&nbsp;<span class="builtinfunc" id="4168748">len</span><span class="op" id="4168751">(</span><span class="ident" id="4168752">p</span><span class="op" id="4168753">)</span>&nbsp;<span class="op" id="4168755">&lt;</span>&nbsp;<span class="builtinfunc" id="4168757">len</span><span class="op" id="4168760">(</span><span class="ident" id="4168761">r</span><span class="op" id="4168762">.</span><span class="ident" id="4168763">URL</span><span class="op" id="4168766">.</span><span class="ident" id="4168767">Path</span><span class="op" id="4168771">)</span>&nbsp;<span class="op" id="4168773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4168778">r</span><span class="op" id="4168779">.</span><span class="ident" id="4168780">URL</span><span class="op" id="4168783">.</span><span class="ident" id="4168784">Path</span>&nbsp;<span class="op" id="4168789">=</span>&nbsp;<span class="ident" id="4168791">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4168796">h</span><span class="op" id="4168797">.</span><span class="ident" id="4168798">ServeHTTP</span><span class="op" id="4168807">(</span><span class="ident" id="4168808">w</span><span class="op" id="4168809">,</span>&nbsp;<span class="ident" id="4168811">r</span><span class="op" id="4168812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4168816">}</span>&nbsp;<span class="keyword" id="4168818">else</span>&nbsp;<span class="op" id="4168823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4168828">NotFound</span><span class="op" id="4168836">(</span><span class="ident" id="4168837">w</span><span class="op" id="4168838">,</span>&nbsp;<span class="ident" id="4168840">r</span><span class="op" id="4168841">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4168845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4168848">}</span><span class="op" id="4168849">)</span><br>
<span class="lineno"></span><span class="op" id="4168851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4168854">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="4168913">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="4168966">func</span>&nbsp;<span class="ident" id="4168971">Redirect</span><span class="op" id="4168979">(</span><span class="ident" id="4168980">w</span>&nbsp;<span class="ident" id="4168982">ResponseWriter</span><span class="op" id="4168996">,</span>&nbsp;<span class="ident" id="4168998">r</span>&nbsp;<span class="op" id="4169000">*</span><span class="ident" id="4169001">Request</span><span class="op" id="4169008">,</span>&nbsp;<span class="ident" id="4169010">urlStr</span>&nbsp;<span class="builtintype" id="4169017">string</span><span class="op" id="4169023">,</span>&nbsp;<span class="ident" id="4169025">code</span>&nbsp;<span class="builtintype" id="4169030">int</span><span class="op" id="4169033">)</span>&nbsp;<span class="op" id="4169035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4169038">if</span>&nbsp;<span class="ident" id="4169041">u</span><span class="op" id="4169042">,</span>&nbsp;<span class="ident" id="4169044">err</span>&nbsp;<span class="op" id="4169048">:=</span>&nbsp;<span class="ident" id="4169051">url</span><span class="op" id="4169054">.</span><span class="ident" id="4169055">Parse</span><span class="op" id="4169060">(</span><span class="ident" id="4169061">urlStr</span><span class="op" id="4169067">)</span><span class="op" id="4169068">;</span>&nbsp;<span class="ident" id="4169070">err</span>&nbsp;<span class="op" id="4169074">==</span>&nbsp;<span class="builtintype" id="4169077">nil</span>&nbsp;<span class="op" id="4169081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169085">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169128">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169162">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169210">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169257">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169305">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169345">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169385">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169420">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169462">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169507">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169555">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169602">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169654">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169707">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169722">oldpath</span>&nbsp;<span class="op" id="4169730">:=</span>&nbsp;<span class="ident" id="4169733">r</span><span class="op" id="4169734">.</span><span class="ident" id="4169735">URL</span><span class="op" id="4169738">.</span><span class="ident" id="4169739">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4169746">if</span>&nbsp;<span class="ident" id="4169749">oldpath</span>&nbsp;<span class="op" id="4169757">==</span>&nbsp;<span class="string" id="4169760">&#34;&#34;</span>&nbsp;<span class="op" id="4169763">{</span>&nbsp;<span class="comment" id="4169765">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169819">oldpath</span>&nbsp;<span class="op" id="4169827">=</span>&nbsp;<span class="string" id="4169829">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4169835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4169839">if</span>&nbsp;<span class="ident" id="4169842">u</span><span class="op" id="4169843">.</span><span class="ident" id="4169844">Scheme</span>&nbsp;<span class="op" id="4169851">==</span>&nbsp;<span class="string" id="4169854">&#34;&#34;</span>&nbsp;<span class="op" id="4169857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169862">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4169893">if</span>&nbsp;<span class="ident" id="4169896">urlStr</span>&nbsp;<span class="op" id="4169903">==</span>&nbsp;<span class="string" id="4169906">&#34;&#34;</span>&nbsp;<span class="op" id="4169909">||</span>&nbsp;<span class="ident" id="4169912">urlStr</span><span class="op" id="4169918">[</span><span class="num" id="4169919">0</span><span class="op" id="4169920">]</span>&nbsp;<span class="op" id="4169922">!=</span>&nbsp;<span class="string" id="4169925">&#39;/&#39;</span>&nbsp;<span class="op" id="4169929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4169935">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4169970">olddir</span><span class="op" id="4169976">,</span>&nbsp;<span class="ident" id="4169978">_</span>&nbsp;<span class="op" id="4169980">:=</span>&nbsp;<span class="ident" id="4169983">path</span><span class="op" id="4169987">.</span><span class="ident" id="4169988">Split</span><span class="op" id="4169993">(</span><span class="ident" id="4169994">oldpath</span><span class="op" id="4170001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170007">urlStr</span>&nbsp;<span class="op" id="4170014">=</span>&nbsp;<span class="ident" id="4170016">olddir</span>&nbsp;<span class="op" id="4170023">+</span>&nbsp;<span class="ident" id="4170025">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4170035">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4170041">var</span>&nbsp;<span class="ident" id="4170045">query</span>&nbsp;<span class="builtintype" id="4170051">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4170061">if</span>&nbsp;<span class="ident" id="4170064">i</span>&nbsp;<span class="op" id="4170066">:=</span>&nbsp;<span class="ident" id="4170069">strings</span><span class="op" id="4170076">.</span><span class="ident" id="4170077">Index</span><span class="op" id="4170082">(</span><span class="ident" id="4170083">urlStr</span><span class="op" id="4170089">,</span>&nbsp;<span class="string" id="4170091">&#34;?&#34;</span><span class="op" id="4170094">)</span><span class="op" id="4170095">;</span>&nbsp;<span class="ident" id="4170097">i</span>&nbsp;<span class="op" id="4170099">!=</span>&nbsp;<span class="op" id="4170102">-</span><span class="num" id="4170103">1</span>&nbsp;<span class="op" id="4170105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170111">urlStr</span><span class="op" id="4170117">,</span>&nbsp;<span class="ident" id="4170119">query</span>&nbsp;<span class="op" id="4170125">=</span>&nbsp;<span class="ident" id="4170127">urlStr</span><span class="op" id="4170133">[</span><span class="op" id="4170134">:</span><span class="ident" id="4170135">i</span><span class="op" id="4170136">]</span><span class="op" id="4170137">,</span>&nbsp;<span class="ident" id="4170139">urlStr</span><span class="op" id="4170145">[</span><span class="ident" id="4170146">i</span><span class="op" id="4170147">:</span><span class="op" id="4170148">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4170153">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170159">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170202">trailing</span>&nbsp;<span class="op" id="4170211">:=</span>&nbsp;<span class="ident" id="4170214">strings</span><span class="op" id="4170221">.</span><span class="ident" id="4170222">HasSuffix</span><span class="op" id="4170231">(</span><span class="ident" id="4170232">urlStr</span><span class="op" id="4170238">,</span>&nbsp;<span class="string" id="4170240">&#34;/&#34;</span><span class="op" id="4170243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170248">urlStr</span>&nbsp;<span class="op" id="4170255">=</span>&nbsp;<span class="ident" id="4170257">path</span><span class="op" id="4170261">.</span><span class="ident" id="4170262">Clean</span><span class="op" id="4170267">(</span><span class="ident" id="4170268">urlStr</span><span class="op" id="4170274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4170279">if</span>&nbsp;<span class="ident" id="4170282">trailing</span>&nbsp;<span class="op" id="4170291">&amp;&amp;</span>&nbsp;<span class="op" id="4170294">!</span><span class="ident" id="4170295">strings</span><span class="op" id="4170302">.</span><span class="ident" id="4170303">HasSuffix</span><span class="op" id="4170312">(</span><span class="ident" id="4170313">urlStr</span><span class="op" id="4170319">,</span>&nbsp;<span class="string" id="4170321">&#34;/&#34;</span><span class="op" id="4170324">)</span>&nbsp;<span class="op" id="4170326">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170332">urlStr</span>&nbsp;<span class="op" id="4170339">+=</span>&nbsp;<span class="string" id="4170342">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4170349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170354">urlStr</span>&nbsp;<span class="op" id="4170361">+=</span>&nbsp;<span class="ident" id="4170364">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4170372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4170375">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170379">w</span><span class="op" id="4170380">.</span><span class="ident" id="4170381">Header</span><span class="op" id="4170387">(</span><span class="op" id="4170388">)</span><span class="op" id="4170389">.</span><span class="ident" id="4170390">Set</span><span class="op" id="4170393">(</span><span class="string" id="4170394">&#34;Location&#34;</span><span class="op" id="4170404">,</span>&nbsp;<span class="ident" id="4170406">urlStr</span><span class="op" id="4170412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170415">w</span><span class="op" id="4170416">.</span><span class="ident" id="4170417">WriteHeader</span><span class="op" id="4170428">(</span><span class="ident" id="4170429">code</span><span class="op" id="4170433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170437">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170506">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170573">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4170640">if</span>&nbsp;<span class="ident" id="4170643">r</span><span class="op" id="4170644">.</span><span class="ident" id="4170645">Method</span>&nbsp;<span class="op" id="4170652">==</span>&nbsp;<span class="string" id="4170655">&#34;GET&#34;</span>&nbsp;<span class="op" id="4170661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170665">note</span>&nbsp;<span class="op" id="4170670">:=</span>&nbsp;<span class="string" id="4170673">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="4170686">+</span>&nbsp;<span class="ident" id="4170688">htmlEscape</span><span class="op" id="4170698">(</span><span class="ident" id="4170699">urlStr</span><span class="op" id="4170705">)</span>&nbsp;<span class="op" id="4170707">+</span>&nbsp;<span class="string" id="4170709">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="4170715">+</span>&nbsp;<span class="ident" id="4170717">statusText</span><span class="op" id="4170727">[</span><span class="ident" id="4170728">code</span><span class="op" id="4170732">]</span>&nbsp;<span class="op" id="4170734">+</span>&nbsp;<span class="string" id="4170736">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170748">fmt</span><span class="op" id="4170751">.</span><span class="ident" id="4170752">Fprintln</span><span class="op" id="4170760">(</span><span class="ident" id="4170761">w</span><span class="op" id="4170762">,</span>&nbsp;<span class="ident" id="4170764">note</span><span class="op" id="4170768">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4170771">}</span><br>
<span class="lineno"></span><span class="op" id="4170773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4170776">var</span>&nbsp;<span class="ident" id="4170780">htmlReplacer</span>&nbsp;<span class="op" id="4170793">=</span>&nbsp;<span class="ident" id="4170795">strings</span><span class="op" id="4170802">.</span><span class="ident" id="4170803">NewReplacer</span><span class="op" id="4170814">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4170817">&#34;&amp;&#34;</span><span class="op" id="4170820">,</span>&nbsp;<span class="string" id="4170822">&#34;&amp;amp;&#34;</span><span class="op" id="4170829">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4170832">&#34;&lt;&#34;</span><span class="op" id="4170835">,</span>&nbsp;<span class="string" id="4170837">&#34;&amp;lt;&#34;</span><span class="op" id="4170843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4170846">&#34;&gt;&#34;</span><span class="op" id="4170849">,</span>&nbsp;<span class="string" id="4170851">&#34;&amp;gt;&#34;</span><span class="op" id="4170857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170860">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4170898">`&#34;`</span><span class="op" id="4170901">,</span>&nbsp;<span class="string" id="4170903">&#34;&amp;#34;&#34;</span><span class="op" id="4170910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4170913">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4170988">&#34;&#39;&#34;</span><span class="op" id="4170991">,</span>&nbsp;<span class="string" id="4170993">&#34;&amp;#39;&#34;</span><span class="op" id="4171000">,</span><br>
<span class="lineno"></span><span class="op" id="4171002">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4171005">func</span>&nbsp;<span class="ident" id="4171010">htmlEscape</span><span class="op" id="4171020">(</span><span class="ident" id="4171021">s</span>&nbsp;<span class="builtintype" id="4171023">string</span><span class="op" id="4171029">)</span>&nbsp;<span class="builtintype" id="4171031">string</span>&nbsp;<span class="op" id="4171038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4171041">return</span>&nbsp;<span class="ident" id="4171048">htmlReplacer</span><span class="op" id="4171060">.</span><span class="ident" id="4171061">Replace</span><span class="op" id="4171068">(</span><span class="ident" id="4171069">s</span><span class="op" id="4171070">)</span><br>
<span class="lineno">1375</span><span class="op" id="4171072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4171075">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="4171102">type</span>&nbsp;<span class="ident" id="4171107">redirectHandler</span>&nbsp;<span class="keyword" id="4171123">struct</span>&nbsp;<span class="op" id="4171130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171133">url</span>&nbsp;&nbsp;<span class="builtintype" id="4171138">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171146">code</span>&nbsp;<span class="builtintype" id="4171151">int</span><br>
<span class="lineno"></span><span class="op" id="4171155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4171158">func</span>&nbsp;<span class="op" id="4171163">(</span><span class="ident" id="4171164">rh</span>&nbsp;<span class="op" id="4171167">*</span><span class="ident" id="4171168">redirectHandler</span><span class="op" id="4171183">)</span>&nbsp;<span class="ident" id="4171185">ServeHTTP</span><span class="op" id="4171194">(</span><span class="ident" id="4171195">w</span>&nbsp;<span class="ident" id="4171197">ResponseWriter</span><span class="op" id="4171211">,</span>&nbsp;<span class="ident" id="4171213">r</span>&nbsp;<span class="op" id="4171215">*</span><span class="ident" id="4171216">Request</span><span class="op" id="4171223">)</span>&nbsp;<span class="op" id="4171225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171228">Redirect</span><span class="op" id="4171236">(</span><span class="ident" id="4171237">w</span><span class="op" id="4171238">,</span>&nbsp;<span class="ident" id="4171240">r</span><span class="op" id="4171241">,</span>&nbsp;<span class="ident" id="4171243">rh</span><span class="op" id="4171245">.</span><span class="ident" id="4171246">url</span><span class="op" id="4171249">,</span>&nbsp;<span class="ident" id="4171251">rh</span><span class="op" id="4171253">.</span><span class="ident" id="4171254">code</span><span class="op" id="4171258">)</span><br>
<span class="lineno">1385</span><span class="op" id="4171260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4171263">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="4171323">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="4171384">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="4171400">func</span>&nbsp;<span class="ident" id="4171405">RedirectHandler</span><span class="op" id="4171420">(</span><span class="ident" id="4171421">url</span>&nbsp;<span class="builtintype" id="4171425">string</span><span class="op" id="4171431">,</span>&nbsp;<span class="ident" id="4171433">code</span>&nbsp;<span class="builtintype" id="4171438">int</span><span class="op" id="4171441">)</span>&nbsp;<span class="ident" id="4171443">Handler</span>&nbsp;<span class="op" id="4171451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4171454">return</span>&nbsp;<span class="op" id="4171461">&amp;</span><span class="ident" id="4171462">redirectHandler</span><span class="op" id="4171477">{</span><span class="ident" id="4171478">url</span><span class="op" id="4171481">,</span>&nbsp;<span class="ident" id="4171483">code</span><span class="op" id="4171487">}</span><br>
<span class="lineno"></span><span class="op" id="4171489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4171492">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="4171536">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="4171612">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4171667">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="4171700">//</span><br>
<span class="lineno"></span><span class="comment" id="4171703">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="4171762">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="4171828">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4171890">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4171946">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4172003">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="4172063">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4172122">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="4172145">//</span><br>
<span class="lineno"></span><span class="comment" id="4172148">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="4172219">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="4172288">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4172336">//</span><br>
<span class="lineno"></span><span class="comment" id="4172339">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4172413">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4172485">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="4172560">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4172631">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4172673">//</span><br>
<span class="lineno"></span><span class="comment" id="4172676">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="4172740">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="4172801">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4172835">type</span>&nbsp;<span class="ident" id="4172840">ServeMux</span>&nbsp;<span class="keyword" id="4172849">struct</span>&nbsp;<span class="op" id="4172856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172859">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172865">sync</span><span class="op" id="4172869">.</span><span class="ident" id="4172870">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172879">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4172885">map</span><span class="op" id="4172888">[</span><span class="builtintype" id="4172889">string</span><span class="op" id="4172895">]</span><span class="ident" id="4172896">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172906">hosts</span>&nbsp;<span class="builtintype" id="4172912">bool</span>&nbsp;<span class="comment" id="4172917">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="4172959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4172962">type</span>&nbsp;<span class="ident" id="4172967">muxEntry</span>&nbsp;<span class="keyword" id="4172976">struct</span>&nbsp;<span class="op" id="4172983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4172986">explicit</span>&nbsp;<span class="builtintype" id="4172995">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173001">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173010">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173019">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="4173028">string</span><br>
<span class="lineno"></span><span class="op" id="4173035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4173038">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="4173091">func</span>&nbsp;<span class="ident" id="4173096">NewServeMux</span><span class="op" id="4173107">(</span><span class="op" id="4173108">)</span>&nbsp;<span class="op" id="4173110">*</span><span class="ident" id="4173111">ServeMux</span>&nbsp;<span class="op" id="4173120">{</span>&nbsp;<span class="keyword" id="4173122">return</span>&nbsp;<span class="op" id="4173129">&amp;</span><span class="ident" id="4173130">ServeMux</span><span class="op" id="4173138">{</span><span class="ident" id="4173139">m</span><span class="op" id="4173140">:</span>&nbsp;<span class="builtinfunc" id="4173142">make</span><span class="op" id="4173146">(</span><span class="keyword" id="4173147">map</span><span class="op" id="4173150">[</span><span class="builtintype" id="4173151">string</span><span class="op" id="4173157">]</span><span class="ident" id="4173158">muxEntry</span><span class="op" id="4173166">)</span><span class="op" id="4173167">}</span>&nbsp;<span class="op" id="4173169">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="4173172">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="4173230">var</span>&nbsp;<span class="ident" id="4173234">DefaultServeMux</span>&nbsp;<span class="op" id="4173250">=</span>&nbsp;<span class="ident" id="4173252">NewServeMux</span><span class="op" id="4173263">(</span><span class="op" id="4173264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4173267">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="4173295">func</span>&nbsp;<span class="ident" id="4173300">pathMatch</span><span class="op" id="4173309">(</span><span class="ident" id="4173310">pattern</span><span class="op" id="4173317">,</span>&nbsp;<span class="ident" id="4173319">path</span>&nbsp;<span class="builtintype" id="4173324">string</span><span class="op" id="4173330">)</span>&nbsp;<span class="builtintype" id="4173332">bool</span>&nbsp;<span class="op" id="4173337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173340">if</span>&nbsp;<span class="builtinfunc" id="4173343">len</span><span class="op" id="4173346">(</span><span class="ident" id="4173347">pattern</span><span class="op" id="4173354">)</span>&nbsp;<span class="op" id="4173356">==</span>&nbsp;<span class="num" id="4173359">0</span>&nbsp;<span class="op" id="4173361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173365">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173388">return</span>&nbsp;<span class="builtintype" id="4173395">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173402">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173405">n</span>&nbsp;<span class="op" id="4173407">:=</span>&nbsp;<span class="builtinfunc" id="4173410">len</span><span class="op" id="4173413">(</span><span class="ident" id="4173414">pattern</span><span class="op" id="4173421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173424">if</span>&nbsp;<span class="ident" id="4173427">pattern</span><span class="op" id="4173434">[</span><span class="ident" id="4173435">n</span><span class="op" id="4173436">-</span><span class="num" id="4173437">1</span><span class="op" id="4173438">]</span>&nbsp;<span class="op" id="4173440">!=</span>&nbsp;<span class="string" id="4173443">&#39;/&#39;</span>&nbsp;<span class="op" id="4173447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173451">return</span>&nbsp;<span class="ident" id="4173458">pattern</span>&nbsp;<span class="op" id="4173466">==</span>&nbsp;<span class="ident" id="4173469">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173478">return</span>&nbsp;<span class="builtinfunc" id="4173485">len</span><span class="op" id="4173488">(</span><span class="ident" id="4173489">path</span><span class="op" id="4173493">)</span>&nbsp;<span class="op" id="4173495">&gt;=</span>&nbsp;<span class="ident" id="4173498">n</span>&nbsp;<span class="op" id="4173500">&amp;&amp;</span>&nbsp;<span class="ident" id="4173503">path</span><span class="op" id="4173507">[</span><span class="num" id="4173508">0</span><span class="op" id="4173509">:</span><span class="ident" id="4173510">n</span><span class="op" id="4173511">]</span>&nbsp;<span class="op" id="4173513">==</span>&nbsp;<span class="ident" id="4173516">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="4173524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4173527">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="4173594">func</span>&nbsp;<span class="ident" id="4173599">cleanPath</span><span class="op" id="4173608">(</span><span class="ident" id="4173609">p</span>&nbsp;<span class="builtintype" id="4173611">string</span><span class="op" id="4173617">)</span>&nbsp;<span class="builtintype" id="4173619">string</span>&nbsp;<span class="op" id="4173626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173629">if</span>&nbsp;<span class="ident" id="4173632">p</span>&nbsp;<span class="op" id="4173634">==</span>&nbsp;<span class="string" id="4173637">&#34;&#34;</span>&nbsp;<span class="op" id="4173640">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173644">return</span>&nbsp;<span class="string" id="4173651">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173659">if</span>&nbsp;<span class="ident" id="4173662">p</span><span class="op" id="4173663">[</span><span class="num" id="4173664">0</span><span class="op" id="4173665">]</span>&nbsp;<span class="op" id="4173667">!=</span>&nbsp;<span class="string" id="4173670">&#39;/&#39;</span>&nbsp;<span class="op" id="4173674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173678">p</span>&nbsp;<span class="op" id="4173680">=</span>&nbsp;<span class="string" id="4173682">&#34;/&#34;</span>&nbsp;<span class="op" id="4173686">+</span>&nbsp;<span class="ident" id="4173688">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173691">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173694">np</span>&nbsp;<span class="op" id="4173697">:=</span>&nbsp;<span class="ident" id="4173700">path</span><span class="op" id="4173704">.</span><span class="ident" id="4173705">Clean</span><span class="op" id="4173710">(</span><span class="ident" id="4173711">p</span><span class="op" id="4173712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173715">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4173770">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173816">if</span>&nbsp;<span class="ident" id="4173819">p</span><span class="op" id="4173820">[</span><span class="builtinfunc" id="4173821">len</span><span class="op" id="4173824">(</span><span class="ident" id="4173825">p</span><span class="op" id="4173826">)</span><span class="op" id="4173827">-</span><span class="num" id="4173828">1</span><span class="op" id="4173829">]</span>&nbsp;<span class="op" id="4173831">==</span>&nbsp;<span class="string" id="4173834">&#39;/&#39;</span>&nbsp;<span class="op" id="4173838">&amp;&amp;</span>&nbsp;<span class="ident" id="4173841">np</span>&nbsp;<span class="op" id="4173844">!=</span>&nbsp;<span class="string" id="4173847">&#34;/&#34;</span>&nbsp;<span class="op" id="4173851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4173855">np</span>&nbsp;<span class="op" id="4173858">+=</span>&nbsp;<span class="string" id="4173861">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4173866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4173869">return</span>&nbsp;<span class="ident" id="4173876">np</span><br>
<span class="lineno"></span><span class="op" id="4173879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4173882">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="4173937">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="4173977">func</span>&nbsp;<span class="op" id="4173982">(</span><span class="ident" id="4173983">mux</span>&nbsp;<span class="op" id="4173987">*</span><span class="ident" id="4173988">ServeMux</span><span class="op" id="4173996">)</span>&nbsp;<span class="ident" id="4173998">match</span><span class="op" id="4174003">(</span><span class="ident" id="4174004">path</span>&nbsp;<span class="builtintype" id="4174009">string</span><span class="op" id="4174015">)</span>&nbsp;<span class="op" id="4174017">(</span><span class="ident" id="4174018">h</span>&nbsp;<span class="ident" id="4174020">Handler</span><span class="op" id="4174027">,</span>&nbsp;<span class="ident" id="4174029">pattern</span>&nbsp;<span class="builtintype" id="4174037">string</span><span class="op" id="4174043">)</span>&nbsp;<span class="op" id="4174045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174048">var</span>&nbsp;<span class="ident" id="4174052">n</span>&nbsp;<span class="op" id="4174054">=</span>&nbsp;<span class="num" id="4174056">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174059">for</span>&nbsp;<span class="ident" id="4174063">k</span><span class="op" id="4174064">,</span>&nbsp;<span class="ident" id="4174066">v</span>&nbsp;<span class="op" id="4174068">:=</span>&nbsp;<span class="keyword" id="4174071">range</span>&nbsp;<span class="ident" id="4174077">mux</span><span class="op" id="4174080">.</span><span class="ident" id="4174081">m</span>&nbsp;<span class="op" id="4174083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174087">if</span>&nbsp;<span class="op" id="4174090">!</span><span class="ident" id="4174091">pathMatch</span><span class="op" id="4174100">(</span><span class="ident" id="4174101">k</span><span class="op" id="4174102">,</span>&nbsp;<span class="ident" id="4174104">path</span><span class="op" id="4174108">)</span>&nbsp;<span class="op" id="4174110">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174115">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174130">if</span>&nbsp;<span class="ident" id="4174133">h</span>&nbsp;<span class="op" id="4174135">==</span>&nbsp;<span class="builtintype" id="4174138">nil</span>&nbsp;<span class="op" id="4174142">||</span>&nbsp;<span class="builtinfunc" id="4174145">len</span><span class="op" id="4174148">(</span><span class="ident" id="4174149">k</span><span class="op" id="4174150">)</span>&nbsp;<span class="op" id="4174152">&gt;</span>&nbsp;<span class="ident" id="4174154">n</span>&nbsp;<span class="op" id="4174156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174161">n</span>&nbsp;<span class="op" id="4174163">=</span>&nbsp;<span class="builtinfunc" id="4174165">len</span><span class="op" id="4174168">(</span><span class="ident" id="4174169">k</span><span class="op" id="4174170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174175">h</span>&nbsp;<span class="op" id="4174177">=</span>&nbsp;<span class="ident" id="4174179">v</span><span class="op" id="4174180">.</span><span class="ident" id="4174181">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174186">pattern</span>&nbsp;<span class="op" id="4174194">=</span>&nbsp;<span class="ident" id="4174196">v</span><span class="op" id="4174197">.</span><span class="ident" id="4174198">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4174211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174214">return</span><br>
<span class="lineno"></span><span class="op" id="4174221">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="4174224">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4174285">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4174351">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4174419">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="4174485">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="4174511">//</span><br>
<span class="lineno"></span><span class="comment" id="4174514">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4174578">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="4174640">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="4174701">//</span><br>
<span class="lineno"></span><span class="comment" id="4174704">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4174770">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4174840">func</span>&nbsp;<span class="op" id="4174845">(</span><span class="ident" id="4174846">mux</span>&nbsp;<span class="op" id="4174850">*</span><span class="ident" id="4174851">ServeMux</span><span class="op" id="4174859">)</span>&nbsp;<span class="ident" id="4174861">Handler</span><span class="op" id="4174868">(</span><span class="ident" id="4174869">r</span>&nbsp;<span class="op" id="4174871">*</span><span class="ident" id="4174872">Request</span><span class="op" id="4174879">)</span>&nbsp;<span class="op" id="4174881">(</span><span class="ident" id="4174882">h</span>&nbsp;<span class="ident" id="4174884">Handler</span><span class="op" id="4174891">,</span>&nbsp;<span class="ident" id="4174893">pattern</span>&nbsp;<span class="builtintype" id="4174901">string</span><span class="op" id="4174907">)</span>&nbsp;<span class="op" id="4174909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174912">if</span>&nbsp;<span class="ident" id="4174915">r</span><span class="op" id="4174916">.</span><span class="ident" id="4174917">Method</span>&nbsp;<span class="op" id="4174924">!=</span>&nbsp;<span class="string" id="4174927">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="4174937">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4174941">if</span>&nbsp;<span class="ident" id="4174944">p</span>&nbsp;<span class="op" id="4174946">:=</span>&nbsp;<span class="ident" id="4174949">cleanPath</span><span class="op" id="4174958">(</span><span class="ident" id="4174959">r</span><span class="op" id="4174960">.</span><span class="ident" id="4174961">URL</span><span class="op" id="4174964">.</span><span class="ident" id="4174965">Path</span><span class="op" id="4174969">)</span><span class="op" id="4174970">;</span>&nbsp;<span class="ident" id="4174972">p</span>&nbsp;<span class="op" id="4174974">!=</span>&nbsp;<span class="ident" id="4174977">r</span><span class="op" id="4174978">.</span><span class="ident" id="4174979">URL</span><span class="op" id="4174982">.</span><span class="ident" id="4174983">Path</span>&nbsp;<span class="op" id="4174988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4174993">_</span><span class="op" id="4174994">,</span>&nbsp;<span class="ident" id="4174996">pattern</span>&nbsp;<span class="op" id="4175004">=</span>&nbsp;<span class="ident" id="4175006">mux</span><span class="op" id="4175009">.</span><span class="ident" id="4175010">handler</span><span class="op" id="4175017">(</span><span class="ident" id="4175018">r</span><span class="op" id="4175019">.</span><span class="ident" id="4175020">Host</span><span class="op" id="4175024">,</span>&nbsp;<span class="ident" id="4175026">p</span><span class="op" id="4175027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175032">url</span>&nbsp;<span class="op" id="4175036">:=</span>&nbsp;<span class="op" id="4175039">*</span><span class="ident" id="4175040">r</span><span class="op" id="4175041">.</span><span class="ident" id="4175042">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175049">url</span><span class="op" id="4175052">.</span><span class="ident" id="4175053">Path</span>&nbsp;<span class="op" id="4175058">=</span>&nbsp;<span class="ident" id="4175060">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175065">return</span>&nbsp;<span class="ident" id="4175072">RedirectHandler</span><span class="op" id="4175087">(</span><span class="ident" id="4175088">url</span><span class="op" id="4175091">.</span><span class="ident" id="4175092">String</span><span class="op" id="4175098">(</span><span class="op" id="4175099">)</span><span class="op" id="4175100">,</span>&nbsp;<span class="ident" id="4175102">StatusMovedPermanently</span><span class="op" id="4175124">)</span><span class="op" id="4175125">,</span>&nbsp;<span class="ident" id="4175127">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175144">return</span>&nbsp;<span class="ident" id="4175151">mux</span><span class="op" id="4175154">.</span><span class="ident" id="4175155">handler</span><span class="op" id="4175162">(</span><span class="ident" id="4175163">r</span><span class="op" id="4175164">.</span><span class="ident" id="4175165">Host</span><span class="op" id="4175169">,</span>&nbsp;<span class="ident" id="4175171">r</span><span class="op" id="4175172">.</span><span class="ident" id="4175173">URL</span><span class="op" id="4175176">.</span><span class="ident" id="4175177">Path</span><span class="op" id="4175181">)</span><br>
<span class="lineno"></span><span class="op" id="4175183">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="4175186">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="4175236">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="4175310">func</span>&nbsp;<span class="op" id="4175315">(</span><span class="ident" id="4175316">mux</span>&nbsp;<span class="op" id="4175320">*</span><span class="ident" id="4175321">ServeMux</span><span class="op" id="4175329">)</span>&nbsp;<span class="ident" id="4175331">handler</span><span class="op" id="4175338">(</span><span class="ident" id="4175339">host</span><span class="op" id="4175343">,</span>&nbsp;<span class="ident" id="4175345">path</span>&nbsp;<span class="builtintype" id="4175350">string</span><span class="op" id="4175356">)</span>&nbsp;<span class="op" id="4175358">(</span><span class="ident" id="4175359">h</span>&nbsp;<span class="ident" id="4175361">Handler</span><span class="op" id="4175368">,</span>&nbsp;<span class="ident" id="4175370">pattern</span>&nbsp;<span class="builtintype" id="4175378">string</span><span class="op" id="4175384">)</span>&nbsp;<span class="op" id="4175386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175389">mux</span><span class="op" id="4175392">.</span><span class="ident" id="4175393">mu</span><span class="op" id="4175395">.</span><span class="ident" id="4175396">RLock</span><span class="op" id="4175401">(</span><span class="op" id="4175402">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175405">defer</span>&nbsp;<span class="ident" id="4175411">mux</span><span class="op" id="4175414">.</span><span class="ident" id="4175415">mu</span><span class="op" id="4175417">.</span><span class="ident" id="4175418">RUnlock</span><span class="op" id="4175425">(</span><span class="op" id="4175426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4175430">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175491">if</span>&nbsp;<span class="ident" id="4175494">mux</span><span class="op" id="4175497">.</span><span class="ident" id="4175498">hosts</span>&nbsp;<span class="op" id="4175504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175508">h</span><span class="op" id="4175509">,</span>&nbsp;<span class="ident" id="4175511">pattern</span>&nbsp;<span class="op" id="4175519">=</span>&nbsp;<span class="ident" id="4175521">mux</span><span class="op" id="4175524">.</span><span class="ident" id="4175525">match</span><span class="op" id="4175530">(</span><span class="ident" id="4175531">host</span>&nbsp;<span class="op" id="4175536">+</span>&nbsp;<span class="ident" id="4175538">path</span><span class="op" id="4175542">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175548">if</span>&nbsp;<span class="ident" id="4175551">h</span>&nbsp;<span class="op" id="4175553">==</span>&nbsp;<span class="builtintype" id="4175556">nil</span>&nbsp;<span class="op" id="4175560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175564">h</span><span class="op" id="4175565">,</span>&nbsp;<span class="ident" id="4175567">pattern</span>&nbsp;<span class="op" id="4175575">=</span>&nbsp;<span class="ident" id="4175577">mux</span><span class="op" id="4175580">.</span><span class="ident" id="4175581">match</span><span class="op" id="4175586">(</span><span class="ident" id="4175587">path</span><span class="op" id="4175591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175597">if</span>&nbsp;<span class="ident" id="4175600">h</span>&nbsp;<span class="op" id="4175602">==</span>&nbsp;<span class="builtintype" id="4175605">nil</span>&nbsp;<span class="op" id="4175609">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175613">h</span><span class="op" id="4175614">,</span>&nbsp;<span class="ident" id="4175616">pattern</span>&nbsp;<span class="op" id="4175624">=</span>&nbsp;<span class="ident" id="4175626">NotFoundHandler</span><span class="op" id="4175641">(</span><span class="op" id="4175642">)</span><span class="op" id="4175643">,</span>&nbsp;<span class="string" id="4175645">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175652">return</span><br>
<span class="lineno"></span><span class="op" id="4175659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="4175662">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="4175719">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4175768">func</span>&nbsp;<span class="op" id="4175773">(</span><span class="ident" id="4175774">mux</span>&nbsp;<span class="op" id="4175778">*</span><span class="ident" id="4175779">ServeMux</span><span class="op" id="4175787">)</span>&nbsp;<span class="ident" id="4175789">ServeHTTP</span><span class="op" id="4175798">(</span><span class="ident" id="4175799">w</span>&nbsp;<span class="ident" id="4175801">ResponseWriter</span><span class="op" id="4175815">,</span>&nbsp;<span class="ident" id="4175817">r</span>&nbsp;<span class="op" id="4175819">*</span><span class="ident" id="4175820">Request</span><span class="op" id="4175827">)</span>&nbsp;<span class="op" id="4175829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175832">if</span>&nbsp;<span class="ident" id="4175835">r</span><span class="op" id="4175836">.</span><span class="ident" id="4175837">RequestURI</span>&nbsp;<span class="op" id="4175848">==</span>&nbsp;<span class="string" id="4175851">&#34;*&#34;</span>&nbsp;<span class="op" id="4175855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175859">if</span>&nbsp;<span class="ident" id="4175862">r</span><span class="op" id="4175863">.</span><span class="ident" id="4175864">ProtoAtLeast</span><span class="op" id="4175876">(</span><span class="num" id="4175877">1</span><span class="op" id="4175878">,</span>&nbsp;<span class="num" id="4175880">1</span><span class="op" id="4175881">)</span>&nbsp;<span class="op" id="4175883">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175888">w</span><span class="op" id="4175889">.</span><span class="ident" id="4175890">Header</span><span class="op" id="4175896">(</span><span class="op" id="4175897">)</span><span class="op" id="4175898">.</span><span class="ident" id="4175899">Set</span><span class="op" id="4175902">(</span><span class="string" id="4175903">&#34;Connection&#34;</span><span class="op" id="4175915">,</span>&nbsp;<span class="string" id="4175917">&#34;close&#34;</span><span class="op" id="4175924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175932">w</span><span class="op" id="4175933">.</span><span class="ident" id="4175934">WriteHeader</span><span class="op" id="4175945">(</span><span class="ident" id="4175946">StatusBadRequest</span><span class="op" id="4175962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4175966">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4175974">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4175977">h</span><span class="op" id="4175978">,</span>&nbsp;<span class="ident" id="4175980">_</span>&nbsp;<span class="op" id="4175982">:=</span>&nbsp;<span class="ident" id="4175985">mux</span><span class="op" id="4175988">.</span><span class="ident" id="4175989">Handler</span><span class="op" id="4175996">(</span><span class="ident" id="4175997">r</span><span class="op" id="4175998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176001">h</span><span class="op" id="4176002">.</span><span class="ident" id="4176003">ServeHTTP</span><span class="op" id="4176012">(</span><span class="ident" id="4176013">w</span><span class="op" id="4176014">,</span>&nbsp;<span class="ident" id="4176016">r</span><span class="op" id="4176017">)</span><br>
<span class="lineno"></span><span class="op" id="4176019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4176022">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="4176077">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="4176136">func</span>&nbsp;<span class="op" id="4176141">(</span><span class="ident" id="4176142">mux</span>&nbsp;<span class="op" id="4176146">*</span><span class="ident" id="4176147">ServeMux</span><span class="op" id="4176155">)</span>&nbsp;<span class="ident" id="4176157">Handle</span><span class="op" id="4176163">(</span><span class="ident" id="4176164">pattern</span>&nbsp;<span class="builtintype" id="4176172">string</span><span class="op" id="4176178">,</span>&nbsp;<span class="ident" id="4176180">handler</span>&nbsp;<span class="ident" id="4176188">Handler</span><span class="op" id="4176195">)</span>&nbsp;<span class="op" id="4176197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176200">mux</span><span class="op" id="4176203">.</span><span class="ident" id="4176204">mu</span><span class="op" id="4176206">.</span><span class="ident" id="4176207">Lock</span><span class="op" id="4176211">(</span><span class="op" id="4176212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176215">defer</span>&nbsp;<span class="ident" id="4176221">mux</span><span class="op" id="4176224">.</span><span class="ident" id="4176225">mu</span><span class="op" id="4176227">.</span><span class="ident" id="4176228">Unlock</span><span class="op" id="4176234">(</span><span class="op" id="4176235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176239">if</span>&nbsp;<span class="ident" id="4176242">pattern</span>&nbsp;<span class="op" id="4176250">==</span>&nbsp;<span class="string" id="4176253">&#34;&#34;</span>&nbsp;<span class="op" id="4176256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4176260">panic</span><span class="op" id="4176265">(</span><span class="string" id="4176266">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="4176291">+</span>&nbsp;<span class="ident" id="4176293">pattern</span><span class="op" id="4176300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176306">if</span>&nbsp;<span class="ident" id="4176309">handler</span>&nbsp;<span class="op" id="4176317">==</span>&nbsp;<span class="builtintype" id="4176320">nil</span>&nbsp;<span class="op" id="4176324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4176328">panic</span><span class="op" id="4176333">(</span><span class="string" id="4176334">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="4176353">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176359">if</span>&nbsp;<span class="ident" id="4176362">mux</span><span class="op" id="4176365">.</span><span class="ident" id="4176366">m</span><span class="op" id="4176367">[</span><span class="ident" id="4176368">pattern</span><span class="op" id="4176375">]</span><span class="op" id="4176376">.</span><span class="ident" id="4176377">explicit</span>&nbsp;<span class="op" id="4176386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4176390">panic</span><span class="op" id="4176395">(</span><span class="string" id="4176396">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4176432">+</span>&nbsp;<span class="ident" id="4176434">pattern</span><span class="op" id="4176441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176448">mux</span><span class="op" id="4176451">.</span><span class="ident" id="4176452">m</span><span class="op" id="4176453">[</span><span class="ident" id="4176454">pattern</span><span class="op" id="4176461">]</span>&nbsp;<span class="op" id="4176463">=</span>&nbsp;<span class="ident" id="4176465">muxEntry</span><span class="op" id="4176473">{</span><span class="ident" id="4176474">explicit</span><span class="op" id="4176482">:</span>&nbsp;<span class="builtintype" id="4176484">true</span><span class="op" id="4176488">,</span>&nbsp;<span class="ident" id="4176490">h</span><span class="op" id="4176491">:</span>&nbsp;<span class="ident" id="4176493">handler</span><span class="op" id="4176500">,</span>&nbsp;<span class="ident" id="4176502">pattern</span><span class="op" id="4176509">:</span>&nbsp;<span class="ident" id="4176511">pattern</span><span class="op" id="4176518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176522">if</span>&nbsp;<span class="ident" id="4176525">pattern</span><span class="op" id="4176532">[</span><span class="num" id="4176533">0</span><span class="op" id="4176534">]</span>&nbsp;<span class="op" id="4176536">!=</span>&nbsp;<span class="string" id="4176539">&#39;/&#39;</span>&nbsp;<span class="op" id="4176543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176547">mux</span><span class="op" id="4176550">.</span><span class="ident" id="4176551">hosts</span>&nbsp;<span class="op" id="4176557">=</span>&nbsp;<span class="builtintype" id="4176559">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4176565">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176569">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176591">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176666">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176720">n</span>&nbsp;<span class="op" id="4176722">:=</span>&nbsp;<span class="builtinfunc" id="4176725">len</span><span class="op" id="4176728">(</span><span class="ident" id="4176729">pattern</span><span class="op" id="4176736">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176739">if</span>&nbsp;<span class="ident" id="4176742">n</span>&nbsp;<span class="op" id="4176744">&gt;</span>&nbsp;<span class="num" id="4176746">0</span>&nbsp;<span class="op" id="4176748">&amp;&amp;</span>&nbsp;<span class="ident" id="4176751">pattern</span><span class="op" id="4176758">[</span><span class="ident" id="4176759">n</span><span class="op" id="4176760">-</span><span class="num" id="4176761">1</span><span class="op" id="4176762">]</span>&nbsp;<span class="op" id="4176764">==</span>&nbsp;<span class="string" id="4176767">&#39;/&#39;</span>&nbsp;<span class="op" id="4176771">&amp;&amp;</span>&nbsp;<span class="op" id="4176774">!</span><span class="ident" id="4176775">mux</span><span class="op" id="4176778">.</span><span class="ident" id="4176779">m</span><span class="op" id="4176780">[</span><span class="ident" id="4176781">pattern</span><span class="op" id="4176788">[</span><span class="num" id="4176789">0</span><span class="op" id="4176790">:</span><span class="ident" id="4176791">n</span><span class="op" id="4176792">-</span><span class="num" id="4176793">1</span><span class="op" id="4176794">]</span><span class="op" id="4176795">]</span><span class="op" id="4176796">.</span><span class="ident" id="4176797">explicit</span>&nbsp;<span class="op" id="4176806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176810">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176875">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4176899">path</span>&nbsp;<span class="op" id="4176904">:=</span>&nbsp;<span class="ident" id="4176907">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4176917">if</span>&nbsp;<span class="ident" id="4176920">pattern</span><span class="op" id="4176927">[</span><span class="num" id="4176928">0</span><span class="op" id="4176929">]</span>&nbsp;<span class="op" id="4176931">!=</span>&nbsp;<span class="string" id="4176934">&#39;/&#39;</span>&nbsp;<span class="op" id="4176938">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4176943">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4177002">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177035">path</span>&nbsp;<span class="op" id="4177040">=</span>&nbsp;<span class="ident" id="4177042">pattern</span><span class="op" id="4177049">[</span><span class="ident" id="4177050">strings</span><span class="op" id="4177057">.</span><span class="ident" id="4177058">Index</span><span class="op" id="4177063">(</span><span class="ident" id="4177064">pattern</span><span class="op" id="4177071">,</span>&nbsp;<span class="string" id="4177073">&#34;/&#34;</span><span class="op" id="4177076">)</span><span class="op" id="4177077">:</span><span class="op" id="4177078">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177086">mux</span><span class="op" id="4177089">.</span><span class="ident" id="4177090">m</span><span class="op" id="4177091">[</span><span class="ident" id="4177092">pattern</span><span class="op" id="4177099">[</span><span class="num" id="4177100">0</span><span class="op" id="4177101">:</span><span class="ident" id="4177102">n</span><span class="op" id="4177103">-</span><span class="num" id="4177104">1</span><span class="op" id="4177105">]</span><span class="op" id="4177106">]</span>&nbsp;<span class="op" id="4177108">=</span>&nbsp;<span class="ident" id="4177110">muxEntry</span><span class="op" id="4177118">{</span><span class="ident" id="4177119">h</span><span class="op" id="4177120">:</span>&nbsp;<span class="ident" id="4177122">RedirectHandler</span><span class="op" id="4177137">(</span><span class="ident" id="4177138">path</span><span class="op" id="4177142">,</span>&nbsp;<span class="ident" id="4177144">StatusMovedPermanently</span><span class="op" id="4177166">)</span><span class="op" id="4177167">,</span>&nbsp;<span class="ident" id="4177169">pattern</span><span class="op" id="4177176">:</span>&nbsp;<span class="ident" id="4177178">pattern</span><span class="op" id="4177185">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4177188">}</span><br>
<span class="lineno"></span><span class="op" id="4177190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4177193">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4177261">func</span>&nbsp;<span class="op" id="4177266">(</span><span class="ident" id="4177267">mux</span>&nbsp;<span class="op" id="4177271">*</span><span class="ident" id="4177272">ServeMux</span><span class="op" id="4177280">)</span>&nbsp;<span class="ident" id="4177282">HandleFunc</span><span class="op" id="4177292">(</span><span class="ident" id="4177293">pattern</span>&nbsp;<span class="builtintype" id="4177301">string</span><span class="op" id="4177307">,</span>&nbsp;<span class="ident" id="4177309">handler</span>&nbsp;<span class="keyword" id="4177317">func</span><span class="op" id="4177321">(</span><span class="ident" id="4177322">ResponseWriter</span><span class="op" id="4177336">,</span>&nbsp;<span class="op" id="4177338">*</span><span class="ident" id="4177339">Request</span><span class="op" id="4177346">)</span><span class="op" id="4177347">)</span>&nbsp;<span class="op" id="4177349">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177352">mux</span><span class="op" id="4177355">.</span><span class="ident" id="4177356">Handle</span><span class="op" id="4177362">(</span><span class="ident" id="4177363">pattern</span><span class="op" id="4177370">,</span>&nbsp;<span class="ident" id="4177372">HandlerFunc</span><span class="op" id="4177383">(</span><span class="ident" id="4177384">handler</span><span class="op" id="4177391">)</span><span class="op" id="4177392">)</span><br>
<span class="lineno"></span><span class="op" id="4177394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4177397">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4177451">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="4177478">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4177547">func</span>&nbsp;<span class="ident" id="4177552">Handle</span><span class="op" id="4177558">(</span><span class="ident" id="4177559">pattern</span>&nbsp;<span class="builtintype" id="4177567">string</span><span class="op" id="4177573">,</span>&nbsp;<span class="ident" id="4177575">handler</span>&nbsp;<span class="ident" id="4177583">Handler</span><span class="op" id="4177590">)</span>&nbsp;<span class="op" id="4177592">{</span>&nbsp;<span class="ident" id="4177594">DefaultServeMux</span><span class="op" id="4177609">.</span><span class="ident" id="4177610">Handle</span><span class="op" id="4177616">(</span><span class="ident" id="4177617">pattern</span><span class="op" id="4177624">,</span>&nbsp;<span class="ident" id="4177626">handler</span><span class="op" id="4177633">)</span>&nbsp;<span class="op" id="4177635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4177638">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4177705">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="4177732">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4177801">func</span>&nbsp;<span class="ident" id="4177806">HandleFunc</span><span class="op" id="4177816">(</span><span class="ident" id="4177817">pattern</span>&nbsp;<span class="builtintype" id="4177825">string</span><span class="op" id="4177831">,</span>&nbsp;<span class="ident" id="4177833">handler</span>&nbsp;<span class="keyword" id="4177841">func</span><span class="op" id="4177845">(</span><span class="ident" id="4177846">ResponseWriter</span><span class="op" id="4177860">,</span>&nbsp;<span class="op" id="4177862">*</span><span class="ident" id="4177863">Request</span><span class="op" id="4177870">)</span><span class="op" id="4177871">)</span>&nbsp;<span class="op" id="4177873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4177876">DefaultServeMux</span><span class="op" id="4177891">.</span><span class="ident" id="4177892">HandleFunc</span><span class="op" id="4177902">(</span><span class="ident" id="4177903">pattern</span><span class="op" id="4177910">,</span>&nbsp;<span class="ident" id="4177912">handler</span><span class="op" id="4177919">)</span><br>
<span class="lineno"></span><span class="op" id="4177921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="4177924">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="4177986">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="4178056">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="4178113">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4178185">func</span>&nbsp;<span class="ident" id="4178190">Serve</span><span class="op" id="4178195">(</span><span class="ident" id="4178196">l</span>&nbsp;<span class="ident" id="4178198">net</span><span class="op" id="4178201">.</span><span class="ident" id="4178202">Listener</span><span class="op" id="4178210">,</span>&nbsp;<span class="ident" id="4178212">handler</span>&nbsp;<span class="ident" id="4178220">Handler</span><span class="op" id="4178227">)</span>&nbsp;<span class="builtintype" id="4178229">error</span>&nbsp;<span class="op" id="4178235">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178238">srv</span>&nbsp;<span class="op" id="4178242">:=</span>&nbsp;<span class="op" id="4178245">&amp;</span><span class="ident" id="4178246">Server</span><span class="op" id="4178252">{</span><span class="ident" id="4178253">Handler</span><span class="op" id="4178260">:</span>&nbsp;<span class="ident" id="4178262">handler</span><span class="op" id="4178269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4178272">return</span>&nbsp;<span class="ident" id="4178279">srv</span><span class="op" id="4178282">.</span><span class="ident" id="4178283">Serve</span><span class="op" id="4178288">(</span><span class="ident" id="4178289">l</span><span class="op" id="4178290">)</span><br>
<span class="lineno"></span><span class="op" id="4178292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4178295">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="4178354">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="4178409">type</span>&nbsp;<span class="ident" id="4178414">Server</span>&nbsp;<span class="keyword" id="4178421">struct</span>&nbsp;<span class="op" id="4178428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178431">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4178446">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178460">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178507">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178522">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178536">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178587">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178602">time</span><span class="op" id="4178606">.</span><span class="ident" id="4178607">Duration</span>&nbsp;<span class="comment" id="4178616">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178675">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4178690">time</span><span class="op" id="4178694">.</span><span class="ident" id="4178695">Duration</span>&nbsp;<span class="comment" id="4178704">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178765">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="4178780">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178794">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4178858">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4178873">*</span><span class="ident" id="4178874">tls</span><span class="op" id="4178877">.</span><span class="ident" id="4178878">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4178887">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4178939">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179001">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179058">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179122">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179182">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179245">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179303">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179355">TLSNextProto</span>&nbsp;<span class="keyword" id="4179368">map</span><span class="op" id="4179371">[</span><span class="builtintype" id="4179372">string</span><span class="op" id="4179378">]</span><span class="keyword" id="4179379">func</span><span class="op" id="4179383">(</span><span class="op" id="4179384">*</span><span class="ident" id="4179385">Server</span><span class="op" id="4179391">,</span>&nbsp;<span class="op" id="4179393">*</span><span class="ident" id="4179394">tls</span><span class="op" id="4179397">.</span><span class="ident" id="4179398">Conn</span><span class="op" id="4179402">,</span>&nbsp;<span class="ident" id="4179404">Handler</span><span class="op" id="4179411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179415">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179477">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179536">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179593">ConnState</span>&nbsp;<span class="keyword" id="4179603">func</span><span class="op" id="4179607">(</span><span class="ident" id="4179608">net</span><span class="op" id="4179611">.</span><span class="ident" id="4179612">Conn</span><span class="op" id="4179616">,</span>&nbsp;<span class="ident" id="4179618">ConnState</span><span class="op" id="4179627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179631">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179694">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179749">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4179809">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179830">ErrorLog</span>&nbsp;<span class="op" id="4179839">*</span><span class="ident" id="4179840">log</span><span class="op" id="4179843">.</span><span class="ident" id="4179844">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4179853">disableKeepAlives</span>&nbsp;<span class="builtintype" id="4179871">int32</span>&nbsp;<span class="comment" id="4179877">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="4179901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179904">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="4179976">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="4180028">type</span>&nbsp;<span class="ident" id="4180033">ConnState</span>&nbsp;<span class="builtintype" id="4180043">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="4180048">const</span>&nbsp;<span class="op" id="4180054">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180057">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180118">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180176">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180231">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180248">StateNew</span>&nbsp;<span class="ident" id="4180257">ConnState</span>&nbsp;<span class="op" id="4180267">=</span>&nbsp;<span class="ident" id="4180269">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180276">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180340">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180394">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180457">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180511">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180564">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180625">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180639">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180695">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180758">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180819">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180861">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180873">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4180925">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4180994">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4181010">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4181058">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4181116">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181147">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="4181159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4181162">var</span>&nbsp;<span class="ident" id="4181166">stateName</span>&nbsp;<span class="op" id="4181176">=</span>&nbsp;<span class="keyword" id="4181178">map</span><span class="op" id="4181181">[</span><span class="ident" id="4181182">ConnState</span><span class="op" id="4181191">]</span><span class="builtintype" id="4181192">string</span><span class="op" id="4181198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181201">StateNew</span><span class="op" id="4181209">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4181216">&#34;new&#34;</span><span class="op" id="4181221">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181224">StateActive</span><span class="op" id="4181235">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4181239">&#34;active&#34;</span><span class="op" id="4181247">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181250">StateIdle</span><span class="op" id="4181259">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4181265">&#34;idle&#34;</span><span class="op" id="4181271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181274">StateHijacked</span><span class="op" id="4181287">:</span>&nbsp;<span class="string" id="4181289">&#34;hijacked&#34;</span><span class="op" id="4181299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181302">StateClosed</span><span class="op" id="4181313">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4181317">&#34;closed&#34;</span><span class="op" id="4181325">,</span><br>
<span class="lineno"></span><span class="op" id="4181327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="4181330">func</span>&nbsp;<span class="op" id="4181335">(</span><span class="ident" id="4181336">c</span>&nbsp;<span class="ident" id="4181338">ConnState</span><span class="op" id="4181347">)</span>&nbsp;<span class="ident" id="4181349">String</span><span class="op" id="4181355">(</span><span class="op" id="4181356">)</span>&nbsp;<span class="builtintype" id="4181358">string</span>&nbsp;<span class="op" id="4181365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181368">return</span>&nbsp;<span class="ident" id="4181375">stateName</span><span class="op" id="4181384">[</span><span class="ident" id="4181385">c</span><span class="op" id="4181386">]</span><br>
<span class="lineno"></span><span class="op" id="4181388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4181391">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="4181452">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4181510">type</span>&nbsp;<span class="ident" id="4181515">serverHandler</span>&nbsp;<span class="keyword" id="4181529">struct</span>&nbsp;<span class="op" id="4181536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181539">srv</span>&nbsp;<span class="op" id="4181543">*</span><span class="ident" id="4181544">Server</span><br>
<span class="lineno"></span><span class="op" id="4181551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="4181554">func</span>&nbsp;<span class="op" id="4181559">(</span><span class="ident" id="4181560">sh</span>&nbsp;<span class="ident" id="4181563">serverHandler</span><span class="op" id="4181576">)</span>&nbsp;<span class="ident" id="4181578">ServeHTTP</span><span class="op" id="4181587">(</span><span class="ident" id="4181588">rw</span>&nbsp;<span class="ident" id="4181591">ResponseWriter</span><span class="op" id="4181605">,</span>&nbsp;<span class="ident" id="4181607">req</span>&nbsp;<span class="op" id="4181611">*</span><span class="ident" id="4181612">Request</span><span class="op" id="4181619">)</span>&nbsp;<span class="op" id="4181621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181624">handler</span>&nbsp;<span class="op" id="4181632">:=</span>&nbsp;<span class="ident" id="4181635">sh</span><span class="op" id="4181637">.</span><span class="ident" id="4181638">srv</span><span class="op" id="4181641">.</span><span class="ident" id="4181642">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181651">if</span>&nbsp;<span class="ident" id="4181654">handler</span>&nbsp;<span class="op" id="4181662">==</span>&nbsp;<span class="builtintype" id="4181665">nil</span>&nbsp;<span class="op" id="4181669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181673">handler</span>&nbsp;<span class="op" id="4181681">=</span>&nbsp;<span class="ident" id="4181683">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181700">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4181703">if</span>&nbsp;<span class="ident" id="4181706">req</span><span class="op" id="4181709">.</span><span class="ident" id="4181710">RequestURI</span>&nbsp;<span class="op" id="4181721">==</span>&nbsp;<span class="string" id="4181724">&#34;*&#34;</span>&nbsp;<span class="op" id="4181728">&amp;&amp;</span>&nbsp;<span class="ident" id="4181731">req</span><span class="op" id="4181734">.</span><span class="ident" id="4181735">Method</span>&nbsp;<span class="op" id="4181742">==</span>&nbsp;<span class="string" id="4181745">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="4181755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181759">handler</span>&nbsp;<span class="op" id="4181767">=</span>&nbsp;<span class="ident" id="4181769">globalOptionsHandler</span><span class="op" id="4181789">{</span><span class="op" id="4181790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4181793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181796">handler</span><span class="op" id="4181803">.</span><span class="ident" id="4181804">ServeHTTP</span><span class="op" id="4181813">(</span><span class="ident" id="4181814">rw</span><span class="op" id="4181816">,</span>&nbsp;<span class="ident" id="4181818">req</span><span class="op" id="4181821">)</span><br>
<span class="lineno"></span><span class="op" id="4181823">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="4181826">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4181897">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4181960">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4181999">func</span>&nbsp;<span class="op" id="4182004">(</span><span class="ident" id="4182005">srv</span>&nbsp;<span class="op" id="4182009">*</span><span class="ident" id="4182010">Server</span><span class="op" id="4182016">)</span>&nbsp;<span class="ident" id="4182018">ListenAndServe</span><span class="op" id="4182032">(</span><span class="op" id="4182033">)</span>&nbsp;<span class="builtintype" id="4182035">error</span>&nbsp;<span class="op" id="4182041">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182044">addr</span>&nbsp;<span class="op" id="4182049">:=</span>&nbsp;<span class="ident" id="4182052">srv</span><span class="op" id="4182055">.</span><span class="ident" id="4182056">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182062">if</span>&nbsp;<span class="ident" id="4182065">addr</span>&nbsp;<span class="op" id="4182070">==</span>&nbsp;<span class="string" id="4182073">&#34;&#34;</span>&nbsp;<span class="op" id="4182076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182080">addr</span>&nbsp;<span class="op" id="4182085">=</span>&nbsp;<span class="string" id="4182087">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182099">ln</span><span class="op" id="4182101">,</span>&nbsp;<span class="ident" id="4182103">err</span>&nbsp;<span class="op" id="4182107">:=</span>&nbsp;<span class="ident" id="4182110">net</span><span class="op" id="4182113">.</span><span class="ident" id="4182114">Listen</span><span class="op" id="4182120">(</span><span class="string" id="4182121">&#34;tcp&#34;</span><span class="op" id="4182126">,</span>&nbsp;<span class="ident" id="4182128">addr</span><span class="op" id="4182132">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182135">if</span>&nbsp;<span class="ident" id="4182138">err</span>&nbsp;<span class="op" id="4182142">!=</span>&nbsp;<span class="builtintype" id="4182145">nil</span>&nbsp;<span class="op" id="4182149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182153">return</span>&nbsp;<span class="ident" id="4182160">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182168">return</span>&nbsp;<span class="ident" id="4182175">srv</span><span class="op" id="4182178">.</span><span class="ident" id="4182179">Serve</span><span class="op" id="4182184">(</span><span class="ident" id="4182185">tcpKeepAliveListener</span><span class="op" id="4182205">{</span><span class="ident" id="4182206">ln</span><span class="op" id="4182208">.</span><span class="op" id="4182209">(</span><span class="op" id="4182210">*</span><span class="ident" id="4182211">net</span><span class="op" id="4182214">.</span><span class="ident" id="4182215">TCPListener</span><span class="op" id="4182226">)</span><span class="op" id="4182227">}</span><span class="op" id="4182228">)</span><br>
<span class="lineno"></span><span class="op" id="4182230">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="4182233">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4182301">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4182378">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4182421">func</span>&nbsp;<span class="op" id="4182426">(</span><span class="ident" id="4182427">srv</span>&nbsp;<span class="op" id="4182431">*</span><span class="ident" id="4182432">Server</span><span class="op" id="4182438">)</span>&nbsp;<span class="ident" id="4182440">Serve</span><span class="op" id="4182445">(</span><span class="ident" id="4182446">l</span>&nbsp;<span class="ident" id="4182448">net</span><span class="op" id="4182451">.</span><span class="ident" id="4182452">Listener</span><span class="op" id="4182460">)</span>&nbsp;<span class="builtintype" id="4182462">error</span>&nbsp;<span class="op" id="4182468">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182471">defer</span>&nbsp;<span class="ident" id="4182477">l</span><span class="op" id="4182478">.</span><span class="ident" id="4182479">Close</span><span class="op" id="4182484">(</span><span class="op" id="4182485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182488">var</span>&nbsp;<span class="ident" id="4182492">tempDelay</span>&nbsp;<span class="ident" id="4182502">time</span><span class="op" id="4182506">.</span><span class="ident" id="4182507">Duration</span>&nbsp;<span class="comment" id="4182516">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182556">for</span>&nbsp;<span class="op" id="4182560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182564">rw</span><span class="op" id="4182566">,</span>&nbsp;<span class="ident" id="4182568">e</span>&nbsp;<span class="op" id="4182570">:=</span>&nbsp;<span class="ident" id="4182573">l</span><span class="op" id="4182574">.</span><span class="ident" id="4182575">Accept</span><span class="op" id="4182581">(</span><span class="op" id="4182582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182586">if</span>&nbsp;<span class="ident" id="4182589">e</span>&nbsp;<span class="op" id="4182591">!=</span>&nbsp;<span class="builtintype" id="4182594">nil</span>&nbsp;<span class="op" id="4182598">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182603">if</span>&nbsp;<span class="ident" id="4182606">ne</span><span class="op" id="4182608">,</span>&nbsp;<span class="ident" id="4182610">ok</span>&nbsp;<span class="op" id="4182613">:=</span>&nbsp;<span class="ident" id="4182616">e</span><span class="op" id="4182617">.</span><span class="op" id="4182618">(</span><span class="ident" id="4182619">net</span><span class="op" id="4182622">.</span><span class="ident" id="4182623">Error</span><span class="op" id="4182628">)</span><span class="op" id="4182629">;</span>&nbsp;<span class="ident" id="4182631">ok</span>&nbsp;<span class="op" id="4182634">&amp;&amp;</span>&nbsp;<span class="ident" id="4182637">ne</span><span class="op" id="4182639">.</span><span class="ident" id="4182640">Temporary</span><span class="op" id="4182649">(</span><span class="op" id="4182650">)</span>&nbsp;<span class="op" id="4182652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182658">if</span>&nbsp;<span class="ident" id="4182661">tempDelay</span>&nbsp;<span class="op" id="4182671">==</span>&nbsp;<span class="num" id="4182674">0</span>&nbsp;<span class="op" id="4182676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182683">tempDelay</span>&nbsp;<span class="op" id="4182693">=</span>&nbsp;<span class="num" id="4182695">5</span>&nbsp;<span class="op" id="4182697">*</span>&nbsp;<span class="ident" id="4182699">time</span><span class="op" id="4182703">.</span><span class="ident" id="4182704">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182720">}</span>&nbsp;<span class="keyword" id="4182722">else</span>&nbsp;<span class="op" id="4182727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182734">tempDelay</span>&nbsp;<span class="op" id="4182744">*=</span>&nbsp;<span class="num" id="4182747">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182759">if</span>&nbsp;<span class="ident" id="4182762">max</span>&nbsp;<span class="op" id="4182766">:=</span>&nbsp;<span class="num" id="4182769">1</span>&nbsp;<span class="op" id="4182771">*</span>&nbsp;<span class="ident" id="4182773">time</span><span class="op" id="4182777">.</span><span class="ident" id="4182778">Second</span><span class="op" id="4182784">;</span>&nbsp;<span class="ident" id="4182786">tempDelay</span>&nbsp;<span class="op" id="4182796">&gt;</span>&nbsp;<span class="ident" id="4182798">max</span>&nbsp;<span class="op" id="4182802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182809">tempDelay</span>&nbsp;<span class="op" id="4182819">=</span>&nbsp;<span class="ident" id="4182821">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182835">srv</span><span class="op" id="4182838">.</span><span class="ident" id="4182839">logf</span><span class="op" id="4182843">(</span><span class="string" id="4182844">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="4182884">,</span>&nbsp;<span class="ident" id="4182886">e</span><span class="op" id="4182887">,</span>&nbsp;<span class="ident" id="4182889">tempDelay</span><span class="op" id="4182898">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182904">time</span><span class="op" id="4182908">.</span><span class="ident" id="4182909">Sleep</span><span class="op" id="4182914">(</span><span class="ident" id="4182915">tempDelay</span><span class="op" id="4182924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182930">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4182947">return</span>&nbsp;<span class="ident" id="4182954">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4182958">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182962">tempDelay</span>&nbsp;<span class="op" id="4182972">=</span>&nbsp;<span class="num" id="4182974">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4182978">c</span><span class="op" id="4182979">,</span>&nbsp;<span class="ident" id="4182981">err</span>&nbsp;<span class="op" id="4182985">:=</span>&nbsp;<span class="ident" id="4182988">srv</span><span class="op" id="4182991">.</span><span class="ident" id="4182992">newConn</span><span class="op" id="4182999">(</span><span class="ident" id="4183000">rw</span><span class="op" id="4183002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183006">if</span>&nbsp;<span class="ident" id="4183009">err</span>&nbsp;<span class="op" id="4183013">!=</span>&nbsp;<span class="builtintype" id="4183016">nil</span>&nbsp;<span class="op" id="4183020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183025">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183036">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183040">c</span><span class="op" id="4183041">.</span><span class="ident" id="4183042">setState</span><span class="op" id="4183050">(</span><span class="ident" id="4183051">c</span><span class="op" id="4183052">.</span><span class="ident" id="4183053">rwc</span><span class="op" id="4183056">,</span>&nbsp;<span class="ident" id="4183058">StateNew</span><span class="op" id="4183066">)</span>&nbsp;<span class="comment" id="4183068">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183097">go</span>&nbsp;<span class="ident" id="4183100">c</span><span class="op" id="4183101">.</span><span class="ident" id="4183102">serve</span><span class="op" id="4183107">(</span><span class="op" id="4183108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183111">}</span><br>
<span class="lineno"></span><span class="op" id="4183113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="4183116">func</span>&nbsp;<span class="op" id="4183121">(</span><span class="ident" id="4183122">s</span>&nbsp;<span class="op" id="4183124">*</span><span class="ident" id="4183125">Server</span><span class="op" id="4183131">)</span>&nbsp;<span class="ident" id="4183133">doKeepAlives</span><span class="op" id="4183145">(</span><span class="op" id="4183146">)</span>&nbsp;<span class="builtintype" id="4183148">bool</span>&nbsp;<span class="op" id="4183153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183156">return</span>&nbsp;<span class="ident" id="4183163">atomic</span><span class="op" id="4183169">.</span><span class="ident" id="4183170">LoadInt32</span><span class="op" id="4183179">(</span><span class="op" id="4183180">&amp;</span><span class="ident" id="4183181">s</span><span class="op" id="4183182">.</span><span class="ident" id="4183183">disableKeepAlives</span><span class="op" id="4183200">)</span>&nbsp;<span class="op" id="4183202">==</span>&nbsp;<span class="num" id="4183205">0</span><br>
<span class="lineno"></span><span class="op" id="4183207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4183210">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="4183281">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="4183338">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4183404">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4183442">func</span>&nbsp;<span class="op" id="4183447">(</span><span class="ident" id="4183448">s</span>&nbsp;<span class="op" id="4183450">*</span><span class="ident" id="4183451">Server</span><span class="op" id="4183457">)</span>&nbsp;<span class="ident" id="4183459">SetKeepAlivesEnabled</span><span class="op" id="4183479">(</span><span class="ident" id="4183480">v</span>&nbsp;<span class="builtintype" id="4183482">bool</span><span class="op" id="4183486">)</span>&nbsp;<span class="op" id="4183488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183491">if</span>&nbsp;<span class="ident" id="4183494">v</span>&nbsp;<span class="op" id="4183496">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183500">atomic</span><span class="op" id="4183506">.</span><span class="ident" id="4183507">StoreInt32</span><span class="op" id="4183517">(</span><span class="op" id="4183518">&amp;</span><span class="ident" id="4183519">s</span><span class="op" id="4183520">.</span><span class="ident" id="4183521">disableKeepAlives</span><span class="op" id="4183538">,</span>&nbsp;<span class="num" id="4183540">0</span><span class="op" id="4183541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183544">}</span>&nbsp;<span class="keyword" id="4183546">else</span>&nbsp;<span class="op" id="4183551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183555">atomic</span><span class="op" id="4183561">.</span><span class="ident" id="4183562">StoreInt32</span><span class="op" id="4183572">(</span><span class="op" id="4183573">&amp;</span><span class="ident" id="4183574">s</span><span class="op" id="4183575">.</span><span class="ident" id="4183576">disableKeepAlives</span><span class="op" id="4183593">,</span>&nbsp;<span class="num" id="4183595">1</span><span class="op" id="4183596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183599">}</span><br>
<span class="lineno"></span><span class="op" id="4183601">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="4183604">func</span>&nbsp;<span class="op" id="4183609">(</span><span class="ident" id="4183610">s</span>&nbsp;<span class="op" id="4183612">*</span><span class="ident" id="4183613">Server</span><span class="op" id="4183619">)</span>&nbsp;<span class="ident" id="4183621">logf</span><span class="op" id="4183625">(</span><span class="ident" id="4183626">format</span>&nbsp;<span class="builtintype" id="4183633">string</span><span class="op" id="4183639">,</span>&nbsp;<span class="ident" id="4183641">args</span>&nbsp;<span class="op" id="4183646">...</span><span class="keyword" id="4183649">interface</span><span class="op" id="4183658">{</span><span class="op" id="4183659">}</span><span class="op" id="4183660">)</span>&nbsp;<span class="op" id="4183662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4183665">if</span>&nbsp;<span class="ident" id="4183668">s</span><span class="op" id="4183669">.</span><span class="ident" id="4183670">ErrorLog</span>&nbsp;<span class="op" id="4183679">!=</span>&nbsp;<span class="builtintype" id="4183682">nil</span>&nbsp;<span class="op" id="4183686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183690">s</span><span class="op" id="4183691">.</span><span class="ident" id="4183692">ErrorLog</span><span class="op" id="4183700">.</span><span class="ident" id="4183701">Printf</span><span class="op" id="4183707">(</span><span class="ident" id="4183708">format</span><span class="op" id="4183714">,</span>&nbsp;<span class="ident" id="4183716">args</span><span class="op" id="4183720">...</span><span class="op" id="4183723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183726">}</span>&nbsp;<span class="keyword" id="4183728">else</span>&nbsp;<span class="op" id="4183733">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183737">log</span><span class="op" id="4183740">.</span><span class="ident" id="4183741">Printf</span><span class="op" id="4183747">(</span><span class="ident" id="4183748">format</span><span class="op" id="4183754">,</span>&nbsp;<span class="ident" id="4183756">args</span><span class="op" id="4183760">...</span><span class="op" id="4183763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183766">}</span><br>
<span class="lineno"></span><span class="op" id="4183768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4183771">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="4183829">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4183885">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="4183940">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="4183986">//</span><br>
<span class="lineno"></span><span class="comment" id="4183989">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="4184021">//</span><br>
<span class="lineno"></span><span class="comment" id="4184024">//&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="4184040">//</span><br>
<span class="lineno"></span><span class="comment" id="4184043">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="4184055">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="4184064">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4184079">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4184089">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="4184094">//</span><br>
<span class="lineno"></span><span class="comment" id="4184097">//&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="4184131">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4184195">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4184236">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4184241">//</span><br>
<span class="lineno"></span><span class="comment" id="4184244">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="4184261">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="4184304">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4184350">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4184370">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="4184410">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">1805</span><span class="comment" id="4184416">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="keyword" id="4184421">func</span>&nbsp;<span class="ident" id="4184426">ListenAndServe</span><span class="op" id="4184440">(</span><span class="ident" id="4184441">addr</span>&nbsp;<span class="builtintype" id="4184446">string</span><span class="op" id="4184452">,</span>&nbsp;<span class="ident" id="4184454">handler</span>&nbsp;<span class="ident" id="4184462">Handler</span><span class="op" id="4184469">)</span>&nbsp;<span class="builtintype" id="4184471">error</span>&nbsp;<span class="op" id="4184477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4184480">server</span>&nbsp;<span class="op" id="4184487">:=</span>&nbsp;<span class="op" id="4184490">&amp;</span><span class="ident" id="4184491">Server</span><span class="op" id="4184497">{</span><span class="ident" id="4184498">Addr</span><span class="op" id="4184502">:</span>&nbsp;<span class="ident" id="4184504">addr</span><span class="op" id="4184508">,</span>&nbsp;<span class="ident" id="4184510">Handler</span><span class="op" id="4184517">:</span>&nbsp;<span class="ident" id="4184519">handler</span><span class="op" id="4184526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4184529">return</span>&nbsp;<span class="ident" id="4184536">server</span><span class="op" id="4184542">.</span><span class="ident" id="4184543">ListenAndServe</span><span class="op" id="4184557">(</span><span class="op" id="4184558">)</span><br>
<span class="lineno"></span><span class="op" id="4184560">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="4184563">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4184635">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4184714">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="4184790">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="4184872">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4184937">//</span><br>
<span class="lineno"></span><span class="comment" id="4184940">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="4184972">//</span><br>
<span class="lineno"></span><span class="comment" id="4184975">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="4184987">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4184997">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4185012">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="4185017">//</span><br>
<span class="lineno"></span><span class="comment" id="4185020">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="4185080">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4185129">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="4185181">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4185186">//</span><br>
<span class="lineno"></span><span class="comment" id="4185189">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="4185206">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="4185240">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4185315">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4185387">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4185407">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="4185427">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4185433">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4185438">//</span><br>
<span class="lineno"></span><span class="comment" id="4185441">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="4185521">func</span>&nbsp;<span class="ident" id="4185526">ListenAndServeTLS</span><span class="op" id="4185543">(</span><span class="ident" id="4185544">addr</span>&nbsp;<span class="builtintype" id="4185549">string</span><span class="op" id="4185555">,</span>&nbsp;<span class="ident" id="4185557">certFile</span>&nbsp;<span class="builtintype" id="4185566">string</span><span class="op" id="4185572">,</span>&nbsp;<span class="ident" id="4185574">keyFile</span>&nbsp;<span class="builtintype" id="4185582">string</span><span class="op" id="4185588">,</span>&nbsp;<span class="ident" id="4185590">handler</span>&nbsp;<span class="ident" id="4185598">Handler</span><span class="op" id="4185605">)</span>&nbsp;<span class="builtintype" id="4185607">error</span>&nbsp;<span class="op" id="4185613">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4185616">server</span>&nbsp;<span class="op" id="4185623">:=</span>&nbsp;<span class="op" id="4185626">&amp;</span><span class="ident" id="4185627">Server</span><span class="op" id="4185633">{</span><span class="ident" id="4185634">Addr</span><span class="op" id="4185638">:</span>&nbsp;<span class="ident" id="4185640">addr</span><span class="op" id="4185644">,</span>&nbsp;<span class="ident" id="4185646">Handler</span><span class="op" id="4185653">:</span>&nbsp;<span class="ident" id="4185655">handler</span><span class="op" id="4185662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4185665">return</span>&nbsp;<span class="ident" id="4185672">server</span><span class="op" id="4185678">.</span><span class="ident" id="4185679">ListenAndServeTLS</span><span class="op" id="4185696">(</span><span class="ident" id="4185697">certFile</span><span class="op" id="4185705">,</span>&nbsp;<span class="ident" id="4185707">keyFile</span><span class="op" id="4185714">)</span><br>
<span class="lineno"></span><span class="op" id="4185716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4185719">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="4185788">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="4185856">//</span><br>
<span class="lineno"></span><span class="comment" id="4185859">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4185926">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4185992">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="4186059">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4186124">//</span><br>
<span class="lineno"></span><span class="comment" id="4186127">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4186170">func</span>&nbsp;<span class="op" id="4186175">(</span><span class="ident" id="4186176">srv</span>&nbsp;<span class="op" id="4186180">*</span><span class="ident" id="4186181">Server</span><span class="op" id="4186187">)</span>&nbsp;<span class="ident" id="4186189">ListenAndServeTLS</span><span class="op" id="4186206">(</span><span class="ident" id="4186207">certFile</span><span class="op" id="4186215">,</span>&nbsp;<span class="ident" id="4186217">keyFile</span>&nbsp;<span class="builtintype" id="4186225">string</span><span class="op" id="4186231">)</span>&nbsp;<span class="builtintype" id="4186233">error</span>&nbsp;<span class="op" id="4186239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186242">addr</span>&nbsp;<span class="op" id="4186247">:=</span>&nbsp;<span class="ident" id="4186250">srv</span><span class="op" id="4186253">.</span><span class="ident" id="4186254">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186260">if</span>&nbsp;<span class="ident" id="4186263">addr</span>&nbsp;<span class="op" id="4186268">==</span>&nbsp;<span class="string" id="4186271">&#34;&#34;</span>&nbsp;<span class="op" id="4186274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186278">addr</span>&nbsp;<span class="op" id="4186283">=</span>&nbsp;<span class="string" id="4186285">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186298">config</span>&nbsp;<span class="op" id="4186305">:=</span>&nbsp;<span class="op" id="4186308">&amp;</span><span class="ident" id="4186309">tls</span><span class="op" id="4186312">.</span><span class="ident" id="4186313">Config</span><span class="op" id="4186319">{</span><span class="op" id="4186320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186323">if</span>&nbsp;<span class="ident" id="4186326">srv</span><span class="op" id="4186329">.</span><span class="ident" id="4186330">TLSConfig</span>&nbsp;<span class="op" id="4186340">!=</span>&nbsp;<span class="builtintype" id="4186343">nil</span>&nbsp;<span class="op" id="4186347">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186351">*</span><span class="ident" id="4186352">config</span>&nbsp;<span class="op" id="4186359">=</span>&nbsp;<span class="op" id="4186361">*</span><span class="ident" id="4186362">srv</span><span class="op" id="4186365">.</span><span class="ident" id="4186366">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186380">if</span>&nbsp;<span class="ident" id="4186383">config</span><span class="op" id="4186389">.</span><span class="ident" id="4186390">NextProtos</span>&nbsp;<span class="op" id="4186401">==</span>&nbsp;<span class="builtintype" id="4186404">nil</span>&nbsp;<span class="op" id="4186408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186412">config</span><span class="op" id="4186418">.</span><span class="ident" id="4186419">NextProtos</span>&nbsp;<span class="op" id="4186430">=</span>&nbsp;<span class="op" id="4186432">[</span><span class="op" id="4186433">]</span><span class="builtintype" id="4186434">string</span><span class="op" id="4186440">{</span><span class="string" id="4186441">&#34;http/1.1&#34;</span><span class="op" id="4186451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186454">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186458">var</span>&nbsp;<span class="ident" id="4186462">err</span>&nbsp;<span class="builtintype" id="4186466">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186473">config</span><span class="op" id="4186479">.</span><span class="ident" id="4186480">Certificates</span>&nbsp;<span class="op" id="4186493">=</span>&nbsp;<span class="builtinfunc" id="4186495">make</span><span class="op" id="4186499">(</span><span class="op" id="4186500">[</span><span class="op" id="4186501">]</span><span class="ident" id="4186502">tls</span><span class="op" id="4186505">.</span><span class="ident" id="4186506">Certificate</span><span class="op" id="4186517">,</span>&nbsp;<span class="num" id="4186519">1</span><span class="op" id="4186520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186523">config</span><span class="op" id="4186529">.</span><span class="ident" id="4186530">Certificates</span><span class="op" id="4186542">[</span><span class="num" id="4186543">0</span><span class="op" id="4186544">]</span><span class="op" id="4186545">,</span>&nbsp;<span class="ident" id="4186547">err</span>&nbsp;<span class="op" id="4186551">=</span>&nbsp;<span class="ident" id="4186553">tls</span><span class="op" id="4186556">.</span><span class="ident" id="4186557">LoadX509KeyPair</span><span class="op" id="4186572">(</span><span class="ident" id="4186573">certFile</span><span class="op" id="4186581">,</span>&nbsp;<span class="ident" id="4186583">keyFile</span><span class="op" id="4186590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186593">if</span>&nbsp;<span class="ident" id="4186596">err</span>&nbsp;<span class="op" id="4186600">!=</span>&nbsp;<span class="builtintype" id="4186603">nil</span>&nbsp;<span class="op" id="4186607">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186611">return</span>&nbsp;<span class="ident" id="4186618">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186627">ln</span><span class="op" id="4186629">,</span>&nbsp;<span class="ident" id="4186631">err</span>&nbsp;<span class="op" id="4186635">:=</span>&nbsp;<span class="ident" id="4186638">net</span><span class="op" id="4186641">.</span><span class="ident" id="4186642">Listen</span><span class="op" id="4186648">(</span><span class="string" id="4186649">&#34;tcp&#34;</span><span class="op" id="4186654">,</span>&nbsp;<span class="ident" id="4186656">addr</span><span class="op" id="4186660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186663">if</span>&nbsp;<span class="ident" id="4186666">err</span>&nbsp;<span class="op" id="4186670">!=</span>&nbsp;<span class="builtintype" id="4186673">nil</span>&nbsp;<span class="op" id="4186677">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186681">return</span>&nbsp;<span class="ident" id="4186688">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4186693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4186697">tlsListener</span>&nbsp;<span class="op" id="4186709">:=</span>&nbsp;<span class="ident" id="4186712">tls</span><span class="op" id="4186715">.</span><span class="ident" id="4186716">NewListener</span><span class="op" id="4186727">(</span><span class="ident" id="4186728">tcpKeepAliveListener</span><span class="op" id="4186748">{</span><span class="ident" id="4186749">ln</span><span class="op" id="4186751">.</span><span class="op" id="4186752">(</span><span class="op" id="4186753">*</span><span class="ident" id="4186754">net</span><span class="op" id="4186757">.</span><span class="ident" id="4186758">TCPListener</span><span class="op" id="4186769">)</span><span class="op" id="4186770">}</span><span class="op" id="4186771">,</span>&nbsp;<span class="ident" id="4186773">config</span><span class="op" id="4186779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4186782">return</span>&nbsp;<span class="ident" id="4186789">srv</span><span class="op" id="4186792">.</span><span class="ident" id="4186793">Serve</span><span class="op" id="4186798">(</span><span class="ident" id="4186799">tlsListener</span><span class="op" id="4186810">)</span><br>
<span class="lineno">1880</span><span class="op" id="4186812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4186815">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="4186890">//</span><br>
<span class="lineno"></span><span class="comment" id="4186893">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="4186963">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4187034">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="4187104">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="4187167">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="4187238">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="4187260">func</span>&nbsp;<span class="ident" id="4187265">TimeoutHandler</span><span class="op" id="4187279">(</span><span class="ident" id="4187280">h</span>&nbsp;<span class="ident" id="4187282">Handler</span><span class="op" id="4187289">,</span>&nbsp;<span class="ident" id="4187291">dt</span>&nbsp;<span class="ident" id="4187294">time</span><span class="op" id="4187298">.</span><span class="ident" id="4187299">Duration</span><span class="op" id="4187307">,</span>&nbsp;<span class="ident" id="4187309">msg</span>&nbsp;<span class="builtintype" id="4187313">string</span><span class="op" id="4187319">)</span>&nbsp;<span class="ident" id="4187321">Handler</span>&nbsp;<span class="op" id="4187329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187332">f</span>&nbsp;<span class="op" id="4187334">:=</span>&nbsp;<span class="keyword" id="4187337">func</span><span class="op" id="4187341">(</span><span class="op" id="4187342">)</span>&nbsp;<span class="op" id="4187344">&lt;-</span><span class="keyword" id="4187346">chan</span>&nbsp;<span class="ident" id="4187351">time</span><span class="op" id="4187355">.</span><span class="ident" id="4187356">Time</span>&nbsp;<span class="op" id="4187361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187365">return</span>&nbsp;<span class="ident" id="4187372">time</span><span class="op" id="4187376">.</span><span class="ident" id="4187377">After</span><span class="op" id="4187382">(</span><span class="ident" id="4187383">dt</span><span class="op" id="4187385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187391">return</span>&nbsp;<span class="op" id="4187398">&amp;</span><span class="ident" id="4187399">timeoutHandler</span><span class="op" id="4187413">{</span><span class="ident" id="4187414">h</span><span class="op" id="4187415">,</span>&nbsp;<span class="ident" id="4187417">f</span><span class="op" id="4187418">,</span>&nbsp;<span class="ident" id="4187420">msg</span><span class="op" id="4187423">}</span><br>
<span class="lineno">1895</span><span class="op" id="4187425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4187428">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="4187491">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4187528">var</span>&nbsp;<span class="ident" id="4187532">ErrHandlerTimeout</span>&nbsp;<span class="op" id="4187550">=</span>&nbsp;<span class="ident" id="4187552">errors</span><span class="op" id="4187558">.</span><span class="ident" id="4187559">New</span><span class="op" id="4187562">(</span><span class="string" id="4187563">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="4187586">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="4187589">type</span>&nbsp;<span class="ident" id="4187594">timeoutHandler</span>&nbsp;<span class="keyword" id="4187609">struct</span>&nbsp;<span class="op" id="4187616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187619">handler</span>&nbsp;<span class="ident" id="4187627">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187636">timeout</span>&nbsp;<span class="keyword" id="4187644">func</span><span class="op" id="4187648">(</span><span class="op" id="4187649">)</span>&nbsp;<span class="op" id="4187651">&lt;-</span><span class="keyword" id="4187653">chan</span>&nbsp;<span class="ident" id="4187658">time</span><span class="op" id="4187662">.</span><span class="ident" id="4187663">Time</span>&nbsp;<span class="comment" id="4187668">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187708">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4187716">string</span><br>
<span class="lineno">1905</span><span class="op" id="4187723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4187726">func</span>&nbsp;<span class="op" id="4187731">(</span><span class="ident" id="4187732">h</span>&nbsp;<span class="op" id="4187734">*</span><span class="ident" id="4187735">timeoutHandler</span><span class="op" id="4187749">)</span>&nbsp;<span class="ident" id="4187751">errorBody</span><span class="op" id="4187760">(</span><span class="op" id="4187761">)</span>&nbsp;<span class="builtintype" id="4187763">string</span>&nbsp;<span class="op" id="4187770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187773">if</span>&nbsp;<span class="ident" id="4187776">h</span><span class="op" id="4187777">.</span><span class="ident" id="4187778">body</span>&nbsp;<span class="op" id="4187783">!=</span>&nbsp;<span class="string" id="4187786">&#34;&#34;</span>&nbsp;<span class="op" id="4187789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187793">return</span>&nbsp;<span class="ident" id="4187800">h</span><span class="op" id="4187801">.</span><span class="ident" id="4187802">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4187808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4187811">return</span>&nbsp;<span class="string" id="4187818">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4187898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4187901">func</span>&nbsp;<span class="op" id="4187906">(</span><span class="ident" id="4187907">h</span>&nbsp;<span class="op" id="4187909">*</span><span class="ident" id="4187910">timeoutHandler</span><span class="op" id="4187924">)</span>&nbsp;<span class="ident" id="4187926">ServeHTTP</span><span class="op" id="4187935">(</span><span class="ident" id="4187936">w</span>&nbsp;<span class="ident" id="4187938">ResponseWriter</span><span class="op" id="4187952">,</span>&nbsp;<span class="ident" id="4187954">r</span>&nbsp;<span class="op" id="4187956">*</span><span class="ident" id="4187957">Request</span><span class="op" id="4187964">)</span>&nbsp;<span class="op" id="4187966">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187969">done</span>&nbsp;<span class="op" id="4187974">:=</span>&nbsp;<span class="builtinfunc" id="4187977">make</span><span class="op" id="4187981">(</span><span class="keyword" id="4187982">chan</span>&nbsp;<span class="builtintype" id="4187987">bool</span><span class="op" id="4187991">,</span>&nbsp;<span class="num" id="4187993">1</span><span class="op" id="4187994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4187997">tw</span>&nbsp;<span class="op" id="4188000">:=</span>&nbsp;<span class="op" id="4188003">&amp;</span><span class="ident" id="4188004">timeoutWriter</span><span class="op" id="4188017">{</span><span class="ident" id="4188018">w</span><span class="op" id="4188019">:</span>&nbsp;<span class="ident" id="4188021">w</span><span class="op" id="4188022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188025">go</span>&nbsp;<span class="keyword" id="4188028">func</span><span class="op" id="4188032">(</span><span class="op" id="4188033">)</span>&nbsp;<span class="op" id="4188035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188039">h</span><span class="op" id="4188040">.</span><span class="ident" id="4188041">handler</span><span class="op" id="4188048">.</span><span class="ident" id="4188049">ServeHTTP</span><span class="op" id="4188058">(</span><span class="ident" id="4188059">tw</span><span class="op" id="4188061">,</span>&nbsp;<span class="ident" id="4188063">r</span><span class="op" id="4188064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188068">done</span>&nbsp;<span class="op" id="4188073">&lt;-</span>&nbsp;<span class="builtintype" id="4188076">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188082">}</span><span class="op" id="4188083">(</span><span class="op" id="4188084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188087">select</span>&nbsp;<span class="op" id="4188094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188097">case</span>&nbsp;<span class="op" id="4188102">&lt;-</span><span class="ident" id="4188104">done</span><span class="op" id="4188108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188112">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188120">case</span>&nbsp;<span class="op" id="4188125">&lt;-</span><span class="ident" id="4188127">h</span><span class="op" id="4188128">.</span><span class="ident" id="4188129">timeout</span><span class="op" id="4188136">(</span><span class="op" id="4188137">)</span><span class="op" id="4188138">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188142">tw</span><span class="op" id="4188144">.</span><span class="ident" id="4188145">mu</span><span class="op" id="4188147">.</span><span class="ident" id="4188148">Lock</span><span class="op" id="4188152">(</span><span class="op" id="4188153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188157">defer</span>&nbsp;<span class="ident" id="4188163">tw</span><span class="op" id="4188165">.</span><span class="ident" id="4188166">mu</span><span class="op" id="4188168">.</span><span class="ident" id="4188169">Unlock</span><span class="op" id="4188175">(</span><span class="op" id="4188176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188180">if</span>&nbsp;<span class="op" id="4188183">!</span><span class="ident" id="4188184">tw</span><span class="op" id="4188186">.</span><span class="ident" id="4188187">wroteHeader</span>&nbsp;<span class="op" id="4188199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188204">tw</span><span class="op" id="4188206">.</span><span class="ident" id="4188207">w</span><span class="op" id="4188208">.</span><span class="ident" id="4188209">WriteHeader</span><span class="op" id="4188220">(</span><span class="ident" id="4188221">StatusServiceUnavailable</span><span class="op" id="4188245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188250">tw</span><span class="op" id="4188252">.</span><span class="ident" id="4188253">w</span><span class="op" id="4188254">.</span><span class="ident" id="4188255">Write</span><span class="op" id="4188260">(</span><span class="op" id="4188261">[</span><span class="op" id="4188262">]</span><span class="builtintype" id="4188263">byte</span><span class="op" id="4188267">(</span><span class="ident" id="4188268">h</span><span class="op" id="4188269">.</span><span class="ident" id="4188270">errorBody</span><span class="op" id="4188279">(</span><span class="op" id="4188280">)</span><span class="op" id="4188281">)</span><span class="op" id="4188282">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188290">tw</span><span class="op" id="4188292">.</span><span class="ident" id="4188293">timedOut</span>&nbsp;<span class="op" id="4188302">=</span>&nbsp;<span class="builtintype" id="4188304">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188310">}</span><br>
<span class="lineno"></span><span class="op" id="4188312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="4188315">type</span>&nbsp;<span class="ident" id="4188320">timeoutWriter</span>&nbsp;<span class="keyword" id="4188334">struct</span>&nbsp;<span class="op" id="4188341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188344">w</span>&nbsp;<span class="ident" id="4188346">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188363">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188375">sync</span><span class="op" id="4188379">.</span><span class="ident" id="4188380">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188387">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4188399">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188405">wroteHeader</span>&nbsp;<span class="builtintype" id="4188417">bool</span><br>
<span class="lineno"></span><span class="op" id="4188422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4188425">func</span>&nbsp;<span class="op" id="4188430">(</span><span class="ident" id="4188431">tw</span>&nbsp;<span class="op" id="4188434">*</span><span class="ident" id="4188435">timeoutWriter</span><span class="op" id="4188448">)</span>&nbsp;<span class="ident" id="4188450">Header</span><span class="op" id="4188456">(</span><span class="op" id="4188457">)</span>&nbsp;<span class="ident" id="4188459">Header</span>&nbsp;<span class="op" id="4188466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188469">return</span>&nbsp;<span class="ident" id="4188476">tw</span><span class="op" id="4188478">.</span><span class="ident" id="4188479">w</span><span class="op" id="4188480">.</span><span class="ident" id="4188481">Header</span><span class="op" id="4188487">(</span><span class="op" id="4188488">)</span><br>
<span class="lineno">1945</span><span class="op" id="4188490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4188493">func</span>&nbsp;<span class="op" id="4188498">(</span><span class="ident" id="4188499">tw</span>&nbsp;<span class="op" id="4188502">*</span><span class="ident" id="4188503">timeoutWriter</span><span class="op" id="4188516">)</span>&nbsp;<span class="ident" id="4188518">Write</span><span class="op" id="4188523">(</span><span class="ident" id="4188524">p</span>&nbsp;<span class="op" id="4188526">[</span><span class="op" id="4188527">]</span><span class="builtintype" id="4188528">byte</span><span class="op" id="4188532">)</span>&nbsp;<span class="op" id="4188534">(</span><span class="builtintype" id="4188535">int</span><span class="op" id="4188538">,</span>&nbsp;<span class="builtintype" id="4188540">error</span><span class="op" id="4188545">)</span>&nbsp;<span class="op" id="4188547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188550">tw</span><span class="op" id="4188552">.</span><span class="ident" id="4188553">mu</span><span class="op" id="4188555">.</span><span class="ident" id="4188556">Lock</span><span class="op" id="4188560">(</span><span class="op" id="4188561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188564">defer</span>&nbsp;<span class="ident" id="4188570">tw</span><span class="op" id="4188572">.</span><span class="ident" id="4188573">mu</span><span class="op" id="4188575">.</span><span class="ident" id="4188576">Unlock</span><span class="op" id="4188582">(</span><span class="op" id="4188583">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188586">tw</span><span class="op" id="4188588">.</span><span class="ident" id="4188589">wroteHeader</span>&nbsp;<span class="op" id="4188601">=</span>&nbsp;<span class="builtintype" id="4188603">true</span>&nbsp;<span class="comment" id="4188608">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188632">if</span>&nbsp;<span class="ident" id="4188635">tw</span><span class="op" id="4188637">.</span><span class="ident" id="4188638">timedOut</span>&nbsp;<span class="op" id="4188647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188651">return</span>&nbsp;<span class="num" id="4188658">0</span><span class="op" id="4188659">,</span>&nbsp;<span class="ident" id="4188661">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188683">return</span>&nbsp;<span class="ident" id="4188690">tw</span><span class="op" id="4188692">.</span><span class="ident" id="4188693">w</span><span class="op" id="4188694">.</span><span class="ident" id="4188695">Write</span><span class="op" id="4188700">(</span><span class="ident" id="4188701">p</span><span class="op" id="4188702">)</span><br>
<span class="lineno">1955</span><span class="op" id="4188704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4188707">func</span>&nbsp;<span class="op" id="4188712">(</span><span class="ident" id="4188713">tw</span>&nbsp;<span class="op" id="4188716">*</span><span class="ident" id="4188717">timeoutWriter</span><span class="op" id="4188730">)</span>&nbsp;<span class="ident" id="4188732">WriteHeader</span><span class="op" id="4188743">(</span><span class="ident" id="4188744">code</span>&nbsp;<span class="builtintype" id="4188749">int</span><span class="op" id="4188752">)</span>&nbsp;<span class="op" id="4188754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188757">tw</span><span class="op" id="4188759">.</span><span class="ident" id="4188760">mu</span><span class="op" id="4188762">.</span><span class="ident" id="4188763">Lock</span><span class="op" id="4188767">(</span><span class="op" id="4188768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188771">defer</span>&nbsp;<span class="ident" id="4188777">tw</span><span class="op" id="4188779">.</span><span class="ident" id="4188780">mu</span><span class="op" id="4188782">.</span><span class="ident" id="4188783">Unlock</span><span class="op" id="4188789">(</span><span class="op" id="4188790">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188793">if</span>&nbsp;<span class="ident" id="4188796">tw</span><span class="op" id="4188798">.</span><span class="ident" id="4188799">timedOut</span>&nbsp;<span class="op" id="4188808">||</span>&nbsp;<span class="ident" id="4188811">tw</span><span class="op" id="4188813">.</span><span class="ident" id="4188814">wroteHeader</span>&nbsp;<span class="op" id="4188826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4188830">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4188838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188841">tw</span><span class="op" id="4188843">.</span><span class="ident" id="4188844">wroteHeader</span>&nbsp;<span class="op" id="4188856">=</span>&nbsp;<span class="builtintype" id="4188858">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4188864">tw</span><span class="op" id="4188866">.</span><span class="ident" id="4188867">w</span><span class="op" id="4188868">.</span><span class="ident" id="4188869">WriteHeader</span><span class="op" id="4188880">(</span><span class="ident" id="4188881">code</span><span class="op" id="4188885">)</span><br>
<span class="lineno">1965</span><span class="op" id="4188887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4188890">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="4188955">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="4189024">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="4189094">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="4189106">type</span>&nbsp;<span class="ident" id="4189111">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="4189132">struct</span>&nbsp;<span class="op" id="4189139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189142">*</span><span class="ident" id="4189143">net</span><span class="op" id="4189146">.</span><span class="ident" id="4189147">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="4189159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="4189162">func</span>&nbsp;<span class="op" id="4189167">(</span><span class="ident" id="4189168">ln</span>&nbsp;<span class="ident" id="4189171">tcpKeepAliveListener</span><span class="op" id="4189191">)</span>&nbsp;<span class="ident" id="4189193">Accept</span><span class="op" id="4189199">(</span><span class="op" id="4189200">)</span>&nbsp;<span class="op" id="4189202">(</span><span class="ident" id="4189203">c</span>&nbsp;<span class="ident" id="4189205">net</span><span class="op" id="4189208">.</span><span class="ident" id="4189209">Conn</span><span class="op" id="4189213">,</span>&nbsp;<span class="ident" id="4189215">err</span>&nbsp;<span class="builtintype" id="4189219">error</span><span class="op" id="4189224">)</span>&nbsp;<span class="op" id="4189226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189229">tc</span><span class="op" id="4189231">,</span>&nbsp;<span class="ident" id="4189233">err</span>&nbsp;<span class="op" id="4189237">:=</span>&nbsp;<span class="ident" id="4189240">ln</span><span class="op" id="4189242">.</span><span class="ident" id="4189243">AcceptTCP</span><span class="op" id="4189252">(</span><span class="op" id="4189253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189256">if</span>&nbsp;<span class="ident" id="4189259">err</span>&nbsp;<span class="op" id="4189263">!=</span>&nbsp;<span class="builtintype" id="4189266">nil</span>&nbsp;<span class="op" id="4189270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189274">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189282">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189285">tc</span><span class="op" id="4189287">.</span><span class="ident" id="4189288">SetKeepAlive</span><span class="op" id="4189300">(</span><span class="builtintype" id="4189301">true</span><span class="op" id="4189305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189308">tc</span><span class="op" id="4189310">.</span><span class="ident" id="4189311">SetKeepAlivePeriod</span><span class="op" id="4189329">(</span><span class="num" id="4189330">3</span>&nbsp;<span class="op" id="4189332">*</span>&nbsp;<span class="ident" id="4189334">time</span><span class="op" id="4189338">.</span><span class="ident" id="4189339">Minute</span><span class="op" id="4189345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189348">return</span>&nbsp;<span class="ident" id="4189355">tc</span><span class="op" id="4189357">,</span>&nbsp;<span class="builtintype" id="4189359">nil</span><br>
<span class="lineno"></span><span class="op" id="4189363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="4189366">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4189424">type</span>&nbsp;<span class="ident" id="4189429">globalOptionsHandler</span>&nbsp;<span class="keyword" id="4189450">struct</span><span class="op" id="4189456">{</span><span class="op" id="4189457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4189460">func</span>&nbsp;<span class="op" id="4189465">(</span><span class="ident" id="4189466">globalOptionsHandler</span><span class="op" id="4189486">)</span>&nbsp;<span class="ident" id="4189488">ServeHTTP</span><span class="op" id="4189497">(</span><span class="ident" id="4189498">w</span>&nbsp;<span class="ident" id="4189500">ResponseWriter</span><span class="op" id="4189514">,</span>&nbsp;<span class="ident" id="4189516">r</span>&nbsp;<span class="op" id="4189518">*</span><span class="ident" id="4189519">Request</span><span class="op" id="4189526">)</span>&nbsp;<span class="op" id="4189528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189531">w</span><span class="op" id="4189532">.</span><span class="ident" id="4189533">Header</span><span class="op" id="4189539">(</span><span class="op" id="4189540">)</span><span class="op" id="4189541">.</span><span class="ident" id="4189542">Set</span><span class="op" id="4189545">(</span><span class="string" id="4189546">&#34;Content-Length&#34;</span><span class="op" id="4189562">,</span>&nbsp;<span class="string" id="4189564">&#34;0&#34;</span><span class="op" id="4189567">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4189570">if</span>&nbsp;<span class="ident" id="4189573">r</span><span class="op" id="4189574">.</span><span class="ident" id="4189575">ContentLength</span>&nbsp;<span class="op" id="4189589">!=</span>&nbsp;<span class="num" id="4189592">0</span>&nbsp;<span class="op" id="4189594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189598">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189655">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189713">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189770">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4189829">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189877">mb</span>&nbsp;<span class="op" id="4189880">:=</span>&nbsp;<span class="ident" id="4189883">MaxBytesReader</span><span class="op" id="4189897">(</span><span class="ident" id="4189898">w</span><span class="op" id="4189899">,</span>&nbsp;<span class="ident" id="4189901">r</span><span class="op" id="4189902">.</span><span class="ident" id="4189903">Body</span><span class="op" id="4189907">,</span>&nbsp;<span class="num" id="4189909">4</span><span class="op" id="4189910">&lt;&lt;</span><span class="num" id="4189912">10</span><span class="op" id="4189914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4189918">io</span><span class="op" id="4189920">.</span><span class="ident" id="4189921">Copy</span><span class="op" id="4189925">(</span><span class="ident" id="4189926">ioutil</span><span class="op" id="4189932">.</span><span class="ident" id="4189933">Discard</span><span class="op" id="4189940">,</span>&nbsp;<span class="ident" id="4189942">mb</span><span class="op" id="4189944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4189947">}</span><br>
<span class="lineno"></span><span class="op" id="4189949">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="4189952">type</span>&nbsp;<span class="ident" id="4189957">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="4189978">struct</span><span class="op" id="4189984">{</span><span class="op" id="4189985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4189988">func</span>&nbsp;<span class="op" id="4189993">(</span><span class="ident" id="4189994">eofReaderWithWriteTo</span><span class="op" id="4190014">)</span>&nbsp;<span class="ident" id="4190016">WriteTo</span><span class="op" id="4190023">(</span><span class="ident" id="4190024">io</span><span class="op" id="4190026">.</span><span class="ident" id="4190027">Writer</span><span class="op" id="4190033">)</span>&nbsp;<span class="op" id="4190035">(</span><span class="ident" id="4190036">int64</span><span class="op" id="4190041">,</span>&nbsp;<span class="builtintype" id="4190043">error</span><span class="op" id="4190048">)</span>&nbsp;<span class="op" id="4190050">{</span>&nbsp;<span class="keyword" id="4190052">return</span>&nbsp;<span class="num" id="4190059">0</span><span class="op" id="4190060">,</span>&nbsp;<span class="builtintype" id="4190062">nil</span>&nbsp;<span class="op" id="4190066">}</span><br>
<span class="lineno"></span><span class="keyword" id="4190068">func</span>&nbsp;<span class="op" id="4190073">(</span><span class="ident" id="4190074">eofReaderWithWriteTo</span><span class="op" id="4190094">)</span>&nbsp;<span class="ident" id="4190096">Read</span><span class="op" id="4190100">(</span><span class="op" id="4190101">[</span><span class="op" id="4190102">]</span><span class="builtintype" id="4190103">byte</span><span class="op" id="4190107">)</span>&nbsp;<span class="op" id="4190109">(</span><span class="builtintype" id="4190110">int</span><span class="op" id="4190113">,</span>&nbsp;<span class="builtintype" id="4190115">error</span><span class="op" id="4190120">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190130">{</span>&nbsp;<span class="keyword" id="4190132">return</span>&nbsp;<span class="num" id="4190139">0</span><span class="op" id="4190140">,</span>&nbsp;<span class="ident" id="4190142">io</span><span class="op" id="4190144">.</span><span class="ident" id="4190145">EOF</span>&nbsp;<span class="op" id="4190149">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="4190152">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="4190217">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4190276">var</span>&nbsp;<span class="ident" id="4190280">eofReader</span>&nbsp;<span class="op" id="4190290">=</span>&nbsp;<span class="op" id="4190292">&amp;</span><span class="keyword" id="4190293">struct</span>&nbsp;<span class="op" id="4190300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190303">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190325">io</span><span class="op" id="4190327">.</span><span class="ident" id="4190328">Closer</span><br>
<span class="lineno"></span><span class="op" id="4190335">}</span><span class="op" id="4190336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190339">eofReaderWithWriteTo</span><span class="op" id="4190359">{</span><span class="op" id="4190360">}</span><span class="op" id="4190361">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190364">ioutil</span><span class="op" id="4190370">.</span><span class="ident" id="4190371">NopCloser</span><span class="op" id="4190380">(</span><span class="builtintype" id="4190381">nil</span><span class="op" id="4190384">)</span><span class="op" id="4190385">,</span><br>
<span class="lineno"></span><span class="op" id="4190387">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="4190390">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4190458">var</span>&nbsp;<span class="ident" id="4190462">_</span>&nbsp;<span class="ident" id="4190464">io</span><span class="op" id="4190466">.</span><span class="ident" id="4190467">WriterTo</span>&nbsp;<span class="op" id="4190476">=</span>&nbsp;<span class="ident" id="4190478">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4190489">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="4190551">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="4190619">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="4190664">type</span>&nbsp;<span class="ident" id="4190669">initNPNRequest</span>&nbsp;<span class="keyword" id="4190684">struct</span>&nbsp;<span class="op" id="4190691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190694">c</span>&nbsp;<span class="op" id="4190696">*</span><span class="ident" id="4190697">tls</span><span class="op" id="4190700">.</span><span class="ident" id="4190701">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190707">h</span>&nbsp;<span class="ident" id="4190709">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="4190723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4190726">func</span>&nbsp;<span class="op" id="4190731">(</span><span class="ident" id="4190732">h</span>&nbsp;<span class="ident" id="4190734">initNPNRequest</span><span class="op" id="4190748">)</span>&nbsp;<span class="ident" id="4190750">ServeHTTP</span><span class="op" id="4190759">(</span><span class="ident" id="4190760">rw</span>&nbsp;<span class="ident" id="4190763">ResponseWriter</span><span class="op" id="4190777">,</span>&nbsp;<span class="ident" id="4190779">req</span>&nbsp;<span class="op" id="4190783">*</span><span class="ident" id="4190784">Request</span><span class="op" id="4190791">)</span>&nbsp;<span class="op" id="4190793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190796">if</span>&nbsp;<span class="ident" id="4190799">req</span><span class="op" id="4190802">.</span><span class="ident" id="4190803">TLS</span>&nbsp;<span class="op" id="4190807">==</span>&nbsp;<span class="builtintype" id="4190810">nil</span>&nbsp;<span class="op" id="4190814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190818">req</span><span class="op" id="4190821">.</span><span class="ident" id="4190822">TLS</span>&nbsp;<span class="op" id="4190826">=</span>&nbsp;<span class="op" id="4190828">&amp;</span><span class="ident" id="4190829">tls</span><span class="op" id="4190832">.</span><span class="ident" id="4190833">ConnectionState</span><span class="op" id="4190848">{</span><span class="op" id="4190849">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190853">*</span><span class="ident" id="4190854">req</span><span class="op" id="4190857">.</span><span class="ident" id="4190858">TLS</span>&nbsp;<span class="op" id="4190862">=</span>&nbsp;<span class="ident" id="4190864">h</span><span class="op" id="4190865">.</span><span class="ident" id="4190866">c</span><span class="op" id="4190867">.</span><span class="ident" id="4190868">ConnectionState</span><span class="op" id="4190883">(</span><span class="op" id="4190884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190890">if</span>&nbsp;<span class="ident" id="4190893">req</span><span class="op" id="4190896">.</span><span class="ident" id="4190897">Body</span>&nbsp;<span class="op" id="4190902">==</span>&nbsp;<span class="builtintype" id="4190905">nil</span>&nbsp;<span class="op" id="4190909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190913">req</span><span class="op" id="4190916">.</span><span class="ident" id="4190917">Body</span>&nbsp;<span class="op" id="4190922">=</span>&nbsp;<span class="ident" id="4190924">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4190935">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4190938">if</span>&nbsp;<span class="ident" id="4190941">req</span><span class="op" id="4190944">.</span><span class="ident" id="4190945">RemoteAddr</span>&nbsp;<span class="op" id="4190956">==</span>&nbsp;<span class="string" id="4190959">&#34;&#34;</span>&nbsp;<span class="op" id="4190962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4190966">req</span><span class="op" id="4190969">.</span><span class="ident" id="4190970">RemoteAddr</span>&nbsp;<span class="op" id="4190981">=</span>&nbsp;<span class="ident" id="4190983">h</span><span class="op" id="4190984">.</span><span class="ident" id="4190985">c</span><span class="op" id="4190986">.</span><span class="ident" id="4190987">RemoteAddr</span><span class="op" id="4190997">(</span><span class="op" id="4190998">)</span><span class="op" id="4190999">.</span><span class="ident" id="4191000">String</span><span class="op" id="4191006">(</span><span class="op" id="4191007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191013">h</span><span class="op" id="4191014">.</span><span class="ident" id="4191015">h</span><span class="op" id="4191016">.</span><span class="ident" id="4191017">ServeHTTP</span><span class="op" id="4191026">(</span><span class="ident" id="4191027">rw</span><span class="op" id="4191029">,</span>&nbsp;<span class="ident" id="4191031">req</span><span class="op" id="4191034">)</span><br>
<span class="lineno"></span><span class="op" id="4191036">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="4191039">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="4191077">type</span>&nbsp;<span class="ident" id="4191082">loggingConn</span>&nbsp;<span class="keyword" id="4191094">struct</span>&nbsp;<span class="op" id="4191101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191104">name</span>&nbsp;<span class="builtintype" id="4191109">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191117">net</span><span class="op" id="4191120">.</span><span class="ident" id="4191121">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="4191126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191129">var</span>&nbsp;<span class="op" id="4191133">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191136">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4191149">sync</span><span class="op" id="4191153">.</span><span class="ident" id="4191154">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191161">uniqNameNext</span>&nbsp;<span class="op" id="4191174">=</span>&nbsp;<span class="builtinfunc" id="4191176">make</span><span class="op" id="4191180">(</span><span class="keyword" id="4191181">map</span><span class="op" id="4191184">[</span><span class="builtintype" id="4191185">string</span><span class="op" id="4191191">]</span><span class="builtintype" id="4191192">int</span><span class="op" id="4191195">)</span><br>
<span class="lineno">2050</span><span class="op" id="4191197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191200">func</span>&nbsp;<span class="ident" id="4191205">newLoggingConn</span><span class="op" id="4191219">(</span><span class="ident" id="4191220">baseName</span>&nbsp;<span class="builtintype" id="4191229">string</span><span class="op" id="4191235">,</span>&nbsp;<span class="ident" id="4191237">c</span>&nbsp;<span class="ident" id="4191239">net</span><span class="op" id="4191242">.</span><span class="ident" id="4191243">Conn</span><span class="op" id="4191247">)</span>&nbsp;<span class="ident" id="4191249">net</span><span class="op" id="4191252">.</span><span class="ident" id="4191253">Conn</span>&nbsp;<span class="op" id="4191258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191261">uniqNameMu</span><span class="op" id="4191271">.</span><span class="ident" id="4191272">Lock</span><span class="op" id="4191276">(</span><span class="op" id="4191277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191280">defer</span>&nbsp;<span class="ident" id="4191286">uniqNameMu</span><span class="op" id="4191296">.</span><span class="ident" id="4191297">Unlock</span><span class="op" id="4191303">(</span><span class="op" id="4191304">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191307">uniqNameNext</span><span class="op" id="4191319">[</span><span class="ident" id="4191320">baseName</span><span class="op" id="4191328">]</span><span class="op" id="4191329">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191333">return</span>&nbsp;<span class="op" id="4191340">&amp;</span><span class="ident" id="4191341">loggingConn</span><span class="op" id="4191352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191356">name</span><span class="op" id="4191360">:</span>&nbsp;<span class="ident" id="4191362">fmt</span><span class="op" id="4191365">.</span><span class="ident" id="4191366">Sprintf</span><span class="op" id="4191373">(</span><span class="string" id="4191374">&#34;%s-%d&#34;</span><span class="op" id="4191381">,</span>&nbsp;<span class="ident" id="4191383">baseName</span><span class="op" id="4191391">,</span>&nbsp;<span class="ident" id="4191393">uniqNameNext</span><span class="op" id="4191405">[</span><span class="ident" id="4191406">baseName</span><span class="op" id="4191414">]</span><span class="op" id="4191415">)</span><span class="op" id="4191416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191420">Conn</span><span class="op" id="4191424">:</span>&nbsp;<span class="ident" id="4191426">c</span><span class="op" id="4191427">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4191430">}</span><br>
<span class="lineno">2060</span><span class="op" id="4191432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191435">func</span>&nbsp;<span class="op" id="4191440">(</span><span class="ident" id="4191441">c</span>&nbsp;<span class="op" id="4191443">*</span><span class="ident" id="4191444">loggingConn</span><span class="op" id="4191455">)</span>&nbsp;<span class="ident" id="4191457">Write</span><span class="op" id="4191462">(</span><span class="ident" id="4191463">p</span>&nbsp;<span class="op" id="4191465">[</span><span class="op" id="4191466">]</span><span class="builtintype" id="4191467">byte</span><span class="op" id="4191471">)</span>&nbsp;<span class="op" id="4191473">(</span><span class="ident" id="4191474">n</span>&nbsp;<span class="builtintype" id="4191476">int</span><span class="op" id="4191479">,</span>&nbsp;<span class="ident" id="4191481">err</span>&nbsp;<span class="builtintype" id="4191485">error</span><span class="op" id="4191490">)</span>&nbsp;<span class="op" id="4191492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191495">log</span><span class="op" id="4191498">.</span><span class="ident" id="4191499">Printf</span><span class="op" id="4191505">(</span><span class="string" id="4191506">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4191527">,</span>&nbsp;<span class="ident" id="4191529">c</span><span class="op" id="4191530">.</span><span class="ident" id="4191531">name</span><span class="op" id="4191535">,</span>&nbsp;<span class="builtinfunc" id="4191537">len</span><span class="op" id="4191540">(</span><span class="ident" id="4191541">p</span><span class="op" id="4191542">)</span><span class="op" id="4191543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191546">n</span><span class="op" id="4191547">,</span>&nbsp;<span class="ident" id="4191549">err</span>&nbsp;<span class="op" id="4191553">=</span>&nbsp;<span class="ident" id="4191555">c</span><span class="op" id="4191556">.</span><span class="ident" id="4191557">Conn</span><span class="op" id="4191561">.</span><span class="ident" id="4191562">Write</span><span class="op" id="4191567">(</span><span class="ident" id="4191568">p</span><span class="op" id="4191569">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191572">log</span><span class="op" id="4191575">.</span><span class="ident" id="4191576">Printf</span><span class="op" id="4191582">(</span><span class="string" id="4191583">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4191606">,</span>&nbsp;<span class="ident" id="4191608">c</span><span class="op" id="4191609">.</span><span class="ident" id="4191610">name</span><span class="op" id="4191614">,</span>&nbsp;<span class="builtinfunc" id="4191616">len</span><span class="op" id="4191619">(</span><span class="ident" id="4191620">p</span><span class="op" id="4191621">)</span><span class="op" id="4191622">,</span>&nbsp;<span class="ident" id="4191624">n</span><span class="op" id="4191625">,</span>&nbsp;<span class="ident" id="4191627">err</span><span class="op" id="4191630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191633">return</span><br>
<span class="lineno"></span><span class="op" id="4191640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191643">func</span>&nbsp;<span class="op" id="4191648">(</span><span class="ident" id="4191649">c</span>&nbsp;<span class="op" id="4191651">*</span><span class="ident" id="4191652">loggingConn</span><span class="op" id="4191663">)</span>&nbsp;<span class="ident" id="4191665">Read</span><span class="op" id="4191669">(</span><span class="ident" id="4191670">p</span>&nbsp;<span class="op" id="4191672">[</span><span class="op" id="4191673">]</span><span class="builtintype" id="4191674">byte</span><span class="op" id="4191678">)</span>&nbsp;<span class="op" id="4191680">(</span><span class="ident" id="4191681">n</span>&nbsp;<span class="builtintype" id="4191683">int</span><span class="op" id="4191686">,</span>&nbsp;<span class="ident" id="4191688">err</span>&nbsp;<span class="builtintype" id="4191692">error</span><span class="op" id="4191697">)</span>&nbsp;<span class="op" id="4191699">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191702">log</span><span class="op" id="4191705">.</span><span class="ident" id="4191706">Printf</span><span class="op" id="4191712">(</span><span class="string" id="4191713">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4191733">,</span>&nbsp;<span class="ident" id="4191735">c</span><span class="op" id="4191736">.</span><span class="ident" id="4191737">name</span><span class="op" id="4191741">,</span>&nbsp;<span class="builtinfunc" id="4191743">len</span><span class="op" id="4191746">(</span><span class="ident" id="4191747">p</span><span class="op" id="4191748">)</span><span class="op" id="4191749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191752">n</span><span class="op" id="4191753">,</span>&nbsp;<span class="ident" id="4191755">err</span>&nbsp;<span class="op" id="4191759">=</span>&nbsp;<span class="ident" id="4191761">c</span><span class="op" id="4191762">.</span><span class="ident" id="4191763">Conn</span><span class="op" id="4191767">.</span><span class="ident" id="4191768">Read</span><span class="op" id="4191772">(</span><span class="ident" id="4191773">p</span><span class="op" id="4191774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191777">log</span><span class="op" id="4191780">.</span><span class="ident" id="4191781">Printf</span><span class="op" id="4191787">(</span><span class="string" id="4191788">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4191810">,</span>&nbsp;<span class="ident" id="4191812">c</span><span class="op" id="4191813">.</span><span class="ident" id="4191814">name</span><span class="op" id="4191818">,</span>&nbsp;<span class="builtinfunc" id="4191820">len</span><span class="op" id="4191823">(</span><span class="ident" id="4191824">p</span><span class="op" id="4191825">)</span><span class="op" id="4191826">,</span>&nbsp;<span class="ident" id="4191828">n</span><span class="op" id="4191829">,</span>&nbsp;<span class="ident" id="4191831">err</span><span class="op" id="4191834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191837">return</span><br>
<span class="lineno"></span><span class="op" id="4191844">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="4191847">func</span>&nbsp;<span class="op" id="4191852">(</span><span class="ident" id="4191853">c</span>&nbsp;<span class="op" id="4191855">*</span><span class="ident" id="4191856">loggingConn</span><span class="op" id="4191867">)</span>&nbsp;<span class="ident" id="4191869">Close</span><span class="op" id="4191874">(</span><span class="op" id="4191875">)</span>&nbsp;<span class="op" id="4191877">(</span><span class="ident" id="4191878">err</span>&nbsp;<span class="builtintype" id="4191882">error</span><span class="op" id="4191887">)</span>&nbsp;<span class="op" id="4191889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191892">log</span><span class="op" id="4191895">.</span><span class="ident" id="4191896">Printf</span><span class="op" id="4191902">(</span><span class="string" id="4191903">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="4191921">,</span>&nbsp;<span class="ident" id="4191923">c</span><span class="op" id="4191924">.</span><span class="ident" id="4191925">name</span><span class="op" id="4191929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191932">err</span>&nbsp;<span class="op" id="4191936">=</span>&nbsp;<span class="ident" id="4191938">c</span><span class="op" id="4191939">.</span><span class="ident" id="4191940">Conn</span><span class="op" id="4191944">.</span><span class="ident" id="4191945">Close</span><span class="op" id="4191950">(</span><span class="op" id="4191951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4191954">log</span><span class="op" id="4191957">.</span><span class="ident" id="4191958">Printf</span><span class="op" id="4191964">(</span><span class="string" id="4191965">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="4191982">,</span>&nbsp;<span class="ident" id="4191984">c</span><span class="op" id="4191985">.</span><span class="ident" id="4191986">name</span><span class="op" id="4191990">,</span>&nbsp;<span class="ident" id="4191992">err</span><span class="op" id="4191995">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4191998">return</span><br>
<span class="lineno"></span><span class="op" id="4192005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4192008">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="4192088">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="4192155">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4192214">type</span>&nbsp;<span class="ident" id="4192219">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="4192240">struct</span>&nbsp;<span class="op" id="4192247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192250">c</span>&nbsp;<span class="op" id="4192252">*</span><span class="ident" id="4192253">conn</span><br>
<span class="lineno"></span><span class="op" id="4192258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="4192261">func</span>&nbsp;<span class="op" id="4192266">(</span><span class="ident" id="4192267">w</span>&nbsp;<span class="ident" id="4192269">checkConnErrorWriter</span><span class="op" id="4192289">)</span>&nbsp;<span class="ident" id="4192291">Write</span><span class="op" id="4192296">(</span><span class="ident" id="4192297">p</span>&nbsp;<span class="op" id="4192299">[</span><span class="op" id="4192300">]</span><span class="builtintype" id="4192301">byte</span><span class="op" id="4192305">)</span>&nbsp;<span class="op" id="4192307">(</span><span class="ident" id="4192308">n</span>&nbsp;<span class="builtintype" id="4192310">int</span><span class="op" id="4192313">,</span>&nbsp;<span class="ident" id="4192315">err</span>&nbsp;<span class="builtintype" id="4192319">error</span><span class="op" id="4192324">)</span>&nbsp;<span class="op" id="4192326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192329">n</span><span class="op" id="4192330">,</span>&nbsp;<span class="ident" id="4192332">err</span>&nbsp;<span class="op" id="4192336">=</span>&nbsp;<span class="ident" id="4192338">w</span><span class="op" id="4192339">.</span><span class="ident" id="4192340">c</span><span class="op" id="4192341">.</span><span class="ident" id="4192342">w</span><span class="op" id="4192343">.</span><span class="ident" id="4192344">Write</span><span class="op" id="4192349">(</span><span class="ident" id="4192350">p</span><span class="op" id="4192351">)</span>&nbsp;<span class="comment" id="4192353">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192411">if</span>&nbsp;<span class="ident" id="4192414">err</span>&nbsp;<span class="op" id="4192418">!=</span>&nbsp;<span class="builtintype" id="4192421">nil</span>&nbsp;<span class="op" id="4192425">&amp;&amp;</span>&nbsp;<span class="ident" id="4192428">w</span><span class="op" id="4192429">.</span><span class="ident" id="4192430">c</span><span class="op" id="4192431">.</span><span class="ident" id="4192432">werr</span>&nbsp;<span class="op" id="4192437">==</span>&nbsp;<span class="builtintype" id="4192440">nil</span>&nbsp;<span class="op" id="4192444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192448">w</span><span class="op" id="4192449">.</span><span class="ident" id="4192450">c</span><span class="op" id="4192451">.</span><span class="ident" id="4192452">werr</span>&nbsp;<span class="op" id="4192457">=</span>&nbsp;<span class="ident" id="4192459">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192464">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4192467">return</span><br>
<span class="lineno"></span><span class="op" id="4192474">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
