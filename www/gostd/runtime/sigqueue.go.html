<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1698470">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1698525">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1698579">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1698630">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1698691">//</span><br>
<span class="lineno"></span><span class="comment" id="1698694">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1698752">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1698823">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1698882">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1698908">//</span><br>
<span class="lineno"></span><span class="comment" id="1698911">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1698977">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1699054">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1699131">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1699206">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1699285">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1699309">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1699378">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1699425">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1699512">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1699572">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1699648">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1699724">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1699798">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1699817">package</span>&nbsp;<span class="ident" id="1699825">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1699834">import</span>&nbsp;<span class="string" id="1699841">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1699851">var</span>&nbsp;<span class="ident" id="1699855">sig</span>&nbsp;<span class="keyword" id="1699859">struct</span>&nbsp;<span class="op" id="1699866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699869">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1699876">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699882">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1699889">[</span><span class="op" id="1699890">(</span><span class="ident" id="1699891">_NSIG</span>&nbsp;<span class="op" id="1699897">+</span>&nbsp;<span class="num" id="1699899">31</span><span class="op" id="1699901">)</span>&nbsp;<span class="op" id="1699903">/</span>&nbsp;<span class="num" id="1699905">32</span><span class="op" id="1699907">]</span><span class="builtintype" id="1699908">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699916">wanted</span>&nbsp;<span class="op" id="1699923">[</span><span class="op" id="1699924">(</span><span class="ident" id="1699925">_NSIG</span>&nbsp;<span class="op" id="1699931">+</span>&nbsp;<span class="num" id="1699933">31</span><span class="op" id="1699935">)</span>&nbsp;<span class="op" id="1699937">/</span>&nbsp;<span class="num" id="1699939">32</span><span class="op" id="1699941">]</span><span class="builtintype" id="1699942">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699950">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1699957">[</span><span class="op" id="1699958">(</span><span class="ident" id="1699959">_NSIG</span>&nbsp;<span class="op" id="1699965">+</span>&nbsp;<span class="num" id="1699967">31</span><span class="op" id="1699969">)</span>&nbsp;<span class="op" id="1699971">/</span>&nbsp;<span class="num" id="1699973">32</span><span class="op" id="1699975">]</span><span class="builtintype" id="1699976">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699984">state</span>&nbsp;&nbsp;<span class="builtintype" id="1699991">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1699999">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1700006">bool</span><br>
<span class="lineno"></span><span class="op" id="1700011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1700014">const</span>&nbsp;<span class="op" id="1700020">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700023">sigIdle</span>&nbsp;<span class="op" id="1700031">=</span>&nbsp;<span class="ident" id="1700033">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700039">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700053">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1700064">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1700067">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1700150">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1700240">func</span>&nbsp;<span class="ident" id="1700245">sigsend</span><span class="op" id="1700252">(</span><span class="ident" id="1700253">s</span>&nbsp;<span class="builtintype" id="1700255">int32</span><span class="op" id="1700260">)</span>&nbsp;<span class="builtintype" id="1700262">bool</span>&nbsp;<span class="op" id="1700267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700270">bit</span>&nbsp;<span class="op" id="1700274">:=</span>&nbsp;<span class="builtintype" id="1700277">uint32</span><span class="op" id="1700283">(</span><span class="num" id="1700284">1</span><span class="op" id="1700285">)</span>&nbsp;<span class="op" id="1700287">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1700290">uint</span><span class="op" id="1700294">(</span><span class="ident" id="1700295">s</span><span class="op" id="1700296">&amp;</span><span class="num" id="1700297">31</span><span class="op" id="1700299">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700302">if</span>&nbsp;<span class="op" id="1700305">!</span><span class="ident" id="1700306">sig</span><span class="op" id="1700309">.</span><span class="ident" id="1700310">inuse</span>&nbsp;<span class="op" id="1700316">||</span>&nbsp;<span class="ident" id="1700319">s</span>&nbsp;<span class="op" id="1700321">&lt;</span>&nbsp;<span class="num" id="1700323">0</span>&nbsp;<span class="op" id="1700325">||</span>&nbsp;<span class="builtintype" id="1700328">int</span><span class="op" id="1700331">(</span><span class="ident" id="1700332">s</span><span class="op" id="1700333">)</span>&nbsp;<span class="op" id="1700335">&gt;=</span>&nbsp;<span class="num" id="1700338">32</span><span class="op" id="1700340">*</span><span class="builtinfunc" id="1700341">len</span><span class="op" id="1700344">(</span><span class="ident" id="1700345">sig</span><span class="op" id="1700348">.</span><span class="ident" id="1700349">wanted</span><span class="op" id="1700355">)</span>&nbsp;<span class="op" id="1700357">||</span>&nbsp;<span class="ident" id="1700360">sig</span><span class="op" id="1700363">.</span><span class="ident" id="1700364">wanted</span><span class="op" id="1700370">[</span><span class="ident" id="1700371">s</span><span class="op" id="1700372">/</span><span class="num" id="1700373">32</span><span class="op" id="1700375">]</span><span class="op" id="1700376">&amp;</span><span class="ident" id="1700377">bit</span>&nbsp;<span class="op" id="1700381">==</span>&nbsp;<span class="num" id="1700384">0</span>&nbsp;<span class="op" id="1700386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700390">return</span>&nbsp;<span class="builtintype" id="1700397">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700408">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700442">for</span>&nbsp;<span class="op" id="1700446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700450">mask</span>&nbsp;<span class="op" id="1700455">:=</span>&nbsp;<span class="ident" id="1700458">sig</span><span class="op" id="1700461">.</span><span class="ident" id="1700462">mask</span><span class="op" id="1700466">[</span><span class="ident" id="1700467">s</span><span class="op" id="1700468">/</span><span class="num" id="1700469">32</span><span class="op" id="1700471">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700475">if</span>&nbsp;<span class="ident" id="1700478">mask</span><span class="op" id="1700482">&amp;</span><span class="ident" id="1700483">bit</span>&nbsp;<span class="op" id="1700487">!=</span>&nbsp;<span class="num" id="1700490">0</span>&nbsp;<span class="op" id="1700492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700497">return</span>&nbsp;<span class="builtintype" id="1700504">true</span>&nbsp;<span class="comment" id="1700509">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700538">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700542">if</span>&nbsp;<span class="ident" id="1700545">cas</span><span class="op" id="1700548">(</span><span class="op" id="1700549">&amp;</span><span class="ident" id="1700550">sig</span><span class="op" id="1700553">.</span><span class="ident" id="1700554">mask</span><span class="op" id="1700558">[</span><span class="ident" id="1700559">s</span><span class="op" id="1700560">/</span><span class="num" id="1700561">32</span><span class="op" id="1700563">]</span><span class="op" id="1700564">,</span>&nbsp;<span class="ident" id="1700566">mask</span><span class="op" id="1700570">,</span>&nbsp;<span class="ident" id="1700572">mask</span><span class="op" id="1700576">|</span><span class="ident" id="1700577">bit</span><span class="op" id="1700580">)</span>&nbsp;<span class="op" id="1700582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700587">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700602">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1700645">Send</span><span class="op" id="1700649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700652">for</span>&nbsp;<span class="op" id="1700656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700660">switch</span>&nbsp;<span class="ident" id="1700667">atomicload</span><span class="op" id="1700677">(</span><span class="op" id="1700678">&amp;</span><span class="ident" id="1700679">sig</span><span class="op" id="1700682">.</span><span class="ident" id="1700683">state</span><span class="op" id="1700688">)</span>&nbsp;<span class="op" id="1700690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700694">default</span><span class="op" id="1700701">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700706">gothrow</span><span class="op" id="1700713">(</span><span class="string" id="1700714">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1700743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700747">case</span>&nbsp;<span class="ident" id="1700752">sigIdle</span><span class="op" id="1700759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700764">if</span>&nbsp;<span class="ident" id="1700767">cas</span><span class="op" id="1700770">(</span><span class="op" id="1700771">&amp;</span><span class="ident" id="1700772">sig</span><span class="op" id="1700775">.</span><span class="ident" id="1700776">state</span><span class="op" id="1700781">,</span>&nbsp;<span class="ident" id="1700783">sigIdle</span><span class="op" id="1700790">,</span>&nbsp;<span class="ident" id="1700792">sigSending</span><span class="op" id="1700802">)</span>&nbsp;<span class="op" id="1700804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700810">break</span>&nbsp;<span class="ident" id="1700816">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1700824">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700828">case</span>&nbsp;<span class="ident" id="1700833">sigSending</span><span class="op" id="1700843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1700848">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700883">break</span>&nbsp;<span class="ident" id="1700889">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700896">case</span>&nbsp;<span class="ident" id="1700901">sigReceiving</span><span class="op" id="1700913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700918">if</span>&nbsp;<span class="ident" id="1700921">cas</span><span class="op" id="1700924">(</span><span class="op" id="1700925">&amp;</span><span class="ident" id="1700926">sig</span><span class="op" id="1700929">.</span><span class="ident" id="1700930">state</span><span class="op" id="1700935">,</span>&nbsp;<span class="ident" id="1700937">sigReceiving</span><span class="op" id="1700949">,</span>&nbsp;<span class="ident" id="1700951">sigIdle</span><span class="op" id="1700958">)</span>&nbsp;<span class="op" id="1700960">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1700966">notewakeup</span><span class="op" id="1700976">(</span><span class="op" id="1700977">&amp;</span><span class="ident" id="1700978">sig</span><span class="op" id="1700981">.</span><span class="ident" id="1700982">note</span><span class="op" id="1700986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1700992">break</span>&nbsp;<span class="ident" id="1700998">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701013">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701017">return</span>&nbsp;<span class="builtintype" id="1701024">true</span><br>
<span class="lineno"></span><span class="op" id="1701029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1701032">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1701077">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1701135">func</span>&nbsp;<span class="ident" id="1701140">signal_recv</span><span class="op" id="1701151">(</span><span class="op" id="1701152">)</span>&nbsp;<span class="builtintype" id="1701154">uint32</span>&nbsp;<span class="op" id="1701161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701164">for</span>&nbsp;<span class="op" id="1701168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1701172">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701212">for</span>&nbsp;<span class="ident" id="1701216">i</span>&nbsp;<span class="op" id="1701218">:=</span>&nbsp;<span class="builtintype" id="1701221">uint32</span><span class="op" id="1701227">(</span><span class="num" id="1701228">0</span><span class="op" id="1701229">)</span><span class="op" id="1701230">;</span>&nbsp;<span class="ident" id="1701232">i</span>&nbsp;<span class="op" id="1701234">&lt;</span>&nbsp;<span class="ident" id="1701236">_NSIG</span><span class="op" id="1701241">;</span>&nbsp;<span class="ident" id="1701243">i</span><span class="op" id="1701244">++</span>&nbsp;<span class="op" id="1701247">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701252">if</span>&nbsp;<span class="ident" id="1701255">sig</span><span class="op" id="1701258">.</span><span class="ident" id="1701259">recv</span><span class="op" id="1701263">[</span><span class="ident" id="1701264">i</span><span class="op" id="1701265">/</span><span class="num" id="1701266">32</span><span class="op" id="1701268">]</span><span class="op" id="1701269">&amp;</span><span class="op" id="1701270">(</span><span class="num" id="1701271">1</span><span class="op" id="1701272">&lt;&lt;</span><span class="op" id="1701274">(</span><span class="ident" id="1701275">i</span><span class="op" id="1701276">&amp;</span><span class="num" id="1701277">31</span><span class="op" id="1701279">)</span><span class="op" id="1701280">)</span>&nbsp;<span class="op" id="1701282">!=</span>&nbsp;<span class="num" id="1701285">0</span>&nbsp;<span class="op" id="1701287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701293">sig</span><span class="op" id="1701296">.</span><span class="ident" id="1701297">recv</span><span class="op" id="1701301">[</span><span class="ident" id="1701302">i</span><span class="op" id="1701303">/</span><span class="num" id="1701304">32</span><span class="op" id="1701306">]</span>&nbsp;<span class="op" id="1701308">&amp;^=</span>&nbsp;<span class="num" id="1701312">1</span>&nbsp;<span class="op" id="1701314">&lt;&lt;</span>&nbsp;<span class="op" id="1701317">(</span><span class="ident" id="1701318">i</span>&nbsp;<span class="op" id="1701320">&amp;</span>&nbsp;<span class="num" id="1701322">31</span><span class="op" id="1701324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701330">return</span>&nbsp;<span class="ident" id="1701337">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701346">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1701351">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701408">Receive</span><span class="op" id="1701415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701419">for</span>&nbsp;<span class="op" id="1701423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701428">switch</span>&nbsp;<span class="ident" id="1701435">atomicload</span><span class="op" id="1701445">(</span><span class="op" id="1701446">&amp;</span><span class="ident" id="1701447">sig</span><span class="op" id="1701450">.</span><span class="ident" id="1701451">state</span><span class="op" id="1701456">)</span>&nbsp;<span class="op" id="1701458">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701463">default</span><span class="op" id="1701470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701476">gothrow</span><span class="op" id="1701483">(</span><span class="string" id="1701484">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1701517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701522">case</span>&nbsp;<span class="ident" id="1701527">sigIdle</span><span class="op" id="1701534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701540">if</span>&nbsp;<span class="ident" id="1701543">cas</span><span class="op" id="1701546">(</span><span class="op" id="1701547">&amp;</span><span class="ident" id="1701548">sig</span><span class="op" id="1701551">.</span><span class="ident" id="1701552">state</span><span class="op" id="1701557">,</span>&nbsp;<span class="ident" id="1701559">sigIdle</span><span class="op" id="1701566">,</span>&nbsp;<span class="ident" id="1701568">sigReceiving</span><span class="op" id="1701580">)</span>&nbsp;<span class="op" id="1701582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701589">notetsleepg</span><span class="op" id="1701600">(</span><span class="op" id="1701601">&amp;</span><span class="ident" id="1701602">sig</span><span class="op" id="1701605">.</span><span class="ident" id="1701606">note</span><span class="op" id="1701610">,</span>&nbsp;<span class="op" id="1701612">-</span><span class="num" id="1701613">1</span><span class="op" id="1701614">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701621">noteclear</span><span class="op" id="1701630">(</span><span class="op" id="1701631">&amp;</span><span class="ident" id="1701632">sig</span><span class="op" id="1701635">.</span><span class="ident" id="1701636">note</span><span class="op" id="1701640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701647">break</span>&nbsp;<span class="ident" id="1701653">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701670">case</span>&nbsp;<span class="ident" id="1701675">sigSending</span><span class="op" id="1701685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701691">if</span>&nbsp;<span class="ident" id="1701694">cas</span><span class="op" id="1701697">(</span><span class="op" id="1701698">&amp;</span><span class="ident" id="1701699">sig</span><span class="op" id="1701702">.</span><span class="ident" id="1701703">state</span><span class="op" id="1701708">,</span>&nbsp;<span class="ident" id="1701710">sigSending</span><span class="op" id="1701720">,</span>&nbsp;<span class="ident" id="1701722">sigIdle</span><span class="op" id="1701729">)</span>&nbsp;<span class="op" id="1701731">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701738">break</span>&nbsp;<span class="ident" id="1701744">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1701770">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701824">for</span>&nbsp;<span class="ident" id="1701828">i</span>&nbsp;<span class="op" id="1701830">:=</span>&nbsp;<span class="keyword" id="1701833">range</span>&nbsp;<span class="ident" id="1701839">sig</span><span class="op" id="1701842">.</span><span class="ident" id="1701843">mask</span>&nbsp;<span class="op" id="1701848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1701853">sig</span><span class="op" id="1701856">.</span><span class="ident" id="1701857">recv</span><span class="op" id="1701861">[</span><span class="ident" id="1701862">i</span><span class="op" id="1701863">]</span>&nbsp;<span class="op" id="1701865">=</span>&nbsp;<span class="ident" id="1701867">xchg</span><span class="op" id="1701871">(</span><span class="op" id="1701872">&amp;</span><span class="ident" id="1701873">sig</span><span class="op" id="1701876">.</span><span class="ident" id="1701877">mask</span><span class="op" id="1701881">[</span><span class="ident" id="1701882">i</span><span class="op" id="1701883">]</span><span class="op" id="1701884">,</span>&nbsp;<span class="num" id="1701886">0</span><span class="op" id="1701887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1701894">}</span><br>
<span class="lineno">125</span><span class="op" id="1701896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1701899">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1701957">func</span>&nbsp;<span class="ident" id="1701962">signal_enable</span><span class="op" id="1701975">(</span><span class="ident" id="1701976">s</span>&nbsp;<span class="builtintype" id="1701978">uint32</span><span class="op" id="1701984">)</span>&nbsp;<span class="op" id="1701986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1701989">if</span>&nbsp;<span class="op" id="1701992">!</span><span class="ident" id="1701993">sig</span><span class="op" id="1701996">.</span><span class="ident" id="1701997">inuse</span>&nbsp;<span class="op" id="1702003">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1702007">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1702054">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1702104">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702134">sig</span><span class="op" id="1702137">.</span><span class="ident" id="1702138">inuse</span>&nbsp;<span class="op" id="1702144">=</span>&nbsp;<span class="builtintype" id="1702146">true</span>&nbsp;<span class="comment" id="1702151">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702200">noteclear</span><span class="op" id="1702209">(</span><span class="op" id="1702210">&amp;</span><span class="ident" id="1702211">sig</span><span class="op" id="1702214">.</span><span class="ident" id="1702215">note</span><span class="op" id="1702219">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702223">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702235">if</span>&nbsp;<span class="builtintype" id="1702238">int</span><span class="op" id="1702241">(</span><span class="ident" id="1702242">s</span><span class="op" id="1702243">)</span>&nbsp;<span class="op" id="1702245">&gt;=</span>&nbsp;<span class="builtinfunc" id="1702248">len</span><span class="op" id="1702251">(</span><span class="ident" id="1702252">sig</span><span class="op" id="1702255">.</span><span class="ident" id="1702256">wanted</span><span class="op" id="1702262">)</span><span class="op" id="1702263">*</span><span class="num" id="1702264">32</span>&nbsp;<span class="op" id="1702267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702271">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702282">sig</span><span class="op" id="1702285">.</span><span class="ident" id="1702286">wanted</span><span class="op" id="1702292">[</span><span class="ident" id="1702293">s</span><span class="op" id="1702294">/</span><span class="num" id="1702295">32</span><span class="op" id="1702297">]</span>&nbsp;<span class="op" id="1702299">|=</span>&nbsp;<span class="num" id="1702302">1</span>&nbsp;<span class="op" id="1702304">&lt;&lt;</span>&nbsp;<span class="op" id="1702307">(</span><span class="ident" id="1702308">s</span>&nbsp;<span class="op" id="1702310">&amp;</span>&nbsp;<span class="num" id="1702312">31</span><span class="op" id="1702314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702317">sigenable_go</span><span class="op" id="1702329">(</span><span class="ident" id="1702330">s</span><span class="op" id="1702331">)</span><br>
<span class="lineno"></span><span class="op" id="1702333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1702336">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1702394">func</span>&nbsp;<span class="ident" id="1702399">signal_disable</span><span class="op" id="1702413">(</span><span class="ident" id="1702414">s</span>&nbsp;<span class="builtintype" id="1702416">uint32</span><span class="op" id="1702422">)</span>&nbsp;<span class="op" id="1702424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702427">if</span>&nbsp;<span class="builtintype" id="1702430">int</span><span class="op" id="1702433">(</span><span class="ident" id="1702434">s</span><span class="op" id="1702435">)</span>&nbsp;<span class="op" id="1702437">&gt;=</span>&nbsp;<span class="builtinfunc" id="1702440">len</span><span class="op" id="1702443">(</span><span class="ident" id="1702444">sig</span><span class="op" id="1702447">.</span><span class="ident" id="1702448">wanted</span><span class="op" id="1702454">)</span><span class="op" id="1702455">*</span><span class="num" id="1702456">32</span>&nbsp;<span class="op" id="1702459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1702463">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1702471">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702474">sig</span><span class="op" id="1702477">.</span><span class="ident" id="1702478">wanted</span><span class="op" id="1702484">[</span><span class="ident" id="1702485">s</span><span class="op" id="1702486">/</span><span class="num" id="1702487">32</span><span class="op" id="1702489">]</span>&nbsp;<span class="op" id="1702491">&amp;^=</span>&nbsp;<span class="num" id="1702495">1</span>&nbsp;<span class="op" id="1702497">&lt;&lt;</span>&nbsp;<span class="op" id="1702500">(</span><span class="ident" id="1702501">s</span>&nbsp;<span class="op" id="1702503">&amp;</span>&nbsp;<span class="num" id="1702505">31</span><span class="op" id="1702507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702510">sigdisable_go</span><span class="op" id="1702523">(</span><span class="ident" id="1702524">s</span><span class="op" id="1702525">)</span><br>
<span class="lineno"></span><span class="op" id="1702527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1702530">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1702601">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1702614">func</span>&nbsp;<span class="ident" id="1702619">badsignal</span><span class="op" id="1702628">(</span><span class="ident" id="1702629">sig</span>&nbsp;<span class="builtintype" id="1702633">uintptr</span><span class="op" id="1702640">)</span>&nbsp;<span class="op" id="1702642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702645">cgocallback</span><span class="op" id="1702656">(</span><span class="ident" id="1702657">unsafe</span><span class="op" id="1702663">.</span><span class="ident" id="1702664">Pointer</span><span class="op" id="1702671">(</span><span class="ident" id="1702672">funcPC</span><span class="op" id="1702678">(</span><span class="ident" id="1702679">sigsend</span><span class="op" id="1702686">)</span><span class="op" id="1702687">)</span><span class="op" id="1702688">,</span>&nbsp;<span class="ident" id="1702690">noescape</span><span class="op" id="1702698">(</span><span class="ident" id="1702699">unsafe</span><span class="op" id="1702705">.</span><span class="ident" id="1702706">Pointer</span><span class="op" id="1702713">(</span><span class="op" id="1702714">&amp;</span><span class="ident" id="1702715">sig</span><span class="op" id="1702718">)</span><span class="op" id="1702719">)</span><span class="op" id="1702720">,</span>&nbsp;<span class="ident" id="1702722">unsafe</span><span class="op" id="1702728">.</span><span class="ident" id="1702729">Sizeof</span><span class="op" id="1702735">(</span><span class="ident" id="1702736">sig</span><span class="op" id="1702739">)</span><span class="op" id="1702740">)</span><br>
<span class="lineno"></span><span class="op" id="1702742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1702745">func</span>&nbsp;<span class="ident" id="1702750">sigenable_m</span><span class="op" id="1702761">(</span><span class="op" id="1702762">)</span><br>
<span class="lineno"></span><span class="keyword" id="1702764">func</span>&nbsp;<span class="ident" id="1702769">sigdisable_m</span><span class="op" id="1702781">(</span><span class="op" id="1702782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1702785">func</span>&nbsp;<span class="ident" id="1702790">sigenable_go</span><span class="op" id="1702802">(</span><span class="ident" id="1702803">s</span>&nbsp;<span class="builtintype" id="1702805">uint32</span><span class="op" id="1702811">)</span>&nbsp;<span class="op" id="1702813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702816">g</span>&nbsp;<span class="op" id="1702818">:=</span>&nbsp;<span class="ident" id="1702821">getg</span><span class="op" id="1702825">(</span><span class="op" id="1702826">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702829">g</span><span class="op" id="1702830">.</span><span class="ident" id="1702831">m</span><span class="op" id="1702832">.</span><span class="ident" id="1702833">scalararg</span><span class="op" id="1702842">[</span><span class="num" id="1702843">0</span><span class="op" id="1702844">]</span>&nbsp;<span class="op" id="1702846">=</span>&nbsp;<span class="builtintype" id="1702848">uintptr</span><span class="op" id="1702855">(</span><span class="ident" id="1702856">s</span><span class="op" id="1702857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702860">onM</span><span class="op" id="1702863">(</span><span class="ident" id="1702864">sigenable_m</span><span class="op" id="1702875">)</span><br>
<span class="lineno"></span><span class="op" id="1702877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1702880">func</span>&nbsp;<span class="ident" id="1702885">sigdisable_go</span><span class="op" id="1702898">(</span><span class="ident" id="1702899">s</span>&nbsp;<span class="builtintype" id="1702901">uint32</span><span class="op" id="1702907">)</span>&nbsp;<span class="op" id="1702909">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702912">g</span>&nbsp;<span class="op" id="1702914">:=</span>&nbsp;<span class="ident" id="1702917">getg</span><span class="op" id="1702921">(</span><span class="op" id="1702922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702925">g</span><span class="op" id="1702926">.</span><span class="ident" id="1702927">m</span><span class="op" id="1702928">.</span><span class="ident" id="1702929">scalararg</span><span class="op" id="1702938">[</span><span class="num" id="1702939">0</span><span class="op" id="1702940">]</span>&nbsp;<span class="op" id="1702942">=</span>&nbsp;<span class="builtintype" id="1702944">uintptr</span><span class="op" id="1702951">(</span><span class="ident" id="1702952">s</span><span class="op" id="1702953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1702956">onM</span><span class="op" id="1702959">(</span><span class="ident" id="1702960">sigdisable_m</span><span class="op" id="1702972">)</span><br>
<span class="lineno"></span><span class="op" id="1702974">}</span>
</div>
</body>
</html>
