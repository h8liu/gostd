<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2971858">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2971913">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2971967">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2972018">package</span>&nbsp;<span class="ident" id="2972026">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2972033">import</span>&nbsp;<span class="op" id="2972040">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2972043">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2972050">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2972056">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="2972063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2972066">const</span>&nbsp;<span class="op" id="2972072">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972075">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972094">=</span>&nbsp;<span class="num" id="2972096">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972099">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972118">=</span>&nbsp;<span class="num" id="2972120">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972123">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972142">=</span>&nbsp;<span class="num" id="2972144">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972147">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972166">=</span>&nbsp;<span class="num" id="2972168">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972171">DefaultCompression</span>&nbsp;<span class="op" id="2972190">=</span>&nbsp;<span class="op" id="2972192">-</span><span class="num" id="2972193">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972196">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972215">=</span>&nbsp;<span class="num" id="2972217">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972221">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972240">=</span>&nbsp;<span class="num" id="2972242">1</span>&nbsp;<span class="op" id="2972244">&lt;&lt;</span>&nbsp;<span class="ident" id="2972247">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972262">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972281">=</span>&nbsp;<span class="ident" id="2972283">windowSize</span>&nbsp;<span class="op" id="2972294">-</span>&nbsp;<span class="num" id="2972296">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972299">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2972318">=</span>&nbsp;<span class="num" id="2972320">15</span>&nbsp;&nbsp;<span class="comment" id="2972324">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972345">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972364">=</span>&nbsp;<span class="num" id="2972366">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2972370">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972423">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972442">=</span>&nbsp;<span class="num" id="2972444">258</span>&nbsp;<span class="comment" id="2972448">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972489">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972508">=</span>&nbsp;<span class="num" id="2972510">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2972514">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2972560">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2972635">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972675">maxFlateBlockTokens</span>&nbsp;<span class="op" id="2972695">=</span>&nbsp;<span class="num" id="2972697">1</span>&nbsp;<span class="op" id="2972699">&lt;&lt;</span>&nbsp;<span class="num" id="2972702">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972706">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2972726">=</span>&nbsp;<span class="num" id="2972728">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972735">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972755">=</span>&nbsp;<span class="num" id="2972757">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972761">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972781">=</span>&nbsp;<span class="num" id="2972783">1</span>&nbsp;<span class="op" id="2972785">&lt;&lt;</span>&nbsp;<span class="ident" id="2972788">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972798">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972818">=</span>&nbsp;<span class="op" id="2972820">(</span><span class="num" id="2972821">1</span>&nbsp;<span class="op" id="2972823">&lt;&lt;</span>&nbsp;<span class="ident" id="2972826">hashBits</span><span class="op" id="2972834">)</span>&nbsp;<span class="op" id="2972836">-</span>&nbsp;<span class="num" id="2972838">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972841">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972861">=</span>&nbsp;<span class="op" id="2972863">(</span><span class="ident" id="2972864">hashBits</span>&nbsp;<span class="op" id="2972873">+</span>&nbsp;<span class="ident" id="2972875">minMatchLength</span>&nbsp;<span class="op" id="2972890">-</span>&nbsp;<span class="num" id="2972892">1</span><span class="op" id="2972893">)</span>&nbsp;<span class="op" id="2972895">/</span>&nbsp;<span class="ident" id="2972897">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972913">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972933">=</span>&nbsp;<span class="num" id="2972935">1</span>&nbsp;<span class="op" id="2972937">&lt;&lt;</span>&nbsp;<span class="num" id="2972940">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2972945">skipNever</span>&nbsp;<span class="op" id="2972955">=</span>&nbsp;<span class="ident" id="2972957">math</span><span class="op" id="2972961">.</span><span class="ident" id="2972962">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="2972971">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="2972974">type</span>&nbsp;<span class="ident" id="2972979">compressionLevel</span>&nbsp;<span class="keyword" id="2972996">struct</span>&nbsp;<span class="op" id="2973003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2973006">good</span><span class="op" id="2973010">,</span>&nbsp;<span class="ident" id="2973012">lazy</span><span class="op" id="2973016">,</span>&nbsp;<span class="ident" id="2973018">nice</span><span class="op" id="2973022">,</span>&nbsp;<span class="ident" id="2973024">chain</span><span class="op" id="2973029">,</span>&nbsp;<span class="ident" id="2973031">fastSkipHashing</span>&nbsp;<span class="builtintype" id="2973047">int</span><br>
<span class="lineno"></span><span class="op" id="2973051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2973054">var</span>&nbsp;<span class="ident" id="2973058">levels</span>&nbsp;<span class="op" id="2973065">=</span>&nbsp;<span class="op" id="2973067">[</span><span class="op" id="2973068">]</span><span class="ident" id="2973069">compressionLevel</span><span class="op" id="2973085">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973088">{</span><span class="op" id="2973089">}</span><span class="op" id="2973090">,</span>&nbsp;<span class="comment" id="2973092">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973098">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973158">{</span><span class="num" id="2973159">3</span><span class="op" id="2973160">,</span>&nbsp;<span class="num" id="2973162">0</span><span class="op" id="2973163">,</span>&nbsp;<span class="num" id="2973165">8</span><span class="op" id="2973166">,</span>&nbsp;<span class="num" id="2973168">4</span><span class="op" id="2973169">,</span>&nbsp;<span class="num" id="2973171">4</span><span class="op" id="2973172">}</span><span class="op" id="2973173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973176">{</span><span class="num" id="2973177">3</span><span class="op" id="2973178">,</span>&nbsp;<span class="num" id="2973180">0</span><span class="op" id="2973181">,</span>&nbsp;<span class="num" id="2973183">16</span><span class="op" id="2973185">,</span>&nbsp;<span class="num" id="2973187">8</span><span class="op" id="2973188">,</span>&nbsp;<span class="num" id="2973190">5</span><span class="op" id="2973191">}</span><span class="op" id="2973192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973195">{</span><span class="num" id="2973196">3</span><span class="op" id="2973197">,</span>&nbsp;<span class="num" id="2973199">0</span><span class="op" id="2973200">,</span>&nbsp;<span class="num" id="2973202">32</span><span class="op" id="2973204">,</span>&nbsp;<span class="num" id="2973206">32</span><span class="op" id="2973208">,</span>&nbsp;<span class="num" id="2973210">6</span><span class="op" id="2973211">}</span><span class="op" id="2973212">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973215">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973266">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973327">{</span><span class="num" id="2973328">4</span><span class="op" id="2973329">,</span>&nbsp;<span class="num" id="2973331">4</span><span class="op" id="2973332">,</span>&nbsp;<span class="num" id="2973334">16</span><span class="op" id="2973336">,</span>&nbsp;<span class="num" id="2973338">16</span><span class="op" id="2973340">,</span>&nbsp;<span class="ident" id="2973342">skipNever</span><span class="op" id="2973351">}</span><span class="op" id="2973352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973355">{</span><span class="num" id="2973356">8</span><span class="op" id="2973357">,</span>&nbsp;<span class="num" id="2973359">16</span><span class="op" id="2973361">,</span>&nbsp;<span class="num" id="2973363">32</span><span class="op" id="2973365">,</span>&nbsp;<span class="num" id="2973367">32</span><span class="op" id="2973369">,</span>&nbsp;<span class="ident" id="2973371">skipNever</span><span class="op" id="2973380">}</span><span class="op" id="2973381">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973384">{</span><span class="num" id="2973385">8</span><span class="op" id="2973386">,</span>&nbsp;<span class="num" id="2973388">16</span><span class="op" id="2973390">,</span>&nbsp;<span class="num" id="2973392">128</span><span class="op" id="2973395">,</span>&nbsp;<span class="num" id="2973397">128</span><span class="op" id="2973400">,</span>&nbsp;<span class="ident" id="2973402">skipNever</span><span class="op" id="2973411">}</span><span class="op" id="2973412">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973415">{</span><span class="num" id="2973416">8</span><span class="op" id="2973417">,</span>&nbsp;<span class="num" id="2973419">32</span><span class="op" id="2973421">,</span>&nbsp;<span class="num" id="2973423">128</span><span class="op" id="2973426">,</span>&nbsp;<span class="num" id="2973428">256</span><span class="op" id="2973431">,</span>&nbsp;<span class="ident" id="2973433">skipNever</span><span class="op" id="2973442">}</span><span class="op" id="2973443">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973446">{</span><span class="num" id="2973447">32</span><span class="op" id="2973449">,</span>&nbsp;<span class="num" id="2973451">128</span><span class="op" id="2973454">,</span>&nbsp;<span class="num" id="2973456">258</span><span class="op" id="2973459">,</span>&nbsp;<span class="num" id="2973461">1024</span><span class="op" id="2973465">,</span>&nbsp;<span class="ident" id="2973467">skipNever</span><span class="op" id="2973476">}</span><span class="op" id="2973477">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2973480">{</span><span class="num" id="2973481">32</span><span class="op" id="2973483">,</span>&nbsp;<span class="num" id="2973485">258</span><span class="op" id="2973488">,</span>&nbsp;<span class="num" id="2973490">258</span><span class="op" id="2973493">,</span>&nbsp;<span class="num" id="2973495">4096</span><span class="op" id="2973499">,</span>&nbsp;<span class="ident" id="2973501">skipNever</span><span class="op" id="2973510">}</span><span class="op" id="2973511">,</span><br>
<span class="lineno"></span><span class="op" id="2973513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="2973516">type</span>&nbsp;<span class="ident" id="2973521">compressor</span>&nbsp;<span class="keyword" id="2973532">struct</span>&nbsp;<span class="op" id="2973539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2973542">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2973561">w</span>&nbsp;<span class="op" id="2973563">*</span><span class="ident" id="2973564">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973583">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2973609">fill</span>&nbsp;<span class="keyword" id="2973614">func</span><span class="op" id="2973618">(</span><span class="op" id="2973619">*</span><span class="ident" id="2973620">compressor</span><span class="op" id="2973630">,</span>&nbsp;<span class="op" id="2973632">[</span><span class="op" id="2973633">]</span><span class="builtintype" id="2973634">byte</span><span class="op" id="2973638">)</span>&nbsp;<span class="builtintype" id="2973640">int</span>&nbsp;<span class="comment" id="2973644">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2973668">step</span>&nbsp;<span class="keyword" id="2973673">func</span><span class="op" id="2973677">(</span><span class="op" id="2973678">*</span><span class="ident" id="2973679">compressor</span><span class="op" id="2973689">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2973703">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2973722">sync</span>&nbsp;<span class="builtintype" id="2973727">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2973757">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973779">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973801">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973887">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2973949">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2974024">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974054">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="2974065">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974070">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2974081">[</span><span class="op" id="2974082">]</span><span class="builtintype" id="2974083">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974088">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2974099">[</span><span class="op" id="2974100">]</span><span class="builtintype" id="2974101">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974106">hashOffset</span>&nbsp;<span class="builtintype" id="2974117">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2974123">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974185">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974199">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974204">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2974218">[</span><span class="op" id="2974219">]</span><span class="builtintype" id="2974220">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974226">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974240">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974245">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974259">int</span>&nbsp;&nbsp;<span class="comment" id="2974264">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974308">byteAvailable</span>&nbsp;<span class="builtintype" id="2974322">bool</span>&nbsp;<span class="comment" id="2974327">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2974380">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974405">tokens</span>&nbsp;<span class="op" id="2974412">[</span><span class="op" id="2974413">]</span><span class="ident" id="2974414">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2974422">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974440">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974455">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974460">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974475">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974480">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974495">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974500">maxInsertIndex</span>&nbsp;<span class="builtintype" id="2974515">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974520">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2974535">error</span><br>
<span class="lineno"></span><span class="op" id="2974541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2974544">func</span>&nbsp;<span class="op" id="2974549">(</span><span class="ident" id="2974550">d</span>&nbsp;<span class="op" id="2974552">*</span><span class="ident" id="2974553">compressor</span><span class="op" id="2974563">)</span>&nbsp;<span class="ident" id="2974565">fillDeflate</span><span class="op" id="2974576">(</span><span class="ident" id="2974577">b</span>&nbsp;<span class="op" id="2974579">[</span><span class="op" id="2974580">]</span><span class="builtintype" id="2974581">byte</span><span class="op" id="2974585">)</span>&nbsp;<span class="builtintype" id="2974587">int</span>&nbsp;<span class="op" id="2974591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2974594">if</span>&nbsp;<span class="ident" id="2974597">d</span><span class="op" id="2974598">.</span><span class="ident" id="2974599">index</span>&nbsp;<span class="op" id="2974605">&gt;=</span>&nbsp;<span class="num" id="2974608">2</span><span class="op" id="2974609">*</span><span class="ident" id="2974610">windowSize</span><span class="op" id="2974620">-</span><span class="op" id="2974621">(</span><span class="ident" id="2974622">minMatchLength</span><span class="op" id="2974636">+</span><span class="ident" id="2974637">maxMatchLength</span><span class="op" id="2974651">)</span>&nbsp;<span class="op" id="2974653">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2974657">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2974693">copy</span><span class="op" id="2974697">(</span><span class="ident" id="2974698">d</span><span class="op" id="2974699">.</span><span class="ident" id="2974700">window</span><span class="op" id="2974706">,</span>&nbsp;<span class="ident" id="2974708">d</span><span class="op" id="2974709">.</span><span class="ident" id="2974710">window</span><span class="op" id="2974716">[</span><span class="ident" id="2974717">windowSize</span><span class="op" id="2974727">:</span><span class="num" id="2974728">2</span><span class="op" id="2974729">*</span><span class="ident" id="2974730">windowSize</span><span class="op" id="2974740">]</span><span class="op" id="2974741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974745">d</span><span class="op" id="2974746">.</span><span class="ident" id="2974747">index</span>&nbsp;<span class="op" id="2974753">-=</span>&nbsp;<span class="ident" id="2974756">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974769">d</span><span class="op" id="2974770">.</span><span class="ident" id="2974771">windowEnd</span>&nbsp;<span class="op" id="2974781">-=</span>&nbsp;<span class="ident" id="2974784">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2974797">if</span>&nbsp;<span class="ident" id="2974800">d</span><span class="op" id="2974801">.</span><span class="ident" id="2974802">blockStart</span>&nbsp;<span class="op" id="2974813">&gt;=</span>&nbsp;<span class="ident" id="2974816">windowSize</span>&nbsp;<span class="op" id="2974827">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974832">d</span><span class="op" id="2974833">.</span><span class="ident" id="2974834">blockStart</span>&nbsp;<span class="op" id="2974845">-=</span>&nbsp;<span class="ident" id="2974848">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2974861">}</span>&nbsp;<span class="keyword" id="2974863">else</span>&nbsp;<span class="op" id="2974868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974873">d</span><span class="op" id="2974874">.</span><span class="ident" id="2974875">blockStart</span>&nbsp;<span class="op" id="2974886">=</span>&nbsp;<span class="ident" id="2974888">math</span><span class="op" id="2974892">.</span><span class="ident" id="2974893">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2974904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974908">d</span><span class="op" id="2974909">.</span><span class="ident" id="2974910">hashOffset</span>&nbsp;<span class="op" id="2974921">+=</span>&nbsp;<span class="ident" id="2974924">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2974937">if</span>&nbsp;<span class="ident" id="2974940">d</span><span class="op" id="2974941">.</span><span class="ident" id="2974942">hashOffset</span>&nbsp;<span class="op" id="2974953">&gt;</span>&nbsp;<span class="ident" id="2974955">maxHashOffset</span>&nbsp;<span class="op" id="2974969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2974974">delta</span>&nbsp;<span class="op" id="2974980">:=</span>&nbsp;<span class="ident" id="2974983">d</span><span class="op" id="2974984">.</span><span class="ident" id="2974985">hashOffset</span>&nbsp;<span class="op" id="2974996">-</span>&nbsp;<span class="num" id="2974998">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975003">d</span><span class="op" id="2975004">.</span><span class="ident" id="2975005">hashOffset</span>&nbsp;<span class="op" id="2975016">-=</span>&nbsp;<span class="ident" id="2975019">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975028">d</span><span class="op" id="2975029">.</span><span class="ident" id="2975030">chainHead</span>&nbsp;<span class="op" id="2975040">-=</span>&nbsp;<span class="ident" id="2975043">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975052">for</span>&nbsp;<span class="ident" id="2975056">i</span><span class="op" id="2975057">,</span>&nbsp;<span class="ident" id="2975059">v</span>&nbsp;<span class="op" id="2975061">:=</span>&nbsp;<span class="keyword" id="2975064">range</span>&nbsp;<span class="ident" id="2975070">d</span><span class="op" id="2975071">.</span><span class="ident" id="2975072">hashPrev</span>&nbsp;<span class="op" id="2975081">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975087">if</span>&nbsp;<span class="ident" id="2975090">v</span>&nbsp;<span class="op" id="2975092">&gt;</span>&nbsp;<span class="ident" id="2975094">delta</span>&nbsp;<span class="op" id="2975100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975107">d</span><span class="op" id="2975108">.</span><span class="ident" id="2975109">hashPrev</span><span class="op" id="2975117">[</span><span class="ident" id="2975118">i</span><span class="op" id="2975119">]</span>&nbsp;<span class="op" id="2975121">-=</span>&nbsp;<span class="ident" id="2975124">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975134">}</span>&nbsp;<span class="keyword" id="2975136">else</span>&nbsp;<span class="op" id="2975141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975148">d</span><span class="op" id="2975149">.</span><span class="ident" id="2975150">hashPrev</span><span class="op" id="2975158">[</span><span class="ident" id="2975159">i</span><span class="op" id="2975160">]</span>&nbsp;<span class="op" id="2975162">=</span>&nbsp;<span class="num" id="2975164">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975170">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975180">for</span>&nbsp;<span class="ident" id="2975184">i</span><span class="op" id="2975185">,</span>&nbsp;<span class="ident" id="2975187">v</span>&nbsp;<span class="op" id="2975189">:=</span>&nbsp;<span class="keyword" id="2975192">range</span>&nbsp;<span class="ident" id="2975198">d</span><span class="op" id="2975199">.</span><span class="ident" id="2975200">hashHead</span>&nbsp;<span class="op" id="2975209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975215">if</span>&nbsp;<span class="ident" id="2975218">v</span>&nbsp;<span class="op" id="2975220">&gt;</span>&nbsp;<span class="ident" id="2975222">delta</span>&nbsp;<span class="op" id="2975228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975235">d</span><span class="op" id="2975236">.</span><span class="ident" id="2975237">hashHead</span><span class="op" id="2975245">[</span><span class="ident" id="2975246">i</span><span class="op" id="2975247">]</span>&nbsp;<span class="op" id="2975249">-=</span>&nbsp;<span class="ident" id="2975252">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975262">}</span>&nbsp;<span class="keyword" id="2975264">else</span>&nbsp;<span class="op" id="2975269">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975276">d</span><span class="op" id="2975277">.</span><span class="ident" id="2975278">hashHead</span><span class="op" id="2975286">[</span><span class="ident" id="2975287">i</span><span class="op" id="2975288">]</span>&nbsp;<span class="op" id="2975290">=</span>&nbsp;<span class="num" id="2975292">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975310">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975313">n</span>&nbsp;<span class="op" id="2975315">:=</span>&nbsp;<span class="builtinfunc" id="2975318">copy</span><span class="op" id="2975322">(</span><span class="ident" id="2975323">d</span><span class="op" id="2975324">.</span><span class="ident" id="2975325">window</span><span class="op" id="2975331">[</span><span class="ident" id="2975332">d</span><span class="op" id="2975333">.</span><span class="ident" id="2975334">windowEnd</span><span class="op" id="2975343">:</span><span class="op" id="2975344">]</span><span class="op" id="2975345">,</span>&nbsp;<span class="ident" id="2975347">b</span><span class="op" id="2975348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975351">d</span><span class="op" id="2975352">.</span><span class="ident" id="2975353">windowEnd</span>&nbsp;<span class="op" id="2975363">+=</span>&nbsp;<span class="ident" id="2975366">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975369">return</span>&nbsp;<span class="ident" id="2975376">n</span><br>
<span class="lineno"></span><span class="op" id="2975378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="2975381">func</span>&nbsp;<span class="op" id="2975386">(</span><span class="ident" id="2975387">d</span>&nbsp;<span class="op" id="2975389">*</span><span class="ident" id="2975390">compressor</span><span class="op" id="2975400">)</span>&nbsp;<span class="ident" id="2975402">writeBlock</span><span class="op" id="2975412">(</span><span class="ident" id="2975413">tokens</span>&nbsp;<span class="op" id="2975420">[</span><span class="op" id="2975421">]</span><span class="ident" id="2975422">token</span><span class="op" id="2975427">,</span>&nbsp;<span class="ident" id="2975429">index</span>&nbsp;<span class="builtintype" id="2975435">int</span><span class="op" id="2975438">,</span>&nbsp;<span class="ident" id="2975440">eof</span>&nbsp;<span class="builtintype" id="2975444">bool</span><span class="op" id="2975448">)</span>&nbsp;<span class="builtintype" id="2975450">error</span>&nbsp;<span class="op" id="2975456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975459">if</span>&nbsp;<span class="ident" id="2975462">index</span>&nbsp;<span class="op" id="2975468">&gt;</span>&nbsp;<span class="num" id="2975470">0</span>&nbsp;<span class="op" id="2975472">||</span>&nbsp;<span class="ident" id="2975475">eof</span>&nbsp;<span class="op" id="2975479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975483">var</span>&nbsp;<span class="ident" id="2975487">window</span>&nbsp;<span class="op" id="2975494">[</span><span class="op" id="2975495">]</span><span class="builtintype" id="2975496">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975503">if</span>&nbsp;<span class="ident" id="2975506">d</span><span class="op" id="2975507">.</span><span class="ident" id="2975508">blockStart</span>&nbsp;<span class="op" id="2975519">&lt;=</span>&nbsp;<span class="ident" id="2975522">index</span>&nbsp;<span class="op" id="2975528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975533">window</span>&nbsp;<span class="op" id="2975540">=</span>&nbsp;<span class="ident" id="2975542">d</span><span class="op" id="2975543">.</span><span class="ident" id="2975544">window</span><span class="op" id="2975550">[</span><span class="ident" id="2975551">d</span><span class="op" id="2975552">.</span><span class="ident" id="2975553">blockStart</span><span class="op" id="2975563">:</span><span class="ident" id="2975564">index</span><span class="op" id="2975569">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975577">d</span><span class="op" id="2975578">.</span><span class="ident" id="2975579">blockStart</span>&nbsp;<span class="op" id="2975590">=</span>&nbsp;<span class="ident" id="2975592">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975600">d</span><span class="op" id="2975601">.</span><span class="ident" id="2975602">w</span><span class="op" id="2975603">.</span><span class="ident" id="2975604">writeBlock</span><span class="op" id="2975614">(</span><span class="ident" id="2975615">tokens</span><span class="op" id="2975621">,</span>&nbsp;<span class="ident" id="2975623">eof</span><span class="op" id="2975626">,</span>&nbsp;<span class="ident" id="2975628">window</span><span class="op" id="2975634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975638">return</span>&nbsp;<span class="ident" id="2975645">d</span><span class="op" id="2975646">.</span><span class="ident" id="2975647">w</span><span class="op" id="2975648">.</span><span class="ident" id="2975649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2975654">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975657">return</span>&nbsp;<span class="ident" id="2975664">nil</span><br>
<span class="lineno"></span><span class="op" id="2975668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2975671">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="2975751">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="2975813">func</span>&nbsp;<span class="op" id="2975818">(</span><span class="ident" id="2975819">d</span>&nbsp;<span class="op" id="2975821">*</span><span class="ident" id="2975822">compressor</span><span class="op" id="2975832">)</span>&nbsp;<span class="ident" id="2975834">findMatch</span><span class="op" id="2975843">(</span><span class="ident" id="2975844">pos</span>&nbsp;<span class="builtintype" id="2975848">int</span><span class="op" id="2975851">,</span>&nbsp;<span class="ident" id="2975853">prevHead</span>&nbsp;<span class="builtintype" id="2975862">int</span><span class="op" id="2975865">,</span>&nbsp;<span class="ident" id="2975867">prevLength</span>&nbsp;<span class="builtintype" id="2975878">int</span><span class="op" id="2975881">,</span>&nbsp;<span class="ident" id="2975883">lookahead</span>&nbsp;<span class="builtintype" id="2975893">int</span><span class="op" id="2975896">)</span>&nbsp;<span class="op" id="2975898">(</span><span class="ident" id="2975899">length</span><span class="op" id="2975905">,</span>&nbsp;<span class="ident" id="2975907">offset</span>&nbsp;<span class="builtintype" id="2975914">int</span><span class="op" id="2975917">,</span>&nbsp;<span class="ident" id="2975919">ok</span>&nbsp;<span class="builtintype" id="2975922">bool</span><span class="op" id="2975926">)</span>&nbsp;<span class="op" id="2975928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975931">minMatchLook</span>&nbsp;<span class="op" id="2975944">:=</span>&nbsp;<span class="ident" id="2975947">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2975963">if</span>&nbsp;<span class="ident" id="2975966">lookahead</span>&nbsp;<span class="op" id="2975976">&lt;</span>&nbsp;<span class="ident" id="2975978">minMatchLook</span>&nbsp;<span class="op" id="2975991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2975995">minMatchLook</span>&nbsp;<span class="op" id="2976008">=</span>&nbsp;<span class="ident" id="2976010">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976021">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976025">win</span>&nbsp;<span class="op" id="2976029">:=</span>&nbsp;<span class="ident" id="2976032">d</span><span class="op" id="2976033">.</span><span class="ident" id="2976034">window</span><span class="op" id="2976040">[</span><span class="num" id="2976041">0</span>&nbsp;<span class="op" id="2976043">:</span>&nbsp;<span class="ident" id="2976045">pos</span><span class="op" id="2976048">+</span><span class="ident" id="2976049">minMatchLook</span><span class="op" id="2976061">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2976065">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976123">nice</span>&nbsp;<span class="op" id="2976128">:=</span>&nbsp;<span class="builtinfunc" id="2976131">len</span><span class="op" id="2976134">(</span><span class="ident" id="2976135">win</span><span class="op" id="2976138">)</span>&nbsp;<span class="op" id="2976140">-</span>&nbsp;<span class="ident" id="2976142">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976147">if</span>&nbsp;<span class="ident" id="2976150">d</span><span class="op" id="2976151">.</span><span class="ident" id="2976152">nice</span>&nbsp;<span class="op" id="2976157">&lt;</span>&nbsp;<span class="ident" id="2976159">nice</span>&nbsp;<span class="op" id="2976164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976168">nice</span>&nbsp;<span class="op" id="2976173">=</span>&nbsp;<span class="ident" id="2976175">d</span><span class="op" id="2976176">.</span><span class="ident" id="2976177">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2976187">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976260">tries</span>&nbsp;<span class="op" id="2976266">:=</span>&nbsp;<span class="ident" id="2976269">d</span><span class="op" id="2976270">.</span><span class="ident" id="2976271">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976278">length</span>&nbsp;<span class="op" id="2976285">=</span>&nbsp;<span class="ident" id="2976287">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976299">if</span>&nbsp;<span class="ident" id="2976302">length</span>&nbsp;<span class="op" id="2976309">&gt;=</span>&nbsp;<span class="ident" id="2976312">d</span><span class="op" id="2976313">.</span><span class="ident" id="2976314">good</span>&nbsp;<span class="op" id="2976319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976323">tries</span>&nbsp;<span class="op" id="2976329">&gt;&gt;=</span>&nbsp;<span class="num" id="2976333">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976336">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976340">w0</span>&nbsp;<span class="op" id="2976343">:=</span>&nbsp;<span class="ident" id="2976346">win</span><span class="op" id="2976349">[</span><span class="ident" id="2976350">pos</span><span class="op" id="2976353">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976356">w1</span>&nbsp;<span class="op" id="2976359">:=</span>&nbsp;<span class="ident" id="2976362">win</span><span class="op" id="2976365">[</span><span class="ident" id="2976366">pos</span><span class="op" id="2976369">+</span><span class="num" id="2976370">1</span><span class="op" id="2976371">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976374">wEnd</span>&nbsp;<span class="op" id="2976379">:=</span>&nbsp;<span class="ident" id="2976382">win</span><span class="op" id="2976385">[</span><span class="ident" id="2976386">pos</span><span class="op" id="2976389">+</span><span class="ident" id="2976390">length</span><span class="op" id="2976396">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976399">minIndex</span>&nbsp;<span class="op" id="2976408">:=</span>&nbsp;<span class="ident" id="2976411">pos</span>&nbsp;<span class="op" id="2976415">-</span>&nbsp;<span class="ident" id="2976417">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976430">for</span>&nbsp;<span class="ident" id="2976434">i</span>&nbsp;<span class="op" id="2976436">:=</span>&nbsp;<span class="ident" id="2976439">prevHead</span><span class="op" id="2976447">;</span>&nbsp;<span class="ident" id="2976449">tries</span>&nbsp;<span class="op" id="2976455">&gt;</span>&nbsp;<span class="num" id="2976457">0</span><span class="op" id="2976458">;</span>&nbsp;<span class="ident" id="2976460">tries</span><span class="op" id="2976465">--</span>&nbsp;<span class="op" id="2976468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976472">if</span>&nbsp;<span class="ident" id="2976475">w0</span>&nbsp;<span class="op" id="2976478">==</span>&nbsp;<span class="ident" id="2976481">win</span><span class="op" id="2976484">[</span><span class="ident" id="2976485">i</span><span class="op" id="2976486">]</span>&nbsp;<span class="op" id="2976488">&amp;&amp;</span>&nbsp;<span class="ident" id="2976491">w1</span>&nbsp;<span class="op" id="2976494">==</span>&nbsp;<span class="ident" id="2976497">win</span><span class="op" id="2976500">[</span><span class="ident" id="2976501">i</span><span class="op" id="2976502">+</span><span class="num" id="2976503">1</span><span class="op" id="2976504">]</span>&nbsp;<span class="op" id="2976506">&amp;&amp;</span>&nbsp;<span class="ident" id="2976509">wEnd</span>&nbsp;<span class="op" id="2976514">==</span>&nbsp;<span class="ident" id="2976517">win</span><span class="op" id="2976520">[</span><span class="ident" id="2976521">i</span><span class="op" id="2976522">+</span><span class="ident" id="2976523">length</span><span class="op" id="2976529">]</span>&nbsp;<span class="op" id="2976531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2976536">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976621">n</span>&nbsp;<span class="op" id="2976623">:=</span>&nbsp;<span class="num" id="2976626">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976631">for</span>&nbsp;<span class="ident" id="2976635">pos</span><span class="op" id="2976638">+</span><span class="ident" id="2976639">n</span>&nbsp;<span class="op" id="2976641">&lt;</span>&nbsp;<span class="builtinfunc" id="2976643">len</span><span class="op" id="2976646">(</span><span class="ident" id="2976647">win</span><span class="op" id="2976650">)</span>&nbsp;<span class="op" id="2976652">&amp;&amp;</span>&nbsp;<span class="ident" id="2976655">win</span><span class="op" id="2976658">[</span><span class="ident" id="2976659">i</span><span class="op" id="2976660">+</span><span class="ident" id="2976661">n</span><span class="op" id="2976662">]</span>&nbsp;<span class="op" id="2976664">==</span>&nbsp;<span class="ident" id="2976667">win</span><span class="op" id="2976670">[</span><span class="ident" id="2976671">pos</span><span class="op" id="2976674">+</span><span class="ident" id="2976675">n</span><span class="op" id="2976676">]</span>&nbsp;<span class="op" id="2976678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976684">n</span><span class="op" id="2976685">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976696">if</span>&nbsp;<span class="ident" id="2976699">n</span>&nbsp;<span class="op" id="2976701">&gt;</span>&nbsp;<span class="ident" id="2976703">length</span>&nbsp;<span class="op" id="2976710">&amp;&amp;</span>&nbsp;<span class="op" id="2976713">(</span><span class="ident" id="2976714">n</span>&nbsp;<span class="op" id="2976716">&gt;</span>&nbsp;<span class="num" id="2976718">3</span>&nbsp;<span class="op" id="2976720">||</span>&nbsp;<span class="ident" id="2976723">pos</span><span class="op" id="2976726">-</span><span class="ident" id="2976727">i</span>&nbsp;<span class="op" id="2976729">&lt;=</span>&nbsp;<span class="num" id="2976732">4096</span><span class="op" id="2976736">)</span>&nbsp;<span class="op" id="2976738">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976744">length</span>&nbsp;<span class="op" id="2976751">=</span>&nbsp;<span class="ident" id="2976753">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976759">offset</span>&nbsp;<span class="op" id="2976766">=</span>&nbsp;<span class="ident" id="2976768">pos</span>&nbsp;<span class="op" id="2976772">-</span>&nbsp;<span class="ident" id="2976774">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976780">ok</span>&nbsp;<span class="op" id="2976783">=</span>&nbsp;<span class="builtintype" id="2976785">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976794">if</span>&nbsp;<span class="ident" id="2976797">n</span>&nbsp;<span class="op" id="2976799">&gt;=</span>&nbsp;<span class="ident" id="2976802">nice</span>&nbsp;<span class="op" id="2976807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2976814">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976887">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2976903">wEnd</span>&nbsp;<span class="op" id="2976908">=</span>&nbsp;<span class="ident" id="2976910">win</span><span class="op" id="2976913">[</span><span class="ident" id="2976914">pos</span><span class="op" id="2976917">+</span><span class="ident" id="2976918">n</span><span class="op" id="2976919">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2976928">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2976932">if</span>&nbsp;<span class="ident" id="2976935">i</span>&nbsp;<span class="op" id="2976937">==</span>&nbsp;<span class="ident" id="2976940">minIndex</span>&nbsp;<span class="op" id="2976949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2976954">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977028">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2977036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977040">if</span>&nbsp;<span class="ident" id="2977043">i</span>&nbsp;<span class="op" id="2977045">=</span>&nbsp;<span class="ident" id="2977047">d</span><span class="op" id="2977048">.</span><span class="ident" id="2977049">hashPrev</span><span class="op" id="2977057">[</span><span class="ident" id="2977058">i</span><span class="op" id="2977059">&amp;</span><span class="ident" id="2977060">windowMask</span><span class="op" id="2977070">]</span>&nbsp;<span class="op" id="2977072">-</span>&nbsp;<span class="ident" id="2977074">d</span><span class="op" id="2977075">.</span><span class="ident" id="2977076">hashOffset</span><span class="op" id="2977086">;</span>&nbsp;<span class="ident" id="2977088">i</span>&nbsp;<span class="op" id="2977090">&lt;</span>&nbsp;<span class="ident" id="2977092">minIndex</span>&nbsp;<span class="op" id="2977101">||</span>&nbsp;<span class="ident" id="2977104">i</span>&nbsp;<span class="op" id="2977106">&lt;</span>&nbsp;<span class="num" id="2977108">0</span>&nbsp;<span class="op" id="2977110">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977115">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2977123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2977126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977129">return</span><br>
<span class="lineno"></span><span class="op" id="2977136">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="2977139">func</span>&nbsp;<span class="op" id="2977144">(</span><span class="ident" id="2977145">d</span>&nbsp;<span class="op" id="2977147">*</span><span class="ident" id="2977148">compressor</span><span class="op" id="2977158">)</span>&nbsp;<span class="ident" id="2977160">writeStoredBlock</span><span class="op" id="2977176">(</span><span class="ident" id="2977177">buf</span>&nbsp;<span class="op" id="2977181">[</span><span class="op" id="2977182">]</span><span class="builtintype" id="2977183">byte</span><span class="op" id="2977187">)</span>&nbsp;<span class="builtintype" id="2977189">error</span>&nbsp;<span class="op" id="2977195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977198">if</span>&nbsp;<span class="ident" id="2977201">d</span><span class="op" id="2977202">.</span><span class="ident" id="2977203">w</span><span class="op" id="2977204">.</span><span class="ident" id="2977205">writeStoredHeader</span><span class="op" id="2977222">(</span><span class="builtinfunc" id="2977223">len</span><span class="op" id="2977226">(</span><span class="ident" id="2977227">buf</span><span class="op" id="2977230">)</span><span class="op" id="2977231">,</span>&nbsp;<span class="builtintype" id="2977233">false</span><span class="op" id="2977238">)</span><span class="op" id="2977239">;</span>&nbsp;<span class="ident" id="2977241">d</span><span class="op" id="2977242">.</span><span class="ident" id="2977243">w</span><span class="op" id="2977244">.</span><span class="ident" id="2977245">err</span>&nbsp;<span class="op" id="2977249">!=</span>&nbsp;<span class="ident" id="2977252">nil</span>&nbsp;<span class="op" id="2977256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977260">return</span>&nbsp;<span class="ident" id="2977267">d</span><span class="op" id="2977268">.</span><span class="ident" id="2977269">w</span><span class="op" id="2977270">.</span><span class="ident" id="2977271">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2977276">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977279">d</span><span class="op" id="2977280">.</span><span class="ident" id="2977281">w</span><span class="op" id="2977282">.</span><span class="ident" id="2977283">writeBytes</span><span class="op" id="2977293">(</span><span class="ident" id="2977294">buf</span><span class="op" id="2977297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977300">return</span>&nbsp;<span class="ident" id="2977307">d</span><span class="op" id="2977308">.</span><span class="ident" id="2977309">w</span><span class="op" id="2977310">.</span><span class="ident" id="2977311">err</span><br>
<span class="lineno"></span><span class="op" id="2977315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2977318">func</span>&nbsp;<span class="op" id="2977323">(</span><span class="ident" id="2977324">d</span>&nbsp;<span class="op" id="2977326">*</span><span class="ident" id="2977327">compressor</span><span class="op" id="2977337">)</span>&nbsp;<span class="ident" id="2977339">initDeflate</span><span class="op" id="2977350">(</span><span class="op" id="2977351">)</span>&nbsp;<span class="op" id="2977353">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977356">d</span><span class="op" id="2977357">.</span><span class="ident" id="2977358">hashHead</span>&nbsp;<span class="op" id="2977367">=</span>&nbsp;<span class="builtinfunc" id="2977369">make</span><span class="op" id="2977373">(</span><span class="op" id="2977374">[</span><span class="op" id="2977375">]</span><span class="builtintype" id="2977376">int</span><span class="op" id="2977379">,</span>&nbsp;<span class="ident" id="2977381">hashSize</span><span class="op" id="2977389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977392">d</span><span class="op" id="2977393">.</span><span class="ident" id="2977394">hashPrev</span>&nbsp;<span class="op" id="2977403">=</span>&nbsp;<span class="builtinfunc" id="2977405">make</span><span class="op" id="2977409">(</span><span class="op" id="2977410">[</span><span class="op" id="2977411">]</span><span class="builtintype" id="2977412">int</span><span class="op" id="2977415">,</span>&nbsp;<span class="ident" id="2977417">windowSize</span><span class="op" id="2977427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977430">d</span><span class="op" id="2977431">.</span><span class="ident" id="2977432">window</span>&nbsp;<span class="op" id="2977439">=</span>&nbsp;<span class="builtinfunc" id="2977441">make</span><span class="op" id="2977445">(</span><span class="op" id="2977446">[</span><span class="op" id="2977447">]</span><span class="builtintype" id="2977448">byte</span><span class="op" id="2977452">,</span>&nbsp;<span class="num" id="2977454">2</span><span class="op" id="2977455">*</span><span class="ident" id="2977456">windowSize</span><span class="op" id="2977466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977469">d</span><span class="op" id="2977470">.</span><span class="ident" id="2977471">hashOffset</span>&nbsp;<span class="op" id="2977482">=</span>&nbsp;<span class="num" id="2977484">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977487">d</span><span class="op" id="2977488">.</span><span class="ident" id="2977489">tokens</span>&nbsp;<span class="op" id="2977496">=</span>&nbsp;<span class="builtinfunc" id="2977498">make</span><span class="op" id="2977502">(</span><span class="op" id="2977503">[</span><span class="op" id="2977504">]</span><span class="ident" id="2977505">token</span><span class="op" id="2977510">,</span>&nbsp;<span class="num" id="2977512">0</span><span class="op" id="2977513">,</span>&nbsp;<span class="ident" id="2977515">maxFlateBlockTokens</span><span class="op" id="2977534">+</span><span class="num" id="2977535">1</span><span class="op" id="2977536">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977539">d</span><span class="op" id="2977540">.</span><span class="ident" id="2977541">length</span>&nbsp;<span class="op" id="2977548">=</span>&nbsp;<span class="ident" id="2977550">minMatchLength</span>&nbsp;<span class="op" id="2977565">-</span>&nbsp;<span class="num" id="2977567">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977570">d</span><span class="op" id="2977571">.</span><span class="ident" id="2977572">offset</span>&nbsp;<span class="op" id="2977579">=</span>&nbsp;<span class="num" id="2977581">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977584">d</span><span class="op" id="2977585">.</span><span class="ident" id="2977586">byteAvailable</span>&nbsp;<span class="op" id="2977600">=</span>&nbsp;<span class="builtintype" id="2977602">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977609">d</span><span class="op" id="2977610">.</span><span class="ident" id="2977611">index</span>&nbsp;<span class="op" id="2977617">=</span>&nbsp;<span class="num" id="2977619">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977622">d</span><span class="op" id="2977623">.</span><span class="ident" id="2977624">hash</span>&nbsp;<span class="op" id="2977629">=</span>&nbsp;<span class="num" id="2977631">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977634">d</span><span class="op" id="2977635">.</span><span class="ident" id="2977636">chainHead</span>&nbsp;<span class="op" id="2977646">=</span>&nbsp;<span class="op" id="2977648">-</span><span class="num" id="2977649">1</span><br>
<span class="lineno"></span><span class="op" id="2977651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2977654">func</span>&nbsp;<span class="op" id="2977659">(</span><span class="ident" id="2977660">d</span>&nbsp;<span class="op" id="2977662">*</span><span class="ident" id="2977663">compressor</span><span class="op" id="2977673">)</span>&nbsp;<span class="ident" id="2977675">deflate</span><span class="op" id="2977682">(</span><span class="op" id="2977683">)</span>&nbsp;<span class="op" id="2977685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977688">if</span>&nbsp;<span class="ident" id="2977691">d</span><span class="op" id="2977692">.</span><span class="ident" id="2977693">windowEnd</span><span class="op" id="2977702">-</span><span class="ident" id="2977703">d</span><span class="op" id="2977704">.</span><span class="ident" id="2977705">index</span>&nbsp;<span class="op" id="2977711">&lt;</span>&nbsp;<span class="ident" id="2977713">minMatchLength</span><span class="op" id="2977727">+</span><span class="ident" id="2977728">maxMatchLength</span>&nbsp;<span class="op" id="2977743">&amp;&amp;</span>&nbsp;<span class="op" id="2977746">!</span><span class="ident" id="2977747">d</span><span class="op" id="2977748">.</span><span class="ident" id="2977749">sync</span>&nbsp;<span class="op" id="2977754">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977758">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2977766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977770">d</span><span class="op" id="2977771">.</span><span class="ident" id="2977772">maxInsertIndex</span>&nbsp;<span class="op" id="2977787">=</span>&nbsp;<span class="ident" id="2977789">d</span><span class="op" id="2977790">.</span><span class="ident" id="2977791">windowEnd</span>&nbsp;<span class="op" id="2977801">-</span>&nbsp;<span class="op" id="2977803">(</span><span class="ident" id="2977804">minMatchLength</span>&nbsp;<span class="op" id="2977819">-</span>&nbsp;<span class="num" id="2977821">1</span><span class="op" id="2977822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977825">if</span>&nbsp;<span class="ident" id="2977828">d</span><span class="op" id="2977829">.</span><span class="ident" id="2977830">index</span>&nbsp;<span class="op" id="2977836">&lt;</span>&nbsp;<span class="ident" id="2977838">d</span><span class="op" id="2977839">.</span><span class="ident" id="2977840">maxInsertIndex</span>&nbsp;<span class="op" id="2977855">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2977859">d</span><span class="op" id="2977860">.</span><span class="ident" id="2977861">hash</span>&nbsp;<span class="op" id="2977866">=</span>&nbsp;<span class="builtintype" id="2977868">int</span><span class="op" id="2977871">(</span><span class="ident" id="2977872">d</span><span class="op" id="2977873">.</span><span class="ident" id="2977874">window</span><span class="op" id="2977880">[</span><span class="ident" id="2977881">d</span><span class="op" id="2977882">.</span><span class="ident" id="2977883">index</span><span class="op" id="2977888">]</span><span class="op" id="2977889">)</span><span class="op" id="2977890">&lt;&lt;</span><span class="ident" id="2977892">hashShift</span>&nbsp;<span class="op" id="2977902">+</span>&nbsp;<span class="builtintype" id="2977904">int</span><span class="op" id="2977907">(</span><span class="ident" id="2977908">d</span><span class="op" id="2977909">.</span><span class="ident" id="2977910">window</span><span class="op" id="2977916">[</span><span class="ident" id="2977917">d</span><span class="op" id="2977918">.</span><span class="ident" id="2977919">index</span><span class="op" id="2977924">+</span><span class="num" id="2977925">1</span><span class="op" id="2977926">]</span><span class="op" id="2977927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2977930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="2977933">Loop</span><span class="op" id="2977937">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977940">for</span>&nbsp;<span class="op" id="2977944">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2977948">if</span>&nbsp;<span class="ident" id="2977951">d</span><span class="op" id="2977952">.</span><span class="ident" id="2977953">index</span>&nbsp;<span class="op" id="2977959">&gt;</span>&nbsp;<span class="ident" id="2977961">d</span><span class="op" id="2977962">.</span><span class="ident" id="2977963">windowEnd</span>&nbsp;<span class="op" id="2977973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2977978">panic</span><span class="op" id="2977983">(</span><span class="string" id="2977984">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="2978003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978011">lookahead</span>&nbsp;<span class="op" id="2978021">:=</span>&nbsp;<span class="ident" id="2978024">d</span><span class="op" id="2978025">.</span><span class="ident" id="2978026">windowEnd</span>&nbsp;<span class="op" id="2978036">-</span>&nbsp;<span class="ident" id="2978038">d</span><span class="op" id="2978039">.</span><span class="ident" id="2978040">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978048">if</span>&nbsp;<span class="ident" id="2978051">lookahead</span>&nbsp;<span class="op" id="2978061">&lt;</span>&nbsp;<span class="ident" id="2978063">minMatchLength</span><span class="op" id="2978077">+</span><span class="ident" id="2978078">maxMatchLength</span>&nbsp;<span class="op" id="2978093">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978098">if</span>&nbsp;<span class="op" id="2978101">!</span><span class="ident" id="2978102">d</span><span class="op" id="2978103">.</span><span class="ident" id="2978104">sync</span>&nbsp;<span class="op" id="2978109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978115">break</span>&nbsp;<span class="ident" id="2978121">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978134">if</span>&nbsp;<span class="ident" id="2978137">d</span><span class="op" id="2978138">.</span><span class="ident" id="2978139">index</span>&nbsp;<span class="op" id="2978145">&gt;</span>&nbsp;<span class="ident" id="2978147">d</span><span class="op" id="2978148">.</span><span class="ident" id="2978149">windowEnd</span>&nbsp;<span class="op" id="2978159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2978165">panic</span><span class="op" id="2978170">(</span><span class="string" id="2978171">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="2978190">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978200">if</span>&nbsp;<span class="ident" id="2978203">lookahead</span>&nbsp;<span class="op" id="2978213">==</span>&nbsp;<span class="num" id="2978216">0</span>&nbsp;<span class="op" id="2978218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2978224">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978266">if</span>&nbsp;<span class="ident" id="2978269">d</span><span class="op" id="2978270">.</span><span class="ident" id="2978271">byteAvailable</span>&nbsp;<span class="op" id="2978285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2978292">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978358">d</span><span class="op" id="2978359">.</span><span class="ident" id="2978360">tokens</span>&nbsp;<span class="op" id="2978367">=</span>&nbsp;<span class="builtinfunc" id="2978369">append</span><span class="op" id="2978375">(</span><span class="ident" id="2978376">d</span><span class="op" id="2978377">.</span><span class="ident" id="2978378">tokens</span><span class="op" id="2978384">,</span>&nbsp;<span class="ident" id="2978386">literalToken</span><span class="op" id="2978398">(</span><span class="builtintype" id="2978399">uint32</span><span class="op" id="2978405">(</span><span class="ident" id="2978406">d</span><span class="op" id="2978407">.</span><span class="ident" id="2978408">window</span><span class="op" id="2978414">[</span><span class="ident" id="2978415">d</span><span class="op" id="2978416">.</span><span class="ident" id="2978417">index</span><span class="op" id="2978422">-</span><span class="num" id="2978423">1</span><span class="op" id="2978424">]</span><span class="op" id="2978425">)</span><span class="op" id="2978426">)</span><span class="op" id="2978427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978434">d</span><span class="op" id="2978435">.</span><span class="ident" id="2978436">byteAvailable</span>&nbsp;<span class="op" id="2978450">=</span>&nbsp;<span class="builtintype" id="2978452">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978468">if</span>&nbsp;<span class="builtinfunc" id="2978471">len</span><span class="op" id="2978474">(</span><span class="ident" id="2978475">d</span><span class="op" id="2978476">.</span><span class="ident" id="2978477">tokens</span><span class="op" id="2978483">)</span>&nbsp;<span class="op" id="2978485">&gt;</span>&nbsp;<span class="num" id="2978487">0</span>&nbsp;<span class="op" id="2978489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978496">if</span>&nbsp;<span class="ident" id="2978499">d</span><span class="op" id="2978500">.</span><span class="ident" id="2978501">err</span>&nbsp;<span class="op" id="2978505">=</span>&nbsp;<span class="ident" id="2978507">d</span><span class="op" id="2978508">.</span><span class="ident" id="2978509">writeBlock</span><span class="op" id="2978519">(</span><span class="ident" id="2978520">d</span><span class="op" id="2978521">.</span><span class="ident" id="2978522">tokens</span><span class="op" id="2978528">,</span>&nbsp;<span class="ident" id="2978530">d</span><span class="op" id="2978531">.</span><span class="ident" id="2978532">index</span><span class="op" id="2978537">,</span>&nbsp;<span class="builtintype" id="2978539">false</span><span class="op" id="2978544">)</span><span class="op" id="2978545">;</span>&nbsp;<span class="ident" id="2978547">d</span><span class="op" id="2978548">.</span><span class="ident" id="2978549">err</span>&nbsp;<span class="op" id="2978553">!=</span>&nbsp;<span class="ident" id="2978556">nil</span>&nbsp;<span class="op" id="2978560">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978568">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978587">d</span><span class="op" id="2978588">.</span><span class="ident" id="2978589">tokens</span>&nbsp;<span class="op" id="2978596">=</span>&nbsp;<span class="ident" id="2978598">d</span><span class="op" id="2978599">.</span><span class="ident" id="2978600">tokens</span><span class="op" id="2978606">[</span><span class="op" id="2978607">:</span><span class="num" id="2978608">0</span><span class="op" id="2978609">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978621">break</span>&nbsp;<span class="ident" id="2978627">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978643">if</span>&nbsp;<span class="ident" id="2978646">d</span><span class="op" id="2978647">.</span><span class="ident" id="2978648">index</span>&nbsp;<span class="op" id="2978654">&lt;</span>&nbsp;<span class="ident" id="2978656">d</span><span class="op" id="2978657">.</span><span class="ident" id="2978658">maxInsertIndex</span>&nbsp;<span class="op" id="2978673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2978678">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978700">d</span><span class="op" id="2978701">.</span><span class="ident" id="2978702">hash</span>&nbsp;<span class="op" id="2978707">=</span>&nbsp;<span class="op" id="2978709">(</span><span class="ident" id="2978710">d</span><span class="op" id="2978711">.</span><span class="ident" id="2978712">hash</span><span class="op" id="2978716">&lt;&lt;</span><span class="ident" id="2978718">hashShift</span>&nbsp;<span class="op" id="2978728">+</span>&nbsp;<span class="builtintype" id="2978730">int</span><span class="op" id="2978733">(</span><span class="ident" id="2978734">d</span><span class="op" id="2978735">.</span><span class="ident" id="2978736">window</span><span class="op" id="2978742">[</span><span class="ident" id="2978743">d</span><span class="op" id="2978744">.</span><span class="ident" id="2978745">index</span><span class="op" id="2978750">+</span><span class="num" id="2978751">2</span><span class="op" id="2978752">]</span><span class="op" id="2978753">)</span><span class="op" id="2978754">)</span>&nbsp;<span class="op" id="2978756">&amp;</span>&nbsp;<span class="ident" id="2978758">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978770">d</span><span class="op" id="2978771">.</span><span class="ident" id="2978772">chainHead</span>&nbsp;<span class="op" id="2978782">=</span>&nbsp;<span class="ident" id="2978784">d</span><span class="op" id="2978785">.</span><span class="ident" id="2978786">hashHead</span><span class="op" id="2978794">[</span><span class="ident" id="2978795">d</span><span class="op" id="2978796">.</span><span class="ident" id="2978797">hash</span><span class="op" id="2978801">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978806">d</span><span class="op" id="2978807">.</span><span class="ident" id="2978808">hashPrev</span><span class="op" id="2978816">[</span><span class="ident" id="2978817">d</span><span class="op" id="2978818">.</span><span class="ident" id="2978819">index</span><span class="op" id="2978824">&amp;</span><span class="ident" id="2978825">windowMask</span><span class="op" id="2978835">]</span>&nbsp;<span class="op" id="2978837">=</span>&nbsp;<span class="ident" id="2978839">d</span><span class="op" id="2978840">.</span><span class="ident" id="2978841">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978854">d</span><span class="op" id="2978855">.</span><span class="ident" id="2978856">hashHead</span><span class="op" id="2978864">[</span><span class="ident" id="2978865">d</span><span class="op" id="2978866">.</span><span class="ident" id="2978867">hash</span><span class="op" id="2978871">]</span>&nbsp;<span class="op" id="2978873">=</span>&nbsp;<span class="ident" id="2978875">d</span><span class="op" id="2978876">.</span><span class="ident" id="2978877">index</span>&nbsp;<span class="op" id="2978883">+</span>&nbsp;<span class="ident" id="2978885">d</span><span class="op" id="2978886">.</span><span class="ident" id="2978887">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2978900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978904">prevLength</span>&nbsp;<span class="op" id="2978915">:=</span>&nbsp;<span class="ident" id="2978918">d</span><span class="op" id="2978919">.</span><span class="ident" id="2978920">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978929">prevOffset</span>&nbsp;<span class="op" id="2978940">:=</span>&nbsp;<span class="ident" id="2978943">d</span><span class="op" id="2978944">.</span><span class="ident" id="2978945">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978954">d</span><span class="op" id="2978955">.</span><span class="ident" id="2978956">length</span>&nbsp;<span class="op" id="2978963">=</span>&nbsp;<span class="ident" id="2978965">minMatchLength</span>&nbsp;<span class="op" id="2978980">-</span>&nbsp;<span class="num" id="2978982">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978986">d</span><span class="op" id="2978987">.</span><span class="ident" id="2978988">offset</span>&nbsp;<span class="op" id="2978995">=</span>&nbsp;<span class="num" id="2978997">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979001">minIndex</span>&nbsp;<span class="op" id="2979010">:=</span>&nbsp;<span class="ident" id="2979013">d</span><span class="op" id="2979014">.</span><span class="ident" id="2979015">index</span>&nbsp;<span class="op" id="2979021">-</span>&nbsp;<span class="ident" id="2979023">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979036">if</span>&nbsp;<span class="ident" id="2979039">minIndex</span>&nbsp;<span class="op" id="2979048">&lt;</span>&nbsp;<span class="num" id="2979050">0</span>&nbsp;<span class="op" id="2979052">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979057">minIndex</span>&nbsp;<span class="op" id="2979066">=</span>&nbsp;<span class="num" id="2979068">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979077">if</span>&nbsp;<span class="ident" id="2979080">d</span><span class="op" id="2979081">.</span><span class="ident" id="2979082">chainHead</span><span class="op" id="2979091">-</span><span class="ident" id="2979092">d</span><span class="op" id="2979093">.</span><span class="ident" id="2979094">hashOffset</span>&nbsp;<span class="op" id="2979105">&gt;=</span>&nbsp;<span class="ident" id="2979108">minIndex</span>&nbsp;<span class="op" id="2979117">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979123">(</span><span class="ident" id="2979124">d</span><span class="op" id="2979125">.</span><span class="ident" id="2979126">fastSkipHashing</span>&nbsp;<span class="op" id="2979142">!=</span>&nbsp;<span class="ident" id="2979145">skipNever</span>&nbsp;<span class="op" id="2979155">&amp;&amp;</span>&nbsp;<span class="ident" id="2979158">lookahead</span>&nbsp;<span class="op" id="2979168">&gt;</span>&nbsp;<span class="ident" id="2979170">minMatchLength</span><span class="op" id="2979184">-</span><span class="num" id="2979185">1</span>&nbsp;<span class="op" id="2979187">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979194">d</span><span class="op" id="2979195">.</span><span class="ident" id="2979196">fastSkipHashing</span>&nbsp;<span class="op" id="2979212">==</span>&nbsp;<span class="ident" id="2979215">skipNever</span>&nbsp;<span class="op" id="2979225">&amp;&amp;</span>&nbsp;<span class="ident" id="2979228">lookahead</span>&nbsp;<span class="op" id="2979238">&gt;</span>&nbsp;<span class="ident" id="2979240">prevLength</span>&nbsp;<span class="op" id="2979251">&amp;&amp;</span>&nbsp;<span class="ident" id="2979254">prevLength</span>&nbsp;<span class="op" id="2979265">&lt;</span>&nbsp;<span class="ident" id="2979267">d</span><span class="op" id="2979268">.</span><span class="ident" id="2979269">lazy</span><span class="op" id="2979273">)</span>&nbsp;<span class="op" id="2979275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979280">if</span>&nbsp;<span class="ident" id="2979283">newLength</span><span class="op" id="2979292">,</span>&nbsp;<span class="ident" id="2979294">newOffset</span><span class="op" id="2979303">,</span>&nbsp;<span class="ident" id="2979305">ok</span>&nbsp;<span class="op" id="2979308">:=</span>&nbsp;<span class="ident" id="2979311">d</span><span class="op" id="2979312">.</span><span class="ident" id="2979313">findMatch</span><span class="op" id="2979322">(</span><span class="ident" id="2979323">d</span><span class="op" id="2979324">.</span><span class="ident" id="2979325">index</span><span class="op" id="2979330">,</span>&nbsp;<span class="ident" id="2979332">d</span><span class="op" id="2979333">.</span><span class="ident" id="2979334">chainHead</span><span class="op" id="2979343">-</span><span class="ident" id="2979344">d</span><span class="op" id="2979345">.</span><span class="ident" id="2979346">hashOffset</span><span class="op" id="2979356">,</span>&nbsp;<span class="ident" id="2979358">minMatchLength</span><span class="op" id="2979372">-</span><span class="num" id="2979373">1</span><span class="op" id="2979374">,</span>&nbsp;<span class="ident" id="2979376">lookahead</span><span class="op" id="2979385">)</span><span class="op" id="2979386">;</span>&nbsp;<span class="ident" id="2979388">ok</span>&nbsp;<span class="op" id="2979391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979397">d</span><span class="op" id="2979398">.</span><span class="ident" id="2979399">length</span>&nbsp;<span class="op" id="2979406">=</span>&nbsp;<span class="ident" id="2979408">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979422">d</span><span class="op" id="2979423">.</span><span class="ident" id="2979424">offset</span>&nbsp;<span class="op" id="2979431">=</span>&nbsp;<span class="ident" id="2979433">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979446">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979454">if</span>&nbsp;<span class="ident" id="2979457">d</span><span class="op" id="2979458">.</span><span class="ident" id="2979459">fastSkipHashing</span>&nbsp;<span class="op" id="2979475">!=</span>&nbsp;<span class="ident" id="2979478">skipNever</span>&nbsp;<span class="op" id="2979488">&amp;&amp;</span>&nbsp;<span class="ident" id="2979491">d</span><span class="op" id="2979492">.</span><span class="ident" id="2979493">length</span>&nbsp;<span class="op" id="2979500">&gt;=</span>&nbsp;<span class="ident" id="2979503">minMatchLength</span>&nbsp;<span class="op" id="2979518">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979524">d</span><span class="op" id="2979525">.</span><span class="ident" id="2979526">fastSkipHashing</span>&nbsp;<span class="op" id="2979542">==</span>&nbsp;<span class="ident" id="2979545">skipNever</span>&nbsp;<span class="op" id="2979555">&amp;&amp;</span>&nbsp;<span class="ident" id="2979558">prevLength</span>&nbsp;<span class="op" id="2979569">&gt;=</span>&nbsp;<span class="ident" id="2979572">minMatchLength</span>&nbsp;<span class="op" id="2979587">&amp;&amp;</span>&nbsp;<span class="ident" id="2979590">d</span><span class="op" id="2979591">.</span><span class="ident" id="2979592">length</span>&nbsp;<span class="op" id="2979599">&lt;=</span>&nbsp;<span class="ident" id="2979602">prevLength</span>&nbsp;<span class="op" id="2979613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2979618">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2979689">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979734">if</span>&nbsp;<span class="ident" id="2979737">d</span><span class="op" id="2979738">.</span><span class="ident" id="2979739">fastSkipHashing</span>&nbsp;<span class="op" id="2979755">!=</span>&nbsp;<span class="ident" id="2979758">skipNever</span>&nbsp;<span class="op" id="2979768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979774">d</span><span class="op" id="2979775">.</span><span class="ident" id="2979776">tokens</span>&nbsp;<span class="op" id="2979783">=</span>&nbsp;<span class="builtinfunc" id="2979785">append</span><span class="op" id="2979791">(</span><span class="ident" id="2979792">d</span><span class="op" id="2979793">.</span><span class="ident" id="2979794">tokens</span><span class="op" id="2979800">,</span>&nbsp;<span class="ident" id="2979802">matchToken</span><span class="op" id="2979812">(</span><span class="builtintype" id="2979813">uint32</span><span class="op" id="2979819">(</span><span class="ident" id="2979820">d</span><span class="op" id="2979821">.</span><span class="ident" id="2979822">length</span><span class="op" id="2979828">-</span><span class="ident" id="2979829">minMatchLength</span><span class="op" id="2979843">)</span><span class="op" id="2979844">,</span>&nbsp;<span class="builtintype" id="2979846">uint32</span><span class="op" id="2979852">(</span><span class="ident" id="2979853">d</span><span class="op" id="2979854">.</span><span class="ident" id="2979855">offset</span><span class="op" id="2979861">-</span><span class="ident" id="2979862">minOffsetSize</span><span class="op" id="2979875">)</span><span class="op" id="2979876">)</span><span class="op" id="2979877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979882">}</span>&nbsp;<span class="keyword" id="2979884">else</span>&nbsp;<span class="op" id="2979889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979895">d</span><span class="op" id="2979896">.</span><span class="ident" id="2979897">tokens</span>&nbsp;<span class="op" id="2979904">=</span>&nbsp;<span class="builtinfunc" id="2979906">append</span><span class="op" id="2979912">(</span><span class="ident" id="2979913">d</span><span class="op" id="2979914">.</span><span class="ident" id="2979915">tokens</span><span class="op" id="2979921">,</span>&nbsp;<span class="ident" id="2979923">matchToken</span><span class="op" id="2979933">(</span><span class="builtintype" id="2979934">uint32</span><span class="op" id="2979940">(</span><span class="ident" id="2979941">prevLength</span><span class="op" id="2979951">-</span><span class="ident" id="2979952">minMatchLength</span><span class="op" id="2979966">)</span><span class="op" id="2979967">,</span>&nbsp;<span class="builtintype" id="2979969">uint32</span><span class="op" id="2979975">(</span><span class="ident" id="2979976">prevOffset</span><span class="op" id="2979986">-</span><span class="ident" id="2979987">minOffsetSize</span><span class="op" id="2980000">)</span><span class="op" id="2980001">)</span><span class="op" id="2980002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980007">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980012">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980083">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980152">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980221">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980234">if</span>&nbsp;<span class="ident" id="2980237">d</span><span class="op" id="2980238">.</span><span class="ident" id="2980239">length</span>&nbsp;<span class="op" id="2980246">&lt;=</span>&nbsp;<span class="ident" id="2980249">d</span><span class="op" id="2980250">.</span><span class="ident" id="2980251">fastSkipHashing</span>&nbsp;<span class="op" id="2980267">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980273">var</span>&nbsp;<span class="ident" id="2980277">newIndex</span>&nbsp;<span class="builtintype" id="2980286">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980294">if</span>&nbsp;<span class="ident" id="2980297">d</span><span class="op" id="2980298">.</span><span class="ident" id="2980299">fastSkipHashing</span>&nbsp;<span class="op" id="2980315">!=</span>&nbsp;<span class="ident" id="2980318">skipNever</span>&nbsp;<span class="op" id="2980328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980335">newIndex</span>&nbsp;<span class="op" id="2980344">=</span>&nbsp;<span class="ident" id="2980346">d</span><span class="op" id="2980347">.</span><span class="ident" id="2980348">index</span>&nbsp;<span class="op" id="2980354">+</span>&nbsp;<span class="ident" id="2980356">d</span><span class="op" id="2980357">.</span><span class="ident" id="2980358">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980369">}</span>&nbsp;<span class="keyword" id="2980371">else</span>&nbsp;<span class="op" id="2980376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980383">newIndex</span>&nbsp;<span class="op" id="2980392">=</span>&nbsp;<span class="ident" id="2980394">d</span><span class="op" id="2980395">.</span><span class="ident" id="2980396">index</span>&nbsp;<span class="op" id="2980402">+</span>&nbsp;<span class="ident" id="2980404">prevLength</span>&nbsp;<span class="op" id="2980415">-</span>&nbsp;<span class="num" id="2980417">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980429">for</span>&nbsp;<span class="ident" id="2980433">d</span><span class="op" id="2980434">.</span><span class="ident" id="2980435">index</span><span class="op" id="2980440">++</span><span class="op" id="2980442">;</span>&nbsp;<span class="ident" id="2980444">d</span><span class="op" id="2980445">.</span><span class="ident" id="2980446">index</span>&nbsp;<span class="op" id="2980452">&lt;</span>&nbsp;<span class="ident" id="2980454">newIndex</span><span class="op" id="2980462">;</span>&nbsp;<span class="ident" id="2980464">d</span><span class="op" id="2980465">.</span><span class="ident" id="2980466">index</span><span class="op" id="2980471">++</span>&nbsp;<span class="op" id="2980474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980481">if</span>&nbsp;<span class="ident" id="2980484">d</span><span class="op" id="2980485">.</span><span class="ident" id="2980486">index</span>&nbsp;<span class="op" id="2980492">&lt;</span>&nbsp;<span class="ident" id="2980494">d</span><span class="op" id="2980495">.</span><span class="ident" id="2980496">maxInsertIndex</span>&nbsp;<span class="op" id="2980511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980519">d</span><span class="op" id="2980520">.</span><span class="ident" id="2980521">hash</span>&nbsp;<span class="op" id="2980526">=</span>&nbsp;<span class="op" id="2980528">(</span><span class="ident" id="2980529">d</span><span class="op" id="2980530">.</span><span class="ident" id="2980531">hash</span><span class="op" id="2980535">&lt;&lt;</span><span class="ident" id="2980537">hashShift</span>&nbsp;<span class="op" id="2980547">+</span>&nbsp;<span class="builtintype" id="2980549">int</span><span class="op" id="2980552">(</span><span class="ident" id="2980553">d</span><span class="op" id="2980554">.</span><span class="ident" id="2980555">window</span><span class="op" id="2980561">[</span><span class="ident" id="2980562">d</span><span class="op" id="2980563">.</span><span class="ident" id="2980564">index</span><span class="op" id="2980569">+</span><span class="num" id="2980570">2</span><span class="op" id="2980571">]</span><span class="op" id="2980572">)</span><span class="op" id="2980573">)</span>&nbsp;<span class="op" id="2980575">&amp;</span>&nbsp;<span class="ident" id="2980577">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980592">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980640">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980695">d</span><span class="op" id="2980696">.</span><span class="ident" id="2980697">hashPrev</span><span class="op" id="2980705">[</span><span class="ident" id="2980706">d</span><span class="op" id="2980707">.</span><span class="ident" id="2980708">index</span><span class="op" id="2980713">&amp;</span><span class="ident" id="2980714">windowMask</span><span class="op" id="2980724">]</span>&nbsp;<span class="op" id="2980726">=</span>&nbsp;<span class="ident" id="2980728">d</span><span class="op" id="2980729">.</span><span class="ident" id="2980730">hashHead</span><span class="op" id="2980738">[</span><span class="ident" id="2980739">d</span><span class="op" id="2980740">.</span><span class="ident" id="2980741">hash</span><span class="op" id="2980745">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980753">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980800">d</span><span class="op" id="2980801">.</span><span class="ident" id="2980802">hashHead</span><span class="op" id="2980810">[</span><span class="ident" id="2980811">d</span><span class="op" id="2980812">.</span><span class="ident" id="2980813">hash</span><span class="op" id="2980817">]</span>&nbsp;<span class="op" id="2980819">=</span>&nbsp;<span class="ident" id="2980821">d</span><span class="op" id="2980822">.</span><span class="ident" id="2980823">index</span>&nbsp;<span class="op" id="2980829">+</span>&nbsp;<span class="ident" id="2980831">d</span><span class="op" id="2980832">.</span><span class="ident" id="2980833">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980849">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980861">if</span>&nbsp;<span class="ident" id="2980864">d</span><span class="op" id="2980865">.</span><span class="ident" id="2980866">fastSkipHashing</span>&nbsp;<span class="op" id="2980882">==</span>&nbsp;<span class="ident" id="2980885">skipNever</span>&nbsp;<span class="op" id="2980895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980902">d</span><span class="op" id="2980903">.</span><span class="ident" id="2980904">byteAvailable</span>&nbsp;<span class="op" id="2980918">=</span>&nbsp;<span class="builtintype" id="2980920">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980931">d</span><span class="op" id="2980932">.</span><span class="ident" id="2980933">length</span>&nbsp;<span class="op" id="2980940">=</span>&nbsp;<span class="ident" id="2980942">minMatchLength</span>&nbsp;<span class="op" id="2980957">-</span>&nbsp;<span class="num" id="2980959">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980965">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980970">}</span>&nbsp;<span class="keyword" id="2980972">else</span>&nbsp;<span class="op" id="2980977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2980983">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2981055">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981083">d</span><span class="op" id="2981084">.</span><span class="ident" id="2981085">index</span>&nbsp;<span class="op" id="2981091">+=</span>&nbsp;<span class="ident" id="2981094">d</span><span class="op" id="2981095">.</span><span class="ident" id="2981096">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981107">if</span>&nbsp;<span class="ident" id="2981110">d</span><span class="op" id="2981111">.</span><span class="ident" id="2981112">index</span>&nbsp;<span class="op" id="2981118">&lt;</span>&nbsp;<span class="ident" id="2981120">d</span><span class="op" id="2981121">.</span><span class="ident" id="2981122">maxInsertIndex</span>&nbsp;<span class="op" id="2981137">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981144">d</span><span class="op" id="2981145">.</span><span class="ident" id="2981146">hash</span>&nbsp;<span class="op" id="2981151">=</span>&nbsp;<span class="op" id="2981153">(</span><span class="builtintype" id="2981154">int</span><span class="op" id="2981157">(</span><span class="ident" id="2981158">d</span><span class="op" id="2981159">.</span><span class="ident" id="2981160">window</span><span class="op" id="2981166">[</span><span class="ident" id="2981167">d</span><span class="op" id="2981168">.</span><span class="ident" id="2981169">index</span><span class="op" id="2981174">]</span><span class="op" id="2981175">)</span><span class="op" id="2981176">&lt;&lt;</span><span class="ident" id="2981178">hashShift</span>&nbsp;<span class="op" id="2981188">+</span>&nbsp;<span class="builtintype" id="2981190">int</span><span class="op" id="2981193">(</span><span class="ident" id="2981194">d</span><span class="op" id="2981195">.</span><span class="ident" id="2981196">window</span><span class="op" id="2981202">[</span><span class="ident" id="2981203">d</span><span class="op" id="2981204">.</span><span class="ident" id="2981205">index</span><span class="op" id="2981210">+</span><span class="num" id="2981211">1</span><span class="op" id="2981212">]</span><span class="op" id="2981213">)</span><span class="op" id="2981214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981230">if</span>&nbsp;<span class="builtinfunc" id="2981233">len</span><span class="op" id="2981236">(</span><span class="ident" id="2981237">d</span><span class="op" id="2981238">.</span><span class="ident" id="2981239">tokens</span><span class="op" id="2981245">)</span>&nbsp;<span class="op" id="2981247">==</span>&nbsp;<span class="ident" id="2981250">maxFlateBlockTokens</span>&nbsp;<span class="op" id="2981270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2981276">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981324">if</span>&nbsp;<span class="ident" id="2981327">d</span><span class="op" id="2981328">.</span><span class="ident" id="2981329">err</span>&nbsp;<span class="op" id="2981333">=</span>&nbsp;<span class="ident" id="2981335">d</span><span class="op" id="2981336">.</span><span class="ident" id="2981337">writeBlock</span><span class="op" id="2981347">(</span><span class="ident" id="2981348">d</span><span class="op" id="2981349">.</span><span class="ident" id="2981350">tokens</span><span class="op" id="2981356">,</span>&nbsp;<span class="ident" id="2981358">d</span><span class="op" id="2981359">.</span><span class="ident" id="2981360">index</span><span class="op" id="2981365">,</span>&nbsp;<span class="builtintype" id="2981367">false</span><span class="op" id="2981372">)</span><span class="op" id="2981373">;</span>&nbsp;<span class="ident" id="2981375">d</span><span class="op" id="2981376">.</span><span class="ident" id="2981377">err</span>&nbsp;<span class="op" id="2981381">!=</span>&nbsp;<span class="ident" id="2981384">nil</span>&nbsp;<span class="op" id="2981388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981395">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981412">d</span><span class="op" id="2981413">.</span><span class="ident" id="2981414">tokens</span>&nbsp;<span class="op" id="2981421">=</span>&nbsp;<span class="ident" id="2981423">d</span><span class="op" id="2981424">.</span><span class="ident" id="2981425">tokens</span><span class="op" id="2981431">[</span><span class="op" id="2981432">:</span><span class="num" id="2981433">0</span><span class="op" id="2981434">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981439">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981443">}</span>&nbsp;<span class="keyword" id="2981445">else</span>&nbsp;<span class="op" id="2981450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981455">if</span>&nbsp;<span class="ident" id="2981458">d</span><span class="op" id="2981459">.</span><span class="ident" id="2981460">fastSkipHashing</span>&nbsp;<span class="op" id="2981476">!=</span>&nbsp;<span class="ident" id="2981479">skipNever</span>&nbsp;<span class="op" id="2981489">||</span>&nbsp;<span class="ident" id="2981492">d</span><span class="op" id="2981493">.</span><span class="ident" id="2981494">byteAvailable</span>&nbsp;<span class="op" id="2981508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981514">i</span>&nbsp;<span class="op" id="2981516">:=</span>&nbsp;<span class="ident" id="2981519">d</span><span class="op" id="2981520">.</span><span class="ident" id="2981521">index</span>&nbsp;<span class="op" id="2981527">-</span>&nbsp;<span class="num" id="2981529">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981535">if</span>&nbsp;<span class="ident" id="2981538">d</span><span class="op" id="2981539">.</span><span class="ident" id="2981540">fastSkipHashing</span>&nbsp;<span class="op" id="2981556">!=</span>&nbsp;<span class="ident" id="2981559">skipNever</span>&nbsp;<span class="op" id="2981569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981576">i</span>&nbsp;<span class="op" id="2981578">=</span>&nbsp;<span class="ident" id="2981580">d</span><span class="op" id="2981581">.</span><span class="ident" id="2981582">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981598">d</span><span class="op" id="2981599">.</span><span class="ident" id="2981600">tokens</span>&nbsp;<span class="op" id="2981607">=</span>&nbsp;<span class="builtinfunc" id="2981609">append</span><span class="op" id="2981615">(</span><span class="ident" id="2981616">d</span><span class="op" id="2981617">.</span><span class="ident" id="2981618">tokens</span><span class="op" id="2981624">,</span>&nbsp;<span class="ident" id="2981626">literalToken</span><span class="op" id="2981638">(</span><span class="builtintype" id="2981639">uint32</span><span class="op" id="2981645">(</span><span class="ident" id="2981646">d</span><span class="op" id="2981647">.</span><span class="ident" id="2981648">window</span><span class="op" id="2981654">[</span><span class="ident" id="2981655">i</span><span class="op" id="2981656">]</span><span class="op" id="2981657">)</span><span class="op" id="2981658">)</span><span class="op" id="2981659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981665">if</span>&nbsp;<span class="builtinfunc" id="2981668">len</span><span class="op" id="2981671">(</span><span class="ident" id="2981672">d</span><span class="op" id="2981673">.</span><span class="ident" id="2981674">tokens</span><span class="op" id="2981680">)</span>&nbsp;<span class="op" id="2981682">==</span>&nbsp;<span class="ident" id="2981685">maxFlateBlockTokens</span>&nbsp;<span class="op" id="2981705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981712">if</span>&nbsp;<span class="ident" id="2981715">d</span><span class="op" id="2981716">.</span><span class="ident" id="2981717">err</span>&nbsp;<span class="op" id="2981721">=</span>&nbsp;<span class="ident" id="2981723">d</span><span class="op" id="2981724">.</span><span class="ident" id="2981725">writeBlock</span><span class="op" id="2981735">(</span><span class="ident" id="2981736">d</span><span class="op" id="2981737">.</span><span class="ident" id="2981738">tokens</span><span class="op" id="2981744">,</span>&nbsp;<span class="ident" id="2981746">i</span><span class="op" id="2981747">+</span><span class="num" id="2981748">1</span><span class="op" id="2981749">,</span>&nbsp;<span class="builtintype" id="2981751">false</span><span class="op" id="2981756">)</span><span class="op" id="2981757">;</span>&nbsp;<span class="ident" id="2981759">d</span><span class="op" id="2981760">.</span><span class="ident" id="2981761">err</span>&nbsp;<span class="op" id="2981765">!=</span>&nbsp;<span class="ident" id="2981768">nil</span>&nbsp;<span class="op" id="2981772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981780">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981799">d</span><span class="op" id="2981800">.</span><span class="ident" id="2981801">tokens</span>&nbsp;<span class="op" id="2981808">=</span>&nbsp;<span class="ident" id="2981810">d</span><span class="op" id="2981811">.</span><span class="ident" id="2981812">tokens</span><span class="op" id="2981818">[</span><span class="op" id="2981819">:</span><span class="num" id="2981820">0</span><span class="op" id="2981821">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981837">d</span><span class="op" id="2981838">.</span><span class="ident" id="2981839">index</span><span class="op" id="2981844">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981850">if</span>&nbsp;<span class="ident" id="2981853">d</span><span class="op" id="2981854">.</span><span class="ident" id="2981855">fastSkipHashing</span>&nbsp;<span class="op" id="2981871">==</span>&nbsp;<span class="ident" id="2981874">skipNever</span>&nbsp;<span class="op" id="2981884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981890">d</span><span class="op" id="2981891">.</span><span class="ident" id="2981892">byteAvailable</span>&nbsp;<span class="op" id="2981906">=</span>&nbsp;<span class="builtintype" id="2981908">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981923">}</span><br>
<span class="lineno">360</span><span class="op" id="2981925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2981928">func</span>&nbsp;<span class="op" id="2981933">(</span><span class="ident" id="2981934">d</span>&nbsp;<span class="op" id="2981936">*</span><span class="ident" id="2981937">compressor</span><span class="op" id="2981947">)</span>&nbsp;<span class="ident" id="2981949">fillStore</span><span class="op" id="2981958">(</span><span class="ident" id="2981959">b</span>&nbsp;<span class="op" id="2981961">[</span><span class="op" id="2981962">]</span><span class="builtintype" id="2981963">byte</span><span class="op" id="2981967">)</span>&nbsp;<span class="builtintype" id="2981969">int</span>&nbsp;<span class="op" id="2981973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981976">n</span>&nbsp;<span class="op" id="2981978">:=</span>&nbsp;<span class="builtinfunc" id="2981981">copy</span><span class="op" id="2981985">(</span><span class="ident" id="2981986">d</span><span class="op" id="2981987">.</span><span class="ident" id="2981988">window</span><span class="op" id="2981994">[</span><span class="ident" id="2981995">d</span><span class="op" id="2981996">.</span><span class="ident" id="2981997">windowEnd</span><span class="op" id="2982006">:</span><span class="op" id="2982007">]</span><span class="op" id="2982008">,</span>&nbsp;<span class="ident" id="2982010">b</span><span class="op" id="2982011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982014">d</span><span class="op" id="2982015">.</span><span class="ident" id="2982016">windowEnd</span>&nbsp;<span class="op" id="2982026">+=</span>&nbsp;<span class="ident" id="2982029">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982032">return</span>&nbsp;<span class="ident" id="2982039">n</span><br>
<span class="lineno"></span><span class="op" id="2982041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2982044">func</span>&nbsp;<span class="op" id="2982049">(</span><span class="ident" id="2982050">d</span>&nbsp;<span class="op" id="2982052">*</span><span class="ident" id="2982053">compressor</span><span class="op" id="2982063">)</span>&nbsp;<span class="ident" id="2982065">store</span><span class="op" id="2982070">(</span><span class="op" id="2982071">)</span>&nbsp;<span class="op" id="2982073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982076">if</span>&nbsp;<span class="ident" id="2982079">d</span><span class="op" id="2982080">.</span><span class="ident" id="2982081">windowEnd</span>&nbsp;<span class="op" id="2982091">&gt;</span>&nbsp;<span class="num" id="2982093">0</span>&nbsp;<span class="op" id="2982095">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982099">d</span><span class="op" id="2982100">.</span><span class="ident" id="2982101">err</span>&nbsp;<span class="op" id="2982105">=</span>&nbsp;<span class="ident" id="2982107">d</span><span class="op" id="2982108">.</span><span class="ident" id="2982109">writeStoredBlock</span><span class="op" id="2982125">(</span><span class="ident" id="2982126">d</span><span class="op" id="2982127">.</span><span class="ident" id="2982128">window</span><span class="op" id="2982134">[</span><span class="op" id="2982135">:</span><span class="ident" id="2982136">d</span><span class="op" id="2982137">.</span><span class="ident" id="2982138">windowEnd</span><span class="op" id="2982147">]</span><span class="op" id="2982148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2982151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982154">d</span><span class="op" id="2982155">.</span><span class="ident" id="2982156">windowEnd</span>&nbsp;<span class="op" id="2982166">=</span>&nbsp;<span class="num" id="2982168">0</span><br>
<span class="lineno"></span><span class="op" id="2982170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="2982173">func</span>&nbsp;<span class="op" id="2982178">(</span><span class="ident" id="2982179">d</span>&nbsp;<span class="op" id="2982181">*</span><span class="ident" id="2982182">compressor</span><span class="op" id="2982192">)</span>&nbsp;<span class="ident" id="2982194">write</span><span class="op" id="2982199">(</span><span class="ident" id="2982200">b</span>&nbsp;<span class="op" id="2982202">[</span><span class="op" id="2982203">]</span><span class="builtintype" id="2982204">byte</span><span class="op" id="2982208">)</span>&nbsp;<span class="op" id="2982210">(</span><span class="ident" id="2982211">n</span>&nbsp;<span class="builtintype" id="2982213">int</span><span class="op" id="2982216">,</span>&nbsp;<span class="ident" id="2982218">err</span>&nbsp;<span class="builtintype" id="2982222">error</span><span class="op" id="2982227">)</span>&nbsp;<span class="op" id="2982229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982232">n</span>&nbsp;<span class="op" id="2982234">=</span>&nbsp;<span class="builtinfunc" id="2982236">len</span><span class="op" id="2982239">(</span><span class="ident" id="2982240">b</span><span class="op" id="2982241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982244">b</span>&nbsp;<span class="op" id="2982246">=</span>&nbsp;<span class="ident" id="2982248">b</span><span class="op" id="2982249">[</span><span class="ident" id="2982250">d</span><span class="op" id="2982251">.</span><span class="ident" id="2982252">fill</span><span class="op" id="2982256">(</span><span class="ident" id="2982257">d</span><span class="op" id="2982258">,</span>&nbsp;<span class="ident" id="2982260">b</span><span class="op" id="2982261">)</span><span class="op" id="2982262">:</span><span class="op" id="2982263">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982266">for</span>&nbsp;<span class="builtinfunc" id="2982270">len</span><span class="op" id="2982273">(</span><span class="ident" id="2982274">b</span><span class="op" id="2982275">)</span>&nbsp;<span class="op" id="2982277">&gt;</span>&nbsp;<span class="num" id="2982279">0</span>&nbsp;<span class="op" id="2982281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982285">d</span><span class="op" id="2982286">.</span><span class="ident" id="2982287">step</span><span class="op" id="2982291">(</span><span class="ident" id="2982292">d</span><span class="op" id="2982293">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982297">b</span>&nbsp;<span class="op" id="2982299">=</span>&nbsp;<span class="ident" id="2982301">b</span><span class="op" id="2982302">[</span><span class="ident" id="2982303">d</span><span class="op" id="2982304">.</span><span class="ident" id="2982305">fill</span><span class="op" id="2982309">(</span><span class="ident" id="2982310">d</span><span class="op" id="2982311">,</span>&nbsp;<span class="ident" id="2982313">b</span><span class="op" id="2982314">)</span><span class="op" id="2982315">:</span><span class="op" id="2982316">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2982319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982322">return</span>&nbsp;<span class="ident" id="2982329">n</span><span class="op" id="2982330">,</span>&nbsp;<span class="ident" id="2982332">d</span><span class="op" id="2982333">.</span><span class="ident" id="2982334">err</span><br>
<span class="lineno"></span><span class="op" id="2982338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2982341">func</span>&nbsp;<span class="op" id="2982346">(</span><span class="ident" id="2982347">d</span>&nbsp;<span class="op" id="2982349">*</span><span class="ident" id="2982350">compressor</span><span class="op" id="2982360">)</span>&nbsp;<span class="ident" id="2982362">syncFlush</span><span class="op" id="2982371">(</span><span class="op" id="2982372">)</span>&nbsp;<span class="builtintype" id="2982374">error</span>&nbsp;<span class="op" id="2982380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982383">d</span><span class="op" id="2982384">.</span><span class="ident" id="2982385">sync</span>&nbsp;<span class="op" id="2982390">=</span>&nbsp;<span class="builtintype" id="2982392">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982398">d</span><span class="op" id="2982399">.</span><span class="ident" id="2982400">step</span><span class="op" id="2982404">(</span><span class="ident" id="2982405">d</span><span class="op" id="2982406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982409">if</span>&nbsp;<span class="ident" id="2982412">d</span><span class="op" id="2982413">.</span><span class="ident" id="2982414">err</span>&nbsp;<span class="op" id="2982418">==</span>&nbsp;<span class="ident" id="2982421">nil</span>&nbsp;<span class="op" id="2982425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982429">d</span><span class="op" id="2982430">.</span><span class="ident" id="2982431">w</span><span class="op" id="2982432">.</span><span class="ident" id="2982433">writeStoredHeader</span><span class="op" id="2982450">(</span><span class="num" id="2982451">0</span><span class="op" id="2982452">,</span>&nbsp;<span class="builtintype" id="2982454">false</span><span class="op" id="2982459">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982463">d</span><span class="op" id="2982464">.</span><span class="ident" id="2982465">w</span><span class="op" id="2982466">.</span><span class="ident" id="2982467">flush</span><span class="op" id="2982472">(</span><span class="op" id="2982473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982477">d</span><span class="op" id="2982478">.</span><span class="ident" id="2982479">err</span>&nbsp;<span class="op" id="2982483">=</span>&nbsp;<span class="ident" id="2982485">d</span><span class="op" id="2982486">.</span><span class="ident" id="2982487">w</span><span class="op" id="2982488">.</span><span class="ident" id="2982489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2982494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982497">d</span><span class="op" id="2982498">.</span><span class="ident" id="2982499">sync</span>&nbsp;<span class="op" id="2982504">=</span>&nbsp;<span class="builtintype" id="2982506">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982513">return</span>&nbsp;<span class="ident" id="2982520">d</span><span class="op" id="2982521">.</span><span class="ident" id="2982522">err</span><br>
<span class="lineno">395</span><span class="op" id="2982526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2982529">func</span>&nbsp;<span class="op" id="2982534">(</span><span class="ident" id="2982535">d</span>&nbsp;<span class="op" id="2982537">*</span><span class="ident" id="2982538">compressor</span><span class="op" id="2982548">)</span>&nbsp;<span class="ident" id="2982550">init</span><span class="op" id="2982554">(</span><span class="ident" id="2982555">w</span>&nbsp;<span class="ident" id="2982557">io</span><span class="op" id="2982559">.</span><span class="ident" id="2982560">Writer</span><span class="op" id="2982566">,</span>&nbsp;<span class="ident" id="2982568">level</span>&nbsp;<span class="builtintype" id="2982574">int</span><span class="op" id="2982577">)</span>&nbsp;<span class="op" id="2982579">(</span><span class="ident" id="2982580">err</span>&nbsp;<span class="builtintype" id="2982584">error</span><span class="op" id="2982589">)</span>&nbsp;<span class="op" id="2982591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982594">d</span><span class="op" id="2982595">.</span><span class="ident" id="2982596">w</span>&nbsp;<span class="op" id="2982598">=</span>&nbsp;<span class="ident" id="2982600">newHuffmanBitWriter</span><span class="op" id="2982619">(</span><span class="ident" id="2982620">w</span><span class="op" id="2982621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982625">switch</span>&nbsp;<span class="op" id="2982632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982635">case</span>&nbsp;<span class="ident" id="2982640">level</span>&nbsp;<span class="op" id="2982646">==</span>&nbsp;<span class="ident" id="2982649">NoCompression</span><span class="op" id="2982662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982666">d</span><span class="op" id="2982667">.</span><span class="ident" id="2982668">window</span>&nbsp;<span class="op" id="2982675">=</span>&nbsp;<span class="builtinfunc" id="2982677">make</span><span class="op" id="2982681">(</span><span class="op" id="2982682">[</span><span class="op" id="2982683">]</span><span class="builtintype" id="2982684">byte</span><span class="op" id="2982688">,</span>&nbsp;<span class="ident" id="2982690">maxStoreBlockSize</span><span class="op" id="2982707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982711">d</span><span class="op" id="2982712">.</span><span class="ident" id="2982713">fill</span>&nbsp;<span class="op" id="2982718">=</span>&nbsp;<span class="op" id="2982720">(</span><span class="op" id="2982721">*</span><span class="ident" id="2982722">compressor</span><span class="op" id="2982732">)</span><span class="op" id="2982733">.</span><span class="ident" id="2982734">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982746">d</span><span class="op" id="2982747">.</span><span class="ident" id="2982748">step</span>&nbsp;<span class="op" id="2982753">=</span>&nbsp;<span class="op" id="2982755">(</span><span class="op" id="2982756">*</span><span class="ident" id="2982757">compressor</span><span class="op" id="2982767">)</span><span class="op" id="2982768">.</span><span class="ident" id="2982769">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982776">case</span>&nbsp;<span class="ident" id="2982781">level</span>&nbsp;<span class="op" id="2982787">==</span>&nbsp;<span class="ident" id="2982790">DefaultCompression</span><span class="op" id="2982808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982812">level</span>&nbsp;<span class="op" id="2982818">=</span>&nbsp;<span class="num" id="2982820">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982824">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982837">case</span>&nbsp;<span class="num" id="2982842">1</span>&nbsp;<span class="op" id="2982844">&lt;=</span>&nbsp;<span class="ident" id="2982847">level</span>&nbsp;<span class="op" id="2982853">&amp;&amp;</span>&nbsp;<span class="ident" id="2982856">level</span>&nbsp;<span class="op" id="2982862">&lt;=</span>&nbsp;<span class="num" id="2982865">9</span><span class="op" id="2982866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982870">d</span><span class="op" id="2982871">.</span><span class="ident" id="2982872">compressionLevel</span>&nbsp;<span class="op" id="2982889">=</span>&nbsp;<span class="ident" id="2982891">levels</span><span class="op" id="2982897">[</span><span class="ident" id="2982898">level</span><span class="op" id="2982903">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982907">d</span><span class="op" id="2982908">.</span><span class="ident" id="2982909">initDeflate</span><span class="op" id="2982920">(</span><span class="op" id="2982921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982925">d</span><span class="op" id="2982926">.</span><span class="ident" id="2982927">fill</span>&nbsp;<span class="op" id="2982932">=</span>&nbsp;<span class="op" id="2982934">(</span><span class="op" id="2982935">*</span><span class="ident" id="2982936">compressor</span><span class="op" id="2982946">)</span><span class="op" id="2982947">.</span><span class="ident" id="2982948">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982962">d</span><span class="op" id="2982963">.</span><span class="ident" id="2982964">step</span>&nbsp;<span class="op" id="2982969">=</span>&nbsp;<span class="op" id="2982971">(</span><span class="op" id="2982972">*</span><span class="ident" id="2982973">compressor</span><span class="op" id="2982983">)</span><span class="op" id="2982984">.</span><span class="ident" id="2982985">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982994">default</span><span class="op" id="2983001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983005">return</span>&nbsp;<span class="ident" id="2983012">fmt</span><span class="op" id="2983015">.</span><span class="ident" id="2983016">Errorf</span><span class="op" id="2983022">(</span><span class="string" id="2983023">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="2983089">,</span>&nbsp;<span class="ident" id="2983091">level</span><span class="op" id="2983096">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983102">return</span>&nbsp;<span class="ident" id="2983109">nil</span><br>
<span class="lineno"></span><span class="op" id="2983113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2983116">var</span>&nbsp;<span class="ident" id="2983120">zeroes</span>&nbsp;<span class="op" id="2983127">[</span><span class="num" id="2983128">32</span><span class="op" id="2983130">]</span><span class="builtintype" id="2983131">int</span><br>
<span class="lineno">420</span><span class="keyword" id="2983135">var</span>&nbsp;<span class="ident" id="2983139">bzeroes</span>&nbsp;<span class="op" id="2983147">[</span><span class="num" id="2983148">256</span><span class="op" id="2983151">]</span><span class="builtintype" id="2983152">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2983158">func</span>&nbsp;<span class="op" id="2983163">(</span><span class="ident" id="2983164">d</span>&nbsp;<span class="op" id="2983166">*</span><span class="ident" id="2983167">compressor</span><span class="op" id="2983177">)</span>&nbsp;<span class="ident" id="2983179">reset</span><span class="op" id="2983184">(</span><span class="ident" id="2983185">w</span>&nbsp;<span class="ident" id="2983187">io</span><span class="op" id="2983189">.</span><span class="ident" id="2983190">Writer</span><span class="op" id="2983196">)</span>&nbsp;<span class="op" id="2983198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983201">d</span><span class="op" id="2983202">.</span><span class="ident" id="2983203">w</span><span class="op" id="2983204">.</span><span class="ident" id="2983205">reset</span><span class="op" id="2983210">(</span><span class="ident" id="2983211">w</span><span class="op" id="2983212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983215">d</span><span class="op" id="2983216">.</span><span class="ident" id="2983217">sync</span>&nbsp;<span class="op" id="2983222">=</span>&nbsp;<span class="builtintype" id="2983224">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983231">d</span><span class="op" id="2983232">.</span><span class="ident" id="2983233">err</span>&nbsp;<span class="op" id="2983237">=</span>&nbsp;<span class="ident" id="2983239">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983244">switch</span>&nbsp;<span class="ident" id="2983251">d</span><span class="op" id="2983252">.</span><span class="ident" id="2983253">compressionLevel</span><span class="op" id="2983269">.</span><span class="ident" id="2983270">chain</span>&nbsp;<span class="op" id="2983276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983279">case</span>&nbsp;<span class="num" id="2983284">0</span><span class="op" id="2983285">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2983289">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983319">for</span>&nbsp;<span class="ident" id="2983323">i</span>&nbsp;<span class="op" id="2983325">:=</span>&nbsp;<span class="keyword" id="2983328">range</span>&nbsp;<span class="ident" id="2983334">d</span><span class="op" id="2983335">.</span><span class="ident" id="2983336">window</span>&nbsp;<span class="op" id="2983343">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983348">d</span><span class="op" id="2983349">.</span><span class="ident" id="2983350">window</span><span class="op" id="2983356">[</span><span class="ident" id="2983357">i</span><span class="op" id="2983358">]</span>&nbsp;<span class="op" id="2983360">=</span>&nbsp;<span class="num" id="2983362">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983370">d</span><span class="op" id="2983371">.</span><span class="ident" id="2983372">windowEnd</span>&nbsp;<span class="op" id="2983382">=</span>&nbsp;<span class="num" id="2983384">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983387">default</span><span class="op" id="2983394">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983398">d</span><span class="op" id="2983399">.</span><span class="ident" id="2983400">chainHead</span>&nbsp;<span class="op" id="2983410">=</span>&nbsp;<span class="op" id="2983412">-</span><span class="num" id="2983413">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983417">for</span>&nbsp;<span class="ident" id="2983421">s</span>&nbsp;<span class="op" id="2983423">:=</span>&nbsp;<span class="ident" id="2983426">d</span><span class="op" id="2983427">.</span><span class="ident" id="2983428">hashHead</span><span class="op" id="2983436">;</span>&nbsp;<span class="builtinfunc" id="2983438">len</span><span class="op" id="2983441">(</span><span class="ident" id="2983442">s</span><span class="op" id="2983443">)</span>&nbsp;<span class="op" id="2983445">&gt;</span>&nbsp;<span class="num" id="2983447">0</span><span class="op" id="2983448">;</span>&nbsp;<span class="op" id="2983450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983455">n</span>&nbsp;<span class="op" id="2983457">:=</span>&nbsp;<span class="builtinfunc" id="2983460">copy</span><span class="op" id="2983464">(</span><span class="ident" id="2983465">s</span><span class="op" id="2983466">,</span>&nbsp;<span class="ident" id="2983468">zeroes</span><span class="op" id="2983474">[</span><span class="op" id="2983475">:</span><span class="op" id="2983476">]</span><span class="op" id="2983477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983482">s</span>&nbsp;<span class="op" id="2983484">=</span>&nbsp;<span class="ident" id="2983486">s</span><span class="op" id="2983487">[</span><span class="ident" id="2983488">n</span><span class="op" id="2983489">:</span><span class="op" id="2983490">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983498">for</span>&nbsp;<span class="ident" id="2983502">s</span>&nbsp;<span class="op" id="2983504">:=</span>&nbsp;<span class="ident" id="2983507">d</span><span class="op" id="2983508">.</span><span class="ident" id="2983509">hashPrev</span><span class="op" id="2983517">;</span>&nbsp;<span class="builtinfunc" id="2983519">len</span><span class="op" id="2983522">(</span><span class="ident" id="2983523">s</span><span class="op" id="2983524">)</span>&nbsp;<span class="op" id="2983526">&gt;</span>&nbsp;<span class="num" id="2983528">0</span><span class="op" id="2983529">;</span>&nbsp;<span class="ident" id="2983531">s</span>&nbsp;<span class="op" id="2983533">=</span>&nbsp;<span class="ident" id="2983535">s</span><span class="op" id="2983536">[</span><span class="builtinfunc" id="2983537">len</span><span class="op" id="2983540">(</span><span class="ident" id="2983541">zeroes</span><span class="op" id="2983547">)</span><span class="op" id="2983548">:</span><span class="op" id="2983549">]</span>&nbsp;<span class="op" id="2983551">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2983556">copy</span><span class="op" id="2983560">(</span><span class="ident" id="2983561">s</span><span class="op" id="2983562">,</span>&nbsp;<span class="ident" id="2983564">zeroes</span><span class="op" id="2983570">[</span><span class="op" id="2983571">:</span><span class="op" id="2983572">]</span><span class="op" id="2983573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983581">d</span><span class="op" id="2983582">.</span><span class="ident" id="2983583">hashOffset</span>&nbsp;<span class="op" id="2983594">=</span>&nbsp;<span class="num" id="2983596">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983601">d</span><span class="op" id="2983602">.</span><span class="ident" id="2983603">index</span><span class="op" id="2983608">,</span>&nbsp;<span class="ident" id="2983610">d</span><span class="op" id="2983611">.</span><span class="ident" id="2983612">windowEnd</span>&nbsp;<span class="op" id="2983622">=</span>&nbsp;<span class="num" id="2983624">0</span><span class="op" id="2983625">,</span>&nbsp;<span class="num" id="2983627">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983631">for</span>&nbsp;<span class="ident" id="2983635">s</span>&nbsp;<span class="op" id="2983637">:=</span>&nbsp;<span class="ident" id="2983640">d</span><span class="op" id="2983641">.</span><span class="ident" id="2983642">window</span><span class="op" id="2983648">;</span>&nbsp;<span class="builtinfunc" id="2983650">len</span><span class="op" id="2983653">(</span><span class="ident" id="2983654">s</span><span class="op" id="2983655">)</span>&nbsp;<span class="op" id="2983657">&gt;</span>&nbsp;<span class="num" id="2983659">0</span><span class="op" id="2983660">;</span>&nbsp;<span class="op" id="2983662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983667">n</span>&nbsp;<span class="op" id="2983669">:=</span>&nbsp;<span class="builtinfunc" id="2983672">copy</span><span class="op" id="2983676">(</span><span class="ident" id="2983677">s</span><span class="op" id="2983678">,</span>&nbsp;<span class="ident" id="2983680">bzeroes</span><span class="op" id="2983687">[</span><span class="op" id="2983688">:</span><span class="op" id="2983689">]</span><span class="op" id="2983690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983695">s</span>&nbsp;<span class="op" id="2983697">=</span>&nbsp;<span class="ident" id="2983699">s</span><span class="op" id="2983700">[</span><span class="ident" id="2983701">n</span><span class="op" id="2983702">:</span><span class="op" id="2983703">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983711">d</span><span class="op" id="2983712">.</span><span class="ident" id="2983713">blockStart</span><span class="op" id="2983723">,</span>&nbsp;<span class="ident" id="2983725">d</span><span class="op" id="2983726">.</span><span class="ident" id="2983727">byteAvailable</span>&nbsp;<span class="op" id="2983741">=</span>&nbsp;<span class="num" id="2983743">0</span><span class="op" id="2983744">,</span>&nbsp;<span class="builtintype" id="2983746">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983755">d</span><span class="op" id="2983756">.</span><span class="ident" id="2983757">tokens</span>&nbsp;<span class="op" id="2983764">=</span>&nbsp;<span class="ident" id="2983766">d</span><span class="op" id="2983767">.</span><span class="ident" id="2983768">tokens</span><span class="op" id="2983774">[</span><span class="op" id="2983775">:</span><span class="ident" id="2983776">maxFlateBlockTokens</span><span class="op" id="2983795">+</span><span class="num" id="2983796">1</span><span class="op" id="2983797">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983801">for</span>&nbsp;<span class="ident" id="2983805">i</span>&nbsp;<span class="op" id="2983807">:=</span>&nbsp;<span class="num" id="2983810">0</span><span class="op" id="2983811">;</span>&nbsp;<span class="ident" id="2983813">i</span>&nbsp;<span class="op" id="2983815">&lt;=</span>&nbsp;<span class="ident" id="2983818">maxFlateBlockTokens</span><span class="op" id="2983837">;</span>&nbsp;<span class="ident" id="2983839">i</span><span class="op" id="2983840">++</span>&nbsp;<span class="op" id="2983843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983848">d</span><span class="op" id="2983849">.</span><span class="ident" id="2983850">tokens</span><span class="op" id="2983856">[</span><span class="ident" id="2983857">i</span><span class="op" id="2983858">]</span>&nbsp;<span class="op" id="2983860">=</span>&nbsp;<span class="num" id="2983862">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983866">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983870">d</span><span class="op" id="2983871">.</span><span class="ident" id="2983872">tokens</span>&nbsp;<span class="op" id="2983879">=</span>&nbsp;<span class="ident" id="2983881">d</span><span class="op" id="2983882">.</span><span class="ident" id="2983883">tokens</span><span class="op" id="2983889">[</span><span class="op" id="2983890">:</span><span class="num" id="2983891">0</span><span class="op" id="2983892">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983896">d</span><span class="op" id="2983897">.</span><span class="ident" id="2983898">length</span>&nbsp;<span class="op" id="2983905">=</span>&nbsp;<span class="ident" id="2983907">minMatchLength</span>&nbsp;<span class="op" id="2983922">-</span>&nbsp;<span class="num" id="2983924">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983928">d</span><span class="op" id="2983929">.</span><span class="ident" id="2983930">offset</span>&nbsp;<span class="op" id="2983937">=</span>&nbsp;<span class="num" id="2983939">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983943">d</span><span class="op" id="2983944">.</span><span class="ident" id="2983945">hash</span>&nbsp;<span class="op" id="2983950">=</span>&nbsp;<span class="num" id="2983952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983956">d</span><span class="op" id="2983957">.</span><span class="ident" id="2983958">maxInsertIndex</span>&nbsp;<span class="op" id="2983973">=</span>&nbsp;<span class="num" id="2983975">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983978">}</span><br>
<span class="lineno"></span><span class="op" id="2983980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2983983">func</span>&nbsp;<span class="op" id="2983988">(</span><span class="ident" id="2983989">d</span>&nbsp;<span class="op" id="2983991">*</span><span class="ident" id="2983992">compressor</span><span class="op" id="2984002">)</span>&nbsp;<span class="builtinfunc" id="2984004">close</span><span class="op" id="2984009">(</span><span class="op" id="2984010">)</span>&nbsp;<span class="builtintype" id="2984012">error</span>&nbsp;<span class="op" id="2984018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984021">d</span><span class="op" id="2984022">.</span><span class="ident" id="2984023">sync</span>&nbsp;<span class="op" id="2984028">=</span>&nbsp;<span class="builtintype" id="2984030">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984036">d</span><span class="op" id="2984037">.</span><span class="ident" id="2984038">step</span><span class="op" id="2984042">(</span><span class="ident" id="2984043">d</span><span class="op" id="2984044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984047">if</span>&nbsp;<span class="ident" id="2984050">d</span><span class="op" id="2984051">.</span><span class="ident" id="2984052">err</span>&nbsp;<span class="op" id="2984056">!=</span>&nbsp;<span class="ident" id="2984059">nil</span>&nbsp;<span class="op" id="2984063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984067">return</span>&nbsp;<span class="ident" id="2984074">d</span><span class="op" id="2984075">.</span><span class="ident" id="2984076">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984084">if</span>&nbsp;<span class="ident" id="2984087">d</span><span class="op" id="2984088">.</span><span class="ident" id="2984089">w</span><span class="op" id="2984090">.</span><span class="ident" id="2984091">writeStoredHeader</span><span class="op" id="2984108">(</span><span class="num" id="2984109">0</span><span class="op" id="2984110">,</span>&nbsp;<span class="builtintype" id="2984112">true</span><span class="op" id="2984116">)</span><span class="op" id="2984117">;</span>&nbsp;<span class="ident" id="2984119">d</span><span class="op" id="2984120">.</span><span class="ident" id="2984121">w</span><span class="op" id="2984122">.</span><span class="ident" id="2984123">err</span>&nbsp;<span class="op" id="2984127">!=</span>&nbsp;<span class="ident" id="2984130">nil</span>&nbsp;<span class="op" id="2984134">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984138">return</span>&nbsp;<span class="ident" id="2984145">d</span><span class="op" id="2984146">.</span><span class="ident" id="2984147">w</span><span class="op" id="2984148">.</span><span class="ident" id="2984149">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984157">d</span><span class="op" id="2984158">.</span><span class="ident" id="2984159">w</span><span class="op" id="2984160">.</span><span class="ident" id="2984161">flush</span><span class="op" id="2984166">(</span><span class="op" id="2984167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984170">return</span>&nbsp;<span class="ident" id="2984177">d</span><span class="op" id="2984178">.</span><span class="ident" id="2984179">w</span><span class="op" id="2984180">.</span><span class="ident" id="2984181">err</span><br>
<span class="lineno"></span><span class="op" id="2984185">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="2984188">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="2984259">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="2984334">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="2984399">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="2984469">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="2984546">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="2984568">//</span><br>
<span class="lineno"></span><span class="comment" id="2984571">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="2984644">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="2984693">func</span>&nbsp;<span class="ident" id="2984698">NewWriter</span><span class="op" id="2984707">(</span><span class="ident" id="2984708">w</span>&nbsp;<span class="ident" id="2984710">io</span><span class="op" id="2984712">.</span><span class="ident" id="2984713">Writer</span><span class="op" id="2984719">,</span>&nbsp;<span class="ident" id="2984721">level</span>&nbsp;<span class="builtintype" id="2984727">int</span><span class="op" id="2984730">)</span>&nbsp;<span class="op" id="2984732">(</span><span class="op" id="2984733">*</span><span class="ident" id="2984734">Writer</span><span class="op" id="2984740">,</span>&nbsp;<span class="builtintype" id="2984742">error</span><span class="op" id="2984747">)</span>&nbsp;<span class="op" id="2984749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984752">var</span>&nbsp;<span class="ident" id="2984756">dw</span>&nbsp;<span class="ident" id="2984759">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984767">if</span>&nbsp;<span class="ident" id="2984770">err</span>&nbsp;<span class="op" id="2984774">:=</span>&nbsp;<span class="ident" id="2984777">dw</span><span class="op" id="2984779">.</span><span class="ident" id="2984780">d</span><span class="op" id="2984781">.</span><span class="ident" id="2984782">init</span><span class="op" id="2984786">(</span><span class="ident" id="2984787">w</span><span class="op" id="2984788">,</span>&nbsp;<span class="ident" id="2984790">level</span><span class="op" id="2984795">)</span><span class="op" id="2984796">;</span>&nbsp;<span class="ident" id="2984798">err</span>&nbsp;<span class="op" id="2984802">!=</span>&nbsp;<span class="ident" id="2984805">nil</span>&nbsp;<span class="op" id="2984809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984813">return</span>&nbsp;<span class="ident" id="2984820">nil</span><span class="op" id="2984823">,</span>&nbsp;<span class="ident" id="2984825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984830">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984833">return</span>&nbsp;<span class="op" id="2984840">&amp;</span><span class="ident" id="2984841">dw</span><span class="op" id="2984843">,</span>&nbsp;<span class="ident" id="2984845">nil</span><br>
<span class="lineno"></span><span class="op" id="2984849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2984852">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="2984911">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="2984976">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="2985041">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="2985101">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2985162">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="2985182">func</span>&nbsp;<span class="ident" id="2985187">NewWriterDict</span><span class="op" id="2985200">(</span><span class="ident" id="2985201">w</span>&nbsp;<span class="ident" id="2985203">io</span><span class="op" id="2985205">.</span><span class="ident" id="2985206">Writer</span><span class="op" id="2985212">,</span>&nbsp;<span class="ident" id="2985214">level</span>&nbsp;<span class="builtintype" id="2985220">int</span><span class="op" id="2985223">,</span>&nbsp;<span class="ident" id="2985225">dict</span>&nbsp;<span class="op" id="2985230">[</span><span class="op" id="2985231">]</span><span class="builtintype" id="2985232">byte</span><span class="op" id="2985236">)</span>&nbsp;<span class="op" id="2985238">(</span><span class="op" id="2985239">*</span><span class="ident" id="2985240">Writer</span><span class="op" id="2985246">,</span>&nbsp;<span class="builtintype" id="2985248">error</span><span class="op" id="2985253">)</span>&nbsp;<span class="op" id="2985255">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985258">dw</span>&nbsp;<span class="op" id="2985261">:=</span>&nbsp;<span class="op" id="2985264">&amp;</span><span class="ident" id="2985265">dictWriter</span><span class="op" id="2985275">{</span><span class="ident" id="2985276">w</span><span class="op" id="2985277">,</span>&nbsp;<span class="builtintype" id="2985279">false</span><span class="op" id="2985284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985287">zw</span><span class="op" id="2985289">,</span>&nbsp;<span class="ident" id="2985291">err</span>&nbsp;<span class="op" id="2985295">:=</span>&nbsp;<span class="ident" id="2985298">NewWriter</span><span class="op" id="2985307">(</span><span class="ident" id="2985308">dw</span><span class="op" id="2985310">,</span>&nbsp;<span class="ident" id="2985312">level</span><span class="op" id="2985317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985320">if</span>&nbsp;<span class="ident" id="2985323">err</span>&nbsp;<span class="op" id="2985327">!=</span>&nbsp;<span class="ident" id="2985330">nil</span>&nbsp;<span class="op" id="2985334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985338">return</span>&nbsp;<span class="ident" id="2985345">nil</span><span class="op" id="2985348">,</span>&nbsp;<span class="ident" id="2985350">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2985355">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985358">zw</span><span class="op" id="2985360">.</span><span class="ident" id="2985361">Write</span><span class="op" id="2985366">(</span><span class="ident" id="2985367">dict</span><span class="op" id="2985371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985374">zw</span><span class="op" id="2985376">.</span><span class="ident" id="2985377">Flush</span><span class="op" id="2985382">(</span><span class="op" id="2985383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985386">dw</span><span class="op" id="2985388">.</span><span class="ident" id="2985389">enabled</span>&nbsp;<span class="op" id="2985397">=</span>&nbsp;<span class="builtintype" id="2985399">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985405">zw</span><span class="op" id="2985407">.</span><span class="ident" id="2985408">dict</span>&nbsp;<span class="op" id="2985413">=</span>&nbsp;<span class="builtinfunc" id="2985415">append</span><span class="op" id="2985421">(</span><span class="ident" id="2985422">zw</span><span class="op" id="2985424">.</span><span class="ident" id="2985425">dict</span><span class="op" id="2985429">,</span>&nbsp;<span class="ident" id="2985431">dict</span><span class="op" id="2985435">...</span><span class="op" id="2985438">)</span>&nbsp;<span class="comment" id="2985440">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985483">return</span>&nbsp;<span class="ident" id="2985490">zw</span><span class="op" id="2985492">,</span>&nbsp;<span class="ident" id="2985494">err</span><br>
<span class="lineno">510</span><span class="op" id="2985498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2985501">type</span>&nbsp;<span class="ident" id="2985506">dictWriter</span>&nbsp;<span class="keyword" id="2985517">struct</span>&nbsp;<span class="op" id="2985524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985527">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2985535">io</span><span class="op" id="2985537">.</span><span class="ident" id="2985538">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985546">enabled</span>&nbsp;<span class="builtintype" id="2985554">bool</span><br>
<span class="lineno">515</span><span class="op" id="2985559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2985562">func</span>&nbsp;<span class="op" id="2985567">(</span><span class="ident" id="2985568">w</span>&nbsp;<span class="op" id="2985570">*</span><span class="ident" id="2985571">dictWriter</span><span class="op" id="2985581">)</span>&nbsp;<span class="ident" id="2985583">Write</span><span class="op" id="2985588">(</span><span class="ident" id="2985589">b</span>&nbsp;<span class="op" id="2985591">[</span><span class="op" id="2985592">]</span><span class="builtintype" id="2985593">byte</span><span class="op" id="2985597">)</span>&nbsp;<span class="op" id="2985599">(</span><span class="ident" id="2985600">n</span>&nbsp;<span class="builtintype" id="2985602">int</span><span class="op" id="2985605">,</span>&nbsp;<span class="ident" id="2985607">err</span>&nbsp;<span class="builtintype" id="2985611">error</span><span class="op" id="2985616">)</span>&nbsp;<span class="op" id="2985618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985621">if</span>&nbsp;<span class="ident" id="2985624">w</span><span class="op" id="2985625">.</span><span class="ident" id="2985626">enabled</span>&nbsp;<span class="op" id="2985634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985638">return</span>&nbsp;<span class="ident" id="2985645">w</span><span class="op" id="2985646">.</span><span class="ident" id="2985647">w</span><span class="op" id="2985648">.</span><span class="ident" id="2985649">Write</span><span class="op" id="2985654">(</span><span class="ident" id="2985655">b</span><span class="op" id="2985656">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2985659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985662">return</span>&nbsp;<span class="builtinfunc" id="2985669">len</span><span class="op" id="2985672">(</span><span class="ident" id="2985673">b</span><span class="op" id="2985674">)</span><span class="op" id="2985675">,</span>&nbsp;<span class="ident" id="2985677">nil</span><br>
<span class="lineno"></span><span class="op" id="2985681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2985684">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="2985747">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="2985809">type</span>&nbsp;<span class="ident" id="2985814">Writer</span>&nbsp;<span class="keyword" id="2985821">struct</span>&nbsp;<span class="op" id="2985828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985831">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2985836">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985848">dict</span>&nbsp;<span class="op" id="2985853">[</span><span class="op" id="2985854">]</span><span class="builtintype" id="2985855">byte</span><br>
<span class="lineno"></span><span class="op" id="2985860">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="2985863">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2985922">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2985975">func</span>&nbsp;<span class="op" id="2985980">(</span><span class="ident" id="2985981">w</span>&nbsp;<span class="op" id="2985983">*</span><span class="ident" id="2985984">Writer</span><span class="op" id="2985990">)</span>&nbsp;<span class="ident" id="2985992">Write</span><span class="op" id="2985997">(</span><span class="ident" id="2985998">data</span>&nbsp;<span class="op" id="2986003">[</span><span class="op" id="2986004">]</span><span class="builtintype" id="2986005">byte</span><span class="op" id="2986009">)</span>&nbsp;<span class="op" id="2986011">(</span><span class="ident" id="2986012">n</span>&nbsp;<span class="builtintype" id="2986014">int</span><span class="op" id="2986017">,</span>&nbsp;<span class="ident" id="2986019">err</span>&nbsp;<span class="builtintype" id="2986023">error</span><span class="op" id="2986028">)</span>&nbsp;<span class="op" id="2986030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986033">return</span>&nbsp;<span class="ident" id="2986040">w</span><span class="op" id="2986041">.</span><span class="ident" id="2986042">d</span><span class="op" id="2986043">.</span><span class="ident" id="2986044">write</span><span class="op" id="2986049">(</span><span class="ident" id="2986050">data</span><span class="op" id="2986054">)</span><br>
<span class="lineno">535</span><span class="op" id="2986056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2986059">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="2986130">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="2986201">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="2986261">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="2986319">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="2986391">//</span><br>
<span class="lineno"></span><span class="comment" id="2986394">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="2986474">func</span>&nbsp;<span class="op" id="2986479">(</span><span class="ident" id="2986480">w</span>&nbsp;<span class="op" id="2986482">*</span><span class="ident" id="2986483">Writer</span><span class="op" id="2986489">)</span>&nbsp;<span class="ident" id="2986491">Flush</span><span class="op" id="2986496">(</span><span class="op" id="2986497">)</span>&nbsp;<span class="builtintype" id="2986499">error</span>&nbsp;<span class="op" id="2986505">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2986508">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2986537">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986589">return</span>&nbsp;<span class="ident" id="2986596">w</span><span class="op" id="2986597">.</span><span class="ident" id="2986598">d</span><span class="op" id="2986599">.</span><span class="ident" id="2986600">syncFlush</span><span class="op" id="2986609">(</span><span class="op" id="2986610">)</span><br>
<span class="lineno"></span><span class="op" id="2986612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="2986615">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2986655">func</span>&nbsp;<span class="op" id="2986660">(</span><span class="ident" id="2986661">w</span>&nbsp;<span class="op" id="2986663">*</span><span class="ident" id="2986664">Writer</span><span class="op" id="2986670">)</span>&nbsp;<span class="ident" id="2986672">Close</span><span class="op" id="2986677">(</span><span class="op" id="2986678">)</span>&nbsp;<span class="builtintype" id="2986680">error</span>&nbsp;<span class="op" id="2986686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986689">return</span>&nbsp;<span class="ident" id="2986696">w</span><span class="op" id="2986697">.</span><span class="ident" id="2986698">d</span><span class="op" id="2986699">.</span><span class="builtinfunc" id="2986700">close</span><span class="op" id="2986705">(</span><span class="op" id="2986706">)</span><br>
<span class="lineno"></span><span class="op" id="2986708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="2986711">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2986775">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="2986835">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="2986868">func</span>&nbsp;<span class="op" id="2986873">(</span><span class="ident" id="2986874">w</span>&nbsp;<span class="op" id="2986876">*</span><span class="ident" id="2986877">Writer</span><span class="op" id="2986883">)</span>&nbsp;<span class="ident" id="2986885">Reset</span><span class="op" id="2986890">(</span><span class="ident" id="2986891">dst</span>&nbsp;<span class="ident" id="2986895">io</span><span class="op" id="2986897">.</span><span class="ident" id="2986898">Writer</span><span class="op" id="2986904">)</span>&nbsp;<span class="op" id="2986906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986909">if</span>&nbsp;<span class="ident" id="2986912">dw</span><span class="op" id="2986914">,</span>&nbsp;<span class="ident" id="2986916">ok</span>&nbsp;<span class="op" id="2986919">:=</span>&nbsp;<span class="ident" id="2986922">w</span><span class="op" id="2986923">.</span><span class="ident" id="2986924">d</span><span class="op" id="2986925">.</span><span class="ident" id="2986926">w</span><span class="op" id="2986927">.</span><span class="ident" id="2986928">w</span><span class="op" id="2986929">.</span><span class="op" id="2986930">(</span><span class="op" id="2986931">*</span><span class="ident" id="2986932">dictWriter</span><span class="op" id="2986942">)</span><span class="op" id="2986943">;</span>&nbsp;<span class="ident" id="2986945">ok</span>&nbsp;<span class="op" id="2986948">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2986952">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986990">dw</span><span class="op" id="2986992">.</span><span class="ident" id="2986993">w</span>&nbsp;<span class="op" id="2986995">=</span>&nbsp;<span class="ident" id="2986997">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987003">w</span><span class="op" id="2987004">.</span><span class="ident" id="2987005">d</span><span class="op" id="2987006">.</span><span class="ident" id="2987007">reset</span><span class="op" id="2987012">(</span><span class="ident" id="2987013">dw</span><span class="op" id="2987015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987019">dw</span><span class="op" id="2987021">.</span><span class="ident" id="2987022">enabled</span>&nbsp;<span class="op" id="2987030">=</span>&nbsp;<span class="builtintype" id="2987032">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987040">w</span><span class="op" id="2987041">.</span><span class="ident" id="2987042">Write</span><span class="op" id="2987047">(</span><span class="ident" id="2987048">w</span><span class="op" id="2987049">.</span><span class="ident" id="2987050">dict</span><span class="op" id="2987054">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987058">w</span><span class="op" id="2987059">.</span><span class="ident" id="2987060">Flush</span><span class="op" id="2987065">(</span><span class="op" id="2987066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987070">dw</span><span class="op" id="2987072">.</span><span class="ident" id="2987073">enabled</span>&nbsp;<span class="op" id="2987081">=</span>&nbsp;<span class="builtintype" id="2987083">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2987089">}</span>&nbsp;<span class="keyword" id="2987091">else</span>&nbsp;<span class="op" id="2987096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2987100">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987134">w</span><span class="op" id="2987135">.</span><span class="ident" id="2987136">d</span><span class="op" id="2987137">.</span><span class="ident" id="2987138">reset</span><span class="op" id="2987143">(</span><span class="ident" id="2987144">dst</span><span class="op" id="2987147">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2987150">}</span><br>
<span class="lineno"></span><span class="op" id="2987152">}</span>
</div>
</body>
</html>
