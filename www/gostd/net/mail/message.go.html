<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html" class="current">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6169847">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6169902">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6169956">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6170007">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="6170414">package</span>&nbsp;<span class="ident" id="6170422">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6170428">import</span>&nbsp;<span class="op" id="6170435">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170438">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170447">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170456">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170475">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170485">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170492">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170498">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170511">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170518">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170535">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170546">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170557">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6170565">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="6170575">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6170578">var</span>&nbsp;<span class="ident" id="6170582">debug</span>&nbsp;<span class="op" id="6170588">=</span>&nbsp;<span class="ident" id="6170590">debugT</span><span class="op" id="6170596">(</span><span class="builtintype" id="6170597">false</span><span class="op" id="6170602">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6170605">type</span>&nbsp;<span class="ident" id="6170610">debugT</span>&nbsp;<span class="builtintype" id="6170617">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6170623">func</span>&nbsp;<span class="op" id="6170628">(</span><span class="ident" id="6170629">d</span>&nbsp;<span class="ident" id="6170631">debugT</span><span class="op" id="6170637">)</span>&nbsp;<span class="ident" id="6170639">Printf</span><span class="op" id="6170645">(</span><span class="ident" id="6170646">format</span>&nbsp;<span class="builtintype" id="6170653">string</span><span class="op" id="6170659">,</span>&nbsp;<span class="ident" id="6170661">args</span>&nbsp;<span class="op" id="6170666">...</span><span class="keyword" id="6170669">interface</span><span class="op" id="6170678">{</span><span class="op" id="6170679">}</span><span class="op" id="6170680">)</span>&nbsp;<span class="op" id="6170682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6170685">if</span>&nbsp;<span class="ident" id="6170688">d</span>&nbsp;<span class="op" id="6170690">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6170694">log</span><span class="op" id="6170697">.</span><span class="ident" id="6170698">Printf</span><span class="op" id="6170704">(</span><span class="ident" id="6170705">format</span><span class="op" id="6170711">,</span>&nbsp;<span class="ident" id="6170713">args</span><span class="op" id="6170717">...</span><span class="op" id="6170720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6170723">}</span><br>
<span class="lineno"></span><span class="op" id="6170725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6170728">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="6170775">type</span>&nbsp;<span class="ident" id="6170780">Message</span>&nbsp;<span class="keyword" id="6170788">struct</span>&nbsp;<span class="op" id="6170795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6170798">Header</span>&nbsp;<span class="ident" id="6170805">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6170813">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6170820">io</span><span class="op" id="6170822">.</span><span class="ident" id="6170823">Reader</span><br>
<span class="lineno"></span><span class="op" id="6170830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="6170833">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="6170872">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="6170945">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6170968">func</span>&nbsp;<span class="ident" id="6170973">ReadMessage</span><span class="op" id="6170984">(</span><span class="ident" id="6170985">r</span>&nbsp;<span class="ident" id="6170987">io</span><span class="op" id="6170989">.</span><span class="ident" id="6170990">Reader</span><span class="op" id="6170996">)</span>&nbsp;<span class="op" id="6170998">(</span><span class="ident" id="6170999">msg</span>&nbsp;<span class="op" id="6171003">*</span><span class="ident" id="6171004">Message</span><span class="op" id="6171011">,</span>&nbsp;<span class="ident" id="6171013">err</span>&nbsp;<span class="builtintype" id="6171017">error</span><span class="op" id="6171022">)</span>&nbsp;<span class="op" id="6171024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171027">tp</span>&nbsp;<span class="op" id="6171030">:=</span>&nbsp;<span class="ident" id="6171033">textproto</span><span class="op" id="6171042">.</span><span class="ident" id="6171043">NewReader</span><span class="op" id="6171052">(</span><span class="ident" id="6171053">bufio</span><span class="op" id="6171058">.</span><span class="ident" id="6171059">NewReader</span><span class="op" id="6171068">(</span><span class="ident" id="6171069">r</span><span class="op" id="6171070">)</span><span class="op" id="6171071">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171075">hdr</span><span class="op" id="6171078">,</span>&nbsp;<span class="ident" id="6171080">err</span>&nbsp;<span class="op" id="6171084">:=</span>&nbsp;<span class="ident" id="6171087">tp</span><span class="op" id="6171089">.</span><span class="ident" id="6171090">ReadMIMEHeader</span><span class="op" id="6171104">(</span><span class="op" id="6171105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171108">if</span>&nbsp;<span class="ident" id="6171111">err</span>&nbsp;<span class="op" id="6171115">!=</span>&nbsp;<span class="ident" id="6171118">nil</span>&nbsp;<span class="op" id="6171122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171126">return</span>&nbsp;<span class="ident" id="6171133">nil</span><span class="op" id="6171136">,</span>&nbsp;<span class="ident" id="6171138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6171143">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171147">return</span>&nbsp;<span class="op" id="6171154">&amp;</span><span class="ident" id="6171155">Message</span><span class="op" id="6171162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171166">Header</span><span class="op" id="6171172">:</span>&nbsp;<span class="ident" id="6171174">Header</span><span class="op" id="6171180">(</span><span class="ident" id="6171181">hdr</span><span class="op" id="6171184">)</span><span class="op" id="6171185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171189">Body</span><span class="op" id="6171193">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6171197">tp</span><span class="op" id="6171199">.</span><span class="ident" id="6171200">R</span><span class="op" id="6171201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6171204">}</span><span class="op" id="6171205">,</span>&nbsp;<span class="ident" id="6171207">nil</span><br>
<span class="lineno">65</span><span class="op" id="6171211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6171214">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="6171261">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="6171290">var</span>&nbsp;<span class="ident" id="6171294">dateLayouts</span>&nbsp;<span class="op" id="6171306">[</span><span class="op" id="6171307">]</span><span class="builtintype" id="6171308">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="6171316">func</span>&nbsp;<span class="ident" id="6171321">init</span><span class="op" id="6171325">(</span><span class="op" id="6171326">)</span>&nbsp;<span class="op" id="6171328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6171331">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171385">dows</span>&nbsp;<span class="op" id="6171390">:=</span>&nbsp;<span class="op" id="6171393">[</span><span class="op" id="6171394">...</span><span class="op" id="6171397">]</span><span class="builtintype" id="6171398">string</span><span class="op" id="6171404">{</span><span class="string" id="6171405">&#34;&#34;</span><span class="op" id="6171407">,</span>&nbsp;<span class="string" id="6171409">&#34;Mon,&nbsp;&#34;</span><span class="op" id="6171416">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6171420">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171436">days</span>&nbsp;<span class="op" id="6171441">:=</span>&nbsp;<span class="op" id="6171444">[</span><span class="op" id="6171445">...</span><span class="op" id="6171448">]</span><span class="builtintype" id="6171449">string</span><span class="op" id="6171455">{</span><span class="string" id="6171456">&#34;2&#34;</span><span class="op" id="6171459">,</span>&nbsp;<span class="string" id="6171461">&#34;02&#34;</span><span class="op" id="6171465">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6171471">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171490">years</span>&nbsp;<span class="op" id="6171496">:=</span>&nbsp;<span class="op" id="6171499">[</span><span class="op" id="6171500">...</span><span class="op" id="6171503">]</span><span class="builtintype" id="6171504">string</span><span class="op" id="6171510">{</span><span class="string" id="6171511">&#34;2006&#34;</span><span class="op" id="6171517">,</span>&nbsp;<span class="string" id="6171519">&#34;06&#34;</span><span class="op" id="6171523">}</span>&nbsp;<span class="comment" id="6171525">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171554">seconds</span>&nbsp;<span class="op" id="6171562">:=</span>&nbsp;<span class="op" id="6171565">[</span><span class="op" id="6171566">...</span><span class="op" id="6171569">]</span><span class="builtintype" id="6171570">string</span><span class="op" id="6171576">{</span><span class="string" id="6171577">&#34;:05&#34;</span><span class="op" id="6171582">,</span>&nbsp;<span class="string" id="6171584">&#34;&#34;</span><span class="op" id="6171586">}</span>&nbsp;&nbsp;<span class="comment" id="6171589">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6171600">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171653">zones</span>&nbsp;<span class="op" id="6171659">:=</span>&nbsp;<span class="op" id="6171662">[</span><span class="op" id="6171663">...</span><span class="op" id="6171666">]</span><span class="builtintype" id="6171667">string</span><span class="op" id="6171673">{</span><span class="string" id="6171674">&#34;-0700&#34;</span><span class="op" id="6171681">,</span>&nbsp;<span class="string" id="6171683">&#34;MST&#34;</span><span class="op" id="6171688">,</span>&nbsp;<span class="string" id="6171690">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="6171703">}</span>&nbsp;<span class="comment" id="6171705">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171752">for</span>&nbsp;<span class="ident" id="6171756">_</span><span class="op" id="6171757">,</span>&nbsp;<span class="ident" id="6171759">dow</span>&nbsp;<span class="op" id="6171763">:=</span>&nbsp;<span class="keyword" id="6171766">range</span>&nbsp;<span class="ident" id="6171772">dows</span>&nbsp;<span class="op" id="6171777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171781">for</span>&nbsp;<span class="ident" id="6171785">_</span><span class="op" id="6171786">,</span>&nbsp;<span class="ident" id="6171788">day</span>&nbsp;<span class="op" id="6171792">:=</span>&nbsp;<span class="keyword" id="6171795">range</span>&nbsp;<span class="ident" id="6171801">days</span>&nbsp;<span class="op" id="6171806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171811">for</span>&nbsp;<span class="ident" id="6171815">_</span><span class="op" id="6171816">,</span>&nbsp;<span class="ident" id="6171818">year</span>&nbsp;<span class="op" id="6171823">:=</span>&nbsp;<span class="keyword" id="6171826">range</span>&nbsp;<span class="ident" id="6171832">years</span>&nbsp;<span class="op" id="6171838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171844">for</span>&nbsp;<span class="ident" id="6171848">_</span><span class="op" id="6171849">,</span>&nbsp;<span class="ident" id="6171851">second</span>&nbsp;<span class="op" id="6171858">:=</span>&nbsp;<span class="keyword" id="6171861">range</span>&nbsp;<span class="ident" id="6171867">seconds</span>&nbsp;<span class="op" id="6171875">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6171882">for</span>&nbsp;<span class="ident" id="6171886">_</span><span class="op" id="6171887">,</span>&nbsp;<span class="ident" id="6171889">zone</span>&nbsp;<span class="op" id="6171894">:=</span>&nbsp;<span class="keyword" id="6171897">range</span>&nbsp;<span class="ident" id="6171903">zones</span>&nbsp;<span class="op" id="6171909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171917">s</span>&nbsp;<span class="op" id="6171919">:=</span>&nbsp;<span class="ident" id="6171922">dow</span>&nbsp;<span class="op" id="6171926">+</span>&nbsp;<span class="ident" id="6171928">day</span>&nbsp;<span class="op" id="6171932">+</span>&nbsp;<span class="string" id="6171934">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="6171942">+</span>&nbsp;<span class="ident" id="6171944">year</span>&nbsp;<span class="op" id="6171949">+</span>&nbsp;<span class="string" id="6171951">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="6171960">+</span>&nbsp;<span class="ident" id="6171962">second</span>&nbsp;<span class="op" id="6171969">+</span>&nbsp;<span class="string" id="6171971">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="6171975">+</span>&nbsp;<span class="ident" id="6171977">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6171988">dateLayouts</span>&nbsp;<span class="op" id="6172000">=</span>&nbsp;<span class="builtinfunc" id="6172002">append</span><span class="op" id="6172008">(</span><span class="ident" id="6172009">dateLayouts</span><span class="op" id="6172020">,</span>&nbsp;<span class="ident" id="6172022">s</span><span class="op" id="6172023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172036">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172048">}</span><br>
<span class="lineno"></span><span class="op" id="6172050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6172053">func</span>&nbsp;<span class="ident" id="6172058">parseDate</span><span class="op" id="6172067">(</span><span class="ident" id="6172068">date</span>&nbsp;<span class="builtintype" id="6172073">string</span><span class="op" id="6172079">)</span>&nbsp;<span class="op" id="6172081">(</span><span class="ident" id="6172082">time</span><span class="op" id="6172086">.</span><span class="ident" id="6172087">Time</span><span class="op" id="6172091">,</span>&nbsp;<span class="builtintype" id="6172093">error</span><span class="op" id="6172098">)</span>&nbsp;<span class="op" id="6172100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172103">for</span>&nbsp;<span class="ident" id="6172107">_</span><span class="op" id="6172108">,</span>&nbsp;<span class="ident" id="6172110">layout</span>&nbsp;<span class="op" id="6172117">:=</span>&nbsp;<span class="keyword" id="6172120">range</span>&nbsp;<span class="ident" id="6172126">dateLayouts</span>&nbsp;<span class="op" id="6172138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6172142">t</span><span class="op" id="6172143">,</span>&nbsp;<span class="ident" id="6172145">err</span>&nbsp;<span class="op" id="6172149">:=</span>&nbsp;<span class="ident" id="6172152">time</span><span class="op" id="6172156">.</span><span class="ident" id="6172157">Parse</span><span class="op" id="6172162">(</span><span class="ident" id="6172163">layout</span><span class="op" id="6172169">,</span>&nbsp;<span class="ident" id="6172171">date</span><span class="op" id="6172175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172179">if</span>&nbsp;<span class="ident" id="6172182">err</span>&nbsp;<span class="op" id="6172186">==</span>&nbsp;<span class="ident" id="6172189">nil</span>&nbsp;<span class="op" id="6172193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172198">return</span>&nbsp;<span class="ident" id="6172205">t</span><span class="op" id="6172206">,</span>&nbsp;<span class="ident" id="6172208">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172220">return</span>&nbsp;<span class="ident" id="6172227">time</span><span class="op" id="6172231">.</span><span class="ident" id="6172232">Time</span><span class="op" id="6172236">{</span><span class="op" id="6172237">}</span><span class="op" id="6172238">,</span>&nbsp;<span class="ident" id="6172240">errors</span><span class="op" id="6172246">.</span><span class="ident" id="6172247">New</span><span class="op" id="6172250">(</span><span class="string" id="6172251">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="6172285">)</span><br>
<span class="lineno"></span><span class="op" id="6172287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="6172290">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6172359">type</span>&nbsp;<span class="ident" id="6172364">Header</span>&nbsp;<span class="keyword" id="6172371">map</span><span class="op" id="6172374">[</span><span class="builtintype" id="6172375">string</span><span class="op" id="6172381">]</span><span class="op" id="6172382">[</span><span class="op" id="6172383">]</span><span class="builtintype" id="6172384">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6172392">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="6172451">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="6172518">func</span>&nbsp;<span class="op" id="6172523">(</span><span class="ident" id="6172524">h</span>&nbsp;<span class="ident" id="6172526">Header</span><span class="op" id="6172532">)</span>&nbsp;<span class="ident" id="6172534">Get</span><span class="op" id="6172537">(</span><span class="ident" id="6172538">key</span>&nbsp;<span class="builtintype" id="6172542">string</span><span class="op" id="6172548">)</span>&nbsp;<span class="builtintype" id="6172550">string</span>&nbsp;<span class="op" id="6172557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172560">return</span>&nbsp;<span class="ident" id="6172567">textproto</span><span class="op" id="6172576">.</span><span class="ident" id="6172577">MIMEHeader</span><span class="op" id="6172587">(</span><span class="ident" id="6172588">h</span><span class="op" id="6172589">)</span><span class="op" id="6172590">.</span><span class="ident" id="6172591">Get</span><span class="op" id="6172594">(</span><span class="ident" id="6172595">key</span><span class="op" id="6172598">)</span><br>
<span class="lineno"></span><span class="op" id="6172600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6172603">var</span>&nbsp;<span class="ident" id="6172607">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="6172627">=</span>&nbsp;<span class="ident" id="6172629">errors</span><span class="op" id="6172635">.</span><span class="ident" id="6172636">New</span><span class="op" id="6172639">(</span><span class="string" id="6172640">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="6172669">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6172672">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="6172710">func</span>&nbsp;<span class="op" id="6172715">(</span><span class="ident" id="6172716">h</span>&nbsp;<span class="ident" id="6172718">Header</span><span class="op" id="6172724">)</span>&nbsp;<span class="ident" id="6172726">Date</span><span class="op" id="6172730">(</span><span class="op" id="6172731">)</span>&nbsp;<span class="op" id="6172733">(</span><span class="ident" id="6172734">time</span><span class="op" id="6172738">.</span><span class="ident" id="6172739">Time</span><span class="op" id="6172743">,</span>&nbsp;<span class="builtintype" id="6172745">error</span><span class="op" id="6172750">)</span>&nbsp;<span class="op" id="6172752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6172755">hdr</span>&nbsp;<span class="op" id="6172759">:=</span>&nbsp;<span class="ident" id="6172762">h</span><span class="op" id="6172763">.</span><span class="ident" id="6172764">Get</span><span class="op" id="6172767">(</span><span class="string" id="6172768">&#34;Date&#34;</span><span class="op" id="6172774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172777">if</span>&nbsp;<span class="ident" id="6172780">hdr</span>&nbsp;<span class="op" id="6172784">==</span>&nbsp;<span class="string" id="6172787">&#34;&#34;</span>&nbsp;<span class="op" id="6172790">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172794">return</span>&nbsp;<span class="ident" id="6172801">time</span><span class="op" id="6172805">.</span><span class="ident" id="6172806">Time</span><span class="op" id="6172810">{</span><span class="op" id="6172811">}</span><span class="op" id="6172812">,</span>&nbsp;<span class="ident" id="6172814">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6172835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6172838">return</span>&nbsp;<span class="ident" id="6172845">parseDate</span><span class="op" id="6172854">(</span><span class="ident" id="6172855">hdr</span><span class="op" id="6172858">)</span><br>
<span class="lineno"></span><span class="op" id="6172860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="6172863">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="6172932">func</span>&nbsp;<span class="op" id="6172937">(</span><span class="ident" id="6172938">h</span>&nbsp;<span class="ident" id="6172940">Header</span><span class="op" id="6172946">)</span>&nbsp;<span class="ident" id="6172948">AddressList</span><span class="op" id="6172959">(</span><span class="ident" id="6172960">key</span>&nbsp;<span class="builtintype" id="6172964">string</span><span class="op" id="6172970">)</span>&nbsp;<span class="op" id="6172972">(</span><span class="op" id="6172973">[</span><span class="op" id="6172974">]</span><span class="op" id="6172975">*</span><span class="ident" id="6172976">Address</span><span class="op" id="6172983">,</span>&nbsp;<span class="builtintype" id="6172985">error</span><span class="op" id="6172990">)</span>&nbsp;<span class="op" id="6172992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6172995">hdr</span>&nbsp;<span class="op" id="6172999">:=</span>&nbsp;<span class="ident" id="6173002">h</span><span class="op" id="6173003">.</span><span class="ident" id="6173004">Get</span><span class="op" id="6173007">(</span><span class="ident" id="6173008">key</span><span class="op" id="6173011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173014">if</span>&nbsp;<span class="ident" id="6173017">hdr</span>&nbsp;<span class="op" id="6173021">==</span>&nbsp;<span class="string" id="6173024">&#34;&#34;</span>&nbsp;<span class="op" id="6173027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173031">return</span>&nbsp;<span class="ident" id="6173038">nil</span><span class="op" id="6173041">,</span>&nbsp;<span class="ident" id="6173043">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6173064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173067">return</span>&nbsp;<span class="ident" id="6173074">ParseAddressList</span><span class="op" id="6173090">(</span><span class="ident" id="6173091">hdr</span><span class="op" id="6173094">)</span><br>
<span class="lineno"></span><span class="op" id="6173096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6173099">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="6173144">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="6173212">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="6173275">type</span>&nbsp;<span class="ident" id="6173280">Address</span>&nbsp;<span class="keyword" id="6173288">struct</span>&nbsp;<span class="op" id="6173295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6173298">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6173306">string</span>&nbsp;<span class="comment" id="6173313">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6173344">Address</span>&nbsp;<span class="builtintype" id="6173352">string</span>&nbsp;<span class="comment" id="6173359">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="6173374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6173377">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6173450">func</span>&nbsp;<span class="ident" id="6173455">ParseAddress</span><span class="op" id="6173467">(</span><span class="ident" id="6173468">address</span>&nbsp;<span class="builtintype" id="6173476">string</span><span class="op" id="6173482">)</span>&nbsp;<span class="op" id="6173484">(</span><span class="op" id="6173485">*</span><span class="ident" id="6173486">Address</span><span class="op" id="6173493">,</span>&nbsp;<span class="builtintype" id="6173495">error</span><span class="op" id="6173500">)</span>&nbsp;<span class="op" id="6173502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173505">return</span>&nbsp;<span class="ident" id="6173512">newAddrParser</span><span class="op" id="6173525">(</span><span class="ident" id="6173526">address</span><span class="op" id="6173533">)</span><span class="op" id="6173534">.</span><span class="ident" id="6173535">parseAddress</span><span class="op" id="6173547">(</span><span class="op" id="6173548">)</span><br>
<span class="lineno">145</span><span class="op" id="6173550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6173553">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="6173621">func</span>&nbsp;<span class="ident" id="6173626">ParseAddressList</span><span class="op" id="6173642">(</span><span class="ident" id="6173643">list</span>&nbsp;<span class="builtintype" id="6173648">string</span><span class="op" id="6173654">)</span>&nbsp;<span class="op" id="6173656">(</span><span class="op" id="6173657">[</span><span class="op" id="6173658">]</span><span class="op" id="6173659">*</span><span class="ident" id="6173660">Address</span><span class="op" id="6173667">,</span>&nbsp;<span class="builtintype" id="6173669">error</span><span class="op" id="6173674">)</span>&nbsp;<span class="op" id="6173676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173679">return</span>&nbsp;<span class="ident" id="6173686">newAddrParser</span><span class="op" id="6173699">(</span><span class="ident" id="6173700">list</span><span class="op" id="6173704">)</span><span class="op" id="6173705">.</span><span class="ident" id="6173706">parseAddressList</span><span class="op" id="6173722">(</span><span class="op" id="6173723">)</span><br>
<span class="lineno">150</span><span class="op" id="6173725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6173728">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="6173787">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="6173842">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="6173894">func</span>&nbsp;<span class="op" id="6173899">(</span><span class="ident" id="6173900">a</span>&nbsp;<span class="op" id="6173902">*</span><span class="ident" id="6173903">Address</span><span class="op" id="6173910">)</span>&nbsp;<span class="ident" id="6173912">String</span><span class="op" id="6173918">(</span><span class="op" id="6173919">)</span>&nbsp;<span class="builtintype" id="6173921">string</span>&nbsp;<span class="op" id="6173928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6173931">s</span>&nbsp;<span class="op" id="6173933">:=</span>&nbsp;<span class="string" id="6173936">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="6173940">+</span>&nbsp;<span class="ident" id="6173942">a</span><span class="op" id="6173943">.</span><span class="ident" id="6173944">Address</span>&nbsp;<span class="op" id="6173952">+</span>&nbsp;<span class="string" id="6173954">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173959">if</span>&nbsp;<span class="ident" id="6173962">a</span><span class="op" id="6173963">.</span><span class="ident" id="6173964">Name</span>&nbsp;<span class="op" id="6173969">==</span>&nbsp;<span class="string" id="6173972">&#34;&#34;</span>&nbsp;<span class="op" id="6173975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6173979">return</span>&nbsp;<span class="ident" id="6173986">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6173989">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6173992">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174054">allPrintable</span>&nbsp;<span class="op" id="6174067">:=</span>&nbsp;<span class="builtintype" id="6174070">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174076">for</span>&nbsp;<span class="ident" id="6174080">i</span>&nbsp;<span class="op" id="6174082">:=</span>&nbsp;<span class="num" id="6174085">0</span><span class="op" id="6174086">;</span>&nbsp;<span class="ident" id="6174088">i</span>&nbsp;<span class="op" id="6174090">&lt;</span>&nbsp;<span class="builtinfunc" id="6174092">len</span><span class="op" id="6174095">(</span><span class="ident" id="6174096">a</span><span class="op" id="6174097">.</span><span class="ident" id="6174098">Name</span><span class="op" id="6174102">)</span><span class="op" id="6174103">;</span>&nbsp;<span class="ident" id="6174105">i</span><span class="op" id="6174106">++</span>&nbsp;<span class="op" id="6174109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6174113">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6174155">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174194">if</span>&nbsp;<span class="op" id="6174197">!</span><span class="ident" id="6174198">isVchar</span><span class="op" id="6174205">(</span><span class="ident" id="6174206">a</span><span class="op" id="6174207">.</span><span class="ident" id="6174208">Name</span><span class="op" id="6174212">[</span><span class="ident" id="6174213">i</span><span class="op" id="6174214">]</span><span class="op" id="6174215">)</span>&nbsp;<span class="op" id="6174217">&amp;&amp;</span>&nbsp;<span class="op" id="6174220">!</span><span class="ident" id="6174221">isWSP</span><span class="op" id="6174226">(</span><span class="ident" id="6174227">a</span><span class="op" id="6174228">.</span><span class="ident" id="6174229">Name</span><span class="op" id="6174233">[</span><span class="ident" id="6174234">i</span><span class="op" id="6174235">]</span><span class="op" id="6174236">)</span>&nbsp;<span class="op" id="6174238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174243">allPrintable</span>&nbsp;<span class="op" id="6174256">=</span>&nbsp;<span class="builtintype" id="6174258">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174267">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174278">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174281">if</span>&nbsp;<span class="ident" id="6174284">allPrintable</span>&nbsp;<span class="op" id="6174297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174301">b</span>&nbsp;<span class="op" id="6174303">:=</span>&nbsp;<span class="ident" id="6174306">bytes</span><span class="op" id="6174311">.</span><span class="ident" id="6174312">NewBufferString</span><span class="op" id="6174327">(</span><span class="string" id="6174328">`&#34;`</span><span class="op" id="6174331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174335">for</span>&nbsp;<span class="ident" id="6174339">i</span>&nbsp;<span class="op" id="6174341">:=</span>&nbsp;<span class="num" id="6174344">0</span><span class="op" id="6174345">;</span>&nbsp;<span class="ident" id="6174347">i</span>&nbsp;<span class="op" id="6174349">&lt;</span>&nbsp;<span class="builtinfunc" id="6174351">len</span><span class="op" id="6174354">(</span><span class="ident" id="6174355">a</span><span class="op" id="6174356">.</span><span class="ident" id="6174357">Name</span><span class="op" id="6174361">)</span><span class="op" id="6174362">;</span>&nbsp;<span class="ident" id="6174364">i</span><span class="op" id="6174365">++</span>&nbsp;<span class="op" id="6174368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174373">if</span>&nbsp;<span class="op" id="6174376">!</span><span class="ident" id="6174377">isQtext</span><span class="op" id="6174384">(</span><span class="ident" id="6174385">a</span><span class="op" id="6174386">.</span><span class="ident" id="6174387">Name</span><span class="op" id="6174391">[</span><span class="ident" id="6174392">i</span><span class="op" id="6174393">]</span><span class="op" id="6174394">)</span>&nbsp;<span class="op" id="6174396">&amp;&amp;</span>&nbsp;<span class="op" id="6174399">!</span><span class="ident" id="6174400">isWSP</span><span class="op" id="6174405">(</span><span class="ident" id="6174406">a</span><span class="op" id="6174407">.</span><span class="ident" id="6174408">Name</span><span class="op" id="6174412">[</span><span class="ident" id="6174413">i</span><span class="op" id="6174414">]</span><span class="op" id="6174415">)</span>&nbsp;<span class="op" id="6174417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174423">b</span><span class="op" id="6174424">.</span><span class="ident" id="6174425">WriteByte</span><span class="op" id="6174434">(</span><span class="string" id="6174435">&#39;\\&#39;</span><span class="op" id="6174439">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174449">b</span><span class="op" id="6174450">.</span><span class="ident" id="6174451">WriteByte</span><span class="op" id="6174460">(</span><span class="ident" id="6174461">a</span><span class="op" id="6174462">.</span><span class="ident" id="6174463">Name</span><span class="op" id="6174467">[</span><span class="ident" id="6174468">i</span><span class="op" id="6174469">]</span><span class="op" id="6174470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174478">b</span><span class="op" id="6174479">.</span><span class="ident" id="6174480">WriteString</span><span class="op" id="6174491">(</span><span class="string" id="6174492">`&#34;&nbsp;`</span><span class="op" id="6174496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174500">b</span><span class="op" id="6174501">.</span><span class="ident" id="6174502">WriteString</span><span class="op" id="6174513">(</span><span class="ident" id="6174514">s</span><span class="op" id="6174515">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174519">return</span>&nbsp;<span class="ident" id="6174526">b</span><span class="op" id="6174527">.</span><span class="ident" id="6174528">String</span><span class="op" id="6174534">(</span><span class="op" id="6174535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6174542">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174565">b</span>&nbsp;<span class="op" id="6174567">:=</span>&nbsp;<span class="ident" id="6174570">bytes</span><span class="op" id="6174575">.</span><span class="ident" id="6174576">NewBufferString</span><span class="op" id="6174591">(</span><span class="string" id="6174592">&#34;=?utf-8?q?&#34;</span><span class="op" id="6174604">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174607">for</span>&nbsp;<span class="ident" id="6174611">i</span>&nbsp;<span class="op" id="6174613">:=</span>&nbsp;<span class="num" id="6174616">0</span><span class="op" id="6174617">;</span>&nbsp;<span class="ident" id="6174619">i</span>&nbsp;<span class="op" id="6174621">&lt;</span>&nbsp;<span class="builtinfunc" id="6174623">len</span><span class="op" id="6174626">(</span><span class="ident" id="6174627">a</span><span class="op" id="6174628">.</span><span class="ident" id="6174629">Name</span><span class="op" id="6174633">)</span><span class="op" id="6174634">;</span>&nbsp;<span class="ident" id="6174636">i</span><span class="op" id="6174637">++</span>&nbsp;<span class="op" id="6174640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174644">switch</span>&nbsp;<span class="ident" id="6174651">c</span>&nbsp;<span class="op" id="6174653">:=</span>&nbsp;<span class="ident" id="6174656">a</span><span class="op" id="6174657">.</span><span class="ident" id="6174658">Name</span><span class="op" id="6174662">[</span><span class="ident" id="6174663">i</span><span class="op" id="6174664">]</span><span class="op" id="6174665">;</span>&nbsp;<span class="op" id="6174667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174671">case</span>&nbsp;<span class="ident" id="6174676">c</span>&nbsp;<span class="op" id="6174678">==</span>&nbsp;<span class="string" id="6174681">&#39;&nbsp;&#39;</span><span class="op" id="6174684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174689">b</span><span class="op" id="6174690">.</span><span class="ident" id="6174691">WriteByte</span><span class="op" id="6174700">(</span><span class="string" id="6174701">&#39;_&#39;</span><span class="op" id="6174704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174708">case</span>&nbsp;<span class="ident" id="6174713">isVchar</span><span class="op" id="6174720">(</span><span class="ident" id="6174721">c</span><span class="op" id="6174722">)</span>&nbsp;<span class="op" id="6174724">&amp;&amp;</span>&nbsp;<span class="ident" id="6174727">c</span>&nbsp;<span class="op" id="6174729">!=</span>&nbsp;<span class="string" id="6174732">&#39;=&#39;</span>&nbsp;<span class="op" id="6174736">&amp;&amp;</span>&nbsp;<span class="ident" id="6174739">c</span>&nbsp;<span class="op" id="6174741">!=</span>&nbsp;<span class="string" id="6174744">&#39;?&#39;</span>&nbsp;<span class="op" id="6174748">&amp;&amp;</span>&nbsp;<span class="ident" id="6174751">c</span>&nbsp;<span class="op" id="6174753">!=</span>&nbsp;<span class="string" id="6174756">&#39;_&#39;</span><span class="op" id="6174759">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174764">b</span><span class="op" id="6174765">.</span><span class="ident" id="6174766">WriteByte</span><span class="op" id="6174775">(</span><span class="ident" id="6174776">c</span><span class="op" id="6174777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174781">default</span><span class="op" id="6174788">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174793">fmt</span><span class="op" id="6174796">.</span><span class="ident" id="6174797">Fprintf</span><span class="op" id="6174804">(</span><span class="ident" id="6174805">b</span><span class="op" id="6174806">,</span>&nbsp;<span class="string" id="6174808">&#34;=%02X&#34;</span><span class="op" id="6174815">,</span>&nbsp;<span class="ident" id="6174817">c</span><span class="op" id="6174818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6174825">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174828">b</span><span class="op" id="6174829">.</span><span class="ident" id="6174830">WriteString</span><span class="op" id="6174841">(</span><span class="string" id="6174842">&#34;?=&nbsp;&#34;</span><span class="op" id="6174847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174850">b</span><span class="op" id="6174851">.</span><span class="ident" id="6174852">WriteString</span><span class="op" id="6174863">(</span><span class="ident" id="6174864">s</span><span class="op" id="6174865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174868">return</span>&nbsp;<span class="ident" id="6174875">b</span><span class="op" id="6174876">.</span><span class="ident" id="6174877">String</span><span class="op" id="6174883">(</span><span class="op" id="6174884">)</span><br>
<span class="lineno"></span><span class="op" id="6174886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6174889">type</span>&nbsp;<span class="ident" id="6174894">addrParser</span>&nbsp;<span class="op" id="6174905">[</span><span class="op" id="6174906">]</span><span class="builtintype" id="6174907">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6174913">func</span>&nbsp;<span class="ident" id="6174918">newAddrParser</span><span class="op" id="6174931">(</span><span class="ident" id="6174932">s</span>&nbsp;<span class="builtintype" id="6174934">string</span><span class="op" id="6174940">)</span>&nbsp;<span class="op" id="6174942">*</span><span class="ident" id="6174943">addrParser</span>&nbsp;<span class="op" id="6174954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6174957">p</span>&nbsp;<span class="op" id="6174959">:=</span>&nbsp;<span class="ident" id="6174962">addrParser</span><span class="op" id="6174972">(</span><span class="ident" id="6174973">s</span><span class="op" id="6174974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6174977">return</span>&nbsp;<span class="op" id="6174984">&amp;</span><span class="ident" id="6174985">p</span><br>
<span class="lineno">205</span><span class="op" id="6174987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6174990">func</span>&nbsp;<span class="op" id="6174995">(</span><span class="ident" id="6174996">p</span>&nbsp;<span class="op" id="6174998">*</span><span class="ident" id="6174999">addrParser</span><span class="op" id="6175009">)</span>&nbsp;<span class="ident" id="6175011">parseAddressList</span><span class="op" id="6175027">(</span><span class="op" id="6175028">)</span>&nbsp;<span class="op" id="6175030">(</span><span class="op" id="6175031">[</span><span class="op" id="6175032">]</span><span class="op" id="6175033">*</span><span class="ident" id="6175034">Address</span><span class="op" id="6175041">,</span>&nbsp;<span class="builtintype" id="6175043">error</span><span class="op" id="6175048">)</span>&nbsp;<span class="op" id="6175050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175053">var</span>&nbsp;<span class="ident" id="6175057">list</span>&nbsp;<span class="op" id="6175062">[</span><span class="op" id="6175063">]</span><span class="op" id="6175064">*</span><span class="ident" id="6175065">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175074">for</span>&nbsp;<span class="op" id="6175078">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175082">p</span><span class="op" id="6175083">.</span><span class="ident" id="6175084">skipSpace</span><span class="op" id="6175093">(</span><span class="op" id="6175094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175098">addr</span><span class="op" id="6175102">,</span>&nbsp;<span class="ident" id="6175104">err</span>&nbsp;<span class="op" id="6175108">:=</span>&nbsp;<span class="ident" id="6175111">p</span><span class="op" id="6175112">.</span><span class="ident" id="6175113">parseAddress</span><span class="op" id="6175125">(</span><span class="op" id="6175126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175130">if</span>&nbsp;<span class="ident" id="6175133">err</span>&nbsp;<span class="op" id="6175137">!=</span>&nbsp;<span class="ident" id="6175140">nil</span>&nbsp;<span class="op" id="6175144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175149">return</span>&nbsp;<span class="ident" id="6175156">nil</span><span class="op" id="6175159">,</span>&nbsp;<span class="ident" id="6175161">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175167">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175171">list</span>&nbsp;<span class="op" id="6175176">=</span>&nbsp;<span class="builtinfunc" id="6175178">append</span><span class="op" id="6175184">(</span><span class="ident" id="6175185">list</span><span class="op" id="6175189">,</span>&nbsp;<span class="ident" id="6175191">addr</span><span class="op" id="6175195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175200">p</span><span class="op" id="6175201">.</span><span class="ident" id="6175202">skipSpace</span><span class="op" id="6175211">(</span><span class="op" id="6175212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175216">if</span>&nbsp;<span class="ident" id="6175219">p</span><span class="op" id="6175220">.</span><span class="ident" id="6175221">empty</span><span class="op" id="6175226">(</span><span class="op" id="6175227">)</span>&nbsp;<span class="op" id="6175229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175234">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175246">if</span>&nbsp;<span class="op" id="6175249">!</span><span class="ident" id="6175250">p</span><span class="op" id="6175251">.</span><span class="ident" id="6175252">consume</span><span class="op" id="6175259">(</span><span class="string" id="6175260">&#39;,&#39;</span><span class="op" id="6175263">)</span>&nbsp;<span class="op" id="6175265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175270">return</span>&nbsp;<span class="ident" id="6175277">nil</span><span class="op" id="6175280">,</span>&nbsp;<span class="ident" id="6175282">errors</span><span class="op" id="6175288">.</span><span class="ident" id="6175289">New</span><span class="op" id="6175292">(</span><span class="string" id="6175293">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="6175315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175322">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175325">return</span>&nbsp;<span class="ident" id="6175332">list</span><span class="op" id="6175336">,</span>&nbsp;<span class="ident" id="6175338">nil</span><br>
<span class="lineno"></span><span class="op" id="6175342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6175345">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6175413">func</span>&nbsp;<span class="op" id="6175418">(</span><span class="ident" id="6175419">p</span>&nbsp;<span class="op" id="6175421">*</span><span class="ident" id="6175422">addrParser</span><span class="op" id="6175432">)</span>&nbsp;<span class="ident" id="6175434">parseAddress</span><span class="op" id="6175446">(</span><span class="op" id="6175447">)</span>&nbsp;<span class="op" id="6175449">(</span><span class="ident" id="6175450">addr</span>&nbsp;<span class="op" id="6175455">*</span><span class="ident" id="6175456">Address</span><span class="op" id="6175463">,</span>&nbsp;<span class="ident" id="6175465">err</span>&nbsp;<span class="builtintype" id="6175469">error</span><span class="op" id="6175474">)</span>&nbsp;<span class="op" id="6175476">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175479">debug</span><span class="op" id="6175484">.</span><span class="ident" id="6175485">Printf</span><span class="op" id="6175491">(</span><span class="string" id="6175492">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="6175510">,</span>&nbsp;<span class="op" id="6175512">*</span><span class="ident" id="6175513">p</span><span class="op" id="6175514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175517">p</span><span class="op" id="6175518">.</span><span class="ident" id="6175519">skipSpace</span><span class="op" id="6175528">(</span><span class="op" id="6175529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175532">if</span>&nbsp;<span class="ident" id="6175535">p</span><span class="op" id="6175536">.</span><span class="ident" id="6175537">empty</span><span class="op" id="6175542">(</span><span class="op" id="6175543">)</span>&nbsp;<span class="op" id="6175545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175549">return</span>&nbsp;<span class="ident" id="6175556">nil</span><span class="op" id="6175559">,</span>&nbsp;<span class="ident" id="6175561">errors</span><span class="op" id="6175567">.</span><span class="ident" id="6175568">New</span><span class="op" id="6175571">(</span><span class="string" id="6175572">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="6175590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175593">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6175597">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6175633">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6175685">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6175745">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6175801">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175845">spec</span><span class="op" id="6175849">,</span>&nbsp;<span class="ident" id="6175851">err</span>&nbsp;<span class="op" id="6175855">:=</span>&nbsp;<span class="ident" id="6175858">p</span><span class="op" id="6175859">.</span><span class="ident" id="6175860">consumeAddrSpec</span><span class="op" id="6175875">(</span><span class="op" id="6175876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175879">if</span>&nbsp;<span class="ident" id="6175882">err</span>&nbsp;<span class="op" id="6175886">==</span>&nbsp;<span class="ident" id="6175889">nil</span>&nbsp;<span class="op" id="6175893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6175897">return</span>&nbsp;<span class="op" id="6175904">&amp;</span><span class="ident" id="6175905">Address</span><span class="op" id="6175912">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175917">Address</span><span class="op" id="6175924">:</span>&nbsp;<span class="ident" id="6175926">spec</span><span class="op" id="6175930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175934">}</span><span class="op" id="6175935">,</span>&nbsp;<span class="ident" id="6175937">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6175942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6175945">debug</span><span class="op" id="6175950">.</span><span class="ident" id="6175951">Printf</span><span class="op" id="6175957">(</span><span class="string" id="6175958">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="6175994">,</span>&nbsp;<span class="ident" id="6175996">err</span><span class="op" id="6175999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176002">debug</span><span class="op" id="6176007">.</span><span class="ident" id="6176008">Printf</span><span class="op" id="6176014">(</span><span class="string" id="6176015">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="6176046">,</span>&nbsp;<span class="op" id="6176048">*</span><span class="ident" id="6176049">p</span><span class="op" id="6176050">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6176054">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176071">var</span>&nbsp;<span class="ident" id="6176075">displayName</span>&nbsp;<span class="builtintype" id="6176087">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176095">if</span>&nbsp;<span class="ident" id="6176098">p</span><span class="op" id="6176099">.</span><span class="ident" id="6176100">peek</span><span class="op" id="6176104">(</span><span class="op" id="6176105">)</span>&nbsp;<span class="op" id="6176107">!=</span>&nbsp;<span class="string" id="6176110">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="6176114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176118">displayName</span><span class="op" id="6176129">,</span>&nbsp;<span class="ident" id="6176131">err</span>&nbsp;<span class="op" id="6176135">=</span>&nbsp;<span class="ident" id="6176137">p</span><span class="op" id="6176138">.</span><span class="ident" id="6176139">consumePhrase</span><span class="op" id="6176152">(</span><span class="op" id="6176153">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176157">if</span>&nbsp;<span class="ident" id="6176160">err</span>&nbsp;<span class="op" id="6176164">!=</span>&nbsp;<span class="ident" id="6176167">nil</span>&nbsp;<span class="op" id="6176171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176176">return</span>&nbsp;<span class="ident" id="6176183">nil</span><span class="op" id="6176186">,</span>&nbsp;<span class="ident" id="6176188">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176200">debug</span><span class="op" id="6176205">.</span><span class="ident" id="6176206">Printf</span><span class="op" id="6176212">(</span><span class="string" id="6176213">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="6176243">,</span>&nbsp;<span class="ident" id="6176245">displayName</span><span class="op" id="6176256">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6176260">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176295">p</span><span class="op" id="6176296">.</span><span class="ident" id="6176297">skipSpace</span><span class="op" id="6176306">(</span><span class="op" id="6176307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176310">if</span>&nbsp;<span class="op" id="6176313">!</span><span class="ident" id="6176314">p</span><span class="op" id="6176315">.</span><span class="ident" id="6176316">consume</span><span class="op" id="6176323">(</span><span class="string" id="6176324">&#39;&lt;&#39;</span><span class="op" id="6176327">)</span>&nbsp;<span class="op" id="6176329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176333">return</span>&nbsp;<span class="ident" id="6176340">nil</span><span class="op" id="6176343">,</span>&nbsp;<span class="ident" id="6176345">errors</span><span class="op" id="6176351">.</span><span class="ident" id="6176352">New</span><span class="op" id="6176355">(</span><span class="string" id="6176356">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="6176377">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176383">spec</span><span class="op" id="6176387">,</span>&nbsp;<span class="ident" id="6176389">err</span>&nbsp;<span class="op" id="6176393">=</span>&nbsp;<span class="ident" id="6176395">p</span><span class="op" id="6176396">.</span><span class="ident" id="6176397">consumeAddrSpec</span><span class="op" id="6176412">(</span><span class="op" id="6176413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176416">if</span>&nbsp;<span class="ident" id="6176419">err</span>&nbsp;<span class="op" id="6176423">!=</span>&nbsp;<span class="ident" id="6176426">nil</span>&nbsp;<span class="op" id="6176430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176434">return</span>&nbsp;<span class="ident" id="6176441">nil</span><span class="op" id="6176444">,</span>&nbsp;<span class="ident" id="6176446">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176451">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176454">if</span>&nbsp;<span class="op" id="6176457">!</span><span class="ident" id="6176458">p</span><span class="op" id="6176459">.</span><span class="ident" id="6176460">consume</span><span class="op" id="6176467">(</span><span class="string" id="6176468">&#39;&gt;&#39;</span><span class="op" id="6176471">)</span>&nbsp;<span class="op" id="6176473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176477">return</span>&nbsp;<span class="ident" id="6176484">nil</span><span class="op" id="6176487">,</span>&nbsp;<span class="ident" id="6176489">errors</span><span class="op" id="6176495">.</span><span class="ident" id="6176496">New</span><span class="op" id="6176499">(</span><span class="string" id="6176500">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="6176527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176533">debug</span><span class="op" id="6176538">.</span><span class="ident" id="6176539">Printf</span><span class="op" id="6176545">(</span><span class="string" id="6176546">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="6176569">,</span>&nbsp;<span class="ident" id="6176571">spec</span><span class="op" id="6176575">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176579">return</span>&nbsp;<span class="op" id="6176586">&amp;</span><span class="ident" id="6176587">Address</span><span class="op" id="6176594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176598">Name</span><span class="op" id="6176602">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6176607">displayName</span><span class="op" id="6176618">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176622">Address</span><span class="op" id="6176629">:</span>&nbsp;<span class="ident" id="6176631">spec</span><span class="op" id="6176635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176638">}</span><span class="op" id="6176639">,</span>&nbsp;<span class="ident" id="6176641">nil</span><br>
<span class="lineno"></span><span class="op" id="6176645">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="6176648">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6176721">func</span>&nbsp;<span class="op" id="6176726">(</span><span class="ident" id="6176727">p</span>&nbsp;<span class="op" id="6176729">*</span><span class="ident" id="6176730">addrParser</span><span class="op" id="6176740">)</span>&nbsp;<span class="ident" id="6176742">consumeAddrSpec</span><span class="op" id="6176757">(</span><span class="op" id="6176758">)</span>&nbsp;<span class="op" id="6176760">(</span><span class="ident" id="6176761">spec</span>&nbsp;<span class="builtintype" id="6176766">string</span><span class="op" id="6176772">,</span>&nbsp;<span class="ident" id="6176774">err</span>&nbsp;<span class="builtintype" id="6176778">error</span><span class="op" id="6176783">)</span>&nbsp;<span class="op" id="6176785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176788">debug</span><span class="op" id="6176793">.</span><span class="ident" id="6176794">Printf</span><span class="op" id="6176800">(</span><span class="string" id="6176801">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="6176822">,</span>&nbsp;<span class="op" id="6176824">*</span><span class="ident" id="6176825">p</span><span class="op" id="6176826">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176830">orig</span>&nbsp;<span class="op" id="6176835">:=</span>&nbsp;<span class="op" id="6176838">*</span><span class="ident" id="6176839">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176842">defer</span>&nbsp;<span class="keyword" id="6176848">func</span><span class="op" id="6176852">(</span><span class="op" id="6176853">)</span>&nbsp;<span class="op" id="6176855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176859">if</span>&nbsp;<span class="ident" id="6176862">err</span>&nbsp;<span class="op" id="6176866">!=</span>&nbsp;<span class="ident" id="6176869">nil</span>&nbsp;<span class="op" id="6176873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176878">*</span><span class="ident" id="6176879">p</span>&nbsp;<span class="op" id="6176881">=</span>&nbsp;<span class="ident" id="6176883">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176890">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6176893">}</span><span class="op" id="6176894">(</span><span class="op" id="6176895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6176899">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176941">var</span>&nbsp;<span class="ident" id="6176945">localPart</span>&nbsp;<span class="builtintype" id="6176955">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6176963">p</span><span class="op" id="6176964">.</span><span class="ident" id="6176965">skipSpace</span><span class="op" id="6176974">(</span><span class="op" id="6176975">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176978">if</span>&nbsp;<span class="ident" id="6176981">p</span><span class="op" id="6176982">.</span><span class="ident" id="6176983">empty</span><span class="op" id="6176988">(</span><span class="op" id="6176989">)</span>&nbsp;<span class="op" id="6176991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6176995">return</span>&nbsp;<span class="string" id="6177002">&#34;&#34;</span><span class="op" id="6177004">,</span>&nbsp;<span class="ident" id="6177006">errors</span><span class="op" id="6177012">.</span><span class="ident" id="6177013">New</span><span class="op" id="6177016">(</span><span class="string" id="6177017">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="6177037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177043">if</span>&nbsp;<span class="ident" id="6177046">p</span><span class="op" id="6177047">.</span><span class="ident" id="6177048">peek</span><span class="op" id="6177052">(</span><span class="op" id="6177053">)</span>&nbsp;<span class="op" id="6177055">==</span>&nbsp;<span class="string" id="6177058">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6177062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6177066">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177085">debug</span><span class="op" id="6177090">.</span><span class="ident" id="6177091">Printf</span><span class="op" id="6177097">(</span><span class="string" id="6177098">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="6177138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177142">localPart</span><span class="op" id="6177151">,</span>&nbsp;<span class="ident" id="6177153">err</span>&nbsp;<span class="op" id="6177157">=</span>&nbsp;<span class="ident" id="6177159">p</span><span class="op" id="6177160">.</span><span class="ident" id="6177161">consumeQuotedString</span><span class="op" id="6177180">(</span><span class="op" id="6177181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177184">}</span>&nbsp;<span class="keyword" id="6177186">else</span>&nbsp;<span class="op" id="6177191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6177195">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177209">debug</span><span class="op" id="6177214">.</span><span class="ident" id="6177215">Printf</span><span class="op" id="6177221">(</span><span class="string" id="6177222">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="6177257">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177261">localPart</span><span class="op" id="6177270">,</span>&nbsp;<span class="ident" id="6177272">err</span>&nbsp;<span class="op" id="6177276">=</span>&nbsp;<span class="ident" id="6177278">p</span><span class="op" id="6177279">.</span><span class="ident" id="6177280">consumeAtom</span><span class="op" id="6177291">(</span><span class="builtintype" id="6177292">true</span><span class="op" id="6177296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177302">if</span>&nbsp;<span class="ident" id="6177305">err</span>&nbsp;<span class="op" id="6177309">!=</span>&nbsp;<span class="ident" id="6177312">nil</span>&nbsp;<span class="op" id="6177316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177320">debug</span><span class="op" id="6177325">.</span><span class="ident" id="6177326">Printf</span><span class="op" id="6177332">(</span><span class="string" id="6177333">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6177362">,</span>&nbsp;<span class="ident" id="6177364">err</span><span class="op" id="6177367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177371">return</span>&nbsp;<span class="string" id="6177378">&#34;&#34;</span><span class="op" id="6177380">,</span>&nbsp;<span class="ident" id="6177382">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177391">if</span>&nbsp;<span class="op" id="6177394">!</span><span class="ident" id="6177395">p</span><span class="op" id="6177396">.</span><span class="ident" id="6177397">consume</span><span class="op" id="6177404">(</span><span class="string" id="6177405">&#39;@&#39;</span><span class="op" id="6177408">)</span>&nbsp;<span class="op" id="6177410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177414">return</span>&nbsp;<span class="string" id="6177421">&#34;&#34;</span><span class="op" id="6177423">,</span>&nbsp;<span class="ident" id="6177425">errors</span><span class="op" id="6177431">.</span><span class="ident" id="6177432">New</span><span class="op" id="6177435">(</span><span class="string" id="6177436">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="6177466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177469">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6177473">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177512">var</span>&nbsp;<span class="ident" id="6177516">domain</span>&nbsp;<span class="builtintype" id="6177523">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177531">p</span><span class="op" id="6177532">.</span><span class="ident" id="6177533">skipSpace</span><span class="op" id="6177542">(</span><span class="op" id="6177543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177546">if</span>&nbsp;<span class="ident" id="6177549">p</span><span class="op" id="6177550">.</span><span class="ident" id="6177551">empty</span><span class="op" id="6177556">(</span><span class="op" id="6177557">)</span>&nbsp;<span class="op" id="6177559">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177563">return</span>&nbsp;<span class="string" id="6177570">&#34;&#34;</span><span class="op" id="6177572">,</span>&nbsp;<span class="ident" id="6177574">errors</span><span class="op" id="6177580">.</span><span class="ident" id="6177581">New</span><span class="op" id="6177584">(</span><span class="string" id="6177585">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="6177615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6177621">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177663">domain</span><span class="op" id="6177669">,</span>&nbsp;<span class="ident" id="6177671">err</span>&nbsp;<span class="op" id="6177675">=</span>&nbsp;<span class="ident" id="6177677">p</span><span class="op" id="6177678">.</span><span class="ident" id="6177679">consumeAtom</span><span class="op" id="6177690">(</span><span class="builtintype" id="6177691">true</span><span class="op" id="6177695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177698">if</span>&nbsp;<span class="ident" id="6177701">err</span>&nbsp;<span class="op" id="6177705">!=</span>&nbsp;<span class="ident" id="6177708">nil</span>&nbsp;<span class="op" id="6177712">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177716">return</span>&nbsp;<span class="string" id="6177723">&#34;&#34;</span><span class="op" id="6177725">,</span>&nbsp;<span class="ident" id="6177727">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6177732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177736">return</span>&nbsp;<span class="ident" id="6177743">localPart</span>&nbsp;<span class="op" id="6177753">+</span>&nbsp;<span class="string" id="6177755">&#34;@&#34;</span>&nbsp;<span class="op" id="6177759">+</span>&nbsp;<span class="ident" id="6177761">domain</span><span class="op" id="6177767">,</span>&nbsp;<span class="ident" id="6177769">nil</span><br>
<span class="lineno"></span><span class="op" id="6177773">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="6177776">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6177839">func</span>&nbsp;<span class="op" id="6177844">(</span><span class="ident" id="6177845">p</span>&nbsp;<span class="op" id="6177847">*</span><span class="ident" id="6177848">addrParser</span><span class="op" id="6177858">)</span>&nbsp;<span class="ident" id="6177860">consumePhrase</span><span class="op" id="6177873">(</span><span class="op" id="6177874">)</span>&nbsp;<span class="op" id="6177876">(</span><span class="ident" id="6177877">phrase</span>&nbsp;<span class="builtintype" id="6177884">string</span><span class="op" id="6177890">,</span>&nbsp;<span class="ident" id="6177892">err</span>&nbsp;<span class="builtintype" id="6177896">error</span><span class="op" id="6177901">)</span>&nbsp;<span class="op" id="6177903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6177906">debug</span><span class="op" id="6177911">.</span><span class="ident" id="6177912">Printf</span><span class="op" id="6177918">(</span><span class="string" id="6177919">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="6177940">,</span>&nbsp;<span class="op" id="6177942">*</span><span class="ident" id="6177943">p</span><span class="op" id="6177944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6177947">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177967">var</span>&nbsp;<span class="ident" id="6177971">words</span>&nbsp;<span class="op" id="6177977">[</span><span class="op" id="6177978">]</span><span class="builtintype" id="6177979">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6177987">for</span>&nbsp;<span class="op" id="6177991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6177995">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178028">var</span>&nbsp;<span class="ident" id="6178032">word</span>&nbsp;<span class="builtintype" id="6178037">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178046">p</span><span class="op" id="6178047">.</span><span class="ident" id="6178048">skipSpace</span><span class="op" id="6178057">(</span><span class="op" id="6178058">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178062">if</span>&nbsp;<span class="ident" id="6178065">p</span><span class="op" id="6178066">.</span><span class="ident" id="6178067">empty</span><span class="op" id="6178072">(</span><span class="op" id="6178073">)</span>&nbsp;<span class="op" id="6178075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178080">return</span>&nbsp;<span class="string" id="6178087">&#34;&#34;</span><span class="op" id="6178089">,</span>&nbsp;<span class="ident" id="6178091">errors</span><span class="op" id="6178097">.</span><span class="ident" id="6178098">New</span><span class="op" id="6178101">(</span><span class="string" id="6178102">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="6178124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178132">if</span>&nbsp;<span class="ident" id="6178135">p</span><span class="op" id="6178136">.</span><span class="ident" id="6178137">peek</span><span class="op" id="6178141">(</span><span class="op" id="6178142">)</span>&nbsp;<span class="op" id="6178144">==</span>&nbsp;<span class="string" id="6178147">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6178151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6178156">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178176">word</span><span class="op" id="6178180">,</span>&nbsp;<span class="ident" id="6178182">err</span>&nbsp;<span class="op" id="6178186">=</span>&nbsp;<span class="ident" id="6178188">p</span><span class="op" id="6178189">.</span><span class="ident" id="6178190">consumeQuotedString</span><span class="op" id="6178209">(</span><span class="op" id="6178210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178214">}</span>&nbsp;<span class="keyword" id="6178216">else</span>&nbsp;<span class="op" id="6178221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6178226">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6178237">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6178297">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178333">word</span><span class="op" id="6178337">,</span>&nbsp;<span class="ident" id="6178339">err</span>&nbsp;<span class="op" id="6178343">=</span>&nbsp;<span class="ident" id="6178345">p</span><span class="op" id="6178346">.</span><span class="ident" id="6178347">consumeAtom</span><span class="op" id="6178358">(</span><span class="builtintype" id="6178359">true</span><span class="op" id="6178363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6178372">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178451">if</span>&nbsp;<span class="ident" id="6178454">err</span>&nbsp;<span class="op" id="6178458">==</span>&nbsp;<span class="ident" id="6178461">nil</span>&nbsp;<span class="op" id="6178465">&amp;&amp;</span>&nbsp;<span class="ident" id="6178468">strings</span><span class="op" id="6178475">.</span><span class="ident" id="6178476">HasPrefix</span><span class="op" id="6178485">(</span><span class="ident" id="6178486">word</span><span class="op" id="6178490">,</span>&nbsp;<span class="string" id="6178492">&#34;=?&#34;</span><span class="op" id="6178496">)</span>&nbsp;<span class="op" id="6178498">&amp;&amp;</span>&nbsp;<span class="ident" id="6178501">strings</span><span class="op" id="6178508">.</span><span class="ident" id="6178509">HasSuffix</span><span class="op" id="6178518">(</span><span class="ident" id="6178519">word</span><span class="op" id="6178523">,</span>&nbsp;<span class="string" id="6178525">&#34;?=&#34;</span><span class="op" id="6178529">)</span>&nbsp;<span class="op" id="6178531">&amp;&amp;</span>&nbsp;<span class="ident" id="6178534">strings</span><span class="op" id="6178541">.</span><span class="ident" id="6178542">Count</span><span class="op" id="6178547">(</span><span class="ident" id="6178548">word</span><span class="op" id="6178552">,</span>&nbsp;<span class="string" id="6178554">&#34;?&#34;</span><span class="op" id="6178557">)</span>&nbsp;<span class="op" id="6178559">==</span>&nbsp;<span class="num" id="6178562">4</span>&nbsp;<span class="op" id="6178564">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178569">word</span><span class="op" id="6178573">,</span>&nbsp;<span class="ident" id="6178575">err</span>&nbsp;<span class="op" id="6178579">=</span>&nbsp;<span class="ident" id="6178581">decodeRFC2047Word</span><span class="op" id="6178598">(</span><span class="ident" id="6178599">word</span><span class="op" id="6178603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178612">if</span>&nbsp;<span class="ident" id="6178615">err</span>&nbsp;<span class="op" id="6178619">!=</span>&nbsp;<span class="ident" id="6178622">nil</span>&nbsp;<span class="op" id="6178626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178631">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178643">debug</span><span class="op" id="6178648">.</span><span class="ident" id="6178649">Printf</span><span class="op" id="6178655">(</span><span class="string" id="6178656">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="6178684">,</span>&nbsp;<span class="ident" id="6178686">word</span><span class="op" id="6178690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178694">words</span>&nbsp;<span class="op" id="6178700">=</span>&nbsp;<span class="builtinfunc" id="6178702">append</span><span class="op" id="6178708">(</span><span class="ident" id="6178709">words</span><span class="op" id="6178714">,</span>&nbsp;<span class="ident" id="6178716">word</span><span class="op" id="6178720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6178726">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178776">if</span>&nbsp;<span class="ident" id="6178779">err</span>&nbsp;<span class="op" id="6178783">!=</span>&nbsp;<span class="ident" id="6178786">nil</span>&nbsp;<span class="op" id="6178790">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6178793">len</span><span class="op" id="6178796">(</span><span class="ident" id="6178797">words</span><span class="op" id="6178802">)</span>&nbsp;<span class="op" id="6178804">==</span>&nbsp;<span class="num" id="6178807">0</span>&nbsp;<span class="op" id="6178809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178813">debug</span><span class="op" id="6178818">.</span><span class="ident" id="6178819">Printf</span><span class="op" id="6178825">(</span><span class="string" id="6178826">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="6178854">,</span>&nbsp;<span class="ident" id="6178856">err</span><span class="op" id="6178859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178863">return</span>&nbsp;<span class="string" id="6178870">&#34;&#34;</span><span class="op" id="6178872">,</span>&nbsp;<span class="ident" id="6178874">fmt</span><span class="op" id="6178877">.</span><span class="ident" id="6178878">Errorf</span><span class="op" id="6178884">(</span><span class="string" id="6178885">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="6178919">,</span>&nbsp;<span class="ident" id="6178921">err</span><span class="op" id="6178924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6178927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6178930">phrase</span>&nbsp;<span class="op" id="6178937">=</span>&nbsp;<span class="ident" id="6178939">strings</span><span class="op" id="6178946">.</span><span class="ident" id="6178947">Join</span><span class="op" id="6178951">(</span><span class="ident" id="6178952">words</span><span class="op" id="6178957">,</span>&nbsp;<span class="string" id="6178959">&#34;&nbsp;&#34;</span><span class="op" id="6178962">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6178965">return</span>&nbsp;<span class="ident" id="6178972">phrase</span><span class="op" id="6178978">,</span>&nbsp;<span class="ident" id="6178980">nil</span><br>
<span class="lineno"></span><span class="op" id="6178984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6178987">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6179054">func</span>&nbsp;<span class="op" id="6179059">(</span><span class="ident" id="6179060">p</span>&nbsp;<span class="op" id="6179062">*</span><span class="ident" id="6179063">addrParser</span><span class="op" id="6179073">)</span>&nbsp;<span class="ident" id="6179075">consumeQuotedString</span><span class="op" id="6179094">(</span><span class="op" id="6179095">)</span>&nbsp;<span class="op" id="6179097">(</span><span class="ident" id="6179098">qs</span>&nbsp;<span class="builtintype" id="6179101">string</span><span class="op" id="6179107">,</span>&nbsp;<span class="ident" id="6179109">err</span>&nbsp;<span class="builtintype" id="6179113">error</span><span class="op" id="6179118">)</span>&nbsp;<span class="op" id="6179120">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6179123">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6179153">i</span>&nbsp;<span class="op" id="6179155">:=</span>&nbsp;<span class="num" id="6179158">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6179161">qsb</span>&nbsp;<span class="op" id="6179165">:=</span>&nbsp;<span class="builtinfunc" id="6179168">make</span><span class="op" id="6179172">(</span><span class="op" id="6179173">[</span><span class="op" id="6179174">]</span><span class="builtintype" id="6179175">byte</span><span class="op" id="6179179">,</span>&nbsp;<span class="num" id="6179181">0</span><span class="op" id="6179182">,</span>&nbsp;<span class="num" id="6179184">10</span><span class="op" id="6179186">)</span><br>
<span class="lineno"></span><span class="ident" id="6179188">Loop</span><span class="op" id="6179192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179195">for</span>&nbsp;<span class="op" id="6179199">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179203">if</span>&nbsp;<span class="ident" id="6179206">i</span>&nbsp;<span class="op" id="6179208">&gt;=</span>&nbsp;<span class="ident" id="6179211">p</span><span class="op" id="6179212">.</span><span class="builtinfunc" id="6179213">len</span><span class="op" id="6179216">(</span><span class="op" id="6179217">)</span>&nbsp;<span class="op" id="6179219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179224">return</span>&nbsp;<span class="string" id="6179231">&#34;&#34;</span><span class="op" id="6179233">,</span>&nbsp;<span class="ident" id="6179235">errors</span><span class="op" id="6179241">.</span><span class="ident" id="6179242">New</span><span class="op" id="6179245">(</span><span class="string" id="6179246">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="6179276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6179280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179284">switch</span>&nbsp;<span class="ident" id="6179291">c</span>&nbsp;<span class="op" id="6179293">:=</span>&nbsp;<span class="op" id="6179296">(</span><span class="op" id="6179297">*</span><span class="ident" id="6179298">p</span><span class="op" id="6179299">)</span><span class="op" id="6179300">[</span><span class="ident" id="6179301">i</span><span class="op" id="6179302">]</span><span class="op" id="6179303">;</span>&nbsp;<span class="op" id="6179305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179309">case</span>&nbsp;<span class="ident" id="6179314">c</span>&nbsp;<span class="op" id="6179316">==</span>&nbsp;<span class="string" id="6179319">&#39;&#34;&#39;</span><span class="op" id="6179322">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179327">break</span>&nbsp;<span class="ident" id="6179333">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179340">case</span>&nbsp;<span class="ident" id="6179345">c</span>&nbsp;<span class="op" id="6179347">==</span>&nbsp;<span class="string" id="6179350">&#39;\\&#39;</span><span class="op" id="6179354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179359">if</span>&nbsp;<span class="ident" id="6179362">i</span><span class="op" id="6179363">+</span><span class="num" id="6179364">1</span>&nbsp;<span class="op" id="6179366">==</span>&nbsp;<span class="ident" id="6179369">p</span><span class="op" id="6179370">.</span><span class="builtinfunc" id="6179371">len</span><span class="op" id="6179374">(</span><span class="op" id="6179375">)</span>&nbsp;<span class="op" id="6179377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179383">return</span>&nbsp;<span class="string" id="6179390">&#34;&#34;</span><span class="op" id="6179392">,</span>&nbsp;<span class="ident" id="6179394">errors</span><span class="op" id="6179400">.</span><span class="ident" id="6179401">New</span><span class="op" id="6179404">(</span><span class="string" id="6179405">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="6179435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6179440">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6179445">qsb</span>&nbsp;<span class="op" id="6179449">=</span>&nbsp;<span class="builtinfunc" id="6179451">append</span><span class="op" id="6179457">(</span><span class="ident" id="6179458">qsb</span><span class="op" id="6179461">,</span>&nbsp;<span class="op" id="6179463">(</span><span class="op" id="6179464">*</span><span class="ident" id="6179465">p</span><span class="op" id="6179466">)</span><span class="op" id="6179467">[</span><span class="ident" id="6179468">i</span><span class="op" id="6179469">+</span><span class="num" id="6179470">1</span><span class="op" id="6179471">]</span><span class="op" id="6179472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6179477">i</span>&nbsp;<span class="op" id="6179479">+=</span>&nbsp;<span class="num" id="6179482">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179486">case</span>&nbsp;<span class="ident" id="6179491">isQtext</span><span class="op" id="6179498">(</span><span class="ident" id="6179499">c</span><span class="op" id="6179500">)</span><span class="op" id="6179501">,</span>&nbsp;<span class="ident" id="6179503">c</span>&nbsp;<span class="op" id="6179505">==</span>&nbsp;<span class="string" id="6179508">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6179512">||</span>&nbsp;<span class="ident" id="6179515">c</span>&nbsp;<span class="op" id="6179517">==</span>&nbsp;<span class="string" id="6179520">&#39;\t&#39;</span><span class="op" id="6179524">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6179529">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6179584">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6179624">qsb</span>&nbsp;<span class="op" id="6179628">=</span>&nbsp;<span class="builtinfunc" id="6179630">append</span><span class="op" id="6179636">(</span><span class="ident" id="6179637">qsb</span><span class="op" id="6179640">,</span>&nbsp;<span class="ident" id="6179642">c</span><span class="op" id="6179643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6179648">i</span><span class="op" id="6179649">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179654">default</span><span class="op" id="6179661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179666">return</span>&nbsp;<span class="string" id="6179673">&#34;&#34;</span><span class="op" id="6179675">,</span>&nbsp;<span class="ident" id="6179677">fmt</span><span class="op" id="6179680">.</span><span class="ident" id="6179681">Errorf</span><span class="op" id="6179687">(</span><span class="string" id="6179688">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="6179730">,</span>&nbsp;<span class="ident" id="6179732">c</span><span class="op" id="6179733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6179737">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6179740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6179743">*</span><span class="ident" id="6179744">p</span>&nbsp;<span class="op" id="6179746">=</span>&nbsp;<span class="op" id="6179748">(</span><span class="op" id="6179749">*</span><span class="ident" id="6179750">p</span><span class="op" id="6179751">)</span><span class="op" id="6179752">[</span><span class="ident" id="6179753">i</span><span class="op" id="6179754">+</span><span class="num" id="6179755">1</span><span class="op" id="6179756">:</span><span class="op" id="6179757">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179760">return</span>&nbsp;<span class="builtintype" id="6179767">string</span><span class="op" id="6179773">(</span><span class="ident" id="6179774">qsb</span><span class="op" id="6179777">)</span><span class="op" id="6179778">,</span>&nbsp;<span class="ident" id="6179780">nil</span><br>
<span class="lineno"></span><span class="op" id="6179784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="6179787">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="6179845">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6179913">func</span>&nbsp;<span class="op" id="6179918">(</span><span class="ident" id="6179919">p</span>&nbsp;<span class="op" id="6179921">*</span><span class="ident" id="6179922">addrParser</span><span class="op" id="6179932">)</span>&nbsp;<span class="ident" id="6179934">consumeAtom</span><span class="op" id="6179945">(</span><span class="ident" id="6179946">dot</span>&nbsp;<span class="builtintype" id="6179950">bool</span><span class="op" id="6179954">)</span>&nbsp;<span class="op" id="6179956">(</span><span class="ident" id="6179957">atom</span>&nbsp;<span class="builtintype" id="6179962">string</span><span class="op" id="6179968">,</span>&nbsp;<span class="ident" id="6179970">err</span>&nbsp;<span class="builtintype" id="6179974">error</span><span class="op" id="6179979">)</span>&nbsp;<span class="op" id="6179981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6179984">if</span>&nbsp;<span class="op" id="6179987">!</span><span class="ident" id="6179988">isAtext</span><span class="op" id="6179995">(</span><span class="ident" id="6179996">p</span><span class="op" id="6179997">.</span><span class="ident" id="6179998">peek</span><span class="op" id="6180002">(</span><span class="op" id="6180003">)</span><span class="op" id="6180004">,</span>&nbsp;<span class="builtintype" id="6180006">false</span><span class="op" id="6180011">)</span>&nbsp;<span class="op" id="6180013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180017">return</span>&nbsp;<span class="string" id="6180024">&#34;&#34;</span><span class="op" id="6180026">,</span>&nbsp;<span class="ident" id="6180028">errors</span><span class="op" id="6180034">.</span><span class="ident" id="6180035">New</span><span class="op" id="6180038">(</span><span class="string" id="6180039">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="6180061">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6180064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6180067">i</span>&nbsp;<span class="op" id="6180069">:=</span>&nbsp;<span class="num" id="6180072">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180075">for</span>&nbsp;<span class="op" id="6180079">;</span>&nbsp;<span class="ident" id="6180081">i</span>&nbsp;<span class="op" id="6180083">&lt;</span>&nbsp;<span class="ident" id="6180085">p</span><span class="op" id="6180086">.</span><span class="builtinfunc" id="6180087">len</span><span class="op" id="6180090">(</span><span class="op" id="6180091">)</span>&nbsp;<span class="op" id="6180093">&amp;&amp;</span>&nbsp;<span class="ident" id="6180096">isAtext</span><span class="op" id="6180103">(</span><span class="op" id="6180104">(</span><span class="op" id="6180105">*</span><span class="ident" id="6180106">p</span><span class="op" id="6180107">)</span><span class="op" id="6180108">[</span><span class="ident" id="6180109">i</span><span class="op" id="6180110">]</span><span class="op" id="6180111">,</span>&nbsp;<span class="ident" id="6180113">dot</span><span class="op" id="6180116">)</span><span class="op" id="6180117">;</span>&nbsp;<span class="ident" id="6180119">i</span><span class="op" id="6180120">++</span>&nbsp;<span class="op" id="6180123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6180126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6180129">atom</span><span class="op" id="6180133">,</span>&nbsp;<span class="op" id="6180135">*</span><span class="ident" id="6180136">p</span>&nbsp;<span class="op" id="6180138">=</span>&nbsp;<span class="builtintype" id="6180140">string</span><span class="op" id="6180146">(</span><span class="op" id="6180147">(</span><span class="op" id="6180148">*</span><span class="ident" id="6180149">p</span><span class="op" id="6180150">)</span><span class="op" id="6180151">[</span><span class="op" id="6180152">:</span><span class="ident" id="6180153">i</span><span class="op" id="6180154">]</span><span class="op" id="6180155">)</span><span class="op" id="6180156">,</span>&nbsp;<span class="op" id="6180158">(</span><span class="op" id="6180159">*</span><span class="ident" id="6180160">p</span><span class="op" id="6180161">)</span><span class="op" id="6180162">[</span><span class="ident" id="6180163">i</span><span class="op" id="6180164">:</span><span class="op" id="6180165">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180168">return</span>&nbsp;<span class="ident" id="6180175">atom</span><span class="op" id="6180179">,</span>&nbsp;<span class="ident" id="6180181">nil</span><br>
<span class="lineno"></span><span class="op" id="6180185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6180188">func</span>&nbsp;<span class="op" id="6180193">(</span><span class="ident" id="6180194">p</span>&nbsp;<span class="op" id="6180196">*</span><span class="ident" id="6180197">addrParser</span><span class="op" id="6180207">)</span>&nbsp;<span class="ident" id="6180209">consume</span><span class="op" id="6180216">(</span><span class="ident" id="6180217">c</span>&nbsp;<span class="builtintype" id="6180219">byte</span><span class="op" id="6180223">)</span>&nbsp;<span class="builtintype" id="6180225">bool</span>&nbsp;<span class="op" id="6180230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180233">if</span>&nbsp;<span class="ident" id="6180236">p</span><span class="op" id="6180237">.</span><span class="ident" id="6180238">empty</span><span class="op" id="6180243">(</span><span class="op" id="6180244">)</span>&nbsp;<span class="op" id="6180246">||</span>&nbsp;<span class="ident" id="6180249">p</span><span class="op" id="6180250">.</span><span class="ident" id="6180251">peek</span><span class="op" id="6180255">(</span><span class="op" id="6180256">)</span>&nbsp;<span class="op" id="6180258">!=</span>&nbsp;<span class="ident" id="6180261">c</span>&nbsp;<span class="op" id="6180263">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180267">return</span>&nbsp;<span class="builtintype" id="6180274">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6180281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6180284">*</span><span class="ident" id="6180285">p</span>&nbsp;<span class="op" id="6180287">=</span>&nbsp;<span class="op" id="6180289">(</span><span class="op" id="6180290">*</span><span class="ident" id="6180291">p</span><span class="op" id="6180292">)</span><span class="op" id="6180293">[</span><span class="num" id="6180294">1</span><span class="op" id="6180295">:</span><span class="op" id="6180296">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180299">return</span>&nbsp;<span class="builtintype" id="6180306">true</span><br>
<span class="lineno"></span><span class="op" id="6180311">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="6180314">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="6180371">func</span>&nbsp;<span class="op" id="6180376">(</span><span class="ident" id="6180377">p</span>&nbsp;<span class="op" id="6180379">*</span><span class="ident" id="6180380">addrParser</span><span class="op" id="6180390">)</span>&nbsp;<span class="ident" id="6180392">skipSpace</span><span class="op" id="6180401">(</span><span class="op" id="6180402">)</span>&nbsp;<span class="op" id="6180404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6180407">*</span><span class="ident" id="6180408">p</span>&nbsp;<span class="op" id="6180410">=</span>&nbsp;<span class="ident" id="6180412">bytes</span><span class="op" id="6180417">.</span><span class="ident" id="6180418">TrimLeft</span><span class="op" id="6180426">(</span><span class="op" id="6180427">*</span><span class="ident" id="6180428">p</span><span class="op" id="6180429">,</span>&nbsp;<span class="string" id="6180431">&#34;&nbsp;\t&#34;</span><span class="op" id="6180436">)</span><br>
<span class="lineno"></span><span class="op" id="6180438">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="6180441">func</span>&nbsp;<span class="op" id="6180446">(</span><span class="ident" id="6180447">p</span>&nbsp;<span class="op" id="6180449">*</span><span class="ident" id="6180450">addrParser</span><span class="op" id="6180460">)</span>&nbsp;<span class="ident" id="6180462">peek</span><span class="op" id="6180466">(</span><span class="op" id="6180467">)</span>&nbsp;<span class="builtintype" id="6180469">byte</span>&nbsp;<span class="op" id="6180474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180477">return</span>&nbsp;<span class="op" id="6180484">(</span><span class="op" id="6180485">*</span><span class="ident" id="6180486">p</span><span class="op" id="6180487">)</span><span class="op" id="6180488">[</span><span class="num" id="6180489">0</span><span class="op" id="6180490">]</span><br>
<span class="lineno"></span><span class="op" id="6180492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6180495">func</span>&nbsp;<span class="op" id="6180500">(</span><span class="ident" id="6180501">p</span>&nbsp;<span class="op" id="6180503">*</span><span class="ident" id="6180504">addrParser</span><span class="op" id="6180514">)</span>&nbsp;<span class="ident" id="6180516">empty</span><span class="op" id="6180521">(</span><span class="op" id="6180522">)</span>&nbsp;<span class="builtintype" id="6180524">bool</span>&nbsp;<span class="op" id="6180529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180532">return</span>&nbsp;<span class="ident" id="6180539">p</span><span class="op" id="6180540">.</span><span class="builtinfunc" id="6180541">len</span><span class="op" id="6180544">(</span><span class="op" id="6180545">)</span>&nbsp;<span class="op" id="6180547">==</span>&nbsp;<span class="num" id="6180550">0</span><br>
<span class="lineno"></span><span class="op" id="6180552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6180555">func</span>&nbsp;<span class="op" id="6180560">(</span><span class="ident" id="6180561">p</span>&nbsp;<span class="op" id="6180563">*</span><span class="ident" id="6180564">addrParser</span><span class="op" id="6180574">)</span>&nbsp;<span class="builtinfunc" id="6180576">len</span><span class="op" id="6180579">(</span><span class="op" id="6180580">)</span>&nbsp;<span class="builtintype" id="6180582">int</span>&nbsp;<span class="op" id="6180586">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180589">return</span>&nbsp;<span class="builtinfunc" id="6180596">len</span><span class="op" id="6180599">(</span><span class="op" id="6180600">*</span><span class="ident" id="6180601">p</span><span class="op" id="6180602">)</span><br>
<span class="lineno"></span><span class="op" id="6180604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6180607">func</span>&nbsp;<span class="ident" id="6180612">decodeRFC2047Word</span><span class="op" id="6180629">(</span><span class="ident" id="6180630">s</span>&nbsp;<span class="builtintype" id="6180632">string</span><span class="op" id="6180638">)</span>&nbsp;<span class="op" id="6180640">(</span><span class="builtintype" id="6180641">string</span><span class="op" id="6180647">,</span>&nbsp;<span class="builtintype" id="6180649">error</span><span class="op" id="6180654">)</span>&nbsp;<span class="op" id="6180656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6180659">fields</span>&nbsp;<span class="op" id="6180666">:=</span>&nbsp;<span class="ident" id="6180669">strings</span><span class="op" id="6180676">.</span><span class="ident" id="6180677">Split</span><span class="op" id="6180682">(</span><span class="ident" id="6180683">s</span><span class="op" id="6180684">,</span>&nbsp;<span class="string" id="6180686">&#34;?&#34;</span><span class="op" id="6180689">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180692">if</span>&nbsp;<span class="builtinfunc" id="6180695">len</span><span class="op" id="6180698">(</span><span class="ident" id="6180699">fields</span><span class="op" id="6180705">)</span>&nbsp;<span class="op" id="6180707">!=</span>&nbsp;<span class="num" id="6180710">5</span>&nbsp;<span class="op" id="6180712">||</span>&nbsp;<span class="ident" id="6180715">fields</span><span class="op" id="6180721">[</span><span class="num" id="6180722">0</span><span class="op" id="6180723">]</span>&nbsp;<span class="op" id="6180725">!=</span>&nbsp;<span class="string" id="6180728">&#34;=&#34;</span>&nbsp;<span class="op" id="6180732">||</span>&nbsp;<span class="ident" id="6180735">fields</span><span class="op" id="6180741">[</span><span class="num" id="6180742">4</span><span class="op" id="6180743">]</span>&nbsp;<span class="op" id="6180745">!=</span>&nbsp;<span class="string" id="6180748">&#34;=&#34;</span>&nbsp;<span class="op" id="6180752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180756">return</span>&nbsp;<span class="string" id="6180763">&#34;&#34;</span><span class="op" id="6180765">,</span>&nbsp;<span class="ident" id="6180767">errors</span><span class="op" id="6180773">.</span><span class="ident" id="6180774">New</span><span class="op" id="6180777">(</span><span class="string" id="6180778">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="6180808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6180811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6180814">charset</span><span class="op" id="6180821">,</span>&nbsp;<span class="ident" id="6180823">enc</span>&nbsp;<span class="op" id="6180827">:=</span>&nbsp;<span class="ident" id="6180830">strings</span><span class="op" id="6180837">.</span><span class="ident" id="6180838">ToLower</span><span class="op" id="6180845">(</span><span class="ident" id="6180846">fields</span><span class="op" id="6180852">[</span><span class="num" id="6180853">1</span><span class="op" id="6180854">]</span><span class="op" id="6180855">)</span><span class="op" id="6180856">,</span>&nbsp;<span class="ident" id="6180858">strings</span><span class="op" id="6180865">.</span><span class="ident" id="6180866">ToLower</span><span class="op" id="6180873">(</span><span class="ident" id="6180874">fields</span><span class="op" id="6180880">[</span><span class="num" id="6180881">2</span><span class="op" id="6180882">]</span><span class="op" id="6180883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180886">if</span>&nbsp;<span class="ident" id="6180889">charset</span>&nbsp;<span class="op" id="6180897">!=</span>&nbsp;<span class="string" id="6180900">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="6180911">&amp;&amp;</span>&nbsp;<span class="ident" id="6180914">charset</span>&nbsp;<span class="op" id="6180922">!=</span>&nbsp;<span class="string" id="6180925">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="6180938">&amp;&amp;</span>&nbsp;<span class="ident" id="6180941">charset</span>&nbsp;<span class="op" id="6180949">!=</span>&nbsp;<span class="string" id="6180952">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="6180960">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6180964">return</span>&nbsp;<span class="string" id="6180971">&#34;&#34;</span><span class="op" id="6180973">,</span>&nbsp;<span class="ident" id="6180975">fmt</span><span class="op" id="6180978">.</span><span class="ident" id="6180979">Errorf</span><span class="op" id="6180985">(</span><span class="string" id="6180986">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6181013">,</span>&nbsp;<span class="ident" id="6181015">charset</span><span class="op" id="6181022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181029">in</span>&nbsp;<span class="op" id="6181032">:=</span>&nbsp;<span class="ident" id="6181035">bytes</span><span class="op" id="6181040">.</span><span class="ident" id="6181041">NewBufferString</span><span class="op" id="6181056">(</span><span class="ident" id="6181057">fields</span><span class="op" id="6181063">[</span><span class="num" id="6181064">3</span><span class="op" id="6181065">]</span><span class="op" id="6181066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181069">var</span>&nbsp;<span class="ident" id="6181073">r</span>&nbsp;<span class="ident" id="6181075">io</span><span class="op" id="6181077">.</span><span class="ident" id="6181078">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181086">switch</span>&nbsp;<span class="ident" id="6181093">enc</span>&nbsp;<span class="op" id="6181097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181100">case</span>&nbsp;<span class="string" id="6181105">&#34;b&#34;</span><span class="op" id="6181108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181112">r</span>&nbsp;<span class="op" id="6181114">=</span>&nbsp;<span class="ident" id="6181116">base64</span><span class="op" id="6181122">.</span><span class="ident" id="6181123">NewDecoder</span><span class="op" id="6181133">(</span><span class="ident" id="6181134">base64</span><span class="op" id="6181140">.</span><span class="ident" id="6181141">StdEncoding</span><span class="op" id="6181152">,</span>&nbsp;<span class="ident" id="6181154">in</span><span class="op" id="6181156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181159">case</span>&nbsp;<span class="string" id="6181164">&#34;q&#34;</span><span class="op" id="6181167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181171">r</span>&nbsp;<span class="op" id="6181173">=</span>&nbsp;<span class="ident" id="6181175">qDecoder</span><span class="op" id="6181183">{</span><span class="ident" id="6181184">r</span><span class="op" id="6181185">:</span>&nbsp;<span class="ident" id="6181187">in</span><span class="op" id="6181189">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181192">default</span><span class="op" id="6181199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181203">return</span>&nbsp;<span class="string" id="6181210">&#34;&#34;</span><span class="op" id="6181212">,</span>&nbsp;<span class="ident" id="6181214">fmt</span><span class="op" id="6181217">.</span><span class="ident" id="6181218">Errorf</span><span class="op" id="6181224">(</span><span class="string" id="6181225">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6181262">,</span>&nbsp;<span class="ident" id="6181264">enc</span><span class="op" id="6181267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181274">dec</span><span class="op" id="6181277">,</span>&nbsp;<span class="ident" id="6181279">err</span>&nbsp;<span class="op" id="6181283">:=</span>&nbsp;<span class="ident" id="6181286">ioutil</span><span class="op" id="6181292">.</span><span class="ident" id="6181293">ReadAll</span><span class="op" id="6181300">(</span><span class="ident" id="6181301">r</span><span class="op" id="6181302">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181305">if</span>&nbsp;<span class="ident" id="6181308">err</span>&nbsp;<span class="op" id="6181312">!=</span>&nbsp;<span class="ident" id="6181315">nil</span>&nbsp;<span class="op" id="6181319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181323">return</span>&nbsp;<span class="string" id="6181330">&#34;&#34;</span><span class="op" id="6181332">,</span>&nbsp;<span class="ident" id="6181334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181343">switch</span>&nbsp;<span class="ident" id="6181350">charset</span>&nbsp;<span class="op" id="6181358">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181361">case</span>&nbsp;<span class="string" id="6181366">&#34;us-ascii&#34;</span><span class="op" id="6181376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181380">b</span>&nbsp;<span class="op" id="6181382">:=</span>&nbsp;<span class="builtinfunc" id="6181385">new</span><span class="op" id="6181388">(</span><span class="ident" id="6181389">bytes</span><span class="op" id="6181394">.</span><span class="ident" id="6181395">Buffer</span><span class="op" id="6181401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181405">for</span>&nbsp;<span class="ident" id="6181409">_</span><span class="op" id="6181410">,</span>&nbsp;<span class="ident" id="6181412">c</span>&nbsp;<span class="op" id="6181414">:=</span>&nbsp;<span class="keyword" id="6181417">range</span>&nbsp;<span class="ident" id="6181423">dec</span>&nbsp;<span class="op" id="6181427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181432">if</span>&nbsp;<span class="ident" id="6181435">c</span>&nbsp;<span class="op" id="6181437">&gt;=</span>&nbsp;<span class="num" id="6181440">0x80</span>&nbsp;<span class="op" id="6181445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181451">b</span><span class="op" id="6181452">.</span><span class="ident" id="6181453">WriteRune</span><span class="op" id="6181462">(</span><span class="ident" id="6181463">unicode</span><span class="op" id="6181470">.</span><span class="ident" id="6181471">ReplacementChar</span><span class="op" id="6181486">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181491">}</span>&nbsp;<span class="keyword" id="6181493">else</span>&nbsp;<span class="op" id="6181498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181504">b</span><span class="op" id="6181505">.</span><span class="ident" id="6181506">WriteRune</span><span class="op" id="6181515">(</span><span class="builtintype" id="6181516">rune</span><span class="op" id="6181520">(</span><span class="ident" id="6181521">c</span><span class="op" id="6181522">)</span><span class="op" id="6181523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181536">return</span>&nbsp;<span class="ident" id="6181543">b</span><span class="op" id="6181544">.</span><span class="ident" id="6181545">String</span><span class="op" id="6181551">(</span><span class="op" id="6181552">)</span><span class="op" id="6181553">,</span>&nbsp;<span class="ident" id="6181555">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181560">case</span>&nbsp;<span class="string" id="6181565">&#34;iso-8859-1&#34;</span><span class="op" id="6181577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181581">b</span>&nbsp;<span class="op" id="6181583">:=</span>&nbsp;<span class="builtinfunc" id="6181586">new</span><span class="op" id="6181589">(</span><span class="ident" id="6181590">bytes</span><span class="op" id="6181595">.</span><span class="ident" id="6181596">Buffer</span><span class="op" id="6181602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181606">for</span>&nbsp;<span class="ident" id="6181610">_</span><span class="op" id="6181611">,</span>&nbsp;<span class="ident" id="6181613">c</span>&nbsp;<span class="op" id="6181615">:=</span>&nbsp;<span class="keyword" id="6181618">range</span>&nbsp;<span class="ident" id="6181624">dec</span>&nbsp;<span class="op" id="6181628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181633">b</span><span class="op" id="6181634">.</span><span class="ident" id="6181635">WriteRune</span><span class="op" id="6181644">(</span><span class="builtintype" id="6181645">rune</span><span class="op" id="6181649">(</span><span class="ident" id="6181650">c</span><span class="op" id="6181651">)</span><span class="op" id="6181652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181656">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181660">return</span>&nbsp;<span class="ident" id="6181667">b</span><span class="op" id="6181668">.</span><span class="ident" id="6181669">String</span><span class="op" id="6181675">(</span><span class="op" id="6181676">)</span><span class="op" id="6181677">,</span>&nbsp;<span class="ident" id="6181679">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181684">case</span>&nbsp;<span class="string" id="6181689">&#34;utf-8&#34;</span><span class="op" id="6181696">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181700">return</span>&nbsp;<span class="builtintype" id="6181707">string</span><span class="op" id="6181713">(</span><span class="ident" id="6181714">dec</span><span class="op" id="6181717">)</span><span class="op" id="6181718">,</span>&nbsp;<span class="ident" id="6181720">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6181728">panic</span><span class="op" id="6181733">(</span><span class="string" id="6181734">&#34;unreachable&#34;</span><span class="op" id="6181747">)</span><br>
<span class="lineno">490</span><span class="op" id="6181749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6181752">type</span>&nbsp;<span class="ident" id="6181757">qDecoder</span>&nbsp;<span class="keyword" id="6181766">struct</span>&nbsp;<span class="op" id="6181773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181776">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181784">io</span><span class="op" id="6181786">.</span><span class="ident" id="6181787">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6181795">scratch</span>&nbsp;<span class="op" id="6181803">[</span><span class="num" id="6181804">2</span><span class="op" id="6181805">]</span><span class="builtintype" id="6181806">byte</span><br>
<span class="lineno">495</span><span class="op" id="6181811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6181814">func</span>&nbsp;<span class="op" id="6181819">(</span><span class="ident" id="6181820">qd</span>&nbsp;<span class="ident" id="6181823">qDecoder</span><span class="op" id="6181831">)</span>&nbsp;<span class="ident" id="6181833">Read</span><span class="op" id="6181837">(</span><span class="ident" id="6181838">p</span>&nbsp;<span class="op" id="6181840">[</span><span class="op" id="6181841">]</span><span class="builtintype" id="6181842">byte</span><span class="op" id="6181846">)</span>&nbsp;<span class="op" id="6181848">(</span><span class="ident" id="6181849">n</span>&nbsp;<span class="builtintype" id="6181851">int</span><span class="op" id="6181854">,</span>&nbsp;<span class="ident" id="6181856">err</span>&nbsp;<span class="builtintype" id="6181860">error</span><span class="op" id="6181865">)</span>&nbsp;<span class="op" id="6181867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6181870">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181918">if</span>&nbsp;<span class="builtinfunc" id="6181921">len</span><span class="op" id="6181924">(</span><span class="ident" id="6181925">p</span><span class="op" id="6181926">)</span>&nbsp;<span class="op" id="6181928">==</span>&nbsp;<span class="num" id="6181931">0</span>&nbsp;<span class="op" id="6181933">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181937">return</span>&nbsp;<span class="num" id="6181944">0</span><span class="op" id="6181945">,</span>&nbsp;<span class="ident" id="6181947">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6181952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6181955">if</span>&nbsp;<span class="ident" id="6181958">_</span><span class="op" id="6181959">,</span>&nbsp;<span class="ident" id="6181961">err</span>&nbsp;<span class="op" id="6181965">:=</span>&nbsp;<span class="ident" id="6181968">qd</span><span class="op" id="6181970">.</span><span class="ident" id="6181971">r</span><span class="op" id="6181972">.</span><span class="ident" id="6181973">Read</span><span class="op" id="6181977">(</span><span class="ident" id="6181978">qd</span><span class="op" id="6181980">.</span><span class="ident" id="6181981">scratch</span><span class="op" id="6181988">[</span><span class="op" id="6181989">:</span><span class="num" id="6181990">1</span><span class="op" id="6181991">]</span><span class="op" id="6181992">)</span><span class="op" id="6181993">;</span>&nbsp;<span class="ident" id="6181995">err</span>&nbsp;<span class="op" id="6181999">!=</span>&nbsp;<span class="ident" id="6182002">nil</span>&nbsp;<span class="op" id="6182006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182010">return</span>&nbsp;<span class="num" id="6182017">0</span><span class="op" id="6182018">,</span>&nbsp;<span class="ident" id="6182020">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182025">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182028">switch</span>&nbsp;<span class="ident" id="6182035">c</span>&nbsp;<span class="op" id="6182037">:=</span>&nbsp;<span class="ident" id="6182040">qd</span><span class="op" id="6182042">.</span><span class="ident" id="6182043">scratch</span><span class="op" id="6182050">[</span><span class="num" id="6182051">0</span><span class="op" id="6182052">]</span><span class="op" id="6182053">;</span>&nbsp;<span class="op" id="6182055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182058">case</span>&nbsp;<span class="ident" id="6182063">c</span>&nbsp;<span class="op" id="6182065">==</span>&nbsp;<span class="string" id="6182068">&#39;=&#39;</span><span class="op" id="6182071">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182075">if</span>&nbsp;<span class="ident" id="6182078">_</span><span class="op" id="6182079">,</span>&nbsp;<span class="ident" id="6182081">err</span>&nbsp;<span class="op" id="6182085">:=</span>&nbsp;<span class="ident" id="6182088">io</span><span class="op" id="6182090">.</span><span class="ident" id="6182091">ReadFull</span><span class="op" id="6182099">(</span><span class="ident" id="6182100">qd</span><span class="op" id="6182102">.</span><span class="ident" id="6182103">r</span><span class="op" id="6182104">,</span>&nbsp;<span class="ident" id="6182106">qd</span><span class="op" id="6182108">.</span><span class="ident" id="6182109">scratch</span><span class="op" id="6182116">[</span><span class="op" id="6182117">:</span><span class="num" id="6182118">2</span><span class="op" id="6182119">]</span><span class="op" id="6182120">)</span><span class="op" id="6182121">;</span>&nbsp;<span class="ident" id="6182123">err</span>&nbsp;<span class="op" id="6182127">!=</span>&nbsp;<span class="ident" id="6182130">nil</span>&nbsp;<span class="op" id="6182134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182139">return</span>&nbsp;<span class="num" id="6182146">0</span><span class="op" id="6182147">,</span>&nbsp;<span class="ident" id="6182149">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182155">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182159">x</span><span class="op" id="6182160">,</span>&nbsp;<span class="ident" id="6182162">err</span>&nbsp;<span class="op" id="6182166">:=</span>&nbsp;<span class="ident" id="6182169">strconv</span><span class="op" id="6182176">.</span><span class="ident" id="6182177">ParseInt</span><span class="op" id="6182185">(</span><span class="builtintype" id="6182186">string</span><span class="op" id="6182192">(</span><span class="ident" id="6182193">qd</span><span class="op" id="6182195">.</span><span class="ident" id="6182196">scratch</span><span class="op" id="6182203">[</span><span class="op" id="6182204">:</span><span class="num" id="6182205">2</span><span class="op" id="6182206">]</span><span class="op" id="6182207">)</span><span class="op" id="6182208">,</span>&nbsp;<span class="num" id="6182210">16</span><span class="op" id="6182212">,</span>&nbsp;<span class="num" id="6182214">64</span><span class="op" id="6182216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182220">if</span>&nbsp;<span class="ident" id="6182223">err</span>&nbsp;<span class="op" id="6182227">!=</span>&nbsp;<span class="ident" id="6182230">nil</span>&nbsp;<span class="op" id="6182234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182239">return</span>&nbsp;<span class="num" id="6182246">0</span><span class="op" id="6182247">,</span>&nbsp;<span class="ident" id="6182249">fmt</span><span class="op" id="6182252">.</span><span class="ident" id="6182253">Errorf</span><span class="op" id="6182259">(</span><span class="string" id="6182260">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="6182297">,</span>&nbsp;<span class="ident" id="6182299">qd</span><span class="op" id="6182301">.</span><span class="ident" id="6182302">scratch</span><span class="op" id="6182309">[</span><span class="op" id="6182310">:</span><span class="num" id="6182311">2</span><span class="op" id="6182312">]</span><span class="op" id="6182313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182321">p</span><span class="op" id="6182322">[</span><span class="num" id="6182323">0</span><span class="op" id="6182324">]</span>&nbsp;<span class="op" id="6182326">=</span>&nbsp;<span class="builtintype" id="6182328">byte</span><span class="op" id="6182332">(</span><span class="ident" id="6182333">x</span><span class="op" id="6182334">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182337">case</span>&nbsp;<span class="ident" id="6182342">c</span>&nbsp;<span class="op" id="6182344">==</span>&nbsp;<span class="string" id="6182347">&#39;_&#39;</span><span class="op" id="6182350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182354">p</span><span class="op" id="6182355">[</span><span class="num" id="6182356">0</span><span class="op" id="6182357">]</span>&nbsp;<span class="op" id="6182359">=</span>&nbsp;<span class="string" id="6182361">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182366">default</span><span class="op" id="6182373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6182377">p</span><span class="op" id="6182378">[</span><span class="num" id="6182379">0</span><span class="op" id="6182380">]</span>&nbsp;<span class="op" id="6182382">=</span>&nbsp;<span class="ident" id="6182384">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182387">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182390">return</span>&nbsp;<span class="num" id="6182397">1</span><span class="op" id="6182398">,</span>&nbsp;<span class="ident" id="6182400">nil</span><br>
<span class="lineno"></span><span class="op" id="6182404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182407">var</span>&nbsp;<span class="ident" id="6182411">atextChars</span>&nbsp;<span class="op" id="6182422">=</span>&nbsp;<span class="op" id="6182424">[</span><span class="op" id="6182425">]</span><span class="builtintype" id="6182426">byte</span><span class="op" id="6182430">(</span><span class="string" id="6182431">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="6182460">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6182463">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="6182492">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6182495">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="6182508">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6182511">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="6182532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182535">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="6182596">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="6182635">func</span>&nbsp;<span class="ident" id="6182640">isAtext</span><span class="op" id="6182647">(</span><span class="ident" id="6182648">c</span>&nbsp;<span class="builtintype" id="6182650">byte</span><span class="op" id="6182654">,</span>&nbsp;<span class="ident" id="6182656">dot</span>&nbsp;<span class="builtintype" id="6182660">bool</span><span class="op" id="6182664">)</span>&nbsp;<span class="builtintype" id="6182666">bool</span>&nbsp;<span class="op" id="6182671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182674">if</span>&nbsp;<span class="ident" id="6182677">dot</span>&nbsp;<span class="op" id="6182681">&amp;&amp;</span>&nbsp;<span class="ident" id="6182684">c</span>&nbsp;<span class="op" id="6182686">==</span>&nbsp;<span class="string" id="6182689">&#39;.&#39;</span>&nbsp;<span class="op" id="6182693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182697">return</span>&nbsp;<span class="builtintype" id="6182704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182713">return</span>&nbsp;<span class="ident" id="6182720">bytes</span><span class="op" id="6182725">.</span><span class="ident" id="6182726">IndexByte</span><span class="op" id="6182735">(</span><span class="ident" id="6182736">atextChars</span><span class="op" id="6182746">,</span>&nbsp;<span class="ident" id="6182748">c</span><span class="op" id="6182749">)</span>&nbsp;<span class="op" id="6182751">&gt;=</span>&nbsp;<span class="num" id="6182754">0</span><br>
<span class="lineno">535</span><span class="op" id="6182756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182759">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6182820">func</span>&nbsp;<span class="ident" id="6182825">isQtext</span><span class="op" id="6182832">(</span><span class="ident" id="6182833">c</span>&nbsp;<span class="builtintype" id="6182835">byte</span><span class="op" id="6182839">)</span>&nbsp;<span class="builtintype" id="6182841">bool</span>&nbsp;<span class="op" id="6182846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6182849">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182903">if</span>&nbsp;<span class="ident" id="6182906">c</span>&nbsp;<span class="op" id="6182908">==</span>&nbsp;<span class="string" id="6182911">&#39;\\&#39;</span>&nbsp;<span class="op" id="6182916">||</span>&nbsp;<span class="ident" id="6182919">c</span>&nbsp;<span class="op" id="6182921">==</span>&nbsp;<span class="string" id="6182924">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6182928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182932">return</span>&nbsp;<span class="builtintype" id="6182939">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6182946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6182949">return</span>&nbsp;<span class="string" id="6182956">&#39;!&#39;</span>&nbsp;<span class="op" id="6182960">&lt;=</span>&nbsp;<span class="ident" id="6182963">c</span>&nbsp;<span class="op" id="6182965">&amp;&amp;</span>&nbsp;<span class="ident" id="6182968">c</span>&nbsp;<span class="op" id="6182970">&lt;=</span>&nbsp;<span class="string" id="6182973">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="6182977">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="6182980">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6183041">func</span>&nbsp;<span class="ident" id="6183046">isVchar</span><span class="op" id="6183053">(</span><span class="ident" id="6183054">c</span>&nbsp;<span class="builtintype" id="6183056">byte</span><span class="op" id="6183060">)</span>&nbsp;<span class="builtintype" id="6183062">bool</span>&nbsp;<span class="op" id="6183067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6183070">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183105">return</span>&nbsp;<span class="string" id="6183112">&#39;!&#39;</span>&nbsp;<span class="op" id="6183116">&lt;=</span>&nbsp;<span class="ident" id="6183119">c</span>&nbsp;<span class="op" id="6183121">&amp;&amp;</span>&nbsp;<span class="ident" id="6183124">c</span>&nbsp;<span class="op" id="6183126">&lt;=</span>&nbsp;<span class="string" id="6183129">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="6183133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6183136">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="6183187">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="6183245">func</span>&nbsp;<span class="ident" id="6183250">isWSP</span><span class="op" id="6183255">(</span><span class="ident" id="6183256">c</span>&nbsp;<span class="builtintype" id="6183258">byte</span><span class="op" id="6183262">)</span>&nbsp;<span class="builtintype" id="6183264">bool</span>&nbsp;<span class="op" id="6183269">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6183272">return</span>&nbsp;<span class="ident" id="6183279">c</span>&nbsp;<span class="op" id="6183281">==</span>&nbsp;<span class="string" id="6183284">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6183288">||</span>&nbsp;<span class="ident" id="6183291">c</span>&nbsp;<span class="op" id="6183293">==</span>&nbsp;<span class="string" id="6183296">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="6183301">}</span>
</div>
</body>
</html>
