<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5495405">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5495460">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5495514">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5495565">package</span>&nbsp;<span class="ident" id="5495573">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5495579">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5495653">import</span>&nbsp;<span class="op" id="5495660">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495663">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495673">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495680">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495686">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495699">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495706">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495718">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495734">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495740">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495751">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5495759">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5495766">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5495769">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="5495850">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="5495888">type</span>&nbsp;<span class="ident" id="5495893">request</span>&nbsp;<span class="keyword" id="5495901">struct</span>&nbsp;<span class="op" id="5495908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495911">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5495921">*</span><span class="ident" id="5495922">io</span><span class="op" id="5495924">.</span><span class="ident" id="5495925">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495937">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5495947">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495955">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5495965">map</span><span class="op" id="5495968">[</span><span class="builtintype" id="5495969">string</span><span class="op" id="5495975">]</span><span class="builtintype" id="5495976">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5495984">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5495994">[</span><span class="num" id="5495995">1024</span><span class="op" id="5495999">]</span><span class="builtintype" id="5496000">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496006">rawParams</span>&nbsp;<span class="op" id="5496016">[</span><span class="op" id="5496017">]</span><span class="builtintype" id="5496018">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496024">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="5496034">bool</span><br>
<span class="lineno"></span><span class="op" id="5496039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5496042">func</span>&nbsp;<span class="ident" id="5496047">newRequest</span><span class="op" id="5496057">(</span><span class="ident" id="5496058">reqId</span>&nbsp;<span class="builtintype" id="5496064">uint16</span><span class="op" id="5496070">,</span>&nbsp;<span class="ident" id="5496072">flags</span>&nbsp;<span class="builtintype" id="5496078">uint8</span><span class="op" id="5496083">)</span>&nbsp;<span class="op" id="5496085">*</span><span class="ident" id="5496086">request</span>&nbsp;<span class="op" id="5496094">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496097">r</span>&nbsp;<span class="op" id="5496099">:=</span>&nbsp;<span class="op" id="5496102">&amp;</span><span class="ident" id="5496103">request</span><span class="op" id="5496110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496114">reqId</span><span class="op" id="5496119">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5496124">reqId</span><span class="op" id="5496129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496133">params</span><span class="op" id="5496139">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5496143">map</span><span class="op" id="5496146">[</span><span class="builtintype" id="5496147">string</span><span class="op" id="5496153">]</span><span class="builtintype" id="5496154">string</span><span class="op" id="5496160">{</span><span class="op" id="5496161">}</span><span class="op" id="5496162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496166">keepConn</span><span class="op" id="5496174">:</span>&nbsp;<span class="ident" id="5496176">flags</span><span class="op" id="5496181">&amp;</span><span class="ident" id="5496182">flagKeepConn</span>&nbsp;<span class="op" id="5496195">!=</span>&nbsp;<span class="num" id="5496198">0</span><span class="op" id="5496199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496202">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496205">r</span><span class="op" id="5496206">.</span><span class="ident" id="5496207">rawParams</span>&nbsp;<span class="op" id="5496217">=</span>&nbsp;<span class="ident" id="5496219">r</span><span class="op" id="5496220">.</span><span class="ident" id="5496221">buf</span><span class="op" id="5496224">[</span><span class="op" id="5496225">:</span><span class="num" id="5496226">0</span><span class="op" id="5496227">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496230">return</span>&nbsp;<span class="ident" id="5496237">r</span><br>
<span class="lineno"></span><span class="op" id="5496239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5496242">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="5496294">func</span>&nbsp;<span class="op" id="5496299">(</span><span class="ident" id="5496300">r</span>&nbsp;<span class="op" id="5496302">*</span><span class="ident" id="5496303">request</span><span class="op" id="5496310">)</span>&nbsp;<span class="ident" id="5496312">parseParams</span><span class="op" id="5496323">(</span><span class="op" id="5496324">)</span>&nbsp;<span class="op" id="5496326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496329">text</span>&nbsp;<span class="op" id="5496334">:=</span>&nbsp;<span class="ident" id="5496337">r</span><span class="op" id="5496338">.</span><span class="ident" id="5496339">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496350">r</span><span class="op" id="5496351">.</span><span class="ident" id="5496352">rawParams</span>&nbsp;<span class="op" id="5496362">=</span>&nbsp;<span class="ident" id="5496364">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496369">for</span>&nbsp;<span class="builtinfunc" id="5496373">len</span><span class="op" id="5496376">(</span><span class="ident" id="5496377">text</span><span class="op" id="5496381">)</span>&nbsp;<span class="op" id="5496383">&gt;</span>&nbsp;<span class="num" id="5496385">0</span>&nbsp;<span class="op" id="5496387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496391">keyLen</span><span class="op" id="5496397">,</span>&nbsp;<span class="ident" id="5496399">n</span>&nbsp;<span class="op" id="5496401">:=</span>&nbsp;<span class="ident" id="5496404">readSize</span><span class="op" id="5496412">(</span><span class="ident" id="5496413">text</span><span class="op" id="5496417">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496421">if</span>&nbsp;<span class="ident" id="5496424">n</span>&nbsp;<span class="op" id="5496426">==</span>&nbsp;<span class="num" id="5496429">0</span>&nbsp;<span class="op" id="5496431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496436">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496449">text</span>&nbsp;<span class="op" id="5496454">=</span>&nbsp;<span class="ident" id="5496456">text</span><span class="op" id="5496460">[</span><span class="ident" id="5496461">n</span><span class="op" id="5496462">:</span><span class="op" id="5496463">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496467">valLen</span><span class="op" id="5496473">,</span>&nbsp;<span class="ident" id="5496475">n</span>&nbsp;<span class="op" id="5496477">:=</span>&nbsp;<span class="ident" id="5496480">readSize</span><span class="op" id="5496488">(</span><span class="ident" id="5496489">text</span><span class="op" id="5496493">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496497">if</span>&nbsp;<span class="ident" id="5496500">n</span>&nbsp;<span class="op" id="5496502">==</span>&nbsp;<span class="num" id="5496505">0</span>&nbsp;<span class="op" id="5496507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496512">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496525">text</span>&nbsp;<span class="op" id="5496530">=</span>&nbsp;<span class="ident" id="5496532">text</span><span class="op" id="5496536">[</span><span class="ident" id="5496537">n</span><span class="op" id="5496538">:</span><span class="op" id="5496539">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496543">key</span>&nbsp;<span class="op" id="5496547">:=</span>&nbsp;<span class="ident" id="5496550">readString</span><span class="op" id="5496560">(</span><span class="ident" id="5496561">text</span><span class="op" id="5496565">,</span>&nbsp;<span class="ident" id="5496567">keyLen</span><span class="op" id="5496573">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496577">text</span>&nbsp;<span class="op" id="5496582">=</span>&nbsp;<span class="ident" id="5496584">text</span><span class="op" id="5496588">[</span><span class="ident" id="5496589">keyLen</span><span class="op" id="5496595">:</span><span class="op" id="5496596">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496600">val</span>&nbsp;<span class="op" id="5496604">:=</span>&nbsp;<span class="ident" id="5496607">readString</span><span class="op" id="5496617">(</span><span class="ident" id="5496618">text</span><span class="op" id="5496622">,</span>&nbsp;<span class="ident" id="5496624">valLen</span><span class="op" id="5496630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496634">text</span>&nbsp;<span class="op" id="5496639">=</span>&nbsp;<span class="ident" id="5496641">text</span><span class="op" id="5496645">[</span><span class="ident" id="5496646">valLen</span><span class="op" id="5496652">:</span><span class="op" id="5496653">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496657">r</span><span class="op" id="5496658">.</span><span class="ident" id="5496659">params</span><span class="op" id="5496665">[</span><span class="ident" id="5496666">key</span><span class="op" id="5496669">]</span>&nbsp;<span class="op" id="5496671">=</span>&nbsp;<span class="ident" id="5496673">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5496678">}</span><br>
<span class="lineno">65</span><span class="op" id="5496680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5496683">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5496727">type</span>&nbsp;<span class="ident" id="5496732">response</span>&nbsp;<span class="keyword" id="5496741">struct</span>&nbsp;<span class="op" id="5496748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496751">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5496763">*</span><span class="ident" id="5496764">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496773">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5496785">http</span><span class="op" id="5496789">.</span><span class="ident" id="5496790">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496798">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5496810">*</span><span class="ident" id="5496811">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496822">wroteHeader</span>&nbsp;<span class="builtintype" id="5496834">bool</span><br>
<span class="lineno"></span><span class="op" id="5496839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="5496842">func</span>&nbsp;<span class="ident" id="5496847">newResponse</span><span class="op" id="5496858">(</span><span class="ident" id="5496859">c</span>&nbsp;<span class="op" id="5496861">*</span><span class="ident" id="5496862">child</span><span class="op" id="5496867">,</span>&nbsp;<span class="ident" id="5496869">req</span>&nbsp;<span class="op" id="5496873">*</span><span class="ident" id="5496874">request</span><span class="op" id="5496881">)</span>&nbsp;<span class="op" id="5496883">*</span><span class="ident" id="5496884">response</span>&nbsp;<span class="op" id="5496893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5496896">return</span>&nbsp;<span class="op" id="5496903">&amp;</span><span class="ident" id="5496904">response</span><span class="op" id="5496912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496916">req</span><span class="op" id="5496919">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5496924">req</span><span class="op" id="5496927">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496931">header</span><span class="op" id="5496937">:</span>&nbsp;<span class="ident" id="5496939">http</span><span class="op" id="5496943">.</span><span class="ident" id="5496944">Header</span><span class="op" id="5496950">{</span><span class="op" id="5496951">}</span><span class="op" id="5496952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5496956">w</span><span class="op" id="5496957">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5496964">newWriter</span><span class="op" id="5496973">(</span><span class="ident" id="5496974">c</span><span class="op" id="5496975">.</span><span class="ident" id="5496976">conn</span><span class="op" id="5496980">,</span>&nbsp;<span class="ident" id="5496982">typeStdout</span><span class="op" id="5496992">,</span>&nbsp;<span class="ident" id="5496994">req</span><span class="op" id="5496997">.</span><span class="ident" id="5496998">reqId</span><span class="op" id="5497003">)</span><span class="op" id="5497004">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497007">}</span><br>
<span class="lineno"></span><span class="op" id="5497009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497012">func</span>&nbsp;<span class="op" id="5497017">(</span><span class="ident" id="5497018">r</span>&nbsp;<span class="op" id="5497020">*</span><span class="ident" id="5497021">response</span><span class="op" id="5497029">)</span>&nbsp;<span class="ident" id="5497031">Header</span><span class="op" id="5497037">(</span><span class="op" id="5497038">)</span>&nbsp;<span class="ident" id="5497040">http</span><span class="op" id="5497044">.</span><span class="ident" id="5497045">Header</span>&nbsp;<span class="op" id="5497052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497055">return</span>&nbsp;<span class="ident" id="5497062">r</span><span class="op" id="5497063">.</span><span class="ident" id="5497064">header</span><br>
<span class="lineno">85</span><span class="op" id="5497071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497074">func</span>&nbsp;<span class="op" id="5497079">(</span><span class="ident" id="5497080">r</span>&nbsp;<span class="op" id="5497082">*</span><span class="ident" id="5497083">response</span><span class="op" id="5497091">)</span>&nbsp;<span class="ident" id="5497093">Write</span><span class="op" id="5497098">(</span><span class="ident" id="5497099">data</span>&nbsp;<span class="op" id="5497104">[</span><span class="op" id="5497105">]</span><span class="builtintype" id="5497106">byte</span><span class="op" id="5497110">)</span>&nbsp;<span class="op" id="5497112">(</span><span class="builtintype" id="5497113">int</span><span class="op" id="5497116">,</span>&nbsp;<span class="builtintype" id="5497118">error</span><span class="op" id="5497123">)</span>&nbsp;<span class="op" id="5497125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497128">if</span>&nbsp;<span class="op" id="5497131">!</span><span class="ident" id="5497132">r</span><span class="op" id="5497133">.</span><span class="ident" id="5497134">wroteHeader</span>&nbsp;<span class="op" id="5497146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497150">r</span><span class="op" id="5497151">.</span><span class="ident" id="5497152">WriteHeader</span><span class="op" id="5497163">(</span><span class="ident" id="5497164">http</span><span class="op" id="5497168">.</span><span class="ident" id="5497169">StatusOK</span><span class="op" id="5497177">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497183">return</span>&nbsp;<span class="ident" id="5497190">r</span><span class="op" id="5497191">.</span><span class="ident" id="5497192">w</span><span class="op" id="5497193">.</span><span class="ident" id="5497194">Write</span><span class="op" id="5497199">(</span><span class="ident" id="5497200">data</span><span class="op" id="5497204">)</span><br>
<span class="lineno"></span><span class="op" id="5497206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497209">func</span>&nbsp;<span class="op" id="5497214">(</span><span class="ident" id="5497215">r</span>&nbsp;<span class="op" id="5497217">*</span><span class="ident" id="5497218">response</span><span class="op" id="5497226">)</span>&nbsp;<span class="ident" id="5497228">WriteHeader</span><span class="op" id="5497239">(</span><span class="ident" id="5497240">code</span>&nbsp;<span class="builtintype" id="5497245">int</span><span class="op" id="5497248">)</span>&nbsp;<span class="op" id="5497250">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497253">if</span>&nbsp;<span class="ident" id="5497256">r</span><span class="op" id="5497257">.</span><span class="ident" id="5497258">wroteHeader</span>&nbsp;<span class="op" id="5497270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497274">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497285">r</span><span class="op" id="5497286">.</span><span class="ident" id="5497287">wroteHeader</span>&nbsp;<span class="op" id="5497299">=</span>&nbsp;<span class="builtintype" id="5497301">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497307">if</span>&nbsp;<span class="ident" id="5497310">code</span>&nbsp;<span class="op" id="5497315">==</span>&nbsp;<span class="ident" id="5497318">http</span><span class="op" id="5497322">.</span><span class="ident" id="5497323">StatusNotModified</span>&nbsp;<span class="op" id="5497341">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5497345">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497370">r</span><span class="op" id="5497371">.</span><span class="ident" id="5497372">header</span><span class="op" id="5497378">.</span><span class="ident" id="5497379">Del</span><span class="op" id="5497382">(</span><span class="string" id="5497383">&#34;Content-Type&#34;</span><span class="op" id="5497397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497401">r</span><span class="op" id="5497402">.</span><span class="ident" id="5497403">header</span><span class="op" id="5497409">.</span><span class="ident" id="5497410">Del</span><span class="op" id="5497413">(</span><span class="string" id="5497414">&#34;Content-Length&#34;</span><span class="op" id="5497430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497434">r</span><span class="op" id="5497435">.</span><span class="ident" id="5497436">header</span><span class="op" id="5497442">.</span><span class="ident" id="5497443">Del</span><span class="op" id="5497446">(</span><span class="string" id="5497447">&#34;Transfer-Encoding&#34;</span><span class="op" id="5497466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497469">}</span>&nbsp;<span class="keyword" id="5497471">else</span>&nbsp;<span class="keyword" id="5497476">if</span>&nbsp;<span class="ident" id="5497479">r</span><span class="op" id="5497480">.</span><span class="ident" id="5497481">header</span><span class="op" id="5497487">.</span><span class="ident" id="5497488">Get</span><span class="op" id="5497491">(</span><span class="string" id="5497492">&#34;Content-Type&#34;</span><span class="op" id="5497506">)</span>&nbsp;<span class="op" id="5497508">==</span>&nbsp;<span class="string" id="5497511">&#34;&#34;</span>&nbsp;<span class="op" id="5497514">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497518">r</span><span class="op" id="5497519">.</span><span class="ident" id="5497520">header</span><span class="op" id="5497526">.</span><span class="ident" id="5497527">Set</span><span class="op" id="5497530">(</span><span class="string" id="5497531">&#34;Content-Type&#34;</span><span class="op" id="5497545">,</span>&nbsp;<span class="string" id="5497547">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5497573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497580">if</span>&nbsp;<span class="ident" id="5497583">r</span><span class="op" id="5497584">.</span><span class="ident" id="5497585">header</span><span class="op" id="5497591">.</span><span class="ident" id="5497592">Get</span><span class="op" id="5497595">(</span><span class="string" id="5497596">&#34;Date&#34;</span><span class="op" id="5497602">)</span>&nbsp;<span class="op" id="5497604">==</span>&nbsp;<span class="string" id="5497607">&#34;&#34;</span>&nbsp;<span class="op" id="5497610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497614">r</span><span class="op" id="5497615">.</span><span class="ident" id="5497616">header</span><span class="op" id="5497622">.</span><span class="ident" id="5497623">Set</span><span class="op" id="5497626">(</span><span class="string" id="5497627">&#34;Date&#34;</span><span class="op" id="5497633">,</span>&nbsp;<span class="ident" id="5497635">time</span><span class="op" id="5497639">.</span><span class="ident" id="5497640">Now</span><span class="op" id="5497643">(</span><span class="op" id="5497644">)</span><span class="op" id="5497645">.</span><span class="ident" id="5497646">UTC</span><span class="op" id="5497649">(</span><span class="op" id="5497650">)</span><span class="op" id="5497651">.</span><span class="ident" id="5497652">Format</span><span class="op" id="5497658">(</span><span class="ident" id="5497659">http</span><span class="op" id="5497663">.</span><span class="ident" id="5497664">TimeFormat</span><span class="op" id="5497674">)</span><span class="op" id="5497675">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497682">fmt</span><span class="op" id="5497685">.</span><span class="ident" id="5497686">Fprintf</span><span class="op" id="5497693">(</span><span class="ident" id="5497694">r</span><span class="op" id="5497695">.</span><span class="ident" id="5497696">w</span><span class="op" id="5497697">,</span>&nbsp;<span class="string" id="5497699">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5497718">,</span>&nbsp;<span class="ident" id="5497720">code</span><span class="op" id="5497724">,</span>&nbsp;<span class="ident" id="5497726">http</span><span class="op" id="5497730">.</span><span class="ident" id="5497731">StatusText</span><span class="op" id="5497741">(</span><span class="ident" id="5497742">code</span><span class="op" id="5497746">)</span><span class="op" id="5497747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497750">r</span><span class="op" id="5497751">.</span><span class="ident" id="5497752">header</span><span class="op" id="5497758">.</span><span class="ident" id="5497759">Write</span><span class="op" id="5497764">(</span><span class="ident" id="5497765">r</span><span class="op" id="5497766">.</span><span class="ident" id="5497767">w</span><span class="op" id="5497768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497771">r</span><span class="op" id="5497772">.</span><span class="ident" id="5497773">w</span><span class="op" id="5497774">.</span><span class="ident" id="5497775">WriteString</span><span class="op" id="5497786">(</span><span class="string" id="5497787">&#34;\r\n&#34;</span><span class="op" id="5497793">)</span><br>
<span class="lineno">115</span><span class="op" id="5497795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497798">func</span>&nbsp;<span class="op" id="5497803">(</span><span class="ident" id="5497804">r</span>&nbsp;<span class="op" id="5497806">*</span><span class="ident" id="5497807">response</span><span class="op" id="5497815">)</span>&nbsp;<span class="ident" id="5497817">Flush</span><span class="op" id="5497822">(</span><span class="op" id="5497823">)</span>&nbsp;<span class="op" id="5497825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497828">if</span>&nbsp;<span class="op" id="5497831">!</span><span class="ident" id="5497832">r</span><span class="op" id="5497833">.</span><span class="ident" id="5497834">wroteHeader</span>&nbsp;<span class="op" id="5497846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497850">r</span><span class="op" id="5497851">.</span><span class="ident" id="5497852">WriteHeader</span><span class="op" id="5497863">(</span><span class="ident" id="5497864">http</span><span class="op" id="5497868">.</span><span class="ident" id="5497869">StatusOK</span><span class="op" id="5497877">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5497880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497883">r</span><span class="op" id="5497884">.</span><span class="ident" id="5497885">w</span><span class="op" id="5497886">.</span><span class="ident" id="5497887">Flush</span><span class="op" id="5497892">(</span><span class="op" id="5497893">)</span><br>
<span class="lineno"></span><span class="op" id="5497895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497898">func</span>&nbsp;<span class="op" id="5497903">(</span><span class="ident" id="5497904">r</span>&nbsp;<span class="op" id="5497906">*</span><span class="ident" id="5497907">response</span><span class="op" id="5497915">)</span>&nbsp;<span class="ident" id="5497917">Close</span><span class="op" id="5497922">(</span><span class="op" id="5497923">)</span>&nbsp;<span class="builtintype" id="5497925">error</span>&nbsp;<span class="op" id="5497931">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497934">r</span><span class="op" id="5497935">.</span><span class="ident" id="5497936">Flush</span><span class="op" id="5497941">(</span><span class="op" id="5497942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5497945">return</span>&nbsp;<span class="ident" id="5497952">r</span><span class="op" id="5497953">.</span><span class="ident" id="5497954">w</span><span class="op" id="5497955">.</span><span class="ident" id="5497956">Close</span><span class="op" id="5497961">(</span><span class="op" id="5497962">)</span><br>
<span class="lineno"></span><span class="op" id="5497964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5497967">type</span>&nbsp;<span class="ident" id="5497972">child</span>&nbsp;<span class="keyword" id="5497978">struct</span>&nbsp;<span class="op" id="5497985">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5497988">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5497996">*</span><span class="ident" id="5497997">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498003">handler</span>&nbsp;<span class="ident" id="5498011">http</span><span class="op" id="5498015">.</span><span class="ident" id="5498016">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498026">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5498035">sync</span><span class="op" id="5498039">.</span><span class="ident" id="5498040">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5498055">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498078">requests</span>&nbsp;<span class="keyword" id="5498087">map</span><span class="op" id="5498090">[</span><span class="builtintype" id="5498091">uint16</span><span class="op" id="5498097">]</span><span class="op" id="5498098">*</span><span class="ident" id="5498099">request</span>&nbsp;<span class="comment" id="5498107">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="5498130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5498133">func</span>&nbsp;<span class="ident" id="5498138">newChild</span><span class="op" id="5498146">(</span><span class="ident" id="5498147">rwc</span>&nbsp;<span class="ident" id="5498151">io</span><span class="op" id="5498153">.</span><span class="ident" id="5498154">ReadWriteCloser</span><span class="op" id="5498169">,</span>&nbsp;<span class="ident" id="5498171">handler</span>&nbsp;<span class="ident" id="5498179">http</span><span class="op" id="5498183">.</span><span class="ident" id="5498184">Handler</span><span class="op" id="5498191">)</span>&nbsp;<span class="op" id="5498193">*</span><span class="ident" id="5498194">child</span>&nbsp;<span class="op" id="5498200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498203">return</span>&nbsp;<span class="op" id="5498210">&amp;</span><span class="ident" id="5498211">child</span><span class="op" id="5498216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498220">conn</span><span class="op" id="5498224">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5498230">newConn</span><span class="op" id="5498237">(</span><span class="ident" id="5498238">rwc</span><span class="op" id="5498241">)</span><span class="op" id="5498242">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498246">handler</span><span class="op" id="5498253">:</span>&nbsp;&nbsp;<span class="ident" id="5498256">handler</span><span class="op" id="5498263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498267">requests</span><span class="op" id="5498275">:</span>&nbsp;<span class="builtinfunc" id="5498277">make</span><span class="op" id="5498281">(</span><span class="keyword" id="5498282">map</span><span class="op" id="5498285">[</span><span class="builtintype" id="5498286">uint16</span><span class="op" id="5498292">]</span><span class="op" id="5498293">*</span><span class="ident" id="5498294">request</span><span class="op" id="5498301">)</span><span class="op" id="5498302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498305">}</span><br>
<span class="lineno"></span><span class="op" id="5498307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5498310">func</span>&nbsp;<span class="op" id="5498315">(</span><span class="ident" id="5498316">c</span>&nbsp;<span class="op" id="5498318">*</span><span class="ident" id="5498319">child</span><span class="op" id="5498324">)</span>&nbsp;<span class="ident" id="5498326">serve</span><span class="op" id="5498331">(</span><span class="op" id="5498332">)</span>&nbsp;<span class="op" id="5498334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498337">defer</span>&nbsp;<span class="ident" id="5498343">c</span><span class="op" id="5498344">.</span><span class="ident" id="5498345">conn</span><span class="op" id="5498349">.</span><span class="ident" id="5498350">Close</span><span class="op" id="5498355">(</span><span class="op" id="5498356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498359">var</span>&nbsp;<span class="ident" id="5498363">rec</span>&nbsp;<span class="ident" id="5498367">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498375">for</span>&nbsp;<span class="op" id="5498379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498383">if</span>&nbsp;<span class="ident" id="5498386">err</span>&nbsp;<span class="op" id="5498390">:=</span>&nbsp;<span class="ident" id="5498393">rec</span><span class="op" id="5498396">.</span><span class="ident" id="5498397">read</span><span class="op" id="5498401">(</span><span class="ident" id="5498402">c</span><span class="op" id="5498403">.</span><span class="ident" id="5498404">conn</span><span class="op" id="5498408">.</span><span class="ident" id="5498409">rwc</span><span class="op" id="5498412">)</span><span class="op" id="5498413">;</span>&nbsp;<span class="ident" id="5498415">err</span>&nbsp;<span class="op" id="5498419">!=</span>&nbsp;<span class="ident" id="5498422">nil</span>&nbsp;<span class="op" id="5498426">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498431">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498444">if</span>&nbsp;<span class="ident" id="5498447">err</span>&nbsp;<span class="op" id="5498451">:=</span>&nbsp;<span class="ident" id="5498454">c</span><span class="op" id="5498455">.</span><span class="ident" id="5498456">handleRecord</span><span class="op" id="5498468">(</span><span class="op" id="5498469">&amp;</span><span class="ident" id="5498470">rec</span><span class="op" id="5498473">)</span><span class="op" id="5498474">;</span>&nbsp;<span class="ident" id="5498476">err</span>&nbsp;<span class="op" id="5498480">!=</span>&nbsp;<span class="ident" id="5498483">nil</span>&nbsp;<span class="op" id="5498487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498492">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498501">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498504">}</span><br>
<span class="lineno"></span><span class="op" id="5498506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5498509">var</span>&nbsp;<span class="ident" id="5498513">errCloseConn</span>&nbsp;<span class="op" id="5498526">=</span>&nbsp;<span class="ident" id="5498528">errors</span><span class="op" id="5498534">.</span><span class="ident" id="5498535">New</span><span class="op" id="5498538">(</span><span class="string" id="5498539">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="5498574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="5498577">var</span>&nbsp;<span class="ident" id="5498581">emptyBody</span>&nbsp;<span class="op" id="5498591">=</span>&nbsp;<span class="ident" id="5498593">ioutil</span><span class="op" id="5498599">.</span><span class="ident" id="5498600">NopCloser</span><span class="op" id="5498609">(</span><span class="ident" id="5498610">strings</span><span class="op" id="5498617">.</span><span class="ident" id="5498618">NewReader</span><span class="op" id="5498627">(</span><span class="string" id="5498628">&#34;&#34;</span><span class="op" id="5498630">)</span><span class="op" id="5498631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5498634">func</span>&nbsp;<span class="op" id="5498639">(</span><span class="ident" id="5498640">c</span>&nbsp;<span class="op" id="5498642">*</span><span class="ident" id="5498643">child</span><span class="op" id="5498648">)</span>&nbsp;<span class="ident" id="5498650">handleRecord</span><span class="op" id="5498662">(</span><span class="ident" id="5498663">rec</span>&nbsp;<span class="op" id="5498667">*</span><span class="ident" id="5498668">record</span><span class="op" id="5498674">)</span>&nbsp;<span class="builtintype" id="5498676">error</span>&nbsp;<span class="op" id="5498682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498685">c</span><span class="op" id="5498686">.</span><span class="ident" id="5498687">mu</span><span class="op" id="5498689">.</span><span class="ident" id="5498690">Lock</span><span class="op" id="5498694">(</span><span class="op" id="5498695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498698">req</span><span class="op" id="5498701">,</span>&nbsp;<span class="ident" id="5498703">ok</span>&nbsp;<span class="op" id="5498706">:=</span>&nbsp;<span class="ident" id="5498709">c</span><span class="op" id="5498710">.</span><span class="ident" id="5498711">requests</span><span class="op" id="5498719">[</span><span class="ident" id="5498720">rec</span><span class="op" id="5498723">.</span><span class="ident" id="5498724">h</span><span class="op" id="5498725">.</span><span class="ident" id="5498726">Id</span><span class="op" id="5498728">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5498731">c</span><span class="op" id="5498732">.</span><span class="ident" id="5498733">mu</span><span class="op" id="5498735">.</span><span class="ident" id="5498736">Unlock</span><span class="op" id="5498742">(</span><span class="op" id="5498743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498746">if</span>&nbsp;<span class="op" id="5498749">!</span><span class="ident" id="5498750">ok</span>&nbsp;<span class="op" id="5498753">&amp;&amp;</span>&nbsp;<span class="ident" id="5498756">rec</span><span class="op" id="5498759">.</span><span class="ident" id="5498760">h</span><span class="op" id="5498761">.</span><span class="ident" id="5498762">Type</span>&nbsp;<span class="op" id="5498767">!=</span>&nbsp;<span class="ident" id="5498770">typeBeginRequest</span>&nbsp;<span class="op" id="5498787">&amp;&amp;</span>&nbsp;<span class="ident" id="5498790">rec</span><span class="op" id="5498793">.</span><span class="ident" id="5498794">h</span><span class="op" id="5498795">.</span><span class="ident" id="5498796">Type</span>&nbsp;<span class="op" id="5498801">!=</span>&nbsp;<span class="ident" id="5498804">typeGetValues</span>&nbsp;<span class="op" id="5498818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498822">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498872">return</span>&nbsp;<span class="ident" id="5498879">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5498884">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498888">switch</span>&nbsp;<span class="ident" id="5498895">rec</span><span class="op" id="5498898">.</span><span class="ident" id="5498899">h</span><span class="op" id="5498900">.</span><span class="ident" id="5498901">Type</span>&nbsp;<span class="op" id="5498906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498909">case</span>&nbsp;<span class="ident" id="5498914">typeBeginRequest</span><span class="op" id="5498930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5498934">if</span>&nbsp;<span class="ident" id="5498937">req</span>&nbsp;<span class="op" id="5498941">!=</span>&nbsp;<span class="ident" id="5498944">nil</span>&nbsp;<span class="op" id="5498948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5498953">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499016">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499067">return</span>&nbsp;<span class="ident" id="5499074">errors</span><span class="op" id="5499080">.</span><span class="ident" id="5499081">New</span><span class="op" id="5499084">(</span><span class="string" id="5499085">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="5499130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499139">var</span>&nbsp;<span class="ident" id="5499143">br</span>&nbsp;<span class="ident" id="5499146">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499161">if</span>&nbsp;<span class="ident" id="5499164">err</span>&nbsp;<span class="op" id="5499168">:=</span>&nbsp;<span class="ident" id="5499171">br</span><span class="op" id="5499173">.</span><span class="ident" id="5499174">read</span><span class="op" id="5499178">(</span><span class="ident" id="5499179">rec</span><span class="op" id="5499182">.</span><span class="ident" id="5499183">content</span><span class="op" id="5499190">(</span><span class="op" id="5499191">)</span><span class="op" id="5499192">)</span><span class="op" id="5499193">;</span>&nbsp;<span class="ident" id="5499195">err</span>&nbsp;<span class="op" id="5499199">!=</span>&nbsp;<span class="ident" id="5499202">nil</span>&nbsp;<span class="op" id="5499206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499211">return</span>&nbsp;<span class="ident" id="5499218">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499228">if</span>&nbsp;<span class="ident" id="5499231">br</span><span class="op" id="5499233">.</span><span class="ident" id="5499234">role</span>&nbsp;<span class="op" id="5499239">!=</span>&nbsp;<span class="ident" id="5499242">roleResponder</span>&nbsp;<span class="op" id="5499256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499261">c</span><span class="op" id="5499262">.</span><span class="ident" id="5499263">conn</span><span class="op" id="5499267">.</span><span class="ident" id="5499268">writeEndRequest</span><span class="op" id="5499283">(</span><span class="ident" id="5499284">rec</span><span class="op" id="5499287">.</span><span class="ident" id="5499288">h</span><span class="op" id="5499289">.</span><span class="ident" id="5499290">Id</span><span class="op" id="5499292">,</span>&nbsp;<span class="num" id="5499294">0</span><span class="op" id="5499295">,</span>&nbsp;<span class="ident" id="5499297">statusUnknownRole</span><span class="op" id="5499314">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499319">return</span>&nbsp;<span class="ident" id="5499326">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499336">req</span>&nbsp;<span class="op" id="5499340">=</span>&nbsp;<span class="ident" id="5499342">newRequest</span><span class="op" id="5499352">(</span><span class="ident" id="5499353">rec</span><span class="op" id="5499356">.</span><span class="ident" id="5499357">h</span><span class="op" id="5499358">.</span><span class="ident" id="5499359">Id</span><span class="op" id="5499361">,</span>&nbsp;<span class="ident" id="5499363">br</span><span class="op" id="5499365">.</span><span class="ident" id="5499366">flags</span><span class="op" id="5499371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499375">c</span><span class="op" id="5499376">.</span><span class="ident" id="5499377">mu</span><span class="op" id="5499379">.</span><span class="ident" id="5499380">Lock</span><span class="op" id="5499384">(</span><span class="op" id="5499385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499389">c</span><span class="op" id="5499390">.</span><span class="ident" id="5499391">requests</span><span class="op" id="5499399">[</span><span class="ident" id="5499400">rec</span><span class="op" id="5499403">.</span><span class="ident" id="5499404">h</span><span class="op" id="5499405">.</span><span class="ident" id="5499406">Id</span><span class="op" id="5499408">]</span>&nbsp;<span class="op" id="5499410">=</span>&nbsp;<span class="ident" id="5499412">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499418">c</span><span class="op" id="5499419">.</span><span class="ident" id="5499420">mu</span><span class="op" id="5499422">.</span><span class="ident" id="5499423">Unlock</span><span class="op" id="5499429">(</span><span class="op" id="5499430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499434">return</span>&nbsp;<span class="ident" id="5499441">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499446">case</span>&nbsp;<span class="ident" id="5499451">typeParams</span><span class="op" id="5499461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499465">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499536">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499609">if</span>&nbsp;<span class="builtinfunc" id="5499612">len</span><span class="op" id="5499615">(</span><span class="ident" id="5499616">rec</span><span class="op" id="5499619">.</span><span class="ident" id="5499620">content</span><span class="op" id="5499627">(</span><span class="op" id="5499628">)</span><span class="op" id="5499629">)</span>&nbsp;<span class="op" id="5499631">&gt;</span>&nbsp;<span class="num" id="5499633">0</span>&nbsp;<span class="op" id="5499635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499640">req</span><span class="op" id="5499643">.</span><span class="ident" id="5499644">rawParams</span>&nbsp;<span class="op" id="5499654">=</span>&nbsp;<span class="builtinfunc" id="5499656">append</span><span class="op" id="5499662">(</span><span class="ident" id="5499663">req</span><span class="op" id="5499666">.</span><span class="ident" id="5499667">rawParams</span><span class="op" id="5499676">,</span>&nbsp;<span class="ident" id="5499678">rec</span><span class="op" id="5499681">.</span><span class="ident" id="5499682">content</span><span class="op" id="5499689">(</span><span class="op" id="5499690">)</span><span class="op" id="5499691">...</span><span class="op" id="5499694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499699">return</span>&nbsp;<span class="ident" id="5499706">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5499712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499716">req</span><span class="op" id="5499719">.</span><span class="ident" id="5499720">parseParams</span><span class="op" id="5499731">(</span><span class="op" id="5499732">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499736">return</span>&nbsp;<span class="ident" id="5499743">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499748">case</span>&nbsp;<span class="ident" id="5499753">typeStdin</span><span class="op" id="5499762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499766">content</span>&nbsp;<span class="op" id="5499774">:=</span>&nbsp;<span class="ident" id="5499777">rec</span><span class="op" id="5499780">.</span><span class="ident" id="5499781">content</span><span class="op" id="5499788">(</span><span class="op" id="5499789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499793">if</span>&nbsp;<span class="ident" id="5499796">req</span><span class="op" id="5499799">.</span><span class="ident" id="5499800">pw</span>&nbsp;<span class="op" id="5499803">==</span>&nbsp;<span class="ident" id="5499806">nil</span>&nbsp;<span class="op" id="5499810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499815">var</span>&nbsp;<span class="ident" id="5499819">body</span>&nbsp;<span class="ident" id="5499824">io</span><span class="op" id="5499826">.</span><span class="ident" id="5499827">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5499841">if</span>&nbsp;<span class="builtinfunc" id="5499844">len</span><span class="op" id="5499847">(</span><span class="ident" id="5499848">content</span><span class="op" id="5499855">)</span>&nbsp;<span class="op" id="5499857">&gt;</span>&nbsp;<span class="num" id="5499859">0</span>&nbsp;<span class="op" id="5499861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499867">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5499931">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5499974">body</span><span class="op" id="5499978">,</span>&nbsp;<span class="ident" id="5499980">req</span><span class="op" id="5499983">.</span><span class="ident" id="5499984">pw</span>&nbsp;<span class="op" id="5499987">=</span>&nbsp;<span class="ident" id="5499989">io</span><span class="op" id="5499991">.</span><span class="ident" id="5499992">Pipe</span><span class="op" id="5499996">(</span><span class="op" id="5499997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500002">}</span>&nbsp;<span class="keyword" id="5500004">else</span>&nbsp;<span class="op" id="5500009">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500015">body</span>&nbsp;<span class="op" id="5500020">=</span>&nbsp;<span class="ident" id="5500022">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500040">go</span>&nbsp;<span class="ident" id="5500043">c</span><span class="op" id="5500044">.</span><span class="ident" id="5500045">serveRequest</span><span class="op" id="5500057">(</span><span class="ident" id="5500058">req</span><span class="op" id="5500061">,</span>&nbsp;<span class="ident" id="5500063">body</span><span class="op" id="5500067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500075">if</span>&nbsp;<span class="builtinfunc" id="5500078">len</span><span class="op" id="5500081">(</span><span class="ident" id="5500082">content</span><span class="op" id="5500089">)</span>&nbsp;<span class="op" id="5500091">&gt;</span>&nbsp;<span class="num" id="5500093">0</span>&nbsp;<span class="op" id="5500095">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500100">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500168">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500231">req</span><span class="op" id="5500234">.</span><span class="ident" id="5500235">pw</span><span class="op" id="5500237">.</span><span class="ident" id="5500238">Write</span><span class="op" id="5500243">(</span><span class="ident" id="5500244">content</span><span class="op" id="5500251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500255">}</span>&nbsp;<span class="keyword" id="5500257">else</span>&nbsp;<span class="keyword" id="5500262">if</span>&nbsp;<span class="ident" id="5500265">req</span><span class="op" id="5500268">.</span><span class="ident" id="5500269">pw</span>&nbsp;<span class="op" id="5500272">!=</span>&nbsp;<span class="ident" id="5500275">nil</span>&nbsp;<span class="op" id="5500279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500284">req</span><span class="op" id="5500287">.</span><span class="ident" id="5500288">pw</span><span class="op" id="5500290">.</span><span class="ident" id="5500291">Close</span><span class="op" id="5500296">(</span><span class="op" id="5500297">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500305">return</span>&nbsp;<span class="ident" id="5500312">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500317">case</span>&nbsp;<span class="ident" id="5500322">typeGetValues</span><span class="op" id="5500335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500339">values</span>&nbsp;<span class="op" id="5500346">:=</span>&nbsp;<span class="keyword" id="5500349">map</span><span class="op" id="5500352">[</span><span class="builtintype" id="5500353">string</span><span class="op" id="5500359">]</span><span class="builtintype" id="5500360">string</span><span class="op" id="5500366">{</span><span class="string" id="5500367">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="5500384">:</span>&nbsp;<span class="string" id="5500386">&#34;1&#34;</span><span class="op" id="5500389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500393">c</span><span class="op" id="5500394">.</span><span class="ident" id="5500395">conn</span><span class="op" id="5500399">.</span><span class="ident" id="5500400">writePairs</span><span class="op" id="5500410">(</span><span class="ident" id="5500411">typeGetValuesResult</span><span class="op" id="5500430">,</span>&nbsp;<span class="num" id="5500432">0</span><span class="op" id="5500433">,</span>&nbsp;<span class="ident" id="5500435">values</span><span class="op" id="5500441">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500445">return</span>&nbsp;<span class="ident" id="5500452">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500457">case</span>&nbsp;<span class="ident" id="5500462">typeData</span><span class="op" id="5500470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500474">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500541">return</span>&nbsp;<span class="ident" id="5500548">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500553">case</span>&nbsp;<span class="ident" id="5500558">typeAbortRequest</span><span class="op" id="5500574">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5500578">println</span><span class="op" id="5500585">(</span><span class="string" id="5500586">&#34;abort&#34;</span><span class="op" id="5500593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500597">c</span><span class="op" id="5500598">.</span><span class="ident" id="5500599">mu</span><span class="op" id="5500601">.</span><span class="ident" id="5500602">Lock</span><span class="op" id="5500606">(</span><span class="op" id="5500607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5500611">delete</span><span class="op" id="5500617">(</span><span class="ident" id="5500618">c</span><span class="op" id="5500619">.</span><span class="ident" id="5500620">requests</span><span class="op" id="5500628">,</span>&nbsp;<span class="ident" id="5500630">rec</span><span class="op" id="5500633">.</span><span class="ident" id="5500634">h</span><span class="op" id="5500635">.</span><span class="ident" id="5500636">Id</span><span class="op" id="5500638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500642">c</span><span class="op" id="5500643">.</span><span class="ident" id="5500644">mu</span><span class="op" id="5500646">.</span><span class="ident" id="5500647">Unlock</span><span class="op" id="5500653">(</span><span class="op" id="5500654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500658">c</span><span class="op" id="5500659">.</span><span class="ident" id="5500660">conn</span><span class="op" id="5500664">.</span><span class="ident" id="5500665">writeEndRequest</span><span class="op" id="5500680">(</span><span class="ident" id="5500681">rec</span><span class="op" id="5500684">.</span><span class="ident" id="5500685">h</span><span class="op" id="5500686">.</span><span class="ident" id="5500687">Id</span><span class="op" id="5500689">,</span>&nbsp;<span class="num" id="5500691">0</span><span class="op" id="5500692">,</span>&nbsp;<span class="ident" id="5500694">statusRequestComplete</span><span class="op" id="5500715">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500719">if</span>&nbsp;<span class="op" id="5500722">!</span><span class="ident" id="5500723">req</span><span class="op" id="5500726">.</span><span class="ident" id="5500727">keepConn</span>&nbsp;<span class="op" id="5500736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5500741">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500781">return</span>&nbsp;<span class="ident" id="5500788">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500807">return</span>&nbsp;<span class="ident" id="5500814">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500819">default</span><span class="op" id="5500826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500830">b</span>&nbsp;<span class="op" id="5500832">:=</span>&nbsp;<span class="builtinfunc" id="5500835">make</span><span class="op" id="5500839">(</span><span class="op" id="5500840">[</span><span class="op" id="5500841">]</span><span class="builtintype" id="5500842">byte</span><span class="op" id="5500846">,</span>&nbsp;<span class="num" id="5500848">8</span><span class="op" id="5500849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500853">b</span><span class="op" id="5500854">[</span><span class="num" id="5500855">0</span><span class="op" id="5500856">]</span>&nbsp;<span class="op" id="5500858">=</span>&nbsp;<span class="builtintype" id="5500860">byte</span><span class="op" id="5500864">(</span><span class="ident" id="5500865">rec</span><span class="op" id="5500868">.</span><span class="ident" id="5500869">h</span><span class="op" id="5500870">.</span><span class="ident" id="5500871">Type</span><span class="op" id="5500875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5500879">c</span><span class="op" id="5500880">.</span><span class="ident" id="5500881">conn</span><span class="op" id="5500885">.</span><span class="ident" id="5500886">writeRecord</span><span class="op" id="5500897">(</span><span class="ident" id="5500898">typeUnknownType</span><span class="op" id="5500913">,</span>&nbsp;<span class="num" id="5500915">0</span><span class="op" id="5500916">,</span>&nbsp;<span class="ident" id="5500918">b</span><span class="op" id="5500919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5500923">return</span>&nbsp;<span class="ident" id="5500930">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5500935">}</span><br>
<span class="lineno"></span><span class="op" id="5500937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5500940">func</span>&nbsp;<span class="op" id="5500945">(</span><span class="ident" id="5500946">c</span>&nbsp;<span class="op" id="5500948">*</span><span class="ident" id="5500949">child</span><span class="op" id="5500954">)</span>&nbsp;<span class="ident" id="5500956">serveRequest</span><span class="op" id="5500968">(</span><span class="ident" id="5500969">req</span>&nbsp;<span class="op" id="5500973">*</span><span class="ident" id="5500974">request</span><span class="op" id="5500981">,</span>&nbsp;<span class="ident" id="5500983">body</span>&nbsp;<span class="ident" id="5500988">io</span><span class="op" id="5500990">.</span><span class="ident" id="5500991">ReadCloser</span><span class="op" id="5501001">)</span>&nbsp;<span class="op" id="5501003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501006">r</span>&nbsp;<span class="op" id="5501008">:=</span>&nbsp;<span class="ident" id="5501011">newResponse</span><span class="op" id="5501022">(</span><span class="ident" id="5501023">c</span><span class="op" id="5501024">,</span>&nbsp;<span class="ident" id="5501026">req</span><span class="op" id="5501029">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501032">httpReq</span><span class="op" id="5501039">,</span>&nbsp;<span class="ident" id="5501041">err</span>&nbsp;<span class="op" id="5501045">:=</span>&nbsp;<span class="ident" id="5501048">cgi</span><span class="op" id="5501051">.</span><span class="ident" id="5501052">RequestFromMap</span><span class="op" id="5501066">(</span><span class="ident" id="5501067">req</span><span class="op" id="5501070">.</span><span class="ident" id="5501071">params</span><span class="op" id="5501077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501080">if</span>&nbsp;<span class="ident" id="5501083">err</span>&nbsp;<span class="op" id="5501087">!=</span>&nbsp;<span class="ident" id="5501090">nil</span>&nbsp;<span class="op" id="5501094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501098">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501142">r</span><span class="op" id="5501143">.</span><span class="ident" id="5501144">WriteHeader</span><span class="op" id="5501155">(</span><span class="ident" id="5501156">http</span><span class="op" id="5501160">.</span><span class="ident" id="5501161">StatusInternalServerError</span><span class="op" id="5501186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501190">c</span><span class="op" id="5501191">.</span><span class="ident" id="5501192">conn</span><span class="op" id="5501196">.</span><span class="ident" id="5501197">writeRecord</span><span class="op" id="5501208">(</span><span class="ident" id="5501209">typeStderr</span><span class="op" id="5501219">,</span>&nbsp;<span class="ident" id="5501221">req</span><span class="op" id="5501224">.</span><span class="ident" id="5501225">reqId</span><span class="op" id="5501230">,</span>&nbsp;<span class="op" id="5501232">[</span><span class="op" id="5501233">]</span><span class="builtintype" id="5501234">byte</span><span class="op" id="5501238">(</span><span class="ident" id="5501239">err</span><span class="op" id="5501242">.</span><span class="ident" id="5501243">Error</span><span class="op" id="5501248">(</span><span class="op" id="5501249">)</span><span class="op" id="5501250">)</span><span class="op" id="5501251">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501254">}</span>&nbsp;<span class="keyword" id="5501256">else</span>&nbsp;<span class="op" id="5501261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501265">httpReq</span><span class="op" id="5501272">.</span><span class="ident" id="5501273">Body</span>&nbsp;<span class="op" id="5501278">=</span>&nbsp;<span class="ident" id="5501280">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501287">c</span><span class="op" id="5501288">.</span><span class="ident" id="5501289">handler</span><span class="op" id="5501296">.</span><span class="ident" id="5501297">ServeHTTP</span><span class="op" id="5501306">(</span><span class="ident" id="5501307">r</span><span class="op" id="5501308">,</span>&nbsp;<span class="ident" id="5501310">httpReq</span><span class="op" id="5501317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501323">r</span><span class="op" id="5501324">.</span><span class="ident" id="5501325">Close</span><span class="op" id="5501330">(</span><span class="op" id="5501331">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501334">c</span><span class="op" id="5501335">.</span><span class="ident" id="5501336">mu</span><span class="op" id="5501338">.</span><span class="ident" id="5501339">Lock</span><span class="op" id="5501343">(</span><span class="op" id="5501344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5501347">delete</span><span class="op" id="5501353">(</span><span class="ident" id="5501354">c</span><span class="op" id="5501355">.</span><span class="ident" id="5501356">requests</span><span class="op" id="5501364">,</span>&nbsp;<span class="ident" id="5501366">req</span><span class="op" id="5501369">.</span><span class="ident" id="5501370">reqId</span><span class="op" id="5501375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501378">c</span><span class="op" id="5501379">.</span><span class="ident" id="5501380">mu</span><span class="op" id="5501382">.</span><span class="ident" id="5501383">Unlock</span><span class="op" id="5501389">(</span><span class="op" id="5501390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501393">c</span><span class="op" id="5501394">.</span><span class="ident" id="5501395">conn</span><span class="op" id="5501399">.</span><span class="ident" id="5501400">writeEndRequest</span><span class="op" id="5501415">(</span><span class="ident" id="5501416">req</span><span class="op" id="5501419">.</span><span class="ident" id="5501420">reqId</span><span class="op" id="5501425">,</span>&nbsp;<span class="num" id="5501427">0</span><span class="op" id="5501428">,</span>&nbsp;<span class="ident" id="5501430">statusRequestComplete</span><span class="op" id="5501451">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501455">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501519">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501580">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501635">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501693">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501749">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5501807">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501846">io</span><span class="op" id="5501848">.</span><span class="ident" id="5501849">CopyN</span><span class="op" id="5501854">(</span><span class="ident" id="5501855">ioutil</span><span class="op" id="5501861">.</span><span class="ident" id="5501862">Discard</span><span class="op" id="5501869">,</span>&nbsp;<span class="ident" id="5501871">body</span><span class="op" id="5501875">,</span>&nbsp;<span class="num" id="5501877">100</span><span class="op" id="5501880">&lt;&lt;</span><span class="num" id="5501882">20</span><span class="op" id="5501884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501887">body</span><span class="op" id="5501891">.</span><span class="ident" id="5501892">Close</span><span class="op" id="5501897">(</span><span class="op" id="5501898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5501902">if</span>&nbsp;<span class="op" id="5501905">!</span><span class="ident" id="5501906">req</span><span class="op" id="5501909">.</span><span class="ident" id="5501910">keepConn</span>&nbsp;<span class="op" id="5501919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5501923">c</span><span class="op" id="5501924">.</span><span class="ident" id="5501925">conn</span><span class="op" id="5501929">.</span><span class="ident" id="5501930">Close</span><span class="op" id="5501935">(</span><span class="op" id="5501936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5501939">}</span><br>
<span class="lineno"></span><span class="op" id="5501941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="5501944">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5502024">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5502099">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="5502120">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="5502177">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="5502229">func</span>&nbsp;<span class="ident" id="5502234">Serve</span><span class="op" id="5502239">(</span><span class="ident" id="5502240">l</span>&nbsp;<span class="ident" id="5502242">net</span><span class="op" id="5502245">.</span><span class="ident" id="5502246">Listener</span><span class="op" id="5502254">,</span>&nbsp;<span class="ident" id="5502256">handler</span>&nbsp;<span class="ident" id="5502264">http</span><span class="op" id="5502268">.</span><span class="ident" id="5502269">Handler</span><span class="op" id="5502276">)</span>&nbsp;<span class="builtintype" id="5502278">error</span>&nbsp;<span class="op" id="5502284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502287">if</span>&nbsp;<span class="ident" id="5502290">l</span>&nbsp;<span class="op" id="5502292">==</span>&nbsp;<span class="ident" id="5502295">nil</span>&nbsp;<span class="op" id="5502299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502303">var</span>&nbsp;<span class="ident" id="5502307">err</span>&nbsp;<span class="builtintype" id="5502311">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502319">l</span><span class="op" id="5502320">,</span>&nbsp;<span class="ident" id="5502322">err</span>&nbsp;<span class="op" id="5502326">=</span>&nbsp;<span class="ident" id="5502328">net</span><span class="op" id="5502331">.</span><span class="ident" id="5502332">FileListener</span><span class="op" id="5502344">(</span><span class="ident" id="5502345">os</span><span class="op" id="5502347">.</span><span class="ident" id="5502348">Stdin</span><span class="op" id="5502353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502357">if</span>&nbsp;<span class="ident" id="5502360">err</span>&nbsp;<span class="op" id="5502364">!=</span>&nbsp;<span class="ident" id="5502367">nil</span>&nbsp;<span class="op" id="5502371">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502376">return</span>&nbsp;<span class="ident" id="5502383">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502393">defer</span>&nbsp;<span class="ident" id="5502399">l</span><span class="op" id="5502400">.</span><span class="ident" id="5502401">Close</span><span class="op" id="5502406">(</span><span class="op" id="5502407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502413">if</span>&nbsp;<span class="ident" id="5502416">handler</span>&nbsp;<span class="op" id="5502424">==</span>&nbsp;<span class="ident" id="5502427">nil</span>&nbsp;<span class="op" id="5502431">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502435">handler</span>&nbsp;<span class="op" id="5502443">=</span>&nbsp;<span class="ident" id="5502445">http</span><span class="op" id="5502449">.</span><span class="ident" id="5502450">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502470">for</span>&nbsp;<span class="op" id="5502474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502478">rw</span><span class="op" id="5502480">,</span>&nbsp;<span class="ident" id="5502482">err</span>&nbsp;<span class="op" id="5502486">:=</span>&nbsp;<span class="ident" id="5502489">l</span><span class="op" id="5502490">.</span><span class="ident" id="5502491">Accept</span><span class="op" id="5502497">(</span><span class="op" id="5502498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502502">if</span>&nbsp;<span class="ident" id="5502505">err</span>&nbsp;<span class="op" id="5502509">!=</span>&nbsp;<span class="ident" id="5502512">nil</span>&nbsp;<span class="op" id="5502516">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502521">return</span>&nbsp;<span class="ident" id="5502528">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5502538">c</span>&nbsp;<span class="op" id="5502540">:=</span>&nbsp;<span class="ident" id="5502543">newChild</span><span class="op" id="5502551">(</span><span class="ident" id="5502552">rw</span><span class="op" id="5502554">,</span>&nbsp;<span class="ident" id="5502556">handler</span><span class="op" id="5502563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5502567">go</span>&nbsp;<span class="ident" id="5502570">c</span><span class="op" id="5502571">.</span><span class="ident" id="5502572">serve</span><span class="op" id="5502577">(</span><span class="op" id="5502578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5502581">}</span><br>
<span class="lineno">305</span><span class="op" id="5502583">}</span>
</div>
</body>
</html>
