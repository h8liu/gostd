<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">syntax</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="string">&#34;unicode&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;patchList&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;instruction&nbsp;pointers&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;filled&nbsp;in&nbsp;(patched).</span><br>
<span class="lineno">10</span><span class="comment">//&nbsp;Because&nbsp;the&nbsp;pointers&nbsp;haven&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet,&nbsp;we&nbsp;can&nbsp;reuse&nbsp;their&nbsp;storage</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;hold&nbsp;the&nbsp;list.&nbsp;&nbsp;It&#39;s&nbsp;kind&nbsp;of&nbsp;sleazy,&nbsp;but&nbsp;works&nbsp;well&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;See&nbsp;http://swtch.com/~rsc/regexp/regexp1.html&nbsp;for&nbsp;inspiration.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;These&nbsp;aren&#39;t&nbsp;really&nbsp;pointers:&nbsp;they&#39;re&nbsp;integers,&nbsp;so&nbsp;we&nbsp;can&nbsp;reinterpret&nbsp;them</span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;this&nbsp;way&nbsp;without&nbsp;using&nbsp;package&nbsp;unsafe.&nbsp;&nbsp;A&nbsp;value&nbsp;l&nbsp;denotes</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;p.inst[l&gt;&gt;1].Out&nbsp;(l&amp;1==0)&nbsp;or&nbsp;.Arg&nbsp;(l&amp;1==1).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;l&nbsp;==&nbsp;0&nbsp;denotes&nbsp;the&nbsp;empty&nbsp;list,&nbsp;okay&nbsp;because&nbsp;we&nbsp;start&nbsp;every&nbsp;program</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;with&nbsp;a&nbsp;fail&nbsp;instruction,&nbsp;so&nbsp;we&#39;ll&nbsp;never&nbsp;want&nbsp;to&nbsp;point&nbsp;at&nbsp;its&nbsp;output&nbsp;link.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">patchList</span>&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="ident">patchList</span><span class="op">)</span>&nbsp;<span class="ident">next</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Prog</span><span class="op">)</span>&nbsp;<span class="ident">patchList</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">l</span><span class="op">&gt;&gt;</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="ident">patchList</span><span class="op">)</span>&nbsp;<span class="ident">patch</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Prog</span><span class="op">,</span>&nbsp;<span class="ident">val</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">l</span><span class="op">&gt;&gt;</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">val</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">40</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">l1</span>&nbsp;<span class="ident">patchList</span><span class="op">)</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Prog</span><span class="op">,</span>&nbsp;<span class="ident">l2</span>&nbsp;<span class="ident">patchList</span><span class="op">)</span>&nbsp;<span class="ident">patchList</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l2</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">last</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">last</span><span class="op">.</span><span class="ident">next</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">next</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">last</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">last</span><span class="op">&gt;&gt;</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">last</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">l2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">l2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l1</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;frag&nbsp;represents&nbsp;a&nbsp;compiled&nbsp;program&nbsp;fragment.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;index&nbsp;of&nbsp;first&nbsp;instruction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span>&nbsp;<span class="ident">patchList</span>&nbsp;<span class="comment">//&nbsp;where&nbsp;to&nbsp;record&nbsp;end&nbsp;instruction</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">compiler</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">Prog</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Compile&nbsp;compiles&nbsp;the&nbsp;regexp&nbsp;into&nbsp;a&nbsp;program&nbsp;to&nbsp;be&nbsp;executed.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;regexp&nbsp;should&nbsp;have&nbsp;been&nbsp;simplified&nbsp;already&nbsp;(returned&nbsp;from&nbsp;re.Simplify).</span><br>
<span class="lineno">80</span><span class="keyword">func</span>&nbsp;<span class="ident">Compile</span><span class="op">(</span><span class="ident">re</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Prog</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="ident">compiler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">init</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">re</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span><span class="op">.</span><span class="ident">patch</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstMatch</span><span class="op">)</span><span class="op">.</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Start</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">Prog</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">NumCap</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="comment">//&nbsp;implicit&nbsp;(&nbsp;and&nbsp;)&nbsp;for&nbsp;whole&nbsp;match&nbsp;$0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstFail</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword">var</span>&nbsp;<span class="ident">anyRuneNotNL</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="string">&#39;\n&#39;</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="string">&#39;\n&#39;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">MaxRune</span><span class="op">}</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">anyRune</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">MaxRune</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">compile</span><span class="op">(</span><span class="ident">re</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpNoMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">fail</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpEmptyMatch</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">nop</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpLiteral</span><span class="op">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Rune</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">nop</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="ident">frag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Rune</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="builtintype">rune</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Rune</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="ident">j</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">cat</span><span class="op">(</span><span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">f1</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpCharClass</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="builtintype">rune</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Rune</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpAnyCharNotNL</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="builtintype">rune</span><span class="op">(</span><span class="ident">anyRuneNotNL</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpAnyChar</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="builtintype">rune</span><span class="op">(</span><span class="ident">anyRune</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpBeginLine</span><span class="op">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="ident">EmptyBeginLine</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpEndLine</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="ident">EmptyEndLine</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpBeginText</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="ident">EmptyBeginText</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpEndText</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="ident">EmptyEndText</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpWordBoundary</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="ident">EmptyWordBoundary</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpNoWordBoundary</span><span class="op">:</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">empty</span><span class="op">(</span><span class="ident">EmptyNoWordBoundary</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpCapture</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bra</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="builtinfunc">cap</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Cap</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ket</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="builtinfunc">cap</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Cap</span><span class="op">&lt;&lt;</span><span class="num">1</span>&nbsp;<span class="op">|</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">cat</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">cat</span><span class="op">(</span><span class="ident">bra</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">ket</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpStar</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">star</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpPlus</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">plus</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpQuest</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">quest</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpConcat</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">nop</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="ident">frag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">sub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">sub</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">cat</span><span class="op">(</span><span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">sub</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpAlternate</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="ident">frag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">sub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">alt</span><span class="op">(</span><span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">compile</span><span class="op">(</span><span class="ident">sub</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;regexp:&nbsp;unhandled&nbsp;case&nbsp;in&nbsp;compile&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">inst</span><span class="op">(</span><span class="ident">op</span>&nbsp;<span class="ident">InstOp</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;impose&nbsp;length&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">frag</span><span class="op">{</span><span class="ident">i</span><span class="op">:</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">,</span>&nbsp;<span class="ident">Inst</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">op</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno">175</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">nop</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstNop</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">fail</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">frag</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno">185</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">arg</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstCapture</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">arg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">NumCap</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">arg</span><span class="op">)</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">NumCap</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">arg</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">cat</span><span class="op">(</span><span class="ident">f1</span><span class="op">,</span>&nbsp;<span class="ident">f2</span>&nbsp;<span class="ident">frag</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;concat&nbsp;of&nbsp;failure&nbsp;is&nbsp;failure</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">f2</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">frag</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;elide&nbsp;nop</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f1</span><span class="op">.</span><span class="ident">out</span><span class="op">.</span><span class="ident">patch</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">f2</span><span class="op">.</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">frag</span><span class="op">{</span><span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">f2</span><span class="op">.</span><span class="ident">out</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">alt</span><span class="op">(</span><span class="ident">f1</span><span class="op">,</span>&nbsp;<span class="ident">f2</span>&nbsp;<span class="ident">frag</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;alt&nbsp;of&nbsp;failure&nbsp;is&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f2</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstAlt</span><span class="op">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f2</span><span class="op">.</span><span class="ident">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">out</span><span class="op">.</span><span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">f2</span><span class="op">.</span><span class="ident">out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno">225</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">quest</span><span class="op">(</span><span class="ident">f1</span>&nbsp;<span class="ident">frag</span><span class="op">,</span>&nbsp;<span class="ident">nongreedy</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstAlt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nongreedy</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">&lt;&lt;</span><span class="num">1</span>&nbsp;<span class="op">|</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">out</span><span class="op">.</span><span class="builtinfunc">append</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">star</span><span class="op">(</span><span class="ident">f1</span>&nbsp;<span class="ident">frag</span><span class="op">,</span>&nbsp;<span class="ident">nongreedy</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstAlt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nongreedy</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">&lt;&lt;</span><span class="num">1</span>&nbsp;<span class="op">|</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f1</span><span class="op">.</span><span class="ident">out</span><span class="op">.</span><span class="ident">patch</span><span class="op">(</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">plus</span><span class="op">(</span><span class="ident">f1</span>&nbsp;<span class="ident">frag</span><span class="op">,</span>&nbsp;<span class="ident">nongreedy</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">frag</span><span class="op">{</span><span class="ident">f1</span><span class="op">.</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">star</span><span class="op">(</span><span class="ident">f1</span><span class="op">,</span>&nbsp;<span class="ident">nongreedy</span><span class="op">)</span><span class="op">.</span><span class="ident">out</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="ident">empty</span><span class="op">(</span><span class="ident">op</span>&nbsp;<span class="ident">EmptyOp</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstEmptyWidth</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">op</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">compiler</span><span class="op">)</span>&nbsp;<span class="builtintype">rune</span><span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="ident">flags</span>&nbsp;<span class="ident">Flags</span><span class="op">)</span>&nbsp;<span class="ident">frag</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">inst</span><span class="op">(</span><span class="ident">InstRune</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">c</span><span class="op">.</span><span class="ident">p</span><span class="op">.</span><span class="ident">Inst</span><span class="op">[</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Rune</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flags</span>&nbsp;<span class="op">&amp;=</span>&nbsp;<span class="ident">FoldCase</span>&nbsp;<span class="comment">//&nbsp;only&nbsp;relevant&nbsp;flag&nbsp;is&nbsp;FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">SimpleFold</span><span class="op">(</span><span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;sometimes&nbsp;not&nbsp;even&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flags</span>&nbsp;<span class="op">&amp;^=</span>&nbsp;<span class="ident">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Arg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">flags</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">patchList</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;cases&nbsp;for&nbsp;exec&nbsp;machine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">flags</span><span class="op">&amp;</span><span class="ident">FoldCase</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">InstRune1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">MaxRune</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">InstRuneAny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">4</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;\n&#39;</span><span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">2</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;\n&#39;</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span><span class="op">[</span><span class="num">3</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">MaxRune</span><span class="op">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">InstRuneAnyNotNL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">f</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
