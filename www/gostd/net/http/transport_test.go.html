<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html" class="current">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="563141">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="563196">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="563250">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="563301">//&nbsp;Tests&nbsp;for&nbsp;transport.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="563328">package</span>&nbsp;<span class="ident" id="563336">http_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="563347">import</span>&nbsp;<span class="op" id="563354">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563357">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563366">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563375">&#34;compress/gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563392">&#34;crypto/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563407">&#34;crypto/tls&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563421">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563431">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563438">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563444">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563457">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563464">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563471">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="563483">.</span>&nbsp;<span class="string" id="563485">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563497">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563518">&#34;net/url&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563529">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563535">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563546">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563557">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563568">&#34;sync&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563576">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="563587">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="563594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="563597">//&nbsp;TODO:&nbsp;test&nbsp;5&nbsp;pipelined&nbsp;requests&nbsp;with&nbsp;responses:&nbsp;1)&nbsp;OK,&nbsp;2)&nbsp;OK,&nbsp;Connection:&nbsp;Close</span><br>
<span class="lineno">35</span><span class="comment" id="563680">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;then&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;2&nbsp;responses&nbsp;get&nbsp;errors&nbsp;back.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="563750">//&nbsp;hostPortHandler&nbsp;writes&nbsp;back&nbsp;the&nbsp;client&#39;s&nbsp;&#34;host:port&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="563807">var</span>&nbsp;<span class="ident" id="563811">hostPortHandler</span>&nbsp;<span class="op" id="563827">=</span>&nbsp;<span class="ident" id="563829">HandlerFunc</span><span class="op" id="563840">(</span><span class="keyword" id="563841">func</span><span class="op" id="563845">(</span><span class="ident" id="563846">w</span>&nbsp;<span class="ident" id="563848">ResponseWriter</span><span class="op" id="563862">,</span>&nbsp;<span class="ident" id="563864">r</span>&nbsp;<span class="op" id="563866">*</span><span class="ident" id="563867">Request</span><span class="op" id="563874">)</span>&nbsp;<span class="op" id="563876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="563879">if</span>&nbsp;<span class="ident" id="563882">r</span><span class="op" id="563883">.</span><span class="ident" id="563884">FormValue</span><span class="op" id="563893">(</span><span class="string" id="563894">&#34;close&#34;</span><span class="op" id="563901">)</span>&nbsp;<span class="op" id="563903">==</span>&nbsp;<span class="string" id="563906">&#34;true&#34;</span>&nbsp;<span class="op" id="563913">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="563917">w</span><span class="op" id="563918">.</span><span class="ident" id="563919">Header</span><span class="op" id="563925">(</span><span class="op" id="563926">)</span><span class="op" id="563927">.</span><span class="ident" id="563928">Set</span><span class="op" id="563931">(</span><span class="string" id="563932">&#34;Connection&#34;</span><span class="op" id="563944">,</span>&nbsp;<span class="string" id="563946">&#34;close&#34;</span><span class="op" id="563953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="563956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="563959">w</span><span class="op" id="563960">.</span><span class="ident" id="563961">Write</span><span class="op" id="563966">(</span><span class="op" id="563967">[</span><span class="op" id="563968">]</span><span class="builtintype" id="563969">byte</span><span class="op" id="563973">(</span><span class="ident" id="563974">r</span><span class="op" id="563975">.</span><span class="ident" id="563976">RemoteAddr</span><span class="op" id="563986">)</span><span class="op" id="563987">)</span><br>
<span class="lineno"></span><span class="op" id="563989">}</span><span class="op" id="563990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="563993">//&nbsp;testCloseConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;tracked&nbsp;by&nbsp;a&nbsp;testConnSet.</span><br>
<span class="lineno"></span><span class="keyword" id="564050">type</span>&nbsp;<span class="ident" id="564055">testCloseConn</span>&nbsp;<span class="keyword" id="564069">struct</span>&nbsp;<span class="op" id="564076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564079">net</span><span class="op" id="564082">.</span><span class="ident" id="564083">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564089">set</span>&nbsp;<span class="op" id="564093">*</span><span class="ident" id="564094">testConnSet</span><br>
<span class="lineno"></span><span class="op" id="564106">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="564109">func</span>&nbsp;<span class="op" id="564114">(</span><span class="ident" id="564115">c</span>&nbsp;<span class="op" id="564117">*</span><span class="ident" id="564118">testCloseConn</span><span class="op" id="564131">)</span>&nbsp;<span class="ident" id="564133">Close</span><span class="op" id="564138">(</span><span class="op" id="564139">)</span>&nbsp;<span class="builtintype" id="564141">error</span>&nbsp;<span class="op" id="564147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564150">c</span><span class="op" id="564151">.</span><span class="ident" id="564152">set</span><span class="op" id="564155">.</span><span class="ident" id="564156">remove</span><span class="op" id="564162">(</span><span class="ident" id="564163">c</span><span class="op" id="564164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="564167">return</span>&nbsp;<span class="ident" id="564174">c</span><span class="op" id="564175">.</span><span class="ident" id="564176">Conn</span><span class="op" id="564180">.</span><span class="ident" id="564181">Close</span><span class="op" id="564186">(</span><span class="op" id="564187">)</span><br>
<span class="lineno"></span><span class="op" id="564189">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="564192">//&nbsp;testConnSet&nbsp;tracks&nbsp;a&nbsp;set&nbsp;of&nbsp;TCP&nbsp;connections&nbsp;and&nbsp;whether&nbsp;they&#39;ve</span><br>
<span class="lineno"></span><span class="comment" id="564259">//&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="564275">type</span>&nbsp;<span class="ident" id="564280">testConnSet</span>&nbsp;<span class="keyword" id="564292">struct</span>&nbsp;<span class="op" id="564299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564302">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="564309">*</span><span class="ident" id="564310">testing</span><span class="op" id="564317">.</span><span class="ident" id="564318">T</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564321">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564328">sync</span><span class="op" id="564332">.</span><span class="ident" id="564333">Mutex</span>&nbsp;<span class="comment" id="564339">//&nbsp;guards&nbsp;closed&nbsp;and&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564366">closed</span>&nbsp;<span class="keyword" id="564373">map</span><span class="op" id="564376">[</span><span class="ident" id="564377">net</span><span class="op" id="564380">.</span><span class="ident" id="564381">Conn</span><span class="op" id="564385">]</span><span class="builtintype" id="564386">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564392">list</span>&nbsp;&nbsp;&nbsp;<span class="op" id="564399">[</span><span class="op" id="564400">]</span><span class="ident" id="564401">net</span><span class="op" id="564404">.</span><span class="ident" id="564405">Conn</span>&nbsp;<span class="comment" id="564410">//&nbsp;in&nbsp;order&nbsp;created</span><br>
<span class="lineno"></span><span class="op" id="564430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="564433">func</span>&nbsp;<span class="op" id="564438">(</span><span class="ident" id="564439">tcs</span>&nbsp;<span class="op" id="564443">*</span><span class="ident" id="564444">testConnSet</span><span class="op" id="564455">)</span>&nbsp;<span class="ident" id="564457">insert</span><span class="op" id="564463">(</span><span class="ident" id="564464">c</span>&nbsp;<span class="ident" id="564466">net</span><span class="op" id="564469">.</span><span class="ident" id="564470">Conn</span><span class="op" id="564474">)</span>&nbsp;<span class="op" id="564476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564479">tcs</span><span class="op" id="564482">.</span><span class="ident" id="564483">mu</span><span class="op" id="564485">.</span><span class="ident" id="564486">Lock</span><span class="op" id="564490">(</span><span class="op" id="564491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="564494">defer</span>&nbsp;<span class="ident" id="564500">tcs</span><span class="op" id="564503">.</span><span class="ident" id="564504">mu</span><span class="op" id="564506">.</span><span class="ident" id="564507">Unlock</span><span class="op" id="564513">(</span><span class="op" id="564514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564517">tcs</span><span class="op" id="564520">.</span><span class="ident" id="564521">closed</span><span class="op" id="564527">[</span><span class="ident" id="564528">c</span><span class="op" id="564529">]</span>&nbsp;<span class="op" id="564531">=</span>&nbsp;<span class="builtintype" id="564533">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564540">tcs</span><span class="op" id="564543">.</span><span class="ident" id="564544">list</span>&nbsp;<span class="op" id="564549">=</span>&nbsp;<span class="builtinfunc" id="564551">append</span><span class="op" id="564557">(</span><span class="ident" id="564558">tcs</span><span class="op" id="564561">.</span><span class="ident" id="564562">list</span><span class="op" id="564566">,</span>&nbsp;<span class="ident" id="564568">c</span><span class="op" id="564569">)</span><br>
<span class="lineno">70</span><span class="op" id="564571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="564574">func</span>&nbsp;<span class="op" id="564579">(</span><span class="ident" id="564580">tcs</span>&nbsp;<span class="op" id="564584">*</span><span class="ident" id="564585">testConnSet</span><span class="op" id="564596">)</span>&nbsp;<span class="ident" id="564598">remove</span><span class="op" id="564604">(</span><span class="ident" id="564605">c</span>&nbsp;<span class="ident" id="564607">net</span><span class="op" id="564610">.</span><span class="ident" id="564611">Conn</span><span class="op" id="564615">)</span>&nbsp;<span class="op" id="564617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564620">tcs</span><span class="op" id="564623">.</span><span class="ident" id="564624">mu</span><span class="op" id="564626">.</span><span class="ident" id="564627">Lock</span><span class="op" id="564631">(</span><span class="op" id="564632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="564635">defer</span>&nbsp;<span class="ident" id="564641">tcs</span><span class="op" id="564644">.</span><span class="ident" id="564645">mu</span><span class="op" id="564647">.</span><span class="ident" id="564648">Unlock</span><span class="op" id="564654">(</span><span class="op" id="564655">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564658">tcs</span><span class="op" id="564661">.</span><span class="ident" id="564662">closed</span><span class="op" id="564668">[</span><span class="ident" id="564669">c</span><span class="op" id="564670">]</span>&nbsp;<span class="op" id="564672">=</span>&nbsp;<span class="builtintype" id="564674">true</span><br>
<span class="lineno"></span><span class="op" id="564679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="564682">//&nbsp;some&nbsp;tests&nbsp;use&nbsp;this&nbsp;to&nbsp;manage&nbsp;raw&nbsp;tcp&nbsp;connections&nbsp;for&nbsp;later&nbsp;inspection</span><br>
<span class="lineno"></span><span class="keyword" id="564756">func</span>&nbsp;<span class="ident" id="564761">makeTestDial</span><span class="op" id="564773">(</span><span class="ident" id="564774">t</span>&nbsp;<span class="op" id="564776">*</span><span class="ident" id="564777">testing</span><span class="op" id="564784">.</span><span class="ident" id="564785">T</span><span class="op" id="564786">)</span>&nbsp;<span class="op" id="564788">(</span><span class="op" id="564789">*</span><span class="ident" id="564790">testConnSet</span><span class="op" id="564801">,</span>&nbsp;<span class="keyword" id="564803">func</span><span class="op" id="564807">(</span><span class="ident" id="564808">n</span><span class="op" id="564809">,</span>&nbsp;<span class="ident" id="564811">addr</span>&nbsp;<span class="builtintype" id="564816">string</span><span class="op" id="564822">)</span>&nbsp;<span class="op" id="564824">(</span><span class="ident" id="564825">net</span><span class="op" id="564828">.</span><span class="ident" id="564829">Conn</span><span class="op" id="564833">,</span>&nbsp;<span class="builtintype" id="564835">error</span><span class="op" id="564840">)</span><span class="op" id="564841">)</span>&nbsp;<span class="op" id="564843">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564846">connSet</span>&nbsp;<span class="op" id="564854">:=</span>&nbsp;<span class="op" id="564857">&amp;</span><span class="ident" id="564858">testConnSet</span><span class="op" id="564869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564873">t</span><span class="op" id="564874">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564881">t</span><span class="op" id="564882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564886">closed</span><span class="op" id="564892">:</span>&nbsp;<span class="builtinfunc" id="564894">make</span><span class="op" id="564898">(</span><span class="keyword" id="564899">map</span><span class="op" id="564902">[</span><span class="ident" id="564903">net</span><span class="op" id="564906">.</span><span class="ident" id="564907">Conn</span><span class="op" id="564911">]</span><span class="builtintype" id="564912">bool</span><span class="op" id="564916">)</span><span class="op" id="564917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="564920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564923">dial</span>&nbsp;<span class="op" id="564928">:=</span>&nbsp;<span class="keyword" id="564931">func</span><span class="op" id="564935">(</span><span class="ident" id="564936">n</span><span class="op" id="564937">,</span>&nbsp;<span class="ident" id="564939">addr</span>&nbsp;<span class="builtintype" id="564944">string</span><span class="op" id="564950">)</span>&nbsp;<span class="op" id="564952">(</span><span class="ident" id="564953">net</span><span class="op" id="564956">.</span><span class="ident" id="564957">Conn</span><span class="op" id="564961">,</span>&nbsp;<span class="builtintype" id="564963">error</span><span class="op" id="564968">)</span>&nbsp;<span class="op" id="564970">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="564974">c</span><span class="op" id="564975">,</span>&nbsp;<span class="ident" id="564977">err</span>&nbsp;<span class="op" id="564981">:=</span>&nbsp;<span class="ident" id="564984">net</span><span class="op" id="564987">.</span><span class="ident" id="564988">Dial</span><span class="op" id="564992">(</span><span class="ident" id="564993">n</span><span class="op" id="564994">,</span>&nbsp;<span class="ident" id="564996">addr</span><span class="op" id="565000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565004">if</span>&nbsp;<span class="ident" id="565007">err</span>&nbsp;<span class="op" id="565011">!=</span>&nbsp;<span class="ident" id="565014">nil</span>&nbsp;<span class="op" id="565018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565023">return</span>&nbsp;<span class="ident" id="565030">nil</span><span class="op" id="565033">,</span>&nbsp;<span class="ident" id="565035">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="565041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565045">tc</span>&nbsp;<span class="op" id="565048">:=</span>&nbsp;<span class="op" id="565051">&amp;</span><span class="ident" id="565052">testCloseConn</span><span class="op" id="565065">{</span><span class="ident" id="565066">c</span><span class="op" id="565067">,</span>&nbsp;<span class="ident" id="565069">connSet</span><span class="op" id="565076">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565080">connSet</span><span class="op" id="565087">.</span><span class="ident" id="565088">insert</span><span class="op" id="565094">(</span><span class="ident" id="565095">tc</span><span class="op" id="565097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565101">return</span>&nbsp;<span class="ident" id="565108">tc</span><span class="op" id="565110">,</span>&nbsp;<span class="ident" id="565112">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="565117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565120">return</span>&nbsp;<span class="ident" id="565127">connSet</span><span class="op" id="565134">,</span>&nbsp;<span class="ident" id="565136">dial</span><br>
<span class="lineno"></span><span class="op" id="565141">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="565144">func</span>&nbsp;<span class="op" id="565149">(</span><span class="ident" id="565150">tcs</span>&nbsp;<span class="op" id="565154">*</span><span class="ident" id="565155">testConnSet</span><span class="op" id="565166">)</span>&nbsp;<span class="ident" id="565168">check</span><span class="op" id="565173">(</span><span class="ident" id="565174">t</span>&nbsp;<span class="op" id="565176">*</span><span class="ident" id="565177">testing</span><span class="op" id="565184">.</span><span class="ident" id="565185">T</span><span class="op" id="565186">)</span>&nbsp;<span class="op" id="565188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565191">tcs</span><span class="op" id="565194">.</span><span class="ident" id="565195">mu</span><span class="op" id="565197">.</span><span class="ident" id="565198">Lock</span><span class="op" id="565202">(</span><span class="op" id="565203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565206">defer</span>&nbsp;<span class="ident" id="565212">tcs</span><span class="op" id="565215">.</span><span class="ident" id="565216">mu</span><span class="op" id="565218">.</span><span class="ident" id="565219">Unlock</span><span class="op" id="565225">(</span><span class="op" id="565226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565229">for</span>&nbsp;<span class="ident" id="565233">i</span>&nbsp;<span class="op" id="565235">:=</span>&nbsp;<span class="num" id="565238">4</span><span class="op" id="565239">;</span>&nbsp;<span class="ident" id="565241">i</span>&nbsp;<span class="op" id="565243">&gt;=</span>&nbsp;<span class="num" id="565246">0</span><span class="op" id="565247">;</span>&nbsp;<span class="ident" id="565249">i</span><span class="op" id="565250">--</span>&nbsp;<span class="op" id="565253">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565257">for</span>&nbsp;<span class="ident" id="565261">i</span><span class="op" id="565262">,</span>&nbsp;<span class="ident" id="565264">c</span>&nbsp;<span class="op" id="565266">:=</span>&nbsp;<span class="keyword" id="565269">range</span>&nbsp;<span class="ident" id="565275">tcs</span><span class="op" id="565278">.</span><span class="ident" id="565279">list</span>&nbsp;<span class="op" id="565284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565289">if</span>&nbsp;<span class="ident" id="565292">tcs</span><span class="op" id="565295">.</span><span class="ident" id="565296">closed</span><span class="op" id="565302">[</span><span class="ident" id="565303">c</span><span class="op" id="565304">]</span>&nbsp;<span class="op" id="565306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565312">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="565324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565329">if</span>&nbsp;<span class="ident" id="565332">i</span>&nbsp;<span class="op" id="565334">!=</span>&nbsp;<span class="num" id="565337">0</span>&nbsp;<span class="op" id="565339">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565345">tcs</span><span class="op" id="565348">.</span><span class="ident" id="565349">mu</span><span class="op" id="565351">.</span><span class="ident" id="565352">Unlock</span><span class="op" id="565358">(</span><span class="op" id="565359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565365">time</span><span class="op" id="565369">.</span><span class="ident" id="565370">Sleep</span><span class="op" id="565375">(</span><span class="num" id="565376">50</span>&nbsp;<span class="op" id="565379">*</span>&nbsp;<span class="ident" id="565381">time</span><span class="op" id="565385">.</span><span class="ident" id="565386">Millisecond</span><span class="op" id="565397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565403">tcs</span><span class="op" id="565406">.</span><span class="ident" id="565407">mu</span><span class="op" id="565409">.</span><span class="ident" id="565410">Lock</span><span class="op" id="565414">(</span><span class="op" id="565415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565421">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="565433">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565438">t</span><span class="op" id="565439">.</span><span class="ident" id="565440">Errorf</span><span class="op" id="565446">(</span><span class="string" id="565447">&#34;TCP&nbsp;connection&nbsp;#%d,&nbsp;%p&nbsp;(of&nbsp;%d&nbsp;total)&nbsp;was&nbsp;not&nbsp;closed&#34;</span><span class="op" id="565500">,</span>&nbsp;<span class="ident" id="565502">i</span><span class="op" id="565503">+</span><span class="num" id="565504">1</span><span class="op" id="565505">,</span>&nbsp;<span class="ident" id="565507">c</span><span class="op" id="565508">,</span>&nbsp;<span class="builtinfunc" id="565510">len</span><span class="op" id="565513">(</span><span class="ident" id="565514">tcs</span><span class="op" id="565517">.</span><span class="ident" id="565518">list</span><span class="op" id="565522">)</span><span class="op" id="565523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="565527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="565530">}</span><br>
<span class="lineno"></span><span class="op" id="565532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="565535">//&nbsp;Two&nbsp;subsequent&nbsp;requests&nbsp;and&nbsp;verify&nbsp;their&nbsp;response&nbsp;is&nbsp;the&nbsp;same.</span><br>
<span class="lineno"></span><span class="comment" id="565601">//&nbsp;The&nbsp;response&nbsp;from&nbsp;the&nbsp;server&nbsp;is&nbsp;our&nbsp;own&nbsp;IP:port</span><br>
<span class="lineno"></span><span class="keyword" id="565652">func</span>&nbsp;<span class="ident" id="565657">TestTransportKeepAlives</span><span class="op" id="565680">(</span><span class="ident" id="565681">t</span>&nbsp;<span class="op" id="565683">*</span><span class="ident" id="565684">testing</span><span class="op" id="565691">.</span><span class="ident" id="565692">T</span><span class="op" id="565693">)</span>&nbsp;<span class="op" id="565695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565698">defer</span>&nbsp;<span class="ident" id="565704">afterTest</span><span class="op" id="565713">(</span><span class="ident" id="565714">t</span><span class="op" id="565715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565718">ts</span>&nbsp;<span class="op" id="565721">:=</span>&nbsp;<span class="ident" id="565724">httptest</span><span class="op" id="565732">.</span><span class="ident" id="565733">NewServer</span><span class="op" id="565742">(</span><span class="ident" id="565743">hostPortHandler</span><span class="op" id="565758">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565761">defer</span>&nbsp;<span class="ident" id="565767">ts</span><span class="op" id="565769">.</span><span class="ident" id="565770">Close</span><span class="op" id="565775">(</span><span class="op" id="565776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565780">for</span>&nbsp;<span class="ident" id="565784">_</span><span class="op" id="565785">,</span>&nbsp;<span class="ident" id="565787">disableKeepAlive</span>&nbsp;<span class="op" id="565804">:=</span>&nbsp;<span class="keyword" id="565807">range</span>&nbsp;<span class="op" id="565813">[</span><span class="op" id="565814">]</span><span class="builtintype" id="565815">bool</span><span class="op" id="565819">{</span><span class="builtintype" id="565820">false</span><span class="op" id="565825">,</span>&nbsp;<span class="builtintype" id="565827">true</span><span class="op" id="565831">}</span>&nbsp;<span class="op" id="565833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565837">tr</span>&nbsp;<span class="op" id="565840">:=</span>&nbsp;<span class="op" id="565843">&amp;</span><span class="ident" id="565844">Transport</span><span class="op" id="565853">{</span><span class="ident" id="565854">DisableKeepAlives</span><span class="op" id="565871">:</span>&nbsp;<span class="ident" id="565873">disableKeepAlive</span><span class="op" id="565889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="565893">defer</span>&nbsp;<span class="ident" id="565899">tr</span><span class="op" id="565901">.</span><span class="ident" id="565902">CloseIdleConnections</span><span class="op" id="565922">(</span><span class="op" id="565923">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565927">c</span>&nbsp;<span class="op" id="565929">:=</span>&nbsp;<span class="op" id="565932">&amp;</span><span class="ident" id="565933">Client</span><span class="op" id="565939">{</span><span class="ident" id="565940">Transport</span><span class="op" id="565949">:</span>&nbsp;<span class="ident" id="565951">tr</span><span class="op" id="565953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565958">fetch</span>&nbsp;<span class="op" id="565964">:=</span>&nbsp;<span class="keyword" id="565967">func</span><span class="op" id="565971">(</span><span class="ident" id="565972">n</span>&nbsp;<span class="builtintype" id="565974">int</span><span class="op" id="565977">)</span>&nbsp;<span class="builtintype" id="565979">string</span>&nbsp;<span class="op" id="565986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="565991">res</span><span class="op" id="565994">,</span>&nbsp;<span class="ident" id="565996">err</span>&nbsp;<span class="op" id="566000">:=</span>&nbsp;<span class="ident" id="566003">c</span><span class="op" id="566004">.</span><span class="ident" id="566005">Get</span><span class="op" id="566008">(</span><span class="ident" id="566009">ts</span><span class="op" id="566011">.</span><span class="ident" id="566012">URL</span><span class="op" id="566015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566020">if</span>&nbsp;<span class="ident" id="566023">err</span>&nbsp;<span class="op" id="566027">!=</span>&nbsp;<span class="ident" id="566030">nil</span>&nbsp;<span class="op" id="566034">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566040">t</span><span class="op" id="566041">.</span><span class="ident" id="566042">Fatalf</span><span class="op" id="566048">(</span><span class="string" id="566049">&#34;error&nbsp;in&nbsp;disableKeepAlive=%v,&nbsp;req&nbsp;#%d,&nbsp;GET:&nbsp;%v&#34;</span><span class="op" id="566097">,</span>&nbsp;<span class="ident" id="566099">disableKeepAlive</span><span class="op" id="566115">,</span>&nbsp;<span class="ident" id="566117">n</span><span class="op" id="566118">,</span>&nbsp;<span class="ident" id="566120">err</span><span class="op" id="566123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="566128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566133">body</span><span class="op" id="566137">,</span>&nbsp;<span class="ident" id="566139">err</span>&nbsp;<span class="op" id="566143">:=</span>&nbsp;<span class="ident" id="566146">ioutil</span><span class="op" id="566152">.</span><span class="ident" id="566153">ReadAll</span><span class="op" id="566160">(</span><span class="ident" id="566161">res</span><span class="op" id="566164">.</span><span class="ident" id="566165">Body</span><span class="op" id="566169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566174">if</span>&nbsp;<span class="ident" id="566177">err</span>&nbsp;<span class="op" id="566181">!=</span>&nbsp;<span class="ident" id="566184">nil</span>&nbsp;<span class="op" id="566188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566194">t</span><span class="op" id="566195">.</span><span class="ident" id="566196">Fatalf</span><span class="op" id="566202">(</span><span class="string" id="566203">&#34;error&nbsp;in&nbsp;disableKeepAlive=%v,&nbsp;req&nbsp;#%d,&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="566255">,</span>&nbsp;<span class="ident" id="566257">disableKeepAlive</span><span class="op" id="566273">,</span>&nbsp;<span class="ident" id="566275">n</span><span class="op" id="566276">,</span>&nbsp;<span class="ident" id="566278">err</span><span class="op" id="566281">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="566286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566291">return</span>&nbsp;<span class="builtintype" id="566298">string</span><span class="op" id="566304">(</span><span class="ident" id="566305">body</span><span class="op" id="566309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="566313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566318">body1</span>&nbsp;<span class="op" id="566324">:=</span>&nbsp;<span class="ident" id="566327">fetch</span><span class="op" id="566332">(</span><span class="num" id="566333">1</span><span class="op" id="566334">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566338">body2</span>&nbsp;<span class="op" id="566344">:=</span>&nbsp;<span class="ident" id="566347">fetch</span><span class="op" id="566352">(</span><span class="num" id="566353">2</span><span class="op" id="566354">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566359">bodiesDiffer</span>&nbsp;<span class="op" id="566372">:=</span>&nbsp;<span class="ident" id="566375">body1</span>&nbsp;<span class="op" id="566381">!=</span>&nbsp;<span class="ident" id="566384">body2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566392">if</span>&nbsp;<span class="ident" id="566395">bodiesDiffer</span>&nbsp;<span class="op" id="566408">!=</span>&nbsp;<span class="ident" id="566411">disableKeepAlive</span>&nbsp;<span class="op" id="566428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566433">t</span><span class="op" id="566434">.</span><span class="ident" id="566435">Errorf</span><span class="op" id="566441">(</span><span class="string" id="566442">&#34;error&nbsp;in&nbsp;disableKeepAlive=%v.&nbsp;unexpected&nbsp;bodiesDiffer=%v;&nbsp;body1=%q;&nbsp;body2=%q&#34;</span><span class="op" id="566520">,</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566526">disableKeepAlive</span><span class="op" id="566542">,</span>&nbsp;<span class="ident" id="566544">bodiesDiffer</span><span class="op" id="566556">,</span>&nbsp;<span class="ident" id="566558">body1</span><span class="op" id="566563">,</span>&nbsp;<span class="ident" id="566565">body2</span><span class="op" id="566570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="566574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="566577">}</span><br>
<span class="lineno"></span><span class="op" id="566579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="566582">func</span>&nbsp;<span class="ident" id="566587">TestTransportConnectionCloseOnResponse</span><span class="op" id="566625">(</span><span class="ident" id="566626">t</span>&nbsp;<span class="op" id="566628">*</span><span class="ident" id="566629">testing</span><span class="op" id="566636">.</span><span class="ident" id="566637">T</span><span class="op" id="566638">)</span>&nbsp;<span class="op" id="566640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566643">defer</span>&nbsp;<span class="ident" id="566649">afterTest</span><span class="op" id="566658">(</span><span class="ident" id="566659">t</span><span class="op" id="566660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566663">ts</span>&nbsp;<span class="op" id="566666">:=</span>&nbsp;<span class="ident" id="566669">httptest</span><span class="op" id="566677">.</span><span class="ident" id="566678">NewServer</span><span class="op" id="566687">(</span><span class="ident" id="566688">hostPortHandler</span><span class="op" id="566703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566706">defer</span>&nbsp;<span class="ident" id="566712">ts</span><span class="op" id="566714">.</span><span class="ident" id="566715">Close</span><span class="op" id="566720">(</span><span class="op" id="566721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566725">connSet</span><span class="op" id="566732">,</span>&nbsp;<span class="ident" id="566734">testDial</span>&nbsp;<span class="op" id="566743">:=</span>&nbsp;<span class="ident" id="566746">makeTestDial</span><span class="op" id="566758">(</span><span class="ident" id="566759">t</span><span class="op" id="566760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566764">for</span>&nbsp;<span class="ident" id="566768">_</span><span class="op" id="566769">,</span>&nbsp;<span class="ident" id="566771">connectionClose</span>&nbsp;<span class="op" id="566787">:=</span>&nbsp;<span class="keyword" id="566790">range</span>&nbsp;<span class="op" id="566796">[</span><span class="op" id="566797">]</span><span class="builtintype" id="566798">bool</span><span class="op" id="566802">{</span><span class="builtintype" id="566803">false</span><span class="op" id="566808">,</span>&nbsp;<span class="builtintype" id="566810">true</span><span class="op" id="566814">}</span>&nbsp;<span class="op" id="566816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566820">tr</span>&nbsp;<span class="op" id="566823">:=</span>&nbsp;<span class="op" id="566826">&amp;</span><span class="ident" id="566827">Transport</span><span class="op" id="566836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566841">Dial</span><span class="op" id="566845">:</span>&nbsp;<span class="ident" id="566847">testDial</span><span class="op" id="566855">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="566859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566863">c</span>&nbsp;<span class="op" id="566865">:=</span>&nbsp;<span class="op" id="566868">&amp;</span><span class="ident" id="566869">Client</span><span class="op" id="566875">{</span><span class="ident" id="566876">Transport</span><span class="op" id="566885">:</span>&nbsp;<span class="ident" id="566887">tr</span><span class="op" id="566889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566894">fetch</span>&nbsp;<span class="op" id="566900">:=</span>&nbsp;<span class="keyword" id="566903">func</span><span class="op" id="566907">(</span><span class="ident" id="566908">n</span>&nbsp;<span class="builtintype" id="566910">int</span><span class="op" id="566913">)</span>&nbsp;<span class="builtintype" id="566915">string</span>&nbsp;<span class="op" id="566922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566927">req</span>&nbsp;<span class="op" id="566931">:=</span>&nbsp;<span class="builtinfunc" id="566934">new</span><span class="op" id="566937">(</span><span class="ident" id="566938">Request</span><span class="op" id="566945">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="566950">var</span>&nbsp;<span class="ident" id="566954">err</span>&nbsp;<span class="builtintype" id="566958">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="566967">req</span><span class="op" id="566970">.</span><span class="ident" id="566971">URL</span><span class="op" id="566974">,</span>&nbsp;<span class="ident" id="566976">err</span>&nbsp;<span class="op" id="566980">=</span>&nbsp;<span class="ident" id="566982">url</span><span class="op" id="566985">.</span><span class="ident" id="566986">Parse</span><span class="op" id="566991">(</span><span class="ident" id="566992">ts</span><span class="op" id="566994">.</span><span class="ident" id="566995">URL</span>&nbsp;<span class="op" id="566999">+</span>&nbsp;<span class="ident" id="567001">fmt</span><span class="op" id="567004">.</span><span class="ident" id="567005">Sprintf</span><span class="op" id="567012">(</span><span class="string" id="567013">&#34;/?close=%v&#34;</span><span class="op" id="567025">,</span>&nbsp;<span class="ident" id="567027">connectionClose</span><span class="op" id="567042">)</span><span class="op" id="567043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567048">if</span>&nbsp;<span class="ident" id="567051">err</span>&nbsp;<span class="op" id="567055">!=</span>&nbsp;<span class="ident" id="567058">nil</span>&nbsp;<span class="op" id="567062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567068">t</span><span class="op" id="567069">.</span><span class="ident" id="567070">Fatalf</span><span class="op" id="567076">(</span><span class="string" id="567077">&#34;URL&nbsp;parse&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="567098">,</span>&nbsp;<span class="ident" id="567100">err</span><span class="op" id="567103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="567108">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567113">req</span><span class="op" id="567116">.</span><span class="ident" id="567117">Method</span>&nbsp;<span class="op" id="567124">=</span>&nbsp;<span class="string" id="567126">&#34;GET&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567135">req</span><span class="op" id="567138">.</span><span class="ident" id="567139">Proto</span>&nbsp;<span class="op" id="567145">=</span>&nbsp;<span class="string" id="567147">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567161">req</span><span class="op" id="567164">.</span><span class="ident" id="567165">ProtoMajor</span>&nbsp;<span class="op" id="567176">=</span>&nbsp;<span class="num" id="567178">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567183">req</span><span class="op" id="567186">.</span><span class="ident" id="567187">ProtoMinor</span>&nbsp;<span class="op" id="567198">=</span>&nbsp;<span class="num" id="567200">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567206">res</span><span class="op" id="567209">,</span>&nbsp;<span class="ident" id="567211">err</span>&nbsp;<span class="op" id="567215">:=</span>&nbsp;<span class="ident" id="567218">c</span><span class="op" id="567219">.</span><span class="ident" id="567220">Do</span><span class="op" id="567222">(</span><span class="ident" id="567223">req</span><span class="op" id="567226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567231">if</span>&nbsp;<span class="ident" id="567234">err</span>&nbsp;<span class="op" id="567238">!=</span>&nbsp;<span class="ident" id="567241">nil</span>&nbsp;<span class="op" id="567245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567251">t</span><span class="op" id="567252">.</span><span class="ident" id="567253">Fatalf</span><span class="op" id="567259">(</span><span class="string" id="567260">&#34;error&nbsp;in&nbsp;connectionClose=%v,&nbsp;req&nbsp;#%d,&nbsp;Do:&nbsp;%v&#34;</span><span class="op" id="567306">,</span>&nbsp;<span class="ident" id="567308">connectionClose</span><span class="op" id="567323">,</span>&nbsp;<span class="ident" id="567325">n</span><span class="op" id="567326">,</span>&nbsp;<span class="ident" id="567328">err</span><span class="op" id="567331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="567336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567341">defer</span>&nbsp;<span class="ident" id="567347">res</span><span class="op" id="567350">.</span><span class="ident" id="567351">Body</span><span class="op" id="567355">.</span><span class="ident" id="567356">Close</span><span class="op" id="567361">(</span><span class="op" id="567362">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567367">body</span><span class="op" id="567371">,</span>&nbsp;<span class="ident" id="567373">err</span>&nbsp;<span class="op" id="567377">:=</span>&nbsp;<span class="ident" id="567380">ioutil</span><span class="op" id="567386">.</span><span class="ident" id="567387">ReadAll</span><span class="op" id="567394">(</span><span class="ident" id="567395">res</span><span class="op" id="567398">.</span><span class="ident" id="567399">Body</span><span class="op" id="567403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567408">if</span>&nbsp;<span class="ident" id="567411">err</span>&nbsp;<span class="op" id="567415">!=</span>&nbsp;<span class="ident" id="567418">nil</span>&nbsp;<span class="op" id="567422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567428">t</span><span class="op" id="567429">.</span><span class="ident" id="567430">Fatalf</span><span class="op" id="567436">(</span><span class="string" id="567437">&#34;error&nbsp;in&nbsp;connectionClose=%v,&nbsp;req&nbsp;#%d,&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="567488">,</span>&nbsp;<span class="ident" id="567490">connectionClose</span><span class="op" id="567505">,</span>&nbsp;<span class="ident" id="567507">n</span><span class="op" id="567508">,</span>&nbsp;<span class="ident" id="567510">err</span><span class="op" id="567513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="567518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567523">return</span>&nbsp;<span class="builtintype" id="567530">string</span><span class="op" id="567536">(</span><span class="ident" id="567537">body</span><span class="op" id="567541">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="567545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567550">body1</span>&nbsp;<span class="op" id="567556">:=</span>&nbsp;<span class="ident" id="567559">fetch</span><span class="op" id="567564">(</span><span class="num" id="567565">1</span><span class="op" id="567566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567570">body2</span>&nbsp;<span class="op" id="567576">:=</span>&nbsp;<span class="ident" id="567579">fetch</span><span class="op" id="567584">(</span><span class="num" id="567585">2</span><span class="op" id="567586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567590">bodiesDiffer</span>&nbsp;<span class="op" id="567603">:=</span>&nbsp;<span class="ident" id="567606">body1</span>&nbsp;<span class="op" id="567612">!=</span>&nbsp;<span class="ident" id="567615">body2</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567623">if</span>&nbsp;<span class="ident" id="567626">bodiesDiffer</span>&nbsp;<span class="op" id="567639">!=</span>&nbsp;<span class="ident" id="567642">connectionClose</span>&nbsp;<span class="op" id="567658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567663">t</span><span class="op" id="567664">.</span><span class="ident" id="567665">Errorf</span><span class="op" id="567671">(</span><span class="string" id="567672">&#34;error&nbsp;in&nbsp;connectionClose=%v.&nbsp;unexpected&nbsp;bodiesDiffer=%v;&nbsp;body1=%q;&nbsp;body2=%q&#34;</span><span class="op" id="567749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567755">connectionClose</span><span class="op" id="567770">,</span>&nbsp;<span class="ident" id="567772">bodiesDiffer</span><span class="op" id="567784">,</span>&nbsp;<span class="ident" id="567786">body1</span><span class="op" id="567791">,</span>&nbsp;<span class="ident" id="567793">body2</span><span class="op" id="567798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="567802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567807">tr</span><span class="op" id="567809">.</span><span class="ident" id="567810">CloseIdleConnections</span><span class="op" id="567830">(</span><span class="op" id="567831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="567834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567838">connSet</span><span class="op" id="567845">.</span><span class="ident" id="567846">check</span><span class="op" id="567851">(</span><span class="ident" id="567852">t</span><span class="op" id="567853">)</span><br>
<span class="lineno"></span><span class="op" id="567855">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="567858">func</span>&nbsp;<span class="ident" id="567863">TestTransportConnectionCloseOnRequest</span><span class="op" id="567900">(</span><span class="ident" id="567901">t</span>&nbsp;<span class="op" id="567903">*</span><span class="ident" id="567904">testing</span><span class="op" id="567911">.</span><span class="ident" id="567912">T</span><span class="op" id="567913">)</span>&nbsp;<span class="op" id="567915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567918">defer</span>&nbsp;<span class="ident" id="567924">afterTest</span><span class="op" id="567933">(</span><span class="ident" id="567934">t</span><span class="op" id="567935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="567938">ts</span>&nbsp;<span class="op" id="567941">:=</span>&nbsp;<span class="ident" id="567944">httptest</span><span class="op" id="567952">.</span><span class="ident" id="567953">NewServer</span><span class="op" id="567962">(</span><span class="ident" id="567963">hostPortHandler</span><span class="op" id="567978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="567981">defer</span>&nbsp;<span class="ident" id="567987">ts</span><span class="op" id="567989">.</span><span class="ident" id="567990">Close</span><span class="op" id="567995">(</span><span class="op" id="567996">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568000">connSet</span><span class="op" id="568007">,</span>&nbsp;<span class="ident" id="568009">testDial</span>&nbsp;<span class="op" id="568018">:=</span>&nbsp;<span class="ident" id="568021">makeTestDial</span><span class="op" id="568033">(</span><span class="ident" id="568034">t</span><span class="op" id="568035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568039">for</span>&nbsp;<span class="ident" id="568043">_</span><span class="op" id="568044">,</span>&nbsp;<span class="ident" id="568046">connectionClose</span>&nbsp;<span class="op" id="568062">:=</span>&nbsp;<span class="keyword" id="568065">range</span>&nbsp;<span class="op" id="568071">[</span><span class="op" id="568072">]</span><span class="builtintype" id="568073">bool</span><span class="op" id="568077">{</span><span class="builtintype" id="568078">false</span><span class="op" id="568083">,</span>&nbsp;<span class="builtintype" id="568085">true</span><span class="op" id="568089">}</span>&nbsp;<span class="op" id="568091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568095">tr</span>&nbsp;<span class="op" id="568098">:=</span>&nbsp;<span class="op" id="568101">&amp;</span><span class="ident" id="568102">Transport</span><span class="op" id="568111">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568116">Dial</span><span class="op" id="568120">:</span>&nbsp;<span class="ident" id="568122">testDial</span><span class="op" id="568130">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="568134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568138">c</span>&nbsp;<span class="op" id="568140">:=</span>&nbsp;<span class="op" id="568143">&amp;</span><span class="ident" id="568144">Client</span><span class="op" id="568150">{</span><span class="ident" id="568151">Transport</span><span class="op" id="568160">:</span>&nbsp;<span class="ident" id="568162">tr</span><span class="op" id="568164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568169">fetch</span>&nbsp;<span class="op" id="568175">:=</span>&nbsp;<span class="keyword" id="568178">func</span><span class="op" id="568182">(</span><span class="ident" id="568183">n</span>&nbsp;<span class="builtintype" id="568185">int</span><span class="op" id="568188">)</span>&nbsp;<span class="builtintype" id="568190">string</span>&nbsp;<span class="op" id="568197">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568202">req</span>&nbsp;<span class="op" id="568206">:=</span>&nbsp;<span class="builtinfunc" id="568209">new</span><span class="op" id="568212">(</span><span class="ident" id="568213">Request</span><span class="op" id="568220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568225">var</span>&nbsp;<span class="ident" id="568229">err</span>&nbsp;<span class="builtintype" id="568233">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568242">req</span><span class="op" id="568245">.</span><span class="ident" id="568246">URL</span><span class="op" id="568249">,</span>&nbsp;<span class="ident" id="568251">err</span>&nbsp;<span class="op" id="568255">=</span>&nbsp;<span class="ident" id="568257">url</span><span class="op" id="568260">.</span><span class="ident" id="568261">Parse</span><span class="op" id="568266">(</span><span class="ident" id="568267">ts</span><span class="op" id="568269">.</span><span class="ident" id="568270">URL</span><span class="op" id="568273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568278">if</span>&nbsp;<span class="ident" id="568281">err</span>&nbsp;<span class="op" id="568285">!=</span>&nbsp;<span class="ident" id="568288">nil</span>&nbsp;<span class="op" id="568292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568298">t</span><span class="op" id="568299">.</span><span class="ident" id="568300">Fatalf</span><span class="op" id="568306">(</span><span class="string" id="568307">&#34;URL&nbsp;parse&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="568328">,</span>&nbsp;<span class="ident" id="568330">err</span><span class="op" id="568333">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="568338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568343">req</span><span class="op" id="568346">.</span><span class="ident" id="568347">Method</span>&nbsp;<span class="op" id="568354">=</span>&nbsp;<span class="string" id="568356">&#34;GET&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568365">req</span><span class="op" id="568368">.</span><span class="ident" id="568369">Proto</span>&nbsp;<span class="op" id="568375">=</span>&nbsp;<span class="string" id="568377">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568391">req</span><span class="op" id="568394">.</span><span class="ident" id="568395">ProtoMajor</span>&nbsp;<span class="op" id="568406">=</span>&nbsp;<span class="num" id="568408">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568413">req</span><span class="op" id="568416">.</span><span class="ident" id="568417">ProtoMinor</span>&nbsp;<span class="op" id="568428">=</span>&nbsp;<span class="num" id="568430">1</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568435">req</span><span class="op" id="568438">.</span><span class="ident" id="568439">Close</span>&nbsp;<span class="op" id="568445">=</span>&nbsp;<span class="ident" id="568447">connectionClose</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568467">res</span><span class="op" id="568470">,</span>&nbsp;<span class="ident" id="568472">err</span>&nbsp;<span class="op" id="568476">:=</span>&nbsp;<span class="ident" id="568479">c</span><span class="op" id="568480">.</span><span class="ident" id="568481">Do</span><span class="op" id="568483">(</span><span class="ident" id="568484">req</span><span class="op" id="568487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568492">if</span>&nbsp;<span class="ident" id="568495">err</span>&nbsp;<span class="op" id="568499">!=</span>&nbsp;<span class="ident" id="568502">nil</span>&nbsp;<span class="op" id="568506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568512">t</span><span class="op" id="568513">.</span><span class="ident" id="568514">Fatalf</span><span class="op" id="568520">(</span><span class="string" id="568521">&#34;error&nbsp;in&nbsp;connectionClose=%v,&nbsp;req&nbsp;#%d,&nbsp;Do:&nbsp;%v&#34;</span><span class="op" id="568567">,</span>&nbsp;<span class="ident" id="568569">connectionClose</span><span class="op" id="568584">,</span>&nbsp;<span class="ident" id="568586">n</span><span class="op" id="568587">,</span>&nbsp;<span class="ident" id="568589">err</span><span class="op" id="568592">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="568597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568602">body</span><span class="op" id="568606">,</span>&nbsp;<span class="ident" id="568608">err</span>&nbsp;<span class="op" id="568612">:=</span>&nbsp;<span class="ident" id="568615">ioutil</span><span class="op" id="568621">.</span><span class="ident" id="568622">ReadAll</span><span class="op" id="568629">(</span><span class="ident" id="568630">res</span><span class="op" id="568633">.</span><span class="ident" id="568634">Body</span><span class="op" id="568638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568643">if</span>&nbsp;<span class="ident" id="568646">err</span>&nbsp;<span class="op" id="568650">!=</span>&nbsp;<span class="ident" id="568653">nil</span>&nbsp;<span class="op" id="568657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568663">t</span><span class="op" id="568664">.</span><span class="ident" id="568665">Fatalf</span><span class="op" id="568671">(</span><span class="string" id="568672">&#34;error&nbsp;in&nbsp;connectionClose=%v,&nbsp;req&nbsp;#%d,&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="568723">,</span>&nbsp;<span class="ident" id="568725">connectionClose</span><span class="op" id="568740">,</span>&nbsp;<span class="ident" id="568742">n</span><span class="op" id="568743">,</span>&nbsp;<span class="ident" id="568745">err</span><span class="op" id="568748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="568753">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568758">return</span>&nbsp;<span class="builtintype" id="568765">string</span><span class="op" id="568771">(</span><span class="ident" id="568772">body</span><span class="op" id="568776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="568780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568785">body1</span>&nbsp;<span class="op" id="568791">:=</span>&nbsp;<span class="ident" id="568794">fetch</span><span class="op" id="568799">(</span><span class="num" id="568800">1</span><span class="op" id="568801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568805">body2</span>&nbsp;<span class="op" id="568811">:=</span>&nbsp;<span class="ident" id="568814">fetch</span><span class="op" id="568819">(</span><span class="num" id="568820">2</span><span class="op" id="568821">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568825">bodiesDiffer</span>&nbsp;<span class="op" id="568838">:=</span>&nbsp;<span class="ident" id="568841">body1</span>&nbsp;<span class="op" id="568847">!=</span>&nbsp;<span class="ident" id="568850">body2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="568858">if</span>&nbsp;<span class="ident" id="568861">bodiesDiffer</span>&nbsp;<span class="op" id="568874">!=</span>&nbsp;<span class="ident" id="568877">connectionClose</span>&nbsp;<span class="op" id="568893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568898">t</span><span class="op" id="568899">.</span><span class="ident" id="568900">Errorf</span><span class="op" id="568906">(</span><span class="string" id="568907">&#34;error&nbsp;in&nbsp;connectionClose=%v.&nbsp;unexpected&nbsp;bodiesDiffer=%v;&nbsp;body1=%q;&nbsp;body2=%q&#34;</span><span class="op" id="568984">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="568990">connectionClose</span><span class="op" id="569005">,</span>&nbsp;<span class="ident" id="569007">bodiesDiffer</span><span class="op" id="569019">,</span>&nbsp;<span class="ident" id="569021">body1</span><span class="op" id="569026">,</span>&nbsp;<span class="ident" id="569028">body2</span><span class="op" id="569033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569037">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569042">tr</span><span class="op" id="569044">.</span><span class="ident" id="569045">CloseIdleConnections</span><span class="op" id="569065">(</span><span class="op" id="569066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569073">connSet</span><span class="op" id="569080">.</span><span class="ident" id="569081">check</span><span class="op" id="569086">(</span><span class="ident" id="569087">t</span><span class="op" id="569088">)</span><br>
<span class="lineno">250</span><span class="op" id="569090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="569093">func</span>&nbsp;<span class="ident" id="569098">TestTransportIdleCacheKeys</span><span class="op" id="569124">(</span><span class="ident" id="569125">t</span>&nbsp;<span class="op" id="569127">*</span><span class="ident" id="569128">testing</span><span class="op" id="569135">.</span><span class="ident" id="569136">T</span><span class="op" id="569137">)</span>&nbsp;<span class="op" id="569139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569142">defer</span>&nbsp;<span class="ident" id="569148">afterTest</span><span class="op" id="569157">(</span><span class="ident" id="569158">t</span><span class="op" id="569159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569162">ts</span>&nbsp;<span class="op" id="569165">:=</span>&nbsp;<span class="ident" id="569168">httptest</span><span class="op" id="569176">.</span><span class="ident" id="569177">NewServer</span><span class="op" id="569186">(</span><span class="ident" id="569187">hostPortHandler</span><span class="op" id="569202">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569205">defer</span>&nbsp;<span class="ident" id="569211">ts</span><span class="op" id="569213">.</span><span class="ident" id="569214">Close</span><span class="op" id="569219">(</span><span class="op" id="569220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569224">tr</span>&nbsp;<span class="op" id="569227">:=</span>&nbsp;<span class="op" id="569230">&amp;</span><span class="ident" id="569231">Transport</span><span class="op" id="569240">{</span><span class="ident" id="569241">DisableKeepAlives</span><span class="op" id="569258">:</span>&nbsp;<span class="builtintype" id="569260">false</span><span class="op" id="569265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569268">c</span>&nbsp;<span class="op" id="569270">:=</span>&nbsp;<span class="op" id="569273">&amp;</span><span class="ident" id="569274">Client</span><span class="op" id="569280">{</span><span class="ident" id="569281">Transport</span><span class="op" id="569290">:</span>&nbsp;<span class="ident" id="569292">tr</span><span class="op" id="569294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569298">if</span>&nbsp;<span class="ident" id="569301">e</span><span class="op" id="569302">,</span>&nbsp;<span class="ident" id="569304">g</span>&nbsp;<span class="op" id="569306">:=</span>&nbsp;<span class="num" id="569309">0</span><span class="op" id="569310">,</span>&nbsp;<span class="builtinfunc" id="569312">len</span><span class="op" id="569315">(</span><span class="ident" id="569316">tr</span><span class="op" id="569318">.</span><span class="ident" id="569319">IdleConnKeysForTesting</span><span class="op" id="569341">(</span><span class="op" id="569342">)</span><span class="op" id="569343">)</span><span class="op" id="569344">;</span>&nbsp;<span class="ident" id="569346">e</span>&nbsp;<span class="op" id="569348">!=</span>&nbsp;<span class="ident" id="569351">g</span>&nbsp;<span class="op" id="569353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569357">t</span><span class="op" id="569358">.</span><span class="ident" id="569359">Errorf</span><span class="op" id="569365">(</span><span class="string" id="569366">&#34;After&nbsp;CloseIdleConnections&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conn&nbsp;cache&nbsp;keys;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="569435">,</span>&nbsp;<span class="ident" id="569437">e</span><span class="op" id="569438">,</span>&nbsp;<span class="ident" id="569440">g</span><span class="op" id="569441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569448">resp</span><span class="op" id="569452">,</span>&nbsp;<span class="ident" id="569454">err</span>&nbsp;<span class="op" id="569458">:=</span>&nbsp;<span class="ident" id="569461">c</span><span class="op" id="569462">.</span><span class="ident" id="569463">Get</span><span class="op" id="569466">(</span><span class="ident" id="569467">ts</span><span class="op" id="569469">.</span><span class="ident" id="569470">URL</span><span class="op" id="569473">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569476">if</span>&nbsp;<span class="ident" id="569479">err</span>&nbsp;<span class="op" id="569483">!=</span>&nbsp;<span class="ident" id="569486">nil</span>&nbsp;<span class="op" id="569490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569494">t</span><span class="op" id="569495">.</span><span class="ident" id="569496">Error</span><span class="op" id="569501">(</span><span class="ident" id="569502">err</span><span class="op" id="569505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569511">ioutil</span><span class="op" id="569517">.</span><span class="ident" id="569518">ReadAll</span><span class="op" id="569525">(</span><span class="ident" id="569526">resp</span><span class="op" id="569530">.</span><span class="ident" id="569531">Body</span><span class="op" id="569535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569539">keys</span>&nbsp;<span class="op" id="569544">:=</span>&nbsp;<span class="ident" id="569547">tr</span><span class="op" id="569549">.</span><span class="ident" id="569550">IdleConnKeysForTesting</span><span class="op" id="569572">(</span><span class="op" id="569573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569576">if</span>&nbsp;<span class="ident" id="569579">e</span><span class="op" id="569580">,</span>&nbsp;<span class="ident" id="569582">g</span>&nbsp;<span class="op" id="569584">:=</span>&nbsp;<span class="num" id="569587">1</span><span class="op" id="569588">,</span>&nbsp;<span class="builtinfunc" id="569590">len</span><span class="op" id="569593">(</span><span class="ident" id="569594">keys</span><span class="op" id="569598">)</span><span class="op" id="569599">;</span>&nbsp;<span class="ident" id="569601">e</span>&nbsp;<span class="op" id="569603">!=</span>&nbsp;<span class="ident" id="569606">g</span>&nbsp;<span class="op" id="569608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569612">t</span><span class="op" id="569613">.</span><span class="ident" id="569614">Fatalf</span><span class="op" id="569620">(</span><span class="string" id="569621">&#34;After&nbsp;Get&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conn&nbsp;cache&nbsp;keys;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="569673">,</span>&nbsp;<span class="ident" id="569675">e</span><span class="op" id="569676">,</span>&nbsp;<span class="ident" id="569678">g</span><span class="op" id="569679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569686">if</span>&nbsp;<span class="ident" id="569689">e</span>&nbsp;<span class="op" id="569691">:=</span>&nbsp;<span class="string" id="569694">&#34;|http|&#34;</span>&nbsp;<span class="op" id="569703">+</span>&nbsp;<span class="ident" id="569705">ts</span><span class="op" id="569707">.</span><span class="ident" id="569708">Listener</span><span class="op" id="569716">.</span><span class="ident" id="569717">Addr</span><span class="op" id="569721">(</span><span class="op" id="569722">)</span><span class="op" id="569723">.</span><span class="ident" id="569724">String</span><span class="op" id="569730">(</span><span class="op" id="569731">)</span><span class="op" id="569732">;</span>&nbsp;<span class="ident" id="569734">keys</span><span class="op" id="569738">[</span><span class="num" id="569739">0</span><span class="op" id="569740">]</span>&nbsp;<span class="op" id="569742">!=</span>&nbsp;<span class="ident" id="569745">e</span>&nbsp;<span class="op" id="569747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569751">t</span><span class="op" id="569752">.</span><span class="ident" id="569753">Errorf</span><span class="op" id="569759">(</span><span class="string" id="569760">&#34;Expected&nbsp;idle&nbsp;cache&nbsp;key&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="569796">,</span>&nbsp;<span class="ident" id="569798">e</span><span class="op" id="569799">,</span>&nbsp;<span class="ident" id="569801">keys</span><span class="op" id="569805">[</span><span class="num" id="569806">0</span><span class="op" id="569807">]</span><span class="op" id="569808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569815">tr</span><span class="op" id="569817">.</span><span class="ident" id="569818">CloseIdleConnections</span><span class="op" id="569838">(</span><span class="op" id="569839">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="569842">if</span>&nbsp;<span class="ident" id="569845">e</span><span class="op" id="569846">,</span>&nbsp;<span class="ident" id="569848">g</span>&nbsp;<span class="op" id="569850">:=</span>&nbsp;<span class="num" id="569853">0</span><span class="op" id="569854">,</span>&nbsp;<span class="builtinfunc" id="569856">len</span><span class="op" id="569859">(</span><span class="ident" id="569860">tr</span><span class="op" id="569862">.</span><span class="ident" id="569863">IdleConnKeysForTesting</span><span class="op" id="569885">(</span><span class="op" id="569886">)</span><span class="op" id="569887">)</span><span class="op" id="569888">;</span>&nbsp;<span class="ident" id="569890">e</span>&nbsp;<span class="op" id="569892">!=</span>&nbsp;<span class="ident" id="569895">g</span>&nbsp;<span class="op" id="569897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="569901">t</span><span class="op" id="569902">.</span><span class="ident" id="569903">Errorf</span><span class="op" id="569909">(</span><span class="string" id="569910">&#34;After&nbsp;CloseIdleConnections&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conn&nbsp;cache&nbsp;keys;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="569979">,</span>&nbsp;<span class="ident" id="569981">e</span><span class="op" id="569982">,</span>&nbsp;<span class="ident" id="569984">g</span><span class="op" id="569985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="569988">}</span><br>
<span class="lineno"></span><span class="op" id="569990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="569993">//&nbsp;Tests&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;re-uses&nbsp;connections&nbsp;when&nbsp;a&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="570060">//&nbsp;reads&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;response&nbsp;Body&nbsp;without&nbsp;closing&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="570119">func</span>&nbsp;<span class="ident" id="570124">TestTransportReadToEndReusesConn</span><span class="op" id="570156">(</span><span class="ident" id="570157">t</span>&nbsp;<span class="op" id="570159">*</span><span class="ident" id="570160">testing</span><span class="op" id="570167">.</span><span class="ident" id="570168">T</span><span class="op" id="570169">)</span>&nbsp;<span class="op" id="570171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570174">defer</span>&nbsp;<span class="ident" id="570180">afterTest</span><span class="op" id="570189">(</span><span class="ident" id="570190">t</span><span class="op" id="570191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570194">const</span>&nbsp;<span class="ident" id="570200">msg</span>&nbsp;<span class="op" id="570204">=</span>&nbsp;<span class="string" id="570206">&#34;foobar&#34;</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570217">var</span>&nbsp;<span class="ident" id="570221">addrSeen</span>&nbsp;<span class="keyword" id="570230">map</span><span class="op" id="570233">[</span><span class="builtintype" id="570234">string</span><span class="op" id="570240">]</span><span class="builtintype" id="570241">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570246">ts</span>&nbsp;<span class="op" id="570249">:=</span>&nbsp;<span class="ident" id="570252">httptest</span><span class="op" id="570260">.</span><span class="ident" id="570261">NewServer</span><span class="op" id="570270">(</span><span class="ident" id="570271">HandlerFunc</span><span class="op" id="570282">(</span><span class="keyword" id="570283">func</span><span class="op" id="570287">(</span><span class="ident" id="570288">w</span>&nbsp;<span class="ident" id="570290">ResponseWriter</span><span class="op" id="570304">,</span>&nbsp;<span class="ident" id="570306">r</span>&nbsp;<span class="op" id="570308">*</span><span class="ident" id="570309">Request</span><span class="op" id="570316">)</span>&nbsp;<span class="op" id="570318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570322">addrSeen</span><span class="op" id="570330">[</span><span class="ident" id="570331">r</span><span class="op" id="570332">.</span><span class="ident" id="570333">RemoteAddr</span><span class="op" id="570343">]</span><span class="op" id="570344">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570349">if</span>&nbsp;<span class="ident" id="570352">r</span><span class="op" id="570353">.</span><span class="ident" id="570354">URL</span><span class="op" id="570357">.</span><span class="ident" id="570358">Path</span>&nbsp;<span class="op" id="570363">==</span>&nbsp;<span class="string" id="570366">&#34;/chunked/&#34;</span>&nbsp;<span class="op" id="570378">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570383">w</span><span class="op" id="570384">.</span><span class="ident" id="570385">WriteHeader</span><span class="op" id="570396">(</span><span class="num" id="570397">200</span><span class="op" id="570400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570405">w</span><span class="op" id="570406">.</span><span class="op" id="570407">(</span><span class="ident" id="570408">http</span><span class="op" id="570412">.</span><span class="ident" id="570413">Flusher</span><span class="op" id="570420">)</span><span class="op" id="570421">.</span><span class="ident" id="570422">Flush</span><span class="op" id="570427">(</span><span class="op" id="570428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="570432">}</span>&nbsp;<span class="keyword" id="570434">else</span>&nbsp;<span class="op" id="570439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570444">w</span><span class="op" id="570445">.</span><span class="ident" id="570446">Header</span><span class="op" id="570452">(</span><span class="op" id="570453">)</span><span class="op" id="570454">.</span><span class="ident" id="570455">Set</span><span class="op" id="570458">(</span><span class="string" id="570459">&#34;Content-Type&#34;</span><span class="op" id="570473">,</span>&nbsp;<span class="ident" id="570475">strconv</span><span class="op" id="570482">.</span><span class="ident" id="570483">Itoa</span><span class="op" id="570487">(</span><span class="builtinfunc" id="570488">len</span><span class="op" id="570491">(</span><span class="ident" id="570492">msg</span><span class="op" id="570495">)</span><span class="op" id="570496">)</span><span class="op" id="570497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570502">w</span><span class="op" id="570503">.</span><span class="ident" id="570504">WriteHeader</span><span class="op" id="570515">(</span><span class="num" id="570516">200</span><span class="op" id="570519">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="570523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570527">w</span><span class="op" id="570528">.</span><span class="ident" id="570529">Write</span><span class="op" id="570534">(</span><span class="op" id="570535">[</span><span class="op" id="570536">]</span><span class="builtintype" id="570537">byte</span><span class="op" id="570541">(</span><span class="ident" id="570542">msg</span><span class="op" id="570545">)</span><span class="op" id="570546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="570549">}</span><span class="op" id="570550">)</span><span class="op" id="570551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570554">defer</span>&nbsp;<span class="ident" id="570560">ts</span><span class="op" id="570562">.</span><span class="ident" id="570563">Close</span><span class="op" id="570568">(</span><span class="op" id="570569">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570573">buf</span>&nbsp;<span class="op" id="570577">:=</span>&nbsp;<span class="builtinfunc" id="570580">make</span><span class="op" id="570584">(</span><span class="op" id="570585">[</span><span class="op" id="570586">]</span><span class="builtintype" id="570587">byte</span><span class="op" id="570591">,</span>&nbsp;<span class="builtinfunc" id="570593">len</span><span class="op" id="570596">(</span><span class="ident" id="570597">msg</span><span class="op" id="570600">)</span><span class="op" id="570601">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570605">for</span>&nbsp;<span class="ident" id="570609">pi</span><span class="op" id="570611">,</span>&nbsp;<span class="ident" id="570613">path</span>&nbsp;<span class="op" id="570618">:=</span>&nbsp;<span class="keyword" id="570621">range</span>&nbsp;<span class="op" id="570627">[</span><span class="op" id="570628">]</span><span class="builtintype" id="570629">string</span><span class="op" id="570635">{</span><span class="string" id="570636">&#34;/content-length/&#34;</span><span class="op" id="570654">,</span>&nbsp;<span class="string" id="570656">&#34;/chunked/&#34;</span><span class="op" id="570667">}</span>&nbsp;<span class="op" id="570669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570673">wantLen</span>&nbsp;<span class="op" id="570681">:=</span>&nbsp;<span class="op" id="570684">[</span><span class="op" id="570685">]</span><span class="builtintype" id="570686">int</span><span class="op" id="570689">{</span><span class="builtinfunc" id="570690">len</span><span class="op" id="570693">(</span><span class="ident" id="570694">msg</span><span class="op" id="570697">)</span><span class="op" id="570698">,</span>&nbsp;<span class="op" id="570700">-</span><span class="num" id="570701">1</span><span class="op" id="570702">}</span><span class="op" id="570703">[</span><span class="ident" id="570704">pi</span><span class="op" id="570706">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570710">addrSeen</span>&nbsp;<span class="op" id="570719">=</span>&nbsp;<span class="builtinfunc" id="570721">make</span><span class="op" id="570725">(</span><span class="keyword" id="570726">map</span><span class="op" id="570729">[</span><span class="builtintype" id="570730">string</span><span class="op" id="570736">]</span><span class="builtintype" id="570737">int</span><span class="op" id="570740">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570744">for</span>&nbsp;<span class="ident" id="570748">i</span>&nbsp;<span class="op" id="570750">:=</span>&nbsp;<span class="num" id="570753">0</span><span class="op" id="570754">;</span>&nbsp;<span class="ident" id="570756">i</span>&nbsp;<span class="op" id="570758">&lt;</span>&nbsp;<span class="num" id="570760">3</span><span class="op" id="570761">;</span>&nbsp;<span class="ident" id="570763">i</span><span class="op" id="570764">++</span>&nbsp;<span class="op" id="570767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570772">res</span><span class="op" id="570775">,</span>&nbsp;<span class="ident" id="570777">err</span>&nbsp;<span class="op" id="570781">:=</span>&nbsp;<span class="ident" id="570784">http</span><span class="op" id="570788">.</span><span class="ident" id="570789">Get</span><span class="op" id="570792">(</span><span class="ident" id="570793">ts</span><span class="op" id="570795">.</span><span class="ident" id="570796">URL</span>&nbsp;<span class="op" id="570800">+</span>&nbsp;<span class="ident" id="570802">path</span><span class="op" id="570806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570811">if</span>&nbsp;<span class="ident" id="570814">err</span>&nbsp;<span class="op" id="570818">!=</span>&nbsp;<span class="ident" id="570821">nil</span>&nbsp;<span class="op" id="570825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="570831">t</span><span class="op" id="570832">.</span><span class="ident" id="570833">Errorf</span><span class="op" id="570839">(</span><span class="string" id="570840">&#34;Get&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="570852">,</span>&nbsp;<span class="ident" id="570854">path</span><span class="op" id="570858">,</span>&nbsp;<span class="ident" id="570860">err</span><span class="op" id="570863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="570869">continue</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="570881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="570886">//&nbsp;We&nbsp;want&nbsp;to&nbsp;close&nbsp;this&nbsp;body&nbsp;eventually&nbsp;(before&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="570942">//&nbsp;defer&nbsp;afterTest&nbsp;at&nbsp;top&nbsp;runs),&nbsp;but&nbsp;not&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="570997">//&nbsp;len(addrSeen)&nbsp;check&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;this&nbsp;test,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="571051">//&nbsp;since&nbsp;Closing&nbsp;this&nbsp;early&nbsp;in&nbsp;the&nbsp;loop&nbsp;would&nbsp;risk</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="571105">//&nbsp;making&nbsp;connections&nbsp;be&nbsp;re-used&nbsp;for&nbsp;the&nbsp;wrong&nbsp;reason.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571163">defer</span>&nbsp;<span class="ident" id="571169">res</span><span class="op" id="571172">.</span><span class="ident" id="571173">Body</span><span class="op" id="571177">.</span><span class="ident" id="571178">Close</span><span class="op" id="571183">(</span><span class="op" id="571184">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571190">if</span>&nbsp;<span class="ident" id="571193">res</span><span class="op" id="571196">.</span><span class="ident" id="571197">ContentLength</span>&nbsp;<span class="op" id="571211">!=</span>&nbsp;<span class="ident" id="571214">int64</span><span class="op" id="571219">(</span><span class="ident" id="571220">wantLen</span><span class="op" id="571227">)</span>&nbsp;<span class="op" id="571229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571235">t</span><span class="op" id="571236">.</span><span class="ident" id="571237">Errorf</span><span class="op" id="571243">(</span><span class="string" id="571244">&#34;%s&nbsp;res.ContentLength&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="571280">,</span>&nbsp;<span class="ident" id="571282">path</span><span class="op" id="571286">,</span>&nbsp;<span class="ident" id="571288">res</span><span class="op" id="571291">.</span><span class="ident" id="571292">ContentLength</span><span class="op" id="571305">,</span>&nbsp;<span class="ident" id="571307">wantLen</span><span class="op" id="571314">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571324">n</span><span class="op" id="571325">,</span>&nbsp;<span class="ident" id="571327">err</span>&nbsp;<span class="op" id="571331">:=</span>&nbsp;<span class="ident" id="571334">res</span><span class="op" id="571337">.</span><span class="ident" id="571338">Body</span><span class="op" id="571342">.</span><span class="ident" id="571343">Read</span><span class="op" id="571347">(</span><span class="ident" id="571348">buf</span><span class="op" id="571351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571356">if</span>&nbsp;<span class="ident" id="571359">n</span>&nbsp;<span class="op" id="571361">!=</span>&nbsp;<span class="builtinfunc" id="571364">len</span><span class="op" id="571367">(</span><span class="ident" id="571368">msg</span><span class="op" id="571371">)</span>&nbsp;<span class="op" id="571373">||</span>&nbsp;<span class="ident" id="571376">err</span>&nbsp;<span class="op" id="571380">!=</span>&nbsp;<span class="ident" id="571383">io</span><span class="op" id="571385">.</span><span class="ident" id="571386">EOF</span>&nbsp;<span class="op" id="571390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571396">t</span><span class="op" id="571397">.</span><span class="ident" id="571398">Errorf</span><span class="op" id="571404">(</span><span class="string" id="571405">&#34;%s&nbsp;Read&nbsp;=&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="571437">,</span>&nbsp;<span class="ident" id="571439">path</span><span class="op" id="571443">,</span>&nbsp;<span class="ident" id="571445">n</span><span class="op" id="571446">,</span>&nbsp;<span class="ident" id="571448">err</span><span class="op" id="571451">,</span>&nbsp;<span class="builtinfunc" id="571453">len</span><span class="op" id="571456">(</span><span class="ident" id="571457">msg</span><span class="op" id="571460">)</span><span class="op" id="571461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571466">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571474">if</span>&nbsp;<span class="builtinfunc" id="571477">len</span><span class="op" id="571480">(</span><span class="ident" id="571481">addrSeen</span><span class="op" id="571489">)</span>&nbsp;<span class="op" id="571491">!=</span>&nbsp;<span class="num" id="571494">1</span>&nbsp;<span class="op" id="571496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571501">t</span><span class="op" id="571502">.</span><span class="ident" id="571503">Errorf</span><span class="op" id="571509">(</span><span class="string" id="571510">&#34;for&nbsp;%s,&nbsp;server&nbsp;saw&nbsp;%d&nbsp;distinct&nbsp;client&nbsp;addresses;&nbsp;want&nbsp;1&#34;</span><span class="op" id="571567">,</span>&nbsp;<span class="ident" id="571569">path</span><span class="op" id="571573">,</span>&nbsp;<span class="builtinfunc" id="571575">len</span><span class="op" id="571578">(</span><span class="ident" id="571579">addrSeen</span><span class="op" id="571587">)</span><span class="op" id="571588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571595">}</span><br>
<span class="lineno">335</span><span class="op" id="571597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="571600">func</span>&nbsp;<span class="ident" id="571605">TestTransportMaxPerHostIdleConns</span><span class="op" id="571637">(</span><span class="ident" id="571638">t</span>&nbsp;<span class="op" id="571640">*</span><span class="ident" id="571641">testing</span><span class="op" id="571648">.</span><span class="ident" id="571649">T</span><span class="op" id="571650">)</span>&nbsp;<span class="op" id="571652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571655">defer</span>&nbsp;<span class="ident" id="571661">afterTest</span><span class="op" id="571670">(</span><span class="ident" id="571671">t</span><span class="op" id="571672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571675">resch</span>&nbsp;<span class="op" id="571681">:=</span>&nbsp;<span class="builtinfunc" id="571684">make</span><span class="op" id="571688">(</span><span class="keyword" id="571689">chan</span>&nbsp;<span class="builtintype" id="571694">string</span><span class="op" id="571700">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571703">gotReq</span>&nbsp;<span class="op" id="571710">:=</span>&nbsp;<span class="builtinfunc" id="571713">make</span><span class="op" id="571717">(</span><span class="keyword" id="571718">chan</span>&nbsp;<span class="builtintype" id="571723">bool</span><span class="op" id="571727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571730">ts</span>&nbsp;<span class="op" id="571733">:=</span>&nbsp;<span class="ident" id="571736">httptest</span><span class="op" id="571744">.</span><span class="ident" id="571745">NewServer</span><span class="op" id="571754">(</span><span class="ident" id="571755">HandlerFunc</span><span class="op" id="571766">(</span><span class="keyword" id="571767">func</span><span class="op" id="571771">(</span><span class="ident" id="571772">w</span>&nbsp;<span class="ident" id="571774">ResponseWriter</span><span class="op" id="571788">,</span>&nbsp;<span class="ident" id="571790">r</span>&nbsp;<span class="op" id="571792">*</span><span class="ident" id="571793">Request</span><span class="op" id="571800">)</span>&nbsp;<span class="op" id="571802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571806">gotReq</span>&nbsp;<span class="op" id="571813">&lt;-</span>&nbsp;<span class="builtintype" id="571816">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571823">msg</span>&nbsp;<span class="op" id="571827">:=</span>&nbsp;<span class="op" id="571830">&lt;-</span><span class="ident" id="571832">resch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571840">_</span><span class="op" id="571841">,</span>&nbsp;<span class="ident" id="571843">err</span>&nbsp;<span class="op" id="571847">:=</span>&nbsp;<span class="ident" id="571850">w</span><span class="op" id="571851">.</span><span class="ident" id="571852">Write</span><span class="op" id="571857">(</span><span class="op" id="571858">[</span><span class="op" id="571859">]</span><span class="builtintype" id="571860">byte</span><span class="op" id="571864">(</span><span class="ident" id="571865">msg</span><span class="op" id="571868">)</span><span class="op" id="571869">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571873">if</span>&nbsp;<span class="ident" id="571876">err</span>&nbsp;<span class="op" id="571880">!=</span>&nbsp;<span class="ident" id="571883">nil</span>&nbsp;<span class="op" id="571887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571892">t</span><span class="op" id="571893">.</span><span class="ident" id="571894">Fatalf</span><span class="op" id="571900">(</span><span class="string" id="571901">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="571912">,</span>&nbsp;<span class="ident" id="571914">err</span><span class="op" id="571917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="571924">}</span><span class="op" id="571925">)</span><span class="op" id="571926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="571929">defer</span>&nbsp;<span class="ident" id="571935">ts</span><span class="op" id="571937">.</span><span class="ident" id="571938">Close</span><span class="op" id="571943">(</span><span class="op" id="571944">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571947">maxIdleConns</span>&nbsp;<span class="op" id="571960">:=</span>&nbsp;<span class="num" id="571963">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="571966">tr</span>&nbsp;<span class="op" id="571969">:=</span>&nbsp;<span class="op" id="571972">&amp;</span><span class="ident" id="571973">Transport</span><span class="op" id="571982">{</span><span class="ident" id="571983">DisableKeepAlives</span><span class="op" id="572000">:</span>&nbsp;<span class="builtintype" id="572002">false</span><span class="op" id="572007">,</span>&nbsp;<span class="ident" id="572009">MaxIdleConnsPerHost</span><span class="op" id="572028">:</span>&nbsp;<span class="ident" id="572030">maxIdleConns</span><span class="op" id="572042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572045">c</span>&nbsp;<span class="op" id="572047">:=</span>&nbsp;<span class="op" id="572050">&amp;</span><span class="ident" id="572051">Client</span><span class="op" id="572057">{</span><span class="ident" id="572058">Transport</span><span class="op" id="572067">:</span>&nbsp;<span class="ident" id="572069">tr</span><span class="op" id="572071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="572075">//&nbsp;Start&nbsp;3&nbsp;outstanding&nbsp;requests&nbsp;and&nbsp;wait&nbsp;for&nbsp;the&nbsp;server&nbsp;to&nbsp;get&nbsp;them.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="572145">//&nbsp;Their&nbsp;responses&nbsp;will&nbsp;hang&nbsp;until&nbsp;we&nbsp;write&nbsp;to&nbsp;resch,&nbsp;though.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572208">donech</span>&nbsp;<span class="op" id="572215">:=</span>&nbsp;<span class="builtinfunc" id="572218">make</span><span class="op" id="572222">(</span><span class="keyword" id="572223">chan</span>&nbsp;<span class="builtintype" id="572228">bool</span><span class="op" id="572232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572235">doReq</span>&nbsp;<span class="op" id="572241">:=</span>&nbsp;<span class="keyword" id="572244">func</span><span class="op" id="572248">(</span><span class="op" id="572249">)</span>&nbsp;<span class="op" id="572251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572255">resp</span><span class="op" id="572259">,</span>&nbsp;<span class="ident" id="572261">err</span>&nbsp;<span class="op" id="572265">:=</span>&nbsp;<span class="ident" id="572268">c</span><span class="op" id="572269">.</span><span class="ident" id="572270">Get</span><span class="op" id="572273">(</span><span class="ident" id="572274">ts</span><span class="op" id="572276">.</span><span class="ident" id="572277">URL</span><span class="op" id="572280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572284">if</span>&nbsp;<span class="ident" id="572287">err</span>&nbsp;<span class="op" id="572291">!=</span>&nbsp;<span class="ident" id="572294">nil</span>&nbsp;<span class="op" id="572298">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572303">t</span><span class="op" id="572304">.</span><span class="ident" id="572305">Error</span><span class="op" id="572310">(</span><span class="ident" id="572311">err</span><span class="op" id="572314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572319">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572332">if</span>&nbsp;<span class="ident" id="572335">_</span><span class="op" id="572336">,</span>&nbsp;<span class="ident" id="572338">err</span>&nbsp;<span class="op" id="572342">:=</span>&nbsp;<span class="ident" id="572345">ioutil</span><span class="op" id="572351">.</span><span class="ident" id="572352">ReadAll</span><span class="op" id="572359">(</span><span class="ident" id="572360">resp</span><span class="op" id="572364">.</span><span class="ident" id="572365">Body</span><span class="op" id="572369">)</span><span class="op" id="572370">;</span>&nbsp;<span class="ident" id="572372">err</span>&nbsp;<span class="op" id="572376">!=</span>&nbsp;<span class="ident" id="572379">nil</span>&nbsp;<span class="op" id="572383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572388">t</span><span class="op" id="572389">.</span><span class="ident" id="572390">Errorf</span><span class="op" id="572396">(</span><span class="string" id="572397">&#34;ReadAll:&nbsp;%v&#34;</span><span class="op" id="572410">,</span>&nbsp;<span class="ident" id="572412">err</span><span class="op" id="572415">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572420">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572433">donech</span>&nbsp;<span class="op" id="572440">&lt;-</span>&nbsp;<span class="builtintype" id="572443">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572452">go</span>&nbsp;<span class="ident" id="572455">doReq</span><span class="op" id="572460">(</span><span class="op" id="572461">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572464">&lt;-</span><span class="ident" id="572466">gotReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572474">go</span>&nbsp;<span class="ident" id="572477">doReq</span><span class="op" id="572482">(</span><span class="op" id="572483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572486">&lt;-</span><span class="ident" id="572488">gotReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572496">go</span>&nbsp;<span class="ident" id="572499">doReq</span><span class="op" id="572504">(</span><span class="op" id="572505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572508">&lt;-</span><span class="ident" id="572510">gotReq</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572519">if</span>&nbsp;<span class="ident" id="572522">e</span><span class="op" id="572523">,</span>&nbsp;<span class="ident" id="572525">g</span>&nbsp;<span class="op" id="572527">:=</span>&nbsp;<span class="num" id="572530">0</span><span class="op" id="572531">,</span>&nbsp;<span class="builtinfunc" id="572533">len</span><span class="op" id="572536">(</span><span class="ident" id="572537">tr</span><span class="op" id="572539">.</span><span class="ident" id="572540">IdleConnKeysForTesting</span><span class="op" id="572562">(</span><span class="op" id="572563">)</span><span class="op" id="572564">)</span><span class="op" id="572565">;</span>&nbsp;<span class="ident" id="572567">e</span>&nbsp;<span class="op" id="572569">!=</span>&nbsp;<span class="ident" id="572572">g</span>&nbsp;<span class="op" id="572574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572578">t</span><span class="op" id="572579">.</span><span class="ident" id="572580">Fatalf</span><span class="op" id="572586">(</span><span class="string" id="572587">&#34;Before&nbsp;writes,&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conn&nbsp;cache&nbsp;keys;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="572644">,</span>&nbsp;<span class="ident" id="572646">e</span><span class="op" id="572647">,</span>&nbsp;<span class="ident" id="572649">g</span><span class="op" id="572650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572657">resch</span>&nbsp;<span class="op" id="572663">&lt;-</span>&nbsp;<span class="string" id="572666">&#34;res1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572674">&lt;-</span><span class="ident" id="572676">donech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572684">keys</span>&nbsp;<span class="op" id="572689">:=</span>&nbsp;<span class="ident" id="572692">tr</span><span class="op" id="572694">.</span><span class="ident" id="572695">IdleConnKeysForTesting</span><span class="op" id="572717">(</span><span class="op" id="572718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572721">if</span>&nbsp;<span class="ident" id="572724">e</span><span class="op" id="572725">,</span>&nbsp;<span class="ident" id="572727">g</span>&nbsp;<span class="op" id="572729">:=</span>&nbsp;<span class="num" id="572732">1</span><span class="op" id="572733">,</span>&nbsp;<span class="builtinfunc" id="572735">len</span><span class="op" id="572738">(</span><span class="ident" id="572739">keys</span><span class="op" id="572743">)</span><span class="op" id="572744">;</span>&nbsp;<span class="ident" id="572746">e</span>&nbsp;<span class="op" id="572748">!=</span>&nbsp;<span class="ident" id="572751">g</span>&nbsp;<span class="op" id="572753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572757">t</span><span class="op" id="572758">.</span><span class="ident" id="572759">Fatalf</span><span class="op" id="572765">(</span><span class="string" id="572766">&#34;after&nbsp;first&nbsp;response,&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conn&nbsp;cache&nbsp;keys;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="572830">,</span>&nbsp;<span class="ident" id="572832">e</span><span class="op" id="572833">,</span>&nbsp;<span class="ident" id="572835">g</span><span class="op" id="572836">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572842">cacheKey</span>&nbsp;<span class="op" id="572851">:=</span>&nbsp;<span class="string" id="572854">&#34;|http|&#34;</span>&nbsp;<span class="op" id="572863">+</span>&nbsp;<span class="ident" id="572865">ts</span><span class="op" id="572867">.</span><span class="ident" id="572868">Listener</span><span class="op" id="572876">.</span><span class="ident" id="572877">Addr</span><span class="op" id="572881">(</span><span class="op" id="572882">)</span><span class="op" id="572883">.</span><span class="ident" id="572884">String</span><span class="op" id="572890">(</span><span class="op" id="572891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572894">if</span>&nbsp;<span class="ident" id="572897">keys</span><span class="op" id="572901">[</span><span class="num" id="572902">0</span><span class="op" id="572903">]</span>&nbsp;<span class="op" id="572905">!=</span>&nbsp;<span class="ident" id="572908">cacheKey</span>&nbsp;<span class="op" id="572917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="572921">t</span><span class="op" id="572922">.</span><span class="ident" id="572923">Fatalf</span><span class="op" id="572929">(</span><span class="string" id="572930">&#34;Expected&nbsp;idle&nbsp;cache&nbsp;key&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="572966">,</span>&nbsp;<span class="ident" id="572968">cacheKey</span><span class="op" id="572976">,</span>&nbsp;<span class="ident" id="572978">keys</span><span class="op" id="572982">[</span><span class="num" id="572983">0</span><span class="op" id="572984">]</span><span class="op" id="572985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="572988">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="572991">if</span>&nbsp;<span class="ident" id="572994">e</span><span class="op" id="572995">,</span>&nbsp;<span class="ident" id="572997">g</span>&nbsp;<span class="op" id="572999">:=</span>&nbsp;<span class="num" id="573002">1</span><span class="op" id="573003">,</span>&nbsp;<span class="ident" id="573005">tr</span><span class="op" id="573007">.</span><span class="ident" id="573008">IdleConnCountForTesting</span><span class="op" id="573031">(</span><span class="ident" id="573032">cacheKey</span><span class="op" id="573040">)</span><span class="op" id="573041">;</span>&nbsp;<span class="ident" id="573043">e</span>&nbsp;<span class="op" id="573045">!=</span>&nbsp;<span class="ident" id="573048">g</span>&nbsp;<span class="op" id="573050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573054">t</span><span class="op" id="573055">.</span><span class="ident" id="573056">Errorf</span><span class="op" id="573062">(</span><span class="string" id="573063">&#34;after&nbsp;first&nbsp;response,&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conns;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="573117">,</span>&nbsp;<span class="ident" id="573119">e</span><span class="op" id="573120">,</span>&nbsp;<span class="ident" id="573122">g</span><span class="op" id="573123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573130">resch</span>&nbsp;<span class="op" id="573136">&lt;-</span>&nbsp;<span class="string" id="573139">&#34;res2&#34;</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573147">&lt;-</span><span class="ident" id="573149">donech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="573157">if</span>&nbsp;<span class="ident" id="573160">e</span><span class="op" id="573161">,</span>&nbsp;<span class="ident" id="573163">g</span>&nbsp;<span class="op" id="573165">:=</span>&nbsp;<span class="num" id="573168">2</span><span class="op" id="573169">,</span>&nbsp;<span class="ident" id="573171">tr</span><span class="op" id="573173">.</span><span class="ident" id="573174">IdleConnCountForTesting</span><span class="op" id="573197">(</span><span class="ident" id="573198">cacheKey</span><span class="op" id="573206">)</span><span class="op" id="573207">;</span>&nbsp;<span class="ident" id="573209">e</span>&nbsp;<span class="op" id="573211">!=</span>&nbsp;<span class="ident" id="573214">g</span>&nbsp;<span class="op" id="573216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573220">t</span><span class="op" id="573221">.</span><span class="ident" id="573222">Errorf</span><span class="op" id="573228">(</span><span class="string" id="573229">&#34;after&nbsp;second&nbsp;response,&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conns;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="573284">,</span>&nbsp;<span class="ident" id="573286">e</span><span class="op" id="573287">,</span>&nbsp;<span class="ident" id="573289">g</span><span class="op" id="573290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573297">resch</span>&nbsp;<span class="op" id="573303">&lt;-</span>&nbsp;<span class="string" id="573306">&#34;res3&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573314">&lt;-</span><span class="ident" id="573316">donech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="573324">if</span>&nbsp;<span class="ident" id="573327">e</span><span class="op" id="573328">,</span>&nbsp;<span class="ident" id="573330">g</span>&nbsp;<span class="op" id="573332">:=</span>&nbsp;<span class="ident" id="573335">maxIdleConns</span><span class="op" id="573347">,</span>&nbsp;<span class="ident" id="573349">tr</span><span class="op" id="573351">.</span><span class="ident" id="573352">IdleConnCountForTesting</span><span class="op" id="573375">(</span><span class="ident" id="573376">cacheKey</span><span class="op" id="573384">)</span><span class="op" id="573385">;</span>&nbsp;<span class="ident" id="573387">e</span>&nbsp;<span class="op" id="573389">!=</span>&nbsp;<span class="ident" id="573392">g</span>&nbsp;<span class="op" id="573394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573398">t</span><span class="op" id="573399">.</span><span class="ident" id="573400">Errorf</span><span class="op" id="573406">(</span><span class="string" id="573407">&#34;after&nbsp;third&nbsp;response,&nbsp;still&nbsp;expected&nbsp;%d&nbsp;idle&nbsp;conns;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="573467">,</span>&nbsp;<span class="ident" id="573469">e</span><span class="op" id="573470">,</span>&nbsp;<span class="ident" id="573472">g</span><span class="op" id="573473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573476">}</span><br>
<span class="lineno">405</span><span class="op" id="573478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="573481">func</span>&nbsp;<span class="ident" id="573486">TestTransportServerClosingUnexpectedly</span><span class="op" id="573524">(</span><span class="ident" id="573525">t</span>&nbsp;<span class="op" id="573527">*</span><span class="ident" id="573528">testing</span><span class="op" id="573535">.</span><span class="ident" id="573536">T</span><span class="op" id="573537">)</span>&nbsp;<span class="op" id="573539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="573542">defer</span>&nbsp;<span class="ident" id="573548">afterTest</span><span class="op" id="573557">(</span><span class="ident" id="573558">t</span><span class="op" id="573559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573562">ts</span>&nbsp;<span class="op" id="573565">:=</span>&nbsp;<span class="ident" id="573568">httptest</span><span class="op" id="573576">.</span><span class="ident" id="573577">NewServer</span><span class="op" id="573586">(</span><span class="ident" id="573587">hostPortHandler</span><span class="op" id="573602">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="573605">defer</span>&nbsp;<span class="ident" id="573611">ts</span><span class="op" id="573613">.</span><span class="ident" id="573614">Close</span><span class="op" id="573619">(</span><span class="op" id="573620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573624">tr</span>&nbsp;<span class="op" id="573627">:=</span>&nbsp;<span class="op" id="573630">&amp;</span><span class="ident" id="573631">Transport</span><span class="op" id="573640">{</span><span class="op" id="573641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573644">c</span>&nbsp;<span class="op" id="573646">:=</span>&nbsp;<span class="op" id="573649">&amp;</span><span class="ident" id="573650">Client</span><span class="op" id="573656">{</span><span class="ident" id="573657">Transport</span><span class="op" id="573666">:</span>&nbsp;<span class="ident" id="573668">tr</span><span class="op" id="573670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573674">fetch</span>&nbsp;<span class="op" id="573680">:=</span>&nbsp;<span class="keyword" id="573683">func</span><span class="op" id="573687">(</span><span class="ident" id="573688">n</span><span class="op" id="573689">,</span>&nbsp;<span class="ident" id="573691">retries</span>&nbsp;<span class="builtintype" id="573699">int</span><span class="op" id="573702">)</span>&nbsp;<span class="builtintype" id="573704">string</span>&nbsp;<span class="op" id="573711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573715">condFatalf</span>&nbsp;<span class="op" id="573726">:=</span>&nbsp;<span class="keyword" id="573729">func</span><span class="op" id="573733">(</span><span class="ident" id="573734">format</span>&nbsp;<span class="builtintype" id="573741">string</span><span class="op" id="573747">,</span>&nbsp;<span class="ident" id="573749">arg</span>&nbsp;<span class="op" id="573753">...</span><span class="keyword" id="573756">interface</span><span class="op" id="573765">{</span><span class="op" id="573766">}</span><span class="op" id="573767">)</span>&nbsp;<span class="op" id="573769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="573774">if</span>&nbsp;<span class="ident" id="573777">retries</span>&nbsp;<span class="op" id="573785">&lt;=</span>&nbsp;<span class="num" id="573788">0</span>&nbsp;<span class="op" id="573790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573796">t</span><span class="op" id="573797">.</span><span class="ident" id="573798">Fatalf</span><span class="op" id="573804">(</span><span class="ident" id="573805">format</span><span class="op" id="573811">,</span>&nbsp;<span class="ident" id="573813">arg</span><span class="op" id="573816">...</span><span class="op" id="573819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573824">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573829">t</span><span class="op" id="573830">.</span><span class="ident" id="573831">Logf</span><span class="op" id="573835">(</span><span class="string" id="573836">&#34;retrying&nbsp;shortly&nbsp;after&nbsp;expected&nbsp;error:&nbsp;&#34;</span><span class="op" id="573877">+</span><span class="ident" id="573878">format</span><span class="op" id="573884">,</span>&nbsp;<span class="ident" id="573886">arg</span><span class="op" id="573889">...</span><span class="op" id="573892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573897">time</span><span class="op" id="573901">.</span><span class="ident" id="573902">Sleep</span><span class="op" id="573907">(</span><span class="ident" id="573908">time</span><span class="op" id="573912">.</span><span class="ident" id="573913">Second</span>&nbsp;<span class="op" id="573920">/</span>&nbsp;<span class="ident" id="573922">time</span><span class="op" id="573926">.</span><span class="ident" id="573927">Duration</span><span class="op" id="573935">(</span><span class="ident" id="573936">retries</span><span class="op" id="573943">)</span><span class="op" id="573944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="573948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="573952">for</span>&nbsp;<span class="ident" id="573956">retries</span>&nbsp;<span class="op" id="573964">&gt;=</span>&nbsp;<span class="num" id="573967">0</span>&nbsp;<span class="op" id="573969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573974">retries</span><span class="op" id="573981">--</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="573987">res</span><span class="op" id="573990">,</span>&nbsp;<span class="ident" id="573992">err</span>&nbsp;<span class="op" id="573996">:=</span>&nbsp;<span class="ident" id="573999">c</span><span class="op" id="574000">.</span><span class="ident" id="574001">Get</span><span class="op" id="574004">(</span><span class="ident" id="574005">ts</span><span class="op" id="574007">.</span><span class="ident" id="574008">URL</span><span class="op" id="574011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574016">if</span>&nbsp;<span class="ident" id="574019">err</span>&nbsp;<span class="op" id="574023">!=</span>&nbsp;<span class="ident" id="574026">nil</span>&nbsp;<span class="op" id="574030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574036">condFatalf</span><span class="op" id="574046">(</span><span class="string" id="574047">&#34;error&nbsp;in&nbsp;req&nbsp;#%d,&nbsp;GET:&nbsp;%v&#34;</span><span class="op" id="574074">,</span>&nbsp;<span class="ident" id="574076">n</span><span class="op" id="574077">,</span>&nbsp;<span class="ident" id="574079">err</span><span class="op" id="574082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574088">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="574100">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574105">body</span><span class="op" id="574109">,</span>&nbsp;<span class="ident" id="574111">err</span>&nbsp;<span class="op" id="574115">:=</span>&nbsp;<span class="ident" id="574118">ioutil</span><span class="op" id="574124">.</span><span class="ident" id="574125">ReadAll</span><span class="op" id="574132">(</span><span class="ident" id="574133">res</span><span class="op" id="574136">.</span><span class="ident" id="574137">Body</span><span class="op" id="574141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574146">if</span>&nbsp;<span class="ident" id="574149">err</span>&nbsp;<span class="op" id="574153">!=</span>&nbsp;<span class="ident" id="574156">nil</span>&nbsp;<span class="op" id="574160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574166">condFatalf</span><span class="op" id="574176">(</span><span class="string" id="574177">&#34;error&nbsp;in&nbsp;req&nbsp;#%d,&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="574208">,</span>&nbsp;<span class="ident" id="574210">n</span><span class="op" id="574211">,</span>&nbsp;<span class="ident" id="574213">err</span><span class="op" id="574216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574222">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="574234">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574239">res</span><span class="op" id="574242">.</span><span class="ident" id="574243">Body</span><span class="op" id="574247">.</span><span class="ident" id="574248">Close</span><span class="op" id="574253">(</span><span class="op" id="574254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574259">return</span>&nbsp;<span class="builtintype" id="574266">string</span><span class="op" id="574272">(</span><span class="ident" id="574273">body</span><span class="op" id="574277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="574281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="574285">panic</span><span class="op" id="574290">(</span><span class="string" id="574291">&#34;unreachable&#34;</span><span class="op" id="574304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="574307">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574311">body1</span>&nbsp;<span class="op" id="574317">:=</span>&nbsp;<span class="ident" id="574320">fetch</span><span class="op" id="574325">(</span><span class="num" id="574326">1</span><span class="op" id="574327">,</span>&nbsp;<span class="num" id="574329">0</span><span class="op" id="574330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574333">body2</span>&nbsp;<span class="op" id="574339">:=</span>&nbsp;<span class="ident" id="574342">fetch</span><span class="op" id="574347">(</span><span class="num" id="574348">2</span><span class="op" id="574349">,</span>&nbsp;<span class="num" id="574351">0</span><span class="op" id="574352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574356">ts</span><span class="op" id="574358">.</span><span class="ident" id="574359">CloseClientConnections</span><span class="op" id="574381">(</span><span class="op" id="574382">)</span>&nbsp;<span class="comment" id="574384">//&nbsp;surprise!</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="574399">//&nbsp;This&nbsp;test&nbsp;has&nbsp;an&nbsp;expected&nbsp;race.&nbsp;Sleeping&nbsp;for&nbsp;25&nbsp;ms&nbsp;prevents</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="574463">//&nbsp;it&nbsp;on&nbsp;most&nbsp;fast&nbsp;machines,&nbsp;causing&nbsp;the&nbsp;next&nbsp;fetch()&nbsp;call&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="574526">//&nbsp;succeed&nbsp;quickly.&nbsp;&nbsp;But&nbsp;if&nbsp;we&nbsp;do&nbsp;get&nbsp;errors,&nbsp;fetch()&nbsp;will&nbsp;retry&nbsp;5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="574594">//&nbsp;times&nbsp;with&nbsp;some&nbsp;delays&nbsp;between.</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574630">time</span><span class="op" id="574634">.</span><span class="ident" id="574635">Sleep</span><span class="op" id="574640">(</span><span class="num" id="574641">25</span>&nbsp;<span class="op" id="574644">*</span>&nbsp;<span class="ident" id="574646">time</span><span class="op" id="574650">.</span><span class="ident" id="574651">Millisecond</span><span class="op" id="574662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574666">body3</span>&nbsp;<span class="op" id="574672">:=</span>&nbsp;<span class="ident" id="574675">fetch</span><span class="op" id="574680">(</span><span class="num" id="574681">3</span><span class="op" id="574682">,</span>&nbsp;<span class="num" id="574684">5</span><span class="op" id="574685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574689">if</span>&nbsp;<span class="ident" id="574692">body1</span>&nbsp;<span class="op" id="574698">!=</span>&nbsp;<span class="ident" id="574701">body2</span>&nbsp;<span class="op" id="574707">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574711">t</span><span class="op" id="574712">.</span><span class="ident" id="574713">Errorf</span><span class="op" id="574719">(</span><span class="string" id="574720">&#34;expected&nbsp;body1&nbsp;and&nbsp;body2&nbsp;to&nbsp;be&nbsp;equal&#34;</span><span class="op" id="574758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="574761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="574764">if</span>&nbsp;<span class="ident" id="574767">body2</span>&nbsp;<span class="op" id="574773">==</span>&nbsp;<span class="ident" id="574776">body3</span>&nbsp;<span class="op" id="574782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="574786">t</span><span class="op" id="574787">.</span><span class="ident" id="574788">Errorf</span><span class="op" id="574794">(</span><span class="string" id="574795">&#34;expected&nbsp;body2&nbsp;and&nbsp;body3&nbsp;to&nbsp;be&nbsp;different&#34;</span><span class="op" id="574837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="574840">}</span><br>
<span class="lineno">460</span><span class="op" id="574842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="574845">//&nbsp;Test&nbsp;for&nbsp;http://golang.org/issue/2616&nbsp;(appropriate&nbsp;issue&nbsp;number)</span><br>
<span class="lineno"></span><span class="comment" id="574913">//&nbsp;This&nbsp;fails&nbsp;pretty&nbsp;reliably&nbsp;with&nbsp;GOMAXPROCS=100&nbsp;or&nbsp;something&nbsp;high.</span><br>
<span class="lineno"></span><span class="keyword" id="574982">func</span>&nbsp;<span class="ident" id="574987">TestStressSurpriseServerCloses</span><span class="op" id="575017">(</span><span class="ident" id="575018">t</span>&nbsp;<span class="op" id="575020">*</span><span class="ident" id="575021">testing</span><span class="op" id="575028">.</span><span class="ident" id="575029">T</span><span class="op" id="575030">)</span>&nbsp;<span class="op" id="575032">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575035">defer</span>&nbsp;<span class="ident" id="575041">afterTest</span><span class="op" id="575050">(</span><span class="ident" id="575051">t</span><span class="op" id="575052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575055">if</span>&nbsp;<span class="ident" id="575058">testing</span><span class="op" id="575065">.</span><span class="ident" id="575066">Short</span><span class="op" id="575071">(</span><span class="op" id="575072">)</span>&nbsp;<span class="op" id="575074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575078">t</span><span class="op" id="575079">.</span><span class="ident" id="575080">Skip</span><span class="op" id="575084">(</span><span class="string" id="575085">&#34;skipping&nbsp;test&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="575114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="575117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575120">ts</span>&nbsp;<span class="op" id="575123">:=</span>&nbsp;<span class="ident" id="575126">httptest</span><span class="op" id="575134">.</span><span class="ident" id="575135">NewServer</span><span class="op" id="575144">(</span><span class="ident" id="575145">HandlerFunc</span><span class="op" id="575156">(</span><span class="keyword" id="575157">func</span><span class="op" id="575161">(</span><span class="ident" id="575162">w</span>&nbsp;<span class="ident" id="575164">ResponseWriter</span><span class="op" id="575178">,</span>&nbsp;<span class="ident" id="575180">r</span>&nbsp;<span class="op" id="575182">*</span><span class="ident" id="575183">Request</span><span class="op" id="575190">)</span>&nbsp;<span class="op" id="575192">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575196">w</span><span class="op" id="575197">.</span><span class="ident" id="575198">Header</span><span class="op" id="575204">(</span><span class="op" id="575205">)</span><span class="op" id="575206">.</span><span class="ident" id="575207">Set</span><span class="op" id="575210">(</span><span class="string" id="575211">&#34;Content-Length&#34;</span><span class="op" id="575227">,</span>&nbsp;<span class="string" id="575229">&#34;5&#34;</span><span class="op" id="575232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575236">w</span><span class="op" id="575237">.</span><span class="ident" id="575238">Header</span><span class="op" id="575244">(</span><span class="op" id="575245">)</span><span class="op" id="575246">.</span><span class="ident" id="575247">Set</span><span class="op" id="575250">(</span><span class="string" id="575251">&#34;Content-Type&#34;</span><span class="op" id="575265">,</span>&nbsp;<span class="string" id="575267">&#34;text/plain&#34;</span><span class="op" id="575279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575283">w</span><span class="op" id="575284">.</span><span class="ident" id="575285">Write</span><span class="op" id="575290">(</span><span class="op" id="575291">[</span><span class="op" id="575292">]</span><span class="builtintype" id="575293">byte</span><span class="op" id="575297">(</span><span class="string" id="575298">&#34;Hello&#34;</span><span class="op" id="575305">)</span><span class="op" id="575306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575310">w</span><span class="op" id="575311">.</span><span class="op" id="575312">(</span><span class="ident" id="575313">Flusher</span><span class="op" id="575320">)</span><span class="op" id="575321">.</span><span class="ident" id="575322">Flush</span><span class="op" id="575327">(</span><span class="op" id="575328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575332">conn</span><span class="op" id="575336">,</span>&nbsp;<span class="ident" id="575338">buf</span><span class="op" id="575341">,</span>&nbsp;<span class="ident" id="575343">_</span>&nbsp;<span class="op" id="575345">:=</span>&nbsp;<span class="ident" id="575348">w</span><span class="op" id="575349">.</span><span class="op" id="575350">(</span><span class="ident" id="575351">Hijacker</span><span class="op" id="575359">)</span><span class="op" id="575360">.</span><span class="ident" id="575361">Hijack</span><span class="op" id="575367">(</span><span class="op" id="575368">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575372">buf</span><span class="op" id="575375">.</span><span class="ident" id="575376">Flush</span><span class="op" id="575381">(</span><span class="op" id="575382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575386">conn</span><span class="op" id="575390">.</span><span class="ident" id="575391">Close</span><span class="op" id="575396">(</span><span class="op" id="575397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="575400">}</span><span class="op" id="575401">)</span><span class="op" id="575402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575405">defer</span>&nbsp;<span class="ident" id="575411">ts</span><span class="op" id="575413">.</span><span class="ident" id="575414">Close</span><span class="op" id="575419">(</span><span class="op" id="575420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575424">tr</span>&nbsp;<span class="op" id="575427">:=</span>&nbsp;<span class="op" id="575430">&amp;</span><span class="ident" id="575431">Transport</span><span class="op" id="575440">{</span><span class="ident" id="575441">DisableKeepAlives</span><span class="op" id="575458">:</span>&nbsp;<span class="builtintype" id="575460">false</span><span class="op" id="575465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575468">c</span>&nbsp;<span class="op" id="575470">:=</span>&nbsp;<span class="op" id="575473">&amp;</span><span class="ident" id="575474">Client</span><span class="op" id="575480">{</span><span class="ident" id="575481">Transport</span><span class="op" id="575490">:</span>&nbsp;<span class="ident" id="575492">tr</span><span class="op" id="575494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="575498">//&nbsp;Do&nbsp;a&nbsp;bunch&nbsp;of&nbsp;traffic&nbsp;from&nbsp;different&nbsp;goroutines.&nbsp;Send&nbsp;to&nbsp;activityc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="575569">//&nbsp;after&nbsp;each&nbsp;request&nbsp;completes,&nbsp;regardless&nbsp;of&nbsp;whether&nbsp;it&nbsp;failed.</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575636">const</span>&nbsp;<span class="op" id="575642">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575646">numClients</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="575660">=</span>&nbsp;<span class="num" id="575662">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575667">reqsPerClient</span>&nbsp;<span class="op" id="575681">=</span>&nbsp;<span class="num" id="575683">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="575688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575691">activityc</span>&nbsp;<span class="op" id="575701">:=</span>&nbsp;<span class="builtinfunc" id="575704">make</span><span class="op" id="575708">(</span><span class="keyword" id="575709">chan</span>&nbsp;<span class="builtintype" id="575714">bool</span><span class="op" id="575718">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575721">for</span>&nbsp;<span class="ident" id="575725">i</span>&nbsp;<span class="op" id="575727">:=</span>&nbsp;<span class="num" id="575730">0</span><span class="op" id="575731">;</span>&nbsp;<span class="ident" id="575733">i</span>&nbsp;<span class="op" id="575735">&lt;</span>&nbsp;<span class="ident" id="575737">numClients</span><span class="op" id="575747">;</span>&nbsp;<span class="ident" id="575749">i</span><span class="op" id="575750">++</span>&nbsp;<span class="op" id="575753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575757">go</span>&nbsp;<span class="keyword" id="575760">func</span><span class="op" id="575764">(</span><span class="op" id="575765">)</span>&nbsp;<span class="op" id="575767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575772">for</span>&nbsp;<span class="ident" id="575776">i</span>&nbsp;<span class="op" id="575778">:=</span>&nbsp;<span class="num" id="575781">0</span><span class="op" id="575782">;</span>&nbsp;<span class="ident" id="575784">i</span>&nbsp;<span class="op" id="575786">&lt;</span>&nbsp;<span class="ident" id="575788">reqsPerClient</span><span class="op" id="575801">;</span>&nbsp;<span class="ident" id="575803">i</span><span class="op" id="575804">++</span>&nbsp;<span class="op" id="575807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="575813">res</span><span class="op" id="575816">,</span>&nbsp;<span class="ident" id="575818">err</span>&nbsp;<span class="op" id="575822">:=</span>&nbsp;<span class="ident" id="575825">c</span><span class="op" id="575826">.</span><span class="ident" id="575827">Get</span><span class="op" id="575830">(</span><span class="ident" id="575831">ts</span><span class="op" id="575833">.</span><span class="ident" id="575834">URL</span><span class="op" id="575837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="575843">if</span>&nbsp;<span class="ident" id="575846">err</span>&nbsp;<span class="op" id="575850">==</span>&nbsp;<span class="ident" id="575853">nil</span>&nbsp;<span class="op" id="575857">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="575864">//&nbsp;We&nbsp;expect&nbsp;errors&nbsp;since&nbsp;the&nbsp;server&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="575909">//&nbsp;hanging&nbsp;up&nbsp;on&nbsp;us&nbsp;after&nbsp;telling&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="575954">//&nbsp;send&nbsp;more&nbsp;requests,&nbsp;so&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="575994">//&nbsp;actually&nbsp;care&nbsp;what&nbsp;the&nbsp;error&nbsp;is.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="576035">//&nbsp;But&nbsp;we&nbsp;want&nbsp;to&nbsp;close&nbsp;the&nbsp;body&nbsp;in&nbsp;cases</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="576082">//&nbsp;where&nbsp;we&nbsp;won&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576113">res</span><span class="op" id="576116">.</span><span class="ident" id="576117">Body</span><span class="op" id="576121">.</span><span class="ident" id="576122">Close</span><span class="op" id="576127">(</span><span class="op" id="576128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576140">activityc</span>&nbsp;<span class="op" id="576150">&lt;-</span>&nbsp;<span class="builtintype" id="576153">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576161">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576165">}</span><span class="op" id="576166">(</span><span class="op" id="576167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="576174">//&nbsp;Make&nbsp;sure&nbsp;all&nbsp;the&nbsp;request&nbsp;come&nbsp;back,&nbsp;one&nbsp;way&nbsp;or&nbsp;another.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576235">for</span>&nbsp;<span class="ident" id="576239">i</span>&nbsp;<span class="op" id="576241">:=</span>&nbsp;<span class="num" id="576244">0</span><span class="op" id="576245">;</span>&nbsp;<span class="ident" id="576247">i</span>&nbsp;<span class="op" id="576249">&lt;</span>&nbsp;<span class="ident" id="576251">numClients</span><span class="op" id="576261">*</span><span class="ident" id="576262">reqsPerClient</span><span class="op" id="576275">;</span>&nbsp;<span class="ident" id="576277">i</span><span class="op" id="576278">++</span>&nbsp;<span class="op" id="576281">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576285">select</span>&nbsp;<span class="op" id="576292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576296">case</span>&nbsp;<span class="op" id="576301">&lt;-</span><span class="ident" id="576303">activityc</span><span class="op" id="576312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576316">case</span>&nbsp;<span class="op" id="576321">&lt;-</span><span class="ident" id="576323">time</span><span class="op" id="576327">.</span><span class="ident" id="576328">After</span><span class="op" id="576333">(</span><span class="num" id="576334">5</span>&nbsp;<span class="op" id="576336">*</span>&nbsp;<span class="ident" id="576338">time</span><span class="op" id="576342">.</span><span class="ident" id="576343">Second</span><span class="op" id="576349">)</span><span class="op" id="576350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576355">t</span><span class="op" id="576356">.</span><span class="ident" id="576357">Fatalf</span><span class="op" id="576363">(</span><span class="string" id="576364">&#34;presumed&nbsp;deadlock;&nbsp;no&nbsp;HTTP&nbsp;client&nbsp;activity&nbsp;seen&nbsp;in&nbsp;awhile&#34;</span><span class="op" id="576423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576427">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576430">}</span><br>
<span class="lineno"></span><span class="op" id="576432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="576435">//&nbsp;TestTransportHeadResponses&nbsp;verifies&nbsp;that&nbsp;we&nbsp;deal&nbsp;with&nbsp;Content-Lengths</span><br>
<span class="lineno"></span><span class="comment" id="576508">//&nbsp;with&nbsp;no&nbsp;bodies&nbsp;properly</span><br>
<span class="lineno">520</span><span class="keyword" id="576535">func</span>&nbsp;<span class="ident" id="576540">TestTransportHeadResponses</span><span class="op" id="576566">(</span><span class="ident" id="576567">t</span>&nbsp;<span class="op" id="576569">*</span><span class="ident" id="576570">testing</span><span class="op" id="576577">.</span><span class="ident" id="576578">T</span><span class="op" id="576579">)</span>&nbsp;<span class="op" id="576581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576584">defer</span>&nbsp;<span class="ident" id="576590">afterTest</span><span class="op" id="576599">(</span><span class="ident" id="576600">t</span><span class="op" id="576601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576604">ts</span>&nbsp;<span class="op" id="576607">:=</span>&nbsp;<span class="ident" id="576610">httptest</span><span class="op" id="576618">.</span><span class="ident" id="576619">NewServer</span><span class="op" id="576628">(</span><span class="ident" id="576629">HandlerFunc</span><span class="op" id="576640">(</span><span class="keyword" id="576641">func</span><span class="op" id="576645">(</span><span class="ident" id="576646">w</span>&nbsp;<span class="ident" id="576648">ResponseWriter</span><span class="op" id="576662">,</span>&nbsp;<span class="ident" id="576664">r</span>&nbsp;<span class="op" id="576666">*</span><span class="ident" id="576667">Request</span><span class="op" id="576674">)</span>&nbsp;<span class="op" id="576676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576680">if</span>&nbsp;<span class="ident" id="576683">r</span><span class="op" id="576684">.</span><span class="ident" id="576685">Method</span>&nbsp;<span class="op" id="576692">!=</span>&nbsp;<span class="string" id="576695">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="576702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="576707">panic</span><span class="op" id="576712">(</span><span class="string" id="576713">&#34;expected&nbsp;HEAD;&nbsp;got&nbsp;&#34;</span>&nbsp;<span class="op" id="576735">+</span>&nbsp;<span class="ident" id="576737">r</span><span class="op" id="576738">.</span><span class="ident" id="576739">Method</span><span class="op" id="576745">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576753">w</span><span class="op" id="576754">.</span><span class="ident" id="576755">Header</span><span class="op" id="576761">(</span><span class="op" id="576762">)</span><span class="op" id="576763">.</span><span class="ident" id="576764">Set</span><span class="op" id="576767">(</span><span class="string" id="576768">&#34;Content-Length&#34;</span><span class="op" id="576784">,</span>&nbsp;<span class="string" id="576786">&#34;123&#34;</span><span class="op" id="576791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576795">w</span><span class="op" id="576796">.</span><span class="ident" id="576797">WriteHeader</span><span class="op" id="576808">(</span><span class="num" id="576809">200</span><span class="op" id="576812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="576815">}</span><span class="op" id="576816">)</span><span class="op" id="576817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576820">defer</span>&nbsp;<span class="ident" id="576826">ts</span><span class="op" id="576828">.</span><span class="ident" id="576829">Close</span><span class="op" id="576834">(</span><span class="op" id="576835">)</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576839">tr</span>&nbsp;<span class="op" id="576842">:=</span>&nbsp;<span class="op" id="576845">&amp;</span><span class="ident" id="576846">Transport</span><span class="op" id="576855">{</span><span class="ident" id="576856">DisableKeepAlives</span><span class="op" id="576873">:</span>&nbsp;<span class="builtintype" id="576875">false</span><span class="op" id="576880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576883">c</span>&nbsp;<span class="op" id="576885">:=</span>&nbsp;<span class="op" id="576888">&amp;</span><span class="ident" id="576889">Client</span><span class="op" id="576895">{</span><span class="ident" id="576896">Transport</span><span class="op" id="576905">:</span>&nbsp;<span class="ident" id="576907">tr</span><span class="op" id="576909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576912">for</span>&nbsp;<span class="ident" id="576916">i</span>&nbsp;<span class="op" id="576918">:=</span>&nbsp;<span class="num" id="576921">0</span><span class="op" id="576922">;</span>&nbsp;<span class="ident" id="576924">i</span>&nbsp;<span class="op" id="576926">&lt;</span>&nbsp;<span class="num" id="576928">2</span><span class="op" id="576929">;</span>&nbsp;<span class="ident" id="576931">i</span><span class="op" id="576932">++</span>&nbsp;<span class="op" id="576935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576939">res</span><span class="op" id="576942">,</span>&nbsp;<span class="ident" id="576944">err</span>&nbsp;<span class="op" id="576948">:=</span>&nbsp;<span class="ident" id="576951">c</span><span class="op" id="576952">.</span><span class="ident" id="576953">Head</span><span class="op" id="576957">(</span><span class="ident" id="576958">ts</span><span class="op" id="576960">.</span><span class="ident" id="576961">URL</span><span class="op" id="576964">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="576968">if</span>&nbsp;<span class="ident" id="576971">err</span>&nbsp;<span class="op" id="576975">!=</span>&nbsp;<span class="ident" id="576978">nil</span>&nbsp;<span class="op" id="576982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="576987">t</span><span class="op" id="576988">.</span><span class="ident" id="576989">Errorf</span><span class="op" id="576995">(</span><span class="string" id="576996">&#34;error&nbsp;on&nbsp;loop&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="577018">,</span>&nbsp;<span class="ident" id="577020">i</span><span class="op" id="577021">,</span>&nbsp;<span class="ident" id="577023">err</span><span class="op" id="577026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577031">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577046">if</span>&nbsp;<span class="ident" id="577049">e</span><span class="op" id="577050">,</span>&nbsp;<span class="ident" id="577052">g</span>&nbsp;<span class="op" id="577054">:=</span>&nbsp;<span class="string" id="577057">&#34;123&#34;</span><span class="op" id="577062">,</span>&nbsp;<span class="ident" id="577064">res</span><span class="op" id="577067">.</span><span class="ident" id="577068">Header</span><span class="op" id="577074">.</span><span class="ident" id="577075">Get</span><span class="op" id="577078">(</span><span class="string" id="577079">&#34;Content-Length&#34;</span><span class="op" id="577095">)</span><span class="op" id="577096">;</span>&nbsp;<span class="ident" id="577098">e</span>&nbsp;<span class="op" id="577100">!=</span>&nbsp;<span class="ident" id="577103">g</span>&nbsp;<span class="op" id="577105">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577110">t</span><span class="op" id="577111">.</span><span class="ident" id="577112">Errorf</span><span class="op" id="577118">(</span><span class="string" id="577119">&#34;loop&nbsp;%d:&nbsp;expected&nbsp;Content-Length&nbsp;header&nbsp;of&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="577174">,</span>&nbsp;<span class="ident" id="577176">i</span><span class="op" id="577177">,</span>&nbsp;<span class="ident" id="577179">e</span><span class="op" id="577180">,</span>&nbsp;<span class="ident" id="577182">g</span><span class="op" id="577183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577191">if</span>&nbsp;<span class="ident" id="577194">e</span><span class="op" id="577195">,</span>&nbsp;<span class="ident" id="577197">g</span>&nbsp;<span class="op" id="577199">:=</span>&nbsp;<span class="ident" id="577202">int64</span><span class="op" id="577207">(</span><span class="num" id="577208">123</span><span class="op" id="577211">)</span><span class="op" id="577212">,</span>&nbsp;<span class="ident" id="577214">res</span><span class="op" id="577217">.</span><span class="ident" id="577218">ContentLength</span><span class="op" id="577231">;</span>&nbsp;<span class="ident" id="577233">e</span>&nbsp;<span class="op" id="577235">!=</span>&nbsp;<span class="ident" id="577238">g</span>&nbsp;<span class="op" id="577240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577245">t</span><span class="op" id="577246">.</span><span class="ident" id="577247">Errorf</span><span class="op" id="577253">(</span><span class="string" id="577254">&#34;loop&nbsp;%d:&nbsp;expected&nbsp;res.ContentLength&nbsp;of&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="577305">,</span>&nbsp;<span class="ident" id="577307">i</span><span class="op" id="577308">,</span>&nbsp;<span class="ident" id="577310">e</span><span class="op" id="577311">,</span>&nbsp;<span class="ident" id="577313">g</span><span class="op" id="577314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577318">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577322">if</span>&nbsp;<span class="ident" id="577325">all</span><span class="op" id="577328">,</span>&nbsp;<span class="ident" id="577330">err</span>&nbsp;<span class="op" id="577334">:=</span>&nbsp;<span class="ident" id="577337">ioutil</span><span class="op" id="577343">.</span><span class="ident" id="577344">ReadAll</span><span class="op" id="577351">(</span><span class="ident" id="577352">res</span><span class="op" id="577355">.</span><span class="ident" id="577356">Body</span><span class="op" id="577360">)</span><span class="op" id="577361">;</span>&nbsp;<span class="ident" id="577363">err</span>&nbsp;<span class="op" id="577367">!=</span>&nbsp;<span class="ident" id="577370">nil</span>&nbsp;<span class="op" id="577374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577379">t</span><span class="op" id="577380">.</span><span class="ident" id="577381">Errorf</span><span class="op" id="577387">(</span><span class="string" id="577388">&#34;loop&nbsp;%d:&nbsp;Body&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="577415">,</span>&nbsp;<span class="ident" id="577417">i</span><span class="op" id="577418">,</span>&nbsp;<span class="ident" id="577420">err</span><span class="op" id="577423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577427">}</span>&nbsp;<span class="keyword" id="577429">else</span>&nbsp;<span class="keyword" id="577434">if</span>&nbsp;<span class="builtinfunc" id="577437">len</span><span class="op" id="577440">(</span><span class="ident" id="577441">all</span><span class="op" id="577444">)</span>&nbsp;<span class="op" id="577446">!=</span>&nbsp;<span class="num" id="577449">0</span>&nbsp;<span class="op" id="577451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577456">t</span><span class="op" id="577457">.</span><span class="ident" id="577458">Errorf</span><span class="op" id="577464">(</span><span class="string" id="577465">&#34;Bogus&nbsp;body&nbsp;%q&#34;</span><span class="op" id="577480">,</span>&nbsp;<span class="ident" id="577482">all</span><span class="op" id="577485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577489">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577492">}</span><br>
<span class="lineno"></span><span class="op" id="577494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="577497">//&nbsp;TestTransportHeadChunkedResponse&nbsp;verifies&nbsp;that&nbsp;we&nbsp;ignore&nbsp;chunked&nbsp;transfer-encoding</span><br>
<span class="lineno"></span><span class="comment" id="577583">//&nbsp;on&nbsp;responses&nbsp;to&nbsp;HEAD&nbsp;requests.</span><br>
<span class="lineno">555</span><span class="keyword" id="577617">func</span>&nbsp;<span class="ident" id="577622">TestTransportHeadChunkedResponse</span><span class="op" id="577654">(</span><span class="ident" id="577655">t</span>&nbsp;<span class="op" id="577657">*</span><span class="ident" id="577658">testing</span><span class="op" id="577665">.</span><span class="ident" id="577666">T</span><span class="op" id="577667">)</span>&nbsp;<span class="op" id="577669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577672">defer</span>&nbsp;<span class="ident" id="577678">afterTest</span><span class="op" id="577687">(</span><span class="ident" id="577688">t</span><span class="op" id="577689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577692">ts</span>&nbsp;<span class="op" id="577695">:=</span>&nbsp;<span class="ident" id="577698">httptest</span><span class="op" id="577706">.</span><span class="ident" id="577707">NewServer</span><span class="op" id="577716">(</span><span class="ident" id="577717">HandlerFunc</span><span class="op" id="577728">(</span><span class="keyword" id="577729">func</span><span class="op" id="577733">(</span><span class="ident" id="577734">w</span>&nbsp;<span class="ident" id="577736">ResponseWriter</span><span class="op" id="577750">,</span>&nbsp;<span class="ident" id="577752">r</span>&nbsp;<span class="op" id="577754">*</span><span class="ident" id="577755">Request</span><span class="op" id="577762">)</span>&nbsp;<span class="op" id="577764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577768">if</span>&nbsp;<span class="ident" id="577771">r</span><span class="op" id="577772">.</span><span class="ident" id="577773">Method</span>&nbsp;<span class="op" id="577780">!=</span>&nbsp;<span class="string" id="577783">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="577790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="577795">panic</span><span class="op" id="577800">(</span><span class="string" id="577801">&#34;expected&nbsp;HEAD;&nbsp;got&nbsp;&#34;</span>&nbsp;<span class="op" id="577823">+</span>&nbsp;<span class="ident" id="577825">r</span><span class="op" id="577826">.</span><span class="ident" id="577827">Method</span><span class="op" id="577833">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577841">w</span><span class="op" id="577842">.</span><span class="ident" id="577843">Header</span><span class="op" id="577849">(</span><span class="op" id="577850">)</span><span class="op" id="577851">.</span><span class="ident" id="577852">Set</span><span class="op" id="577855">(</span><span class="string" id="577856">&#34;Transfer-Encoding&#34;</span><span class="op" id="577875">,</span>&nbsp;<span class="string" id="577877">&#34;chunked&#34;</span><span class="op" id="577886">)</span>&nbsp;<span class="comment" id="577888">//&nbsp;client&nbsp;should&nbsp;ignore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577914">w</span><span class="op" id="577915">.</span><span class="ident" id="577916">Header</span><span class="op" id="577922">(</span><span class="op" id="577923">)</span><span class="op" id="577924">.</span><span class="ident" id="577925">Set</span><span class="op" id="577928">(</span><span class="string" id="577929">&#34;x-client-ipport&#34;</span><span class="op" id="577946">,</span>&nbsp;<span class="ident" id="577948">r</span><span class="op" id="577949">.</span><span class="ident" id="577950">RemoteAddr</span><span class="op" id="577960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="577964">w</span><span class="op" id="577965">.</span><span class="ident" id="577966">WriteHeader</span><span class="op" id="577977">(</span><span class="num" id="577978">200</span><span class="op" id="577981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="577984">}</span><span class="op" id="577985">)</span><span class="op" id="577986">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="577989">defer</span>&nbsp;<span class="ident" id="577995">ts</span><span class="op" id="577997">.</span><span class="ident" id="577998">Close</span><span class="op" id="578003">(</span><span class="op" id="578004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578008">tr</span>&nbsp;<span class="op" id="578011">:=</span>&nbsp;<span class="op" id="578014">&amp;</span><span class="ident" id="578015">Transport</span><span class="op" id="578024">{</span><span class="ident" id="578025">DisableKeepAlives</span><span class="op" id="578042">:</span>&nbsp;<span class="builtintype" id="578044">false</span><span class="op" id="578049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578052">c</span>&nbsp;<span class="op" id="578054">:=</span>&nbsp;<span class="op" id="578057">&amp;</span><span class="ident" id="578058">Client</span><span class="op" id="578064">{</span><span class="ident" id="578065">Transport</span><span class="op" id="578074">:</span>&nbsp;<span class="ident" id="578076">tr</span><span class="op" id="578078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578082">res1</span><span class="op" id="578086">,</span>&nbsp;<span class="ident" id="578088">err</span>&nbsp;<span class="op" id="578092">:=</span>&nbsp;<span class="ident" id="578095">c</span><span class="op" id="578096">.</span><span class="ident" id="578097">Head</span><span class="op" id="578101">(</span><span class="ident" id="578102">ts</span><span class="op" id="578104">.</span><span class="ident" id="578105">URL</span><span class="op" id="578108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="578111">if</span>&nbsp;<span class="ident" id="578114">err</span>&nbsp;<span class="op" id="578118">!=</span>&nbsp;<span class="ident" id="578121">nil</span>&nbsp;<span class="op" id="578125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578129">t</span><span class="op" id="578130">.</span><span class="ident" id="578131">Fatalf</span><span class="op" id="578137">(</span><span class="string" id="578138">&#34;request&nbsp;1&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="578159">,</span>&nbsp;<span class="ident" id="578161">err</span><span class="op" id="578164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="578167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578170">res2</span><span class="op" id="578174">,</span>&nbsp;<span class="ident" id="578176">err</span>&nbsp;<span class="op" id="578180">:=</span>&nbsp;<span class="ident" id="578183">c</span><span class="op" id="578184">.</span><span class="ident" id="578185">Head</span><span class="op" id="578189">(</span><span class="ident" id="578190">ts</span><span class="op" id="578192">.</span><span class="ident" id="578193">URL</span><span class="op" id="578196">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="578199">if</span>&nbsp;<span class="ident" id="578202">err</span>&nbsp;<span class="op" id="578206">!=</span>&nbsp;<span class="ident" id="578209">nil</span>&nbsp;<span class="op" id="578213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578217">t</span><span class="op" id="578218">.</span><span class="ident" id="578219">Fatalf</span><span class="op" id="578225">(</span><span class="string" id="578226">&#34;request&nbsp;2&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="578247">,</span>&nbsp;<span class="ident" id="578249">err</span><span class="op" id="578252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="578255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="578258">if</span>&nbsp;<span class="ident" id="578261">v1</span><span class="op" id="578263">,</span>&nbsp;<span class="ident" id="578265">v2</span>&nbsp;<span class="op" id="578268">:=</span>&nbsp;<span class="ident" id="578271">res1</span><span class="op" id="578275">.</span><span class="ident" id="578276">Header</span><span class="op" id="578282">.</span><span class="ident" id="578283">Get</span><span class="op" id="578286">(</span><span class="string" id="578287">&#34;x-client-ipport&#34;</span><span class="op" id="578304">)</span><span class="op" id="578305">,</span>&nbsp;<span class="ident" id="578307">res2</span><span class="op" id="578311">.</span><span class="ident" id="578312">Header</span><span class="op" id="578318">.</span><span class="ident" id="578319">Get</span><span class="op" id="578322">(</span><span class="string" id="578323">&#34;x-client-ipport&#34;</span><span class="op" id="578340">)</span><span class="op" id="578341">;</span>&nbsp;<span class="ident" id="578343">v1</span>&nbsp;<span class="op" id="578346">!=</span>&nbsp;<span class="ident" id="578349">v2</span>&nbsp;<span class="op" id="578352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578356">t</span><span class="op" id="578357">.</span><span class="ident" id="578358">Errorf</span><span class="op" id="578364">(</span><span class="string" id="578365">&#34;ip/ports&nbsp;differed&nbsp;between&nbsp;head&nbsp;requests:&nbsp;%q&nbsp;vs&nbsp;%q&#34;</span><span class="op" id="578416">,</span>&nbsp;<span class="ident" id="578418">v1</span><span class="op" id="578420">,</span>&nbsp;<span class="ident" id="578422">v2</span><span class="op" id="578424">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="578427">}</span><br>
<span class="lineno"></span><span class="op" id="578429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="578432">var</span>&nbsp;<span class="ident" id="578436">roundTripTests</span>&nbsp;<span class="op" id="578451">=</span>&nbsp;<span class="op" id="578453">[</span><span class="op" id="578454">]</span><span class="keyword" id="578455">struct</span>&nbsp;<span class="op" id="578462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578465">accept</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="578478">string</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578486">expectAccept</span>&nbsp;<span class="builtintype" id="578499">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578507">compressed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="578520">bool</span><br>
<span class="lineno"></span><span class="op" id="578525">}</span><span class="op" id="578526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="578529">//&nbsp;Requests&nbsp;with&nbsp;no&nbsp;accept-encoding&nbsp;header&nbsp;use&nbsp;transparent&nbsp;compression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="578601">{</span><span class="string" id="578602">&#34;&#34;</span><span class="op" id="578604">,</span>&nbsp;<span class="string" id="578606">&#34;gzip&#34;</span><span class="op" id="578612">,</span>&nbsp;<span class="builtintype" id="578614">false</span><span class="op" id="578619">}</span><span class="op" id="578620">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="578623">//&nbsp;Requests&nbsp;with&nbsp;other&nbsp;accept-encoding&nbsp;should&nbsp;pass&nbsp;through&nbsp;unmodified</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="578694">{</span><span class="string" id="578695">&#34;foo&#34;</span><span class="op" id="578700">,</span>&nbsp;<span class="string" id="578702">&#34;foo&#34;</span><span class="op" id="578707">,</span>&nbsp;<span class="builtintype" id="578709">false</span><span class="op" id="578714">}</span><span class="op" id="578715">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="578718">//&nbsp;Requests&nbsp;with&nbsp;accept-encoding&nbsp;==&nbsp;gzip&nbsp;should&nbsp;be&nbsp;passed&nbsp;through</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="578785">{</span><span class="string" id="578786">&#34;gzip&#34;</span><span class="op" id="578792">,</span>&nbsp;<span class="string" id="578794">&#34;gzip&#34;</span><span class="op" id="578800">,</span>&nbsp;<span class="builtintype" id="578802">true</span><span class="op" id="578806">}</span><span class="op" id="578807">,</span><br>
<span class="lineno"></span><span class="op" id="578809">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span><span class="comment" id="578812">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;modification&nbsp;made&nbsp;to&nbsp;the&nbsp;Request&nbsp;by&nbsp;the&nbsp;RoundTripper&nbsp;is&nbsp;cleaned&nbsp;up</span><br>
<span class="lineno"></span><span class="keyword" id="578896">func</span>&nbsp;<span class="ident" id="578901">TestRoundTripGzip</span><span class="op" id="578918">(</span><span class="ident" id="578919">t</span>&nbsp;<span class="op" id="578921">*</span><span class="ident" id="578922">testing</span><span class="op" id="578929">.</span><span class="ident" id="578930">T</span><span class="op" id="578931">)</span>&nbsp;<span class="op" id="578933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="578936">defer</span>&nbsp;<span class="ident" id="578942">afterTest</span><span class="op" id="578951">(</span><span class="ident" id="578952">t</span><span class="op" id="578953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="578956">const</span>&nbsp;<span class="ident" id="578962">responseBody</span>&nbsp;<span class="op" id="578975">=</span>&nbsp;<span class="string" id="578977">&#34;test&nbsp;response&nbsp;body&#34;</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="578999">ts</span>&nbsp;<span class="op" id="579002">:=</span>&nbsp;<span class="ident" id="579005">httptest</span><span class="op" id="579013">.</span><span class="ident" id="579014">NewServer</span><span class="op" id="579023">(</span><span class="ident" id="579024">HandlerFunc</span><span class="op" id="579035">(</span><span class="keyword" id="579036">func</span><span class="op" id="579040">(</span><span class="ident" id="579041">rw</span>&nbsp;<span class="ident" id="579044">ResponseWriter</span><span class="op" id="579058">,</span>&nbsp;<span class="ident" id="579060">req</span>&nbsp;<span class="op" id="579064">*</span><span class="ident" id="579065">Request</span><span class="op" id="579072">)</span>&nbsp;<span class="op" id="579074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579078">accept</span>&nbsp;<span class="op" id="579085">:=</span>&nbsp;<span class="ident" id="579088">req</span><span class="op" id="579091">.</span><span class="ident" id="579092">Header</span><span class="op" id="579098">.</span><span class="ident" id="579099">Get</span><span class="op" id="579102">(</span><span class="string" id="579103">&#34;Accept-Encoding&#34;</span><span class="op" id="579120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579124">if</span>&nbsp;<span class="ident" id="579127">expect</span>&nbsp;<span class="op" id="579134">:=</span>&nbsp;<span class="ident" id="579137">req</span><span class="op" id="579140">.</span><span class="ident" id="579141">FormValue</span><span class="op" id="579150">(</span><span class="string" id="579151">&#34;expect_accept&#34;</span><span class="op" id="579166">)</span><span class="op" id="579167">;</span>&nbsp;<span class="ident" id="579169">accept</span>&nbsp;<span class="op" id="579176">!=</span>&nbsp;<span class="ident" id="579179">expect</span>&nbsp;<span class="op" id="579186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579191">t</span><span class="op" id="579192">.</span><span class="ident" id="579193">Errorf</span><span class="op" id="579199">(</span><span class="string" id="579200">&#34;in&nbsp;handler,&nbsp;test&nbsp;%v:&nbsp;Accept-Encoding&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="579252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579258">req</span><span class="op" id="579261">.</span><span class="ident" id="579262">FormValue</span><span class="op" id="579271">(</span><span class="string" id="579272">&#34;testnum&#34;</span><span class="op" id="579281">)</span><span class="op" id="579282">,</span>&nbsp;<span class="ident" id="579284">accept</span><span class="op" id="579290">,</span>&nbsp;<span class="ident" id="579292">expect</span><span class="op" id="579298">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="579302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579306">if</span>&nbsp;<span class="ident" id="579309">accept</span>&nbsp;<span class="op" id="579316">==</span>&nbsp;<span class="string" id="579319">&#34;gzip&#34;</span>&nbsp;<span class="op" id="579326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579331">rw</span><span class="op" id="579333">.</span><span class="ident" id="579334">Header</span><span class="op" id="579340">(</span><span class="op" id="579341">)</span><span class="op" id="579342">.</span><span class="ident" id="579343">Set</span><span class="op" id="579346">(</span><span class="string" id="579347">&#34;Content-Encoding&#34;</span><span class="op" id="579365">,</span>&nbsp;<span class="string" id="579367">&#34;gzip&#34;</span><span class="op" id="579373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579378">gz</span>&nbsp;<span class="op" id="579381">:=</span>&nbsp;<span class="ident" id="579384">gzip</span><span class="op" id="579388">.</span><span class="ident" id="579389">NewWriter</span><span class="op" id="579398">(</span><span class="ident" id="579399">rw</span><span class="op" id="579401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579406">gz</span><span class="op" id="579408">.</span><span class="ident" id="579409">Write</span><span class="op" id="579414">(</span><span class="op" id="579415">[</span><span class="op" id="579416">]</span><span class="builtintype" id="579417">byte</span><span class="op" id="579421">(</span><span class="ident" id="579422">responseBody</span><span class="op" id="579434">)</span><span class="op" id="579435">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579440">gz</span><span class="op" id="579442">.</span><span class="ident" id="579443">Close</span><span class="op" id="579448">(</span><span class="op" id="579449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="579453">}</span>&nbsp;<span class="keyword" id="579455">else</span>&nbsp;<span class="op" id="579460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579465">rw</span><span class="op" id="579467">.</span><span class="ident" id="579468">Header</span><span class="op" id="579474">(</span><span class="op" id="579475">)</span><span class="op" id="579476">.</span><span class="ident" id="579477">Set</span><span class="op" id="579480">(</span><span class="string" id="579481">&#34;Content-Encoding&#34;</span><span class="op" id="579499">,</span>&nbsp;<span class="ident" id="579501">accept</span><span class="op" id="579507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579512">rw</span><span class="op" id="579514">.</span><span class="ident" id="579515">Write</span><span class="op" id="579520">(</span><span class="op" id="579521">[</span><span class="op" id="579522">]</span><span class="builtintype" id="579523">byte</span><span class="op" id="579527">(</span><span class="ident" id="579528">responseBody</span><span class="op" id="579540">)</span><span class="op" id="579541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="579545">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="579548">}</span><span class="op" id="579549">)</span><span class="op" id="579550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579553">defer</span>&nbsp;<span class="ident" id="579559">ts</span><span class="op" id="579561">.</span><span class="ident" id="579562">Close</span><span class="op" id="579567">(</span><span class="op" id="579568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579572">for</span>&nbsp;<span class="ident" id="579576">i</span><span class="op" id="579577">,</span>&nbsp;<span class="ident" id="579579">test</span>&nbsp;<span class="op" id="579584">:=</span>&nbsp;<span class="keyword" id="579587">range</span>&nbsp;<span class="ident" id="579593">roundTripTests</span>&nbsp;<span class="op" id="579608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="579612">//&nbsp;Test&nbsp;basic&nbsp;request&nbsp;(no&nbsp;accept-encoding)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579657">req</span><span class="op" id="579660">,</span>&nbsp;<span class="ident" id="579662">_</span>&nbsp;<span class="op" id="579664">:=</span>&nbsp;<span class="ident" id="579667">NewRequest</span><span class="op" id="579677">(</span><span class="string" id="579678">&#34;GET&#34;</span><span class="op" id="579683">,</span>&nbsp;<span class="ident" id="579685">fmt</span><span class="op" id="579688">.</span><span class="ident" id="579689">Sprintf</span><span class="op" id="579696">(</span><span class="string" id="579697">&#34;%s/?testnum=%d&amp;expect_accept=%s&#34;</span><span class="op" id="579730">,</span>&nbsp;<span class="ident" id="579732">ts</span><span class="op" id="579734">.</span><span class="ident" id="579735">URL</span><span class="op" id="579738">,</span>&nbsp;<span class="ident" id="579740">i</span><span class="op" id="579741">,</span>&nbsp;<span class="ident" id="579743">test</span><span class="op" id="579747">.</span><span class="ident" id="579748">expectAccept</span><span class="op" id="579760">)</span><span class="op" id="579761">,</span>&nbsp;<span class="ident" id="579763">nil</span><span class="op" id="579766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579770">if</span>&nbsp;<span class="ident" id="579773">test</span><span class="op" id="579777">.</span><span class="ident" id="579778">accept</span>&nbsp;<span class="op" id="579785">!=</span>&nbsp;<span class="string" id="579788">&#34;&#34;</span>&nbsp;<span class="op" id="579791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579796">req</span><span class="op" id="579799">.</span><span class="ident" id="579800">Header</span><span class="op" id="579806">.</span><span class="ident" id="579807">Set</span><span class="op" id="579810">(</span><span class="string" id="579811">&#34;Accept-Encoding&#34;</span><span class="op" id="579828">,</span>&nbsp;<span class="ident" id="579830">test</span><span class="op" id="579834">.</span><span class="ident" id="579835">accept</span><span class="op" id="579841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="579845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579849">res</span><span class="op" id="579852">,</span>&nbsp;<span class="ident" id="579854">err</span>&nbsp;<span class="op" id="579858">:=</span>&nbsp;<span class="ident" id="579861">DefaultTransport</span><span class="op" id="579877">.</span><span class="ident" id="579878">RoundTrip</span><span class="op" id="579887">(</span><span class="ident" id="579888">req</span><span class="op" id="579891">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579895">var</span>&nbsp;<span class="ident" id="579899">body</span>&nbsp;<span class="op" id="579904">[</span><span class="op" id="579905">]</span><span class="builtintype" id="579906">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579913">if</span>&nbsp;<span class="ident" id="579916">test</span><span class="op" id="579920">.</span><span class="ident" id="579921">compressed</span>&nbsp;<span class="op" id="579932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579937">var</span>&nbsp;<span class="ident" id="579941">r</span>&nbsp;<span class="op" id="579943">*</span><span class="ident" id="579944">gzip</span><span class="op" id="579948">.</span><span class="ident" id="579949">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="579959">r</span><span class="op" id="579960">,</span>&nbsp;<span class="ident" id="579962">err</span>&nbsp;<span class="op" id="579966">=</span>&nbsp;<span class="ident" id="579968">gzip</span><span class="op" id="579972">.</span><span class="ident" id="579973">NewReader</span><span class="op" id="579982">(</span><span class="ident" id="579983">res</span><span class="op" id="579986">.</span><span class="ident" id="579987">Body</span><span class="op" id="579991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="579996">if</span>&nbsp;<span class="ident" id="579999">err</span>&nbsp;<span class="op" id="580003">!=</span>&nbsp;<span class="ident" id="580006">nil</span>&nbsp;<span class="op" id="580010">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580016">t</span><span class="op" id="580017">.</span><span class="ident" id="580018">Errorf</span><span class="op" id="580024">(</span><span class="string" id="580025">&#34;%d.&nbsp;gzip&nbsp;NewReader:&nbsp;%v&#34;</span><span class="op" id="580049">,</span>&nbsp;<span class="ident" id="580051">i</span><span class="op" id="580052">,</span>&nbsp;<span class="ident" id="580054">err</span><span class="op" id="580057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580063">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580080">body</span><span class="op" id="580084">,</span>&nbsp;<span class="ident" id="580086">err</span>&nbsp;<span class="op" id="580090">=</span>&nbsp;<span class="ident" id="580092">ioutil</span><span class="op" id="580098">.</span><span class="ident" id="580099">ReadAll</span><span class="op" id="580106">(</span><span class="ident" id="580107">r</span><span class="op" id="580108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580113">res</span><span class="op" id="580116">.</span><span class="ident" id="580117">Body</span><span class="op" id="580121">.</span><span class="ident" id="580122">Close</span><span class="op" id="580127">(</span><span class="op" id="580128">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580132">}</span>&nbsp;<span class="keyword" id="580134">else</span>&nbsp;<span class="op" id="580139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580144">body</span><span class="op" id="580148">,</span>&nbsp;<span class="ident" id="580150">err</span>&nbsp;<span class="op" id="580154">=</span>&nbsp;<span class="ident" id="580156">ioutil</span><span class="op" id="580162">.</span><span class="ident" id="580163">ReadAll</span><span class="op" id="580170">(</span><span class="ident" id="580171">res</span><span class="op" id="580174">.</span><span class="ident" id="580175">Body</span><span class="op" id="580179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580187">if</span>&nbsp;<span class="ident" id="580190">err</span>&nbsp;<span class="op" id="580194">!=</span>&nbsp;<span class="ident" id="580197">nil</span>&nbsp;<span class="op" id="580201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580206">t</span><span class="op" id="580207">.</span><span class="ident" id="580208">Errorf</span><span class="op" id="580214">(</span><span class="string" id="580215">&#34;%d.&nbsp;Error:&nbsp;%q&#34;</span><span class="op" id="580230">,</span>&nbsp;<span class="ident" id="580232">i</span><span class="op" id="580233">,</span>&nbsp;<span class="ident" id="580235">err</span><span class="op" id="580238">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580243">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580258">if</span>&nbsp;<span class="ident" id="580261">g</span><span class="op" id="580262">,</span>&nbsp;<span class="ident" id="580264">e</span>&nbsp;<span class="op" id="580266">:=</span>&nbsp;<span class="builtintype" id="580269">string</span><span class="op" id="580275">(</span><span class="ident" id="580276">body</span><span class="op" id="580280">)</span><span class="op" id="580281">,</span>&nbsp;<span class="ident" id="580283">responseBody</span><span class="op" id="580295">;</span>&nbsp;<span class="ident" id="580297">g</span>&nbsp;<span class="op" id="580299">!=</span>&nbsp;<span class="ident" id="580302">e</span>&nbsp;<span class="op" id="580304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580309">t</span><span class="op" id="580310">.</span><span class="ident" id="580311">Errorf</span><span class="op" id="580317">(</span><span class="string" id="580318">&#34;%d.&nbsp;body&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="580342">,</span>&nbsp;<span class="ident" id="580344">i</span><span class="op" id="580345">,</span>&nbsp;<span class="ident" id="580347">g</span><span class="op" id="580348">,</span>&nbsp;<span class="ident" id="580350">e</span><span class="op" id="580351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580355">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580359">if</span>&nbsp;<span class="ident" id="580362">g</span><span class="op" id="580363">,</span>&nbsp;<span class="ident" id="580365">e</span>&nbsp;<span class="op" id="580367">:=</span>&nbsp;<span class="ident" id="580370">req</span><span class="op" id="580373">.</span><span class="ident" id="580374">Header</span><span class="op" id="580380">.</span><span class="ident" id="580381">Get</span><span class="op" id="580384">(</span><span class="string" id="580385">&#34;Accept-Encoding&#34;</span><span class="op" id="580402">)</span><span class="op" id="580403">,</span>&nbsp;<span class="ident" id="580405">test</span><span class="op" id="580409">.</span><span class="ident" id="580410">accept</span><span class="op" id="580416">;</span>&nbsp;<span class="ident" id="580418">g</span>&nbsp;<span class="op" id="580420">!=</span>&nbsp;<span class="ident" id="580423">e</span>&nbsp;<span class="op" id="580425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580430">t</span><span class="op" id="580431">.</span><span class="ident" id="580432">Errorf</span><span class="op" id="580438">(</span><span class="string" id="580439">&#34;%d.&nbsp;Accept-Encoding&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&nbsp;(it&nbsp;was&nbsp;mutated,&nbsp;in&nbsp;violation&nbsp;of&nbsp;RoundTrip&nbsp;contract)&#34;</span><span class="op" id="580527">,</span>&nbsp;<span class="ident" id="580529">i</span><span class="op" id="580530">,</span>&nbsp;<span class="ident" id="580532">g</span><span class="op" id="580533">,</span>&nbsp;<span class="ident" id="580535">e</span><span class="op" id="580536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580544">if</span>&nbsp;<span class="ident" id="580547">g</span><span class="op" id="580548">,</span>&nbsp;<span class="ident" id="580550">e</span>&nbsp;<span class="op" id="580552">:=</span>&nbsp;<span class="ident" id="580555">res</span><span class="op" id="580558">.</span><span class="ident" id="580559">Header</span><span class="op" id="580565">.</span><span class="ident" id="580566">Get</span><span class="op" id="580569">(</span><span class="string" id="580570">&#34;Content-Encoding&#34;</span><span class="op" id="580588">)</span><span class="op" id="580589">,</span>&nbsp;<span class="ident" id="580591">test</span><span class="op" id="580595">.</span><span class="ident" id="580596">accept</span><span class="op" id="580602">;</span>&nbsp;<span class="ident" id="580604">g</span>&nbsp;<span class="op" id="580606">!=</span>&nbsp;<span class="ident" id="580609">e</span>&nbsp;<span class="op" id="580611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580616">t</span><span class="op" id="580617">.</span><span class="ident" id="580618">Errorf</span><span class="op" id="580624">(</span><span class="string" id="580625">&#34;%d.&nbsp;Content-Encoding&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="580661">,</span>&nbsp;<span class="ident" id="580663">i</span><span class="op" id="580664">,</span>&nbsp;<span class="ident" id="580666">g</span><span class="op" id="580667">,</span>&nbsp;<span class="ident" id="580669">e</span><span class="op" id="580670">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="580677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="580680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">655</span><span class="keyword" id="580683">func</span>&nbsp;<span class="ident" id="580688">TestTransportGzip</span><span class="op" id="580705">(</span><span class="ident" id="580706">t</span>&nbsp;<span class="op" id="580708">*</span><span class="ident" id="580709">testing</span><span class="op" id="580716">.</span><span class="ident" id="580717">T</span><span class="op" id="580718">)</span>&nbsp;<span class="op" id="580720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580723">defer</span>&nbsp;<span class="ident" id="580729">afterTest</span><span class="op" id="580738">(</span><span class="ident" id="580739">t</span><span class="op" id="580740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580743">const</span>&nbsp;<span class="ident" id="580749">testString</span>&nbsp;<span class="op" id="580760">=</span>&nbsp;<span class="string" id="580762">&#34;The&nbsp;test&nbsp;string&nbsp;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580825">const</span>&nbsp;<span class="ident" id="580831">nRandBytes</span>&nbsp;<span class="op" id="580842">=</span>&nbsp;<span class="num" id="580844">1024</span>&nbsp;<span class="op" id="580849">*</span>&nbsp;<span class="num" id="580851">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="580857">ts</span>&nbsp;<span class="op" id="580860">:=</span>&nbsp;<span class="ident" id="580863">httptest</span><span class="op" id="580871">.</span><span class="ident" id="580872">NewServer</span><span class="op" id="580881">(</span><span class="ident" id="580882">HandlerFunc</span><span class="op" id="580893">(</span><span class="keyword" id="580894">func</span><span class="op" id="580898">(</span><span class="ident" id="580899">rw</span>&nbsp;<span class="ident" id="580902">ResponseWriter</span><span class="op" id="580916">,</span>&nbsp;<span class="ident" id="580918">req</span>&nbsp;<span class="op" id="580922">*</span><span class="ident" id="580923">Request</span><span class="op" id="580930">)</span>&nbsp;<span class="op" id="580932">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580936">if</span>&nbsp;<span class="ident" id="580939">req</span><span class="op" id="580942">.</span><span class="ident" id="580943">Method</span>&nbsp;<span class="op" id="580950">==</span>&nbsp;<span class="string" id="580953">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="580960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="580965">if</span>&nbsp;<span class="ident" id="580968">g</span>&nbsp;<span class="op" id="580970">:=</span>&nbsp;<span class="ident" id="580973">req</span><span class="op" id="580976">.</span><span class="ident" id="580977">Header</span><span class="op" id="580983">.</span><span class="ident" id="580984">Get</span><span class="op" id="580987">(</span><span class="string" id="580988">&#34;Accept-Encoding&#34;</span><span class="op" id="581005">)</span><span class="op" id="581006">;</span>&nbsp;<span class="ident" id="581008">g</span>&nbsp;<span class="op" id="581010">!=</span>&nbsp;<span class="string" id="581013">&#34;&#34;</span>&nbsp;<span class="op" id="581016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581022">t</span><span class="op" id="581023">.</span><span class="ident" id="581024">Errorf</span><span class="op" id="581030">(</span><span class="string" id="581031">&#34;HEAD&nbsp;request&nbsp;sent&nbsp;with&nbsp;Accept-Encoding&nbsp;of&nbsp;%q;&nbsp;want&nbsp;none&#34;</span><span class="op" id="581088">,</span>&nbsp;<span class="ident" id="581090">g</span><span class="op" id="581091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581101">return</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581114">if</span>&nbsp;<span class="ident" id="581117">g</span><span class="op" id="581118">,</span>&nbsp;<span class="ident" id="581120">e</span>&nbsp;<span class="op" id="581122">:=</span>&nbsp;<span class="ident" id="581125">req</span><span class="op" id="581128">.</span><span class="ident" id="581129">Header</span><span class="op" id="581135">.</span><span class="ident" id="581136">Get</span><span class="op" id="581139">(</span><span class="string" id="581140">&#34;Accept-Encoding&#34;</span><span class="op" id="581157">)</span><span class="op" id="581158">,</span>&nbsp;<span class="string" id="581160">&#34;gzip&#34;</span><span class="op" id="581166">;</span>&nbsp;<span class="ident" id="581168">g</span>&nbsp;<span class="op" id="581170">!=</span>&nbsp;<span class="ident" id="581173">e</span>&nbsp;<span class="op" id="581175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581180">t</span><span class="op" id="581181">.</span><span class="ident" id="581182">Errorf</span><span class="op" id="581188">(</span><span class="string" id="581189">&#34;Accept-Encoding&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="581220">,</span>&nbsp;<span class="ident" id="581222">g</span><span class="op" id="581223">,</span>&nbsp;<span class="ident" id="581225">e</span><span class="op" id="581226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581234">rw</span><span class="op" id="581236">.</span><span class="ident" id="581237">Header</span><span class="op" id="581243">(</span><span class="op" id="581244">)</span><span class="op" id="581245">.</span><span class="ident" id="581246">Set</span><span class="op" id="581249">(</span><span class="string" id="581250">&#34;Content-Encoding&#34;</span><span class="op" id="581268">,</span>&nbsp;<span class="string" id="581270">&#34;gzip&#34;</span><span class="op" id="581276">)</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581281">var</span>&nbsp;<span class="ident" id="581285">w</span>&nbsp;<span class="ident" id="581287">io</span><span class="op" id="581289">.</span><span class="ident" id="581290">Writer</span>&nbsp;<span class="op" id="581297">=</span>&nbsp;<span class="ident" id="581299">rw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581304">var</span>&nbsp;<span class="ident" id="581308">buf</span>&nbsp;<span class="ident" id="581312">bytes</span><span class="op" id="581317">.</span><span class="ident" id="581318">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581327">if</span>&nbsp;<span class="ident" id="581330">req</span><span class="op" id="581333">.</span><span class="ident" id="581334">FormValue</span><span class="op" id="581343">(</span><span class="string" id="581344">&#34;chunked&#34;</span><span class="op" id="581353">)</span>&nbsp;<span class="op" id="581355">==</span>&nbsp;<span class="string" id="581358">&#34;0&#34;</span>&nbsp;<span class="op" id="581362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581367">w</span>&nbsp;<span class="op" id="581369">=</span>&nbsp;<span class="op" id="581371">&amp;</span><span class="ident" id="581372">buf</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581379">defer</span>&nbsp;<span class="ident" id="581385">io</span><span class="op" id="581387">.</span><span class="ident" id="581388">Copy</span><span class="op" id="581392">(</span><span class="ident" id="581393">rw</span><span class="op" id="581395">,</span>&nbsp;<span class="op" id="581397">&amp;</span><span class="ident" id="581398">buf</span><span class="op" id="581401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581406">defer</span>&nbsp;<span class="keyword" id="581412">func</span><span class="op" id="581416">(</span><span class="op" id="581417">)</span>&nbsp;<span class="op" id="581419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581425">rw</span><span class="op" id="581427">.</span><span class="ident" id="581428">Header</span><span class="op" id="581434">(</span><span class="op" id="581435">)</span><span class="op" id="581436">.</span><span class="ident" id="581437">Set</span><span class="op" id="581440">(</span><span class="string" id="581441">&#34;Content-Length&#34;</span><span class="op" id="581457">,</span>&nbsp;<span class="ident" id="581459">strconv</span><span class="op" id="581466">.</span><span class="ident" id="581467">Itoa</span><span class="op" id="581471">(</span><span class="ident" id="581472">buf</span><span class="op" id="581475">.</span><span class="ident" id="581476">Len</span><span class="op" id="581479">(</span><span class="op" id="581480">)</span><span class="op" id="581481">)</span><span class="op" id="581482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581487">}</span><span class="op" id="581488">(</span><span class="op" id="581489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581493">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581497">gz</span>&nbsp;<span class="op" id="581500">:=</span>&nbsp;<span class="ident" id="581503">gzip</span><span class="op" id="581507">.</span><span class="ident" id="581508">NewWriter</span><span class="op" id="581517">(</span><span class="ident" id="581518">w</span><span class="op" id="581519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581523">gz</span><span class="op" id="581525">.</span><span class="ident" id="581526">Write</span><span class="op" id="581531">(</span><span class="op" id="581532">[</span><span class="op" id="581533">]</span><span class="builtintype" id="581534">byte</span><span class="op" id="581538">(</span><span class="ident" id="581539">testString</span><span class="op" id="581549">)</span><span class="op" id="581550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581554">if</span>&nbsp;<span class="ident" id="581557">req</span><span class="op" id="581560">.</span><span class="ident" id="581561">FormValue</span><span class="op" id="581570">(</span><span class="string" id="581571">&#34;body&#34;</span><span class="op" id="581577">)</span>&nbsp;<span class="op" id="581579">==</span>&nbsp;<span class="string" id="581582">&#34;large&#34;</span>&nbsp;<span class="op" id="581590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581595">io</span><span class="op" id="581597">.</span><span class="ident" id="581598">CopyN</span><span class="op" id="581603">(</span><span class="ident" id="581604">gz</span><span class="op" id="581606">,</span>&nbsp;<span class="ident" id="581608">rand</span><span class="op" id="581612">.</span><span class="ident" id="581613">Reader</span><span class="op" id="581619">,</span>&nbsp;<span class="ident" id="581621">nRandBytes</span><span class="op" id="581631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581635">}</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581639">gz</span><span class="op" id="581641">.</span><span class="ident" id="581642">Close</span><span class="op" id="581647">(</span><span class="op" id="581648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581651">}</span><span class="op" id="581652">)</span><span class="op" id="581653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581656">defer</span>&nbsp;<span class="ident" id="581662">ts</span><span class="op" id="581664">.</span><span class="ident" id="581665">Close</span><span class="op" id="581670">(</span><span class="op" id="581671">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581675">for</span>&nbsp;<span class="ident" id="581679">_</span><span class="op" id="581680">,</span>&nbsp;<span class="ident" id="581682">chunked</span>&nbsp;<span class="op" id="581690">:=</span>&nbsp;<span class="keyword" id="581693">range</span>&nbsp;<span class="op" id="581699">[</span><span class="op" id="581700">]</span><span class="builtintype" id="581701">string</span><span class="op" id="581707">{</span><span class="string" id="581708">&#34;1&#34;</span><span class="op" id="581711">,</span>&nbsp;<span class="string" id="581713">&#34;0&#34;</span><span class="op" id="581716">}</span>&nbsp;<span class="op" id="581718">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581722">c</span>&nbsp;<span class="op" id="581724">:=</span>&nbsp;<span class="op" id="581727">&amp;</span><span class="ident" id="581728">Client</span><span class="op" id="581734">{</span><span class="ident" id="581735">Transport</span><span class="op" id="581744">:</span>&nbsp;<span class="op" id="581746">&amp;</span><span class="ident" id="581747">Transport</span><span class="op" id="581756">{</span><span class="op" id="581757">}</span><span class="op" id="581758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="581763">//&nbsp;First&nbsp;fetch&nbsp;something&nbsp;large,&nbsp;but&nbsp;only&nbsp;read&nbsp;some&nbsp;of&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581823">res</span><span class="op" id="581826">,</span>&nbsp;<span class="ident" id="581828">err</span>&nbsp;<span class="op" id="581832">:=</span>&nbsp;<span class="ident" id="581835">c</span><span class="op" id="581836">.</span><span class="ident" id="581837">Get</span><span class="op" id="581840">(</span><span class="ident" id="581841">ts</span><span class="op" id="581843">.</span><span class="ident" id="581844">URL</span>&nbsp;<span class="op" id="581848">+</span>&nbsp;<span class="string" id="581850">&#34;/?body=large&amp;chunked=&#34;</span>&nbsp;<span class="op" id="581874">+</span>&nbsp;<span class="ident" id="581876">chunked</span><span class="op" id="581883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="581887">if</span>&nbsp;<span class="ident" id="581890">err</span>&nbsp;<span class="op" id="581894">!=</span>&nbsp;<span class="ident" id="581897">nil</span>&nbsp;<span class="op" id="581901">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581906">t</span><span class="op" id="581907">.</span><span class="ident" id="581908">Fatalf</span><span class="op" id="581914">(</span><span class="string" id="581915">&#34;large&nbsp;get:&nbsp;%v&#34;</span><span class="op" id="581930">,</span>&nbsp;<span class="ident" id="581932">err</span><span class="op" id="581935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="581939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581943">buf</span>&nbsp;<span class="op" id="581947">:=</span>&nbsp;<span class="builtinfunc" id="581950">make</span><span class="op" id="581954">(</span><span class="op" id="581955">[</span><span class="op" id="581956">]</span><span class="builtintype" id="581957">byte</span><span class="op" id="581961">,</span>&nbsp;<span class="builtinfunc" id="581963">len</span><span class="op" id="581966">(</span><span class="ident" id="581967">testString</span><span class="op" id="581977">)</span><span class="op" id="581978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="581982">n</span><span class="op" id="581983">,</span>&nbsp;<span class="ident" id="581985">err</span>&nbsp;<span class="op" id="581989">:=</span>&nbsp;<span class="ident" id="581992">io</span><span class="op" id="581994">.</span><span class="ident" id="581995">ReadFull</span><span class="op" id="582003">(</span><span class="ident" id="582004">res</span><span class="op" id="582007">.</span><span class="ident" id="582008">Body</span><span class="op" id="582012">,</span>&nbsp;<span class="ident" id="582014">buf</span><span class="op" id="582017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582021">if</span>&nbsp;<span class="ident" id="582024">err</span>&nbsp;<span class="op" id="582028">!=</span>&nbsp;<span class="ident" id="582031">nil</span>&nbsp;<span class="op" id="582035">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582040">t</span><span class="op" id="582041">.</span><span class="ident" id="582042">Fatalf</span><span class="op" id="582048">(</span><span class="string" id="582049">&#34;partial&nbsp;read&nbsp;of&nbsp;large&nbsp;response:&nbsp;size=%d,&nbsp;%v&#34;</span><span class="op" id="582094">,</span>&nbsp;<span class="ident" id="582096">n</span><span class="op" id="582097">,</span>&nbsp;<span class="ident" id="582099">err</span><span class="op" id="582102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582110">if</span>&nbsp;<span class="ident" id="582113">e</span><span class="op" id="582114">,</span>&nbsp;<span class="ident" id="582116">g</span>&nbsp;<span class="op" id="582118">:=</span>&nbsp;<span class="ident" id="582121">testString</span><span class="op" id="582131">,</span>&nbsp;<span class="builtintype" id="582133">string</span><span class="op" id="582139">(</span><span class="ident" id="582140">buf</span><span class="op" id="582143">)</span><span class="op" id="582144">;</span>&nbsp;<span class="ident" id="582146">e</span>&nbsp;<span class="op" id="582148">!=</span>&nbsp;<span class="ident" id="582151">g</span>&nbsp;<span class="op" id="582153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582158">t</span><span class="op" id="582159">.</span><span class="ident" id="582160">Errorf</span><span class="op" id="582166">(</span><span class="string" id="582167">&#34;partial&nbsp;read&nbsp;got&nbsp;%q,&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="582201">,</span>&nbsp;<span class="ident" id="582203">g</span><span class="op" id="582204">,</span>&nbsp;<span class="ident" id="582206">e</span><span class="op" id="582207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582211">}</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582215">res</span><span class="op" id="582218">.</span><span class="ident" id="582219">Body</span><span class="op" id="582223">.</span><span class="ident" id="582224">Close</span><span class="op" id="582229">(</span><span class="op" id="582230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="582234">//&nbsp;Read&nbsp;on&nbsp;the&nbsp;body,&nbsp;even&nbsp;though&nbsp;it&#39;s&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582281">n</span><span class="op" id="582282">,</span>&nbsp;<span class="ident" id="582284">err</span>&nbsp;<span class="op" id="582288">=</span>&nbsp;<span class="ident" id="582290">res</span><span class="op" id="582293">.</span><span class="ident" id="582294">Body</span><span class="op" id="582298">.</span><span class="ident" id="582299">Read</span><span class="op" id="582303">(</span><span class="ident" id="582304">buf</span><span class="op" id="582307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582311">if</span>&nbsp;<span class="ident" id="582314">n</span>&nbsp;<span class="op" id="582316">!=</span>&nbsp;<span class="num" id="582319">0</span>&nbsp;<span class="op" id="582321">||</span>&nbsp;<span class="ident" id="582324">err</span>&nbsp;<span class="op" id="582328">==</span>&nbsp;<span class="ident" id="582331">nil</span>&nbsp;<span class="op" id="582335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582340">t</span><span class="op" id="582341">.</span><span class="ident" id="582342">Errorf</span><span class="op" id="582348">(</span><span class="string" id="582349">&#34;expected&nbsp;error&nbsp;post-closed&nbsp;large&nbsp;Read;&nbsp;got&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="582402">,</span>&nbsp;<span class="ident" id="582404">n</span><span class="op" id="582405">,</span>&nbsp;<span class="ident" id="582407">err</span><span class="op" id="582410">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="582419">//&nbsp;Then&nbsp;something&nbsp;small.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582446">res</span><span class="op" id="582449">,</span>&nbsp;<span class="ident" id="582451">err</span>&nbsp;<span class="op" id="582455">=</span>&nbsp;<span class="ident" id="582457">c</span><span class="op" id="582458">.</span><span class="ident" id="582459">Get</span><span class="op" id="582462">(</span><span class="ident" id="582463">ts</span><span class="op" id="582465">.</span><span class="ident" id="582466">URL</span>&nbsp;<span class="op" id="582470">+</span>&nbsp;<span class="string" id="582472">&#34;/?chunked=&#34;</span>&nbsp;<span class="op" id="582485">+</span>&nbsp;<span class="ident" id="582487">chunked</span><span class="op" id="582494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582498">if</span>&nbsp;<span class="ident" id="582501">err</span>&nbsp;<span class="op" id="582505">!=</span>&nbsp;<span class="ident" id="582508">nil</span>&nbsp;<span class="op" id="582512">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582517">t</span><span class="op" id="582518">.</span><span class="ident" id="582519">Fatal</span><span class="op" id="582524">(</span><span class="ident" id="582525">err</span><span class="op" id="582528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582536">body</span><span class="op" id="582540">,</span>&nbsp;<span class="ident" id="582542">err</span>&nbsp;<span class="op" id="582546">:=</span>&nbsp;<span class="ident" id="582549">ioutil</span><span class="op" id="582555">.</span><span class="ident" id="582556">ReadAll</span><span class="op" id="582563">(</span><span class="ident" id="582564">res</span><span class="op" id="582567">.</span><span class="ident" id="582568">Body</span><span class="op" id="582572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582576">if</span>&nbsp;<span class="ident" id="582579">err</span>&nbsp;<span class="op" id="582583">!=</span>&nbsp;<span class="ident" id="582586">nil</span>&nbsp;<span class="op" id="582590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582595">t</span><span class="op" id="582596">.</span><span class="ident" id="582597">Fatal</span><span class="op" id="582602">(</span><span class="ident" id="582603">err</span><span class="op" id="582606">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582614">if</span>&nbsp;<span class="ident" id="582617">g</span><span class="op" id="582618">,</span>&nbsp;<span class="ident" id="582620">e</span>&nbsp;<span class="op" id="582622">:=</span>&nbsp;<span class="builtintype" id="582625">string</span><span class="op" id="582631">(</span><span class="ident" id="582632">body</span><span class="op" id="582636">)</span><span class="op" id="582637">,</span>&nbsp;<span class="ident" id="582639">testString</span><span class="op" id="582649">;</span>&nbsp;<span class="ident" id="582651">g</span>&nbsp;<span class="op" id="582653">!=</span>&nbsp;<span class="ident" id="582656">e</span>&nbsp;<span class="op" id="582658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582663">t</span><span class="op" id="582664">.</span><span class="ident" id="582665">Fatalf</span><span class="op" id="582671">(</span><span class="string" id="582672">&#34;body&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="582692">,</span>&nbsp;<span class="ident" id="582694">g</span><span class="op" id="582695">,</span>&nbsp;<span class="ident" id="582697">e</span><span class="op" id="582698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582706">if</span>&nbsp;<span class="ident" id="582709">g</span><span class="op" id="582710">,</span>&nbsp;<span class="ident" id="582712">e</span>&nbsp;<span class="op" id="582714">:=</span>&nbsp;<span class="ident" id="582717">res</span><span class="op" id="582720">.</span><span class="ident" id="582721">Header</span><span class="op" id="582727">.</span><span class="ident" id="582728">Get</span><span class="op" id="582731">(</span><span class="string" id="582732">&#34;Content-Encoding&#34;</span><span class="op" id="582750">)</span><span class="op" id="582751">,</span>&nbsp;<span class="string" id="582753">&#34;&#34;</span><span class="op" id="582755">;</span>&nbsp;<span class="ident" id="582757">g</span>&nbsp;<span class="op" id="582759">!=</span>&nbsp;<span class="ident" id="582762">e</span>&nbsp;<span class="op" id="582764">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582769">t</span><span class="op" id="582770">.</span><span class="ident" id="582771">Fatalf</span><span class="op" id="582777">(</span><span class="string" id="582778">&#34;Content-Encoding&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="582810">,</span>&nbsp;<span class="ident" id="582812">g</span><span class="op" id="582813">,</span>&nbsp;<span class="ident" id="582815">e</span><span class="op" id="582816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="582820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="582825">//&nbsp;Read&nbsp;on&nbsp;the&nbsp;body&nbsp;after&nbsp;it&#39;s&nbsp;been&nbsp;fully&nbsp;read:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582875">n</span><span class="op" id="582876">,</span>&nbsp;<span class="ident" id="582878">err</span>&nbsp;<span class="op" id="582882">=</span>&nbsp;<span class="ident" id="582884">res</span><span class="op" id="582887">.</span><span class="ident" id="582888">Body</span><span class="op" id="582892">.</span><span class="ident" id="582893">Read</span><span class="op" id="582897">(</span><span class="ident" id="582898">buf</span><span class="op" id="582901">)</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="582905">if</span>&nbsp;<span class="ident" id="582908">n</span>&nbsp;<span class="op" id="582910">!=</span>&nbsp;<span class="num" id="582913">0</span>&nbsp;<span class="op" id="582915">||</span>&nbsp;<span class="ident" id="582918">err</span>&nbsp;<span class="op" id="582922">==</span>&nbsp;<span class="ident" id="582925">nil</span>&nbsp;<span class="op" id="582929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="582934">t</span><span class="op" id="582935">.</span><span class="ident" id="582936">Errorf</span><span class="op" id="582942">(</span><span class="string" id="582943">&#34;expected&nbsp;Read&nbsp;error&nbsp;after&nbsp;exhausted&nbsp;reads;&nbsp;got&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="582998">,</span>&nbsp;<span class="ident" id="583000">n</span><span class="op" id="583001">,</span>&nbsp;<span class="ident" id="583003">err</span><span class="op" id="583006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583014">res</span><span class="op" id="583017">.</span><span class="ident" id="583018">Body</span><span class="op" id="583022">.</span><span class="ident" id="583023">Close</span><span class="op" id="583028">(</span><span class="op" id="583029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583033">n</span><span class="op" id="583034">,</span>&nbsp;<span class="ident" id="583036">err</span>&nbsp;<span class="op" id="583040">=</span>&nbsp;<span class="ident" id="583042">res</span><span class="op" id="583045">.</span><span class="ident" id="583046">Body</span><span class="op" id="583050">.</span><span class="ident" id="583051">Read</span><span class="op" id="583055">(</span><span class="ident" id="583056">buf</span><span class="op" id="583059">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583063">if</span>&nbsp;<span class="ident" id="583066">n</span>&nbsp;<span class="op" id="583068">!=</span>&nbsp;<span class="num" id="583071">0</span>&nbsp;<span class="op" id="583073">||</span>&nbsp;<span class="ident" id="583076">err</span>&nbsp;<span class="op" id="583080">==</span>&nbsp;<span class="ident" id="583083">nil</span>&nbsp;<span class="op" id="583087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583092">t</span><span class="op" id="583093">.</span><span class="ident" id="583094">Errorf</span><span class="op" id="583100">(</span><span class="string" id="583101">&#34;expected&nbsp;Read&nbsp;error&nbsp;after&nbsp;Close;&nbsp;got&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="583146">,</span>&nbsp;<span class="ident" id="583148">n</span><span class="op" id="583149">,</span>&nbsp;<span class="ident" id="583151">err</span><span class="op" id="583154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="583165">//&nbsp;And&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;too,&nbsp;because&nbsp;they&#39;re&nbsp;always&nbsp;weird.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583223">c</span>&nbsp;<span class="op" id="583225">:=</span>&nbsp;<span class="op" id="583228">&amp;</span><span class="ident" id="583229">Client</span><span class="op" id="583235">{</span><span class="ident" id="583236">Transport</span><span class="op" id="583245">:</span>&nbsp;<span class="op" id="583247">&amp;</span><span class="ident" id="583248">Transport</span><span class="op" id="583257">{</span><span class="op" id="583258">}</span><span class="op" id="583259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583262">res</span><span class="op" id="583265">,</span>&nbsp;<span class="ident" id="583267">err</span>&nbsp;<span class="op" id="583271">:=</span>&nbsp;<span class="ident" id="583274">c</span><span class="op" id="583275">.</span><span class="ident" id="583276">Head</span><span class="op" id="583280">(</span><span class="ident" id="583281">ts</span><span class="op" id="583283">.</span><span class="ident" id="583284">URL</span><span class="op" id="583287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583290">if</span>&nbsp;<span class="ident" id="583293">err</span>&nbsp;<span class="op" id="583297">!=</span>&nbsp;<span class="ident" id="583300">nil</span>&nbsp;<span class="op" id="583304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583308">t</span><span class="op" id="583309">.</span><span class="ident" id="583310">Fatalf</span><span class="op" id="583316">(</span><span class="string" id="583317">&#34;Head:&nbsp;%v&#34;</span><span class="op" id="583327">,</span>&nbsp;<span class="ident" id="583329">err</span><span class="op" id="583332">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583338">if</span>&nbsp;<span class="ident" id="583341">res</span><span class="op" id="583344">.</span><span class="ident" id="583345">StatusCode</span>&nbsp;<span class="op" id="583356">!=</span>&nbsp;<span class="num" id="583359">200</span>&nbsp;<span class="op" id="583363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583367">t</span><span class="op" id="583368">.</span><span class="ident" id="583369">Errorf</span><span class="op" id="583375">(</span><span class="string" id="583376">&#34;Head&nbsp;status=%d;&nbsp;want=200&#34;</span><span class="op" id="583402">,</span>&nbsp;<span class="ident" id="583404">res</span><span class="op" id="583407">.</span><span class="ident" id="583408">StatusCode</span><span class="op" id="583418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583421">}</span><br>
<span class="lineno"></span><span class="op" id="583423">}</span><br>
<span class="lineno">750</span><br>
<span class="lineno"></span><span class="keyword" id="583426">func</span>&nbsp;<span class="ident" id="583431">TestTransportProxy</span><span class="op" id="583449">(</span><span class="ident" id="583450">t</span>&nbsp;<span class="op" id="583452">*</span><span class="ident" id="583453">testing</span><span class="op" id="583460">.</span><span class="ident" id="583461">T</span><span class="op" id="583462">)</span>&nbsp;<span class="op" id="583464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583467">defer</span>&nbsp;<span class="ident" id="583473">afterTest</span><span class="op" id="583482">(</span><span class="ident" id="583483">t</span><span class="op" id="583484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583487">ch</span>&nbsp;<span class="op" id="583490">:=</span>&nbsp;<span class="builtinfunc" id="583493">make</span><span class="op" id="583497">(</span><span class="keyword" id="583498">chan</span>&nbsp;<span class="builtintype" id="583503">string</span><span class="op" id="583509">,</span>&nbsp;<span class="num" id="583511">1</span><span class="op" id="583512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583515">ts</span>&nbsp;<span class="op" id="583518">:=</span>&nbsp;<span class="ident" id="583521">httptest</span><span class="op" id="583529">.</span><span class="ident" id="583530">NewServer</span><span class="op" id="583539">(</span><span class="ident" id="583540">HandlerFunc</span><span class="op" id="583551">(</span><span class="keyword" id="583552">func</span><span class="op" id="583556">(</span><span class="ident" id="583557">w</span>&nbsp;<span class="ident" id="583559">ResponseWriter</span><span class="op" id="583573">,</span>&nbsp;<span class="ident" id="583575">r</span>&nbsp;<span class="op" id="583577">*</span><span class="ident" id="583578">Request</span><span class="op" id="583585">)</span>&nbsp;<span class="op" id="583587">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583591">ch</span>&nbsp;<span class="op" id="583594">&lt;-</span>&nbsp;<span class="string" id="583597">&#34;real&nbsp;server&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583612">}</span><span class="op" id="583613">)</span><span class="op" id="583614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583617">defer</span>&nbsp;<span class="ident" id="583623">ts</span><span class="op" id="583625">.</span><span class="ident" id="583626">Close</span><span class="op" id="583631">(</span><span class="op" id="583632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583635">proxy</span>&nbsp;<span class="op" id="583641">:=</span>&nbsp;<span class="ident" id="583644">httptest</span><span class="op" id="583652">.</span><span class="ident" id="583653">NewServer</span><span class="op" id="583662">(</span><span class="ident" id="583663">HandlerFunc</span><span class="op" id="583674">(</span><span class="keyword" id="583675">func</span><span class="op" id="583679">(</span><span class="ident" id="583680">w</span>&nbsp;<span class="ident" id="583682">ResponseWriter</span><span class="op" id="583696">,</span>&nbsp;<span class="ident" id="583698">r</span>&nbsp;<span class="op" id="583700">*</span><span class="ident" id="583701">Request</span><span class="op" id="583708">)</span>&nbsp;<span class="op" id="583710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583714">ch</span>&nbsp;<span class="op" id="583717">&lt;-</span>&nbsp;<span class="string" id="583720">&#34;proxy&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="583733">+</span>&nbsp;<span class="ident" id="583735">r</span><span class="op" id="583736">.</span><span class="ident" id="583737">URL</span><span class="op" id="583740">.</span><span class="ident" id="583741">String</span><span class="op" id="583747">(</span><span class="op" id="583748">)</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583751">}</span><span class="op" id="583752">)</span><span class="op" id="583753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583756">defer</span>&nbsp;<span class="ident" id="583762">proxy</span><span class="op" id="583767">.</span><span class="ident" id="583768">Close</span><span class="op" id="583773">(</span><span class="op" id="583774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583778">pu</span><span class="op" id="583780">,</span>&nbsp;<span class="ident" id="583782">err</span>&nbsp;<span class="op" id="583786">:=</span>&nbsp;<span class="ident" id="583789">url</span><span class="op" id="583792">.</span><span class="ident" id="583793">Parse</span><span class="op" id="583798">(</span><span class="ident" id="583799">proxy</span><span class="op" id="583804">.</span><span class="ident" id="583805">URL</span><span class="op" id="583808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583811">if</span>&nbsp;<span class="ident" id="583814">err</span>&nbsp;<span class="op" id="583818">!=</span>&nbsp;<span class="ident" id="583821">nil</span>&nbsp;<span class="op" id="583825">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583829">t</span><span class="op" id="583830">.</span><span class="ident" id="583831">Fatal</span><span class="op" id="583836">(</span><span class="ident" id="583837">err</span><span class="op" id="583840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="583843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583846">c</span>&nbsp;<span class="op" id="583848">:=</span>&nbsp;<span class="op" id="583851">&amp;</span><span class="ident" id="583852">Client</span><span class="op" id="583858">{</span><span class="ident" id="583859">Transport</span><span class="op" id="583868">:</span>&nbsp;<span class="op" id="583870">&amp;</span><span class="ident" id="583871">Transport</span><span class="op" id="583880">{</span><span class="ident" id="583881">Proxy</span><span class="op" id="583886">:</span>&nbsp;<span class="ident" id="583888">ProxyURL</span><span class="op" id="583896">(</span><span class="ident" id="583897">pu</span><span class="op" id="583899">)</span><span class="op" id="583900">}</span><span class="op" id="583901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583904">c</span><span class="op" id="583905">.</span><span class="ident" id="583906">Head</span><span class="op" id="583910">(</span><span class="ident" id="583911">ts</span><span class="op" id="583913">.</span><span class="ident" id="583914">URL</span><span class="op" id="583917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583920">got</span>&nbsp;<span class="op" id="583924">:=</span>&nbsp;<span class="op" id="583927">&lt;-</span><span class="ident" id="583929">ch</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583933">want</span>&nbsp;<span class="op" id="583938">:=</span>&nbsp;<span class="string" id="583941">&#34;proxy&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="583954">+</span>&nbsp;<span class="ident" id="583956">ts</span><span class="op" id="583958">.</span><span class="ident" id="583959">URL</span>&nbsp;<span class="op" id="583963">+</span>&nbsp;<span class="string" id="583965">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="583970">if</span>&nbsp;<span class="ident" id="583973">got</span>&nbsp;<span class="op" id="583977">!=</span>&nbsp;<span class="ident" id="583980">want</span>&nbsp;<span class="op" id="583985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="583989">t</span><span class="op" id="583990">.</span><span class="ident" id="583991">Errorf</span><span class="op" id="583997">(</span><span class="string" id="583998">&#34;want&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="584015">,</span>&nbsp;<span class="ident" id="584017">want</span><span class="op" id="584021">,</span>&nbsp;<span class="ident" id="584023">got</span><span class="op" id="584026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="584029">}</span><br>
<span class="lineno"></span><span class="op" id="584031">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="584034">//&nbsp;TestTransportGzipRecursive&nbsp;sends&nbsp;a&nbsp;gzip&nbsp;quine&nbsp;and&nbsp;checks&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="584103">//&nbsp;client&nbsp;gets&nbsp;the&nbsp;same&nbsp;value&nbsp;back.&nbsp;This&nbsp;is&nbsp;more&nbsp;cute&nbsp;than&nbsp;anything,</span><br>
<span class="lineno"></span><span class="comment" id="584172">//&nbsp;but&nbsp;checks&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;recurse&nbsp;forever,&nbsp;and&nbsp;checks&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="584233">//&nbsp;Content-Encoding&nbsp;is&nbsp;removed.</span><br>
<span class="lineno">780</span><span class="keyword" id="584265">func</span>&nbsp;<span class="ident" id="584270">TestTransportGzipRecursive</span><span class="op" id="584296">(</span><span class="ident" id="584297">t</span>&nbsp;<span class="op" id="584299">*</span><span class="ident" id="584300">testing</span><span class="op" id="584307">.</span><span class="ident" id="584308">T</span><span class="op" id="584309">)</span>&nbsp;<span class="op" id="584311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="584314">defer</span>&nbsp;<span class="ident" id="584320">afterTest</span><span class="op" id="584329">(</span><span class="ident" id="584330">t</span><span class="op" id="584331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584334">ts</span>&nbsp;<span class="op" id="584337">:=</span>&nbsp;<span class="ident" id="584340">httptest</span><span class="op" id="584348">.</span><span class="ident" id="584349">NewServer</span><span class="op" id="584358">(</span><span class="ident" id="584359">HandlerFunc</span><span class="op" id="584370">(</span><span class="keyword" id="584371">func</span><span class="op" id="584375">(</span><span class="ident" id="584376">w</span>&nbsp;<span class="ident" id="584378">ResponseWriter</span><span class="op" id="584392">,</span>&nbsp;<span class="ident" id="584394">r</span>&nbsp;<span class="op" id="584396">*</span><span class="ident" id="584397">Request</span><span class="op" id="584404">)</span>&nbsp;<span class="op" id="584406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584410">w</span><span class="op" id="584411">.</span><span class="ident" id="584412">Header</span><span class="op" id="584418">(</span><span class="op" id="584419">)</span><span class="op" id="584420">.</span><span class="ident" id="584421">Set</span><span class="op" id="584424">(</span><span class="string" id="584425">&#34;Content-Encoding&#34;</span><span class="op" id="584443">,</span>&nbsp;<span class="string" id="584445">&#34;gzip&#34;</span><span class="op" id="584451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584455">w</span><span class="op" id="584456">.</span><span class="ident" id="584457">Write</span><span class="op" id="584462">(</span><span class="ident" id="584463">rgz</span><span class="op" id="584466">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="584469">}</span><span class="op" id="584470">)</span><span class="op" id="584471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="584474">defer</span>&nbsp;<span class="ident" id="584480">ts</span><span class="op" id="584482">.</span><span class="ident" id="584483">Close</span><span class="op" id="584488">(</span><span class="op" id="584489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584493">c</span>&nbsp;<span class="op" id="584495">:=</span>&nbsp;<span class="op" id="584498">&amp;</span><span class="ident" id="584499">Client</span><span class="op" id="584505">{</span><span class="ident" id="584506">Transport</span><span class="op" id="584515">:</span>&nbsp;<span class="op" id="584517">&amp;</span><span class="ident" id="584518">Transport</span><span class="op" id="584527">{</span><span class="op" id="584528">}</span><span class="op" id="584529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584532">res</span><span class="op" id="584535">,</span>&nbsp;<span class="ident" id="584537">err</span>&nbsp;<span class="op" id="584541">:=</span>&nbsp;<span class="ident" id="584544">c</span><span class="op" id="584545">.</span><span class="ident" id="584546">Get</span><span class="op" id="584549">(</span><span class="ident" id="584550">ts</span><span class="op" id="584552">.</span><span class="ident" id="584553">URL</span><span class="op" id="584556">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="584559">if</span>&nbsp;<span class="ident" id="584562">err</span>&nbsp;<span class="op" id="584566">!=</span>&nbsp;<span class="ident" id="584569">nil</span>&nbsp;<span class="op" id="584573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584577">t</span><span class="op" id="584578">.</span><span class="ident" id="584579">Fatal</span><span class="op" id="584584">(</span><span class="ident" id="584585">err</span><span class="op" id="584588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="584591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584594">body</span><span class="op" id="584598">,</span>&nbsp;<span class="ident" id="584600">err</span>&nbsp;<span class="op" id="584604">:=</span>&nbsp;<span class="ident" id="584607">ioutil</span><span class="op" id="584613">.</span><span class="ident" id="584614">ReadAll</span><span class="op" id="584621">(</span><span class="ident" id="584622">res</span><span class="op" id="584625">.</span><span class="ident" id="584626">Body</span><span class="op" id="584630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="584633">if</span>&nbsp;<span class="ident" id="584636">err</span>&nbsp;<span class="op" id="584640">!=</span>&nbsp;<span class="ident" id="584643">nil</span>&nbsp;<span class="op" id="584647">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584651">t</span><span class="op" id="584652">.</span><span class="ident" id="584653">Fatal</span><span class="op" id="584658">(</span><span class="ident" id="584659">err</span><span class="op" id="584662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="584665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="584668">if</span>&nbsp;<span class="op" id="584671">!</span><span class="ident" id="584672">bytes</span><span class="op" id="584677">.</span><span class="ident" id="584678">Equal</span><span class="op" id="584683">(</span><span class="ident" id="584684">body</span><span class="op" id="584688">,</span>&nbsp;<span class="ident" id="584690">rgz</span><span class="op" id="584693">)</span>&nbsp;<span class="op" id="584695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584699">t</span><span class="op" id="584700">.</span><span class="ident" id="584701">Fatalf</span><span class="op" id="584707">(</span><span class="string" id="584708">&#34;Incorrect&nbsp;result&nbsp;from&nbsp;recursive&nbsp;gz:\nhave=%x\nwant=%x&#34;</span><span class="op" id="584763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584768">body</span><span class="op" id="584772">,</span>&nbsp;<span class="ident" id="584774">rgz</span><span class="op" id="584777">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="584780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="584783">if</span>&nbsp;<span class="ident" id="584786">g</span><span class="op" id="584787">,</span>&nbsp;<span class="ident" id="584789">e</span>&nbsp;<span class="op" id="584791">:=</span>&nbsp;<span class="ident" id="584794">res</span><span class="op" id="584797">.</span><span class="ident" id="584798">Header</span><span class="op" id="584804">.</span><span class="ident" id="584805">Get</span><span class="op" id="584808">(</span><span class="string" id="584809">&#34;Content-Encoding&#34;</span><span class="op" id="584827">)</span><span class="op" id="584828">,</span>&nbsp;<span class="string" id="584830">&#34;&#34;</span><span class="op" id="584832">;</span>&nbsp;<span class="ident" id="584834">g</span>&nbsp;<span class="op" id="584836">!=</span>&nbsp;<span class="ident" id="584839">e</span>&nbsp;<span class="op" id="584841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="584845">t</span><span class="op" id="584846">.</span><span class="ident" id="584847">Fatalf</span><span class="op" id="584853">(</span><span class="string" id="584854">&#34;Content-Encoding&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="584886">,</span>&nbsp;<span class="ident" id="584888">g</span><span class="op" id="584889">,</span>&nbsp;<span class="ident" id="584891">e</span><span class="op" id="584892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="584895">}</span><br>
<span class="lineno"></span><span class="op" id="584897">}</span><br>
<span class="lineno">805</span><br>
<span class="lineno"></span><span class="comment" id="584900">//&nbsp;golang.org/issue/7750:&nbsp;request&nbsp;fails&nbsp;when&nbsp;server&nbsp;replies&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="584965">//&nbsp;a&nbsp;short&nbsp;gzip&nbsp;body</span><br>
<span class="lineno"></span><span class="keyword" id="584986">func</span>&nbsp;<span class="ident" id="584991">TestTransportGzipShort</span><span class="op" id="585013">(</span><span class="ident" id="585014">t</span>&nbsp;<span class="op" id="585016">*</span><span class="ident" id="585017">testing</span><span class="op" id="585024">.</span><span class="ident" id="585025">T</span><span class="op" id="585026">)</span>&nbsp;<span class="op" id="585028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585031">defer</span>&nbsp;<span class="ident" id="585037">afterTest</span><span class="op" id="585046">(</span><span class="ident" id="585047">t</span><span class="op" id="585048">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585051">ts</span>&nbsp;<span class="op" id="585054">:=</span>&nbsp;<span class="ident" id="585057">httptest</span><span class="op" id="585065">.</span><span class="ident" id="585066">NewServer</span><span class="op" id="585075">(</span><span class="ident" id="585076">HandlerFunc</span><span class="op" id="585087">(</span><span class="keyword" id="585088">func</span><span class="op" id="585092">(</span><span class="ident" id="585093">w</span>&nbsp;<span class="ident" id="585095">ResponseWriter</span><span class="op" id="585109">,</span>&nbsp;<span class="ident" id="585111">r</span>&nbsp;<span class="op" id="585113">*</span><span class="ident" id="585114">Request</span><span class="op" id="585121">)</span>&nbsp;<span class="op" id="585123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585127">w</span><span class="op" id="585128">.</span><span class="ident" id="585129">Header</span><span class="op" id="585135">(</span><span class="op" id="585136">)</span><span class="op" id="585137">.</span><span class="ident" id="585138">Set</span><span class="op" id="585141">(</span><span class="string" id="585142">&#34;Content-Encoding&#34;</span><span class="op" id="585160">,</span>&nbsp;<span class="string" id="585162">&#34;gzip&#34;</span><span class="op" id="585168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585172">w</span><span class="op" id="585173">.</span><span class="ident" id="585174">Write</span><span class="op" id="585179">(</span><span class="op" id="585180">[</span><span class="op" id="585181">]</span><span class="builtintype" id="585182">byte</span><span class="op" id="585186">{</span><span class="num" id="585187">0x1f</span><span class="op" id="585191">,</span>&nbsp;<span class="num" id="585193">0x8b</span><span class="op" id="585197">}</span><span class="op" id="585198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="585201">}</span><span class="op" id="585202">)</span><span class="op" id="585203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585206">defer</span>&nbsp;<span class="ident" id="585212">ts</span><span class="op" id="585214">.</span><span class="ident" id="585215">Close</span><span class="op" id="585220">(</span><span class="op" id="585221">)</span><br>
<span class="lineno">815</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585225">tr</span>&nbsp;<span class="op" id="585228">:=</span>&nbsp;<span class="op" id="585231">&amp;</span><span class="ident" id="585232">Transport</span><span class="op" id="585241">{</span><span class="op" id="585242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585245">defer</span>&nbsp;<span class="ident" id="585251">tr</span><span class="op" id="585253">.</span><span class="ident" id="585254">CloseIdleConnections</span><span class="op" id="585274">(</span><span class="op" id="585275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585278">c</span>&nbsp;<span class="op" id="585280">:=</span>&nbsp;<span class="op" id="585283">&amp;</span><span class="ident" id="585284">Client</span><span class="op" id="585290">{</span><span class="ident" id="585291">Transport</span><span class="op" id="585300">:</span>&nbsp;<span class="ident" id="585302">tr</span><span class="op" id="585304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585307">res</span><span class="op" id="585310">,</span>&nbsp;<span class="ident" id="585312">err</span>&nbsp;<span class="op" id="585316">:=</span>&nbsp;<span class="ident" id="585319">c</span><span class="op" id="585320">.</span><span class="ident" id="585321">Get</span><span class="op" id="585324">(</span><span class="ident" id="585325">ts</span><span class="op" id="585327">.</span><span class="ident" id="585328">URL</span><span class="op" id="585331">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585334">if</span>&nbsp;<span class="ident" id="585337">err</span>&nbsp;<span class="op" id="585341">!=</span>&nbsp;<span class="ident" id="585344">nil</span>&nbsp;<span class="op" id="585348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585352">t</span><span class="op" id="585353">.</span><span class="ident" id="585354">Fatal</span><span class="op" id="585359">(</span><span class="ident" id="585360">err</span><span class="op" id="585363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="585366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585369">defer</span>&nbsp;<span class="ident" id="585375">res</span><span class="op" id="585378">.</span><span class="ident" id="585379">Body</span><span class="op" id="585383">.</span><span class="ident" id="585384">Close</span><span class="op" id="585389">(</span><span class="op" id="585390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585393">_</span><span class="op" id="585394">,</span>&nbsp;<span class="ident" id="585396">err</span>&nbsp;<span class="op" id="585400">=</span>&nbsp;<span class="ident" id="585402">ioutil</span><span class="op" id="585408">.</span><span class="ident" id="585409">ReadAll</span><span class="op" id="585416">(</span><span class="ident" id="585417">res</span><span class="op" id="585420">.</span><span class="ident" id="585421">Body</span><span class="op" id="585425">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585428">if</span>&nbsp;<span class="ident" id="585431">err</span>&nbsp;<span class="op" id="585435">==</span>&nbsp;<span class="ident" id="585438">nil</span>&nbsp;<span class="op" id="585442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585446">t</span><span class="op" id="585447">.</span><span class="ident" id="585448">Fatal</span><span class="op" id="585453">(</span><span class="string" id="585454">&#34;Expect&nbsp;an&nbsp;error&nbsp;from&nbsp;reading&nbsp;a&nbsp;body.&#34;</span><span class="op" id="585492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="585495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585498">if</span>&nbsp;<span class="ident" id="585501">err</span>&nbsp;<span class="op" id="585505">!=</span>&nbsp;<span class="ident" id="585508">io</span><span class="op" id="585510">.</span><span class="ident" id="585511">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="585528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585532">t</span><span class="op" id="585533">.</span><span class="ident" id="585534">Errorf</span><span class="op" id="585540">(</span><span class="string" id="585541">&#34;ReadAll&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;io.ErrUnexpectedEOF&#34;</span><span class="op" id="585587">,</span>&nbsp;<span class="ident" id="585589">err</span><span class="op" id="585592">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="585595">}</span><br>
<span class="lineno"></span><span class="op" id="585597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="585600">//&nbsp;tests&nbsp;that&nbsp;persistent&nbsp;goroutine&nbsp;connections&nbsp;shut&nbsp;down&nbsp;when&nbsp;no&nbsp;longer&nbsp;desired.</span><br>
<span class="lineno"></span><span class="keyword" id="585681">func</span>&nbsp;<span class="ident" id="585686">TestTransportPersistConnLeak</span><span class="op" id="585714">(</span><span class="ident" id="585715">t</span>&nbsp;<span class="op" id="585717">*</span><span class="ident" id="585718">testing</span><span class="op" id="585725">.</span><span class="ident" id="585726">T</span><span class="op" id="585727">)</span>&nbsp;<span class="op" id="585729">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585732">if</span>&nbsp;<span class="ident" id="585735">runtime</span><span class="op" id="585742">.</span><span class="ident" id="585743">GOOS</span>&nbsp;<span class="op" id="585748">==</span>&nbsp;<span class="string" id="585751">&#34;plan9&#34;</span>&nbsp;<span class="op" id="585759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585763">t</span><span class="op" id="585764">.</span><span class="ident" id="585765">Skip</span><span class="op" id="585769">(</span><span class="string" id="585770">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="585819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="585822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="585825">defer</span>&nbsp;<span class="ident" id="585831">afterTest</span><span class="op" id="585840">(</span><span class="ident" id="585841">t</span><span class="op" id="585842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585845">gotReqCh</span>&nbsp;<span class="op" id="585854">:=</span>&nbsp;<span class="builtinfunc" id="585857">make</span><span class="op" id="585861">(</span><span class="keyword" id="585862">chan</span>&nbsp;<span class="builtintype" id="585867">bool</span><span class="op" id="585871">)</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585874">unblockCh</span>&nbsp;<span class="op" id="585884">:=</span>&nbsp;<span class="builtinfunc" id="585887">make</span><span class="op" id="585891">(</span><span class="keyword" id="585892">chan</span>&nbsp;<span class="builtintype" id="585897">bool</span><span class="op" id="585901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585904">ts</span>&nbsp;<span class="op" id="585907">:=</span>&nbsp;<span class="ident" id="585910">httptest</span><span class="op" id="585918">.</span><span class="ident" id="585919">NewServer</span><span class="op" id="585928">(</span><span class="ident" id="585929">HandlerFunc</span><span class="op" id="585940">(</span><span class="keyword" id="585941">func</span><span class="op" id="585945">(</span><span class="ident" id="585946">w</span>&nbsp;<span class="ident" id="585948">ResponseWriter</span><span class="op" id="585962">,</span>&nbsp;<span class="ident" id="585964">r</span>&nbsp;<span class="op" id="585966">*</span><span class="ident" id="585967">Request</span><span class="op" id="585974">)</span>&nbsp;<span class="op" id="585976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="585980">gotReqCh</span>&nbsp;<span class="op" id="585989">&lt;-</span>&nbsp;<span class="builtintype" id="585992">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="585999">&lt;-</span><span class="ident" id="586001">unblockCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586013">w</span><span class="op" id="586014">.</span><span class="ident" id="586015">Header</span><span class="op" id="586021">(</span><span class="op" id="586022">)</span><span class="op" id="586023">.</span><span class="ident" id="586024">Set</span><span class="op" id="586027">(</span><span class="string" id="586028">&#34;Content-Length&#34;</span><span class="op" id="586044">,</span>&nbsp;<span class="string" id="586046">&#34;0&#34;</span><span class="op" id="586049">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586053">w</span><span class="op" id="586054">.</span><span class="ident" id="586055">WriteHeader</span><span class="op" id="586066">(</span><span class="num" id="586067">204</span><span class="op" id="586070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586073">}</span><span class="op" id="586074">)</span><span class="op" id="586075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586078">defer</span>&nbsp;<span class="ident" id="586084">ts</span><span class="op" id="586086">.</span><span class="ident" id="586087">Close</span><span class="op" id="586092">(</span><span class="op" id="586093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586097">tr</span>&nbsp;<span class="op" id="586100">:=</span>&nbsp;<span class="op" id="586103">&amp;</span><span class="ident" id="586104">Transport</span><span class="op" id="586113">{</span><span class="op" id="586114">}</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586117">c</span>&nbsp;<span class="op" id="586119">:=</span>&nbsp;<span class="op" id="586122">&amp;</span><span class="ident" id="586123">Client</span><span class="op" id="586129">{</span><span class="ident" id="586130">Transport</span><span class="op" id="586139">:</span>&nbsp;<span class="ident" id="586141">tr</span><span class="op" id="586143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586147">n0</span>&nbsp;<span class="op" id="586150">:=</span>&nbsp;<span class="ident" id="586153">runtime</span><span class="op" id="586160">.</span><span class="ident" id="586161">NumGoroutine</span><span class="op" id="586173">(</span><span class="op" id="586174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586178">const</span>&nbsp;<span class="ident" id="586184">numReq</span>&nbsp;<span class="op" id="586191">=</span>&nbsp;<span class="num" id="586193">25</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586197">didReqCh</span>&nbsp;<span class="op" id="586206">:=</span>&nbsp;<span class="builtinfunc" id="586209">make</span><span class="op" id="586213">(</span><span class="keyword" id="586214">chan</span>&nbsp;<span class="builtintype" id="586219">bool</span><span class="op" id="586223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586226">for</span>&nbsp;<span class="ident" id="586230">i</span>&nbsp;<span class="op" id="586232">:=</span>&nbsp;<span class="num" id="586235">0</span><span class="op" id="586236">;</span>&nbsp;<span class="ident" id="586238">i</span>&nbsp;<span class="op" id="586240">&lt;</span>&nbsp;<span class="ident" id="586242">numReq</span><span class="op" id="586248">;</span>&nbsp;<span class="ident" id="586250">i</span><span class="op" id="586251">++</span>&nbsp;<span class="op" id="586254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586258">go</span>&nbsp;<span class="keyword" id="586261">func</span><span class="op" id="586265">(</span><span class="op" id="586266">)</span>&nbsp;<span class="op" id="586268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586273">res</span><span class="op" id="586276">,</span>&nbsp;<span class="ident" id="586278">err</span>&nbsp;<span class="op" id="586282">:=</span>&nbsp;<span class="ident" id="586285">c</span><span class="op" id="586286">.</span><span class="ident" id="586287">Get</span><span class="op" id="586290">(</span><span class="ident" id="586291">ts</span><span class="op" id="586293">.</span><span class="ident" id="586294">URL</span><span class="op" id="586297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586302">didReqCh</span>&nbsp;<span class="op" id="586311">&lt;-</span>&nbsp;<span class="builtintype" id="586314">true</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586322">if</span>&nbsp;<span class="ident" id="586325">err</span>&nbsp;<span class="op" id="586329">!=</span>&nbsp;<span class="ident" id="586332">nil</span>&nbsp;<span class="op" id="586336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586342">t</span><span class="op" id="586343">.</span><span class="ident" id="586344">Errorf</span><span class="op" id="586350">(</span><span class="string" id="586351">&#34;client&nbsp;fetch&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="586375">,</span>&nbsp;<span class="ident" id="586377">err</span><span class="op" id="586380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586386">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586401">res</span><span class="op" id="586404">.</span><span class="ident" id="586405">Body</span><span class="op" id="586409">.</span><span class="ident" id="586410">Close</span><span class="op" id="586415">(</span><span class="op" id="586416">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586420">}</span><span class="op" id="586421">(</span><span class="op" id="586422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="586429">//&nbsp;Wait&nbsp;for&nbsp;all&nbsp;goroutines&nbsp;to&nbsp;be&nbsp;stuck&nbsp;in&nbsp;the&nbsp;Handler.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586485">for</span>&nbsp;<span class="ident" id="586489">i</span>&nbsp;<span class="op" id="586491">:=</span>&nbsp;<span class="num" id="586494">0</span><span class="op" id="586495">;</span>&nbsp;<span class="ident" id="586497">i</span>&nbsp;<span class="op" id="586499">&lt;</span>&nbsp;<span class="ident" id="586501">numReq</span><span class="op" id="586507">;</span>&nbsp;<span class="ident" id="586509">i</span><span class="op" id="586510">++</span>&nbsp;<span class="op" id="586513">{</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586517">&lt;-</span><span class="ident" id="586519">gotReqCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586533">nhigh</span>&nbsp;<span class="op" id="586539">:=</span>&nbsp;<span class="ident" id="586542">runtime</span><span class="op" id="586549">.</span><span class="ident" id="586550">NumGoroutine</span><span class="op" id="586562">(</span><span class="op" id="586563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="586567">//&nbsp;Tell&nbsp;all&nbsp;handlers&nbsp;to&nbsp;unblock&nbsp;and&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586611">for</span>&nbsp;<span class="ident" id="586615">i</span>&nbsp;<span class="op" id="586617">:=</span>&nbsp;<span class="num" id="586620">0</span><span class="op" id="586621">;</span>&nbsp;<span class="ident" id="586623">i</span>&nbsp;<span class="op" id="586625">&lt;</span>&nbsp;<span class="ident" id="586627">numReq</span><span class="op" id="586633">;</span>&nbsp;<span class="ident" id="586635">i</span><span class="op" id="586636">++</span>&nbsp;<span class="op" id="586639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586643">unblockCh</span>&nbsp;<span class="op" id="586653">&lt;-</span>&nbsp;<span class="builtintype" id="586656">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="586666">//&nbsp;Wait&nbsp;for&nbsp;all&nbsp;HTTP&nbsp;clients&nbsp;to&nbsp;be&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="586708">for</span>&nbsp;<span class="ident" id="586712">i</span>&nbsp;<span class="op" id="586714">:=</span>&nbsp;<span class="num" id="586717">0</span><span class="op" id="586718">;</span>&nbsp;<span class="ident" id="586720">i</span>&nbsp;<span class="op" id="586722">&lt;</span>&nbsp;<span class="ident" id="586724">numReq</span><span class="op" id="586730">;</span>&nbsp;<span class="ident" id="586732">i</span><span class="op" id="586733">++</span>&nbsp;<span class="op" id="586736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586740">&lt;-</span><span class="ident" id="586742">didReqCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="586752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586756">tr</span><span class="op" id="586758">.</span><span class="ident" id="586759">CloseIdleConnections</span><span class="op" id="586779">(</span><span class="op" id="586780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586783">time</span><span class="op" id="586787">.</span><span class="ident" id="586788">Sleep</span><span class="op" id="586793">(</span><span class="num" id="586794">100</span>&nbsp;<span class="op" id="586798">*</span>&nbsp;<span class="ident" id="586800">time</span><span class="op" id="586804">.</span><span class="ident" id="586805">Millisecond</span><span class="op" id="586816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586819">runtime</span><span class="op" id="586826">.</span><span class="ident" id="586827">GC</span><span class="op" id="586829">(</span><span class="op" id="586830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586833">runtime</span><span class="op" id="586840">.</span><span class="ident" id="586841">GC</span><span class="op" id="586843">(</span><span class="op" id="586844">)</span>&nbsp;<span class="comment" id="586846">//&nbsp;even&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586861">nfinal</span>&nbsp;<span class="op" id="586868">:=</span>&nbsp;<span class="ident" id="586871">runtime</span><span class="op" id="586878">.</span><span class="ident" id="586879">NumGoroutine</span><span class="op" id="586891">(</span><span class="op" id="586892">)</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="586896">growth</span>&nbsp;<span class="op" id="586903">:=</span>&nbsp;<span class="ident" id="586906">nfinal</span>&nbsp;<span class="op" id="586913">-</span>&nbsp;<span class="ident" id="586915">n0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="586920">//&nbsp;We&nbsp;expect&nbsp;0&nbsp;or&nbsp;1&nbsp;extra&nbsp;goroutine,&nbsp;empirically.&nbsp;&nbsp;Allow&nbsp;up&nbsp;to&nbsp;5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="586987">//&nbsp;Previously&nbsp;we&nbsp;were&nbsp;leaking&nbsp;one&nbsp;per&nbsp;numReq.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587034">if</span>&nbsp;<span class="builtintype" id="587037">int</span><span class="op" id="587040">(</span><span class="ident" id="587041">growth</span><span class="op" id="587047">)</span>&nbsp;<span class="op" id="587049">&gt;</span>&nbsp;<span class="num" id="587051">5</span>&nbsp;<span class="op" id="587053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587057">t</span><span class="op" id="587058">.</span><span class="ident" id="587059">Logf</span><span class="op" id="587063">(</span><span class="string" id="587064">&#34;goroutine&nbsp;growth:&nbsp;%d&nbsp;-&gt;&nbsp;%d&nbsp;-&gt;&nbsp;%d&nbsp;(delta:&nbsp;%d)&#34;</span><span class="op" id="587110">,</span>&nbsp;<span class="ident" id="587112">n0</span><span class="op" id="587114">,</span>&nbsp;<span class="ident" id="587116">nhigh</span><span class="op" id="587121">,</span>&nbsp;<span class="ident" id="587123">nfinal</span><span class="op" id="587129">,</span>&nbsp;<span class="ident" id="587131">growth</span><span class="op" id="587137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587141">t</span><span class="op" id="587142">.</span><span class="ident" id="587143">Error</span><span class="op" id="587148">(</span><span class="string" id="587149">&#34;too&nbsp;many&nbsp;new&nbsp;goroutines&#34;</span><span class="op" id="587174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="587177">}</span><br>
<span class="lineno"></span><span class="op" id="587179">}</span><br>
<span class="lineno">900</span><br>
<span class="lineno"></span><span class="comment" id="587182">//&nbsp;golang.org/issue/4531:&nbsp;Transport&nbsp;leaks&nbsp;goroutines&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="587240">//&nbsp;request.ContentLength&nbsp;is&nbsp;explicitly&nbsp;short</span><br>
<span class="lineno"></span><span class="keyword" id="587285">func</span>&nbsp;<span class="ident" id="587290">TestTransportPersistConnLeakShortBody</span><span class="op" id="587327">(</span><span class="ident" id="587328">t</span>&nbsp;<span class="op" id="587330">*</span><span class="ident" id="587331">testing</span><span class="op" id="587338">.</span><span class="ident" id="587339">T</span><span class="op" id="587340">)</span>&nbsp;<span class="op" id="587342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587345">if</span>&nbsp;<span class="ident" id="587348">runtime</span><span class="op" id="587355">.</span><span class="ident" id="587356">GOOS</span>&nbsp;<span class="op" id="587361">==</span>&nbsp;<span class="string" id="587364">&#34;plan9&#34;</span>&nbsp;<span class="op" id="587372">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587376">t</span><span class="op" id="587377">.</span><span class="ident" id="587378">Skip</span><span class="op" id="587382">(</span><span class="string" id="587383">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="587432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="587435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587438">defer</span>&nbsp;<span class="ident" id="587444">afterTest</span><span class="op" id="587453">(</span><span class="ident" id="587454">t</span><span class="op" id="587455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587458">ts</span>&nbsp;<span class="op" id="587461">:=</span>&nbsp;<span class="ident" id="587464">httptest</span><span class="op" id="587472">.</span><span class="ident" id="587473">NewServer</span><span class="op" id="587482">(</span><span class="ident" id="587483">HandlerFunc</span><span class="op" id="587494">(</span><span class="keyword" id="587495">func</span><span class="op" id="587499">(</span><span class="ident" id="587500">w</span>&nbsp;<span class="ident" id="587502">ResponseWriter</span><span class="op" id="587516">,</span>&nbsp;<span class="ident" id="587518">r</span>&nbsp;<span class="op" id="587520">*</span><span class="ident" id="587521">Request</span><span class="op" id="587528">)</span>&nbsp;<span class="op" id="587530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="587533">}</span><span class="op" id="587534">)</span><span class="op" id="587535">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587538">defer</span>&nbsp;<span class="ident" id="587544">ts</span><span class="op" id="587546">.</span><span class="ident" id="587547">Close</span><span class="op" id="587552">(</span><span class="op" id="587553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587557">tr</span>&nbsp;<span class="op" id="587560">:=</span>&nbsp;<span class="op" id="587563">&amp;</span><span class="ident" id="587564">Transport</span><span class="op" id="587573">{</span><span class="op" id="587574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587577">c</span>&nbsp;<span class="op" id="587579">:=</span>&nbsp;<span class="op" id="587582">&amp;</span><span class="ident" id="587583">Client</span><span class="op" id="587589">{</span><span class="ident" id="587590">Transport</span><span class="op" id="587599">:</span>&nbsp;<span class="ident" id="587601">tr</span><span class="op" id="587603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587607">n0</span>&nbsp;<span class="op" id="587610">:=</span>&nbsp;<span class="ident" id="587613">runtime</span><span class="op" id="587620">.</span><span class="ident" id="587621">NumGoroutine</span><span class="op" id="587633">(</span><span class="op" id="587634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587637">body</span>&nbsp;<span class="op" id="587642">:=</span>&nbsp;<span class="op" id="587645">[</span><span class="op" id="587646">]</span><span class="builtintype" id="587647">byte</span><span class="op" id="587651">(</span><span class="string" id="587652">&#34;Hello&#34;</span><span class="op" id="587659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587662">for</span>&nbsp;<span class="ident" id="587666">i</span>&nbsp;<span class="op" id="587668">:=</span>&nbsp;<span class="num" id="587671">0</span><span class="op" id="587672">;</span>&nbsp;<span class="ident" id="587674">i</span>&nbsp;<span class="op" id="587676">&lt;</span>&nbsp;<span class="num" id="587678">20</span><span class="op" id="587680">;</span>&nbsp;<span class="ident" id="587682">i</span><span class="op" id="587683">++</span>&nbsp;<span class="op" id="587686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587690">req</span><span class="op" id="587693">,</span>&nbsp;<span class="ident" id="587695">err</span>&nbsp;<span class="op" id="587699">:=</span>&nbsp;<span class="ident" id="587702">NewRequest</span><span class="op" id="587712">(</span><span class="string" id="587713">&#34;POST&#34;</span><span class="op" id="587719">,</span>&nbsp;<span class="ident" id="587721">ts</span><span class="op" id="587723">.</span><span class="ident" id="587724">URL</span><span class="op" id="587727">,</span>&nbsp;<span class="ident" id="587729">bytes</span><span class="op" id="587734">.</span><span class="ident" id="587735">NewReader</span><span class="op" id="587744">(</span><span class="ident" id="587745">body</span><span class="op" id="587749">)</span><span class="op" id="587750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587754">if</span>&nbsp;<span class="ident" id="587757">err</span>&nbsp;<span class="op" id="587761">!=</span>&nbsp;<span class="ident" id="587764">nil</span>&nbsp;<span class="op" id="587768">{</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587773">t</span><span class="op" id="587774">.</span><span class="ident" id="587775">Fatal</span><span class="op" id="587780">(</span><span class="ident" id="587781">err</span><span class="op" id="587784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="587788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587792">req</span><span class="op" id="587795">.</span><span class="ident" id="587796">ContentLength</span>&nbsp;<span class="op" id="587810">=</span>&nbsp;<span class="ident" id="587812">int64</span><span class="op" id="587817">(</span><span class="builtinfunc" id="587818">len</span><span class="op" id="587821">(</span><span class="ident" id="587822">body</span><span class="op" id="587826">)</span>&nbsp;<span class="op" id="587828">-</span>&nbsp;<span class="num" id="587830">2</span><span class="op" id="587831">)</span>&nbsp;<span class="comment" id="587833">//&nbsp;explicitly&nbsp;short</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587855">_</span><span class="op" id="587856">,</span>&nbsp;<span class="ident" id="587858">err</span>&nbsp;<span class="op" id="587862">=</span>&nbsp;<span class="ident" id="587864">c</span><span class="op" id="587865">.</span><span class="ident" id="587866">Do</span><span class="op" id="587868">(</span><span class="ident" id="587869">req</span><span class="op" id="587872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="587876">if</span>&nbsp;<span class="ident" id="587879">err</span>&nbsp;<span class="op" id="587883">==</span>&nbsp;<span class="ident" id="587886">nil</span>&nbsp;<span class="op" id="587890">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587895">t</span><span class="op" id="587896">.</span><span class="ident" id="587897">Fatal</span><span class="op" id="587902">(</span><span class="string" id="587903">&#34;Expect&nbsp;an&nbsp;error&nbsp;from&nbsp;writing&nbsp;too&nbsp;long&nbsp;of&nbsp;a&nbsp;body.&#34;</span><span class="op" id="587953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="587957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="587960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587963">nhigh</span>&nbsp;<span class="op" id="587969">:=</span>&nbsp;<span class="ident" id="587972">runtime</span><span class="op" id="587979">.</span><span class="ident" id="587980">NumGoroutine</span><span class="op" id="587992">(</span><span class="op" id="587993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="587996">tr</span><span class="op" id="587998">.</span><span class="ident" id="587999">CloseIdleConnections</span><span class="op" id="588019">(</span><span class="op" id="588020">)</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588023">time</span><span class="op" id="588027">.</span><span class="ident" id="588028">Sleep</span><span class="op" id="588033">(</span><span class="num" id="588034">400</span>&nbsp;<span class="op" id="588038">*</span>&nbsp;<span class="ident" id="588040">time</span><span class="op" id="588044">.</span><span class="ident" id="588045">Millisecond</span><span class="op" id="588056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588059">runtime</span><span class="op" id="588066">.</span><span class="ident" id="588067">GC</span><span class="op" id="588069">(</span><span class="op" id="588070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588073">nfinal</span>&nbsp;<span class="op" id="588080">:=</span>&nbsp;<span class="ident" id="588083">runtime</span><span class="op" id="588090">.</span><span class="ident" id="588091">NumGoroutine</span><span class="op" id="588103">(</span><span class="op" id="588104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588108">growth</span>&nbsp;<span class="op" id="588115">:=</span>&nbsp;<span class="ident" id="588118">nfinal</span>&nbsp;<span class="op" id="588125">-</span>&nbsp;<span class="ident" id="588127">n0</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="588132">//&nbsp;We&nbsp;expect&nbsp;0&nbsp;or&nbsp;1&nbsp;extra&nbsp;goroutine,&nbsp;empirically.&nbsp;&nbsp;Allow&nbsp;up&nbsp;to&nbsp;5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="588199">//&nbsp;Previously&nbsp;we&nbsp;were&nbsp;leaking&nbsp;one&nbsp;per&nbsp;numReq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588246">t</span><span class="op" id="588247">.</span><span class="ident" id="588248">Logf</span><span class="op" id="588252">(</span><span class="string" id="588253">&#34;goroutine&nbsp;growth:&nbsp;%d&nbsp;-&gt;&nbsp;%d&nbsp;-&gt;&nbsp;%d&nbsp;(delta:&nbsp;%d)&#34;</span><span class="op" id="588299">,</span>&nbsp;<span class="ident" id="588301">n0</span><span class="op" id="588303">,</span>&nbsp;<span class="ident" id="588305">nhigh</span><span class="op" id="588310">,</span>&nbsp;<span class="ident" id="588312">nfinal</span><span class="op" id="588318">,</span>&nbsp;<span class="ident" id="588320">growth</span><span class="op" id="588326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="588329">if</span>&nbsp;<span class="builtintype" id="588332">int</span><span class="op" id="588335">(</span><span class="ident" id="588336">growth</span><span class="op" id="588342">)</span>&nbsp;<span class="op" id="588344">&gt;</span>&nbsp;<span class="num" id="588346">5</span>&nbsp;<span class="op" id="588348">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588352">t</span><span class="op" id="588353">.</span><span class="ident" id="588354">Error</span><span class="op" id="588359">(</span><span class="string" id="588360">&#34;too&nbsp;many&nbsp;new&nbsp;goroutines&#34;</span><span class="op" id="588385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588388">}</span><br>
<span class="lineno"></span><span class="op" id="588390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="588393">//&nbsp;This&nbsp;used&nbsp;to&nbsp;crash;&nbsp;http://golang.org/issue/3266</span><br>
<span class="lineno">945</span><span class="keyword" id="588445">func</span>&nbsp;<span class="ident" id="588450">TestTransportIdleConnCrash</span><span class="op" id="588476">(</span><span class="ident" id="588477">t</span>&nbsp;<span class="op" id="588479">*</span><span class="ident" id="588480">testing</span><span class="op" id="588487">.</span><span class="ident" id="588488">T</span><span class="op" id="588489">)</span>&nbsp;<span class="op" id="588491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="588494">defer</span>&nbsp;<span class="ident" id="588500">afterTest</span><span class="op" id="588509">(</span><span class="ident" id="588510">t</span><span class="op" id="588511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588514">tr</span>&nbsp;<span class="op" id="588517">:=</span>&nbsp;<span class="op" id="588520">&amp;</span><span class="ident" id="588521">Transport</span><span class="op" id="588530">{</span><span class="op" id="588531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588534">c</span>&nbsp;<span class="op" id="588536">:=</span>&nbsp;<span class="op" id="588539">&amp;</span><span class="ident" id="588540">Client</span><span class="op" id="588546">{</span><span class="ident" id="588547">Transport</span><span class="op" id="588556">:</span>&nbsp;<span class="ident" id="588558">tr</span><span class="op" id="588560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588564">unblockCh</span>&nbsp;<span class="op" id="588574">:=</span>&nbsp;<span class="builtinfunc" id="588577">make</span><span class="op" id="588581">(</span><span class="keyword" id="588582">chan</span>&nbsp;<span class="builtintype" id="588587">bool</span><span class="op" id="588591">,</span>&nbsp;<span class="num" id="588593">1</span><span class="op" id="588594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588597">ts</span>&nbsp;<span class="op" id="588600">:=</span>&nbsp;<span class="ident" id="588603">httptest</span><span class="op" id="588611">.</span><span class="ident" id="588612">NewServer</span><span class="op" id="588621">(</span><span class="ident" id="588622">HandlerFunc</span><span class="op" id="588633">(</span><span class="keyword" id="588634">func</span><span class="op" id="588638">(</span><span class="ident" id="588639">w</span>&nbsp;<span class="ident" id="588641">ResponseWriter</span><span class="op" id="588655">,</span>&nbsp;<span class="ident" id="588657">r</span>&nbsp;<span class="op" id="588659">*</span><span class="ident" id="588660">Request</span><span class="op" id="588667">)</span>&nbsp;<span class="op" id="588669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588673">&lt;-</span><span class="ident" id="588675">unblockCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588687">tr</span><span class="op" id="588689">.</span><span class="ident" id="588690">CloseIdleConnections</span><span class="op" id="588710">(</span><span class="op" id="588711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588714">}</span><span class="op" id="588715">)</span><span class="op" id="588716">)</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="588719">defer</span>&nbsp;<span class="ident" id="588725">ts</span><span class="op" id="588727">.</span><span class="ident" id="588728">Close</span><span class="op" id="588733">(</span><span class="op" id="588734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588738">didreq</span>&nbsp;<span class="op" id="588745">:=</span>&nbsp;<span class="builtinfunc" id="588748">make</span><span class="op" id="588752">(</span><span class="keyword" id="588753">chan</span>&nbsp;<span class="builtintype" id="588758">bool</span><span class="op" id="588762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="588765">go</span>&nbsp;<span class="keyword" id="588768">func</span><span class="op" id="588772">(</span><span class="op" id="588773">)</span>&nbsp;<span class="op" id="588775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588779">res</span><span class="op" id="588782">,</span>&nbsp;<span class="ident" id="588784">err</span>&nbsp;<span class="op" id="588788">:=</span>&nbsp;<span class="ident" id="588791">c</span><span class="op" id="588792">.</span><span class="ident" id="588793">Get</span><span class="op" id="588796">(</span><span class="ident" id="588797">ts</span><span class="op" id="588799">.</span><span class="ident" id="588800">URL</span><span class="op" id="588803">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="588807">if</span>&nbsp;<span class="ident" id="588810">err</span>&nbsp;<span class="op" id="588814">!=</span>&nbsp;<span class="ident" id="588817">nil</span>&nbsp;<span class="op" id="588821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588826">t</span><span class="op" id="588827">.</span><span class="ident" id="588828">Error</span><span class="op" id="588833">(</span><span class="ident" id="588834">err</span><span class="op" id="588837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588841">}</span>&nbsp;<span class="keyword" id="588843">else</span>&nbsp;<span class="op" id="588848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588853">res</span><span class="op" id="588856">.</span><span class="ident" id="588857">Body</span><span class="op" id="588861">.</span><span class="ident" id="588862">Close</span><span class="op" id="588867">(</span><span class="op" id="588868">)</span>&nbsp;<span class="comment" id="588870">//&nbsp;returns&nbsp;idle&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588893">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588897">didreq</span>&nbsp;<span class="op" id="588904">&lt;-</span>&nbsp;<span class="builtintype" id="588907">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588913">}</span><span class="op" id="588914">(</span><span class="op" id="588915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="588918">unblockCh</span>&nbsp;<span class="op" id="588928">&lt;-</span>&nbsp;<span class="builtintype" id="588931">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="588937">&lt;-</span><span class="ident" id="588939">didreq</span><br>
<span class="lineno"></span><span class="op" id="588946">}</span><br>
<span class="lineno">970</span><br>
<span class="lineno"></span><span class="comment" id="588949">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;transport&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;TCP&nbsp;connection&nbsp;early,</span><br>
<span class="lineno"></span><span class="comment" id="589016">//&nbsp;before&nbsp;the&nbsp;response&nbsp;body&nbsp;has&nbsp;been&nbsp;read.&nbsp;&nbsp;This&nbsp;was&nbsp;a&nbsp;regression</span><br>
<span class="lineno"></span><span class="comment" id="589082">//&nbsp;which&nbsp;sadly&nbsp;lacked&nbsp;a&nbsp;triggering&nbsp;test.&nbsp;&nbsp;The&nbsp;large&nbsp;response&nbsp;body&nbsp;made</span><br>
<span class="lineno"></span><span class="comment" id="589153">//&nbsp;the&nbsp;old&nbsp;race&nbsp;easier&nbsp;to&nbsp;trigger.</span><br>
<span class="lineno">975</span><span class="keyword" id="589188">func</span>&nbsp;<span class="ident" id="589193">TestIssue3644</span><span class="op" id="589206">(</span><span class="ident" id="589207">t</span>&nbsp;<span class="op" id="589209">*</span><span class="ident" id="589210">testing</span><span class="op" id="589217">.</span><span class="ident" id="589218">T</span><span class="op" id="589219">)</span>&nbsp;<span class="op" id="589221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589224">defer</span>&nbsp;<span class="ident" id="589230">afterTest</span><span class="op" id="589239">(</span><span class="ident" id="589240">t</span><span class="op" id="589241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589244">const</span>&nbsp;<span class="ident" id="589250">numFoos</span>&nbsp;<span class="op" id="589258">=</span>&nbsp;<span class="num" id="589260">5000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589266">ts</span>&nbsp;<span class="op" id="589269">:=</span>&nbsp;<span class="ident" id="589272">httptest</span><span class="op" id="589280">.</span><span class="ident" id="589281">NewServer</span><span class="op" id="589290">(</span><span class="ident" id="589291">HandlerFunc</span><span class="op" id="589302">(</span><span class="keyword" id="589303">func</span><span class="op" id="589307">(</span><span class="ident" id="589308">w</span>&nbsp;<span class="ident" id="589310">ResponseWriter</span><span class="op" id="589324">,</span>&nbsp;<span class="ident" id="589326">r</span>&nbsp;<span class="op" id="589328">*</span><span class="ident" id="589329">Request</span><span class="op" id="589336">)</span>&nbsp;<span class="op" id="589338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589342">w</span><span class="op" id="589343">.</span><span class="ident" id="589344">Header</span><span class="op" id="589350">(</span><span class="op" id="589351">)</span><span class="op" id="589352">.</span><span class="ident" id="589353">Set</span><span class="op" id="589356">(</span><span class="string" id="589357">&#34;Connection&#34;</span><span class="op" id="589369">,</span>&nbsp;<span class="string" id="589371">&#34;close&#34;</span><span class="op" id="589378">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589382">for</span>&nbsp;<span class="ident" id="589386">i</span>&nbsp;<span class="op" id="589388">:=</span>&nbsp;<span class="num" id="589391">0</span><span class="op" id="589392">;</span>&nbsp;<span class="ident" id="589394">i</span>&nbsp;<span class="op" id="589396">&lt;</span>&nbsp;<span class="ident" id="589398">numFoos</span><span class="op" id="589405">;</span>&nbsp;<span class="ident" id="589407">i</span><span class="op" id="589408">++</span>&nbsp;<span class="op" id="589411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589416">w</span><span class="op" id="589417">.</span><span class="ident" id="589418">Write</span><span class="op" id="589423">(</span><span class="op" id="589424">[</span><span class="op" id="589425">]</span><span class="builtintype" id="589426">byte</span><span class="op" id="589430">(</span><span class="string" id="589431">&#34;foo&nbsp;&#34;</span><span class="op" id="589437">)</span><span class="op" id="589438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="589442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="589445">}</span><span class="op" id="589446">)</span><span class="op" id="589447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589450">defer</span>&nbsp;<span class="ident" id="589456">ts</span><span class="op" id="589458">.</span><span class="ident" id="589459">Close</span><span class="op" id="589464">(</span><span class="op" id="589465">)</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589468">tr</span>&nbsp;<span class="op" id="589471">:=</span>&nbsp;<span class="op" id="589474">&amp;</span><span class="ident" id="589475">Transport</span><span class="op" id="589484">{</span><span class="op" id="589485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589488">c</span>&nbsp;<span class="op" id="589490">:=</span>&nbsp;<span class="op" id="589493">&amp;</span><span class="ident" id="589494">Client</span><span class="op" id="589500">{</span><span class="ident" id="589501">Transport</span><span class="op" id="589510">:</span>&nbsp;<span class="ident" id="589512">tr</span><span class="op" id="589514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589517">res</span><span class="op" id="589520">,</span>&nbsp;<span class="ident" id="589522">err</span>&nbsp;<span class="op" id="589526">:=</span>&nbsp;<span class="ident" id="589529">c</span><span class="op" id="589530">.</span><span class="ident" id="589531">Get</span><span class="op" id="589534">(</span><span class="ident" id="589535">ts</span><span class="op" id="589537">.</span><span class="ident" id="589538">URL</span><span class="op" id="589541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589544">if</span>&nbsp;<span class="ident" id="589547">err</span>&nbsp;<span class="op" id="589551">!=</span>&nbsp;<span class="ident" id="589554">nil</span>&nbsp;<span class="op" id="589558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589562">t</span><span class="op" id="589563">.</span><span class="ident" id="589564">Fatal</span><span class="op" id="589569">(</span><span class="ident" id="589570">err</span><span class="op" id="589573">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="589576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589579">defer</span>&nbsp;<span class="ident" id="589585">res</span><span class="op" id="589588">.</span><span class="ident" id="589589">Body</span><span class="op" id="589593">.</span><span class="ident" id="589594">Close</span><span class="op" id="589599">(</span><span class="op" id="589600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589603">bs</span><span class="op" id="589605">,</span>&nbsp;<span class="ident" id="589607">err</span>&nbsp;<span class="op" id="589611">:=</span>&nbsp;<span class="ident" id="589614">ioutil</span><span class="op" id="589620">.</span><span class="ident" id="589621">ReadAll</span><span class="op" id="589628">(</span><span class="ident" id="589629">res</span><span class="op" id="589632">.</span><span class="ident" id="589633">Body</span><span class="op" id="589637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589640">if</span>&nbsp;<span class="ident" id="589643">err</span>&nbsp;<span class="op" id="589647">!=</span>&nbsp;<span class="ident" id="589650">nil</span>&nbsp;<span class="op" id="589654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589658">t</span><span class="op" id="589659">.</span><span class="ident" id="589660">Fatal</span><span class="op" id="589665">(</span><span class="ident" id="589666">err</span><span class="op" id="589669">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="589672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589675">if</span>&nbsp;<span class="builtinfunc" id="589678">len</span><span class="op" id="589681">(</span><span class="ident" id="589682">bs</span><span class="op" id="589684">)</span>&nbsp;<span class="op" id="589686">!=</span>&nbsp;<span class="ident" id="589689">numFoos</span><span class="op" id="589696">*</span><span class="builtinfunc" id="589697">len</span><span class="op" id="589700">(</span><span class="string" id="589701">&#34;foo&nbsp;&#34;</span><span class="op" id="589707">)</span>&nbsp;<span class="op" id="589709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589713">t</span><span class="op" id="589714">.</span><span class="ident" id="589715">Errorf</span><span class="op" id="589721">(</span><span class="string" id="589722">&#34;unexpected&nbsp;response&nbsp;length&#34;</span><span class="op" id="589750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="589753">}</span><br>
<span class="lineno"></span><span class="op" id="589755">}</span><br>
<span class="lineno">1000</span><br>
<span class="lineno"></span><span class="comment" id="589758">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;client&nbsp;receives&nbsp;a&nbsp;server&#39;s&nbsp;reply,&nbsp;even&nbsp;if&nbsp;the&nbsp;server&nbsp;doesn&#39;t&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="589839">//&nbsp;the&nbsp;entire&nbsp;request&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="589867">func</span>&nbsp;<span class="ident" id="589872">TestIssue3595</span><span class="op" id="589885">(</span><span class="ident" id="589886">t</span>&nbsp;<span class="op" id="589888">*</span><span class="ident" id="589889">testing</span><span class="op" id="589896">.</span><span class="ident" id="589897">T</span><span class="op" id="589898">)</span>&nbsp;<span class="op" id="589900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589903">defer</span>&nbsp;<span class="ident" id="589909">afterTest</span><span class="op" id="589918">(</span><span class="ident" id="589919">t</span><span class="op" id="589920">)</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="589923">const</span>&nbsp;<span class="ident" id="589929">deniedMsg</span>&nbsp;<span class="op" id="589939">=</span>&nbsp;<span class="string" id="589941">&#34;sorry,&nbsp;denied.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="589959">ts</span>&nbsp;<span class="op" id="589962">:=</span>&nbsp;<span class="ident" id="589965">httptest</span><span class="op" id="589973">.</span><span class="ident" id="589974">NewServer</span><span class="op" id="589983">(</span><span class="ident" id="589984">HandlerFunc</span><span class="op" id="589995">(</span><span class="keyword" id="589996">func</span><span class="op" id="590000">(</span><span class="ident" id="590001">w</span>&nbsp;<span class="ident" id="590003">ResponseWriter</span><span class="op" id="590017">,</span>&nbsp;<span class="ident" id="590019">r</span>&nbsp;<span class="op" id="590021">*</span><span class="ident" id="590022">Request</span><span class="op" id="590029">)</span>&nbsp;<span class="op" id="590031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590035">Error</span><span class="op" id="590040">(</span><span class="ident" id="590041">w</span><span class="op" id="590042">,</span>&nbsp;<span class="ident" id="590044">deniedMsg</span><span class="op" id="590053">,</span>&nbsp;<span class="ident" id="590055">StatusUnauthorized</span><span class="op" id="590073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="590076">}</span><span class="op" id="590077">)</span><span class="op" id="590078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590081">defer</span>&nbsp;<span class="ident" id="590087">ts</span><span class="op" id="590089">.</span><span class="ident" id="590090">Close</span><span class="op" id="590095">(</span><span class="op" id="590096">)</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590099">tr</span>&nbsp;<span class="op" id="590102">:=</span>&nbsp;<span class="op" id="590105">&amp;</span><span class="ident" id="590106">Transport</span><span class="op" id="590115">{</span><span class="op" id="590116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590119">c</span>&nbsp;<span class="op" id="590121">:=</span>&nbsp;<span class="op" id="590124">&amp;</span><span class="ident" id="590125">Client</span><span class="op" id="590131">{</span><span class="ident" id="590132">Transport</span><span class="op" id="590141">:</span>&nbsp;<span class="ident" id="590143">tr</span><span class="op" id="590145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590148">res</span><span class="op" id="590151">,</span>&nbsp;<span class="ident" id="590153">err</span>&nbsp;<span class="op" id="590157">:=</span>&nbsp;<span class="ident" id="590160">c</span><span class="op" id="590161">.</span><span class="ident" id="590162">Post</span><span class="op" id="590166">(</span><span class="ident" id="590167">ts</span><span class="op" id="590169">.</span><span class="ident" id="590170">URL</span><span class="op" id="590173">,</span>&nbsp;<span class="string" id="590175">&#34;application/octet-stream&#34;</span><span class="op" id="590201">,</span>&nbsp;<span class="ident" id="590203">neverEnding</span><span class="op" id="590214">(</span><span class="string" id="590215">&#39;a&#39;</span><span class="op" id="590218">)</span><span class="op" id="590219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590222">if</span>&nbsp;<span class="ident" id="590225">err</span>&nbsp;<span class="op" id="590229">!=</span>&nbsp;<span class="ident" id="590232">nil</span>&nbsp;<span class="op" id="590236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590240">t</span><span class="op" id="590241">.</span><span class="ident" id="590242">Errorf</span><span class="op" id="590248">(</span><span class="string" id="590249">&#34;Post:&nbsp;%v&#34;</span><span class="op" id="590259">,</span>&nbsp;<span class="ident" id="590261">err</span><span class="op" id="590264">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590268">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="590276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590279">got</span><span class="op" id="590282">,</span>&nbsp;<span class="ident" id="590284">err</span>&nbsp;<span class="op" id="590288">:=</span>&nbsp;<span class="ident" id="590291">ioutil</span><span class="op" id="590297">.</span><span class="ident" id="590298">ReadAll</span><span class="op" id="590305">(</span><span class="ident" id="590306">res</span><span class="op" id="590309">.</span><span class="ident" id="590310">Body</span><span class="op" id="590314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590317">if</span>&nbsp;<span class="ident" id="590320">err</span>&nbsp;<span class="op" id="590324">!=</span>&nbsp;<span class="ident" id="590327">nil</span>&nbsp;<span class="op" id="590331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590335">t</span><span class="op" id="590336">.</span><span class="ident" id="590337">Fatalf</span><span class="op" id="590343">(</span><span class="string" id="590344">&#34;Body&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="590362">,</span>&nbsp;<span class="ident" id="590364">err</span><span class="op" id="590367">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="590370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590373">if</span>&nbsp;<span class="op" id="590376">!</span><span class="ident" id="590377">strings</span><span class="op" id="590384">.</span><span class="ident" id="590385">Contains</span><span class="op" id="590393">(</span><span class="builtintype" id="590394">string</span><span class="op" id="590400">(</span><span class="ident" id="590401">got</span><span class="op" id="590404">)</span><span class="op" id="590405">,</span>&nbsp;<span class="ident" id="590407">deniedMsg</span><span class="op" id="590416">)</span>&nbsp;<span class="op" id="590418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590422">t</span><span class="op" id="590423">.</span><span class="ident" id="590424">Errorf</span><span class="op" id="590430">(</span><span class="string" id="590431">&#34;Known&nbsp;bug:&nbsp;response&nbsp;%q&nbsp;does&nbsp;not&nbsp;contain&nbsp;%q&#34;</span><span class="op" id="590475">,</span>&nbsp;<span class="ident" id="590477">got</span><span class="op" id="590480">,</span>&nbsp;<span class="ident" id="590482">deniedMsg</span><span class="op" id="590491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="590494">}</span><br>
<span class="lineno"></span><span class="op" id="590496">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span><span class="comment" id="590499">//&nbsp;From&nbsp;http://golang.org/issue/4454&nbsp;,</span><br>
<span class="lineno"></span><span class="comment" id="590538">//&nbsp;&#34;client&nbsp;fails&nbsp;to&nbsp;handle&nbsp;requests&nbsp;with&nbsp;no&nbsp;body&nbsp;and&nbsp;chunked&nbsp;encoding&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="590609">func</span>&nbsp;<span class="ident" id="590614">TestChunkedNoContent</span><span class="op" id="590634">(</span><span class="ident" id="590635">t</span>&nbsp;<span class="op" id="590637">*</span><span class="ident" id="590638">testing</span><span class="op" id="590645">.</span><span class="ident" id="590646">T</span><span class="op" id="590647">)</span>&nbsp;<span class="op" id="590649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590652">defer</span>&nbsp;<span class="ident" id="590658">afterTest</span><span class="op" id="590667">(</span><span class="ident" id="590668">t</span><span class="op" id="590669">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590672">ts</span>&nbsp;<span class="op" id="590675">:=</span>&nbsp;<span class="ident" id="590678">httptest</span><span class="op" id="590686">.</span><span class="ident" id="590687">NewServer</span><span class="op" id="590696">(</span><span class="ident" id="590697">HandlerFunc</span><span class="op" id="590708">(</span><span class="keyword" id="590709">func</span><span class="op" id="590713">(</span><span class="ident" id="590714">w</span>&nbsp;<span class="ident" id="590716">ResponseWriter</span><span class="op" id="590730">,</span>&nbsp;<span class="ident" id="590732">r</span>&nbsp;<span class="op" id="590734">*</span><span class="ident" id="590735">Request</span><span class="op" id="590742">)</span>&nbsp;<span class="op" id="590744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590748">w</span><span class="op" id="590749">.</span><span class="ident" id="590750">WriteHeader</span><span class="op" id="590761">(</span><span class="ident" id="590762">StatusNoContent</span><span class="op" id="590777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="590780">}</span><span class="op" id="590781">)</span><span class="op" id="590782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590785">defer</span>&nbsp;<span class="ident" id="590791">ts</span><span class="op" id="590793">.</span><span class="ident" id="590794">Close</span><span class="op" id="590799">(</span><span class="op" id="590800">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590804">for</span>&nbsp;<span class="ident" id="590808">_</span><span class="op" id="590809">,</span>&nbsp;<span class="ident" id="590811">closeBody</span>&nbsp;<span class="op" id="590821">:=</span>&nbsp;<span class="keyword" id="590824">range</span>&nbsp;<span class="op" id="590830">[</span><span class="op" id="590831">]</span><span class="builtintype" id="590832">bool</span><span class="op" id="590836">{</span><span class="builtintype" id="590837">true</span><span class="op" id="590841">,</span>&nbsp;<span class="builtintype" id="590843">false</span><span class="op" id="590848">}</span>&nbsp;<span class="op" id="590850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590854">c</span>&nbsp;<span class="op" id="590856">:=</span>&nbsp;<span class="op" id="590859">&amp;</span><span class="ident" id="590860">Client</span><span class="op" id="590866">{</span><span class="ident" id="590867">Transport</span><span class="op" id="590876">:</span>&nbsp;<span class="op" id="590878">&amp;</span><span class="ident" id="590879">Transport</span><span class="op" id="590888">{</span><span class="op" id="590889">}</span><span class="op" id="590890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590894">const</span>&nbsp;<span class="ident" id="590900">n</span>&nbsp;<span class="op" id="590902">=</span>&nbsp;<span class="num" id="590904">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590908">for</span>&nbsp;<span class="ident" id="590912">i</span>&nbsp;<span class="op" id="590914">:=</span>&nbsp;<span class="num" id="590917">1</span><span class="op" id="590918">;</span>&nbsp;<span class="ident" id="590920">i</span>&nbsp;<span class="op" id="590922">&lt;=</span>&nbsp;<span class="ident" id="590925">n</span><span class="op" id="590926">;</span>&nbsp;<span class="ident" id="590928">i</span><span class="op" id="590929">++</span>&nbsp;<span class="op" id="590932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590937">res</span><span class="op" id="590940">,</span>&nbsp;<span class="ident" id="590942">err</span>&nbsp;<span class="op" id="590946">:=</span>&nbsp;<span class="ident" id="590949">c</span><span class="op" id="590950">.</span><span class="ident" id="590951">Get</span><span class="op" id="590954">(</span><span class="ident" id="590955">ts</span><span class="op" id="590957">.</span><span class="ident" id="590958">URL</span><span class="op" id="590961">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="590966">if</span>&nbsp;<span class="ident" id="590969">err</span>&nbsp;<span class="op" id="590973">!=</span>&nbsp;<span class="ident" id="590976">nil</span>&nbsp;<span class="op" id="590980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="590986">t</span><span class="op" id="590987">.</span><span class="ident" id="590988">Errorf</span><span class="op" id="590994">(</span><span class="string" id="590995">&#34;closingBody=%v,&nbsp;req&nbsp;%d/%d:&nbsp;%v&#34;</span><span class="op" id="591026">,</span>&nbsp;<span class="ident" id="591028">closeBody</span><span class="op" id="591037">,</span>&nbsp;<span class="ident" id="591039">i</span><span class="op" id="591040">,</span>&nbsp;<span class="ident" id="591042">n</span><span class="op" id="591043">,</span>&nbsp;<span class="ident" id="591045">err</span><span class="op" id="591048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591053">}</span>&nbsp;<span class="keyword" id="591055">else</span>&nbsp;<span class="op" id="591060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591066">if</span>&nbsp;<span class="ident" id="591069">closeBody</span>&nbsp;<span class="op" id="591079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591086">res</span><span class="op" id="591089">.</span><span class="ident" id="591090">Body</span><span class="op" id="591094">.</span><span class="ident" id="591095">Close</span><span class="op" id="591100">(</span><span class="op" id="591101">)</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591119">}</span><br>
<span class="lineno"></span><span class="op" id="591121">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="591124">func</span>&nbsp;<span class="ident" id="591129">TestTransportConcurrency</span><span class="op" id="591153">(</span><span class="ident" id="591154">t</span>&nbsp;<span class="op" id="591156">*</span><span class="ident" id="591157">testing</span><span class="op" id="591164">.</span><span class="ident" id="591165">T</span><span class="op" id="591166">)</span>&nbsp;<span class="op" id="591168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591171">defer</span>&nbsp;<span class="ident" id="591177">afterTest</span><span class="op" id="591186">(</span><span class="ident" id="591187">t</span><span class="op" id="591188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591191">maxProcs</span><span class="op" id="591199">,</span>&nbsp;<span class="ident" id="591201">numReqs</span>&nbsp;<span class="op" id="591209">:=</span>&nbsp;<span class="num" id="591212">16</span><span class="op" id="591214">,</span>&nbsp;<span class="num" id="591216">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591221">if</span>&nbsp;<span class="ident" id="591224">testing</span><span class="op" id="591231">.</span><span class="ident" id="591232">Short</span><span class="op" id="591237">(</span><span class="op" id="591238">)</span>&nbsp;<span class="op" id="591240">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591244">maxProcs</span><span class="op" id="591252">,</span>&nbsp;<span class="ident" id="591254">numReqs</span>&nbsp;<span class="op" id="591262">=</span>&nbsp;<span class="num" id="591264">4</span><span class="op" id="591265">,</span>&nbsp;<span class="num" id="591267">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591274">defer</span>&nbsp;<span class="ident" id="591280">runtime</span><span class="op" id="591287">.</span><span class="ident" id="591288">GOMAXPROCS</span><span class="op" id="591298">(</span><span class="ident" id="591299">runtime</span><span class="op" id="591306">.</span><span class="ident" id="591307">GOMAXPROCS</span><span class="op" id="591317">(</span><span class="ident" id="591318">maxProcs</span><span class="op" id="591326">)</span><span class="op" id="591327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591330">ts</span>&nbsp;<span class="op" id="591333">:=</span>&nbsp;<span class="ident" id="591336">httptest</span><span class="op" id="591344">.</span><span class="ident" id="591345">NewServer</span><span class="op" id="591354">(</span><span class="ident" id="591355">HandlerFunc</span><span class="op" id="591366">(</span><span class="keyword" id="591367">func</span><span class="op" id="591371">(</span><span class="ident" id="591372">w</span>&nbsp;<span class="ident" id="591374">ResponseWriter</span><span class="op" id="591388">,</span>&nbsp;<span class="ident" id="591390">r</span>&nbsp;<span class="op" id="591392">*</span><span class="ident" id="591393">Request</span><span class="op" id="591400">)</span>&nbsp;<span class="op" id="591402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591406">fmt</span><span class="op" id="591409">.</span><span class="ident" id="591410">Fprintf</span><span class="op" id="591417">(</span><span class="ident" id="591418">w</span><span class="op" id="591419">,</span>&nbsp;<span class="string" id="591421">&#34;%v&#34;</span><span class="op" id="591425">,</span>&nbsp;<span class="ident" id="591427">r</span><span class="op" id="591428">.</span><span class="ident" id="591429">FormValue</span><span class="op" id="591438">(</span><span class="string" id="591439">&#34;echo&#34;</span><span class="op" id="591445">)</span><span class="op" id="591446">)</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="591449">}</span><span class="op" id="591450">)</span><span class="op" id="591451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591454">defer</span>&nbsp;<span class="ident" id="591460">ts</span><span class="op" id="591462">.</span><span class="ident" id="591463">Close</span><span class="op" id="591468">(</span><span class="op" id="591469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591473">var</span>&nbsp;<span class="ident" id="591477">wg</span>&nbsp;<span class="ident" id="591480">sync</span><span class="op" id="591484">.</span><span class="ident" id="591485">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591496">wg</span><span class="op" id="591498">.</span><span class="ident" id="591499">Add</span><span class="op" id="591502">(</span><span class="ident" id="591503">numReqs</span><span class="op" id="591510">)</span><br>
<span class="lineno">1065</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="591514">//&nbsp;Due&nbsp;to&nbsp;the&nbsp;Transport&#39;s&nbsp;&#34;socket&nbsp;late&nbsp;binding&#34;&nbsp;(see</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="591568">//&nbsp;idleConnCh&nbsp;in&nbsp;transport.go),&nbsp;the&nbsp;numReqs&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="591627">//&nbsp;below&nbsp;can&nbsp;finish&nbsp;with&nbsp;a&nbsp;dial&nbsp;still&nbsp;outstanding.&nbsp;&nbsp;To&nbsp;keep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="591688">//&nbsp;the&nbsp;leak&nbsp;checker&nbsp;happy,&nbsp;keep&nbsp;track&nbsp;of&nbsp;pending&nbsp;dials&nbsp;and</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="591748">//&nbsp;wait&nbsp;for&nbsp;them&nbsp;to&nbsp;finish&nbsp;(and&nbsp;be&nbsp;closed&nbsp;or&nbsp;returned&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="591810">//&nbsp;idle&nbsp;pool)&nbsp;before&nbsp;we&nbsp;close&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591859">SetPendingDialHooks</span><span class="op" id="591878">(</span><span class="keyword" id="591879">func</span><span class="op" id="591883">(</span><span class="op" id="591884">)</span>&nbsp;<span class="op" id="591886">{</span>&nbsp;<span class="ident" id="591888">wg</span><span class="op" id="591890">.</span><span class="ident" id="591891">Add</span><span class="op" id="591894">(</span><span class="num" id="591895">1</span><span class="op" id="591896">)</span>&nbsp;<span class="op" id="591898">}</span><span class="op" id="591899">,</span>&nbsp;<span class="ident" id="591901">wg</span><span class="op" id="591903">.</span><span class="ident" id="591904">Done</span><span class="op" id="591908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591911">defer</span>&nbsp;<span class="ident" id="591917">SetPendingDialHooks</span><span class="op" id="591936">(</span><span class="ident" id="591937">nil</span><span class="op" id="591940">,</span>&nbsp;<span class="ident" id="591942">nil</span><span class="op" id="591945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="591949">tr</span>&nbsp;<span class="op" id="591952">:=</span>&nbsp;<span class="op" id="591955">&amp;</span><span class="ident" id="591956">Transport</span><span class="op" id="591965">{</span><span class="op" id="591966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="591969">defer</span>&nbsp;<span class="ident" id="591975">tr</span><span class="op" id="591977">.</span><span class="ident" id="591978">CloseIdleConnections</span><span class="op" id="591998">(</span><span class="op" id="591999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592003">c</span>&nbsp;<span class="op" id="592005">:=</span>&nbsp;<span class="op" id="592008">&amp;</span><span class="ident" id="592009">Client</span><span class="op" id="592015">{</span><span class="ident" id="592016">Transport</span><span class="op" id="592025">:</span>&nbsp;<span class="ident" id="592027">tr</span><span class="op" id="592029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592032">reqs</span>&nbsp;<span class="op" id="592037">:=</span>&nbsp;<span class="builtinfunc" id="592040">make</span><span class="op" id="592044">(</span><span class="keyword" id="592045">chan</span>&nbsp;<span class="builtintype" id="592050">string</span><span class="op" id="592056">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592059">defer</span>&nbsp;<span class="builtinfunc" id="592065">close</span><span class="op" id="592070">(</span><span class="ident" id="592071">reqs</span><span class="op" id="592075">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592079">for</span>&nbsp;<span class="ident" id="592083">i</span>&nbsp;<span class="op" id="592085">:=</span>&nbsp;<span class="num" id="592088">0</span><span class="op" id="592089">;</span>&nbsp;<span class="ident" id="592091">i</span>&nbsp;<span class="op" id="592093">&lt;</span>&nbsp;<span class="ident" id="592095">maxProcs</span><span class="op" id="592103">*</span><span class="num" id="592104">2</span><span class="op" id="592105">;</span>&nbsp;<span class="ident" id="592107">i</span><span class="op" id="592108">++</span>&nbsp;<span class="op" id="592111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592115">go</span>&nbsp;<span class="keyword" id="592118">func</span><span class="op" id="592122">(</span><span class="op" id="592123">)</span>&nbsp;<span class="op" id="592125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592130">for</span>&nbsp;<span class="ident" id="592134">req</span>&nbsp;<span class="op" id="592138">:=</span>&nbsp;<span class="keyword" id="592141">range</span>&nbsp;<span class="ident" id="592147">reqs</span>&nbsp;<span class="op" id="592152">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592158">res</span><span class="op" id="592161">,</span>&nbsp;<span class="ident" id="592163">err</span>&nbsp;<span class="op" id="592167">:=</span>&nbsp;<span class="ident" id="592170">c</span><span class="op" id="592171">.</span><span class="ident" id="592172">Get</span><span class="op" id="592175">(</span><span class="ident" id="592176">ts</span><span class="op" id="592178">.</span><span class="ident" id="592179">URL</span>&nbsp;<span class="op" id="592183">+</span>&nbsp;<span class="string" id="592185">&#34;/?echo=&#34;</span>&nbsp;<span class="op" id="592195">+</span>&nbsp;<span class="ident" id="592197">req</span><span class="op" id="592200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592206">if</span>&nbsp;<span class="ident" id="592209">err</span>&nbsp;<span class="op" id="592213">!=</span>&nbsp;<span class="ident" id="592216">nil</span>&nbsp;<span class="op" id="592220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592227">t</span><span class="op" id="592228">.</span><span class="ident" id="592229">Errorf</span><span class="op" id="592235">(</span><span class="string" id="592236">&#34;error&nbsp;on&nbsp;req&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="592257">,</span>&nbsp;<span class="ident" id="592259">req</span><span class="op" id="592262">,</span>&nbsp;<span class="ident" id="592264">err</span><span class="op" id="592267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592274">wg</span><span class="op" id="592276">.</span><span class="ident" id="592277">Done</span><span class="op" id="592281">(</span><span class="op" id="592282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592289">continue</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592308">all</span><span class="op" id="592311">,</span>&nbsp;<span class="ident" id="592313">err</span>&nbsp;<span class="op" id="592317">:=</span>&nbsp;<span class="ident" id="592320">ioutil</span><span class="op" id="592326">.</span><span class="ident" id="592327">ReadAll</span><span class="op" id="592334">(</span><span class="ident" id="592335">res</span><span class="op" id="592338">.</span><span class="ident" id="592339">Body</span><span class="op" id="592343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592349">if</span>&nbsp;<span class="ident" id="592352">err</span>&nbsp;<span class="op" id="592356">!=</span>&nbsp;<span class="ident" id="592359">nil</span>&nbsp;<span class="op" id="592363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592370">t</span><span class="op" id="592371">.</span><span class="ident" id="592372">Errorf</span><span class="op" id="592378">(</span><span class="string" id="592379">&#34;read&nbsp;error&nbsp;on&nbsp;req&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="592405">,</span>&nbsp;<span class="ident" id="592407">req</span><span class="op" id="592410">,</span>&nbsp;<span class="ident" id="592412">err</span><span class="op" id="592415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592422">wg</span><span class="op" id="592424">.</span><span class="ident" id="592425">Done</span><span class="op" id="592429">(</span><span class="op" id="592430">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592437">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592456">if</span>&nbsp;<span class="builtintype" id="592459">string</span><span class="op" id="592465">(</span><span class="ident" id="592466">all</span><span class="op" id="592469">)</span>&nbsp;<span class="op" id="592471">!=</span>&nbsp;<span class="ident" id="592474">req</span>&nbsp;<span class="op" id="592478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592485">t</span><span class="op" id="592486">.</span><span class="ident" id="592487">Errorf</span><span class="op" id="592493">(</span><span class="string" id="592494">&#34;body&nbsp;of&nbsp;req&nbsp;%s&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="592524">,</span>&nbsp;<span class="ident" id="592526">req</span><span class="op" id="592529">,</span>&nbsp;<span class="ident" id="592531">all</span><span class="op" id="592534">,</span>&nbsp;<span class="ident" id="592536">req</span><span class="op" id="592539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592545">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592551">res</span><span class="op" id="592554">.</span><span class="ident" id="592555">Body</span><span class="op" id="592559">.</span><span class="ident" id="592560">Close</span><span class="op" id="592565">(</span><span class="op" id="592566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592572">wg</span><span class="op" id="592574">.</span><span class="ident" id="592575">Done</span><span class="op" id="592579">(</span><span class="op" id="592580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592589">}</span><span class="op" id="592590">(</span><span class="op" id="592591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592594">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592597">for</span>&nbsp;<span class="ident" id="592601">i</span>&nbsp;<span class="op" id="592603">:=</span>&nbsp;<span class="num" id="592606">0</span><span class="op" id="592607">;</span>&nbsp;<span class="ident" id="592609">i</span>&nbsp;<span class="op" id="592611">&lt;</span>&nbsp;<span class="ident" id="592613">numReqs</span><span class="op" id="592620">;</span>&nbsp;<span class="ident" id="592622">i</span><span class="op" id="592623">++</span>&nbsp;<span class="op" id="592626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592630">reqs</span>&nbsp;<span class="op" id="592635">&lt;-</span>&nbsp;<span class="ident" id="592638">fmt</span><span class="op" id="592641">.</span><span class="ident" id="592642">Sprintf</span><span class="op" id="592649">(</span><span class="string" id="592650">&#34;request-%d&#34;</span><span class="op" id="592662">,</span>&nbsp;<span class="ident" id="592664">i</span><span class="op" id="592665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592671">wg</span><span class="op" id="592673">.</span><span class="ident" id="592674">Wait</span><span class="op" id="592678">(</span><span class="op" id="592679">)</span><br>
<span class="lineno"></span><span class="op" id="592681">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span><span class="keyword" id="592684">func</span>&nbsp;<span class="ident" id="592689">TestIssue4191_InfiniteGetTimeout</span><span class="op" id="592721">(</span><span class="ident" id="592722">t</span>&nbsp;<span class="op" id="592724">*</span><span class="ident" id="592725">testing</span><span class="op" id="592732">.</span><span class="ident" id="592733">T</span><span class="op" id="592734">)</span>&nbsp;<span class="op" id="592736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592739">if</span>&nbsp;<span class="ident" id="592742">runtime</span><span class="op" id="592749">.</span><span class="ident" id="592750">GOOS</span>&nbsp;<span class="op" id="592755">==</span>&nbsp;<span class="string" id="592758">&#34;plan9&#34;</span>&nbsp;<span class="op" id="592766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592770">t</span><span class="op" id="592771">.</span><span class="ident" id="592772">Skip</span><span class="op" id="592776">(</span><span class="string" id="592777">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="592826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592829">}</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592832">defer</span>&nbsp;<span class="ident" id="592838">afterTest</span><span class="op" id="592847">(</span><span class="ident" id="592848">t</span><span class="op" id="592849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="592852">const</span>&nbsp;<span class="ident" id="592858">debug</span>&nbsp;<span class="op" id="592864">=</span>&nbsp;<span class="builtintype" id="592866">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592873">mux</span>&nbsp;<span class="op" id="592877">:=</span>&nbsp;<span class="ident" id="592880">NewServeMux</span><span class="op" id="592891">(</span><span class="op" id="592892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592895">mux</span><span class="op" id="592898">.</span><span class="ident" id="592899">HandleFunc</span><span class="op" id="592909">(</span><span class="string" id="592910">&#34;/get&#34;</span><span class="op" id="592916">,</span>&nbsp;<span class="keyword" id="592918">func</span><span class="op" id="592922">(</span><span class="ident" id="592923">w</span>&nbsp;<span class="ident" id="592925">ResponseWriter</span><span class="op" id="592939">,</span>&nbsp;<span class="ident" id="592941">r</span>&nbsp;<span class="op" id="592943">*</span><span class="ident" id="592944">Request</span><span class="op" id="592951">)</span>&nbsp;<span class="op" id="592953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592957">io</span><span class="op" id="592959">.</span><span class="ident" id="592960">Copy</span><span class="op" id="592964">(</span><span class="ident" id="592965">w</span><span class="op" id="592966">,</span>&nbsp;<span class="ident" id="592968">neverEnding</span><span class="op" id="592979">(</span><span class="string" id="592980">&#39;a&#39;</span><span class="op" id="592983">)</span><span class="op" id="592984">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="592987">}</span><span class="op" id="592988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="592991">ts</span>&nbsp;<span class="op" id="592994">:=</span>&nbsp;<span class="ident" id="592997">httptest</span><span class="op" id="593005">.</span><span class="ident" id="593006">NewServer</span><span class="op" id="593015">(</span><span class="ident" id="593016">mux</span><span class="op" id="593019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593022">timeout</span>&nbsp;<span class="op" id="593030">:=</span>&nbsp;<span class="num" id="593033">100</span>&nbsp;<span class="op" id="593037">*</span>&nbsp;<span class="ident" id="593039">time</span><span class="op" id="593043">.</span><span class="ident" id="593044">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593058">client</span>&nbsp;<span class="op" id="593065">:=</span>&nbsp;<span class="op" id="593068">&amp;</span><span class="ident" id="593069">Client</span><span class="op" id="593075">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593079">Transport</span><span class="op" id="593088">:</span>&nbsp;<span class="op" id="593090">&amp;</span><span class="ident" id="593091">Transport</span><span class="op" id="593100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593105">Dial</span><span class="op" id="593109">:</span>&nbsp;<span class="keyword" id="593111">func</span><span class="op" id="593115">(</span><span class="ident" id="593116">n</span><span class="op" id="593117">,</span>&nbsp;<span class="ident" id="593119">addr</span>&nbsp;<span class="builtintype" id="593124">string</span><span class="op" id="593130">)</span>&nbsp;<span class="op" id="593132">(</span><span class="ident" id="593133">net</span><span class="op" id="593136">.</span><span class="ident" id="593137">Conn</span><span class="op" id="593141">,</span>&nbsp;<span class="builtintype" id="593143">error</span><span class="op" id="593148">)</span>&nbsp;<span class="op" id="593150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593156">conn</span><span class="op" id="593160">,</span>&nbsp;<span class="ident" id="593162">err</span>&nbsp;<span class="op" id="593166">:=</span>&nbsp;<span class="ident" id="593169">net</span><span class="op" id="593172">.</span><span class="ident" id="593173">Dial</span><span class="op" id="593177">(</span><span class="ident" id="593178">n</span><span class="op" id="593179">,</span>&nbsp;<span class="ident" id="593181">addr</span><span class="op" id="593185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593191">if</span>&nbsp;<span class="ident" id="593194">err</span>&nbsp;<span class="op" id="593198">!=</span>&nbsp;<span class="ident" id="593201">nil</span>&nbsp;<span class="op" id="593205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593212">return</span>&nbsp;<span class="ident" id="593219">nil</span><span class="op" id="593222">,</span>&nbsp;<span class="ident" id="593224">err</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593238">conn</span><span class="op" id="593242">.</span><span class="ident" id="593243">SetDeadline</span><span class="op" id="593254">(</span><span class="ident" id="593255">time</span><span class="op" id="593259">.</span><span class="ident" id="593260">Now</span><span class="op" id="593263">(</span><span class="op" id="593264">)</span><span class="op" id="593265">.</span><span class="ident" id="593266">Add</span><span class="op" id="593269">(</span><span class="ident" id="593270">timeout</span><span class="op" id="593277">)</span><span class="op" id="593278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593284">if</span>&nbsp;<span class="ident" id="593287">debug</span>&nbsp;<span class="op" id="593293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593300">conn</span>&nbsp;<span class="op" id="593305">=</span>&nbsp;<span class="ident" id="593307">NewLoggingConn</span><span class="op" id="593321">(</span><span class="string" id="593322">&#34;client&#34;</span><span class="op" id="593330">,</span>&nbsp;<span class="ident" id="593332">conn</span><span class="op" id="593336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593342">}</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593348">return</span>&nbsp;<span class="ident" id="593355">conn</span><span class="op" id="593359">,</span>&nbsp;<span class="ident" id="593361">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593368">}</span><span class="op" id="593369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593374">DisableKeepAlives</span><span class="op" id="593391">:</span>&nbsp;<span class="builtintype" id="593393">true</span><span class="op" id="593397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593401">}</span><span class="op" id="593402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593405">}</span><br>
<span class="lineno">1140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593409">getFailed</span>&nbsp;<span class="op" id="593419">:=</span>&nbsp;<span class="builtintype" id="593422">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593429">nRuns</span>&nbsp;<span class="op" id="593435">:=</span>&nbsp;<span class="num" id="593438">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593441">if</span>&nbsp;<span class="ident" id="593444">testing</span><span class="op" id="593451">.</span><span class="ident" id="593452">Short</span><span class="op" id="593457">(</span><span class="op" id="593458">)</span>&nbsp;<span class="op" id="593460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593464">nRuns</span>&nbsp;<span class="op" id="593470">=</span>&nbsp;<span class="num" id="593472">1</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593478">for</span>&nbsp;<span class="ident" id="593482">i</span>&nbsp;<span class="op" id="593484">:=</span>&nbsp;<span class="num" id="593487">0</span><span class="op" id="593488">;</span>&nbsp;<span class="ident" id="593490">i</span>&nbsp;<span class="op" id="593492">&lt;</span>&nbsp;<span class="ident" id="593494">nRuns</span><span class="op" id="593499">;</span>&nbsp;<span class="ident" id="593501">i</span><span class="op" id="593502">++</span>&nbsp;<span class="op" id="593505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593509">if</span>&nbsp;<span class="ident" id="593512">debug</span>&nbsp;<span class="op" id="593518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="593523">println</span><span class="op" id="593530">(</span><span class="string" id="593531">&#34;run&#34;</span><span class="op" id="593536">,</span>&nbsp;<span class="ident" id="593538">i</span><span class="op" id="593539">+</span><span class="num" id="593540">1</span><span class="op" id="593541">,</span>&nbsp;<span class="string" id="593543">&#34;of&#34;</span><span class="op" id="593547">,</span>&nbsp;<span class="ident" id="593549">nRuns</span><span class="op" id="593554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593558">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593562">sres</span><span class="op" id="593566">,</span>&nbsp;<span class="ident" id="593568">err</span>&nbsp;<span class="op" id="593572">:=</span>&nbsp;<span class="ident" id="593575">client</span><span class="op" id="593581">.</span><span class="ident" id="593582">Get</span><span class="op" id="593585">(</span><span class="ident" id="593586">ts</span><span class="op" id="593588">.</span><span class="ident" id="593589">URL</span>&nbsp;<span class="op" id="593593">+</span>&nbsp;<span class="string" id="593595">&#34;/get&#34;</span><span class="op" id="593601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593605">if</span>&nbsp;<span class="ident" id="593608">err</span>&nbsp;<span class="op" id="593612">!=</span>&nbsp;<span class="ident" id="593615">nil</span>&nbsp;<span class="op" id="593619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593624">if</span>&nbsp;<span class="op" id="593627">!</span><span class="ident" id="593628">getFailed</span>&nbsp;<span class="op" id="593638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="593644">//&nbsp;Make&nbsp;the&nbsp;timeout&nbsp;longer,&nbsp;once.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593682">getFailed</span>&nbsp;<span class="op" id="593692">=</span>&nbsp;<span class="builtintype" id="593694">true</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593703">t</span><span class="op" id="593704">.</span><span class="ident" id="593705">Logf</span><span class="op" id="593709">(</span><span class="string" id="593710">&#34;increasing&nbsp;timeout&#34;</span><span class="op" id="593730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593736">i</span><span class="op" id="593737">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593744">timeout</span>&nbsp;<span class="op" id="593752">*=</span>&nbsp;<span class="num" id="593755">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593762">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593774">}</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593779">t</span><span class="op" id="593780">.</span><span class="ident" id="593781">Errorf</span><span class="op" id="593787">(</span><span class="string" id="593788">&#34;Error&nbsp;issuing&nbsp;GET:&nbsp;%v&#34;</span><span class="op" id="593811">,</span>&nbsp;<span class="ident" id="593813">err</span><span class="op" id="593816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593821">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593833">_</span><span class="op" id="593834">,</span>&nbsp;<span class="ident" id="593836">err</span>&nbsp;<span class="op" id="593840">=</span>&nbsp;<span class="ident" id="593842">io</span><span class="op" id="593844">.</span><span class="ident" id="593845">Copy</span><span class="op" id="593849">(</span><span class="ident" id="593850">ioutil</span><span class="op" id="593856">.</span><span class="ident" id="593857">Discard</span><span class="op" id="593864">,</span>&nbsp;<span class="ident" id="593866">sres</span><span class="op" id="593870">.</span><span class="ident" id="593871">Body</span><span class="op" id="593875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593879">if</span>&nbsp;<span class="ident" id="593882">err</span>&nbsp;<span class="op" id="593886">==</span>&nbsp;<span class="ident" id="593889">nil</span>&nbsp;<span class="op" id="593893">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="593898">t</span><span class="op" id="593899">.</span><span class="ident" id="593900">Errorf</span><span class="op" id="593906">(</span><span class="string" id="593907">&#34;Unexpected&nbsp;successful&nbsp;copy&#34;</span><span class="op" id="593935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593940">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="593951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="593954">if</span>&nbsp;<span class="ident" id="593957">debug</span>&nbsp;<span class="op" id="593963">{</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="593967">println</span><span class="op" id="593974">(</span><span class="string" id="593975">&#34;tests&nbsp;complete;&nbsp;waiting&nbsp;for&nbsp;handlers&nbsp;to&nbsp;finish&#34;</span><span class="op" id="594023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594029">ts</span><span class="op" id="594031">.</span><span class="ident" id="594032">Close</span><span class="op" id="594037">(</span><span class="op" id="594038">)</span><br>
<span class="lineno"></span><span class="op" id="594040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1175</span><span class="keyword" id="594043">func</span>&nbsp;<span class="ident" id="594048">TestIssue4191_InfiniteGetToPutTimeout</span><span class="op" id="594085">(</span><span class="ident" id="594086">t</span>&nbsp;<span class="op" id="594088">*</span><span class="ident" id="594089">testing</span><span class="op" id="594096">.</span><span class="ident" id="594097">T</span><span class="op" id="594098">)</span>&nbsp;<span class="op" id="594100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594103">if</span>&nbsp;<span class="ident" id="594106">runtime</span><span class="op" id="594113">.</span><span class="ident" id="594114">GOOS</span>&nbsp;<span class="op" id="594119">==</span>&nbsp;<span class="string" id="594122">&#34;plan9&#34;</span>&nbsp;<span class="op" id="594130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594134">t</span><span class="op" id="594135">.</span><span class="ident" id="594136">Skip</span><span class="op" id="594140">(</span><span class="string" id="594141">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7237&#34;</span><span class="op" id="594190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594196">defer</span>&nbsp;<span class="ident" id="594202">afterTest</span><span class="op" id="594211">(</span><span class="ident" id="594212">t</span><span class="op" id="594213">)</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594216">const</span>&nbsp;<span class="ident" id="594222">debug</span>&nbsp;<span class="op" id="594228">=</span>&nbsp;<span class="builtintype" id="594230">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594237">mux</span>&nbsp;<span class="op" id="594241">:=</span>&nbsp;<span class="ident" id="594244">NewServeMux</span><span class="op" id="594255">(</span><span class="op" id="594256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594259">mux</span><span class="op" id="594262">.</span><span class="ident" id="594263">HandleFunc</span><span class="op" id="594273">(</span><span class="string" id="594274">&#34;/get&#34;</span><span class="op" id="594280">,</span>&nbsp;<span class="keyword" id="594282">func</span><span class="op" id="594286">(</span><span class="ident" id="594287">w</span>&nbsp;<span class="ident" id="594289">ResponseWriter</span><span class="op" id="594303">,</span>&nbsp;<span class="ident" id="594305">r</span>&nbsp;<span class="op" id="594307">*</span><span class="ident" id="594308">Request</span><span class="op" id="594315">)</span>&nbsp;<span class="op" id="594317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594321">io</span><span class="op" id="594323">.</span><span class="ident" id="594324">Copy</span><span class="op" id="594328">(</span><span class="ident" id="594329">w</span><span class="op" id="594330">,</span>&nbsp;<span class="ident" id="594332">neverEnding</span><span class="op" id="594343">(</span><span class="string" id="594344">&#39;a&#39;</span><span class="op" id="594347">)</span><span class="op" id="594348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594351">}</span><span class="op" id="594352">)</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594355">mux</span><span class="op" id="594358">.</span><span class="ident" id="594359">HandleFunc</span><span class="op" id="594369">(</span><span class="string" id="594370">&#34;/put&#34;</span><span class="op" id="594376">,</span>&nbsp;<span class="keyword" id="594378">func</span><span class="op" id="594382">(</span><span class="ident" id="594383">w</span>&nbsp;<span class="ident" id="594385">ResponseWriter</span><span class="op" id="594399">,</span>&nbsp;<span class="ident" id="594401">r</span>&nbsp;<span class="op" id="594403">*</span><span class="ident" id="594404">Request</span><span class="op" id="594411">)</span>&nbsp;<span class="op" id="594413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594417">defer</span>&nbsp;<span class="ident" id="594423">r</span><span class="op" id="594424">.</span><span class="ident" id="594425">Body</span><span class="op" id="594429">.</span><span class="ident" id="594430">Close</span><span class="op" id="594435">(</span><span class="op" id="594436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594440">io</span><span class="op" id="594442">.</span><span class="ident" id="594443">Copy</span><span class="op" id="594447">(</span><span class="ident" id="594448">ioutil</span><span class="op" id="594454">.</span><span class="ident" id="594455">Discard</span><span class="op" id="594462">,</span>&nbsp;<span class="ident" id="594464">r</span><span class="op" id="594465">.</span><span class="ident" id="594466">Body</span><span class="op" id="594470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594473">}</span><span class="op" id="594474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594477">ts</span>&nbsp;<span class="op" id="594480">:=</span>&nbsp;<span class="ident" id="594483">httptest</span><span class="op" id="594491">.</span><span class="ident" id="594492">NewServer</span><span class="op" id="594501">(</span><span class="ident" id="594502">mux</span><span class="op" id="594505">)</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594508">timeout</span>&nbsp;<span class="op" id="594516">:=</span>&nbsp;<span class="num" id="594519">100</span>&nbsp;<span class="op" id="594523">*</span>&nbsp;<span class="ident" id="594525">time</span><span class="op" id="594529">.</span><span class="ident" id="594530">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594544">client</span>&nbsp;<span class="op" id="594551">:=</span>&nbsp;<span class="op" id="594554">&amp;</span><span class="ident" id="594555">Client</span><span class="op" id="594561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594565">Transport</span><span class="op" id="594574">:</span>&nbsp;<span class="op" id="594576">&amp;</span><span class="ident" id="594577">Transport</span><span class="op" id="594586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594591">Dial</span><span class="op" id="594595">:</span>&nbsp;<span class="keyword" id="594597">func</span><span class="op" id="594601">(</span><span class="ident" id="594602">n</span><span class="op" id="594603">,</span>&nbsp;<span class="ident" id="594605">addr</span>&nbsp;<span class="builtintype" id="594610">string</span><span class="op" id="594616">)</span>&nbsp;<span class="op" id="594618">(</span><span class="ident" id="594619">net</span><span class="op" id="594622">.</span><span class="ident" id="594623">Conn</span><span class="op" id="594627">,</span>&nbsp;<span class="builtintype" id="594629">error</span><span class="op" id="594634">)</span>&nbsp;<span class="op" id="594636">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594642">conn</span><span class="op" id="594646">,</span>&nbsp;<span class="ident" id="594648">err</span>&nbsp;<span class="op" id="594652">:=</span>&nbsp;<span class="ident" id="594655">net</span><span class="op" id="594658">.</span><span class="ident" id="594659">Dial</span><span class="op" id="594663">(</span><span class="ident" id="594664">n</span><span class="op" id="594665">,</span>&nbsp;<span class="ident" id="594667">addr</span><span class="op" id="594671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594677">if</span>&nbsp;<span class="ident" id="594680">err</span>&nbsp;<span class="op" id="594684">!=</span>&nbsp;<span class="ident" id="594687">nil</span>&nbsp;<span class="op" id="594691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594698">return</span>&nbsp;<span class="ident" id="594705">nil</span><span class="op" id="594708">,</span>&nbsp;<span class="ident" id="594710">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594724">conn</span><span class="op" id="594728">.</span><span class="ident" id="594729">SetDeadline</span><span class="op" id="594740">(</span><span class="ident" id="594741">time</span><span class="op" id="594745">.</span><span class="ident" id="594746">Now</span><span class="op" id="594749">(</span><span class="op" id="594750">)</span><span class="op" id="594751">.</span><span class="ident" id="594752">Add</span><span class="op" id="594755">(</span><span class="ident" id="594756">timeout</span><span class="op" id="594763">)</span><span class="op" id="594764">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594770">if</span>&nbsp;<span class="ident" id="594773">debug</span>&nbsp;<span class="op" id="594779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594786">conn</span>&nbsp;<span class="op" id="594791">=</span>&nbsp;<span class="ident" id="594793">NewLoggingConn</span><span class="op" id="594807">(</span><span class="string" id="594808">&#34;client&#34;</span><span class="op" id="594816">,</span>&nbsp;<span class="ident" id="594818">conn</span><span class="op" id="594822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594834">return</span>&nbsp;<span class="ident" id="594841">conn</span><span class="op" id="594845">,</span>&nbsp;<span class="ident" id="594847">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594854">}</span><span class="op" id="594855">,</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594860">DisableKeepAlives</span><span class="op" id="594877">:</span>&nbsp;<span class="builtintype" id="594879">true</span><span class="op" id="594883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594887">}</span><span class="op" id="594888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594895">getFailed</span>&nbsp;<span class="op" id="594905">:=</span>&nbsp;<span class="builtintype" id="594908">false</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594915">nRuns</span>&nbsp;<span class="op" id="594921">:=</span>&nbsp;<span class="num" id="594924">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594927">if</span>&nbsp;<span class="ident" id="594930">testing</span><span class="op" id="594937">.</span><span class="ident" id="594938">Short</span><span class="op" id="594943">(</span><span class="op" id="594944">)</span>&nbsp;<span class="op" id="594946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="594950">nRuns</span>&nbsp;<span class="op" id="594956">=</span>&nbsp;<span class="num" id="594958">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="594961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594964">for</span>&nbsp;<span class="ident" id="594968">i</span>&nbsp;<span class="op" id="594970">:=</span>&nbsp;<span class="num" id="594973">0</span><span class="op" id="594974">;</span>&nbsp;<span class="ident" id="594976">i</span>&nbsp;<span class="op" id="594978">&lt;</span>&nbsp;<span class="ident" id="594980">nRuns</span><span class="op" id="594985">;</span>&nbsp;<span class="ident" id="594987">i</span><span class="op" id="594988">++</span>&nbsp;<span class="op" id="594991">{</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="594995">if</span>&nbsp;<span class="ident" id="594998">debug</span>&nbsp;<span class="op" id="595004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="595009">println</span><span class="op" id="595016">(</span><span class="string" id="595017">&#34;run&#34;</span><span class="op" id="595022">,</span>&nbsp;<span class="ident" id="595024">i</span><span class="op" id="595025">+</span><span class="num" id="595026">1</span><span class="op" id="595027">,</span>&nbsp;<span class="string" id="595029">&#34;of&#34;</span><span class="op" id="595033">,</span>&nbsp;<span class="ident" id="595035">nRuns</span><span class="op" id="595040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595048">sres</span><span class="op" id="595052">,</span>&nbsp;<span class="ident" id="595054">err</span>&nbsp;<span class="op" id="595058">:=</span>&nbsp;<span class="ident" id="595061">client</span><span class="op" id="595067">.</span><span class="ident" id="595068">Get</span><span class="op" id="595071">(</span><span class="ident" id="595072">ts</span><span class="op" id="595074">.</span><span class="ident" id="595075">URL</span>&nbsp;<span class="op" id="595079">+</span>&nbsp;<span class="string" id="595081">&#34;/get&#34;</span><span class="op" id="595087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595091">if</span>&nbsp;<span class="ident" id="595094">err</span>&nbsp;<span class="op" id="595098">!=</span>&nbsp;<span class="ident" id="595101">nil</span>&nbsp;<span class="op" id="595105">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595110">if</span>&nbsp;<span class="op" id="595113">!</span><span class="ident" id="595114">getFailed</span>&nbsp;<span class="op" id="595124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="595130">//&nbsp;Make&nbsp;the&nbsp;timeout&nbsp;longer,&nbsp;once.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595168">getFailed</span>&nbsp;<span class="op" id="595178">=</span>&nbsp;<span class="builtintype" id="595180">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595189">t</span><span class="op" id="595190">.</span><span class="ident" id="595191">Logf</span><span class="op" id="595195">(</span><span class="string" id="595196">&#34;increasing&nbsp;timeout&#34;</span><span class="op" id="595216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595222">i</span><span class="op" id="595223">--</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595230">timeout</span>&nbsp;<span class="op" id="595238">*=</span>&nbsp;<span class="num" id="595241">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595248">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595265">t</span><span class="op" id="595266">.</span><span class="ident" id="595267">Errorf</span><span class="op" id="595273">(</span><span class="string" id="595274">&#34;Error&nbsp;issuing&nbsp;GET:&nbsp;%v&#34;</span><span class="op" id="595297">,</span>&nbsp;<span class="ident" id="595299">err</span><span class="op" id="595302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595307">break</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595319">req</span><span class="op" id="595322">,</span>&nbsp;<span class="ident" id="595324">_</span>&nbsp;<span class="op" id="595326">:=</span>&nbsp;<span class="ident" id="595329">NewRequest</span><span class="op" id="595339">(</span><span class="string" id="595340">&#34;PUT&#34;</span><span class="op" id="595345">,</span>&nbsp;<span class="ident" id="595347">ts</span><span class="op" id="595349">.</span><span class="ident" id="595350">URL</span><span class="op" id="595353">+</span><span class="string" id="595354">&#34;/put&#34;</span><span class="op" id="595360">,</span>&nbsp;<span class="ident" id="595362">sres</span><span class="op" id="595366">.</span><span class="ident" id="595367">Body</span><span class="op" id="595371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595375">_</span><span class="op" id="595376">,</span>&nbsp;<span class="ident" id="595378">err</span>&nbsp;<span class="op" id="595382">=</span>&nbsp;<span class="ident" id="595384">client</span><span class="op" id="595390">.</span><span class="ident" id="595391">Do</span><span class="op" id="595393">(</span><span class="ident" id="595394">req</span><span class="op" id="595397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595401">if</span>&nbsp;<span class="ident" id="595404">err</span>&nbsp;<span class="op" id="595408">==</span>&nbsp;<span class="ident" id="595411">nil</span>&nbsp;<span class="op" id="595415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595420">sres</span><span class="op" id="595424">.</span><span class="ident" id="595425">Body</span><span class="op" id="595429">.</span><span class="ident" id="595430">Close</span><span class="op" id="595435">(</span><span class="op" id="595436">)</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595441">t</span><span class="op" id="595442">.</span><span class="ident" id="595443">Errorf</span><span class="op" id="595449">(</span><span class="string" id="595450">&#34;Unexpected&nbsp;successful&nbsp;PUT&#34;</span><span class="op" id="595477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595482">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595494">sres</span><span class="op" id="595498">.</span><span class="ident" id="595499">Body</span><span class="op" id="595503">.</span><span class="ident" id="595504">Close</span><span class="op" id="595509">(</span><span class="op" id="595510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595513">}</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595516">if</span>&nbsp;<span class="ident" id="595519">debug</span>&nbsp;<span class="op" id="595525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="595529">println</span><span class="op" id="595536">(</span><span class="string" id="595537">&#34;tests&nbsp;complete;&nbsp;waiting&nbsp;for&nbsp;handlers&nbsp;to&nbsp;finish&#34;</span><span class="op" id="595585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595591">ts</span><span class="op" id="595593">.</span><span class="ident" id="595594">Close</span><span class="op" id="595599">(</span><span class="op" id="595600">)</span><br>
<span class="lineno"></span><span class="op" id="595602">}</span><br>
<span class="lineno">1245</span><br>
<span class="lineno"></span><span class="keyword" id="595605">func</span>&nbsp;<span class="ident" id="595610">TestTransportResponseHeaderTimeout</span><span class="op" id="595644">(</span><span class="ident" id="595645">t</span>&nbsp;<span class="op" id="595647">*</span><span class="ident" id="595648">testing</span><span class="op" id="595655">.</span><span class="ident" id="595656">T</span><span class="op" id="595657">)</span>&nbsp;<span class="op" id="595659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595662">defer</span>&nbsp;<span class="ident" id="595668">afterTest</span><span class="op" id="595677">(</span><span class="ident" id="595678">t</span><span class="op" id="595679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="595682">if</span>&nbsp;<span class="ident" id="595685">testing</span><span class="op" id="595692">.</span><span class="ident" id="595693">Short</span><span class="op" id="595698">(</span><span class="op" id="595699">)</span>&nbsp;<span class="op" id="595701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595705">t</span><span class="op" id="595706">.</span><span class="ident" id="595707">Skip</span><span class="op" id="595711">(</span><span class="string" id="595712">&#34;skipping&nbsp;timeout&nbsp;test&nbsp;in&nbsp;-short&nbsp;mode&#34;</span><span class="op" id="595750">)</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595756">inHandler</span>&nbsp;<span class="op" id="595766">:=</span>&nbsp;<span class="builtinfunc" id="595769">make</span><span class="op" id="595773">(</span><span class="keyword" id="595774">chan</span>&nbsp;<span class="builtintype" id="595779">bool</span><span class="op" id="595783">,</span>&nbsp;<span class="num" id="595785">1</span><span class="op" id="595786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595789">mux</span>&nbsp;<span class="op" id="595793">:=</span>&nbsp;<span class="ident" id="595796">NewServeMux</span><span class="op" id="595807">(</span><span class="op" id="595808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595811">mux</span><span class="op" id="595814">.</span><span class="ident" id="595815">HandleFunc</span><span class="op" id="595825">(</span><span class="string" id="595826">&#34;/fast&#34;</span><span class="op" id="595833">,</span>&nbsp;<span class="keyword" id="595835">func</span><span class="op" id="595839">(</span><span class="ident" id="595840">w</span>&nbsp;<span class="ident" id="595842">ResponseWriter</span><span class="op" id="595856">,</span>&nbsp;<span class="ident" id="595858">r</span>&nbsp;<span class="op" id="595860">*</span><span class="ident" id="595861">Request</span><span class="op" id="595868">)</span>&nbsp;<span class="op" id="595870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595874">inHandler</span>&nbsp;<span class="op" id="595884">&lt;-</span>&nbsp;<span class="builtintype" id="595887">true</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="595893">}</span><span class="op" id="595894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595897">mux</span><span class="op" id="595900">.</span><span class="ident" id="595901">HandleFunc</span><span class="op" id="595911">(</span><span class="string" id="595912">&#34;/slow&#34;</span><span class="op" id="595919">,</span>&nbsp;<span class="keyword" id="595921">func</span><span class="op" id="595925">(</span><span class="ident" id="595926">w</span>&nbsp;<span class="ident" id="595928">ResponseWriter</span><span class="op" id="595942">,</span>&nbsp;<span class="ident" id="595944">r</span>&nbsp;<span class="op" id="595946">*</span><span class="ident" id="595947">Request</span><span class="op" id="595954">)</span>&nbsp;<span class="op" id="595956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595960">inHandler</span>&nbsp;<span class="op" id="595970">&lt;-</span>&nbsp;<span class="builtintype" id="595973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="595980">time</span><span class="op" id="595984">.</span><span class="ident" id="595985">Sleep</span><span class="op" id="595990">(</span><span class="num" id="595991">2</span>&nbsp;<span class="op" id="595993">*</span>&nbsp;<span class="ident" id="595995">time</span><span class="op" id="595999">.</span><span class="ident" id="596000">Second</span><span class="op" id="596006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596009">}</span><span class="op" id="596010">)</span><br>
<span class="lineno">1260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596013">ts</span>&nbsp;<span class="op" id="596016">:=</span>&nbsp;<span class="ident" id="596019">httptest</span><span class="op" id="596027">.</span><span class="ident" id="596028">NewServer</span><span class="op" id="596037">(</span><span class="ident" id="596038">mux</span><span class="op" id="596041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596044">defer</span>&nbsp;<span class="ident" id="596050">ts</span><span class="op" id="596052">.</span><span class="ident" id="596053">Close</span><span class="op" id="596058">(</span><span class="op" id="596059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596063">tr</span>&nbsp;<span class="op" id="596066">:=</span>&nbsp;<span class="op" id="596069">&amp;</span><span class="ident" id="596070">Transport</span><span class="op" id="596079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596083">ResponseHeaderTimeout</span><span class="op" id="596104">:</span>&nbsp;<span class="num" id="596106">500</span>&nbsp;<span class="op" id="596110">*</span>&nbsp;<span class="ident" id="596112">time</span><span class="op" id="596116">.</span><span class="ident" id="596117">Millisecond</span><span class="op" id="596128">,</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596134">defer</span>&nbsp;<span class="ident" id="596140">tr</span><span class="op" id="596142">.</span><span class="ident" id="596143">CloseIdleConnections</span><span class="op" id="596163">(</span><span class="op" id="596164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596167">c</span>&nbsp;<span class="op" id="596169">:=</span>&nbsp;<span class="op" id="596172">&amp;</span><span class="ident" id="596173">Client</span><span class="op" id="596179">{</span><span class="ident" id="596180">Transport</span><span class="op" id="596189">:</span>&nbsp;<span class="ident" id="596191">tr</span><span class="op" id="596193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596197">tests</span>&nbsp;<span class="op" id="596203">:=</span>&nbsp;<span class="op" id="596206">[</span><span class="op" id="596207">]</span><span class="keyword" id="596208">struct</span>&nbsp;<span class="op" id="596215">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596219">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="596227">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596236">want</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="596244">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596250">wantErr</span>&nbsp;<span class="builtintype" id="596258">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596266">}</span><span class="op" id="596267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596271">{</span><span class="ident" id="596272">path</span><span class="op" id="596276">:</span>&nbsp;<span class="string" id="596278">&#34;/fast&#34;</span><span class="op" id="596285">,</span>&nbsp;<span class="ident" id="596287">want</span><span class="op" id="596291">:</span>&nbsp;<span class="num" id="596293">200</span><span class="op" id="596296">}</span><span class="op" id="596297">,</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596301">{</span><span class="ident" id="596302">path</span><span class="op" id="596306">:</span>&nbsp;<span class="string" id="596308">&#34;/slow&#34;</span><span class="op" id="596315">,</span>&nbsp;<span class="ident" id="596317">wantErr</span><span class="op" id="596324">:</span>&nbsp;<span class="string" id="596326">&#34;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="596361">}</span><span class="op" id="596362">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596366">{</span><span class="ident" id="596367">path</span><span class="op" id="596371">:</span>&nbsp;<span class="string" id="596373">&#34;/fast&#34;</span><span class="op" id="596380">,</span>&nbsp;<span class="ident" id="596382">want</span><span class="op" id="596386">:</span>&nbsp;<span class="num" id="596388">200</span><span class="op" id="596391">}</span><span class="op" id="596392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596398">for</span>&nbsp;<span class="ident" id="596402">i</span><span class="op" id="596403">,</span>&nbsp;<span class="ident" id="596405">tt</span>&nbsp;<span class="op" id="596408">:=</span>&nbsp;<span class="keyword" id="596411">range</span>&nbsp;<span class="ident" id="596417">tests</span>&nbsp;<span class="op" id="596423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596427">res</span><span class="op" id="596430">,</span>&nbsp;<span class="ident" id="596432">err</span>&nbsp;<span class="op" id="596436">:=</span>&nbsp;<span class="ident" id="596439">c</span><span class="op" id="596440">.</span><span class="ident" id="596441">Get</span><span class="op" id="596444">(</span><span class="ident" id="596445">ts</span><span class="op" id="596447">.</span><span class="ident" id="596448">URL</span>&nbsp;<span class="op" id="596452">+</span>&nbsp;<span class="ident" id="596454">tt</span><span class="op" id="596456">.</span><span class="ident" id="596457">path</span><span class="op" id="596461">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596465">select</span>&nbsp;<span class="op" id="596472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596476">case</span>&nbsp;<span class="op" id="596481">&lt;-</span><span class="ident" id="596483">inHandler</span><span class="op" id="596492">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596496">case</span>&nbsp;<span class="op" id="596501">&lt;-</span><span class="ident" id="596503">time</span><span class="op" id="596507">.</span><span class="ident" id="596508">After</span><span class="op" id="596513">(</span><span class="num" id="596514">5</span>&nbsp;<span class="op" id="596516">*</span>&nbsp;<span class="ident" id="596518">time</span><span class="op" id="596522">.</span><span class="ident" id="596523">Second</span><span class="op" id="596529">)</span><span class="op" id="596530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596535">t</span><span class="op" id="596536">.</span><span class="ident" id="596537">Errorf</span><span class="op" id="596543">(</span><span class="string" id="596544">&#34;never&nbsp;entered&nbsp;handler&nbsp;for&nbsp;test&nbsp;index&nbsp;%d,&nbsp;%s&#34;</span><span class="op" id="596589">,</span>&nbsp;<span class="ident" id="596591">i</span><span class="op" id="596592">,</span>&nbsp;<span class="ident" id="596594">tt</span><span class="op" id="596596">.</span><span class="ident" id="596597">path</span><span class="op" id="596601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596606">continue</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596621">if</span>&nbsp;<span class="ident" id="596624">err</span>&nbsp;<span class="op" id="596628">!=</span>&nbsp;<span class="ident" id="596631">nil</span>&nbsp;<span class="op" id="596635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596640">uerr</span><span class="op" id="596644">,</span>&nbsp;<span class="ident" id="596646">ok</span>&nbsp;<span class="op" id="596649">:=</span>&nbsp;<span class="ident" id="596652">err</span><span class="op" id="596655">.</span><span class="op" id="596656">(</span><span class="op" id="596657">*</span><span class="ident" id="596658">url</span><span class="op" id="596661">.</span><span class="ident" id="596662">Error</span><span class="op" id="596667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596672">if</span>&nbsp;<span class="op" id="596675">!</span><span class="ident" id="596676">ok</span>&nbsp;<span class="op" id="596679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596685">t</span><span class="op" id="596686">.</span><span class="ident" id="596687">Errorf</span><span class="op" id="596693">(</span><span class="string" id="596694">&#34;error&nbsp;is&nbsp;not&nbsp;an&nbsp;url.Error;&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="596731">,</span>&nbsp;<span class="ident" id="596733">err</span><span class="op" id="596736">)</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596742">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596759">nerr</span><span class="op" id="596763">,</span>&nbsp;<span class="ident" id="596765">ok</span>&nbsp;<span class="op" id="596768">:=</span>&nbsp;<span class="ident" id="596771">uerr</span><span class="op" id="596775">.</span><span class="ident" id="596776">Err</span><span class="op" id="596779">.</span><span class="op" id="596780">(</span><span class="ident" id="596781">net</span><span class="op" id="596784">.</span><span class="ident" id="596785">Error</span><span class="op" id="596790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596795">if</span>&nbsp;<span class="op" id="596798">!</span><span class="ident" id="596799">ok</span>&nbsp;<span class="op" id="596802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596808">t</span><span class="op" id="596809">.</span><span class="ident" id="596810">Errorf</span><span class="op" id="596816">(</span><span class="string" id="596817">&#34;error&nbsp;does&nbsp;not&nbsp;satisfy&nbsp;net.Error&nbsp;interface;&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="596871">,</span>&nbsp;<span class="ident" id="596873">err</span><span class="op" id="596876">)</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596882">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596899">if</span>&nbsp;<span class="op" id="596902">!</span><span class="ident" id="596903">nerr</span><span class="op" id="596907">.</span><span class="ident" id="596908">Timeout</span><span class="op" id="596915">(</span><span class="op" id="596916">)</span>&nbsp;<span class="op" id="596918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="596924">t</span><span class="op" id="596925">.</span><span class="ident" id="596926">Errorf</span><span class="op" id="596932">(</span><span class="string" id="596933">&#34;want&nbsp;timeout&nbsp;error;&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="596962">,</span>&nbsp;<span class="ident" id="596964">nerr</span><span class="op" id="596968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596974">continue</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="596986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="596991">if</span>&nbsp;<span class="ident" id="596994">strings</span><span class="op" id="597001">.</span><span class="ident" id="597002">Contains</span><span class="op" id="597010">(</span><span class="ident" id="597011">err</span><span class="op" id="597014">.</span><span class="ident" id="597015">Error</span><span class="op" id="597020">(</span><span class="op" id="597021">)</span><span class="op" id="597022">,</span>&nbsp;<span class="ident" id="597024">tt</span><span class="op" id="597026">.</span><span class="ident" id="597027">wantErr</span><span class="op" id="597034">)</span>&nbsp;<span class="op" id="597036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597042">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597059">t</span><span class="op" id="597060">.</span><span class="ident" id="597061">Errorf</span><span class="op" id="597067">(</span><span class="string" id="597068">&#34;%d.&nbsp;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="597094">,</span>&nbsp;<span class="ident" id="597096">i</span><span class="op" id="597097">,</span>&nbsp;<span class="ident" id="597099">err</span><span class="op" id="597102">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597107">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597122">if</span>&nbsp;<span class="ident" id="597125">tt</span><span class="op" id="597127">.</span><span class="ident" id="597128">wantErr</span>&nbsp;<span class="op" id="597136">!=</span>&nbsp;<span class="string" id="597139">&#34;&#34;</span>&nbsp;<span class="op" id="597142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597147">t</span><span class="op" id="597148">.</span><span class="ident" id="597149">Errorf</span><span class="op" id="597155">(</span><span class="string" id="597156">&#34;%d.&nbsp;no&nbsp;error.&nbsp;expected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="597190">,</span>&nbsp;<span class="ident" id="597192">i</span><span class="op" id="597193">,</span>&nbsp;<span class="ident" id="597195">tt</span><span class="op" id="597197">.</span><span class="ident" id="597198">wantErr</span><span class="op" id="597205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597210">continue</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597225">if</span>&nbsp;<span class="ident" id="597228">res</span><span class="op" id="597231">.</span><span class="ident" id="597232">StatusCode</span>&nbsp;<span class="op" id="597243">!=</span>&nbsp;<span class="ident" id="597246">tt</span><span class="op" id="597248">.</span><span class="ident" id="597249">want</span>&nbsp;<span class="op" id="597254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597259">t</span><span class="op" id="597260">.</span><span class="ident" id="597261">Errorf</span><span class="op" id="597267">(</span><span class="string" id="597268">&#34;%d&nbsp;for&nbsp;path&nbsp;%q&nbsp;status&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="597305">,</span>&nbsp;<span class="ident" id="597307">i</span><span class="op" id="597308">,</span>&nbsp;<span class="ident" id="597310">tt</span><span class="op" id="597312">.</span><span class="ident" id="597313">path</span><span class="op" id="597317">,</span>&nbsp;<span class="ident" id="597319">res</span><span class="op" id="597322">.</span><span class="ident" id="597323">StatusCode</span><span class="op" id="597333">,</span>&nbsp;<span class="ident" id="597335">tt</span><span class="op" id="597337">.</span><span class="ident" id="597338">want</span><span class="op" id="597342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597349">}</span><br>
<span class="lineno">1315</span><span class="op" id="597351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="597354">func</span>&nbsp;<span class="ident" id="597359">TestTransportCancelRequest</span><span class="op" id="597385">(</span><span class="ident" id="597386">t</span>&nbsp;<span class="op" id="597388">*</span><span class="ident" id="597389">testing</span><span class="op" id="597396">.</span><span class="ident" id="597397">T</span><span class="op" id="597398">)</span>&nbsp;<span class="op" id="597400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597403">defer</span>&nbsp;<span class="ident" id="597409">afterTest</span><span class="op" id="597418">(</span><span class="ident" id="597419">t</span><span class="op" id="597420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597423">if</span>&nbsp;<span class="ident" id="597426">testing</span><span class="op" id="597433">.</span><span class="ident" id="597434">Short</span><span class="op" id="597439">(</span><span class="op" id="597440">)</span>&nbsp;<span class="op" id="597442">{</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597446">t</span><span class="op" id="597447">.</span><span class="ident" id="597448">Skip</span><span class="op" id="597452">(</span><span class="string" id="597453">&#34;skipping&nbsp;test&nbsp;in&nbsp;-short&nbsp;mode&#34;</span><span class="op" id="597483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597489">unblockc</span>&nbsp;<span class="op" id="597498">:=</span>&nbsp;<span class="builtinfunc" id="597501">make</span><span class="op" id="597505">(</span><span class="keyword" id="597506">chan</span>&nbsp;<span class="builtintype" id="597511">bool</span><span class="op" id="597515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597518">ts</span>&nbsp;<span class="op" id="597521">:=</span>&nbsp;<span class="ident" id="597524">httptest</span><span class="op" id="597532">.</span><span class="ident" id="597533">NewServer</span><span class="op" id="597542">(</span><span class="ident" id="597543">HandlerFunc</span><span class="op" id="597554">(</span><span class="keyword" id="597555">func</span><span class="op" id="597559">(</span><span class="ident" id="597560">w</span>&nbsp;<span class="ident" id="597562">ResponseWriter</span><span class="op" id="597576">,</span>&nbsp;<span class="ident" id="597578">r</span>&nbsp;<span class="op" id="597580">*</span><span class="ident" id="597581">Request</span><span class="op" id="597588">)</span>&nbsp;<span class="op" id="597590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597594">fmt</span><span class="op" id="597597">.</span><span class="ident" id="597598">Fprintf</span><span class="op" id="597605">(</span><span class="ident" id="597606">w</span><span class="op" id="597607">,</span>&nbsp;<span class="string" id="597609">&#34;Hello&#34;</span><span class="op" id="597616">)</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597620">w</span><span class="op" id="597621">.</span><span class="op" id="597622">(</span><span class="ident" id="597623">Flusher</span><span class="op" id="597630">)</span><span class="op" id="597631">.</span><span class="ident" id="597632">Flush</span><span class="op" id="597637">(</span><span class="op" id="597638">)</span>&nbsp;<span class="comment" id="597640">//&nbsp;send&nbsp;headers&nbsp;and&nbsp;some&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597672">&lt;-</span><span class="ident" id="597674">unblockc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597684">}</span><span class="op" id="597685">)</span><span class="op" id="597686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597689">defer</span>&nbsp;<span class="ident" id="597695">ts</span><span class="op" id="597697">.</span><span class="ident" id="597698">Close</span><span class="op" id="597703">(</span><span class="op" id="597704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597707">defer</span>&nbsp;<span class="builtinfunc" id="597713">close</span><span class="op" id="597718">(</span><span class="ident" id="597719">unblockc</span><span class="op" id="597727">)</span><br>
<span class="lineno">1330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597731">tr</span>&nbsp;<span class="op" id="597734">:=</span>&nbsp;<span class="op" id="597737">&amp;</span><span class="ident" id="597738">Transport</span><span class="op" id="597747">{</span><span class="op" id="597748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597751">defer</span>&nbsp;<span class="ident" id="597757">tr</span><span class="op" id="597759">.</span><span class="ident" id="597760">CloseIdleConnections</span><span class="op" id="597780">(</span><span class="op" id="597781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597784">c</span>&nbsp;<span class="op" id="597786">:=</span>&nbsp;<span class="op" id="597789">&amp;</span><span class="ident" id="597790">Client</span><span class="op" id="597796">{</span><span class="ident" id="597797">Transport</span><span class="op" id="597806">:</span>&nbsp;<span class="ident" id="597808">tr</span><span class="op" id="597810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597814">req</span><span class="op" id="597817">,</span>&nbsp;<span class="ident" id="597819">_</span>&nbsp;<span class="op" id="597821">:=</span>&nbsp;<span class="ident" id="597824">NewRequest</span><span class="op" id="597834">(</span><span class="string" id="597835">&#34;GET&#34;</span><span class="op" id="597840">,</span>&nbsp;<span class="ident" id="597842">ts</span><span class="op" id="597844">.</span><span class="ident" id="597845">URL</span><span class="op" id="597848">,</span>&nbsp;<span class="ident" id="597850">nil</span><span class="op" id="597853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597856">res</span><span class="op" id="597859">,</span>&nbsp;<span class="ident" id="597861">err</span>&nbsp;<span class="op" id="597865">:=</span>&nbsp;<span class="ident" id="597868">c</span><span class="op" id="597869">.</span><span class="ident" id="597870">Do</span><span class="op" id="597872">(</span><span class="ident" id="597873">req</span><span class="op" id="597876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597879">if</span>&nbsp;<span class="ident" id="597882">err</span>&nbsp;<span class="op" id="597886">!=</span>&nbsp;<span class="ident" id="597889">nil</span>&nbsp;<span class="op" id="597893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597897">t</span><span class="op" id="597898">.</span><span class="ident" id="597899">Fatal</span><span class="op" id="597904">(</span><span class="ident" id="597905">err</span><span class="op" id="597908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597911">}</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="597914">go</span>&nbsp;<span class="keyword" id="597917">func</span><span class="op" id="597921">(</span><span class="op" id="597922">)</span>&nbsp;<span class="op" id="597924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597928">time</span><span class="op" id="597932">.</span><span class="ident" id="597933">Sleep</span><span class="op" id="597938">(</span><span class="num" id="597939">1</span>&nbsp;<span class="op" id="597941">*</span>&nbsp;<span class="ident" id="597943">time</span><span class="op" id="597947">.</span><span class="ident" id="597948">Second</span><span class="op" id="597954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597958">tr</span><span class="op" id="597960">.</span><span class="ident" id="597961">CancelRequest</span><span class="op" id="597974">(</span><span class="ident" id="597975">req</span><span class="op" id="597978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="597981">}</span><span class="op" id="597982">(</span><span class="op" id="597983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="597986">t0</span>&nbsp;<span class="op" id="597989">:=</span>&nbsp;<span class="ident" id="597992">time</span><span class="op" id="597996">.</span><span class="ident" id="597997">Now</span><span class="op" id="598000">(</span><span class="op" id="598001">)</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598004">body</span><span class="op" id="598008">,</span>&nbsp;<span class="ident" id="598010">err</span>&nbsp;<span class="op" id="598014">:=</span>&nbsp;<span class="ident" id="598017">ioutil</span><span class="op" id="598023">.</span><span class="ident" id="598024">ReadAll</span><span class="op" id="598031">(</span><span class="ident" id="598032">res</span><span class="op" id="598035">.</span><span class="ident" id="598036">Body</span><span class="op" id="598040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598043">d</span>&nbsp;<span class="op" id="598045">:=</span>&nbsp;<span class="ident" id="598048">time</span><span class="op" id="598052">.</span><span class="ident" id="598053">Since</span><span class="op" id="598058">(</span><span class="ident" id="598059">t0</span><span class="op" id="598061">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598065">if</span>&nbsp;<span class="ident" id="598068">err</span>&nbsp;<span class="op" id="598072">==</span>&nbsp;<span class="ident" id="598075">nil</span>&nbsp;<span class="op" id="598079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598083">t</span><span class="op" id="598084">.</span><span class="ident" id="598085">Error</span><span class="op" id="598090">(</span><span class="string" id="598091">&#34;expected&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;body&#34;</span><span class="op" id="598127">)</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598133">if</span>&nbsp;<span class="builtintype" id="598136">string</span><span class="op" id="598142">(</span><span class="ident" id="598143">body</span><span class="op" id="598147">)</span>&nbsp;<span class="op" id="598149">!=</span>&nbsp;<span class="string" id="598152">&#34;Hello&#34;</span>&nbsp;<span class="op" id="598160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598164">t</span><span class="op" id="598165">.</span><span class="ident" id="598166">Errorf</span><span class="op" id="598172">(</span><span class="string" id="598173">&#34;Body&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Hello&#34;</span><span class="op" id="598196">,</span>&nbsp;<span class="ident" id="598198">body</span><span class="op" id="598202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598208">if</span>&nbsp;<span class="ident" id="598211">d</span>&nbsp;<span class="op" id="598213">&lt;</span>&nbsp;<span class="num" id="598215">500</span><span class="op" id="598218">*</span><span class="ident" id="598219">time</span><span class="op" id="598223">.</span><span class="ident" id="598224">Millisecond</span>&nbsp;<span class="op" id="598236">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598240">t</span><span class="op" id="598241">.</span><span class="ident" id="598242">Errorf</span><span class="op" id="598248">(</span><span class="string" id="598249">&#34;expected&nbsp;~1&nbsp;second&nbsp;delay;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="598283">,</span>&nbsp;<span class="ident" id="598285">d</span><span class="op" id="598286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="598292">//&nbsp;Verify&nbsp;no&nbsp;outstanding&nbsp;requests&nbsp;after&nbsp;readLoop/writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="598352">//&nbsp;goroutines&nbsp;shut&nbsp;down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598378">for</span>&nbsp;<span class="ident" id="598382">tries</span>&nbsp;<span class="op" id="598388">:=</span>&nbsp;<span class="num" id="598391">3</span><span class="op" id="598392">;</span>&nbsp;<span class="ident" id="598394">tries</span>&nbsp;<span class="op" id="598400">&gt;</span>&nbsp;<span class="num" id="598402">0</span><span class="op" id="598403">;</span>&nbsp;<span class="ident" id="598405">tries</span><span class="op" id="598410">--</span>&nbsp;<span class="op" id="598413">{</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598417">n</span>&nbsp;<span class="op" id="598419">:=</span>&nbsp;<span class="ident" id="598422">tr</span><span class="op" id="598424">.</span><span class="ident" id="598425">NumPendingRequestsForTesting</span><span class="op" id="598453">(</span><span class="op" id="598454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598458">if</span>&nbsp;<span class="ident" id="598461">n</span>&nbsp;<span class="op" id="598463">==</span>&nbsp;<span class="num" id="598466">0</span>&nbsp;<span class="op" id="598468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598473">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598485">time</span><span class="op" id="598489">.</span><span class="ident" id="598490">Sleep</span><span class="op" id="598495">(</span><span class="num" id="598496">100</span>&nbsp;<span class="op" id="598500">*</span>&nbsp;<span class="ident" id="598502">time</span><span class="op" id="598506">.</span><span class="ident" id="598507">Millisecond</span><span class="op" id="598518">)</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598522">if</span>&nbsp;<span class="ident" id="598525">tries</span>&nbsp;<span class="op" id="598531">==</span>&nbsp;<span class="num" id="598534">1</span>&nbsp;<span class="op" id="598536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598541">t</span><span class="op" id="598542">.</span><span class="ident" id="598543">Errorf</span><span class="op" id="598549">(</span><span class="string" id="598550">&#34;pending&nbsp;requests&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="598581">,</span>&nbsp;<span class="ident" id="598583">n</span><span class="op" id="598584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598591">}</span><br>
<span class="lineno"></span><span class="op" id="598593">}</span><br>
<span class="lineno">1370</span><br>
<span class="lineno"></span><span class="keyword" id="598596">func</span>&nbsp;<span class="ident" id="598601">TestTransportCancelRequestInDial</span><span class="op" id="598633">(</span><span class="ident" id="598634">t</span>&nbsp;<span class="op" id="598636">*</span><span class="ident" id="598637">testing</span><span class="op" id="598644">.</span><span class="ident" id="598645">T</span><span class="op" id="598646">)</span>&nbsp;<span class="op" id="598648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598651">defer</span>&nbsp;<span class="ident" id="598657">afterTest</span><span class="op" id="598666">(</span><span class="ident" id="598667">t</span><span class="op" id="598668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598671">if</span>&nbsp;<span class="ident" id="598674">testing</span><span class="op" id="598681">.</span><span class="ident" id="598682">Short</span><span class="op" id="598687">(</span><span class="op" id="598688">)</span>&nbsp;<span class="op" id="598690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598694">t</span><span class="op" id="598695">.</span><span class="ident" id="598696">Skip</span><span class="op" id="598700">(</span><span class="string" id="598701">&#34;skipping&nbsp;test&nbsp;in&nbsp;-short&nbsp;mode&#34;</span><span class="op" id="598731">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="598734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598737">var</span>&nbsp;<span class="ident" id="598741">logbuf</span>&nbsp;<span class="ident" id="598748">bytes</span><span class="op" id="598753">.</span><span class="ident" id="598754">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598762">eventLog</span>&nbsp;<span class="op" id="598771">:=</span>&nbsp;<span class="ident" id="598774">log</span><span class="op" id="598777">.</span><span class="ident" id="598778">New</span><span class="op" id="598781">(</span><span class="op" id="598782">&amp;</span><span class="ident" id="598783">logbuf</span><span class="op" id="598789">,</span>&nbsp;<span class="string" id="598791">&#34;&#34;</span><span class="op" id="598793">,</span>&nbsp;<span class="num" id="598795">0</span><span class="op" id="598796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598800">unblockDial</span>&nbsp;<span class="op" id="598812">:=</span>&nbsp;<span class="builtinfunc" id="598815">make</span><span class="op" id="598819">(</span><span class="keyword" id="598820">chan</span>&nbsp;<span class="builtintype" id="598825">bool</span><span class="op" id="598829">)</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="598832">defer</span>&nbsp;<span class="builtinfunc" id="598838">close</span><span class="op" id="598843">(</span><span class="ident" id="598844">unblockDial</span><span class="op" id="598855">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598859">inDial</span>&nbsp;<span class="op" id="598866">:=</span>&nbsp;<span class="builtinfunc" id="598869">make</span><span class="op" id="598873">(</span><span class="keyword" id="598874">chan</span>&nbsp;<span class="builtintype" id="598879">bool</span><span class="op" id="598883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598886">tr</span>&nbsp;<span class="op" id="598889">:=</span>&nbsp;<span class="op" id="598892">&amp;</span><span class="ident" id="598893">Transport</span><span class="op" id="598902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598906">Dial</span><span class="op" id="598910">:</span>&nbsp;<span class="keyword" id="598912">func</span><span class="op" id="598916">(</span><span class="ident" id="598917">network</span><span class="op" id="598924">,</span>&nbsp;<span class="ident" id="598926">addr</span>&nbsp;<span class="builtintype" id="598931">string</span><span class="op" id="598937">)</span>&nbsp;<span class="op" id="598939">(</span><span class="ident" id="598940">net</span><span class="op" id="598943">.</span><span class="ident" id="598944">Conn</span><span class="op" id="598948">,</span>&nbsp;<span class="builtintype" id="598950">error</span><span class="op" id="598955">)</span>&nbsp;<span class="op" id="598957">{</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="598962">eventLog</span><span class="op" id="598970">.</span><span class="ident" id="598971">Println</span><span class="op" id="598978">(</span><span class="string" id="598979">&#34;dial:&nbsp;blocking&#34;</span><span class="op" id="598995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599000">inDial</span>&nbsp;<span class="op" id="599007">&lt;-</span>&nbsp;<span class="builtintype" id="599010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599018">&lt;-</span><span class="ident" id="599020">unblockDial</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599035">return</span>&nbsp;<span class="ident" id="599042">nil</span><span class="op" id="599045">,</span>&nbsp;<span class="ident" id="599047">errors</span><span class="op" id="599053">.</span><span class="ident" id="599054">New</span><span class="op" id="599057">(</span><span class="string" id="599058">&#34;nope&#34;</span><span class="op" id="599064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599068">}</span><span class="op" id="599069">,</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599075">cl</span>&nbsp;<span class="op" id="599078">:=</span>&nbsp;<span class="op" id="599081">&amp;</span><span class="ident" id="599082">Client</span><span class="op" id="599088">{</span><span class="ident" id="599089">Transport</span><span class="op" id="599098">:</span>&nbsp;<span class="ident" id="599100">tr</span><span class="op" id="599102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599105">gotres</span>&nbsp;<span class="op" id="599112">:=</span>&nbsp;<span class="builtinfunc" id="599115">make</span><span class="op" id="599119">(</span><span class="keyword" id="599120">chan</span>&nbsp;<span class="builtintype" id="599125">bool</span><span class="op" id="599129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599132">req</span><span class="op" id="599135">,</span>&nbsp;<span class="ident" id="599137">_</span>&nbsp;<span class="op" id="599139">:=</span>&nbsp;<span class="ident" id="599142">NewRequest</span><span class="op" id="599152">(</span><span class="string" id="599153">&#34;GET&#34;</span><span class="op" id="599158">,</span>&nbsp;<span class="string" id="599160">&#34;http://something.no-network.tld/&#34;</span><span class="op" id="599194">,</span>&nbsp;<span class="ident" id="599196">nil</span><span class="op" id="599199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599202">go</span>&nbsp;<span class="keyword" id="599205">func</span><span class="op" id="599209">(</span><span class="op" id="599210">)</span>&nbsp;<span class="op" id="599212">{</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599216">_</span><span class="op" id="599217">,</span>&nbsp;<span class="ident" id="599219">err</span>&nbsp;<span class="op" id="599223">:=</span>&nbsp;<span class="ident" id="599226">cl</span><span class="op" id="599228">.</span><span class="ident" id="599229">Do</span><span class="op" id="599231">(</span><span class="ident" id="599232">req</span><span class="op" id="599235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599239">eventLog</span><span class="op" id="599247">.</span><span class="ident" id="599248">Printf</span><span class="op" id="599254">(</span><span class="string" id="599255">&#34;Get&nbsp;=&nbsp;%v&#34;</span><span class="op" id="599265">,</span>&nbsp;<span class="ident" id="599267">err</span><span class="op" id="599270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599274">gotres</span>&nbsp;<span class="op" id="599281">&lt;-</span>&nbsp;<span class="builtintype" id="599284">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599290">}</span><span class="op" id="599291">(</span><span class="op" id="599292">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599296">select</span>&nbsp;<span class="op" id="599303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599306">case</span>&nbsp;<span class="op" id="599311">&lt;-</span><span class="ident" id="599313">inDial</span><span class="op" id="599319">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599322">case</span>&nbsp;<span class="op" id="599327">&lt;-</span><span class="ident" id="599329">time</span><span class="op" id="599333">.</span><span class="ident" id="599334">After</span><span class="op" id="599339">(</span><span class="num" id="599340">5</span>&nbsp;<span class="op" id="599342">*</span>&nbsp;<span class="ident" id="599344">time</span><span class="op" id="599348">.</span><span class="ident" id="599349">Second</span><span class="op" id="599355">)</span><span class="op" id="599356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599360">t</span><span class="op" id="599361">.</span><span class="ident" id="599362">Fatal</span><span class="op" id="599367">(</span><span class="string" id="599368">&#34;timeout;&nbsp;never&nbsp;saw&nbsp;blocking&nbsp;dial&#34;</span><span class="op" id="599402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599405">}</span><br>
<span class="lineno">1405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599409">eventLog</span><span class="op" id="599417">.</span><span class="ident" id="599418">Printf</span><span class="op" id="599424">(</span><span class="string" id="599425">&#34;canceling&#34;</span><span class="op" id="599436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599439">tr</span><span class="op" id="599441">.</span><span class="ident" id="599442">CancelRequest</span><span class="op" id="599455">(</span><span class="ident" id="599456">req</span><span class="op" id="599459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599463">select</span>&nbsp;<span class="op" id="599470">{</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599473">case</span>&nbsp;<span class="op" id="599478">&lt;-</span><span class="ident" id="599480">gotres</span><span class="op" id="599486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599489">case</span>&nbsp;<span class="op" id="599494">&lt;-</span><span class="ident" id="599496">time</span><span class="op" id="599500">.</span><span class="ident" id="599501">After</span><span class="op" id="599506">(</span><span class="num" id="599507">5</span>&nbsp;<span class="op" id="599509">*</span>&nbsp;<span class="ident" id="599511">time</span><span class="op" id="599515">.</span><span class="ident" id="599516">Second</span><span class="op" id="599522">)</span><span class="op" id="599523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="599527">panic</span><span class="op" id="599532">(</span><span class="string" id="599533">&#34;hang.&nbsp;events&nbsp;are:&nbsp;&#34;</span>&nbsp;<span class="op" id="599554">+</span>&nbsp;<span class="ident" id="599556">logbuf</span><span class="op" id="599562">.</span><span class="ident" id="599563">String</span><span class="op" id="599569">(</span><span class="op" id="599570">)</span><span class="op" id="599571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599578">got</span>&nbsp;<span class="op" id="599582">:=</span>&nbsp;<span class="ident" id="599585">logbuf</span><span class="op" id="599591">.</span><span class="ident" id="599592">String</span><span class="op" id="599598">(</span><span class="op" id="599599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599602">want</span>&nbsp;<span class="op" id="599607">:=</span>&nbsp;<span class="string" id="599610">`dial:&nbsp;blocking<br>
<span class="lineno"></span>canceling<br>
<span class="lineno"></span>Get&nbsp;=&nbsp;Get&nbsp;http://something.no-network.tld/:&nbsp;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="599739">if</span>&nbsp;<span class="ident" id="599742">got</span>&nbsp;<span class="op" id="599746">!=</span>&nbsp;<span class="ident" id="599749">want</span>&nbsp;<span class="op" id="599754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="599758">t</span><span class="op" id="599759">.</span><span class="ident" id="599760">Errorf</span><span class="op" id="599766">(</span><span class="string" id="599767">&#34;Got&nbsp;events:\n%s\nWant:\n%s&#34;</span><span class="op" id="599795">,</span>&nbsp;<span class="ident" id="599797">got</span><span class="op" id="599800">,</span>&nbsp;<span class="ident" id="599802">want</span><span class="op" id="599806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="599809">}</span><br>
<span class="lineno"></span><span class="op" id="599811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1425</span><span class="comment" id="599814">//&nbsp;golang.org/issue/3672&nbsp;--&nbsp;Client&nbsp;can&#39;t&nbsp;close&nbsp;HTTP&nbsp;stream</span><br>
<span class="lineno"></span><span class="comment" id="599873">//&nbsp;Calling&nbsp;Close&nbsp;on&nbsp;a&nbsp;Response.Body&nbsp;used&nbsp;to&nbsp;just&nbsp;read&nbsp;until&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="599938">//&nbsp;Now&nbsp;it&nbsp;actually&nbsp;closes&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="599984">func</span>&nbsp;<span class="ident" id="599989">TestTransportCloseResponseBody</span><span class="op" id="600019">(</span><span class="ident" id="600020">t</span>&nbsp;<span class="op" id="600022">*</span><span class="ident" id="600023">testing</span><span class="op" id="600030">.</span><span class="ident" id="600031">T</span><span class="op" id="600032">)</span>&nbsp;<span class="op" id="600034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600037">defer</span>&nbsp;<span class="ident" id="600043">afterTest</span><span class="op" id="600052">(</span><span class="ident" id="600053">t</span><span class="op" id="600054">)</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600057">writeErr</span>&nbsp;<span class="op" id="600066">:=</span>&nbsp;<span class="builtinfunc" id="600069">make</span><span class="op" id="600073">(</span><span class="keyword" id="600074">chan</span>&nbsp;<span class="builtintype" id="600079">error</span><span class="op" id="600084">,</span>&nbsp;<span class="num" id="600086">1</span><span class="op" id="600087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600090">msg</span>&nbsp;<span class="op" id="600094">:=</span>&nbsp;<span class="op" id="600097">[</span><span class="op" id="600098">]</span><span class="builtintype" id="600099">byte</span><span class="op" id="600103">(</span><span class="string" id="600104">&#34;young\n&#34;</span><span class="op" id="600113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600116">ts</span>&nbsp;<span class="op" id="600119">:=</span>&nbsp;<span class="ident" id="600122">httptest</span><span class="op" id="600130">.</span><span class="ident" id="600131">NewServer</span><span class="op" id="600140">(</span><span class="ident" id="600141">HandlerFunc</span><span class="op" id="600152">(</span><span class="keyword" id="600153">func</span><span class="op" id="600157">(</span><span class="ident" id="600158">w</span>&nbsp;<span class="ident" id="600160">ResponseWriter</span><span class="op" id="600174">,</span>&nbsp;<span class="ident" id="600176">r</span>&nbsp;<span class="op" id="600178">*</span><span class="ident" id="600179">Request</span><span class="op" id="600186">)</span>&nbsp;<span class="op" id="600188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600192">for</span>&nbsp;<span class="op" id="600196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600201">_</span><span class="op" id="600202">,</span>&nbsp;<span class="ident" id="600204">err</span>&nbsp;<span class="op" id="600208">:=</span>&nbsp;<span class="ident" id="600211">w</span><span class="op" id="600212">.</span><span class="ident" id="600213">Write</span><span class="op" id="600218">(</span><span class="ident" id="600219">msg</span><span class="op" id="600222">)</span><br>
<span class="lineno">1435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600227">if</span>&nbsp;<span class="ident" id="600230">err</span>&nbsp;<span class="op" id="600234">!=</span>&nbsp;<span class="ident" id="600237">nil</span>&nbsp;<span class="op" id="600241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600247">writeErr</span>&nbsp;<span class="op" id="600256">&lt;-</span>&nbsp;<span class="ident" id="600259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600267">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600282">w</span><span class="op" id="600283">.</span><span class="op" id="600284">(</span><span class="ident" id="600285">Flusher</span><span class="op" id="600292">)</span><span class="op" id="600293">.</span><span class="ident" id="600294">Flush</span><span class="op" id="600299">(</span><span class="op" id="600300">)</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600307">}</span><span class="op" id="600308">)</span><span class="op" id="600309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600312">defer</span>&nbsp;<span class="ident" id="600318">ts</span><span class="op" id="600320">.</span><span class="ident" id="600321">Close</span><span class="op" id="600326">(</span><span class="op" id="600327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600331">tr</span>&nbsp;<span class="op" id="600334">:=</span>&nbsp;<span class="op" id="600337">&amp;</span><span class="ident" id="600338">Transport</span><span class="op" id="600347">{</span><span class="op" id="600348">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600351">defer</span>&nbsp;<span class="ident" id="600357">tr</span><span class="op" id="600359">.</span><span class="ident" id="600360">CloseIdleConnections</span><span class="op" id="600380">(</span><span class="op" id="600381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600384">c</span>&nbsp;<span class="op" id="600386">:=</span>&nbsp;<span class="op" id="600389">&amp;</span><span class="ident" id="600390">Client</span><span class="op" id="600396">{</span><span class="ident" id="600397">Transport</span><span class="op" id="600406">:</span>&nbsp;<span class="ident" id="600408">tr</span><span class="op" id="600410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600414">req</span><span class="op" id="600417">,</span>&nbsp;<span class="ident" id="600419">_</span>&nbsp;<span class="op" id="600421">:=</span>&nbsp;<span class="ident" id="600424">NewRequest</span><span class="op" id="600434">(</span><span class="string" id="600435">&#34;GET&#34;</span><span class="op" id="600440">,</span>&nbsp;<span class="ident" id="600442">ts</span><span class="op" id="600444">.</span><span class="ident" id="600445">URL</span><span class="op" id="600448">,</span>&nbsp;<span class="ident" id="600450">nil</span><span class="op" id="600453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600456">defer</span>&nbsp;<span class="ident" id="600462">tr</span><span class="op" id="600464">.</span><span class="ident" id="600465">CancelRequest</span><span class="op" id="600478">(</span><span class="ident" id="600479">req</span><span class="op" id="600482">)</span><br>
<span class="lineno">1450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600486">res</span><span class="op" id="600489">,</span>&nbsp;<span class="ident" id="600491">err</span>&nbsp;<span class="op" id="600495">:=</span>&nbsp;<span class="ident" id="600498">c</span><span class="op" id="600499">.</span><span class="ident" id="600500">Do</span><span class="op" id="600502">(</span><span class="ident" id="600503">req</span><span class="op" id="600506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600509">if</span>&nbsp;<span class="ident" id="600512">err</span>&nbsp;<span class="op" id="600516">!=</span>&nbsp;<span class="ident" id="600519">nil</span>&nbsp;<span class="op" id="600523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600527">t</span><span class="op" id="600528">.</span><span class="ident" id="600529">Fatal</span><span class="op" id="600534">(</span><span class="ident" id="600535">err</span><span class="op" id="600538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600541">}</span><br>
<span class="lineno">1455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600545">const</span>&nbsp;<span class="ident" id="600551">repeats</span>&nbsp;<span class="op" id="600559">=</span>&nbsp;<span class="num" id="600561">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600564">buf</span>&nbsp;<span class="op" id="600568">:=</span>&nbsp;<span class="builtinfunc" id="600571">make</span><span class="op" id="600575">(</span><span class="op" id="600576">[</span><span class="op" id="600577">]</span><span class="builtintype" id="600578">byte</span><span class="op" id="600582">,</span>&nbsp;<span class="builtinfunc" id="600584">len</span><span class="op" id="600587">(</span><span class="ident" id="600588">msg</span><span class="op" id="600591">)</span><span class="op" id="600592">*</span><span class="ident" id="600593">repeats</span><span class="op" id="600600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600603">want</span>&nbsp;<span class="op" id="600608">:=</span>&nbsp;<span class="ident" id="600611">bytes</span><span class="op" id="600616">.</span><span class="ident" id="600617">Repeat</span><span class="op" id="600623">(</span><span class="ident" id="600624">msg</span><span class="op" id="600627">,</span>&nbsp;<span class="ident" id="600629">repeats</span><span class="op" id="600636">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600640">_</span><span class="op" id="600641">,</span>&nbsp;<span class="ident" id="600643">err</span>&nbsp;<span class="op" id="600647">=</span>&nbsp;<span class="ident" id="600649">io</span><span class="op" id="600651">.</span><span class="ident" id="600652">ReadFull</span><span class="op" id="600660">(</span><span class="ident" id="600661">res</span><span class="op" id="600664">.</span><span class="ident" id="600665">Body</span><span class="op" id="600669">,</span>&nbsp;<span class="ident" id="600671">buf</span><span class="op" id="600674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600677">if</span>&nbsp;<span class="ident" id="600680">err</span>&nbsp;<span class="op" id="600684">!=</span>&nbsp;<span class="ident" id="600687">nil</span>&nbsp;<span class="op" id="600691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600695">t</span><span class="op" id="600696">.</span><span class="ident" id="600697">Fatal</span><span class="op" id="600702">(</span><span class="ident" id="600703">err</span><span class="op" id="600706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600712">if</span>&nbsp;<span class="op" id="600715">!</span><span class="ident" id="600716">bytes</span><span class="op" id="600721">.</span><span class="ident" id="600722">Equal</span><span class="op" id="600727">(</span><span class="ident" id="600728">buf</span><span class="op" id="600731">,</span>&nbsp;<span class="ident" id="600733">want</span><span class="op" id="600737">)</span>&nbsp;<span class="op" id="600739">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600743">t</span><span class="op" id="600744">.</span><span class="ident" id="600745">Fatalf</span><span class="op" id="600751">(</span><span class="string" id="600752">&#34;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="600770">,</span>&nbsp;<span class="ident" id="600772">buf</span><span class="op" id="600775">,</span>&nbsp;<span class="ident" id="600777">want</span><span class="op" id="600781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600787">didClose</span>&nbsp;<span class="op" id="600796">:=</span>&nbsp;<span class="builtinfunc" id="600799">make</span><span class="op" id="600803">(</span><span class="keyword" id="600804">chan</span>&nbsp;<span class="builtintype" id="600809">error</span><span class="op" id="600814">,</span>&nbsp;<span class="num" id="600816">1</span><span class="op" id="600817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600820">go</span>&nbsp;<span class="keyword" id="600823">func</span><span class="op" id="600827">(</span><span class="op" id="600828">)</span>&nbsp;<span class="op" id="600830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600834">didClose</span>&nbsp;<span class="op" id="600843">&lt;-</span>&nbsp;<span class="ident" id="600846">res</span><span class="op" id="600849">.</span><span class="ident" id="600850">Body</span><span class="op" id="600854">.</span><span class="ident" id="600855">Close</span><span class="op" id="600860">(</span><span class="op" id="600861">)</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600864">}</span><span class="op" id="600865">(</span><span class="op" id="600866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600869">select</span>&nbsp;<span class="op" id="600876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600879">case</span>&nbsp;<span class="ident" id="600884">err</span>&nbsp;<span class="op" id="600888">:=</span>&nbsp;<span class="op" id="600891">&lt;-</span><span class="ident" id="600893">didClose</span><span class="op" id="600901">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600905">if</span>&nbsp;<span class="ident" id="600908">err</span>&nbsp;<span class="op" id="600912">!=</span>&nbsp;<span class="ident" id="600915">nil</span>&nbsp;<span class="op" id="600919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600924">t</span><span class="op" id="600925">.</span><span class="ident" id="600926">Errorf</span><span class="op" id="600932">(</span><span class="string" id="600933">&#34;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="600945">,</span>&nbsp;<span class="ident" id="600947">err</span><span class="op" id="600950">)</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="600954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="600957">case</span>&nbsp;<span class="op" id="600962">&lt;-</span><span class="ident" id="600964">time</span><span class="op" id="600968">.</span><span class="ident" id="600969">After</span><span class="op" id="600974">(</span><span class="num" id="600975">10</span>&nbsp;<span class="op" id="600978">*</span>&nbsp;<span class="ident" id="600980">time</span><span class="op" id="600984">.</span><span class="ident" id="600985">Second</span><span class="op" id="600991">)</span><span class="op" id="600992">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="600996">t</span><span class="op" id="600997">.</span><span class="ident" id="600998">Fatal</span><span class="op" id="601003">(</span><span class="string" id="601004">&#34;too&nbsp;long&nbsp;waiting&nbsp;for&nbsp;close&#34;</span><span class="op" id="601032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601038">select</span>&nbsp;<span class="op" id="601045">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601048">case</span>&nbsp;<span class="ident" id="601053">err</span>&nbsp;<span class="op" id="601057">:=</span>&nbsp;<span class="op" id="601060">&lt;-</span><span class="ident" id="601062">writeErr</span><span class="op" id="601070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601074">if</span>&nbsp;<span class="ident" id="601077">err</span>&nbsp;<span class="op" id="601081">==</span>&nbsp;<span class="ident" id="601084">nil</span>&nbsp;<span class="op" id="601088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601093">t</span><span class="op" id="601094">.</span><span class="ident" id="601095">Errorf</span><span class="op" id="601101">(</span><span class="string" id="601102">&#34;expected&nbsp;non-nil&nbsp;write&nbsp;error&#34;</span><span class="op" id="601132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601139">case</span>&nbsp;<span class="op" id="601144">&lt;-</span><span class="ident" id="601146">time</span><span class="op" id="601150">.</span><span class="ident" id="601151">After</span><span class="op" id="601156">(</span><span class="num" id="601157">10</span>&nbsp;<span class="op" id="601160">*</span>&nbsp;<span class="ident" id="601162">time</span><span class="op" id="601166">.</span><span class="ident" id="601167">Second</span><span class="op" id="601173">)</span><span class="op" id="601174">:</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601178">t</span><span class="op" id="601179">.</span><span class="ident" id="601180">Fatal</span><span class="op" id="601185">(</span><span class="string" id="601186">&#34;too&nbsp;long&nbsp;waiting&nbsp;for&nbsp;write&nbsp;error&#34;</span><span class="op" id="601220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601223">}</span><br>
<span class="lineno"></span><span class="op" id="601225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="601228">type</span>&nbsp;<span class="ident" id="601233">fooProto</span>&nbsp;<span class="keyword" id="601242">struct</span><span class="op" id="601248">{</span><span class="op" id="601249">}</span><br>
<span class="lineno">1490</span><br>
<span class="lineno"></span><span class="keyword" id="601252">func</span>&nbsp;<span class="op" id="601257">(</span><span class="ident" id="601258">fooProto</span><span class="op" id="601266">)</span>&nbsp;<span class="ident" id="601268">RoundTrip</span><span class="op" id="601277">(</span><span class="ident" id="601278">req</span>&nbsp;<span class="op" id="601282">*</span><span class="ident" id="601283">Request</span><span class="op" id="601290">)</span>&nbsp;<span class="op" id="601292">(</span><span class="op" id="601293">*</span><span class="ident" id="601294">Response</span><span class="op" id="601302">,</span>&nbsp;<span class="builtintype" id="601304">error</span><span class="op" id="601309">)</span>&nbsp;<span class="op" id="601311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601314">res</span>&nbsp;<span class="op" id="601318">:=</span>&nbsp;<span class="op" id="601321">&amp;</span><span class="ident" id="601322">Response</span><span class="op" id="601330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601334">Status</span><span class="op" id="601340">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="601346">&#34;200&nbsp;OK&#34;</span><span class="op" id="601354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601358">StatusCode</span><span class="op" id="601368">:</span>&nbsp;<span class="num" id="601370">200</span><span class="op" id="601373">,</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601377">Header</span><span class="op" id="601383">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="601389">make</span><span class="op" id="601393">(</span><span class="ident" id="601394">Header</span><span class="op" id="601400">)</span><span class="op" id="601401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601405">Body</span><span class="op" id="601409">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601417">ioutil</span><span class="op" id="601423">.</span><span class="ident" id="601424">NopCloser</span><span class="op" id="601433">(</span><span class="ident" id="601434">strings</span><span class="op" id="601441">.</span><span class="ident" id="601442">NewReader</span><span class="op" id="601451">(</span><span class="string" id="601452">&#34;You&nbsp;wanted&nbsp;&#34;</span>&nbsp;<span class="op" id="601466">+</span>&nbsp;<span class="ident" id="601468">req</span><span class="op" id="601471">.</span><span class="ident" id="601472">URL</span><span class="op" id="601475">.</span><span class="ident" id="601476">String</span><span class="op" id="601482">(</span><span class="op" id="601483">)</span><span class="op" id="601484">)</span><span class="op" id="601485">)</span><span class="op" id="601486">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601492">return</span>&nbsp;<span class="ident" id="601499">res</span><span class="op" id="601502">,</span>&nbsp;<span class="ident" id="601504">nil</span><br>
<span class="lineno"></span><span class="op" id="601508">}</span><br>
<span class="lineno">1500</span><br>
<span class="lineno"></span><span class="keyword" id="601511">func</span>&nbsp;<span class="ident" id="601516">TestTransportAltProto</span><span class="op" id="601537">(</span><span class="ident" id="601538">t</span>&nbsp;<span class="op" id="601540">*</span><span class="ident" id="601541">testing</span><span class="op" id="601548">.</span><span class="ident" id="601549">T</span><span class="op" id="601550">)</span>&nbsp;<span class="op" id="601552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601555">defer</span>&nbsp;<span class="ident" id="601561">afterTest</span><span class="op" id="601570">(</span><span class="ident" id="601571">t</span><span class="op" id="601572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601575">tr</span>&nbsp;<span class="op" id="601578">:=</span>&nbsp;<span class="op" id="601581">&amp;</span><span class="ident" id="601582">Transport</span><span class="op" id="601591">{</span><span class="op" id="601592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601595">c</span>&nbsp;<span class="op" id="601597">:=</span>&nbsp;<span class="op" id="601600">&amp;</span><span class="ident" id="601601">Client</span><span class="op" id="601607">{</span><span class="ident" id="601608">Transport</span><span class="op" id="601617">:</span>&nbsp;<span class="ident" id="601619">tr</span><span class="op" id="601621">}</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601624">tr</span><span class="op" id="601626">.</span><span class="ident" id="601627">RegisterProtocol</span><span class="op" id="601643">(</span><span class="string" id="601644">&#34;foo&#34;</span><span class="op" id="601649">,</span>&nbsp;<span class="ident" id="601651">fooProto</span><span class="op" id="601659">{</span><span class="op" id="601660">}</span><span class="op" id="601661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601664">res</span><span class="op" id="601667">,</span>&nbsp;<span class="ident" id="601669">err</span>&nbsp;<span class="op" id="601673">:=</span>&nbsp;<span class="ident" id="601676">c</span><span class="op" id="601677">.</span><span class="ident" id="601678">Get</span><span class="op" id="601681">(</span><span class="string" id="601682">&#34;foo://bar.com/path&#34;</span><span class="op" id="601702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601705">if</span>&nbsp;<span class="ident" id="601708">err</span>&nbsp;<span class="op" id="601712">!=</span>&nbsp;<span class="ident" id="601715">nil</span>&nbsp;<span class="op" id="601719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601723">t</span><span class="op" id="601724">.</span><span class="ident" id="601725">Fatal</span><span class="op" id="601730">(</span><span class="ident" id="601731">err</span><span class="op" id="601734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601737">}</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601740">bodyb</span><span class="op" id="601745">,</span>&nbsp;<span class="ident" id="601747">err</span>&nbsp;<span class="op" id="601751">:=</span>&nbsp;<span class="ident" id="601754">ioutil</span><span class="op" id="601760">.</span><span class="ident" id="601761">ReadAll</span><span class="op" id="601768">(</span><span class="ident" id="601769">res</span><span class="op" id="601772">.</span><span class="ident" id="601773">Body</span><span class="op" id="601777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601780">if</span>&nbsp;<span class="ident" id="601783">err</span>&nbsp;<span class="op" id="601787">!=</span>&nbsp;<span class="ident" id="601790">nil</span>&nbsp;<span class="op" id="601794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601798">t</span><span class="op" id="601799">.</span><span class="ident" id="601800">Fatal</span><span class="op" id="601805">(</span><span class="ident" id="601806">err</span><span class="op" id="601809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601815">body</span>&nbsp;<span class="op" id="601820">:=</span>&nbsp;<span class="builtintype" id="601823">string</span><span class="op" id="601829">(</span><span class="ident" id="601830">bodyb</span><span class="op" id="601835">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601838">if</span>&nbsp;<span class="ident" id="601841">e</span>&nbsp;<span class="op" id="601843">:=</span>&nbsp;<span class="string" id="601846">&#34;You&nbsp;wanted&nbsp;foo://bar.com/path&#34;</span><span class="op" id="601877">;</span>&nbsp;<span class="ident" id="601879">body</span>&nbsp;<span class="op" id="601884">!=</span>&nbsp;<span class="ident" id="601887">e</span>&nbsp;<span class="op" id="601889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="601893">t</span><span class="op" id="601894">.</span><span class="ident" id="601895">Errorf</span><span class="op" id="601901">(</span><span class="string" id="601902">&#34;got&nbsp;response&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="601928">,</span>&nbsp;<span class="ident" id="601930">body</span><span class="op" id="601934">,</span>&nbsp;<span class="ident" id="601936">e</span><span class="op" id="601937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="601940">}</span><br>
<span class="lineno"></span><span class="op" id="601942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1520</span><span class="keyword" id="601945">func</span>&nbsp;<span class="ident" id="601950">TestTransportNoHost</span><span class="op" id="601969">(</span><span class="ident" id="601970">t</span>&nbsp;<span class="op" id="601972">*</span><span class="ident" id="601973">testing</span><span class="op" id="601980">.</span><span class="ident" id="601981">T</span><span class="op" id="601982">)</span>&nbsp;<span class="op" id="601984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="601987">defer</span>&nbsp;<span class="ident" id="601993">afterTest</span><span class="op" id="602002">(</span><span class="ident" id="602003">t</span><span class="op" id="602004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602007">tr</span>&nbsp;<span class="op" id="602010">:=</span>&nbsp;<span class="op" id="602013">&amp;</span><span class="ident" id="602014">Transport</span><span class="op" id="602023">{</span><span class="op" id="602024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602027">_</span><span class="op" id="602028">,</span>&nbsp;<span class="ident" id="602030">err</span>&nbsp;<span class="op" id="602034">:=</span>&nbsp;<span class="ident" id="602037">tr</span><span class="op" id="602039">.</span><span class="ident" id="602040">RoundTrip</span><span class="op" id="602049">(</span><span class="op" id="602050">&amp;</span><span class="ident" id="602051">Request</span><span class="op" id="602058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602062">Header</span><span class="op" id="602068">:</span>&nbsp;<span class="builtinfunc" id="602070">make</span><span class="op" id="602074">(</span><span class="ident" id="602075">Header</span><span class="op" id="602081">)</span><span class="op" id="602082">,</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602086">URL</span><span class="op" id="602089">:</span>&nbsp;<span class="op" id="602091">&amp;</span><span class="ident" id="602092">url</span><span class="op" id="602095">.</span><span class="ident" id="602096">URL</span><span class="op" id="602099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602104">Scheme</span><span class="op" id="602110">:</span>&nbsp;<span class="string" id="602112">&#34;http&#34;</span><span class="op" id="602118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602122">}</span><span class="op" id="602123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602126">}</span><span class="op" id="602127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602130">want</span>&nbsp;<span class="op" id="602135">:=</span>&nbsp;<span class="string" id="602138">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602170">if</span>&nbsp;<span class="ident" id="602173">got</span>&nbsp;<span class="op" id="602177">:=</span>&nbsp;<span class="ident" id="602180">fmt</span><span class="op" id="602183">.</span><span class="ident" id="602184">Sprint</span><span class="op" id="602190">(</span><span class="ident" id="602191">err</span><span class="op" id="602194">)</span><span class="op" id="602195">;</span>&nbsp;<span class="ident" id="602197">got</span>&nbsp;<span class="op" id="602201">!=</span>&nbsp;<span class="ident" id="602204">want</span>&nbsp;<span class="op" id="602209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602213">t</span><span class="op" id="602214">.</span><span class="ident" id="602215">Errorf</span><span class="op" id="602221">(</span><span class="string" id="602222">&#34;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="602243">,</span>&nbsp;<span class="ident" id="602245">err</span><span class="op" id="602248">,</span>&nbsp;<span class="ident" id="602250">want</span><span class="op" id="602254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602257">}</span><br>
<span class="lineno"></span><span class="op" id="602259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="602262">func</span>&nbsp;<span class="ident" id="602267">TestTransportSocketLateBinding</span><span class="op" id="602297">(</span><span class="ident" id="602298">t</span>&nbsp;<span class="op" id="602300">*</span><span class="ident" id="602301">testing</span><span class="op" id="602308">.</span><span class="ident" id="602309">T</span><span class="op" id="602310">)</span>&nbsp;<span class="op" id="602312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602315">defer</span>&nbsp;<span class="ident" id="602321">afterTest</span><span class="op" id="602330">(</span><span class="ident" id="602331">t</span><span class="op" id="602332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602336">mux</span>&nbsp;<span class="op" id="602340">:=</span>&nbsp;<span class="ident" id="602343">NewServeMux</span><span class="op" id="602354">(</span><span class="op" id="602355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602358">fooGate</span>&nbsp;<span class="op" id="602366">:=</span>&nbsp;<span class="builtinfunc" id="602369">make</span><span class="op" id="602373">(</span><span class="keyword" id="602374">chan</span>&nbsp;<span class="builtintype" id="602379">bool</span><span class="op" id="602383">,</span>&nbsp;<span class="num" id="602385">1</span><span class="op" id="602386">)</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602389">mux</span><span class="op" id="602392">.</span><span class="ident" id="602393">HandleFunc</span><span class="op" id="602403">(</span><span class="string" id="602404">&#34;/foo&#34;</span><span class="op" id="602410">,</span>&nbsp;<span class="keyword" id="602412">func</span><span class="op" id="602416">(</span><span class="ident" id="602417">w</span>&nbsp;<span class="ident" id="602419">ResponseWriter</span><span class="op" id="602433">,</span>&nbsp;<span class="ident" id="602435">r</span>&nbsp;<span class="op" id="602437">*</span><span class="ident" id="602438">Request</span><span class="op" id="602445">)</span>&nbsp;<span class="op" id="602447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602451">w</span><span class="op" id="602452">.</span><span class="ident" id="602453">Header</span><span class="op" id="602459">(</span><span class="op" id="602460">)</span><span class="op" id="602461">.</span><span class="ident" id="602462">Set</span><span class="op" id="602465">(</span><span class="string" id="602466">&#34;foo-ipport&#34;</span><span class="op" id="602478">,</span>&nbsp;<span class="ident" id="602480">r</span><span class="op" id="602481">.</span><span class="ident" id="602482">RemoteAddr</span><span class="op" id="602492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602496">w</span><span class="op" id="602497">.</span><span class="op" id="602498">(</span><span class="ident" id="602499">Flusher</span><span class="op" id="602506">)</span><span class="op" id="602507">.</span><span class="ident" id="602508">Flush</span><span class="op" id="602513">(</span><span class="op" id="602514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602518">&lt;-</span><span class="ident" id="602520">fooGate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602529">}</span><span class="op" id="602530">)</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602533">mux</span><span class="op" id="602536">.</span><span class="ident" id="602537">HandleFunc</span><span class="op" id="602547">(</span><span class="string" id="602548">&#34;/bar&#34;</span><span class="op" id="602554">,</span>&nbsp;<span class="keyword" id="602556">func</span><span class="op" id="602560">(</span><span class="ident" id="602561">w</span>&nbsp;<span class="ident" id="602563">ResponseWriter</span><span class="op" id="602577">,</span>&nbsp;<span class="ident" id="602579">r</span>&nbsp;<span class="op" id="602581">*</span><span class="ident" id="602582">Request</span><span class="op" id="602589">)</span>&nbsp;<span class="op" id="602591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602595">w</span><span class="op" id="602596">.</span><span class="ident" id="602597">Header</span><span class="op" id="602603">(</span><span class="op" id="602604">)</span><span class="op" id="602605">.</span><span class="ident" id="602606">Set</span><span class="op" id="602609">(</span><span class="string" id="602610">&#34;bar-ipport&#34;</span><span class="op" id="602622">,</span>&nbsp;<span class="ident" id="602624">r</span><span class="op" id="602625">.</span><span class="ident" id="602626">RemoteAddr</span><span class="op" id="602636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602639">}</span><span class="op" id="602640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602643">ts</span>&nbsp;<span class="op" id="602646">:=</span>&nbsp;<span class="ident" id="602649">httptest</span><span class="op" id="602657">.</span><span class="ident" id="602658">NewServer</span><span class="op" id="602667">(</span><span class="ident" id="602668">mux</span><span class="op" id="602671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602674">defer</span>&nbsp;<span class="ident" id="602680">ts</span><span class="op" id="602682">.</span><span class="ident" id="602683">Close</span><span class="op" id="602688">(</span><span class="op" id="602689">)</span><br>
<span class="lineno">1550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602693">dialGate</span>&nbsp;<span class="op" id="602702">:=</span>&nbsp;<span class="builtinfunc" id="602705">make</span><span class="op" id="602709">(</span><span class="keyword" id="602710">chan</span>&nbsp;<span class="builtintype" id="602715">bool</span><span class="op" id="602719">,</span>&nbsp;<span class="num" id="602721">1</span><span class="op" id="602722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602725">tr</span>&nbsp;<span class="op" id="602728">:=</span>&nbsp;<span class="op" id="602731">&amp;</span><span class="ident" id="602732">Transport</span><span class="op" id="602741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602745">Dial</span><span class="op" id="602749">:</span>&nbsp;<span class="keyword" id="602751">func</span><span class="op" id="602755">(</span><span class="ident" id="602756">n</span><span class="op" id="602757">,</span>&nbsp;<span class="ident" id="602759">addr</span>&nbsp;<span class="builtintype" id="602764">string</span><span class="op" id="602770">)</span>&nbsp;<span class="op" id="602772">(</span><span class="ident" id="602773">net</span><span class="op" id="602776">.</span><span class="ident" id="602777">Conn</span><span class="op" id="602781">,</span>&nbsp;<span class="builtintype" id="602783">error</span><span class="op" id="602788">)</span>&nbsp;<span class="op" id="602790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602795">if</span>&nbsp;<span class="op" id="602798">&lt;-</span><span class="ident" id="602800">dialGate</span>&nbsp;<span class="op" id="602809">{</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602815">return</span>&nbsp;<span class="ident" id="602822">net</span><span class="op" id="602825">.</span><span class="ident" id="602826">Dial</span><span class="op" id="602830">(</span><span class="ident" id="602831">n</span><span class="op" id="602832">,</span>&nbsp;<span class="ident" id="602834">addr</span><span class="op" id="602838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602848">return</span>&nbsp;<span class="ident" id="602855">nil</span><span class="op" id="602858">,</span>&nbsp;<span class="ident" id="602860">errors</span><span class="op" id="602866">.</span><span class="ident" id="602867">New</span><span class="op" id="602870">(</span><span class="string" id="602871">&#34;manually&nbsp;closed&#34;</span><span class="op" id="602888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602892">}</span><span class="op" id="602893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602897">DisableKeepAlives</span><span class="op" id="602914">:</span>&nbsp;<span class="builtintype" id="602916">false</span><span class="op" id="602921">,</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="602927">defer</span>&nbsp;<span class="ident" id="602933">tr</span><span class="op" id="602935">.</span><span class="ident" id="602936">CloseIdleConnections</span><span class="op" id="602956">(</span><span class="op" id="602957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602960">c</span>&nbsp;<span class="op" id="602962">:=</span>&nbsp;<span class="op" id="602965">&amp;</span><span class="ident" id="602966">Client</span><span class="op" id="602972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602976">Transport</span><span class="op" id="602985">:</span>&nbsp;<span class="ident" id="602987">tr</span><span class="op" id="602989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="602992">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="602996">dialGate</span>&nbsp;<span class="op" id="603005">&lt;-</span>&nbsp;<span class="builtintype" id="603008">true</span>&nbsp;<span class="comment" id="603013">//&nbsp;only&nbsp;allow&nbsp;one&nbsp;dial</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603037">fooRes</span><span class="op" id="603043">,</span>&nbsp;<span class="ident" id="603045">err</span>&nbsp;<span class="op" id="603049">:=</span>&nbsp;<span class="ident" id="603052">c</span><span class="op" id="603053">.</span><span class="ident" id="603054">Get</span><span class="op" id="603057">(</span><span class="ident" id="603058">ts</span><span class="op" id="603060">.</span><span class="ident" id="603061">URL</span>&nbsp;<span class="op" id="603065">+</span>&nbsp;<span class="string" id="603067">&#34;/foo&#34;</span><span class="op" id="603073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="603076">if</span>&nbsp;<span class="ident" id="603079">err</span>&nbsp;<span class="op" id="603083">!=</span>&nbsp;<span class="ident" id="603086">nil</span>&nbsp;<span class="op" id="603090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603094">t</span><span class="op" id="603095">.</span><span class="ident" id="603096">Fatal</span><span class="op" id="603101">(</span><span class="ident" id="603102">err</span><span class="op" id="603105">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="603108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603111">fooAddr</span>&nbsp;<span class="op" id="603119">:=</span>&nbsp;<span class="ident" id="603122">fooRes</span><span class="op" id="603128">.</span><span class="ident" id="603129">Header</span><span class="op" id="603135">.</span><span class="ident" id="603136">Get</span><span class="op" id="603139">(</span><span class="string" id="603140">&#34;foo-ipport&#34;</span><span class="op" id="603152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="603155">if</span>&nbsp;<span class="ident" id="603158">fooAddr</span>&nbsp;<span class="op" id="603166">==</span>&nbsp;<span class="string" id="603169">&#34;&#34;</span>&nbsp;<span class="op" id="603172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603176">t</span><span class="op" id="603177">.</span><span class="ident" id="603178">Fatal</span><span class="op" id="603183">(</span><span class="string" id="603184">&#34;No&nbsp;addr&nbsp;on&nbsp;/foo&nbsp;request&#34;</span><span class="op" id="603209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="603212">}</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603215">time</span><span class="op" id="603219">.</span><span class="ident" id="603220">AfterFunc</span><span class="op" id="603229">(</span><span class="num" id="603230">200</span><span class="op" id="603233">*</span><span class="ident" id="603234">time</span><span class="op" id="603238">.</span><span class="ident" id="603239">Millisecond</span><span class="op" id="603250">,</span>&nbsp;<span class="keyword" id="603252">func</span><span class="op" id="603256">(</span><span class="op" id="603257">)</span>&nbsp;<span class="op" id="603259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="603263">//&nbsp;let&nbsp;the&nbsp;foo&nbsp;response&nbsp;finish&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="603314">//&nbsp;connection&nbsp;for&nbsp;/bar</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603339">fooGate</span>&nbsp;<span class="op" id="603347">&lt;-</span>&nbsp;<span class="builtintype" id="603350">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603357">io</span><span class="op" id="603359">.</span><span class="ident" id="603360">Copy</span><span class="op" id="603364">(</span><span class="ident" id="603365">ioutil</span><span class="op" id="603371">.</span><span class="ident" id="603372">Discard</span><span class="op" id="603379">,</span>&nbsp;<span class="ident" id="603381">fooRes</span><span class="op" id="603387">.</span><span class="ident" id="603388">Body</span><span class="op" id="603392">)</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603396">fooRes</span><span class="op" id="603402">.</span><span class="ident" id="603403">Body</span><span class="op" id="603407">.</span><span class="ident" id="603408">Close</span><span class="op" id="603413">(</span><span class="op" id="603414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="603417">}</span><span class="op" id="603418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603422">barRes</span><span class="op" id="603428">,</span>&nbsp;<span class="ident" id="603430">err</span>&nbsp;<span class="op" id="603434">:=</span>&nbsp;<span class="ident" id="603437">c</span><span class="op" id="603438">.</span><span class="ident" id="603439">Get</span><span class="op" id="603442">(</span><span class="ident" id="603443">ts</span><span class="op" id="603445">.</span><span class="ident" id="603446">URL</span>&nbsp;<span class="op" id="603450">+</span>&nbsp;<span class="string" id="603452">&#34;/bar&#34;</span><span class="op" id="603458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="603461">if</span>&nbsp;<span class="ident" id="603464">err</span>&nbsp;<span class="op" id="603468">!=</span>&nbsp;<span class="ident" id="603471">nil</span>&nbsp;<span class="op" id="603475">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603479">t</span><span class="op" id="603480">.</span><span class="ident" id="603481">Fatal</span><span class="op" id="603486">(</span><span class="ident" id="603487">err</span><span class="op" id="603490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="603493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603496">barAddr</span>&nbsp;<span class="op" id="603504">:=</span>&nbsp;<span class="ident" id="603507">barRes</span><span class="op" id="603513">.</span><span class="ident" id="603514">Header</span><span class="op" id="603520">.</span><span class="ident" id="603521">Get</span><span class="op" id="603524">(</span><span class="string" id="603525">&#34;bar-ipport&#34;</span><span class="op" id="603537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="603540">if</span>&nbsp;<span class="ident" id="603543">barAddr</span>&nbsp;<span class="op" id="603551">!=</span>&nbsp;<span class="ident" id="603554">fooAddr</span>&nbsp;<span class="op" id="603562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603566">t</span><span class="op" id="603567">.</span><span class="ident" id="603568">Fatalf</span><span class="op" id="603574">(</span><span class="string" id="603575">&#34;/foo&nbsp;came&nbsp;from&nbsp;conn&nbsp;%q;&nbsp;/bar&nbsp;came&nbsp;from&nbsp;%q&nbsp;instead&#34;</span><span class="op" id="603626">,</span>&nbsp;<span class="ident" id="603628">fooAddr</span><span class="op" id="603635">,</span>&nbsp;<span class="ident" id="603637">barAddr</span><span class="op" id="603644">)</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="603647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603650">barRes</span><span class="op" id="603656">.</span><span class="ident" id="603657">Body</span><span class="op" id="603661">.</span><span class="ident" id="603662">Close</span><span class="op" id="603667">(</span><span class="op" id="603668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603671">dialGate</span>&nbsp;<span class="op" id="603680">&lt;-</span>&nbsp;<span class="builtintype" id="603683">false</span><br>
<span class="lineno"></span><span class="op" id="603689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1595</span><span class="comment" id="603692">//&nbsp;Issue&nbsp;2184</span><br>
<span class="lineno"></span><span class="keyword" id="603706">func</span>&nbsp;<span class="ident" id="603711">TestTransportReading100Continue</span><span class="op" id="603742">(</span><span class="ident" id="603743">t</span>&nbsp;<span class="op" id="603745">*</span><span class="ident" id="603746">testing</span><span class="op" id="603753">.</span><span class="ident" id="603754">T</span><span class="op" id="603755">)</span>&nbsp;<span class="op" id="603757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="603760">defer</span>&nbsp;<span class="ident" id="603766">afterTest</span><span class="op" id="603775">(</span><span class="ident" id="603776">t</span><span class="op" id="603777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="603781">const</span>&nbsp;<span class="ident" id="603787">numReqs</span>&nbsp;<span class="op" id="603795">=</span>&nbsp;<span class="num" id="603797">5</span><br>
<span class="lineno">1600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603800">reqBody</span>&nbsp;<span class="op" id="603808">:=</span>&nbsp;<span class="keyword" id="603811">func</span><span class="op" id="603815">(</span><span class="ident" id="603816">n</span>&nbsp;<span class="builtintype" id="603818">int</span><span class="op" id="603821">)</span>&nbsp;<span class="builtintype" id="603823">string</span>&nbsp;<span class="op" id="603830">{</span>&nbsp;<span class="keyword" id="603832">return</span>&nbsp;<span class="ident" id="603839">fmt</span><span class="op" id="603842">.</span><span class="ident" id="603843">Sprintf</span><span class="op" id="603850">(</span><span class="string" id="603851">&#34;request&nbsp;body&nbsp;%d&#34;</span><span class="op" id="603868">,</span>&nbsp;<span class="ident" id="603870">n</span><span class="op" id="603871">)</span>&nbsp;<span class="op" id="603873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603876">reqID</span>&nbsp;<span class="op" id="603882">:=</span>&nbsp;<span class="keyword" id="603885">func</span><span class="op" id="603889">(</span><span class="ident" id="603890">n</span>&nbsp;<span class="builtintype" id="603892">int</span><span class="op" id="603895">)</span>&nbsp;<span class="builtintype" id="603897">string</span>&nbsp;<span class="op" id="603904">{</span>&nbsp;<span class="keyword" id="603906">return</span>&nbsp;<span class="ident" id="603913">fmt</span><span class="op" id="603916">.</span><span class="ident" id="603917">Sprintf</span><span class="op" id="603924">(</span><span class="string" id="603925">&#34;REQ-ID-%d&#34;</span><span class="op" id="603936">,</span>&nbsp;<span class="ident" id="603938">n</span><span class="op" id="603939">)</span>&nbsp;<span class="op" id="603941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="603945">send100Response</span>&nbsp;<span class="op" id="603961">:=</span>&nbsp;<span class="keyword" id="603964">func</span><span class="op" id="603968">(</span><span class="ident" id="603969">w</span>&nbsp;<span class="op" id="603971">*</span><span class="ident" id="603972">io</span><span class="op" id="603974">.</span><span class="ident" id="603975">PipeWriter</span><span class="op" id="603985">,</span>&nbsp;<span class="ident" id="603987">r</span>&nbsp;<span class="op" id="603989">*</span><span class="ident" id="603990">io</span><span class="op" id="603992">.</span><span class="ident" id="603993">PipeReader</span><span class="op" id="604003">)</span>&nbsp;<span class="op" id="604005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604009">defer</span>&nbsp;<span class="ident" id="604015">w</span><span class="op" id="604016">.</span><span class="ident" id="604017">Close</span><span class="op" id="604022">(</span><span class="op" id="604023">)</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604027">defer</span>&nbsp;<span class="ident" id="604033">r</span><span class="op" id="604034">.</span><span class="ident" id="604035">Close</span><span class="op" id="604040">(</span><span class="op" id="604041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604045">br</span>&nbsp;<span class="op" id="604048">:=</span>&nbsp;<span class="ident" id="604051">bufio</span><span class="op" id="604056">.</span><span class="ident" id="604057">NewReader</span><span class="op" id="604066">(</span><span class="ident" id="604067">r</span><span class="op" id="604068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604072">n</span>&nbsp;<span class="op" id="604074">:=</span>&nbsp;<span class="num" id="604077">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604081">for</span>&nbsp;<span class="op" id="604085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604090">n</span><span class="op" id="604091">++</span><br>
<span class="lineno">1610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604097">req</span><span class="op" id="604100">,</span>&nbsp;<span class="ident" id="604102">err</span>&nbsp;<span class="op" id="604106">:=</span>&nbsp;<span class="ident" id="604109">ReadRequest</span><span class="op" id="604120">(</span><span class="ident" id="604121">br</span><span class="op" id="604123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604128">if</span>&nbsp;<span class="ident" id="604131">err</span>&nbsp;<span class="op" id="604135">==</span>&nbsp;<span class="ident" id="604138">io</span><span class="op" id="604140">.</span><span class="ident" id="604141">EOF</span>&nbsp;<span class="op" id="604145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604151">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604166">if</span>&nbsp;<span class="ident" id="604169">err</span>&nbsp;<span class="op" id="604173">!=</span>&nbsp;<span class="ident" id="604176">nil</span>&nbsp;<span class="op" id="604180">{</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604186">t</span><span class="op" id="604187">.</span><span class="ident" id="604188">Error</span><span class="op" id="604193">(</span><span class="ident" id="604194">err</span><span class="op" id="604197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604218">slurp</span><span class="op" id="604223">,</span>&nbsp;<span class="ident" id="604225">err</span>&nbsp;<span class="op" id="604229">:=</span>&nbsp;<span class="ident" id="604232">ioutil</span><span class="op" id="604238">.</span><span class="ident" id="604239">ReadAll</span><span class="op" id="604246">(</span><span class="ident" id="604247">req</span><span class="op" id="604250">.</span><span class="ident" id="604251">Body</span><span class="op" id="604255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604260">if</span>&nbsp;<span class="ident" id="604263">err</span>&nbsp;<span class="op" id="604267">!=</span>&nbsp;<span class="ident" id="604270">nil</span>&nbsp;<span class="op" id="604274">{</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604280">t</span><span class="op" id="604281">.</span><span class="ident" id="604282">Errorf</span><span class="op" id="604288">(</span><span class="string" id="604289">&#34;Server&nbsp;request&nbsp;body&nbsp;slurp:&nbsp;%v&#34;</span><span class="op" id="604320">,</span>&nbsp;<span class="ident" id="604322">err</span><span class="op" id="604325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604346">id</span>&nbsp;<span class="op" id="604349">:=</span>&nbsp;<span class="ident" id="604352">req</span><span class="op" id="604355">.</span><span class="ident" id="604356">Header</span><span class="op" id="604362">.</span><span class="ident" id="604363">Get</span><span class="op" id="604366">(</span><span class="string" id="604367">&#34;Request-Id&#34;</span><span class="op" id="604379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604384">resCode</span>&nbsp;<span class="op" id="604392">:=</span>&nbsp;<span class="ident" id="604395">req</span><span class="op" id="604398">.</span><span class="ident" id="604399">Header</span><span class="op" id="604405">.</span><span class="ident" id="604406">Get</span><span class="op" id="604409">(</span><span class="string" id="604410">&#34;X-Want-Response-Code&#34;</span><span class="op" id="604432">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604437">if</span>&nbsp;<span class="ident" id="604440">resCode</span>&nbsp;<span class="op" id="604448">==</span>&nbsp;<span class="string" id="604451">&#34;&#34;</span>&nbsp;<span class="op" id="604454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604460">resCode</span>&nbsp;<span class="op" id="604468">=</span>&nbsp;<span class="string" id="604470">&#34;100&nbsp;Continue&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604489">if</span>&nbsp;<span class="builtintype" id="604492">string</span><span class="op" id="604498">(</span><span class="ident" id="604499">slurp</span><span class="op" id="604504">)</span>&nbsp;<span class="op" id="604506">!=</span>&nbsp;<span class="ident" id="604509">reqBody</span><span class="op" id="604516">(</span><span class="ident" id="604517">n</span><span class="op" id="604518">)</span>&nbsp;<span class="op" id="604520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604527">t</span><span class="op" id="604528">.</span><span class="ident" id="604529">Errorf</span><span class="op" id="604535">(</span><span class="string" id="604536">&#34;Server&nbsp;got&nbsp;%q,&nbsp;%v;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="604564">,</span>&nbsp;<span class="ident" id="604566">slurp</span><span class="op" id="604571">,</span>&nbsp;<span class="ident" id="604573">err</span><span class="op" id="604576">,</span>&nbsp;<span class="ident" id="604578">reqBody</span><span class="op" id="604585">(</span><span class="ident" id="604586">n</span><span class="op" id="604587">)</span><span class="op" id="604588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604594">}</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604604">body</span>&nbsp;<span class="op" id="604609">:=</span>&nbsp;<span class="ident" id="604612">fmt</span><span class="op" id="604615">.</span><span class="ident" id="604616">Sprintf</span><span class="op" id="604623">(</span><span class="string" id="604624">&#34;Response&nbsp;number&nbsp;%d&#34;</span><span class="op" id="604644">,</span>&nbsp;<span class="ident" id="604646">n</span><span class="op" id="604647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604652">v</span>&nbsp;<span class="op" id="604654">:=</span>&nbsp;<span class="op" id="604657">[</span><span class="op" id="604658">]</span><span class="builtintype" id="604659">byte</span><span class="op" id="604663">(</span><span class="ident" id="604664">strings</span><span class="op" id="604671">.</span><span class="ident" id="604672">Replace</span><span class="op" id="604679">(</span><span class="ident" id="604680">fmt</span><span class="op" id="604683">.</span><span class="ident" id="604684">Sprintf</span><span class="op" id="604691">(</span><span class="string" id="604692">`HTTP/1.1&nbsp;%s<br>
<span class="lineno"></span>Date:&nbsp;Thu,&nbsp;28&nbsp;Feb&nbsp;2013&nbsp;17:55:41&nbsp;GMT<br>
<span class="lineno"></span><br>
<span class="lineno">1635</span>HTTP/1.1&nbsp;200&nbsp;OK<br>
<span class="lineno"></span>Content-Type:&nbsp;text/html<br>
<span class="lineno"></span>Echo-Request-Id:&nbsp;%s<br>
<span class="lineno"></span>Content-Length:&nbsp;%d<br>
<span class="lineno"></span><br>
<span class="lineno">1640</span>%s`</span><span class="op" id="604825">,</span>&nbsp;<span class="ident" id="604827">resCode</span><span class="op" id="604834">,</span>&nbsp;<span class="ident" id="604836">id</span><span class="op" id="604838">,</span>&nbsp;<span class="builtinfunc" id="604840">len</span><span class="op" id="604843">(</span><span class="ident" id="604844">body</span><span class="op" id="604848">)</span><span class="op" id="604849">,</span>&nbsp;<span class="ident" id="604851">body</span><span class="op" id="604855">)</span><span class="op" id="604856">,</span>&nbsp;<span class="string" id="604858">&#34;\n&#34;</span><span class="op" id="604862">,</span>&nbsp;<span class="string" id="604864">&#34;\r\n&#34;</span><span class="op" id="604870">,</span>&nbsp;<span class="op" id="604872">-</span><span class="num" id="604873">1</span><span class="op" id="604874">)</span><span class="op" id="604875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604880">w</span><span class="op" id="604881">.</span><span class="ident" id="604882">Write</span><span class="op" id="604887">(</span><span class="ident" id="604888">v</span><span class="op" id="604889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604894">if</span>&nbsp;<span class="ident" id="604897">id</span>&nbsp;<span class="op" id="604900">==</span>&nbsp;<span class="ident" id="604903">reqID</span><span class="op" id="604908">(</span><span class="ident" id="604909">numReqs</span><span class="op" id="604916">)</span>&nbsp;<span class="op" id="604918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="604924">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604934">}</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="604942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604946">tr</span>&nbsp;<span class="op" id="604949">:=</span>&nbsp;<span class="op" id="604952">&amp;</span><span class="ident" id="604953">Transport</span><span class="op" id="604962">{</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="604966">Dial</span><span class="op" id="604970">:</span>&nbsp;<span class="keyword" id="604972">func</span><span class="op" id="604976">(</span><span class="ident" id="604977">n</span><span class="op" id="604978">,</span>&nbsp;<span class="ident" id="604980">addr</span>&nbsp;<span class="builtintype" id="604985">string</span><span class="op" id="604991">)</span>&nbsp;<span class="op" id="604993">(</span><span class="ident" id="604994">net</span><span class="op" id="604997">.</span><span class="ident" id="604998">Conn</span><span class="op" id="605002">,</span>&nbsp;<span class="builtintype" id="605004">error</span><span class="op" id="605009">)</span>&nbsp;<span class="op" id="605011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605016">sr</span><span class="op" id="605018">,</span>&nbsp;<span class="ident" id="605020">sw</span>&nbsp;<span class="op" id="605023">:=</span>&nbsp;<span class="ident" id="605026">io</span><span class="op" id="605028">.</span><span class="ident" id="605029">Pipe</span><span class="op" id="605033">(</span><span class="op" id="605034">)</span>&nbsp;<span class="comment" id="605036">//&nbsp;server&nbsp;read/write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605060">cr</span><span class="op" id="605062">,</span>&nbsp;<span class="ident" id="605064">cw</span>&nbsp;<span class="op" id="605067">:=</span>&nbsp;<span class="ident" id="605070">io</span><span class="op" id="605072">.</span><span class="ident" id="605073">Pipe</span><span class="op" id="605077">(</span><span class="op" id="605078">)</span>&nbsp;<span class="comment" id="605080">//&nbsp;client&nbsp;read/write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605104">conn</span>&nbsp;<span class="op" id="605109">:=</span>&nbsp;<span class="op" id="605112">&amp;</span><span class="ident" id="605113">rwTestConn</span><span class="op" id="605123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605129">Reader</span><span class="op" id="605135">:</span>&nbsp;<span class="ident" id="605137">cr</span><span class="op" id="605139">,</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605145">Writer</span><span class="op" id="605151">:</span>&nbsp;<span class="ident" id="605153">sw</span><span class="op" id="605155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605161">closeFunc</span><span class="op" id="605170">:</span>&nbsp;<span class="keyword" id="605172">func</span><span class="op" id="605176">(</span><span class="op" id="605177">)</span>&nbsp;<span class="builtintype" id="605179">error</span>&nbsp;<span class="op" id="605185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605192">sw</span><span class="op" id="605194">.</span><span class="ident" id="605195">Close</span><span class="op" id="605200">(</span><span class="op" id="605201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605208">cw</span><span class="op" id="605210">.</span><span class="ident" id="605211">Close</span><span class="op" id="605216">(</span><span class="op" id="605217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605224">return</span>&nbsp;<span class="ident" id="605231">nil</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605239">}</span><span class="op" id="605240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605250">go</span>&nbsp;<span class="ident" id="605253">send100Response</span><span class="op" id="605268">(</span><span class="ident" id="605269">cw</span><span class="op" id="605271">,</span>&nbsp;<span class="ident" id="605273">sr</span><span class="op" id="605275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605280">return</span>&nbsp;<span class="ident" id="605287">conn</span><span class="op" id="605291">,</span>&nbsp;<span class="ident" id="605293">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605299">}</span><span class="op" id="605300">,</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605304">DisableKeepAlives</span><span class="op" id="605321">:</span>&nbsp;<span class="builtintype" id="605323">false</span><span class="op" id="605328">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605334">defer</span>&nbsp;<span class="ident" id="605340">tr</span><span class="op" id="605342">.</span><span class="ident" id="605343">CloseIdleConnections</span><span class="op" id="605363">(</span><span class="op" id="605364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605367">c</span>&nbsp;<span class="op" id="605369">:=</span>&nbsp;<span class="op" id="605372">&amp;</span><span class="ident" id="605373">Client</span><span class="op" id="605379">{</span><span class="ident" id="605380">Transport</span><span class="op" id="605389">:</span>&nbsp;<span class="ident" id="605391">tr</span><span class="op" id="605393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605397">testResponse</span>&nbsp;<span class="op" id="605410">:=</span>&nbsp;<span class="keyword" id="605413">func</span><span class="op" id="605417">(</span><span class="ident" id="605418">req</span>&nbsp;<span class="op" id="605422">*</span><span class="ident" id="605423">Request</span><span class="op" id="605430">,</span>&nbsp;<span class="ident" id="605432">name</span>&nbsp;<span class="builtintype" id="605437">string</span><span class="op" id="605443">,</span>&nbsp;<span class="ident" id="605445">wantCode</span>&nbsp;<span class="builtintype" id="605454">int</span><span class="op" id="605457">)</span>&nbsp;<span class="op" id="605459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605463">res</span><span class="op" id="605466">,</span>&nbsp;<span class="ident" id="605468">err</span>&nbsp;<span class="op" id="605472">:=</span>&nbsp;<span class="ident" id="605475">c</span><span class="op" id="605476">.</span><span class="ident" id="605477">Do</span><span class="op" id="605479">(</span><span class="ident" id="605480">req</span><span class="op" id="605483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605487">if</span>&nbsp;<span class="ident" id="605490">err</span>&nbsp;<span class="op" id="605494">!=</span>&nbsp;<span class="ident" id="605497">nil</span>&nbsp;<span class="op" id="605501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605506">t</span><span class="op" id="605507">.</span><span class="ident" id="605508">Fatalf</span><span class="op" id="605514">(</span><span class="string" id="605515">&#34;%s:&nbsp;Do:&nbsp;%v&#34;</span><span class="op" id="605527">,</span>&nbsp;<span class="ident" id="605529">name</span><span class="op" id="605533">,</span>&nbsp;<span class="ident" id="605535">err</span><span class="op" id="605538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605542">}</span><br>
<span class="lineno">1675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605546">if</span>&nbsp;<span class="ident" id="605549">res</span><span class="op" id="605552">.</span><span class="ident" id="605553">StatusCode</span>&nbsp;<span class="op" id="605564">!=</span>&nbsp;<span class="ident" id="605567">wantCode</span>&nbsp;<span class="op" id="605576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605581">t</span><span class="op" id="605582">.</span><span class="ident" id="605583">Fatalf</span><span class="op" id="605589">(</span><span class="string" id="605590">&#34;%s:&nbsp;Response&nbsp;Statuscode=%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="605627">,</span>&nbsp;<span class="ident" id="605629">name</span><span class="op" id="605633">,</span>&nbsp;<span class="ident" id="605635">res</span><span class="op" id="605638">.</span><span class="ident" id="605639">StatusCode</span><span class="op" id="605649">,</span>&nbsp;<span class="ident" id="605651">wantCode</span><span class="op" id="605659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605667">if</span>&nbsp;<span class="ident" id="605670">id</span><span class="op" id="605672">,</span>&nbsp;<span class="ident" id="605674">idBack</span>&nbsp;<span class="op" id="605681">:=</span>&nbsp;<span class="ident" id="605684">req</span><span class="op" id="605687">.</span><span class="ident" id="605688">Header</span><span class="op" id="605694">.</span><span class="ident" id="605695">Get</span><span class="op" id="605698">(</span><span class="string" id="605699">&#34;Request-Id&#34;</span><span class="op" id="605711">)</span><span class="op" id="605712">,</span>&nbsp;<span class="ident" id="605714">res</span><span class="op" id="605717">.</span><span class="ident" id="605718">Header</span><span class="op" id="605724">.</span><span class="ident" id="605725">Get</span><span class="op" id="605728">(</span><span class="string" id="605729">&#34;Echo-Request-Id&#34;</span><span class="op" id="605746">)</span><span class="op" id="605747">;</span>&nbsp;<span class="ident" id="605749">id</span>&nbsp;<span class="op" id="605752">!=</span>&nbsp;<span class="string" id="605755">&#34;&#34;</span>&nbsp;<span class="op" id="605758">&amp;&amp;</span>&nbsp;<span class="ident" id="605761">id</span>&nbsp;<span class="op" id="605764">!=</span>&nbsp;<span class="ident" id="605767">idBack</span>&nbsp;<span class="op" id="605774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605779">t</span><span class="op" id="605780">.</span><span class="ident" id="605781">Errorf</span><span class="op" id="605787">(</span><span class="string" id="605788">&#34;%s:&nbsp;response&nbsp;id&nbsp;%q&nbsp;!=&nbsp;request&nbsp;id&nbsp;%q&#34;</span><span class="op" id="605825">,</span>&nbsp;<span class="ident" id="605827">name</span><span class="op" id="605831">,</span>&nbsp;<span class="ident" id="605833">idBack</span><span class="op" id="605839">,</span>&nbsp;<span class="ident" id="605841">id</span><span class="op" id="605843">)</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605851">_</span><span class="op" id="605852">,</span>&nbsp;<span class="ident" id="605854">err</span>&nbsp;<span class="op" id="605858">=</span>&nbsp;<span class="ident" id="605860">ioutil</span><span class="op" id="605866">.</span><span class="ident" id="605867">ReadAll</span><span class="op" id="605874">(</span><span class="ident" id="605875">res</span><span class="op" id="605878">.</span><span class="ident" id="605879">Body</span><span class="op" id="605883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="605887">if</span>&nbsp;<span class="ident" id="605890">err</span>&nbsp;<span class="op" id="605894">!=</span>&nbsp;<span class="ident" id="605897">nil</span>&nbsp;<span class="op" id="605901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="605906">t</span><span class="op" id="605907">.</span><span class="ident" id="605908">Fatalf</span><span class="op" id="605914">(</span><span class="string" id="605915">&#34;%s:&nbsp;Slurp&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="605936">,</span>&nbsp;<span class="ident" id="605938">name</span><span class="op" id="605942">,</span>&nbsp;<span class="ident" id="605944">err</span><span class="op" id="605947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605951">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="605954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="605958">//&nbsp;Few&nbsp;100&nbsp;responses,&nbsp;making&nbsp;sure&nbsp;we&#39;re&nbsp;not&nbsp;off-by-one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="606015">for</span>&nbsp;<span class="ident" id="606019">i</span>&nbsp;<span class="op" id="606021">:=</span>&nbsp;<span class="num" id="606024">1</span><span class="op" id="606025">;</span>&nbsp;<span class="ident" id="606027">i</span>&nbsp;<span class="op" id="606029">&lt;=</span>&nbsp;<span class="ident" id="606032">numReqs</span><span class="op" id="606039">;</span>&nbsp;<span class="ident" id="606041">i</span><span class="op" id="606042">++</span>&nbsp;<span class="op" id="606045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606049">req</span><span class="op" id="606052">,</span>&nbsp;<span class="ident" id="606054">_</span>&nbsp;<span class="op" id="606056">:=</span>&nbsp;<span class="ident" id="606059">NewRequest</span><span class="op" id="606069">(</span><span class="string" id="606070">&#34;POST&#34;</span><span class="op" id="606076">,</span>&nbsp;<span class="string" id="606078">&#34;http://dummy.tld/&#34;</span><span class="op" id="606097">,</span>&nbsp;<span class="ident" id="606099">strings</span><span class="op" id="606106">.</span><span class="ident" id="606107">NewReader</span><span class="op" id="606116">(</span><span class="ident" id="606117">reqBody</span><span class="op" id="606124">(</span><span class="ident" id="606125">i</span><span class="op" id="606126">)</span><span class="op" id="606127">)</span><span class="op" id="606128">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606132">req</span><span class="op" id="606135">.</span><span class="ident" id="606136">Header</span><span class="op" id="606142">.</span><span class="ident" id="606143">Set</span><span class="op" id="606146">(</span><span class="string" id="606147">&#34;Request-Id&#34;</span><span class="op" id="606159">,</span>&nbsp;<span class="ident" id="606161">reqID</span><span class="op" id="606166">(</span><span class="ident" id="606167">i</span><span class="op" id="606168">)</span><span class="op" id="606169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606173">testResponse</span><span class="op" id="606185">(</span><span class="ident" id="606186">req</span><span class="op" id="606189">,</span>&nbsp;<span class="ident" id="606191">fmt</span><span class="op" id="606194">.</span><span class="ident" id="606195">Sprintf</span><span class="op" id="606202">(</span><span class="string" id="606203">&#34;100,&nbsp;%d/%d&#34;</span><span class="op" id="606215">,</span>&nbsp;<span class="ident" id="606217">i</span><span class="op" id="606218">,</span>&nbsp;<span class="ident" id="606220">numReqs</span><span class="op" id="606227">)</span><span class="op" id="606228">,</span>&nbsp;<span class="num" id="606230">200</span><span class="op" id="606233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="606236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="606240">//&nbsp;And&nbsp;some&nbsp;other&nbsp;informational&nbsp;1xx&nbsp;but&nbsp;non-100&nbsp;responses,&nbsp;to&nbsp;test</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="606308">//&nbsp;we&nbsp;return&nbsp;them&nbsp;but&nbsp;don&#39;t&nbsp;re-use&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="606360">for</span>&nbsp;<span class="ident" id="606364">i</span>&nbsp;<span class="op" id="606366">:=</span>&nbsp;<span class="num" id="606369">1</span><span class="op" id="606370">;</span>&nbsp;<span class="ident" id="606372">i</span>&nbsp;<span class="op" id="606374">&lt;=</span>&nbsp;<span class="ident" id="606377">numReqs</span><span class="op" id="606384">;</span>&nbsp;<span class="ident" id="606386">i</span><span class="op" id="606387">++</span>&nbsp;<span class="op" id="606390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606394">req</span><span class="op" id="606397">,</span>&nbsp;<span class="ident" id="606399">_</span>&nbsp;<span class="op" id="606401">:=</span>&nbsp;<span class="ident" id="606404">NewRequest</span><span class="op" id="606414">(</span><span class="string" id="606415">&#34;POST&#34;</span><span class="op" id="606421">,</span>&nbsp;<span class="string" id="606423">&#34;http://other.tld/&#34;</span><span class="op" id="606442">,</span>&nbsp;<span class="ident" id="606444">strings</span><span class="op" id="606451">.</span><span class="ident" id="606452">NewReader</span><span class="op" id="606461">(</span><span class="ident" id="606462">reqBody</span><span class="op" id="606469">(</span><span class="ident" id="606470">i</span><span class="op" id="606471">)</span><span class="op" id="606472">)</span><span class="op" id="606473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606477">req</span><span class="op" id="606480">.</span><span class="ident" id="606481">Header</span><span class="op" id="606487">.</span><span class="ident" id="606488">Set</span><span class="op" id="606491">(</span><span class="string" id="606492">&#34;X-Want-Response-Code&#34;</span><span class="op" id="606514">,</span>&nbsp;<span class="string" id="606516">&#34;123&nbsp;Sesame&nbsp;Street&#34;</span><span class="op" id="606535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606539">testResponse</span><span class="op" id="606551">(</span><span class="ident" id="606552">req</span><span class="op" id="606555">,</span>&nbsp;<span class="ident" id="606557">fmt</span><span class="op" id="606560">.</span><span class="ident" id="606561">Sprintf</span><span class="op" id="606568">(</span><span class="string" id="606569">&#34;123,&nbsp;%d/%d&#34;</span><span class="op" id="606581">,</span>&nbsp;<span class="ident" id="606583">i</span><span class="op" id="606584">,</span>&nbsp;<span class="ident" id="606586">numReqs</span><span class="op" id="606593">)</span><span class="op" id="606594">,</span>&nbsp;<span class="num" id="606596">123</span><span class="op" id="606599">)</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="606602">}</span><br>
<span class="lineno"></span><span class="op" id="606604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="606607">type</span>&nbsp;<span class="ident" id="606612">proxyFromEnvTest</span>&nbsp;<span class="keyword" id="606629">struct</span>&nbsp;<span class="op" id="606636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606639">req</span>&nbsp;<span class="builtintype" id="606643">string</span>&nbsp;<span class="comment" id="606650">//&nbsp;URL&nbsp;to&nbsp;fetch;&nbsp;blank&nbsp;means&nbsp;&#34;http://example.com&#34;</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606702">env</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="606711">string</span>&nbsp;<span class="comment" id="606718">//&nbsp;HTTP_PROXY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606733">httpsenv</span>&nbsp;<span class="builtintype" id="606742">string</span>&nbsp;<span class="comment" id="606749">//&nbsp;HTTPS_PROXY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606765">noenv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="606774">string</span>&nbsp;<span class="comment" id="606781">//&nbsp;NO_RPXY</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606794">want</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="606802">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606810">wanterr</span>&nbsp;<span class="builtintype" id="606818">error</span><br>
<span class="lineno"></span><span class="op" id="606824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="606827">func</span>&nbsp;<span class="op" id="606832">(</span><span class="ident" id="606833">t</span>&nbsp;<span class="ident" id="606835">proxyFromEnvTest</span><span class="op" id="606851">)</span>&nbsp;<span class="ident" id="606853">String</span><span class="op" id="606859">(</span><span class="op" id="606860">)</span>&nbsp;<span class="builtintype" id="606862">string</span>&nbsp;<span class="op" id="606869">{</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="606872">var</span>&nbsp;<span class="ident" id="606876">buf</span>&nbsp;<span class="ident" id="606880">bytes</span><span class="op" id="606885">.</span><span class="ident" id="606886">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606894">space</span>&nbsp;<span class="op" id="606900">:=</span>&nbsp;<span class="keyword" id="606903">func</span><span class="op" id="606907">(</span><span class="op" id="606908">)</span>&nbsp;<span class="op" id="606910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="606914">if</span>&nbsp;<span class="ident" id="606917">buf</span><span class="op" id="606920">.</span><span class="ident" id="606921">Len</span><span class="op" id="606924">(</span><span class="op" id="606925">)</span>&nbsp;<span class="op" id="606927">&gt;</span>&nbsp;<span class="num" id="606929">0</span>&nbsp;<span class="op" id="606931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606936">buf</span><span class="op" id="606939">.</span><span class="ident" id="606940">WriteByte</span><span class="op" id="606949">(</span><span class="string" id="606950">&#39;&nbsp;&#39;</span><span class="op" id="606953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="606957">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="606960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="606963">if</span>&nbsp;<span class="ident" id="606966">t</span><span class="op" id="606967">.</span><span class="ident" id="606968">env</span>&nbsp;<span class="op" id="606972">!=</span>&nbsp;<span class="string" id="606975">&#34;&#34;</span>&nbsp;<span class="op" id="606978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="606982">fmt</span><span class="op" id="606985">.</span><span class="ident" id="606986">Fprintf</span><span class="op" id="606993">(</span><span class="op" id="606994">&amp;</span><span class="ident" id="606995">buf</span><span class="op" id="606998">,</span>&nbsp;<span class="string" id="607000">&#34;http_proxy=%q&#34;</span><span class="op" id="607015">,</span>&nbsp;<span class="ident" id="607017">t</span><span class="op" id="607018">.</span><span class="ident" id="607019">env</span><span class="op" id="607022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="607028">if</span>&nbsp;<span class="ident" id="607031">t</span><span class="op" id="607032">.</span><span class="ident" id="607033">httpsenv</span>&nbsp;<span class="op" id="607042">!=</span>&nbsp;<span class="string" id="607045">&#34;&#34;</span>&nbsp;<span class="op" id="607048">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607052">space</span><span class="op" id="607057">(</span><span class="op" id="607058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607062">fmt</span><span class="op" id="607065">.</span><span class="ident" id="607066">Fprintf</span><span class="op" id="607073">(</span><span class="op" id="607074">&amp;</span><span class="ident" id="607075">buf</span><span class="op" id="607078">,</span>&nbsp;<span class="string" id="607080">&#34;https_proxy=%q&#34;</span><span class="op" id="607096">,</span>&nbsp;<span class="ident" id="607098">t</span><span class="op" id="607099">.</span><span class="ident" id="607100">httpsenv</span><span class="op" id="607108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="607114">if</span>&nbsp;<span class="ident" id="607117">t</span><span class="op" id="607118">.</span><span class="ident" id="607119">noenv</span>&nbsp;<span class="op" id="607125">!=</span>&nbsp;<span class="string" id="607128">&#34;&#34;</span>&nbsp;<span class="op" id="607131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607135">space</span><span class="op" id="607140">(</span><span class="op" id="607141">)</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607145">fmt</span><span class="op" id="607148">.</span><span class="ident" id="607149">Fprintf</span><span class="op" id="607156">(</span><span class="op" id="607157">&amp;</span><span class="ident" id="607158">buf</span><span class="op" id="607161">,</span>&nbsp;<span class="string" id="607163">&#34;no_proxy=%q&#34;</span><span class="op" id="607176">,</span>&nbsp;<span class="ident" id="607178">t</span><span class="op" id="607179">.</span><span class="ident" id="607180">noenv</span><span class="op" id="607185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607191">req</span>&nbsp;<span class="op" id="607195">:=</span>&nbsp;<span class="string" id="607198">&#34;http://example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="607220">if</span>&nbsp;<span class="ident" id="607223">t</span><span class="op" id="607224">.</span><span class="ident" id="607225">req</span>&nbsp;<span class="op" id="607229">!=</span>&nbsp;<span class="string" id="607232">&#34;&#34;</span>&nbsp;<span class="op" id="607235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607239">req</span>&nbsp;<span class="op" id="607243">=</span>&nbsp;<span class="ident" id="607245">t</span><span class="op" id="607246">.</span><span class="ident" id="607247">req</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607255">space</span><span class="op" id="607260">(</span><span class="op" id="607261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="607264">fmt</span><span class="op" id="607267">.</span><span class="ident" id="607268">Fprintf</span><span class="op" id="607275">(</span><span class="op" id="607276">&amp;</span><span class="ident" id="607277">buf</span><span class="op" id="607280">,</span>&nbsp;<span class="string" id="607282">&#34;req=%q&#34;</span><span class="op" id="607290">,</span>&nbsp;<span class="ident" id="607292">req</span><span class="op" id="607295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="607298">return</span>&nbsp;<span class="ident" id="607305">strings</span><span class="op" id="607312">.</span><span class="ident" id="607313">TrimSpace</span><span class="op" id="607322">(</span><span class="ident" id="607323">buf</span><span class="op" id="607326">.</span><span class="ident" id="607327">String</span><span class="op" id="607333">(</span><span class="op" id="607334">)</span><span class="op" id="607335">)</span><br>
<span class="lineno"></span><span class="op" id="607337">}</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span><span class="keyword" id="607340">var</span>&nbsp;<span class="ident" id="607344">proxyFromEnvTests</span>&nbsp;<span class="op" id="607362">=</span>&nbsp;<span class="op" id="607364">[</span><span class="op" id="607365">]</span><span class="ident" id="607366">proxyFromEnvTest</span><span class="op" id="607382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607385">{</span><span class="ident" id="607386">env</span><span class="op" id="607389">:</span>&nbsp;<span class="string" id="607391">&#34;127.0.0.1:8080&#34;</span><span class="op" id="607407">,</span>&nbsp;<span class="ident" id="607409">want</span><span class="op" id="607413">:</span>&nbsp;<span class="string" id="607415">&#34;http://127.0.0.1:8080&#34;</span><span class="op" id="607438">}</span><span class="op" id="607439">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607442">{</span><span class="ident" id="607443">env</span><span class="op" id="607446">:</span>&nbsp;<span class="string" id="607448">&#34;cache.corp.example.com:1234&#34;</span><span class="op" id="607477">,</span>&nbsp;<span class="ident" id="607479">want</span><span class="op" id="607483">:</span>&nbsp;<span class="string" id="607485">&#34;http://cache.corp.example.com:1234&#34;</span><span class="op" id="607521">}</span><span class="op" id="607522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607525">{</span><span class="ident" id="607526">env</span><span class="op" id="607529">:</span>&nbsp;<span class="string" id="607531">&#34;cache.corp.example.com&#34;</span><span class="op" id="607555">,</span>&nbsp;<span class="ident" id="607557">want</span><span class="op" id="607561">:</span>&nbsp;<span class="string" id="607563">&#34;http://cache.corp.example.com&#34;</span><span class="op" id="607594">}</span><span class="op" id="607595">,</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607598">{</span><span class="ident" id="607599">env</span><span class="op" id="607602">:</span>&nbsp;<span class="string" id="607604">&#34;https://cache.corp.example.com&#34;</span><span class="op" id="607636">,</span>&nbsp;<span class="ident" id="607638">want</span><span class="op" id="607642">:</span>&nbsp;<span class="string" id="607644">&#34;https://cache.corp.example.com&#34;</span><span class="op" id="607676">}</span><span class="op" id="607677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607680">{</span><span class="ident" id="607681">env</span><span class="op" id="607684">:</span>&nbsp;<span class="string" id="607686">&#34;http://127.0.0.1:8080&#34;</span><span class="op" id="607709">,</span>&nbsp;<span class="ident" id="607711">want</span><span class="op" id="607715">:</span>&nbsp;<span class="string" id="607717">&#34;http://127.0.0.1:8080&#34;</span><span class="op" id="607740">}</span><span class="op" id="607741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607744">{</span><span class="ident" id="607745">env</span><span class="op" id="607748">:</span>&nbsp;<span class="string" id="607750">&#34;https://127.0.0.1:8080&#34;</span><span class="op" id="607774">,</span>&nbsp;<span class="ident" id="607776">want</span><span class="op" id="607780">:</span>&nbsp;<span class="string" id="607782">&#34;https://127.0.0.1:8080&#34;</span><span class="op" id="607806">}</span><span class="op" id="607807">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="607811">//&nbsp;Don&#39;t&nbsp;use&nbsp;secure&nbsp;for&nbsp;http</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607841">{</span><span class="ident" id="607842">req</span><span class="op" id="607845">:</span>&nbsp;<span class="string" id="607847">&#34;http://insecure.tld/&#34;</span><span class="op" id="607869">,</span>&nbsp;<span class="ident" id="607871">env</span><span class="op" id="607874">:</span>&nbsp;<span class="string" id="607876">&#34;http.proxy.tld&#34;</span><span class="op" id="607892">,</span>&nbsp;<span class="ident" id="607894">httpsenv</span><span class="op" id="607902">:</span>&nbsp;<span class="string" id="607904">&#34;secure.proxy.tld&#34;</span><span class="op" id="607922">,</span>&nbsp;<span class="ident" id="607924">want</span><span class="op" id="607928">:</span>&nbsp;<span class="string" id="607930">&#34;http://http.proxy.tld&#34;</span><span class="op" id="607953">}</span><span class="op" id="607954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="607957">//&nbsp;Use&nbsp;secure&nbsp;for&nbsp;https.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="607983">{</span><span class="ident" id="607984">req</span><span class="op" id="607987">:</span>&nbsp;<span class="string" id="607989">&#34;https://secure.tld/&#34;</span><span class="op" id="608010">,</span>&nbsp;<span class="ident" id="608012">env</span><span class="op" id="608015">:</span>&nbsp;<span class="string" id="608017">&#34;http.proxy.tld&#34;</span><span class="op" id="608033">,</span>&nbsp;<span class="ident" id="608035">httpsenv</span><span class="op" id="608043">:</span>&nbsp;<span class="string" id="608045">&#34;secure.proxy.tld&#34;</span><span class="op" id="608063">,</span>&nbsp;<span class="ident" id="608065">want</span><span class="op" id="608069">:</span>&nbsp;<span class="string" id="608071">&#34;http://secure.proxy.tld&#34;</span><span class="op" id="608096">}</span><span class="op" id="608097">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608100">{</span><span class="ident" id="608101">req</span><span class="op" id="608104">:</span>&nbsp;<span class="string" id="608106">&#34;https://secure.tld/&#34;</span><span class="op" id="608127">,</span>&nbsp;<span class="ident" id="608129">env</span><span class="op" id="608132">:</span>&nbsp;<span class="string" id="608134">&#34;http.proxy.tld&#34;</span><span class="op" id="608150">,</span>&nbsp;<span class="ident" id="608152">httpsenv</span><span class="op" id="608160">:</span>&nbsp;<span class="string" id="608162">&#34;https://secure.proxy.tld&#34;</span><span class="op" id="608188">,</span>&nbsp;<span class="ident" id="608190">want</span><span class="op" id="608194">:</span>&nbsp;<span class="string" id="608196">&#34;https://secure.proxy.tld&#34;</span><span class="op" id="608222">}</span><span class="op" id="608223">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608227">{</span><span class="ident" id="608228">want</span><span class="op" id="608232">:</span>&nbsp;<span class="string" id="608234">&#34;&lt;nil&gt;&#34;</span><span class="op" id="608241">}</span><span class="op" id="608242">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608246">{</span><span class="ident" id="608247">noenv</span><span class="op" id="608252">:</span>&nbsp;<span class="string" id="608254">&#34;example.com&#34;</span><span class="op" id="608267">,</span>&nbsp;<span class="ident" id="608269">req</span><span class="op" id="608272">:</span>&nbsp;<span class="string" id="608274">&#34;http://example.com/&#34;</span><span class="op" id="608295">,</span>&nbsp;<span class="ident" id="608297">env</span><span class="op" id="608300">:</span>&nbsp;<span class="string" id="608302">&#34;proxy&#34;</span><span class="op" id="608309">,</span>&nbsp;<span class="ident" id="608311">want</span><span class="op" id="608315">:</span>&nbsp;<span class="string" id="608317">&#34;&lt;nil&gt;&#34;</span><span class="op" id="608324">}</span><span class="op" id="608325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608328">{</span><span class="ident" id="608329">noenv</span><span class="op" id="608334">:</span>&nbsp;<span class="string" id="608336">&#34;.example.com&#34;</span><span class="op" id="608350">,</span>&nbsp;<span class="ident" id="608352">req</span><span class="op" id="608355">:</span>&nbsp;<span class="string" id="608357">&#34;http://example.com/&#34;</span><span class="op" id="608378">,</span>&nbsp;<span class="ident" id="608380">env</span><span class="op" id="608383">:</span>&nbsp;<span class="string" id="608385">&#34;proxy&#34;</span><span class="op" id="608392">,</span>&nbsp;<span class="ident" id="608394">want</span><span class="op" id="608398">:</span>&nbsp;<span class="string" id="608400">&#34;&lt;nil&gt;&#34;</span><span class="op" id="608407">}</span><span class="op" id="608408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608411">{</span><span class="ident" id="608412">noenv</span><span class="op" id="608417">:</span>&nbsp;<span class="string" id="608419">&#34;ample.com&#34;</span><span class="op" id="608430">,</span>&nbsp;<span class="ident" id="608432">req</span><span class="op" id="608435">:</span>&nbsp;<span class="string" id="608437">&#34;http://example.com/&#34;</span><span class="op" id="608458">,</span>&nbsp;<span class="ident" id="608460">env</span><span class="op" id="608463">:</span>&nbsp;<span class="string" id="608465">&#34;proxy&#34;</span><span class="op" id="608472">,</span>&nbsp;<span class="ident" id="608474">want</span><span class="op" id="608478">:</span>&nbsp;<span class="string" id="608480">&#34;http://proxy&#34;</span><span class="op" id="608494">}</span><span class="op" id="608495">,</span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608498">{</span><span class="ident" id="608499">noenv</span><span class="op" id="608504">:</span>&nbsp;<span class="string" id="608506">&#34;example.com&#34;</span><span class="op" id="608519">,</span>&nbsp;<span class="ident" id="608521">req</span><span class="op" id="608524">:</span>&nbsp;<span class="string" id="608526">&#34;http://foo.example.com/&#34;</span><span class="op" id="608551">,</span>&nbsp;<span class="ident" id="608553">env</span><span class="op" id="608556">:</span>&nbsp;<span class="string" id="608558">&#34;proxy&#34;</span><span class="op" id="608565">,</span>&nbsp;<span class="ident" id="608567">want</span><span class="op" id="608571">:</span>&nbsp;<span class="string" id="608573">&#34;&lt;nil&gt;&#34;</span><span class="op" id="608580">}</span><span class="op" id="608581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608584">{</span><span class="ident" id="608585">noenv</span><span class="op" id="608590">:</span>&nbsp;<span class="string" id="608592">&#34;.foo.com&#34;</span><span class="op" id="608602">,</span>&nbsp;<span class="ident" id="608604">req</span><span class="op" id="608607">:</span>&nbsp;<span class="string" id="608609">&#34;http://example.com/&#34;</span><span class="op" id="608630">,</span>&nbsp;<span class="ident" id="608632">env</span><span class="op" id="608635">:</span>&nbsp;<span class="string" id="608637">&#34;proxy&#34;</span><span class="op" id="608644">,</span>&nbsp;<span class="ident" id="608646">want</span><span class="op" id="608650">:</span>&nbsp;<span class="string" id="608652">&#34;http://proxy&#34;</span><span class="op" id="608666">}</span><span class="op" id="608667">,</span><br>
<span class="lineno"></span><span class="op" id="608669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="608672">func</span>&nbsp;<span class="ident" id="608677">TestProxyFromEnvironment</span><span class="op" id="608701">(</span><span class="ident" id="608702">t</span>&nbsp;<span class="op" id="608704">*</span><span class="ident" id="608705">testing</span><span class="op" id="608712">.</span><span class="ident" id="608713">T</span><span class="op" id="608714">)</span>&nbsp;<span class="op" id="608716">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608719">ResetProxyEnv</span><span class="op" id="608732">(</span><span class="op" id="608733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="608736">for</span>&nbsp;<span class="ident" id="608740">_</span><span class="op" id="608741">,</span>&nbsp;<span class="ident" id="608743">tt</span>&nbsp;<span class="op" id="608746">:=</span>&nbsp;<span class="keyword" id="608749">range</span>&nbsp;<span class="ident" id="608755">proxyFromEnvTests</span>&nbsp;<span class="op" id="608773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608777">os</span><span class="op" id="608779">.</span><span class="ident" id="608780">Setenv</span><span class="op" id="608786">(</span><span class="string" id="608787">&#34;HTTP_PROXY&#34;</span><span class="op" id="608799">,</span>&nbsp;<span class="ident" id="608801">tt</span><span class="op" id="608803">.</span><span class="ident" id="608804">env</span><span class="op" id="608807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608811">os</span><span class="op" id="608813">.</span><span class="ident" id="608814">Setenv</span><span class="op" id="608820">(</span><span class="string" id="608821">&#34;HTTPS_PROXY&#34;</span><span class="op" id="608834">,</span>&nbsp;<span class="ident" id="608836">tt</span><span class="op" id="608838">.</span><span class="ident" id="608839">httpsenv</span><span class="op" id="608847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608851">os</span><span class="op" id="608853">.</span><span class="ident" id="608854">Setenv</span><span class="op" id="608860">(</span><span class="string" id="608861">&#34;NO_PROXY&#34;</span><span class="op" id="608871">,</span>&nbsp;<span class="ident" id="608873">tt</span><span class="op" id="608875">.</span><span class="ident" id="608876">noenv</span><span class="op" id="608881">)</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608885">ResetCachedEnvironment</span><span class="op" id="608907">(</span><span class="op" id="608908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608912">reqURL</span>&nbsp;<span class="op" id="608919">:=</span>&nbsp;<span class="ident" id="608922">tt</span><span class="op" id="608924">.</span><span class="ident" id="608925">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="608931">if</span>&nbsp;<span class="ident" id="608934">reqURL</span>&nbsp;<span class="op" id="608941">==</span>&nbsp;<span class="string" id="608944">&#34;&#34;</span>&nbsp;<span class="op" id="608947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608952">reqURL</span>&nbsp;<span class="op" id="608959">=</span>&nbsp;<span class="string" id="608961">&#34;http://example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="608984">}</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="608988">req</span><span class="op" id="608991">,</span>&nbsp;<span class="ident" id="608993">_</span>&nbsp;<span class="op" id="608995">:=</span>&nbsp;<span class="ident" id="608998">NewRequest</span><span class="op" id="609008">(</span><span class="string" id="609009">&#34;GET&#34;</span><span class="op" id="609014">,</span>&nbsp;<span class="ident" id="609016">reqURL</span><span class="op" id="609022">,</span>&nbsp;<span class="ident" id="609024">nil</span><span class="op" id="609027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609031">url</span><span class="op" id="609034">,</span>&nbsp;<span class="ident" id="609036">err</span>&nbsp;<span class="op" id="609040">:=</span>&nbsp;<span class="ident" id="609043">ProxyFromEnvironment</span><span class="op" id="609063">(</span><span class="ident" id="609064">req</span><span class="op" id="609067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609071">if</span>&nbsp;<span class="ident" id="609074">g</span><span class="op" id="609075">,</span>&nbsp;<span class="ident" id="609077">e</span>&nbsp;<span class="op" id="609079">:=</span>&nbsp;<span class="ident" id="609082">fmt</span><span class="op" id="609085">.</span><span class="ident" id="609086">Sprintf</span><span class="op" id="609093">(</span><span class="string" id="609094">&#34;%v&#34;</span><span class="op" id="609098">,</span>&nbsp;<span class="ident" id="609100">err</span><span class="op" id="609103">)</span><span class="op" id="609104">,</span>&nbsp;<span class="ident" id="609106">fmt</span><span class="op" id="609109">.</span><span class="ident" id="609110">Sprintf</span><span class="op" id="609117">(</span><span class="string" id="609118">&#34;%v&#34;</span><span class="op" id="609122">,</span>&nbsp;<span class="ident" id="609124">tt</span><span class="op" id="609126">.</span><span class="ident" id="609127">wanterr</span><span class="op" id="609134">)</span><span class="op" id="609135">;</span>&nbsp;<span class="ident" id="609137">g</span>&nbsp;<span class="op" id="609139">!=</span>&nbsp;<span class="ident" id="609142">e</span>&nbsp;<span class="op" id="609144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609149">t</span><span class="op" id="609150">.</span><span class="ident" id="609151">Errorf</span><span class="op" id="609157">(</span><span class="string" id="609158">&#34;%v:&nbsp;got&nbsp;error&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="609187">,</span>&nbsp;<span class="ident" id="609189">tt</span><span class="op" id="609191">,</span>&nbsp;<span class="ident" id="609193">g</span><span class="op" id="609194">,</span>&nbsp;<span class="ident" id="609196">e</span><span class="op" id="609197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609202">continue</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609217">if</span>&nbsp;<span class="ident" id="609220">got</span>&nbsp;<span class="op" id="609224">:=</span>&nbsp;<span class="ident" id="609227">fmt</span><span class="op" id="609230">.</span><span class="ident" id="609231">Sprintf</span><span class="op" id="609238">(</span><span class="string" id="609239">&#34;%s&#34;</span><span class="op" id="609243">,</span>&nbsp;<span class="ident" id="609245">url</span><span class="op" id="609248">)</span><span class="op" id="609249">;</span>&nbsp;<span class="ident" id="609251">got</span>&nbsp;<span class="op" id="609255">!=</span>&nbsp;<span class="ident" id="609258">tt</span><span class="op" id="609260">.</span><span class="ident" id="609261">want</span>&nbsp;<span class="op" id="609266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609271">t</span><span class="op" id="609272">.</span><span class="ident" id="609273">Errorf</span><span class="op" id="609279">(</span><span class="string" id="609280">&#34;%v:&nbsp;got&nbsp;URL&nbsp;=&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="609307">,</span>&nbsp;<span class="ident" id="609309">tt</span><span class="op" id="609311">,</span>&nbsp;<span class="ident" id="609313">url</span><span class="op" id="609316">,</span>&nbsp;<span class="ident" id="609318">tt</span><span class="op" id="609320">.</span><span class="ident" id="609321">want</span><span class="op" id="609325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609332">}</span><br>
<span class="lineno">1785</span><span class="op" id="609334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="609337">func</span>&nbsp;<span class="ident" id="609342">TestIdleConnChannelLeak</span><span class="op" id="609365">(</span><span class="ident" id="609366">t</span>&nbsp;<span class="op" id="609368">*</span><span class="ident" id="609369">testing</span><span class="op" id="609376">.</span><span class="ident" id="609377">T</span><span class="op" id="609378">)</span>&nbsp;<span class="op" id="609380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609383">var</span>&nbsp;<span class="ident" id="609387">mu</span>&nbsp;<span class="ident" id="609390">sync</span><span class="op" id="609394">.</span><span class="ident" id="609395">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609402">var</span>&nbsp;<span class="ident" id="609406">n</span>&nbsp;<span class="builtintype" id="609408">int</span><br>
<span class="lineno">1790</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609414">ts</span>&nbsp;<span class="op" id="609417">:=</span>&nbsp;<span class="ident" id="609420">httptest</span><span class="op" id="609428">.</span><span class="ident" id="609429">NewServer</span><span class="op" id="609438">(</span><span class="ident" id="609439">HandlerFunc</span><span class="op" id="609450">(</span><span class="keyword" id="609451">func</span><span class="op" id="609455">(</span><span class="ident" id="609456">w</span>&nbsp;<span class="ident" id="609458">ResponseWriter</span><span class="op" id="609472">,</span>&nbsp;<span class="ident" id="609474">r</span>&nbsp;<span class="op" id="609476">*</span><span class="ident" id="609477">Request</span><span class="op" id="609484">)</span>&nbsp;<span class="op" id="609486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609490">mu</span><span class="op" id="609492">.</span><span class="ident" id="609493">Lock</span><span class="op" id="609497">(</span><span class="op" id="609498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609502">n</span><span class="op" id="609503">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609508">mu</span><span class="op" id="609510">.</span><span class="ident" id="609511">Unlock</span><span class="op" id="609517">(</span><span class="op" id="609518">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609521">}</span><span class="op" id="609522">)</span><span class="op" id="609523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609526">defer</span>&nbsp;<span class="ident" id="609532">ts</span><span class="op" id="609534">.</span><span class="ident" id="609535">Close</span><span class="op" id="609540">(</span><span class="op" id="609541">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609545">tr</span>&nbsp;<span class="op" id="609548">:=</span>&nbsp;<span class="op" id="609551">&amp;</span><span class="ident" id="609552">Transport</span><span class="op" id="609561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609565">Dial</span><span class="op" id="609569">:</span>&nbsp;<span class="keyword" id="609571">func</span><span class="op" id="609575">(</span><span class="ident" id="609576">netw</span><span class="op" id="609580">,</span>&nbsp;<span class="ident" id="609582">addr</span>&nbsp;<span class="builtintype" id="609587">string</span><span class="op" id="609593">)</span>&nbsp;<span class="op" id="609595">(</span><span class="ident" id="609596">net</span><span class="op" id="609599">.</span><span class="ident" id="609600">Conn</span><span class="op" id="609604">,</span>&nbsp;<span class="builtintype" id="609606">error</span><span class="op" id="609611">)</span>&nbsp;<span class="op" id="609613">{</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609618">return</span>&nbsp;<span class="ident" id="609625">net</span><span class="op" id="609628">.</span><span class="ident" id="609629">Dial</span><span class="op" id="609633">(</span><span class="ident" id="609634">netw</span><span class="op" id="609638">,</span>&nbsp;<span class="ident" id="609640">ts</span><span class="op" id="609642">.</span><span class="ident" id="609643">Listener</span><span class="op" id="609651">.</span><span class="ident" id="609652">Addr</span><span class="op" id="609656">(</span><span class="op" id="609657">)</span><span class="op" id="609658">.</span><span class="ident" id="609659">String</span><span class="op" id="609665">(</span><span class="op" id="609666">)</span><span class="op" id="609667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609671">}</span><span class="op" id="609672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609678">defer</span>&nbsp;<span class="ident" id="609684">tr</span><span class="op" id="609686">.</span><span class="ident" id="609687">CloseIdleConnections</span><span class="op" id="609707">(</span><span class="op" id="609708">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609712">c</span>&nbsp;<span class="op" id="609714">:=</span>&nbsp;<span class="op" id="609717">&amp;</span><span class="ident" id="609718">Client</span><span class="op" id="609724">{</span><span class="ident" id="609725">Transport</span><span class="op" id="609734">:</span>&nbsp;<span class="ident" id="609736">tr</span><span class="op" id="609738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="609742">//&nbsp;First,&nbsp;without&nbsp;keep-alives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609774">for</span>&nbsp;<span class="ident" id="609778">_</span><span class="op" id="609779">,</span>&nbsp;<span class="ident" id="609781">disableKeep</span>&nbsp;<span class="op" id="609793">:=</span>&nbsp;<span class="keyword" id="609796">range</span>&nbsp;<span class="op" id="609802">[</span><span class="op" id="609803">]</span><span class="builtintype" id="609804">bool</span><span class="op" id="609808">{</span><span class="builtintype" id="609809">true</span><span class="op" id="609813">,</span>&nbsp;<span class="builtintype" id="609815">false</span><span class="op" id="609820">}</span>&nbsp;<span class="op" id="609822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609826">tr</span><span class="op" id="609828">.</span><span class="ident" id="609829">DisableKeepAlives</span>&nbsp;<span class="op" id="609847">=</span>&nbsp;<span class="ident" id="609849">disableKeep</span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609863">for</span>&nbsp;<span class="ident" id="609867">i</span>&nbsp;<span class="op" id="609869">:=</span>&nbsp;<span class="num" id="609872">0</span><span class="op" id="609873">;</span>&nbsp;<span class="ident" id="609875">i</span>&nbsp;<span class="op" id="609877">&lt;</span>&nbsp;<span class="num" id="609879">5</span><span class="op" id="609880">;</span>&nbsp;<span class="ident" id="609882">i</span><span class="op" id="609883">++</span>&nbsp;<span class="op" id="609886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609891">_</span><span class="op" id="609892">,</span>&nbsp;<span class="ident" id="609894">err</span>&nbsp;<span class="op" id="609898">:=</span>&nbsp;<span class="ident" id="609901">c</span><span class="op" id="609902">.</span><span class="ident" id="609903">Get</span><span class="op" id="609906">(</span><span class="ident" id="609907">fmt</span><span class="op" id="609910">.</span><span class="ident" id="609911">Sprintf</span><span class="op" id="609918">(</span><span class="string" id="609919">&#34;http://foo-host-%d.tld/&#34;</span><span class="op" id="609944">,</span>&nbsp;<span class="ident" id="609946">i</span><span class="op" id="609947">)</span><span class="op" id="609948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609953">if</span>&nbsp;<span class="ident" id="609956">err</span>&nbsp;<span class="op" id="609960">!=</span>&nbsp;<span class="ident" id="609963">nil</span>&nbsp;<span class="op" id="609967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="609973">t</span><span class="op" id="609974">.</span><span class="ident" id="609975">Fatal</span><span class="op" id="609980">(</span><span class="ident" id="609981">err</span><span class="op" id="609984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609989">}</span><br>
<span class="lineno">1815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="609993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="609997">if</span>&nbsp;<span class="ident" id="610000">got</span>&nbsp;<span class="op" id="610004">:=</span>&nbsp;<span class="ident" id="610007">tr</span><span class="op" id="610009">.</span><span class="ident" id="610010">IdleConnChMapSizeForTesting</span><span class="op" id="610037">(</span><span class="op" id="610038">)</span><span class="op" id="610039">;</span>&nbsp;<span class="ident" id="610041">got</span>&nbsp;<span class="op" id="610045">!=</span>&nbsp;<span class="num" id="610048">0</span>&nbsp;<span class="op" id="610050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610055">t</span><span class="op" id="610056">.</span><span class="ident" id="610057">Fatalf</span><span class="op" id="610063">(</span><span class="string" id="610064">&#34;ForDisableKeepAlives&nbsp;=&nbsp;%v,&nbsp;map&nbsp;size&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="610114">,</span>&nbsp;<span class="ident" id="610116">disableKeep</span><span class="op" id="610127">,</span>&nbsp;<span class="ident" id="610129">got</span><span class="op" id="610132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="610136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="610139">}</span><br>
<span class="lineno">1820</span><span class="op" id="610141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="610144">//&nbsp;Verify&nbsp;the&nbsp;status&nbsp;quo:&nbsp;that&nbsp;the&nbsp;Client.Post&nbsp;function&nbsp;coerces&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="610212">//&nbsp;body&nbsp;into&nbsp;a&nbsp;ReadCloser&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;Closer,&nbsp;and&nbsp;that&nbsp;the&nbsp;Transport</span><br>
<span class="lineno"></span><span class="comment" id="610279">//&nbsp;then&nbsp;closes&nbsp;it.</span><br>
<span class="lineno">1825</span><span class="keyword" id="610298">func</span>&nbsp;<span class="ident" id="610303">TestTransportClosesRequestBody</span><span class="op" id="610333">(</span><span class="ident" id="610334">t</span>&nbsp;<span class="op" id="610336">*</span><span class="ident" id="610337">testing</span><span class="op" id="610344">.</span><span class="ident" id="610345">T</span><span class="op" id="610346">)</span>&nbsp;<span class="op" id="610348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610351">defer</span>&nbsp;<span class="ident" id="610357">afterTest</span><span class="op" id="610366">(</span><span class="ident" id="610367">t</span><span class="op" id="610368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610371">ts</span>&nbsp;<span class="op" id="610374">:=</span>&nbsp;<span class="ident" id="610377">httptest</span><span class="op" id="610385">.</span><span class="ident" id="610386">NewServer</span><span class="op" id="610395">(</span><span class="ident" id="610396">http</span><span class="op" id="610400">.</span><span class="ident" id="610401">HandlerFunc</span><span class="op" id="610412">(</span><span class="keyword" id="610413">func</span><span class="op" id="610417">(</span><span class="ident" id="610418">w</span>&nbsp;<span class="ident" id="610420">ResponseWriter</span><span class="op" id="610434">,</span>&nbsp;<span class="ident" id="610436">r</span>&nbsp;<span class="op" id="610438">*</span><span class="ident" id="610439">Request</span><span class="op" id="610446">)</span>&nbsp;<span class="op" id="610448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610452">io</span><span class="op" id="610454">.</span><span class="ident" id="610455">Copy</span><span class="op" id="610459">(</span><span class="ident" id="610460">ioutil</span><span class="op" id="610466">.</span><span class="ident" id="610467">Discard</span><span class="op" id="610474">,</span>&nbsp;<span class="ident" id="610476">r</span><span class="op" id="610477">.</span><span class="ident" id="610478">Body</span><span class="op" id="610482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="610485">}</span><span class="op" id="610486">)</span><span class="op" id="610487">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610490">defer</span>&nbsp;<span class="ident" id="610496">ts</span><span class="op" id="610498">.</span><span class="ident" id="610499">Close</span><span class="op" id="610504">(</span><span class="op" id="610505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610509">tr</span>&nbsp;<span class="op" id="610512">:=</span>&nbsp;<span class="op" id="610515">&amp;</span><span class="ident" id="610516">Transport</span><span class="op" id="610525">{</span><span class="op" id="610526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610529">defer</span>&nbsp;<span class="ident" id="610535">tr</span><span class="op" id="610537">.</span><span class="ident" id="610538">CloseIdleConnections</span><span class="op" id="610558">(</span><span class="op" id="610559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610562">cl</span>&nbsp;<span class="op" id="610565">:=</span>&nbsp;<span class="op" id="610568">&amp;</span><span class="ident" id="610569">Client</span><span class="op" id="610575">{</span><span class="ident" id="610576">Transport</span><span class="op" id="610585">:</span>&nbsp;<span class="ident" id="610587">tr</span><span class="op" id="610589">}</span><br>
<span class="lineno">1835</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610593">closes</span>&nbsp;<span class="op" id="610600">:=</span>&nbsp;<span class="num" id="610603">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610607">res</span><span class="op" id="610610">,</span>&nbsp;<span class="ident" id="610612">err</span>&nbsp;<span class="op" id="610616">:=</span>&nbsp;<span class="ident" id="610619">cl</span><span class="op" id="610621">.</span><span class="ident" id="610622">Post</span><span class="op" id="610626">(</span><span class="ident" id="610627">ts</span><span class="op" id="610629">.</span><span class="ident" id="610630">URL</span><span class="op" id="610633">,</span>&nbsp;<span class="string" id="610635">&#34;text/plain&#34;</span><span class="op" id="610647">,</span>&nbsp;<span class="ident" id="610649">countCloseReader</span><span class="op" id="610665">{</span><span class="op" id="610666">&amp;</span><span class="ident" id="610667">closes</span><span class="op" id="610673">,</span>&nbsp;<span class="ident" id="610675">strings</span><span class="op" id="610682">.</span><span class="ident" id="610683">NewReader</span><span class="op" id="610692">(</span><span class="string" id="610693">&#34;hello&#34;</span><span class="op" id="610700">)</span><span class="op" id="610701">}</span><span class="op" id="610702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610705">if</span>&nbsp;<span class="ident" id="610708">err</span>&nbsp;<span class="op" id="610712">!=</span>&nbsp;<span class="ident" id="610715">nil</span>&nbsp;<span class="op" id="610719">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610723">t</span><span class="op" id="610724">.</span><span class="ident" id="610725">Fatal</span><span class="op" id="610730">(</span><span class="ident" id="610731">err</span><span class="op" id="610734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="610737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610740">res</span><span class="op" id="610743">.</span><span class="ident" id="610744">Body</span><span class="op" id="610748">.</span><span class="ident" id="610749">Close</span><span class="op" id="610754">(</span><span class="op" id="610755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610758">if</span>&nbsp;<span class="ident" id="610761">closes</span>&nbsp;<span class="op" id="610768">!=</span>&nbsp;<span class="num" id="610771">1</span>&nbsp;<span class="op" id="610773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610777">t</span><span class="op" id="610778">.</span><span class="ident" id="610779">Errorf</span><span class="op" id="610785">(</span><span class="string" id="610786">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="610807">,</span>&nbsp;<span class="ident" id="610809">closes</span><span class="op" id="610815">)</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="610818">}</span><br>
<span class="lineno"></span><span class="op" id="610820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="610823">func</span>&nbsp;<span class="ident" id="610828">TestTransportTLSHandshakeTimeout</span><span class="op" id="610860">(</span><span class="ident" id="610861">t</span>&nbsp;<span class="op" id="610863">*</span><span class="ident" id="610864">testing</span><span class="op" id="610871">.</span><span class="ident" id="610872">T</span><span class="op" id="610873">)</span>&nbsp;<span class="op" id="610875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610878">defer</span>&nbsp;<span class="ident" id="610884">afterTest</span><span class="op" id="610893">(</span><span class="ident" id="610894">t</span><span class="op" id="610895">)</span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610898">if</span>&nbsp;<span class="ident" id="610901">testing</span><span class="op" id="610908">.</span><span class="ident" id="610909">Short</span><span class="op" id="610914">(</span><span class="op" id="610915">)</span>&nbsp;<span class="op" id="610917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610921">t</span><span class="op" id="610922">.</span><span class="ident" id="610923">Skip</span><span class="op" id="610927">(</span><span class="string" id="610928">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="610952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="610955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="610958">ln</span>&nbsp;<span class="op" id="610961">:=</span>&nbsp;<span class="ident" id="610964">newLocalListener</span><span class="op" id="610980">(</span><span class="ident" id="610981">t</span><span class="op" id="610982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="610985">defer</span>&nbsp;<span class="ident" id="610991">ln</span><span class="op" id="610993">.</span><span class="ident" id="610994">Close</span><span class="op" id="610999">(</span><span class="op" id="611000">)</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611003">testdonec</span>&nbsp;<span class="op" id="611013">:=</span>&nbsp;<span class="builtinfunc" id="611016">make</span><span class="op" id="611020">(</span><span class="keyword" id="611021">chan</span>&nbsp;<span class="keyword" id="611026">struct</span><span class="op" id="611032">{</span><span class="op" id="611033">}</span><span class="op" id="611034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611037">defer</span>&nbsp;<span class="builtinfunc" id="611043">close</span><span class="op" id="611048">(</span><span class="ident" id="611049">testdonec</span><span class="op" id="611058">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611062">go</span>&nbsp;<span class="keyword" id="611065">func</span><span class="op" id="611069">(</span><span class="op" id="611070">)</span>&nbsp;<span class="op" id="611072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611076">c</span><span class="op" id="611077">,</span>&nbsp;<span class="ident" id="611079">err</span>&nbsp;<span class="op" id="611083">:=</span>&nbsp;<span class="ident" id="611086">ln</span><span class="op" id="611088">.</span><span class="ident" id="611089">Accept</span><span class="op" id="611095">(</span><span class="op" id="611096">)</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611100">if</span>&nbsp;<span class="ident" id="611103">err</span>&nbsp;<span class="op" id="611107">!=</span>&nbsp;<span class="ident" id="611110">nil</span>&nbsp;<span class="op" id="611114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611119">t</span><span class="op" id="611120">.</span><span class="ident" id="611121">Error</span><span class="op" id="611126">(</span><span class="ident" id="611127">err</span><span class="op" id="611130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611135">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611148">&lt;-</span><span class="ident" id="611150">testdonec</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611162">c</span><span class="op" id="611163">.</span><span class="ident" id="611164">Close</span><span class="op" id="611169">(</span><span class="op" id="611170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611173">}</span><span class="op" id="611174">(</span><span class="op" id="611175">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611179">getdonec</span>&nbsp;<span class="op" id="611188">:=</span>&nbsp;<span class="builtinfunc" id="611191">make</span><span class="op" id="611195">(</span><span class="keyword" id="611196">chan</span>&nbsp;<span class="keyword" id="611201">struct</span><span class="op" id="611207">{</span><span class="op" id="611208">}</span><span class="op" id="611209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611212">go</span>&nbsp;<span class="keyword" id="611215">func</span><span class="op" id="611219">(</span><span class="op" id="611220">)</span>&nbsp;<span class="op" id="611222">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611226">defer</span>&nbsp;<span class="builtinfunc" id="611232">close</span><span class="op" id="611237">(</span><span class="ident" id="611238">getdonec</span><span class="op" id="611246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611250">tr</span>&nbsp;<span class="op" id="611253">:=</span>&nbsp;<span class="op" id="611256">&amp;</span><span class="ident" id="611257">Transport</span><span class="op" id="611266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611271">Dial</span><span class="op" id="611275">:</span>&nbsp;<span class="keyword" id="611277">func</span><span class="op" id="611281">(</span><span class="ident" id="611282">_</span><span class="op" id="611283">,</span>&nbsp;<span class="ident" id="611285">_</span>&nbsp;<span class="builtintype" id="611287">string</span><span class="op" id="611293">)</span>&nbsp;<span class="op" id="611295">(</span><span class="ident" id="611296">net</span><span class="op" id="611299">.</span><span class="ident" id="611300">Conn</span><span class="op" id="611304">,</span>&nbsp;<span class="builtintype" id="611306">error</span><span class="op" id="611311">)</span>&nbsp;<span class="op" id="611313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611319">return</span>&nbsp;<span class="ident" id="611326">net</span><span class="op" id="611329">.</span><span class="ident" id="611330">Dial</span><span class="op" id="611334">(</span><span class="string" id="611335">&#34;tcp&#34;</span><span class="op" id="611340">,</span>&nbsp;<span class="ident" id="611342">ln</span><span class="op" id="611344">.</span><span class="ident" id="611345">Addr</span><span class="op" id="611349">(</span><span class="op" id="611350">)</span><span class="op" id="611351">.</span><span class="ident" id="611352">String</span><span class="op" id="611358">(</span><span class="op" id="611359">)</span><span class="op" id="611360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611365">}</span><span class="op" id="611366">,</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611371">TLSHandshakeTimeout</span><span class="op" id="611390">:</span>&nbsp;<span class="num" id="611392">250</span>&nbsp;<span class="op" id="611396">*</span>&nbsp;<span class="ident" id="611398">time</span><span class="op" id="611402">.</span><span class="ident" id="611403">Millisecond</span><span class="op" id="611414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611422">cl</span>&nbsp;<span class="op" id="611425">:=</span>&nbsp;<span class="op" id="611428">&amp;</span><span class="ident" id="611429">Client</span><span class="op" id="611435">{</span><span class="ident" id="611436">Transport</span><span class="op" id="611445">:</span>&nbsp;<span class="ident" id="611447">tr</span><span class="op" id="611449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611453">_</span><span class="op" id="611454">,</span>&nbsp;<span class="ident" id="611456">err</span>&nbsp;<span class="op" id="611460">:=</span>&nbsp;<span class="ident" id="611463">cl</span><span class="op" id="611465">.</span><span class="ident" id="611466">Get</span><span class="op" id="611469">(</span><span class="string" id="611470">&#34;https://dummy.tld/&#34;</span><span class="op" id="611490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611494">if</span>&nbsp;<span class="ident" id="611497">err</span>&nbsp;<span class="op" id="611501">==</span>&nbsp;<span class="ident" id="611504">nil</span>&nbsp;<span class="op" id="611508">{</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611513">t</span><span class="op" id="611514">.</span><span class="ident" id="611515">Error</span><span class="op" id="611520">(</span><span class="string" id="611521">&#34;expected&nbsp;error&#34;</span><span class="op" id="611537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611542">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611555">ue</span><span class="op" id="611557">,</span>&nbsp;<span class="ident" id="611559">ok</span>&nbsp;<span class="op" id="611562">:=</span>&nbsp;<span class="ident" id="611565">err</span><span class="op" id="611568">.</span><span class="op" id="611569">(</span><span class="op" id="611570">*</span><span class="ident" id="611571">url</span><span class="op" id="611574">.</span><span class="ident" id="611575">Error</span><span class="op" id="611580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611584">if</span>&nbsp;<span class="op" id="611587">!</span><span class="ident" id="611588">ok</span>&nbsp;<span class="op" id="611591">{</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611596">t</span><span class="op" id="611597">.</span><span class="ident" id="611598">Errorf</span><span class="op" id="611604">(</span><span class="string" id="611605">&#34;expected&nbsp;url.Error;&nbsp;got&nbsp;%#v&#34;</span><span class="op" id="611634">,</span>&nbsp;<span class="ident" id="611636">err</span><span class="op" id="611639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611644">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611657">ne</span><span class="op" id="611659">,</span>&nbsp;<span class="ident" id="611661">ok</span>&nbsp;<span class="op" id="611664">:=</span>&nbsp;<span class="ident" id="611667">ue</span><span class="op" id="611669">.</span><span class="ident" id="611670">Err</span><span class="op" id="611673">.</span><span class="op" id="611674">(</span><span class="ident" id="611675">net</span><span class="op" id="611678">.</span><span class="ident" id="611679">Error</span><span class="op" id="611684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611688">if</span>&nbsp;<span class="op" id="611691">!</span><span class="ident" id="611692">ok</span>&nbsp;<span class="op" id="611695">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611700">t</span><span class="op" id="611701">.</span><span class="ident" id="611702">Errorf</span><span class="op" id="611708">(</span><span class="string" id="611709">&#34;expected&nbsp;net.Error;&nbsp;got&nbsp;%#v&#34;</span><span class="op" id="611738">,</span>&nbsp;<span class="ident" id="611740">err</span><span class="op" id="611743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611748">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611761">if</span>&nbsp;<span class="op" id="611764">!</span><span class="ident" id="611765">ne</span><span class="op" id="611767">.</span><span class="ident" id="611768">Timeout</span><span class="op" id="611775">(</span><span class="op" id="611776">)</span>&nbsp;<span class="op" id="611778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611783">t</span><span class="op" id="611784">.</span><span class="ident" id="611785">Errorf</span><span class="op" id="611791">(</span><span class="string" id="611792">&#34;expected&nbsp;timeout&nbsp;error;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="611824">,</span>&nbsp;<span class="ident" id="611826">err</span><span class="op" id="611829">)</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611837">if</span>&nbsp;<span class="op" id="611840">!</span><span class="ident" id="611841">strings</span><span class="op" id="611848">.</span><span class="ident" id="611849">Contains</span><span class="op" id="611857">(</span><span class="ident" id="611858">err</span><span class="op" id="611861">.</span><span class="ident" id="611862">Error</span><span class="op" id="611867">(</span><span class="op" id="611868">)</span><span class="op" id="611869">,</span>&nbsp;<span class="string" id="611871">&#34;handshake&nbsp;timeout&#34;</span><span class="op" id="611890">)</span>&nbsp;<span class="op" id="611892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="611897">t</span><span class="op" id="611898">.</span><span class="ident" id="611899">Errorf</span><span class="op" id="611905">(</span><span class="string" id="611906">&#34;expected&nbsp;&#39;handshake&nbsp;timeout&#39;&nbsp;in&nbsp;error;&nbsp;got&nbsp;%v&#34;</span><span class="op" id="611953">,</span>&nbsp;<span class="ident" id="611955">err</span><span class="op" id="611958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="611965">}</span><span class="op" id="611966">(</span><span class="op" id="611967">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611970">select</span>&nbsp;<span class="op" id="611977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611980">case</span>&nbsp;<span class="op" id="611985">&lt;-</span><span class="ident" id="611987">getdonec</span><span class="op" id="611995">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="611998">case</span>&nbsp;<span class="op" id="612003">&lt;-</span><span class="ident" id="612005">time</span><span class="op" id="612009">.</span><span class="ident" id="612010">After</span><span class="op" id="612015">(</span><span class="num" id="612016">5</span>&nbsp;<span class="op" id="612018">*</span>&nbsp;<span class="ident" id="612020">time</span><span class="op" id="612024">.</span><span class="ident" id="612025">Second</span><span class="op" id="612031">)</span><span class="op" id="612032">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612036">t</span><span class="op" id="612037">.</span><span class="ident" id="612038">Error</span><span class="op" id="612043">(</span><span class="string" id="612044">&#34;test&nbsp;timeout;&nbsp;TLS&nbsp;handshake&nbsp;hung?&#34;</span><span class="op" id="612079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="612082">}</span><br>
<span class="lineno">1905</span><span class="op" id="612084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="612087">//&nbsp;Trying&nbsp;to&nbsp;repro&nbsp;golang.org/issue/3514</span><br>
<span class="lineno"></span><span class="keyword" id="612128">func</span>&nbsp;<span class="ident" id="612133">TestTLSServerClosesConnection</span><span class="op" id="612162">(</span><span class="ident" id="612163">t</span>&nbsp;<span class="op" id="612165">*</span><span class="ident" id="612166">testing</span><span class="op" id="612173">.</span><span class="ident" id="612174">T</span><span class="op" id="612175">)</span>&nbsp;<span class="op" id="612177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612180">defer</span>&nbsp;<span class="ident" id="612186">afterTest</span><span class="op" id="612195">(</span><span class="ident" id="612196">t</span><span class="op" id="612197">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612200">if</span>&nbsp;<span class="ident" id="612203">runtime</span><span class="op" id="612210">.</span><span class="ident" id="612211">GOOS</span>&nbsp;<span class="op" id="612216">==</span>&nbsp;<span class="string" id="612219">&#34;windows&#34;</span>&nbsp;<span class="op" id="612229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612233">t</span><span class="op" id="612234">.</span><span class="ident" id="612235">Skip</span><span class="op" id="612239">(</span><span class="string" id="612240">&#34;skipping&nbsp;flaky&nbsp;test&nbsp;on&nbsp;Windows;&nbsp;golang.org/issue/7634&#34;</span><span class="op" id="612295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="612298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612301">closedc</span>&nbsp;<span class="op" id="612309">:=</span>&nbsp;<span class="builtinfunc" id="612312">make</span><span class="op" id="612316">(</span><span class="keyword" id="612317">chan</span>&nbsp;<span class="builtintype" id="612322">bool</span><span class="op" id="612326">,</span>&nbsp;<span class="num" id="612328">1</span><span class="op" id="612329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612332">ts</span>&nbsp;<span class="op" id="612335">:=</span>&nbsp;<span class="ident" id="612338">httptest</span><span class="op" id="612346">.</span><span class="ident" id="612347">NewTLSServer</span><span class="op" id="612359">(</span><span class="ident" id="612360">HandlerFunc</span><span class="op" id="612371">(</span><span class="keyword" id="612372">func</span><span class="op" id="612376">(</span><span class="ident" id="612377">w</span>&nbsp;<span class="ident" id="612379">ResponseWriter</span><span class="op" id="612393">,</span>&nbsp;<span class="ident" id="612395">r</span>&nbsp;<span class="op" id="612397">*</span><span class="ident" id="612398">Request</span><span class="op" id="612405">)</span>&nbsp;<span class="op" id="612407">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612411">if</span>&nbsp;<span class="ident" id="612414">strings</span><span class="op" id="612421">.</span><span class="ident" id="612422">Contains</span><span class="op" id="612430">(</span><span class="ident" id="612431">r</span><span class="op" id="612432">.</span><span class="ident" id="612433">URL</span><span class="op" id="612436">.</span><span class="ident" id="612437">Path</span><span class="op" id="612441">,</span>&nbsp;<span class="string" id="612443">&#34;/keep-alive-then-die&#34;</span><span class="op" id="612465">)</span>&nbsp;<span class="op" id="612467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612472">conn</span><span class="op" id="612476">,</span>&nbsp;<span class="ident" id="612478">_</span><span class="op" id="612479">,</span>&nbsp;<span class="ident" id="612481">_</span>&nbsp;<span class="op" id="612483">:=</span>&nbsp;<span class="ident" id="612486">w</span><span class="op" id="612487">.</span><span class="op" id="612488">(</span><span class="ident" id="612489">Hijacker</span><span class="op" id="612497">)</span><span class="op" id="612498">.</span><span class="ident" id="612499">Hijack</span><span class="op" id="612505">(</span><span class="op" id="612506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612511">conn</span><span class="op" id="612515">.</span><span class="ident" id="612516">Write</span><span class="op" id="612521">(</span><span class="op" id="612522">[</span><span class="op" id="612523">]</span><span class="builtintype" id="612524">byte</span><span class="op" id="612528">(</span><span class="string" id="612529">&#34;HTTP/1.1&nbsp;200&nbsp;OK\r\nContent-Length:&nbsp;3\r\n\r\nfoo&#34;</span><span class="op" id="612578">)</span><span class="op" id="612579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612584">conn</span><span class="op" id="612588">.</span><span class="ident" id="612589">Close</span><span class="op" id="612594">(</span><span class="op" id="612595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612600">closedc</span>&nbsp;<span class="op" id="612608">&lt;-</span>&nbsp;<span class="builtintype" id="612611">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612619">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="612628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612632">fmt</span><span class="op" id="612635">.</span><span class="ident" id="612636">Fprintf</span><span class="op" id="612643">(</span><span class="ident" id="612644">w</span><span class="op" id="612645">,</span>&nbsp;<span class="string" id="612647">&#34;hello&#34;</span><span class="op" id="612654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="612657">}</span><span class="op" id="612658">)</span><span class="op" id="612659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612662">defer</span>&nbsp;<span class="ident" id="612668">ts</span><span class="op" id="612670">.</span><span class="ident" id="612671">Close</span><span class="op" id="612676">(</span><span class="op" id="612677">)</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612680">tr</span>&nbsp;<span class="op" id="612683">:=</span>&nbsp;<span class="op" id="612686">&amp;</span><span class="ident" id="612687">Transport</span><span class="op" id="612696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612700">TLSClientConfig</span><span class="op" id="612715">:</span>&nbsp;<span class="op" id="612717">&amp;</span><span class="ident" id="612718">tls</span><span class="op" id="612721">.</span><span class="ident" id="612722">Config</span><span class="op" id="612728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612733">InsecureSkipVerify</span><span class="op" id="612751">:</span>&nbsp;<span class="builtintype" id="612753">true</span><span class="op" id="612757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="612761">}</span><span class="op" id="612762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="612765">}</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612768">defer</span>&nbsp;<span class="ident" id="612774">tr</span><span class="op" id="612776">.</span><span class="ident" id="612777">CloseIdleConnections</span><span class="op" id="612797">(</span><span class="op" id="612798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612801">client</span>&nbsp;<span class="op" id="612808">:=</span>&nbsp;<span class="op" id="612811">&amp;</span><span class="ident" id="612812">Client</span><span class="op" id="612818">{</span><span class="ident" id="612819">Transport</span><span class="op" id="612828">:</span>&nbsp;<span class="ident" id="612830">tr</span><span class="op" id="612832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612836">var</span>&nbsp;<span class="ident" id="612840">nSuccess</span>&nbsp;<span class="op" id="612849">=</span>&nbsp;<span class="num" id="612851">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612854">var</span>&nbsp;<span class="ident" id="612858">errs</span>&nbsp;<span class="op" id="612863">[</span><span class="op" id="612864">]</span><span class="builtintype" id="612865">error</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612872">const</span>&nbsp;<span class="ident" id="612878">trials</span>&nbsp;<span class="op" id="612885">=</span>&nbsp;<span class="num" id="612887">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="612891">for</span>&nbsp;<span class="ident" id="612895">i</span>&nbsp;<span class="op" id="612897">:=</span>&nbsp;<span class="num" id="612900">0</span><span class="op" id="612901">;</span>&nbsp;<span class="ident" id="612903">i</span>&nbsp;<span class="op" id="612905">&lt;</span>&nbsp;<span class="ident" id="612907">trials</span><span class="op" id="612913">;</span>&nbsp;<span class="ident" id="612915">i</span><span class="op" id="612916">++</span>&nbsp;<span class="op" id="612919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612923">tr</span><span class="op" id="612925">.</span><span class="ident" id="612926">CloseIdleConnections</span><span class="op" id="612946">(</span><span class="op" id="612947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="612951">res</span><span class="op" id="612954">,</span>&nbsp;<span class="ident" id="612956">err</span>&nbsp;<span class="op" id="612960">:=</span>&nbsp;<span class="ident" id="612963">client</span><span class="op" id="612969">.</span><span class="ident" id="612970">Get</span><span class="op" id="612973">(</span><span class="ident" id="612974">ts</span><span class="op" id="612976">.</span><span class="ident" id="612977">URL</span>&nbsp;<span class="op" id="612981">+</span>&nbsp;<span class="string" id="612983">&#34;/keep-alive-then-die&#34;</span><span class="op" id="613005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613009">if</span>&nbsp;<span class="ident" id="613012">err</span>&nbsp;<span class="op" id="613016">!=</span>&nbsp;<span class="ident" id="613019">nil</span>&nbsp;<span class="op" id="613023">{</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613028">t</span><span class="op" id="613029">.</span><span class="ident" id="613030">Fatal</span><span class="op" id="613035">(</span><span class="ident" id="613036">err</span><span class="op" id="613039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613047">&lt;-</span><span class="ident" id="613049">closedc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613059">slurp</span><span class="op" id="613064">,</span>&nbsp;<span class="ident" id="613066">err</span>&nbsp;<span class="op" id="613070">:=</span>&nbsp;<span class="ident" id="613073">ioutil</span><span class="op" id="613079">.</span><span class="ident" id="613080">ReadAll</span><span class="op" id="613087">(</span><span class="ident" id="613088">res</span><span class="op" id="613091">.</span><span class="ident" id="613092">Body</span><span class="op" id="613096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613100">if</span>&nbsp;<span class="ident" id="613103">err</span>&nbsp;<span class="op" id="613107">!=</span>&nbsp;<span class="ident" id="613110">nil</span>&nbsp;<span class="op" id="613114">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613119">t</span><span class="op" id="613120">.</span><span class="ident" id="613121">Fatal</span><span class="op" id="613126">(</span><span class="ident" id="613127">err</span><span class="op" id="613130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613138">if</span>&nbsp;<span class="builtintype" id="613141">string</span><span class="op" id="613147">(</span><span class="ident" id="613148">slurp</span><span class="op" id="613153">)</span>&nbsp;<span class="op" id="613155">!=</span>&nbsp;<span class="string" id="613158">&#34;foo&#34;</span>&nbsp;<span class="op" id="613164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613169">t</span><span class="op" id="613170">.</span><span class="ident" id="613171">Errorf</span><span class="op" id="613177">(</span><span class="string" id="613178">&#34;Got&nbsp;%q,&nbsp;want&nbsp;foo&#34;</span><span class="op" id="613196">,</span>&nbsp;<span class="ident" id="613198">slurp</span><span class="op" id="613203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613207">}</span><br>
<span class="lineno">1950</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="613212">//&nbsp;Now&nbsp;try&nbsp;again&nbsp;and&nbsp;see&nbsp;if&nbsp;we&nbsp;successfully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="613258">//&nbsp;pick&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613286">res</span><span class="op" id="613289">,</span>&nbsp;<span class="ident" id="613291">err</span>&nbsp;<span class="op" id="613295">=</span>&nbsp;<span class="ident" id="613297">client</span><span class="op" id="613303">.</span><span class="ident" id="613304">Get</span><span class="op" id="613307">(</span><span class="ident" id="613308">ts</span><span class="op" id="613310">.</span><span class="ident" id="613311">URL</span>&nbsp;<span class="op" id="613315">+</span>&nbsp;<span class="string" id="613317">&#34;/&#34;</span><span class="op" id="613320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613324">if</span>&nbsp;<span class="ident" id="613327">err</span>&nbsp;<span class="op" id="613331">!=</span>&nbsp;<span class="ident" id="613334">nil</span>&nbsp;<span class="op" id="613338">{</span><br>
<span class="lineno">1955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613343">errs</span>&nbsp;<span class="op" id="613348">=</span>&nbsp;<span class="builtinfunc" id="613350">append</span><span class="op" id="613356">(</span><span class="ident" id="613357">errs</span><span class="op" id="613361">,</span>&nbsp;<span class="ident" id="613363">err</span><span class="op" id="613366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613371">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613386">slurp</span><span class="op" id="613391">,</span>&nbsp;<span class="ident" id="613393">err</span>&nbsp;<span class="op" id="613397">=</span>&nbsp;<span class="ident" id="613399">ioutil</span><span class="op" id="613405">.</span><span class="ident" id="613406">ReadAll</span><span class="op" id="613413">(</span><span class="ident" id="613414">res</span><span class="op" id="613417">.</span><span class="ident" id="613418">Body</span><span class="op" id="613422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613426">if</span>&nbsp;<span class="ident" id="613429">err</span>&nbsp;<span class="op" id="613433">!=</span>&nbsp;<span class="ident" id="613436">nil</span>&nbsp;<span class="op" id="613440">{</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613445">errs</span>&nbsp;<span class="op" id="613450">=</span>&nbsp;<span class="builtinfunc" id="613452">append</span><span class="op" id="613458">(</span><span class="ident" id="613459">errs</span><span class="op" id="613463">,</span>&nbsp;<span class="ident" id="613465">err</span><span class="op" id="613468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613473">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613488">nSuccess</span><span class="op" id="613496">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613500">}</span><br>
<span class="lineno">1965</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613503">if</span>&nbsp;<span class="ident" id="613506">nSuccess</span>&nbsp;<span class="op" id="613515">&gt;</span>&nbsp;<span class="num" id="613517">0</span>&nbsp;<span class="op" id="613519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613523">t</span><span class="op" id="613524">.</span><span class="ident" id="613525">Logf</span><span class="op" id="613529">(</span><span class="string" id="613530">&#34;successes&nbsp;=&nbsp;%d&nbsp;of&nbsp;%d&#34;</span><span class="op" id="613552">,</span>&nbsp;<span class="ident" id="613554">nSuccess</span><span class="op" id="613562">,</span>&nbsp;<span class="ident" id="613564">trials</span><span class="op" id="613570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613573">}</span>&nbsp;<span class="keyword" id="613575">else</span>&nbsp;<span class="op" id="613580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613584">t</span><span class="op" id="613585">.</span><span class="ident" id="613586">Errorf</span><span class="op" id="613592">(</span><span class="string" id="613593">&#34;All&nbsp;runs&nbsp;failed:&#34;</span><span class="op" id="613611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613614">}</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613617">for</span>&nbsp;<span class="ident" id="613621">_</span><span class="op" id="613622">,</span>&nbsp;<span class="ident" id="613624">err</span>&nbsp;<span class="op" id="613628">:=</span>&nbsp;<span class="keyword" id="613631">range</span>&nbsp;<span class="ident" id="613637">errs</span>&nbsp;<span class="op" id="613642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613646">t</span><span class="op" id="613647">.</span><span class="ident" id="613648">Logf</span><span class="op" id="613652">(</span><span class="string" id="613653">&#34;&nbsp;&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="613664">,</span>&nbsp;<span class="ident" id="613666">err</span><span class="op" id="613669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613672">}</span><br>
<span class="lineno"></span><span class="op" id="613674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="comment" id="613677">//&nbsp;byteFromChanReader&nbsp;is&nbsp;an&nbsp;io.Reader&nbsp;that&nbsp;reads&nbsp;a&nbsp;single&nbsp;byte&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="613745">//&nbsp;time&nbsp;from&nbsp;the&nbsp;channel.&nbsp;&nbsp;When&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed,&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="613811">//&nbsp;returns&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="613830">type</span>&nbsp;<span class="ident" id="613835">byteFromChanReader</span>&nbsp;<span class="keyword" id="613854">chan</span>&nbsp;<span class="builtintype" id="613859">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">1980</span><span class="keyword" id="613865">func</span>&nbsp;<span class="op" id="613870">(</span><span class="ident" id="613871">c</span>&nbsp;<span class="ident" id="613873">byteFromChanReader</span><span class="op" id="613891">)</span>&nbsp;<span class="ident" id="613893">Read</span><span class="op" id="613897">(</span><span class="ident" id="613898">p</span>&nbsp;<span class="op" id="613900">[</span><span class="op" id="613901">]</span><span class="builtintype" id="613902">byte</span><span class="op" id="613906">)</span>&nbsp;<span class="op" id="613908">(</span><span class="ident" id="613909">n</span>&nbsp;<span class="builtintype" id="613911">int</span><span class="op" id="613914">,</span>&nbsp;<span class="ident" id="613916">err</span>&nbsp;<span class="builtintype" id="613920">error</span><span class="op" id="613925">)</span>&nbsp;<span class="op" id="613927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613930">if</span>&nbsp;<span class="builtinfunc" id="613933">len</span><span class="op" id="613936">(</span><span class="ident" id="613937">p</span><span class="op" id="613938">)</span>&nbsp;<span class="op" id="613940">==</span>&nbsp;<span class="num" id="613943">0</span>&nbsp;<span class="op" id="613945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613949">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="613957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="613960">b</span><span class="op" id="613961">,</span>&nbsp;<span class="ident" id="613963">ok</span>&nbsp;<span class="op" id="613966">:=</span>&nbsp;<span class="op" id="613969">&lt;-</span><span class="ident" id="613971">c</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613974">if</span>&nbsp;<span class="op" id="613977">!</span><span class="ident" id="613978">ok</span>&nbsp;<span class="op" id="613981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="613985">return</span>&nbsp;<span class="num" id="613992">0</span><span class="op" id="613993">,</span>&nbsp;<span class="ident" id="613995">io</span><span class="op" id="613997">.</span><span class="ident" id="613998">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="614003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614006">p</span><span class="op" id="614007">[</span><span class="num" id="614008">0</span><span class="op" id="614009">]</span>&nbsp;<span class="op" id="614011">=</span>&nbsp;<span class="ident" id="614013">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614016">return</span>&nbsp;<span class="num" id="614023">1</span><span class="op" id="614024">,</span>&nbsp;<span class="ident" id="614026">nil</span><br>
<span class="lineno">1990</span><span class="op" id="614030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="614033">//&nbsp;Verifies&nbsp;that&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;reuse&nbsp;a&nbsp;connection&nbsp;in&nbsp;the&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="614103">//&nbsp;where&nbsp;the&nbsp;server&nbsp;replies&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;been&nbsp;fully</span><br>
<span class="lineno"></span><span class="comment" id="614165">//&nbsp;written.&nbsp;We&nbsp;still&nbsp;honor&nbsp;that&nbsp;reply&nbsp;(see&nbsp;TestIssue3595),&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno">1995</span><span class="comment" id="614234">//&nbsp;send&nbsp;future&nbsp;requests&nbsp;on&nbsp;the&nbsp;connection&nbsp;because&nbsp;it&#39;s&nbsp;then&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="614299">//&nbsp;questionable&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="614322">//&nbsp;golang.org/issue/7569</span><br>
<span class="lineno"></span><span class="keyword" id="614347">func</span>&nbsp;<span class="ident" id="614352">TestTransportNoReuseAfterEarlyResponse</span><span class="op" id="614390">(</span><span class="ident" id="614391">t</span>&nbsp;<span class="op" id="614393">*</span><span class="ident" id="614394">testing</span><span class="op" id="614401">.</span><span class="ident" id="614402">T</span><span class="op" id="614403">)</span>&nbsp;<span class="op" id="614405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614408">defer</span>&nbsp;<span class="ident" id="614414">afterTest</span><span class="op" id="614423">(</span><span class="ident" id="614424">t</span><span class="op" id="614425">)</span><br>
<span class="lineno">2000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614428">var</span>&nbsp;<span class="ident" id="614432">sconn</span>&nbsp;<span class="keyword" id="614438">struct</span>&nbsp;<span class="op" id="614445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614449">sync</span><span class="op" id="614453">.</span><span class="ident" id="614454">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614462">c</span>&nbsp;<span class="ident" id="614464">net</span><span class="op" id="614467">.</span><span class="ident" id="614468">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="614474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614477">var</span>&nbsp;<span class="ident" id="614481">getOkay</span>&nbsp;<span class="builtintype" id="614489">bool</span><br>
<span class="lineno">2005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614495">closeConn</span>&nbsp;<span class="op" id="614505">:=</span>&nbsp;<span class="keyword" id="614508">func</span><span class="op" id="614512">(</span><span class="op" id="614513">)</span>&nbsp;<span class="op" id="614515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614519">sconn</span><span class="op" id="614524">.</span><span class="ident" id="614525">Lock</span><span class="op" id="614529">(</span><span class="op" id="614530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614534">defer</span>&nbsp;<span class="ident" id="614540">sconn</span><span class="op" id="614545">.</span><span class="ident" id="614546">Unlock</span><span class="op" id="614552">(</span><span class="op" id="614553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614557">if</span>&nbsp;<span class="ident" id="614560">sconn</span><span class="op" id="614565">.</span><span class="ident" id="614566">c</span>&nbsp;<span class="op" id="614568">!=</span>&nbsp;<span class="ident" id="614571">nil</span>&nbsp;<span class="op" id="614575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614580">sconn</span><span class="op" id="614585">.</span><span class="ident" id="614586">c</span><span class="op" id="614587">.</span><span class="ident" id="614588">Close</span><span class="op" id="614593">(</span><span class="op" id="614594">)</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614599">sconn</span><span class="op" id="614604">.</span><span class="ident" id="614605">c</span>&nbsp;<span class="op" id="614607">=</span>&nbsp;<span class="ident" id="614609">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614616">if</span>&nbsp;<span class="op" id="614619">!</span><span class="ident" id="614620">getOkay</span>&nbsp;<span class="op" id="614628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614634">t</span><span class="op" id="614635">.</span><span class="ident" id="614636">Logf</span><span class="op" id="614640">(</span><span class="string" id="614641">&#34;Closed&nbsp;server&nbsp;connection&#34;</span><span class="op" id="614667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="614672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="614676">}</span><br>
<span class="lineno">2015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="614679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614682">defer</span>&nbsp;<span class="ident" id="614688">closeConn</span><span class="op" id="614697">(</span><span class="op" id="614698">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614702">ts</span>&nbsp;<span class="op" id="614705">:=</span>&nbsp;<span class="ident" id="614708">httptest</span><span class="op" id="614716">.</span><span class="ident" id="614717">NewServer</span><span class="op" id="614726">(</span><span class="ident" id="614727">HandlerFunc</span><span class="op" id="614738">(</span><span class="keyword" id="614739">func</span><span class="op" id="614743">(</span><span class="ident" id="614744">w</span>&nbsp;<span class="ident" id="614746">ResponseWriter</span><span class="op" id="614760">,</span>&nbsp;<span class="ident" id="614762">r</span>&nbsp;<span class="op" id="614764">*</span><span class="ident" id="614765">Request</span><span class="op" id="614772">)</span>&nbsp;<span class="op" id="614774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614778">if</span>&nbsp;<span class="ident" id="614781">r</span><span class="op" id="614782">.</span><span class="ident" id="614783">Method</span>&nbsp;<span class="op" id="614790">==</span>&nbsp;<span class="string" id="614793">&#34;GET&#34;</span>&nbsp;<span class="op" id="614799">{</span><br>
<span class="lineno">2020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614804">io</span><span class="op" id="614806">.</span><span class="ident" id="614807">WriteString</span><span class="op" id="614818">(</span><span class="ident" id="614819">w</span><span class="op" id="614820">,</span>&nbsp;<span class="string" id="614822">&#34;bar&#34;</span><span class="op" id="614827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="614832">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="614841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614845">conn</span><span class="op" id="614849">,</span>&nbsp;<span class="ident" id="614851">_</span><span class="op" id="614852">,</span>&nbsp;<span class="ident" id="614854">_</span>&nbsp;<span class="op" id="614856">:=</span>&nbsp;<span class="ident" id="614859">w</span><span class="op" id="614860">.</span><span class="op" id="614861">(</span><span class="ident" id="614862">Hijacker</span><span class="op" id="614870">)</span><span class="op" id="614871">.</span><span class="ident" id="614872">Hijack</span><span class="op" id="614878">(</span><span class="op" id="614879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614883">sconn</span><span class="op" id="614888">.</span><span class="ident" id="614889">Lock</span><span class="op" id="614893">(</span><span class="op" id="614894">)</span><br>
<span class="lineno">2025</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614898">sconn</span><span class="op" id="614903">.</span><span class="ident" id="614904">c</span>&nbsp;<span class="op" id="614906">=</span>&nbsp;<span class="ident" id="614908">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614915">sconn</span><span class="op" id="614920">.</span><span class="ident" id="614921">Unlock</span><span class="op" id="614927">(</span><span class="op" id="614928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="614932">conn</span><span class="op" id="614936">.</span><span class="ident" id="614937">Write</span><span class="op" id="614942">(</span><span class="op" id="614943">[</span><span class="op" id="614944">]</span><span class="builtintype" id="614945">byte</span><span class="op" id="614949">(</span><span class="string" id="614950">&#34;HTTP/1.1&nbsp;200&nbsp;OK\r\nContent-Length:&nbsp;3\r\n\r\nfoo&#34;</span><span class="op" id="614999">)</span><span class="op" id="615000">)</span>&nbsp;<span class="comment" id="615002">//&nbsp;keep-alive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615018">go</span>&nbsp;<span class="ident" id="615021">io</span><span class="op" id="615023">.</span><span class="ident" id="615024">Copy</span><span class="op" id="615028">(</span><span class="ident" id="615029">ioutil</span><span class="op" id="615035">.</span><span class="ident" id="615036">Discard</span><span class="op" id="615043">,</span>&nbsp;<span class="ident" id="615045">conn</span><span class="op" id="615049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="615052">}</span><span class="op" id="615053">)</span><span class="op" id="615054">)</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615057">defer</span>&nbsp;<span class="ident" id="615063">ts</span><span class="op" id="615065">.</span><span class="ident" id="615066">Close</span><span class="op" id="615071">(</span><span class="op" id="615072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615075">tr</span>&nbsp;<span class="op" id="615078">:=</span>&nbsp;<span class="op" id="615081">&amp;</span><span class="ident" id="615082">Transport</span><span class="op" id="615091">{</span><span class="op" id="615092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615095">defer</span>&nbsp;<span class="ident" id="615101">tr</span><span class="op" id="615103">.</span><span class="ident" id="615104">CloseIdleConnections</span><span class="op" id="615124">(</span><span class="op" id="615125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615128">client</span>&nbsp;<span class="op" id="615135">:=</span>&nbsp;<span class="op" id="615138">&amp;</span><span class="ident" id="615139">Client</span><span class="op" id="615145">{</span><span class="ident" id="615146">Transport</span><span class="op" id="615155">:</span>&nbsp;<span class="ident" id="615157">tr</span><span class="op" id="615159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615163">const</span>&nbsp;<span class="ident" id="615169">bodySize</span>&nbsp;<span class="op" id="615178">=</span>&nbsp;<span class="num" id="615180">256</span>&nbsp;<span class="op" id="615184">&lt;&lt;</span>&nbsp;<span class="num" id="615187">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615191">finalBit</span>&nbsp;<span class="op" id="615200">:=</span>&nbsp;<span class="builtinfunc" id="615203">make</span><span class="op" id="615207">(</span><span class="ident" id="615208">byteFromChanReader</span><span class="op" id="615226">,</span>&nbsp;<span class="num" id="615228">1</span><span class="op" id="615229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615232">req</span><span class="op" id="615235">,</span>&nbsp;<span class="ident" id="615237">_</span>&nbsp;<span class="op" id="615239">:=</span>&nbsp;<span class="ident" id="615242">NewRequest</span><span class="op" id="615252">(</span><span class="string" id="615253">&#34;POST&#34;</span><span class="op" id="615259">,</span>&nbsp;<span class="ident" id="615261">ts</span><span class="op" id="615263">.</span><span class="ident" id="615264">URL</span><span class="op" id="615267">,</span>&nbsp;<span class="ident" id="615269">io</span><span class="op" id="615271">.</span><span class="ident" id="615272">MultiReader</span><span class="op" id="615283">(</span><span class="ident" id="615284">io</span><span class="op" id="615286">.</span><span class="ident" id="615287">LimitReader</span><span class="op" id="615298">(</span><span class="ident" id="615299">neverEnding</span><span class="op" id="615310">(</span><span class="string" id="615311">&#39;x&#39;</span><span class="op" id="615314">)</span><span class="op" id="615315">,</span>&nbsp;<span class="ident" id="615317">bodySize</span><span class="op" id="615325">-</span><span class="num" id="615326">1</span><span class="op" id="615327">)</span><span class="op" id="615328">,</span>&nbsp;<span class="ident" id="615330">finalBit</span><span class="op" id="615338">)</span><span class="op" id="615339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615342">req</span><span class="op" id="615345">.</span><span class="ident" id="615346">ContentLength</span>&nbsp;<span class="op" id="615360">=</span>&nbsp;<span class="ident" id="615362">bodySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615372">res</span><span class="op" id="615375">,</span>&nbsp;<span class="ident" id="615377">err</span>&nbsp;<span class="op" id="615381">:=</span>&nbsp;<span class="ident" id="615384">client</span><span class="op" id="615390">.</span><span class="ident" id="615391">Do</span><span class="op" id="615393">(</span><span class="ident" id="615394">req</span><span class="op" id="615397">)</span><br>
<span class="lineno">2040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615400">if</span>&nbsp;<span class="ident" id="615403">err</span>&nbsp;<span class="op" id="615407">:=</span>&nbsp;<span class="ident" id="615410">wantBody</span><span class="op" id="615418">(</span><span class="ident" id="615419">res</span><span class="op" id="615422">,</span>&nbsp;<span class="ident" id="615424">err</span><span class="op" id="615427">,</span>&nbsp;<span class="string" id="615429">&#34;foo&#34;</span><span class="op" id="615434">)</span><span class="op" id="615435">;</span>&nbsp;<span class="ident" id="615437">err</span>&nbsp;<span class="op" id="615441">!=</span>&nbsp;<span class="ident" id="615444">nil</span>&nbsp;<span class="op" id="615448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615452">t</span><span class="op" id="615453">.</span><span class="ident" id="615454">Errorf</span><span class="op" id="615460">(</span><span class="string" id="615461">&#34;POST&nbsp;response:&nbsp;%v&#34;</span><span class="op" id="615480">,</span>&nbsp;<span class="ident" id="615482">err</span><span class="op" id="615485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="615488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615491">donec</span>&nbsp;<span class="op" id="615497">:=</span>&nbsp;<span class="builtinfunc" id="615500">make</span><span class="op" id="615504">(</span><span class="keyword" id="615505">chan</span>&nbsp;<span class="builtintype" id="615510">bool</span><span class="op" id="615514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615517">go</span>&nbsp;<span class="keyword" id="615520">func</span><span class="op" id="615524">(</span><span class="op" id="615525">)</span>&nbsp;<span class="op" id="615527">{</span><br>
<span class="lineno">2045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615531">defer</span>&nbsp;<span class="builtinfunc" id="615537">close</span><span class="op" id="615542">(</span><span class="ident" id="615543">donec</span><span class="op" id="615548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615552">res</span><span class="op" id="615555">,</span>&nbsp;<span class="ident" id="615557">err</span>&nbsp;<span class="op" id="615561">=</span>&nbsp;<span class="ident" id="615563">client</span><span class="op" id="615569">.</span><span class="ident" id="615570">Get</span><span class="op" id="615573">(</span><span class="ident" id="615574">ts</span><span class="op" id="615576">.</span><span class="ident" id="615577">URL</span><span class="op" id="615580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615584">if</span>&nbsp;<span class="ident" id="615587">err</span>&nbsp;<span class="op" id="615591">:=</span>&nbsp;<span class="ident" id="615594">wantBody</span><span class="op" id="615602">(</span><span class="ident" id="615603">res</span><span class="op" id="615606">,</span>&nbsp;<span class="ident" id="615608">err</span><span class="op" id="615611">,</span>&nbsp;<span class="string" id="615613">&#34;bar&#34;</span><span class="op" id="615618">)</span><span class="op" id="615619">;</span>&nbsp;<span class="ident" id="615621">err</span>&nbsp;<span class="op" id="615625">!=</span>&nbsp;<span class="ident" id="615628">nil</span>&nbsp;<span class="op" id="615632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615637">t</span><span class="op" id="615638">.</span><span class="ident" id="615639">Errorf</span><span class="op" id="615645">(</span><span class="string" id="615646">&#34;GET&nbsp;response:&nbsp;%v&#34;</span><span class="op" id="615664">,</span>&nbsp;<span class="ident" id="615666">err</span><span class="op" id="615669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615674">return</span><br>
<span class="lineno">2050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="615683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615687">getOkay</span>&nbsp;<span class="op" id="615695">=</span>&nbsp;<span class="builtintype" id="615697">true</span>&nbsp;<span class="comment" id="615702">//&nbsp;suppress&nbsp;test&nbsp;noise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="615726">}</span><span class="op" id="615727">(</span><span class="op" id="615728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615731">time</span><span class="op" id="615735">.</span><span class="ident" id="615736">AfterFunc</span><span class="op" id="615745">(</span><span class="num" id="615746">5</span><span class="op" id="615747">*</span><span class="ident" id="615748">time</span><span class="op" id="615752">.</span><span class="ident" id="615753">Second</span><span class="op" id="615759">,</span>&nbsp;<span class="ident" id="615761">closeConn</span><span class="op" id="615770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615773">select</span>&nbsp;<span class="op" id="615780">{</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615783">case</span>&nbsp;<span class="op" id="615788">&lt;-</span><span class="ident" id="615790">donec</span><span class="op" id="615795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615799">finalBit</span>&nbsp;<span class="op" id="615808">&lt;-</span>&nbsp;<span class="string" id="615811">&#39;x&#39;</span>&nbsp;<span class="comment" id="615815">//&nbsp;unblock&nbsp;the&nbsp;writeloop&nbsp;of&nbsp;the&nbsp;first&nbsp;Post</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="615860">close</span><span class="op" id="615865">(</span><span class="ident" id="615866">finalBit</span><span class="op" id="615874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="615877">case</span>&nbsp;<span class="op" id="615882">&lt;-</span><span class="ident" id="615884">time</span><span class="op" id="615888">.</span><span class="ident" id="615889">After</span><span class="op" id="615894">(</span><span class="num" id="615895">7</span>&nbsp;<span class="op" id="615897">*</span>&nbsp;<span class="ident" id="615899">time</span><span class="op" id="615903">.</span><span class="ident" id="615904">Second</span><span class="op" id="615910">)</span><span class="op" id="615911">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="615915">t</span><span class="op" id="615916">.</span><span class="ident" id="615917">Fatal</span><span class="op" id="615922">(</span><span class="string" id="615923">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;GET&nbsp;request&nbsp;to&nbsp;finish&#34;</span><span class="op" id="615966">)</span><br>
<span class="lineno">2060</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="615969">}</span><br>
<span class="lineno"></span><span class="op" id="615971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="615974">type</span>&nbsp;<span class="ident" id="615979">errorReader</span>&nbsp;<span class="keyword" id="615991">struct</span>&nbsp;<span class="op" id="615998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616001">err</span>&nbsp;<span class="builtintype" id="616005">error</span><br>
<span class="lineno">2065</span><span class="op" id="616011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="616014">func</span>&nbsp;<span class="op" id="616019">(</span><span class="ident" id="616020">e</span>&nbsp;<span class="ident" id="616022">errorReader</span><span class="op" id="616033">)</span>&nbsp;<span class="ident" id="616035">Read</span><span class="op" id="616039">(</span><span class="ident" id="616040">p</span>&nbsp;<span class="op" id="616042">[</span><span class="op" id="616043">]</span><span class="builtintype" id="616044">byte</span><span class="op" id="616048">)</span>&nbsp;<span class="op" id="616050">(</span><span class="builtintype" id="616051">int</span><span class="op" id="616054">,</span>&nbsp;<span class="builtintype" id="616056">error</span><span class="op" id="616061">)</span>&nbsp;<span class="op" id="616063">{</span>&nbsp;<span class="keyword" id="616065">return</span>&nbsp;<span class="num" id="616072">0</span><span class="op" id="616073">,</span>&nbsp;<span class="ident" id="616075">e</span><span class="op" id="616076">.</span><span class="ident" id="616077">err</span>&nbsp;<span class="op" id="616081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="616084">type</span>&nbsp;<span class="ident" id="616089">closerFunc</span>&nbsp;<span class="keyword" id="616100">func</span><span class="op" id="616104">(</span><span class="op" id="616105">)</span>&nbsp;<span class="builtintype" id="616107">error</span><br>
<span class="lineno">2070</span><br>
<span class="lineno"></span><span class="keyword" id="616114">func</span>&nbsp;<span class="op" id="616119">(</span><span class="ident" id="616120">f</span>&nbsp;<span class="ident" id="616122">closerFunc</span><span class="op" id="616132">)</span>&nbsp;<span class="ident" id="616134">Close</span><span class="op" id="616139">(</span><span class="op" id="616140">)</span>&nbsp;<span class="builtintype" id="616142">error</span>&nbsp;<span class="op" id="616148">{</span>&nbsp;<span class="keyword" id="616150">return</span>&nbsp;<span class="ident" id="616157">f</span><span class="op" id="616158">(</span><span class="op" id="616159">)</span>&nbsp;<span class="op" id="616161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="616164">//&nbsp;Issue&nbsp;6981</span><br>
<span class="lineno"></span><span class="keyword" id="616178">func</span>&nbsp;<span class="ident" id="616183">TestTransportClosesBodyOnError</span><span class="op" id="616213">(</span><span class="ident" id="616214">t</span>&nbsp;<span class="op" id="616216">*</span><span class="ident" id="616217">testing</span><span class="op" id="616224">.</span><span class="ident" id="616225">T</span><span class="op" id="616226">)</span>&nbsp;<span class="op" id="616228">{</span><br>
<span class="lineno">2075</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616231">if</span>&nbsp;<span class="ident" id="616234">runtime</span><span class="op" id="616241">.</span><span class="ident" id="616242">GOOS</span>&nbsp;<span class="op" id="616247">==</span>&nbsp;<span class="string" id="616250">&#34;plan9&#34;</span>&nbsp;<span class="op" id="616258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616262">t</span><span class="op" id="616263">.</span><span class="ident" id="616264">Skip</span><span class="op" id="616268">(</span><span class="string" id="616269">&#34;skipping&nbsp;test;&nbsp;see&nbsp;http://golang.org/issue/7782&#34;</span><span class="op" id="616318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616324">defer</span>&nbsp;<span class="ident" id="616330">afterTest</span><span class="op" id="616339">(</span><span class="ident" id="616340">t</span><span class="op" id="616341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616344">readBody</span>&nbsp;<span class="op" id="616353">:=</span>&nbsp;<span class="builtinfunc" id="616356">make</span><span class="op" id="616360">(</span><span class="keyword" id="616361">chan</span>&nbsp;<span class="builtintype" id="616366">error</span><span class="op" id="616371">,</span>&nbsp;<span class="num" id="616373">1</span><span class="op" id="616374">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616377">ts</span>&nbsp;<span class="op" id="616380">:=</span>&nbsp;<span class="ident" id="616383">httptest</span><span class="op" id="616391">.</span><span class="ident" id="616392">NewServer</span><span class="op" id="616401">(</span><span class="ident" id="616402">HandlerFunc</span><span class="op" id="616413">(</span><span class="keyword" id="616414">func</span><span class="op" id="616418">(</span><span class="ident" id="616419">w</span>&nbsp;<span class="ident" id="616421">ResponseWriter</span><span class="op" id="616435">,</span>&nbsp;<span class="ident" id="616437">r</span>&nbsp;<span class="op" id="616439">*</span><span class="ident" id="616440">Request</span><span class="op" id="616447">)</span>&nbsp;<span class="op" id="616449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616453">_</span><span class="op" id="616454">,</span>&nbsp;<span class="ident" id="616456">err</span>&nbsp;<span class="op" id="616460">:=</span>&nbsp;<span class="ident" id="616463">ioutil</span><span class="op" id="616469">.</span><span class="ident" id="616470">ReadAll</span><span class="op" id="616477">(</span><span class="ident" id="616478">r</span><span class="op" id="616479">.</span><span class="ident" id="616480">Body</span><span class="op" id="616484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616488">readBody</span>&nbsp;<span class="op" id="616497">&lt;-</span>&nbsp;<span class="ident" id="616500">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616505">}</span><span class="op" id="616506">)</span><span class="op" id="616507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616510">defer</span>&nbsp;<span class="ident" id="616516">ts</span><span class="op" id="616518">.</span><span class="ident" id="616519">Close</span><span class="op" id="616524">(</span><span class="op" id="616525">)</span><br>
<span class="lineno">2085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616528">fakeErr</span>&nbsp;<span class="op" id="616536">:=</span>&nbsp;<span class="ident" id="616539">errors</span><span class="op" id="616545">.</span><span class="ident" id="616546">New</span><span class="op" id="616549">(</span><span class="string" id="616550">&#34;fake&nbsp;error&#34;</span><span class="op" id="616562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616565">didClose</span>&nbsp;<span class="op" id="616574">:=</span>&nbsp;<span class="builtinfunc" id="616577">make</span><span class="op" id="616581">(</span><span class="keyword" id="616582">chan</span>&nbsp;<span class="builtintype" id="616587">bool</span><span class="op" id="616591">,</span>&nbsp;<span class="num" id="616593">1</span><span class="op" id="616594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616597">req</span><span class="op" id="616600">,</span>&nbsp;<span class="ident" id="616602">_</span>&nbsp;<span class="op" id="616604">:=</span>&nbsp;<span class="ident" id="616607">NewRequest</span><span class="op" id="616617">(</span><span class="string" id="616618">&#34;POST&#34;</span><span class="op" id="616624">,</span>&nbsp;<span class="ident" id="616626">ts</span><span class="op" id="616628">.</span><span class="ident" id="616629">URL</span><span class="op" id="616632">,</span>&nbsp;<span class="keyword" id="616634">struct</span>&nbsp;<span class="op" id="616641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616645">io</span><span class="op" id="616647">.</span><span class="ident" id="616648">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616657">io</span><span class="op" id="616659">.</span><span class="ident" id="616660">Closer</span><br>
<span class="lineno">2090</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616668">}</span><span class="op" id="616669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616673">io</span><span class="op" id="616675">.</span><span class="ident" id="616676">MultiReader</span><span class="op" id="616687">(</span><span class="ident" id="616688">io</span><span class="op" id="616690">.</span><span class="ident" id="616691">LimitReader</span><span class="op" id="616702">(</span><span class="ident" id="616703">neverEnding</span><span class="op" id="616714">(</span><span class="string" id="616715">&#39;x&#39;</span><span class="op" id="616718">)</span><span class="op" id="616719">,</span>&nbsp;<span class="num" id="616721">1</span><span class="op" id="616722">&lt;&lt;</span><span class="num" id="616724">20</span><span class="op" id="616726">)</span><span class="op" id="616727">,</span>&nbsp;<span class="ident" id="616729">errorReader</span><span class="op" id="616740">{</span><span class="ident" id="616741">fakeErr</span><span class="op" id="616748">}</span><span class="op" id="616749">)</span><span class="op" id="616750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616754">closerFunc</span><span class="op" id="616764">(</span><span class="keyword" id="616765">func</span><span class="op" id="616769">(</span><span class="op" id="616770">)</span>&nbsp;<span class="builtintype" id="616772">error</span>&nbsp;<span class="op" id="616778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616783">select</span>&nbsp;<span class="op" id="616790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616795">case</span>&nbsp;<span class="ident" id="616800">didClose</span>&nbsp;<span class="op" id="616809">&lt;-</span>&nbsp;<span class="builtintype" id="616812">true</span><span class="op" id="616816">:</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616821">default</span><span class="op" id="616828">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616838">return</span>&nbsp;<span class="ident" id="616845">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616851">}</span><span class="op" id="616852">)</span><span class="op" id="616853">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616856">}</span><span class="op" id="616857">)</span><br>
<span class="lineno">2100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="616860">res</span><span class="op" id="616863">,</span>&nbsp;<span class="ident" id="616865">err</span>&nbsp;<span class="op" id="616869">:=</span>&nbsp;<span class="ident" id="616872">DefaultClient</span><span class="op" id="616885">.</span><span class="ident" id="616886">Do</span><span class="op" id="616888">(</span><span class="ident" id="616889">req</span><span class="op" id="616892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616895">if</span>&nbsp;<span class="ident" id="616898">res</span>&nbsp;<span class="op" id="616902">!=</span>&nbsp;<span class="ident" id="616905">nil</span>&nbsp;<span class="op" id="616909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616913">defer</span>&nbsp;<span class="ident" id="616919">res</span><span class="op" id="616922">.</span><span class="ident" id="616923">Body</span><span class="op" id="616927">.</span><span class="ident" id="616928">Close</span><span class="op" id="616933">(</span><span class="op" id="616934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="616937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="616940">if</span>&nbsp;<span class="ident" id="616943">err</span>&nbsp;<span class="op" id="616947">==</span>&nbsp;<span class="ident" id="616950">nil</span>&nbsp;<span class="op" id="616954">||</span>&nbsp;<span class="op" id="616957">!</span><span class="ident" id="616958">strings</span><span class="op" id="616965">.</span><span class="ident" id="616966">Contains</span><span class="op" id="616974">(</span><span class="ident" id="616975">err</span><span class="op" id="616978">.</span><span class="ident" id="616979">Error</span><span class="op" id="616984">(</span><span class="op" id="616985">)</span><span class="op" id="616986">,</span>&nbsp;<span class="ident" id="616988">fakeErr</span><span class="op" id="616995">.</span><span class="ident" id="616996">Error</span><span class="op" id="617001">(</span><span class="op" id="617002">)</span><span class="op" id="617003">)</span>&nbsp;<span class="op" id="617005">{</span><br>
<span class="lineno">2105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617009">t</span><span class="op" id="617010">.</span><span class="ident" id="617011">Fatalf</span><span class="op" id="617017">(</span><span class="string" id="617018">&#34;Do&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;something&nbsp;containing&nbsp;%q&#34;</span><span class="op" id="617063">,</span>&nbsp;<span class="ident" id="617065">err</span><span class="op" id="617068">,</span>&nbsp;<span class="ident" id="617070">fakeErr</span><span class="op" id="617077">.</span><span class="ident" id="617078">Error</span><span class="op" id="617083">(</span><span class="op" id="617084">)</span><span class="op" id="617085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617091">select</span>&nbsp;<span class="op" id="617098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617101">case</span>&nbsp;<span class="ident" id="617106">err</span>&nbsp;<span class="op" id="617110">:=</span>&nbsp;<span class="op" id="617113">&lt;-</span><span class="ident" id="617115">readBody</span><span class="op" id="617123">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617127">if</span>&nbsp;<span class="ident" id="617130">err</span>&nbsp;<span class="op" id="617134">==</span>&nbsp;<span class="ident" id="617137">nil</span>&nbsp;<span class="op" id="617141">{</span><br>
<span class="lineno">2110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617146">t</span><span class="op" id="617147">.</span><span class="ident" id="617148">Errorf</span><span class="op" id="617154">(</span><span class="string" id="617155">&#34;Unexpected&nbsp;success&nbsp;reading&nbsp;request&nbsp;body&nbsp;from&nbsp;handler;&nbsp;want&nbsp;&#39;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#39;&#34;</span><span class="op" id="617248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617255">case</span>&nbsp;<span class="op" id="617260">&lt;-</span><span class="ident" id="617262">time</span><span class="op" id="617266">.</span><span class="ident" id="617267">After</span><span class="op" id="617272">(</span><span class="num" id="617273">5</span>&nbsp;<span class="op" id="617275">*</span>&nbsp;<span class="ident" id="617277">time</span><span class="op" id="617281">.</span><span class="ident" id="617282">Second</span><span class="op" id="617288">)</span><span class="op" id="617289">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617293">t</span><span class="op" id="617294">.</span><span class="ident" id="617295">Error</span><span class="op" id="617300">(</span><span class="string" id="617301">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;server&nbsp;handler&nbsp;to&nbsp;complete&#34;</span><span class="op" id="617349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617352">}</span><br>
<span class="lineno">2115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617355">select</span>&nbsp;<span class="op" id="617362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617365">case</span>&nbsp;<span class="op" id="617370">&lt;-</span><span class="ident" id="617372">didClose</span><span class="op" id="617380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617383">default</span><span class="op" id="617390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617394">t</span><span class="op" id="617395">.</span><span class="ident" id="617396">Errorf</span><span class="op" id="617402">(</span><span class="string" id="617403">&#34;didn&#39;t&nbsp;see&nbsp;Body.Close&#34;</span><span class="op" id="617426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617429">}</span><br>
<span class="lineno">2120</span><span class="op" id="617431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="617434">func</span>&nbsp;<span class="ident" id="617439">TestTransportDialTLS</span><span class="op" id="617459">(</span><span class="ident" id="617460">t</span>&nbsp;<span class="op" id="617462">*</span><span class="ident" id="617463">testing</span><span class="op" id="617470">.</span><span class="ident" id="617471">T</span><span class="op" id="617472">)</span>&nbsp;<span class="op" id="617474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617477">var</span>&nbsp;<span class="ident" id="617481">mu</span>&nbsp;<span class="ident" id="617484">sync</span><span class="op" id="617488">.</span><span class="ident" id="617489">Mutex</span>&nbsp;<span class="comment" id="617495">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617516">var</span>&nbsp;<span class="ident" id="617520">gotReq</span><span class="op" id="617526">,</span>&nbsp;<span class="ident" id="617528">didDial</span>&nbsp;<span class="builtintype" id="617536">bool</span><br>
<span class="lineno">2125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617543">ts</span>&nbsp;<span class="op" id="617546">:=</span>&nbsp;<span class="ident" id="617549">httptest</span><span class="op" id="617557">.</span><span class="ident" id="617558">NewTLSServer</span><span class="op" id="617570">(</span><span class="ident" id="617571">HandlerFunc</span><span class="op" id="617582">(</span><span class="keyword" id="617583">func</span><span class="op" id="617587">(</span><span class="ident" id="617588">w</span>&nbsp;<span class="ident" id="617590">ResponseWriter</span><span class="op" id="617604">,</span>&nbsp;<span class="ident" id="617606">r</span>&nbsp;<span class="op" id="617608">*</span><span class="ident" id="617609">Request</span><span class="op" id="617616">)</span>&nbsp;<span class="op" id="617618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617622">mu</span><span class="op" id="617624">.</span><span class="ident" id="617625">Lock</span><span class="op" id="617629">(</span><span class="op" id="617630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617634">gotReq</span>&nbsp;<span class="op" id="617641">=</span>&nbsp;<span class="builtintype" id="617643">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617650">mu</span><span class="op" id="617652">.</span><span class="ident" id="617653">Unlock</span><span class="op" id="617659">(</span><span class="op" id="617660">)</span><br>
<span class="lineno">2130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617663">}</span><span class="op" id="617664">)</span><span class="op" id="617665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617668">defer</span>&nbsp;<span class="ident" id="617674">ts</span><span class="op" id="617676">.</span><span class="ident" id="617677">Close</span><span class="op" id="617682">(</span><span class="op" id="617683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617686">tr</span>&nbsp;<span class="op" id="617689">:=</span>&nbsp;<span class="op" id="617692">&amp;</span><span class="ident" id="617693">Transport</span><span class="op" id="617702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617706">DialTLS</span><span class="op" id="617713">:</span>&nbsp;<span class="keyword" id="617715">func</span><span class="op" id="617719">(</span><span class="ident" id="617720">netw</span><span class="op" id="617724">,</span>&nbsp;<span class="ident" id="617726">addr</span>&nbsp;<span class="builtintype" id="617731">string</span><span class="op" id="617737">)</span>&nbsp;<span class="op" id="617739">(</span><span class="ident" id="617740">net</span><span class="op" id="617743">.</span><span class="ident" id="617744">Conn</span><span class="op" id="617748">,</span>&nbsp;<span class="builtintype" id="617750">error</span><span class="op" id="617755">)</span>&nbsp;<span class="op" id="617757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617762">mu</span><span class="op" id="617764">.</span><span class="ident" id="617765">Lock</span><span class="op" id="617769">(</span><span class="op" id="617770">)</span><br>
<span class="lineno">2135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617775">didDial</span>&nbsp;<span class="op" id="617783">=</span>&nbsp;<span class="builtintype" id="617785">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617793">mu</span><span class="op" id="617795">.</span><span class="ident" id="617796">Unlock</span><span class="op" id="617802">(</span><span class="op" id="617803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617808">c</span><span class="op" id="617809">,</span>&nbsp;<span class="ident" id="617811">err</span>&nbsp;<span class="op" id="617815">:=</span>&nbsp;<span class="ident" id="617818">tls</span><span class="op" id="617821">.</span><span class="ident" id="617822">Dial</span><span class="op" id="617826">(</span><span class="ident" id="617827">netw</span><span class="op" id="617831">,</span>&nbsp;<span class="ident" id="617833">addr</span><span class="op" id="617837">,</span>&nbsp;<span class="op" id="617839">&amp;</span><span class="ident" id="617840">tls</span><span class="op" id="617843">.</span><span class="ident" id="617844">Config</span><span class="op" id="617850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="617856">InsecureSkipVerify</span><span class="op" id="617874">:</span>&nbsp;<span class="builtintype" id="617876">true</span><span class="op" id="617880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617885">}</span><span class="op" id="617886">)</span><br>
<span class="lineno">2140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617891">if</span>&nbsp;<span class="ident" id="617894">err</span>&nbsp;<span class="op" id="617898">!=</span>&nbsp;<span class="ident" id="617901">nil</span>&nbsp;<span class="op" id="617905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617911">return</span>&nbsp;<span class="ident" id="617918">nil</span><span class="op" id="617921">,</span>&nbsp;<span class="ident" id="617923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617935">return</span>&nbsp;<span class="ident" id="617942">c</span><span class="op" id="617943">,</span>&nbsp;<span class="ident" id="617945">c</span><span class="op" id="617946">.</span><span class="ident" id="617947">Handshake</span><span class="op" id="617956">(</span><span class="op" id="617957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617961">}</span><span class="op" id="617962">,</span><br>
<span class="lineno">2145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="617965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="617968">defer</span>&nbsp;<span class="ident" id="617974">tr</span><span class="op" id="617976">.</span><span class="ident" id="617977">CloseIdleConnections</span><span class="op" id="617997">(</span><span class="op" id="617998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618001">client</span>&nbsp;<span class="op" id="618008">:=</span>&nbsp;<span class="op" id="618011">&amp;</span><span class="ident" id="618012">Client</span><span class="op" id="618018">{</span><span class="ident" id="618019">Transport</span><span class="op" id="618028">:</span>&nbsp;<span class="ident" id="618030">tr</span><span class="op" id="618032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618035">res</span><span class="op" id="618038">,</span>&nbsp;<span class="ident" id="618040">err</span>&nbsp;<span class="op" id="618044">:=</span>&nbsp;<span class="ident" id="618047">client</span><span class="op" id="618053">.</span><span class="ident" id="618054">Get</span><span class="op" id="618057">(</span><span class="ident" id="618058">ts</span><span class="op" id="618060">.</span><span class="ident" id="618061">URL</span><span class="op" id="618064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="618067">if</span>&nbsp;<span class="ident" id="618070">err</span>&nbsp;<span class="op" id="618074">!=</span>&nbsp;<span class="ident" id="618077">nil</span>&nbsp;<span class="op" id="618081">{</span><br>
<span class="lineno">2150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618085">t</span><span class="op" id="618086">.</span><span class="ident" id="618087">Fatal</span><span class="op" id="618092">(</span><span class="ident" id="618093">err</span><span class="op" id="618096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="618099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618102">res</span><span class="op" id="618105">.</span><span class="ident" id="618106">Body</span><span class="op" id="618110">.</span><span class="ident" id="618111">Close</span><span class="op" id="618116">(</span><span class="op" id="618117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618120">mu</span><span class="op" id="618122">.</span><span class="ident" id="618123">Lock</span><span class="op" id="618127">(</span><span class="op" id="618128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="618131">if</span>&nbsp;<span class="op" id="618134">!</span><span class="ident" id="618135">gotReq</span>&nbsp;<span class="op" id="618142">{</span><br>
<span class="lineno">2155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618146">t</span><span class="op" id="618147">.</span><span class="ident" id="618148">Error</span><span class="op" id="618153">(</span><span class="string" id="618154">&#34;didn&#39;t&nbsp;get&nbsp;request&#34;</span><span class="op" id="618174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="618177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="618180">if</span>&nbsp;<span class="op" id="618183">!</span><span class="ident" id="618184">didDial</span>&nbsp;<span class="op" id="618192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618196">t</span><span class="op" id="618197">.</span><span class="ident" id="618198">Error</span><span class="op" id="618203">(</span><span class="string" id="618204">&#34;didn&#39;t&nbsp;use&nbsp;dial&nbsp;hook&#34;</span><span class="op" id="618226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="618229">}</span><br>
<span class="lineno">2160</span><span class="op" id="618231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="618234">//&nbsp;Test&nbsp;for&nbsp;issue&nbsp;8755</span><br>
<span class="lineno"></span><span class="comment" id="618257">//&nbsp;Ensure&nbsp;that&nbsp;if&nbsp;a&nbsp;proxy&nbsp;returns&nbsp;an&nbsp;error,&nbsp;it&nbsp;is&nbsp;exposed&nbsp;by&nbsp;RoundTrip</span><br>
<span class="lineno"></span><span class="keyword" id="618328">func</span>&nbsp;<span class="ident" id="618333">TestRoundTripReturnsProxyError</span><span class="op" id="618363">(</span><span class="ident" id="618364">t</span>&nbsp;<span class="op" id="618366">*</span><span class="ident" id="618367">testing</span><span class="op" id="618374">.</span><span class="ident" id="618375">T</span><span class="op" id="618376">)</span>&nbsp;<span class="op" id="618378">{</span><br>
<span class="lineno">2165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618381">badProxy</span>&nbsp;<span class="op" id="618390">:=</span>&nbsp;<span class="keyword" id="618393">func</span><span class="op" id="618397">(</span><span class="op" id="618398">*</span><span class="ident" id="618399">http</span><span class="op" id="618403">.</span><span class="ident" id="618404">Request</span><span class="op" id="618411">)</span>&nbsp;<span class="op" id="618413">(</span><span class="op" id="618414">*</span><span class="ident" id="618415">url</span><span class="op" id="618418">.</span><span class="ident" id="618419">URL</span><span class="op" id="618422">,</span>&nbsp;<span class="builtintype" id="618424">error</span><span class="op" id="618429">)</span>&nbsp;<span class="op" id="618431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="618435">return</span>&nbsp;<span class="ident" id="618442">nil</span><span class="op" id="618445">,</span>&nbsp;<span class="ident" id="618447">errors</span><span class="op" id="618453">.</span><span class="ident" id="618454">New</span><span class="op" id="618457">(</span><span class="string" id="618458">&#34;errorMessage&#34;</span><span class="op" id="618472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="618475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618479">tr</span>&nbsp;<span class="op" id="618482">:=</span>&nbsp;<span class="op" id="618485">&amp;</span><span class="ident" id="618486">Transport</span><span class="op" id="618495">{</span><span class="ident" id="618496">Proxy</span><span class="op" id="618501">:</span>&nbsp;<span class="ident" id="618503">badProxy</span><span class="op" id="618511">}</span><br>
<span class="lineno">2170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618515">req</span><span class="op" id="618518">,</span>&nbsp;<span class="ident" id="618520">_</span>&nbsp;<span class="op" id="618522">:=</span>&nbsp;<span class="ident" id="618525">http</span><span class="op" id="618529">.</span><span class="ident" id="618530">NewRequest</span><span class="op" id="618540">(</span><span class="string" id="618541">&#34;GET&#34;</span><span class="op" id="618546">,</span>&nbsp;<span class="string" id="618548">&#34;http://example.com&#34;</span><span class="op" id="618568">,</span>&nbsp;<span class="ident" id="618570">nil</span><span class="op" id="618573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618577">_</span><span class="op" id="618578">,</span>&nbsp;<span class="ident" id="618580">err</span>&nbsp;<span class="op" id="618584">:=</span>&nbsp;<span class="ident" id="618587">tr</span><span class="op" id="618589">.</span><span class="ident" id="618590">RoundTrip</span><span class="op" id="618599">(</span><span class="ident" id="618600">req</span><span class="op" id="618603">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">2175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="618607">if</span>&nbsp;<span class="ident" id="618610">err</span>&nbsp;<span class="op" id="618614">==</span>&nbsp;<span class="ident" id="618617">nil</span>&nbsp;<span class="op" id="618621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618625">t</span><span class="op" id="618626">.</span><span class="ident" id="618627">Error</span><span class="op" id="618632">(</span><span class="string" id="618633">&#34;Expected&nbsp;proxy&nbsp;error&nbsp;to&nbsp;be&nbsp;returned&nbsp;by&nbsp;RoundTrip&#34;</span><span class="op" id="618683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="618686">}</span><br>
<span class="lineno"></span><span class="op" id="618688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2180</span><span class="comment" id="618691">//&nbsp;tests&nbsp;that&nbsp;putting&nbsp;an&nbsp;idle&nbsp;conn&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;CloseIdleConns&nbsp;does&nbsp;return&nbsp;it</span><br>
<span class="lineno"></span><span class="keyword" id="618772">func</span>&nbsp;<span class="ident" id="618777">TestTransportCloseIdleConnsThenReturn</span><span class="op" id="618814">(</span><span class="ident" id="618815">t</span>&nbsp;<span class="op" id="618817">*</span><span class="ident" id="618818">testing</span><span class="op" id="618825">.</span><span class="ident" id="618826">T</span><span class="op" id="618827">)</span>&nbsp;<span class="op" id="618829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618832">tr</span>&nbsp;<span class="op" id="618835">:=</span>&nbsp;<span class="op" id="618838">&amp;</span><span class="ident" id="618839">Transport</span><span class="op" id="618848">{</span><span class="op" id="618849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618852">wantIdle</span>&nbsp;<span class="op" id="618861">:=</span>&nbsp;<span class="keyword" id="618864">func</span><span class="op" id="618868">(</span><span class="ident" id="618869">when</span>&nbsp;<span class="builtintype" id="618874">string</span><span class="op" id="618880">,</span>&nbsp;<span class="ident" id="618882">n</span>&nbsp;<span class="builtintype" id="618884">int</span><span class="op" id="618887">)</span>&nbsp;<span class="builtintype" id="618889">bool</span>&nbsp;<span class="op" id="618894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="618898">got</span>&nbsp;<span class="op" id="618902">:=</span>&nbsp;<span class="ident" id="618905">tr</span><span class="op" id="618907">.</span><span class="ident" id="618908">IdleConnCountForTesting</span><span class="op" id="618931">(</span><span class="string" id="618932">&#34;|http|example.com&#34;</span><span class="op" id="618951">)</span>&nbsp;<span class="comment" id="618953">//&nbsp;key&nbsp;used&nbsp;by&nbsp;PutIdleTestConn</span><br>
<span class="lineno">2185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="618986">if</span>&nbsp;<span class="ident" id="618989">got</span>&nbsp;<span class="op" id="618993">==</span>&nbsp;<span class="ident" id="618996">n</span>&nbsp;<span class="op" id="618998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619003">return</span>&nbsp;<span class="builtintype" id="619010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619021">t</span><span class="op" id="619022">.</span><span class="ident" id="619023">Errorf</span><span class="op" id="619029">(</span><span class="string" id="619030">&#34;%s:&nbsp;idle&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="619060">,</span>&nbsp;<span class="ident" id="619062">when</span><span class="op" id="619066">,</span>&nbsp;<span class="ident" id="619068">got</span><span class="op" id="619071">,</span>&nbsp;<span class="ident" id="619073">n</span><span class="op" id="619074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619078">return</span>&nbsp;<span class="builtintype" id="619085">false</span><br>
<span class="lineno">2190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619095">wantIdle</span><span class="op" id="619103">(</span><span class="string" id="619104">&#34;start&#34;</span><span class="op" id="619111">,</span>&nbsp;<span class="num" id="619113">0</span><span class="op" id="619114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619117">if</span>&nbsp;<span class="op" id="619120">!</span><span class="ident" id="619121">tr</span><span class="op" id="619123">.</span><span class="ident" id="619124">PutIdleTestConn</span><span class="op" id="619139">(</span><span class="op" id="619140">)</span>&nbsp;<span class="op" id="619142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619146">t</span><span class="op" id="619147">.</span><span class="ident" id="619148">Fatal</span><span class="op" id="619153">(</span><span class="string" id="619154">&#34;put&nbsp;failed&#34;</span><span class="op" id="619166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619169">}</span><br>
<span class="lineno">2195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619172">if</span>&nbsp;<span class="op" id="619175">!</span><span class="ident" id="619176">tr</span><span class="op" id="619178">.</span><span class="ident" id="619179">PutIdleTestConn</span><span class="op" id="619194">(</span><span class="op" id="619195">)</span>&nbsp;<span class="op" id="619197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619201">t</span><span class="op" id="619202">.</span><span class="ident" id="619203">Fatal</span><span class="op" id="619208">(</span><span class="string" id="619209">&#34;second&nbsp;put&nbsp;failed&#34;</span><span class="op" id="619228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619234">wantIdle</span><span class="op" id="619242">(</span><span class="string" id="619243">&#34;after&nbsp;put&#34;</span><span class="op" id="619254">,</span>&nbsp;<span class="num" id="619256">2</span><span class="op" id="619257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619260">tr</span><span class="op" id="619262">.</span><span class="ident" id="619263">CloseIdleConnections</span><span class="op" id="619283">(</span><span class="op" id="619284">)</span><br>
<span class="lineno">2200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619287">if</span>&nbsp;<span class="op" id="619290">!</span><span class="ident" id="619291">tr</span><span class="op" id="619293">.</span><span class="ident" id="619294">IsIdleForTesting</span><span class="op" id="619310">(</span><span class="op" id="619311">)</span>&nbsp;<span class="op" id="619313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619317">t</span><span class="op" id="619318">.</span><span class="ident" id="619319">Error</span><span class="op" id="619324">(</span><span class="string" id="619325">&#34;should&nbsp;be&nbsp;idle&nbsp;after&nbsp;CloseIdleConnections&#34;</span><span class="op" id="619368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619374">wantIdle</span><span class="op" id="619382">(</span><span class="string" id="619383">&#34;after&nbsp;close&nbsp;idle&#34;</span><span class="op" id="619401">,</span>&nbsp;<span class="num" id="619403">0</span><span class="op" id="619404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619407">if</span>&nbsp;<span class="ident" id="619410">tr</span><span class="op" id="619412">.</span><span class="ident" id="619413">PutIdleTestConn</span><span class="op" id="619428">(</span><span class="op" id="619429">)</span>&nbsp;<span class="op" id="619431">{</span><br>
<span class="lineno">2205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619435">t</span><span class="op" id="619436">.</span><span class="ident" id="619437">Fatal</span><span class="op" id="619442">(</span><span class="string" id="619443">&#34;put&nbsp;didn&#39;t&nbsp;fail&#34;</span><span class="op" id="619460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619466">wantIdle</span><span class="op" id="619474">(</span><span class="string" id="619475">&#34;after&nbsp;second&nbsp;put&#34;</span><span class="op" id="619493">,</span>&nbsp;<span class="num" id="619495">0</span><span class="op" id="619496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619500">tr</span><span class="op" id="619502">.</span><span class="ident" id="619503">RequestIdleConnChForTesting</span><span class="op" id="619530">(</span><span class="op" id="619531">)</span>&nbsp;<span class="comment" id="619533">//&nbsp;should&nbsp;toggle&nbsp;the&nbsp;transport&nbsp;out&nbsp;of&nbsp;idle&nbsp;mode</span><br>
<span class="lineno">2210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619582">if</span>&nbsp;<span class="ident" id="619585">tr</span><span class="op" id="619587">.</span><span class="ident" id="619588">IsIdleForTesting</span><span class="op" id="619604">(</span><span class="op" id="619605">)</span>&nbsp;<span class="op" id="619607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619611">t</span><span class="op" id="619612">.</span><span class="ident" id="619613">Error</span><span class="op" id="619618">(</span><span class="string" id="619619">&#34;shouldn&#39;t&nbsp;be&nbsp;idle&nbsp;after&nbsp;RequestIdleConnChForTesting&#34;</span><span class="op" id="619672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="619678">if</span>&nbsp;<span class="op" id="619681">!</span><span class="ident" id="619682">tr</span><span class="op" id="619684">.</span><span class="ident" id="619685">PutIdleTestConn</span><span class="op" id="619700">(</span><span class="op" id="619701">)</span>&nbsp;<span class="op" id="619703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619707">t</span><span class="op" id="619708">.</span><span class="ident" id="619709">Fatal</span><span class="op" id="619714">(</span><span class="string" id="619715">&#34;after&nbsp;re-activation&#34;</span><span class="op" id="619736">)</span><br>
<span class="lineno">2215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="619739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="619742">wantIdle</span><span class="op" id="619750">(</span><span class="string" id="619751">&#34;after&nbsp;final&nbsp;put&#34;</span><span class="op" id="619768">,</span>&nbsp;<span class="num" id="619770">1</span><span class="op" id="619771">)</span><br>
<span class="lineno"></span><span class="op" id="619773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="619776">//&nbsp;This&nbsp;tests&nbsp;that&nbsp;an&nbsp;client&nbsp;requesting&nbsp;a&nbsp;content&nbsp;range&nbsp;won&#39;t&nbsp;also</span><br>
<span class="lineno">2220</span><span class="comment" id="619843">//&nbsp;implicitly&nbsp;ask&nbsp;for&nbsp;gzip&nbsp;support.&nbsp;If&nbsp;they&nbsp;want&nbsp;that,&nbsp;they&nbsp;need&nbsp;to&nbsp;do&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="619917">//&nbsp;on&nbsp;their&nbsp;own.</span><br>
<span class="lineno"></span><span class="comment" id="619934">//&nbsp;golang.org/issue/8923</span><br>
<span class="lineno"></span><span class="keyword" id="619959">func</span>&nbsp;<span class="ident" id="619964">TestTransportRangeAndGzip</span><span class="op" id="619989">(</span><span class="ident" id="619990">t</span>&nbsp;<span class="op" id="619992">*</span><span class="ident" id="619993">testing</span><span class="op" id="620000">.</span><span class="ident" id="620001">T</span><span class="op" id="620002">)</span>&nbsp;<span class="op" id="620004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620007">defer</span>&nbsp;<span class="ident" id="620013">afterTest</span><span class="op" id="620022">(</span><span class="ident" id="620023">t</span><span class="op" id="620024">)</span><br>
<span class="lineno">2225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620027">reqc</span>&nbsp;<span class="op" id="620032">:=</span>&nbsp;<span class="builtinfunc" id="620035">make</span><span class="op" id="620039">(</span><span class="keyword" id="620040">chan</span>&nbsp;<span class="op" id="620045">*</span><span class="ident" id="620046">Request</span><span class="op" id="620053">,</span>&nbsp;<span class="num" id="620055">1</span><span class="op" id="620056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620059">ts</span>&nbsp;<span class="op" id="620062">:=</span>&nbsp;<span class="ident" id="620065">httptest</span><span class="op" id="620073">.</span><span class="ident" id="620074">NewServer</span><span class="op" id="620083">(</span><span class="ident" id="620084">HandlerFunc</span><span class="op" id="620095">(</span><span class="keyword" id="620096">func</span><span class="op" id="620100">(</span><span class="ident" id="620101">w</span>&nbsp;<span class="ident" id="620103">ResponseWriter</span><span class="op" id="620117">,</span>&nbsp;<span class="ident" id="620119">r</span>&nbsp;<span class="op" id="620121">*</span><span class="ident" id="620122">Request</span><span class="op" id="620129">)</span>&nbsp;<span class="op" id="620131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620135">reqc</span>&nbsp;<span class="op" id="620140">&lt;-</span>&nbsp;<span class="ident" id="620143">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620146">}</span><span class="op" id="620147">)</span><span class="op" id="620148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620151">defer</span>&nbsp;<span class="ident" id="620157">ts</span><span class="op" id="620159">.</span><span class="ident" id="620160">Close</span><span class="op" id="620165">(</span><span class="op" id="620166">)</span><br>
<span class="lineno">2230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620170">req</span><span class="op" id="620173">,</span>&nbsp;<span class="ident" id="620175">_</span>&nbsp;<span class="op" id="620177">:=</span>&nbsp;<span class="ident" id="620180">NewRequest</span><span class="op" id="620190">(</span><span class="string" id="620191">&#34;GET&#34;</span><span class="op" id="620196">,</span>&nbsp;<span class="ident" id="620198">ts</span><span class="op" id="620200">.</span><span class="ident" id="620201">URL</span><span class="op" id="620204">,</span>&nbsp;<span class="ident" id="620206">nil</span><span class="op" id="620209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620212">req</span><span class="op" id="620215">.</span><span class="ident" id="620216">Header</span><span class="op" id="620222">.</span><span class="ident" id="620223">Set</span><span class="op" id="620226">(</span><span class="string" id="620227">&#34;Range&#34;</span><span class="op" id="620234">,</span>&nbsp;<span class="string" id="620236">&#34;bytes=7-11&#34;</span><span class="op" id="620248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620251">res</span><span class="op" id="620254">,</span>&nbsp;<span class="ident" id="620256">err</span>&nbsp;<span class="op" id="620260">:=</span>&nbsp;<span class="ident" id="620263">DefaultClient</span><span class="op" id="620276">.</span><span class="ident" id="620277">Do</span><span class="op" id="620279">(</span><span class="ident" id="620280">req</span><span class="op" id="620283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620286">if</span>&nbsp;<span class="ident" id="620289">err</span>&nbsp;<span class="op" id="620293">!=</span>&nbsp;<span class="ident" id="620296">nil</span>&nbsp;<span class="op" id="620300">{</span><br>
<span class="lineno">2235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620304">t</span><span class="op" id="620305">.</span><span class="ident" id="620306">Fatal</span><span class="op" id="620311">(</span><span class="ident" id="620312">err</span><span class="op" id="620315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620322">select</span>&nbsp;<span class="op" id="620329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620332">case</span>&nbsp;<span class="ident" id="620337">r</span>&nbsp;<span class="op" id="620339">:=</span>&nbsp;<span class="op" id="620342">&lt;-</span><span class="ident" id="620344">reqc</span><span class="op" id="620348">:</span><br>
<span class="lineno">2240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620352">if</span>&nbsp;<span class="ident" id="620355">strings</span><span class="op" id="620362">.</span><span class="ident" id="620363">Contains</span><span class="op" id="620371">(</span><span class="ident" id="620372">r</span><span class="op" id="620373">.</span><span class="ident" id="620374">Header</span><span class="op" id="620380">.</span><span class="ident" id="620381">Get</span><span class="op" id="620384">(</span><span class="string" id="620385">&#34;Accept-Encoding&#34;</span><span class="op" id="620402">)</span><span class="op" id="620403">,</span>&nbsp;<span class="string" id="620405">&#34;gzip&#34;</span><span class="op" id="620411">)</span>&nbsp;<span class="op" id="620413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620418">t</span><span class="op" id="620419">.</span><span class="ident" id="620420">Error</span><span class="op" id="620425">(</span><span class="string" id="620426">&#34;Transport&nbsp;advertised&nbsp;gzip&nbsp;support&nbsp;in&nbsp;the&nbsp;Accept&nbsp;header&#34;</span><span class="op" id="620482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620490">if</span>&nbsp;<span class="ident" id="620493">r</span><span class="op" id="620494">.</span><span class="ident" id="620495">Header</span><span class="op" id="620501">.</span><span class="ident" id="620502">Get</span><span class="op" id="620505">(</span><span class="string" id="620506">&#34;Range&#34;</span><span class="op" id="620513">)</span>&nbsp;<span class="op" id="620515">==</span>&nbsp;<span class="string" id="620518">&#34;&#34;</span>&nbsp;<span class="op" id="620521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620526">t</span><span class="op" id="620527">.</span><span class="ident" id="620528">Error</span><span class="op" id="620533">(</span><span class="string" id="620534">&#34;no&nbsp;Range&nbsp;in&nbsp;request&#34;</span><span class="op" id="620555">)</span><br>
<span class="lineno">2245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620562">case</span>&nbsp;<span class="op" id="620567">&lt;-</span><span class="ident" id="620569">time</span><span class="op" id="620573">.</span><span class="ident" id="620574">After</span><span class="op" id="620579">(</span><span class="num" id="620580">10</span>&nbsp;<span class="op" id="620583">*</span>&nbsp;<span class="ident" id="620585">time</span><span class="op" id="620589">.</span><span class="ident" id="620590">Second</span><span class="op" id="620596">)</span><span class="op" id="620597">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620601">t</span><span class="op" id="620602">.</span><span class="ident" id="620603">Fatal</span><span class="op" id="620608">(</span><span class="string" id="620609">&#34;timeout&#34;</span><span class="op" id="620618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620624">res</span><span class="op" id="620627">.</span><span class="ident" id="620628">Body</span><span class="op" id="620632">.</span><span class="ident" id="620633">Close</span><span class="op" id="620638">(</span><span class="op" id="620639">)</span><br>
<span class="lineno">2250</span><span class="op" id="620641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="620644">func</span>&nbsp;<span class="ident" id="620649">wantBody</span><span class="op" id="620657">(</span><span class="ident" id="620658">res</span>&nbsp;<span class="op" id="620662">*</span><span class="ident" id="620663">http</span><span class="op" id="620667">.</span><span class="ident" id="620668">Response</span><span class="op" id="620676">,</span>&nbsp;<span class="ident" id="620678">err</span>&nbsp;<span class="builtintype" id="620682">error</span><span class="op" id="620687">,</span>&nbsp;<span class="ident" id="620689">want</span>&nbsp;<span class="builtintype" id="620694">string</span><span class="op" id="620700">)</span>&nbsp;<span class="builtintype" id="620702">error</span>&nbsp;<span class="op" id="620708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620711">if</span>&nbsp;<span class="ident" id="620714">err</span>&nbsp;<span class="op" id="620718">!=</span>&nbsp;<span class="ident" id="620721">nil</span>&nbsp;<span class="op" id="620725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620729">return</span>&nbsp;<span class="ident" id="620736">err</span><br>
<span class="lineno">2255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="620744">slurp</span><span class="op" id="620749">,</span>&nbsp;<span class="ident" id="620751">err</span>&nbsp;<span class="op" id="620755">:=</span>&nbsp;<span class="ident" id="620758">ioutil</span><span class="op" id="620764">.</span><span class="ident" id="620765">ReadAll</span><span class="op" id="620772">(</span><span class="ident" id="620773">res</span><span class="op" id="620776">.</span><span class="ident" id="620777">Body</span><span class="op" id="620781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620784">if</span>&nbsp;<span class="ident" id="620787">err</span>&nbsp;<span class="op" id="620791">!=</span>&nbsp;<span class="ident" id="620794">nil</span>&nbsp;<span class="op" id="620798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620802">return</span>&nbsp;<span class="ident" id="620809">fmt</span><span class="op" id="620812">.</span><span class="ident" id="620813">Errorf</span><span class="op" id="620819">(</span><span class="string" id="620820">&#34;error&nbsp;reading&nbsp;body:&nbsp;%v&#34;</span><span class="op" id="620844">,</span>&nbsp;<span class="ident" id="620846">err</span><span class="op" id="620849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620852">}</span><br>
<span class="lineno">2260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620855">if</span>&nbsp;<span class="builtintype" id="620858">string</span><span class="op" id="620864">(</span><span class="ident" id="620865">slurp</span><span class="op" id="620870">)</span>&nbsp;<span class="op" id="620872">!=</span>&nbsp;<span class="ident" id="620875">want</span>&nbsp;<span class="op" id="620880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620884">return</span>&nbsp;<span class="ident" id="620891">fmt</span><span class="op" id="620894">.</span><span class="ident" id="620895">Errorf</span><span class="op" id="620901">(</span><span class="string" id="620902">&#34;body&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="620922">,</span>&nbsp;<span class="ident" id="620924">slurp</span><span class="op" id="620929">,</span>&nbsp;<span class="ident" id="620931">want</span><span class="op" id="620935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="620938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620941">if</span>&nbsp;<span class="ident" id="620944">err</span>&nbsp;<span class="op" id="620948">:=</span>&nbsp;<span class="ident" id="620951">res</span><span class="op" id="620954">.</span><span class="ident" id="620955">Body</span><span class="op" id="620959">.</span><span class="ident" id="620960">Close</span><span class="op" id="620965">(</span><span class="op" id="620966">)</span><span class="op" id="620967">;</span>&nbsp;<span class="ident" id="620969">err</span>&nbsp;<span class="op" id="620973">!=</span>&nbsp;<span class="ident" id="620976">nil</span>&nbsp;<span class="op" id="620980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="620984">return</span>&nbsp;<span class="ident" id="620991">fmt</span><span class="op" id="620994">.</span><span class="ident" id="620995">Errorf</span><span class="op" id="621001">(</span><span class="string" id="621002">&#34;body&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="621019">,</span>&nbsp;<span class="ident" id="621021">err</span><span class="op" id="621024">)</span><br>
<span class="lineno">2265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="621027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="621030">return</span>&nbsp;<span class="ident" id="621037">nil</span><br>
<span class="lineno"></span><span class="op" id="621041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="621044">func</span>&nbsp;<span class="ident" id="621049">newLocalListener</span><span class="op" id="621065">(</span><span class="ident" id="621066">t</span>&nbsp;<span class="op" id="621068">*</span><span class="ident" id="621069">testing</span><span class="op" id="621076">.</span><span class="ident" id="621077">T</span><span class="op" id="621078">)</span>&nbsp;<span class="ident" id="621080">net</span><span class="op" id="621083">.</span><span class="ident" id="621084">Listener</span>&nbsp;<span class="op" id="621093">{</span><br>
<span class="lineno">2270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="621096">ln</span><span class="op" id="621098">,</span>&nbsp;<span class="ident" id="621100">err</span>&nbsp;<span class="op" id="621104">:=</span>&nbsp;<span class="ident" id="621107">net</span><span class="op" id="621110">.</span><span class="ident" id="621111">Listen</span><span class="op" id="621117">(</span><span class="string" id="621118">&#34;tcp&#34;</span><span class="op" id="621123">,</span>&nbsp;<span class="string" id="621125">&#34;127.0.0.1:0&#34;</span><span class="op" id="621138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="621141">if</span>&nbsp;<span class="ident" id="621144">err</span>&nbsp;<span class="op" id="621148">!=</span>&nbsp;<span class="ident" id="621151">nil</span>&nbsp;<span class="op" id="621155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="621159">ln</span><span class="op" id="621161">,</span>&nbsp;<span class="ident" id="621163">err</span>&nbsp;<span class="op" id="621167">=</span>&nbsp;<span class="ident" id="621169">net</span><span class="op" id="621172">.</span><span class="ident" id="621173">Listen</span><span class="op" id="621179">(</span><span class="string" id="621180">&#34;tcp6&#34;</span><span class="op" id="621186">,</span>&nbsp;<span class="string" id="621188">&#34;[::1]:0&#34;</span><span class="op" id="621197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="621200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="621203">if</span>&nbsp;<span class="ident" id="621206">err</span>&nbsp;<span class="op" id="621210">!=</span>&nbsp;<span class="ident" id="621213">nil</span>&nbsp;<span class="op" id="621217">{</span><br>
<span class="lineno">2275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="621221">t</span><span class="op" id="621222">.</span><span class="ident" id="621223">Fatal</span><span class="op" id="621228">(</span><span class="ident" id="621229">err</span><span class="op" id="621232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="621235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="621238">return</span>&nbsp;<span class="ident" id="621245">ln</span><br>
<span class="lineno"></span><span class="op" id="621248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2280</span><span class="keyword" id="621251">type</span>&nbsp;<span class="ident" id="621256">countCloseReader</span>&nbsp;<span class="keyword" id="621273">struct</span>&nbsp;<span class="op" id="621280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="621283">n</span>&nbsp;<span class="op" id="621285">*</span><span class="builtintype" id="621286">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="621291">io</span><span class="op" id="621293">.</span><span class="ident" id="621294">Reader</span><br>
<span class="lineno"></span><span class="op" id="621301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2285</span><span class="keyword" id="621304">func</span>&nbsp;<span class="op" id="621309">(</span><span class="ident" id="621310">cr</span>&nbsp;<span class="ident" id="621313">countCloseReader</span><span class="op" id="621329">)</span>&nbsp;<span class="ident" id="621331">Close</span><span class="op" id="621336">(</span><span class="op" id="621337">)</span>&nbsp;<span class="builtintype" id="621339">error</span>&nbsp;<span class="op" id="621345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="621348">(</span><span class="op" id="621349">*</span><span class="ident" id="621350">cr</span><span class="op" id="621352">.</span><span class="ident" id="621353">n</span><span class="op" id="621354">)</span><span class="op" id="621355">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="621359">return</span>&nbsp;<span class="ident" id="621366">nil</span><br>
<span class="lineno"></span><span class="op" id="621370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2290</span><span class="comment" id="621373">//&nbsp;rgz&nbsp;is&nbsp;a&nbsp;gzip&nbsp;quine&nbsp;that&nbsp;uncompresses&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span><span class="keyword" id="621425">var</span>&nbsp;<span class="ident" id="621429">rgz</span>&nbsp;<span class="op" id="621433">=</span>&nbsp;<span class="op" id="621435">[</span><span class="op" id="621436">]</span><span class="builtintype" id="621437">byte</span><span class="op" id="621441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621444">0x1f</span><span class="op" id="621448">,</span>&nbsp;<span class="num" id="621450">0x8b</span><span class="op" id="621454">,</span>&nbsp;<span class="num" id="621456">0x08</span><span class="op" id="621460">,</span>&nbsp;<span class="num" id="621462">0x08</span><span class="op" id="621466">,</span>&nbsp;<span class="num" id="621468">0x00</span><span class="op" id="621472">,</span>&nbsp;<span class="num" id="621474">0x00</span><span class="op" id="621478">,</span>&nbsp;<span class="num" id="621480">0x00</span><span class="op" id="621484">,</span>&nbsp;<span class="num" id="621486">0x00</span><span class="op" id="621490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621493">0x00</span><span class="op" id="621497">,</span>&nbsp;<span class="num" id="621499">0x00</span><span class="op" id="621503">,</span>&nbsp;<span class="num" id="621505">0x72</span><span class="op" id="621509">,</span>&nbsp;<span class="num" id="621511">0x65</span><span class="op" id="621515">,</span>&nbsp;<span class="num" id="621517">0x63</span><span class="op" id="621521">,</span>&nbsp;<span class="num" id="621523">0x75</span><span class="op" id="621527">,</span>&nbsp;<span class="num" id="621529">0x72</span><span class="op" id="621533">,</span>&nbsp;<span class="num" id="621535">0x73</span><span class="op" id="621539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621542">0x69</span><span class="op" id="621546">,</span>&nbsp;<span class="num" id="621548">0x76</span><span class="op" id="621552">,</span>&nbsp;<span class="num" id="621554">0x65</span><span class="op" id="621558">,</span>&nbsp;<span class="num" id="621560">0x00</span><span class="op" id="621564">,</span>&nbsp;<span class="num" id="621566">0x92</span><span class="op" id="621570">,</span>&nbsp;<span class="num" id="621572">0xef</span><span class="op" id="621576">,</span>&nbsp;<span class="num" id="621578">0xe6</span><span class="op" id="621582">,</span>&nbsp;<span class="num" id="621584">0xe0</span><span class="op" id="621588">,</span><br>
<span class="lineno">2295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621591">0x60</span><span class="op" id="621595">,</span>&nbsp;<span class="num" id="621597">0x00</span><span class="op" id="621601">,</span>&nbsp;<span class="num" id="621603">0x83</span><span class="op" id="621607">,</span>&nbsp;<span class="num" id="621609">0xa2</span><span class="op" id="621613">,</span>&nbsp;<span class="num" id="621615">0xd4</span><span class="op" id="621619">,</span>&nbsp;<span class="num" id="621621">0xe4</span><span class="op" id="621625">,</span>&nbsp;<span class="num" id="621627">0xd2</span><span class="op" id="621631">,</span>&nbsp;<span class="num" id="621633">0xa2</span><span class="op" id="621637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621640">0xe2</span><span class="op" id="621644">,</span>&nbsp;<span class="num" id="621646">0xcc</span><span class="op" id="621650">,</span>&nbsp;<span class="num" id="621652">0xb2</span><span class="op" id="621656">,</span>&nbsp;<span class="num" id="621658">0x54</span><span class="op" id="621662">,</span>&nbsp;<span class="num" id="621664">0x06</span><span class="op" id="621668">,</span>&nbsp;<span class="num" id="621670">0x00</span><span class="op" id="621674">,</span>&nbsp;<span class="num" id="621676">0x00</span><span class="op" id="621680">,</span>&nbsp;<span class="num" id="621682">0x17</span><span class="op" id="621686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621689">0x00</span><span class="op" id="621693">,</span>&nbsp;<span class="num" id="621695">0xe8</span><span class="op" id="621699">,</span>&nbsp;<span class="num" id="621701">0xff</span><span class="op" id="621705">,</span>&nbsp;<span class="num" id="621707">0x92</span><span class="op" id="621711">,</span>&nbsp;<span class="num" id="621713">0xef</span><span class="op" id="621717">,</span>&nbsp;<span class="num" id="621719">0xe6</span><span class="op" id="621723">,</span>&nbsp;<span class="num" id="621725">0xe0</span><span class="op" id="621729">,</span>&nbsp;<span class="num" id="621731">0x60</span><span class="op" id="621735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621738">0x00</span><span class="op" id="621742">,</span>&nbsp;<span class="num" id="621744">0x83</span><span class="op" id="621748">,</span>&nbsp;<span class="num" id="621750">0xa2</span><span class="op" id="621754">,</span>&nbsp;<span class="num" id="621756">0xd4</span><span class="op" id="621760">,</span>&nbsp;<span class="num" id="621762">0xe4</span><span class="op" id="621766">,</span>&nbsp;<span class="num" id="621768">0xd2</span><span class="op" id="621772">,</span>&nbsp;<span class="num" id="621774">0xa2</span><span class="op" id="621778">,</span>&nbsp;<span class="num" id="621780">0xe2</span><span class="op" id="621784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621787">0xcc</span><span class="op" id="621791">,</span>&nbsp;<span class="num" id="621793">0xb2</span><span class="op" id="621797">,</span>&nbsp;<span class="num" id="621799">0x54</span><span class="op" id="621803">,</span>&nbsp;<span class="num" id="621805">0x06</span><span class="op" id="621809">,</span>&nbsp;<span class="num" id="621811">0x00</span><span class="op" id="621815">,</span>&nbsp;<span class="num" id="621817">0x00</span><span class="op" id="621821">,</span>&nbsp;<span class="num" id="621823">0x17</span><span class="op" id="621827">,</span>&nbsp;<span class="num" id="621829">0x00</span><span class="op" id="621833">,</span><br>
<span class="lineno">2300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621836">0xe8</span><span class="op" id="621840">,</span>&nbsp;<span class="num" id="621842">0xff</span><span class="op" id="621846">,</span>&nbsp;<span class="num" id="621848">0x42</span><span class="op" id="621852">,</span>&nbsp;<span class="num" id="621854">0x12</span><span class="op" id="621858">,</span>&nbsp;<span class="num" id="621860">0x46</span><span class="op" id="621864">,</span>&nbsp;<span class="num" id="621866">0x16</span><span class="op" id="621870">,</span>&nbsp;<span class="num" id="621872">0x06</span><span class="op" id="621876">,</span>&nbsp;<span class="num" id="621878">0x00</span><span class="op" id="621882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621885">0x05</span><span class="op" id="621889">,</span>&nbsp;<span class="num" id="621891">0x00</span><span class="op" id="621895">,</span>&nbsp;<span class="num" id="621897">0xfa</span><span class="op" id="621901">,</span>&nbsp;<span class="num" id="621903">0xff</span><span class="op" id="621907">,</span>&nbsp;<span class="num" id="621909">0x42</span><span class="op" id="621913">,</span>&nbsp;<span class="num" id="621915">0x12</span><span class="op" id="621919">,</span>&nbsp;<span class="num" id="621921">0x46</span><span class="op" id="621925">,</span>&nbsp;<span class="num" id="621927">0x16</span><span class="op" id="621931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621934">0x06</span><span class="op" id="621938">,</span>&nbsp;<span class="num" id="621940">0x00</span><span class="op" id="621944">,</span>&nbsp;<span class="num" id="621946">0x05</span><span class="op" id="621950">,</span>&nbsp;<span class="num" id="621952">0x00</span><span class="op" id="621956">,</span>&nbsp;<span class="num" id="621958">0xfa</span><span class="op" id="621962">,</span>&nbsp;<span class="num" id="621964">0xff</span><span class="op" id="621968">,</span>&nbsp;<span class="num" id="621970">0x00</span><span class="op" id="621974">,</span>&nbsp;<span class="num" id="621976">0x05</span><span class="op" id="621980">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="621983">0x00</span><span class="op" id="621987">,</span>&nbsp;<span class="num" id="621989">0xfa</span><span class="op" id="621993">,</span>&nbsp;<span class="num" id="621995">0xff</span><span class="op" id="621999">,</span>&nbsp;<span class="num" id="622001">0x00</span><span class="op" id="622005">,</span>&nbsp;<span class="num" id="622007">0x14</span><span class="op" id="622011">,</span>&nbsp;<span class="num" id="622013">0x00</span><span class="op" id="622017">,</span>&nbsp;<span class="num" id="622019">0xeb</span><span class="op" id="622023">,</span>&nbsp;<span class="num" id="622025">0xff</span><span class="op" id="622029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622032">0x42</span><span class="op" id="622036">,</span>&nbsp;<span class="num" id="622038">0x12</span><span class="op" id="622042">,</span>&nbsp;<span class="num" id="622044">0x46</span><span class="op" id="622048">,</span>&nbsp;<span class="num" id="622050">0x16</span><span class="op" id="622054">,</span>&nbsp;<span class="num" id="622056">0x06</span><span class="op" id="622060">,</span>&nbsp;<span class="num" id="622062">0x00</span><span class="op" id="622066">,</span>&nbsp;<span class="num" id="622068">0x05</span><span class="op" id="622072">,</span>&nbsp;<span class="num" id="622074">0x00</span><span class="op" id="622078">,</span><br>
<span class="lineno">2305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622081">0xfa</span><span class="op" id="622085">,</span>&nbsp;<span class="num" id="622087">0xff</span><span class="op" id="622091">,</span>&nbsp;<span class="num" id="622093">0x00</span><span class="op" id="622097">,</span>&nbsp;<span class="num" id="622099">0x05</span><span class="op" id="622103">,</span>&nbsp;<span class="num" id="622105">0x00</span><span class="op" id="622109">,</span>&nbsp;<span class="num" id="622111">0xfa</span><span class="op" id="622115">,</span>&nbsp;<span class="num" id="622117">0xff</span><span class="op" id="622121">,</span>&nbsp;<span class="num" id="622123">0x00</span><span class="op" id="622127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622130">0x14</span><span class="op" id="622134">,</span>&nbsp;<span class="num" id="622136">0x00</span><span class="op" id="622140">,</span>&nbsp;<span class="num" id="622142">0xeb</span><span class="op" id="622146">,</span>&nbsp;<span class="num" id="622148">0xff</span><span class="op" id="622152">,</span>&nbsp;<span class="num" id="622154">0x42</span><span class="op" id="622158">,</span>&nbsp;<span class="num" id="622160">0x88</span><span class="op" id="622164">,</span>&nbsp;<span class="num" id="622166">0x21</span><span class="op" id="622170">,</span>&nbsp;<span class="num" id="622172">0xc4</span><span class="op" id="622176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622179">0x00</span><span class="op" id="622183">,</span>&nbsp;<span class="num" id="622185">0x00</span><span class="op" id="622189">,</span>&nbsp;<span class="num" id="622191">0x14</span><span class="op" id="622195">,</span>&nbsp;<span class="num" id="622197">0x00</span><span class="op" id="622201">,</span>&nbsp;<span class="num" id="622203">0xeb</span><span class="op" id="622207">,</span>&nbsp;<span class="num" id="622209">0xff</span><span class="op" id="622213">,</span>&nbsp;<span class="num" id="622215">0x42</span><span class="op" id="622219">,</span>&nbsp;<span class="num" id="622221">0x88</span><span class="op" id="622225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622228">0x21</span><span class="op" id="622232">,</span>&nbsp;<span class="num" id="622234">0xc4</span><span class="op" id="622238">,</span>&nbsp;<span class="num" id="622240">0x00</span><span class="op" id="622244">,</span>&nbsp;<span class="num" id="622246">0x00</span><span class="op" id="622250">,</span>&nbsp;<span class="num" id="622252">0x14</span><span class="op" id="622256">,</span>&nbsp;<span class="num" id="622258">0x00</span><span class="op" id="622262">,</span>&nbsp;<span class="num" id="622264">0xeb</span><span class="op" id="622268">,</span>&nbsp;<span class="num" id="622270">0xff</span><span class="op" id="622274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622277">0x42</span><span class="op" id="622281">,</span>&nbsp;<span class="num" id="622283">0x88</span><span class="op" id="622287">,</span>&nbsp;<span class="num" id="622289">0x21</span><span class="op" id="622293">,</span>&nbsp;<span class="num" id="622295">0xc4</span><span class="op" id="622299">,</span>&nbsp;<span class="num" id="622301">0x00</span><span class="op" id="622305">,</span>&nbsp;<span class="num" id="622307">0x00</span><span class="op" id="622311">,</span>&nbsp;<span class="num" id="622313">0x14</span><span class="op" id="622317">,</span>&nbsp;<span class="num" id="622319">0x00</span><span class="op" id="622323">,</span><br>
<span class="lineno">2310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622326">0xeb</span><span class="op" id="622330">,</span>&nbsp;<span class="num" id="622332">0xff</span><span class="op" id="622336">,</span>&nbsp;<span class="num" id="622338">0x42</span><span class="op" id="622342">,</span>&nbsp;<span class="num" id="622344">0x88</span><span class="op" id="622348">,</span>&nbsp;<span class="num" id="622350">0x21</span><span class="op" id="622354">,</span>&nbsp;<span class="num" id="622356">0xc4</span><span class="op" id="622360">,</span>&nbsp;<span class="num" id="622362">0x00</span><span class="op" id="622366">,</span>&nbsp;<span class="num" id="622368">0x00</span><span class="op" id="622372">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622375">0x14</span><span class="op" id="622379">,</span>&nbsp;<span class="num" id="622381">0x00</span><span class="op" id="622385">,</span>&nbsp;<span class="num" id="622387">0xeb</span><span class="op" id="622391">,</span>&nbsp;<span class="num" id="622393">0xff</span><span class="op" id="622397">,</span>&nbsp;<span class="num" id="622399">0x42</span><span class="op" id="622403">,</span>&nbsp;<span class="num" id="622405">0x88</span><span class="op" id="622409">,</span>&nbsp;<span class="num" id="622411">0x21</span><span class="op" id="622415">,</span>&nbsp;<span class="num" id="622417">0xc4</span><span class="op" id="622421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622424">0x00</span><span class="op" id="622428">,</span>&nbsp;<span class="num" id="622430">0x00</span><span class="op" id="622434">,</span>&nbsp;<span class="num" id="622436">0x00</span><span class="op" id="622440">,</span>&nbsp;<span class="num" id="622442">0x00</span><span class="op" id="622446">,</span>&nbsp;<span class="num" id="622448">0xff</span><span class="op" id="622452">,</span>&nbsp;<span class="num" id="622454">0xff</span><span class="op" id="622458">,</span>&nbsp;<span class="num" id="622460">0x00</span><span class="op" id="622464">,</span>&nbsp;<span class="num" id="622466">0x00</span><span class="op" id="622470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622473">0x00</span><span class="op" id="622477">,</span>&nbsp;<span class="num" id="622479">0xff</span><span class="op" id="622483">,</span>&nbsp;<span class="num" id="622485">0xff</span><span class="op" id="622489">,</span>&nbsp;<span class="num" id="622491">0x00</span><span class="op" id="622495">,</span>&nbsp;<span class="num" id="622497">0x17</span><span class="op" id="622501">,</span>&nbsp;<span class="num" id="622503">0x00</span><span class="op" id="622507">,</span>&nbsp;<span class="num" id="622509">0xe8</span><span class="op" id="622513">,</span>&nbsp;<span class="num" id="622515">0xff</span><span class="op" id="622519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622522">0x42</span><span class="op" id="622526">,</span>&nbsp;<span class="num" id="622528">0x88</span><span class="op" id="622532">,</span>&nbsp;<span class="num" id="622534">0x21</span><span class="op" id="622538">,</span>&nbsp;<span class="num" id="622540">0xc4</span><span class="op" id="622544">,</span>&nbsp;<span class="num" id="622546">0x00</span><span class="op" id="622550">,</span>&nbsp;<span class="num" id="622552">0x00</span><span class="op" id="622556">,</span>&nbsp;<span class="num" id="622558">0x00</span><span class="op" id="622562">,</span>&nbsp;<span class="num" id="622564">0x00</span><span class="op" id="622568">,</span><br>
<span class="lineno">2315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622571">0xff</span><span class="op" id="622575">,</span>&nbsp;<span class="num" id="622577">0xff</span><span class="op" id="622581">,</span>&nbsp;<span class="num" id="622583">0x00</span><span class="op" id="622587">,</span>&nbsp;<span class="num" id="622589">0x00</span><span class="op" id="622593">,</span>&nbsp;<span class="num" id="622595">0x00</span><span class="op" id="622599">,</span>&nbsp;<span class="num" id="622601">0xff</span><span class="op" id="622605">,</span>&nbsp;<span class="num" id="622607">0xff</span><span class="op" id="622611">,</span>&nbsp;<span class="num" id="622613">0x00</span><span class="op" id="622617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622620">0x17</span><span class="op" id="622624">,</span>&nbsp;<span class="num" id="622626">0x00</span><span class="op" id="622630">,</span>&nbsp;<span class="num" id="622632">0xe8</span><span class="op" id="622636">,</span>&nbsp;<span class="num" id="622638">0xff</span><span class="op" id="622642">,</span>&nbsp;<span class="num" id="622644">0x42</span><span class="op" id="622648">,</span>&nbsp;<span class="num" id="622650">0x12</span><span class="op" id="622654">,</span>&nbsp;<span class="num" id="622656">0x46</span><span class="op" id="622660">,</span>&nbsp;<span class="num" id="622662">0x16</span><span class="op" id="622666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622669">0x06</span><span class="op" id="622673">,</span>&nbsp;<span class="num" id="622675">0x00</span><span class="op" id="622679">,</span>&nbsp;<span class="num" id="622681">0x00</span><span class="op" id="622685">,</span>&nbsp;<span class="num" id="622687">0x00</span><span class="op" id="622691">,</span>&nbsp;<span class="num" id="622693">0xff</span><span class="op" id="622697">,</span>&nbsp;<span class="num" id="622699">0xff</span><span class="op" id="622703">,</span>&nbsp;<span class="num" id="622705">0x01</span><span class="op" id="622709">,</span>&nbsp;<span class="num" id="622711">0x08</span><span class="op" id="622715">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622718">0x00</span><span class="op" id="622722">,</span>&nbsp;<span class="num" id="622724">0xf7</span><span class="op" id="622728">,</span>&nbsp;<span class="num" id="622730">0xff</span><span class="op" id="622734">,</span>&nbsp;<span class="num" id="622736">0x3d</span><span class="op" id="622740">,</span>&nbsp;<span class="num" id="622742">0xb1</span><span class="op" id="622746">,</span>&nbsp;<span class="num" id="622748">0x20</span><span class="op" id="622752">,</span>&nbsp;<span class="num" id="622754">0x85</span><span class="op" id="622758">,</span>&nbsp;<span class="num" id="622760">0xfa</span><span class="op" id="622764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622767">0x00</span><span class="op" id="622771">,</span>&nbsp;<span class="num" id="622773">0x00</span><span class="op" id="622777">,</span>&nbsp;<span class="num" id="622779">0x00</span><span class="op" id="622783">,</span>&nbsp;<span class="num" id="622785">0x42</span><span class="op" id="622789">,</span>&nbsp;<span class="num" id="622791">0x12</span><span class="op" id="622795">,</span>&nbsp;<span class="num" id="622797">0x46</span><span class="op" id="622801">,</span>&nbsp;<span class="num" id="622803">0x16</span><span class="op" id="622807">,</span>&nbsp;<span class="num" id="622809">0x06</span><span class="op" id="622813">,</span><br>
<span class="lineno">2320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622816">0x00</span><span class="op" id="622820">,</span>&nbsp;<span class="num" id="622822">0x00</span><span class="op" id="622826">,</span>&nbsp;<span class="num" id="622828">0x00</span><span class="op" id="622832">,</span>&nbsp;<span class="num" id="622834">0xff</span><span class="op" id="622838">,</span>&nbsp;<span class="num" id="622840">0xff</span><span class="op" id="622844">,</span>&nbsp;<span class="num" id="622846">0x01</span><span class="op" id="622850">,</span>&nbsp;<span class="num" id="622852">0x08</span><span class="op" id="622856">,</span>&nbsp;<span class="num" id="622858">0x00</span><span class="op" id="622862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622865">0xf7</span><span class="op" id="622869">,</span>&nbsp;<span class="num" id="622871">0xff</span><span class="op" id="622875">,</span>&nbsp;<span class="num" id="622877">0x3d</span><span class="op" id="622881">,</span>&nbsp;<span class="num" id="622883">0xb1</span><span class="op" id="622887">,</span>&nbsp;<span class="num" id="622889">0x20</span><span class="op" id="622893">,</span>&nbsp;<span class="num" id="622895">0x85</span><span class="op" id="622899">,</span>&nbsp;<span class="num" id="622901">0xfa</span><span class="op" id="622905">,</span>&nbsp;<span class="num" id="622907">0x00</span><span class="op" id="622911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622914">0x00</span><span class="op" id="622918">,</span>&nbsp;<span class="num" id="622920">0x00</span><span class="op" id="622924">,</span>&nbsp;<span class="num" id="622926">0x3d</span><span class="op" id="622930">,</span>&nbsp;<span class="num" id="622932">0xb1</span><span class="op" id="622936">,</span>&nbsp;<span class="num" id="622938">0x20</span><span class="op" id="622942">,</span>&nbsp;<span class="num" id="622944">0x85</span><span class="op" id="622948">,</span>&nbsp;<span class="num" id="622950">0xfa</span><span class="op" id="622954">,</span>&nbsp;<span class="num" id="622956">0x00</span><span class="op" id="622960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="622963">0x00</span><span class="op" id="622967">,</span>&nbsp;<span class="num" id="622969">0x00</span><span class="op" id="622973">,</span><br>
<span class="lineno"></span><span class="op" id="622975">}</span>
</div>
</body>
</html>
