<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">cbc</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newCBC</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="ident">Block</span><span class="op">,</span>&nbsp;<span class="ident">iv</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">cbc</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">cbc</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">b</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blockSize</span><span class="op">:</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iv</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">dup</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tmp</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword">type</span>&nbsp;<span class="ident">cbcEncrypter</span>&nbsp;<span class="ident">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword">func</span>&nbsp;<span class="ident">NewCBCEncrypter</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="ident">Block</span><span class="op">,</span>&nbsp;<span class="ident">iv</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="ident">BlockMode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">cbcEncrypter</span><span class="op">)</span><span class="op">(</span><span class="ident">newCBC</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">40</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">cbcEncrypter</span><span class="op">)</span>&nbsp;<span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">cbcEncrypter</span><span class="op">)</span>&nbsp;<span class="ident">CryptBlocks</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">src</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span><span class="op">%</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">dst</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iv</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xorBytes</span><span class="op">(</span><span class="ident">dst</span><span class="op">[</span><span class="op">:</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="op">:</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Encrypt</span><span class="op">(</span><span class="ident">dst</span><span class="op">[</span><span class="op">:</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">dst</span><span class="op">[</span><span class="op">:</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">iv</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dst</span><span class="op">[</span><span class="op">:</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">src</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dst</span><span class="op">[</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">cbcEncrypter</span><span class="op">)</span>&nbsp;<span class="ident">SetIV</span><span class="op">(</span><span class="ident">iv</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">cbcDecrypter</span>&nbsp;<span class="ident">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewCBCDecrypter</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="ident">Block</span><span class="op">,</span>&nbsp;<span class="ident">iv</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="ident">BlockMode</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">cbcDecrypter</span><span class="op">)</span><span class="op">(</span><span class="ident">newCBC</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">cbcDecrypter</span><span class="op">)</span>&nbsp;<span class="ident">BlockSize</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">cbcDecrypter</span><span class="op">)</span>&nbsp;<span class="ident">CryptBlocks</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">src</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span><span class="op">%</span><span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">dst</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">end</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">src</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">start</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">end</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prev</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">start</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">tmp</span><span class="op">,</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">start</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Decrypt</span><span class="op">(</span><span class="ident">dst</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xorBytes</span><span class="op">(</span><span class="ident">dst</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">dst</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">prev</span><span class="op">:</span><span class="ident">start</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">end</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">start</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prev</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Decrypt</span><span class="op">(</span><span class="ident">dst</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xorBytes</span><span class="op">(</span><span class="ident">dst</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">dst</span><span class="op">[</span><span class="ident">start</span><span class="op">:</span><span class="ident">end</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">tmp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">tmp</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">cbcDecrypter</span><span class="op">)</span>&nbsp;<span class="ident">SetIV</span><span class="op">(</span><span class="ident">iv</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">iv</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
