<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html" class="current">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4747412">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4747468">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4747522">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4747573">package</span>&nbsp;<span class="ident" id="4747581">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4747590">import</span>&nbsp;<span class="op" id="4747597">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4747600">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4747617">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4747627">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4747633">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4747644">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4747651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4747654">var</span>&nbsp;<span class="ident" id="4747658">errMissingParams</span>&nbsp;<span class="op" id="4747675">=</span>&nbsp;<span class="ident" id="4747677">errors</span><span class="op" id="4747683">.</span><span class="ident" id="4747684">New</span><span class="op" id="4747687">(</span><span class="string" id="4747688">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="4747726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4747729">type</span>&nbsp;<span class="ident" id="4747734">serverCodec</span>&nbsp;<span class="keyword" id="4747746">struct</span>&nbsp;<span class="op" id="4747753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4747756">dec</span>&nbsp;<span class="op" id="4747760">*</span><span class="ident" id="4747761">json</span><span class="op" id="4747765">.</span><span class="ident" id="4747766">Decoder</span>&nbsp;<span class="comment" id="4747774">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4747802">enc</span>&nbsp;<span class="op" id="4747806">*</span><span class="ident" id="4747807">json</span><span class="op" id="4747811">.</span><span class="ident" id="4747812">Encoder</span>&nbsp;<span class="comment" id="4747820">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4747848">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4747852">io</span><span class="op" id="4747854">.</span><span class="ident" id="4747855">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4747864">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4747889">req</span>&nbsp;<span class="ident" id="4747893">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4747909">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4747976">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4748020">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4748079">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4748136">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4748189">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748239">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4748247">sync</span><span class="op" id="4748251">.</span><span class="ident" id="4748252">Mutex</span>&nbsp;<span class="comment" id="4748258">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748284">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748292">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748300">pending</span>&nbsp;<span class="keyword" id="4748308">map</span><span class="op" id="4748311">[</span><span class="ident" id="4748312">uint64</span><span class="op" id="4748318">]</span><span class="op" id="4748319">*</span><span class="ident" id="4748320">json</span><span class="op" id="4748324">.</span><span class="ident" id="4748325">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="4748336">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="4748339">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="4748411">func</span>&nbsp;<span class="ident" id="4748416">NewServerCodec</span><span class="op" id="4748430">(</span><span class="ident" id="4748431">conn</span>&nbsp;<span class="ident" id="4748436">io</span><span class="op" id="4748438">.</span><span class="ident" id="4748439">ReadWriteCloser</span><span class="op" id="4748454">)</span>&nbsp;<span class="ident" id="4748456">rpc</span><span class="op" id="4748459">.</span><span class="ident" id="4748460">ServerCodec</span>&nbsp;<span class="op" id="4748472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4748475">return</span>&nbsp;<span class="op" id="4748482">&amp;</span><span class="ident" id="4748483">serverCodec</span><span class="op" id="4748494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748498">dec</span><span class="op" id="4748501">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748507">json</span><span class="op" id="4748511">.</span><span class="ident" id="4748512">NewDecoder</span><span class="op" id="4748522">(</span><span class="ident" id="4748523">conn</span><span class="op" id="4748527">)</span><span class="op" id="4748528">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748532">enc</span><span class="op" id="4748535">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748541">json</span><span class="op" id="4748545">.</span><span class="ident" id="4748546">NewEncoder</span><span class="op" id="4748556">(</span><span class="ident" id="4748557">conn</span><span class="op" id="4748561">)</span><span class="op" id="4748562">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748566">c</span><span class="op" id="4748567">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748575">conn</span><span class="op" id="4748579">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748583">pending</span><span class="op" id="4748590">:</span>&nbsp;<span class="builtinfunc" id="4748592">make</span><span class="op" id="4748596">(</span><span class="keyword" id="4748597">map</span><span class="op" id="4748600">[</span><span class="ident" id="4748601">uint64</span><span class="op" id="4748607">]</span><span class="op" id="4748608">*</span><span class="ident" id="4748609">json</span><span class="op" id="4748613">.</span><span class="ident" id="4748614">RawMessage</span><span class="op" id="4748624">)</span><span class="op" id="4748625">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4748628">}</span><br>
<span class="lineno"></span><span class="op" id="4748630">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="4748633">type</span>&nbsp;<span class="ident" id="4748638">serverRequest</span>&nbsp;<span class="keyword" id="4748652">struct</span>&nbsp;<span class="op" id="4748659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748662">Method</span>&nbsp;<span class="builtintype" id="4748669">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4748686">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748703">Params</span>&nbsp;<span class="op" id="4748710">*</span><span class="ident" id="4748711">json</span><span class="op" id="4748715">.</span><span class="ident" id="4748716">RawMessage</span>&nbsp;<span class="string" id="4748727">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748744">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4748751">*</span><span class="ident" id="4748752">json</span><span class="op" id="4748756">.</span><span class="ident" id="4748757">RawMessage</span>&nbsp;<span class="string" id="4748768">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="4748780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4748783">func</span>&nbsp;<span class="op" id="4748788">(</span><span class="ident" id="4748789">r</span>&nbsp;<span class="op" id="4748791">*</span><span class="ident" id="4748792">serverRequest</span><span class="op" id="4748805">)</span>&nbsp;<span class="ident" id="4748807">reset</span><span class="op" id="4748812">(</span><span class="op" id="4748813">)</span>&nbsp;<span class="op" id="4748815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748818">r</span><span class="op" id="4748819">.</span><span class="ident" id="4748820">Method</span>&nbsp;<span class="op" id="4748827">=</span>&nbsp;<span class="string" id="4748829">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748833">r</span><span class="op" id="4748834">.</span><span class="ident" id="4748835">Params</span>&nbsp;<span class="op" id="4748842">=</span>&nbsp;<span class="ident" id="4748844">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748849">r</span><span class="op" id="4748850">.</span><span class="ident" id="4748851">Id</span>&nbsp;<span class="op" id="4748854">=</span>&nbsp;<span class="ident" id="4748856">nil</span><br>
<span class="lineno"></span><span class="op" id="4748860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4748863">type</span>&nbsp;<span class="ident" id="4748868">serverResponse</span>&nbsp;<span class="keyword" id="4748883">struct</span>&nbsp;<span class="op" id="4748890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748893">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4748900">*</span><span class="ident" id="4748901">json</span><span class="op" id="4748905">.</span><span class="ident" id="4748906">RawMessage</span>&nbsp;<span class="string" id="4748917">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748930">Result</span>&nbsp;<span class="keyword" id="4748937">interface</span><span class="op" id="4748946">{</span><span class="op" id="4748947">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4748954">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4748971">Error</span>&nbsp;&nbsp;<span class="keyword" id="4748978">interface</span><span class="op" id="4748987">{</span><span class="op" id="4748988">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4748995">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="4749010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4749013">func</span>&nbsp;<span class="op" id="4749018">(</span><span class="ident" id="4749019">c</span>&nbsp;<span class="op" id="4749021">*</span><span class="ident" id="4749022">serverCodec</span><span class="op" id="4749033">)</span>&nbsp;<span class="ident" id="4749035">ReadRequestHeader</span><span class="op" id="4749052">(</span><span class="ident" id="4749053">r</span>&nbsp;<span class="op" id="4749055">*</span><span class="ident" id="4749056">rpc</span><span class="op" id="4749059">.</span><span class="ident" id="4749060">Request</span><span class="op" id="4749067">)</span>&nbsp;<span class="builtintype" id="4749069">error</span>&nbsp;<span class="op" id="4749075">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749078">c</span><span class="op" id="4749079">.</span><span class="ident" id="4749080">req</span><span class="op" id="4749083">.</span><span class="ident" id="4749084">reset</span><span class="op" id="4749089">(</span><span class="op" id="4749090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749093">if</span>&nbsp;<span class="ident" id="4749096">err</span>&nbsp;<span class="op" id="4749100">:=</span>&nbsp;<span class="ident" id="4749103">c</span><span class="op" id="4749104">.</span><span class="ident" id="4749105">dec</span><span class="op" id="4749108">.</span><span class="ident" id="4749109">Decode</span><span class="op" id="4749115">(</span><span class="op" id="4749116">&amp;</span><span class="ident" id="4749117">c</span><span class="op" id="4749118">.</span><span class="ident" id="4749119">req</span><span class="op" id="4749122">)</span><span class="op" id="4749123">;</span>&nbsp;<span class="ident" id="4749125">err</span>&nbsp;<span class="op" id="4749129">!=</span>&nbsp;<span class="ident" id="4749132">nil</span>&nbsp;<span class="op" id="4749136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749140">return</span>&nbsp;<span class="ident" id="4749147">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4749152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749155">r</span><span class="op" id="4749156">.</span><span class="ident" id="4749157">ServiceMethod</span>&nbsp;<span class="op" id="4749171">=</span>&nbsp;<span class="ident" id="4749173">c</span><span class="op" id="4749174">.</span><span class="ident" id="4749175">req</span><span class="op" id="4749178">.</span><span class="ident" id="4749179">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749188">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749231">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749277">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749324">c</span><span class="op" id="4749325">.</span><span class="ident" id="4749326">mutex</span><span class="op" id="4749331">.</span><span class="ident" id="4749332">Lock</span><span class="op" id="4749336">(</span><span class="op" id="4749337">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749340">c</span><span class="op" id="4749341">.</span><span class="ident" id="4749342">seq</span><span class="op" id="4749345">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749349">c</span><span class="op" id="4749350">.</span><span class="ident" id="4749351">pending</span><span class="op" id="4749358">[</span><span class="ident" id="4749359">c</span><span class="op" id="4749360">.</span><span class="ident" id="4749361">seq</span><span class="op" id="4749364">]</span>&nbsp;<span class="op" id="4749366">=</span>&nbsp;<span class="ident" id="4749368">c</span><span class="op" id="4749369">.</span><span class="ident" id="4749370">req</span><span class="op" id="4749373">.</span><span class="ident" id="4749374">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749378">c</span><span class="op" id="4749379">.</span><span class="ident" id="4749380">req</span><span class="op" id="4749383">.</span><span class="ident" id="4749384">Id</span>&nbsp;<span class="op" id="4749387">=</span>&nbsp;<span class="ident" id="4749389">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749394">r</span><span class="op" id="4749395">.</span><span class="ident" id="4749396">Seq</span>&nbsp;<span class="op" id="4749400">=</span>&nbsp;<span class="ident" id="4749402">c</span><span class="op" id="4749403">.</span><span class="ident" id="4749404">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749409">c</span><span class="op" id="4749410">.</span><span class="ident" id="4749411">mutex</span><span class="op" id="4749416">.</span><span class="ident" id="4749417">Unlock</span><span class="op" id="4749423">(</span><span class="op" id="4749424">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749428">return</span>&nbsp;<span class="ident" id="4749435">nil</span><br>
<span class="lineno"></span><span class="op" id="4749439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4749442">func</span>&nbsp;<span class="op" id="4749447">(</span><span class="ident" id="4749448">c</span>&nbsp;<span class="op" id="4749450">*</span><span class="ident" id="4749451">serverCodec</span><span class="op" id="4749462">)</span>&nbsp;<span class="ident" id="4749464">ReadRequestBody</span><span class="op" id="4749479">(</span><span class="ident" id="4749480">x</span>&nbsp;<span class="keyword" id="4749482">interface</span><span class="op" id="4749491">{</span><span class="op" id="4749492">}</span><span class="op" id="4749493">)</span>&nbsp;<span class="builtintype" id="4749495">error</span>&nbsp;<span class="op" id="4749501">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749504">if</span>&nbsp;<span class="ident" id="4749507">x</span>&nbsp;<span class="op" id="4749509">==</span>&nbsp;<span class="ident" id="4749512">nil</span>&nbsp;<span class="op" id="4749516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749520">return</span>&nbsp;<span class="ident" id="4749527">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4749532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749535">if</span>&nbsp;<span class="ident" id="4749538">c</span><span class="op" id="4749539">.</span><span class="ident" id="4749540">req</span><span class="op" id="4749543">.</span><span class="ident" id="4749544">Params</span>&nbsp;<span class="op" id="4749551">==</span>&nbsp;<span class="ident" id="4749554">nil</span>&nbsp;<span class="op" id="4749558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749562">return</span>&nbsp;<span class="ident" id="4749569">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4749587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749590">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749622">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749648">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4749700">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749748">var</span>&nbsp;<span class="ident" id="4749752">params</span>&nbsp;<span class="op" id="4749759">[</span><span class="num" id="4749760">1</span><span class="op" id="4749761">]</span><span class="keyword" id="4749762">interface</span><span class="op" id="4749771">{</span><span class="op" id="4749772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749775">params</span><span class="op" id="4749781">[</span><span class="num" id="4749782">0</span><span class="op" id="4749783">]</span>&nbsp;<span class="op" id="4749785">=</span>&nbsp;<span class="ident" id="4749787">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4749790">return</span>&nbsp;<span class="ident" id="4749797">json</span><span class="op" id="4749801">.</span><span class="ident" id="4749802">Unmarshal</span><span class="op" id="4749811">(</span><span class="op" id="4749812">*</span><span class="ident" id="4749813">c</span><span class="op" id="4749814">.</span><span class="ident" id="4749815">req</span><span class="op" id="4749818">.</span><span class="ident" id="4749819">Params</span><span class="op" id="4749825">,</span>&nbsp;<span class="op" id="4749827">&amp;</span><span class="ident" id="4749828">params</span><span class="op" id="4749834">)</span><br>
<span class="lineno"></span><span class="op" id="4749836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="4749839">var</span>&nbsp;<span class="ident" id="4749843">null</span>&nbsp;<span class="op" id="4749848">=</span>&nbsp;<span class="ident" id="4749850">json</span><span class="op" id="4749854">.</span><span class="ident" id="4749855">RawMessage</span><span class="op" id="4749865">(</span><span class="op" id="4749866">[</span><span class="op" id="4749867">]</span><span class="builtintype" id="4749868">byte</span><span class="op" id="4749872">(</span><span class="string" id="4749873">&#34;null&#34;</span><span class="op" id="4749879">)</span><span class="op" id="4749880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4749883">func</span>&nbsp;<span class="op" id="4749888">(</span><span class="ident" id="4749889">c</span>&nbsp;<span class="op" id="4749891">*</span><span class="ident" id="4749892">serverCodec</span><span class="op" id="4749903">)</span>&nbsp;<span class="ident" id="4749905">WriteResponse</span><span class="op" id="4749918">(</span><span class="ident" id="4749919">r</span>&nbsp;<span class="op" id="4749921">*</span><span class="ident" id="4749922">rpc</span><span class="op" id="4749925">.</span><span class="ident" id="4749926">Response</span><span class="op" id="4749934">,</span>&nbsp;<span class="ident" id="4749936">x</span>&nbsp;<span class="keyword" id="4749938">interface</span><span class="op" id="4749947">{</span><span class="op" id="4749948">}</span><span class="op" id="4749949">)</span>&nbsp;<span class="builtintype" id="4749951">error</span>&nbsp;<span class="op" id="4749957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749960">c</span><span class="op" id="4749961">.</span><span class="ident" id="4749962">mutex</span><span class="op" id="4749967">.</span><span class="ident" id="4749968">Lock</span><span class="op" id="4749972">(</span><span class="op" id="4749973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4749976">b</span><span class="op" id="4749977">,</span>&nbsp;<span class="ident" id="4749979">ok</span>&nbsp;<span class="op" id="4749982">:=</span>&nbsp;<span class="ident" id="4749985">c</span><span class="op" id="4749986">.</span><span class="ident" id="4749987">pending</span><span class="op" id="4749994">[</span><span class="ident" id="4749995">r</span><span class="op" id="4749996">.</span><span class="ident" id="4749997">Seq</span><span class="op" id="4750000">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4750003">if</span>&nbsp;<span class="op" id="4750006">!</span><span class="ident" id="4750007">ok</span>&nbsp;<span class="op" id="4750010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750014">c</span><span class="op" id="4750015">.</span><span class="ident" id="4750016">mutex</span><span class="op" id="4750021">.</span><span class="ident" id="4750022">Unlock</span><span class="op" id="4750028">(</span><span class="op" id="4750029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4750033">return</span>&nbsp;<span class="ident" id="4750040">errors</span><span class="op" id="4750046">.</span><span class="ident" id="4750047">New</span><span class="op" id="4750050">(</span><span class="string" id="4750051">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="4750088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4750091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4750094">delete</span><span class="op" id="4750100">(</span><span class="ident" id="4750101">c</span><span class="op" id="4750102">.</span><span class="ident" id="4750103">pending</span><span class="op" id="4750110">,</span>&nbsp;<span class="ident" id="4750112">r</span><span class="op" id="4750113">.</span><span class="ident" id="4750114">Seq</span><span class="op" id="4750117">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750120">c</span><span class="op" id="4750121">.</span><span class="ident" id="4750122">mutex</span><span class="op" id="4750127">.</span><span class="ident" id="4750128">Unlock</span><span class="op" id="4750134">(</span><span class="op" id="4750135">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4750139">if</span>&nbsp;<span class="ident" id="4750142">b</span>&nbsp;<span class="op" id="4750144">==</span>&nbsp;<span class="ident" id="4750147">nil</span>&nbsp;<span class="op" id="4750151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4750155">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750202">b</span>&nbsp;<span class="op" id="4750204">=</span>&nbsp;<span class="op" id="4750206">&amp;</span><span class="ident" id="4750207">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4750213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750216">resp</span>&nbsp;<span class="op" id="4750221">:=</span>&nbsp;<span class="ident" id="4750224">serverResponse</span><span class="op" id="4750238">{</span><span class="ident" id="4750239">Id</span><span class="op" id="4750241">:</span>&nbsp;<span class="ident" id="4750243">b</span><span class="op" id="4750244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4750247">if</span>&nbsp;<span class="ident" id="4750250">r</span><span class="op" id="4750251">.</span><span class="ident" id="4750252">Error</span>&nbsp;<span class="op" id="4750258">==</span>&nbsp;<span class="string" id="4750261">&#34;&#34;</span>&nbsp;<span class="op" id="4750264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750268">resp</span><span class="op" id="4750272">.</span><span class="ident" id="4750273">Result</span>&nbsp;<span class="op" id="4750280">=</span>&nbsp;<span class="ident" id="4750282">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4750285">}</span>&nbsp;<span class="keyword" id="4750287">else</span>&nbsp;<span class="op" id="4750292">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750296">resp</span><span class="op" id="4750300">.</span><span class="ident" id="4750301">Error</span>&nbsp;<span class="op" id="4750307">=</span>&nbsp;<span class="ident" id="4750309">r</span><span class="op" id="4750310">.</span><span class="ident" id="4750311">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4750318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4750321">return</span>&nbsp;<span class="ident" id="4750328">c</span><span class="op" id="4750329">.</span><span class="ident" id="4750330">enc</span><span class="op" id="4750333">.</span><span class="ident" id="4750334">Encode</span><span class="op" id="4750340">(</span><span class="ident" id="4750341">resp</span><span class="op" id="4750345">)</span><br>
<span class="lineno"></span><span class="op" id="4750347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="4750350">func</span>&nbsp;<span class="op" id="4750355">(</span><span class="ident" id="4750356">c</span>&nbsp;<span class="op" id="4750358">*</span><span class="ident" id="4750359">serverCodec</span><span class="op" id="4750370">)</span>&nbsp;<span class="ident" id="4750372">Close</span><span class="op" id="4750377">(</span><span class="op" id="4750378">)</span>&nbsp;<span class="builtintype" id="4750380">error</span>&nbsp;<span class="op" id="4750386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4750389">return</span>&nbsp;<span class="ident" id="4750396">c</span><span class="op" id="4750397">.</span><span class="ident" id="4750398">c</span><span class="op" id="4750399">.</span><span class="ident" id="4750400">Close</span><span class="op" id="4750405">(</span><span class="op" id="4750406">)</span><br>
<span class="lineno"></span><span class="op" id="4750408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4750411">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="4750473">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4750544">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4750605">func</span>&nbsp;<span class="ident" id="4750610">ServeConn</span><span class="op" id="4750619">(</span><span class="ident" id="4750620">conn</span>&nbsp;<span class="ident" id="4750625">io</span><span class="op" id="4750627">.</span><span class="ident" id="4750628">ReadWriteCloser</span><span class="op" id="4750643">)</span>&nbsp;<span class="op" id="4750645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4750648">rpc</span><span class="op" id="4750651">.</span><span class="ident" id="4750652">ServeCodec</span><span class="op" id="4750662">(</span><span class="ident" id="4750663">NewServerCodec</span><span class="op" id="4750677">(</span><span class="ident" id="4750678">conn</span><span class="op" id="4750682">)</span><span class="op" id="4750683">)</span><br>
<span class="lineno"></span><span class="op" id="4750685">}</span>
</div>
</body>
</html>
