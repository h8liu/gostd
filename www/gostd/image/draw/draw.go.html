<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html" class="current">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6101470">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6101526">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6101580">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6101631">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="6101685">//</span><br>
<span class="lineno"></span><span class="comment" id="6101688">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="6101760">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="6101810">package</span>&nbsp;<span class="ident" id="6101818">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="6101824">import</span>&nbsp;<span class="op" id="6101831">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6101834">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6101843">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="6101857">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6101860">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="6101922">const</span>&nbsp;<span class="ident" id="6101928">m</span>&nbsp;<span class="op" id="6101930">=</span>&nbsp;<span class="num" id="6101932">1</span><span class="op" id="6101933">&lt;&lt;</span><span class="num" id="6101935">16</span>&nbsp;<span class="op" id="6101938">-</span>&nbsp;<span class="num" id="6101940">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6101943">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="6102014">type</span>&nbsp;<span class="ident" id="6102019">Image</span>&nbsp;<span class="keyword" id="6102025">interface</span>&nbsp;<span class="op" id="6102035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102038">image</span><span class="op" id="6102043">.</span><span class="ident" id="6102044">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102051">Set</span><span class="op" id="6102054">(</span><span class="ident" id="6102055">x</span><span class="op" id="6102056">,</span>&nbsp;<span class="ident" id="6102058">y</span>&nbsp;<span class="builtintype" id="6102060">int</span><span class="op" id="6102063">,</span>&nbsp;<span class="ident" id="6102065">c</span>&nbsp;<span class="ident" id="6102067">color</span><span class="op" id="6102072">.</span><span class="ident" id="6102073">Color</span><span class="op" id="6102078">)</span><br>
<span class="lineno"></span><span class="op" id="6102080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="6102083">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6102129">type</span>&nbsp;<span class="ident" id="6102134">Quantizer</span>&nbsp;<span class="keyword" id="6102144">interface</span>&nbsp;<span class="op" id="6102154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102157">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102228">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102295">Quantize</span><span class="op" id="6102303">(</span><span class="ident" id="6102304">p</span>&nbsp;<span class="ident" id="6102306">color</span><span class="op" id="6102311">.</span><span class="ident" id="6102312">Palette</span><span class="op" id="6102319">,</span>&nbsp;<span class="ident" id="6102321">m</span>&nbsp;<span class="ident" id="6102323">image</span><span class="op" id="6102328">.</span><span class="ident" id="6102329">Image</span><span class="op" id="6102334">)</span>&nbsp;<span class="ident" id="6102336">color</span><span class="op" id="6102341">.</span><span class="ident" id="6102342">Palette</span><br>
<span class="lineno">30</span><span class="op" id="6102350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6102353">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="6102398">type</span>&nbsp;<span class="ident" id="6102403">Op</span>&nbsp;<span class="builtintype" id="6102406">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="6102411">const</span>&nbsp;<span class="op" id="6102417">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102420">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102467">Over</span>&nbsp;<span class="ident" id="6102472">Op</span>&nbsp;<span class="op" id="6102475">=</span>&nbsp;<span class="ident" id="6102477">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102483">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102518">Src</span><br>
<span class="lineno">40</span><span class="op" id="6102522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6102525">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="6102604">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="6102611">func</span>&nbsp;<span class="op" id="6102616">(</span><span class="ident" id="6102617">op</span>&nbsp;<span class="ident" id="6102620">Op</span><span class="op" id="6102622">)</span>&nbsp;<span class="ident" id="6102624">Draw</span><span class="op" id="6102628">(</span><span class="ident" id="6102629">dst</span>&nbsp;<span class="ident" id="6102633">Image</span><span class="op" id="6102638">,</span>&nbsp;<span class="ident" id="6102640">r</span>&nbsp;<span class="ident" id="6102642">image</span><span class="op" id="6102647">.</span><span class="ident" id="6102648">Rectangle</span><span class="op" id="6102657">,</span>&nbsp;<span class="ident" id="6102659">src</span>&nbsp;<span class="ident" id="6102663">image</span><span class="op" id="6102668">.</span><span class="ident" id="6102669">Image</span><span class="op" id="6102674">,</span>&nbsp;<span class="ident" id="6102676">sp</span>&nbsp;<span class="ident" id="6102679">image</span><span class="op" id="6102684">.</span><span class="ident" id="6102685">Point</span><span class="op" id="6102690">)</span>&nbsp;<span class="op" id="6102692">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102695">DrawMask</span><span class="op" id="6102703">(</span><span class="ident" id="6102704">dst</span><span class="op" id="6102707">,</span>&nbsp;<span class="ident" id="6102709">r</span><span class="op" id="6102710">,</span>&nbsp;<span class="ident" id="6102712">src</span><span class="op" id="6102715">,</span>&nbsp;<span class="ident" id="6102717">sp</span><span class="op" id="6102719">,</span>&nbsp;<span class="builtintype" id="6102721">nil</span><span class="op" id="6102724">,</span>&nbsp;<span class="ident" id="6102726">image</span><span class="op" id="6102731">.</span><span class="ident" id="6102732">Point</span><span class="op" id="6102737">{</span><span class="op" id="6102738">}</span><span class="op" id="6102739">,</span>&nbsp;<span class="ident" id="6102741">op</span><span class="op" id="6102743">)</span><br>
<span class="lineno"></span><span class="op" id="6102745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6102748">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="6102784">type</span>&nbsp;<span class="ident" id="6102789">Drawer</span>&nbsp;<span class="keyword" id="6102796">interface</span>&nbsp;<span class="op" id="6102806">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102809">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6102875">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6102937">Draw</span><span class="op" id="6102941">(</span><span class="ident" id="6102942">dst</span>&nbsp;<span class="ident" id="6102946">Image</span><span class="op" id="6102951">,</span>&nbsp;<span class="ident" id="6102953">r</span>&nbsp;<span class="ident" id="6102955">image</span><span class="op" id="6102960">.</span><span class="ident" id="6102961">Rectangle</span><span class="op" id="6102970">,</span>&nbsp;<span class="ident" id="6102972">src</span>&nbsp;<span class="ident" id="6102976">image</span><span class="op" id="6102981">.</span><span class="ident" id="6102982">Image</span><span class="op" id="6102987">,</span>&nbsp;<span class="ident" id="6102989">sp</span>&nbsp;<span class="ident" id="6102992">image</span><span class="op" id="6102997">.</span><span class="ident" id="6102998">Point</span><span class="op" id="6103003">)</span><br>
<span class="lineno"></span><span class="op" id="6103005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="6103008">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6103084">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="6103098">var</span>&nbsp;<span class="ident" id="6103102">FloydSteinberg</span>&nbsp;<span class="ident" id="6103117">Drawer</span>&nbsp;<span class="op" id="6103124">=</span>&nbsp;<span class="ident" id="6103126">floydSteinberg</span><span class="op" id="6103140">{</span><span class="op" id="6103141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6103144">type</span>&nbsp;<span class="ident" id="6103149">floydSteinberg</span>&nbsp;<span class="keyword" id="6103164">struct</span><span class="op" id="6103170">{</span><span class="op" id="6103171">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6103174">func</span>&nbsp;<span class="op" id="6103179">(</span><span class="ident" id="6103180">floydSteinberg</span><span class="op" id="6103194">)</span>&nbsp;<span class="ident" id="6103196">Draw</span><span class="op" id="6103200">(</span><span class="ident" id="6103201">dst</span>&nbsp;<span class="ident" id="6103205">Image</span><span class="op" id="6103210">,</span>&nbsp;<span class="ident" id="6103212">r</span>&nbsp;<span class="ident" id="6103214">image</span><span class="op" id="6103219">.</span><span class="ident" id="6103220">Rectangle</span><span class="op" id="6103229">,</span>&nbsp;<span class="ident" id="6103231">src</span>&nbsp;<span class="ident" id="6103235">image</span><span class="op" id="6103240">.</span><span class="ident" id="6103241">Image</span><span class="op" id="6103246">,</span>&nbsp;<span class="ident" id="6103248">sp</span>&nbsp;<span class="ident" id="6103251">image</span><span class="op" id="6103256">.</span><span class="ident" id="6103257">Point</span><span class="op" id="6103262">)</span>&nbsp;<span class="op" id="6103264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6103267">clip</span><span class="op" id="6103271">(</span><span class="ident" id="6103272">dst</span><span class="op" id="6103275">,</span>&nbsp;<span class="op" id="6103277">&amp;</span><span class="ident" id="6103278">r</span><span class="op" id="6103279">,</span>&nbsp;<span class="ident" id="6103281">src</span><span class="op" id="6103284">,</span>&nbsp;<span class="op" id="6103286">&amp;</span><span class="ident" id="6103287">sp</span><span class="op" id="6103289">,</span>&nbsp;<span class="builtintype" id="6103291">nil</span><span class="op" id="6103294">,</span>&nbsp;<span class="builtintype" id="6103296">nil</span><span class="op" id="6103299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6103302">if</span>&nbsp;<span class="ident" id="6103305">r</span><span class="op" id="6103306">.</span><span class="ident" id="6103307">Empty</span><span class="op" id="6103312">(</span><span class="op" id="6103313">)</span>&nbsp;<span class="op" id="6103315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6103319">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6103330">drawPaletted</span><span class="op" id="6103342">(</span><span class="ident" id="6103343">dst</span><span class="op" id="6103346">,</span>&nbsp;<span class="ident" id="6103348">r</span><span class="op" id="6103349">,</span>&nbsp;<span class="ident" id="6103351">src</span><span class="op" id="6103354">,</span>&nbsp;<span class="ident" id="6103356">sp</span><span class="op" id="6103358">,</span>&nbsp;<span class="builtintype" id="6103360">true</span><span class="op" id="6103364">)</span><br>
<span class="lineno"></span><span class="op" id="6103366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6103369">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="6103441">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6103518">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="6103561">func</span>&nbsp;<span class="ident" id="6103566">clip</span><span class="op" id="6103570">(</span><span class="ident" id="6103571">dst</span>&nbsp;<span class="ident" id="6103575">Image</span><span class="op" id="6103580">,</span>&nbsp;<span class="ident" id="6103582">r</span>&nbsp;<span class="op" id="6103584">*</span><span class="ident" id="6103585">image</span><span class="op" id="6103590">.</span><span class="ident" id="6103591">Rectangle</span><span class="op" id="6103600">,</span>&nbsp;<span class="ident" id="6103602">src</span>&nbsp;<span class="ident" id="6103606">image</span><span class="op" id="6103611">.</span><span class="ident" id="6103612">Image</span><span class="op" id="6103617">,</span>&nbsp;<span class="ident" id="6103619">sp</span>&nbsp;<span class="op" id="6103622">*</span><span class="ident" id="6103623">image</span><span class="op" id="6103628">.</span><span class="ident" id="6103629">Point</span><span class="op" id="6103634">,</span>&nbsp;<span class="ident" id="6103636">mask</span>&nbsp;<span class="ident" id="6103641">image</span><span class="op" id="6103646">.</span><span class="ident" id="6103647">Image</span><span class="op" id="6103652">,</span>&nbsp;<span class="ident" id="6103654">mp</span>&nbsp;<span class="op" id="6103657">*</span><span class="ident" id="6103658">image</span><span class="op" id="6103663">.</span><span class="ident" id="6103664">Point</span><span class="op" id="6103669">)</span>&nbsp;<span class="op" id="6103671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6103674">orig</span>&nbsp;<span class="op" id="6103679">:=</span>&nbsp;<span class="ident" id="6103682">r</span><span class="op" id="6103683">.</span><span class="ident" id="6103684">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103689">*</span><span class="ident" id="6103690">r</span>&nbsp;<span class="op" id="6103692">=</span>&nbsp;<span class="ident" id="6103694">r</span><span class="op" id="6103695">.</span><span class="ident" id="6103696">Intersect</span><span class="op" id="6103705">(</span><span class="ident" id="6103706">dst</span><span class="op" id="6103709">.</span><span class="ident" id="6103710">Bounds</span><span class="op" id="6103716">(</span><span class="op" id="6103717">)</span><span class="op" id="6103718">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103721">*</span><span class="ident" id="6103722">r</span>&nbsp;<span class="op" id="6103724">=</span>&nbsp;<span class="ident" id="6103726">r</span><span class="op" id="6103727">.</span><span class="ident" id="6103728">Intersect</span><span class="op" id="6103737">(</span><span class="ident" id="6103738">src</span><span class="op" id="6103741">.</span><span class="ident" id="6103742">Bounds</span><span class="op" id="6103748">(</span><span class="op" id="6103749">)</span><span class="op" id="6103750">.</span><span class="ident" id="6103751">Add</span><span class="op" id="6103754">(</span><span class="ident" id="6103755">orig</span><span class="op" id="6103759">.</span><span class="ident" id="6103760">Sub</span><span class="op" id="6103763">(</span><span class="op" id="6103764">*</span><span class="ident" id="6103765">sp</span><span class="op" id="6103767">)</span><span class="op" id="6103768">)</span><span class="op" id="6103769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6103772">if</span>&nbsp;<span class="ident" id="6103775">mask</span>&nbsp;<span class="op" id="6103780">!=</span>&nbsp;<span class="builtintype" id="6103783">nil</span>&nbsp;<span class="op" id="6103787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103791">*</span><span class="ident" id="6103792">r</span>&nbsp;<span class="op" id="6103794">=</span>&nbsp;<span class="ident" id="6103796">r</span><span class="op" id="6103797">.</span><span class="ident" id="6103798">Intersect</span><span class="op" id="6103807">(</span><span class="ident" id="6103808">mask</span><span class="op" id="6103812">.</span><span class="ident" id="6103813">Bounds</span><span class="op" id="6103819">(</span><span class="op" id="6103820">)</span><span class="op" id="6103821">.</span><span class="ident" id="6103822">Add</span><span class="op" id="6103825">(</span><span class="ident" id="6103826">orig</span><span class="op" id="6103830">.</span><span class="ident" id="6103831">Sub</span><span class="op" id="6103834">(</span><span class="op" id="6103835">*</span><span class="ident" id="6103836">mp</span><span class="op" id="6103838">)</span><span class="op" id="6103839">)</span><span class="op" id="6103840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6103846">dx</span>&nbsp;<span class="op" id="6103849">:=</span>&nbsp;<span class="ident" id="6103852">r</span><span class="op" id="6103853">.</span><span class="ident" id="6103854">Min</span><span class="op" id="6103857">.</span><span class="ident" id="6103858">X</span>&nbsp;<span class="op" id="6103860">-</span>&nbsp;<span class="ident" id="6103862">orig</span><span class="op" id="6103866">.</span><span class="ident" id="6103867">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6103870">dy</span>&nbsp;<span class="op" id="6103873">:=</span>&nbsp;<span class="ident" id="6103876">r</span><span class="op" id="6103877">.</span><span class="ident" id="6103878">Min</span><span class="op" id="6103881">.</span><span class="ident" id="6103882">Y</span>&nbsp;<span class="op" id="6103884">-</span>&nbsp;<span class="ident" id="6103886">orig</span><span class="op" id="6103890">.</span><span class="ident" id="6103891">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6103894">if</span>&nbsp;<span class="ident" id="6103897">dx</span>&nbsp;<span class="op" id="6103900">==</span>&nbsp;<span class="num" id="6103903">0</span>&nbsp;<span class="op" id="6103905">&amp;&amp;</span>&nbsp;<span class="ident" id="6103908">dy</span>&nbsp;<span class="op" id="6103911">==</span>&nbsp;<span class="num" id="6103914">0</span>&nbsp;<span class="op" id="6103916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6103920">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103931">(</span><span class="op" id="6103932">*</span><span class="ident" id="6103933">sp</span><span class="op" id="6103935">)</span><span class="op" id="6103936">.</span><span class="ident" id="6103937">X</span>&nbsp;<span class="op" id="6103939">+=</span>&nbsp;<span class="ident" id="6103942">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103946">(</span><span class="op" id="6103947">*</span><span class="ident" id="6103948">sp</span><span class="op" id="6103950">)</span><span class="op" id="6103951">.</span><span class="ident" id="6103952">Y</span>&nbsp;<span class="op" id="6103954">+=</span>&nbsp;<span class="ident" id="6103957">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103961">(</span><span class="op" id="6103962">*</span><span class="ident" id="6103963">mp</span><span class="op" id="6103965">)</span><span class="op" id="6103966">.</span><span class="ident" id="6103967">X</span>&nbsp;<span class="op" id="6103969">+=</span>&nbsp;<span class="ident" id="6103972">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6103976">(</span><span class="op" id="6103977">*</span><span class="ident" id="6103978">mp</span><span class="op" id="6103980">)</span><span class="op" id="6103981">.</span><span class="ident" id="6103982">Y</span>&nbsp;<span class="op" id="6103984">+=</span>&nbsp;<span class="ident" id="6103987">dy</span><br>
<span class="lineno"></span><span class="op" id="6103990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="6103993">func</span>&nbsp;<span class="ident" id="6103998">processBackward</span><span class="op" id="6104013">(</span><span class="ident" id="6104014">dst</span>&nbsp;<span class="ident" id="6104018">Image</span><span class="op" id="6104023">,</span>&nbsp;<span class="ident" id="6104025">r</span>&nbsp;<span class="ident" id="6104027">image</span><span class="op" id="6104032">.</span><span class="ident" id="6104033">Rectangle</span><span class="op" id="6104042">,</span>&nbsp;<span class="ident" id="6104044">src</span>&nbsp;<span class="ident" id="6104048">image</span><span class="op" id="6104053">.</span><span class="ident" id="6104054">Image</span><span class="op" id="6104059">,</span>&nbsp;<span class="ident" id="6104061">sp</span>&nbsp;<span class="ident" id="6104064">image</span><span class="op" id="6104069">.</span><span class="ident" id="6104070">Point</span><span class="op" id="6104075">)</span>&nbsp;<span class="builtintype" id="6104077">bool</span>&nbsp;<span class="op" id="6104082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104085">return</span>&nbsp;<span class="ident" id="6104092">image</span><span class="op" id="6104097">.</span><span class="ident" id="6104098">Image</span><span class="op" id="6104103">(</span><span class="ident" id="6104104">dst</span><span class="op" id="6104107">)</span>&nbsp;<span class="op" id="6104109">==</span>&nbsp;<span class="ident" id="6104112">src</span>&nbsp;<span class="op" id="6104116">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6104121">r</span><span class="op" id="6104122">.</span><span class="ident" id="6104123">Overlaps</span><span class="op" id="6104131">(</span><span class="ident" id="6104132">r</span><span class="op" id="6104133">.</span><span class="ident" id="6104134">Add</span><span class="op" id="6104137">(</span><span class="ident" id="6104138">sp</span><span class="op" id="6104140">.</span><span class="ident" id="6104141">Sub</span><span class="op" id="6104144">(</span><span class="ident" id="6104145">r</span><span class="op" id="6104146">.</span><span class="ident" id="6104147">Min</span><span class="op" id="6104150">)</span><span class="op" id="6104151">)</span><span class="op" id="6104152">)</span>&nbsp;<span class="op" id="6104154">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6104159">(</span><span class="ident" id="6104160">sp</span><span class="op" id="6104162">.</span><span class="ident" id="6104163">Y</span>&nbsp;<span class="op" id="6104165">&lt;</span>&nbsp;<span class="ident" id="6104167">r</span><span class="op" id="6104168">.</span><span class="ident" id="6104169">Min</span><span class="op" id="6104172">.</span><span class="ident" id="6104173">Y</span>&nbsp;<span class="op" id="6104175">||</span>&nbsp;<span class="op" id="6104178">(</span><span class="ident" id="6104179">sp</span><span class="op" id="6104181">.</span><span class="ident" id="6104182">Y</span>&nbsp;<span class="op" id="6104184">==</span>&nbsp;<span class="ident" id="6104187">r</span><span class="op" id="6104188">.</span><span class="ident" id="6104189">Min</span><span class="op" id="6104192">.</span><span class="ident" id="6104193">Y</span>&nbsp;<span class="op" id="6104195">&amp;&amp;</span>&nbsp;<span class="ident" id="6104198">sp</span><span class="op" id="6104200">.</span><span class="ident" id="6104201">X</span>&nbsp;<span class="op" id="6104203">&lt;</span>&nbsp;<span class="ident" id="6104205">r</span><span class="op" id="6104206">.</span><span class="ident" id="6104207">Min</span><span class="op" id="6104210">.</span><span class="ident" id="6104211">X</span><span class="op" id="6104212">)</span><span class="op" id="6104213">)</span><br>
<span class="lineno"></span><span class="op" id="6104215">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="6104218">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="6104258">func</span>&nbsp;<span class="ident" id="6104263">Draw</span><span class="op" id="6104267">(</span><span class="ident" id="6104268">dst</span>&nbsp;<span class="ident" id="6104272">Image</span><span class="op" id="6104277">,</span>&nbsp;<span class="ident" id="6104279">r</span>&nbsp;<span class="ident" id="6104281">image</span><span class="op" id="6104286">.</span><span class="ident" id="6104287">Rectangle</span><span class="op" id="6104296">,</span>&nbsp;<span class="ident" id="6104298">src</span>&nbsp;<span class="ident" id="6104302">image</span><span class="op" id="6104307">.</span><span class="ident" id="6104308">Image</span><span class="op" id="6104313">,</span>&nbsp;<span class="ident" id="6104315">sp</span>&nbsp;<span class="ident" id="6104318">image</span><span class="op" id="6104323">.</span><span class="ident" id="6104324">Point</span><span class="op" id="6104329">,</span>&nbsp;<span class="ident" id="6104331">op</span>&nbsp;<span class="ident" id="6104334">Op</span><span class="op" id="6104336">)</span>&nbsp;<span class="op" id="6104338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6104341">DrawMask</span><span class="op" id="6104349">(</span><span class="ident" id="6104350">dst</span><span class="op" id="6104353">,</span>&nbsp;<span class="ident" id="6104355">r</span><span class="op" id="6104356">,</span>&nbsp;<span class="ident" id="6104358">src</span><span class="op" id="6104361">,</span>&nbsp;<span class="ident" id="6104363">sp</span><span class="op" id="6104365">,</span>&nbsp;<span class="builtintype" id="6104367">nil</span><span class="op" id="6104370">,</span>&nbsp;<span class="ident" id="6104372">image</span><span class="op" id="6104377">.</span><span class="ident" id="6104378">Point</span><span class="op" id="6104383">{</span><span class="op" id="6104384">}</span><span class="op" id="6104385">,</span>&nbsp;<span class="ident" id="6104387">op</span><span class="op" id="6104389">)</span><br>
<span class="lineno"></span><span class="op" id="6104391">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6104394">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="6104490">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="6104579">func</span>&nbsp;<span class="ident" id="6104584">DrawMask</span><span class="op" id="6104592">(</span><span class="ident" id="6104593">dst</span>&nbsp;<span class="ident" id="6104597">Image</span><span class="op" id="6104602">,</span>&nbsp;<span class="ident" id="6104604">r</span>&nbsp;<span class="ident" id="6104606">image</span><span class="op" id="6104611">.</span><span class="ident" id="6104612">Rectangle</span><span class="op" id="6104621">,</span>&nbsp;<span class="ident" id="6104623">src</span>&nbsp;<span class="ident" id="6104627">image</span><span class="op" id="6104632">.</span><span class="ident" id="6104633">Image</span><span class="op" id="6104638">,</span>&nbsp;<span class="ident" id="6104640">sp</span>&nbsp;<span class="ident" id="6104643">image</span><span class="op" id="6104648">.</span><span class="ident" id="6104649">Point</span><span class="op" id="6104654">,</span>&nbsp;<span class="ident" id="6104656">mask</span>&nbsp;<span class="ident" id="6104661">image</span><span class="op" id="6104666">.</span><span class="ident" id="6104667">Image</span><span class="op" id="6104672">,</span>&nbsp;<span class="ident" id="6104674">mp</span>&nbsp;<span class="ident" id="6104677">image</span><span class="op" id="6104682">.</span><span class="ident" id="6104683">Point</span><span class="op" id="6104688">,</span>&nbsp;<span class="ident" id="6104690">op</span>&nbsp;<span class="ident" id="6104693">Op</span><span class="op" id="6104695">)</span>&nbsp;<span class="op" id="6104697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6104700">clip</span><span class="op" id="6104704">(</span><span class="ident" id="6104705">dst</span><span class="op" id="6104708">,</span>&nbsp;<span class="op" id="6104710">&amp;</span><span class="ident" id="6104711">r</span><span class="op" id="6104712">,</span>&nbsp;<span class="ident" id="6104714">src</span><span class="op" id="6104717">,</span>&nbsp;<span class="op" id="6104719">&amp;</span><span class="ident" id="6104720">sp</span><span class="op" id="6104722">,</span>&nbsp;<span class="ident" id="6104724">mask</span><span class="op" id="6104728">,</span>&nbsp;<span class="op" id="6104730">&amp;</span><span class="ident" id="6104731">mp</span><span class="op" id="6104733">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104736">if</span>&nbsp;<span class="ident" id="6104739">r</span><span class="op" id="6104740">.</span><span class="ident" id="6104741">Empty</span><span class="op" id="6104746">(</span><span class="op" id="6104747">)</span>&nbsp;<span class="op" id="6104749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104753">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6104761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6104765">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104878">switch</span>&nbsp;<span class="ident" id="6104885">dst0</span>&nbsp;<span class="op" id="6104890">:=</span>&nbsp;<span class="ident" id="6104893">dst</span><span class="op" id="6104896">.</span><span class="op" id="6104897">(</span><span class="keyword" id="6104898">type</span><span class="op" id="6104902">)</span>&nbsp;<span class="op" id="6104904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104907">case</span>&nbsp;<span class="op" id="6104912">*</span><span class="ident" id="6104913">image</span><span class="op" id="6104918">.</span><span class="ident" id="6104919">RGBA</span><span class="op" id="6104923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104927">if</span>&nbsp;<span class="ident" id="6104930">op</span>&nbsp;<span class="op" id="6104933">==</span>&nbsp;<span class="ident" id="6104936">Over</span>&nbsp;<span class="op" id="6104941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104946">if</span>&nbsp;<span class="ident" id="6104949">mask</span>&nbsp;<span class="op" id="6104954">==</span>&nbsp;<span class="builtintype" id="6104957">nil</span>&nbsp;<span class="op" id="6104961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104967">switch</span>&nbsp;<span class="ident" id="6104974">src0</span>&nbsp;<span class="op" id="6104979">:=</span>&nbsp;<span class="ident" id="6104982">src</span><span class="op" id="6104985">.</span><span class="op" id="6104986">(</span><span class="keyword" id="6104987">type</span><span class="op" id="6104991">)</span>&nbsp;<span class="op" id="6104993">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6104999">case</span>&nbsp;<span class="op" id="6105004">*</span><span class="ident" id="6105005">image</span><span class="op" id="6105010">.</span><span class="ident" id="6105011">Uniform</span><span class="op" id="6105018">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105025">drawFillOver</span><span class="op" id="6105037">(</span><span class="ident" id="6105038">dst0</span><span class="op" id="6105042">,</span>&nbsp;<span class="ident" id="6105044">r</span><span class="op" id="6105045">,</span>&nbsp;<span class="ident" id="6105047">src0</span><span class="op" id="6105051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105058">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105069">case</span>&nbsp;<span class="op" id="6105074">*</span><span class="ident" id="6105075">image</span><span class="op" id="6105080">.</span><span class="ident" id="6105081">RGBA</span><span class="op" id="6105085">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105092">drawCopyOver</span><span class="op" id="6105104">(</span><span class="ident" id="6105105">dst0</span><span class="op" id="6105109">,</span>&nbsp;<span class="ident" id="6105111">r</span><span class="op" id="6105112">,</span>&nbsp;<span class="ident" id="6105114">src0</span><span class="op" id="6105118">,</span>&nbsp;<span class="ident" id="6105120">sp</span><span class="op" id="6105122">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105129">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105140">case</span>&nbsp;<span class="op" id="6105145">*</span><span class="ident" id="6105146">image</span><span class="op" id="6105151">.</span><span class="ident" id="6105152">NRGBA</span><span class="op" id="6105157">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105164">drawNRGBAOver</span><span class="op" id="6105177">(</span><span class="ident" id="6105178">dst0</span><span class="op" id="6105182">,</span>&nbsp;<span class="ident" id="6105184">r</span><span class="op" id="6105185">,</span>&nbsp;<span class="ident" id="6105187">src0</span><span class="op" id="6105191">,</span>&nbsp;<span class="ident" id="6105193">sp</span><span class="op" id="6105195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105202">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105213">case</span>&nbsp;<span class="op" id="6105218">*</span><span class="ident" id="6105219">image</span><span class="op" id="6105224">.</span><span class="ident" id="6105225">YCbCr</span><span class="op" id="6105230">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105237">if</span>&nbsp;<span class="ident" id="6105240">drawYCbCr</span><span class="op" id="6105249">(</span><span class="ident" id="6105250">dst0</span><span class="op" id="6105254">,</span>&nbsp;<span class="ident" id="6105256">r</span><span class="op" id="6105257">,</span>&nbsp;<span class="ident" id="6105259">src0</span><span class="op" id="6105263">,</span>&nbsp;<span class="ident" id="6105265">sp</span><span class="op" id="6105267">)</span>&nbsp;<span class="op" id="6105269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105277">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105300">}</span>&nbsp;<span class="keyword" id="6105302">else</span>&nbsp;<span class="keyword" id="6105307">if</span>&nbsp;<span class="ident" id="6105310">mask0</span><span class="op" id="6105315">,</span>&nbsp;<span class="ident" id="6105317">ok</span>&nbsp;<span class="op" id="6105320">:=</span>&nbsp;<span class="ident" id="6105323">mask</span><span class="op" id="6105327">.</span><span class="op" id="6105328">(</span><span class="op" id="6105329">*</span><span class="ident" id="6105330">image</span><span class="op" id="6105335">.</span><span class="ident" id="6105336">Alpha</span><span class="op" id="6105341">)</span><span class="op" id="6105342">;</span>&nbsp;<span class="ident" id="6105344">ok</span>&nbsp;<span class="op" id="6105347">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105353">switch</span>&nbsp;<span class="ident" id="6105360">src0</span>&nbsp;<span class="op" id="6105365">:=</span>&nbsp;<span class="ident" id="6105368">src</span><span class="op" id="6105371">.</span><span class="op" id="6105372">(</span><span class="keyword" id="6105373">type</span><span class="op" id="6105377">)</span>&nbsp;<span class="op" id="6105379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105385">case</span>&nbsp;<span class="op" id="6105390">*</span><span class="ident" id="6105391">image</span><span class="op" id="6105396">.</span><span class="ident" id="6105397">Uniform</span><span class="op" id="6105404">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105411">drawGlyphOver</span><span class="op" id="6105424">(</span><span class="ident" id="6105425">dst0</span><span class="op" id="6105429">,</span>&nbsp;<span class="ident" id="6105431">r</span><span class="op" id="6105432">,</span>&nbsp;<span class="ident" id="6105434">src0</span><span class="op" id="6105438">,</span>&nbsp;<span class="ident" id="6105440">mask0</span><span class="op" id="6105445">,</span>&nbsp;<span class="ident" id="6105447">mp</span><span class="op" id="6105449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105456">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105467">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105476">}</span>&nbsp;<span class="keyword" id="6105478">else</span>&nbsp;<span class="op" id="6105483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105488">if</span>&nbsp;<span class="ident" id="6105491">mask</span>&nbsp;<span class="op" id="6105496">==</span>&nbsp;<span class="builtintype" id="6105499">nil</span>&nbsp;<span class="op" id="6105503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105509">switch</span>&nbsp;<span class="ident" id="6105516">src0</span>&nbsp;<span class="op" id="6105521">:=</span>&nbsp;<span class="ident" id="6105524">src</span><span class="op" id="6105527">.</span><span class="op" id="6105528">(</span><span class="keyword" id="6105529">type</span><span class="op" id="6105533">)</span>&nbsp;<span class="op" id="6105535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105541">case</span>&nbsp;<span class="op" id="6105546">*</span><span class="ident" id="6105547">image</span><span class="op" id="6105552">.</span><span class="ident" id="6105553">Uniform</span><span class="op" id="6105560">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105567">drawFillSrc</span><span class="op" id="6105578">(</span><span class="ident" id="6105579">dst0</span><span class="op" id="6105583">,</span>&nbsp;<span class="ident" id="6105585">r</span><span class="op" id="6105586">,</span>&nbsp;<span class="ident" id="6105588">src0</span><span class="op" id="6105592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105599">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105610">case</span>&nbsp;<span class="op" id="6105615">*</span><span class="ident" id="6105616">image</span><span class="op" id="6105621">.</span><span class="ident" id="6105622">RGBA</span><span class="op" id="6105626">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105633">drawCopySrc</span><span class="op" id="6105644">(</span><span class="ident" id="6105645">dst0</span><span class="op" id="6105649">,</span>&nbsp;<span class="ident" id="6105651">r</span><span class="op" id="6105652">,</span>&nbsp;<span class="ident" id="6105654">src0</span><span class="op" id="6105658">,</span>&nbsp;<span class="ident" id="6105660">sp</span><span class="op" id="6105662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105669">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105680">case</span>&nbsp;<span class="op" id="6105685">*</span><span class="ident" id="6105686">image</span><span class="op" id="6105691">.</span><span class="ident" id="6105692">NRGBA</span><span class="op" id="6105697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105704">drawNRGBASrc</span><span class="op" id="6105716">(</span><span class="ident" id="6105717">dst0</span><span class="op" id="6105721">,</span>&nbsp;<span class="ident" id="6105723">r</span><span class="op" id="6105724">,</span>&nbsp;<span class="ident" id="6105726">src0</span><span class="op" id="6105730">,</span>&nbsp;<span class="ident" id="6105732">sp</span><span class="op" id="6105734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105741">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105752">case</span>&nbsp;<span class="op" id="6105757">*</span><span class="ident" id="6105758">image</span><span class="op" id="6105763">.</span><span class="ident" id="6105764">YCbCr</span><span class="op" id="6105769">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105776">if</span>&nbsp;<span class="ident" id="6105779">drawYCbCr</span><span class="op" id="6105788">(</span><span class="ident" id="6105789">dst0</span><span class="op" id="6105793">,</span>&nbsp;<span class="ident" id="6105795">r</span><span class="op" id="6105796">,</span>&nbsp;<span class="ident" id="6105798">src0</span><span class="op" id="6105802">,</span>&nbsp;<span class="ident" id="6105804">sp</span><span class="op" id="6105806">)</span>&nbsp;<span class="op" id="6105808">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105816">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6105843">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105847">drawRGBA</span><span class="op" id="6105855">(</span><span class="ident" id="6105856">dst0</span><span class="op" id="6105860">,</span>&nbsp;<span class="ident" id="6105862">r</span><span class="op" id="6105863">,</span>&nbsp;<span class="ident" id="6105865">src</span><span class="op" id="6105868">,</span>&nbsp;<span class="ident" id="6105870">sp</span><span class="op" id="6105872">,</span>&nbsp;<span class="ident" id="6105874">mask</span><span class="op" id="6105878">,</span>&nbsp;<span class="ident" id="6105880">mp</span><span class="op" id="6105882">,</span>&nbsp;<span class="ident" id="6105884">op</span><span class="op" id="6105886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105890">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105898">case</span>&nbsp;<span class="op" id="6105903">*</span><span class="ident" id="6105904">image</span><span class="op" id="6105909">.</span><span class="ident" id="6105910">Paletted</span><span class="op" id="6105918">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6105922">if</span>&nbsp;<span class="ident" id="6105925">op</span>&nbsp;<span class="op" id="6105928">==</span>&nbsp;<span class="ident" id="6105931">Src</span>&nbsp;<span class="op" id="6105935">&amp;&amp;</span>&nbsp;<span class="ident" id="6105938">mask</span>&nbsp;<span class="op" id="6105943">==</span>&nbsp;<span class="builtintype" id="6105946">nil</span>&nbsp;<span class="op" id="6105950">&amp;&amp;</span>&nbsp;<span class="op" id="6105953">!</span><span class="ident" id="6105954">processBackward</span><span class="op" id="6105969">(</span><span class="ident" id="6105970">dst</span><span class="op" id="6105973">,</span>&nbsp;<span class="ident" id="6105975">r</span><span class="op" id="6105976">,</span>&nbsp;<span class="ident" id="6105978">src</span><span class="op" id="6105981">,</span>&nbsp;<span class="ident" id="6105983">sp</span><span class="op" id="6105985">)</span>&nbsp;<span class="op" id="6105987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6105992">drawPaletted</span><span class="op" id="6106004">(</span><span class="ident" id="6106005">dst0</span><span class="op" id="6106009">,</span>&nbsp;<span class="ident" id="6106011">r</span><span class="op" id="6106012">,</span>&nbsp;<span class="ident" id="6106014">src</span><span class="op" id="6106017">,</span>&nbsp;<span class="ident" id="6106019">sp</span><span class="op" id="6106021">,</span>&nbsp;<span class="builtintype" id="6106023">false</span><span class="op" id="6106028">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6106032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6106035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106039">x0</span><span class="op" id="6106041">,</span>&nbsp;<span class="ident" id="6106043">x1</span><span class="op" id="6106045">,</span>&nbsp;<span class="ident" id="6106047">dx</span>&nbsp;<span class="op" id="6106050">:=</span>&nbsp;<span class="ident" id="6106053">r</span><span class="op" id="6106054">.</span><span class="ident" id="6106055">Min</span><span class="op" id="6106058">.</span><span class="ident" id="6106059">X</span><span class="op" id="6106060">,</span>&nbsp;<span class="ident" id="6106062">r</span><span class="op" id="6106063">.</span><span class="ident" id="6106064">Max</span><span class="op" id="6106067">.</span><span class="ident" id="6106068">X</span><span class="op" id="6106069">,</span>&nbsp;<span class="num" id="6106071">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106074">y0</span><span class="op" id="6106076">,</span>&nbsp;<span class="ident" id="6106078">y1</span><span class="op" id="6106080">,</span>&nbsp;<span class="ident" id="6106082">dy</span>&nbsp;<span class="op" id="6106085">:=</span>&nbsp;<span class="ident" id="6106088">r</span><span class="op" id="6106089">.</span><span class="ident" id="6106090">Min</span><span class="op" id="6106093">.</span><span class="ident" id="6106094">Y</span><span class="op" id="6106095">,</span>&nbsp;<span class="ident" id="6106097">r</span><span class="op" id="6106098">.</span><span class="ident" id="6106099">Max</span><span class="op" id="6106102">.</span><span class="ident" id="6106103">Y</span><span class="op" id="6106104">,</span>&nbsp;<span class="num" id="6106106">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106109">if</span>&nbsp;<span class="ident" id="6106112">processBackward</span><span class="op" id="6106127">(</span><span class="ident" id="6106128">dst</span><span class="op" id="6106131">,</span>&nbsp;<span class="ident" id="6106133">r</span><span class="op" id="6106134">,</span>&nbsp;<span class="ident" id="6106136">src</span><span class="op" id="6106139">,</span>&nbsp;<span class="ident" id="6106141">sp</span><span class="op" id="6106143">)</span>&nbsp;<span class="op" id="6106145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106149">x0</span><span class="op" id="6106151">,</span>&nbsp;<span class="ident" id="6106153">x1</span><span class="op" id="6106155">,</span>&nbsp;<span class="ident" id="6106157">dx</span>&nbsp;<span class="op" id="6106160">=</span>&nbsp;<span class="ident" id="6106162">x1</span><span class="op" id="6106164">-</span><span class="num" id="6106165">1</span><span class="op" id="6106166">,</span>&nbsp;<span class="ident" id="6106168">x0</span><span class="op" id="6106170">-</span><span class="num" id="6106171">1</span><span class="op" id="6106172">,</span>&nbsp;<span class="op" id="6106174">-</span><span class="num" id="6106175">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106179">y0</span><span class="op" id="6106181">,</span>&nbsp;<span class="ident" id="6106183">y1</span><span class="op" id="6106185">,</span>&nbsp;<span class="ident" id="6106187">dy</span>&nbsp;<span class="op" id="6106190">=</span>&nbsp;<span class="ident" id="6106192">y1</span><span class="op" id="6106194">-</span><span class="num" id="6106195">1</span><span class="op" id="6106196">,</span>&nbsp;<span class="ident" id="6106198">y0</span><span class="op" id="6106200">-</span><span class="num" id="6106201">1</span><span class="op" id="6106202">,</span>&nbsp;<span class="op" id="6106204">-</span><span class="num" id="6106205">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6106208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106212">var</span>&nbsp;<span class="ident" id="6106216">out</span>&nbsp;<span class="ident" id="6106220">color</span><span class="op" id="6106225">.</span><span class="ident" id="6106226">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106234">sy</span>&nbsp;<span class="op" id="6106237">:=</span>&nbsp;<span class="ident" id="6106240">sp</span><span class="op" id="6106242">.</span><span class="ident" id="6106243">Y</span>&nbsp;<span class="op" id="6106245">+</span>&nbsp;<span class="ident" id="6106247">y0</span>&nbsp;<span class="op" id="6106250">-</span>&nbsp;<span class="ident" id="6106252">r</span><span class="op" id="6106253">.</span><span class="ident" id="6106254">Min</span><span class="op" id="6106257">.</span><span class="ident" id="6106258">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106261">my</span>&nbsp;<span class="op" id="6106264">:=</span>&nbsp;<span class="ident" id="6106267">mp</span><span class="op" id="6106269">.</span><span class="ident" id="6106270">Y</span>&nbsp;<span class="op" id="6106272">+</span>&nbsp;<span class="ident" id="6106274">y0</span>&nbsp;<span class="op" id="6106277">-</span>&nbsp;<span class="ident" id="6106279">r</span><span class="op" id="6106280">.</span><span class="ident" id="6106281">Min</span><span class="op" id="6106284">.</span><span class="ident" id="6106285">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106288">for</span>&nbsp;<span class="ident" id="6106292">y</span>&nbsp;<span class="op" id="6106294">:=</span>&nbsp;<span class="ident" id="6106297">y0</span><span class="op" id="6106299">;</span>&nbsp;<span class="ident" id="6106301">y</span>&nbsp;<span class="op" id="6106303">!=</span>&nbsp;<span class="ident" id="6106306">y1</span><span class="op" id="6106308">;</span>&nbsp;<span class="ident" id="6106310">y</span><span class="op" id="6106311">,</span>&nbsp;<span class="ident" id="6106313">sy</span><span class="op" id="6106315">,</span>&nbsp;<span class="ident" id="6106317">my</span>&nbsp;<span class="op" id="6106320">=</span>&nbsp;<span class="ident" id="6106322">y</span><span class="op" id="6106323">+</span><span class="ident" id="6106324">dy</span><span class="op" id="6106326">,</span>&nbsp;<span class="ident" id="6106328">sy</span><span class="op" id="6106330">+</span><span class="ident" id="6106331">dy</span><span class="op" id="6106333">,</span>&nbsp;<span class="ident" id="6106335">my</span><span class="op" id="6106337">+</span><span class="ident" id="6106338">dy</span>&nbsp;<span class="op" id="6106341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106345">sx</span>&nbsp;<span class="op" id="6106348">:=</span>&nbsp;<span class="ident" id="6106351">sp</span><span class="op" id="6106353">.</span><span class="ident" id="6106354">X</span>&nbsp;<span class="op" id="6106356">+</span>&nbsp;<span class="ident" id="6106358">x0</span>&nbsp;<span class="op" id="6106361">-</span>&nbsp;<span class="ident" id="6106363">r</span><span class="op" id="6106364">.</span><span class="ident" id="6106365">Min</span><span class="op" id="6106368">.</span><span class="ident" id="6106369">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106373">mx</span>&nbsp;<span class="op" id="6106376">:=</span>&nbsp;<span class="ident" id="6106379">mp</span><span class="op" id="6106381">.</span><span class="ident" id="6106382">X</span>&nbsp;<span class="op" id="6106384">+</span>&nbsp;<span class="ident" id="6106386">x0</span>&nbsp;<span class="op" id="6106389">-</span>&nbsp;<span class="ident" id="6106391">r</span><span class="op" id="6106392">.</span><span class="ident" id="6106393">Min</span><span class="op" id="6106396">.</span><span class="ident" id="6106397">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106401">for</span>&nbsp;<span class="ident" id="6106405">x</span>&nbsp;<span class="op" id="6106407">:=</span>&nbsp;<span class="ident" id="6106410">x0</span><span class="op" id="6106412">;</span>&nbsp;<span class="ident" id="6106414">x</span>&nbsp;<span class="op" id="6106416">!=</span>&nbsp;<span class="ident" id="6106419">x1</span><span class="op" id="6106421">;</span>&nbsp;<span class="ident" id="6106423">x</span><span class="op" id="6106424">,</span>&nbsp;<span class="ident" id="6106426">sx</span><span class="op" id="6106428">,</span>&nbsp;<span class="ident" id="6106430">mx</span>&nbsp;<span class="op" id="6106433">=</span>&nbsp;<span class="ident" id="6106435">x</span><span class="op" id="6106436">+</span><span class="ident" id="6106437">dx</span><span class="op" id="6106439">,</span>&nbsp;<span class="ident" id="6106441">sx</span><span class="op" id="6106443">+</span><span class="ident" id="6106444">dx</span><span class="op" id="6106446">,</span>&nbsp;<span class="ident" id="6106448">mx</span><span class="op" id="6106450">+</span><span class="ident" id="6106451">dx</span>&nbsp;<span class="op" id="6106454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106459">ma</span>&nbsp;<span class="op" id="6106462">:=</span>&nbsp;<span class="builtintype" id="6106465">uint32</span><span class="op" id="6106471">(</span><span class="ident" id="6106472">m</span><span class="op" id="6106473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106478">if</span>&nbsp;<span class="ident" id="6106481">mask</span>&nbsp;<span class="op" id="6106486">!=</span>&nbsp;<span class="builtintype" id="6106489">nil</span>&nbsp;<span class="op" id="6106493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106499">_</span><span class="op" id="6106500">,</span>&nbsp;<span class="ident" id="6106502">_</span><span class="op" id="6106503">,</span>&nbsp;<span class="ident" id="6106505">_</span><span class="op" id="6106506">,</span>&nbsp;<span class="ident" id="6106508">ma</span>&nbsp;<span class="op" id="6106511">=</span>&nbsp;<span class="ident" id="6106513">mask</span><span class="op" id="6106517">.</span><span class="ident" id="6106518">At</span><span class="op" id="6106520">(</span><span class="ident" id="6106521">mx</span><span class="op" id="6106523">,</span>&nbsp;<span class="ident" id="6106525">my</span><span class="op" id="6106527">)</span><span class="op" id="6106528">.</span><span class="ident" id="6106529">RGBA</span><span class="op" id="6106533">(</span><span class="op" id="6106534">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6106539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106544">switch</span>&nbsp;<span class="op" id="6106551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106556">case</span>&nbsp;<span class="ident" id="6106561">ma</span>&nbsp;<span class="op" id="6106564">==</span>&nbsp;<span class="num" id="6106567">0</span><span class="op" id="6106568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106574">if</span>&nbsp;<span class="ident" id="6106577">op</span>&nbsp;<span class="op" id="6106580">==</span>&nbsp;<span class="ident" id="6106583">Over</span>&nbsp;<span class="op" id="6106588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6106595">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6106609">}</span>&nbsp;<span class="keyword" id="6106611">else</span>&nbsp;<span class="op" id="6106616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106623">dst</span><span class="op" id="6106626">.</span><span class="ident" id="6106627">Set</span><span class="op" id="6106630">(</span><span class="ident" id="6106631">x</span><span class="op" id="6106632">,</span>&nbsp;<span class="ident" id="6106634">y</span><span class="op" id="6106635">,</span>&nbsp;<span class="ident" id="6106637">color</span><span class="op" id="6106642">.</span><span class="ident" id="6106643">Transparent</span><span class="op" id="6106654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6106660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106665">case</span>&nbsp;<span class="ident" id="6106670">ma</span>&nbsp;<span class="op" id="6106673">==</span>&nbsp;<span class="ident" id="6106676">m</span>&nbsp;<span class="op" id="6106678">&amp;&amp;</span>&nbsp;<span class="ident" id="6106681">op</span>&nbsp;<span class="op" id="6106684">==</span>&nbsp;<span class="ident" id="6106687">Src</span><span class="op" id="6106690">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106696">dst</span><span class="op" id="6106699">.</span><span class="ident" id="6106700">Set</span><span class="op" id="6106703">(</span><span class="ident" id="6106704">x</span><span class="op" id="6106705">,</span>&nbsp;<span class="ident" id="6106707">y</span><span class="op" id="6106708">,</span>&nbsp;<span class="ident" id="6106710">src</span><span class="op" id="6106713">.</span><span class="ident" id="6106714">At</span><span class="op" id="6106716">(</span><span class="ident" id="6106717">sx</span><span class="op" id="6106719">,</span>&nbsp;<span class="ident" id="6106721">sy</span><span class="op" id="6106723">)</span><span class="op" id="6106724">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106729">default</span><span class="op" id="6106736">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106742">sr</span><span class="op" id="6106744">,</span>&nbsp;<span class="ident" id="6106746">sg</span><span class="op" id="6106748">,</span>&nbsp;<span class="ident" id="6106750">sb</span><span class="op" id="6106752">,</span>&nbsp;<span class="ident" id="6106754">sa</span>&nbsp;<span class="op" id="6106757">:=</span>&nbsp;<span class="ident" id="6106760">src</span><span class="op" id="6106763">.</span><span class="ident" id="6106764">At</span><span class="op" id="6106766">(</span><span class="ident" id="6106767">sx</span><span class="op" id="6106769">,</span>&nbsp;<span class="ident" id="6106771">sy</span><span class="op" id="6106773">)</span><span class="op" id="6106774">.</span><span class="ident" id="6106775">RGBA</span><span class="op" id="6106779">(</span><span class="op" id="6106780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6106786">if</span>&nbsp;<span class="ident" id="6106789">op</span>&nbsp;<span class="op" id="6106792">==</span>&nbsp;<span class="ident" id="6106795">Over</span>&nbsp;<span class="op" id="6106800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106807">dr</span><span class="op" id="6106809">,</span>&nbsp;<span class="ident" id="6106811">dg</span><span class="op" id="6106813">,</span>&nbsp;<span class="ident" id="6106815">db</span><span class="op" id="6106817">,</span>&nbsp;<span class="ident" id="6106819">da</span>&nbsp;<span class="op" id="6106822">:=</span>&nbsp;<span class="ident" id="6106825">dst</span><span class="op" id="6106828">.</span><span class="ident" id="6106829">At</span><span class="op" id="6106831">(</span><span class="ident" id="6106832">x</span><span class="op" id="6106833">,</span>&nbsp;<span class="ident" id="6106835">y</span><span class="op" id="6106836">)</span><span class="op" id="6106837">.</span><span class="ident" id="6106838">RGBA</span><span class="op" id="6106842">(</span><span class="op" id="6106843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106850">a</span>&nbsp;<span class="op" id="6106852">:=</span>&nbsp;<span class="ident" id="6106855">m</span>&nbsp;<span class="op" id="6106857">-</span>&nbsp;<span class="op" id="6106859">(</span><span class="ident" id="6106860">sa</span>&nbsp;<span class="op" id="6106863">*</span>&nbsp;<span class="ident" id="6106865">ma</span>&nbsp;<span class="op" id="6106868">/</span>&nbsp;<span class="ident" id="6106870">m</span><span class="op" id="6106871">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106878">out</span><span class="op" id="6106881">.</span><span class="ident" id="6106882">R</span>&nbsp;<span class="op" id="6106884">=</span>&nbsp;<span class="builtintype" id="6106886">uint16</span><span class="op" id="6106892">(</span><span class="op" id="6106893">(</span><span class="ident" id="6106894">dr</span><span class="op" id="6106896">*</span><span class="ident" id="6106897">a</span>&nbsp;<span class="op" id="6106899">+</span>&nbsp;<span class="ident" id="6106901">sr</span><span class="op" id="6106903">*</span><span class="ident" id="6106904">ma</span><span class="op" id="6106906">)</span>&nbsp;<span class="op" id="6106908">/</span>&nbsp;<span class="ident" id="6106910">m</span><span class="op" id="6106911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106918">out</span><span class="op" id="6106921">.</span><span class="ident" id="6106922">G</span>&nbsp;<span class="op" id="6106924">=</span>&nbsp;<span class="builtintype" id="6106926">uint16</span><span class="op" id="6106932">(</span><span class="op" id="6106933">(</span><span class="ident" id="6106934">dg</span><span class="op" id="6106936">*</span><span class="ident" id="6106937">a</span>&nbsp;<span class="op" id="6106939">+</span>&nbsp;<span class="ident" id="6106941">sg</span><span class="op" id="6106943">*</span><span class="ident" id="6106944">ma</span><span class="op" id="6106946">)</span>&nbsp;<span class="op" id="6106948">/</span>&nbsp;<span class="ident" id="6106950">m</span><span class="op" id="6106951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106958">out</span><span class="op" id="6106961">.</span><span class="ident" id="6106962">B</span>&nbsp;<span class="op" id="6106964">=</span>&nbsp;<span class="builtintype" id="6106966">uint16</span><span class="op" id="6106972">(</span><span class="op" id="6106973">(</span><span class="ident" id="6106974">db</span><span class="op" id="6106976">*</span><span class="ident" id="6106977">a</span>&nbsp;<span class="op" id="6106979">+</span>&nbsp;<span class="ident" id="6106981">sb</span><span class="op" id="6106983">*</span><span class="ident" id="6106984">ma</span><span class="op" id="6106986">)</span>&nbsp;<span class="op" id="6106988">/</span>&nbsp;<span class="ident" id="6106990">m</span><span class="op" id="6106991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6106998">out</span><span class="op" id="6107001">.</span><span class="ident" id="6107002">A</span>&nbsp;<span class="op" id="6107004">=</span>&nbsp;<span class="builtintype" id="6107006">uint16</span><span class="op" id="6107012">(</span><span class="op" id="6107013">(</span><span class="ident" id="6107014">da</span><span class="op" id="6107016">*</span><span class="ident" id="6107017">a</span>&nbsp;<span class="op" id="6107019">+</span>&nbsp;<span class="ident" id="6107021">sa</span><span class="op" id="6107023">*</span><span class="ident" id="6107024">ma</span><span class="op" id="6107026">)</span>&nbsp;<span class="op" id="6107028">/</span>&nbsp;<span class="ident" id="6107030">m</span><span class="op" id="6107031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6107037">}</span>&nbsp;<span class="keyword" id="6107039">else</span>&nbsp;<span class="op" id="6107044">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107051">out</span><span class="op" id="6107054">.</span><span class="ident" id="6107055">R</span>&nbsp;<span class="op" id="6107057">=</span>&nbsp;<span class="builtintype" id="6107059">uint16</span><span class="op" id="6107065">(</span><span class="ident" id="6107066">sr</span>&nbsp;<span class="op" id="6107069">*</span>&nbsp;<span class="ident" id="6107071">ma</span>&nbsp;<span class="op" id="6107074">/</span>&nbsp;<span class="ident" id="6107076">m</span><span class="op" id="6107077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107084">out</span><span class="op" id="6107087">.</span><span class="ident" id="6107088">G</span>&nbsp;<span class="op" id="6107090">=</span>&nbsp;<span class="builtintype" id="6107092">uint16</span><span class="op" id="6107098">(</span><span class="ident" id="6107099">sg</span>&nbsp;<span class="op" id="6107102">*</span>&nbsp;<span class="ident" id="6107104">ma</span>&nbsp;<span class="op" id="6107107">/</span>&nbsp;<span class="ident" id="6107109">m</span><span class="op" id="6107110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107117">out</span><span class="op" id="6107120">.</span><span class="ident" id="6107121">B</span>&nbsp;<span class="op" id="6107123">=</span>&nbsp;<span class="builtintype" id="6107125">uint16</span><span class="op" id="6107131">(</span><span class="ident" id="6107132">sb</span>&nbsp;<span class="op" id="6107135">*</span>&nbsp;<span class="ident" id="6107137">ma</span>&nbsp;<span class="op" id="6107140">/</span>&nbsp;<span class="ident" id="6107142">m</span><span class="op" id="6107143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107150">out</span><span class="op" id="6107153">.</span><span class="ident" id="6107154">A</span>&nbsp;<span class="op" id="6107156">=</span>&nbsp;<span class="builtintype" id="6107158">uint16</span><span class="op" id="6107164">(</span><span class="ident" id="6107165">sa</span>&nbsp;<span class="op" id="6107168">*</span>&nbsp;<span class="ident" id="6107170">ma</span>&nbsp;<span class="op" id="6107173">/</span>&nbsp;<span class="ident" id="6107175">m</span><span class="op" id="6107176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6107182">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6107188">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6107249">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6107314">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6107377">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107438">dst</span><span class="op" id="6107441">.</span><span class="ident" id="6107442">Set</span><span class="op" id="6107445">(</span><span class="ident" id="6107446">x</span><span class="op" id="6107447">,</span>&nbsp;<span class="ident" id="6107449">y</span><span class="op" id="6107450">,</span>&nbsp;<span class="op" id="6107452">&amp;</span><span class="ident" id="6107453">out</span><span class="op" id="6107456">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6107461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6107465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6107468">}</span><br>
<span class="lineno"></span><span class="op" id="6107470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="6107473">func</span>&nbsp;<span class="ident" id="6107478">drawFillOver</span><span class="op" id="6107490">(</span><span class="ident" id="6107491">dst</span>&nbsp;<span class="op" id="6107495">*</span><span class="ident" id="6107496">image</span><span class="op" id="6107501">.</span><span class="ident" id="6107502">RGBA</span><span class="op" id="6107506">,</span>&nbsp;<span class="ident" id="6107508">r</span>&nbsp;<span class="ident" id="6107510">image</span><span class="op" id="6107515">.</span><span class="ident" id="6107516">Rectangle</span><span class="op" id="6107525">,</span>&nbsp;<span class="ident" id="6107527">src</span>&nbsp;<span class="op" id="6107531">*</span><span class="ident" id="6107532">image</span><span class="op" id="6107537">.</span><span class="ident" id="6107538">Uniform</span><span class="op" id="6107545">)</span>&nbsp;<span class="op" id="6107547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107550">sr</span><span class="op" id="6107552">,</span>&nbsp;<span class="ident" id="6107554">sg</span><span class="op" id="6107556">,</span>&nbsp;<span class="ident" id="6107558">sb</span><span class="op" id="6107560">,</span>&nbsp;<span class="ident" id="6107562">sa</span>&nbsp;<span class="op" id="6107565">:=</span>&nbsp;<span class="ident" id="6107568">src</span><span class="op" id="6107571">.</span><span class="ident" id="6107572">RGBA</span><span class="op" id="6107576">(</span><span class="op" id="6107577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6107580">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107638">a</span>&nbsp;<span class="op" id="6107640">:=</span>&nbsp;<span class="op" id="6107643">(</span><span class="ident" id="6107644">m</span>&nbsp;<span class="op" id="6107646">-</span>&nbsp;<span class="ident" id="6107648">sa</span><span class="op" id="6107650">)</span>&nbsp;<span class="op" id="6107652">*</span>&nbsp;<span class="num" id="6107654">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107661">i0</span>&nbsp;<span class="op" id="6107664">:=</span>&nbsp;<span class="ident" id="6107667">dst</span><span class="op" id="6107670">.</span><span class="ident" id="6107671">PixOffset</span><span class="op" id="6107680">(</span><span class="ident" id="6107681">r</span><span class="op" id="6107682">.</span><span class="ident" id="6107683">Min</span><span class="op" id="6107686">.</span><span class="ident" id="6107687">X</span><span class="op" id="6107688">,</span>&nbsp;<span class="ident" id="6107690">r</span><span class="op" id="6107691">.</span><span class="ident" id="6107692">Min</span><span class="op" id="6107695">.</span><span class="ident" id="6107696">Y</span><span class="op" id="6107697">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107700">i1</span>&nbsp;<span class="op" id="6107703">:=</span>&nbsp;<span class="ident" id="6107706">i0</span>&nbsp;<span class="op" id="6107709">+</span>&nbsp;<span class="ident" id="6107711">r</span><span class="op" id="6107712">.</span><span class="ident" id="6107713">Dx</span><span class="op" id="6107715">(</span><span class="op" id="6107716">)</span><span class="op" id="6107717">*</span><span class="num" id="6107718">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6107721">for</span>&nbsp;<span class="ident" id="6107725">y</span>&nbsp;<span class="op" id="6107727">:=</span>&nbsp;<span class="ident" id="6107730">r</span><span class="op" id="6107731">.</span><span class="ident" id="6107732">Min</span><span class="op" id="6107735">.</span><span class="ident" id="6107736">Y</span><span class="op" id="6107737">;</span>&nbsp;<span class="ident" id="6107739">y</span>&nbsp;<span class="op" id="6107741">!=</span>&nbsp;<span class="ident" id="6107744">r</span><span class="op" id="6107745">.</span><span class="ident" id="6107746">Max</span><span class="op" id="6107749">.</span><span class="ident" id="6107750">Y</span><span class="op" id="6107751">;</span>&nbsp;<span class="ident" id="6107753">y</span><span class="op" id="6107754">++</span>&nbsp;<span class="op" id="6107757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6107761">for</span>&nbsp;<span class="ident" id="6107765">i</span>&nbsp;<span class="op" id="6107767">:=</span>&nbsp;<span class="ident" id="6107770">i0</span><span class="op" id="6107772">;</span>&nbsp;<span class="ident" id="6107774">i</span>&nbsp;<span class="op" id="6107776">&lt;</span>&nbsp;<span class="ident" id="6107778">i1</span><span class="op" id="6107780">;</span>&nbsp;<span class="ident" id="6107782">i</span>&nbsp;<span class="op" id="6107784">+=</span>&nbsp;<span class="num" id="6107787">4</span>&nbsp;<span class="op" id="6107789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107794">dr</span>&nbsp;<span class="op" id="6107797">:=</span>&nbsp;<span class="builtintype" id="6107800">uint32</span><span class="op" id="6107806">(</span><span class="ident" id="6107807">dst</span><span class="op" id="6107810">.</span><span class="ident" id="6107811">Pix</span><span class="op" id="6107814">[</span><span class="ident" id="6107815">i</span><span class="op" id="6107816">+</span><span class="num" id="6107817">0</span><span class="op" id="6107818">]</span><span class="op" id="6107819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107824">dg</span>&nbsp;<span class="op" id="6107827">:=</span>&nbsp;<span class="builtintype" id="6107830">uint32</span><span class="op" id="6107836">(</span><span class="ident" id="6107837">dst</span><span class="op" id="6107840">.</span><span class="ident" id="6107841">Pix</span><span class="op" id="6107844">[</span><span class="ident" id="6107845">i</span><span class="op" id="6107846">+</span><span class="num" id="6107847">1</span><span class="op" id="6107848">]</span><span class="op" id="6107849">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107854">db</span>&nbsp;<span class="op" id="6107857">:=</span>&nbsp;<span class="builtintype" id="6107860">uint32</span><span class="op" id="6107866">(</span><span class="ident" id="6107867">dst</span><span class="op" id="6107870">.</span><span class="ident" id="6107871">Pix</span><span class="op" id="6107874">[</span><span class="ident" id="6107875">i</span><span class="op" id="6107876">+</span><span class="num" id="6107877">2</span><span class="op" id="6107878">]</span><span class="op" id="6107879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107884">da</span>&nbsp;<span class="op" id="6107887">:=</span>&nbsp;<span class="builtintype" id="6107890">uint32</span><span class="op" id="6107896">(</span><span class="ident" id="6107897">dst</span><span class="op" id="6107900">.</span><span class="ident" id="6107901">Pix</span><span class="op" id="6107904">[</span><span class="ident" id="6107905">i</span><span class="op" id="6107906">+</span><span class="num" id="6107907">3</span><span class="op" id="6107908">]</span><span class="op" id="6107909">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107915">dst</span><span class="op" id="6107918">.</span><span class="ident" id="6107919">Pix</span><span class="op" id="6107922">[</span><span class="ident" id="6107923">i</span><span class="op" id="6107924">+</span><span class="num" id="6107925">0</span><span class="op" id="6107926">]</span>&nbsp;<span class="op" id="6107928">=</span>&nbsp;<span class="builtintype" id="6107930">uint8</span><span class="op" id="6107935">(</span><span class="op" id="6107936">(</span><span class="ident" id="6107937">dr</span><span class="op" id="6107939">*</span><span class="ident" id="6107940">a</span><span class="op" id="6107941">/</span><span class="ident" id="6107942">m</span>&nbsp;<span class="op" id="6107944">+</span>&nbsp;<span class="ident" id="6107946">sr</span><span class="op" id="6107948">)</span>&nbsp;<span class="op" id="6107950">&gt;&gt;</span>&nbsp;<span class="num" id="6107953">8</span><span class="op" id="6107954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6107959">dst</span><span class="op" id="6107962">.</span><span class="ident" id="6107963">Pix</span><span class="op" id="6107966">[</span><span class="ident" id="6107967">i</span><span class="op" id="6107968">+</span><span class="num" id="6107969">1</span><span class="op" id="6107970">]</span>&nbsp;<span class="op" id="6107972">=</span>&nbsp;<span class="builtintype" id="6107974">uint8</span><span class="op" id="6107979">(</span><span class="op" id="6107980">(</span><span class="ident" id="6107981">dg</span><span class="op" id="6107983">*</span><span class="ident" id="6107984">a</span><span class="op" id="6107985">/</span><span class="ident" id="6107986">m</span>&nbsp;<span class="op" id="6107988">+</span>&nbsp;<span class="ident" id="6107990">sg</span><span class="op" id="6107992">)</span>&nbsp;<span class="op" id="6107994">&gt;&gt;</span>&nbsp;<span class="num" id="6107997">8</span><span class="op" id="6107998">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108003">dst</span><span class="op" id="6108006">.</span><span class="ident" id="6108007">Pix</span><span class="op" id="6108010">[</span><span class="ident" id="6108011">i</span><span class="op" id="6108012">+</span><span class="num" id="6108013">2</span><span class="op" id="6108014">]</span>&nbsp;<span class="op" id="6108016">=</span>&nbsp;<span class="builtintype" id="6108018">uint8</span><span class="op" id="6108023">(</span><span class="op" id="6108024">(</span><span class="ident" id="6108025">db</span><span class="op" id="6108027">*</span><span class="ident" id="6108028">a</span><span class="op" id="6108029">/</span><span class="ident" id="6108030">m</span>&nbsp;<span class="op" id="6108032">+</span>&nbsp;<span class="ident" id="6108034">sb</span><span class="op" id="6108036">)</span>&nbsp;<span class="op" id="6108038">&gt;&gt;</span>&nbsp;<span class="num" id="6108041">8</span><span class="op" id="6108042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108047">dst</span><span class="op" id="6108050">.</span><span class="ident" id="6108051">Pix</span><span class="op" id="6108054">[</span><span class="ident" id="6108055">i</span><span class="op" id="6108056">+</span><span class="num" id="6108057">3</span><span class="op" id="6108058">]</span>&nbsp;<span class="op" id="6108060">=</span>&nbsp;<span class="builtintype" id="6108062">uint8</span><span class="op" id="6108067">(</span><span class="op" id="6108068">(</span><span class="ident" id="6108069">da</span><span class="op" id="6108071">*</span><span class="ident" id="6108072">a</span><span class="op" id="6108073">/</span><span class="ident" id="6108074">m</span>&nbsp;<span class="op" id="6108076">+</span>&nbsp;<span class="ident" id="6108078">sa</span><span class="op" id="6108080">)</span>&nbsp;<span class="op" id="6108082">&gt;&gt;</span>&nbsp;<span class="num" id="6108085">8</span><span class="op" id="6108086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6108090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108094">i0</span>&nbsp;<span class="op" id="6108097">+=</span>&nbsp;<span class="ident" id="6108100">dst</span><span class="op" id="6108103">.</span><span class="ident" id="6108104">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108113">i1</span>&nbsp;<span class="op" id="6108116">+=</span>&nbsp;<span class="ident" id="6108119">dst</span><span class="op" id="6108122">.</span><span class="ident" id="6108123">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6108131">}</span><br>
<span class="lineno"></span><span class="op" id="6108133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6108136">func</span>&nbsp;<span class="ident" id="6108141">drawFillSrc</span><span class="op" id="6108152">(</span><span class="ident" id="6108153">dst</span>&nbsp;<span class="op" id="6108157">*</span><span class="ident" id="6108158">image</span><span class="op" id="6108163">.</span><span class="ident" id="6108164">RGBA</span><span class="op" id="6108168">,</span>&nbsp;<span class="ident" id="6108170">r</span>&nbsp;<span class="ident" id="6108172">image</span><span class="op" id="6108177">.</span><span class="ident" id="6108178">Rectangle</span><span class="op" id="6108187">,</span>&nbsp;<span class="ident" id="6108189">src</span>&nbsp;<span class="op" id="6108193">*</span><span class="ident" id="6108194">image</span><span class="op" id="6108199">.</span><span class="ident" id="6108200">Uniform</span><span class="op" id="6108207">)</span>&nbsp;<span class="op" id="6108209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108212">sr</span><span class="op" id="6108214">,</span>&nbsp;<span class="ident" id="6108216">sg</span><span class="op" id="6108218">,</span>&nbsp;<span class="ident" id="6108220">sb</span><span class="op" id="6108222">,</span>&nbsp;<span class="ident" id="6108224">sa</span>&nbsp;<span class="op" id="6108227">:=</span>&nbsp;<span class="ident" id="6108230">src</span><span class="op" id="6108233">.</span><span class="ident" id="6108234">RGBA</span><span class="op" id="6108238">(</span><span class="op" id="6108239">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6108242">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6108344">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6108448">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108519">i0</span>&nbsp;<span class="op" id="6108522">:=</span>&nbsp;<span class="ident" id="6108525">dst</span><span class="op" id="6108528">.</span><span class="ident" id="6108529">PixOffset</span><span class="op" id="6108538">(</span><span class="ident" id="6108539">r</span><span class="op" id="6108540">.</span><span class="ident" id="6108541">Min</span><span class="op" id="6108544">.</span><span class="ident" id="6108545">X</span><span class="op" id="6108546">,</span>&nbsp;<span class="ident" id="6108548">r</span><span class="op" id="6108549">.</span><span class="ident" id="6108550">Min</span><span class="op" id="6108553">.</span><span class="ident" id="6108554">Y</span><span class="op" id="6108555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108558">i1</span>&nbsp;<span class="op" id="6108561">:=</span>&nbsp;<span class="ident" id="6108564">i0</span>&nbsp;<span class="op" id="6108567">+</span>&nbsp;<span class="ident" id="6108569">r</span><span class="op" id="6108570">.</span><span class="ident" id="6108571">Dx</span><span class="op" id="6108573">(</span><span class="op" id="6108574">)</span><span class="op" id="6108575">*</span><span class="num" id="6108576">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6108579">for</span>&nbsp;<span class="ident" id="6108583">i</span>&nbsp;<span class="op" id="6108585">:=</span>&nbsp;<span class="ident" id="6108588">i0</span><span class="op" id="6108590">;</span>&nbsp;<span class="ident" id="6108592">i</span>&nbsp;<span class="op" id="6108594">&lt;</span>&nbsp;<span class="ident" id="6108596">i1</span><span class="op" id="6108598">;</span>&nbsp;<span class="ident" id="6108600">i</span>&nbsp;<span class="op" id="6108602">+=</span>&nbsp;<span class="num" id="6108605">4</span>&nbsp;<span class="op" id="6108607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108611">dst</span><span class="op" id="6108614">.</span><span class="ident" id="6108615">Pix</span><span class="op" id="6108618">[</span><span class="ident" id="6108619">i</span><span class="op" id="6108620">+</span><span class="num" id="6108621">0</span><span class="op" id="6108622">]</span>&nbsp;<span class="op" id="6108624">=</span>&nbsp;<span class="builtintype" id="6108626">uint8</span><span class="op" id="6108631">(</span><span class="ident" id="6108632">sr</span>&nbsp;<span class="op" id="6108635">&gt;&gt;</span>&nbsp;<span class="num" id="6108638">8</span><span class="op" id="6108639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108643">dst</span><span class="op" id="6108646">.</span><span class="ident" id="6108647">Pix</span><span class="op" id="6108650">[</span><span class="ident" id="6108651">i</span><span class="op" id="6108652">+</span><span class="num" id="6108653">1</span><span class="op" id="6108654">]</span>&nbsp;<span class="op" id="6108656">=</span>&nbsp;<span class="builtintype" id="6108658">uint8</span><span class="op" id="6108663">(</span><span class="ident" id="6108664">sg</span>&nbsp;<span class="op" id="6108667">&gt;&gt;</span>&nbsp;<span class="num" id="6108670">8</span><span class="op" id="6108671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108675">dst</span><span class="op" id="6108678">.</span><span class="ident" id="6108679">Pix</span><span class="op" id="6108682">[</span><span class="ident" id="6108683">i</span><span class="op" id="6108684">+</span><span class="num" id="6108685">2</span><span class="op" id="6108686">]</span>&nbsp;<span class="op" id="6108688">=</span>&nbsp;<span class="builtintype" id="6108690">uint8</span><span class="op" id="6108695">(</span><span class="ident" id="6108696">sb</span>&nbsp;<span class="op" id="6108699">&gt;&gt;</span>&nbsp;<span class="num" id="6108702">8</span><span class="op" id="6108703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108707">dst</span><span class="op" id="6108710">.</span><span class="ident" id="6108711">Pix</span><span class="op" id="6108714">[</span><span class="ident" id="6108715">i</span><span class="op" id="6108716">+</span><span class="num" id="6108717">3</span><span class="op" id="6108718">]</span>&nbsp;<span class="op" id="6108720">=</span>&nbsp;<span class="builtintype" id="6108722">uint8</span><span class="op" id="6108727">(</span><span class="ident" id="6108728">sa</span>&nbsp;<span class="op" id="6108731">&gt;&gt;</span>&nbsp;<span class="num" id="6108734">8</span><span class="op" id="6108735">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6108738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108741">firstRow</span>&nbsp;<span class="op" id="6108750">:=</span>&nbsp;<span class="ident" id="6108753">dst</span><span class="op" id="6108756">.</span><span class="ident" id="6108757">Pix</span><span class="op" id="6108760">[</span><span class="ident" id="6108761">i0</span><span class="op" id="6108763">:</span><span class="ident" id="6108764">i1</span><span class="op" id="6108766">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6108769">for</span>&nbsp;<span class="ident" id="6108773">y</span>&nbsp;<span class="op" id="6108775">:=</span>&nbsp;<span class="ident" id="6108778">r</span><span class="op" id="6108779">.</span><span class="ident" id="6108780">Min</span><span class="op" id="6108783">.</span><span class="ident" id="6108784">Y</span>&nbsp;<span class="op" id="6108786">+</span>&nbsp;<span class="num" id="6108788">1</span><span class="op" id="6108789">;</span>&nbsp;<span class="ident" id="6108791">y</span>&nbsp;<span class="op" id="6108793">&lt;</span>&nbsp;<span class="ident" id="6108795">r</span><span class="op" id="6108796">.</span><span class="ident" id="6108797">Max</span><span class="op" id="6108800">.</span><span class="ident" id="6108801">Y</span><span class="op" id="6108802">;</span>&nbsp;<span class="ident" id="6108804">y</span><span class="op" id="6108805">++</span>&nbsp;<span class="op" id="6108808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108812">i0</span>&nbsp;<span class="op" id="6108815">+=</span>&nbsp;<span class="ident" id="6108818">dst</span><span class="op" id="6108821">.</span><span class="ident" id="6108822">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108831">i1</span>&nbsp;<span class="op" id="6108834">+=</span>&nbsp;<span class="ident" id="6108837">dst</span><span class="op" id="6108840">.</span><span class="ident" id="6108841">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6108850">copy</span><span class="op" id="6108854">(</span><span class="ident" id="6108855">dst</span><span class="op" id="6108858">.</span><span class="ident" id="6108859">Pix</span><span class="op" id="6108862">[</span><span class="ident" id="6108863">i0</span><span class="op" id="6108865">:</span><span class="ident" id="6108866">i1</span><span class="op" id="6108868">]</span><span class="op" id="6108869">,</span>&nbsp;<span class="ident" id="6108871">firstRow</span><span class="op" id="6108879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6108882">}</span><br>
<span class="lineno"></span><span class="op" id="6108884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6108887">func</span>&nbsp;<span class="ident" id="6108892">drawCopyOver</span><span class="op" id="6108904">(</span><span class="ident" id="6108905">dst</span>&nbsp;<span class="op" id="6108909">*</span><span class="ident" id="6108910">image</span><span class="op" id="6108915">.</span><span class="ident" id="6108916">RGBA</span><span class="op" id="6108920">,</span>&nbsp;<span class="ident" id="6108922">r</span>&nbsp;<span class="ident" id="6108924">image</span><span class="op" id="6108929">.</span><span class="ident" id="6108930">Rectangle</span><span class="op" id="6108939">,</span>&nbsp;<span class="ident" id="6108941">src</span>&nbsp;<span class="op" id="6108945">*</span><span class="ident" id="6108946">image</span><span class="op" id="6108951">.</span><span class="ident" id="6108952">RGBA</span><span class="op" id="6108956">,</span>&nbsp;<span class="ident" id="6108958">sp</span>&nbsp;<span class="ident" id="6108961">image</span><span class="op" id="6108966">.</span><span class="ident" id="6108967">Point</span><span class="op" id="6108972">)</span>&nbsp;<span class="op" id="6108974">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6108977">dx</span><span class="op" id="6108979">,</span>&nbsp;<span class="ident" id="6108981">dy</span>&nbsp;<span class="op" id="6108984">:=</span>&nbsp;<span class="ident" id="6108987">r</span><span class="op" id="6108988">.</span><span class="ident" id="6108989">Dx</span><span class="op" id="6108991">(</span><span class="op" id="6108992">)</span><span class="op" id="6108993">,</span>&nbsp;<span class="ident" id="6108995">r</span><span class="op" id="6108996">.</span><span class="ident" id="6108997">Dy</span><span class="op" id="6108999">(</span><span class="op" id="6109000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109003">d0</span>&nbsp;<span class="op" id="6109006">:=</span>&nbsp;<span class="ident" id="6109009">dst</span><span class="op" id="6109012">.</span><span class="ident" id="6109013">PixOffset</span><span class="op" id="6109022">(</span><span class="ident" id="6109023">r</span><span class="op" id="6109024">.</span><span class="ident" id="6109025">Min</span><span class="op" id="6109028">.</span><span class="ident" id="6109029">X</span><span class="op" id="6109030">,</span>&nbsp;<span class="ident" id="6109032">r</span><span class="op" id="6109033">.</span><span class="ident" id="6109034">Min</span><span class="op" id="6109037">.</span><span class="ident" id="6109038">Y</span><span class="op" id="6109039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109042">s0</span>&nbsp;<span class="op" id="6109045">:=</span>&nbsp;<span class="ident" id="6109048">src</span><span class="op" id="6109051">.</span><span class="ident" id="6109052">PixOffset</span><span class="op" id="6109061">(</span><span class="ident" id="6109062">sp</span><span class="op" id="6109064">.</span><span class="ident" id="6109065">X</span><span class="op" id="6109066">,</span>&nbsp;<span class="ident" id="6109068">sp</span><span class="op" id="6109070">.</span><span class="ident" id="6109071">Y</span><span class="op" id="6109072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6109075">var</span>&nbsp;<span class="op" id="6109079">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109083">ddelta</span><span class="op" id="6109089">,</span>&nbsp;<span class="ident" id="6109091">sdelta</span>&nbsp;<span class="builtintype" id="6109098">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109104">i0</span><span class="op" id="6109106">,</span>&nbsp;<span class="ident" id="6109108">i1</span><span class="op" id="6109110">,</span>&nbsp;<span class="ident" id="6109112">idelta</span>&nbsp;<span class="builtintype" id="6109119">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6109124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6109127">if</span>&nbsp;<span class="ident" id="6109130">r</span><span class="op" id="6109131">.</span><span class="ident" id="6109132">Min</span><span class="op" id="6109135">.</span><span class="ident" id="6109136">Y</span>&nbsp;<span class="op" id="6109138">&lt;</span>&nbsp;<span class="ident" id="6109140">sp</span><span class="op" id="6109142">.</span><span class="ident" id="6109143">Y</span>&nbsp;<span class="op" id="6109145">||</span>&nbsp;<span class="ident" id="6109148">r</span><span class="op" id="6109149">.</span><span class="ident" id="6109150">Min</span><span class="op" id="6109153">.</span><span class="ident" id="6109154">Y</span>&nbsp;<span class="op" id="6109156">==</span>&nbsp;<span class="ident" id="6109159">sp</span><span class="op" id="6109161">.</span><span class="ident" id="6109162">Y</span>&nbsp;<span class="op" id="6109164">&amp;&amp;</span>&nbsp;<span class="ident" id="6109167">r</span><span class="op" id="6109168">.</span><span class="ident" id="6109169">Min</span><span class="op" id="6109172">.</span><span class="ident" id="6109173">X</span>&nbsp;<span class="op" id="6109175">&lt;=</span>&nbsp;<span class="ident" id="6109178">sp</span><span class="op" id="6109180">.</span><span class="ident" id="6109181">X</span>&nbsp;<span class="op" id="6109183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109187">ddelta</span>&nbsp;<span class="op" id="6109194">=</span>&nbsp;<span class="ident" id="6109196">dst</span><span class="op" id="6109199">.</span><span class="ident" id="6109200">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109209">sdelta</span>&nbsp;<span class="op" id="6109216">=</span>&nbsp;<span class="ident" id="6109218">src</span><span class="op" id="6109221">.</span><span class="ident" id="6109222">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109231">i0</span><span class="op" id="6109233">,</span>&nbsp;<span class="ident" id="6109235">i1</span><span class="op" id="6109237">,</span>&nbsp;<span class="ident" id="6109239">idelta</span>&nbsp;<span class="op" id="6109246">=</span>&nbsp;<span class="num" id="6109248">0</span><span class="op" id="6109249">,</span>&nbsp;<span class="ident" id="6109251">dx</span><span class="op" id="6109253">*</span><span class="num" id="6109254">4</span><span class="op" id="6109255">,</span>&nbsp;<span class="op" id="6109257">+</span><span class="num" id="6109258">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6109261">}</span>&nbsp;<span class="keyword" id="6109263">else</span>&nbsp;<span class="op" id="6109268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6109272">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6109380">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109480">d0</span>&nbsp;<span class="op" id="6109483">+=</span>&nbsp;<span class="op" id="6109486">(</span><span class="ident" id="6109487">dy</span>&nbsp;<span class="op" id="6109490">-</span>&nbsp;<span class="num" id="6109492">1</span><span class="op" id="6109493">)</span>&nbsp;<span class="op" id="6109495">*</span>&nbsp;<span class="ident" id="6109497">dst</span><span class="op" id="6109500">.</span><span class="ident" id="6109501">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109510">s0</span>&nbsp;<span class="op" id="6109513">+=</span>&nbsp;<span class="op" id="6109516">(</span><span class="ident" id="6109517">dy</span>&nbsp;<span class="op" id="6109520">-</span>&nbsp;<span class="num" id="6109522">1</span><span class="op" id="6109523">)</span>&nbsp;<span class="op" id="6109525">*</span>&nbsp;<span class="ident" id="6109527">src</span><span class="op" id="6109530">.</span><span class="ident" id="6109531">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109540">ddelta</span>&nbsp;<span class="op" id="6109547">=</span>&nbsp;<span class="op" id="6109549">-</span><span class="ident" id="6109550">dst</span><span class="op" id="6109553">.</span><span class="ident" id="6109554">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109563">sdelta</span>&nbsp;<span class="op" id="6109570">=</span>&nbsp;<span class="op" id="6109572">-</span><span class="ident" id="6109573">src</span><span class="op" id="6109576">.</span><span class="ident" id="6109577">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109586">i0</span><span class="op" id="6109588">,</span>&nbsp;<span class="ident" id="6109590">i1</span><span class="op" id="6109592">,</span>&nbsp;<span class="ident" id="6109594">idelta</span>&nbsp;<span class="op" id="6109601">=</span>&nbsp;<span class="op" id="6109603">(</span><span class="ident" id="6109604">dx</span><span class="op" id="6109606">-</span><span class="num" id="6109607">1</span><span class="op" id="6109608">)</span><span class="op" id="6109609">*</span><span class="num" id="6109610">4</span><span class="op" id="6109611">,</span>&nbsp;<span class="op" id="6109613">-</span><span class="num" id="6109614">4</span><span class="op" id="6109615">,</span>&nbsp;<span class="op" id="6109617">-</span><span class="num" id="6109618">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6109621">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6109624">for</span>&nbsp;<span class="op" id="6109628">;</span>&nbsp;<span class="ident" id="6109630">dy</span>&nbsp;<span class="op" id="6109633">&gt;</span>&nbsp;<span class="num" id="6109635">0</span><span class="op" id="6109636">;</span>&nbsp;<span class="ident" id="6109638">dy</span><span class="op" id="6109640">--</span>&nbsp;<span class="op" id="6109643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109647">dpix</span>&nbsp;<span class="op" id="6109652">:=</span>&nbsp;<span class="ident" id="6109655">dst</span><span class="op" id="6109658">.</span><span class="ident" id="6109659">Pix</span><span class="op" id="6109662">[</span><span class="ident" id="6109663">d0</span><span class="op" id="6109665">:</span><span class="op" id="6109666">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109670">spix</span>&nbsp;<span class="op" id="6109675">:=</span>&nbsp;<span class="ident" id="6109678">src</span><span class="op" id="6109681">.</span><span class="ident" id="6109682">Pix</span><span class="op" id="6109685">[</span><span class="ident" id="6109686">s0</span><span class="op" id="6109688">:</span><span class="op" id="6109689">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6109693">for</span>&nbsp;<span class="ident" id="6109697">i</span>&nbsp;<span class="op" id="6109699">:=</span>&nbsp;<span class="ident" id="6109702">i0</span><span class="op" id="6109704">;</span>&nbsp;<span class="ident" id="6109706">i</span>&nbsp;<span class="op" id="6109708">!=</span>&nbsp;<span class="ident" id="6109711">i1</span><span class="op" id="6109713">;</span>&nbsp;<span class="ident" id="6109715">i</span>&nbsp;<span class="op" id="6109717">+=</span>&nbsp;<span class="ident" id="6109720">idelta</span>&nbsp;<span class="op" id="6109727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109732">sr</span>&nbsp;<span class="op" id="6109735">:=</span>&nbsp;<span class="builtintype" id="6109738">uint32</span><span class="op" id="6109744">(</span><span class="ident" id="6109745">spix</span><span class="op" id="6109749">[</span><span class="ident" id="6109750">i</span><span class="op" id="6109751">+</span><span class="num" id="6109752">0</span><span class="op" id="6109753">]</span><span class="op" id="6109754">)</span>&nbsp;<span class="op" id="6109756">*</span>&nbsp;<span class="num" id="6109758">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109767">sg</span>&nbsp;<span class="op" id="6109770">:=</span>&nbsp;<span class="builtintype" id="6109773">uint32</span><span class="op" id="6109779">(</span><span class="ident" id="6109780">spix</span><span class="op" id="6109784">[</span><span class="ident" id="6109785">i</span><span class="op" id="6109786">+</span><span class="num" id="6109787">1</span><span class="op" id="6109788">]</span><span class="op" id="6109789">)</span>&nbsp;<span class="op" id="6109791">*</span>&nbsp;<span class="num" id="6109793">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109802">sb</span>&nbsp;<span class="op" id="6109805">:=</span>&nbsp;<span class="builtintype" id="6109808">uint32</span><span class="op" id="6109814">(</span><span class="ident" id="6109815">spix</span><span class="op" id="6109819">[</span><span class="ident" id="6109820">i</span><span class="op" id="6109821">+</span><span class="num" id="6109822">2</span><span class="op" id="6109823">]</span><span class="op" id="6109824">)</span>&nbsp;<span class="op" id="6109826">*</span>&nbsp;<span class="num" id="6109828">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109837">sa</span>&nbsp;<span class="op" id="6109840">:=</span>&nbsp;<span class="builtintype" id="6109843">uint32</span><span class="op" id="6109849">(</span><span class="ident" id="6109850">spix</span><span class="op" id="6109854">[</span><span class="ident" id="6109855">i</span><span class="op" id="6109856">+</span><span class="num" id="6109857">3</span><span class="op" id="6109858">]</span><span class="op" id="6109859">)</span>&nbsp;<span class="op" id="6109861">*</span>&nbsp;<span class="num" id="6109863">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109873">dr</span>&nbsp;<span class="op" id="6109876">:=</span>&nbsp;<span class="builtintype" id="6109879">uint32</span><span class="op" id="6109885">(</span><span class="ident" id="6109886">dpix</span><span class="op" id="6109890">[</span><span class="ident" id="6109891">i</span><span class="op" id="6109892">+</span><span class="num" id="6109893">0</span><span class="op" id="6109894">]</span><span class="op" id="6109895">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109900">dg</span>&nbsp;<span class="op" id="6109903">:=</span>&nbsp;<span class="builtintype" id="6109906">uint32</span><span class="op" id="6109912">(</span><span class="ident" id="6109913">dpix</span><span class="op" id="6109917">[</span><span class="ident" id="6109918">i</span><span class="op" id="6109919">+</span><span class="num" id="6109920">1</span><span class="op" id="6109921">]</span><span class="op" id="6109922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109927">db</span>&nbsp;<span class="op" id="6109930">:=</span>&nbsp;<span class="builtintype" id="6109933">uint32</span><span class="op" id="6109939">(</span><span class="ident" id="6109940">dpix</span><span class="op" id="6109944">[</span><span class="ident" id="6109945">i</span><span class="op" id="6109946">+</span><span class="num" id="6109947">2</span><span class="op" id="6109948">]</span><span class="op" id="6109949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6109954">da</span>&nbsp;<span class="op" id="6109957">:=</span>&nbsp;<span class="builtintype" id="6109960">uint32</span><span class="op" id="6109966">(</span><span class="ident" id="6109967">dpix</span><span class="op" id="6109971">[</span><span class="ident" id="6109972">i</span><span class="op" id="6109973">+</span><span class="num" id="6109974">3</span><span class="op" id="6109975">]</span><span class="op" id="6109976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6109982">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110042">a</span>&nbsp;<span class="op" id="6110044">:=</span>&nbsp;<span class="op" id="6110047">(</span><span class="ident" id="6110048">m</span>&nbsp;<span class="op" id="6110050">-</span>&nbsp;<span class="ident" id="6110052">sa</span><span class="op" id="6110054">)</span>&nbsp;<span class="op" id="6110056">*</span>&nbsp;<span class="num" id="6110058">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110068">dpix</span><span class="op" id="6110072">[</span><span class="ident" id="6110073">i</span><span class="op" id="6110074">+</span><span class="num" id="6110075">0</span><span class="op" id="6110076">]</span>&nbsp;<span class="op" id="6110078">=</span>&nbsp;<span class="builtintype" id="6110080">uint8</span><span class="op" id="6110085">(</span><span class="op" id="6110086">(</span><span class="ident" id="6110087">dr</span><span class="op" id="6110089">*</span><span class="ident" id="6110090">a</span><span class="op" id="6110091">/</span><span class="ident" id="6110092">m</span>&nbsp;<span class="op" id="6110094">+</span>&nbsp;<span class="ident" id="6110096">sr</span><span class="op" id="6110098">)</span>&nbsp;<span class="op" id="6110100">&gt;&gt;</span>&nbsp;<span class="num" id="6110103">8</span><span class="op" id="6110104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110109">dpix</span><span class="op" id="6110113">[</span><span class="ident" id="6110114">i</span><span class="op" id="6110115">+</span><span class="num" id="6110116">1</span><span class="op" id="6110117">]</span>&nbsp;<span class="op" id="6110119">=</span>&nbsp;<span class="builtintype" id="6110121">uint8</span><span class="op" id="6110126">(</span><span class="op" id="6110127">(</span><span class="ident" id="6110128">dg</span><span class="op" id="6110130">*</span><span class="ident" id="6110131">a</span><span class="op" id="6110132">/</span><span class="ident" id="6110133">m</span>&nbsp;<span class="op" id="6110135">+</span>&nbsp;<span class="ident" id="6110137">sg</span><span class="op" id="6110139">)</span>&nbsp;<span class="op" id="6110141">&gt;&gt;</span>&nbsp;<span class="num" id="6110144">8</span><span class="op" id="6110145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110150">dpix</span><span class="op" id="6110154">[</span><span class="ident" id="6110155">i</span><span class="op" id="6110156">+</span><span class="num" id="6110157">2</span><span class="op" id="6110158">]</span>&nbsp;<span class="op" id="6110160">=</span>&nbsp;<span class="builtintype" id="6110162">uint8</span><span class="op" id="6110167">(</span><span class="op" id="6110168">(</span><span class="ident" id="6110169">db</span><span class="op" id="6110171">*</span><span class="ident" id="6110172">a</span><span class="op" id="6110173">/</span><span class="ident" id="6110174">m</span>&nbsp;<span class="op" id="6110176">+</span>&nbsp;<span class="ident" id="6110178">sb</span><span class="op" id="6110180">)</span>&nbsp;<span class="op" id="6110182">&gt;&gt;</span>&nbsp;<span class="num" id="6110185">8</span><span class="op" id="6110186">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110191">dpix</span><span class="op" id="6110195">[</span><span class="ident" id="6110196">i</span><span class="op" id="6110197">+</span><span class="num" id="6110198">3</span><span class="op" id="6110199">]</span>&nbsp;<span class="op" id="6110201">=</span>&nbsp;<span class="builtintype" id="6110203">uint8</span><span class="op" id="6110208">(</span><span class="op" id="6110209">(</span><span class="ident" id="6110210">da</span><span class="op" id="6110212">*</span><span class="ident" id="6110213">a</span><span class="op" id="6110214">/</span><span class="ident" id="6110215">m</span>&nbsp;<span class="op" id="6110217">+</span>&nbsp;<span class="ident" id="6110219">sa</span><span class="op" id="6110221">)</span>&nbsp;<span class="op" id="6110223">&gt;&gt;</span>&nbsp;<span class="num" id="6110226">8</span><span class="op" id="6110227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110235">d0</span>&nbsp;<span class="op" id="6110238">+=</span>&nbsp;<span class="ident" id="6110241">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110250">s0</span>&nbsp;<span class="op" id="6110253">+=</span>&nbsp;<span class="ident" id="6110256">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110264">}</span><br>
<span class="lineno">305</span><span class="op" id="6110266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6110269">func</span>&nbsp;<span class="ident" id="6110274">drawCopySrc</span><span class="op" id="6110285">(</span><span class="ident" id="6110286">dst</span>&nbsp;<span class="op" id="6110290">*</span><span class="ident" id="6110291">image</span><span class="op" id="6110296">.</span><span class="ident" id="6110297">RGBA</span><span class="op" id="6110301">,</span>&nbsp;<span class="ident" id="6110303">r</span>&nbsp;<span class="ident" id="6110305">image</span><span class="op" id="6110310">.</span><span class="ident" id="6110311">Rectangle</span><span class="op" id="6110320">,</span>&nbsp;<span class="ident" id="6110322">src</span>&nbsp;<span class="op" id="6110326">*</span><span class="ident" id="6110327">image</span><span class="op" id="6110332">.</span><span class="ident" id="6110333">RGBA</span><span class="op" id="6110337">,</span>&nbsp;<span class="ident" id="6110339">sp</span>&nbsp;<span class="ident" id="6110342">image</span><span class="op" id="6110347">.</span><span class="ident" id="6110348">Point</span><span class="op" id="6110353">)</span>&nbsp;<span class="op" id="6110355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110358">n</span><span class="op" id="6110359">,</span>&nbsp;<span class="ident" id="6110361">dy</span>&nbsp;<span class="op" id="6110364">:=</span>&nbsp;<span class="num" id="6110367">4</span><span class="op" id="6110368">*</span><span class="ident" id="6110369">r</span><span class="op" id="6110370">.</span><span class="ident" id="6110371">Dx</span><span class="op" id="6110373">(</span><span class="op" id="6110374">)</span><span class="op" id="6110375">,</span>&nbsp;<span class="ident" id="6110377">r</span><span class="op" id="6110378">.</span><span class="ident" id="6110379">Dy</span><span class="op" id="6110381">(</span><span class="op" id="6110382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110385">d0</span>&nbsp;<span class="op" id="6110388">:=</span>&nbsp;<span class="ident" id="6110391">dst</span><span class="op" id="6110394">.</span><span class="ident" id="6110395">PixOffset</span><span class="op" id="6110404">(</span><span class="ident" id="6110405">r</span><span class="op" id="6110406">.</span><span class="ident" id="6110407">Min</span><span class="op" id="6110410">.</span><span class="ident" id="6110411">X</span><span class="op" id="6110412">,</span>&nbsp;<span class="ident" id="6110414">r</span><span class="op" id="6110415">.</span><span class="ident" id="6110416">Min</span><span class="op" id="6110419">.</span><span class="ident" id="6110420">Y</span><span class="op" id="6110421">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110424">s0</span>&nbsp;<span class="op" id="6110427">:=</span>&nbsp;<span class="ident" id="6110430">src</span><span class="op" id="6110433">.</span><span class="ident" id="6110434">PixOffset</span><span class="op" id="6110443">(</span><span class="ident" id="6110444">sp</span><span class="op" id="6110446">.</span><span class="ident" id="6110447">X</span><span class="op" id="6110448">,</span>&nbsp;<span class="ident" id="6110450">sp</span><span class="op" id="6110452">.</span><span class="ident" id="6110453">Y</span><span class="op" id="6110454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6110457">var</span>&nbsp;<span class="ident" id="6110461">ddelta</span><span class="op" id="6110467">,</span>&nbsp;<span class="ident" id="6110469">sdelta</span>&nbsp;<span class="builtintype" id="6110476">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6110481">if</span>&nbsp;<span class="ident" id="6110484">r</span><span class="op" id="6110485">.</span><span class="ident" id="6110486">Min</span><span class="op" id="6110489">.</span><span class="ident" id="6110490">Y</span>&nbsp;<span class="op" id="6110492">&lt;=</span>&nbsp;<span class="ident" id="6110495">sp</span><span class="op" id="6110497">.</span><span class="ident" id="6110498">Y</span>&nbsp;<span class="op" id="6110500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110504">ddelta</span>&nbsp;<span class="op" id="6110511">=</span>&nbsp;<span class="ident" id="6110513">dst</span><span class="op" id="6110516">.</span><span class="ident" id="6110517">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110526">sdelta</span>&nbsp;<span class="op" id="6110533">=</span>&nbsp;<span class="ident" id="6110535">src</span><span class="op" id="6110538">.</span><span class="ident" id="6110539">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110547">}</span>&nbsp;<span class="keyword" id="6110549">else</span>&nbsp;<span class="op" id="6110554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6110558">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6110658">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6110754">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110850">d0</span>&nbsp;<span class="op" id="6110853">+=</span>&nbsp;<span class="op" id="6110856">(</span><span class="ident" id="6110857">dy</span>&nbsp;<span class="op" id="6110860">-</span>&nbsp;<span class="num" id="6110862">1</span><span class="op" id="6110863">)</span>&nbsp;<span class="op" id="6110865">*</span>&nbsp;<span class="ident" id="6110867">dst</span><span class="op" id="6110870">.</span><span class="ident" id="6110871">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110880">s0</span>&nbsp;<span class="op" id="6110883">+=</span>&nbsp;<span class="op" id="6110886">(</span><span class="ident" id="6110887">dy</span>&nbsp;<span class="op" id="6110890">-</span>&nbsp;<span class="num" id="6110892">1</span><span class="op" id="6110893">)</span>&nbsp;<span class="op" id="6110895">*</span>&nbsp;<span class="ident" id="6110897">src</span><span class="op" id="6110900">.</span><span class="ident" id="6110901">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110910">ddelta</span>&nbsp;<span class="op" id="6110917">=</span>&nbsp;<span class="op" id="6110919">-</span><span class="ident" id="6110920">dst</span><span class="op" id="6110923">.</span><span class="ident" id="6110924">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6110933">sdelta</span>&nbsp;<span class="op" id="6110940">=</span>&nbsp;<span class="op" id="6110942">-</span><span class="ident" id="6110943">src</span><span class="op" id="6110946">.</span><span class="ident" id="6110947">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6110955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6110958">for</span>&nbsp;<span class="op" id="6110962">;</span>&nbsp;<span class="ident" id="6110964">dy</span>&nbsp;<span class="op" id="6110967">&gt;</span>&nbsp;<span class="num" id="6110969">0</span><span class="op" id="6110970">;</span>&nbsp;<span class="ident" id="6110972">dy</span><span class="op" id="6110974">--</span>&nbsp;<span class="op" id="6110977">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6110981">copy</span><span class="op" id="6110985">(</span><span class="ident" id="6110986">dst</span><span class="op" id="6110989">.</span><span class="ident" id="6110990">Pix</span><span class="op" id="6110993">[</span><span class="ident" id="6110994">d0</span><span class="op" id="6110996">:</span><span class="ident" id="6110997">d0</span><span class="op" id="6110999">+</span><span class="ident" id="6111000">n</span><span class="op" id="6111001">]</span><span class="op" id="6111002">,</span>&nbsp;<span class="ident" id="6111004">src</span><span class="op" id="6111007">.</span><span class="ident" id="6111008">Pix</span><span class="op" id="6111011">[</span><span class="ident" id="6111012">s0</span><span class="op" id="6111014">:</span><span class="ident" id="6111015">s0</span><span class="op" id="6111017">+</span><span class="ident" id="6111018">n</span><span class="op" id="6111019">]</span><span class="op" id="6111020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111024">d0</span>&nbsp;<span class="op" id="6111027">+=</span>&nbsp;<span class="ident" id="6111030">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111039">s0</span>&nbsp;<span class="op" id="6111042">+=</span>&nbsp;<span class="ident" id="6111045">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111053">}</span><br>
<span class="lineno"></span><span class="op" id="6111055">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="6111058">func</span>&nbsp;<span class="ident" id="6111063">drawNRGBAOver</span><span class="op" id="6111076">(</span><span class="ident" id="6111077">dst</span>&nbsp;<span class="op" id="6111081">*</span><span class="ident" id="6111082">image</span><span class="op" id="6111087">.</span><span class="ident" id="6111088">RGBA</span><span class="op" id="6111092">,</span>&nbsp;<span class="ident" id="6111094">r</span>&nbsp;<span class="ident" id="6111096">image</span><span class="op" id="6111101">.</span><span class="ident" id="6111102">Rectangle</span><span class="op" id="6111111">,</span>&nbsp;<span class="ident" id="6111113">src</span>&nbsp;<span class="op" id="6111117">*</span><span class="ident" id="6111118">image</span><span class="op" id="6111123">.</span><span class="ident" id="6111124">NRGBA</span><span class="op" id="6111129">,</span>&nbsp;<span class="ident" id="6111131">sp</span>&nbsp;<span class="ident" id="6111134">image</span><span class="op" id="6111139">.</span><span class="ident" id="6111140">Point</span><span class="op" id="6111145">)</span>&nbsp;<span class="op" id="6111147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111150">i0</span>&nbsp;<span class="op" id="6111153">:=</span>&nbsp;<span class="op" id="6111156">(</span><span class="ident" id="6111157">r</span><span class="op" id="6111158">.</span><span class="ident" id="6111159">Min</span><span class="op" id="6111162">.</span><span class="ident" id="6111163">X</span>&nbsp;<span class="op" id="6111165">-</span>&nbsp;<span class="ident" id="6111167">dst</span><span class="op" id="6111170">.</span><span class="ident" id="6111171">Rect</span><span class="op" id="6111175">.</span><span class="ident" id="6111176">Min</span><span class="op" id="6111179">.</span><span class="ident" id="6111180">X</span><span class="op" id="6111181">)</span>&nbsp;<span class="op" id="6111183">*</span>&nbsp;<span class="num" id="6111185">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111188">i1</span>&nbsp;<span class="op" id="6111191">:=</span>&nbsp;<span class="op" id="6111194">(</span><span class="ident" id="6111195">r</span><span class="op" id="6111196">.</span><span class="ident" id="6111197">Max</span><span class="op" id="6111200">.</span><span class="ident" id="6111201">X</span>&nbsp;<span class="op" id="6111203">-</span>&nbsp;<span class="ident" id="6111205">dst</span><span class="op" id="6111208">.</span><span class="ident" id="6111209">Rect</span><span class="op" id="6111213">.</span><span class="ident" id="6111214">Min</span><span class="op" id="6111217">.</span><span class="ident" id="6111218">X</span><span class="op" id="6111219">)</span>&nbsp;<span class="op" id="6111221">*</span>&nbsp;<span class="num" id="6111223">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111226">si0</span>&nbsp;<span class="op" id="6111230">:=</span>&nbsp;<span class="op" id="6111233">(</span><span class="ident" id="6111234">sp</span><span class="op" id="6111236">.</span><span class="ident" id="6111237">X</span>&nbsp;<span class="op" id="6111239">-</span>&nbsp;<span class="ident" id="6111241">src</span><span class="op" id="6111244">.</span><span class="ident" id="6111245">Rect</span><span class="op" id="6111249">.</span><span class="ident" id="6111250">Min</span><span class="op" id="6111253">.</span><span class="ident" id="6111254">X</span><span class="op" id="6111255">)</span>&nbsp;<span class="op" id="6111257">*</span>&nbsp;<span class="num" id="6111259">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111262">yMax</span>&nbsp;<span class="op" id="6111267">:=</span>&nbsp;<span class="ident" id="6111270">r</span><span class="op" id="6111271">.</span><span class="ident" id="6111272">Max</span><span class="op" id="6111275">.</span><span class="ident" id="6111276">Y</span>&nbsp;<span class="op" id="6111278">-</span>&nbsp;<span class="ident" id="6111280">dst</span><span class="op" id="6111283">.</span><span class="ident" id="6111284">Rect</span><span class="op" id="6111288">.</span><span class="ident" id="6111289">Min</span><span class="op" id="6111292">.</span><span class="ident" id="6111293">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111297">y</span>&nbsp;<span class="op" id="6111299">:=</span>&nbsp;<span class="ident" id="6111302">r</span><span class="op" id="6111303">.</span><span class="ident" id="6111304">Min</span><span class="op" id="6111307">.</span><span class="ident" id="6111308">Y</span>&nbsp;<span class="op" id="6111310">-</span>&nbsp;<span class="ident" id="6111312">dst</span><span class="op" id="6111315">.</span><span class="ident" id="6111316">Rect</span><span class="op" id="6111320">.</span><span class="ident" id="6111321">Min</span><span class="op" id="6111324">.</span><span class="ident" id="6111325">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111328">sy</span>&nbsp;<span class="op" id="6111331">:=</span>&nbsp;<span class="ident" id="6111334">sp</span><span class="op" id="6111336">.</span><span class="ident" id="6111337">Y</span>&nbsp;<span class="op" id="6111339">-</span>&nbsp;<span class="ident" id="6111341">src</span><span class="op" id="6111344">.</span><span class="ident" id="6111345">Rect</span><span class="op" id="6111349">.</span><span class="ident" id="6111350">Min</span><span class="op" id="6111353">.</span><span class="ident" id="6111354">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111357">for</span>&nbsp;<span class="op" id="6111361">;</span>&nbsp;<span class="ident" id="6111363">y</span>&nbsp;<span class="op" id="6111365">!=</span>&nbsp;<span class="ident" id="6111368">yMax</span><span class="op" id="6111372">;</span>&nbsp;<span class="ident" id="6111374">y</span><span class="op" id="6111375">,</span>&nbsp;<span class="ident" id="6111377">sy</span>&nbsp;<span class="op" id="6111380">=</span>&nbsp;<span class="ident" id="6111382">y</span><span class="op" id="6111383">+</span><span class="num" id="6111384">1</span><span class="op" id="6111385">,</span>&nbsp;<span class="ident" id="6111387">sy</span><span class="op" id="6111389">+</span><span class="num" id="6111390">1</span>&nbsp;<span class="op" id="6111392">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111396">dpix</span>&nbsp;<span class="op" id="6111401">:=</span>&nbsp;<span class="ident" id="6111404">dst</span><span class="op" id="6111407">.</span><span class="ident" id="6111408">Pix</span><span class="op" id="6111411">[</span><span class="ident" id="6111412">y</span><span class="op" id="6111413">*</span><span class="ident" id="6111414">dst</span><span class="op" id="6111417">.</span><span class="ident" id="6111418">Stride</span><span class="op" id="6111424">:</span><span class="op" id="6111425">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111429">spix</span>&nbsp;<span class="op" id="6111434">:=</span>&nbsp;<span class="ident" id="6111437">src</span><span class="op" id="6111440">.</span><span class="ident" id="6111441">Pix</span><span class="op" id="6111444">[</span><span class="ident" id="6111445">sy</span><span class="op" id="6111447">*</span><span class="ident" id="6111448">src</span><span class="op" id="6111451">.</span><span class="ident" id="6111452">Stride</span><span class="op" id="6111458">:</span><span class="op" id="6111459">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111464">for</span>&nbsp;<span class="ident" id="6111468">i</span><span class="op" id="6111469">,</span>&nbsp;<span class="ident" id="6111471">si</span>&nbsp;<span class="op" id="6111474">:=</span>&nbsp;<span class="ident" id="6111477">i0</span><span class="op" id="6111479">,</span>&nbsp;<span class="ident" id="6111481">si0</span><span class="op" id="6111484">;</span>&nbsp;<span class="ident" id="6111486">i</span>&nbsp;<span class="op" id="6111488">&lt;</span>&nbsp;<span class="ident" id="6111490">i1</span><span class="op" id="6111492">;</span>&nbsp;<span class="ident" id="6111494">i</span><span class="op" id="6111495">,</span>&nbsp;<span class="ident" id="6111497">si</span>&nbsp;<span class="op" id="6111500">=</span>&nbsp;<span class="ident" id="6111502">i</span><span class="op" id="6111503">+</span><span class="num" id="6111504">4</span><span class="op" id="6111505">,</span>&nbsp;<span class="ident" id="6111507">si</span><span class="op" id="6111509">+</span><span class="num" id="6111510">4</span>&nbsp;<span class="op" id="6111512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6111517">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111585">sa</span>&nbsp;<span class="op" id="6111588">:=</span>&nbsp;<span class="builtintype" id="6111591">uint32</span><span class="op" id="6111597">(</span><span class="ident" id="6111598">spix</span><span class="op" id="6111602">[</span><span class="ident" id="6111603">si</span><span class="op" id="6111605">+</span><span class="num" id="6111606">3</span><span class="op" id="6111607">]</span><span class="op" id="6111608">)</span>&nbsp;<span class="op" id="6111610">*</span>&nbsp;<span class="num" id="6111612">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111621">sr</span>&nbsp;<span class="op" id="6111624">:=</span>&nbsp;<span class="builtintype" id="6111627">uint32</span><span class="op" id="6111633">(</span><span class="ident" id="6111634">spix</span><span class="op" id="6111638">[</span><span class="ident" id="6111639">si</span><span class="op" id="6111641">+</span><span class="num" id="6111642">0</span><span class="op" id="6111643">]</span><span class="op" id="6111644">)</span>&nbsp;<span class="op" id="6111646">*</span>&nbsp;<span class="ident" id="6111648">sa</span>&nbsp;<span class="op" id="6111651">/</span>&nbsp;<span class="num" id="6111653">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111661">sg</span>&nbsp;<span class="op" id="6111664">:=</span>&nbsp;<span class="builtintype" id="6111667">uint32</span><span class="op" id="6111673">(</span><span class="ident" id="6111674">spix</span><span class="op" id="6111678">[</span><span class="ident" id="6111679">si</span><span class="op" id="6111681">+</span><span class="num" id="6111682">1</span><span class="op" id="6111683">]</span><span class="op" id="6111684">)</span>&nbsp;<span class="op" id="6111686">*</span>&nbsp;<span class="ident" id="6111688">sa</span>&nbsp;<span class="op" id="6111691">/</span>&nbsp;<span class="num" id="6111693">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111701">sb</span>&nbsp;<span class="op" id="6111704">:=</span>&nbsp;<span class="builtintype" id="6111707">uint32</span><span class="op" id="6111713">(</span><span class="ident" id="6111714">spix</span><span class="op" id="6111718">[</span><span class="ident" id="6111719">si</span><span class="op" id="6111721">+</span><span class="num" id="6111722">2</span><span class="op" id="6111723">]</span><span class="op" id="6111724">)</span>&nbsp;<span class="op" id="6111726">*</span>&nbsp;<span class="ident" id="6111728">sa</span>&nbsp;<span class="op" id="6111731">/</span>&nbsp;<span class="num" id="6111733">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111742">dr</span>&nbsp;<span class="op" id="6111745">:=</span>&nbsp;<span class="builtintype" id="6111748">uint32</span><span class="op" id="6111754">(</span><span class="ident" id="6111755">dpix</span><span class="op" id="6111759">[</span><span class="ident" id="6111760">i</span><span class="op" id="6111761">+</span><span class="num" id="6111762">0</span><span class="op" id="6111763">]</span><span class="op" id="6111764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111769">dg</span>&nbsp;<span class="op" id="6111772">:=</span>&nbsp;<span class="builtintype" id="6111775">uint32</span><span class="op" id="6111781">(</span><span class="ident" id="6111782">dpix</span><span class="op" id="6111786">[</span><span class="ident" id="6111787">i</span><span class="op" id="6111788">+</span><span class="num" id="6111789">1</span><span class="op" id="6111790">]</span><span class="op" id="6111791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111796">db</span>&nbsp;<span class="op" id="6111799">:=</span>&nbsp;<span class="builtintype" id="6111802">uint32</span><span class="op" id="6111808">(</span><span class="ident" id="6111809">dpix</span><span class="op" id="6111813">[</span><span class="ident" id="6111814">i</span><span class="op" id="6111815">+</span><span class="num" id="6111816">2</span><span class="op" id="6111817">]</span><span class="op" id="6111818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111823">da</span>&nbsp;<span class="op" id="6111826">:=</span>&nbsp;<span class="builtintype" id="6111829">uint32</span><span class="op" id="6111835">(</span><span class="ident" id="6111836">dpix</span><span class="op" id="6111840">[</span><span class="ident" id="6111841">i</span><span class="op" id="6111842">+</span><span class="num" id="6111843">3</span><span class="op" id="6111844">]</span><span class="op" id="6111845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6111851">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111911">a</span>&nbsp;<span class="op" id="6111913">:=</span>&nbsp;<span class="op" id="6111916">(</span><span class="ident" id="6111917">m</span>&nbsp;<span class="op" id="6111919">-</span>&nbsp;<span class="ident" id="6111921">sa</span><span class="op" id="6111923">)</span>&nbsp;<span class="op" id="6111925">*</span>&nbsp;<span class="num" id="6111927">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111937">dpix</span><span class="op" id="6111941">[</span><span class="ident" id="6111942">i</span><span class="op" id="6111943">+</span><span class="num" id="6111944">0</span><span class="op" id="6111945">]</span>&nbsp;<span class="op" id="6111947">=</span>&nbsp;<span class="builtintype" id="6111949">uint8</span><span class="op" id="6111954">(</span><span class="op" id="6111955">(</span><span class="ident" id="6111956">dr</span><span class="op" id="6111958">*</span><span class="ident" id="6111959">a</span><span class="op" id="6111960">/</span><span class="ident" id="6111961">m</span>&nbsp;<span class="op" id="6111963">+</span>&nbsp;<span class="ident" id="6111965">sr</span><span class="op" id="6111967">)</span>&nbsp;<span class="op" id="6111969">&gt;&gt;</span>&nbsp;<span class="num" id="6111972">8</span><span class="op" id="6111973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111978">dpix</span><span class="op" id="6111982">[</span><span class="ident" id="6111983">i</span><span class="op" id="6111984">+</span><span class="num" id="6111985">1</span><span class="op" id="6111986">]</span>&nbsp;<span class="op" id="6111988">=</span>&nbsp;<span class="builtintype" id="6111990">uint8</span><span class="op" id="6111995">(</span><span class="op" id="6111996">(</span><span class="ident" id="6111997">dg</span><span class="op" id="6111999">*</span><span class="ident" id="6112000">a</span><span class="op" id="6112001">/</span><span class="ident" id="6112002">m</span>&nbsp;<span class="op" id="6112004">+</span>&nbsp;<span class="ident" id="6112006">sg</span><span class="op" id="6112008">)</span>&nbsp;<span class="op" id="6112010">&gt;&gt;</span>&nbsp;<span class="num" id="6112013">8</span><span class="op" id="6112014">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112019">dpix</span><span class="op" id="6112023">[</span><span class="ident" id="6112024">i</span><span class="op" id="6112025">+</span><span class="num" id="6112026">2</span><span class="op" id="6112027">]</span>&nbsp;<span class="op" id="6112029">=</span>&nbsp;<span class="builtintype" id="6112031">uint8</span><span class="op" id="6112036">(</span><span class="op" id="6112037">(</span><span class="ident" id="6112038">db</span><span class="op" id="6112040">*</span><span class="ident" id="6112041">a</span><span class="op" id="6112042">/</span><span class="ident" id="6112043">m</span>&nbsp;<span class="op" id="6112045">+</span>&nbsp;<span class="ident" id="6112047">sb</span><span class="op" id="6112049">)</span>&nbsp;<span class="op" id="6112051">&gt;&gt;</span>&nbsp;<span class="num" id="6112054">8</span><span class="op" id="6112055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112060">dpix</span><span class="op" id="6112064">[</span><span class="ident" id="6112065">i</span><span class="op" id="6112066">+</span><span class="num" id="6112067">3</span><span class="op" id="6112068">]</span>&nbsp;<span class="op" id="6112070">=</span>&nbsp;<span class="builtintype" id="6112072">uint8</span><span class="op" id="6112077">(</span><span class="op" id="6112078">(</span><span class="ident" id="6112079">da</span><span class="op" id="6112081">*</span><span class="ident" id="6112082">a</span><span class="op" id="6112083">/</span><span class="ident" id="6112084">m</span>&nbsp;<span class="op" id="6112086">+</span>&nbsp;<span class="ident" id="6112088">sa</span><span class="op" id="6112090">)</span>&nbsp;<span class="op" id="6112092">&gt;&gt;</span>&nbsp;<span class="num" id="6112095">8</span><span class="op" id="6112096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112103">}</span><br>
<span class="lineno"></span><span class="op" id="6112105">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="6112108">func</span>&nbsp;<span class="ident" id="6112113">drawNRGBASrc</span><span class="op" id="6112125">(</span><span class="ident" id="6112126">dst</span>&nbsp;<span class="op" id="6112130">*</span><span class="ident" id="6112131">image</span><span class="op" id="6112136">.</span><span class="ident" id="6112137">RGBA</span><span class="op" id="6112141">,</span>&nbsp;<span class="ident" id="6112143">r</span>&nbsp;<span class="ident" id="6112145">image</span><span class="op" id="6112150">.</span><span class="ident" id="6112151">Rectangle</span><span class="op" id="6112160">,</span>&nbsp;<span class="ident" id="6112162">src</span>&nbsp;<span class="op" id="6112166">*</span><span class="ident" id="6112167">image</span><span class="op" id="6112172">.</span><span class="ident" id="6112173">NRGBA</span><span class="op" id="6112178">,</span>&nbsp;<span class="ident" id="6112180">sp</span>&nbsp;<span class="ident" id="6112183">image</span><span class="op" id="6112188">.</span><span class="ident" id="6112189">Point</span><span class="op" id="6112194">)</span>&nbsp;<span class="op" id="6112196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112199">i0</span>&nbsp;<span class="op" id="6112202">:=</span>&nbsp;<span class="op" id="6112205">(</span><span class="ident" id="6112206">r</span><span class="op" id="6112207">.</span><span class="ident" id="6112208">Min</span><span class="op" id="6112211">.</span><span class="ident" id="6112212">X</span>&nbsp;<span class="op" id="6112214">-</span>&nbsp;<span class="ident" id="6112216">dst</span><span class="op" id="6112219">.</span><span class="ident" id="6112220">Rect</span><span class="op" id="6112224">.</span><span class="ident" id="6112225">Min</span><span class="op" id="6112228">.</span><span class="ident" id="6112229">X</span><span class="op" id="6112230">)</span>&nbsp;<span class="op" id="6112232">*</span>&nbsp;<span class="num" id="6112234">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112237">i1</span>&nbsp;<span class="op" id="6112240">:=</span>&nbsp;<span class="op" id="6112243">(</span><span class="ident" id="6112244">r</span><span class="op" id="6112245">.</span><span class="ident" id="6112246">Max</span><span class="op" id="6112249">.</span><span class="ident" id="6112250">X</span>&nbsp;<span class="op" id="6112252">-</span>&nbsp;<span class="ident" id="6112254">dst</span><span class="op" id="6112257">.</span><span class="ident" id="6112258">Rect</span><span class="op" id="6112262">.</span><span class="ident" id="6112263">Min</span><span class="op" id="6112266">.</span><span class="ident" id="6112267">X</span><span class="op" id="6112268">)</span>&nbsp;<span class="op" id="6112270">*</span>&nbsp;<span class="num" id="6112272">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112275">si0</span>&nbsp;<span class="op" id="6112279">:=</span>&nbsp;<span class="op" id="6112282">(</span><span class="ident" id="6112283">sp</span><span class="op" id="6112285">.</span><span class="ident" id="6112286">X</span>&nbsp;<span class="op" id="6112288">-</span>&nbsp;<span class="ident" id="6112290">src</span><span class="op" id="6112293">.</span><span class="ident" id="6112294">Rect</span><span class="op" id="6112298">.</span><span class="ident" id="6112299">Min</span><span class="op" id="6112302">.</span><span class="ident" id="6112303">X</span><span class="op" id="6112304">)</span>&nbsp;<span class="op" id="6112306">*</span>&nbsp;<span class="num" id="6112308">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112311">yMax</span>&nbsp;<span class="op" id="6112316">:=</span>&nbsp;<span class="ident" id="6112319">r</span><span class="op" id="6112320">.</span><span class="ident" id="6112321">Max</span><span class="op" id="6112324">.</span><span class="ident" id="6112325">Y</span>&nbsp;<span class="op" id="6112327">-</span>&nbsp;<span class="ident" id="6112329">dst</span><span class="op" id="6112332">.</span><span class="ident" id="6112333">Rect</span><span class="op" id="6112337">.</span><span class="ident" id="6112338">Min</span><span class="op" id="6112341">.</span><span class="ident" id="6112342">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112346">y</span>&nbsp;<span class="op" id="6112348">:=</span>&nbsp;<span class="ident" id="6112351">r</span><span class="op" id="6112352">.</span><span class="ident" id="6112353">Min</span><span class="op" id="6112356">.</span><span class="ident" id="6112357">Y</span>&nbsp;<span class="op" id="6112359">-</span>&nbsp;<span class="ident" id="6112361">dst</span><span class="op" id="6112364">.</span><span class="ident" id="6112365">Rect</span><span class="op" id="6112369">.</span><span class="ident" id="6112370">Min</span><span class="op" id="6112373">.</span><span class="ident" id="6112374">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112377">sy</span>&nbsp;<span class="op" id="6112380">:=</span>&nbsp;<span class="ident" id="6112383">sp</span><span class="op" id="6112385">.</span><span class="ident" id="6112386">Y</span>&nbsp;<span class="op" id="6112388">-</span>&nbsp;<span class="ident" id="6112390">src</span><span class="op" id="6112393">.</span><span class="ident" id="6112394">Rect</span><span class="op" id="6112398">.</span><span class="ident" id="6112399">Min</span><span class="op" id="6112402">.</span><span class="ident" id="6112403">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112406">for</span>&nbsp;<span class="op" id="6112410">;</span>&nbsp;<span class="ident" id="6112412">y</span>&nbsp;<span class="op" id="6112414">!=</span>&nbsp;<span class="ident" id="6112417">yMax</span><span class="op" id="6112421">;</span>&nbsp;<span class="ident" id="6112423">y</span><span class="op" id="6112424">,</span>&nbsp;<span class="ident" id="6112426">sy</span>&nbsp;<span class="op" id="6112429">=</span>&nbsp;<span class="ident" id="6112431">y</span><span class="op" id="6112432">+</span><span class="num" id="6112433">1</span><span class="op" id="6112434">,</span>&nbsp;<span class="ident" id="6112436">sy</span><span class="op" id="6112438">+</span><span class="num" id="6112439">1</span>&nbsp;<span class="op" id="6112441">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112445">dpix</span>&nbsp;<span class="op" id="6112450">:=</span>&nbsp;<span class="ident" id="6112453">dst</span><span class="op" id="6112456">.</span><span class="ident" id="6112457">Pix</span><span class="op" id="6112460">[</span><span class="ident" id="6112461">y</span><span class="op" id="6112462">*</span><span class="ident" id="6112463">dst</span><span class="op" id="6112466">.</span><span class="ident" id="6112467">Stride</span><span class="op" id="6112473">:</span><span class="op" id="6112474">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112478">spix</span>&nbsp;<span class="op" id="6112483">:=</span>&nbsp;<span class="ident" id="6112486">src</span><span class="op" id="6112489">.</span><span class="ident" id="6112490">Pix</span><span class="op" id="6112493">[</span><span class="ident" id="6112494">sy</span><span class="op" id="6112496">*</span><span class="ident" id="6112497">src</span><span class="op" id="6112500">.</span><span class="ident" id="6112501">Stride</span><span class="op" id="6112507">:</span><span class="op" id="6112508">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112513">for</span>&nbsp;<span class="ident" id="6112517">i</span><span class="op" id="6112518">,</span>&nbsp;<span class="ident" id="6112520">si</span>&nbsp;<span class="op" id="6112523">:=</span>&nbsp;<span class="ident" id="6112526">i0</span><span class="op" id="6112528">,</span>&nbsp;<span class="ident" id="6112530">si0</span><span class="op" id="6112533">;</span>&nbsp;<span class="ident" id="6112535">i</span>&nbsp;<span class="op" id="6112537">&lt;</span>&nbsp;<span class="ident" id="6112539">i1</span><span class="op" id="6112541">;</span>&nbsp;<span class="ident" id="6112543">i</span><span class="op" id="6112544">,</span>&nbsp;<span class="ident" id="6112546">si</span>&nbsp;<span class="op" id="6112549">=</span>&nbsp;<span class="ident" id="6112551">i</span><span class="op" id="6112552">+</span><span class="num" id="6112553">4</span><span class="op" id="6112554">,</span>&nbsp;<span class="ident" id="6112556">si</span><span class="op" id="6112558">+</span><span class="num" id="6112559">4</span>&nbsp;<span class="op" id="6112561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6112566">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112634">sa</span>&nbsp;<span class="op" id="6112637">:=</span>&nbsp;<span class="builtintype" id="6112640">uint32</span><span class="op" id="6112646">(</span><span class="ident" id="6112647">spix</span><span class="op" id="6112651">[</span><span class="ident" id="6112652">si</span><span class="op" id="6112654">+</span><span class="num" id="6112655">3</span><span class="op" id="6112656">]</span><span class="op" id="6112657">)</span>&nbsp;<span class="op" id="6112659">*</span>&nbsp;<span class="num" id="6112661">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112670">sr</span>&nbsp;<span class="op" id="6112673">:=</span>&nbsp;<span class="builtintype" id="6112676">uint32</span><span class="op" id="6112682">(</span><span class="ident" id="6112683">spix</span><span class="op" id="6112687">[</span><span class="ident" id="6112688">si</span><span class="op" id="6112690">+</span><span class="num" id="6112691">0</span><span class="op" id="6112692">]</span><span class="op" id="6112693">)</span>&nbsp;<span class="op" id="6112695">*</span>&nbsp;<span class="ident" id="6112697">sa</span>&nbsp;<span class="op" id="6112700">/</span>&nbsp;<span class="num" id="6112702">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112710">sg</span>&nbsp;<span class="op" id="6112713">:=</span>&nbsp;<span class="builtintype" id="6112716">uint32</span><span class="op" id="6112722">(</span><span class="ident" id="6112723">spix</span><span class="op" id="6112727">[</span><span class="ident" id="6112728">si</span><span class="op" id="6112730">+</span><span class="num" id="6112731">1</span><span class="op" id="6112732">]</span><span class="op" id="6112733">)</span>&nbsp;<span class="op" id="6112735">*</span>&nbsp;<span class="ident" id="6112737">sa</span>&nbsp;<span class="op" id="6112740">/</span>&nbsp;<span class="num" id="6112742">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112750">sb</span>&nbsp;<span class="op" id="6112753">:=</span>&nbsp;<span class="builtintype" id="6112756">uint32</span><span class="op" id="6112762">(</span><span class="ident" id="6112763">spix</span><span class="op" id="6112767">[</span><span class="ident" id="6112768">si</span><span class="op" id="6112770">+</span><span class="num" id="6112771">2</span><span class="op" id="6112772">]</span><span class="op" id="6112773">)</span>&nbsp;<span class="op" id="6112775">*</span>&nbsp;<span class="ident" id="6112777">sa</span>&nbsp;<span class="op" id="6112780">/</span>&nbsp;<span class="num" id="6112782">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112791">dpix</span><span class="op" id="6112795">[</span><span class="ident" id="6112796">i</span><span class="op" id="6112797">+</span><span class="num" id="6112798">0</span><span class="op" id="6112799">]</span>&nbsp;<span class="op" id="6112801">=</span>&nbsp;<span class="builtintype" id="6112803">uint8</span><span class="op" id="6112808">(</span><span class="ident" id="6112809">sr</span>&nbsp;<span class="op" id="6112812">&gt;&gt;</span>&nbsp;<span class="num" id="6112815">8</span><span class="op" id="6112816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112821">dpix</span><span class="op" id="6112825">[</span><span class="ident" id="6112826">i</span><span class="op" id="6112827">+</span><span class="num" id="6112828">1</span><span class="op" id="6112829">]</span>&nbsp;<span class="op" id="6112831">=</span>&nbsp;<span class="builtintype" id="6112833">uint8</span><span class="op" id="6112838">(</span><span class="ident" id="6112839">sg</span>&nbsp;<span class="op" id="6112842">&gt;&gt;</span>&nbsp;<span class="num" id="6112845">8</span><span class="op" id="6112846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112851">dpix</span><span class="op" id="6112855">[</span><span class="ident" id="6112856">i</span><span class="op" id="6112857">+</span><span class="num" id="6112858">2</span><span class="op" id="6112859">]</span>&nbsp;<span class="op" id="6112861">=</span>&nbsp;<span class="builtintype" id="6112863">uint8</span><span class="op" id="6112868">(</span><span class="ident" id="6112869">sb</span>&nbsp;<span class="op" id="6112872">&gt;&gt;</span>&nbsp;<span class="num" id="6112875">8</span><span class="op" id="6112876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112881">dpix</span><span class="op" id="6112885">[</span><span class="ident" id="6112886">i</span><span class="op" id="6112887">+</span><span class="num" id="6112888">3</span><span class="op" id="6112889">]</span>&nbsp;<span class="op" id="6112891">=</span>&nbsp;<span class="builtintype" id="6112893">uint8</span><span class="op" id="6112898">(</span><span class="ident" id="6112899">sa</span>&nbsp;<span class="op" id="6112902">&gt;&gt;</span>&nbsp;<span class="num" id="6112905">8</span><span class="op" id="6112906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112910">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112913">}</span><br>
<span class="lineno"></span><span class="op" id="6112915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112918">func</span>&nbsp;<span class="ident" id="6112923">drawYCbCr</span><span class="op" id="6112932">(</span><span class="ident" id="6112933">dst</span>&nbsp;<span class="op" id="6112937">*</span><span class="ident" id="6112938">image</span><span class="op" id="6112943">.</span><span class="ident" id="6112944">RGBA</span><span class="op" id="6112948">,</span>&nbsp;<span class="ident" id="6112950">r</span>&nbsp;<span class="ident" id="6112952">image</span><span class="op" id="6112957">.</span><span class="ident" id="6112958">Rectangle</span><span class="op" id="6112967">,</span>&nbsp;<span class="ident" id="6112969">src</span>&nbsp;<span class="op" id="6112973">*</span><span class="ident" id="6112974">image</span><span class="op" id="6112979">.</span><span class="ident" id="6112980">YCbCr</span><span class="op" id="6112985">,</span>&nbsp;<span class="ident" id="6112987">sp</span>&nbsp;<span class="ident" id="6112990">image</span><span class="op" id="6112995">.</span><span class="ident" id="6112996">Point</span><span class="op" id="6113001">)</span>&nbsp;<span class="op" id="6113003">(</span><span class="ident" id="6113004">ok</span>&nbsp;<span class="builtintype" id="6113007">bool</span><span class="op" id="6113011">)</span>&nbsp;<span class="op" id="6113013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6113016">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6113096">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113159">x0</span>&nbsp;<span class="op" id="6113162">:=</span>&nbsp;<span class="op" id="6113165">(</span><span class="ident" id="6113166">r</span><span class="op" id="6113167">.</span><span class="ident" id="6113168">Min</span><span class="op" id="6113171">.</span><span class="ident" id="6113172">X</span>&nbsp;<span class="op" id="6113174">-</span>&nbsp;<span class="ident" id="6113176">dst</span><span class="op" id="6113179">.</span><span class="ident" id="6113180">Rect</span><span class="op" id="6113184">.</span><span class="ident" id="6113185">Min</span><span class="op" id="6113188">.</span><span class="ident" id="6113189">X</span><span class="op" id="6113190">)</span>&nbsp;<span class="op" id="6113192">*</span>&nbsp;<span class="num" id="6113194">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113197">x1</span>&nbsp;<span class="op" id="6113200">:=</span>&nbsp;<span class="op" id="6113203">(</span><span class="ident" id="6113204">r</span><span class="op" id="6113205">.</span><span class="ident" id="6113206">Max</span><span class="op" id="6113209">.</span><span class="ident" id="6113210">X</span>&nbsp;<span class="op" id="6113212">-</span>&nbsp;<span class="ident" id="6113214">dst</span><span class="op" id="6113217">.</span><span class="ident" id="6113218">Rect</span><span class="op" id="6113222">.</span><span class="ident" id="6113223">Min</span><span class="op" id="6113226">.</span><span class="ident" id="6113227">X</span><span class="op" id="6113228">)</span>&nbsp;<span class="op" id="6113230">*</span>&nbsp;<span class="num" id="6113232">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113235">y0</span>&nbsp;<span class="op" id="6113238">:=</span>&nbsp;<span class="ident" id="6113241">r</span><span class="op" id="6113242">.</span><span class="ident" id="6113243">Min</span><span class="op" id="6113246">.</span><span class="ident" id="6113247">Y</span>&nbsp;<span class="op" id="6113249">-</span>&nbsp;<span class="ident" id="6113251">dst</span><span class="op" id="6113254">.</span><span class="ident" id="6113255">Rect</span><span class="op" id="6113259">.</span><span class="ident" id="6113260">Min</span><span class="op" id="6113263">.</span><span class="ident" id="6113264">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113267">y1</span>&nbsp;<span class="op" id="6113270">:=</span>&nbsp;<span class="ident" id="6113273">r</span><span class="op" id="6113274">.</span><span class="ident" id="6113275">Max</span><span class="op" id="6113278">.</span><span class="ident" id="6113279">Y</span>&nbsp;<span class="op" id="6113281">-</span>&nbsp;<span class="ident" id="6113283">dst</span><span class="op" id="6113286">.</span><span class="ident" id="6113287">Rect</span><span class="op" id="6113291">.</span><span class="ident" id="6113292">Min</span><span class="op" id="6113295">.</span><span class="ident" id="6113296">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113299">switch</span>&nbsp;<span class="ident" id="6113306">src</span><span class="op" id="6113309">.</span><span class="ident" id="6113310">SubsampleRatio</span>&nbsp;<span class="op" id="6113325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113328">case</span>&nbsp;<span class="ident" id="6113333">image</span><span class="op" id="6113338">.</span><span class="ident" id="6113339">YCbCrSubsampleRatio444</span><span class="op" id="6113361">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113365">for</span>&nbsp;<span class="ident" id="6113369">y</span><span class="op" id="6113370">,</span>&nbsp;<span class="ident" id="6113372">sy</span>&nbsp;<span class="op" id="6113375">:=</span>&nbsp;<span class="ident" id="6113378">y0</span><span class="op" id="6113380">,</span>&nbsp;<span class="ident" id="6113382">sp</span><span class="op" id="6113384">.</span><span class="ident" id="6113385">Y</span><span class="op" id="6113386">;</span>&nbsp;<span class="ident" id="6113388">y</span>&nbsp;<span class="op" id="6113390">!=</span>&nbsp;<span class="ident" id="6113393">y1</span><span class="op" id="6113395">;</span>&nbsp;<span class="ident" id="6113397">y</span><span class="op" id="6113398">,</span>&nbsp;<span class="ident" id="6113400">sy</span>&nbsp;<span class="op" id="6113403">=</span>&nbsp;<span class="ident" id="6113405">y</span><span class="op" id="6113406">+</span><span class="num" id="6113407">1</span><span class="op" id="6113408">,</span>&nbsp;<span class="ident" id="6113410">sy</span><span class="op" id="6113412">+</span><span class="num" id="6113413">1</span>&nbsp;<span class="op" id="6113415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113420">dpix</span>&nbsp;<span class="op" id="6113425">:=</span>&nbsp;<span class="ident" id="6113428">dst</span><span class="op" id="6113431">.</span><span class="ident" id="6113432">Pix</span><span class="op" id="6113435">[</span><span class="ident" id="6113436">y</span><span class="op" id="6113437">*</span><span class="ident" id="6113438">dst</span><span class="op" id="6113441">.</span><span class="ident" id="6113442">Stride</span><span class="op" id="6113448">:</span><span class="op" id="6113449">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113454">yi</span>&nbsp;<span class="op" id="6113457">:=</span>&nbsp;<span class="op" id="6113460">(</span><span class="ident" id="6113461">sy</span><span class="op" id="6113463">-</span><span class="ident" id="6113464">src</span><span class="op" id="6113467">.</span><span class="ident" id="6113468">Rect</span><span class="op" id="6113472">.</span><span class="ident" id="6113473">Min</span><span class="op" id="6113476">.</span><span class="ident" id="6113477">Y</span><span class="op" id="6113478">)</span><span class="op" id="6113479">*</span><span class="ident" id="6113480">src</span><span class="op" id="6113483">.</span><span class="ident" id="6113484">YStride</span>&nbsp;<span class="op" id="6113492">+</span>&nbsp;<span class="op" id="6113494">(</span><span class="ident" id="6113495">sp</span><span class="op" id="6113497">.</span><span class="ident" id="6113498">X</span>&nbsp;<span class="op" id="6113500">-</span>&nbsp;<span class="ident" id="6113502">src</span><span class="op" id="6113505">.</span><span class="ident" id="6113506">Rect</span><span class="op" id="6113510">.</span><span class="ident" id="6113511">Min</span><span class="op" id="6113514">.</span><span class="ident" id="6113515">X</span><span class="op" id="6113516">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113521">ci</span>&nbsp;<span class="op" id="6113524">:=</span>&nbsp;<span class="op" id="6113527">(</span><span class="ident" id="6113528">sy</span><span class="op" id="6113530">-</span><span class="ident" id="6113531">src</span><span class="op" id="6113534">.</span><span class="ident" id="6113535">Rect</span><span class="op" id="6113539">.</span><span class="ident" id="6113540">Min</span><span class="op" id="6113543">.</span><span class="ident" id="6113544">Y</span><span class="op" id="6113545">)</span><span class="op" id="6113546">*</span><span class="ident" id="6113547">src</span><span class="op" id="6113550">.</span><span class="ident" id="6113551">CStride</span>&nbsp;<span class="op" id="6113559">+</span>&nbsp;<span class="op" id="6113561">(</span><span class="ident" id="6113562">sp</span><span class="op" id="6113564">.</span><span class="ident" id="6113565">X</span>&nbsp;<span class="op" id="6113567">-</span>&nbsp;<span class="ident" id="6113569">src</span><span class="op" id="6113572">.</span><span class="ident" id="6113573">Rect</span><span class="op" id="6113577">.</span><span class="ident" id="6113578">Min</span><span class="op" id="6113581">.</span><span class="ident" id="6113582">X</span><span class="op" id="6113583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113588">for</span>&nbsp;<span class="ident" id="6113592">x</span>&nbsp;<span class="op" id="6113594">:=</span>&nbsp;<span class="ident" id="6113597">x0</span><span class="op" id="6113599">;</span>&nbsp;<span class="ident" id="6113601">x</span>&nbsp;<span class="op" id="6113603">!=</span>&nbsp;<span class="ident" id="6113606">x1</span><span class="op" id="6113608">;</span>&nbsp;<span class="ident" id="6113610">x</span><span class="op" id="6113611">,</span>&nbsp;<span class="ident" id="6113613">yi</span><span class="op" id="6113615">,</span>&nbsp;<span class="ident" id="6113617">ci</span>&nbsp;<span class="op" id="6113620">=</span>&nbsp;<span class="ident" id="6113622">x</span><span class="op" id="6113623">+</span><span class="num" id="6113624">4</span><span class="op" id="6113625">,</span>&nbsp;<span class="ident" id="6113627">yi</span><span class="op" id="6113629">+</span><span class="num" id="6113630">1</span><span class="op" id="6113631">,</span>&nbsp;<span class="ident" id="6113633">ci</span><span class="op" id="6113635">+</span><span class="num" id="6113636">1</span>&nbsp;<span class="op" id="6113638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113644">rr</span><span class="op" id="6113646">,</span>&nbsp;<span class="ident" id="6113648">gg</span><span class="op" id="6113650">,</span>&nbsp;<span class="ident" id="6113652">bb</span>&nbsp;<span class="op" id="6113655">:=</span>&nbsp;<span class="ident" id="6113658">color</span><span class="op" id="6113663">.</span><span class="ident" id="6113664">YCbCrToRGB</span><span class="op" id="6113674">(</span><span class="ident" id="6113675">src</span><span class="op" id="6113678">.</span><span class="ident" id="6113679">Y</span><span class="op" id="6113680">[</span><span class="ident" id="6113681">yi</span><span class="op" id="6113683">]</span><span class="op" id="6113684">,</span>&nbsp;<span class="ident" id="6113686">src</span><span class="op" id="6113689">.</span><span class="ident" id="6113690">Cb</span><span class="op" id="6113692">[</span><span class="ident" id="6113693">ci</span><span class="op" id="6113695">]</span><span class="op" id="6113696">,</span>&nbsp;<span class="ident" id="6113698">src</span><span class="op" id="6113701">.</span><span class="ident" id="6113702">Cr</span><span class="op" id="6113704">[</span><span class="ident" id="6113705">ci</span><span class="op" id="6113707">]</span><span class="op" id="6113708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113714">dpix</span><span class="op" id="6113718">[</span><span class="ident" id="6113719">x</span><span class="op" id="6113720">+</span><span class="num" id="6113721">0</span><span class="op" id="6113722">]</span>&nbsp;<span class="op" id="6113724">=</span>&nbsp;<span class="ident" id="6113726">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113733">dpix</span><span class="op" id="6113737">[</span><span class="ident" id="6113738">x</span><span class="op" id="6113739">+</span><span class="num" id="6113740">1</span><span class="op" id="6113741">]</span>&nbsp;<span class="op" id="6113743">=</span>&nbsp;<span class="ident" id="6113745">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113752">dpix</span><span class="op" id="6113756">[</span><span class="ident" id="6113757">x</span><span class="op" id="6113758">+</span><span class="num" id="6113759">2</span><span class="op" id="6113760">]</span>&nbsp;<span class="op" id="6113762">=</span>&nbsp;<span class="ident" id="6113764">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113771">dpix</span><span class="op" id="6113775">[</span><span class="ident" id="6113776">x</span><span class="op" id="6113777">+</span><span class="num" id="6113778">3</span><span class="op" id="6113779">]</span>&nbsp;<span class="op" id="6113781">=</span>&nbsp;<span class="num" id="6113783">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113797">case</span>&nbsp;<span class="ident" id="6113802">image</span><span class="op" id="6113807">.</span><span class="ident" id="6113808">YCbCrSubsampleRatio422</span><span class="op" id="6113830">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113834">for</span>&nbsp;<span class="ident" id="6113838">y</span><span class="op" id="6113839">,</span>&nbsp;<span class="ident" id="6113841">sy</span>&nbsp;<span class="op" id="6113844">:=</span>&nbsp;<span class="ident" id="6113847">y0</span><span class="op" id="6113849">,</span>&nbsp;<span class="ident" id="6113851">sp</span><span class="op" id="6113853">.</span><span class="ident" id="6113854">Y</span><span class="op" id="6113855">;</span>&nbsp;<span class="ident" id="6113857">y</span>&nbsp;<span class="op" id="6113859">!=</span>&nbsp;<span class="ident" id="6113862">y1</span><span class="op" id="6113864">;</span>&nbsp;<span class="ident" id="6113866">y</span><span class="op" id="6113867">,</span>&nbsp;<span class="ident" id="6113869">sy</span>&nbsp;<span class="op" id="6113872">=</span>&nbsp;<span class="ident" id="6113874">y</span><span class="op" id="6113875">+</span><span class="num" id="6113876">1</span><span class="op" id="6113877">,</span>&nbsp;<span class="ident" id="6113879">sy</span><span class="op" id="6113881">+</span><span class="num" id="6113882">1</span>&nbsp;<span class="op" id="6113884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113889">dpix</span>&nbsp;<span class="op" id="6113894">:=</span>&nbsp;<span class="ident" id="6113897">dst</span><span class="op" id="6113900">.</span><span class="ident" id="6113901">Pix</span><span class="op" id="6113904">[</span><span class="ident" id="6113905">y</span><span class="op" id="6113906">*</span><span class="ident" id="6113907">dst</span><span class="op" id="6113910">.</span><span class="ident" id="6113911">Stride</span><span class="op" id="6113917">:</span><span class="op" id="6113918">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113923">yi</span>&nbsp;<span class="op" id="6113926">:=</span>&nbsp;<span class="op" id="6113929">(</span><span class="ident" id="6113930">sy</span><span class="op" id="6113932">-</span><span class="ident" id="6113933">src</span><span class="op" id="6113936">.</span><span class="ident" id="6113937">Rect</span><span class="op" id="6113941">.</span><span class="ident" id="6113942">Min</span><span class="op" id="6113945">.</span><span class="ident" id="6113946">Y</span><span class="op" id="6113947">)</span><span class="op" id="6113948">*</span><span class="ident" id="6113949">src</span><span class="op" id="6113952">.</span><span class="ident" id="6113953">YStride</span>&nbsp;<span class="op" id="6113961">+</span>&nbsp;<span class="op" id="6113963">(</span><span class="ident" id="6113964">sp</span><span class="op" id="6113966">.</span><span class="ident" id="6113967">X</span>&nbsp;<span class="op" id="6113969">-</span>&nbsp;<span class="ident" id="6113971">src</span><span class="op" id="6113974">.</span><span class="ident" id="6113975">Rect</span><span class="op" id="6113979">.</span><span class="ident" id="6113980">Min</span><span class="op" id="6113983">.</span><span class="ident" id="6113984">X</span><span class="op" id="6113985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113990">ciBase</span>&nbsp;<span class="op" id="6113997">:=</span>&nbsp;<span class="op" id="6114000">(</span><span class="ident" id="6114001">sy</span><span class="op" id="6114003">-</span><span class="ident" id="6114004">src</span><span class="op" id="6114007">.</span><span class="ident" id="6114008">Rect</span><span class="op" id="6114012">.</span><span class="ident" id="6114013">Min</span><span class="op" id="6114016">.</span><span class="ident" id="6114017">Y</span><span class="op" id="6114018">)</span><span class="op" id="6114019">*</span><span class="ident" id="6114020">src</span><span class="op" id="6114023">.</span><span class="ident" id="6114024">CStride</span>&nbsp;<span class="op" id="6114032">-</span>&nbsp;<span class="ident" id="6114034">src</span><span class="op" id="6114037">.</span><span class="ident" id="6114038">Rect</span><span class="op" id="6114042">.</span><span class="ident" id="6114043">Min</span><span class="op" id="6114046">.</span><span class="ident" id="6114047">X</span><span class="op" id="6114048">/</span><span class="num" id="6114049">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114054">for</span>&nbsp;<span class="ident" id="6114058">x</span><span class="op" id="6114059">,</span>&nbsp;<span class="ident" id="6114061">sx</span>&nbsp;<span class="op" id="6114064">:=</span>&nbsp;<span class="ident" id="6114067">x0</span><span class="op" id="6114069">,</span>&nbsp;<span class="ident" id="6114071">sp</span><span class="op" id="6114073">.</span><span class="ident" id="6114074">X</span><span class="op" id="6114075">;</span>&nbsp;<span class="ident" id="6114077">x</span>&nbsp;<span class="op" id="6114079">!=</span>&nbsp;<span class="ident" id="6114082">x1</span><span class="op" id="6114084">;</span>&nbsp;<span class="ident" id="6114086">x</span><span class="op" id="6114087">,</span>&nbsp;<span class="ident" id="6114089">sx</span><span class="op" id="6114091">,</span>&nbsp;<span class="ident" id="6114093">yi</span>&nbsp;<span class="op" id="6114096">=</span>&nbsp;<span class="ident" id="6114098">x</span><span class="op" id="6114099">+</span><span class="num" id="6114100">4</span><span class="op" id="6114101">,</span>&nbsp;<span class="ident" id="6114103">sx</span><span class="op" id="6114105">+</span><span class="num" id="6114106">1</span><span class="op" id="6114107">,</span>&nbsp;<span class="ident" id="6114109">yi</span><span class="op" id="6114111">+</span><span class="num" id="6114112">1</span>&nbsp;<span class="op" id="6114114">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114120">ci</span>&nbsp;<span class="op" id="6114123">:=</span>&nbsp;<span class="ident" id="6114126">ciBase</span>&nbsp;<span class="op" id="6114133">+</span>&nbsp;<span class="ident" id="6114135">sx</span><span class="op" id="6114137">/</span><span class="num" id="6114138">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114144">rr</span><span class="op" id="6114146">,</span>&nbsp;<span class="ident" id="6114148">gg</span><span class="op" id="6114150">,</span>&nbsp;<span class="ident" id="6114152">bb</span>&nbsp;<span class="op" id="6114155">:=</span>&nbsp;<span class="ident" id="6114158">color</span><span class="op" id="6114163">.</span><span class="ident" id="6114164">YCbCrToRGB</span><span class="op" id="6114174">(</span><span class="ident" id="6114175">src</span><span class="op" id="6114178">.</span><span class="ident" id="6114179">Y</span><span class="op" id="6114180">[</span><span class="ident" id="6114181">yi</span><span class="op" id="6114183">]</span><span class="op" id="6114184">,</span>&nbsp;<span class="ident" id="6114186">src</span><span class="op" id="6114189">.</span><span class="ident" id="6114190">Cb</span><span class="op" id="6114192">[</span><span class="ident" id="6114193">ci</span><span class="op" id="6114195">]</span><span class="op" id="6114196">,</span>&nbsp;<span class="ident" id="6114198">src</span><span class="op" id="6114201">.</span><span class="ident" id="6114202">Cr</span><span class="op" id="6114204">[</span><span class="ident" id="6114205">ci</span><span class="op" id="6114207">]</span><span class="op" id="6114208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114214">dpix</span><span class="op" id="6114218">[</span><span class="ident" id="6114219">x</span><span class="op" id="6114220">+</span><span class="num" id="6114221">0</span><span class="op" id="6114222">]</span>&nbsp;<span class="op" id="6114224">=</span>&nbsp;<span class="ident" id="6114226">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114233">dpix</span><span class="op" id="6114237">[</span><span class="ident" id="6114238">x</span><span class="op" id="6114239">+</span><span class="num" id="6114240">1</span><span class="op" id="6114241">]</span>&nbsp;<span class="op" id="6114243">=</span>&nbsp;<span class="ident" id="6114245">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114252">dpix</span><span class="op" id="6114256">[</span><span class="ident" id="6114257">x</span><span class="op" id="6114258">+</span><span class="num" id="6114259">2</span><span class="op" id="6114260">]</span>&nbsp;<span class="op" id="6114262">=</span>&nbsp;<span class="ident" id="6114264">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114271">dpix</span><span class="op" id="6114275">[</span><span class="ident" id="6114276">x</span><span class="op" id="6114277">+</span><span class="num" id="6114278">3</span><span class="op" id="6114279">]</span>&nbsp;<span class="op" id="6114281">=</span>&nbsp;<span class="num" id="6114283">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114297">case</span>&nbsp;<span class="ident" id="6114302">image</span><span class="op" id="6114307">.</span><span class="ident" id="6114308">YCbCrSubsampleRatio420</span><span class="op" id="6114330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114334">for</span>&nbsp;<span class="ident" id="6114338">y</span><span class="op" id="6114339">,</span>&nbsp;<span class="ident" id="6114341">sy</span>&nbsp;<span class="op" id="6114344">:=</span>&nbsp;<span class="ident" id="6114347">y0</span><span class="op" id="6114349">,</span>&nbsp;<span class="ident" id="6114351">sp</span><span class="op" id="6114353">.</span><span class="ident" id="6114354">Y</span><span class="op" id="6114355">;</span>&nbsp;<span class="ident" id="6114357">y</span>&nbsp;<span class="op" id="6114359">!=</span>&nbsp;<span class="ident" id="6114362">y1</span><span class="op" id="6114364">;</span>&nbsp;<span class="ident" id="6114366">y</span><span class="op" id="6114367">,</span>&nbsp;<span class="ident" id="6114369">sy</span>&nbsp;<span class="op" id="6114372">=</span>&nbsp;<span class="ident" id="6114374">y</span><span class="op" id="6114375">+</span><span class="num" id="6114376">1</span><span class="op" id="6114377">,</span>&nbsp;<span class="ident" id="6114379">sy</span><span class="op" id="6114381">+</span><span class="num" id="6114382">1</span>&nbsp;<span class="op" id="6114384">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114389">dpix</span>&nbsp;<span class="op" id="6114394">:=</span>&nbsp;<span class="ident" id="6114397">dst</span><span class="op" id="6114400">.</span><span class="ident" id="6114401">Pix</span><span class="op" id="6114404">[</span><span class="ident" id="6114405">y</span><span class="op" id="6114406">*</span><span class="ident" id="6114407">dst</span><span class="op" id="6114410">.</span><span class="ident" id="6114411">Stride</span><span class="op" id="6114417">:</span><span class="op" id="6114418">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114423">yi</span>&nbsp;<span class="op" id="6114426">:=</span>&nbsp;<span class="op" id="6114429">(</span><span class="ident" id="6114430">sy</span><span class="op" id="6114432">-</span><span class="ident" id="6114433">src</span><span class="op" id="6114436">.</span><span class="ident" id="6114437">Rect</span><span class="op" id="6114441">.</span><span class="ident" id="6114442">Min</span><span class="op" id="6114445">.</span><span class="ident" id="6114446">Y</span><span class="op" id="6114447">)</span><span class="op" id="6114448">*</span><span class="ident" id="6114449">src</span><span class="op" id="6114452">.</span><span class="ident" id="6114453">YStride</span>&nbsp;<span class="op" id="6114461">+</span>&nbsp;<span class="op" id="6114463">(</span><span class="ident" id="6114464">sp</span><span class="op" id="6114466">.</span><span class="ident" id="6114467">X</span>&nbsp;<span class="op" id="6114469">-</span>&nbsp;<span class="ident" id="6114471">src</span><span class="op" id="6114474">.</span><span class="ident" id="6114475">Rect</span><span class="op" id="6114479">.</span><span class="ident" id="6114480">Min</span><span class="op" id="6114483">.</span><span class="ident" id="6114484">X</span><span class="op" id="6114485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114490">ciBase</span>&nbsp;<span class="op" id="6114497">:=</span>&nbsp;<span class="op" id="6114500">(</span><span class="ident" id="6114501">sy</span><span class="op" id="6114503">/</span><span class="num" id="6114504">2</span><span class="op" id="6114505">-</span><span class="ident" id="6114506">src</span><span class="op" id="6114509">.</span><span class="ident" id="6114510">Rect</span><span class="op" id="6114514">.</span><span class="ident" id="6114515">Min</span><span class="op" id="6114518">.</span><span class="ident" id="6114519">Y</span><span class="op" id="6114520">/</span><span class="num" id="6114521">2</span><span class="op" id="6114522">)</span><span class="op" id="6114523">*</span><span class="ident" id="6114524">src</span><span class="op" id="6114527">.</span><span class="ident" id="6114528">CStride</span>&nbsp;<span class="op" id="6114536">-</span>&nbsp;<span class="ident" id="6114538">src</span><span class="op" id="6114541">.</span><span class="ident" id="6114542">Rect</span><span class="op" id="6114546">.</span><span class="ident" id="6114547">Min</span><span class="op" id="6114550">.</span><span class="ident" id="6114551">X</span><span class="op" id="6114552">/</span><span class="num" id="6114553">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114558">for</span>&nbsp;<span class="ident" id="6114562">x</span><span class="op" id="6114563">,</span>&nbsp;<span class="ident" id="6114565">sx</span>&nbsp;<span class="op" id="6114568">:=</span>&nbsp;<span class="ident" id="6114571">x0</span><span class="op" id="6114573">,</span>&nbsp;<span class="ident" id="6114575">sp</span><span class="op" id="6114577">.</span><span class="ident" id="6114578">X</span><span class="op" id="6114579">;</span>&nbsp;<span class="ident" id="6114581">x</span>&nbsp;<span class="op" id="6114583">!=</span>&nbsp;<span class="ident" id="6114586">x1</span><span class="op" id="6114588">;</span>&nbsp;<span class="ident" id="6114590">x</span><span class="op" id="6114591">,</span>&nbsp;<span class="ident" id="6114593">sx</span><span class="op" id="6114595">,</span>&nbsp;<span class="ident" id="6114597">yi</span>&nbsp;<span class="op" id="6114600">=</span>&nbsp;<span class="ident" id="6114602">x</span><span class="op" id="6114603">+</span><span class="num" id="6114604">4</span><span class="op" id="6114605">,</span>&nbsp;<span class="ident" id="6114607">sx</span><span class="op" id="6114609">+</span><span class="num" id="6114610">1</span><span class="op" id="6114611">,</span>&nbsp;<span class="ident" id="6114613">yi</span><span class="op" id="6114615">+</span><span class="num" id="6114616">1</span>&nbsp;<span class="op" id="6114618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114624">ci</span>&nbsp;<span class="op" id="6114627">:=</span>&nbsp;<span class="ident" id="6114630">ciBase</span>&nbsp;<span class="op" id="6114637">+</span>&nbsp;<span class="ident" id="6114639">sx</span><span class="op" id="6114641">/</span><span class="num" id="6114642">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114648">rr</span><span class="op" id="6114650">,</span>&nbsp;<span class="ident" id="6114652">gg</span><span class="op" id="6114654">,</span>&nbsp;<span class="ident" id="6114656">bb</span>&nbsp;<span class="op" id="6114659">:=</span>&nbsp;<span class="ident" id="6114662">color</span><span class="op" id="6114667">.</span><span class="ident" id="6114668">YCbCrToRGB</span><span class="op" id="6114678">(</span><span class="ident" id="6114679">src</span><span class="op" id="6114682">.</span><span class="ident" id="6114683">Y</span><span class="op" id="6114684">[</span><span class="ident" id="6114685">yi</span><span class="op" id="6114687">]</span><span class="op" id="6114688">,</span>&nbsp;<span class="ident" id="6114690">src</span><span class="op" id="6114693">.</span><span class="ident" id="6114694">Cb</span><span class="op" id="6114696">[</span><span class="ident" id="6114697">ci</span><span class="op" id="6114699">]</span><span class="op" id="6114700">,</span>&nbsp;<span class="ident" id="6114702">src</span><span class="op" id="6114705">.</span><span class="ident" id="6114706">Cr</span><span class="op" id="6114708">[</span><span class="ident" id="6114709">ci</span><span class="op" id="6114711">]</span><span class="op" id="6114712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114718">dpix</span><span class="op" id="6114722">[</span><span class="ident" id="6114723">x</span><span class="op" id="6114724">+</span><span class="num" id="6114725">0</span><span class="op" id="6114726">]</span>&nbsp;<span class="op" id="6114728">=</span>&nbsp;<span class="ident" id="6114730">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114737">dpix</span><span class="op" id="6114741">[</span><span class="ident" id="6114742">x</span><span class="op" id="6114743">+</span><span class="num" id="6114744">1</span><span class="op" id="6114745">]</span>&nbsp;<span class="op" id="6114747">=</span>&nbsp;<span class="ident" id="6114749">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114756">dpix</span><span class="op" id="6114760">[</span><span class="ident" id="6114761">x</span><span class="op" id="6114762">+</span><span class="num" id="6114763">2</span><span class="op" id="6114764">]</span>&nbsp;<span class="op" id="6114766">=</span>&nbsp;<span class="ident" id="6114768">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114775">dpix</span><span class="op" id="6114779">[</span><span class="ident" id="6114780">x</span><span class="op" id="6114781">+</span><span class="num" id="6114782">3</span><span class="op" id="6114783">]</span>&nbsp;<span class="op" id="6114785">=</span>&nbsp;<span class="num" id="6114787">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114801">case</span>&nbsp;<span class="ident" id="6114806">image</span><span class="op" id="6114811">.</span><span class="ident" id="6114812">YCbCrSubsampleRatio440</span><span class="op" id="6114834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114838">for</span>&nbsp;<span class="ident" id="6114842">y</span><span class="op" id="6114843">,</span>&nbsp;<span class="ident" id="6114845">sy</span>&nbsp;<span class="op" id="6114848">:=</span>&nbsp;<span class="ident" id="6114851">y0</span><span class="op" id="6114853">,</span>&nbsp;<span class="ident" id="6114855">sp</span><span class="op" id="6114857">.</span><span class="ident" id="6114858">Y</span><span class="op" id="6114859">;</span>&nbsp;<span class="ident" id="6114861">y</span>&nbsp;<span class="op" id="6114863">!=</span>&nbsp;<span class="ident" id="6114866">y1</span><span class="op" id="6114868">;</span>&nbsp;<span class="ident" id="6114870">y</span><span class="op" id="6114871">,</span>&nbsp;<span class="ident" id="6114873">sy</span>&nbsp;<span class="op" id="6114876">=</span>&nbsp;<span class="ident" id="6114878">y</span><span class="op" id="6114879">+</span><span class="num" id="6114880">1</span><span class="op" id="6114881">,</span>&nbsp;<span class="ident" id="6114883">sy</span><span class="op" id="6114885">+</span><span class="num" id="6114886">1</span>&nbsp;<span class="op" id="6114888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114893">dpix</span>&nbsp;<span class="op" id="6114898">:=</span>&nbsp;<span class="ident" id="6114901">dst</span><span class="op" id="6114904">.</span><span class="ident" id="6114905">Pix</span><span class="op" id="6114908">[</span><span class="ident" id="6114909">y</span><span class="op" id="6114910">*</span><span class="ident" id="6114911">dst</span><span class="op" id="6114914">.</span><span class="ident" id="6114915">Stride</span><span class="op" id="6114921">:</span><span class="op" id="6114922">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114927">yi</span>&nbsp;<span class="op" id="6114930">:=</span>&nbsp;<span class="op" id="6114933">(</span><span class="ident" id="6114934">sy</span><span class="op" id="6114936">-</span><span class="ident" id="6114937">src</span><span class="op" id="6114940">.</span><span class="ident" id="6114941">Rect</span><span class="op" id="6114945">.</span><span class="ident" id="6114946">Min</span><span class="op" id="6114949">.</span><span class="ident" id="6114950">Y</span><span class="op" id="6114951">)</span><span class="op" id="6114952">*</span><span class="ident" id="6114953">src</span><span class="op" id="6114956">.</span><span class="ident" id="6114957">YStride</span>&nbsp;<span class="op" id="6114965">+</span>&nbsp;<span class="op" id="6114967">(</span><span class="ident" id="6114968">sp</span><span class="op" id="6114970">.</span><span class="ident" id="6114971">X</span>&nbsp;<span class="op" id="6114973">-</span>&nbsp;<span class="ident" id="6114975">src</span><span class="op" id="6114978">.</span><span class="ident" id="6114979">Rect</span><span class="op" id="6114983">.</span><span class="ident" id="6114984">Min</span><span class="op" id="6114987">.</span><span class="ident" id="6114988">X</span><span class="op" id="6114989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114994">ci</span>&nbsp;<span class="op" id="6114997">:=</span>&nbsp;<span class="op" id="6115000">(</span><span class="ident" id="6115001">sy</span><span class="op" id="6115003">/</span><span class="num" id="6115004">2</span><span class="op" id="6115005">-</span><span class="ident" id="6115006">src</span><span class="op" id="6115009">.</span><span class="ident" id="6115010">Rect</span><span class="op" id="6115014">.</span><span class="ident" id="6115015">Min</span><span class="op" id="6115018">.</span><span class="ident" id="6115019">Y</span><span class="op" id="6115020">/</span><span class="num" id="6115021">2</span><span class="op" id="6115022">)</span><span class="op" id="6115023">*</span><span class="ident" id="6115024">src</span><span class="op" id="6115027">.</span><span class="ident" id="6115028">CStride</span>&nbsp;<span class="op" id="6115036">+</span>&nbsp;<span class="op" id="6115038">(</span><span class="ident" id="6115039">sp</span><span class="op" id="6115041">.</span><span class="ident" id="6115042">X</span>&nbsp;<span class="op" id="6115044">-</span>&nbsp;<span class="ident" id="6115046">src</span><span class="op" id="6115049">.</span><span class="ident" id="6115050">Rect</span><span class="op" id="6115054">.</span><span class="ident" id="6115055">Min</span><span class="op" id="6115058">.</span><span class="ident" id="6115059">X</span><span class="op" id="6115060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115065">for</span>&nbsp;<span class="ident" id="6115069">x</span>&nbsp;<span class="op" id="6115071">:=</span>&nbsp;<span class="ident" id="6115074">x0</span><span class="op" id="6115076">;</span>&nbsp;<span class="ident" id="6115078">x</span>&nbsp;<span class="op" id="6115080">!=</span>&nbsp;<span class="ident" id="6115083">x1</span><span class="op" id="6115085">;</span>&nbsp;<span class="ident" id="6115087">x</span><span class="op" id="6115088">,</span>&nbsp;<span class="ident" id="6115090">yi</span><span class="op" id="6115092">,</span>&nbsp;<span class="ident" id="6115094">ci</span>&nbsp;<span class="op" id="6115097">=</span>&nbsp;<span class="ident" id="6115099">x</span><span class="op" id="6115100">+</span><span class="num" id="6115101">4</span><span class="op" id="6115102">,</span>&nbsp;<span class="ident" id="6115104">yi</span><span class="op" id="6115106">+</span><span class="num" id="6115107">1</span><span class="op" id="6115108">,</span>&nbsp;<span class="ident" id="6115110">ci</span><span class="op" id="6115112">+</span><span class="num" id="6115113">1</span>&nbsp;<span class="op" id="6115115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115121">rr</span><span class="op" id="6115123">,</span>&nbsp;<span class="ident" id="6115125">gg</span><span class="op" id="6115127">,</span>&nbsp;<span class="ident" id="6115129">bb</span>&nbsp;<span class="op" id="6115132">:=</span>&nbsp;<span class="ident" id="6115135">color</span><span class="op" id="6115140">.</span><span class="ident" id="6115141">YCbCrToRGB</span><span class="op" id="6115151">(</span><span class="ident" id="6115152">src</span><span class="op" id="6115155">.</span><span class="ident" id="6115156">Y</span><span class="op" id="6115157">[</span><span class="ident" id="6115158">yi</span><span class="op" id="6115160">]</span><span class="op" id="6115161">,</span>&nbsp;<span class="ident" id="6115163">src</span><span class="op" id="6115166">.</span><span class="ident" id="6115167">Cb</span><span class="op" id="6115169">[</span><span class="ident" id="6115170">ci</span><span class="op" id="6115172">]</span><span class="op" id="6115173">,</span>&nbsp;<span class="ident" id="6115175">src</span><span class="op" id="6115178">.</span><span class="ident" id="6115179">Cr</span><span class="op" id="6115181">[</span><span class="ident" id="6115182">ci</span><span class="op" id="6115184">]</span><span class="op" id="6115185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115191">dpix</span><span class="op" id="6115195">[</span><span class="ident" id="6115196">x</span><span class="op" id="6115197">+</span><span class="num" id="6115198">0</span><span class="op" id="6115199">]</span>&nbsp;<span class="op" id="6115201">=</span>&nbsp;<span class="ident" id="6115203">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115210">dpix</span><span class="op" id="6115214">[</span><span class="ident" id="6115215">x</span><span class="op" id="6115216">+</span><span class="num" id="6115217">1</span><span class="op" id="6115218">]</span>&nbsp;<span class="op" id="6115220">=</span>&nbsp;<span class="ident" id="6115222">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115229">dpix</span><span class="op" id="6115233">[</span><span class="ident" id="6115234">x</span><span class="op" id="6115235">+</span><span class="num" id="6115236">2</span><span class="op" id="6115237">]</span>&nbsp;<span class="op" id="6115239">=</span>&nbsp;<span class="ident" id="6115241">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115248">dpix</span><span class="op" id="6115252">[</span><span class="ident" id="6115253">x</span><span class="op" id="6115254">+</span><span class="num" id="6115255">3</span><span class="op" id="6115256">]</span>&nbsp;<span class="op" id="6115258">=</span>&nbsp;<span class="num" id="6115260">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115271">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115274">default</span><span class="op" id="6115281">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115285">return</span>&nbsp;<span class="builtintype" id="6115292">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115302">return</span>&nbsp;<span class="builtintype" id="6115309">true</span><br>
<span class="lineno"></span><span class="op" id="6115314">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="6115317">func</span>&nbsp;<span class="ident" id="6115322">drawGlyphOver</span><span class="op" id="6115335">(</span><span class="ident" id="6115336">dst</span>&nbsp;<span class="op" id="6115340">*</span><span class="ident" id="6115341">image</span><span class="op" id="6115346">.</span><span class="ident" id="6115347">RGBA</span><span class="op" id="6115351">,</span>&nbsp;<span class="ident" id="6115353">r</span>&nbsp;<span class="ident" id="6115355">image</span><span class="op" id="6115360">.</span><span class="ident" id="6115361">Rectangle</span><span class="op" id="6115370">,</span>&nbsp;<span class="ident" id="6115372">src</span>&nbsp;<span class="op" id="6115376">*</span><span class="ident" id="6115377">image</span><span class="op" id="6115382">.</span><span class="ident" id="6115383">Uniform</span><span class="op" id="6115390">,</span>&nbsp;<span class="ident" id="6115392">mask</span>&nbsp;<span class="op" id="6115397">*</span><span class="ident" id="6115398">image</span><span class="op" id="6115403">.</span><span class="ident" id="6115404">Alpha</span><span class="op" id="6115409">,</span>&nbsp;<span class="ident" id="6115411">mp</span>&nbsp;<span class="ident" id="6115414">image</span><span class="op" id="6115419">.</span><span class="ident" id="6115420">Point</span><span class="op" id="6115425">)</span>&nbsp;<span class="op" id="6115427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115430">i0</span>&nbsp;<span class="op" id="6115433">:=</span>&nbsp;<span class="ident" id="6115436">dst</span><span class="op" id="6115439">.</span><span class="ident" id="6115440">PixOffset</span><span class="op" id="6115449">(</span><span class="ident" id="6115450">r</span><span class="op" id="6115451">.</span><span class="ident" id="6115452">Min</span><span class="op" id="6115455">.</span><span class="ident" id="6115456">X</span><span class="op" id="6115457">,</span>&nbsp;<span class="ident" id="6115459">r</span><span class="op" id="6115460">.</span><span class="ident" id="6115461">Min</span><span class="op" id="6115464">.</span><span class="ident" id="6115465">Y</span><span class="op" id="6115466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115469">i1</span>&nbsp;<span class="op" id="6115472">:=</span>&nbsp;<span class="ident" id="6115475">i0</span>&nbsp;<span class="op" id="6115478">+</span>&nbsp;<span class="ident" id="6115480">r</span><span class="op" id="6115481">.</span><span class="ident" id="6115482">Dx</span><span class="op" id="6115484">(</span><span class="op" id="6115485">)</span><span class="op" id="6115486">*</span><span class="num" id="6115487">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115490">mi0</span>&nbsp;<span class="op" id="6115494">:=</span>&nbsp;<span class="ident" id="6115497">mask</span><span class="op" id="6115501">.</span><span class="ident" id="6115502">PixOffset</span><span class="op" id="6115511">(</span><span class="ident" id="6115512">mp</span><span class="op" id="6115514">.</span><span class="ident" id="6115515">X</span><span class="op" id="6115516">,</span>&nbsp;<span class="ident" id="6115518">mp</span><span class="op" id="6115520">.</span><span class="ident" id="6115521">Y</span><span class="op" id="6115522">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115525">sr</span><span class="op" id="6115527">,</span>&nbsp;<span class="ident" id="6115529">sg</span><span class="op" id="6115531">,</span>&nbsp;<span class="ident" id="6115533">sb</span><span class="op" id="6115535">,</span>&nbsp;<span class="ident" id="6115537">sa</span>&nbsp;<span class="op" id="6115540">:=</span>&nbsp;<span class="ident" id="6115543">src</span><span class="op" id="6115546">.</span><span class="ident" id="6115547">RGBA</span><span class="op" id="6115551">(</span><span class="op" id="6115552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115555">for</span>&nbsp;<span class="ident" id="6115559">y</span><span class="op" id="6115560">,</span>&nbsp;<span class="ident" id="6115562">my</span>&nbsp;<span class="op" id="6115565">:=</span>&nbsp;<span class="ident" id="6115568">r</span><span class="op" id="6115569">.</span><span class="ident" id="6115570">Min</span><span class="op" id="6115573">.</span><span class="ident" id="6115574">Y</span><span class="op" id="6115575">,</span>&nbsp;<span class="ident" id="6115577">mp</span><span class="op" id="6115579">.</span><span class="ident" id="6115580">Y</span><span class="op" id="6115581">;</span>&nbsp;<span class="ident" id="6115583">y</span>&nbsp;<span class="op" id="6115585">!=</span>&nbsp;<span class="ident" id="6115588">r</span><span class="op" id="6115589">.</span><span class="ident" id="6115590">Max</span><span class="op" id="6115593">.</span><span class="ident" id="6115594">Y</span><span class="op" id="6115595">;</span>&nbsp;<span class="ident" id="6115597">y</span><span class="op" id="6115598">,</span>&nbsp;<span class="ident" id="6115600">my</span>&nbsp;<span class="op" id="6115603">=</span>&nbsp;<span class="ident" id="6115605">y</span><span class="op" id="6115606">+</span><span class="num" id="6115607">1</span><span class="op" id="6115608">,</span>&nbsp;<span class="ident" id="6115610">my</span><span class="op" id="6115612">+</span><span class="num" id="6115613">1</span>&nbsp;<span class="op" id="6115615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115619">for</span>&nbsp;<span class="ident" id="6115623">i</span><span class="op" id="6115624">,</span>&nbsp;<span class="ident" id="6115626">mi</span>&nbsp;<span class="op" id="6115629">:=</span>&nbsp;<span class="ident" id="6115632">i0</span><span class="op" id="6115634">,</span>&nbsp;<span class="ident" id="6115636">mi0</span><span class="op" id="6115639">;</span>&nbsp;<span class="ident" id="6115641">i</span>&nbsp;<span class="op" id="6115643">&lt;</span>&nbsp;<span class="ident" id="6115645">i1</span><span class="op" id="6115647">;</span>&nbsp;<span class="ident" id="6115649">i</span><span class="op" id="6115650">,</span>&nbsp;<span class="ident" id="6115652">mi</span>&nbsp;<span class="op" id="6115655">=</span>&nbsp;<span class="ident" id="6115657">i</span><span class="op" id="6115658">+</span><span class="num" id="6115659">4</span><span class="op" id="6115660">,</span>&nbsp;<span class="ident" id="6115662">mi</span><span class="op" id="6115664">+</span><span class="num" id="6115665">1</span>&nbsp;<span class="op" id="6115667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115672">ma</span>&nbsp;<span class="op" id="6115675">:=</span>&nbsp;<span class="builtintype" id="6115678">uint32</span><span class="op" id="6115684">(</span><span class="ident" id="6115685">mask</span><span class="op" id="6115689">.</span><span class="ident" id="6115690">Pix</span><span class="op" id="6115693">[</span><span class="ident" id="6115694">mi</span><span class="op" id="6115696">]</span><span class="op" id="6115697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115702">if</span>&nbsp;<span class="ident" id="6115705">ma</span>&nbsp;<span class="op" id="6115708">==</span>&nbsp;<span class="num" id="6115711">0</span>&nbsp;<span class="op" id="6115713">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115719">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115736">ma</span>&nbsp;<span class="op" id="6115739">|=</span>&nbsp;<span class="ident" id="6115742">ma</span>&nbsp;<span class="op" id="6115745">&lt;&lt;</span>&nbsp;<span class="num" id="6115748">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115754">dr</span>&nbsp;<span class="op" id="6115757">:=</span>&nbsp;<span class="builtintype" id="6115760">uint32</span><span class="op" id="6115766">(</span><span class="ident" id="6115767">dst</span><span class="op" id="6115770">.</span><span class="ident" id="6115771">Pix</span><span class="op" id="6115774">[</span><span class="ident" id="6115775">i</span><span class="op" id="6115776">+</span><span class="num" id="6115777">0</span><span class="op" id="6115778">]</span><span class="op" id="6115779">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115784">dg</span>&nbsp;<span class="op" id="6115787">:=</span>&nbsp;<span class="builtintype" id="6115790">uint32</span><span class="op" id="6115796">(</span><span class="ident" id="6115797">dst</span><span class="op" id="6115800">.</span><span class="ident" id="6115801">Pix</span><span class="op" id="6115804">[</span><span class="ident" id="6115805">i</span><span class="op" id="6115806">+</span><span class="num" id="6115807">1</span><span class="op" id="6115808">]</span><span class="op" id="6115809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115814">db</span>&nbsp;<span class="op" id="6115817">:=</span>&nbsp;<span class="builtintype" id="6115820">uint32</span><span class="op" id="6115826">(</span><span class="ident" id="6115827">dst</span><span class="op" id="6115830">.</span><span class="ident" id="6115831">Pix</span><span class="op" id="6115834">[</span><span class="ident" id="6115835">i</span><span class="op" id="6115836">+</span><span class="num" id="6115837">2</span><span class="op" id="6115838">]</span><span class="op" id="6115839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115844">da</span>&nbsp;<span class="op" id="6115847">:=</span>&nbsp;<span class="builtintype" id="6115850">uint32</span><span class="op" id="6115856">(</span><span class="ident" id="6115857">dst</span><span class="op" id="6115860">.</span><span class="ident" id="6115861">Pix</span><span class="op" id="6115864">[</span><span class="ident" id="6115865">i</span><span class="op" id="6115866">+</span><span class="num" id="6115867">3</span><span class="op" id="6115868">]</span><span class="op" id="6115869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115875">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115935">a</span>&nbsp;<span class="op" id="6115937">:=</span>&nbsp;<span class="op" id="6115940">(</span><span class="ident" id="6115941">m</span>&nbsp;<span class="op" id="6115943">-</span>&nbsp;<span class="op" id="6115945">(</span><span class="ident" id="6115946">sa</span>&nbsp;<span class="op" id="6115949">*</span>&nbsp;<span class="ident" id="6115951">ma</span>&nbsp;<span class="op" id="6115954">/</span>&nbsp;<span class="ident" id="6115956">m</span><span class="op" id="6115957">)</span><span class="op" id="6115958">)</span>&nbsp;<span class="op" id="6115960">*</span>&nbsp;<span class="num" id="6115962">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115972">dst</span><span class="op" id="6115975">.</span><span class="ident" id="6115976">Pix</span><span class="op" id="6115979">[</span><span class="ident" id="6115980">i</span><span class="op" id="6115981">+</span><span class="num" id="6115982">0</span><span class="op" id="6115983">]</span>&nbsp;<span class="op" id="6115985">=</span>&nbsp;<span class="builtintype" id="6115987">uint8</span><span class="op" id="6115992">(</span><span class="op" id="6115993">(</span><span class="ident" id="6115994">dr</span><span class="op" id="6115996">*</span><span class="ident" id="6115997">a</span>&nbsp;<span class="op" id="6115999">+</span>&nbsp;<span class="ident" id="6116001">sr</span><span class="op" id="6116003">*</span><span class="ident" id="6116004">ma</span><span class="op" id="6116006">)</span>&nbsp;<span class="op" id="6116008">/</span>&nbsp;<span class="ident" id="6116010">m</span>&nbsp;<span class="op" id="6116012">&gt;&gt;</span>&nbsp;<span class="num" id="6116015">8</span><span class="op" id="6116016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116021">dst</span><span class="op" id="6116024">.</span><span class="ident" id="6116025">Pix</span><span class="op" id="6116028">[</span><span class="ident" id="6116029">i</span><span class="op" id="6116030">+</span><span class="num" id="6116031">1</span><span class="op" id="6116032">]</span>&nbsp;<span class="op" id="6116034">=</span>&nbsp;<span class="builtintype" id="6116036">uint8</span><span class="op" id="6116041">(</span><span class="op" id="6116042">(</span><span class="ident" id="6116043">dg</span><span class="op" id="6116045">*</span><span class="ident" id="6116046">a</span>&nbsp;<span class="op" id="6116048">+</span>&nbsp;<span class="ident" id="6116050">sg</span><span class="op" id="6116052">*</span><span class="ident" id="6116053">ma</span><span class="op" id="6116055">)</span>&nbsp;<span class="op" id="6116057">/</span>&nbsp;<span class="ident" id="6116059">m</span>&nbsp;<span class="op" id="6116061">&gt;&gt;</span>&nbsp;<span class="num" id="6116064">8</span><span class="op" id="6116065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116070">dst</span><span class="op" id="6116073">.</span><span class="ident" id="6116074">Pix</span><span class="op" id="6116077">[</span><span class="ident" id="6116078">i</span><span class="op" id="6116079">+</span><span class="num" id="6116080">2</span><span class="op" id="6116081">]</span>&nbsp;<span class="op" id="6116083">=</span>&nbsp;<span class="builtintype" id="6116085">uint8</span><span class="op" id="6116090">(</span><span class="op" id="6116091">(</span><span class="ident" id="6116092">db</span><span class="op" id="6116094">*</span><span class="ident" id="6116095">a</span>&nbsp;<span class="op" id="6116097">+</span>&nbsp;<span class="ident" id="6116099">sb</span><span class="op" id="6116101">*</span><span class="ident" id="6116102">ma</span><span class="op" id="6116104">)</span>&nbsp;<span class="op" id="6116106">/</span>&nbsp;<span class="ident" id="6116108">m</span>&nbsp;<span class="op" id="6116110">&gt;&gt;</span>&nbsp;<span class="num" id="6116113">8</span><span class="op" id="6116114">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116119">dst</span><span class="op" id="6116122">.</span><span class="ident" id="6116123">Pix</span><span class="op" id="6116126">[</span><span class="ident" id="6116127">i</span><span class="op" id="6116128">+</span><span class="num" id="6116129">3</span><span class="op" id="6116130">]</span>&nbsp;<span class="op" id="6116132">=</span>&nbsp;<span class="builtintype" id="6116134">uint8</span><span class="op" id="6116139">(</span><span class="op" id="6116140">(</span><span class="ident" id="6116141">da</span><span class="op" id="6116143">*</span><span class="ident" id="6116144">a</span>&nbsp;<span class="op" id="6116146">+</span>&nbsp;<span class="ident" id="6116148">sa</span><span class="op" id="6116150">*</span><span class="ident" id="6116151">ma</span><span class="op" id="6116153">)</span>&nbsp;<span class="op" id="6116155">/</span>&nbsp;<span class="ident" id="6116157">m</span>&nbsp;<span class="op" id="6116159">&gt;&gt;</span>&nbsp;<span class="num" id="6116162">8</span><span class="op" id="6116163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116171">i0</span>&nbsp;<span class="op" id="6116174">+=</span>&nbsp;<span class="ident" id="6116177">dst</span><span class="op" id="6116180">.</span><span class="ident" id="6116181">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116190">i1</span>&nbsp;<span class="op" id="6116193">+=</span>&nbsp;<span class="ident" id="6116196">dst</span><span class="op" id="6116199">.</span><span class="ident" id="6116200">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116209">mi0</span>&nbsp;<span class="op" id="6116213">+=</span>&nbsp;<span class="ident" id="6116216">mask</span><span class="op" id="6116220">.</span><span class="ident" id="6116221">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116229">}</span><br>
<span class="lineno"></span><span class="op" id="6116231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6116234">func</span>&nbsp;<span class="ident" id="6116239">drawRGBA</span><span class="op" id="6116247">(</span><span class="ident" id="6116248">dst</span>&nbsp;<span class="op" id="6116252">*</span><span class="ident" id="6116253">image</span><span class="op" id="6116258">.</span><span class="ident" id="6116259">RGBA</span><span class="op" id="6116263">,</span>&nbsp;<span class="ident" id="6116265">r</span>&nbsp;<span class="ident" id="6116267">image</span><span class="op" id="6116272">.</span><span class="ident" id="6116273">Rectangle</span><span class="op" id="6116282">,</span>&nbsp;<span class="ident" id="6116284">src</span>&nbsp;<span class="ident" id="6116288">image</span><span class="op" id="6116293">.</span><span class="ident" id="6116294">Image</span><span class="op" id="6116299">,</span>&nbsp;<span class="ident" id="6116301">sp</span>&nbsp;<span class="ident" id="6116304">image</span><span class="op" id="6116309">.</span><span class="ident" id="6116310">Point</span><span class="op" id="6116315">,</span>&nbsp;<span class="ident" id="6116317">mask</span>&nbsp;<span class="ident" id="6116322">image</span><span class="op" id="6116327">.</span><span class="ident" id="6116328">Image</span><span class="op" id="6116333">,</span>&nbsp;<span class="ident" id="6116335">mp</span>&nbsp;<span class="ident" id="6116338">image</span><span class="op" id="6116343">.</span><span class="ident" id="6116344">Point</span><span class="op" id="6116349">,</span>&nbsp;<span class="ident" id="6116351">op</span>&nbsp;<span class="ident" id="6116354">Op</span><span class="op" id="6116356">)</span>&nbsp;<span class="op" id="6116358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116361">x0</span><span class="op" id="6116363">,</span>&nbsp;<span class="ident" id="6116365">x1</span><span class="op" id="6116367">,</span>&nbsp;<span class="ident" id="6116369">dx</span>&nbsp;<span class="op" id="6116372">:=</span>&nbsp;<span class="ident" id="6116375">r</span><span class="op" id="6116376">.</span><span class="ident" id="6116377">Min</span><span class="op" id="6116380">.</span><span class="ident" id="6116381">X</span><span class="op" id="6116382">,</span>&nbsp;<span class="ident" id="6116384">r</span><span class="op" id="6116385">.</span><span class="ident" id="6116386">Max</span><span class="op" id="6116389">.</span><span class="ident" id="6116390">X</span><span class="op" id="6116391">,</span>&nbsp;<span class="num" id="6116393">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116396">y0</span><span class="op" id="6116398">,</span>&nbsp;<span class="ident" id="6116400">y1</span><span class="op" id="6116402">,</span>&nbsp;<span class="ident" id="6116404">dy</span>&nbsp;<span class="op" id="6116407">:=</span>&nbsp;<span class="ident" id="6116410">r</span><span class="op" id="6116411">.</span><span class="ident" id="6116412">Min</span><span class="op" id="6116415">.</span><span class="ident" id="6116416">Y</span><span class="op" id="6116417">,</span>&nbsp;<span class="ident" id="6116419">r</span><span class="op" id="6116420">.</span><span class="ident" id="6116421">Max</span><span class="op" id="6116424">.</span><span class="ident" id="6116425">Y</span><span class="op" id="6116426">,</span>&nbsp;<span class="num" id="6116428">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116431">if</span>&nbsp;<span class="ident" id="6116434">image</span><span class="op" id="6116439">.</span><span class="ident" id="6116440">Image</span><span class="op" id="6116445">(</span><span class="ident" id="6116446">dst</span><span class="op" id="6116449">)</span>&nbsp;<span class="op" id="6116451">==</span>&nbsp;<span class="ident" id="6116454">src</span>&nbsp;<span class="op" id="6116458">&amp;&amp;</span>&nbsp;<span class="ident" id="6116461">r</span><span class="op" id="6116462">.</span><span class="ident" id="6116463">Overlaps</span><span class="op" id="6116471">(</span><span class="ident" id="6116472">r</span><span class="op" id="6116473">.</span><span class="ident" id="6116474">Add</span><span class="op" id="6116477">(</span><span class="ident" id="6116478">sp</span><span class="op" id="6116480">.</span><span class="ident" id="6116481">Sub</span><span class="op" id="6116484">(</span><span class="ident" id="6116485">r</span><span class="op" id="6116486">.</span><span class="ident" id="6116487">Min</span><span class="op" id="6116490">)</span><span class="op" id="6116491">)</span><span class="op" id="6116492">)</span>&nbsp;<span class="op" id="6116494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116498">if</span>&nbsp;<span class="ident" id="6116501">sp</span><span class="op" id="6116503">.</span><span class="ident" id="6116504">Y</span>&nbsp;<span class="op" id="6116506">&lt;</span>&nbsp;<span class="ident" id="6116508">r</span><span class="op" id="6116509">.</span><span class="ident" id="6116510">Min</span><span class="op" id="6116513">.</span><span class="ident" id="6116514">Y</span>&nbsp;<span class="op" id="6116516">||</span>&nbsp;<span class="ident" id="6116519">sp</span><span class="op" id="6116521">.</span><span class="ident" id="6116522">Y</span>&nbsp;<span class="op" id="6116524">==</span>&nbsp;<span class="ident" id="6116527">r</span><span class="op" id="6116528">.</span><span class="ident" id="6116529">Min</span><span class="op" id="6116532">.</span><span class="ident" id="6116533">Y</span>&nbsp;<span class="op" id="6116535">&amp;&amp;</span>&nbsp;<span class="ident" id="6116538">sp</span><span class="op" id="6116540">.</span><span class="ident" id="6116541">X</span>&nbsp;<span class="op" id="6116543">&lt;</span>&nbsp;<span class="ident" id="6116545">r</span><span class="op" id="6116546">.</span><span class="ident" id="6116547">Min</span><span class="op" id="6116550">.</span><span class="ident" id="6116551">X</span>&nbsp;<span class="op" id="6116553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116558">x0</span><span class="op" id="6116560">,</span>&nbsp;<span class="ident" id="6116562">x1</span><span class="op" id="6116564">,</span>&nbsp;<span class="ident" id="6116566">dx</span>&nbsp;<span class="op" id="6116569">=</span>&nbsp;<span class="ident" id="6116571">x1</span><span class="op" id="6116573">-</span><span class="num" id="6116574">1</span><span class="op" id="6116575">,</span>&nbsp;<span class="ident" id="6116577">x0</span><span class="op" id="6116579">-</span><span class="num" id="6116580">1</span><span class="op" id="6116581">,</span>&nbsp;<span class="op" id="6116583">-</span><span class="num" id="6116584">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116589">y0</span><span class="op" id="6116591">,</span>&nbsp;<span class="ident" id="6116593">y1</span><span class="op" id="6116595">,</span>&nbsp;<span class="ident" id="6116597">dy</span>&nbsp;<span class="op" id="6116600">=</span>&nbsp;<span class="ident" id="6116602">y1</span><span class="op" id="6116604">-</span><span class="num" id="6116605">1</span><span class="op" id="6116606">,</span>&nbsp;<span class="ident" id="6116608">y0</span><span class="op" id="6116610">-</span><span class="num" id="6116611">1</span><span class="op" id="6116612">,</span>&nbsp;<span class="op" id="6116614">-</span><span class="num" id="6116615">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116626">sy</span>&nbsp;<span class="op" id="6116629">:=</span>&nbsp;<span class="ident" id="6116632">sp</span><span class="op" id="6116634">.</span><span class="ident" id="6116635">Y</span>&nbsp;<span class="op" id="6116637">+</span>&nbsp;<span class="ident" id="6116639">y0</span>&nbsp;<span class="op" id="6116642">-</span>&nbsp;<span class="ident" id="6116644">r</span><span class="op" id="6116645">.</span><span class="ident" id="6116646">Min</span><span class="op" id="6116649">.</span><span class="ident" id="6116650">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116653">my</span>&nbsp;<span class="op" id="6116656">:=</span>&nbsp;<span class="ident" id="6116659">mp</span><span class="op" id="6116661">.</span><span class="ident" id="6116662">Y</span>&nbsp;<span class="op" id="6116664">+</span>&nbsp;<span class="ident" id="6116666">y0</span>&nbsp;<span class="op" id="6116669">-</span>&nbsp;<span class="ident" id="6116671">r</span><span class="op" id="6116672">.</span><span class="ident" id="6116673">Min</span><span class="op" id="6116676">.</span><span class="ident" id="6116677">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116680">sx0</span>&nbsp;<span class="op" id="6116684">:=</span>&nbsp;<span class="ident" id="6116687">sp</span><span class="op" id="6116689">.</span><span class="ident" id="6116690">X</span>&nbsp;<span class="op" id="6116692">+</span>&nbsp;<span class="ident" id="6116694">x0</span>&nbsp;<span class="op" id="6116697">-</span>&nbsp;<span class="ident" id="6116699">r</span><span class="op" id="6116700">.</span><span class="ident" id="6116701">Min</span><span class="op" id="6116704">.</span><span class="ident" id="6116705">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116708">mx0</span>&nbsp;<span class="op" id="6116712">:=</span>&nbsp;<span class="ident" id="6116715">mp</span><span class="op" id="6116717">.</span><span class="ident" id="6116718">X</span>&nbsp;<span class="op" id="6116720">+</span>&nbsp;<span class="ident" id="6116722">x0</span>&nbsp;<span class="op" id="6116725">-</span>&nbsp;<span class="ident" id="6116727">r</span><span class="op" id="6116728">.</span><span class="ident" id="6116729">Min</span><span class="op" id="6116732">.</span><span class="ident" id="6116733">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116736">sx1</span>&nbsp;<span class="op" id="6116740">:=</span>&nbsp;<span class="ident" id="6116743">sx0</span>&nbsp;<span class="op" id="6116747">+</span>&nbsp;<span class="op" id="6116749">(</span><span class="ident" id="6116750">x1</span>&nbsp;<span class="op" id="6116753">-</span>&nbsp;<span class="ident" id="6116755">x0</span><span class="op" id="6116757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116760">i0</span>&nbsp;<span class="op" id="6116763">:=</span>&nbsp;<span class="ident" id="6116766">dst</span><span class="op" id="6116769">.</span><span class="ident" id="6116770">PixOffset</span><span class="op" id="6116779">(</span><span class="ident" id="6116780">x0</span><span class="op" id="6116782">,</span>&nbsp;<span class="ident" id="6116784">y0</span><span class="op" id="6116786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116789">di</span>&nbsp;<span class="op" id="6116792">:=</span>&nbsp;<span class="ident" id="6116795">dx</span>&nbsp;<span class="op" id="6116798">*</span>&nbsp;<span class="num" id="6116800">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116803">for</span>&nbsp;<span class="ident" id="6116807">y</span>&nbsp;<span class="op" id="6116809">:=</span>&nbsp;<span class="ident" id="6116812">y0</span><span class="op" id="6116814">;</span>&nbsp;<span class="ident" id="6116816">y</span>&nbsp;<span class="op" id="6116818">!=</span>&nbsp;<span class="ident" id="6116821">y1</span><span class="op" id="6116823">;</span>&nbsp;<span class="ident" id="6116825">y</span><span class="op" id="6116826">,</span>&nbsp;<span class="ident" id="6116828">sy</span><span class="op" id="6116830">,</span>&nbsp;<span class="ident" id="6116832">my</span>&nbsp;<span class="op" id="6116835">=</span>&nbsp;<span class="ident" id="6116837">y</span><span class="op" id="6116838">+</span><span class="ident" id="6116839">dy</span><span class="op" id="6116841">,</span>&nbsp;<span class="ident" id="6116843">sy</span><span class="op" id="6116845">+</span><span class="ident" id="6116846">dy</span><span class="op" id="6116848">,</span>&nbsp;<span class="ident" id="6116850">my</span><span class="op" id="6116852">+</span><span class="ident" id="6116853">dy</span>&nbsp;<span class="op" id="6116856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116860">for</span>&nbsp;<span class="ident" id="6116864">i</span><span class="op" id="6116865">,</span>&nbsp;<span class="ident" id="6116867">sx</span><span class="op" id="6116869">,</span>&nbsp;<span class="ident" id="6116871">mx</span>&nbsp;<span class="op" id="6116874">:=</span>&nbsp;<span class="ident" id="6116877">i0</span><span class="op" id="6116879">,</span>&nbsp;<span class="ident" id="6116881">sx0</span><span class="op" id="6116884">,</span>&nbsp;<span class="ident" id="6116886">mx0</span><span class="op" id="6116889">;</span>&nbsp;<span class="ident" id="6116891">sx</span>&nbsp;<span class="op" id="6116894">!=</span>&nbsp;<span class="ident" id="6116897">sx1</span><span class="op" id="6116900">;</span>&nbsp;<span class="ident" id="6116902">i</span><span class="op" id="6116903">,</span>&nbsp;<span class="ident" id="6116905">sx</span><span class="op" id="6116907">,</span>&nbsp;<span class="ident" id="6116909">mx</span>&nbsp;<span class="op" id="6116912">=</span>&nbsp;<span class="ident" id="6116914">i</span><span class="op" id="6116915">+</span><span class="ident" id="6116916">di</span><span class="op" id="6116918">,</span>&nbsp;<span class="ident" id="6116920">sx</span><span class="op" id="6116922">+</span><span class="ident" id="6116923">dx</span><span class="op" id="6116925">,</span>&nbsp;<span class="ident" id="6116927">mx</span><span class="op" id="6116929">+</span><span class="ident" id="6116930">dx</span>&nbsp;<span class="op" id="6116933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116938">ma</span>&nbsp;<span class="op" id="6116941">:=</span>&nbsp;<span class="builtintype" id="6116944">uint32</span><span class="op" id="6116950">(</span><span class="ident" id="6116951">m</span><span class="op" id="6116952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116957">if</span>&nbsp;<span class="ident" id="6116960">mask</span>&nbsp;<span class="op" id="6116965">!=</span>&nbsp;<span class="builtintype" id="6116968">nil</span>&nbsp;<span class="op" id="6116972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116978">_</span><span class="op" id="6116979">,</span>&nbsp;<span class="ident" id="6116981">_</span><span class="op" id="6116982">,</span>&nbsp;<span class="ident" id="6116984">_</span><span class="op" id="6116985">,</span>&nbsp;<span class="ident" id="6116987">ma</span>&nbsp;<span class="op" id="6116990">=</span>&nbsp;<span class="ident" id="6116992">mask</span><span class="op" id="6116996">.</span><span class="ident" id="6116997">At</span><span class="op" id="6116999">(</span><span class="ident" id="6117000">mx</span><span class="op" id="6117002">,</span>&nbsp;<span class="ident" id="6117004">my</span><span class="op" id="6117006">)</span><span class="op" id="6117007">.</span><span class="ident" id="6117008">RGBA</span><span class="op" id="6117012">(</span><span class="op" id="6117013">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117023">sr</span><span class="op" id="6117025">,</span>&nbsp;<span class="ident" id="6117027">sg</span><span class="op" id="6117029">,</span>&nbsp;<span class="ident" id="6117031">sb</span><span class="op" id="6117033">,</span>&nbsp;<span class="ident" id="6117035">sa</span>&nbsp;<span class="op" id="6117038">:=</span>&nbsp;<span class="ident" id="6117041">src</span><span class="op" id="6117044">.</span><span class="ident" id="6117045">At</span><span class="op" id="6117047">(</span><span class="ident" id="6117048">sx</span><span class="op" id="6117050">,</span>&nbsp;<span class="ident" id="6117052">sy</span><span class="op" id="6117054">)</span><span class="op" id="6117055">.</span><span class="ident" id="6117056">RGBA</span><span class="op" id="6117060">(</span><span class="op" id="6117061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117066">if</span>&nbsp;<span class="ident" id="6117069">op</span>&nbsp;<span class="op" id="6117072">==</span>&nbsp;<span class="ident" id="6117075">Over</span>&nbsp;<span class="op" id="6117080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117086">dr</span>&nbsp;<span class="op" id="6117089">:=</span>&nbsp;<span class="builtintype" id="6117092">uint32</span><span class="op" id="6117098">(</span><span class="ident" id="6117099">dst</span><span class="op" id="6117102">.</span><span class="ident" id="6117103">Pix</span><span class="op" id="6117106">[</span><span class="ident" id="6117107">i</span><span class="op" id="6117108">+</span><span class="num" id="6117109">0</span><span class="op" id="6117110">]</span><span class="op" id="6117111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117117">dg</span>&nbsp;<span class="op" id="6117120">:=</span>&nbsp;<span class="builtintype" id="6117123">uint32</span><span class="op" id="6117129">(</span><span class="ident" id="6117130">dst</span><span class="op" id="6117133">.</span><span class="ident" id="6117134">Pix</span><span class="op" id="6117137">[</span><span class="ident" id="6117138">i</span><span class="op" id="6117139">+</span><span class="num" id="6117140">1</span><span class="op" id="6117141">]</span><span class="op" id="6117142">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117148">db</span>&nbsp;<span class="op" id="6117151">:=</span>&nbsp;<span class="builtintype" id="6117154">uint32</span><span class="op" id="6117160">(</span><span class="ident" id="6117161">dst</span><span class="op" id="6117164">.</span><span class="ident" id="6117165">Pix</span><span class="op" id="6117168">[</span><span class="ident" id="6117169">i</span><span class="op" id="6117170">+</span><span class="num" id="6117171">2</span><span class="op" id="6117172">]</span><span class="op" id="6117173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117179">da</span>&nbsp;<span class="op" id="6117182">:=</span>&nbsp;<span class="builtintype" id="6117185">uint32</span><span class="op" id="6117191">(</span><span class="ident" id="6117192">dst</span><span class="op" id="6117195">.</span><span class="ident" id="6117196">Pix</span><span class="op" id="6117199">[</span><span class="ident" id="6117200">i</span><span class="op" id="6117201">+</span><span class="num" id="6117202">3</span><span class="op" id="6117203">]</span><span class="op" id="6117204">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117211">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117291">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117349">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117370">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117436">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117501">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117573">a</span>&nbsp;<span class="op" id="6117575">:=</span>&nbsp;<span class="op" id="6117578">(</span><span class="ident" id="6117579">m</span>&nbsp;<span class="op" id="6117581">-</span>&nbsp;<span class="op" id="6117583">(</span><span class="ident" id="6117584">sa</span>&nbsp;<span class="op" id="6117587">*</span>&nbsp;<span class="ident" id="6117589">ma</span>&nbsp;<span class="op" id="6117592">/</span>&nbsp;<span class="ident" id="6117594">m</span><span class="op" id="6117595">)</span><span class="op" id="6117596">)</span>&nbsp;<span class="op" id="6117598">*</span>&nbsp;<span class="num" id="6117600">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117611">dst</span><span class="op" id="6117614">.</span><span class="ident" id="6117615">Pix</span><span class="op" id="6117618">[</span><span class="ident" id="6117619">i</span><span class="op" id="6117620">+</span><span class="num" id="6117621">0</span><span class="op" id="6117622">]</span>&nbsp;<span class="op" id="6117624">=</span>&nbsp;<span class="builtintype" id="6117626">uint8</span><span class="op" id="6117631">(</span><span class="op" id="6117632">(</span><span class="ident" id="6117633">dr</span><span class="op" id="6117635">*</span><span class="ident" id="6117636">a</span>&nbsp;<span class="op" id="6117638">+</span>&nbsp;<span class="ident" id="6117640">sr</span><span class="op" id="6117642">*</span><span class="ident" id="6117643">ma</span><span class="op" id="6117645">)</span>&nbsp;<span class="op" id="6117647">/</span>&nbsp;<span class="ident" id="6117649">m</span>&nbsp;<span class="op" id="6117651">&gt;&gt;</span>&nbsp;<span class="num" id="6117654">8</span><span class="op" id="6117655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117661">dst</span><span class="op" id="6117664">.</span><span class="ident" id="6117665">Pix</span><span class="op" id="6117668">[</span><span class="ident" id="6117669">i</span><span class="op" id="6117670">+</span><span class="num" id="6117671">1</span><span class="op" id="6117672">]</span>&nbsp;<span class="op" id="6117674">=</span>&nbsp;<span class="builtintype" id="6117676">uint8</span><span class="op" id="6117681">(</span><span class="op" id="6117682">(</span><span class="ident" id="6117683">dg</span><span class="op" id="6117685">*</span><span class="ident" id="6117686">a</span>&nbsp;<span class="op" id="6117688">+</span>&nbsp;<span class="ident" id="6117690">sg</span><span class="op" id="6117692">*</span><span class="ident" id="6117693">ma</span><span class="op" id="6117695">)</span>&nbsp;<span class="op" id="6117697">/</span>&nbsp;<span class="ident" id="6117699">m</span>&nbsp;<span class="op" id="6117701">&gt;&gt;</span>&nbsp;<span class="num" id="6117704">8</span><span class="op" id="6117705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117711">dst</span><span class="op" id="6117714">.</span><span class="ident" id="6117715">Pix</span><span class="op" id="6117718">[</span><span class="ident" id="6117719">i</span><span class="op" id="6117720">+</span><span class="num" id="6117721">2</span><span class="op" id="6117722">]</span>&nbsp;<span class="op" id="6117724">=</span>&nbsp;<span class="builtintype" id="6117726">uint8</span><span class="op" id="6117731">(</span><span class="op" id="6117732">(</span><span class="ident" id="6117733">db</span><span class="op" id="6117735">*</span><span class="ident" id="6117736">a</span>&nbsp;<span class="op" id="6117738">+</span>&nbsp;<span class="ident" id="6117740">sb</span><span class="op" id="6117742">*</span><span class="ident" id="6117743">ma</span><span class="op" id="6117745">)</span>&nbsp;<span class="op" id="6117747">/</span>&nbsp;<span class="ident" id="6117749">m</span>&nbsp;<span class="op" id="6117751">&gt;&gt;</span>&nbsp;<span class="num" id="6117754">8</span><span class="op" id="6117755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117761">dst</span><span class="op" id="6117764">.</span><span class="ident" id="6117765">Pix</span><span class="op" id="6117768">[</span><span class="ident" id="6117769">i</span><span class="op" id="6117770">+</span><span class="num" id="6117771">3</span><span class="op" id="6117772">]</span>&nbsp;<span class="op" id="6117774">=</span>&nbsp;<span class="builtintype" id="6117776">uint8</span><span class="op" id="6117781">(</span><span class="op" id="6117782">(</span><span class="ident" id="6117783">da</span><span class="op" id="6117785">*</span><span class="ident" id="6117786">a</span>&nbsp;<span class="op" id="6117788">+</span>&nbsp;<span class="ident" id="6117790">sa</span><span class="op" id="6117792">*</span><span class="ident" id="6117793">ma</span><span class="op" id="6117795">)</span>&nbsp;<span class="op" id="6117797">/</span>&nbsp;<span class="ident" id="6117799">m</span>&nbsp;<span class="op" id="6117801">&gt;&gt;</span>&nbsp;<span class="num" id="6117804">8</span><span class="op" id="6117805">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117811">}</span>&nbsp;<span class="keyword" id="6117813">else</span>&nbsp;<span class="op" id="6117818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117824">dst</span><span class="op" id="6117827">.</span><span class="ident" id="6117828">Pix</span><span class="op" id="6117831">[</span><span class="ident" id="6117832">i</span><span class="op" id="6117833">+</span><span class="num" id="6117834">0</span><span class="op" id="6117835">]</span>&nbsp;<span class="op" id="6117837">=</span>&nbsp;<span class="builtintype" id="6117839">uint8</span><span class="op" id="6117844">(</span><span class="ident" id="6117845">sr</span>&nbsp;<span class="op" id="6117848">*</span>&nbsp;<span class="ident" id="6117850">ma</span>&nbsp;<span class="op" id="6117853">/</span>&nbsp;<span class="ident" id="6117855">m</span>&nbsp;<span class="op" id="6117857">&gt;&gt;</span>&nbsp;<span class="num" id="6117860">8</span><span class="op" id="6117861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117867">dst</span><span class="op" id="6117870">.</span><span class="ident" id="6117871">Pix</span><span class="op" id="6117874">[</span><span class="ident" id="6117875">i</span><span class="op" id="6117876">+</span><span class="num" id="6117877">1</span><span class="op" id="6117878">]</span>&nbsp;<span class="op" id="6117880">=</span>&nbsp;<span class="builtintype" id="6117882">uint8</span><span class="op" id="6117887">(</span><span class="ident" id="6117888">sg</span>&nbsp;<span class="op" id="6117891">*</span>&nbsp;<span class="ident" id="6117893">ma</span>&nbsp;<span class="op" id="6117896">/</span>&nbsp;<span class="ident" id="6117898">m</span>&nbsp;<span class="op" id="6117900">&gt;&gt;</span>&nbsp;<span class="num" id="6117903">8</span><span class="op" id="6117904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117910">dst</span><span class="op" id="6117913">.</span><span class="ident" id="6117914">Pix</span><span class="op" id="6117917">[</span><span class="ident" id="6117918">i</span><span class="op" id="6117919">+</span><span class="num" id="6117920">2</span><span class="op" id="6117921">]</span>&nbsp;<span class="op" id="6117923">=</span>&nbsp;<span class="builtintype" id="6117925">uint8</span><span class="op" id="6117930">(</span><span class="ident" id="6117931">sb</span>&nbsp;<span class="op" id="6117934">*</span>&nbsp;<span class="ident" id="6117936">ma</span>&nbsp;<span class="op" id="6117939">/</span>&nbsp;<span class="ident" id="6117941">m</span>&nbsp;<span class="op" id="6117943">&gt;&gt;</span>&nbsp;<span class="num" id="6117946">8</span><span class="op" id="6117947">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117953">dst</span><span class="op" id="6117956">.</span><span class="ident" id="6117957">Pix</span><span class="op" id="6117960">[</span><span class="ident" id="6117961">i</span><span class="op" id="6117962">+</span><span class="num" id="6117963">3</span><span class="op" id="6117964">]</span>&nbsp;<span class="op" id="6117966">=</span>&nbsp;<span class="builtintype" id="6117968">uint8</span><span class="op" id="6117973">(</span><span class="ident" id="6117974">sa</span>&nbsp;<span class="op" id="6117977">*</span>&nbsp;<span class="ident" id="6117979">ma</span>&nbsp;<span class="op" id="6117982">/</span>&nbsp;<span class="ident" id="6117984">m</span>&nbsp;<span class="op" id="6117986">&gt;&gt;</span>&nbsp;<span class="num" id="6117989">8</span><span class="op" id="6117990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118003">i0</span>&nbsp;<span class="op" id="6118006">+=</span>&nbsp;<span class="ident" id="6118009">dy</span>&nbsp;<span class="op" id="6118012">*</span>&nbsp;<span class="ident" id="6118014">dst</span><span class="op" id="6118017">.</span><span class="ident" id="6118018">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6118026">}</span><br>
<span class="lineno">545</span><span class="op" id="6118028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6118031">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="6118078">func</span>&nbsp;<span class="ident" id="6118083">clamp</span><span class="op" id="6118088">(</span><span class="ident" id="6118089">i</span>&nbsp;<span class="builtintype" id="6118091">int32</span><span class="op" id="6118096">)</span>&nbsp;<span class="builtintype" id="6118098">int32</span>&nbsp;<span class="op" id="6118104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118107">if</span>&nbsp;<span class="ident" id="6118110">i</span>&nbsp;<span class="op" id="6118112">&lt;</span>&nbsp;<span class="num" id="6118114">0</span>&nbsp;<span class="op" id="6118116">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118120">return</span>&nbsp;<span class="num" id="6118127">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6118130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118133">if</span>&nbsp;<span class="ident" id="6118136">i</span>&nbsp;<span class="op" id="6118138">&gt;</span>&nbsp;<span class="num" id="6118140">0xffff</span>&nbsp;<span class="op" id="6118147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118151">return</span>&nbsp;<span class="num" id="6118158">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6118166">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118169">return</span>&nbsp;<span class="ident" id="6118176">i</span><br>
<span class="lineno"></span><span class="op" id="6118178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6118181">func</span>&nbsp;<span class="ident" id="6118186">drawPaletted</span><span class="op" id="6118198">(</span><span class="ident" id="6118199">dst</span>&nbsp;<span class="ident" id="6118203">Image</span><span class="op" id="6118208">,</span>&nbsp;<span class="ident" id="6118210">r</span>&nbsp;<span class="ident" id="6118212">image</span><span class="op" id="6118217">.</span><span class="ident" id="6118218">Rectangle</span><span class="op" id="6118227">,</span>&nbsp;<span class="ident" id="6118229">src</span>&nbsp;<span class="ident" id="6118233">image</span><span class="op" id="6118238">.</span><span class="ident" id="6118239">Image</span><span class="op" id="6118244">,</span>&nbsp;<span class="ident" id="6118246">sp</span>&nbsp;<span class="ident" id="6118249">image</span><span class="op" id="6118254">.</span><span class="ident" id="6118255">Point</span><span class="op" id="6118260">,</span>&nbsp;<span class="ident" id="6118262">floydSteinberg</span>&nbsp;<span class="builtintype" id="6118277">bool</span><span class="op" id="6118281">)</span>&nbsp;<span class="op" id="6118283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118286">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118353">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118418">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118481">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118551">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118622">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6118693">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118739">palette</span><span class="op" id="6118746">,</span>&nbsp;<span class="ident" id="6118748">pix</span><span class="op" id="6118751">,</span>&nbsp;<span class="ident" id="6118753">stride</span>&nbsp;<span class="op" id="6118760">:=</span>&nbsp;<span class="op" id="6118763">[</span><span class="op" id="6118764">]</span><span class="op" id="6118765">[</span><span class="num" id="6118766">3</span><span class="op" id="6118767">]</span><span class="builtintype" id="6118768">int32</span><span class="op" id="6118773">(</span><span class="builtintype" id="6118774">nil</span><span class="op" id="6118777">)</span><span class="op" id="6118778">,</span>&nbsp;<span class="op" id="6118780">[</span><span class="op" id="6118781">]</span><span class="builtintype" id="6118782">byte</span><span class="op" id="6118786">(</span><span class="builtintype" id="6118787">nil</span><span class="op" id="6118790">)</span><span class="op" id="6118791">,</span>&nbsp;<span class="num" id="6118793">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118796">if</span>&nbsp;<span class="ident" id="6118799">p</span><span class="op" id="6118800">,</span>&nbsp;<span class="ident" id="6118802">ok</span>&nbsp;<span class="op" id="6118805">:=</span>&nbsp;<span class="ident" id="6118808">dst</span><span class="op" id="6118811">.</span><span class="op" id="6118812">(</span><span class="op" id="6118813">*</span><span class="ident" id="6118814">image</span><span class="op" id="6118819">.</span><span class="ident" id="6118820">Paletted</span><span class="op" id="6118828">)</span><span class="op" id="6118829">;</span>&nbsp;<span class="ident" id="6118831">ok</span>&nbsp;<span class="op" id="6118834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118838">palette</span>&nbsp;<span class="op" id="6118846">=</span>&nbsp;<span class="builtinfunc" id="6118848">make</span><span class="op" id="6118852">(</span><span class="op" id="6118853">[</span><span class="op" id="6118854">]</span><span class="op" id="6118855">[</span><span class="num" id="6118856">3</span><span class="op" id="6118857">]</span><span class="builtintype" id="6118858">int32</span><span class="op" id="6118863">,</span>&nbsp;<span class="builtinfunc" id="6118865">len</span><span class="op" id="6118868">(</span><span class="ident" id="6118869">p</span><span class="op" id="6118870">.</span><span class="ident" id="6118871">Palette</span><span class="op" id="6118878">)</span><span class="op" id="6118879">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118883">for</span>&nbsp;<span class="ident" id="6118887">i</span><span class="op" id="6118888">,</span>&nbsp;<span class="ident" id="6118890">col</span>&nbsp;<span class="op" id="6118894">:=</span>&nbsp;<span class="keyword" id="6118897">range</span>&nbsp;<span class="ident" id="6118903">p</span><span class="op" id="6118904">.</span><span class="ident" id="6118905">Palette</span>&nbsp;<span class="op" id="6118913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118918">r</span><span class="op" id="6118919">,</span>&nbsp;<span class="ident" id="6118921">g</span><span class="op" id="6118922">,</span>&nbsp;<span class="ident" id="6118924">b</span><span class="op" id="6118925">,</span>&nbsp;<span class="ident" id="6118927">_</span>&nbsp;<span class="op" id="6118929">:=</span>&nbsp;<span class="ident" id="6118932">col</span><span class="op" id="6118935">.</span><span class="ident" id="6118936">RGBA</span><span class="op" id="6118940">(</span><span class="op" id="6118941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118946">palette</span><span class="op" id="6118953">[</span><span class="ident" id="6118954">i</span><span class="op" id="6118955">]</span><span class="op" id="6118956">[</span><span class="num" id="6118957">0</span><span class="op" id="6118958">]</span>&nbsp;<span class="op" id="6118960">=</span>&nbsp;<span class="builtintype" id="6118962">int32</span><span class="op" id="6118967">(</span><span class="ident" id="6118968">r</span><span class="op" id="6118969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118974">palette</span><span class="op" id="6118981">[</span><span class="ident" id="6118982">i</span><span class="op" id="6118983">]</span><span class="op" id="6118984">[</span><span class="num" id="6118985">1</span><span class="op" id="6118986">]</span>&nbsp;<span class="op" id="6118988">=</span>&nbsp;<span class="builtintype" id="6118990">int32</span><span class="op" id="6118995">(</span><span class="ident" id="6118996">g</span><span class="op" id="6118997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119002">palette</span><span class="op" id="6119009">[</span><span class="ident" id="6119010">i</span><span class="op" id="6119011">]</span><span class="op" id="6119012">[</span><span class="num" id="6119013">2</span><span class="op" id="6119014">]</span>&nbsp;<span class="op" id="6119016">=</span>&nbsp;<span class="builtintype" id="6119018">int32</span><span class="op" id="6119023">(</span><span class="ident" id="6119024">b</span><span class="op" id="6119025">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6119029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119033">pix</span><span class="op" id="6119036">,</span>&nbsp;<span class="ident" id="6119038">stride</span>&nbsp;<span class="op" id="6119045">=</span>&nbsp;<span class="ident" id="6119047">p</span><span class="op" id="6119048">.</span><span class="ident" id="6119049">Pix</span><span class="op" id="6119052">[</span><span class="ident" id="6119053">p</span><span class="op" id="6119054">.</span><span class="ident" id="6119055">PixOffset</span><span class="op" id="6119064">(</span><span class="ident" id="6119065">r</span><span class="op" id="6119066">.</span><span class="ident" id="6119067">Min</span><span class="op" id="6119070">.</span><span class="ident" id="6119071">X</span><span class="op" id="6119072">,</span>&nbsp;<span class="ident" id="6119074">r</span><span class="op" id="6119075">.</span><span class="ident" id="6119076">Min</span><span class="op" id="6119079">.</span><span class="ident" id="6119080">Y</span><span class="op" id="6119081">)</span><span class="op" id="6119082">:</span><span class="op" id="6119083">]</span><span class="op" id="6119084">,</span>&nbsp;<span class="ident" id="6119086">p</span><span class="op" id="6119087">.</span><span class="ident" id="6119088">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6119096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119100">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119175">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119250">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119306">var</span>&nbsp;<span class="ident" id="6119310">quantErrorCurr</span><span class="op" id="6119324">,</span>&nbsp;<span class="ident" id="6119326">quantErrorNext</span>&nbsp;<span class="op" id="6119341">[</span><span class="op" id="6119342">]</span><span class="op" id="6119343">[</span><span class="num" id="6119344">3</span><span class="op" id="6119345">]</span><span class="builtintype" id="6119346">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119353">if</span>&nbsp;<span class="ident" id="6119356">floydSteinberg</span>&nbsp;<span class="op" id="6119371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119375">quantErrorCurr</span>&nbsp;<span class="op" id="6119390">=</span>&nbsp;<span class="builtinfunc" id="6119392">make</span><span class="op" id="6119396">(</span><span class="op" id="6119397">[</span><span class="op" id="6119398">]</span><span class="op" id="6119399">[</span><span class="num" id="6119400">3</span><span class="op" id="6119401">]</span><span class="builtintype" id="6119402">int32</span><span class="op" id="6119407">,</span>&nbsp;<span class="ident" id="6119409">r</span><span class="op" id="6119410">.</span><span class="ident" id="6119411">Dx</span><span class="op" id="6119413">(</span><span class="op" id="6119414">)</span><span class="op" id="6119415">+</span><span class="num" id="6119416">2</span><span class="op" id="6119417">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119421">quantErrorNext</span>&nbsp;<span class="op" id="6119436">=</span>&nbsp;<span class="builtinfunc" id="6119438">make</span><span class="op" id="6119442">(</span><span class="op" id="6119443">[</span><span class="op" id="6119444">]</span><span class="op" id="6119445">[</span><span class="num" id="6119446">3</span><span class="op" id="6119447">]</span><span class="builtintype" id="6119448">int32</span><span class="op" id="6119453">,</span>&nbsp;<span class="ident" id="6119455">r</span><span class="op" id="6119456">.</span><span class="ident" id="6119457">Dx</span><span class="op" id="6119459">(</span><span class="op" id="6119460">)</span><span class="op" id="6119461">+</span><span class="num" id="6119462">2</span><span class="op" id="6119463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6119466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119470">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119503">out</span>&nbsp;<span class="op" id="6119507">:=</span>&nbsp;<span class="ident" id="6119510">color</span><span class="op" id="6119515">.</span><span class="ident" id="6119516">RGBA64</span><span class="op" id="6119522">{</span><span class="ident" id="6119523">A</span><span class="op" id="6119524">:</span>&nbsp;<span class="num" id="6119526">0xffff</span><span class="op" id="6119532">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119535">for</span>&nbsp;<span class="ident" id="6119539">y</span>&nbsp;<span class="op" id="6119541">:=</span>&nbsp;<span class="num" id="6119544">0</span><span class="op" id="6119545">;</span>&nbsp;<span class="ident" id="6119547">y</span>&nbsp;<span class="op" id="6119549">!=</span>&nbsp;<span class="ident" id="6119552">r</span><span class="op" id="6119553">.</span><span class="ident" id="6119554">Dy</span><span class="op" id="6119556">(</span><span class="op" id="6119557">)</span><span class="op" id="6119558">;</span>&nbsp;<span class="ident" id="6119560">y</span><span class="op" id="6119561">++</span>&nbsp;<span class="op" id="6119564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119568">for</span>&nbsp;<span class="ident" id="6119572">x</span>&nbsp;<span class="op" id="6119574">:=</span>&nbsp;<span class="num" id="6119577">0</span><span class="op" id="6119578">;</span>&nbsp;<span class="ident" id="6119580">x</span>&nbsp;<span class="op" id="6119582">!=</span>&nbsp;<span class="ident" id="6119585">r</span><span class="op" id="6119586">.</span><span class="ident" id="6119587">Dx</span><span class="op" id="6119589">(</span><span class="op" id="6119590">)</span><span class="op" id="6119591">;</span>&nbsp;<span class="ident" id="6119593">x</span><span class="op" id="6119594">++</span>&nbsp;<span class="op" id="6119597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119602">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119660">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119698">sr</span><span class="op" id="6119700">,</span>&nbsp;<span class="ident" id="6119702">sg</span><span class="op" id="6119704">,</span>&nbsp;<span class="ident" id="6119706">sb</span><span class="op" id="6119708">,</span>&nbsp;<span class="ident" id="6119710">_</span>&nbsp;<span class="op" id="6119712">:=</span>&nbsp;<span class="ident" id="6119715">src</span><span class="op" id="6119718">.</span><span class="ident" id="6119719">At</span><span class="op" id="6119721">(</span><span class="ident" id="6119722">sp</span><span class="op" id="6119724">.</span><span class="ident" id="6119725">X</span><span class="op" id="6119726">+</span><span class="ident" id="6119727">x</span><span class="op" id="6119728">,</span>&nbsp;<span class="ident" id="6119730">sp</span><span class="op" id="6119732">.</span><span class="ident" id="6119733">Y</span><span class="op" id="6119734">+</span><span class="ident" id="6119735">y</span><span class="op" id="6119736">)</span><span class="op" id="6119737">.</span><span class="ident" id="6119738">RGBA</span><span class="op" id="6119742">(</span><span class="op" id="6119743">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119748">er</span><span class="op" id="6119750">,</span>&nbsp;<span class="ident" id="6119752">eg</span><span class="op" id="6119754">,</span>&nbsp;<span class="ident" id="6119756">eb</span>&nbsp;<span class="op" id="6119759">:=</span>&nbsp;<span class="builtintype" id="6119762">int32</span><span class="op" id="6119767">(</span><span class="ident" id="6119768">sr</span><span class="op" id="6119770">)</span><span class="op" id="6119771">,</span>&nbsp;<span class="builtintype" id="6119773">int32</span><span class="op" id="6119778">(</span><span class="ident" id="6119779">sg</span><span class="op" id="6119781">)</span><span class="op" id="6119782">,</span>&nbsp;<span class="builtintype" id="6119784">int32</span><span class="op" id="6119789">(</span><span class="ident" id="6119790">sb</span><span class="op" id="6119792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119797">if</span>&nbsp;<span class="ident" id="6119800">floydSteinberg</span>&nbsp;<span class="op" id="6119815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119821">er</span>&nbsp;<span class="op" id="6119824">=</span>&nbsp;<span class="ident" id="6119826">clamp</span><span class="op" id="6119831">(</span><span class="ident" id="6119832">er</span>&nbsp;<span class="op" id="6119835">+</span>&nbsp;<span class="ident" id="6119837">quantErrorCurr</span><span class="op" id="6119851">[</span><span class="ident" id="6119852">x</span><span class="op" id="6119853">+</span><span class="num" id="6119854">1</span><span class="op" id="6119855">]</span><span class="op" id="6119856">[</span><span class="num" id="6119857">0</span><span class="op" id="6119858">]</span><span class="op" id="6119859">/</span><span class="num" id="6119860">16</span><span class="op" id="6119862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119868">eg</span>&nbsp;<span class="op" id="6119871">=</span>&nbsp;<span class="ident" id="6119873">clamp</span><span class="op" id="6119878">(</span><span class="ident" id="6119879">eg</span>&nbsp;<span class="op" id="6119882">+</span>&nbsp;<span class="ident" id="6119884">quantErrorCurr</span><span class="op" id="6119898">[</span><span class="ident" id="6119899">x</span><span class="op" id="6119900">+</span><span class="num" id="6119901">1</span><span class="op" id="6119902">]</span><span class="op" id="6119903">[</span><span class="num" id="6119904">1</span><span class="op" id="6119905">]</span><span class="op" id="6119906">/</span><span class="num" id="6119907">16</span><span class="op" id="6119909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6119915">eb</span>&nbsp;<span class="op" id="6119918">=</span>&nbsp;<span class="ident" id="6119920">clamp</span><span class="op" id="6119925">(</span><span class="ident" id="6119926">eb</span>&nbsp;<span class="op" id="6119929">+</span>&nbsp;<span class="ident" id="6119931">quantErrorCurr</span><span class="op" id="6119945">[</span><span class="ident" id="6119946">x</span><span class="op" id="6119947">+</span><span class="num" id="6119948">1</span><span class="op" id="6119949">]</span><span class="op" id="6119950">[</span><span class="num" id="6119951">2</span><span class="op" id="6119952">]</span><span class="op" id="6119953">/</span><span class="num" id="6119954">16</span><span class="op" id="6119956">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6119961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6119967">if</span>&nbsp;<span class="ident" id="6119970">palette</span>&nbsp;<span class="op" id="6119978">!=</span>&nbsp;<span class="builtintype" id="6119981">nil</span>&nbsp;<span class="op" id="6119985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6119991">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6120059">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6120127">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6120196">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120248">bestIndex</span><span class="op" id="6120257">,</span>&nbsp;<span class="ident" id="6120259">bestSSD</span>&nbsp;<span class="op" id="6120267">:=</span>&nbsp;<span class="num" id="6120270">0</span><span class="op" id="6120271">,</span>&nbsp;<span class="builtintype" id="6120273">uint32</span><span class="op" id="6120279">(</span><span class="num" id="6120280">1</span><span class="op" id="6120281">&lt;&lt;</span><span class="num" id="6120283">32</span><span class="op" id="6120285">-</span><span class="num" id="6120286">1</span><span class="op" id="6120287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120293">for</span>&nbsp;<span class="ident" id="6120297">index</span><span class="op" id="6120302">,</span>&nbsp;<span class="ident" id="6120304">p</span>&nbsp;<span class="op" id="6120306">:=</span>&nbsp;<span class="keyword" id="6120309">range</span>&nbsp;<span class="ident" id="6120315">palette</span>&nbsp;<span class="op" id="6120323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120330">delta</span>&nbsp;<span class="op" id="6120336">:=</span>&nbsp;<span class="op" id="6120339">(</span><span class="ident" id="6120340">er</span>&nbsp;<span class="op" id="6120343">-</span>&nbsp;<span class="ident" id="6120345">p</span><span class="op" id="6120346">[</span><span class="num" id="6120347">0</span><span class="op" id="6120348">]</span><span class="op" id="6120349">)</span>&nbsp;<span class="op" id="6120351">&gt;&gt;</span>&nbsp;<span class="num" id="6120354">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120361">ssd</span>&nbsp;<span class="op" id="6120365">:=</span>&nbsp;<span class="builtintype" id="6120368">uint32</span><span class="op" id="6120374">(</span><span class="ident" id="6120375">delta</span>&nbsp;<span class="op" id="6120381">*</span>&nbsp;<span class="ident" id="6120383">delta</span><span class="op" id="6120388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120395">delta</span>&nbsp;<span class="op" id="6120401">=</span>&nbsp;<span class="op" id="6120403">(</span><span class="ident" id="6120404">eg</span>&nbsp;<span class="op" id="6120407">-</span>&nbsp;<span class="ident" id="6120409">p</span><span class="op" id="6120410">[</span><span class="num" id="6120411">1</span><span class="op" id="6120412">]</span><span class="op" id="6120413">)</span>&nbsp;<span class="op" id="6120415">&gt;&gt;</span>&nbsp;<span class="num" id="6120418">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120425">ssd</span>&nbsp;<span class="op" id="6120429">+=</span>&nbsp;<span class="builtintype" id="6120432">uint32</span><span class="op" id="6120438">(</span><span class="ident" id="6120439">delta</span>&nbsp;<span class="op" id="6120445">*</span>&nbsp;<span class="ident" id="6120447">delta</span><span class="op" id="6120452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120459">delta</span>&nbsp;<span class="op" id="6120465">=</span>&nbsp;<span class="op" id="6120467">(</span><span class="ident" id="6120468">eb</span>&nbsp;<span class="op" id="6120471">-</span>&nbsp;<span class="ident" id="6120473">p</span><span class="op" id="6120474">[</span><span class="num" id="6120475">2</span><span class="op" id="6120476">]</span><span class="op" id="6120477">)</span>&nbsp;<span class="op" id="6120479">&gt;&gt;</span>&nbsp;<span class="num" id="6120482">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120489">ssd</span>&nbsp;<span class="op" id="6120493">+=</span>&nbsp;<span class="builtintype" id="6120496">uint32</span><span class="op" id="6120502">(</span><span class="ident" id="6120503">delta</span>&nbsp;<span class="op" id="6120509">*</span>&nbsp;<span class="ident" id="6120511">delta</span><span class="op" id="6120516">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120523">if</span>&nbsp;<span class="ident" id="6120526">ssd</span>&nbsp;<span class="op" id="6120530">&lt;</span>&nbsp;<span class="ident" id="6120532">bestSSD</span>&nbsp;<span class="op" id="6120540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120548">bestIndex</span><span class="op" id="6120557">,</span>&nbsp;<span class="ident" id="6120559">bestSSD</span>&nbsp;<span class="op" id="6120567">=</span>&nbsp;<span class="ident" id="6120569">index</span><span class="op" id="6120574">,</span>&nbsp;<span class="ident" id="6120576">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120586">if</span>&nbsp;<span class="ident" id="6120589">ssd</span>&nbsp;<span class="op" id="6120593">==</span>&nbsp;<span class="num" id="6120596">0</span>&nbsp;<span class="op" id="6120598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120607">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120619">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120638">pix</span><span class="op" id="6120641">[</span><span class="ident" id="6120642">y</span><span class="op" id="6120643">*</span><span class="ident" id="6120644">stride</span><span class="op" id="6120650">+</span><span class="ident" id="6120651">x</span><span class="op" id="6120652">]</span>&nbsp;<span class="op" id="6120654">=</span>&nbsp;<span class="builtintype" id="6120656">byte</span><span class="op" id="6120660">(</span><span class="ident" id="6120661">bestIndex</span><span class="op" id="6120670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120677">if</span>&nbsp;<span class="op" id="6120680">!</span><span class="ident" id="6120681">floydSteinberg</span>&nbsp;<span class="op" id="6120696">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6120703">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120722">er</span>&nbsp;<span class="op" id="6120725">-=</span>&nbsp;<span class="builtintype" id="6120728">int32</span><span class="op" id="6120733">(</span><span class="ident" id="6120734">palette</span><span class="op" id="6120741">[</span><span class="ident" id="6120742">bestIndex</span><span class="op" id="6120751">]</span><span class="op" id="6120752">[</span><span class="num" id="6120753">0</span><span class="op" id="6120754">]</span><span class="op" id="6120755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120761">eg</span>&nbsp;<span class="op" id="6120764">-=</span>&nbsp;<span class="builtintype" id="6120767">int32</span><span class="op" id="6120772">(</span><span class="ident" id="6120773">palette</span><span class="op" id="6120780">[</span><span class="ident" id="6120781">bestIndex</span><span class="op" id="6120790">]</span><span class="op" id="6120791">[</span><span class="num" id="6120792">1</span><span class="op" id="6120793">]</span><span class="op" id="6120794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120800">eb</span>&nbsp;<span class="op" id="6120803">-=</span>&nbsp;<span class="builtintype" id="6120806">int32</span><span class="op" id="6120811">(</span><span class="ident" id="6120812">palette</span><span class="op" id="6120819">[</span><span class="ident" id="6120820">bestIndex</span><span class="op" id="6120829">]</span><span class="op" id="6120830">[</span><span class="num" id="6120831">2</span><span class="op" id="6120832">]</span><span class="op" id="6120833">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6120839">}</span>&nbsp;<span class="keyword" id="6120841">else</span>&nbsp;<span class="op" id="6120846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120852">out</span><span class="op" id="6120855">.</span><span class="ident" id="6120856">R</span>&nbsp;<span class="op" id="6120858">=</span>&nbsp;<span class="builtintype" id="6120860">uint16</span><span class="op" id="6120866">(</span><span class="ident" id="6120867">er</span><span class="op" id="6120869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120875">out</span><span class="op" id="6120878">.</span><span class="ident" id="6120879">G</span>&nbsp;<span class="op" id="6120881">=</span>&nbsp;<span class="builtintype" id="6120883">uint16</span><span class="op" id="6120889">(</span><span class="ident" id="6120890">eg</span><span class="op" id="6120892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6120898">out</span><span class="op" id="6120901">.</span><span class="ident" id="6120902">B</span>&nbsp;<span class="op" id="6120904">=</span>&nbsp;<span class="builtintype" id="6120906">uint16</span><span class="op" id="6120912">(</span><span class="ident" id="6120913">eb</span><span class="op" id="6120915">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6120921">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6120982">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6121047">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6121110">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121171">dst</span><span class="op" id="6121174">.</span><span class="ident" id="6121175">Set</span><span class="op" id="6121178">(</span><span class="ident" id="6121179">r</span><span class="op" id="6121180">.</span><span class="ident" id="6121181">Min</span><span class="op" id="6121184">.</span><span class="ident" id="6121185">X</span><span class="op" id="6121186">+</span><span class="ident" id="6121187">x</span><span class="op" id="6121188">,</span>&nbsp;<span class="ident" id="6121190">r</span><span class="op" id="6121191">.</span><span class="ident" id="6121192">Min</span><span class="op" id="6121195">.</span><span class="ident" id="6121196">Y</span><span class="op" id="6121197">+</span><span class="ident" id="6121198">y</span><span class="op" id="6121199">,</span>&nbsp;<span class="op" id="6121201">&amp;</span><span class="ident" id="6121202">out</span><span class="op" id="6121205">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121212">if</span>&nbsp;<span class="op" id="6121215">!</span><span class="ident" id="6121216">floydSteinberg</span>&nbsp;<span class="op" id="6121231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121238">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6121251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121257">sr</span><span class="op" id="6121259">,</span>&nbsp;<span class="ident" id="6121261">sg</span><span class="op" id="6121263">,</span>&nbsp;<span class="ident" id="6121265">sb</span><span class="op" id="6121267">,</span>&nbsp;<span class="ident" id="6121269">_</span>&nbsp;<span class="op" id="6121271">=</span>&nbsp;<span class="ident" id="6121273">dst</span><span class="op" id="6121276">.</span><span class="ident" id="6121277">At</span><span class="op" id="6121279">(</span><span class="ident" id="6121280">r</span><span class="op" id="6121281">.</span><span class="ident" id="6121282">Min</span><span class="op" id="6121285">.</span><span class="ident" id="6121286">X</span><span class="op" id="6121287">+</span><span class="ident" id="6121288">x</span><span class="op" id="6121289">,</span>&nbsp;<span class="ident" id="6121291">r</span><span class="op" id="6121292">.</span><span class="ident" id="6121293">Min</span><span class="op" id="6121296">.</span><span class="ident" id="6121297">Y</span><span class="op" id="6121298">+</span><span class="ident" id="6121299">y</span><span class="op" id="6121300">)</span><span class="op" id="6121301">.</span><span class="ident" id="6121302">RGBA</span><span class="op" id="6121306">(</span><span class="op" id="6121307">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121313">er</span>&nbsp;<span class="op" id="6121316">-=</span>&nbsp;<span class="builtintype" id="6121319">int32</span><span class="op" id="6121324">(</span><span class="ident" id="6121325">sr</span><span class="op" id="6121327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121333">eg</span>&nbsp;<span class="op" id="6121336">-=</span>&nbsp;<span class="builtintype" id="6121339">int32</span><span class="op" id="6121344">(</span><span class="ident" id="6121345">sg</span><span class="op" id="6121347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121353">eb</span>&nbsp;<span class="op" id="6121356">-=</span>&nbsp;<span class="builtintype" id="6121359">int32</span><span class="op" id="6121364">(</span><span class="ident" id="6121365">sb</span><span class="op" id="6121367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6121372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6121378">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121434">quantErrorNext</span><span class="op" id="6121448">[</span><span class="ident" id="6121449">x</span><span class="op" id="6121450">+</span><span class="num" id="6121451">0</span><span class="op" id="6121452">]</span><span class="op" id="6121453">[</span><span class="num" id="6121454">0</span><span class="op" id="6121455">]</span>&nbsp;<span class="op" id="6121457">+=</span>&nbsp;<span class="ident" id="6121460">er</span>&nbsp;<span class="op" id="6121463">*</span>&nbsp;<span class="num" id="6121465">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121470">quantErrorNext</span><span class="op" id="6121484">[</span><span class="ident" id="6121485">x</span><span class="op" id="6121486">+</span><span class="num" id="6121487">0</span><span class="op" id="6121488">]</span><span class="op" id="6121489">[</span><span class="num" id="6121490">1</span><span class="op" id="6121491">]</span>&nbsp;<span class="op" id="6121493">+=</span>&nbsp;<span class="ident" id="6121496">eg</span>&nbsp;<span class="op" id="6121499">*</span>&nbsp;<span class="num" id="6121501">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121506">quantErrorNext</span><span class="op" id="6121520">[</span><span class="ident" id="6121521">x</span><span class="op" id="6121522">+</span><span class="num" id="6121523">0</span><span class="op" id="6121524">]</span><span class="op" id="6121525">[</span><span class="num" id="6121526">2</span><span class="op" id="6121527">]</span>&nbsp;<span class="op" id="6121529">+=</span>&nbsp;<span class="ident" id="6121532">eb</span>&nbsp;<span class="op" id="6121535">*</span>&nbsp;<span class="num" id="6121537">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121542">quantErrorNext</span><span class="op" id="6121556">[</span><span class="ident" id="6121557">x</span><span class="op" id="6121558">+</span><span class="num" id="6121559">1</span><span class="op" id="6121560">]</span><span class="op" id="6121561">[</span><span class="num" id="6121562">0</span><span class="op" id="6121563">]</span>&nbsp;<span class="op" id="6121565">+=</span>&nbsp;<span class="ident" id="6121568">er</span>&nbsp;<span class="op" id="6121571">*</span>&nbsp;<span class="num" id="6121573">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121578">quantErrorNext</span><span class="op" id="6121592">[</span><span class="ident" id="6121593">x</span><span class="op" id="6121594">+</span><span class="num" id="6121595">1</span><span class="op" id="6121596">]</span><span class="op" id="6121597">[</span><span class="num" id="6121598">1</span><span class="op" id="6121599">]</span>&nbsp;<span class="op" id="6121601">+=</span>&nbsp;<span class="ident" id="6121604">eg</span>&nbsp;<span class="op" id="6121607">*</span>&nbsp;<span class="num" id="6121609">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121614">quantErrorNext</span><span class="op" id="6121628">[</span><span class="ident" id="6121629">x</span><span class="op" id="6121630">+</span><span class="num" id="6121631">1</span><span class="op" id="6121632">]</span><span class="op" id="6121633">[</span><span class="num" id="6121634">2</span><span class="op" id="6121635">]</span>&nbsp;<span class="op" id="6121637">+=</span>&nbsp;<span class="ident" id="6121640">eb</span>&nbsp;<span class="op" id="6121643">*</span>&nbsp;<span class="num" id="6121645">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121650">quantErrorNext</span><span class="op" id="6121664">[</span><span class="ident" id="6121665">x</span><span class="op" id="6121666">+</span><span class="num" id="6121667">2</span><span class="op" id="6121668">]</span><span class="op" id="6121669">[</span><span class="num" id="6121670">0</span><span class="op" id="6121671">]</span>&nbsp;<span class="op" id="6121673">+=</span>&nbsp;<span class="ident" id="6121676">er</span>&nbsp;<span class="op" id="6121679">*</span>&nbsp;<span class="num" id="6121681">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121686">quantErrorNext</span><span class="op" id="6121700">[</span><span class="ident" id="6121701">x</span><span class="op" id="6121702">+</span><span class="num" id="6121703">2</span><span class="op" id="6121704">]</span><span class="op" id="6121705">[</span><span class="num" id="6121706">1</span><span class="op" id="6121707">]</span>&nbsp;<span class="op" id="6121709">+=</span>&nbsp;<span class="ident" id="6121712">eg</span>&nbsp;<span class="op" id="6121715">*</span>&nbsp;<span class="num" id="6121717">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121722">quantErrorNext</span><span class="op" id="6121736">[</span><span class="ident" id="6121737">x</span><span class="op" id="6121738">+</span><span class="num" id="6121739">2</span><span class="op" id="6121740">]</span><span class="op" id="6121741">[</span><span class="num" id="6121742">2</span><span class="op" id="6121743">]</span>&nbsp;<span class="op" id="6121745">+=</span>&nbsp;<span class="ident" id="6121748">eb</span>&nbsp;<span class="op" id="6121751">*</span>&nbsp;<span class="num" id="6121753">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121758">quantErrorCurr</span><span class="op" id="6121772">[</span><span class="ident" id="6121773">x</span><span class="op" id="6121774">+</span><span class="num" id="6121775">2</span><span class="op" id="6121776">]</span><span class="op" id="6121777">[</span><span class="num" id="6121778">0</span><span class="op" id="6121779">]</span>&nbsp;<span class="op" id="6121781">+=</span>&nbsp;<span class="ident" id="6121784">er</span>&nbsp;<span class="op" id="6121787">*</span>&nbsp;<span class="num" id="6121789">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121794">quantErrorCurr</span><span class="op" id="6121808">[</span><span class="ident" id="6121809">x</span><span class="op" id="6121810">+</span><span class="num" id="6121811">2</span><span class="op" id="6121812">]</span><span class="op" id="6121813">[</span><span class="num" id="6121814">1</span><span class="op" id="6121815">]</span>&nbsp;<span class="op" id="6121817">+=</span>&nbsp;<span class="ident" id="6121820">eg</span>&nbsp;<span class="op" id="6121823">*</span>&nbsp;<span class="num" id="6121825">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121830">quantErrorCurr</span><span class="op" id="6121844">[</span><span class="ident" id="6121845">x</span><span class="op" id="6121846">+</span><span class="num" id="6121847">2</span><span class="op" id="6121848">]</span><span class="op" id="6121849">[</span><span class="num" id="6121850">2</span><span class="op" id="6121851">]</span>&nbsp;<span class="op" id="6121853">+=</span>&nbsp;<span class="ident" id="6121856">eb</span>&nbsp;<span class="op" id="6121859">*</span>&nbsp;<span class="num" id="6121861">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6121865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6121870">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6121915">if</span>&nbsp;<span class="ident" id="6121918">floydSteinberg</span>&nbsp;<span class="op" id="6121933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6121938">quantErrorCurr</span><span class="op" id="6121952">,</span>&nbsp;<span class="ident" id="6121954">quantErrorNext</span>&nbsp;<span class="op" id="6121969">=</span>&nbsp;<span class="ident" id="6121971">quantErrorNext</span><span class="op" id="6121985">,</span>&nbsp;<span class="ident" id="6121987">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6122005">for</span>&nbsp;<span class="ident" id="6122009">i</span>&nbsp;<span class="op" id="6122011">:=</span>&nbsp;<span class="keyword" id="6122014">range</span>&nbsp;<span class="ident" id="6122020">quantErrorNext</span>&nbsp;<span class="op" id="6122035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6122041">quantErrorNext</span><span class="op" id="6122055">[</span><span class="ident" id="6122056">i</span><span class="op" id="6122057">]</span>&nbsp;<span class="op" id="6122059">=</span>&nbsp;<span class="op" id="6122061">[</span><span class="num" id="6122062">3</span><span class="op" id="6122063">]</span><span class="builtintype" id="6122064">int32</span><span class="op" id="6122069">{</span><span class="op" id="6122070">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122082">}</span><br>
<span class="lineno"></span><span class="op" id="6122084">}</span>
</div>
</body>
</html>
