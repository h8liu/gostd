<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3714700">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3714756">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3714810">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3714861">package</span>&nbsp;<span class="ident" id="3714869">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3714874">import</span>&nbsp;<span class="string" id="3714881">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3714889">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3714947">type</span>&nbsp;<span class="ident" id="3714952">call</span>&nbsp;<span class="keyword" id="3714957">struct</span>&nbsp;<span class="op" id="3714964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3714967">wg</span>&nbsp;<span class="ident" id="3714970">sync</span><span class="op" id="3714974">.</span><span class="ident" id="3714975">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3714987">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3715050">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715101">val</span>&nbsp;<span class="keyword" id="3715105">interface</span><span class="op" id="3715114">{</span><span class="op" id="3715115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715118">err</span>&nbsp;<span class="builtintype" id="3715122">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3715130">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3715190">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3715252">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715297">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3715303">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715308">chans</span>&nbsp;<span class="op" id="3715314">[</span><span class="op" id="3715315">]</span><span class="keyword" id="3715316">chan</span><span class="op" id="3715320">&lt;-</span>&nbsp;<span class="ident" id="3715323">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3715342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3715345">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3715413">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3715480">type</span>&nbsp;<span class="ident" id="3715485">singleflight</span>&nbsp;<span class="keyword" id="3715498">struct</span>&nbsp;<span class="op" id="3715505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715508">mu</span>&nbsp;<span class="ident" id="3715511">sync</span><span class="op" id="3715515">.</span><span class="ident" id="3715516">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3715528">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715543">m</span>&nbsp;&nbsp;<span class="keyword" id="3715546">map</span><span class="op" id="3715549">[</span><span class="builtintype" id="3715550">string</span><span class="op" id="3715556">]</span><span class="op" id="3715557">*</span><span class="ident" id="3715558">call</span>&nbsp;<span class="comment" id="3715563">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3715585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3715588">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3715657">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3715674">type</span>&nbsp;<span class="ident" id="3715679">singleflightResult</span>&nbsp;<span class="keyword" id="3715698">struct</span>&nbsp;<span class="op" id="3715705">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715708">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3715715">interface</span><span class="op" id="3715724">{</span><span class="op" id="3715725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715728">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3715735">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3715742">shared</span>&nbsp;<span class="builtintype" id="3715749">bool</span><br>
<span class="lineno"></span><span class="op" id="3715754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3715757">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3715826">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3715892">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3715961">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3716016">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3716094">func</span>&nbsp;<span class="op" id="3716099">(</span><span class="ident" id="3716100">g</span>&nbsp;<span class="op" id="3716102">*</span><span class="ident" id="3716103">singleflight</span><span class="op" id="3716115">)</span>&nbsp;<span class="ident" id="3716117">Do</span><span class="op" id="3716119">(</span><span class="ident" id="3716120">key</span>&nbsp;<span class="builtintype" id="3716124">string</span><span class="op" id="3716130">,</span>&nbsp;<span class="ident" id="3716132">fn</span>&nbsp;<span class="keyword" id="3716135">func</span><span class="op" id="3716139">(</span><span class="op" id="3716140">)</span>&nbsp;<span class="op" id="3716142">(</span><span class="keyword" id="3716143">interface</span><span class="op" id="3716152">{</span><span class="op" id="3716153">}</span><span class="op" id="3716154">,</span>&nbsp;<span class="builtintype" id="3716156">error</span><span class="op" id="3716161">)</span><span class="op" id="3716162">)</span>&nbsp;<span class="op" id="3716164">(</span><span class="ident" id="3716165">v</span>&nbsp;<span class="keyword" id="3716167">interface</span><span class="op" id="3716176">{</span><span class="op" id="3716177">}</span><span class="op" id="3716178">,</span>&nbsp;<span class="ident" id="3716180">err</span>&nbsp;<span class="builtintype" id="3716184">error</span><span class="op" id="3716189">,</span>&nbsp;<span class="ident" id="3716191">shared</span>&nbsp;<span class="builtintype" id="3716198">bool</span><span class="op" id="3716202">)</span>&nbsp;<span class="op" id="3716204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716207">g</span><span class="op" id="3716208">.</span><span class="ident" id="3716209">mu</span><span class="op" id="3716211">.</span><span class="ident" id="3716212">Lock</span><span class="op" id="3716216">(</span><span class="op" id="3716217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716220">if</span>&nbsp;<span class="ident" id="3716223">g</span><span class="op" id="3716224">.</span><span class="ident" id="3716225">m</span>&nbsp;<span class="op" id="3716227">==</span>&nbsp;<span class="ident" id="3716230">nil</span>&nbsp;<span class="op" id="3716234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716238">g</span><span class="op" id="3716239">.</span><span class="ident" id="3716240">m</span>&nbsp;<span class="op" id="3716242">=</span>&nbsp;<span class="builtinfunc" id="3716244">make</span><span class="op" id="3716248">(</span><span class="keyword" id="3716249">map</span><span class="op" id="3716252">[</span><span class="builtintype" id="3716253">string</span><span class="op" id="3716259">]</span><span class="op" id="3716260">*</span><span class="ident" id="3716261">call</span><span class="op" id="3716265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3716268">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716271">if</span>&nbsp;<span class="ident" id="3716274">c</span><span class="op" id="3716275">,</span>&nbsp;<span class="ident" id="3716277">ok</span>&nbsp;<span class="op" id="3716280">:=</span>&nbsp;<span class="ident" id="3716283">g</span><span class="op" id="3716284">.</span><span class="ident" id="3716285">m</span><span class="op" id="3716286">[</span><span class="ident" id="3716287">key</span><span class="op" id="3716290">]</span><span class="op" id="3716291">;</span>&nbsp;<span class="ident" id="3716293">ok</span>&nbsp;<span class="op" id="3716296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716300">c</span><span class="op" id="3716301">.</span><span class="ident" id="3716302">dups</span><span class="op" id="3716306">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716311">g</span><span class="op" id="3716312">.</span><span class="ident" id="3716313">mu</span><span class="op" id="3716315">.</span><span class="ident" id="3716316">Unlock</span><span class="op" id="3716322">(</span><span class="op" id="3716323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716327">c</span><span class="op" id="3716328">.</span><span class="ident" id="3716329">wg</span><span class="op" id="3716331">.</span><span class="ident" id="3716332">Wait</span><span class="op" id="3716336">(</span><span class="op" id="3716337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716341">return</span>&nbsp;<span class="ident" id="3716348">c</span><span class="op" id="3716349">.</span><span class="ident" id="3716350">val</span><span class="op" id="3716353">,</span>&nbsp;<span class="ident" id="3716355">c</span><span class="op" id="3716356">.</span><span class="ident" id="3716357">err</span><span class="op" id="3716360">,</span>&nbsp;<span class="builtintype" id="3716362">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3716368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716371">c</span>&nbsp;<span class="op" id="3716373">:=</span>&nbsp;<span class="builtinfunc" id="3716376">new</span><span class="op" id="3716379">(</span><span class="ident" id="3716380">call</span><span class="op" id="3716384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716387">c</span><span class="op" id="3716388">.</span><span class="ident" id="3716389">wg</span><span class="op" id="3716391">.</span><span class="ident" id="3716392">Add</span><span class="op" id="3716395">(</span><span class="num" id="3716396">1</span><span class="op" id="3716397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716400">g</span><span class="op" id="3716401">.</span><span class="ident" id="3716402">m</span><span class="op" id="3716403">[</span><span class="ident" id="3716404">key</span><span class="op" id="3716407">]</span>&nbsp;<span class="op" id="3716409">=</span>&nbsp;<span class="ident" id="3716411">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716414">g</span><span class="op" id="3716415">.</span><span class="ident" id="3716416">mu</span><span class="op" id="3716418">.</span><span class="ident" id="3716419">Unlock</span><span class="op" id="3716425">(</span><span class="op" id="3716426">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716430">g</span><span class="op" id="3716431">.</span><span class="ident" id="3716432">doCall</span><span class="op" id="3716438">(</span><span class="ident" id="3716439">c</span><span class="op" id="3716440">,</span>&nbsp;<span class="ident" id="3716442">key</span><span class="op" id="3716445">,</span>&nbsp;<span class="ident" id="3716447">fn</span><span class="op" id="3716449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716452">return</span>&nbsp;<span class="ident" id="3716459">c</span><span class="op" id="3716460">.</span><span class="ident" id="3716461">val</span><span class="op" id="3716464">,</span>&nbsp;<span class="ident" id="3716466">c</span><span class="op" id="3716467">.</span><span class="ident" id="3716468">err</span><span class="op" id="3716471">,</span>&nbsp;<span class="ident" id="3716473">c</span><span class="op" id="3716474">.</span><span class="ident" id="3716475">dups</span>&nbsp;<span class="op" id="3716480">&gt;</span>&nbsp;<span class="num" id="3716482">0</span><br>
<span class="lineno"></span><span class="op" id="3716484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3716487">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3716552">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3716584">func</span>&nbsp;<span class="op" id="3716589">(</span><span class="ident" id="3716590">g</span>&nbsp;<span class="op" id="3716592">*</span><span class="ident" id="3716593">singleflight</span><span class="op" id="3716605">)</span>&nbsp;<span class="ident" id="3716607">DoChan</span><span class="op" id="3716613">(</span><span class="ident" id="3716614">key</span>&nbsp;<span class="builtintype" id="3716618">string</span><span class="op" id="3716624">,</span>&nbsp;<span class="ident" id="3716626">fn</span>&nbsp;<span class="keyword" id="3716629">func</span><span class="op" id="3716633">(</span><span class="op" id="3716634">)</span>&nbsp;<span class="op" id="3716636">(</span><span class="keyword" id="3716637">interface</span><span class="op" id="3716646">{</span><span class="op" id="3716647">}</span><span class="op" id="3716648">,</span>&nbsp;<span class="builtintype" id="3716650">error</span><span class="op" id="3716655">)</span><span class="op" id="3716656">)</span>&nbsp;<span class="op" id="3716658">&lt;-</span><span class="keyword" id="3716660">chan</span>&nbsp;<span class="ident" id="3716665">singleflightResult</span>&nbsp;<span class="op" id="3716684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716687">ch</span>&nbsp;<span class="op" id="3716690">:=</span>&nbsp;<span class="builtinfunc" id="3716693">make</span><span class="op" id="3716697">(</span><span class="keyword" id="3716698">chan</span>&nbsp;<span class="ident" id="3716703">singleflightResult</span><span class="op" id="3716721">,</span>&nbsp;<span class="num" id="3716723">1</span><span class="op" id="3716724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716727">g</span><span class="op" id="3716728">.</span><span class="ident" id="3716729">mu</span><span class="op" id="3716731">.</span><span class="ident" id="3716732">Lock</span><span class="op" id="3716736">(</span><span class="op" id="3716737">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716740">if</span>&nbsp;<span class="ident" id="3716743">g</span><span class="op" id="3716744">.</span><span class="ident" id="3716745">m</span>&nbsp;<span class="op" id="3716747">==</span>&nbsp;<span class="ident" id="3716750">nil</span>&nbsp;<span class="op" id="3716754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716758">g</span><span class="op" id="3716759">.</span><span class="ident" id="3716760">m</span>&nbsp;<span class="op" id="3716762">=</span>&nbsp;<span class="builtinfunc" id="3716764">make</span><span class="op" id="3716768">(</span><span class="keyword" id="3716769">map</span><span class="op" id="3716772">[</span><span class="builtintype" id="3716773">string</span><span class="op" id="3716779">]</span><span class="op" id="3716780">*</span><span class="ident" id="3716781">call</span><span class="op" id="3716785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3716788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716791">if</span>&nbsp;<span class="ident" id="3716794">c</span><span class="op" id="3716795">,</span>&nbsp;<span class="ident" id="3716797">ok</span>&nbsp;<span class="op" id="3716800">:=</span>&nbsp;<span class="ident" id="3716803">g</span><span class="op" id="3716804">.</span><span class="ident" id="3716805">m</span><span class="op" id="3716806">[</span><span class="ident" id="3716807">key</span><span class="op" id="3716810">]</span><span class="op" id="3716811">;</span>&nbsp;<span class="ident" id="3716813">ok</span>&nbsp;<span class="op" id="3716816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716820">c</span><span class="op" id="3716821">.</span><span class="ident" id="3716822">dups</span><span class="op" id="3716826">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716831">c</span><span class="op" id="3716832">.</span><span class="ident" id="3716833">chans</span>&nbsp;<span class="op" id="3716839">=</span>&nbsp;<span class="builtinfunc" id="3716841">append</span><span class="op" id="3716847">(</span><span class="ident" id="3716848">c</span><span class="op" id="3716849">.</span><span class="ident" id="3716850">chans</span><span class="op" id="3716855">,</span>&nbsp;<span class="ident" id="3716857">ch</span><span class="op" id="3716859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716863">g</span><span class="op" id="3716864">.</span><span class="ident" id="3716865">mu</span><span class="op" id="3716867">.</span><span class="ident" id="3716868">Unlock</span><span class="op" id="3716874">(</span><span class="op" id="3716875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716879">return</span>&nbsp;<span class="ident" id="3716886">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3716890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716893">c</span>&nbsp;<span class="op" id="3716895">:=</span>&nbsp;<span class="op" id="3716898">&amp;</span><span class="ident" id="3716899">call</span><span class="op" id="3716903">{</span><span class="ident" id="3716904">chans</span><span class="op" id="3716909">:</span>&nbsp;<span class="op" id="3716911">[</span><span class="op" id="3716912">]</span><span class="keyword" id="3716913">chan</span><span class="op" id="3716917">&lt;-</span>&nbsp;<span class="ident" id="3716920">singleflightResult</span><span class="op" id="3716938">{</span><span class="ident" id="3716939">ch</span><span class="op" id="3716941">}</span><span class="op" id="3716942">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716945">c</span><span class="op" id="3716946">.</span><span class="ident" id="3716947">wg</span><span class="op" id="3716949">.</span><span class="ident" id="3716950">Add</span><span class="op" id="3716953">(</span><span class="num" id="3716954">1</span><span class="op" id="3716955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716958">g</span><span class="op" id="3716959">.</span><span class="ident" id="3716960">m</span><span class="op" id="3716961">[</span><span class="ident" id="3716962">key</span><span class="op" id="3716965">]</span>&nbsp;<span class="op" id="3716967">=</span>&nbsp;<span class="ident" id="3716969">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3716972">g</span><span class="op" id="3716973">.</span><span class="ident" id="3716974">mu</span><span class="op" id="3716976">.</span><span class="ident" id="3716977">Unlock</span><span class="op" id="3716983">(</span><span class="op" id="3716984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3716988">go</span>&nbsp;<span class="ident" id="3716991">g</span><span class="op" id="3716992">.</span><span class="ident" id="3716993">doCall</span><span class="op" id="3716999">(</span><span class="ident" id="3717000">c</span><span class="op" id="3717001">,</span>&nbsp;<span class="ident" id="3717003">key</span><span class="op" id="3717006">,</span>&nbsp;<span class="ident" id="3717008">fn</span><span class="op" id="3717010">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3717014">return</span>&nbsp;<span class="ident" id="3717021">ch</span><br>
<span class="lineno"></span><span class="op" id="3717024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3717027">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3717072">func</span>&nbsp;<span class="op" id="3717077">(</span><span class="ident" id="3717078">g</span>&nbsp;<span class="op" id="3717080">*</span><span class="ident" id="3717081">singleflight</span><span class="op" id="3717093">)</span>&nbsp;<span class="ident" id="3717095">doCall</span><span class="op" id="3717101">(</span><span class="ident" id="3717102">c</span>&nbsp;<span class="op" id="3717104">*</span><span class="ident" id="3717105">call</span><span class="op" id="3717109">,</span>&nbsp;<span class="ident" id="3717111">key</span>&nbsp;<span class="builtintype" id="3717115">string</span><span class="op" id="3717121">,</span>&nbsp;<span class="ident" id="3717123">fn</span>&nbsp;<span class="keyword" id="3717126">func</span><span class="op" id="3717130">(</span><span class="op" id="3717131">)</span>&nbsp;<span class="op" id="3717133">(</span><span class="keyword" id="3717134">interface</span><span class="op" id="3717143">{</span><span class="op" id="3717144">}</span><span class="op" id="3717145">,</span>&nbsp;<span class="builtintype" id="3717147">error</span><span class="op" id="3717152">)</span><span class="op" id="3717153">)</span>&nbsp;<span class="op" id="3717155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717158">c</span><span class="op" id="3717159">.</span><span class="ident" id="3717160">val</span><span class="op" id="3717163">,</span>&nbsp;<span class="ident" id="3717165">c</span><span class="op" id="3717166">.</span><span class="ident" id="3717167">err</span>&nbsp;<span class="op" id="3717171">=</span>&nbsp;<span class="ident" id="3717173">fn</span><span class="op" id="3717175">(</span><span class="op" id="3717176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717179">c</span><span class="op" id="3717180">.</span><span class="ident" id="3717181">wg</span><span class="op" id="3717183">.</span><span class="ident" id="3717184">Done</span><span class="op" id="3717188">(</span><span class="op" id="3717189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717193">g</span><span class="op" id="3717194">.</span><span class="ident" id="3717195">mu</span><span class="op" id="3717197">.</span><span class="ident" id="3717198">Lock</span><span class="op" id="3717202">(</span><span class="op" id="3717203">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3717206">delete</span><span class="op" id="3717212">(</span><span class="ident" id="3717213">g</span><span class="op" id="3717214">.</span><span class="ident" id="3717215">m</span><span class="op" id="3717216">,</span>&nbsp;<span class="ident" id="3717218">key</span><span class="op" id="3717221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3717224">for</span>&nbsp;<span class="ident" id="3717228">_</span><span class="op" id="3717229">,</span>&nbsp;<span class="ident" id="3717231">ch</span>&nbsp;<span class="op" id="3717234">:=</span>&nbsp;<span class="keyword" id="3717237">range</span>&nbsp;<span class="ident" id="3717243">c</span><span class="op" id="3717244">.</span><span class="ident" id="3717245">chans</span>&nbsp;<span class="op" id="3717251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717255">ch</span>&nbsp;<span class="op" id="3717258">&lt;-</span>&nbsp;<span class="ident" id="3717261">singleflightResult</span><span class="op" id="3717279">{</span><span class="ident" id="3717280">c</span><span class="op" id="3717281">.</span><span class="ident" id="3717282">val</span><span class="op" id="3717285">,</span>&nbsp;<span class="ident" id="3717287">c</span><span class="op" id="3717288">.</span><span class="ident" id="3717289">err</span><span class="op" id="3717292">,</span>&nbsp;<span class="ident" id="3717294">c</span><span class="op" id="3717295">.</span><span class="ident" id="3717296">dups</span>&nbsp;<span class="op" id="3717301">&gt;</span>&nbsp;<span class="num" id="3717303">0</span><span class="op" id="3717304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3717307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717310">g</span><span class="op" id="3717311">.</span><span class="ident" id="3717312">mu</span><span class="op" id="3717314">.</span><span class="ident" id="3717315">Unlock</span><span class="op" id="3717321">(</span><span class="op" id="3717322">)</span><br>
<span class="lineno">100</span><span class="op" id="3717324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3717327">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3717397">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3717466">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3717498">func</span>&nbsp;<span class="op" id="3717503">(</span><span class="ident" id="3717504">g</span>&nbsp;<span class="op" id="3717506">*</span><span class="ident" id="3717507">singleflight</span><span class="op" id="3717519">)</span>&nbsp;<span class="ident" id="3717521">Forget</span><span class="op" id="3717527">(</span><span class="ident" id="3717528">key</span>&nbsp;<span class="builtintype" id="3717532">string</span><span class="op" id="3717538">)</span>&nbsp;<span class="op" id="3717540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717543">g</span><span class="op" id="3717544">.</span><span class="ident" id="3717545">mu</span><span class="op" id="3717547">.</span><span class="ident" id="3717548">Lock</span><span class="op" id="3717552">(</span><span class="op" id="3717553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3717556">delete</span><span class="op" id="3717562">(</span><span class="ident" id="3717563">g</span><span class="op" id="3717564">.</span><span class="ident" id="3717565">m</span><span class="op" id="3717566">,</span>&nbsp;<span class="ident" id="3717568">key</span><span class="op" id="3717571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3717574">g</span><span class="op" id="3717575">.</span><span class="ident" id="3717576">mu</span><span class="op" id="3717578">.</span><span class="ident" id="3717579">Unlock</span><span class="op" id="3717585">(</span><span class="op" id="3717586">)</span><br>
<span class="lineno"></span><span class="op" id="3717588">}</span>
</div>
</body>
</html>
