<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3519223">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3519278">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3519332">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3519382">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3519386">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3519579">package</span>&nbsp;<span class="ident" id="3519587">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3519598">import</span>&nbsp;<span class="op" id="3519605">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519608">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519617">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519626">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519633">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519639">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519652">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519660">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3519676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3519679">var</span>&nbsp;<span class="ident" id="3519683">emptyParams</span>&nbsp;<span class="op" id="3519695">=</span>&nbsp;<span class="builtinfunc" id="3519697">make</span><span class="op" id="3519701">(</span><span class="keyword" id="3519702">map</span><span class="op" id="3519705">[</span><span class="builtintype" id="3519706">string</span><span class="op" id="3519712">]</span><span class="builtintype" id="3519713">string</span><span class="op" id="3519719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3519722">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3519778">type</span>&nbsp;<span class="ident" id="3519783">Part</span>&nbsp;<span class="keyword" id="3519788">struct</span>&nbsp;<span class="op" id="3519795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3519798">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3519863">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3519925">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3519978">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3519982">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520047">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520109">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520172">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520195">Header</span>&nbsp;<span class="ident" id="3520202">textproto</span><span class="op" id="3520211">.</span><span class="ident" id="3520212">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520225">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520235">*</span><span class="ident" id="3520236">bytes</span><span class="op" id="3520241">.</span><span class="ident" id="3520242">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520250">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520260">*</span><span class="ident" id="3520261">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520269">bytesRead</span>&nbsp;<span class="builtintype" id="3520279">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520285">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3520303">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520311">dispositionParams</span>&nbsp;<span class="keyword" id="3520329">map</span><span class="op" id="3520332">[</span><span class="builtintype" id="3520333">string</span><span class="op" id="3520339">]</span><span class="builtintype" id="3520340">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520349">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520410">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520457">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520487">r</span>&nbsp;<span class="ident" id="3520489">io</span><span class="op" id="3520491">.</span><span class="ident" id="3520492">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3520499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3520502">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3520572">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3520636">func</span>&nbsp;<span class="op" id="3520641">(</span><span class="ident" id="3520642">p</span>&nbsp;<span class="op" id="3520644">*</span><span class="ident" id="3520645">Part</span><span class="op" id="3520649">)</span>&nbsp;<span class="ident" id="3520651">FormName</span><span class="op" id="3520659">(</span><span class="op" id="3520660">)</span>&nbsp;<span class="builtintype" id="3520662">string</span>&nbsp;<span class="op" id="3520669">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520672">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520734">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520775">if</span>&nbsp;<span class="ident" id="3520778">p</span><span class="op" id="3520779">.</span><span class="ident" id="3520780">dispositionParams</span>&nbsp;<span class="op" id="3520798">==</span>&nbsp;<span class="ident" id="3520801">nil</span>&nbsp;<span class="op" id="3520805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520809">p</span><span class="op" id="3520810">.</span><span class="ident" id="3520811">parseContentDisposition</span><span class="op" id="3520834">(</span><span class="op" id="3520835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520838">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520841">if</span>&nbsp;<span class="ident" id="3520844">p</span><span class="op" id="3520845">.</span><span class="ident" id="3520846">disposition</span>&nbsp;<span class="op" id="3520858">!=</span>&nbsp;<span class="string" id="3520861">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3520873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520877">return</span>&nbsp;<span class="string" id="3520884">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520891">return</span>&nbsp;<span class="ident" id="3520898">p</span><span class="op" id="3520899">.</span><span class="ident" id="3520900">dispositionParams</span><span class="op" id="3520917">[</span><span class="string" id="3520918">&#34;name&#34;</span><span class="op" id="3520924">]</span><br>
<span class="lineno"></span><span class="op" id="3520926">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3520929">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3520986">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3521017">func</span>&nbsp;<span class="op" id="3521022">(</span><span class="ident" id="3521023">p</span>&nbsp;<span class="op" id="3521025">*</span><span class="ident" id="3521026">Part</span><span class="op" id="3521030">)</span>&nbsp;<span class="ident" id="3521032">FileName</span><span class="op" id="3521040">(</span><span class="op" id="3521041">)</span>&nbsp;<span class="builtintype" id="3521043">string</span>&nbsp;<span class="op" id="3521050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521053">if</span>&nbsp;<span class="ident" id="3521056">p</span><span class="op" id="3521057">.</span><span class="ident" id="3521058">dispositionParams</span>&nbsp;<span class="op" id="3521076">==</span>&nbsp;<span class="ident" id="3521079">nil</span>&nbsp;<span class="op" id="3521083">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521087">p</span><span class="op" id="3521088">.</span><span class="ident" id="3521089">parseContentDisposition</span><span class="op" id="3521112">(</span><span class="op" id="3521113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521119">return</span>&nbsp;<span class="ident" id="3521126">p</span><span class="op" id="3521127">.</span><span class="ident" id="3521128">dispositionParams</span><span class="op" id="3521145">[</span><span class="string" id="3521146">&#34;filename&#34;</span><span class="op" id="3521156">]</span><br>
<span class="lineno"></span><span class="op" id="3521158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3521161">func</span>&nbsp;<span class="op" id="3521166">(</span><span class="ident" id="3521167">p</span>&nbsp;<span class="op" id="3521169">*</span><span class="ident" id="3521170">Part</span><span class="op" id="3521174">)</span>&nbsp;<span class="ident" id="3521176">parseContentDisposition</span><span class="op" id="3521199">(</span><span class="op" id="3521200">)</span>&nbsp;<span class="op" id="3521202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521205">v</span>&nbsp;<span class="op" id="3521207">:=</span>&nbsp;<span class="ident" id="3521210">p</span><span class="op" id="3521211">.</span><span class="ident" id="3521212">Header</span><span class="op" id="3521218">.</span><span class="ident" id="3521219">Get</span><span class="op" id="3521222">(</span><span class="string" id="3521223">&#34;Content-Disposition&#34;</span><span class="op" id="3521244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521247">var</span>&nbsp;<span class="ident" id="3521251">err</span>&nbsp;<span class="builtintype" id="3521255">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521262">p</span><span class="op" id="3521263">.</span><span class="ident" id="3521264">disposition</span><span class="op" id="3521275">,</span>&nbsp;<span class="ident" id="3521277">p</span><span class="op" id="3521278">.</span><span class="ident" id="3521279">dispositionParams</span><span class="op" id="3521296">,</span>&nbsp;<span class="ident" id="3521298">err</span>&nbsp;<span class="op" id="3521302">=</span>&nbsp;<span class="ident" id="3521304">mime</span><span class="op" id="3521308">.</span><span class="ident" id="3521309">ParseMediaType</span><span class="op" id="3521323">(</span><span class="ident" id="3521324">v</span><span class="op" id="3521325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521328">if</span>&nbsp;<span class="ident" id="3521331">err</span>&nbsp;<span class="op" id="3521335">!=</span>&nbsp;<span class="ident" id="3521338">nil</span>&nbsp;<span class="op" id="3521342">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521346">p</span><span class="op" id="3521347">.</span><span class="ident" id="3521348">dispositionParams</span>&nbsp;<span class="op" id="3521366">=</span>&nbsp;<span class="ident" id="3521368">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521381">}</span><br>
<span class="lineno"></span><span class="op" id="3521383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3521386">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3521455">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3521479">//</span><br>
<span class="lineno"></span><span class="comment" id="3521482">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3521551">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3521618">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3521641">func</span>&nbsp;<span class="ident" id="3521646">NewReader</span><span class="op" id="3521655">(</span><span class="ident" id="3521656">r</span>&nbsp;<span class="ident" id="3521658">io</span><span class="op" id="3521660">.</span><span class="ident" id="3521661">Reader</span><span class="op" id="3521667">,</span>&nbsp;<span class="ident" id="3521669">boundary</span>&nbsp;<span class="builtintype" id="3521678">string</span><span class="op" id="3521684">)</span>&nbsp;<span class="op" id="3521686">*</span><span class="ident" id="3521687">Reader</span>&nbsp;<span class="op" id="3521694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521697">b</span>&nbsp;<span class="op" id="3521699">:=</span>&nbsp;<span class="op" id="3521702">[</span><span class="op" id="3521703">]</span><span class="builtintype" id="3521704">byte</span><span class="op" id="3521708">(</span><span class="string" id="3521709">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3521718">+</span>&nbsp;<span class="ident" id="3521720">boundary</span>&nbsp;<span class="op" id="3521729">+</span>&nbsp;<span class="string" id="3521731">&#34;--&#34;</span><span class="op" id="3521735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521738">return</span>&nbsp;<span class="op" id="3521745">&amp;</span><span class="ident" id="3521746">Reader</span><span class="op" id="3521752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521756">bufReader</span><span class="op" id="3521765">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521774">bufio</span><span class="op" id="3521779">.</span><span class="ident" id="3521780">NewReader</span><span class="op" id="3521789">(</span><span class="ident" id="3521790">r</span><span class="op" id="3521791">)</span><span class="op" id="3521792">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521796">nl</span><span class="op" id="3521798">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521814">b</span><span class="op" id="3521815">[</span><span class="op" id="3521816">:</span><span class="num" id="3521817">2</span><span class="op" id="3521818">]</span><span class="op" id="3521819">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521823">nlDashBoundary</span><span class="op" id="3521837">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3521841">b</span><span class="op" id="3521842">[</span><span class="op" id="3521843">:</span><span class="builtinfunc" id="3521844">len</span><span class="op" id="3521847">(</span><span class="ident" id="3521848">b</span><span class="op" id="3521849">)</span><span class="op" id="3521850">-</span><span class="num" id="3521851">2</span><span class="op" id="3521852">]</span><span class="op" id="3521853">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521857">dashBoundaryDash</span><span class="op" id="3521873">:</span>&nbsp;<span class="ident" id="3521875">b</span><span class="op" id="3521876">[</span><span class="num" id="3521877">2</span><span class="op" id="3521878">:</span><span class="op" id="3521879">]</span><span class="op" id="3521880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521884">dashBoundary</span><span class="op" id="3521896">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3521902">b</span><span class="op" id="3521903">[</span><span class="num" id="3521904">2</span>&nbsp;<span class="op" id="3521906">:</span>&nbsp;<span class="builtinfunc" id="3521908">len</span><span class="op" id="3521911">(</span><span class="ident" id="3521912">b</span><span class="op" id="3521913">)</span><span class="op" id="3521914">-</span><span class="num" id="3521915">2</span><span class="op" id="3521916">]</span><span class="op" id="3521917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521920">}</span><br>
<span class="lineno"></span><span class="op" id="3521922">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3521925">func</span>&nbsp;<span class="ident" id="3521930">newPart</span><span class="op" id="3521937">(</span><span class="ident" id="3521938">mr</span>&nbsp;<span class="op" id="3521941">*</span><span class="ident" id="3521942">Reader</span><span class="op" id="3521948">)</span>&nbsp;<span class="op" id="3521950">(</span><span class="op" id="3521951">*</span><span class="ident" id="3521952">Part</span><span class="op" id="3521956">,</span>&nbsp;<span class="builtintype" id="3521958">error</span><span class="op" id="3521963">)</span>&nbsp;<span class="op" id="3521965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521968">bp</span>&nbsp;<span class="op" id="3521971">:=</span>&nbsp;<span class="op" id="3521974">&amp;</span><span class="ident" id="3521975">Part</span><span class="op" id="3521979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521983">Header</span><span class="op" id="3521989">:</span>&nbsp;<span class="builtinfunc" id="3521991">make</span><span class="op" id="3521995">(</span><span class="keyword" id="3521996">map</span><span class="op" id="3521999">[</span><span class="builtintype" id="3522000">string</span><span class="op" id="3522006">]</span><span class="op" id="3522007">[</span><span class="op" id="3522008">]</span><span class="builtintype" id="3522009">string</span><span class="op" id="3522015">)</span><span class="op" id="3522016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522020">mr</span><span class="op" id="3522022">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3522028">mr</span><span class="op" id="3522030">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522034">buffer</span><span class="op" id="3522040">:</span>&nbsp;<span class="builtinfunc" id="3522042">new</span><span class="op" id="3522045">(</span><span class="ident" id="3522046">bytes</span><span class="op" id="3522051">.</span><span class="ident" id="3522052">Buffer</span><span class="op" id="3522058">)</span><span class="op" id="3522059">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522065">if</span>&nbsp;<span class="ident" id="3522068">err</span>&nbsp;<span class="op" id="3522072">:=</span>&nbsp;<span class="ident" id="3522075">bp</span><span class="op" id="3522077">.</span><span class="ident" id="3522078">populateHeaders</span><span class="op" id="3522093">(</span><span class="op" id="3522094">)</span><span class="op" id="3522095">;</span>&nbsp;<span class="ident" id="3522097">err</span>&nbsp;<span class="op" id="3522101">!=</span>&nbsp;<span class="ident" id="3522104">nil</span>&nbsp;<span class="op" id="3522108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522112">return</span>&nbsp;<span class="ident" id="3522119">nil</span><span class="op" id="3522122">,</span>&nbsp;<span class="ident" id="3522124">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522129">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522132">bp</span><span class="op" id="3522134">.</span><span class="ident" id="3522135">r</span>&nbsp;<span class="op" id="3522137">=</span>&nbsp;<span class="ident" id="3522139">partReader</span><span class="op" id="3522149">{</span><span class="ident" id="3522150">bp</span><span class="op" id="3522152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522155">const</span>&nbsp;<span class="ident" id="3522161">cte</span>&nbsp;<span class="op" id="3522165">=</span>&nbsp;<span class="string" id="3522167">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522196">if</span>&nbsp;<span class="ident" id="3522199">bp</span><span class="op" id="3522201">.</span><span class="ident" id="3522202">Header</span><span class="op" id="3522208">.</span><span class="ident" id="3522209">Get</span><span class="op" id="3522212">(</span><span class="ident" id="3522213">cte</span><span class="op" id="3522216">)</span>&nbsp;<span class="op" id="3522218">==</span>&nbsp;<span class="string" id="3522221">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3522240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522244">bp</span><span class="op" id="3522246">.</span><span class="ident" id="3522247">Header</span><span class="op" id="3522253">.</span><span class="ident" id="3522254">Del</span><span class="op" id="3522257">(</span><span class="ident" id="3522258">cte</span><span class="op" id="3522261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522265">bp</span><span class="op" id="3522267">.</span><span class="ident" id="3522268">r</span>&nbsp;<span class="op" id="3522270">=</span>&nbsp;<span class="ident" id="3522272">newQuotedPrintableReader</span><span class="op" id="3522296">(</span><span class="ident" id="3522297">bp</span><span class="op" id="3522299">.</span><span class="ident" id="3522300">r</span><span class="op" id="3522301">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522307">return</span>&nbsp;<span class="ident" id="3522314">bp</span><span class="op" id="3522316">,</span>&nbsp;<span class="ident" id="3522318">nil</span><br>
<span class="lineno"></span><span class="op" id="3522322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3522325">func</span>&nbsp;<span class="op" id="3522330">(</span><span class="ident" id="3522331">bp</span>&nbsp;<span class="op" id="3522334">*</span><span class="ident" id="3522335">Part</span><span class="op" id="3522339">)</span>&nbsp;<span class="ident" id="3522341">populateHeaders</span><span class="op" id="3522356">(</span><span class="op" id="3522357">)</span>&nbsp;<span class="builtintype" id="3522359">error</span>&nbsp;<span class="op" id="3522365">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522368">r</span>&nbsp;<span class="op" id="3522370">:=</span>&nbsp;<span class="ident" id="3522373">textproto</span><span class="op" id="3522382">.</span><span class="ident" id="3522383">NewReader</span><span class="op" id="3522392">(</span><span class="ident" id="3522393">bp</span><span class="op" id="3522395">.</span><span class="ident" id="3522396">mr</span><span class="op" id="3522398">.</span><span class="ident" id="3522399">bufReader</span><span class="op" id="3522408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522411">header</span><span class="op" id="3522417">,</span>&nbsp;<span class="ident" id="3522419">err</span>&nbsp;<span class="op" id="3522423">:=</span>&nbsp;<span class="ident" id="3522426">r</span><span class="op" id="3522427">.</span><span class="ident" id="3522428">ReadMIMEHeader</span><span class="op" id="3522442">(</span><span class="op" id="3522443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522446">if</span>&nbsp;<span class="ident" id="3522449">err</span>&nbsp;<span class="op" id="3522453">==</span>&nbsp;<span class="ident" id="3522456">nil</span>&nbsp;<span class="op" id="3522460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522464">bp</span><span class="op" id="3522466">.</span><span class="ident" id="3522467">Header</span>&nbsp;<span class="op" id="3522474">=</span>&nbsp;<span class="ident" id="3522476">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522484">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522487">return</span>&nbsp;<span class="ident" id="3522494">err</span><br>
<span class="lineno"></span><span class="op" id="3522498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3522501">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3522568">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3522598">func</span>&nbsp;<span class="op" id="3522603">(</span><span class="ident" id="3522604">p</span>&nbsp;<span class="op" id="3522606">*</span><span class="ident" id="3522607">Part</span><span class="op" id="3522611">)</span>&nbsp;<span class="ident" id="3522613">Read</span><span class="op" id="3522617">(</span><span class="ident" id="3522618">d</span>&nbsp;<span class="op" id="3522620">[</span><span class="op" id="3522621">]</span><span class="builtintype" id="3522622">byte</span><span class="op" id="3522626">)</span>&nbsp;<span class="op" id="3522628">(</span><span class="ident" id="3522629">n</span>&nbsp;<span class="builtintype" id="3522631">int</span><span class="op" id="3522634">,</span>&nbsp;<span class="ident" id="3522636">err</span>&nbsp;<span class="builtintype" id="3522640">error</span><span class="op" id="3522645">)</span>&nbsp;<span class="op" id="3522647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522650">return</span>&nbsp;<span class="ident" id="3522657">p</span><span class="op" id="3522658">.</span><span class="ident" id="3522659">r</span><span class="op" id="3522660">.</span><span class="ident" id="3522661">Read</span><span class="op" id="3522665">(</span><span class="ident" id="3522666">d</span><span class="op" id="3522667">)</span><br>
<span class="lineno"></span><span class="op" id="3522669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3522672">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3522746">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3522810">type</span>&nbsp;<span class="ident" id="3522815">partReader</span>&nbsp;<span class="keyword" id="3522826">struct</span>&nbsp;<span class="op" id="3522833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522836">p</span>&nbsp;<span class="op" id="3522838">*</span><span class="ident" id="3522839">Part</span><br>
<span class="lineno"></span><span class="op" id="3522844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3522847">func</span>&nbsp;<span class="op" id="3522852">(</span><span class="ident" id="3522853">pr</span>&nbsp;<span class="ident" id="3522856">partReader</span><span class="op" id="3522866">)</span>&nbsp;<span class="ident" id="3522868">Read</span><span class="op" id="3522872">(</span><span class="ident" id="3522873">d</span>&nbsp;<span class="op" id="3522875">[</span><span class="op" id="3522876">]</span><span class="builtintype" id="3522877">byte</span><span class="op" id="3522881">)</span>&nbsp;<span class="op" id="3522883">(</span><span class="ident" id="3522884">n</span>&nbsp;<span class="builtintype" id="3522886">int</span><span class="op" id="3522889">,</span>&nbsp;<span class="ident" id="3522891">err</span>&nbsp;<span class="builtintype" id="3522895">error</span><span class="op" id="3522900">)</span>&nbsp;<span class="op" id="3522902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522905">p</span>&nbsp;<span class="op" id="3522907">:=</span>&nbsp;<span class="ident" id="3522910">pr</span><span class="op" id="3522912">.</span><span class="ident" id="3522913">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522916">defer</span>&nbsp;<span class="keyword" id="3522922">func</span><span class="op" id="3522926">(</span><span class="op" id="3522927">)</span>&nbsp;<span class="op" id="3522929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522933">p</span><span class="op" id="3522934">.</span><span class="ident" id="3522935">bytesRead</span>&nbsp;<span class="op" id="3522945">+=</span>&nbsp;<span class="ident" id="3522948">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522951">}</span><span class="op" id="3522952">(</span><span class="op" id="3522953">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522956">if</span>&nbsp;<span class="ident" id="3522959">p</span><span class="op" id="3522960">.</span><span class="ident" id="3522961">buffer</span><span class="op" id="3522967">.</span><span class="ident" id="3522968">Len</span><span class="op" id="3522971">(</span><span class="op" id="3522972">)</span>&nbsp;<span class="op" id="3522974">&gt;=</span>&nbsp;<span class="builtinfunc" id="3522977">len</span><span class="op" id="3522980">(</span><span class="ident" id="3522981">d</span><span class="op" id="3522982">)</span>&nbsp;<span class="op" id="3522984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522988">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523048">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523109">return</span>&nbsp;<span class="ident" id="3523116">p</span><span class="op" id="3523117">.</span><span class="ident" id="3523118">buffer</span><span class="op" id="3523124">.</span><span class="ident" id="3523125">Read</span><span class="op" id="3523129">(</span><span class="ident" id="3523130">d</span><span class="op" id="3523131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523134">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523137">peek</span><span class="op" id="3523141">,</span>&nbsp;<span class="ident" id="3523143">err</span>&nbsp;<span class="op" id="3523147">:=</span>&nbsp;<span class="ident" id="3523150">p</span><span class="op" id="3523151">.</span><span class="ident" id="3523152">mr</span><span class="op" id="3523154">.</span><span class="ident" id="3523155">bufReader</span><span class="op" id="3523164">.</span><span class="ident" id="3523165">Peek</span><span class="op" id="3523169">(</span><span class="num" id="3523170">4096</span><span class="op" id="3523174">)</span>&nbsp;<span class="comment" id="3523176">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523222">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523282">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523345">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523405">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523465">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523490">if</span>&nbsp;<span class="ident" id="3523493">p</span><span class="op" id="3523494">.</span><span class="ident" id="3523495">bytesRead</span>&nbsp;<span class="op" id="3523505">==</span>&nbsp;<span class="num" id="3523508">0</span>&nbsp;<span class="op" id="3523510">&amp;&amp;</span>&nbsp;<span class="ident" id="3523513">p</span><span class="op" id="3523514">.</span><span class="ident" id="3523515">mr</span><span class="op" id="3523517">.</span><span class="ident" id="3523518">peekBufferIsEmptyPart</span><span class="op" id="3523539">(</span><span class="ident" id="3523540">peek</span><span class="op" id="3523544">)</span>&nbsp;<span class="op" id="3523546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523550">return</span>&nbsp;<span class="num" id="3523557">0</span><span class="op" id="3523558">,</span>&nbsp;<span class="ident" id="3523560">io</span><span class="op" id="3523562">.</span><span class="ident" id="3523563">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523568">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523571">unexpectedEOF</span>&nbsp;<span class="op" id="3523585">:=</span>&nbsp;<span class="ident" id="3523588">err</span>&nbsp;<span class="op" id="3523592">==</span>&nbsp;<span class="ident" id="3523595">io</span><span class="op" id="3523597">.</span><span class="ident" id="3523598">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523603">if</span>&nbsp;<span class="ident" id="3523606">err</span>&nbsp;<span class="op" id="3523610">!=</span>&nbsp;<span class="ident" id="3523613">nil</span>&nbsp;<span class="op" id="3523617">&amp;&amp;</span>&nbsp;<span class="op" id="3523620">!</span><span class="ident" id="3523621">unexpectedEOF</span>&nbsp;<span class="op" id="3523635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523639">return</span>&nbsp;<span class="num" id="3523646">0</span><span class="op" id="3523647">,</span>&nbsp;<span class="ident" id="3523649">fmt</span><span class="op" id="3523652">.</span><span class="ident" id="3523653">Errorf</span><span class="op" id="3523659">(</span><span class="string" id="3523660">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3523686">,</span>&nbsp;<span class="ident" id="3523688">err</span><span class="op" id="3523691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523697">if</span>&nbsp;<span class="ident" id="3523700">peek</span>&nbsp;<span class="op" id="3523705">==</span>&nbsp;<span class="ident" id="3523708">nil</span>&nbsp;<span class="op" id="3523712">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523716">panic</span><span class="op" id="3523721">(</span><span class="string" id="3523722">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3523736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523743">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523802">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523866">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523925">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523937">nCopy</span>&nbsp;<span class="op" id="3523943">:=</span>&nbsp;<span class="num" id="3523946">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523949">foundBoundary</span>&nbsp;<span class="op" id="3523963">:=</span>&nbsp;<span class="builtintype" id="3523966">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523973">if</span>&nbsp;<span class="ident" id="3523976">idx</span>&nbsp;<span class="op" id="3523980">:=</span>&nbsp;<span class="ident" id="3523983">bytes</span><span class="op" id="3523988">.</span><span class="ident" id="3523989">Index</span><span class="op" id="3523994">(</span><span class="ident" id="3523995">peek</span><span class="op" id="3523999">,</span>&nbsp;<span class="ident" id="3524001">p</span><span class="op" id="3524002">.</span><span class="ident" id="3524003">mr</span><span class="op" id="3524005">.</span><span class="ident" id="3524006">nlDashBoundary</span><span class="op" id="3524020">)</span><span class="op" id="3524021">;</span>&nbsp;<span class="ident" id="3524023">idx</span>&nbsp;<span class="op" id="3524027">!=</span>&nbsp;<span class="op" id="3524030">-</span><span class="num" id="3524031">1</span>&nbsp;<span class="op" id="3524033">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524037">nCopy</span>&nbsp;<span class="op" id="3524043">=</span>&nbsp;<span class="ident" id="3524045">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524051">foundBoundary</span>&nbsp;<span class="op" id="3524065">=</span>&nbsp;<span class="builtintype" id="3524067">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524073">}</span>&nbsp;<span class="keyword" id="3524075">else</span>&nbsp;<span class="keyword" id="3524080">if</span>&nbsp;<span class="ident" id="3524083">safeCount</span>&nbsp;<span class="op" id="3524093">:=</span>&nbsp;<span class="builtinfunc" id="3524096">len</span><span class="op" id="3524099">(</span><span class="ident" id="3524100">peek</span><span class="op" id="3524104">)</span>&nbsp;<span class="op" id="3524106">-</span>&nbsp;<span class="builtinfunc" id="3524108">len</span><span class="op" id="3524111">(</span><span class="ident" id="3524112">p</span><span class="op" id="3524113">.</span><span class="ident" id="3524114">mr</span><span class="op" id="3524116">.</span><span class="ident" id="3524117">nlDashBoundary</span><span class="op" id="3524131">)</span><span class="op" id="3524132">;</span>&nbsp;<span class="ident" id="3524134">safeCount</span>&nbsp;<span class="op" id="3524144">&gt;</span>&nbsp;<span class="num" id="3524146">0</span>&nbsp;<span class="op" id="3524148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524152">nCopy</span>&nbsp;<span class="op" id="3524158">=</span>&nbsp;<span class="ident" id="3524160">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524171">}</span>&nbsp;<span class="keyword" id="3524173">else</span>&nbsp;<span class="keyword" id="3524178">if</span>&nbsp;<span class="ident" id="3524181">unexpectedEOF</span>&nbsp;<span class="op" id="3524195">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524199">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524253">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524310">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524353">return</span>&nbsp;<span class="num" id="3524360">0</span><span class="op" id="3524361">,</span>&nbsp;<span class="ident" id="3524363">io</span><span class="op" id="3524365">.</span><span class="ident" id="3524366">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524384">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524387">if</span>&nbsp;<span class="ident" id="3524390">nCopy</span>&nbsp;<span class="op" id="3524396">&gt;</span>&nbsp;<span class="num" id="3524398">0</span>&nbsp;<span class="op" id="3524400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524404">if</span>&nbsp;<span class="ident" id="3524407">_</span><span class="op" id="3524408">,</span>&nbsp;<span class="ident" id="3524410">err</span>&nbsp;<span class="op" id="3524414">:=</span>&nbsp;<span class="ident" id="3524417">io</span><span class="op" id="3524419">.</span><span class="ident" id="3524420">CopyN</span><span class="op" id="3524425">(</span><span class="ident" id="3524426">p</span><span class="op" id="3524427">.</span><span class="ident" id="3524428">buffer</span><span class="op" id="3524434">,</span>&nbsp;<span class="ident" id="3524436">p</span><span class="op" id="3524437">.</span><span class="ident" id="3524438">mr</span><span class="op" id="3524440">.</span><span class="ident" id="3524441">bufReader</span><span class="op" id="3524450">,</span>&nbsp;<span class="ident" id="3524452">int64</span><span class="op" id="3524457">(</span><span class="ident" id="3524458">nCopy</span><span class="op" id="3524463">)</span><span class="op" id="3524464">)</span><span class="op" id="3524465">;</span>&nbsp;<span class="ident" id="3524467">err</span>&nbsp;<span class="op" id="3524471">!=</span>&nbsp;<span class="ident" id="3524474">nil</span>&nbsp;<span class="op" id="3524478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524483">return</span>&nbsp;<span class="num" id="3524490">0</span><span class="op" id="3524491">,</span>&nbsp;<span class="ident" id="3524493">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524502">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524505">n</span><span class="op" id="3524506">,</span>&nbsp;<span class="ident" id="3524508">err</span>&nbsp;<span class="op" id="3524512">=</span>&nbsp;<span class="ident" id="3524514">p</span><span class="op" id="3524515">.</span><span class="ident" id="3524516">buffer</span><span class="op" id="3524522">.</span><span class="ident" id="3524523">Read</span><span class="op" id="3524527">(</span><span class="ident" id="3524528">d</span><span class="op" id="3524529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524532">if</span>&nbsp;<span class="ident" id="3524535">err</span>&nbsp;<span class="op" id="3524539">==</span>&nbsp;<span class="ident" id="3524542">io</span><span class="op" id="3524544">.</span><span class="ident" id="3524545">EOF</span>&nbsp;<span class="op" id="3524549">&amp;&amp;</span>&nbsp;<span class="op" id="3524552">!</span><span class="ident" id="3524553">foundBoundary</span>&nbsp;<span class="op" id="3524567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524571">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524628">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524684">err</span>&nbsp;<span class="op" id="3524688">=</span>&nbsp;<span class="ident" id="3524690">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524698">return</span><br>
<span class="lineno"></span><span class="op" id="3524705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3524708">func</span>&nbsp;<span class="op" id="3524713">(</span><span class="ident" id="3524714">p</span>&nbsp;<span class="op" id="3524716">*</span><span class="ident" id="3524717">Part</span><span class="op" id="3524721">)</span>&nbsp;<span class="ident" id="3524723">Close</span><span class="op" id="3524728">(</span><span class="op" id="3524729">)</span>&nbsp;<span class="builtintype" id="3524731">error</span>&nbsp;<span class="op" id="3524737">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524740">io</span><span class="op" id="3524742">.</span><span class="ident" id="3524743">Copy</span><span class="op" id="3524747">(</span><span class="ident" id="3524748">ioutil</span><span class="op" id="3524754">.</span><span class="ident" id="3524755">Discard</span><span class="op" id="3524762">,</span>&nbsp;<span class="ident" id="3524764">p</span><span class="op" id="3524765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524768">return</span>&nbsp;<span class="ident" id="3524775">nil</span><br>
<span class="lineno"></span><span class="op" id="3524779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3524782">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3524844">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3524913">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3524933">type</span>&nbsp;<span class="ident" id="3524938">Reader</span>&nbsp;<span class="keyword" id="3524945">struct</span>&nbsp;<span class="op" id="3524952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524955">bufReader</span>&nbsp;<span class="op" id="3524965">*</span><span class="ident" id="3524966">bufio</span><span class="op" id="3524971">.</span><span class="ident" id="3524972">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524981">currentPart</span>&nbsp;<span class="op" id="3524993">*</span><span class="ident" id="3524994">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525000">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3525012">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525018">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525035">[</span><span class="op" id="3525036">]</span><span class="builtintype" id="3525037">byte</span>&nbsp;<span class="comment" id="3525042">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525100">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3525117">[</span><span class="op" id="3525118">]</span><span class="builtintype" id="3525119">byte</span>&nbsp;<span class="comment" id="3525124">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525146">dashBoundaryDash</span>&nbsp;<span class="op" id="3525163">[</span><span class="op" id="3525164">]</span><span class="builtintype" id="3525165">byte</span>&nbsp;<span class="comment" id="3525170">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525189">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3525206">[</span><span class="op" id="3525207">]</span><span class="builtintype" id="3525208">byte</span>&nbsp;<span class="comment" id="3525213">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3525229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3525232">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3525296">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3525359">func</span>&nbsp;<span class="op" id="3525364">(</span><span class="ident" id="3525365">r</span>&nbsp;<span class="op" id="3525367">*</span><span class="ident" id="3525368">Reader</span><span class="op" id="3525374">)</span>&nbsp;<span class="ident" id="3525376">NextPart</span><span class="op" id="3525384">(</span><span class="op" id="3525385">)</span>&nbsp;<span class="op" id="3525387">(</span><span class="op" id="3525388">*</span><span class="ident" id="3525389">Part</span><span class="op" id="3525393">,</span>&nbsp;<span class="builtintype" id="3525395">error</span><span class="op" id="3525400">)</span>&nbsp;<span class="op" id="3525402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525405">if</span>&nbsp;<span class="ident" id="3525408">r</span><span class="op" id="3525409">.</span><span class="ident" id="3525410">currentPart</span>&nbsp;<span class="op" id="3525422">!=</span>&nbsp;<span class="ident" id="3525425">nil</span>&nbsp;<span class="op" id="3525429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525433">r</span><span class="op" id="3525434">.</span><span class="ident" id="3525435">currentPart</span><span class="op" id="3525446">.</span><span class="ident" id="3525447">Close</span><span class="op" id="3525452">(</span><span class="op" id="3525453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525456">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525460">expectNewPart</span>&nbsp;<span class="op" id="3525474">:=</span>&nbsp;<span class="builtintype" id="3525477">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525484">for</span>&nbsp;<span class="op" id="3525488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525492">line</span><span class="op" id="3525496">,</span>&nbsp;<span class="ident" id="3525498">err</span>&nbsp;<span class="op" id="3525502">:=</span>&nbsp;<span class="ident" id="3525505">r</span><span class="op" id="3525506">.</span><span class="ident" id="3525507">bufReader</span><span class="op" id="3525516">.</span><span class="ident" id="3525517">ReadSlice</span><span class="op" id="3525526">(</span><span class="string" id="3525527">&#39;\n&#39;</span><span class="op" id="3525531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525535">if</span>&nbsp;<span class="ident" id="3525538">err</span>&nbsp;<span class="op" id="3525542">==</span>&nbsp;<span class="ident" id="3525545">io</span><span class="op" id="3525547">.</span><span class="ident" id="3525548">EOF</span>&nbsp;<span class="op" id="3525552">&amp;&amp;</span>&nbsp;<span class="ident" id="3525555">r</span><span class="op" id="3525556">.</span><span class="ident" id="3525557">isFinalBoundary</span><span class="op" id="3525572">(</span><span class="ident" id="3525573">line</span><span class="op" id="3525577">)</span>&nbsp;<span class="op" id="3525579">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525584">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525639">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525693">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525750">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525809">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525834">return</span>&nbsp;<span class="ident" id="3525841">nil</span><span class="op" id="3525844">,</span>&nbsp;<span class="ident" id="3525846">io</span><span class="op" id="3525848">.</span><span class="ident" id="3525849">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525859">if</span>&nbsp;<span class="ident" id="3525862">err</span>&nbsp;<span class="op" id="3525866">!=</span>&nbsp;<span class="ident" id="3525869">nil</span>&nbsp;<span class="op" id="3525873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525878">return</span>&nbsp;<span class="ident" id="3525885">nil</span><span class="op" id="3525888">,</span>&nbsp;<span class="ident" id="3525890">fmt</span><span class="op" id="3525893">.</span><span class="ident" id="3525894">Errorf</span><span class="op" id="3525900">(</span><span class="string" id="3525901">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3525926">,</span>&nbsp;<span class="ident" id="3525928">err</span><span class="op" id="3525931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525935">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525940">if</span>&nbsp;<span class="ident" id="3525943">r</span><span class="op" id="3525944">.</span><span class="ident" id="3525945">isBoundaryDelimiterLine</span><span class="op" id="3525968">(</span><span class="ident" id="3525969">line</span><span class="op" id="3525973">)</span>&nbsp;<span class="op" id="3525975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525980">r</span><span class="op" id="3525981">.</span><span class="ident" id="3525982">partsRead</span><span class="op" id="3525991">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525997">bp</span><span class="op" id="3525999">,</span>&nbsp;<span class="ident" id="3526001">err</span>&nbsp;<span class="op" id="3526005">:=</span>&nbsp;<span class="ident" id="3526008">newPart</span><span class="op" id="3526015">(</span><span class="ident" id="3526016">r</span><span class="op" id="3526017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526022">if</span>&nbsp;<span class="ident" id="3526025">err</span>&nbsp;<span class="op" id="3526029">!=</span>&nbsp;<span class="ident" id="3526032">nil</span>&nbsp;<span class="op" id="3526036">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526042">return</span>&nbsp;<span class="ident" id="3526049">nil</span><span class="op" id="3526052">,</span>&nbsp;<span class="ident" id="3526054">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526066">r</span><span class="op" id="3526067">.</span><span class="ident" id="3526068">currentPart</span>&nbsp;<span class="op" id="3526080">=</span>&nbsp;<span class="ident" id="3526082">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526088">return</span>&nbsp;<span class="ident" id="3526095">bp</span><span class="op" id="3526097">,</span>&nbsp;<span class="ident" id="3526099">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526105">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526110">if</span>&nbsp;<span class="ident" id="3526113">r</span><span class="op" id="3526114">.</span><span class="ident" id="3526115">isFinalBoundary</span><span class="op" id="3526130">(</span><span class="ident" id="3526131">line</span><span class="op" id="3526135">)</span>&nbsp;<span class="op" id="3526137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526142">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526161">return</span>&nbsp;<span class="ident" id="3526168">nil</span><span class="op" id="3526171">,</span>&nbsp;<span class="ident" id="3526173">io</span><span class="op" id="3526175">.</span><span class="ident" id="3526176">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526182">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526187">if</span>&nbsp;<span class="ident" id="3526190">expectNewPart</span>&nbsp;<span class="op" id="3526204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526209">return</span>&nbsp;<span class="ident" id="3526216">nil</span><span class="op" id="3526219">,</span>&nbsp;<span class="ident" id="3526221">fmt</span><span class="op" id="3526224">.</span><span class="ident" id="3526225">Errorf</span><span class="op" id="3526231">(</span><span class="string" id="3526232">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3526278">,</span>&nbsp;<span class="builtintype" id="3526280">string</span><span class="op" id="3526286">(</span><span class="ident" id="3526287">line</span><span class="op" id="3526291">)</span><span class="op" id="3526292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526301">if</span>&nbsp;<span class="ident" id="3526304">r</span><span class="op" id="3526305">.</span><span class="ident" id="3526306">partsRead</span>&nbsp;<span class="op" id="3526316">==</span>&nbsp;<span class="num" id="3526319">0</span>&nbsp;<span class="op" id="3526321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526326">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526342">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526358">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526412">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526468">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526523">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526542">if</span>&nbsp;<span class="ident" id="3526545">bytes</span><span class="op" id="3526550">.</span><span class="ident" id="3526551">Equal</span><span class="op" id="3526556">(</span><span class="ident" id="3526557">line</span><span class="op" id="3526561">,</span>&nbsp;<span class="ident" id="3526563">r</span><span class="op" id="3526564">.</span><span class="ident" id="3526565">nl</span><span class="op" id="3526567">)</span>&nbsp;<span class="op" id="3526569">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526574">expectNewPart</span>&nbsp;<span class="op" id="3526588">=</span>&nbsp;<span class="builtintype" id="3526590">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526598">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526614">return</span>&nbsp;<span class="ident" id="3526621">nil</span><span class="op" id="3526624">,</span>&nbsp;<span class="ident" id="3526626">fmt</span><span class="op" id="3526629">.</span><span class="ident" id="3526630">Errorf</span><span class="op" id="3526636">(</span><span class="string" id="3526637">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3526679">,</span>&nbsp;<span class="ident" id="3526681">line</span><span class="op" id="3526685">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526688">}</span><br>
<span class="lineno"></span><span class="op" id="3526690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3526693">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3526760">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3526799">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3526843">func</span>&nbsp;<span class="op" id="3526848">(</span><span class="ident" id="3526849">mr</span>&nbsp;<span class="op" id="3526852">*</span><span class="ident" id="3526853">Reader</span><span class="op" id="3526859">)</span>&nbsp;<span class="ident" id="3526861">isFinalBoundary</span><span class="op" id="3526876">(</span><span class="ident" id="3526877">line</span>&nbsp;<span class="op" id="3526882">[</span><span class="op" id="3526883">]</span><span class="builtintype" id="3526884">byte</span><span class="op" id="3526888">)</span>&nbsp;<span class="builtintype" id="3526890">bool</span>&nbsp;<span class="op" id="3526895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526898">if</span>&nbsp;<span class="op" id="3526901">!</span><span class="ident" id="3526902">bytes</span><span class="op" id="3526907">.</span><span class="ident" id="3526908">HasPrefix</span><span class="op" id="3526917">(</span><span class="ident" id="3526918">line</span><span class="op" id="3526922">,</span>&nbsp;<span class="ident" id="3526924">mr</span><span class="op" id="3526926">.</span><span class="ident" id="3526927">dashBoundaryDash</span><span class="op" id="3526943">)</span>&nbsp;<span class="op" id="3526945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526949">return</span>&nbsp;<span class="builtintype" id="3526956">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526963">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526966">rest</span>&nbsp;<span class="op" id="3526971">:=</span>&nbsp;<span class="ident" id="3526974">line</span><span class="op" id="3526978">[</span><span class="builtinfunc" id="3526979">len</span><span class="op" id="3526982">(</span><span class="ident" id="3526983">mr</span><span class="op" id="3526985">.</span><span class="ident" id="3526986">dashBoundaryDash</span><span class="op" id="3527002">)</span><span class="op" id="3527003">:</span><span class="op" id="3527004">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527007">rest</span>&nbsp;<span class="op" id="3527012">=</span>&nbsp;<span class="ident" id="3527014">skipLWSPChar</span><span class="op" id="3527026">(</span><span class="ident" id="3527027">rest</span><span class="op" id="3527031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527034">return</span>&nbsp;<span class="builtinfunc" id="3527041">len</span><span class="op" id="3527044">(</span><span class="ident" id="3527045">rest</span><span class="op" id="3527049">)</span>&nbsp;<span class="op" id="3527051">==</span>&nbsp;<span class="num" id="3527054">0</span>&nbsp;<span class="op" id="3527056">||</span>&nbsp;<span class="ident" id="3527059">bytes</span><span class="op" id="3527064">.</span><span class="ident" id="3527065">Equal</span><span class="op" id="3527070">(</span><span class="ident" id="3527071">rest</span><span class="op" id="3527075">,</span>&nbsp;<span class="ident" id="3527077">mr</span><span class="op" id="3527079">.</span><span class="ident" id="3527080">nl</span><span class="op" id="3527082">)</span><br>
<span class="lineno"></span><span class="op" id="3527084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3527087">func</span>&nbsp;<span class="op" id="3527092">(</span><span class="ident" id="3527093">mr</span>&nbsp;<span class="op" id="3527096">*</span><span class="ident" id="3527097">Reader</span><span class="op" id="3527103">)</span>&nbsp;<span class="ident" id="3527105">isBoundaryDelimiterLine</span><span class="op" id="3527128">(</span><span class="ident" id="3527129">line</span>&nbsp;<span class="op" id="3527134">[</span><span class="op" id="3527135">]</span><span class="builtintype" id="3527136">byte</span><span class="op" id="3527140">)</span>&nbsp;<span class="op" id="3527142">(</span><span class="ident" id="3527143">ret</span>&nbsp;<span class="builtintype" id="3527147">bool</span><span class="op" id="3527151">)</span>&nbsp;<span class="op" id="3527153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527156">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527207">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527267">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527324">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527383">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527447">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527489">if</span>&nbsp;<span class="op" id="3527492">!</span><span class="ident" id="3527493">bytes</span><span class="op" id="3527498">.</span><span class="ident" id="3527499">HasPrefix</span><span class="op" id="3527508">(</span><span class="ident" id="3527509">line</span><span class="op" id="3527513">,</span>&nbsp;<span class="ident" id="3527515">mr</span><span class="op" id="3527517">.</span><span class="ident" id="3527518">dashBoundary</span><span class="op" id="3527530">)</span>&nbsp;<span class="op" id="3527532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527536">return</span>&nbsp;<span class="builtintype" id="3527543">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527550">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527553">rest</span>&nbsp;<span class="op" id="3527558">:=</span>&nbsp;<span class="ident" id="3527561">line</span><span class="op" id="3527565">[</span><span class="builtinfunc" id="3527566">len</span><span class="op" id="3527569">(</span><span class="ident" id="3527570">mr</span><span class="op" id="3527572">.</span><span class="ident" id="3527573">dashBoundary</span><span class="op" id="3527585">)</span><span class="op" id="3527586">:</span><span class="op" id="3527587">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527590">rest</span>&nbsp;<span class="op" id="3527595">=</span>&nbsp;<span class="ident" id="3527597">skipLWSPChar</span><span class="op" id="3527609">(</span><span class="ident" id="3527610">rest</span><span class="op" id="3527614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527618">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527688">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527759">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527787">if</span>&nbsp;<span class="ident" id="3527790">mr</span><span class="op" id="3527792">.</span><span class="ident" id="3527793">partsRead</span>&nbsp;<span class="op" id="3527803">==</span>&nbsp;<span class="num" id="3527806">0</span>&nbsp;<span class="op" id="3527808">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3527811">len</span><span class="op" id="3527814">(</span><span class="ident" id="3527815">rest</span><span class="op" id="3527819">)</span>&nbsp;<span class="op" id="3527821">==</span>&nbsp;<span class="num" id="3527824">1</span>&nbsp;<span class="op" id="3527826">&amp;&amp;</span>&nbsp;<span class="ident" id="3527829">rest</span><span class="op" id="3527833">[</span><span class="num" id="3527834">0</span><span class="op" id="3527835">]</span>&nbsp;<span class="op" id="3527837">==</span>&nbsp;<span class="string" id="3527840">&#39;\n&#39;</span>&nbsp;<span class="op" id="3527845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527849">mr</span><span class="op" id="3527851">.</span><span class="ident" id="3527852">nl</span>&nbsp;<span class="op" id="3527855">=</span>&nbsp;<span class="ident" id="3527857">mr</span><span class="op" id="3527859">.</span><span class="ident" id="3527860">nl</span><span class="op" id="3527862">[</span><span class="num" id="3527863">1</span><span class="op" id="3527864">:</span><span class="op" id="3527865">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527869">mr</span><span class="op" id="3527871">.</span><span class="ident" id="3527872">nlDashBoundary</span>&nbsp;<span class="op" id="3527887">=</span>&nbsp;<span class="ident" id="3527889">mr</span><span class="op" id="3527891">.</span><span class="ident" id="3527892">nlDashBoundary</span><span class="op" id="3527906">[</span><span class="num" id="3527907">1</span><span class="op" id="3527908">:</span><span class="op" id="3527909">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527912">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527915">return</span>&nbsp;<span class="ident" id="3527922">bytes</span><span class="op" id="3527927">.</span><span class="ident" id="3527928">Equal</span><span class="op" id="3527933">(</span><span class="ident" id="3527934">rest</span><span class="op" id="3527938">,</span>&nbsp;<span class="ident" id="3527940">mr</span><span class="op" id="3527942">.</span><span class="ident" id="3527943">nl</span><span class="op" id="3527945">)</span><br>
<span class="lineno"></span><span class="op" id="3527947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3527950">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3528015">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3528082">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3528153">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3528218">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3528230">//</span><br>
<span class="lineno"></span><span class="comment" id="3528233">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3528303">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3528371">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3528439">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3528483">func</span>&nbsp;<span class="op" id="3528488">(</span><span class="ident" id="3528489">mr</span>&nbsp;<span class="op" id="3528492">*</span><span class="ident" id="3528493">Reader</span><span class="op" id="3528499">)</span>&nbsp;<span class="ident" id="3528501">peekBufferIsEmptyPart</span><span class="op" id="3528522">(</span><span class="ident" id="3528523">peek</span>&nbsp;<span class="op" id="3528528">[</span><span class="op" id="3528529">]</span><span class="builtintype" id="3528530">byte</span><span class="op" id="3528534">)</span>&nbsp;<span class="builtintype" id="3528536">bool</span>&nbsp;<span class="op" id="3528541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528544">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528567">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528629">if</span>&nbsp;<span class="ident" id="3528632">bytes</span><span class="op" id="3528637">.</span><span class="ident" id="3528638">HasPrefix</span><span class="op" id="3528647">(</span><span class="ident" id="3528648">peek</span><span class="op" id="3528652">,</span>&nbsp;<span class="ident" id="3528654">mr</span><span class="op" id="3528656">.</span><span class="ident" id="3528657">dashBoundaryDash</span><span class="op" id="3528673">)</span>&nbsp;<span class="op" id="3528675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528679">rest</span>&nbsp;<span class="op" id="3528684">:=</span>&nbsp;<span class="ident" id="3528687">peek</span><span class="op" id="3528691">[</span><span class="builtinfunc" id="3528692">len</span><span class="op" id="3528695">(</span><span class="ident" id="3528696">mr</span><span class="op" id="3528698">.</span><span class="ident" id="3528699">dashBoundaryDash</span><span class="op" id="3528715">)</span><span class="op" id="3528716">:</span><span class="op" id="3528717">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528721">rest</span>&nbsp;<span class="op" id="3528726">=</span>&nbsp;<span class="ident" id="3528728">skipLWSPChar</span><span class="op" id="3528740">(</span><span class="ident" id="3528741">rest</span><span class="op" id="3528745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528749">return</span>&nbsp;<span class="ident" id="3528756">bytes</span><span class="op" id="3528761">.</span><span class="ident" id="3528762">HasPrefix</span><span class="op" id="3528771">(</span><span class="ident" id="3528772">rest</span><span class="op" id="3528776">,</span>&nbsp;<span class="ident" id="3528778">mr</span><span class="op" id="3528780">.</span><span class="ident" id="3528781">nl</span><span class="op" id="3528783">)</span>&nbsp;<span class="op" id="3528785">||</span>&nbsp;<span class="builtinfunc" id="3528788">len</span><span class="op" id="3528791">(</span><span class="ident" id="3528792">rest</span><span class="op" id="3528796">)</span>&nbsp;<span class="op" id="3528798">==</span>&nbsp;<span class="num" id="3528801">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528807">if</span>&nbsp;<span class="op" id="3528810">!</span><span class="ident" id="3528811">bytes</span><span class="op" id="3528816">.</span><span class="ident" id="3528817">HasPrefix</span><span class="op" id="3528826">(</span><span class="ident" id="3528827">peek</span><span class="op" id="3528831">,</span>&nbsp;<span class="ident" id="3528833">mr</span><span class="op" id="3528835">.</span><span class="ident" id="3528836">dashBoundary</span><span class="op" id="3528848">)</span>&nbsp;<span class="op" id="3528850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528854">return</span>&nbsp;<span class="builtintype" id="3528861">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528871">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528916">rest</span>&nbsp;<span class="op" id="3528921">:=</span>&nbsp;<span class="ident" id="3528924">peek</span><span class="op" id="3528928">[</span><span class="builtinfunc" id="3528929">len</span><span class="op" id="3528932">(</span><span class="ident" id="3528933">mr</span><span class="op" id="3528935">.</span><span class="ident" id="3528936">dashBoundary</span><span class="op" id="3528948">)</span><span class="op" id="3528949">:</span><span class="op" id="3528950">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528953">rest</span>&nbsp;<span class="op" id="3528958">=</span>&nbsp;<span class="ident" id="3528960">skipLWSPChar</span><span class="op" id="3528972">(</span><span class="ident" id="3528973">rest</span><span class="op" id="3528977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528980">return</span>&nbsp;<span class="ident" id="3528987">bytes</span><span class="op" id="3528992">.</span><span class="ident" id="3528993">HasPrefix</span><span class="op" id="3529002">(</span><span class="ident" id="3529003">rest</span><span class="op" id="3529007">,</span>&nbsp;<span class="ident" id="3529009">mr</span><span class="op" id="3529011">.</span><span class="ident" id="3529012">nl</span><span class="op" id="3529014">)</span><br>
<span class="lineno"></span><span class="op" id="3529016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3529019">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3529083">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3529103">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3529134">func</span>&nbsp;<span class="ident" id="3529139">skipLWSPChar</span><span class="op" id="3529151">(</span><span class="ident" id="3529152">b</span>&nbsp;<span class="op" id="3529154">[</span><span class="op" id="3529155">]</span><span class="builtintype" id="3529156">byte</span><span class="op" id="3529160">)</span>&nbsp;<span class="op" id="3529162">[</span><span class="op" id="3529163">]</span><span class="builtintype" id="3529164">byte</span>&nbsp;<span class="op" id="3529169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529172">for</span>&nbsp;<span class="builtinfunc" id="3529176">len</span><span class="op" id="3529179">(</span><span class="ident" id="3529180">b</span><span class="op" id="3529181">)</span>&nbsp;<span class="op" id="3529183">&gt;</span>&nbsp;<span class="num" id="3529185">0</span>&nbsp;<span class="op" id="3529187">&amp;&amp;</span>&nbsp;<span class="op" id="3529190">(</span><span class="ident" id="3529191">b</span><span class="op" id="3529192">[</span><span class="num" id="3529193">0</span><span class="op" id="3529194">]</span>&nbsp;<span class="op" id="3529196">==</span>&nbsp;<span class="string" id="3529199">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3529203">||</span>&nbsp;<span class="ident" id="3529206">b</span><span class="op" id="3529207">[</span><span class="num" id="3529208">0</span><span class="op" id="3529209">]</span>&nbsp;<span class="op" id="3529211">==</span>&nbsp;<span class="string" id="3529214">&#39;\t&#39;</span><span class="op" id="3529218">)</span>&nbsp;<span class="op" id="3529220">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529224">b</span>&nbsp;<span class="op" id="3529226">=</span>&nbsp;<span class="ident" id="3529228">b</span><span class="op" id="3529229">[</span><span class="num" id="3529230">1</span><span class="op" id="3529231">:</span><span class="op" id="3529232">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529238">return</span>&nbsp;<span class="ident" id="3529245">b</span><br>
<span class="lineno"></span><span class="op" id="3529247">}</span>
</div>
</body>
</html>
