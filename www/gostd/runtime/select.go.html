<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html" class="current">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1855877">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1855932">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1855986">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1856037">package</span>&nbsp;<span class="ident" id="1856045">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1856054">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1856121">import</span>&nbsp;<span class="string" id="1856128">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1856138">const</span>&nbsp;<span class="op" id="1856144">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856147">debugSelect</span>&nbsp;<span class="op" id="1856159">=</span>&nbsp;<span class="builtintype" id="1856161">false</span><br>
<span class="lineno"></span><span class="op" id="1856167">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1856170">var</span>&nbsp;<span class="op" id="1856174">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856177">chansendpc</span>&nbsp;<span class="op" id="1856188">=</span>&nbsp;<span class="ident" id="1856190">funcPC</span><span class="op" id="1856196">(</span><span class="ident" id="1856197">chansend</span><span class="op" id="1856205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856208">chanrecvpc</span>&nbsp;<span class="op" id="1856219">=</span>&nbsp;<span class="ident" id="1856221">funcPC</span><span class="op" id="1856227">(</span><span class="ident" id="1856228">chanrecv</span><span class="op" id="1856236">)</span><br>
<span class="lineno"></span><span class="op" id="1856238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1856241">func</span>&nbsp;<span class="ident" id="1856246">selectsize</span><span class="op" id="1856256">(</span><span class="ident" id="1856257">size</span>&nbsp;<span class="builtintype" id="1856262">uintptr</span><span class="op" id="1856269">)</span>&nbsp;<span class="builtintype" id="1856271">uintptr</span>&nbsp;<span class="op" id="1856279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856282">selsize</span>&nbsp;<span class="op" id="1856290">:=</span>&nbsp;<span class="ident" id="1856293">unsafe</span><span class="op" id="1856299">.</span><span class="ident" id="1856300">Sizeof</span><span class="op" id="1856306">(</span><span class="ident" id="1856307">_select</span><span class="op" id="1856314">{</span><span class="op" id="1856315">}</span><span class="op" id="1856316">)</span>&nbsp;<span class="op" id="1856318">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1856322">(</span><span class="ident" id="1856323">size</span><span class="op" id="1856327">-</span><span class="num" id="1856328">1</span><span class="op" id="1856329">)</span><span class="op" id="1856330">*</span><span class="ident" id="1856331">unsafe</span><span class="op" id="1856337">.</span><span class="ident" id="1856338">Sizeof</span><span class="op" id="1856344">(</span><span class="ident" id="1856345">_select</span><span class="op" id="1856352">{</span><span class="op" id="1856353">}</span><span class="op" id="1856354">.</span><span class="ident" id="1856355">scase</span><span class="op" id="1856360">[</span><span class="num" id="1856361">0</span><span class="op" id="1856362">]</span><span class="op" id="1856363">)</span>&nbsp;<span class="op" id="1856365">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856369">size</span><span class="op" id="1856373">*</span><span class="ident" id="1856374">unsafe</span><span class="op" id="1856380">.</span><span class="ident" id="1856381">Sizeof</span><span class="op" id="1856387">(</span><span class="op" id="1856388">*</span><span class="ident" id="1856389">_select</span><span class="op" id="1856396">{</span><span class="op" id="1856397">}</span><span class="op" id="1856398">.</span><span class="ident" id="1856399">lockorder</span><span class="op" id="1856408">)</span>&nbsp;<span class="op" id="1856410">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856414">size</span><span class="op" id="1856418">*</span><span class="ident" id="1856419">unsafe</span><span class="op" id="1856425">.</span><span class="ident" id="1856426">Sizeof</span><span class="op" id="1856432">(</span><span class="op" id="1856433">*</span><span class="ident" id="1856434">_select</span><span class="op" id="1856441">{</span><span class="op" id="1856442">}</span><span class="op" id="1856443">.</span><span class="ident" id="1856444">pollorder</span><span class="op" id="1856453">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1856456">return</span>&nbsp;<span class="ident" id="1856463">round</span><span class="op" id="1856468">(</span><span class="ident" id="1856469">selsize</span><span class="op" id="1856476">,</span>&nbsp;<span class="ident" id="1856478">_Int64Align</span><span class="op" id="1856489">)</span><br>
<span class="lineno"></span><span class="op" id="1856491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1856494">func</span>&nbsp;<span class="ident" id="1856499">newselect</span><span class="op" id="1856508">(</span><span class="ident" id="1856509">sel</span>&nbsp;<span class="op" id="1856513">*</span><span class="ident" id="1856514">_select</span><span class="op" id="1856521">,</span>&nbsp;<span class="ident" id="1856523">selsize</span>&nbsp;<span class="ident" id="1856531">int64</span><span class="op" id="1856536">,</span>&nbsp;<span class="ident" id="1856538">size</span>&nbsp;<span class="builtintype" id="1856543">int32</span><span class="op" id="1856548">)</span>&nbsp;<span class="op" id="1856550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1856553">if</span>&nbsp;<span class="ident" id="1856556">selsize</span>&nbsp;<span class="op" id="1856564">!=</span>&nbsp;<span class="ident" id="1856567">int64</span><span class="op" id="1856572">(</span><span class="ident" id="1856573">selectsize</span><span class="op" id="1856583">(</span><span class="builtintype" id="1856584">uintptr</span><span class="op" id="1856591">(</span><span class="ident" id="1856592">size</span><span class="op" id="1856596">)</span><span class="op" id="1856597">)</span><span class="op" id="1856598">)</span>&nbsp;<span class="op" id="1856600">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1856604">print</span><span class="op" id="1856609">(</span><span class="string" id="1856610">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1856637">,</span>&nbsp;<span class="ident" id="1856639">selsize</span><span class="op" id="1856646">,</span>&nbsp;<span class="string" id="1856648">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1856657">,</span>&nbsp;<span class="ident" id="1856659">selectsize</span><span class="op" id="1856669">(</span><span class="builtintype" id="1856670">uintptr</span><span class="op" id="1856677">(</span><span class="ident" id="1856678">size</span><span class="op" id="1856682">)</span><span class="op" id="1856683">)</span><span class="op" id="1856684">,</span>&nbsp;<span class="string" id="1856686">&#34;\n&#34;</span><span class="op" id="1856690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856694">gothrow</span><span class="op" id="1856701">(</span><span class="string" id="1856702">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1856719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1856722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856725">sel</span><span class="op" id="1856728">.</span><span class="ident" id="1856729">tcase</span>&nbsp;<span class="op" id="1856735">=</span>&nbsp;<span class="builtintype" id="1856737">uint16</span><span class="op" id="1856743">(</span><span class="ident" id="1856744">size</span><span class="op" id="1856748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856751">sel</span><span class="op" id="1856754">.</span><span class="ident" id="1856755">ncase</span>&nbsp;<span class="op" id="1856761">=</span>&nbsp;<span class="num" id="1856763">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856766">sel</span><span class="op" id="1856769">.</span><span class="ident" id="1856770">lockorder</span>&nbsp;<span class="op" id="1856780">=</span>&nbsp;<span class="op" id="1856782">(</span><span class="op" id="1856783">*</span><span class="op" id="1856784">*</span><span class="ident" id="1856785">hchan</span><span class="op" id="1856790">)</span><span class="op" id="1856791">(</span><span class="ident" id="1856792">add</span><span class="op" id="1856795">(</span><span class="ident" id="1856796">unsafe</span><span class="op" id="1856802">.</span><span class="ident" id="1856803">Pointer</span><span class="op" id="1856810">(</span><span class="op" id="1856811">&amp;</span><span class="ident" id="1856812">sel</span><span class="op" id="1856815">.</span><span class="ident" id="1856816">scase</span><span class="op" id="1856821">)</span><span class="op" id="1856822">,</span>&nbsp;<span class="builtintype" id="1856824">uintptr</span><span class="op" id="1856831">(</span><span class="ident" id="1856832">size</span><span class="op" id="1856836">)</span><span class="op" id="1856837">*</span><span class="ident" id="1856838">unsafe</span><span class="op" id="1856844">.</span><span class="ident" id="1856845">Sizeof</span><span class="op" id="1856851">(</span><span class="ident" id="1856852">_select</span><span class="op" id="1856859">{</span><span class="op" id="1856860">}</span><span class="op" id="1856861">.</span><span class="ident" id="1856862">scase</span><span class="op" id="1856867">[</span><span class="num" id="1856868">0</span><span class="op" id="1856869">]</span><span class="op" id="1856870">)</span><span class="op" id="1856871">)</span><span class="op" id="1856872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1856875">sel</span><span class="op" id="1856878">.</span><span class="ident" id="1856879">pollorder</span>&nbsp;<span class="op" id="1856889">=</span>&nbsp;<span class="op" id="1856891">(</span><span class="op" id="1856892">*</span><span class="builtintype" id="1856893">uint16</span><span class="op" id="1856899">)</span><span class="op" id="1856900">(</span><span class="ident" id="1856901">add</span><span class="op" id="1856904">(</span><span class="ident" id="1856905">unsafe</span><span class="op" id="1856911">.</span><span class="ident" id="1856912">Pointer</span><span class="op" id="1856919">(</span><span class="ident" id="1856920">sel</span><span class="op" id="1856923">.</span><span class="ident" id="1856924">lockorder</span><span class="op" id="1856933">)</span><span class="op" id="1856934">,</span>&nbsp;<span class="builtintype" id="1856936">uintptr</span><span class="op" id="1856943">(</span><span class="ident" id="1856944">size</span><span class="op" id="1856948">)</span><span class="op" id="1856949">*</span><span class="ident" id="1856950">unsafe</span><span class="op" id="1856956">.</span><span class="ident" id="1856957">Sizeof</span><span class="op" id="1856963">(</span><span class="op" id="1856964">*</span><span class="ident" id="1856965">_select</span><span class="op" id="1856972">{</span><span class="op" id="1856973">}</span><span class="op" id="1856974">.</span><span class="ident" id="1856975">lockorder</span><span class="op" id="1856984">)</span><span class="op" id="1856985">)</span><span class="op" id="1856986">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1856990">if</span>&nbsp;<span class="ident" id="1856993">debugSelect</span>&nbsp;<span class="op" id="1857005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1857009">print</span><span class="op" id="1857014">(</span><span class="string" id="1857015">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1857029">,</span>&nbsp;<span class="ident" id="1857031">sel</span><span class="op" id="1857034">,</span>&nbsp;<span class="string" id="1857036">&#34;&nbsp;size=&#34;</span><span class="op" id="1857044">,</span>&nbsp;<span class="ident" id="1857046">size</span><span class="op" id="1857050">,</span>&nbsp;<span class="string" id="1857052">&#34;\n&#34;</span><span class="op" id="1857056">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1857059">}</span><br>
<span class="lineno"></span><span class="op" id="1857061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1857064">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1857077">func</span>&nbsp;<span class="ident" id="1857082">selectsend</span><span class="op" id="1857092">(</span><span class="ident" id="1857093">sel</span>&nbsp;<span class="op" id="1857097">*</span><span class="ident" id="1857098">_select</span><span class="op" id="1857105">,</span>&nbsp;<span class="ident" id="1857107">c</span>&nbsp;<span class="op" id="1857109">*</span><span class="ident" id="1857110">hchan</span><span class="op" id="1857115">,</span>&nbsp;<span class="ident" id="1857117">elem</span>&nbsp;<span class="ident" id="1857122">unsafe</span><span class="op" id="1857128">.</span><span class="ident" id="1857129">Pointer</span><span class="op" id="1857136">)</span>&nbsp;<span class="op" id="1857138">(</span><span class="ident" id="1857139">selected</span>&nbsp;<span class="builtintype" id="1857148">bool</span><span class="op" id="1857152">)</span>&nbsp;<span class="op" id="1857154">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1857157">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1857186">if</span>&nbsp;<span class="ident" id="1857189">c</span>&nbsp;<span class="op" id="1857191">!=</span>&nbsp;<span class="ident" id="1857194">nil</span>&nbsp;<span class="op" id="1857198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857202">selectsendImpl</span><span class="op" id="1857216">(</span><span class="ident" id="1857217">sel</span><span class="op" id="1857220">,</span>&nbsp;<span class="ident" id="1857222">c</span><span class="op" id="1857223">,</span>&nbsp;<span class="ident" id="1857225">getcallerpc</span><span class="op" id="1857236">(</span><span class="ident" id="1857237">unsafe</span><span class="op" id="1857243">.</span><span class="ident" id="1857244">Pointer</span><span class="op" id="1857251">(</span><span class="op" id="1857252">&amp;</span><span class="ident" id="1857253">sel</span><span class="op" id="1857256">)</span><span class="op" id="1857257">)</span><span class="op" id="1857258">,</span>&nbsp;<span class="ident" id="1857260">elem</span><span class="op" id="1857264">,</span>&nbsp;<span class="builtintype" id="1857266">uintptr</span><span class="op" id="1857273">(</span><span class="ident" id="1857274">unsafe</span><span class="op" id="1857280">.</span><span class="ident" id="1857281">Pointer</span><span class="op" id="1857288">(</span><span class="op" id="1857289">&amp;</span><span class="ident" id="1857290">selected</span><span class="op" id="1857298">)</span><span class="op" id="1857299">)</span><span class="op" id="1857300">-</span><span class="builtintype" id="1857301">uintptr</span><span class="op" id="1857308">(</span><span class="ident" id="1857309">unsafe</span><span class="op" id="1857315">.</span><span class="ident" id="1857316">Pointer</span><span class="op" id="1857323">(</span><span class="op" id="1857324">&amp;</span><span class="ident" id="1857325">sel</span><span class="op" id="1857328">)</span><span class="op" id="1857329">)</span><span class="op" id="1857330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1857333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1857336">return</span><br>
<span class="lineno">50</span><span class="op" id="1857343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1857346">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1857393">func</span>&nbsp;<span class="ident" id="1857398">selectsendImpl</span><span class="op" id="1857412">(</span><span class="ident" id="1857413">sel</span>&nbsp;<span class="op" id="1857417">*</span><span class="ident" id="1857418">_select</span><span class="op" id="1857425">,</span>&nbsp;<span class="ident" id="1857427">c</span>&nbsp;<span class="op" id="1857429">*</span><span class="ident" id="1857430">hchan</span><span class="op" id="1857435">,</span>&nbsp;<span class="ident" id="1857437">pc</span>&nbsp;<span class="builtintype" id="1857440">uintptr</span><span class="op" id="1857447">,</span>&nbsp;<span class="ident" id="1857449">elem</span>&nbsp;<span class="ident" id="1857454">unsafe</span><span class="op" id="1857460">.</span><span class="ident" id="1857461">Pointer</span><span class="op" id="1857468">,</span>&nbsp;<span class="ident" id="1857470">so</span>&nbsp;<span class="builtintype" id="1857473">uintptr</span><span class="op" id="1857480">)</span>&nbsp;<span class="op" id="1857482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857485">i</span>&nbsp;<span class="op" id="1857487">:=</span>&nbsp;<span class="ident" id="1857490">sel</span><span class="op" id="1857493">.</span><span class="ident" id="1857494">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1857501">if</span>&nbsp;<span class="ident" id="1857504">i</span>&nbsp;<span class="op" id="1857506">&gt;=</span>&nbsp;<span class="ident" id="1857509">sel</span><span class="op" id="1857512">.</span><span class="ident" id="1857513">tcase</span>&nbsp;<span class="op" id="1857519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857523">gothrow</span><span class="op" id="1857530">(</span><span class="string" id="1857531">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1857559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1857562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857565">sel</span><span class="op" id="1857568">.</span><span class="ident" id="1857569">ncase</span>&nbsp;<span class="op" id="1857575">=</span>&nbsp;<span class="ident" id="1857577">i</span>&nbsp;<span class="op" id="1857579">+</span>&nbsp;<span class="num" id="1857581">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857584">cas</span>&nbsp;<span class="op" id="1857588">:=</span>&nbsp;<span class="op" id="1857591">(</span><span class="op" id="1857592">*</span><span class="ident" id="1857593">scase</span><span class="op" id="1857598">)</span><span class="op" id="1857599">(</span><span class="ident" id="1857600">add</span><span class="op" id="1857603">(</span><span class="ident" id="1857604">unsafe</span><span class="op" id="1857610">.</span><span class="ident" id="1857611">Pointer</span><span class="op" id="1857618">(</span><span class="op" id="1857619">&amp;</span><span class="ident" id="1857620">sel</span><span class="op" id="1857623">.</span><span class="ident" id="1857624">scase</span><span class="op" id="1857629">)</span><span class="op" id="1857630">,</span>&nbsp;<span class="builtintype" id="1857632">uintptr</span><span class="op" id="1857639">(</span><span class="ident" id="1857640">i</span><span class="op" id="1857641">)</span><span class="op" id="1857642">*</span><span class="ident" id="1857643">unsafe</span><span class="op" id="1857649">.</span><span class="ident" id="1857650">Sizeof</span><span class="op" id="1857656">(</span><span class="ident" id="1857657">sel</span><span class="op" id="1857660">.</span><span class="ident" id="1857661">scase</span><span class="op" id="1857666">[</span><span class="num" id="1857667">0</span><span class="op" id="1857668">]</span><span class="op" id="1857669">)</span><span class="op" id="1857670">)</span><span class="op" id="1857671">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857675">cas</span><span class="op" id="1857678">.</span><span class="ident" id="1857679">pc</span>&nbsp;<span class="op" id="1857682">=</span>&nbsp;<span class="ident" id="1857684">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857688">cas</span><span class="op" id="1857691">.</span><span class="ident" id="1857692">_chan</span>&nbsp;<span class="op" id="1857698">=</span>&nbsp;<span class="ident" id="1857700">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857703">cas</span><span class="op" id="1857706">.</span><span class="ident" id="1857707">so</span>&nbsp;<span class="op" id="1857710">=</span>&nbsp;<span class="builtintype" id="1857712">uint16</span><span class="op" id="1857718">(</span><span class="ident" id="1857719">so</span><span class="op" id="1857721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857724">cas</span><span class="op" id="1857727">.</span><span class="ident" id="1857728">kind</span>&nbsp;<span class="op" id="1857733">=</span>&nbsp;<span class="ident" id="1857735">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1857746">cas</span><span class="op" id="1857749">.</span><span class="ident" id="1857750">elem</span>&nbsp;<span class="op" id="1857755">=</span>&nbsp;<span class="ident" id="1857757">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1857764">if</span>&nbsp;<span class="ident" id="1857767">debugSelect</span>&nbsp;<span class="op" id="1857779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1857783">print</span><span class="op" id="1857788">(</span><span class="string" id="1857789">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1857804">,</span>&nbsp;<span class="ident" id="1857806">sel</span><span class="op" id="1857809">,</span>&nbsp;<span class="string" id="1857811">&#34;&nbsp;pc=&#34;</span><span class="op" id="1857817">,</span>&nbsp;<span class="ident" id="1857819">hex</span><span class="op" id="1857822">(</span><span class="ident" id="1857823">cas</span><span class="op" id="1857826">.</span><span class="ident" id="1857827">pc</span><span class="op" id="1857829">)</span><span class="op" id="1857830">,</span>&nbsp;<span class="string" id="1857832">&#34;&nbsp;chan=&#34;</span><span class="op" id="1857840">,</span>&nbsp;<span class="ident" id="1857842">cas</span><span class="op" id="1857845">.</span><span class="ident" id="1857846">_chan</span><span class="op" id="1857851">,</span>&nbsp;<span class="string" id="1857853">&#34;&nbsp;so=&#34;</span><span class="op" id="1857859">,</span>&nbsp;<span class="ident" id="1857861">cas</span><span class="op" id="1857864">.</span><span class="ident" id="1857865">so</span><span class="op" id="1857867">,</span>&nbsp;<span class="string" id="1857869">&#34;\n&#34;</span><span class="op" id="1857873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1857876">}</span><br>
<span class="lineno">70</span><span class="op" id="1857878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1857881">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1857894">func</span>&nbsp;<span class="ident" id="1857899">selectrecv</span><span class="op" id="1857909">(</span><span class="ident" id="1857910">sel</span>&nbsp;<span class="op" id="1857914">*</span><span class="ident" id="1857915">_select</span><span class="op" id="1857922">,</span>&nbsp;<span class="ident" id="1857924">c</span>&nbsp;<span class="op" id="1857926">*</span><span class="ident" id="1857927">hchan</span><span class="op" id="1857932">,</span>&nbsp;<span class="ident" id="1857934">elem</span>&nbsp;<span class="ident" id="1857939">unsafe</span><span class="op" id="1857945">.</span><span class="ident" id="1857946">Pointer</span><span class="op" id="1857953">)</span>&nbsp;<span class="op" id="1857955">(</span><span class="ident" id="1857956">selected</span>&nbsp;<span class="builtintype" id="1857965">bool</span><span class="op" id="1857969">)</span>&nbsp;<span class="op" id="1857971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1857974">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1858003">if</span>&nbsp;<span class="ident" id="1858006">c</span>&nbsp;<span class="op" id="1858008">!=</span>&nbsp;<span class="ident" id="1858011">nil</span>&nbsp;<span class="op" id="1858015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858019">selectrecvImpl</span><span class="op" id="1858033">(</span><span class="ident" id="1858034">sel</span><span class="op" id="1858037">,</span>&nbsp;<span class="ident" id="1858039">c</span><span class="op" id="1858040">,</span>&nbsp;<span class="ident" id="1858042">getcallerpc</span><span class="op" id="1858053">(</span><span class="ident" id="1858054">unsafe</span><span class="op" id="1858060">.</span><span class="ident" id="1858061">Pointer</span><span class="op" id="1858068">(</span><span class="op" id="1858069">&amp;</span><span class="ident" id="1858070">sel</span><span class="op" id="1858073">)</span><span class="op" id="1858074">)</span><span class="op" id="1858075">,</span>&nbsp;<span class="ident" id="1858077">elem</span><span class="op" id="1858081">,</span>&nbsp;<span class="ident" id="1858083">nil</span><span class="op" id="1858086">,</span>&nbsp;<span class="builtintype" id="1858088">uintptr</span><span class="op" id="1858095">(</span><span class="ident" id="1858096">unsafe</span><span class="op" id="1858102">.</span><span class="ident" id="1858103">Pointer</span><span class="op" id="1858110">(</span><span class="op" id="1858111">&amp;</span><span class="ident" id="1858112">selected</span><span class="op" id="1858120">)</span><span class="op" id="1858121">)</span><span class="op" id="1858122">-</span><span class="builtintype" id="1858123">uintptr</span><span class="op" id="1858130">(</span><span class="ident" id="1858131">unsafe</span><span class="op" id="1858137">.</span><span class="ident" id="1858138">Pointer</span><span class="op" id="1858145">(</span><span class="op" id="1858146">&amp;</span><span class="ident" id="1858147">sel</span><span class="op" id="1858150">)</span><span class="op" id="1858151">)</span><span class="op" id="1858152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1858155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1858158">return</span><br>
<span class="lineno"></span><span class="op" id="1858165">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1858168">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1858181">func</span>&nbsp;<span class="ident" id="1858186">selectrecv2</span><span class="op" id="1858197">(</span><span class="ident" id="1858198">sel</span>&nbsp;<span class="op" id="1858202">*</span><span class="ident" id="1858203">_select</span><span class="op" id="1858210">,</span>&nbsp;<span class="ident" id="1858212">c</span>&nbsp;<span class="op" id="1858214">*</span><span class="ident" id="1858215">hchan</span><span class="op" id="1858220">,</span>&nbsp;<span class="ident" id="1858222">elem</span>&nbsp;<span class="ident" id="1858227">unsafe</span><span class="op" id="1858233">.</span><span class="ident" id="1858234">Pointer</span><span class="op" id="1858241">,</span>&nbsp;<span class="ident" id="1858243">received</span>&nbsp;<span class="op" id="1858252">*</span><span class="builtintype" id="1858253">bool</span><span class="op" id="1858257">)</span>&nbsp;<span class="op" id="1858259">(</span><span class="ident" id="1858260">selected</span>&nbsp;<span class="builtintype" id="1858269">bool</span><span class="op" id="1858273">)</span>&nbsp;<span class="op" id="1858275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1858278">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1858307">if</span>&nbsp;<span class="ident" id="1858310">c</span>&nbsp;<span class="op" id="1858312">!=</span>&nbsp;<span class="ident" id="1858315">nil</span>&nbsp;<span class="op" id="1858319">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858323">selectrecvImpl</span><span class="op" id="1858337">(</span><span class="ident" id="1858338">sel</span><span class="op" id="1858341">,</span>&nbsp;<span class="ident" id="1858343">c</span><span class="op" id="1858344">,</span>&nbsp;<span class="ident" id="1858346">getcallerpc</span><span class="op" id="1858357">(</span><span class="ident" id="1858358">unsafe</span><span class="op" id="1858364">.</span><span class="ident" id="1858365">Pointer</span><span class="op" id="1858372">(</span><span class="op" id="1858373">&amp;</span><span class="ident" id="1858374">sel</span><span class="op" id="1858377">)</span><span class="op" id="1858378">)</span><span class="op" id="1858379">,</span>&nbsp;<span class="ident" id="1858381">elem</span><span class="op" id="1858385">,</span>&nbsp;<span class="ident" id="1858387">received</span><span class="op" id="1858395">,</span>&nbsp;<span class="builtintype" id="1858397">uintptr</span><span class="op" id="1858404">(</span><span class="ident" id="1858405">unsafe</span><span class="op" id="1858411">.</span><span class="ident" id="1858412">Pointer</span><span class="op" id="1858419">(</span><span class="op" id="1858420">&amp;</span><span class="ident" id="1858421">selected</span><span class="op" id="1858429">)</span><span class="op" id="1858430">)</span><span class="op" id="1858431">-</span><span class="builtintype" id="1858432">uintptr</span><span class="op" id="1858439">(</span><span class="ident" id="1858440">unsafe</span><span class="op" id="1858446">.</span><span class="ident" id="1858447">Pointer</span><span class="op" id="1858454">(</span><span class="op" id="1858455">&amp;</span><span class="ident" id="1858456">sel</span><span class="op" id="1858459">)</span><span class="op" id="1858460">)</span><span class="op" id="1858461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1858464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1858467">return</span><br>
<span class="lineno"></span><span class="op" id="1858474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1858477">func</span>&nbsp;<span class="ident" id="1858482">selectrecvImpl</span><span class="op" id="1858496">(</span><span class="ident" id="1858497">sel</span>&nbsp;<span class="op" id="1858501">*</span><span class="ident" id="1858502">_select</span><span class="op" id="1858509">,</span>&nbsp;<span class="ident" id="1858511">c</span>&nbsp;<span class="op" id="1858513">*</span><span class="ident" id="1858514">hchan</span><span class="op" id="1858519">,</span>&nbsp;<span class="ident" id="1858521">pc</span>&nbsp;<span class="builtintype" id="1858524">uintptr</span><span class="op" id="1858531">,</span>&nbsp;<span class="ident" id="1858533">elem</span>&nbsp;<span class="ident" id="1858538">unsafe</span><span class="op" id="1858544">.</span><span class="ident" id="1858545">Pointer</span><span class="op" id="1858552">,</span>&nbsp;<span class="ident" id="1858554">received</span>&nbsp;<span class="op" id="1858563">*</span><span class="builtintype" id="1858564">bool</span><span class="op" id="1858568">,</span>&nbsp;<span class="ident" id="1858570">so</span>&nbsp;<span class="builtintype" id="1858573">uintptr</span><span class="op" id="1858580">)</span>&nbsp;<span class="op" id="1858582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858585">i</span>&nbsp;<span class="op" id="1858587">:=</span>&nbsp;<span class="ident" id="1858590">sel</span><span class="op" id="1858593">.</span><span class="ident" id="1858594">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1858601">if</span>&nbsp;<span class="ident" id="1858604">i</span>&nbsp;<span class="op" id="1858606">&gt;=</span>&nbsp;<span class="ident" id="1858609">sel</span><span class="op" id="1858612">.</span><span class="ident" id="1858613">tcase</span>&nbsp;<span class="op" id="1858619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858623">gothrow</span><span class="op" id="1858630">(</span><span class="string" id="1858631">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1858659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1858662">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858665">sel</span><span class="op" id="1858668">.</span><span class="ident" id="1858669">ncase</span>&nbsp;<span class="op" id="1858675">=</span>&nbsp;<span class="ident" id="1858677">i</span>&nbsp;<span class="op" id="1858679">+</span>&nbsp;<span class="num" id="1858681">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858684">cas</span>&nbsp;<span class="op" id="1858688">:=</span>&nbsp;<span class="op" id="1858691">(</span><span class="op" id="1858692">*</span><span class="ident" id="1858693">scase</span><span class="op" id="1858698">)</span><span class="op" id="1858699">(</span><span class="ident" id="1858700">add</span><span class="op" id="1858703">(</span><span class="ident" id="1858704">unsafe</span><span class="op" id="1858710">.</span><span class="ident" id="1858711">Pointer</span><span class="op" id="1858718">(</span><span class="op" id="1858719">&amp;</span><span class="ident" id="1858720">sel</span><span class="op" id="1858723">.</span><span class="ident" id="1858724">scase</span><span class="op" id="1858729">)</span><span class="op" id="1858730">,</span>&nbsp;<span class="builtintype" id="1858732">uintptr</span><span class="op" id="1858739">(</span><span class="ident" id="1858740">i</span><span class="op" id="1858741">)</span><span class="op" id="1858742">*</span><span class="ident" id="1858743">unsafe</span><span class="op" id="1858749">.</span><span class="ident" id="1858750">Sizeof</span><span class="op" id="1858756">(</span><span class="ident" id="1858757">sel</span><span class="op" id="1858760">.</span><span class="ident" id="1858761">scase</span><span class="op" id="1858766">[</span><span class="num" id="1858767">0</span><span class="op" id="1858768">]</span><span class="op" id="1858769">)</span><span class="op" id="1858770">)</span><span class="op" id="1858771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858774">cas</span><span class="op" id="1858777">.</span><span class="ident" id="1858778">pc</span>&nbsp;<span class="op" id="1858781">=</span>&nbsp;<span class="ident" id="1858783">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858787">cas</span><span class="op" id="1858790">.</span><span class="ident" id="1858791">_chan</span>&nbsp;<span class="op" id="1858797">=</span>&nbsp;<span class="ident" id="1858799">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858802">cas</span><span class="op" id="1858805">.</span><span class="ident" id="1858806">so</span>&nbsp;<span class="op" id="1858809">=</span>&nbsp;<span class="builtintype" id="1858811">uint16</span><span class="op" id="1858817">(</span><span class="ident" id="1858818">so</span><span class="op" id="1858820">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858823">cas</span><span class="op" id="1858826">.</span><span class="ident" id="1858827">kind</span>&nbsp;<span class="op" id="1858832">=</span>&nbsp;<span class="ident" id="1858834">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858845">cas</span><span class="op" id="1858848">.</span><span class="ident" id="1858849">elem</span>&nbsp;<span class="op" id="1858854">=</span>&nbsp;<span class="ident" id="1858856">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1858862">cas</span><span class="op" id="1858865">.</span><span class="ident" id="1858866">receivedp</span>&nbsp;<span class="op" id="1858876">=</span>&nbsp;<span class="ident" id="1858878">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1858889">if</span>&nbsp;<span class="ident" id="1858892">debugSelect</span>&nbsp;<span class="op" id="1858904">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1858908">print</span><span class="op" id="1858913">(</span><span class="string" id="1858914">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1858929">,</span>&nbsp;<span class="ident" id="1858931">sel</span><span class="op" id="1858934">,</span>&nbsp;<span class="string" id="1858936">&#34;&nbsp;pc=&#34;</span><span class="op" id="1858942">,</span>&nbsp;<span class="ident" id="1858944">hex</span><span class="op" id="1858947">(</span><span class="ident" id="1858948">cas</span><span class="op" id="1858951">.</span><span class="ident" id="1858952">pc</span><span class="op" id="1858954">)</span><span class="op" id="1858955">,</span>&nbsp;<span class="string" id="1858957">&#34;&nbsp;chan=&#34;</span><span class="op" id="1858965">,</span>&nbsp;<span class="ident" id="1858967">cas</span><span class="op" id="1858970">.</span><span class="ident" id="1858971">_chan</span><span class="op" id="1858976">,</span>&nbsp;<span class="string" id="1858978">&#34;&nbsp;so=&#34;</span><span class="op" id="1858984">,</span>&nbsp;<span class="ident" id="1858986">cas</span><span class="op" id="1858989">.</span><span class="ident" id="1858990">so</span><span class="op" id="1858992">,</span>&nbsp;<span class="string" id="1858994">&#34;\n&#34;</span><span class="op" id="1858998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1859001">}</span><br>
<span class="lineno"></span><span class="op" id="1859003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1859006">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1859019">func</span>&nbsp;<span class="ident" id="1859024">selectdefault</span><span class="op" id="1859037">(</span><span class="ident" id="1859038">sel</span>&nbsp;<span class="op" id="1859042">*</span><span class="ident" id="1859043">_select</span><span class="op" id="1859050">)</span>&nbsp;<span class="op" id="1859052">(</span><span class="ident" id="1859053">selected</span>&nbsp;<span class="builtintype" id="1859062">bool</span><span class="op" id="1859066">)</span>&nbsp;<span class="op" id="1859068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859071">selectdefaultImpl</span><span class="op" id="1859088">(</span><span class="ident" id="1859089">sel</span><span class="op" id="1859092">,</span>&nbsp;<span class="ident" id="1859094">getcallerpc</span><span class="op" id="1859105">(</span><span class="ident" id="1859106">unsafe</span><span class="op" id="1859112">.</span><span class="ident" id="1859113">Pointer</span><span class="op" id="1859120">(</span><span class="op" id="1859121">&amp;</span><span class="ident" id="1859122">sel</span><span class="op" id="1859125">)</span><span class="op" id="1859126">)</span><span class="op" id="1859127">,</span>&nbsp;<span class="builtintype" id="1859129">uintptr</span><span class="op" id="1859136">(</span><span class="ident" id="1859137">unsafe</span><span class="op" id="1859143">.</span><span class="ident" id="1859144">Pointer</span><span class="op" id="1859151">(</span><span class="op" id="1859152">&amp;</span><span class="ident" id="1859153">selected</span><span class="op" id="1859161">)</span><span class="op" id="1859162">)</span><span class="op" id="1859163">-</span><span class="builtintype" id="1859164">uintptr</span><span class="op" id="1859171">(</span><span class="ident" id="1859172">unsafe</span><span class="op" id="1859178">.</span><span class="ident" id="1859179">Pointer</span><span class="op" id="1859186">(</span><span class="op" id="1859187">&amp;</span><span class="ident" id="1859188">sel</span><span class="op" id="1859191">)</span><span class="op" id="1859192">)</span><span class="op" id="1859193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1859196">return</span><br>
<span class="lineno"></span><span class="op" id="1859203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1859206">func</span>&nbsp;<span class="ident" id="1859211">selectdefaultImpl</span><span class="op" id="1859228">(</span><span class="ident" id="1859229">sel</span>&nbsp;<span class="op" id="1859233">*</span><span class="ident" id="1859234">_select</span><span class="op" id="1859241">,</span>&nbsp;<span class="ident" id="1859243">callerpc</span>&nbsp;<span class="builtintype" id="1859252">uintptr</span><span class="op" id="1859259">,</span>&nbsp;<span class="ident" id="1859261">so</span>&nbsp;<span class="builtintype" id="1859264">uintptr</span><span class="op" id="1859271">)</span>&nbsp;<span class="op" id="1859273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859276">i</span>&nbsp;<span class="op" id="1859278">:=</span>&nbsp;<span class="ident" id="1859281">sel</span><span class="op" id="1859284">.</span><span class="ident" id="1859285">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1859292">if</span>&nbsp;<span class="ident" id="1859295">i</span>&nbsp;<span class="op" id="1859297">&gt;=</span>&nbsp;<span class="ident" id="1859300">sel</span><span class="op" id="1859303">.</span><span class="ident" id="1859304">tcase</span>&nbsp;<span class="op" id="1859310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859314">gothrow</span><span class="op" id="1859321">(</span><span class="string" id="1859322">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1859353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1859356">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859359">sel</span><span class="op" id="1859362">.</span><span class="ident" id="1859363">ncase</span>&nbsp;<span class="op" id="1859369">=</span>&nbsp;<span class="ident" id="1859371">i</span>&nbsp;<span class="op" id="1859373">+</span>&nbsp;<span class="num" id="1859375">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859378">cas</span>&nbsp;<span class="op" id="1859382">:=</span>&nbsp;<span class="op" id="1859385">(</span><span class="op" id="1859386">*</span><span class="ident" id="1859387">scase</span><span class="op" id="1859392">)</span><span class="op" id="1859393">(</span><span class="ident" id="1859394">add</span><span class="op" id="1859397">(</span><span class="ident" id="1859398">unsafe</span><span class="op" id="1859404">.</span><span class="ident" id="1859405">Pointer</span><span class="op" id="1859412">(</span><span class="op" id="1859413">&amp;</span><span class="ident" id="1859414">sel</span><span class="op" id="1859417">.</span><span class="ident" id="1859418">scase</span><span class="op" id="1859423">)</span><span class="op" id="1859424">,</span>&nbsp;<span class="builtintype" id="1859426">uintptr</span><span class="op" id="1859433">(</span><span class="ident" id="1859434">i</span><span class="op" id="1859435">)</span><span class="op" id="1859436">*</span><span class="ident" id="1859437">unsafe</span><span class="op" id="1859443">.</span><span class="ident" id="1859444">Sizeof</span><span class="op" id="1859450">(</span><span class="ident" id="1859451">sel</span><span class="op" id="1859454">.</span><span class="ident" id="1859455">scase</span><span class="op" id="1859460">[</span><span class="num" id="1859461">0</span><span class="op" id="1859462">]</span><span class="op" id="1859463">)</span><span class="op" id="1859464">)</span><span class="op" id="1859465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859468">cas</span><span class="op" id="1859471">.</span><span class="ident" id="1859472">pc</span>&nbsp;<span class="op" id="1859475">=</span>&nbsp;<span class="ident" id="1859477">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859487">cas</span><span class="op" id="1859490">.</span><span class="ident" id="1859491">_chan</span>&nbsp;<span class="op" id="1859497">=</span>&nbsp;<span class="ident" id="1859499">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859504">cas</span><span class="op" id="1859507">.</span><span class="ident" id="1859508">so</span>&nbsp;<span class="op" id="1859511">=</span>&nbsp;<span class="builtintype" id="1859513">uint16</span><span class="op" id="1859519">(</span><span class="ident" id="1859520">so</span><span class="op" id="1859522">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859525">cas</span><span class="op" id="1859528">.</span><span class="ident" id="1859529">kind</span>&nbsp;<span class="op" id="1859534">=</span>&nbsp;<span class="ident" id="1859536">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1859551">if</span>&nbsp;<span class="ident" id="1859554">debugSelect</span>&nbsp;<span class="op" id="1859566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1859570">print</span><span class="op" id="1859575">(</span><span class="string" id="1859576">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1859594">,</span>&nbsp;<span class="ident" id="1859596">sel</span><span class="op" id="1859599">,</span>&nbsp;<span class="string" id="1859601">&#34;&nbsp;pc=&#34;</span><span class="op" id="1859607">,</span>&nbsp;<span class="ident" id="1859609">hex</span><span class="op" id="1859612">(</span><span class="ident" id="1859613">cas</span><span class="op" id="1859616">.</span><span class="ident" id="1859617">pc</span><span class="op" id="1859619">)</span><span class="op" id="1859620">,</span>&nbsp;<span class="string" id="1859622">&#34;&nbsp;so=&#34;</span><span class="op" id="1859628">,</span>&nbsp;<span class="ident" id="1859630">cas</span><span class="op" id="1859633">.</span><span class="ident" id="1859634">so</span><span class="op" id="1859636">,</span>&nbsp;<span class="string" id="1859638">&#34;\n&#34;</span><span class="op" id="1859642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1859645">}</span><br>
<span class="lineno">130</span><span class="op" id="1859647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1859650">func</span>&nbsp;<span class="ident" id="1859655">sellock</span><span class="op" id="1859662">(</span><span class="ident" id="1859663">sel</span>&nbsp;<span class="op" id="1859667">*</span><span class="ident" id="1859668">_select</span><span class="op" id="1859675">)</span>&nbsp;<span class="op" id="1859677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859680">lockslice</span>&nbsp;<span class="op" id="1859690">:=</span>&nbsp;<span class="ident" id="1859693">sliceStruct</span><span class="op" id="1859704">{</span><span class="ident" id="1859705">unsafe</span><span class="op" id="1859711">.</span><span class="ident" id="1859712">Pointer</span><span class="op" id="1859719">(</span><span class="ident" id="1859720">sel</span><span class="op" id="1859723">.</span><span class="ident" id="1859724">lockorder</span><span class="op" id="1859733">)</span><span class="op" id="1859734">,</span>&nbsp;<span class="builtintype" id="1859736">int</span><span class="op" id="1859739">(</span><span class="ident" id="1859740">sel</span><span class="op" id="1859743">.</span><span class="ident" id="1859744">ncase</span><span class="op" id="1859749">)</span><span class="op" id="1859750">,</span>&nbsp;<span class="builtintype" id="1859752">int</span><span class="op" id="1859755">(</span><span class="ident" id="1859756">sel</span><span class="op" id="1859759">.</span><span class="ident" id="1859760">ncase</span><span class="op" id="1859765">)</span><span class="op" id="1859766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859769">lockorder</span>&nbsp;<span class="op" id="1859779">:=</span>&nbsp;<span class="op" id="1859782">*</span><span class="op" id="1859783">(</span><span class="op" id="1859784">*</span><span class="op" id="1859785">[</span><span class="op" id="1859786">]</span><span class="op" id="1859787">*</span><span class="ident" id="1859788">hchan</span><span class="op" id="1859793">)</span><span class="op" id="1859794">(</span><span class="ident" id="1859795">unsafe</span><span class="op" id="1859801">.</span><span class="ident" id="1859802">Pointer</span><span class="op" id="1859809">(</span><span class="op" id="1859810">&amp;</span><span class="ident" id="1859811">lockslice</span><span class="op" id="1859820">)</span><span class="op" id="1859821">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1859824">var</span>&nbsp;<span class="ident" id="1859828">c</span>&nbsp;<span class="op" id="1859830">*</span><span class="ident" id="1859831">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1859838">for</span>&nbsp;<span class="ident" id="1859842">_</span><span class="op" id="1859843">,</span>&nbsp;<span class="ident" id="1859845">c0</span>&nbsp;<span class="op" id="1859848">:=</span>&nbsp;<span class="keyword" id="1859851">range</span>&nbsp;<span class="ident" id="1859857">lockorder</span>&nbsp;<span class="op" id="1859867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1859871">if</span>&nbsp;<span class="ident" id="1859874">c0</span>&nbsp;<span class="op" id="1859877">!=</span>&nbsp;<span class="ident" id="1859880">nil</span>&nbsp;<span class="op" id="1859884">&amp;&amp;</span>&nbsp;<span class="ident" id="1859887">c0</span>&nbsp;<span class="op" id="1859890">!=</span>&nbsp;<span class="ident" id="1859893">c</span>&nbsp;<span class="op" id="1859895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859900">c</span>&nbsp;<span class="op" id="1859902">=</span>&nbsp;<span class="ident" id="1859904">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1859910">lock</span><span class="op" id="1859914">(</span><span class="op" id="1859915">&amp;</span><span class="ident" id="1859916">c</span><span class="op" id="1859917">.</span><span class="ident" id="1859918">lock</span><span class="op" id="1859922">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1859926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1859929">}</span><br>
<span class="lineno"></span><span class="op" id="1859931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1859934">func</span>&nbsp;<span class="ident" id="1859939">selunlock</span><span class="op" id="1859948">(</span><span class="ident" id="1859949">sel</span>&nbsp;<span class="op" id="1859953">*</span><span class="ident" id="1859954">_select</span><span class="op" id="1859961">)</span>&nbsp;<span class="op" id="1859963">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1859966">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860039">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860112">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860150">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860224">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860293">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860368">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860440">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860505">n</span>&nbsp;<span class="op" id="1860507">:=</span>&nbsp;<span class="builtintype" id="1860510">int</span><span class="op" id="1860513">(</span><span class="ident" id="1860514">sel</span><span class="op" id="1860517">.</span><span class="ident" id="1860518">ncase</span><span class="op" id="1860523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860526">r</span>&nbsp;<span class="op" id="1860528">:=</span>&nbsp;<span class="num" id="1860531">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860534">lockslice</span>&nbsp;<span class="op" id="1860544">:=</span>&nbsp;<span class="ident" id="1860547">sliceStruct</span><span class="op" id="1860558">{</span><span class="ident" id="1860559">unsafe</span><span class="op" id="1860565">.</span><span class="ident" id="1860566">Pointer</span><span class="op" id="1860573">(</span><span class="ident" id="1860574">sel</span><span class="op" id="1860577">.</span><span class="ident" id="1860578">lockorder</span><span class="op" id="1860587">)</span><span class="op" id="1860588">,</span>&nbsp;<span class="ident" id="1860590">n</span><span class="op" id="1860591">,</span>&nbsp;<span class="ident" id="1860593">n</span><span class="op" id="1860594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860597">lockorder</span>&nbsp;<span class="op" id="1860607">:=</span>&nbsp;<span class="op" id="1860610">*</span><span class="op" id="1860611">(</span><span class="op" id="1860612">*</span><span class="op" id="1860613">[</span><span class="op" id="1860614">]</span><span class="op" id="1860615">*</span><span class="ident" id="1860616">hchan</span><span class="op" id="1860621">)</span><span class="op" id="1860622">(</span><span class="ident" id="1860623">unsafe</span><span class="op" id="1860629">.</span><span class="ident" id="1860630">Pointer</span><span class="op" id="1860637">(</span><span class="op" id="1860638">&amp;</span><span class="ident" id="1860639">lockslice</span><span class="op" id="1860648">)</span><span class="op" id="1860649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1860652">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1860678">if</span>&nbsp;<span class="ident" id="1860681">n</span>&nbsp;<span class="op" id="1860683">&gt;</span>&nbsp;<span class="num" id="1860685">0</span>&nbsp;<span class="op" id="1860687">&amp;&amp;</span>&nbsp;<span class="ident" id="1860690">lockorder</span><span class="op" id="1860699">[</span><span class="num" id="1860700">0</span><span class="op" id="1860701">]</span>&nbsp;<span class="op" id="1860703">==</span>&nbsp;<span class="ident" id="1860706">nil</span>&nbsp;<span class="op" id="1860710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860714">r</span>&nbsp;<span class="op" id="1860716">=</span>&nbsp;<span class="num" id="1860718">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1860721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1860724">for</span>&nbsp;<span class="ident" id="1860728">i</span>&nbsp;<span class="op" id="1860730">:=</span>&nbsp;<span class="ident" id="1860733">n</span>&nbsp;<span class="op" id="1860735">-</span>&nbsp;<span class="num" id="1860737">1</span><span class="op" id="1860738">;</span>&nbsp;<span class="ident" id="1860740">i</span>&nbsp;<span class="op" id="1860742">&gt;=</span>&nbsp;<span class="ident" id="1860745">r</span><span class="op" id="1860746">;</span>&nbsp;<span class="ident" id="1860748">i</span><span class="op" id="1860749">--</span>&nbsp;<span class="op" id="1860752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860756">c</span>&nbsp;<span class="op" id="1860758">:=</span>&nbsp;<span class="ident" id="1860761">lockorder</span><span class="op" id="1860770">[</span><span class="ident" id="1860771">i</span><span class="op" id="1860772">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1860776">if</span>&nbsp;<span class="ident" id="1860779">i</span>&nbsp;<span class="op" id="1860781">&gt;</span>&nbsp;<span class="num" id="1860783">0</span>&nbsp;<span class="op" id="1860785">&amp;&amp;</span>&nbsp;<span class="ident" id="1860788">c</span>&nbsp;<span class="op" id="1860790">==</span>&nbsp;<span class="ident" id="1860793">lockorder</span><span class="op" id="1860802">[</span><span class="ident" id="1860803">i</span><span class="op" id="1860804">-</span><span class="num" id="1860805">1</span><span class="op" id="1860806">]</span>&nbsp;<span class="op" id="1860808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1860813">continue</span>&nbsp;<span class="comment" id="1860822">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1860864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860868">unlock</span><span class="op" id="1860874">(</span><span class="op" id="1860875">&amp;</span><span class="ident" id="1860876">c</span><span class="op" id="1860877">.</span><span class="ident" id="1860878">lock</span><span class="op" id="1860882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1860885">}</span><br>
<span class="lineno"></span><span class="op" id="1860887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1860890">func</span>&nbsp;<span class="ident" id="1860895">selparkcommit</span><span class="op" id="1860908">(</span><span class="ident" id="1860909">gp</span>&nbsp;<span class="op" id="1860912">*</span><span class="ident" id="1860913">g</span><span class="op" id="1860914">,</span>&nbsp;<span class="ident" id="1860916">sel</span>&nbsp;<span class="op" id="1860920">*</span><span class="ident" id="1860921">_select</span><span class="op" id="1860928">)</span>&nbsp;<span class="builtintype" id="1860930">bool</span>&nbsp;<span class="op" id="1860935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860938">selunlock</span><span class="op" id="1860947">(</span><span class="ident" id="1860948">sel</span><span class="op" id="1860951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1860954">return</span>&nbsp;<span class="builtintype" id="1860961">true</span><br>
<span class="lineno"></span><span class="op" id="1860966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1860969">func</span>&nbsp;<span class="ident" id="1860974">block</span><span class="op" id="1860979">(</span><span class="op" id="1860980">)</span>&nbsp;<span class="op" id="1860982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1860985">gopark</span><span class="op" id="1860991">(</span><span class="ident" id="1860992">nil</span><span class="op" id="1860995">,</span>&nbsp;<span class="ident" id="1860997">nil</span><span class="op" id="1861000">,</span>&nbsp;<span class="string" id="1861002">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1861021">)</span>&nbsp;<span class="comment" id="1861023">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1861034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1861037">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1861105">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1861162">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1861175">func</span>&nbsp;<span class="ident" id="1861180">selectgo</span><span class="op" id="1861188">(</span><span class="ident" id="1861189">sel</span>&nbsp;<span class="op" id="1861193">*</span><span class="ident" id="1861194">_select</span><span class="op" id="1861201">)</span>&nbsp;<span class="op" id="1861203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1861206">pc</span><span class="op" id="1861208">,</span>&nbsp;<span class="ident" id="1861210">offset</span>&nbsp;<span class="op" id="1861217">:=</span>&nbsp;<span class="ident" id="1861220">selectgoImpl</span><span class="op" id="1861232">(</span><span class="ident" id="1861233">sel</span><span class="op" id="1861236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1861239">*</span><span class="op" id="1861240">(</span><span class="op" id="1861241">*</span><span class="builtintype" id="1861242">bool</span><span class="op" id="1861246">)</span><span class="op" id="1861247">(</span><span class="ident" id="1861248">add</span><span class="op" id="1861251">(</span><span class="ident" id="1861252">unsafe</span><span class="op" id="1861258">.</span><span class="ident" id="1861259">Pointer</span><span class="op" id="1861266">(</span><span class="op" id="1861267">&amp;</span><span class="ident" id="1861268">sel</span><span class="op" id="1861271">)</span><span class="op" id="1861272">,</span>&nbsp;<span class="builtintype" id="1861274">uintptr</span><span class="op" id="1861281">(</span><span class="ident" id="1861282">offset</span><span class="op" id="1861288">)</span><span class="op" id="1861289">)</span><span class="op" id="1861290">)</span>&nbsp;<span class="op" id="1861292">=</span>&nbsp;<span class="builtintype" id="1861294">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1861300">setcallerpc</span><span class="op" id="1861311">(</span><span class="ident" id="1861312">unsafe</span><span class="op" id="1861318">.</span><span class="ident" id="1861319">Pointer</span><span class="op" id="1861326">(</span><span class="op" id="1861327">&amp;</span><span class="ident" id="1861328">sel</span><span class="op" id="1861331">)</span><span class="op" id="1861332">,</span>&nbsp;<span class="ident" id="1861334">pc</span><span class="op" id="1861336">)</span><br>
<span class="lineno"></span><span class="op" id="1861338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1861341">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1861402">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1861423">func</span>&nbsp;<span class="ident" id="1861428">selectgoImpl</span><span class="op" id="1861440">(</span><span class="ident" id="1861441">sel</span>&nbsp;<span class="op" id="1861445">*</span><span class="ident" id="1861446">_select</span><span class="op" id="1861453">)</span>&nbsp;<span class="op" id="1861455">(</span><span class="builtintype" id="1861456">uintptr</span><span class="op" id="1861463">,</span>&nbsp;<span class="builtintype" id="1861465">uint16</span><span class="op" id="1861471">)</span>&nbsp;<span class="op" id="1861473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1861476">if</span>&nbsp;<span class="ident" id="1861479">debugSelect</span>&nbsp;<span class="op" id="1861491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1861495">print</span><span class="op" id="1861500">(</span><span class="string" id="1861501">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1861515">,</span>&nbsp;<span class="ident" id="1861517">sel</span><span class="op" id="1861520">,</span>&nbsp;<span class="string" id="1861522">&#34;\n&#34;</span><span class="op" id="1861526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1861529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1861533">scaseslice</span>&nbsp;<span class="op" id="1861544">:=</span>&nbsp;<span class="ident" id="1861547">sliceStruct</span><span class="op" id="1861558">{</span><span class="ident" id="1861559">unsafe</span><span class="op" id="1861565">.</span><span class="ident" id="1861566">Pointer</span><span class="op" id="1861573">(</span><span class="op" id="1861574">&amp;</span><span class="ident" id="1861575">sel</span><span class="op" id="1861578">.</span><span class="ident" id="1861579">scase</span><span class="op" id="1861584">)</span><span class="op" id="1861585">,</span>&nbsp;<span class="builtintype" id="1861587">int</span><span class="op" id="1861590">(</span><span class="ident" id="1861591">sel</span><span class="op" id="1861594">.</span><span class="ident" id="1861595">ncase</span><span class="op" id="1861600">)</span><span class="op" id="1861601">,</span>&nbsp;<span class="builtintype" id="1861603">int</span><span class="op" id="1861606">(</span><span class="ident" id="1861607">sel</span><span class="op" id="1861610">.</span><span class="ident" id="1861611">ncase</span><span class="op" id="1861616">)</span><span class="op" id="1861617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1861620">scases</span>&nbsp;<span class="op" id="1861627">:=</span>&nbsp;<span class="op" id="1861630">*</span><span class="op" id="1861631">(</span><span class="op" id="1861632">*</span><span class="op" id="1861633">[</span><span class="op" id="1861634">]</span><span class="ident" id="1861635">scase</span><span class="op" id="1861640">)</span><span class="op" id="1861641">(</span><span class="ident" id="1861642">unsafe</span><span class="op" id="1861648">.</span><span class="ident" id="1861649">Pointer</span><span class="op" id="1861656">(</span><span class="op" id="1861657">&amp;</span><span class="ident" id="1861658">scaseslice</span><span class="op" id="1861668">)</span><span class="op" id="1861669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1861673">var</span>&nbsp;<span class="ident" id="1861677">t0</span>&nbsp;<span class="ident" id="1861680">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1861687">if</span>&nbsp;<span class="ident" id="1861690">blockprofilerate</span>&nbsp;<span class="op" id="1861707">&gt;</span>&nbsp;<span class="num" id="1861709">0</span>&nbsp;<span class="op" id="1861711">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1861715">t0</span>&nbsp;<span class="op" id="1861718">=</span>&nbsp;<span class="ident" id="1861720">cputicks</span><span class="op" id="1861728">(</span><span class="op" id="1861729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1861733">for</span>&nbsp;<span class="ident" id="1861737">i</span>&nbsp;<span class="op" id="1861739">:=</span>&nbsp;<span class="num" id="1861742">0</span><span class="op" id="1861743">;</span>&nbsp;<span class="ident" id="1861745">i</span>&nbsp;<span class="op" id="1861747">&lt;</span>&nbsp;<span class="builtintype" id="1861749">int</span><span class="op" id="1861752">(</span><span class="ident" id="1861753">sel</span><span class="op" id="1861756">.</span><span class="ident" id="1861757">ncase</span><span class="op" id="1861762">)</span><span class="op" id="1861763">;</span>&nbsp;<span class="ident" id="1861765">i</span><span class="op" id="1861766">++</span>&nbsp;<span class="op" id="1861769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1861774">scases</span><span class="op" id="1861780">[</span><span class="ident" id="1861781">i</span><span class="op" id="1861782">]</span><span class="op" id="1861783">.</span><span class="ident" id="1861784">releasetime</span>&nbsp;<span class="op" id="1861796">=</span>&nbsp;<span class="op" id="1861798">-</span><span class="num" id="1861799">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1861803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1861806">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1861810">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1861865">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1861925">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1861982">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1862044">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1862102">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1862162">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1862201">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862229">pollslice</span>&nbsp;<span class="op" id="1862239">:=</span>&nbsp;<span class="ident" id="1862242">sliceStruct</span><span class="op" id="1862253">{</span><span class="ident" id="1862254">unsafe</span><span class="op" id="1862260">.</span><span class="ident" id="1862261">Pointer</span><span class="op" id="1862268">(</span><span class="ident" id="1862269">sel</span><span class="op" id="1862272">.</span><span class="ident" id="1862273">pollorder</span><span class="op" id="1862282">)</span><span class="op" id="1862283">,</span>&nbsp;<span class="builtintype" id="1862285">int</span><span class="op" id="1862288">(</span><span class="ident" id="1862289">sel</span><span class="op" id="1862292">.</span><span class="ident" id="1862293">ncase</span><span class="op" id="1862298">)</span><span class="op" id="1862299">,</span>&nbsp;<span class="builtintype" id="1862301">int</span><span class="op" id="1862304">(</span><span class="ident" id="1862305">sel</span><span class="op" id="1862308">.</span><span class="ident" id="1862309">ncase</span><span class="op" id="1862314">)</span><span class="op" id="1862315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862318">pollorder</span>&nbsp;<span class="op" id="1862328">:=</span>&nbsp;<span class="op" id="1862331">*</span><span class="op" id="1862332">(</span><span class="op" id="1862333">*</span><span class="op" id="1862334">[</span><span class="op" id="1862335">]</span><span class="builtintype" id="1862336">uint16</span><span class="op" id="1862342">)</span><span class="op" id="1862343">(</span><span class="ident" id="1862344">unsafe</span><span class="op" id="1862350">.</span><span class="ident" id="1862351">Pointer</span><span class="op" id="1862358">(</span><span class="op" id="1862359">&amp;</span><span class="ident" id="1862360">pollslice</span><span class="op" id="1862369">)</span><span class="op" id="1862370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1862373">for</span>&nbsp;<span class="ident" id="1862377">i</span>&nbsp;<span class="op" id="1862379">:=</span>&nbsp;<span class="num" id="1862382">0</span><span class="op" id="1862383">;</span>&nbsp;<span class="ident" id="1862385">i</span>&nbsp;<span class="op" id="1862387">&lt;</span>&nbsp;<span class="builtintype" id="1862389">int</span><span class="op" id="1862392">(</span><span class="ident" id="1862393">sel</span><span class="op" id="1862396">.</span><span class="ident" id="1862397">ncase</span><span class="op" id="1862402">)</span><span class="op" id="1862403">;</span>&nbsp;<span class="ident" id="1862405">i</span><span class="op" id="1862406">++</span>&nbsp;<span class="op" id="1862409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862413">pollorder</span><span class="op" id="1862422">[</span><span class="ident" id="1862423">i</span><span class="op" id="1862424">]</span>&nbsp;<span class="op" id="1862426">=</span>&nbsp;<span class="builtintype" id="1862428">uint16</span><span class="op" id="1862434">(</span><span class="ident" id="1862435">i</span><span class="op" id="1862436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1862439">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1862442">for</span>&nbsp;<span class="ident" id="1862446">i</span>&nbsp;<span class="op" id="1862448">:=</span>&nbsp;<span class="num" id="1862451">1</span><span class="op" id="1862452">;</span>&nbsp;<span class="ident" id="1862454">i</span>&nbsp;<span class="op" id="1862456">&lt;</span>&nbsp;<span class="builtintype" id="1862458">int</span><span class="op" id="1862461">(</span><span class="ident" id="1862462">sel</span><span class="op" id="1862465">.</span><span class="ident" id="1862466">ncase</span><span class="op" id="1862471">)</span><span class="op" id="1862472">;</span>&nbsp;<span class="ident" id="1862474">i</span><span class="op" id="1862475">++</span>&nbsp;<span class="op" id="1862478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862482">o</span>&nbsp;<span class="op" id="1862484">:=</span>&nbsp;<span class="ident" id="1862487">pollorder</span><span class="op" id="1862496">[</span><span class="ident" id="1862497">i</span><span class="op" id="1862498">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862502">j</span>&nbsp;<span class="op" id="1862504">:=</span>&nbsp;<span class="builtintype" id="1862507">int</span><span class="op" id="1862510">(</span><span class="ident" id="1862511">fastrand1</span><span class="op" id="1862520">(</span><span class="op" id="1862521">)</span><span class="op" id="1862522">)</span>&nbsp;<span class="op" id="1862524">%</span>&nbsp;<span class="op" id="1862526">(</span><span class="ident" id="1862527">i</span>&nbsp;<span class="op" id="1862529">+</span>&nbsp;<span class="num" id="1862531">1</span><span class="op" id="1862532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862536">pollorder</span><span class="op" id="1862545">[</span><span class="ident" id="1862546">i</span><span class="op" id="1862547">]</span>&nbsp;<span class="op" id="1862549">=</span>&nbsp;<span class="ident" id="1862551">pollorder</span><span class="op" id="1862560">[</span><span class="ident" id="1862561">j</span><span class="op" id="1862562">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862566">pollorder</span><span class="op" id="1862575">[</span><span class="ident" id="1862576">j</span><span class="op" id="1862577">]</span>&nbsp;<span class="op" id="1862579">=</span>&nbsp;<span class="ident" id="1862581">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1862584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1862588">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1862650">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862728">lockslice</span>&nbsp;<span class="op" id="1862738">:=</span>&nbsp;<span class="ident" id="1862741">sliceStruct</span><span class="op" id="1862752">{</span><span class="ident" id="1862753">unsafe</span><span class="op" id="1862759">.</span><span class="ident" id="1862760">Pointer</span><span class="op" id="1862767">(</span><span class="ident" id="1862768">sel</span><span class="op" id="1862771">.</span><span class="ident" id="1862772">lockorder</span><span class="op" id="1862781">)</span><span class="op" id="1862782">,</span>&nbsp;<span class="builtintype" id="1862784">int</span><span class="op" id="1862787">(</span><span class="ident" id="1862788">sel</span><span class="op" id="1862791">.</span><span class="ident" id="1862792">ncase</span><span class="op" id="1862797">)</span><span class="op" id="1862798">,</span>&nbsp;<span class="builtintype" id="1862800">int</span><span class="op" id="1862803">(</span><span class="ident" id="1862804">sel</span><span class="op" id="1862807">.</span><span class="ident" id="1862808">ncase</span><span class="op" id="1862813">)</span><span class="op" id="1862814">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862817">lockorder</span>&nbsp;<span class="op" id="1862827">:=</span>&nbsp;<span class="op" id="1862830">*</span><span class="op" id="1862831">(</span><span class="op" id="1862832">*</span><span class="op" id="1862833">[</span><span class="op" id="1862834">]</span><span class="op" id="1862835">*</span><span class="ident" id="1862836">hchan</span><span class="op" id="1862841">)</span><span class="op" id="1862842">(</span><span class="ident" id="1862843">unsafe</span><span class="op" id="1862849">.</span><span class="ident" id="1862850">Pointer</span><span class="op" id="1862857">(</span><span class="op" id="1862858">&amp;</span><span class="ident" id="1862859">lockslice</span><span class="op" id="1862868">)</span><span class="op" id="1862869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1862872">for</span>&nbsp;<span class="ident" id="1862876">i</span>&nbsp;<span class="op" id="1862878">:=</span>&nbsp;<span class="num" id="1862881">0</span><span class="op" id="1862882">;</span>&nbsp;<span class="ident" id="1862884">i</span>&nbsp;<span class="op" id="1862886">&lt;</span>&nbsp;<span class="builtintype" id="1862888">int</span><span class="op" id="1862891">(</span><span class="ident" id="1862892">sel</span><span class="op" id="1862895">.</span><span class="ident" id="1862896">ncase</span><span class="op" id="1862901">)</span><span class="op" id="1862902">;</span>&nbsp;<span class="ident" id="1862904">i</span><span class="op" id="1862905">++</span>&nbsp;<span class="op" id="1862908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862912">j</span>&nbsp;<span class="op" id="1862914">:=</span>&nbsp;<span class="ident" id="1862917">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1862921">c</span>&nbsp;<span class="op" id="1862923">:=</span>&nbsp;<span class="ident" id="1862926">scases</span><span class="op" id="1862932">[</span><span class="ident" id="1862933">j</span><span class="op" id="1862934">]</span><span class="op" id="1862935">.</span><span class="ident" id="1862936">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1862944">for</span>&nbsp;<span class="ident" id="1862948">j</span>&nbsp;<span class="op" id="1862950">&gt;</span>&nbsp;<span class="num" id="1862952">0</span>&nbsp;<span class="op" id="1862954">&amp;&amp;</span>&nbsp;<span class="ident" id="1862957">lockorder</span><span class="op" id="1862966">[</span><span class="op" id="1862967">(</span><span class="ident" id="1862968">j</span><span class="op" id="1862969">-</span><span class="num" id="1862970">1</span><span class="op" id="1862971">)</span><span class="op" id="1862972">/</span><span class="num" id="1862973">2</span><span class="op" id="1862974">]</span><span class="op" id="1862975">.</span><span class="ident" id="1862976">sortkey</span><span class="op" id="1862983">(</span><span class="op" id="1862984">)</span>&nbsp;<span class="op" id="1862986">&lt;</span>&nbsp;<span class="ident" id="1862988">c</span><span class="op" id="1862989">.</span><span class="ident" id="1862990">sortkey</span><span class="op" id="1862997">(</span><span class="op" id="1862998">)</span>&nbsp;<span class="op" id="1863000">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863005">k</span>&nbsp;<span class="op" id="1863007">:=</span>&nbsp;<span class="op" id="1863010">(</span><span class="ident" id="1863011">j</span>&nbsp;<span class="op" id="1863013">-</span>&nbsp;<span class="num" id="1863015">1</span><span class="op" id="1863016">)</span>&nbsp;<span class="op" id="1863018">/</span>&nbsp;<span class="num" id="1863020">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863025">lockorder</span><span class="op" id="1863034">[</span><span class="ident" id="1863035">j</span><span class="op" id="1863036">]</span>&nbsp;<span class="op" id="1863038">=</span>&nbsp;<span class="ident" id="1863040">lockorder</span><span class="op" id="1863049">[</span><span class="ident" id="1863050">k</span><span class="op" id="1863051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863056">j</span>&nbsp;<span class="op" id="1863058">=</span>&nbsp;<span class="ident" id="1863060">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863068">lockorder</span><span class="op" id="1863077">[</span><span class="ident" id="1863078">j</span><span class="op" id="1863079">]</span>&nbsp;<span class="op" id="1863081">=</span>&nbsp;<span class="ident" id="1863083">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863089">for</span>&nbsp;<span class="ident" id="1863093">i</span>&nbsp;<span class="op" id="1863095">:=</span>&nbsp;<span class="builtintype" id="1863098">int</span><span class="op" id="1863101">(</span><span class="ident" id="1863102">sel</span><span class="op" id="1863105">.</span><span class="ident" id="1863106">ncase</span><span class="op" id="1863111">)</span>&nbsp;<span class="op" id="1863113">-</span>&nbsp;<span class="num" id="1863115">1</span><span class="op" id="1863116">;</span>&nbsp;<span class="ident" id="1863118">i</span>&nbsp;<span class="op" id="1863120">&gt;=</span>&nbsp;<span class="num" id="1863123">0</span><span class="op" id="1863124">;</span>&nbsp;<span class="ident" id="1863126">i</span><span class="op" id="1863127">--</span>&nbsp;<span class="op" id="1863130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863134">c</span>&nbsp;<span class="op" id="1863136">:=</span>&nbsp;<span class="ident" id="1863139">lockorder</span><span class="op" id="1863148">[</span><span class="ident" id="1863149">i</span><span class="op" id="1863150">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863154">lockorder</span><span class="op" id="1863163">[</span><span class="ident" id="1863164">i</span><span class="op" id="1863165">]</span>&nbsp;<span class="op" id="1863167">=</span>&nbsp;<span class="ident" id="1863169">lockorder</span><span class="op" id="1863178">[</span><span class="num" id="1863179">0</span><span class="op" id="1863180">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863184">j</span>&nbsp;<span class="op" id="1863186">:=</span>&nbsp;<span class="num" id="1863189">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863193">for</span>&nbsp;<span class="op" id="1863197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863202">k</span>&nbsp;<span class="op" id="1863204">:=</span>&nbsp;<span class="ident" id="1863207">j</span><span class="op" id="1863208">*</span><span class="num" id="1863209">2</span>&nbsp;<span class="op" id="1863211">+</span>&nbsp;<span class="num" id="1863213">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863218">if</span>&nbsp;<span class="ident" id="1863221">k</span>&nbsp;<span class="op" id="1863223">&gt;=</span>&nbsp;<span class="ident" id="1863226">i</span>&nbsp;<span class="op" id="1863228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863234">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863243">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863248">if</span>&nbsp;<span class="ident" id="1863251">k</span><span class="op" id="1863252">+</span><span class="num" id="1863253">1</span>&nbsp;<span class="op" id="1863255">&lt;</span>&nbsp;<span class="ident" id="1863257">i</span>&nbsp;<span class="op" id="1863259">&amp;&amp;</span>&nbsp;<span class="ident" id="1863262">lockorder</span><span class="op" id="1863271">[</span><span class="ident" id="1863272">k</span><span class="op" id="1863273">]</span><span class="op" id="1863274">.</span><span class="ident" id="1863275">sortkey</span><span class="op" id="1863282">(</span><span class="op" id="1863283">)</span>&nbsp;<span class="op" id="1863285">&lt;</span>&nbsp;<span class="ident" id="1863287">lockorder</span><span class="op" id="1863296">[</span><span class="ident" id="1863297">k</span><span class="op" id="1863298">+</span><span class="num" id="1863299">1</span><span class="op" id="1863300">]</span><span class="op" id="1863301">.</span><span class="ident" id="1863302">sortkey</span><span class="op" id="1863309">(</span><span class="op" id="1863310">)</span>&nbsp;<span class="op" id="1863312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863318">k</span><span class="op" id="1863319">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863330">if</span>&nbsp;<span class="ident" id="1863333">c</span><span class="op" id="1863334">.</span><span class="ident" id="1863335">sortkey</span><span class="op" id="1863342">(</span><span class="op" id="1863343">)</span>&nbsp;<span class="op" id="1863345">&lt;</span>&nbsp;<span class="ident" id="1863347">lockorder</span><span class="op" id="1863356">[</span><span class="ident" id="1863357">k</span><span class="op" id="1863358">]</span><span class="op" id="1863359">.</span><span class="ident" id="1863360">sortkey</span><span class="op" id="1863367">(</span><span class="op" id="1863368">)</span>&nbsp;<span class="op" id="1863370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863376">lockorder</span><span class="op" id="1863385">[</span><span class="ident" id="1863386">j</span><span class="op" id="1863387">]</span>&nbsp;<span class="op" id="1863389">=</span>&nbsp;<span class="ident" id="1863391">lockorder</span><span class="op" id="1863400">[</span><span class="ident" id="1863401">k</span><span class="op" id="1863402">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863408">j</span>&nbsp;<span class="op" id="1863410">=</span>&nbsp;<span class="ident" id="1863412">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863418">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863435">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863443">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863447">lockorder</span><span class="op" id="1863456">[</span><span class="ident" id="1863457">j</span><span class="op" id="1863458">]</span>&nbsp;<span class="op" id="1863460">=</span>&nbsp;<span class="ident" id="1863462">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1863468">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1863690">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863739">sellock</span><span class="op" id="1863746">(</span><span class="ident" id="1863747">sel</span><span class="op" id="1863750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863754">var</span>&nbsp;<span class="op" id="1863758">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863762">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1863769">*</span><span class="ident" id="1863770">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863774">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1863781">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863790">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1863797">*</span><span class="ident" id="1863798">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863806">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1863813">*</span><span class="ident" id="1863814">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863822">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1863829">*</span><span class="ident" id="1863830">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863838">sglist</span>&nbsp;<span class="op" id="1863845">*</span><span class="ident" id="1863846">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863854">sgnext</span>&nbsp;<span class="op" id="1863861">*</span><span class="ident" id="1863862">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1863869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1863872">loop</span><span class="op" id="1863876">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1863879">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863927">var</span>&nbsp;<span class="ident" id="1863931">dfl</span>&nbsp;<span class="op" id="1863935">*</span><span class="ident" id="1863936">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863943">var</span>&nbsp;<span class="ident" id="1863947">cas</span>&nbsp;<span class="op" id="1863951">*</span><span class="ident" id="1863952">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1863959">for</span>&nbsp;<span class="ident" id="1863963">i</span>&nbsp;<span class="op" id="1863965">:=</span>&nbsp;<span class="num" id="1863968">0</span><span class="op" id="1863969">;</span>&nbsp;<span class="ident" id="1863971">i</span>&nbsp;<span class="op" id="1863973">&lt;</span>&nbsp;<span class="builtintype" id="1863975">int</span><span class="op" id="1863978">(</span><span class="ident" id="1863979">sel</span><span class="op" id="1863982">.</span><span class="ident" id="1863983">ncase</span><span class="op" id="1863988">)</span><span class="op" id="1863989">;</span>&nbsp;<span class="ident" id="1863991">i</span><span class="op" id="1863992">++</span>&nbsp;<span class="op" id="1863995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1863999">cas</span>&nbsp;<span class="op" id="1864003">=</span>&nbsp;<span class="op" id="1864005">&amp;</span><span class="ident" id="1864006">scases</span><span class="op" id="1864012">[</span><span class="ident" id="1864013">pollorder</span><span class="op" id="1864022">[</span><span class="ident" id="1864023">i</span><span class="op" id="1864024">]</span><span class="op" id="1864025">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864029">c</span>&nbsp;<span class="op" id="1864031">=</span>&nbsp;<span class="ident" id="1864033">cas</span><span class="op" id="1864036">.</span><span class="ident" id="1864037">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864046">switch</span>&nbsp;<span class="ident" id="1864053">cas</span><span class="op" id="1864056">.</span><span class="ident" id="1864057">kind</span>&nbsp;<span class="op" id="1864062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864066">case</span>&nbsp;<span class="ident" id="1864071">_CaseRecv</span><span class="op" id="1864080">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864085">if</span>&nbsp;<span class="ident" id="1864088">c</span><span class="op" id="1864089">.</span><span class="ident" id="1864090">dataqsiz</span>&nbsp;<span class="op" id="1864099">&gt;</span>&nbsp;<span class="num" id="1864101">0</span>&nbsp;<span class="op" id="1864103">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864109">if</span>&nbsp;<span class="ident" id="1864112">c</span><span class="op" id="1864113">.</span><span class="ident" id="1864114">qcount</span>&nbsp;<span class="op" id="1864121">&gt;</span>&nbsp;<span class="num" id="1864123">0</span>&nbsp;<span class="op" id="1864125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864132">goto</span>&nbsp;<span class="ident" id="1864137">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864156">}</span>&nbsp;<span class="keyword" id="1864158">else</span>&nbsp;<span class="op" id="1864163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864169">sg</span>&nbsp;<span class="op" id="1864172">=</span>&nbsp;<span class="ident" id="1864174">c</span><span class="op" id="1864175">.</span><span class="ident" id="1864176">sendq</span><span class="op" id="1864181">.</span><span class="ident" id="1864182">dequeue</span><span class="op" id="1864189">(</span><span class="op" id="1864190">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864196">if</span>&nbsp;<span class="ident" id="1864199">sg</span>&nbsp;<span class="op" id="1864202">!=</span>&nbsp;<span class="ident" id="1864205">nil</span>&nbsp;<span class="op" id="1864209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864216">goto</span>&nbsp;<span class="ident" id="1864221">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864244">if</span>&nbsp;<span class="ident" id="1864247">c</span><span class="op" id="1864248">.</span><span class="ident" id="1864249">closed</span>&nbsp;<span class="op" id="1864256">!=</span>&nbsp;<span class="num" id="1864259">0</span>&nbsp;<span class="op" id="1864261">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864267">goto</span>&nbsp;<span class="ident" id="1864272">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864287">case</span>&nbsp;<span class="ident" id="1864292">_CaseSend</span><span class="op" id="1864301">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864306">if</span>&nbsp;<span class="ident" id="1864309">raceenabled</span>&nbsp;<span class="op" id="1864321">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864327">racereadpc</span><span class="op" id="1864337">(</span><span class="ident" id="1864338">unsafe</span><span class="op" id="1864344">.</span><span class="ident" id="1864345">Pointer</span><span class="op" id="1864352">(</span><span class="ident" id="1864353">c</span><span class="op" id="1864354">)</span><span class="op" id="1864355">,</span>&nbsp;<span class="ident" id="1864357">cas</span><span class="op" id="1864360">.</span><span class="ident" id="1864361">pc</span><span class="op" id="1864363">,</span>&nbsp;<span class="ident" id="1864365">chansendpc</span><span class="op" id="1864375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864385">if</span>&nbsp;<span class="ident" id="1864388">c</span><span class="op" id="1864389">.</span><span class="ident" id="1864390">closed</span>&nbsp;<span class="op" id="1864397">!=</span>&nbsp;<span class="num" id="1864400">0</span>&nbsp;<span class="op" id="1864402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864408">goto</span>&nbsp;<span class="ident" id="1864413">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864423">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864428">if</span>&nbsp;<span class="ident" id="1864431">c</span><span class="op" id="1864432">.</span><span class="ident" id="1864433">dataqsiz</span>&nbsp;<span class="op" id="1864442">&gt;</span>&nbsp;<span class="num" id="1864444">0</span>&nbsp;<span class="op" id="1864446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864452">if</span>&nbsp;<span class="ident" id="1864455">c</span><span class="op" id="1864456">.</span><span class="ident" id="1864457">qcount</span>&nbsp;<span class="op" id="1864464">&lt;</span>&nbsp;<span class="ident" id="1864466">c</span><span class="op" id="1864467">.</span><span class="ident" id="1864468">dataqsiz</span>&nbsp;<span class="op" id="1864477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864484">goto</span>&nbsp;<span class="ident" id="1864489">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864508">}</span>&nbsp;<span class="keyword" id="1864510">else</span>&nbsp;<span class="op" id="1864515">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864521">sg</span>&nbsp;<span class="op" id="1864524">=</span>&nbsp;<span class="ident" id="1864526">c</span><span class="op" id="1864527">.</span><span class="ident" id="1864528">recvq</span><span class="op" id="1864533">.</span><span class="ident" id="1864534">dequeue</span><span class="op" id="1864541">(</span><span class="op" id="1864542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864548">if</span>&nbsp;<span class="ident" id="1864551">sg</span>&nbsp;<span class="op" id="1864554">!=</span>&nbsp;<span class="ident" id="1864557">nil</span>&nbsp;<span class="op" id="1864561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864568">goto</span>&nbsp;<span class="ident" id="1864573">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864591">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864596">case</span>&nbsp;<span class="ident" id="1864601">_CaseDefault</span><span class="op" id="1864613">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864618">dfl</span>&nbsp;<span class="op" id="1864622">=</span>&nbsp;<span class="ident" id="1864624">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864633">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864637">if</span>&nbsp;<span class="ident" id="1864640">dfl</span>&nbsp;<span class="op" id="1864644">!=</span>&nbsp;<span class="ident" id="1864647">nil</span>&nbsp;<span class="op" id="1864651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864655">selunlock</span><span class="op" id="1864664">(</span><span class="ident" id="1864665">sel</span><span class="op" id="1864668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864672">cas</span>&nbsp;<span class="op" id="1864676">=</span>&nbsp;<span class="ident" id="1864678">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864684">goto</span>&nbsp;<span class="ident" id="1864689">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1864695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1864699">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864733">gp</span>&nbsp;<span class="op" id="1864736">=</span>&nbsp;<span class="ident" id="1864738">getg</span><span class="op" id="1864742">(</span><span class="op" id="1864743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864746">done</span>&nbsp;<span class="op" id="1864751">=</span>&nbsp;<span class="num" id="1864753">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1864756">for</span>&nbsp;<span class="ident" id="1864760">i</span>&nbsp;<span class="op" id="1864762">:=</span>&nbsp;<span class="num" id="1864765">0</span><span class="op" id="1864766">;</span>&nbsp;<span class="ident" id="1864768">i</span>&nbsp;<span class="op" id="1864770">&lt;</span>&nbsp;<span class="builtintype" id="1864772">int</span><span class="op" id="1864775">(</span><span class="ident" id="1864776">sel</span><span class="op" id="1864779">.</span><span class="ident" id="1864780">ncase</span><span class="op" id="1864785">)</span><span class="op" id="1864786">;</span>&nbsp;<span class="ident" id="1864788">i</span><span class="op" id="1864789">++</span>&nbsp;<span class="op" id="1864792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864796">cas</span>&nbsp;<span class="op" id="1864800">=</span>&nbsp;<span class="op" id="1864802">&amp;</span><span class="ident" id="1864803">scases</span><span class="op" id="1864809">[</span><span class="ident" id="1864810">pollorder</span><span class="op" id="1864819">[</span><span class="ident" id="1864820">i</span><span class="op" id="1864821">]</span><span class="op" id="1864822">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864826">c</span>&nbsp;<span class="op" id="1864828">=</span>&nbsp;<span class="ident" id="1864830">cas</span><span class="op" id="1864833">.</span><span class="ident" id="1864834">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864842">sg</span>&nbsp;<span class="op" id="1864845">:=</span>&nbsp;<span class="ident" id="1864848">acquireSudog</span><span class="op" id="1864860">(</span><span class="op" id="1864861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864865">sg</span><span class="op" id="1864867">.</span><span class="ident" id="1864868">g</span>&nbsp;<span class="op" id="1864870">=</span>&nbsp;<span class="ident" id="1864872">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1864877">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1864952">sg</span><span class="op" id="1864954">.</span><span class="ident" id="1864955">selectdone</span>&nbsp;<span class="op" id="1864966">=</span>&nbsp;<span class="op" id="1864968">(</span><span class="op" id="1864969">*</span><span class="builtintype" id="1864970">uint32</span><span class="op" id="1864976">)</span><span class="op" id="1864977">(</span><span class="ident" id="1864978">noescape</span><span class="op" id="1864986">(</span><span class="ident" id="1864987">unsafe</span><span class="op" id="1864993">.</span><span class="ident" id="1864994">Pointer</span><span class="op" id="1865001">(</span><span class="op" id="1865002">&amp;</span><span class="ident" id="1865003">done</span><span class="op" id="1865007">)</span><span class="op" id="1865008">)</span><span class="op" id="1865009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865013">sg</span><span class="op" id="1865015">.</span><span class="ident" id="1865016">elem</span>&nbsp;<span class="op" id="1865021">=</span>&nbsp;<span class="ident" id="1865023">cas</span><span class="op" id="1865026">.</span><span class="ident" id="1865027">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865034">sg</span><span class="op" id="1865036">.</span><span class="ident" id="1865037">releasetime</span>&nbsp;<span class="op" id="1865049">=</span>&nbsp;<span class="num" id="1865051">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1865055">if</span>&nbsp;<span class="ident" id="1865058">t0</span>&nbsp;<span class="op" id="1865061">!=</span>&nbsp;<span class="num" id="1865064">0</span>&nbsp;<span class="op" id="1865066">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865071">sg</span><span class="op" id="1865073">.</span><span class="ident" id="1865074">releasetime</span>&nbsp;<span class="op" id="1865086">=</span>&nbsp;<span class="op" id="1865088">-</span><span class="num" id="1865089">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1865093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865097">sg</span><span class="op" id="1865099">.</span><span class="ident" id="1865100">waitlink</span>&nbsp;<span class="op" id="1865109">=</span>&nbsp;<span class="ident" id="1865111">gp</span><span class="op" id="1865113">.</span><span class="ident" id="1865114">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865124">gp</span><span class="op" id="1865126">.</span><span class="ident" id="1865127">waiting</span>&nbsp;<span class="op" id="1865135">=</span>&nbsp;<span class="ident" id="1865137">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1865143">switch</span>&nbsp;<span class="ident" id="1865150">cas</span><span class="op" id="1865153">.</span><span class="ident" id="1865154">kind</span>&nbsp;<span class="op" id="1865159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1865163">case</span>&nbsp;<span class="ident" id="1865168">_CaseRecv</span><span class="op" id="1865177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865182">c</span><span class="op" id="1865183">.</span><span class="ident" id="1865184">recvq</span><span class="op" id="1865189">.</span><span class="ident" id="1865190">enqueue</span><span class="op" id="1865197">(</span><span class="ident" id="1865198">sg</span><span class="op" id="1865200">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1865205">case</span>&nbsp;<span class="ident" id="1865210">_CaseSend</span><span class="op" id="1865219">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865224">c</span><span class="op" id="1865225">.</span><span class="ident" id="1865226">sendq</span><span class="op" id="1865231">.</span><span class="ident" id="1865232">enqueue</span><span class="op" id="1865239">(</span><span class="ident" id="1865240">sg</span><span class="op" id="1865242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1865246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1865249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865253">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865288">gp</span><span class="op" id="1865290">.</span><span class="ident" id="1865291">param</span>&nbsp;<span class="op" id="1865297">=</span>&nbsp;<span class="ident" id="1865299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865304">gopark</span><span class="op" id="1865310">(</span><span class="ident" id="1865311">unsafe</span><span class="op" id="1865317">.</span><span class="ident" id="1865318">Pointer</span><span class="op" id="1865325">(</span><span class="ident" id="1865326">funcPC</span><span class="op" id="1865332">(</span><span class="ident" id="1865333">selparkcommit</span><span class="op" id="1865346">)</span><span class="op" id="1865347">)</span><span class="op" id="1865348">,</span>&nbsp;<span class="ident" id="1865350">unsafe</span><span class="op" id="1865356">.</span><span class="ident" id="1865357">Pointer</span><span class="op" id="1865364">(</span><span class="ident" id="1865365">sel</span><span class="op" id="1865368">)</span><span class="op" id="1865369">,</span>&nbsp;<span class="string" id="1865371">&#34;select&#34;</span><span class="op" id="1865379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865383">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865406">sellock</span><span class="op" id="1865413">(</span><span class="ident" id="1865414">sel</span><span class="op" id="1865417">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865420">sg</span>&nbsp;<span class="op" id="1865423">=</span>&nbsp;<span class="op" id="1865425">(</span><span class="op" id="1865426">*</span><span class="ident" id="1865427">sudog</span><span class="op" id="1865432">)</span><span class="op" id="1865433">(</span><span class="ident" id="1865434">gp</span><span class="op" id="1865436">.</span><span class="ident" id="1865437">param</span><span class="op" id="1865442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865445">gp</span><span class="op" id="1865447">.</span><span class="ident" id="1865448">param</span>&nbsp;<span class="op" id="1865454">=</span>&nbsp;<span class="ident" id="1865456">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865462">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865507">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865553">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865593">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865651">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865716">cas</span>&nbsp;<span class="op" id="1865720">=</span>&nbsp;<span class="ident" id="1865722">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1865727">sglist</span>&nbsp;<span class="op" id="1865734">=</span>&nbsp;<span class="ident" id="1865736">gp</span><span class="op" id="1865738">.</span><span class="ident" id="1865739">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865748">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865816">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865885">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1865963">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1866038">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1866104">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866127">for</span>&nbsp;<span class="ident" id="1866131">sg1</span>&nbsp;<span class="op" id="1866135">:=</span>&nbsp;<span class="ident" id="1866138">gp</span><span class="op" id="1866140">.</span><span class="ident" id="1866141">waiting</span><span class="op" id="1866148">;</span>&nbsp;<span class="ident" id="1866150">sg1</span>&nbsp;<span class="op" id="1866154">!=</span>&nbsp;<span class="ident" id="1866157">nil</span><span class="op" id="1866160">;</span>&nbsp;<span class="ident" id="1866162">sg1</span>&nbsp;<span class="op" id="1866166">=</span>&nbsp;<span class="ident" id="1866168">sg1</span><span class="op" id="1866171">.</span><span class="ident" id="1866172">waitlink</span>&nbsp;<span class="op" id="1866181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866185">sg1</span><span class="op" id="1866188">.</span><span class="ident" id="1866189">selectdone</span>&nbsp;<span class="op" id="1866200">=</span>&nbsp;<span class="ident" id="1866202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866208">sg1</span><span class="op" id="1866211">.</span><span class="ident" id="1866212">elem</span>&nbsp;<span class="op" id="1866217">=</span>&nbsp;<span class="ident" id="1866219">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866224">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866227">gp</span><span class="op" id="1866229">.</span><span class="ident" id="1866230">waiting</span>&nbsp;<span class="op" id="1866238">=</span>&nbsp;<span class="ident" id="1866240">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866245">for</span>&nbsp;<span class="ident" id="1866249">i</span>&nbsp;<span class="op" id="1866251">:=</span>&nbsp;<span class="builtintype" id="1866254">int</span><span class="op" id="1866257">(</span><span class="ident" id="1866258">sel</span><span class="op" id="1866261">.</span><span class="ident" id="1866262">ncase</span><span class="op" id="1866267">)</span>&nbsp;<span class="op" id="1866269">-</span>&nbsp;<span class="num" id="1866271">1</span><span class="op" id="1866272">;</span>&nbsp;<span class="ident" id="1866274">i</span>&nbsp;<span class="op" id="1866276">&gt;=</span>&nbsp;<span class="num" id="1866279">0</span><span class="op" id="1866280">;</span>&nbsp;<span class="ident" id="1866282">i</span><span class="op" id="1866283">--</span>&nbsp;<span class="op" id="1866286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866290">k</span>&nbsp;<span class="op" id="1866292">=</span>&nbsp;<span class="op" id="1866294">&amp;</span><span class="ident" id="1866295">scases</span><span class="op" id="1866301">[</span><span class="ident" id="1866302">pollorder</span><span class="op" id="1866311">[</span><span class="ident" id="1866312">i</span><span class="op" id="1866313">]</span><span class="op" id="1866314">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866318">if</span>&nbsp;<span class="ident" id="1866321">sglist</span><span class="op" id="1866327">.</span><span class="ident" id="1866328">releasetime</span>&nbsp;<span class="op" id="1866340">&gt;</span>&nbsp;<span class="num" id="1866342">0</span>&nbsp;<span class="op" id="1866344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866349">k</span><span class="op" id="1866350">.</span><span class="ident" id="1866351">releasetime</span>&nbsp;<span class="op" id="1866363">=</span>&nbsp;<span class="ident" id="1866365">sglist</span><span class="op" id="1866371">.</span><span class="ident" id="1866372">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866390">if</span>&nbsp;<span class="ident" id="1866393">sg</span>&nbsp;<span class="op" id="1866396">==</span>&nbsp;<span class="ident" id="1866399">sglist</span>&nbsp;<span class="op" id="1866406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866411">cas</span>&nbsp;<span class="op" id="1866415">=</span>&nbsp;<span class="ident" id="1866417">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866421">}</span>&nbsp;<span class="keyword" id="1866423">else</span>&nbsp;<span class="op" id="1866428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866433">c</span>&nbsp;<span class="op" id="1866435">=</span>&nbsp;<span class="ident" id="1866437">k</span><span class="op" id="1866438">.</span><span class="ident" id="1866439">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866448">if</span>&nbsp;<span class="ident" id="1866451">k</span><span class="op" id="1866452">.</span><span class="ident" id="1866453">kind</span>&nbsp;<span class="op" id="1866458">==</span>&nbsp;<span class="ident" id="1866461">_CaseSend</span>&nbsp;<span class="op" id="1866471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866477">c</span><span class="op" id="1866478">.</span><span class="ident" id="1866479">sendq</span><span class="op" id="1866484">.</span><span class="ident" id="1866485">dequeueSudoG</span><span class="op" id="1866497">(</span><span class="ident" id="1866498">sglist</span><span class="op" id="1866504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866509">}</span>&nbsp;<span class="keyword" id="1866511">else</span>&nbsp;<span class="op" id="1866516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866522">c</span><span class="op" id="1866523">.</span><span class="ident" id="1866524">recvq</span><span class="op" id="1866529">.</span><span class="ident" id="1866530">dequeueSudoG</span><span class="op" id="1866542">(</span><span class="ident" id="1866543">sglist</span><span class="op" id="1866549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866554">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866562">sgnext</span>&nbsp;<span class="op" id="1866569">=</span>&nbsp;<span class="ident" id="1866571">sglist</span><span class="op" id="1866577">.</span><span class="ident" id="1866578">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866589">sglist</span><span class="op" id="1866595">.</span><span class="ident" id="1866596">waitlink</span>&nbsp;<span class="op" id="1866605">=</span>&nbsp;<span class="ident" id="1866607">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866613">releaseSudog</span><span class="op" id="1866625">(</span><span class="ident" id="1866626">sglist</span><span class="op" id="1866632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866636">sglist</span>&nbsp;<span class="op" id="1866643">=</span>&nbsp;<span class="ident" id="1866645">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866657">if</span>&nbsp;<span class="ident" id="1866660">cas</span>&nbsp;<span class="op" id="1866664">==</span>&nbsp;<span class="ident" id="1866667">nil</span>&nbsp;<span class="op" id="1866671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866675">goto</span>&nbsp;<span class="ident" id="1866680">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866686">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866690">c</span>&nbsp;<span class="op" id="1866692">=</span>&nbsp;<span class="ident" id="1866694">cas</span><span class="op" id="1866697">.</span><span class="ident" id="1866698">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866706">if</span>&nbsp;<span class="ident" id="1866709">c</span><span class="op" id="1866710">.</span><span class="ident" id="1866711">dataqsiz</span>&nbsp;<span class="op" id="1866720">&gt;</span>&nbsp;<span class="num" id="1866722">0</span>&nbsp;<span class="op" id="1866724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1866728">gothrow</span><span class="op" id="1866735">(</span><span class="string" id="1866736">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1866764">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866771">if</span>&nbsp;<span class="ident" id="1866774">debugSelect</span>&nbsp;<span class="op" id="1866786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1866790">print</span><span class="op" id="1866795">(</span><span class="string" id="1866796">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1866815">,</span>&nbsp;<span class="ident" id="1866817">sel</span><span class="op" id="1866820">,</span>&nbsp;<span class="string" id="1866822">&#34;&nbsp;c=&#34;</span><span class="op" id="1866827">,</span>&nbsp;<span class="ident" id="1866829">c</span><span class="op" id="1866830">,</span>&nbsp;<span class="string" id="1866832">&#34;&nbsp;cas=&#34;</span><span class="op" id="1866839">,</span>&nbsp;<span class="ident" id="1866841">cas</span><span class="op" id="1866844">,</span>&nbsp;<span class="string" id="1866846">&#34;&nbsp;kind=&#34;</span><span class="op" id="1866854">,</span>&nbsp;<span class="ident" id="1866856">cas</span><span class="op" id="1866859">.</span><span class="ident" id="1866860">kind</span><span class="op" id="1866864">,</span>&nbsp;<span class="string" id="1866866">&#34;\n&#34;</span><span class="op" id="1866870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866873">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866877">if</span>&nbsp;<span class="ident" id="1866880">cas</span><span class="op" id="1866883">.</span><span class="ident" id="1866884">kind</span>&nbsp;<span class="op" id="1866889">==</span>&nbsp;<span class="ident" id="1866892">_CaseRecv</span>&nbsp;<span class="op" id="1866902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866906">if</span>&nbsp;<span class="ident" id="1866909">cas</span><span class="op" id="1866912">.</span><span class="ident" id="1866913">receivedp</span>&nbsp;<span class="op" id="1866923">!=</span>&nbsp;<span class="ident" id="1866926">nil</span>&nbsp;<span class="op" id="1866930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866935">*</span><span class="ident" id="1866936">cas</span><span class="op" id="1866939">.</span><span class="ident" id="1866940">receivedp</span>&nbsp;<span class="op" id="1866950">=</span>&nbsp;<span class="builtintype" id="1866952">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866959">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1866962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866966">if</span>&nbsp;<span class="ident" id="1866969">raceenabled</span>&nbsp;<span class="op" id="1866981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1866985">if</span>&nbsp;<span class="ident" id="1866988">cas</span><span class="op" id="1866991">.</span><span class="ident" id="1866992">kind</span>&nbsp;<span class="op" id="1866997">==</span>&nbsp;<span class="ident" id="1867000">_CaseRecv</span>&nbsp;<span class="op" id="1867010">&amp;&amp;</span>&nbsp;<span class="ident" id="1867013">cas</span><span class="op" id="1867016">.</span><span class="ident" id="1867017">elem</span>&nbsp;<span class="op" id="1867022">!=</span>&nbsp;<span class="ident" id="1867025">nil</span>&nbsp;<span class="op" id="1867029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867034">raceWriteObjectPC</span><span class="op" id="1867051">(</span><span class="ident" id="1867052">c</span><span class="op" id="1867053">.</span><span class="ident" id="1867054">elemtype</span><span class="op" id="1867062">,</span>&nbsp;<span class="ident" id="1867064">cas</span><span class="op" id="1867067">.</span><span class="ident" id="1867068">elem</span><span class="op" id="1867072">,</span>&nbsp;<span class="ident" id="1867074">cas</span><span class="op" id="1867077">.</span><span class="ident" id="1867078">pc</span><span class="op" id="1867080">,</span>&nbsp;<span class="ident" id="1867082">chanrecvpc</span><span class="op" id="1867092">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867096">}</span>&nbsp;<span class="keyword" id="1867098">else</span>&nbsp;<span class="keyword" id="1867103">if</span>&nbsp;<span class="ident" id="1867106">cas</span><span class="op" id="1867109">.</span><span class="ident" id="1867110">kind</span>&nbsp;<span class="op" id="1867115">==</span>&nbsp;<span class="ident" id="1867118">_CaseSend</span>&nbsp;<span class="op" id="1867128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867133">raceReadObjectPC</span><span class="op" id="1867149">(</span><span class="ident" id="1867150">c</span><span class="op" id="1867151">.</span><span class="ident" id="1867152">elemtype</span><span class="op" id="1867160">,</span>&nbsp;<span class="ident" id="1867162">cas</span><span class="op" id="1867165">.</span><span class="ident" id="1867166">elem</span><span class="op" id="1867170">,</span>&nbsp;<span class="ident" id="1867172">cas</span><span class="op" id="1867175">.</span><span class="ident" id="1867176">pc</span><span class="op" id="1867178">,</span>&nbsp;<span class="ident" id="1867180">chansendpc</span><span class="op" id="1867190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867201">selunlock</span><span class="op" id="1867210">(</span><span class="ident" id="1867211">sel</span><span class="op" id="1867214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867217">goto</span>&nbsp;<span class="ident" id="1867222">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1867228">asyncrecv</span><span class="op" id="1867237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1867240">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867268">if</span>&nbsp;<span class="ident" id="1867271">raceenabled</span>&nbsp;<span class="op" id="1867283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867287">if</span>&nbsp;<span class="ident" id="1867290">cas</span><span class="op" id="1867293">.</span><span class="ident" id="1867294">elem</span>&nbsp;<span class="op" id="1867299">!=</span>&nbsp;<span class="ident" id="1867302">nil</span>&nbsp;<span class="op" id="1867306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867311">raceWriteObjectPC</span><span class="op" id="1867328">(</span><span class="ident" id="1867329">c</span><span class="op" id="1867330">.</span><span class="ident" id="1867331">elemtype</span><span class="op" id="1867339">,</span>&nbsp;<span class="ident" id="1867341">cas</span><span class="op" id="1867344">.</span><span class="ident" id="1867345">elem</span><span class="op" id="1867349">,</span>&nbsp;<span class="ident" id="1867351">cas</span><span class="op" id="1867354">.</span><span class="ident" id="1867355">pc</span><span class="op" id="1867357">,</span>&nbsp;<span class="ident" id="1867359">chanrecvpc</span><span class="op" id="1867369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867377">raceacquire</span><span class="op" id="1867388">(</span><span class="ident" id="1867389">chanbuf</span><span class="op" id="1867396">(</span><span class="ident" id="1867397">c</span><span class="op" id="1867398">,</span>&nbsp;<span class="ident" id="1867400">c</span><span class="op" id="1867401">.</span><span class="ident" id="1867402">recvx</span><span class="op" id="1867407">)</span><span class="op" id="1867408">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867412">racerelease</span><span class="op" id="1867423">(</span><span class="ident" id="1867424">chanbuf</span><span class="op" id="1867431">(</span><span class="ident" id="1867432">c</span><span class="op" id="1867433">,</span>&nbsp;<span class="ident" id="1867435">c</span><span class="op" id="1867436">.</span><span class="ident" id="1867437">recvx</span><span class="op" id="1867442">)</span><span class="op" id="1867443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867449">if</span>&nbsp;<span class="ident" id="1867452">cas</span><span class="op" id="1867455">.</span><span class="ident" id="1867456">receivedp</span>&nbsp;<span class="op" id="1867466">!=</span>&nbsp;<span class="ident" id="1867469">nil</span>&nbsp;<span class="op" id="1867473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867477">*</span><span class="ident" id="1867478">cas</span><span class="op" id="1867481">.</span><span class="ident" id="1867482">receivedp</span>&nbsp;<span class="op" id="1867492">=</span>&nbsp;<span class="builtintype" id="1867494">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867500">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867503">if</span>&nbsp;<span class="ident" id="1867506">cas</span><span class="op" id="1867509">.</span><span class="ident" id="1867510">elem</span>&nbsp;<span class="op" id="1867515">!=</span>&nbsp;<span class="ident" id="1867518">nil</span>&nbsp;<span class="op" id="1867522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867526">memmove</span><span class="op" id="1867533">(</span><span class="ident" id="1867534">cas</span><span class="op" id="1867537">.</span><span class="ident" id="1867538">elem</span><span class="op" id="1867542">,</span>&nbsp;<span class="ident" id="1867544">chanbuf</span><span class="op" id="1867551">(</span><span class="ident" id="1867552">c</span><span class="op" id="1867553">,</span>&nbsp;<span class="ident" id="1867555">c</span><span class="op" id="1867556">.</span><span class="ident" id="1867557">recvx</span><span class="op" id="1867562">)</span><span class="op" id="1867563">,</span>&nbsp;<span class="builtintype" id="1867565">uintptr</span><span class="op" id="1867572">(</span><span class="ident" id="1867573">c</span><span class="op" id="1867574">.</span><span class="ident" id="1867575">elemsize</span><span class="op" id="1867583">)</span><span class="op" id="1867584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867590">memclr</span><span class="op" id="1867596">(</span><span class="ident" id="1867597">chanbuf</span><span class="op" id="1867604">(</span><span class="ident" id="1867605">c</span><span class="op" id="1867606">,</span>&nbsp;<span class="ident" id="1867608">c</span><span class="op" id="1867609">.</span><span class="ident" id="1867610">recvx</span><span class="op" id="1867615">)</span><span class="op" id="1867616">,</span>&nbsp;<span class="builtintype" id="1867618">uintptr</span><span class="op" id="1867625">(</span><span class="ident" id="1867626">c</span><span class="op" id="1867627">.</span><span class="ident" id="1867628">elemsize</span><span class="op" id="1867636">)</span><span class="op" id="1867637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867640">c</span><span class="op" id="1867641">.</span><span class="ident" id="1867642">recvx</span><span class="op" id="1867647">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867651">if</span>&nbsp;<span class="ident" id="1867654">c</span><span class="op" id="1867655">.</span><span class="ident" id="1867656">recvx</span>&nbsp;<span class="op" id="1867662">==</span>&nbsp;<span class="ident" id="1867665">c</span><span class="op" id="1867666">.</span><span class="ident" id="1867667">dataqsiz</span>&nbsp;<span class="op" id="1867676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867680">c</span><span class="op" id="1867681">.</span><span class="ident" id="1867682">recvx</span>&nbsp;<span class="op" id="1867688">=</span>&nbsp;<span class="num" id="1867690">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867696">c</span><span class="op" id="1867697">.</span><span class="ident" id="1867698">qcount</span><span class="op" id="1867704">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867708">sg</span>&nbsp;<span class="op" id="1867711">=</span>&nbsp;<span class="ident" id="1867713">c</span><span class="op" id="1867714">.</span><span class="ident" id="1867715">sendq</span><span class="op" id="1867720">.</span><span class="ident" id="1867721">dequeue</span><span class="op" id="1867728">(</span><span class="op" id="1867729">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867732">if</span>&nbsp;<span class="ident" id="1867735">sg</span>&nbsp;<span class="op" id="1867738">!=</span>&nbsp;<span class="ident" id="1867741">nil</span>&nbsp;<span class="op" id="1867745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867749">gp</span>&nbsp;<span class="op" id="1867752">=</span>&nbsp;<span class="ident" id="1867754">sg</span><span class="op" id="1867756">.</span><span class="ident" id="1867757">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867761">selunlock</span><span class="op" id="1867770">(</span><span class="ident" id="1867771">sel</span><span class="op" id="1867774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867778">if</span>&nbsp;<span class="ident" id="1867781">sg</span><span class="op" id="1867783">.</span><span class="ident" id="1867784">releasetime</span>&nbsp;<span class="op" id="1867796">!=</span>&nbsp;<span class="num" id="1867799">0</span>&nbsp;<span class="op" id="1867801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867806">sg</span><span class="op" id="1867808">.</span><span class="ident" id="1867809">releasetime</span>&nbsp;<span class="op" id="1867821">=</span>&nbsp;<span class="ident" id="1867823">cputicks</span><span class="op" id="1867831">(</span><span class="op" id="1867832">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867840">goready</span><span class="op" id="1867847">(</span><span class="ident" id="1867848">gp</span><span class="op" id="1867850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867853">}</span>&nbsp;<span class="keyword" id="1867855">else</span>&nbsp;<span class="op" id="1867860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867864">selunlock</span><span class="op" id="1867873">(</span><span class="ident" id="1867874">sel</span><span class="op" id="1867877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1867880">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867883">goto</span>&nbsp;<span class="ident" id="1867888">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1867894">asyncsend</span><span class="op" id="1867903">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1867906">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1867929">if</span>&nbsp;<span class="ident" id="1867932">raceenabled</span>&nbsp;<span class="op" id="1867944">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867948">raceacquire</span><span class="op" id="1867959">(</span><span class="ident" id="1867960">chanbuf</span><span class="op" id="1867967">(</span><span class="ident" id="1867968">c</span><span class="op" id="1867969">,</span>&nbsp;<span class="ident" id="1867971">c</span><span class="op" id="1867972">.</span><span class="ident" id="1867973">sendx</span><span class="op" id="1867978">)</span><span class="op" id="1867979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1867983">racerelease</span><span class="op" id="1867994">(</span><span class="ident" id="1867995">chanbuf</span><span class="op" id="1868002">(</span><span class="ident" id="1868003">c</span><span class="op" id="1868004">,</span>&nbsp;<span class="ident" id="1868006">c</span><span class="op" id="1868007">.</span><span class="ident" id="1868008">sendx</span><span class="op" id="1868013">)</span><span class="op" id="1868014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868018">raceReadObjectPC</span><span class="op" id="1868034">(</span><span class="ident" id="1868035">c</span><span class="op" id="1868036">.</span><span class="ident" id="1868037">elemtype</span><span class="op" id="1868045">,</span>&nbsp;<span class="ident" id="1868047">cas</span><span class="op" id="1868050">.</span><span class="ident" id="1868051">elem</span><span class="op" id="1868055">,</span>&nbsp;<span class="ident" id="1868057">cas</span><span class="op" id="1868060">.</span><span class="ident" id="1868061">pc</span><span class="op" id="1868063">,</span>&nbsp;<span class="ident" id="1868065">chansendpc</span><span class="op" id="1868075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868081">memmove</span><span class="op" id="1868088">(</span><span class="ident" id="1868089">chanbuf</span><span class="op" id="1868096">(</span><span class="ident" id="1868097">c</span><span class="op" id="1868098">,</span>&nbsp;<span class="ident" id="1868100">c</span><span class="op" id="1868101">.</span><span class="ident" id="1868102">sendx</span><span class="op" id="1868107">)</span><span class="op" id="1868108">,</span>&nbsp;<span class="ident" id="1868110">cas</span><span class="op" id="1868113">.</span><span class="ident" id="1868114">elem</span><span class="op" id="1868118">,</span>&nbsp;<span class="builtintype" id="1868120">uintptr</span><span class="op" id="1868127">(</span><span class="ident" id="1868128">c</span><span class="op" id="1868129">.</span><span class="ident" id="1868130">elemsize</span><span class="op" id="1868138">)</span><span class="op" id="1868139">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868142">c</span><span class="op" id="1868143">.</span><span class="ident" id="1868144">sendx</span><span class="op" id="1868149">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868153">if</span>&nbsp;<span class="ident" id="1868156">c</span><span class="op" id="1868157">.</span><span class="ident" id="1868158">sendx</span>&nbsp;<span class="op" id="1868164">==</span>&nbsp;<span class="ident" id="1868167">c</span><span class="op" id="1868168">.</span><span class="ident" id="1868169">dataqsiz</span>&nbsp;<span class="op" id="1868178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868182">c</span><span class="op" id="1868183">.</span><span class="ident" id="1868184">sendx</span>&nbsp;<span class="op" id="1868190">=</span>&nbsp;<span class="num" id="1868192">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868198">c</span><span class="op" id="1868199">.</span><span class="ident" id="1868200">qcount</span><span class="op" id="1868206">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868210">sg</span>&nbsp;<span class="op" id="1868213">=</span>&nbsp;<span class="ident" id="1868215">c</span><span class="op" id="1868216">.</span><span class="ident" id="1868217">recvq</span><span class="op" id="1868222">.</span><span class="ident" id="1868223">dequeue</span><span class="op" id="1868230">(</span><span class="op" id="1868231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868234">if</span>&nbsp;<span class="ident" id="1868237">sg</span>&nbsp;<span class="op" id="1868240">!=</span>&nbsp;<span class="ident" id="1868243">nil</span>&nbsp;<span class="op" id="1868247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868251">gp</span>&nbsp;<span class="op" id="1868254">=</span>&nbsp;<span class="ident" id="1868256">sg</span><span class="op" id="1868258">.</span><span class="ident" id="1868259">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868263">selunlock</span><span class="op" id="1868272">(</span><span class="ident" id="1868273">sel</span><span class="op" id="1868276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868280">if</span>&nbsp;<span class="ident" id="1868283">sg</span><span class="op" id="1868285">.</span><span class="ident" id="1868286">releasetime</span>&nbsp;<span class="op" id="1868298">!=</span>&nbsp;<span class="num" id="1868301">0</span>&nbsp;<span class="op" id="1868303">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868308">sg</span><span class="op" id="1868310">.</span><span class="ident" id="1868311">releasetime</span>&nbsp;<span class="op" id="1868323">=</span>&nbsp;<span class="ident" id="1868325">cputicks</span><span class="op" id="1868333">(</span><span class="op" id="1868334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868342">goready</span><span class="op" id="1868349">(</span><span class="ident" id="1868350">gp</span><span class="op" id="1868352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868355">}</span>&nbsp;<span class="keyword" id="1868357">else</span>&nbsp;<span class="op" id="1868362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868366">selunlock</span><span class="op" id="1868375">(</span><span class="ident" id="1868376">sel</span><span class="op" id="1868379">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868385">goto</span>&nbsp;<span class="ident" id="1868390">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1868396">syncrecv</span><span class="op" id="1868404">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1868407">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868449">if</span>&nbsp;<span class="ident" id="1868452">raceenabled</span>&nbsp;<span class="op" id="1868464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868468">if</span>&nbsp;<span class="ident" id="1868471">cas</span><span class="op" id="1868474">.</span><span class="ident" id="1868475">elem</span>&nbsp;<span class="op" id="1868480">!=</span>&nbsp;<span class="ident" id="1868483">nil</span>&nbsp;<span class="op" id="1868487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868492">raceWriteObjectPC</span><span class="op" id="1868509">(</span><span class="ident" id="1868510">c</span><span class="op" id="1868511">.</span><span class="ident" id="1868512">elemtype</span><span class="op" id="1868520">,</span>&nbsp;<span class="ident" id="1868522">cas</span><span class="op" id="1868525">.</span><span class="ident" id="1868526">elem</span><span class="op" id="1868530">,</span>&nbsp;<span class="ident" id="1868532">cas</span><span class="op" id="1868535">.</span><span class="ident" id="1868536">pc</span><span class="op" id="1868538">,</span>&nbsp;<span class="ident" id="1868540">chanrecvpc</span><span class="op" id="1868550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868558">racesync</span><span class="op" id="1868566">(</span><span class="ident" id="1868567">c</span><span class="op" id="1868568">,</span>&nbsp;<span class="ident" id="1868570">sg</span><span class="op" id="1868572">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868578">selunlock</span><span class="op" id="1868587">(</span><span class="ident" id="1868588">sel</span><span class="op" id="1868591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868594">if</span>&nbsp;<span class="ident" id="1868597">debugSelect</span>&nbsp;<span class="op" id="1868609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1868613">print</span><span class="op" id="1868618">(</span><span class="string" id="1868619">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1868635">,</span>&nbsp;<span class="ident" id="1868637">sel</span><span class="op" id="1868640">,</span>&nbsp;<span class="string" id="1868642">&#34;&nbsp;c=&#34;</span><span class="op" id="1868647">,</span>&nbsp;<span class="ident" id="1868649">c</span><span class="op" id="1868650">,</span>&nbsp;<span class="string" id="1868652">&#34;\n&#34;</span><span class="op" id="1868656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868659">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868662">if</span>&nbsp;<span class="ident" id="1868665">cas</span><span class="op" id="1868668">.</span><span class="ident" id="1868669">receivedp</span>&nbsp;<span class="op" id="1868679">!=</span>&nbsp;<span class="ident" id="1868682">nil</span>&nbsp;<span class="op" id="1868686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868690">*</span><span class="ident" id="1868691">cas</span><span class="op" id="1868694">.</span><span class="ident" id="1868695">receivedp</span>&nbsp;<span class="op" id="1868705">=</span>&nbsp;<span class="builtintype" id="1868707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868716">if</span>&nbsp;<span class="ident" id="1868719">cas</span><span class="op" id="1868722">.</span><span class="ident" id="1868723">elem</span>&nbsp;<span class="op" id="1868728">!=</span>&nbsp;<span class="ident" id="1868731">nil</span>&nbsp;<span class="op" id="1868735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868739">memmove</span><span class="op" id="1868746">(</span><span class="ident" id="1868747">cas</span><span class="op" id="1868750">.</span><span class="ident" id="1868751">elem</span><span class="op" id="1868755">,</span>&nbsp;<span class="ident" id="1868757">sg</span><span class="op" id="1868759">.</span><span class="ident" id="1868760">elem</span><span class="op" id="1868764">,</span>&nbsp;<span class="builtintype" id="1868766">uintptr</span><span class="op" id="1868773">(</span><span class="ident" id="1868774">c</span><span class="op" id="1868775">.</span><span class="ident" id="1868776">elemsize</span><span class="op" id="1868784">)</span><span class="op" id="1868785">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868791">sg</span><span class="op" id="1868793">.</span><span class="ident" id="1868794">elem</span>&nbsp;<span class="op" id="1868799">=</span>&nbsp;<span class="ident" id="1868801">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868806">gp</span>&nbsp;<span class="op" id="1868809">=</span>&nbsp;<span class="ident" id="1868811">sg</span><span class="op" id="1868813">.</span><span class="ident" id="1868814">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868817">gp</span><span class="op" id="1868819">.</span><span class="ident" id="1868820">param</span>&nbsp;<span class="op" id="1868826">=</span>&nbsp;<span class="ident" id="1868828">unsafe</span><span class="op" id="1868834">.</span><span class="ident" id="1868835">Pointer</span><span class="op" id="1868842">(</span><span class="ident" id="1868843">sg</span><span class="op" id="1868845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868848">if</span>&nbsp;<span class="ident" id="1868851">sg</span><span class="op" id="1868853">.</span><span class="ident" id="1868854">releasetime</span>&nbsp;<span class="op" id="1868866">!=</span>&nbsp;<span class="num" id="1868869">0</span>&nbsp;<span class="op" id="1868871">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868875">sg</span><span class="op" id="1868877">.</span><span class="ident" id="1868878">releasetime</span>&nbsp;<span class="op" id="1868890">=</span>&nbsp;<span class="ident" id="1868892">cputicks</span><span class="op" id="1868900">(</span><span class="op" id="1868901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1868904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868907">goready</span><span class="op" id="1868914">(</span><span class="ident" id="1868915">gp</span><span class="op" id="1868917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868920">goto</span>&nbsp;<span class="ident" id="1868925">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1868931">rclose</span><span class="op" id="1868937">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1868940">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1868974">selunlock</span><span class="op" id="1868983">(</span><span class="ident" id="1868984">sel</span><span class="op" id="1868987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1868990">if</span>&nbsp;<span class="ident" id="1868993">cas</span><span class="op" id="1868996">.</span><span class="ident" id="1868997">receivedp</span>&nbsp;<span class="op" id="1869007">!=</span>&nbsp;<span class="ident" id="1869010">nil</span>&nbsp;<span class="op" id="1869014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869018">*</span><span class="ident" id="1869019">cas</span><span class="op" id="1869022">.</span><span class="ident" id="1869023">receivedp</span>&nbsp;<span class="op" id="1869033">=</span>&nbsp;<span class="builtintype" id="1869035">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869045">if</span>&nbsp;<span class="ident" id="1869048">cas</span><span class="op" id="1869051">.</span><span class="ident" id="1869052">elem</span>&nbsp;<span class="op" id="1869057">!=</span>&nbsp;<span class="ident" id="1869060">nil</span>&nbsp;<span class="op" id="1869064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869068">memclr</span><span class="op" id="1869074">(</span><span class="ident" id="1869075">cas</span><span class="op" id="1869078">.</span><span class="ident" id="1869079">elem</span><span class="op" id="1869083">,</span>&nbsp;<span class="builtintype" id="1869085">uintptr</span><span class="op" id="1869092">(</span><span class="ident" id="1869093">c</span><span class="op" id="1869094">.</span><span class="ident" id="1869095">elemsize</span><span class="op" id="1869103">)</span><span class="op" id="1869104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869110">if</span>&nbsp;<span class="ident" id="1869113">raceenabled</span>&nbsp;<span class="op" id="1869125">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869129">raceacquire</span><span class="op" id="1869140">(</span><span class="ident" id="1869141">unsafe</span><span class="op" id="1869147">.</span><span class="ident" id="1869148">Pointer</span><span class="op" id="1869155">(</span><span class="ident" id="1869156">c</span><span class="op" id="1869157">)</span><span class="op" id="1869158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869164">goto</span>&nbsp;<span class="ident" id="1869169">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1869175">syncsend</span><span class="op" id="1869183">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869186">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869225">if</span>&nbsp;<span class="ident" id="1869228">raceenabled</span>&nbsp;<span class="op" id="1869240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869244">raceReadObjectPC</span><span class="op" id="1869260">(</span><span class="ident" id="1869261">c</span><span class="op" id="1869262">.</span><span class="ident" id="1869263">elemtype</span><span class="op" id="1869271">,</span>&nbsp;<span class="ident" id="1869273">cas</span><span class="op" id="1869276">.</span><span class="ident" id="1869277">elem</span><span class="op" id="1869281">,</span>&nbsp;<span class="ident" id="1869283">cas</span><span class="op" id="1869286">.</span><span class="ident" id="1869287">pc</span><span class="op" id="1869289">,</span>&nbsp;<span class="ident" id="1869291">chansendpc</span><span class="op" id="1869301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869305">racesync</span><span class="op" id="1869313">(</span><span class="ident" id="1869314">c</span><span class="op" id="1869315">,</span>&nbsp;<span class="ident" id="1869317">sg</span><span class="op" id="1869319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869322">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869325">selunlock</span><span class="op" id="1869334">(</span><span class="ident" id="1869335">sel</span><span class="op" id="1869338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869341">if</span>&nbsp;<span class="ident" id="1869344">debugSelect</span>&nbsp;<span class="op" id="1869356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1869360">print</span><span class="op" id="1869365">(</span><span class="string" id="1869366">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1869382">,</span>&nbsp;<span class="ident" id="1869384">sel</span><span class="op" id="1869387">,</span>&nbsp;<span class="string" id="1869389">&#34;&nbsp;c=&#34;</span><span class="op" id="1869394">,</span>&nbsp;<span class="ident" id="1869396">c</span><span class="op" id="1869397">,</span>&nbsp;<span class="string" id="1869399">&#34;\n&#34;</span><span class="op" id="1869403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869409">if</span>&nbsp;<span class="ident" id="1869412">sg</span><span class="op" id="1869414">.</span><span class="ident" id="1869415">elem</span>&nbsp;<span class="op" id="1869420">!=</span>&nbsp;<span class="ident" id="1869423">nil</span>&nbsp;<span class="op" id="1869427">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869431">memmove</span><span class="op" id="1869438">(</span><span class="ident" id="1869439">sg</span><span class="op" id="1869441">.</span><span class="ident" id="1869442">elem</span><span class="op" id="1869446">,</span>&nbsp;<span class="ident" id="1869448">cas</span><span class="op" id="1869451">.</span><span class="ident" id="1869452">elem</span><span class="op" id="1869456">,</span>&nbsp;<span class="builtintype" id="1869458">uintptr</span><span class="op" id="1869465">(</span><span class="ident" id="1869466">c</span><span class="op" id="1869467">.</span><span class="ident" id="1869468">elemsize</span><span class="op" id="1869476">)</span><span class="op" id="1869477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869483">sg</span><span class="op" id="1869485">.</span><span class="ident" id="1869486">elem</span>&nbsp;<span class="op" id="1869491">=</span>&nbsp;<span class="ident" id="1869493">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869498">gp</span>&nbsp;<span class="op" id="1869501">=</span>&nbsp;<span class="ident" id="1869503">sg</span><span class="op" id="1869505">.</span><span class="ident" id="1869506">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869509">gp</span><span class="op" id="1869511">.</span><span class="ident" id="1869512">param</span>&nbsp;<span class="op" id="1869518">=</span>&nbsp;<span class="ident" id="1869520">unsafe</span><span class="op" id="1869526">.</span><span class="ident" id="1869527">Pointer</span><span class="op" id="1869534">(</span><span class="ident" id="1869535">sg</span><span class="op" id="1869537">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869540">if</span>&nbsp;<span class="ident" id="1869543">sg</span><span class="op" id="1869545">.</span><span class="ident" id="1869546">releasetime</span>&nbsp;<span class="op" id="1869558">!=</span>&nbsp;<span class="num" id="1869561">0</span>&nbsp;<span class="op" id="1869563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869567">sg</span><span class="op" id="1869569">.</span><span class="ident" id="1869570">releasetime</span>&nbsp;<span class="op" id="1869582">=</span>&nbsp;<span class="ident" id="1869584">cputicks</span><span class="op" id="1869592">(</span><span class="op" id="1869593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869599">goready</span><span class="op" id="1869606">(</span><span class="ident" id="1869607">gp</span><span class="op" id="1869609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1869612">retc</span><span class="op" id="1869616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869619">if</span>&nbsp;<span class="ident" id="1869622">cas</span><span class="op" id="1869625">.</span><span class="ident" id="1869626">releasetime</span>&nbsp;<span class="op" id="1869638">&gt;</span>&nbsp;<span class="num" id="1869640">0</span>&nbsp;<span class="op" id="1869642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869646">blockevent</span><span class="op" id="1869656">(</span><span class="ident" id="1869657">cas</span><span class="op" id="1869660">.</span><span class="ident" id="1869661">releasetime</span><span class="op" id="1869672">-</span><span class="ident" id="1869673">t0</span><span class="op" id="1869675">,</span>&nbsp;<span class="num" id="1869677">2</span><span class="op" id="1869678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1869681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869684">return</span>&nbsp;<span class="ident" id="1869691">cas</span><span class="op" id="1869694">.</span><span class="ident" id="1869695">pc</span><span class="op" id="1869697">,</span>&nbsp;<span class="ident" id="1869699">cas</span><span class="op" id="1869702">.</span><span class="ident" id="1869703">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1869707">sclose</span><span class="op" id="1869713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869716">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1869743">selunlock</span><span class="op" id="1869752">(</span><span class="ident" id="1869753">sel</span><span class="op" id="1869756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1869759">panic</span><span class="op" id="1869764">(</span><span class="string" id="1869765">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1869789">)</span><br>
<span class="lineno">575</span><span class="op" id="1869791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1869794">func</span>&nbsp;<span class="op" id="1869799">(</span><span class="ident" id="1869800">c</span>&nbsp;<span class="op" id="1869802">*</span><span class="ident" id="1869803">hchan</span><span class="op" id="1869808">)</span>&nbsp;<span class="ident" id="1869810">sortkey</span><span class="op" id="1869817">(</span><span class="op" id="1869818">)</span>&nbsp;<span class="builtintype" id="1869820">uintptr</span>&nbsp;<span class="op" id="1869828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869831">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1869899">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1869925">return</span>&nbsp;<span class="builtintype" id="1869932">uintptr</span><span class="op" id="1869939">(</span><span class="ident" id="1869940">unsafe</span><span class="op" id="1869946">.</span><span class="ident" id="1869947">Pointer</span><span class="op" id="1869954">(</span><span class="ident" id="1869955">c</span><span class="op" id="1869956">)</span><span class="op" id="1869957">)</span><br>
<span class="lineno"></span><span class="op" id="1869959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1869962">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1870017">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1870071">type</span>&nbsp;<span class="ident" id="1870076">runtimeSelect</span>&nbsp;<span class="keyword" id="1870090">struct</span>&nbsp;<span class="op" id="1870097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870100">dir</span>&nbsp;<span class="ident" id="1870104">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870115">typ</span>&nbsp;<span class="ident" id="1870119">unsafe</span><span class="op" id="1870125">.</span><span class="ident" id="1870126">Pointer</span>&nbsp;<span class="comment" id="1870134">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870167">ch</span>&nbsp;&nbsp;<span class="op" id="1870171">*</span><span class="ident" id="1870172">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1870186">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870198">val</span>&nbsp;<span class="ident" id="1870202">unsafe</span><span class="op" id="1870208">.</span><span class="ident" id="1870209">Pointer</span>&nbsp;<span class="comment" id="1870217">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1870277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1870280">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1870339">type</span>&nbsp;<span class="ident" id="1870344">selectDir</span>&nbsp;<span class="builtintype" id="1870354">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1870359">const</span>&nbsp;<span class="op" id="1870365">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870368">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1870382">selectDir</span>&nbsp;<span class="op" id="1870392">=</span>&nbsp;<span class="ident" id="1870394">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870400">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1870424">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870446">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1870470">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870487">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1870511">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1870522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1870525">func</span>&nbsp;<span class="ident" id="1870530">reflect_rselect</span><span class="op" id="1870545">(</span><span class="ident" id="1870546">cases</span>&nbsp;<span class="op" id="1870552">[</span><span class="op" id="1870553">]</span><span class="ident" id="1870554">runtimeSelect</span><span class="op" id="1870567">)</span>&nbsp;<span class="op" id="1870569">(</span><span class="ident" id="1870570">chosen</span>&nbsp;<span class="builtintype" id="1870577">int</span><span class="op" id="1870580">,</span>&nbsp;<span class="ident" id="1870582">recvOK</span>&nbsp;<span class="builtintype" id="1870589">bool</span><span class="op" id="1870593">)</span>&nbsp;<span class="op" id="1870595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1870598">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870679">size</span>&nbsp;<span class="op" id="1870684">:=</span>&nbsp;<span class="ident" id="1870687">selectsize</span><span class="op" id="1870697">(</span><span class="builtintype" id="1870698">uintptr</span><span class="op" id="1870705">(</span><span class="builtinfunc" id="1870706">len</span><span class="op" id="1870709">(</span><span class="ident" id="1870710">cases</span><span class="op" id="1870715">)</span><span class="op" id="1870716">)</span><span class="op" id="1870717">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870720">sel</span>&nbsp;<span class="op" id="1870724">:=</span>&nbsp;<span class="op" id="1870727">(</span><span class="op" id="1870728">*</span><span class="ident" id="1870729">_select</span><span class="op" id="1870736">)</span><span class="op" id="1870737">(</span><span class="ident" id="1870738">mallocgc</span><span class="op" id="1870746">(</span><span class="ident" id="1870747">size</span><span class="op" id="1870751">,</span>&nbsp;<span class="ident" id="1870753">nil</span><span class="op" id="1870756">,</span>&nbsp;<span class="ident" id="1870758">flagNoScan</span><span class="op" id="1870768">)</span><span class="op" id="1870769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870772">newselect</span><span class="op" id="1870781">(</span><span class="ident" id="1870782">sel</span><span class="op" id="1870785">,</span>&nbsp;<span class="ident" id="1870787">int64</span><span class="op" id="1870792">(</span><span class="ident" id="1870793">size</span><span class="op" id="1870797">)</span><span class="op" id="1870798">,</span>&nbsp;<span class="builtintype" id="1870800">int32</span><span class="op" id="1870805">(</span><span class="builtinfunc" id="1870806">len</span><span class="op" id="1870809">(</span><span class="ident" id="1870810">cases</span><span class="op" id="1870815">)</span><span class="op" id="1870816">)</span><span class="op" id="1870817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870820">r</span>&nbsp;<span class="op" id="1870822">:=</span>&nbsp;<span class="builtinfunc" id="1870825">new</span><span class="op" id="1870828">(</span><span class="builtintype" id="1870829">bool</span><span class="op" id="1870833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1870836">for</span>&nbsp;<span class="ident" id="1870840">i</span>&nbsp;<span class="op" id="1870842">:=</span>&nbsp;<span class="keyword" id="1870845">range</span>&nbsp;<span class="ident" id="1870851">cases</span>&nbsp;<span class="op" id="1870857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870861">rc</span>&nbsp;<span class="op" id="1870864">:=</span>&nbsp;<span class="op" id="1870867">&amp;</span><span class="ident" id="1870868">cases</span><span class="op" id="1870873">[</span><span class="ident" id="1870874">i</span><span class="op" id="1870875">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1870879">switch</span>&nbsp;<span class="ident" id="1870886">rc</span><span class="op" id="1870888">.</span><span class="ident" id="1870889">dir</span>&nbsp;<span class="op" id="1870893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1870897">case</span>&nbsp;<span class="ident" id="1870902">selectDefault</span><span class="op" id="1870915">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1870920">selectdefaultImpl</span><span class="op" id="1870937">(</span><span class="ident" id="1870938">sel</span><span class="op" id="1870941">,</span>&nbsp;<span class="builtintype" id="1870943">uintptr</span><span class="op" id="1870950">(</span><span class="ident" id="1870951">i</span><span class="op" id="1870952">)</span><span class="op" id="1870953">,</span>&nbsp;<span class="num" id="1870955">0</span><span class="op" id="1870956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1870960">case</span>&nbsp;<span class="ident" id="1870965">selectSend</span><span class="op" id="1870975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1870980">if</span>&nbsp;<span class="ident" id="1870983">rc</span><span class="op" id="1870985">.</span><span class="ident" id="1870986">ch</span>&nbsp;<span class="op" id="1870989">==</span>&nbsp;<span class="ident" id="1870992">nil</span>&nbsp;<span class="op" id="1870996">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871002">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871016">selectsendImpl</span><span class="op" id="1871030">(</span><span class="ident" id="1871031">sel</span><span class="op" id="1871034">,</span>&nbsp;<span class="ident" id="1871036">rc</span><span class="op" id="1871038">.</span><span class="ident" id="1871039">ch</span><span class="op" id="1871041">,</span>&nbsp;<span class="builtintype" id="1871043">uintptr</span><span class="op" id="1871050">(</span><span class="ident" id="1871051">i</span><span class="op" id="1871052">)</span><span class="op" id="1871053">,</span>&nbsp;<span class="ident" id="1871055">rc</span><span class="op" id="1871057">.</span><span class="ident" id="1871058">val</span><span class="op" id="1871061">,</span>&nbsp;<span class="num" id="1871063">0</span><span class="op" id="1871064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871068">case</span>&nbsp;<span class="ident" id="1871073">selectRecv</span><span class="op" id="1871083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871088">if</span>&nbsp;<span class="ident" id="1871091">rc</span><span class="op" id="1871093">.</span><span class="ident" id="1871094">ch</span>&nbsp;<span class="op" id="1871097">==</span>&nbsp;<span class="ident" id="1871100">nil</span>&nbsp;<span class="op" id="1871104">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871110">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871124">selectrecvImpl</span><span class="op" id="1871138">(</span><span class="ident" id="1871139">sel</span><span class="op" id="1871142">,</span>&nbsp;<span class="ident" id="1871144">rc</span><span class="op" id="1871146">.</span><span class="ident" id="1871147">ch</span><span class="op" id="1871149">,</span>&nbsp;<span class="builtintype" id="1871151">uintptr</span><span class="op" id="1871158">(</span><span class="ident" id="1871159">i</span><span class="op" id="1871160">)</span><span class="op" id="1871161">,</span>&nbsp;<span class="ident" id="1871163">rc</span><span class="op" id="1871165">.</span><span class="ident" id="1871166">val</span><span class="op" id="1871169">,</span>&nbsp;<span class="ident" id="1871171">r</span><span class="op" id="1871172">,</span>&nbsp;<span class="num" id="1871174">0</span><span class="op" id="1871175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871182">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871186">pc</span><span class="op" id="1871188">,</span>&nbsp;<span class="ident" id="1871190">_</span>&nbsp;<span class="op" id="1871192">:=</span>&nbsp;<span class="ident" id="1871195">selectgoImpl</span><span class="op" id="1871207">(</span><span class="ident" id="1871208">sel</span><span class="op" id="1871211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871214">chosen</span>&nbsp;<span class="op" id="1871221">=</span>&nbsp;<span class="builtintype" id="1871223">int</span><span class="op" id="1871226">(</span><span class="ident" id="1871227">pc</span><span class="op" id="1871229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871232">recvOK</span>&nbsp;<span class="op" id="1871239">=</span>&nbsp;<span class="op" id="1871241">*</span><span class="ident" id="1871242">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871245">return</span><br>
<span class="lineno">630</span><span class="op" id="1871252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1871255">func</span>&nbsp;<span class="op" id="1871260">(</span><span class="ident" id="1871261">q</span>&nbsp;<span class="op" id="1871263">*</span><span class="ident" id="1871264">waitq</span><span class="op" id="1871269">)</span>&nbsp;<span class="ident" id="1871271">dequeueSudoG</span><span class="op" id="1871283">(</span><span class="ident" id="1871284">s</span>&nbsp;<span class="op" id="1871286">*</span><span class="ident" id="1871287">sudog</span><span class="op" id="1871292">)</span>&nbsp;<span class="op" id="1871294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871297">var</span>&nbsp;<span class="ident" id="1871301">prevsgp</span>&nbsp;<span class="op" id="1871309">*</span><span class="ident" id="1871310">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871317">l</span>&nbsp;<span class="op" id="1871319">:=</span>&nbsp;<span class="op" id="1871322">&amp;</span><span class="ident" id="1871323">q</span><span class="op" id="1871324">.</span><span class="ident" id="1871325">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871332">for</span>&nbsp;<span class="op" id="1871336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871340">sgp</span>&nbsp;<span class="op" id="1871344">:=</span>&nbsp;<span class="op" id="1871347">*</span><span class="ident" id="1871348">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871352">if</span>&nbsp;<span class="ident" id="1871355">sgp</span>&nbsp;<span class="op" id="1871359">==</span>&nbsp;<span class="ident" id="1871362">nil</span>&nbsp;<span class="op" id="1871366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871371">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871380">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871384">if</span>&nbsp;<span class="ident" id="1871387">sgp</span>&nbsp;<span class="op" id="1871391">==</span>&nbsp;<span class="ident" id="1871394">s</span>&nbsp;<span class="op" id="1871396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871401">*</span><span class="ident" id="1871402">l</span>&nbsp;<span class="op" id="1871404">=</span>&nbsp;<span class="ident" id="1871406">sgp</span><span class="op" id="1871409">.</span><span class="ident" id="1871410">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871418">if</span>&nbsp;<span class="ident" id="1871421">q</span><span class="op" id="1871422">.</span><span class="ident" id="1871423">last</span>&nbsp;<span class="op" id="1871428">==</span>&nbsp;<span class="ident" id="1871431">sgp</span>&nbsp;<span class="op" id="1871435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871441">q</span><span class="op" id="1871442">.</span><span class="ident" id="1871443">last</span>&nbsp;<span class="op" id="1871448">=</span>&nbsp;<span class="ident" id="1871450">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871461">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871466">s</span><span class="op" id="1871467">.</span><span class="ident" id="1871468">next</span>&nbsp;<span class="op" id="1871473">=</span>&nbsp;<span class="ident" id="1871475">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1871482">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871495">l</span>&nbsp;<span class="op" id="1871497">=</span>&nbsp;<span class="op" id="1871499">&amp;</span><span class="ident" id="1871500">sgp</span><span class="op" id="1871503">.</span><span class="ident" id="1871504">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1871511">prevsgp</span>&nbsp;<span class="op" id="1871519">=</span>&nbsp;<span class="ident" id="1871521">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1871526">}</span><br>
<span class="lineno"></span><span class="op" id="1871528">}</span>
</div>
</body>
</html>
