<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5254183">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5254238">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5254292">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5254343">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5254405">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5254472">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="5254494">package</span>&nbsp;<span class="ident" id="5254502">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5254512">import</span>&nbsp;<span class="op" id="5254519">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5254522">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5254531">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5254540">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5254550">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5254557">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5254562">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5254565">const</span>&nbsp;<span class="ident" id="5254571">maxLineLength</span>&nbsp;<span class="op" id="5254585">=</span>&nbsp;<span class="num" id="5254587">4096</span>&nbsp;<span class="comment" id="5254592">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5254628">var</span>&nbsp;<span class="ident" id="5254632">ErrLineTooLong</span>&nbsp;<span class="op" id="5254647">=</span>&nbsp;<span class="ident" id="5254649">errors</span><span class="op" id="5254655">.</span><span class="ident" id="5254656">New</span><span class="op" id="5254659">(</span><span class="string" id="5254660">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="5254682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5254685">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5254770">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="5254823">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="5254898">//</span><br>
<span class="lineno"></span><span class="comment" id="5254901">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5254976">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="5255040">func</span>&nbsp;<span class="ident" id="5255045">NewChunkedReader</span><span class="op" id="5255061">(</span><span class="ident" id="5255062">r</span>&nbsp;<span class="ident" id="5255064">io</span><span class="op" id="5255066">.</span><span class="ident" id="5255067">Reader</span><span class="op" id="5255073">)</span>&nbsp;<span class="ident" id="5255075">io</span><span class="op" id="5255077">.</span><span class="ident" id="5255078">Reader</span>&nbsp;<span class="op" id="5255085">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255088">br</span><span class="op" id="5255090">,</span>&nbsp;<span class="ident" id="5255092">ok</span>&nbsp;<span class="op" id="5255095">:=</span>&nbsp;<span class="ident" id="5255098">r</span><span class="op" id="5255099">.</span><span class="op" id="5255100">(</span><span class="op" id="5255101">*</span><span class="ident" id="5255102">bufio</span><span class="op" id="5255107">.</span><span class="ident" id="5255108">Reader</span><span class="op" id="5255114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255117">if</span>&nbsp;<span class="op" id="5255120">!</span><span class="ident" id="5255121">ok</span>&nbsp;<span class="op" id="5255124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255128">br</span>&nbsp;<span class="op" id="5255131">=</span>&nbsp;<span class="ident" id="5255133">bufio</span><span class="op" id="5255138">.</span><span class="ident" id="5255139">NewReader</span><span class="op" id="5255148">(</span><span class="ident" id="5255149">r</span><span class="op" id="5255150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255156">return</span>&nbsp;<span class="op" id="5255163">&amp;</span><span class="ident" id="5255164">chunkedReader</span><span class="op" id="5255177">{</span><span class="ident" id="5255178">r</span><span class="op" id="5255179">:</span>&nbsp;<span class="ident" id="5255181">br</span><span class="op" id="5255183">}</span><br>
<span class="lineno">35</span><span class="op" id="5255185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5255188">type</span>&nbsp;<span class="ident" id="5255193">chunkedReader</span>&nbsp;<span class="keyword" id="5255207">struct</span>&nbsp;<span class="op" id="5255214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255217">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5255221">*</span><span class="ident" id="5255222">bufio</span><span class="op" id="5255227">.</span><span class="ident" id="5255228">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255236">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5255240">uint64</span>&nbsp;<span class="comment" id="5255247">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255273">err</span>&nbsp;<span class="builtintype" id="5255277">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255284">buf</span>&nbsp;<span class="op" id="5255288">[</span><span class="num" id="5255289">2</span><span class="op" id="5255290">]</span><span class="builtintype" id="5255291">byte</span><br>
<span class="lineno"></span><span class="op" id="5255296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5255299">func</span>&nbsp;<span class="op" id="5255304">(</span><span class="ident" id="5255305">cr</span>&nbsp;<span class="op" id="5255308">*</span><span class="ident" id="5255309">chunkedReader</span><span class="op" id="5255322">)</span>&nbsp;<span class="ident" id="5255324">beginChunk</span><span class="op" id="5255334">(</span><span class="op" id="5255335">)</span>&nbsp;<span class="op" id="5255337">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5255340">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255360">var</span>&nbsp;<span class="ident" id="5255364">line</span>&nbsp;<span class="op" id="5255369">[</span><span class="op" id="5255370">]</span><span class="builtintype" id="5255371">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255377">line</span><span class="op" id="5255381">,</span>&nbsp;<span class="ident" id="5255383">cr</span><span class="op" id="5255385">.</span><span class="ident" id="5255386">err</span>&nbsp;<span class="op" id="5255390">=</span>&nbsp;<span class="ident" id="5255392">readLine</span><span class="op" id="5255400">(</span><span class="ident" id="5255401">cr</span><span class="op" id="5255403">.</span><span class="ident" id="5255404">r</span><span class="op" id="5255405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255408">if</span>&nbsp;<span class="ident" id="5255411">cr</span><span class="op" id="5255413">.</span><span class="ident" id="5255414">err</span>&nbsp;<span class="op" id="5255418">!=</span>&nbsp;<span class="ident" id="5255421">nil</span>&nbsp;<span class="op" id="5255425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255429">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255440">cr</span><span class="op" id="5255442">.</span><span class="ident" id="5255443">n</span><span class="op" id="5255444">,</span>&nbsp;<span class="ident" id="5255446">cr</span><span class="op" id="5255448">.</span><span class="ident" id="5255449">err</span>&nbsp;<span class="op" id="5255453">=</span>&nbsp;<span class="ident" id="5255455">parseHexUint</span><span class="op" id="5255467">(</span><span class="ident" id="5255468">line</span><span class="op" id="5255472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255475">if</span>&nbsp;<span class="ident" id="5255478">cr</span><span class="op" id="5255480">.</span><span class="ident" id="5255481">err</span>&nbsp;<span class="op" id="5255485">!=</span>&nbsp;<span class="ident" id="5255488">nil</span>&nbsp;<span class="op" id="5255492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255496">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255504">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255507">if</span>&nbsp;<span class="ident" id="5255510">cr</span><span class="op" id="5255512">.</span><span class="ident" id="5255513">n</span>&nbsp;<span class="op" id="5255515">==</span>&nbsp;<span class="num" id="5255518">0</span>&nbsp;<span class="op" id="5255520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255524">cr</span><span class="op" id="5255526">.</span><span class="ident" id="5255527">err</span>&nbsp;<span class="op" id="5255531">=</span>&nbsp;<span class="ident" id="5255533">io</span><span class="op" id="5255535">.</span><span class="ident" id="5255536">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255541">}</span><br>
<span class="lineno"></span><span class="op" id="5255543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5255546">func</span>&nbsp;<span class="op" id="5255551">(</span><span class="ident" id="5255552">cr</span>&nbsp;<span class="op" id="5255555">*</span><span class="ident" id="5255556">chunkedReader</span><span class="op" id="5255569">)</span>&nbsp;<span class="ident" id="5255571">chunkHeaderAvailable</span><span class="op" id="5255591">(</span><span class="op" id="5255592">)</span>&nbsp;<span class="builtintype" id="5255594">bool</span>&nbsp;<span class="op" id="5255599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255602">n</span>&nbsp;<span class="op" id="5255604">:=</span>&nbsp;<span class="ident" id="5255607">cr</span><span class="op" id="5255609">.</span><span class="ident" id="5255610">r</span><span class="op" id="5255611">.</span><span class="ident" id="5255612">Buffered</span><span class="op" id="5255620">(</span><span class="op" id="5255621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255624">if</span>&nbsp;<span class="ident" id="5255627">n</span>&nbsp;<span class="op" id="5255629">&gt;</span>&nbsp;<span class="num" id="5255631">0</span>&nbsp;<span class="op" id="5255633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255637">peek</span><span class="op" id="5255641">,</span>&nbsp;<span class="ident" id="5255643">_</span>&nbsp;<span class="op" id="5255645">:=</span>&nbsp;<span class="ident" id="5255648">cr</span><span class="op" id="5255650">.</span><span class="ident" id="5255651">r</span><span class="op" id="5255652">.</span><span class="ident" id="5255653">Peek</span><span class="op" id="5255657">(</span><span class="ident" id="5255658">n</span><span class="op" id="5255659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255663">return</span>&nbsp;<span class="ident" id="5255670">bytes</span><span class="op" id="5255675">.</span><span class="ident" id="5255676">IndexByte</span><span class="op" id="5255685">(</span><span class="ident" id="5255686">peek</span><span class="op" id="5255690">,</span>&nbsp;<span class="string" id="5255692">&#39;\n&#39;</span><span class="op" id="5255696">)</span>&nbsp;<span class="op" id="5255698">&gt;=</span>&nbsp;<span class="num" id="5255701">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255707">return</span>&nbsp;<span class="builtintype" id="5255714">false</span><br>
<span class="lineno"></span><span class="op" id="5255720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5255723">func</span>&nbsp;<span class="op" id="5255728">(</span><span class="ident" id="5255729">cr</span>&nbsp;<span class="op" id="5255732">*</span><span class="ident" id="5255733">chunkedReader</span><span class="op" id="5255746">)</span>&nbsp;<span class="ident" id="5255748">Read</span><span class="op" id="5255752">(</span><span class="ident" id="5255753">b</span>&nbsp;<span class="op" id="5255755">[</span><span class="op" id="5255756">]</span><span class="builtintype" id="5255757">uint8</span><span class="op" id="5255762">)</span>&nbsp;<span class="op" id="5255764">(</span><span class="ident" id="5255765">n</span>&nbsp;<span class="builtintype" id="5255767">int</span><span class="op" id="5255770">,</span>&nbsp;<span class="ident" id="5255772">err</span>&nbsp;<span class="builtintype" id="5255776">error</span><span class="op" id="5255781">)</span>&nbsp;<span class="op" id="5255783">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255786">for</span>&nbsp;<span class="ident" id="5255790">cr</span><span class="op" id="5255792">.</span><span class="ident" id="5255793">err</span>&nbsp;<span class="op" id="5255797">==</span>&nbsp;<span class="ident" id="5255800">nil</span>&nbsp;<span class="op" id="5255804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255808">if</span>&nbsp;<span class="ident" id="5255811">cr</span><span class="op" id="5255813">.</span><span class="ident" id="5255814">n</span>&nbsp;<span class="op" id="5255816">==</span>&nbsp;<span class="num" id="5255819">0</span>&nbsp;<span class="op" id="5255821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255826">if</span>&nbsp;<span class="ident" id="5255829">n</span>&nbsp;<span class="op" id="5255831">&gt;</span>&nbsp;<span class="num" id="5255833">0</span>&nbsp;<span class="op" id="5255835">&amp;&amp;</span>&nbsp;<span class="op" id="5255838">!</span><span class="ident" id="5255839">cr</span><span class="op" id="5255841">.</span><span class="ident" id="5255842">chunkHeaderAvailable</span><span class="op" id="5255862">(</span><span class="op" id="5255863">)</span>&nbsp;<span class="op" id="5255865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5255871">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5255921">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255956">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5255965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5255970">cr</span><span class="op" id="5255972">.</span><span class="ident" id="5255973">beginChunk</span><span class="op" id="5255983">(</span><span class="op" id="5255984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5255989">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256000">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256004">if</span>&nbsp;<span class="builtinfunc" id="5256007">len</span><span class="op" id="5256010">(</span><span class="ident" id="5256011">b</span><span class="op" id="5256012">)</span>&nbsp;<span class="op" id="5256014">==</span>&nbsp;<span class="num" id="5256017">0</span>&nbsp;<span class="op" id="5256019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256024">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256036">rbuf</span>&nbsp;<span class="op" id="5256041">:=</span>&nbsp;<span class="ident" id="5256044">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256048">if</span>&nbsp;<span class="ident" id="5256051">uint64</span><span class="op" id="5256057">(</span><span class="builtinfunc" id="5256058">len</span><span class="op" id="5256061">(</span><span class="ident" id="5256062">rbuf</span><span class="op" id="5256066">)</span><span class="op" id="5256067">)</span>&nbsp;<span class="op" id="5256069">&gt;</span>&nbsp;<span class="ident" id="5256071">cr</span><span class="op" id="5256073">.</span><span class="ident" id="5256074">n</span>&nbsp;<span class="op" id="5256076">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256081">rbuf</span>&nbsp;<span class="op" id="5256086">=</span>&nbsp;<span class="ident" id="5256088">rbuf</span><span class="op" id="5256092">[</span><span class="op" id="5256093">:</span><span class="ident" id="5256094">cr</span><span class="op" id="5256096">.</span><span class="ident" id="5256097">n</span><span class="op" id="5256098">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256106">var</span>&nbsp;<span class="ident" id="5256110">n0</span>&nbsp;<span class="builtintype" id="5256113">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256119">n0</span><span class="op" id="5256121">,</span>&nbsp;<span class="ident" id="5256123">cr</span><span class="op" id="5256125">.</span><span class="ident" id="5256126">err</span>&nbsp;<span class="op" id="5256130">=</span>&nbsp;<span class="ident" id="5256132">cr</span><span class="op" id="5256134">.</span><span class="ident" id="5256135">r</span><span class="op" id="5256136">.</span><span class="ident" id="5256137">Read</span><span class="op" id="5256141">(</span><span class="ident" id="5256142">rbuf</span><span class="op" id="5256146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256150">n</span>&nbsp;<span class="op" id="5256152">+=</span>&nbsp;<span class="ident" id="5256155">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256160">b</span>&nbsp;<span class="op" id="5256162">=</span>&nbsp;<span class="ident" id="5256164">b</span><span class="op" id="5256165">[</span><span class="ident" id="5256166">n0</span><span class="op" id="5256168">:</span><span class="op" id="5256169">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256173">cr</span><span class="op" id="5256175">.</span><span class="ident" id="5256176">n</span>&nbsp;<span class="op" id="5256178">-=</span>&nbsp;<span class="ident" id="5256181">uint64</span><span class="op" id="5256187">(</span><span class="ident" id="5256188">n0</span><span class="op" id="5256190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256194">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256249">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256287">if</span>&nbsp;<span class="ident" id="5256290">cr</span><span class="op" id="5256292">.</span><span class="ident" id="5256293">n</span>&nbsp;<span class="op" id="5256295">==</span>&nbsp;<span class="num" id="5256298">0</span>&nbsp;<span class="op" id="5256300">&amp;&amp;</span>&nbsp;<span class="ident" id="5256303">cr</span><span class="op" id="5256305">.</span><span class="ident" id="5256306">err</span>&nbsp;<span class="op" id="5256310">==</span>&nbsp;<span class="ident" id="5256313">nil</span>&nbsp;<span class="op" id="5256317">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256322">if</span>&nbsp;<span class="ident" id="5256325">_</span><span class="op" id="5256326">,</span>&nbsp;<span class="ident" id="5256328">cr</span><span class="op" id="5256330">.</span><span class="ident" id="5256331">err</span>&nbsp;<span class="op" id="5256335">=</span>&nbsp;<span class="ident" id="5256337">io</span><span class="op" id="5256339">.</span><span class="ident" id="5256340">ReadFull</span><span class="op" id="5256348">(</span><span class="ident" id="5256349">cr</span><span class="op" id="5256351">.</span><span class="ident" id="5256352">r</span><span class="op" id="5256353">,</span>&nbsp;<span class="ident" id="5256355">cr</span><span class="op" id="5256357">.</span><span class="ident" id="5256358">buf</span><span class="op" id="5256361">[</span><span class="op" id="5256362">:</span><span class="num" id="5256363">2</span><span class="op" id="5256364">]</span><span class="op" id="5256365">)</span><span class="op" id="5256366">;</span>&nbsp;<span class="ident" id="5256368">cr</span><span class="op" id="5256370">.</span><span class="ident" id="5256371">err</span>&nbsp;<span class="op" id="5256375">==</span>&nbsp;<span class="ident" id="5256378">nil</span>&nbsp;<span class="op" id="5256382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256388">if</span>&nbsp;<span class="ident" id="5256391">cr</span><span class="op" id="5256393">.</span><span class="ident" id="5256394">buf</span><span class="op" id="5256397">[</span><span class="num" id="5256398">0</span><span class="op" id="5256399">]</span>&nbsp;<span class="op" id="5256401">!=</span>&nbsp;<span class="string" id="5256404">&#39;\r&#39;</span>&nbsp;<span class="op" id="5256409">||</span>&nbsp;<span class="ident" id="5256412">cr</span><span class="op" id="5256414">.</span><span class="ident" id="5256415">buf</span><span class="op" id="5256418">[</span><span class="num" id="5256419">1</span><span class="op" id="5256420">]</span>&nbsp;<span class="op" id="5256422">!=</span>&nbsp;<span class="string" id="5256425">&#39;\n&#39;</span>&nbsp;<span class="op" id="5256430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256437">cr</span><span class="op" id="5256439">.</span><span class="ident" id="5256440">err</span>&nbsp;<span class="op" id="5256444">=</span>&nbsp;<span class="ident" id="5256446">errors</span><span class="op" id="5256452">.</span><span class="ident" id="5256453">New</span><span class="op" id="5256456">(</span><span class="string" id="5256457">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="5256485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256496">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256506">return</span>&nbsp;<span class="ident" id="5256513">n</span><span class="op" id="5256514">,</span>&nbsp;<span class="ident" id="5256516">cr</span><span class="op" id="5256518">.</span><span class="ident" id="5256519">err</span><br>
<span class="lineno"></span><span class="op" id="5256523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5256526">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5256569">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="5256615">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5256667">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="5256731">func</span>&nbsp;<span class="ident" id="5256736">readLine</span><span class="op" id="5256744">(</span><span class="ident" id="5256745">b</span>&nbsp;<span class="op" id="5256747">*</span><span class="ident" id="5256748">bufio</span><span class="op" id="5256753">.</span><span class="ident" id="5256754">Reader</span><span class="op" id="5256760">)</span>&nbsp;<span class="op" id="5256762">(</span><span class="ident" id="5256763">p</span>&nbsp;<span class="op" id="5256765">[</span><span class="op" id="5256766">]</span><span class="builtintype" id="5256767">byte</span><span class="op" id="5256771">,</span>&nbsp;<span class="ident" id="5256773">err</span>&nbsp;<span class="builtintype" id="5256777">error</span><span class="op" id="5256782">)</span>&nbsp;<span class="op" id="5256784">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256787">if</span>&nbsp;<span class="ident" id="5256790">p</span><span class="op" id="5256791">,</span>&nbsp;<span class="ident" id="5256793">err</span>&nbsp;<span class="op" id="5256797">=</span>&nbsp;<span class="ident" id="5256799">b</span><span class="op" id="5256800">.</span><span class="ident" id="5256801">ReadSlice</span><span class="op" id="5256810">(</span><span class="string" id="5256811">&#39;\n&#39;</span><span class="op" id="5256815">)</span><span class="op" id="5256816">;</span>&nbsp;<span class="ident" id="5256818">err</span>&nbsp;<span class="op" id="5256822">!=</span>&nbsp;<span class="ident" id="5256825">nil</span>&nbsp;<span class="op" id="5256829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256833">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5256873">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5256934">if</span>&nbsp;<span class="ident" id="5256937">err</span>&nbsp;<span class="op" id="5256941">==</span>&nbsp;<span class="ident" id="5256944">io</span><span class="op" id="5256946">.</span><span class="ident" id="5256947">EOF</span>&nbsp;<span class="op" id="5256951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5256956">err</span>&nbsp;<span class="op" id="5256960">=</span>&nbsp;<span class="ident" id="5256962">io</span><span class="op" id="5256964">.</span><span class="ident" id="5256965">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5256984">}</span>&nbsp;<span class="keyword" id="5256986">else</span>&nbsp;<span class="keyword" id="5256991">if</span>&nbsp;<span class="ident" id="5256994">err</span>&nbsp;<span class="op" id="5256998">==</span>&nbsp;<span class="ident" id="5257001">bufio</span><span class="op" id="5257006">.</span><span class="ident" id="5257007">ErrBufferFull</span>&nbsp;<span class="op" id="5257021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5257026">err</span>&nbsp;<span class="op" id="5257030">=</span>&nbsp;<span class="ident" id="5257032">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5257049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257053">return</span>&nbsp;<span class="ident" id="5257060">nil</span><span class="op" id="5257063">,</span>&nbsp;<span class="ident" id="5257065">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5257070">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257073">if</span>&nbsp;<span class="builtinfunc" id="5257076">len</span><span class="op" id="5257079">(</span><span class="ident" id="5257080">p</span><span class="op" id="5257081">)</span>&nbsp;<span class="op" id="5257083">&gt;=</span>&nbsp;<span class="ident" id="5257086">maxLineLength</span>&nbsp;<span class="op" id="5257100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257104">return</span>&nbsp;<span class="ident" id="5257111">nil</span><span class="op" id="5257114">,</span>&nbsp;<span class="ident" id="5257116">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5257132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257135">return</span>&nbsp;<span class="ident" id="5257142">trimTrailingWhitespace</span><span class="op" id="5257164">(</span><span class="ident" id="5257165">p</span><span class="op" id="5257166">)</span><span class="op" id="5257167">,</span>&nbsp;<span class="ident" id="5257169">nil</span><br>
<span class="lineno"></span><span class="op" id="5257173">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="5257176">func</span>&nbsp;<span class="ident" id="5257181">trimTrailingWhitespace</span><span class="op" id="5257203">(</span><span class="ident" id="5257204">b</span>&nbsp;<span class="op" id="5257206">[</span><span class="op" id="5257207">]</span><span class="builtintype" id="5257208">byte</span><span class="op" id="5257212">)</span>&nbsp;<span class="op" id="5257214">[</span><span class="op" id="5257215">]</span><span class="builtintype" id="5257216">byte</span>&nbsp;<span class="op" id="5257221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257224">for</span>&nbsp;<span class="builtinfunc" id="5257228">len</span><span class="op" id="5257231">(</span><span class="ident" id="5257232">b</span><span class="op" id="5257233">)</span>&nbsp;<span class="op" id="5257235">&gt;</span>&nbsp;<span class="num" id="5257237">0</span>&nbsp;<span class="op" id="5257239">&amp;&amp;</span>&nbsp;<span class="ident" id="5257242">isASCIISpace</span><span class="op" id="5257254">(</span><span class="ident" id="5257255">b</span><span class="op" id="5257256">[</span><span class="builtinfunc" id="5257257">len</span><span class="op" id="5257260">(</span><span class="ident" id="5257261">b</span><span class="op" id="5257262">)</span><span class="op" id="5257263">-</span><span class="num" id="5257264">1</span><span class="op" id="5257265">]</span><span class="op" id="5257266">)</span>&nbsp;<span class="op" id="5257268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5257272">b</span>&nbsp;<span class="op" id="5257274">=</span>&nbsp;<span class="ident" id="5257276">b</span><span class="op" id="5257277">[</span><span class="op" id="5257278">:</span><span class="builtinfunc" id="5257279">len</span><span class="op" id="5257282">(</span><span class="ident" id="5257283">b</span><span class="op" id="5257284">)</span><span class="op" id="5257285">-</span><span class="num" id="5257286">1</span><span class="op" id="5257287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5257290">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257293">return</span>&nbsp;<span class="ident" id="5257300">b</span><br>
<span class="lineno"></span><span class="op" id="5257302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5257305">func</span>&nbsp;<span class="ident" id="5257310">isASCIISpace</span><span class="op" id="5257322">(</span><span class="ident" id="5257323">b</span>&nbsp;<span class="builtintype" id="5257325">byte</span><span class="op" id="5257329">)</span>&nbsp;<span class="builtintype" id="5257331">bool</span>&nbsp;<span class="op" id="5257336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257339">return</span>&nbsp;<span class="ident" id="5257346">b</span>&nbsp;<span class="op" id="5257348">==</span>&nbsp;<span class="string" id="5257351">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5257355">||</span>&nbsp;<span class="ident" id="5257358">b</span>&nbsp;<span class="op" id="5257360">==</span>&nbsp;<span class="string" id="5257363">&#39;\t&#39;</span>&nbsp;<span class="op" id="5257368">||</span>&nbsp;<span class="ident" id="5257371">b</span>&nbsp;<span class="op" id="5257373">==</span>&nbsp;<span class="string" id="5257376">&#39;\n&#39;</span>&nbsp;<span class="op" id="5257381">||</span>&nbsp;<span class="ident" id="5257384">b</span>&nbsp;<span class="op" id="5257386">==</span>&nbsp;<span class="string" id="5257389">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="5257394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5257397">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="5257478">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="5257559">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="5257627">//</span><br>
<span class="lineno"></span><span class="comment" id="5257630">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="5257697">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5257760">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5257826">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="5257895">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="5257931">func</span>&nbsp;<span class="ident" id="5257936">NewChunkedWriter</span><span class="op" id="5257952">(</span><span class="ident" id="5257953">w</span>&nbsp;<span class="ident" id="5257955">io</span><span class="op" id="5257957">.</span><span class="ident" id="5257958">Writer</span><span class="op" id="5257964">)</span>&nbsp;<span class="ident" id="5257966">io</span><span class="op" id="5257968">.</span><span class="ident" id="5257969">WriteCloser</span>&nbsp;<span class="op" id="5257981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5257984">return</span>&nbsp;<span class="op" id="5257991">&amp;</span><span class="ident" id="5257992">chunkedWriter</span><span class="op" id="5258005">{</span><span class="ident" id="5258006">w</span><span class="op" id="5258007">}</span><br>
<span class="lineno"></span><span class="op" id="5258009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="5258012">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="5258087">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5258149">type</span>&nbsp;<span class="ident" id="5258154">chunkedWriter</span>&nbsp;<span class="keyword" id="5258168">struct</span>&nbsp;<span class="op" id="5258175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258178">Wire</span>&nbsp;<span class="ident" id="5258183">io</span><span class="op" id="5258185">.</span><span class="ident" id="5258186">Writer</span><br>
<span class="lineno"></span><span class="op" id="5258193">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5258196">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="5258248">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5258327">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="5258390">func</span>&nbsp;<span class="op" id="5258395">(</span><span class="ident" id="5258396">cw</span>&nbsp;<span class="op" id="5258399">*</span><span class="ident" id="5258400">chunkedWriter</span><span class="op" id="5258413">)</span>&nbsp;<span class="ident" id="5258415">Write</span><span class="op" id="5258420">(</span><span class="ident" id="5258421">data</span>&nbsp;<span class="op" id="5258426">[</span><span class="op" id="5258427">]</span><span class="builtintype" id="5258428">byte</span><span class="op" id="5258432">)</span>&nbsp;<span class="op" id="5258434">(</span><span class="ident" id="5258435">n</span>&nbsp;<span class="builtintype" id="5258437">int</span><span class="op" id="5258440">,</span>&nbsp;<span class="ident" id="5258442">err</span>&nbsp;<span class="builtintype" id="5258446">error</span><span class="op" id="5258451">)</span>&nbsp;<span class="op" id="5258453">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5258457">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258527">if</span>&nbsp;<span class="builtinfunc" id="5258530">len</span><span class="op" id="5258533">(</span><span class="ident" id="5258534">data</span><span class="op" id="5258538">)</span>&nbsp;<span class="op" id="5258540">==</span>&nbsp;<span class="num" id="5258543">0</span>&nbsp;<span class="op" id="5258545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258549">return</span>&nbsp;<span class="num" id="5258556">0</span><span class="op" id="5258557">,</span>&nbsp;<span class="ident" id="5258559">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258564">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258568">if</span>&nbsp;<span class="ident" id="5258571">_</span><span class="op" id="5258572">,</span>&nbsp;<span class="ident" id="5258574">err</span>&nbsp;<span class="op" id="5258578">=</span>&nbsp;<span class="ident" id="5258580">fmt</span><span class="op" id="5258583">.</span><span class="ident" id="5258584">Fprintf</span><span class="op" id="5258591">(</span><span class="ident" id="5258592">cw</span><span class="op" id="5258594">.</span><span class="ident" id="5258595">Wire</span><span class="op" id="5258599">,</span>&nbsp;<span class="string" id="5258601">&#34;%x\r\n&#34;</span><span class="op" id="5258609">,</span>&nbsp;<span class="builtinfunc" id="5258611">len</span><span class="op" id="5258614">(</span><span class="ident" id="5258615">data</span><span class="op" id="5258619">)</span><span class="op" id="5258620">)</span><span class="op" id="5258621">;</span>&nbsp;<span class="ident" id="5258623">err</span>&nbsp;<span class="op" id="5258627">!=</span>&nbsp;<span class="ident" id="5258630">nil</span>&nbsp;<span class="op" id="5258634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258638">return</span>&nbsp;<span class="num" id="5258645">0</span><span class="op" id="5258646">,</span>&nbsp;<span class="ident" id="5258648">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258656">if</span>&nbsp;<span class="ident" id="5258659">n</span><span class="op" id="5258660">,</span>&nbsp;<span class="ident" id="5258662">err</span>&nbsp;<span class="op" id="5258666">=</span>&nbsp;<span class="ident" id="5258668">cw</span><span class="op" id="5258670">.</span><span class="ident" id="5258671">Wire</span><span class="op" id="5258675">.</span><span class="ident" id="5258676">Write</span><span class="op" id="5258681">(</span><span class="ident" id="5258682">data</span><span class="op" id="5258686">)</span><span class="op" id="5258687">;</span>&nbsp;<span class="ident" id="5258689">err</span>&nbsp;<span class="op" id="5258693">!=</span>&nbsp;<span class="ident" id="5258696">nil</span>&nbsp;<span class="op" id="5258700">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258704">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258715">if</span>&nbsp;<span class="ident" id="5258718">n</span>&nbsp;<span class="op" id="5258720">!=</span>&nbsp;<span class="builtinfunc" id="5258723">len</span><span class="op" id="5258726">(</span><span class="ident" id="5258727">data</span><span class="op" id="5258731">)</span>&nbsp;<span class="op" id="5258733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258737">err</span>&nbsp;<span class="op" id="5258741">=</span>&nbsp;<span class="ident" id="5258743">io</span><span class="op" id="5258745">.</span><span class="ident" id="5258746">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258762">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5258770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258773">_</span><span class="op" id="5258774">,</span>&nbsp;<span class="ident" id="5258776">err</span>&nbsp;<span class="op" id="5258780">=</span>&nbsp;<span class="ident" id="5258782">io</span><span class="op" id="5258784">.</span><span class="ident" id="5258785">WriteString</span><span class="op" id="5258796">(</span><span class="ident" id="5258797">cw</span><span class="op" id="5258799">.</span><span class="ident" id="5258800">Wire</span><span class="op" id="5258804">,</span>&nbsp;<span class="string" id="5258806">&#34;\r\n&#34;</span><span class="op" id="5258812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258816">return</span><br>
<span class="lineno"></span><span class="op" id="5258823">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="5258826">func</span>&nbsp;<span class="op" id="5258831">(</span><span class="ident" id="5258832">cw</span>&nbsp;<span class="op" id="5258835">*</span><span class="ident" id="5258836">chunkedWriter</span><span class="op" id="5258849">)</span>&nbsp;<span class="ident" id="5258851">Close</span><span class="op" id="5258856">(</span><span class="op" id="5258857">)</span>&nbsp;<span class="builtintype" id="5258859">error</span>&nbsp;<span class="op" id="5258865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5258868">_</span><span class="op" id="5258869">,</span>&nbsp;<span class="ident" id="5258871">err</span>&nbsp;<span class="op" id="5258875">:=</span>&nbsp;<span class="ident" id="5258878">io</span><span class="op" id="5258880">.</span><span class="ident" id="5258881">WriteString</span><span class="op" id="5258892">(</span><span class="ident" id="5258893">cw</span><span class="op" id="5258895">.</span><span class="ident" id="5258896">Wire</span><span class="op" id="5258900">,</span>&nbsp;<span class="string" id="5258902">&#34;0\r\n&#34;</span><span class="op" id="5258909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258912">return</span>&nbsp;<span class="ident" id="5258919">err</span><br>
<span class="lineno"></span><span class="op" id="5258923">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="5258926">func</span>&nbsp;<span class="ident" id="5258931">parseHexUint</span><span class="op" id="5258943">(</span><span class="ident" id="5258944">v</span>&nbsp;<span class="op" id="5258946">[</span><span class="op" id="5258947">]</span><span class="builtintype" id="5258948">byte</span><span class="op" id="5258952">)</span>&nbsp;<span class="op" id="5258954">(</span><span class="ident" id="5258955">n</span>&nbsp;<span class="ident" id="5258957">uint64</span><span class="op" id="5258963">,</span>&nbsp;<span class="ident" id="5258965">err</span>&nbsp;<span class="builtintype" id="5258969">error</span><span class="op" id="5258974">)</span>&nbsp;<span class="op" id="5258976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5258979">for</span>&nbsp;<span class="ident" id="5258983">_</span><span class="op" id="5258984">,</span>&nbsp;<span class="ident" id="5258986">b</span>&nbsp;<span class="op" id="5258988">:=</span>&nbsp;<span class="keyword" id="5258991">range</span>&nbsp;<span class="ident" id="5258997">v</span>&nbsp;<span class="op" id="5258999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259003">n</span>&nbsp;<span class="op" id="5259005">&lt;&lt;=</span>&nbsp;<span class="num" id="5259009">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259013">switch</span>&nbsp;<span class="op" id="5259020">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259024">case</span>&nbsp;<span class="string" id="5259029">&#39;0&#39;</span>&nbsp;<span class="op" id="5259033">&lt;=</span>&nbsp;<span class="ident" id="5259036">b</span>&nbsp;<span class="op" id="5259038">&amp;&amp;</span>&nbsp;<span class="ident" id="5259041">b</span>&nbsp;<span class="op" id="5259043">&lt;=</span>&nbsp;<span class="string" id="5259046">&#39;9&#39;</span><span class="op" id="5259049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259054">b</span>&nbsp;<span class="op" id="5259056">=</span>&nbsp;<span class="ident" id="5259058">b</span>&nbsp;<span class="op" id="5259060">-</span>&nbsp;<span class="string" id="5259062">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259068">case</span>&nbsp;<span class="string" id="5259073">&#39;a&#39;</span>&nbsp;<span class="op" id="5259077">&lt;=</span>&nbsp;<span class="ident" id="5259080">b</span>&nbsp;<span class="op" id="5259082">&amp;&amp;</span>&nbsp;<span class="ident" id="5259085">b</span>&nbsp;<span class="op" id="5259087">&lt;=</span>&nbsp;<span class="string" id="5259090">&#39;f&#39;</span><span class="op" id="5259093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259098">b</span>&nbsp;<span class="op" id="5259100">=</span>&nbsp;<span class="ident" id="5259102">b</span>&nbsp;<span class="op" id="5259104">-</span>&nbsp;<span class="string" id="5259106">&#39;a&#39;</span>&nbsp;<span class="op" id="5259110">+</span>&nbsp;<span class="num" id="5259112">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259117">case</span>&nbsp;<span class="string" id="5259122">&#39;A&#39;</span>&nbsp;<span class="op" id="5259126">&lt;=</span>&nbsp;<span class="ident" id="5259129">b</span>&nbsp;<span class="op" id="5259131">&amp;&amp;</span>&nbsp;<span class="ident" id="5259134">b</span>&nbsp;<span class="op" id="5259136">&lt;=</span>&nbsp;<span class="string" id="5259139">&#39;F&#39;</span><span class="op" id="5259142">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259147">b</span>&nbsp;<span class="op" id="5259149">=</span>&nbsp;<span class="ident" id="5259151">b</span>&nbsp;<span class="op" id="5259153">-</span>&nbsp;<span class="string" id="5259155">&#39;A&#39;</span>&nbsp;<span class="op" id="5259159">+</span>&nbsp;<span class="num" id="5259161">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259166">default</span><span class="op" id="5259173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259178">return</span>&nbsp;<span class="num" id="5259185">0</span><span class="op" id="5259186">,</span>&nbsp;<span class="ident" id="5259188">errors</span><span class="op" id="5259194">.</span><span class="ident" id="5259195">New</span><span class="op" id="5259198">(</span><span class="string" id="5259199">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="5259229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5259237">n</span>&nbsp;<span class="op" id="5259239">|=</span>&nbsp;<span class="ident" id="5259242">uint64</span><span class="op" id="5259248">(</span><span class="ident" id="5259249">b</span><span class="op" id="5259250">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5259253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5259256">return</span><br>
<span class="lineno"></span><span class="op" id="5259263">}</span>
</div>
</body>
</html>
