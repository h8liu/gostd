<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Binary&nbsp;to&nbsp;decimal&nbsp;floating&nbsp;point&nbsp;conversion.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Algorithm:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;1)&nbsp;store&nbsp;mantissa&nbsp;in&nbsp;multiprecision&nbsp;decimal</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;2)&nbsp;shift&nbsp;decimal&nbsp;by&nbsp;exponent</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;3)&nbsp;read&nbsp;digits&nbsp;out&nbsp;&amp;&nbsp;format</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">strconv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="string">&#34;math&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;TODO:&nbsp;move&nbsp;elsewhere?</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">floatInfo</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantbits</span>&nbsp;<span class="builtintype">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">expbits</span>&nbsp;&nbsp;<span class="builtintype">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bias</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">20</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">float32info</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">floatInfo</span><span class="op">{</span><span class="num">23</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="op">-</span><span class="num">127</span><span class="op">}</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">float64info</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">floatInfo</span><span class="op">{</span><span class="num">52</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="op">-</span><span class="num">1023</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;FormatFloat&nbsp;converts&nbsp;the&nbsp;floating-point&nbsp;number&nbsp;f&nbsp;to&nbsp;a&nbsp;string,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;according&nbsp;to&nbsp;the&nbsp;format&nbsp;fmt&nbsp;and&nbsp;precision&nbsp;prec.&nbsp;&nbsp;It&nbsp;rounds&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;result&nbsp;assuming&nbsp;that&nbsp;the&nbsp;original&nbsp;was&nbsp;obtained&nbsp;from&nbsp;a&nbsp;floating-point</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;value&nbsp;of&nbsp;bitSize&nbsp;bits&nbsp;(32&nbsp;for&nbsp;float32,&nbsp;64&nbsp;for&nbsp;float64).</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">30</span><span class="comment">//&nbsp;The&nbsp;format&nbsp;fmt&nbsp;is&nbsp;one&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#39;b&#39;&nbsp;(-ddddp±ddd,&nbsp;a&nbsp;binary&nbsp;exponent),</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#39;e&#39;&nbsp;(-d.dddde±dd,&nbsp;a&nbsp;decimal&nbsp;exponent),</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#39;E&#39;&nbsp;(-d.ddddE±dd,&nbsp;a&nbsp;decimal&nbsp;exponent),</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#39;f&#39;&nbsp;(-ddd.dddd,&nbsp;no&nbsp;exponent),</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;&#39;g&#39;&nbsp;(&#39;e&#39;&nbsp;for&nbsp;large&nbsp;exponents,&nbsp;&#39;f&#39;&nbsp;otherwise),&nbsp;or</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#39;G&#39;&nbsp;(&#39;E&#39;&nbsp;for&nbsp;large&nbsp;exponents,&nbsp;&#39;f&#39;&nbsp;otherwise).</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;precision&nbsp;prec&nbsp;controls&nbsp;the&nbsp;number&nbsp;of&nbsp;digits</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(excluding&nbsp;the&nbsp;exponent)&nbsp;printed&nbsp;by&nbsp;the&nbsp;&#39;e&#39;,&nbsp;&#39;E&#39;,&nbsp;&#39;f&#39;,&nbsp;&#39;g&#39;,&nbsp;and&nbsp;&#39;G&#39;&nbsp;formats.</span><br>
<span class="lineno">40</span><span class="comment">//&nbsp;For&nbsp;&#39;e&#39;,&nbsp;&#39;E&#39;,&nbsp;and&nbsp;&#39;f&#39;&nbsp;it&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;after&nbsp;the&nbsp;decimal&nbsp;point.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;For&nbsp;&#39;g&#39;&nbsp;and&nbsp;&#39;G&#39;&nbsp;it&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;digits.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;special&nbsp;precision&nbsp;-1&nbsp;uses&nbsp;the&nbsp;smallest&nbsp;number&nbsp;of&nbsp;digits</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;necessary&nbsp;such&nbsp;that&nbsp;ParseFloat&nbsp;will&nbsp;return&nbsp;f&nbsp;exactly.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">FormatFloat</span><span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float64</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">bitSize</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">genericFtoa</span><span class="op">(</span><span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">prec</span><span class="op">+</span><span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">bitSize</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;AppendFloat&nbsp;appends&nbsp;the&nbsp;string&nbsp;form&nbsp;of&nbsp;the&nbsp;floating-point&nbsp;number&nbsp;f,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;as&nbsp;generated&nbsp;by&nbsp;FormatFloat,&nbsp;to&nbsp;dst&nbsp;and&nbsp;returns&nbsp;the&nbsp;extended&nbsp;buffer.</span><br>
<span class="lineno">50</span><span class="keyword">func</span>&nbsp;<span class="ident">AppendFloat</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="builtintype">float64</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">bitSize</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">genericFtoa</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">bitSize</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">genericFtoa</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">val</span>&nbsp;<span class="builtintype">float64</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">bitSize</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">flt</span>&nbsp;<span class="op">*</span><span class="ident">floatInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">bitSize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">32</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">math</span><span class="op">.</span><span class="ident">Float32bits</span><span class="op">(</span><span class="builtintype">float32</span><span class="op">(</span><span class="ident">val</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">float32info</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">Float64bits</span><span class="op">(</span><span class="ident">val</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">float64info</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;strconv:&nbsp;illegal&nbsp;AppendFloat/FormatFloat&nbsp;bitSize&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">neg</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bits</span><span class="op">&gt;&gt;</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">expbits</span><span class="op">+</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">bits</span><span class="op">&gt;&gt;</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">flt</span><span class="op">.</span><span class="ident">expbits</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mant</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">flt</span><span class="op">.</span><span class="ident">expbits</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Inf,&nbsp;NaN</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;NaN&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">neg</span><span class="op">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;-Inf&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;+Inf&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;denormalized</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span><span class="op">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;add&nbsp;implicit&nbsp;top&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mant</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">flt</span><span class="op">.</span><span class="ident">bias</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Pick&nbsp;off&nbsp;easy&nbsp;binary&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;b&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmtB</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">flt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">optimize</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">bigFtoa</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">flt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">digs</span>&nbsp;<span class="ident">decimalSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Negative&nbsp;precision&nbsp;means&nbsp;&#34;only&nbsp;as&nbsp;much&nbsp;as&nbsp;needed&nbsp;to&nbsp;be&nbsp;exact.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shortest</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shortest</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Try&nbsp;Grisu3&nbsp;algorithm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">extFloat</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lower</span><span class="op">,</span>&nbsp;<span class="ident">upper</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">AssignComputeBounds</span><span class="op">(</span><span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">flt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="num">32</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digs</span><span class="op">.</span><span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">ShortestDecimal</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">lower</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">upper</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">bigFtoa</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">flt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Precision&nbsp;for&nbsp;shortest&nbsp;representation&nbsp;mode.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;e&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;E&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;f&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><span class="op">-</span><span class="ident">digs</span><span class="op">.</span><span class="ident">dp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;g&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;G&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#39;f&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Fixed&nbsp;number&nbsp;of&nbsp;digits.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;e&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;E&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digits</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;g&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;G&#39;</span><span class="op">:</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">prec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">digits</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">15</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;try&nbsp;fast&nbsp;algorithm&nbsp;when&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;is&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="num">24</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digs</span><span class="op">.</span><span class="ident">d</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">extFloat</span><span class="op">{</span><span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">FixedDecimal</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">digits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">bigFtoa</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">flt</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">formatDigits</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">shortest</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;bigFtoa&nbsp;uses&nbsp;multiprecision&nbsp;computations&nbsp;to&nbsp;format&nbsp;a&nbsp;float.</span><br>
<span class="lineno">155</span><span class="keyword">func</span>&nbsp;<span class="ident">bigFtoa</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="ident">uint64</span><span class="op">,</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">flt</span>&nbsp;<span class="op">*</span><span class="ident">floatInfo</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decimal</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Assign</span><span class="op">(</span><span class="ident">mant</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Shift</span><span class="op">(</span><span class="ident">exp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">digs</span>&nbsp;<span class="ident">decimalSlice</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shortest</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shortest</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">roundShortest</span><span class="op">(</span><span class="ident">d</span><span class="op">,</span>&nbsp;<span class="ident">mant</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">flt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decimalSlice</span><span class="op">{</span><span class="ident">d</span><span class="op">:</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nd</span><span class="op">:</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span><span class="op">,</span>&nbsp;<span class="ident">dp</span><span class="op">:</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Precision&nbsp;for&nbsp;shortest&nbsp;representation&nbsp;mode.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;e&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;E&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;f&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><span class="op">-</span><span class="ident">digs</span><span class="op">.</span><span class="ident">dp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;g&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;G&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Round&nbsp;appropriately.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;e&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;E&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Round</span><span class="op">(</span><span class="ident">prec</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;f&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Round</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">prec</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;g&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;G&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Round</span><span class="op">(</span><span class="ident">prec</span><span class="op">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">decimalSlice</span><span class="op">{</span><span class="ident">d</span><span class="op">:</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nd</span><span class="op">:</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span><span class="op">,</span>&nbsp;<span class="ident">dp</span><span class="op">:</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">formatDigits</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">shortest</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">formatDigits</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">shortest</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">digs</span>&nbsp;<span class="ident">decimalSlice</span><span class="op">,</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;e&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;E&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmtE</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;f&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmtF</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;g&#39;</span><span class="op">,</span>&nbsp;<span class="string">&#39;G&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;trailing&nbsp;fractional&nbsp;zeros&nbsp;in&nbsp;&#39;e&#39;&nbsp;form&nbsp;will&nbsp;be&nbsp;trimmed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">eprec</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prec</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">eprec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">eprec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;%e&nbsp;is&nbsp;used&nbsp;if&nbsp;the&nbsp;exponent&nbsp;from&nbsp;the&nbsp;conversion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;is&nbsp;less&nbsp;than&nbsp;-4&nbsp;or&nbsp;greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;the&nbsp;precision.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;if&nbsp;precision&nbsp;was&nbsp;the&nbsp;shortest&nbsp;possible,&nbsp;use&nbsp;precision&nbsp;6&nbsp;for&nbsp;this&nbsp;decision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shortest</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">eprec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="op">-</span><span class="num">4</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">eprec</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmtE</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">-</span><span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">+</span><span class="string">&#39;e&#39;</span><span class="op">-</span><span class="string">&#39;g&#39;</span><span class="op">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">digs</span><span class="op">.</span><span class="ident">nd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmtF</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">neg</span><span class="op">,</span>&nbsp;<span class="ident">digs</span><span class="op">,</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">prec</span><span class="op">-</span><span class="ident">digs</span><span class="op">.</span><span class="ident">dp</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;unknown&nbsp;format</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;%&#39;</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Round&nbsp;d&nbsp;(=&nbsp;mant&nbsp;*&nbsp;2^exp)&nbsp;to&nbsp;the&nbsp;shortest&nbsp;number&nbsp;of&nbsp;digits</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;will&nbsp;let&nbsp;the&nbsp;original&nbsp;floating&nbsp;point&nbsp;value&nbsp;be&nbsp;precisely</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;reconstructed.&nbsp;&nbsp;Size&nbsp;is&nbsp;original&nbsp;floating&nbsp;point&nbsp;size&nbsp;(64&nbsp;or&nbsp;32).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">roundShortest</span><span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">decimal</span><span class="op">,</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="ident">uint64</span><span class="op">,</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">flt</span>&nbsp;<span class="op">*</span><span class="ident">floatInfo</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;mantissa&nbsp;is&nbsp;zero,&nbsp;the&nbsp;number&nbsp;is&nbsp;zero;&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Compute&nbsp;upper&nbsp;and&nbsp;lower&nbsp;such&nbsp;that&nbsp;any&nbsp;decimal&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;between&nbsp;upper&nbsp;and&nbsp;lower&nbsp;(possibly&nbsp;inclusive)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;will&nbsp;round&nbsp;to&nbsp;the&nbsp;original&nbsp;floating&nbsp;point&nbsp;number.</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;may&nbsp;see&nbsp;at&nbsp;once&nbsp;that&nbsp;the&nbsp;number&nbsp;is&nbsp;already&nbsp;shortest.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Suppose&nbsp;d&nbsp;is&nbsp;not&nbsp;denormal,&nbsp;so&nbsp;that&nbsp;2^exp&nbsp;&lt;=&nbsp;d&nbsp;&lt;&nbsp;10^dp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;closest&nbsp;shorter&nbsp;number&nbsp;is&nbsp;at&nbsp;least&nbsp;10^(dp-nd)&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;lower/upper&nbsp;bounds&nbsp;computed&nbsp;below&nbsp;are&nbsp;at&nbsp;distance</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;at&nbsp;most&nbsp;2^(exp-mantbits).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;So&nbsp;the&nbsp;number&nbsp;is&nbsp;already&nbsp;shortest&nbsp;if&nbsp;10^(dp-nd)&nbsp;&gt;&nbsp;2^(exp-mantbits),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;or&nbsp;equivalently&nbsp;log2(10)*(dp-nd)&nbsp;&gt;&nbsp;exp-mantbits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;It&nbsp;is&nbsp;true&nbsp;if&nbsp;332/100*(dp-nd)&nbsp;&gt;=&nbsp;exp-mantbits&nbsp;(log2(10)&nbsp;&gt;&nbsp;3.32).</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">minexp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">flt</span><span class="op">.</span><span class="ident">bias</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;minimum&nbsp;possible&nbsp;exponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">minexp</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="num">332</span><span class="op">*</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">dp</span><span class="op">-</span><span class="ident">d</span><span class="op">.</span><span class="ident">nd</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">100</span><span class="op">*</span><span class="op">(</span><span class="ident">exp</span><span class="op">-</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;number&nbsp;is&nbsp;already&nbsp;shortest.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;d&nbsp;=&nbsp;mant&nbsp;&lt;&lt;&nbsp;(exp&nbsp;-&nbsp;mantbits)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Next&nbsp;highest&nbsp;floating&nbsp;point&nbsp;number&nbsp;is&nbsp;mant+1&nbsp;&lt;&lt;&nbsp;exp-mantbits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Our&nbsp;upper&nbsp;bound&nbsp;is&nbsp;halfway&nbsp;between,&nbsp;mant*2+1&nbsp;&lt;&lt;&nbsp;exp-mantbits-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">upper</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decimal</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">upper</span><span class="op">.</span><span class="ident">Assign</span><span class="op">(</span><span class="ident">mant</span><span class="op">*</span><span class="num">2</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">upper</span><span class="op">.</span><span class="ident">Shift</span><span class="op">(</span><span class="ident">exp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;d&nbsp;=&nbsp;mant&nbsp;&lt;&lt;&nbsp;(exp&nbsp;-&nbsp;mantbits)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Next&nbsp;lowest&nbsp;floating&nbsp;point&nbsp;number&nbsp;is&nbsp;mant-1&nbsp;&lt;&lt;&nbsp;exp-mantbits,</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;unless&nbsp;mant-1&nbsp;drops&nbsp;the&nbsp;significant&nbsp;bit&nbsp;and&nbsp;exp&nbsp;is&nbsp;not&nbsp;the&nbsp;minimum&nbsp;exp,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;next&nbsp;lowest&nbsp;is&nbsp;mant*2-1&nbsp;&lt;&lt;&nbsp;exp-mantbits-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Either&nbsp;way,&nbsp;call&nbsp;it&nbsp;mantlo&nbsp;&lt;&lt;&nbsp;explo-mantbits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Our&nbsp;lower&nbsp;bound&nbsp;is&nbsp;halfway&nbsp;between,&nbsp;mantlo*2+1&nbsp;&lt;&lt;&nbsp;explo-mantbits-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">mantlo</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">explo</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">minexp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantlo</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">explo</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">exp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantlo</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mant</span><span class="op">*</span><span class="num">2</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">explo</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lower</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">decimal</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lower</span><span class="op">.</span><span class="ident">Assign</span><span class="op">(</span><span class="ident">mantlo</span><span class="op">*</span><span class="num">2</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lower</span><span class="op">.</span><span class="ident">Shift</span><span class="op">(</span><span class="ident">explo</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;upper&nbsp;and&nbsp;lower&nbsp;bounds&nbsp;are&nbsp;possible&nbsp;outputs&nbsp;only&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;original&nbsp;mantissa&nbsp;is&nbsp;even,&nbsp;so&nbsp;that&nbsp;IEEE&nbsp;round-to-even</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;would&nbsp;round&nbsp;to&nbsp;the&nbsp;original&nbsp;mantissa&nbsp;and&nbsp;not&nbsp;the&nbsp;neighbors.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inclusive</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mant</span><span class="op">%</span><span class="num">2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Now&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;the&nbsp;minimum&nbsp;number&nbsp;of&nbsp;digits&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Walk&nbsp;along&nbsp;until&nbsp;d&nbsp;has&nbsp;distinguished&nbsp;itself&nbsp;from&nbsp;upper&nbsp;and&nbsp;lower.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="builtintype">byte</span>&nbsp;<span class="comment">//&nbsp;lower,&nbsp;middle,&nbsp;upper&nbsp;digits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">lower</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">lower</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;0&#39;</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">upper</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">upper</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Okay&nbsp;to&nbsp;round&nbsp;down&nbsp;(truncate)&nbsp;if&nbsp;lower&nbsp;has&nbsp;a&nbsp;different&nbsp;digit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;or&nbsp;if&nbsp;lower&nbsp;is&nbsp;inclusive&nbsp;and&nbsp;is&nbsp;exactly&nbsp;the&nbsp;result&nbsp;of&nbsp;rounding&nbsp;down.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">okdown</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">(</span><span class="ident">inclusive</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">i</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">lower</span><span class="op">.</span><span class="ident">nd</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Okay&nbsp;to&nbsp;round&nbsp;up&nbsp;if&nbsp;upper&nbsp;has&nbsp;a&nbsp;different&nbsp;digit&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;either&nbsp;upper&nbsp;is&nbsp;inclusive&nbsp;or&nbsp;upper&nbsp;is&nbsp;bigger&nbsp;than&nbsp;the&nbsp;result&nbsp;of&nbsp;rounding&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">okup</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">inclusive</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">m</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">i</span><span class="op">+</span><span class="num">1</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">upper</span><span class="op">.</span><span class="ident">nd</span><span class="op">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;do&nbsp;either,&nbsp;then&nbsp;round&nbsp;to&nbsp;the&nbsp;nearest&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;do&nbsp;only&nbsp;one,&nbsp;do&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">okdown</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">okup</span><span class="op">:</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">Round</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">okdown</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">RoundDown</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">okup</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">.</span><span class="ident">RoundUp</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">325</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">decimalSlice</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nd</span><span class="op">,</span>&nbsp;<span class="ident">dp</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">neg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;%e:&nbsp;-d.ddddde±dd</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">fmtE</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="ident">decimalSlice</span><span class="op">,</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span>&nbsp;<span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;sign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;-&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;first&nbsp;digit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">ch</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;.moredigits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;.&#39;</span><span class="op">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">nd</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;e±</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">fmt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;special&nbsp;case:&nbsp;0&nbsp;has&nbsp;exponent&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;-&#39;</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">exp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;+&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">ch</span><span class="op">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;dddd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="num">3</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">10</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">exp</span><span class="op">%</span><span class="num">10</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">/=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;exp&nbsp;&lt;&nbsp;10</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">exp</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">2</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;leading&nbsp;zeroes</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dst</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span><span class="comment">//&nbsp;%f:&nbsp;-ddddddd.ddddd</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">fmtF</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="ident">decimalSlice</span><span class="op">,</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;sign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;-&#39;</span><span class="op">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;integer,&nbsp;padded&nbsp;with&nbsp;zeros&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;fraction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="string">&#39;.&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">prec</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">dp</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">i</span><span class="op">;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">nd</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">d</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">ch</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dst</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment">//&nbsp;%b:&nbsp;-ddddddddp+ddd</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">fmtB</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="ident">uint64</span><span class="op">,</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">flt</span>&nbsp;<span class="op">*</span><span class="ident">floatInfo</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="num">50</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">flt</span><span class="op">.</span><span class="ident">mantbits</span><span class="op">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">esign</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="string">&#39;+&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">esign</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;-&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">exp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">w</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">exp</span><span class="op">%</span><span class="num">10</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">/=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">w</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">esign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">--</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">w</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;p&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">mant</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">--</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">w</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">byte</span><span class="op">(</span><span class="ident">mant</span><span class="op">%</span><span class="num">10</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#39;0&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mant</span>&nbsp;<span class="op">/=</span>&nbsp;<span class="num">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span><span class="op">--</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">w</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#39;-&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">dst</span><span class="op">,</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="ident">w</span><span class="op">:</span><span class="op">]</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword">func</span>&nbsp;<span class="ident">max</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno">475</span><span class="op">}</span>
</div>
</body>
</html>
