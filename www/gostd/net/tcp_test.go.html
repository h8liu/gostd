<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html" class="current">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7623886">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7623941">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7623995">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7624046">package</span>&nbsp;<span class="ident" id="7624054">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624059">import</span>&nbsp;<span class="op" id="7624066">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624069">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624076">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624082">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624093">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624104">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624112">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7624123">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7624130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624133">func</span>&nbsp;<span class="ident" id="7624138">BenchmarkTCP4OneShot</span><span class="op" id="7624158">(</span><span class="ident" id="7624159">b</span>&nbsp;<span class="op" id="7624161">*</span><span class="ident" id="7624162">testing</span><span class="op" id="7624169">.</span><span class="ident" id="7624170">B</span><span class="op" id="7624171">)</span>&nbsp;<span class="op" id="7624173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624176">benchmarkTCP</span><span class="op" id="7624188">(</span><span class="ident" id="7624189">b</span><span class="op" id="7624190">,</span>&nbsp;<span class="builtintype" id="7624192">false</span><span class="op" id="7624197">,</span>&nbsp;<span class="builtintype" id="7624199">false</span><span class="op" id="7624204">,</span>&nbsp;<span class="string" id="7624206">&#34;127.0.0.1:0&#34;</span><span class="op" id="7624219">)</span><br>
<span class="lineno"></span><span class="op" id="7624221">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7624224">func</span>&nbsp;<span class="ident" id="7624229">BenchmarkTCP4OneShotTimeout</span><span class="op" id="7624256">(</span><span class="ident" id="7624257">b</span>&nbsp;<span class="op" id="7624259">*</span><span class="ident" id="7624260">testing</span><span class="op" id="7624267">.</span><span class="ident" id="7624268">B</span><span class="op" id="7624269">)</span>&nbsp;<span class="op" id="7624271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624274">benchmarkTCP</span><span class="op" id="7624286">(</span><span class="ident" id="7624287">b</span><span class="op" id="7624288">,</span>&nbsp;<span class="builtintype" id="7624290">false</span><span class="op" id="7624295">,</span>&nbsp;<span class="builtintype" id="7624297">true</span><span class="op" id="7624301">,</span>&nbsp;<span class="string" id="7624303">&#34;127.0.0.1:0&#34;</span><span class="op" id="7624316">)</span><br>
<span class="lineno"></span><span class="op" id="7624318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7624321">func</span>&nbsp;<span class="ident" id="7624326">BenchmarkTCP4Persistent</span><span class="op" id="7624349">(</span><span class="ident" id="7624350">b</span>&nbsp;<span class="op" id="7624352">*</span><span class="ident" id="7624353">testing</span><span class="op" id="7624360">.</span><span class="ident" id="7624361">B</span><span class="op" id="7624362">)</span>&nbsp;<span class="op" id="7624364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624367">benchmarkTCP</span><span class="op" id="7624379">(</span><span class="ident" id="7624380">b</span><span class="op" id="7624381">,</span>&nbsp;<span class="builtintype" id="7624383">true</span><span class="op" id="7624387">,</span>&nbsp;<span class="builtintype" id="7624389">false</span><span class="op" id="7624394">,</span>&nbsp;<span class="string" id="7624396">&#34;127.0.0.1:0&#34;</span><span class="op" id="7624409">)</span><br>
<span class="lineno"></span><span class="op" id="7624411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624414">func</span>&nbsp;<span class="ident" id="7624419">BenchmarkTCP4PersistentTimeout</span><span class="op" id="7624449">(</span><span class="ident" id="7624450">b</span>&nbsp;<span class="op" id="7624452">*</span><span class="ident" id="7624453">testing</span><span class="op" id="7624460">.</span><span class="ident" id="7624461">B</span><span class="op" id="7624462">)</span>&nbsp;<span class="op" id="7624464">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624467">benchmarkTCP</span><span class="op" id="7624479">(</span><span class="ident" id="7624480">b</span><span class="op" id="7624481">,</span>&nbsp;<span class="builtintype" id="7624483">true</span><span class="op" id="7624487">,</span>&nbsp;<span class="builtintype" id="7624489">true</span><span class="op" id="7624493">,</span>&nbsp;<span class="string" id="7624495">&#34;127.0.0.1:0&#34;</span><span class="op" id="7624508">)</span><br>
<span class="lineno"></span><span class="op" id="7624510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624513">func</span>&nbsp;<span class="ident" id="7624518">BenchmarkTCP6OneShot</span><span class="op" id="7624538">(</span><span class="ident" id="7624539">b</span>&nbsp;<span class="op" id="7624541">*</span><span class="ident" id="7624542">testing</span><span class="op" id="7624549">.</span><span class="ident" id="7624550">B</span><span class="op" id="7624551">)</span>&nbsp;<span class="op" id="7624553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624556">if</span>&nbsp;<span class="op" id="7624559">!</span><span class="ident" id="7624560">supportsIPv6</span>&nbsp;<span class="op" id="7624573">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624577">b</span><span class="op" id="7624578">.</span><span class="ident" id="7624579">Skip</span><span class="op" id="7624583">(</span><span class="string" id="7624584">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7624607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624613">benchmarkTCP</span><span class="op" id="7624625">(</span><span class="ident" id="7624626">b</span><span class="op" id="7624627">,</span>&nbsp;<span class="builtintype" id="7624629">false</span><span class="op" id="7624634">,</span>&nbsp;<span class="builtintype" id="7624636">false</span><span class="op" id="7624641">,</span>&nbsp;<span class="string" id="7624643">&#34;[::1]:0&#34;</span><span class="op" id="7624652">)</span><br>
<span class="lineno"></span><span class="op" id="7624654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="7624657">func</span>&nbsp;<span class="ident" id="7624662">BenchmarkTCP6OneShotTimeout</span><span class="op" id="7624689">(</span><span class="ident" id="7624690">b</span>&nbsp;<span class="op" id="7624692">*</span><span class="ident" id="7624693">testing</span><span class="op" id="7624700">.</span><span class="ident" id="7624701">B</span><span class="op" id="7624702">)</span>&nbsp;<span class="op" id="7624704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624707">if</span>&nbsp;<span class="op" id="7624710">!</span><span class="ident" id="7624711">supportsIPv6</span>&nbsp;<span class="op" id="7624724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624728">b</span><span class="op" id="7624729">.</span><span class="ident" id="7624730">Skip</span><span class="op" id="7624734">(</span><span class="string" id="7624735">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7624758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624764">benchmarkTCP</span><span class="op" id="7624776">(</span><span class="ident" id="7624777">b</span><span class="op" id="7624778">,</span>&nbsp;<span class="builtintype" id="7624780">false</span><span class="op" id="7624785">,</span>&nbsp;<span class="builtintype" id="7624787">true</span><span class="op" id="7624791">,</span>&nbsp;<span class="string" id="7624793">&#34;[::1]:0&#34;</span><span class="op" id="7624802">)</span><br>
<span class="lineno">45</span><span class="op" id="7624804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624807">func</span>&nbsp;<span class="ident" id="7624812">BenchmarkTCP6Persistent</span><span class="op" id="7624835">(</span><span class="ident" id="7624836">b</span>&nbsp;<span class="op" id="7624838">*</span><span class="ident" id="7624839">testing</span><span class="op" id="7624846">.</span><span class="ident" id="7624847">B</span><span class="op" id="7624848">)</span>&nbsp;<span class="op" id="7624850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7624853">if</span>&nbsp;<span class="op" id="7624856">!</span><span class="ident" id="7624857">supportsIPv6</span>&nbsp;<span class="op" id="7624870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624874">b</span><span class="op" id="7624875">.</span><span class="ident" id="7624876">Skip</span><span class="op" id="7624880">(</span><span class="string" id="7624881">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7624904">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624910">benchmarkTCP</span><span class="op" id="7624922">(</span><span class="ident" id="7624923">b</span><span class="op" id="7624924">,</span>&nbsp;<span class="builtintype" id="7624926">true</span><span class="op" id="7624930">,</span>&nbsp;<span class="builtintype" id="7624932">false</span><span class="op" id="7624937">,</span>&nbsp;<span class="string" id="7624939">&#34;[::1]:0&#34;</span><span class="op" id="7624948">)</span><br>
<span class="lineno"></span><span class="op" id="7624950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624953">func</span>&nbsp;<span class="ident" id="7624958">BenchmarkTCP6PersistentTimeout</span><span class="op" id="7624988">(</span><span class="ident" id="7624989">b</span>&nbsp;<span class="op" id="7624991">*</span><span class="ident" id="7624992">testing</span><span class="op" id="7624999">.</span><span class="ident" id="7625000">B</span><span class="op" id="7625001">)</span>&nbsp;<span class="op" id="7625003">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625006">if</span>&nbsp;<span class="op" id="7625009">!</span><span class="ident" id="7625010">supportsIPv6</span>&nbsp;<span class="op" id="7625023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625027">b</span><span class="op" id="7625028">.</span><span class="ident" id="7625029">Skip</span><span class="op" id="7625033">(</span><span class="string" id="7625034">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7625057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625063">benchmarkTCP</span><span class="op" id="7625075">(</span><span class="ident" id="7625076">b</span><span class="op" id="7625077">,</span>&nbsp;<span class="builtintype" id="7625079">true</span><span class="op" id="7625083">,</span>&nbsp;<span class="builtintype" id="7625085">true</span><span class="op" id="7625089">,</span>&nbsp;<span class="string" id="7625091">&#34;[::1]:0&#34;</span><span class="op" id="7625100">)</span><br>
<span class="lineno"></span><span class="op" id="7625102">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="7625105">func</span>&nbsp;<span class="ident" id="7625110">benchmarkTCP</span><span class="op" id="7625122">(</span><span class="ident" id="7625123">b</span>&nbsp;<span class="op" id="7625125">*</span><span class="ident" id="7625126">testing</span><span class="op" id="7625133">.</span><span class="ident" id="7625134">B</span><span class="op" id="7625135">,</span>&nbsp;<span class="ident" id="7625137">persistent</span><span class="op" id="7625147">,</span>&nbsp;<span class="ident" id="7625149">timeout</span>&nbsp;<span class="builtintype" id="7625157">bool</span><span class="op" id="7625161">,</span>&nbsp;<span class="ident" id="7625163">laddr</span>&nbsp;<span class="builtintype" id="7625169">string</span><span class="op" id="7625175">)</span>&nbsp;<span class="op" id="7625177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625180">const</span>&nbsp;<span class="ident" id="7625186">msgLen</span>&nbsp;<span class="op" id="7625193">=</span>&nbsp;<span class="num" id="7625195">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625200">conns</span>&nbsp;<span class="op" id="7625206">:=</span>&nbsp;<span class="ident" id="7625209">b</span><span class="op" id="7625210">.</span><span class="ident" id="7625211">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625214">numConcurrent</span>&nbsp;<span class="op" id="7625228">:=</span>&nbsp;<span class="ident" id="7625231">runtime</span><span class="op" id="7625238">.</span><span class="ident" id="7625239">GOMAXPROCS</span><span class="op" id="7625249">(</span><span class="op" id="7625250">-</span><span class="num" id="7625251">1</span><span class="op" id="7625252">)</span>&nbsp;<span class="op" id="7625254">*</span>&nbsp;<span class="num" id="7625256">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625259">msgs</span>&nbsp;<span class="op" id="7625264">:=</span>&nbsp;<span class="num" id="7625267">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625270">if</span>&nbsp;<span class="ident" id="7625273">persistent</span>&nbsp;<span class="op" id="7625284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625288">conns</span>&nbsp;<span class="op" id="7625294">=</span>&nbsp;<span class="ident" id="7625296">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625312">msgs</span>&nbsp;<span class="op" id="7625317">=</span>&nbsp;<span class="ident" id="7625319">b</span><span class="op" id="7625320">.</span><span class="ident" id="7625321">N</span>&nbsp;<span class="op" id="7625323">/</span>&nbsp;<span class="ident" id="7625325">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625333">if</span>&nbsp;<span class="ident" id="7625336">msgs</span>&nbsp;<span class="op" id="7625341">==</span>&nbsp;<span class="num" id="7625344">0</span>&nbsp;<span class="op" id="7625346">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625351">msgs</span>&nbsp;<span class="op" id="7625356">=</span>&nbsp;<span class="num" id="7625358">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625366">if</span>&nbsp;<span class="ident" id="7625369">conns</span>&nbsp;<span class="op" id="7625375">&gt;</span>&nbsp;<span class="ident" id="7625377">b</span><span class="op" id="7625378">.</span><span class="ident" id="7625379">N</span>&nbsp;<span class="op" id="7625381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625386">conns</span>&nbsp;<span class="op" id="7625392">=</span>&nbsp;<span class="ident" id="7625394">b</span><span class="op" id="7625395">.</span><span class="ident" id="7625396">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625400">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625406">sendMsg</span>&nbsp;<span class="op" id="7625414">:=</span>&nbsp;<span class="keyword" id="7625417">func</span><span class="op" id="7625421">(</span><span class="ident" id="7625422">c</span>&nbsp;<span class="ident" id="7625424">Conn</span><span class="op" id="7625428">,</span>&nbsp;<span class="ident" id="7625430">buf</span>&nbsp;<span class="op" id="7625434">[</span><span class="op" id="7625435">]</span><span class="builtintype" id="7625436">byte</span><span class="op" id="7625440">)</span>&nbsp;<span class="builtintype" id="7625442">bool</span>&nbsp;<span class="op" id="7625447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625451">n</span><span class="op" id="7625452">,</span>&nbsp;<span class="ident" id="7625454">err</span>&nbsp;<span class="op" id="7625458">:=</span>&nbsp;<span class="ident" id="7625461">c</span><span class="op" id="7625462">.</span><span class="ident" id="7625463">Write</span><span class="op" id="7625468">(</span><span class="ident" id="7625469">buf</span><span class="op" id="7625472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625476">if</span>&nbsp;<span class="ident" id="7625479">n</span>&nbsp;<span class="op" id="7625481">!=</span>&nbsp;<span class="builtinfunc" id="7625484">len</span><span class="op" id="7625487">(</span><span class="ident" id="7625488">buf</span><span class="op" id="7625491">)</span>&nbsp;<span class="op" id="7625493">||</span>&nbsp;<span class="ident" id="7625496">err</span>&nbsp;<span class="op" id="7625500">!=</span>&nbsp;<span class="ident" id="7625503">nil</span>&nbsp;<span class="op" id="7625507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625512">b</span><span class="op" id="7625513">.</span><span class="ident" id="7625514">Logf</span><span class="op" id="7625518">(</span><span class="string" id="7625519">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7625537">,</span>&nbsp;<span class="ident" id="7625539">err</span><span class="op" id="7625542">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625547">return</span>&nbsp;<span class="builtintype" id="7625554">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625566">return</span>&nbsp;<span class="builtintype" id="7625573">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625582">recvMsg</span>&nbsp;<span class="op" id="7625590">:=</span>&nbsp;<span class="keyword" id="7625593">func</span><span class="op" id="7625597">(</span><span class="ident" id="7625598">c</span>&nbsp;<span class="ident" id="7625600">Conn</span><span class="op" id="7625604">,</span>&nbsp;<span class="ident" id="7625606">buf</span>&nbsp;<span class="op" id="7625610">[</span><span class="op" id="7625611">]</span><span class="builtintype" id="7625612">byte</span><span class="op" id="7625616">)</span>&nbsp;<span class="builtintype" id="7625618">bool</span>&nbsp;<span class="op" id="7625623">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625627">for</span>&nbsp;<span class="ident" id="7625631">read</span>&nbsp;<span class="op" id="7625636">:=</span>&nbsp;<span class="num" id="7625639">0</span><span class="op" id="7625640">;</span>&nbsp;<span class="ident" id="7625642">read</span>&nbsp;<span class="op" id="7625647">!=</span>&nbsp;<span class="builtinfunc" id="7625650">len</span><span class="op" id="7625653">(</span><span class="ident" id="7625654">buf</span><span class="op" id="7625657">)</span><span class="op" id="7625658">;</span>&nbsp;<span class="op" id="7625660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625665">n</span><span class="op" id="7625666">,</span>&nbsp;<span class="ident" id="7625668">err</span>&nbsp;<span class="op" id="7625672">:=</span>&nbsp;<span class="ident" id="7625675">c</span><span class="op" id="7625676">.</span><span class="ident" id="7625677">Read</span><span class="op" id="7625681">(</span><span class="ident" id="7625682">buf</span><span class="op" id="7625685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625690">read</span>&nbsp;<span class="op" id="7625695">+=</span>&nbsp;<span class="ident" id="7625698">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625703">if</span>&nbsp;<span class="ident" id="7625706">err</span>&nbsp;<span class="op" id="7625710">!=</span>&nbsp;<span class="ident" id="7625713">nil</span>&nbsp;<span class="op" id="7625717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625723">b</span><span class="op" id="7625724">.</span><span class="ident" id="7625725">Logf</span><span class="op" id="7625729">(</span><span class="string" id="7625730">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7625747">,</span>&nbsp;<span class="ident" id="7625749">err</span><span class="op" id="7625752">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625758">return</span>&nbsp;<span class="builtintype" id="7625765">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625782">return</span>&nbsp;<span class="builtintype" id="7625789">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625795">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625798">ln</span><span class="op" id="7625800">,</span>&nbsp;<span class="ident" id="7625802">err</span>&nbsp;<span class="op" id="7625806">:=</span>&nbsp;<span class="ident" id="7625809">Listen</span><span class="op" id="7625815">(</span><span class="string" id="7625816">&#34;tcp&#34;</span><span class="op" id="7625821">,</span>&nbsp;<span class="ident" id="7625823">laddr</span><span class="op" id="7625828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625831">if</span>&nbsp;<span class="ident" id="7625834">err</span>&nbsp;<span class="op" id="7625838">!=</span>&nbsp;<span class="ident" id="7625841">nil</span>&nbsp;<span class="op" id="7625845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625849">b</span><span class="op" id="7625850">.</span><span class="ident" id="7625851">Fatalf</span><span class="op" id="7625857">(</span><span class="string" id="7625858">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7625877">,</span>&nbsp;<span class="ident" id="7625879">err</span><span class="op" id="7625882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625888">defer</span>&nbsp;<span class="ident" id="7625894">ln</span><span class="op" id="7625896">.</span><span class="ident" id="7625897">Close</span><span class="op" id="7625902">(</span><span class="op" id="7625903">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625906">serverSem</span>&nbsp;<span class="op" id="7625916">:=</span>&nbsp;<span class="builtinfunc" id="7625919">make</span><span class="op" id="7625923">(</span><span class="keyword" id="7625924">chan</span>&nbsp;<span class="builtintype" id="7625929">bool</span><span class="op" id="7625933">,</span>&nbsp;<span class="ident" id="7625935">numConcurrent</span><span class="op" id="7625948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7625951">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625965">go</span>&nbsp;<span class="keyword" id="7625968">func</span><span class="op" id="7625972">(</span><span class="op" id="7625973">)</span>&nbsp;<span class="op" id="7625975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625979">for</span>&nbsp;<span class="op" id="7625983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625988">c</span><span class="op" id="7625989">,</span>&nbsp;<span class="ident" id="7625991">err</span>&nbsp;<span class="op" id="7625995">:=</span>&nbsp;<span class="ident" id="7625998">ln</span><span class="op" id="7626000">.</span><span class="ident" id="7626001">Accept</span><span class="op" id="7626007">(</span><span class="op" id="7626008">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626013">if</span>&nbsp;<span class="ident" id="7626016">err</span>&nbsp;<span class="op" id="7626020">!=</span>&nbsp;<span class="ident" id="7626023">nil</span>&nbsp;<span class="op" id="7626027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626033">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626047">serverSem</span>&nbsp;<span class="op" id="7626057">&lt;-</span>&nbsp;<span class="builtintype" id="7626060">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626068">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626093">go</span>&nbsp;<span class="keyword" id="7626096">func</span><span class="op" id="7626100">(</span><span class="ident" id="7626101">c</span>&nbsp;<span class="ident" id="7626103">Conn</span><span class="op" id="7626107">)</span>&nbsp;<span class="op" id="7626109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626115">defer</span>&nbsp;<span class="keyword" id="7626121">func</span><span class="op" id="7626125">(</span><span class="op" id="7626126">)</span>&nbsp;<span class="op" id="7626128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626135">c</span><span class="op" id="7626136">.</span><span class="ident" id="7626137">Close</span><span class="op" id="7626142">(</span><span class="op" id="7626143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626150">&lt;-</span><span class="ident" id="7626152">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626166">}</span><span class="op" id="7626167">(</span><span class="op" id="7626168">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626174">if</span>&nbsp;<span class="ident" id="7626177">timeout</span>&nbsp;<span class="op" id="7626185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626192">c</span><span class="op" id="7626193">.</span><span class="ident" id="7626194">SetDeadline</span><span class="op" id="7626205">(</span><span class="ident" id="7626206">time</span><span class="op" id="7626210">.</span><span class="ident" id="7626211">Now</span><span class="op" id="7626214">(</span><span class="op" id="7626215">)</span><span class="op" id="7626216">.</span><span class="ident" id="7626217">Add</span><span class="op" id="7626220">(</span><span class="ident" id="7626221">time</span><span class="op" id="7626225">.</span><span class="ident" id="7626226">Hour</span><span class="op" id="7626230">)</span><span class="op" id="7626231">)</span>&nbsp;<span class="comment" id="7626233">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626268">var</span>&nbsp;<span class="ident" id="7626272">buf</span>&nbsp;<span class="op" id="7626276">[</span><span class="ident" id="7626277">msgLen</span><span class="op" id="7626283">]</span><span class="builtintype" id="7626284">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626293">for</span>&nbsp;<span class="ident" id="7626297">m</span>&nbsp;<span class="op" id="7626299">:=</span>&nbsp;<span class="num" id="7626302">0</span><span class="op" id="7626303">;</span>&nbsp;<span class="ident" id="7626305">m</span>&nbsp;<span class="op" id="7626307">&lt;</span>&nbsp;<span class="ident" id="7626309">msgs</span><span class="op" id="7626313">;</span>&nbsp;<span class="ident" id="7626315">m</span><span class="op" id="7626316">++</span>&nbsp;<span class="op" id="7626319">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626326">if</span>&nbsp;<span class="op" id="7626329">!</span><span class="ident" id="7626330">recvMsg</span><span class="op" id="7626337">(</span><span class="ident" id="7626338">c</span><span class="op" id="7626339">,</span>&nbsp;<span class="ident" id="7626341">buf</span><span class="op" id="7626344">[</span><span class="op" id="7626345">:</span><span class="op" id="7626346">]</span><span class="op" id="7626347">)</span>&nbsp;<span class="op" id="7626349">||</span>&nbsp;<span class="op" id="7626352">!</span><span class="ident" id="7626353">sendMsg</span><span class="op" id="7626360">(</span><span class="ident" id="7626361">c</span><span class="op" id="7626362">,</span>&nbsp;<span class="ident" id="7626364">buf</span><span class="op" id="7626367">[</span><span class="op" id="7626368">:</span><span class="op" id="7626369">]</span><span class="op" id="7626370">)</span>&nbsp;<span class="op" id="7626372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626380">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626402">}</span><span class="op" id="7626403">(</span><span class="ident" id="7626404">c</span><span class="op" id="7626405">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626412">}</span><span class="op" id="7626413">(</span><span class="op" id="7626414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626417">clientSem</span>&nbsp;<span class="op" id="7626427">:=</span>&nbsp;<span class="builtinfunc" id="7626430">make</span><span class="op" id="7626434">(</span><span class="keyword" id="7626435">chan</span>&nbsp;<span class="builtintype" id="7626440">bool</span><span class="op" id="7626444">,</span>&nbsp;<span class="ident" id="7626446">numConcurrent</span><span class="op" id="7626459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626462">for</span>&nbsp;<span class="ident" id="7626466">i</span>&nbsp;<span class="op" id="7626468">:=</span>&nbsp;<span class="num" id="7626471">0</span><span class="op" id="7626472">;</span>&nbsp;<span class="ident" id="7626474">i</span>&nbsp;<span class="op" id="7626476">&lt;</span>&nbsp;<span class="ident" id="7626478">conns</span><span class="op" id="7626483">;</span>&nbsp;<span class="ident" id="7626485">i</span><span class="op" id="7626486">++</span>&nbsp;<span class="op" id="7626489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626493">clientSem</span>&nbsp;<span class="op" id="7626503">&lt;-</span>&nbsp;<span class="builtintype" id="7626506">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626513">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626537">go</span>&nbsp;<span class="keyword" id="7626540">func</span><span class="op" id="7626544">(</span><span class="op" id="7626545">)</span>&nbsp;<span class="op" id="7626547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626552">defer</span>&nbsp;<span class="keyword" id="7626558">func</span><span class="op" id="7626562">(</span><span class="op" id="7626563">)</span>&nbsp;<span class="op" id="7626565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626571">&lt;-</span><span class="ident" id="7626573">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626586">}</span><span class="op" id="7626587">(</span><span class="op" id="7626588">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626593">c</span><span class="op" id="7626594">,</span>&nbsp;<span class="ident" id="7626596">err</span>&nbsp;<span class="op" id="7626600">:=</span>&nbsp;<span class="ident" id="7626603">Dial</span><span class="op" id="7626607">(</span><span class="string" id="7626608">&#34;tcp&#34;</span><span class="op" id="7626613">,</span>&nbsp;<span class="ident" id="7626615">ln</span><span class="op" id="7626617">.</span><span class="ident" id="7626618">Addr</span><span class="op" id="7626622">(</span><span class="op" id="7626623">)</span><span class="op" id="7626624">.</span><span class="ident" id="7626625">String</span><span class="op" id="7626631">(</span><span class="op" id="7626632">)</span><span class="op" id="7626633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626638">if</span>&nbsp;<span class="ident" id="7626641">err</span>&nbsp;<span class="op" id="7626645">!=</span>&nbsp;<span class="ident" id="7626648">nil</span>&nbsp;<span class="op" id="7626652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626658">b</span><span class="op" id="7626659">.</span><span class="ident" id="7626660">Logf</span><span class="op" id="7626664">(</span><span class="string" id="7626665">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7626682">,</span>&nbsp;<span class="ident" id="7626684">err</span><span class="op" id="7626687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626693">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626703">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626708">defer</span>&nbsp;<span class="ident" id="7626714">c</span><span class="op" id="7626715">.</span><span class="ident" id="7626716">Close</span><span class="op" id="7626721">(</span><span class="op" id="7626722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626727">if</span>&nbsp;<span class="ident" id="7626730">timeout</span>&nbsp;<span class="op" id="7626738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626744">c</span><span class="op" id="7626745">.</span><span class="ident" id="7626746">SetDeadline</span><span class="op" id="7626757">(</span><span class="ident" id="7626758">time</span><span class="op" id="7626762">.</span><span class="ident" id="7626763">Now</span><span class="op" id="7626766">(</span><span class="op" id="7626767">)</span><span class="op" id="7626768">.</span><span class="ident" id="7626769">Add</span><span class="op" id="7626772">(</span><span class="ident" id="7626773">time</span><span class="op" id="7626777">.</span><span class="ident" id="7626778">Hour</span><span class="op" id="7626782">)</span><span class="op" id="7626783">)</span>&nbsp;<span class="comment" id="7626785">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626818">var</span>&nbsp;<span class="ident" id="7626822">buf</span>&nbsp;<span class="op" id="7626826">[</span><span class="ident" id="7626827">msgLen</span><span class="op" id="7626833">]</span><span class="builtintype" id="7626834">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626842">for</span>&nbsp;<span class="ident" id="7626846">m</span>&nbsp;<span class="op" id="7626848">:=</span>&nbsp;<span class="num" id="7626851">0</span><span class="op" id="7626852">;</span>&nbsp;<span class="ident" id="7626854">m</span>&nbsp;<span class="op" id="7626856">&lt;</span>&nbsp;<span class="ident" id="7626858">msgs</span><span class="op" id="7626862">;</span>&nbsp;<span class="ident" id="7626864">m</span><span class="op" id="7626865">++</span>&nbsp;<span class="op" id="7626868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626874">if</span>&nbsp;<span class="op" id="7626877">!</span><span class="ident" id="7626878">sendMsg</span><span class="op" id="7626885">(</span><span class="ident" id="7626886">c</span><span class="op" id="7626887">,</span>&nbsp;<span class="ident" id="7626889">buf</span><span class="op" id="7626892">[</span><span class="op" id="7626893">:</span><span class="op" id="7626894">]</span><span class="op" id="7626895">)</span>&nbsp;<span class="op" id="7626897">||</span>&nbsp;<span class="op" id="7626900">!</span><span class="ident" id="7626901">recvMsg</span><span class="op" id="7626908">(</span><span class="ident" id="7626909">c</span><span class="op" id="7626910">,</span>&nbsp;<span class="ident" id="7626912">buf</span><span class="op" id="7626915">[</span><span class="op" id="7626916">:</span><span class="op" id="7626917">]</span><span class="op" id="7626918">)</span>&nbsp;<span class="op" id="7626920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626927">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626942">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626946">}</span><span class="op" id="7626947">(</span><span class="op" id="7626948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626954">for</span>&nbsp;<span class="ident" id="7626958">i</span>&nbsp;<span class="op" id="7626960">:=</span>&nbsp;<span class="num" id="7626963">0</span><span class="op" id="7626964">;</span>&nbsp;<span class="ident" id="7626966">i</span>&nbsp;<span class="op" id="7626968">&lt;</span>&nbsp;<span class="ident" id="7626970">numConcurrent</span><span class="op" id="7626983">;</span>&nbsp;<span class="ident" id="7626985">i</span><span class="op" id="7626986">++</span>&nbsp;<span class="op" id="7626989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626993">clientSem</span>&nbsp;<span class="op" id="7627003">&lt;-</span>&nbsp;<span class="builtintype" id="7627006">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627013">serverSem</span>&nbsp;<span class="op" id="7627023">&lt;-</span>&nbsp;<span class="builtintype" id="7627026">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627032">}</span><br>
<span class="lineno"></span><span class="op" id="7627034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7627037">func</span>&nbsp;<span class="ident" id="7627042">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="7627074">(</span><span class="ident" id="7627075">b</span>&nbsp;<span class="op" id="7627077">*</span><span class="ident" id="7627078">testing</span><span class="op" id="7627085">.</span><span class="ident" id="7627086">B</span><span class="op" id="7627087">)</span>&nbsp;<span class="op" id="7627089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627092">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7627123">(</span><span class="ident" id="7627124">b</span><span class="op" id="7627125">,</span>&nbsp;<span class="string" id="7627127">&#34;127.0.0.1:0&#34;</span><span class="op" id="7627140">)</span><br>
<span class="lineno">160</span><span class="op" id="7627142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7627145">func</span>&nbsp;<span class="ident" id="7627150">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="7627182">(</span><span class="ident" id="7627183">b</span>&nbsp;<span class="op" id="7627185">*</span><span class="ident" id="7627186">testing</span><span class="op" id="7627193">.</span><span class="ident" id="7627194">B</span><span class="op" id="7627195">)</span>&nbsp;<span class="op" id="7627197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627200">if</span>&nbsp;<span class="op" id="7627203">!</span><span class="ident" id="7627204">supportsIPv6</span>&nbsp;<span class="op" id="7627217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627221">b</span><span class="op" id="7627222">.</span><span class="ident" id="7627223">Skip</span><span class="op" id="7627227">(</span><span class="string" id="7627228">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7627251">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627257">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7627288">(</span><span class="ident" id="7627289">b</span><span class="op" id="7627290">,</span>&nbsp;<span class="string" id="7627292">&#34;[::1]:0&#34;</span><span class="op" id="7627301">)</span><br>
<span class="lineno"></span><span class="op" id="7627303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7627306">func</span>&nbsp;<span class="ident" id="7627311">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7627342">(</span><span class="ident" id="7627343">b</span>&nbsp;<span class="op" id="7627345">*</span><span class="ident" id="7627346">testing</span><span class="op" id="7627353">.</span><span class="ident" id="7627354">B</span><span class="op" id="7627355">,</span>&nbsp;<span class="ident" id="7627357">laddr</span>&nbsp;<span class="builtintype" id="7627363">string</span><span class="op" id="7627369">)</span>&nbsp;<span class="op" id="7627371">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7627374">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7627432">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7627515">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7627597">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627648">b</span><span class="op" id="7627649">.</span><span class="ident" id="7627650">StopTimer</span><span class="op" id="7627659">(</span><span class="op" id="7627660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627664">P</span>&nbsp;<span class="op" id="7627666">:=</span>&nbsp;<span class="ident" id="7627669">runtime</span><span class="op" id="7627676">.</span><span class="ident" id="7627677">GOMAXPROCS</span><span class="op" id="7627687">(</span><span class="num" id="7627688">0</span><span class="op" id="7627689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627692">N</span>&nbsp;<span class="op" id="7627694">:=</span>&nbsp;<span class="ident" id="7627697">b</span><span class="op" id="7627698">.</span><span class="ident" id="7627699">N</span>&nbsp;<span class="op" id="7627701">/</span>&nbsp;<span class="ident" id="7627703">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627706">W</span>&nbsp;<span class="op" id="7627708">:=</span>&nbsp;<span class="num" id="7627711">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7627718">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627757">clients</span>&nbsp;<span class="op" id="7627765">:=</span>&nbsp;<span class="builtinfunc" id="7627768">make</span><span class="op" id="7627772">(</span><span class="op" id="7627773">[</span><span class="op" id="7627774">]</span><span class="ident" id="7627775">Conn</span><span class="op" id="7627779">,</span>&nbsp;<span class="ident" id="7627781">P</span><span class="op" id="7627782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627785">servers</span>&nbsp;<span class="op" id="7627793">:=</span>&nbsp;<span class="builtinfunc" id="7627796">make</span><span class="op" id="7627800">(</span><span class="op" id="7627801">[</span><span class="op" id="7627802">]</span><span class="ident" id="7627803">Conn</span><span class="op" id="7627807">,</span>&nbsp;<span class="ident" id="7627809">P</span><span class="op" id="7627810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627813">ln</span><span class="op" id="7627815">,</span>&nbsp;<span class="ident" id="7627817">err</span>&nbsp;<span class="op" id="7627821">:=</span>&nbsp;<span class="ident" id="7627824">Listen</span><span class="op" id="7627830">(</span><span class="string" id="7627831">&#34;tcp&#34;</span><span class="op" id="7627836">,</span>&nbsp;<span class="ident" id="7627838">laddr</span><span class="op" id="7627843">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627846">if</span>&nbsp;<span class="ident" id="7627849">err</span>&nbsp;<span class="op" id="7627853">!=</span>&nbsp;<span class="ident" id="7627856">nil</span>&nbsp;<span class="op" id="7627860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627864">b</span><span class="op" id="7627865">.</span><span class="ident" id="7627866">Fatalf</span><span class="op" id="7627872">(</span><span class="string" id="7627873">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7627892">,</span>&nbsp;<span class="ident" id="7627894">err</span><span class="op" id="7627897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627903">defer</span>&nbsp;<span class="ident" id="7627909">ln</span><span class="op" id="7627911">.</span><span class="ident" id="7627912">Close</span><span class="op" id="7627917">(</span><span class="op" id="7627918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627921">done</span>&nbsp;<span class="op" id="7627926">:=</span>&nbsp;<span class="builtinfunc" id="7627929">make</span><span class="op" id="7627933">(</span><span class="keyword" id="7627934">chan</span>&nbsp;<span class="builtintype" id="7627939">bool</span><span class="op" id="7627943">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627946">go</span>&nbsp;<span class="keyword" id="7627949">func</span><span class="op" id="7627953">(</span><span class="op" id="7627954">)</span>&nbsp;<span class="op" id="7627956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627960">for</span>&nbsp;<span class="ident" id="7627964">p</span>&nbsp;<span class="op" id="7627966">:=</span>&nbsp;<span class="num" id="7627969">0</span><span class="op" id="7627970">;</span>&nbsp;<span class="ident" id="7627972">p</span>&nbsp;<span class="op" id="7627974">&lt;</span>&nbsp;<span class="ident" id="7627976">P</span><span class="op" id="7627977">;</span>&nbsp;<span class="ident" id="7627979">p</span><span class="op" id="7627980">++</span>&nbsp;<span class="op" id="7627983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627988">s</span><span class="op" id="7627989">,</span>&nbsp;<span class="ident" id="7627991">err</span>&nbsp;<span class="op" id="7627995">:=</span>&nbsp;<span class="ident" id="7627998">ln</span><span class="op" id="7628000">.</span><span class="ident" id="7628001">Accept</span><span class="op" id="7628007">(</span><span class="op" id="7628008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628013">if</span>&nbsp;<span class="ident" id="7628016">err</span>&nbsp;<span class="op" id="7628020">!=</span>&nbsp;<span class="ident" id="7628023">nil</span>&nbsp;<span class="op" id="7628027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628033">b</span><span class="op" id="7628034">.</span><span class="ident" id="7628035">Errorf</span><span class="op" id="7628041">(</span><span class="string" id="7628042">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7628061">,</span>&nbsp;<span class="ident" id="7628063">err</span><span class="op" id="7628066">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628072">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628087">servers</span><span class="op" id="7628094">[</span><span class="ident" id="7628095">p</span><span class="op" id="7628096">]</span>&nbsp;<span class="op" id="7628098">=</span>&nbsp;<span class="ident" id="7628100">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628108">done</span>&nbsp;<span class="op" id="7628113">&lt;-</span>&nbsp;<span class="builtintype" id="7628116">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628122">}</span><span class="op" id="7628123">(</span><span class="op" id="7628124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628127">for</span>&nbsp;<span class="ident" id="7628131">p</span>&nbsp;<span class="op" id="7628133">:=</span>&nbsp;<span class="num" id="7628136">0</span><span class="op" id="7628137">;</span>&nbsp;<span class="ident" id="7628139">p</span>&nbsp;<span class="op" id="7628141">&lt;</span>&nbsp;<span class="ident" id="7628143">P</span><span class="op" id="7628144">;</span>&nbsp;<span class="ident" id="7628146">p</span><span class="op" id="7628147">++</span>&nbsp;<span class="op" id="7628150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628154">c</span><span class="op" id="7628155">,</span>&nbsp;<span class="ident" id="7628157">err</span>&nbsp;<span class="op" id="7628161">:=</span>&nbsp;<span class="ident" id="7628164">Dial</span><span class="op" id="7628168">(</span><span class="string" id="7628169">&#34;tcp&#34;</span><span class="op" id="7628174">,</span>&nbsp;<span class="ident" id="7628176">ln</span><span class="op" id="7628178">.</span><span class="ident" id="7628179">Addr</span><span class="op" id="7628183">(</span><span class="op" id="7628184">)</span><span class="op" id="7628185">.</span><span class="ident" id="7628186">String</span><span class="op" id="7628192">(</span><span class="op" id="7628193">)</span><span class="op" id="7628194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628198">if</span>&nbsp;<span class="ident" id="7628201">err</span>&nbsp;<span class="op" id="7628205">!=</span>&nbsp;<span class="ident" id="7628208">nil</span>&nbsp;<span class="op" id="7628212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628217">b</span><span class="op" id="7628218">.</span><span class="ident" id="7628219">Fatalf</span><span class="op" id="7628225">(</span><span class="string" id="7628226">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7628243">,</span>&nbsp;<span class="ident" id="7628245">err</span><span class="op" id="7628248">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628256">clients</span><span class="op" id="7628263">[</span><span class="ident" id="7628264">p</span><span class="op" id="7628265">]</span>&nbsp;<span class="op" id="7628267">=</span>&nbsp;<span class="ident" id="7628269">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628275">&lt;-</span><span class="ident" id="7628277">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628284">b</span><span class="op" id="7628285">.</span><span class="ident" id="7628286">StartTimer</span><span class="op" id="7628296">(</span><span class="op" id="7628297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628301">var</span>&nbsp;<span class="ident" id="7628305">wg</span>&nbsp;<span class="ident" id="7628308">sync</span><span class="op" id="7628312">.</span><span class="ident" id="7628313">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628324">wg</span><span class="op" id="7628326">.</span><span class="ident" id="7628327">Add</span><span class="op" id="7628330">(</span><span class="num" id="7628331">4</span>&nbsp;<span class="op" id="7628333">*</span>&nbsp;<span class="ident" id="7628335">P</span><span class="op" id="7628336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628339">for</span>&nbsp;<span class="ident" id="7628343">p</span>&nbsp;<span class="op" id="7628345">:=</span>&nbsp;<span class="num" id="7628348">0</span><span class="op" id="7628349">;</span>&nbsp;<span class="ident" id="7628351">p</span>&nbsp;<span class="op" id="7628353">&lt;</span>&nbsp;<span class="ident" id="7628355">P</span><span class="op" id="7628356">;</span>&nbsp;<span class="ident" id="7628358">p</span><span class="op" id="7628359">++</span>&nbsp;<span class="op" id="7628362">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628366">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628386">go</span>&nbsp;<span class="keyword" id="7628389">func</span><span class="op" id="7628393">(</span><span class="ident" id="7628394">c</span>&nbsp;<span class="ident" id="7628396">Conn</span><span class="op" id="7628400">)</span>&nbsp;<span class="op" id="7628402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628407">defer</span>&nbsp;<span class="ident" id="7628413">wg</span><span class="op" id="7628415">.</span><span class="ident" id="7628416">Done</span><span class="op" id="7628420">(</span><span class="op" id="7628421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628426">var</span>&nbsp;<span class="ident" id="7628430">buf</span>&nbsp;<span class="op" id="7628434">[</span><span class="num" id="7628435">1</span><span class="op" id="7628436">]</span><span class="builtintype" id="7628437">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628445">for</span>&nbsp;<span class="ident" id="7628449">i</span>&nbsp;<span class="op" id="7628451">:=</span>&nbsp;<span class="num" id="7628454">0</span><span class="op" id="7628455">;</span>&nbsp;<span class="ident" id="7628457">i</span>&nbsp;<span class="op" id="7628459">&lt;</span>&nbsp;<span class="ident" id="7628461">N</span><span class="op" id="7628462">;</span>&nbsp;<span class="ident" id="7628464">i</span><span class="op" id="7628465">++</span>&nbsp;<span class="op" id="7628468">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628474">v</span>&nbsp;<span class="op" id="7628476">:=</span>&nbsp;<span class="builtintype" id="7628479">byte</span><span class="op" id="7628483">(</span><span class="ident" id="7628484">i</span><span class="op" id="7628485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628491">for</span>&nbsp;<span class="ident" id="7628495">w</span>&nbsp;<span class="op" id="7628497">:=</span>&nbsp;<span class="num" id="7628500">0</span><span class="op" id="7628501">;</span>&nbsp;<span class="ident" id="7628503">w</span>&nbsp;<span class="op" id="7628505">&lt;</span>&nbsp;<span class="ident" id="7628507">W</span><span class="op" id="7628508">;</span>&nbsp;<span class="ident" id="7628510">w</span><span class="op" id="7628511">++</span>&nbsp;<span class="op" id="7628514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628521">v</span>&nbsp;<span class="op" id="7628523">*=</span>&nbsp;<span class="ident" id="7628526">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628538">buf</span><span class="op" id="7628541">[</span><span class="num" id="7628542">0</span><span class="op" id="7628543">]</span>&nbsp;<span class="op" id="7628545">=</span>&nbsp;<span class="ident" id="7628547">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628553">_</span><span class="op" id="7628554">,</span>&nbsp;<span class="ident" id="7628556">err</span>&nbsp;<span class="op" id="7628560">:=</span>&nbsp;<span class="ident" id="7628563">c</span><span class="op" id="7628564">.</span><span class="ident" id="7628565">Write</span><span class="op" id="7628570">(</span><span class="ident" id="7628571">buf</span><span class="op" id="7628574">[</span><span class="op" id="7628575">:</span><span class="op" id="7628576">]</span><span class="op" id="7628577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628583">if</span>&nbsp;<span class="ident" id="7628586">err</span>&nbsp;<span class="op" id="7628590">!=</span>&nbsp;<span class="ident" id="7628593">nil</span>&nbsp;<span class="op" id="7628597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628604">b</span><span class="op" id="7628605">.</span><span class="ident" id="7628606">Errorf</span><span class="op" id="7628612">(</span><span class="string" id="7628613">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7628631">,</span>&nbsp;<span class="ident" id="7628633">err</span><span class="op" id="7628636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628643">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628654">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628663">}</span><span class="op" id="7628664">(</span><span class="ident" id="7628665">clients</span><span class="op" id="7628672">[</span><span class="ident" id="7628673">p</span><span class="op" id="7628674">]</span><span class="op" id="7628675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628680">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628731">pipe</span>&nbsp;<span class="op" id="7628736">:=</span>&nbsp;<span class="builtinfunc" id="7628739">make</span><span class="op" id="7628743">(</span><span class="keyword" id="7628744">chan</span>&nbsp;<span class="builtintype" id="7628749">byte</span><span class="op" id="7628753">,</span>&nbsp;<span class="num" id="7628755">128</span><span class="op" id="7628758">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7628763">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628783">go</span>&nbsp;<span class="keyword" id="7628786">func</span><span class="op" id="7628790">(</span><span class="ident" id="7628791">s</span>&nbsp;<span class="ident" id="7628793">Conn</span><span class="op" id="7628797">)</span>&nbsp;<span class="op" id="7628799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628804">defer</span>&nbsp;<span class="ident" id="7628810">wg</span><span class="op" id="7628812">.</span><span class="ident" id="7628813">Done</span><span class="op" id="7628817">(</span><span class="op" id="7628818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628823">var</span>&nbsp;<span class="ident" id="7628827">buf</span>&nbsp;<span class="op" id="7628831">[</span><span class="num" id="7628832">1</span><span class="op" id="7628833">]</span><span class="builtintype" id="7628834">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628842">for</span>&nbsp;<span class="ident" id="7628846">i</span>&nbsp;<span class="op" id="7628848">:=</span>&nbsp;<span class="num" id="7628851">0</span><span class="op" id="7628852">;</span>&nbsp;<span class="ident" id="7628854">i</span>&nbsp;<span class="op" id="7628856">&lt;</span>&nbsp;<span class="ident" id="7628858">N</span><span class="op" id="7628859">;</span>&nbsp;<span class="ident" id="7628861">i</span><span class="op" id="7628862">++</span>&nbsp;<span class="op" id="7628865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628871">_</span><span class="op" id="7628872">,</span>&nbsp;<span class="ident" id="7628874">err</span>&nbsp;<span class="op" id="7628878">:=</span>&nbsp;<span class="ident" id="7628881">s</span><span class="op" id="7628882">.</span><span class="ident" id="7628883">Read</span><span class="op" id="7628887">(</span><span class="ident" id="7628888">buf</span><span class="op" id="7628891">[</span><span class="op" id="7628892">:</span><span class="op" id="7628893">]</span><span class="op" id="7628894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628900">if</span>&nbsp;<span class="ident" id="7628903">err</span>&nbsp;<span class="op" id="7628907">!=</span>&nbsp;<span class="ident" id="7628910">nil</span>&nbsp;<span class="op" id="7628914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628921">b</span><span class="op" id="7628922">.</span><span class="ident" id="7628923">Errorf</span><span class="op" id="7628929">(</span><span class="string" id="7628930">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7628947">,</span>&nbsp;<span class="ident" id="7628949">err</span><span class="op" id="7628952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628959">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628976">pipe</span>&nbsp;<span class="op" id="7628981">&lt;-</span>&nbsp;<span class="ident" id="7628984">buf</span><span class="op" id="7628987">[</span><span class="num" id="7628988">0</span><span class="op" id="7628989">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628998">}</span><span class="op" id="7628999">(</span><span class="ident" id="7629000">servers</span><span class="op" id="7629007">[</span><span class="ident" id="7629008">p</span><span class="op" id="7629009">]</span><span class="op" id="7629010">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629015">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629035">go</span>&nbsp;<span class="keyword" id="7629038">func</span><span class="op" id="7629042">(</span><span class="ident" id="7629043">s</span>&nbsp;<span class="ident" id="7629045">Conn</span><span class="op" id="7629049">)</span>&nbsp;<span class="op" id="7629051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629056">defer</span>&nbsp;<span class="ident" id="7629062">wg</span><span class="op" id="7629064">.</span><span class="ident" id="7629065">Done</span><span class="op" id="7629069">(</span><span class="op" id="7629070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629075">var</span>&nbsp;<span class="ident" id="7629079">buf</span>&nbsp;<span class="op" id="7629083">[</span><span class="num" id="7629084">1</span><span class="op" id="7629085">]</span><span class="builtintype" id="7629086">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629094">for</span>&nbsp;<span class="ident" id="7629098">i</span>&nbsp;<span class="op" id="7629100">:=</span>&nbsp;<span class="num" id="7629103">0</span><span class="op" id="7629104">;</span>&nbsp;<span class="ident" id="7629106">i</span>&nbsp;<span class="op" id="7629108">&lt;</span>&nbsp;<span class="ident" id="7629110">N</span><span class="op" id="7629111">;</span>&nbsp;<span class="ident" id="7629113">i</span><span class="op" id="7629114">++</span>&nbsp;<span class="op" id="7629117">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629123">v</span>&nbsp;<span class="op" id="7629125">:=</span>&nbsp;<span class="op" id="7629128">&lt;-</span><span class="ident" id="7629130">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629139">for</span>&nbsp;<span class="ident" id="7629143">w</span>&nbsp;<span class="op" id="7629145">:=</span>&nbsp;<span class="num" id="7629148">0</span><span class="op" id="7629149">;</span>&nbsp;<span class="ident" id="7629151">w</span>&nbsp;<span class="op" id="7629153">&lt;</span>&nbsp;<span class="ident" id="7629155">W</span><span class="op" id="7629156">;</span>&nbsp;<span class="ident" id="7629158">w</span><span class="op" id="7629159">++</span>&nbsp;<span class="op" id="7629162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629169">v</span>&nbsp;<span class="op" id="7629171">*=</span>&nbsp;<span class="ident" id="7629174">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629186">buf</span><span class="op" id="7629189">[</span><span class="num" id="7629190">0</span><span class="op" id="7629191">]</span>&nbsp;<span class="op" id="7629193">=</span>&nbsp;<span class="ident" id="7629195">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629201">_</span><span class="op" id="7629202">,</span>&nbsp;<span class="ident" id="7629204">err</span>&nbsp;<span class="op" id="7629208">:=</span>&nbsp;<span class="ident" id="7629211">s</span><span class="op" id="7629212">.</span><span class="ident" id="7629213">Write</span><span class="op" id="7629218">(</span><span class="ident" id="7629219">buf</span><span class="op" id="7629222">[</span><span class="op" id="7629223">:</span><span class="op" id="7629224">]</span><span class="op" id="7629225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629231">if</span>&nbsp;<span class="ident" id="7629234">err</span>&nbsp;<span class="op" id="7629238">!=</span>&nbsp;<span class="ident" id="7629241">nil</span>&nbsp;<span class="op" id="7629245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629252">b</span><span class="op" id="7629253">.</span><span class="ident" id="7629254">Errorf</span><span class="op" id="7629260">(</span><span class="string" id="7629261">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7629279">,</span>&nbsp;<span class="ident" id="7629281">err</span><span class="op" id="7629284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629291">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629302">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629312">s</span><span class="op" id="7629313">.</span><span class="ident" id="7629314">Close</span><span class="op" id="7629319">(</span><span class="op" id="7629320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629324">}</span><span class="op" id="7629325">(</span><span class="ident" id="7629326">servers</span><span class="op" id="7629333">[</span><span class="ident" id="7629334">p</span><span class="op" id="7629335">]</span><span class="op" id="7629336">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629341">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629361">go</span>&nbsp;<span class="keyword" id="7629364">func</span><span class="op" id="7629368">(</span><span class="ident" id="7629369">c</span>&nbsp;<span class="ident" id="7629371">Conn</span><span class="op" id="7629375">)</span>&nbsp;<span class="op" id="7629377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629382">defer</span>&nbsp;<span class="ident" id="7629388">wg</span><span class="op" id="7629390">.</span><span class="ident" id="7629391">Done</span><span class="op" id="7629395">(</span><span class="op" id="7629396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629401">var</span>&nbsp;<span class="ident" id="7629405">buf</span>&nbsp;<span class="op" id="7629409">[</span><span class="num" id="7629410">1</span><span class="op" id="7629411">]</span><span class="builtintype" id="7629412">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629420">for</span>&nbsp;<span class="ident" id="7629424">i</span>&nbsp;<span class="op" id="7629426">:=</span>&nbsp;<span class="num" id="7629429">0</span><span class="op" id="7629430">;</span>&nbsp;<span class="ident" id="7629432">i</span>&nbsp;<span class="op" id="7629434">&lt;</span>&nbsp;<span class="ident" id="7629436">N</span><span class="op" id="7629437">;</span>&nbsp;<span class="ident" id="7629439">i</span><span class="op" id="7629440">++</span>&nbsp;<span class="op" id="7629443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629449">_</span><span class="op" id="7629450">,</span>&nbsp;<span class="ident" id="7629452">err</span>&nbsp;<span class="op" id="7629456">:=</span>&nbsp;<span class="ident" id="7629459">c</span><span class="op" id="7629460">.</span><span class="ident" id="7629461">Read</span><span class="op" id="7629465">(</span><span class="ident" id="7629466">buf</span><span class="op" id="7629469">[</span><span class="op" id="7629470">:</span><span class="op" id="7629471">]</span><span class="op" id="7629472">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629478">if</span>&nbsp;<span class="ident" id="7629481">err</span>&nbsp;<span class="op" id="7629485">!=</span>&nbsp;<span class="ident" id="7629488">nil</span>&nbsp;<span class="op" id="7629492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629499">b</span><span class="op" id="7629500">.</span><span class="ident" id="7629501">Errorf</span><span class="op" id="7629507">(</span><span class="string" id="7629508">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7629525">,</span>&nbsp;<span class="ident" id="7629527">err</span><span class="op" id="7629530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629537">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629553">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629558">c</span><span class="op" id="7629559">.</span><span class="ident" id="7629560">Close</span><span class="op" id="7629565">(</span><span class="op" id="7629566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629570">}</span><span class="op" id="7629571">(</span><span class="ident" id="7629572">clients</span><span class="op" id="7629579">[</span><span class="ident" id="7629580">p</span><span class="op" id="7629581">]</span><span class="op" id="7629582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629588">wg</span><span class="op" id="7629590">.</span><span class="ident" id="7629591">Wait</span><span class="op" id="7629595">(</span><span class="op" id="7629596">)</span><br>
<span class="lineno"></span><span class="op" id="7629598">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="7629601">type</span>&nbsp;<span class="ident" id="7629606">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="7629625">struct</span>&nbsp;<span class="op" id="7629632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629635">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7629649">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629657">litAddrOrName</span>&nbsp;<span class="builtintype" id="7629671">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629679">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7629693">*</span><span class="ident" id="7629694">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629703">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7629717">error</span><br>
<span class="lineno"></span><span class="op" id="7629723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7629726">var</span>&nbsp;<span class="ident" id="7629730">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7629750">=</span>&nbsp;<span class="op" id="7629752">[</span><span class="op" id="7629753">]</span><span class="ident" id="7629754">resolveTCPAddrTest</span><span class="op" id="7629772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629775">{</span><span class="string" id="7629776">&#34;tcp&#34;</span><span class="op" id="7629781">,</span>&nbsp;<span class="string" id="7629783">&#34;127.0.0.1:0&#34;</span><span class="op" id="7629796">,</span>&nbsp;<span class="op" id="7629798">&amp;</span><span class="ident" id="7629799">TCPAddr</span><span class="op" id="7629806">{</span><span class="ident" id="7629807">IP</span><span class="op" id="7629809">:</span>&nbsp;<span class="ident" id="7629811">IPv4</span><span class="op" id="7629815">(</span><span class="num" id="7629816">127</span><span class="op" id="7629819">,</span>&nbsp;<span class="num" id="7629821">0</span><span class="op" id="7629822">,</span>&nbsp;<span class="num" id="7629824">0</span><span class="op" id="7629825">,</span>&nbsp;<span class="num" id="7629827">1</span><span class="op" id="7629828">)</span><span class="op" id="7629829">,</span>&nbsp;<span class="ident" id="7629831">Port</span><span class="op" id="7629835">:</span>&nbsp;<span class="num" id="7629837">0</span><span class="op" id="7629838">}</span><span class="op" id="7629839">,</span>&nbsp;<span class="ident" id="7629841">nil</span><span class="op" id="7629844">}</span><span class="op" id="7629845">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629848">{</span><span class="string" id="7629849">&#34;tcp4&#34;</span><span class="op" id="7629855">,</span>&nbsp;<span class="string" id="7629857">&#34;127.0.0.1:65535&#34;</span><span class="op" id="7629874">,</span>&nbsp;<span class="op" id="7629876">&amp;</span><span class="ident" id="7629877">TCPAddr</span><span class="op" id="7629884">{</span><span class="ident" id="7629885">IP</span><span class="op" id="7629887">:</span>&nbsp;<span class="ident" id="7629889">IPv4</span><span class="op" id="7629893">(</span><span class="num" id="7629894">127</span><span class="op" id="7629897">,</span>&nbsp;<span class="num" id="7629899">0</span><span class="op" id="7629900">,</span>&nbsp;<span class="num" id="7629902">0</span><span class="op" id="7629903">,</span>&nbsp;<span class="num" id="7629905">1</span><span class="op" id="7629906">)</span><span class="op" id="7629907">,</span>&nbsp;<span class="ident" id="7629909">Port</span><span class="op" id="7629913">:</span>&nbsp;<span class="num" id="7629915">65535</span><span class="op" id="7629920">}</span><span class="op" id="7629921">,</span>&nbsp;<span class="ident" id="7629923">nil</span><span class="op" id="7629926">}</span><span class="op" id="7629927">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629931">{</span><span class="string" id="7629932">&#34;tcp&#34;</span><span class="op" id="7629937">,</span>&nbsp;<span class="string" id="7629939">&#34;[::1]:1&#34;</span><span class="op" id="7629948">,</span>&nbsp;<span class="op" id="7629950">&amp;</span><span class="ident" id="7629951">TCPAddr</span><span class="op" id="7629958">{</span><span class="ident" id="7629959">IP</span><span class="op" id="7629961">:</span>&nbsp;<span class="ident" id="7629963">ParseIP</span><span class="op" id="7629970">(</span><span class="string" id="7629971">&#34;::1&#34;</span><span class="op" id="7629976">)</span><span class="op" id="7629977">,</span>&nbsp;<span class="ident" id="7629979">Port</span><span class="op" id="7629983">:</span>&nbsp;<span class="num" id="7629985">1</span><span class="op" id="7629986">}</span><span class="op" id="7629987">,</span>&nbsp;<span class="ident" id="7629989">nil</span><span class="op" id="7629992">}</span><span class="op" id="7629993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629996">{</span><span class="string" id="7629997">&#34;tcp6&#34;</span><span class="op" id="7630003">,</span>&nbsp;<span class="string" id="7630005">&#34;[::1]:65534&#34;</span><span class="op" id="7630018">,</span>&nbsp;<span class="op" id="7630020">&amp;</span><span class="ident" id="7630021">TCPAddr</span><span class="op" id="7630028">{</span><span class="ident" id="7630029">IP</span><span class="op" id="7630031">:</span>&nbsp;<span class="ident" id="7630033">ParseIP</span><span class="op" id="7630040">(</span><span class="string" id="7630041">&#34;::1&#34;</span><span class="op" id="7630046">)</span><span class="op" id="7630047">,</span>&nbsp;<span class="ident" id="7630049">Port</span><span class="op" id="7630053">:</span>&nbsp;<span class="num" id="7630055">65534</span><span class="op" id="7630060">}</span><span class="op" id="7630061">,</span>&nbsp;<span class="ident" id="7630063">nil</span><span class="op" id="7630066">}</span><span class="op" id="7630067">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630071">{</span><span class="string" id="7630072">&#34;tcp&#34;</span><span class="op" id="7630077">,</span>&nbsp;<span class="string" id="7630079">&#34;[::1%en0]:1&#34;</span><span class="op" id="7630092">,</span>&nbsp;<span class="op" id="7630094">&amp;</span><span class="ident" id="7630095">TCPAddr</span><span class="op" id="7630102">{</span><span class="ident" id="7630103">IP</span><span class="op" id="7630105">:</span>&nbsp;<span class="ident" id="7630107">ParseIP</span><span class="op" id="7630114">(</span><span class="string" id="7630115">&#34;::1&#34;</span><span class="op" id="7630120">)</span><span class="op" id="7630121">,</span>&nbsp;<span class="ident" id="7630123">Port</span><span class="op" id="7630127">:</span>&nbsp;<span class="num" id="7630129">1</span><span class="op" id="7630130">,</span>&nbsp;<span class="ident" id="7630132">Zone</span><span class="op" id="7630136">:</span>&nbsp;<span class="string" id="7630138">&#34;en0&#34;</span><span class="op" id="7630143">}</span><span class="op" id="7630144">,</span>&nbsp;<span class="ident" id="7630146">nil</span><span class="op" id="7630149">}</span><span class="op" id="7630150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630153">{</span><span class="string" id="7630154">&#34;tcp6&#34;</span><span class="op" id="7630160">,</span>&nbsp;<span class="string" id="7630162">&#34;[::1%911]:2&#34;</span><span class="op" id="7630175">,</span>&nbsp;<span class="op" id="7630177">&amp;</span><span class="ident" id="7630178">TCPAddr</span><span class="op" id="7630185">{</span><span class="ident" id="7630186">IP</span><span class="op" id="7630188">:</span>&nbsp;<span class="ident" id="7630190">ParseIP</span><span class="op" id="7630197">(</span><span class="string" id="7630198">&#34;::1&#34;</span><span class="op" id="7630203">)</span><span class="op" id="7630204">,</span>&nbsp;<span class="ident" id="7630206">Port</span><span class="op" id="7630210">:</span>&nbsp;<span class="num" id="7630212">2</span><span class="op" id="7630213">,</span>&nbsp;<span class="ident" id="7630215">Zone</span><span class="op" id="7630219">:</span>&nbsp;<span class="string" id="7630221">&#34;911&#34;</span><span class="op" id="7630226">}</span><span class="op" id="7630227">,</span>&nbsp;<span class="ident" id="7630229">nil</span><span class="op" id="7630232">}</span><span class="op" id="7630233">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630237">{</span><span class="string" id="7630238">&#34;&#34;</span><span class="op" id="7630240">,</span>&nbsp;<span class="string" id="7630242">&#34;127.0.0.1:0&#34;</span><span class="op" id="7630255">,</span>&nbsp;<span class="op" id="7630257">&amp;</span><span class="ident" id="7630258">TCPAddr</span><span class="op" id="7630265">{</span><span class="ident" id="7630266">IP</span><span class="op" id="7630268">:</span>&nbsp;<span class="ident" id="7630270">IPv4</span><span class="op" id="7630274">(</span><span class="num" id="7630275">127</span><span class="op" id="7630278">,</span>&nbsp;<span class="num" id="7630280">0</span><span class="op" id="7630281">,</span>&nbsp;<span class="num" id="7630283">0</span><span class="op" id="7630284">,</span>&nbsp;<span class="num" id="7630286">1</span><span class="op" id="7630287">)</span><span class="op" id="7630288">,</span>&nbsp;<span class="ident" id="7630290">Port</span><span class="op" id="7630294">:</span>&nbsp;<span class="num" id="7630296">0</span><span class="op" id="7630297">}</span><span class="op" id="7630298">,</span>&nbsp;<span class="ident" id="7630300">nil</span><span class="op" id="7630303">}</span><span class="op" id="7630304">,</span>&nbsp;<span class="comment" id="7630306">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630326">{</span><span class="string" id="7630327">&#34;&#34;</span><span class="op" id="7630329">,</span>&nbsp;<span class="string" id="7630331">&#34;[::1]:0&#34;</span><span class="op" id="7630340">,</span>&nbsp;<span class="op" id="7630342">&amp;</span><span class="ident" id="7630343">TCPAddr</span><span class="op" id="7630350">{</span><span class="ident" id="7630351">IP</span><span class="op" id="7630353">:</span>&nbsp;<span class="ident" id="7630355">ParseIP</span><span class="op" id="7630362">(</span><span class="string" id="7630363">&#34;::1&#34;</span><span class="op" id="7630368">)</span><span class="op" id="7630369">,</span>&nbsp;<span class="ident" id="7630371">Port</span><span class="op" id="7630375">:</span>&nbsp;<span class="num" id="7630377">0</span><span class="op" id="7630378">}</span><span class="op" id="7630379">,</span>&nbsp;<span class="ident" id="7630381">nil</span><span class="op" id="7630384">}</span><span class="op" id="7630385">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7630395">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630416">{</span><span class="string" id="7630417">&#34;tcp&#34;</span><span class="op" id="7630422">,</span>&nbsp;<span class="string" id="7630424">&#34;:12345&#34;</span><span class="op" id="7630432">,</span>&nbsp;<span class="op" id="7630434">&amp;</span><span class="ident" id="7630435">TCPAddr</span><span class="op" id="7630442">{</span><span class="ident" id="7630443">Port</span><span class="op" id="7630447">:</span>&nbsp;<span class="num" id="7630449">12345</span><span class="op" id="7630454">}</span><span class="op" id="7630455">,</span>&nbsp;<span class="ident" id="7630457">nil</span><span class="op" id="7630460">}</span><span class="op" id="7630461">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630465">{</span><span class="string" id="7630466">&#34;http&#34;</span><span class="op" id="7630472">,</span>&nbsp;<span class="string" id="7630474">&#34;127.0.0.1:0&#34;</span><span class="op" id="7630487">,</span>&nbsp;<span class="ident" id="7630489">nil</span><span class="op" id="7630492">,</span>&nbsp;<span class="ident" id="7630494">UnknownNetworkError</span><span class="op" id="7630513">(</span><span class="string" id="7630514">&#34;http&#34;</span><span class="op" id="7630520">)</span><span class="op" id="7630521">}</span><span class="op" id="7630522">,</span><br>
<span class="lineno"></span><span class="op" id="7630524">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="7630527">func</span>&nbsp;<span class="ident" id="7630532">init</span><span class="op" id="7630536">(</span><span class="op" id="7630537">)</span>&nbsp;<span class="op" id="7630539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630542">if</span>&nbsp;<span class="ident" id="7630545">ifi</span>&nbsp;<span class="op" id="7630549">:=</span>&nbsp;<span class="ident" id="7630552">loopbackInterface</span><span class="op" id="7630569">(</span><span class="op" id="7630570">)</span><span class="op" id="7630571">;</span>&nbsp;<span class="ident" id="7630573">ifi</span>&nbsp;<span class="op" id="7630577">!=</span>&nbsp;<span class="ident" id="7630580">nil</span>&nbsp;<span class="op" id="7630584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630588">index</span>&nbsp;<span class="op" id="7630594">:=</span>&nbsp;<span class="ident" id="7630597">fmt</span><span class="op" id="7630600">.</span><span class="ident" id="7630601">Sprintf</span><span class="op" id="7630608">(</span><span class="string" id="7630609">&#34;%v&#34;</span><span class="op" id="7630613">,</span>&nbsp;<span class="ident" id="7630615">ifi</span><span class="op" id="7630618">.</span><span class="ident" id="7630619">Index</span><span class="op" id="7630624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630628">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7630648">=</span>&nbsp;<span class="builtinfunc" id="7630650">append</span><span class="op" id="7630656">(</span><span class="ident" id="7630657">resolveTCPAddrTests</span><span class="op" id="7630676">,</span>&nbsp;<span class="op" id="7630678">[</span><span class="op" id="7630679">]</span><span class="ident" id="7630680">resolveTCPAddrTest</span><span class="op" id="7630698">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630703">{</span><span class="string" id="7630704">&#34;tcp6&#34;</span><span class="op" id="7630710">,</span>&nbsp;<span class="string" id="7630712">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7630724">+</span>&nbsp;<span class="ident" id="7630726">ifi</span><span class="op" id="7630729">.</span><span class="ident" id="7630730">Name</span>&nbsp;<span class="op" id="7630735">+</span>&nbsp;<span class="string" id="7630737">&#34;]:3&#34;</span><span class="op" id="7630742">,</span>&nbsp;<span class="op" id="7630744">&amp;</span><span class="ident" id="7630745">TCPAddr</span><span class="op" id="7630752">{</span><span class="ident" id="7630753">IP</span><span class="op" id="7630755">:</span>&nbsp;<span class="ident" id="7630757">ParseIP</span><span class="op" id="7630764">(</span><span class="string" id="7630765">&#34;fe80::1&#34;</span><span class="op" id="7630774">)</span><span class="op" id="7630775">,</span>&nbsp;<span class="ident" id="7630777">Port</span><span class="op" id="7630781">:</span>&nbsp;<span class="num" id="7630783">3</span><span class="op" id="7630784">,</span>&nbsp;<span class="ident" id="7630786">Zone</span><span class="op" id="7630790">:</span>&nbsp;<span class="ident" id="7630792">zoneToString</span><span class="op" id="7630804">(</span><span class="ident" id="7630805">ifi</span><span class="op" id="7630808">.</span><span class="ident" id="7630809">Index</span><span class="op" id="7630814">)</span><span class="op" id="7630815">}</span><span class="op" id="7630816">,</span>&nbsp;<span class="ident" id="7630818">nil</span><span class="op" id="7630821">}</span><span class="op" id="7630822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630827">{</span><span class="string" id="7630828">&#34;tcp6&#34;</span><span class="op" id="7630834">,</span>&nbsp;<span class="string" id="7630836">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7630848">+</span>&nbsp;<span class="ident" id="7630850">index</span>&nbsp;<span class="op" id="7630856">+</span>&nbsp;<span class="string" id="7630858">&#34;]:4&#34;</span><span class="op" id="7630863">,</span>&nbsp;<span class="op" id="7630865">&amp;</span><span class="ident" id="7630866">TCPAddr</span><span class="op" id="7630873">{</span><span class="ident" id="7630874">IP</span><span class="op" id="7630876">:</span>&nbsp;<span class="ident" id="7630878">ParseIP</span><span class="op" id="7630885">(</span><span class="string" id="7630886">&#34;fe80::1&#34;</span><span class="op" id="7630895">)</span><span class="op" id="7630896">,</span>&nbsp;<span class="ident" id="7630898">Port</span><span class="op" id="7630902">:</span>&nbsp;<span class="num" id="7630904">4</span><span class="op" id="7630905">,</span>&nbsp;<span class="ident" id="7630907">Zone</span><span class="op" id="7630911">:</span>&nbsp;<span class="ident" id="7630913">index</span><span class="op" id="7630918">}</span><span class="op" id="7630919">,</span>&nbsp;<span class="ident" id="7630921">nil</span><span class="op" id="7630924">}</span><span class="op" id="7630925">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630929">}</span><span class="op" id="7630930">...</span><span class="op" id="7630933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630939">if</span>&nbsp;<span class="ident" id="7630942">ips</span><span class="op" id="7630945">,</span>&nbsp;<span class="ident" id="7630947">err</span>&nbsp;<span class="op" id="7630951">:=</span>&nbsp;<span class="ident" id="7630954">LookupIP</span><span class="op" id="7630962">(</span><span class="string" id="7630963">&#34;localhost&#34;</span><span class="op" id="7630974">)</span><span class="op" id="7630975">;</span>&nbsp;<span class="ident" id="7630977">err</span>&nbsp;<span class="op" id="7630981">==</span>&nbsp;<span class="ident" id="7630984">nil</span>&nbsp;<span class="op" id="7630988">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="7630991">len</span><span class="op" id="7630994">(</span><span class="ident" id="7630995">ips</span><span class="op" id="7630998">)</span>&nbsp;<span class="op" id="7631000">&gt;</span>&nbsp;<span class="num" id="7631002">1</span>&nbsp;<span class="op" id="7631004">&amp;&amp;</span>&nbsp;<span class="ident" id="7631007">supportsIPv4</span>&nbsp;<span class="op" id="7631020">&amp;&amp;</span>&nbsp;<span class="ident" id="7631023">supportsIPv6</span>&nbsp;<span class="op" id="7631036">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631040">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7631060">=</span>&nbsp;<span class="builtinfunc" id="7631062">append</span><span class="op" id="7631068">(</span><span class="ident" id="7631069">resolveTCPAddrTests</span><span class="op" id="7631088">,</span>&nbsp;<span class="op" id="7631090">[</span><span class="op" id="7631091">]</span><span class="ident" id="7631092">resolveTCPAddrTest</span><span class="op" id="7631110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631115">{</span><span class="string" id="7631116">&#34;tcp&#34;</span><span class="op" id="7631121">,</span>&nbsp;<span class="string" id="7631123">&#34;localhost:5&#34;</span><span class="op" id="7631136">,</span>&nbsp;<span class="op" id="7631138">&amp;</span><span class="ident" id="7631139">TCPAddr</span><span class="op" id="7631146">{</span><span class="ident" id="7631147">IP</span><span class="op" id="7631149">:</span>&nbsp;<span class="ident" id="7631151">IPv4</span><span class="op" id="7631155">(</span><span class="num" id="7631156">127</span><span class="op" id="7631159">,</span>&nbsp;<span class="num" id="7631161">0</span><span class="op" id="7631162">,</span>&nbsp;<span class="num" id="7631164">0</span><span class="op" id="7631165">,</span>&nbsp;<span class="num" id="7631167">1</span><span class="op" id="7631168">)</span><span class="op" id="7631169">,</span>&nbsp;<span class="ident" id="7631171">Port</span><span class="op" id="7631175">:</span>&nbsp;<span class="num" id="7631177">5</span><span class="op" id="7631178">}</span><span class="op" id="7631179">,</span>&nbsp;<span class="ident" id="7631181">nil</span><span class="op" id="7631184">}</span><span class="op" id="7631185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631190">{</span><span class="string" id="7631191">&#34;tcp4&#34;</span><span class="op" id="7631197">,</span>&nbsp;<span class="string" id="7631199">&#34;localhost:6&#34;</span><span class="op" id="7631212">,</span>&nbsp;<span class="op" id="7631214">&amp;</span><span class="ident" id="7631215">TCPAddr</span><span class="op" id="7631222">{</span><span class="ident" id="7631223">IP</span><span class="op" id="7631225">:</span>&nbsp;<span class="ident" id="7631227">IPv4</span><span class="op" id="7631231">(</span><span class="num" id="7631232">127</span><span class="op" id="7631235">,</span>&nbsp;<span class="num" id="7631237">0</span><span class="op" id="7631238">,</span>&nbsp;<span class="num" id="7631240">0</span><span class="op" id="7631241">,</span>&nbsp;<span class="num" id="7631243">1</span><span class="op" id="7631244">)</span><span class="op" id="7631245">,</span>&nbsp;<span class="ident" id="7631247">Port</span><span class="op" id="7631251">:</span>&nbsp;<span class="num" id="7631253">6</span><span class="op" id="7631254">}</span><span class="op" id="7631255">,</span>&nbsp;<span class="ident" id="7631257">nil</span><span class="op" id="7631260">}</span><span class="op" id="7631261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631266">{</span><span class="string" id="7631267">&#34;tcp6&#34;</span><span class="op" id="7631273">,</span>&nbsp;<span class="string" id="7631275">&#34;localhost:7&#34;</span><span class="op" id="7631288">,</span>&nbsp;<span class="op" id="7631290">&amp;</span><span class="ident" id="7631291">TCPAddr</span><span class="op" id="7631298">{</span><span class="ident" id="7631299">IP</span><span class="op" id="7631301">:</span>&nbsp;<span class="ident" id="7631303">IPv6loopback</span><span class="op" id="7631315">,</span>&nbsp;<span class="ident" id="7631317">Port</span><span class="op" id="7631321">:</span>&nbsp;<span class="num" id="7631323">7</span><span class="op" id="7631324">}</span><span class="op" id="7631325">,</span>&nbsp;<span class="ident" id="7631327">nil</span><span class="op" id="7631330">}</span><span class="op" id="7631331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631335">}</span><span class="op" id="7631336">...</span><span class="op" id="7631339">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631342">}</span><br>
<span class="lineno"></span><span class="op" id="7631344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7631347">func</span>&nbsp;<span class="ident" id="7631352">TestResolveTCPAddr</span><span class="op" id="7631370">(</span><span class="ident" id="7631371">t</span>&nbsp;<span class="op" id="7631373">*</span><span class="ident" id="7631374">testing</span><span class="op" id="7631381">.</span><span class="ident" id="7631382">T</span><span class="op" id="7631383">)</span>&nbsp;<span class="op" id="7631385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631388">for</span>&nbsp;<span class="ident" id="7631392">_</span><span class="op" id="7631393">,</span>&nbsp;<span class="ident" id="7631395">tt</span>&nbsp;<span class="op" id="7631398">:=</span>&nbsp;<span class="keyword" id="7631401">range</span>&nbsp;<span class="ident" id="7631407">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7631427">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631431">addr</span><span class="op" id="7631435">,</span>&nbsp;<span class="ident" id="7631437">err</span>&nbsp;<span class="op" id="7631441">:=</span>&nbsp;<span class="ident" id="7631444">ResolveTCPAddr</span><span class="op" id="7631458">(</span><span class="ident" id="7631459">tt</span><span class="op" id="7631461">.</span><span class="ident" id="7631462">net</span><span class="op" id="7631465">,</span>&nbsp;<span class="ident" id="7631467">tt</span><span class="op" id="7631469">.</span><span class="ident" id="7631470">litAddrOrName</span><span class="op" id="7631483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631487">if</span>&nbsp;<span class="ident" id="7631490">err</span>&nbsp;<span class="op" id="7631494">!=</span>&nbsp;<span class="ident" id="7631497">tt</span><span class="op" id="7631499">.</span><span class="ident" id="7631500">err</span>&nbsp;<span class="op" id="7631504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631509">t</span><span class="op" id="7631510">.</span><span class="ident" id="7631511">Fatalf</span><span class="op" id="7631517">(</span><span class="string" id="7631518">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7631553">,</span>&nbsp;<span class="ident" id="7631555">tt</span><span class="op" id="7631557">.</span><span class="ident" id="7631558">net</span><span class="op" id="7631561">,</span>&nbsp;<span class="ident" id="7631563">tt</span><span class="op" id="7631565">.</span><span class="ident" id="7631566">litAddrOrName</span><span class="op" id="7631579">,</span>&nbsp;<span class="ident" id="7631581">err</span><span class="op" id="7631584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631592">if</span>&nbsp;<span class="op" id="7631595">!</span><span class="ident" id="7631596">reflect</span><span class="op" id="7631603">.</span><span class="ident" id="7631604">DeepEqual</span><span class="op" id="7631613">(</span><span class="ident" id="7631614">addr</span><span class="op" id="7631618">,</span>&nbsp;<span class="ident" id="7631620">tt</span><span class="op" id="7631622">.</span><span class="ident" id="7631623">addr</span><span class="op" id="7631627">)</span>&nbsp;<span class="op" id="7631629">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631634">t</span><span class="op" id="7631635">.</span><span class="ident" id="7631636">Fatalf</span><span class="op" id="7631642">(</span><span class="string" id="7631643">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7631683">,</span>&nbsp;<span class="ident" id="7631685">tt</span><span class="op" id="7631687">.</span><span class="ident" id="7631688">net</span><span class="op" id="7631691">,</span>&nbsp;<span class="ident" id="7631693">tt</span><span class="op" id="7631695">.</span><span class="ident" id="7631696">litAddrOrName</span><span class="op" id="7631709">,</span>&nbsp;<span class="ident" id="7631711">addr</span><span class="op" id="7631715">,</span>&nbsp;<span class="ident" id="7631717">tt</span><span class="op" id="7631719">.</span><span class="ident" id="7631720">addr</span><span class="op" id="7631724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631732">if</span>&nbsp;<span class="ident" id="7631735">err</span>&nbsp;<span class="op" id="7631739">==</span>&nbsp;<span class="ident" id="7631742">nil</span>&nbsp;<span class="op" id="7631746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631751">str</span>&nbsp;<span class="op" id="7631755">:=</span>&nbsp;<span class="ident" id="7631758">addr</span><span class="op" id="7631762">.</span><span class="ident" id="7631763">String</span><span class="op" id="7631769">(</span><span class="op" id="7631770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631775">addr1</span><span class="op" id="7631780">,</span>&nbsp;<span class="ident" id="7631782">err</span>&nbsp;<span class="op" id="7631786">:=</span>&nbsp;<span class="ident" id="7631789">ResolveTCPAddr</span><span class="op" id="7631803">(</span><span class="ident" id="7631804">tt</span><span class="op" id="7631806">.</span><span class="ident" id="7631807">net</span><span class="op" id="7631810">,</span>&nbsp;<span class="ident" id="7631812">str</span><span class="op" id="7631815">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631820">if</span>&nbsp;<span class="ident" id="7631823">err</span>&nbsp;<span class="op" id="7631827">!=</span>&nbsp;<span class="ident" id="7631830">nil</span>&nbsp;<span class="op" id="7631834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631840">t</span><span class="op" id="7631841">.</span><span class="ident" id="7631842">Fatalf</span><span class="op" id="7631848">(</span><span class="string" id="7631849">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="7631887">,</span>&nbsp;<span class="ident" id="7631889">tt</span><span class="op" id="7631891">.</span><span class="ident" id="7631892">net</span><span class="op" id="7631895">,</span>&nbsp;<span class="ident" id="7631897">str</span><span class="op" id="7631900">,</span>&nbsp;<span class="ident" id="7631902">tt</span><span class="op" id="7631904">.</span><span class="ident" id="7631905">litAddrOrName</span><span class="op" id="7631918">,</span>&nbsp;<span class="ident" id="7631920">err</span><span class="op" id="7631923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631933">if</span>&nbsp;<span class="op" id="7631936">!</span><span class="ident" id="7631937">reflect</span><span class="op" id="7631944">.</span><span class="ident" id="7631945">DeepEqual</span><span class="op" id="7631954">(</span><span class="ident" id="7631955">addr1</span><span class="op" id="7631960">,</span>&nbsp;<span class="ident" id="7631962">addr</span><span class="op" id="7631966">)</span>&nbsp;<span class="op" id="7631968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631974">t</span><span class="op" id="7631975">.</span><span class="ident" id="7631976">Fatalf</span><span class="op" id="7631982">(</span><span class="string" id="7631983">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7632033">,</span>&nbsp;<span class="ident" id="7632035">tt</span><span class="op" id="7632037">.</span><span class="ident" id="7632038">net</span><span class="op" id="7632041">,</span>&nbsp;<span class="ident" id="7632043">str</span><span class="op" id="7632046">,</span>&nbsp;<span class="ident" id="7632048">tt</span><span class="op" id="7632050">.</span><span class="ident" id="7632051">litAddrOrName</span><span class="op" id="7632064">,</span>&nbsp;<span class="ident" id="7632066">addr1</span><span class="op" id="7632071">,</span>&nbsp;<span class="ident" id="7632073">addr</span><span class="op" id="7632077">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632089">}</span><br>
<span class="lineno"></span><span class="op" id="7632091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="7632094">var</span>&nbsp;<span class="ident" id="7632098">tcpListenerNameTests</span>&nbsp;<span class="op" id="7632119">=</span>&nbsp;<span class="op" id="7632121">[</span><span class="op" id="7632122">]</span><span class="keyword" id="7632123">struct</span>&nbsp;<span class="op" id="7632130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632133">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7632139">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632147">laddr</span>&nbsp;<span class="op" id="7632153">*</span><span class="ident" id="7632154">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="7632162">}</span><span class="op" id="7632163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632166">{</span><span class="string" id="7632167">&#34;tcp4&#34;</span><span class="op" id="7632173">,</span>&nbsp;<span class="op" id="7632175">&amp;</span><span class="ident" id="7632176">TCPAddr</span><span class="op" id="7632183">{</span><span class="ident" id="7632184">IP</span><span class="op" id="7632186">:</span>&nbsp;<span class="ident" id="7632188">IPv4</span><span class="op" id="7632192">(</span><span class="num" id="7632193">127</span><span class="op" id="7632196">,</span>&nbsp;<span class="num" id="7632198">0</span><span class="op" id="7632199">,</span>&nbsp;<span class="num" id="7632201">0</span><span class="op" id="7632202">,</span>&nbsp;<span class="num" id="7632204">1</span><span class="op" id="7632205">)</span><span class="op" id="7632206">}</span><span class="op" id="7632207">}</span><span class="op" id="7632208">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632211">{</span><span class="string" id="7632212">&#34;tcp4&#34;</span><span class="op" id="7632218">,</span>&nbsp;<span class="op" id="7632220">&amp;</span><span class="ident" id="7632221">TCPAddr</span><span class="op" id="7632228">{</span><span class="op" id="7632229">}</span><span class="op" id="7632230">}</span><span class="op" id="7632231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632234">{</span><span class="string" id="7632235">&#34;tcp4&#34;</span><span class="op" id="7632241">,</span>&nbsp;<span class="ident" id="7632243">nil</span><span class="op" id="7632246">}</span><span class="op" id="7632247">,</span><br>
<span class="lineno"></span><span class="op" id="7632249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7632252">func</span>&nbsp;<span class="ident" id="7632257">TestTCPListenerName</span><span class="op" id="7632276">(</span><span class="ident" id="7632277">t</span>&nbsp;<span class="op" id="7632279">*</span><span class="ident" id="7632280">testing</span><span class="op" id="7632287">.</span><span class="ident" id="7632288">T</span><span class="op" id="7632289">)</span>&nbsp;<span class="op" id="7632291">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632294">if</span>&nbsp;<span class="ident" id="7632297">testing</span><span class="op" id="7632304">.</span><span class="ident" id="7632305">Short</span><span class="op" id="7632310">(</span><span class="op" id="7632311">)</span>&nbsp;<span class="op" id="7632313">||</span>&nbsp;<span class="op" id="7632316">!</span><span class="op" id="7632317">*</span><span class="ident" id="7632318">testExternal</span>&nbsp;<span class="op" id="7632331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632335">t</span><span class="op" id="7632336">.</span><span class="ident" id="7632337">Skip</span><span class="op" id="7632341">(</span><span class="string" id="7632342">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7632383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632390">for</span>&nbsp;<span class="ident" id="7632394">_</span><span class="op" id="7632395">,</span>&nbsp;<span class="ident" id="7632397">tt</span>&nbsp;<span class="op" id="7632400">:=</span>&nbsp;<span class="keyword" id="7632403">range</span>&nbsp;<span class="ident" id="7632409">tcpListenerNameTests</span>&nbsp;<span class="op" id="7632430">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632434">ln</span><span class="op" id="7632436">,</span>&nbsp;<span class="ident" id="7632438">err</span>&nbsp;<span class="op" id="7632442">:=</span>&nbsp;<span class="ident" id="7632445">ListenTCP</span><span class="op" id="7632454">(</span><span class="ident" id="7632455">tt</span><span class="op" id="7632457">.</span><span class="ident" id="7632458">net</span><span class="op" id="7632461">,</span>&nbsp;<span class="ident" id="7632463">tt</span><span class="op" id="7632465">.</span><span class="ident" id="7632466">laddr</span><span class="op" id="7632471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632475">if</span>&nbsp;<span class="ident" id="7632478">err</span>&nbsp;<span class="op" id="7632482">!=</span>&nbsp;<span class="ident" id="7632485">nil</span>&nbsp;<span class="op" id="7632489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632494">t</span><span class="op" id="7632495">.</span><span class="ident" id="7632496">Fatalf</span><span class="op" id="7632502">(</span><span class="string" id="7632503">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7632525">,</span>&nbsp;<span class="ident" id="7632527">err</span><span class="op" id="7632530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632538">defer</span>&nbsp;<span class="ident" id="7632544">ln</span><span class="op" id="7632546">.</span><span class="ident" id="7632547">Close</span><span class="op" id="7632552">(</span><span class="op" id="7632553">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632557">la</span>&nbsp;<span class="op" id="7632560">:=</span>&nbsp;<span class="ident" id="7632563">ln</span><span class="op" id="7632565">.</span><span class="ident" id="7632566">Addr</span><span class="op" id="7632570">(</span><span class="op" id="7632571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632575">if</span>&nbsp;<span class="ident" id="7632578">a</span><span class="op" id="7632579">,</span>&nbsp;<span class="ident" id="7632581">ok</span>&nbsp;<span class="op" id="7632584">:=</span>&nbsp;<span class="ident" id="7632587">la</span><span class="op" id="7632589">.</span><span class="op" id="7632590">(</span><span class="op" id="7632591">*</span><span class="ident" id="7632592">TCPAddr</span><span class="op" id="7632599">)</span><span class="op" id="7632600">;</span>&nbsp;<span class="op" id="7632602">!</span><span class="ident" id="7632603">ok</span>&nbsp;<span class="op" id="7632606">||</span>&nbsp;<span class="ident" id="7632609">a</span><span class="op" id="7632610">.</span><span class="ident" id="7632611">Port</span>&nbsp;<span class="op" id="7632616">==</span>&nbsp;<span class="num" id="7632619">0</span>&nbsp;<span class="op" id="7632621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632626">t</span><span class="op" id="7632627">.</span><span class="ident" id="7632628">Fatalf</span><span class="op" id="7632634">(</span><span class="string" id="7632635">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="7632696">,</span>&nbsp;<span class="ident" id="7632698">la</span><span class="op" id="7632700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632707">}</span><br>
<span class="lineno">375</span><span class="op" id="7632709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7632712">func</span>&nbsp;<span class="ident" id="7632717">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="7632744">(</span><span class="ident" id="7632745">t</span>&nbsp;<span class="op" id="7632747">*</span><span class="ident" id="7632748">testing</span><span class="op" id="7632755">.</span><span class="ident" id="7632756">T</span><span class="op" id="7632757">)</span>&nbsp;<span class="op" id="7632759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632762">if</span>&nbsp;<span class="ident" id="7632765">testing</span><span class="op" id="7632772">.</span><span class="ident" id="7632773">Short</span><span class="op" id="7632778">(</span><span class="op" id="7632779">)</span>&nbsp;<span class="op" id="7632781">||</span>&nbsp;<span class="op" id="7632784">!</span><span class="op" id="7632785">*</span><span class="ident" id="7632786">testExternal</span>&nbsp;<span class="op" id="7632799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632803">t</span><span class="op" id="7632804">.</span><span class="ident" id="7632805">Skip</span><span class="op" id="7632809">(</span><span class="string" id="7632810">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7632851">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632857">if</span>&nbsp;<span class="op" id="7632860">!</span><span class="ident" id="7632861">supportsIPv6</span>&nbsp;<span class="op" id="7632874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632878">t</span><span class="op" id="7632879">.</span><span class="ident" id="7632880">Skip</span><span class="op" id="7632884">(</span><span class="string" id="7632885">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7632908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632914">ifi</span>&nbsp;<span class="op" id="7632918">:=</span>&nbsp;<span class="ident" id="7632921">loopbackInterface</span><span class="op" id="7632938">(</span><span class="op" id="7632939">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632942">if</span>&nbsp;<span class="ident" id="7632945">ifi</span>&nbsp;<span class="op" id="7632949">==</span>&nbsp;<span class="ident" id="7632952">nil</span>&nbsp;<span class="op" id="7632956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632960">t</span><span class="op" id="7632961">.</span><span class="ident" id="7632962">Skip</span><span class="op" id="7632966">(</span><span class="string" id="7632967">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="7632997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633003">laddr</span>&nbsp;<span class="op" id="7633009">:=</span>&nbsp;<span class="ident" id="7633012">ipv6LinkLocalUnicastAddr</span><span class="op" id="7633036">(</span><span class="ident" id="7633037">ifi</span><span class="op" id="7633040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633043">if</span>&nbsp;<span class="ident" id="7633046">laddr</span>&nbsp;<span class="op" id="7633052">==</span>&nbsp;<span class="string" id="7633055">&#34;&#34;</span>&nbsp;<span class="op" id="7633058">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633062">t</span><span class="op" id="7633063">.</span><span class="ident" id="7633064">Skip</span><span class="op" id="7633068">(</span><span class="string" id="7633069">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="7633113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633120">type</span>&nbsp;<span class="ident" id="7633125">test</span>&nbsp;<span class="keyword" id="7633130">struct</span>&nbsp;<span class="op" id="7633137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633141">net</span><span class="op" id="7633144">,</span>&nbsp;<span class="ident" id="7633146">addr</span>&nbsp;&nbsp;<span class="builtintype" id="7633152">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633161">nameLookup</span>&nbsp;<span class="builtintype" id="7633172">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633181">var</span>&nbsp;<span class="ident" id="7633185">tests</span>&nbsp;<span class="op" id="7633191">=</span>&nbsp;<span class="op" id="7633193">[</span><span class="op" id="7633194">]</span><span class="ident" id="7633195">test</span><span class="op" id="7633199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633203">{</span><span class="string" id="7633204">&#34;tcp&#34;</span><span class="op" id="7633209">,</span>&nbsp;<span class="string" id="7633211">&#34;[&#34;</span>&nbsp;<span class="op" id="7633215">+</span>&nbsp;<span class="ident" id="7633217">laddr</span>&nbsp;<span class="op" id="7633223">+</span>&nbsp;<span class="string" id="7633225">&#34;%&#34;</span>&nbsp;<span class="op" id="7633229">+</span>&nbsp;<span class="ident" id="7633231">ifi</span><span class="op" id="7633234">.</span><span class="ident" id="7633235">Name</span>&nbsp;<span class="op" id="7633240">+</span>&nbsp;<span class="string" id="7633242">&#34;]:0&#34;</span><span class="op" id="7633247">,</span>&nbsp;<span class="builtintype" id="7633249">false</span><span class="op" id="7633254">}</span><span class="op" id="7633255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633259">{</span><span class="string" id="7633260">&#34;tcp6&#34;</span><span class="op" id="7633266">,</span>&nbsp;<span class="string" id="7633268">&#34;[&#34;</span>&nbsp;<span class="op" id="7633272">+</span>&nbsp;<span class="ident" id="7633274">laddr</span>&nbsp;<span class="op" id="7633280">+</span>&nbsp;<span class="string" id="7633282">&#34;%&#34;</span>&nbsp;<span class="op" id="7633286">+</span>&nbsp;<span class="ident" id="7633288">ifi</span><span class="op" id="7633291">.</span><span class="ident" id="7633292">Name</span>&nbsp;<span class="op" id="7633297">+</span>&nbsp;<span class="string" id="7633299">&#34;]:0&#34;</span><span class="op" id="7633304">,</span>&nbsp;<span class="builtintype" id="7633306">false</span><span class="op" id="7633311">}</span><span class="op" id="7633312">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633318">switch</span>&nbsp;<span class="ident" id="7633325">runtime</span><span class="op" id="7633332">.</span><span class="ident" id="7633333">GOOS</span>&nbsp;<span class="op" id="7633338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633341">case</span>&nbsp;<span class="string" id="7633346">&#34;darwin&#34;</span><span class="op" id="7633354">,</span>&nbsp;<span class="string" id="7633356">&#34;freebsd&#34;</span><span class="op" id="7633365">,</span>&nbsp;<span class="string" id="7633367">&#34;openbsd&#34;</span><span class="op" id="7633376">,</span>&nbsp;<span class="string" id="7633378">&#34;netbsd&#34;</span><span class="op" id="7633386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633390">tests</span>&nbsp;<span class="op" id="7633396">=</span>&nbsp;<span class="builtinfunc" id="7633398">append</span><span class="op" id="7633404">(</span><span class="ident" id="7633405">tests</span><span class="op" id="7633410">,</span>&nbsp;<span class="op" id="7633412">[</span><span class="op" id="7633413">]</span><span class="ident" id="7633414">test</span><span class="op" id="7633418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633423">{</span><span class="string" id="7633424">&#34;tcp&#34;</span><span class="op" id="7633429">,</span>&nbsp;<span class="string" id="7633431">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7633445">+</span>&nbsp;<span class="ident" id="7633447">ifi</span><span class="op" id="7633450">.</span><span class="ident" id="7633451">Name</span>&nbsp;<span class="op" id="7633456">+</span>&nbsp;<span class="string" id="7633458">&#34;]:0&#34;</span><span class="op" id="7633463">,</span>&nbsp;<span class="builtintype" id="7633465">true</span><span class="op" id="7633469">}</span><span class="op" id="7633470">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633475">{</span><span class="string" id="7633476">&#34;tcp6&#34;</span><span class="op" id="7633482">,</span>&nbsp;<span class="string" id="7633484">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7633498">+</span>&nbsp;<span class="ident" id="7633500">ifi</span><span class="op" id="7633503">.</span><span class="ident" id="7633504">Name</span>&nbsp;<span class="op" id="7633509">+</span>&nbsp;<span class="string" id="7633511">&#34;]:0&#34;</span><span class="op" id="7633516">,</span>&nbsp;<span class="builtintype" id="7633518">true</span><span class="op" id="7633522">}</span><span class="op" id="7633523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633527">}</span><span class="op" id="7633528">...</span><span class="op" id="7633531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633534">case</span>&nbsp;<span class="string" id="7633539">&#34;linux&#34;</span><span class="op" id="7633546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633550">tests</span>&nbsp;<span class="op" id="7633556">=</span>&nbsp;<span class="builtinfunc" id="7633558">append</span><span class="op" id="7633564">(</span><span class="ident" id="7633565">tests</span><span class="op" id="7633570">,</span>&nbsp;<span class="op" id="7633572">[</span><span class="op" id="7633573">]</span><span class="ident" id="7633574">test</span><span class="op" id="7633578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633583">{</span><span class="string" id="7633584">&#34;tcp&#34;</span><span class="op" id="7633589">,</span>&nbsp;<span class="string" id="7633591">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7633609">+</span>&nbsp;<span class="ident" id="7633611">ifi</span><span class="op" id="7633614">.</span><span class="ident" id="7633615">Name</span>&nbsp;<span class="op" id="7633620">+</span>&nbsp;<span class="string" id="7633622">&#34;]:0&#34;</span><span class="op" id="7633627">,</span>&nbsp;<span class="builtintype" id="7633629">true</span><span class="op" id="7633633">}</span><span class="op" id="7633634">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633639">{</span><span class="string" id="7633640">&#34;tcp6&#34;</span><span class="op" id="7633646">,</span>&nbsp;<span class="string" id="7633648">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7633666">+</span>&nbsp;<span class="ident" id="7633668">ifi</span><span class="op" id="7633671">.</span><span class="ident" id="7633672">Name</span>&nbsp;<span class="op" id="7633677">+</span>&nbsp;<span class="string" id="7633679">&#34;]:0&#34;</span><span class="op" id="7633684">,</span>&nbsp;<span class="builtintype" id="7633686">true</span><span class="op" id="7633690">}</span><span class="op" id="7633691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633695">}</span><span class="op" id="7633696">...</span><span class="op" id="7633699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633705">for</span>&nbsp;<span class="ident" id="7633709">_</span><span class="op" id="7633710">,</span>&nbsp;<span class="ident" id="7633712">tt</span>&nbsp;<span class="op" id="7633715">:=</span>&nbsp;<span class="keyword" id="7633718">range</span>&nbsp;<span class="ident" id="7633724">tests</span>&nbsp;<span class="op" id="7633730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633734">ln</span><span class="op" id="7633736">,</span>&nbsp;<span class="ident" id="7633738">err</span>&nbsp;<span class="op" id="7633742">:=</span>&nbsp;<span class="ident" id="7633745">Listen</span><span class="op" id="7633751">(</span><span class="ident" id="7633752">tt</span><span class="op" id="7633754">.</span><span class="ident" id="7633755">net</span><span class="op" id="7633758">,</span>&nbsp;<span class="ident" id="7633760">tt</span><span class="op" id="7633762">.</span><span class="ident" id="7633763">addr</span><span class="op" id="7633767">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633771">if</span>&nbsp;<span class="ident" id="7633774">err</span>&nbsp;<span class="op" id="7633778">!=</span>&nbsp;<span class="ident" id="7633781">nil</span>&nbsp;<span class="op" id="7633785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7633790">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7633836">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633885">t</span><span class="op" id="7633886">.</span><span class="ident" id="7633887">Logf</span><span class="op" id="7633891">(</span><span class="string" id="7633892">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7633911">,</span>&nbsp;<span class="ident" id="7633913">err</span><span class="op" id="7633916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633921">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633936">defer</span>&nbsp;<span class="ident" id="7633942">ln</span><span class="op" id="7633944">.</span><span class="ident" id="7633945">Close</span><span class="op" id="7633950">(</span><span class="op" id="7633951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633955">if</span>&nbsp;<span class="ident" id="7633958">la</span><span class="op" id="7633960">,</span>&nbsp;<span class="ident" id="7633962">ok</span>&nbsp;<span class="op" id="7633965">:=</span>&nbsp;<span class="ident" id="7633968">ln</span><span class="op" id="7633970">.</span><span class="ident" id="7633971">Addr</span><span class="op" id="7633975">(</span><span class="op" id="7633976">)</span><span class="op" id="7633977">.</span><span class="op" id="7633978">(</span><span class="op" id="7633979">*</span><span class="ident" id="7633980">TCPAddr</span><span class="op" id="7633987">)</span><span class="op" id="7633988">;</span>&nbsp;<span class="op" id="7633990">!</span><span class="ident" id="7633991">ok</span>&nbsp;<span class="op" id="7633994">||</span>&nbsp;<span class="op" id="7633997">!</span><span class="ident" id="7633998">tt</span><span class="op" id="7634000">.</span><span class="ident" id="7634001">nameLookup</span>&nbsp;<span class="op" id="7634012">&amp;&amp;</span>&nbsp;<span class="ident" id="7634015">la</span><span class="op" id="7634017">.</span><span class="ident" id="7634018">Zone</span>&nbsp;<span class="op" id="7634023">==</span>&nbsp;<span class="string" id="7634026">&#34;&#34;</span>&nbsp;<span class="op" id="7634029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634034">t</span><span class="op" id="7634035">.</span><span class="ident" id="7634036">Fatalf</span><span class="op" id="7634042">(</span><span class="string" id="7634043">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7634099">,</span>&nbsp;<span class="ident" id="7634101">la</span><span class="op" id="7634103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634107">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634112">done</span>&nbsp;<span class="op" id="7634117">:=</span>&nbsp;<span class="builtinfunc" id="7634120">make</span><span class="op" id="7634124">(</span><span class="keyword" id="7634125">chan</span>&nbsp;<span class="builtintype" id="7634130">int</span><span class="op" id="7634133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634137">go</span>&nbsp;<span class="ident" id="7634140">transponder</span><span class="op" id="7634151">(</span><span class="ident" id="7634152">t</span><span class="op" id="7634153">,</span>&nbsp;<span class="ident" id="7634155">ln</span><span class="op" id="7634157">,</span>&nbsp;<span class="ident" id="7634159">done</span><span class="op" id="7634163">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634168">c</span><span class="op" id="7634169">,</span>&nbsp;<span class="ident" id="7634171">err</span>&nbsp;<span class="op" id="7634175">:=</span>&nbsp;<span class="ident" id="7634178">Dial</span><span class="op" id="7634182">(</span><span class="ident" id="7634183">tt</span><span class="op" id="7634185">.</span><span class="ident" id="7634186">net</span><span class="op" id="7634189">,</span>&nbsp;<span class="ident" id="7634191">ln</span><span class="op" id="7634193">.</span><span class="ident" id="7634194">Addr</span><span class="op" id="7634198">(</span><span class="op" id="7634199">)</span><span class="op" id="7634200">.</span><span class="ident" id="7634201">String</span><span class="op" id="7634207">(</span><span class="op" id="7634208">)</span><span class="op" id="7634209">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634213">if</span>&nbsp;<span class="ident" id="7634216">err</span>&nbsp;<span class="op" id="7634220">!=</span>&nbsp;<span class="ident" id="7634223">nil</span>&nbsp;<span class="op" id="7634227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634232">t</span><span class="op" id="7634233">.</span><span class="ident" id="7634234">Fatalf</span><span class="op" id="7634240">(</span><span class="string" id="7634241">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7634258">,</span>&nbsp;<span class="ident" id="7634260">err</span><span class="op" id="7634263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634271">defer</span>&nbsp;<span class="ident" id="7634277">c</span><span class="op" id="7634278">.</span><span class="ident" id="7634279">Close</span><span class="op" id="7634284">(</span><span class="op" id="7634285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634289">if</span>&nbsp;<span class="ident" id="7634292">la</span><span class="op" id="7634294">,</span>&nbsp;<span class="ident" id="7634296">ok</span>&nbsp;<span class="op" id="7634299">:=</span>&nbsp;<span class="ident" id="7634302">c</span><span class="op" id="7634303">.</span><span class="ident" id="7634304">LocalAddr</span><span class="op" id="7634313">(</span><span class="op" id="7634314">)</span><span class="op" id="7634315">.</span><span class="op" id="7634316">(</span><span class="op" id="7634317">*</span><span class="ident" id="7634318">TCPAddr</span><span class="op" id="7634325">)</span><span class="op" id="7634326">;</span>&nbsp;<span class="op" id="7634328">!</span><span class="ident" id="7634329">ok</span>&nbsp;<span class="op" id="7634332">||</span>&nbsp;<span class="op" id="7634335">!</span><span class="ident" id="7634336">tt</span><span class="op" id="7634338">.</span><span class="ident" id="7634339">nameLookup</span>&nbsp;<span class="op" id="7634350">&amp;&amp;</span>&nbsp;<span class="ident" id="7634353">la</span><span class="op" id="7634355">.</span><span class="ident" id="7634356">Zone</span>&nbsp;<span class="op" id="7634361">==</span>&nbsp;<span class="string" id="7634364">&#34;&#34;</span>&nbsp;<span class="op" id="7634367">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634372">t</span><span class="op" id="7634373">.</span><span class="ident" id="7634374">Fatalf</span><span class="op" id="7634380">(</span><span class="string" id="7634381">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7634437">,</span>&nbsp;<span class="ident" id="7634439">la</span><span class="op" id="7634441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634449">if</span>&nbsp;<span class="ident" id="7634452">ra</span><span class="op" id="7634454">,</span>&nbsp;<span class="ident" id="7634456">ok</span>&nbsp;<span class="op" id="7634459">:=</span>&nbsp;<span class="ident" id="7634462">c</span><span class="op" id="7634463">.</span><span class="ident" id="7634464">RemoteAddr</span><span class="op" id="7634474">(</span><span class="op" id="7634475">)</span><span class="op" id="7634476">.</span><span class="op" id="7634477">(</span><span class="op" id="7634478">*</span><span class="ident" id="7634479">TCPAddr</span><span class="op" id="7634486">)</span><span class="op" id="7634487">;</span>&nbsp;<span class="op" id="7634489">!</span><span class="ident" id="7634490">ok</span>&nbsp;<span class="op" id="7634493">||</span>&nbsp;<span class="op" id="7634496">!</span><span class="ident" id="7634497">tt</span><span class="op" id="7634499">.</span><span class="ident" id="7634500">nameLookup</span>&nbsp;<span class="op" id="7634511">&amp;&amp;</span>&nbsp;<span class="ident" id="7634514">ra</span><span class="op" id="7634516">.</span><span class="ident" id="7634517">Zone</span>&nbsp;<span class="op" id="7634522">==</span>&nbsp;<span class="string" id="7634525">&#34;&#34;</span>&nbsp;<span class="op" id="7634528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634533">t</span><span class="op" id="7634534">.</span><span class="ident" id="7634535">Fatalf</span><span class="op" id="7634541">(</span><span class="string" id="7634542">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7634598">,</span>&nbsp;<span class="ident" id="7634600">ra</span><span class="op" id="7634602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634606">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634611">if</span>&nbsp;<span class="ident" id="7634614">_</span><span class="op" id="7634615">,</span>&nbsp;<span class="ident" id="7634617">err</span>&nbsp;<span class="op" id="7634621">:=</span>&nbsp;<span class="ident" id="7634624">c</span><span class="op" id="7634625">.</span><span class="ident" id="7634626">Write</span><span class="op" id="7634631">(</span><span class="op" id="7634632">[</span><span class="op" id="7634633">]</span><span class="builtintype" id="7634634">byte</span><span class="op" id="7634638">(</span><span class="string" id="7634639">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="7634669">)</span><span class="op" id="7634670">)</span><span class="op" id="7634671">;</span>&nbsp;<span class="ident" id="7634673">err</span>&nbsp;<span class="op" id="7634677">!=</span>&nbsp;<span class="ident" id="7634680">nil</span>&nbsp;<span class="op" id="7634684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634689">t</span><span class="op" id="7634690">.</span><span class="ident" id="7634691">Fatalf</span><span class="op" id="7634697">(</span><span class="string" id="7634698">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7634721">,</span>&nbsp;<span class="ident" id="7634723">err</span><span class="op" id="7634726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634734">b</span>&nbsp;<span class="op" id="7634736">:=</span>&nbsp;<span class="builtinfunc" id="7634739">make</span><span class="op" id="7634743">(</span><span class="op" id="7634744">[</span><span class="op" id="7634745">]</span><span class="builtintype" id="7634746">byte</span><span class="op" id="7634750">,</span>&nbsp;<span class="num" id="7634752">32</span><span class="op" id="7634754">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634758">if</span>&nbsp;<span class="ident" id="7634761">_</span><span class="op" id="7634762">,</span>&nbsp;<span class="ident" id="7634764">err</span>&nbsp;<span class="op" id="7634768">:=</span>&nbsp;<span class="ident" id="7634771">c</span><span class="op" id="7634772">.</span><span class="ident" id="7634773">Read</span><span class="op" id="7634777">(</span><span class="ident" id="7634778">b</span><span class="op" id="7634779">)</span><span class="op" id="7634780">;</span>&nbsp;<span class="ident" id="7634782">err</span>&nbsp;<span class="op" id="7634786">!=</span>&nbsp;<span class="ident" id="7634789">nil</span>&nbsp;<span class="op" id="7634793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634798">t</span><span class="op" id="7634799">.</span><span class="ident" id="7634800">Fatalf</span><span class="op" id="7634806">(</span><span class="string" id="7634807">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7634829">,</span>&nbsp;<span class="ident" id="7634831">err</span><span class="op" id="7634834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634843">&lt;-</span><span class="ident" id="7634845">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634851">}</span><br>
<span class="lineno"></span><span class="op" id="7634853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7634856">func</span>&nbsp;<span class="ident" id="7634861">TestTCPConcurrentAccept</span><span class="op" id="7634884">(</span><span class="ident" id="7634885">t</span>&nbsp;<span class="op" id="7634887">*</span><span class="ident" id="7634888">testing</span><span class="op" id="7634895">.</span><span class="ident" id="7634896">T</span><span class="op" id="7634897">)</span>&nbsp;<span class="op" id="7634899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634902">defer</span>&nbsp;<span class="ident" id="7634908">runtime</span><span class="op" id="7634915">.</span><span class="ident" id="7634916">GOMAXPROCS</span><span class="op" id="7634926">(</span><span class="ident" id="7634927">runtime</span><span class="op" id="7634934">.</span><span class="ident" id="7634935">GOMAXPROCS</span><span class="op" id="7634945">(</span><span class="num" id="7634946">4</span><span class="op" id="7634947">)</span><span class="op" id="7634948">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634951">ln</span><span class="op" id="7634953">,</span>&nbsp;<span class="ident" id="7634955">err</span>&nbsp;<span class="op" id="7634959">:=</span>&nbsp;<span class="ident" id="7634962">Listen</span><span class="op" id="7634968">(</span><span class="string" id="7634969">&#34;tcp&#34;</span><span class="op" id="7634974">,</span>&nbsp;<span class="string" id="7634976">&#34;127.0.0.1:0&#34;</span><span class="op" id="7634989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634992">if</span>&nbsp;<span class="ident" id="7634995">err</span>&nbsp;<span class="op" id="7634999">!=</span>&nbsp;<span class="ident" id="7635002">nil</span>&nbsp;<span class="op" id="7635006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635010">t</span><span class="op" id="7635011">.</span><span class="ident" id="7635012">Fatalf</span><span class="op" id="7635018">(</span><span class="string" id="7635019">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7635038">,</span>&nbsp;<span class="ident" id="7635040">err</span><span class="op" id="7635043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635049">const</span>&nbsp;<span class="ident" id="7635055">N</span>&nbsp;<span class="op" id="7635057">=</span>&nbsp;<span class="num" id="7635059">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635063">var</span>&nbsp;<span class="ident" id="7635067">wg</span>&nbsp;<span class="ident" id="7635070">sync</span><span class="op" id="7635074">.</span><span class="ident" id="7635075">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635086">wg</span><span class="op" id="7635088">.</span><span class="ident" id="7635089">Add</span><span class="op" id="7635092">(</span><span class="ident" id="7635093">N</span><span class="op" id="7635094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635097">for</span>&nbsp;<span class="ident" id="7635101">i</span>&nbsp;<span class="op" id="7635103">:=</span>&nbsp;<span class="num" id="7635106">0</span><span class="op" id="7635107">;</span>&nbsp;<span class="ident" id="7635109">i</span>&nbsp;<span class="op" id="7635111">&lt;</span>&nbsp;<span class="ident" id="7635113">N</span><span class="op" id="7635114">;</span>&nbsp;<span class="ident" id="7635116">i</span><span class="op" id="7635117">++</span>&nbsp;<span class="op" id="7635120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635124">go</span>&nbsp;<span class="keyword" id="7635127">func</span><span class="op" id="7635131">(</span><span class="op" id="7635132">)</span>&nbsp;<span class="op" id="7635134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635139">for</span>&nbsp;<span class="op" id="7635143">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635149">c</span><span class="op" id="7635150">,</span>&nbsp;<span class="ident" id="7635152">err</span>&nbsp;<span class="op" id="7635156">:=</span>&nbsp;<span class="ident" id="7635159">ln</span><span class="op" id="7635161">.</span><span class="ident" id="7635162">Accept</span><span class="op" id="7635168">(</span><span class="op" id="7635169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635175">if</span>&nbsp;<span class="ident" id="7635178">err</span>&nbsp;<span class="op" id="7635182">!=</span>&nbsp;<span class="ident" id="7635185">nil</span>&nbsp;<span class="op" id="7635189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635196">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635212">c</span><span class="op" id="7635213">.</span><span class="ident" id="7635214">Close</span><span class="op" id="7635219">(</span><span class="op" id="7635220">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635230">wg</span><span class="op" id="7635232">.</span><span class="ident" id="7635233">Done</span><span class="op" id="7635237">(</span><span class="op" id="7635238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635242">}</span><span class="op" id="7635243">(</span><span class="op" id="7635244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635250">attempts</span>&nbsp;<span class="op" id="7635259">:=</span>&nbsp;<span class="num" id="7635262">10</span>&nbsp;<span class="op" id="7635265">*</span>&nbsp;<span class="ident" id="7635267">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635270">fails</span>&nbsp;<span class="op" id="7635276">:=</span>&nbsp;<span class="num" id="7635279">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635282">d</span>&nbsp;<span class="op" id="7635284">:=</span>&nbsp;<span class="op" id="7635287">&amp;</span><span class="ident" id="7635288">Dialer</span><span class="op" id="7635294">{</span><span class="ident" id="7635295">Timeout</span><span class="op" id="7635302">:</span>&nbsp;<span class="num" id="7635304">200</span>&nbsp;<span class="op" id="7635308">*</span>&nbsp;<span class="ident" id="7635310">time</span><span class="op" id="7635314">.</span><span class="ident" id="7635315">Millisecond</span><span class="op" id="7635326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635329">for</span>&nbsp;<span class="ident" id="7635333">i</span>&nbsp;<span class="op" id="7635335">:=</span>&nbsp;<span class="num" id="7635338">0</span><span class="op" id="7635339">;</span>&nbsp;<span class="ident" id="7635341">i</span>&nbsp;<span class="op" id="7635343">&lt;</span>&nbsp;<span class="ident" id="7635345">attempts</span><span class="op" id="7635353">;</span>&nbsp;<span class="ident" id="7635355">i</span><span class="op" id="7635356">++</span>&nbsp;<span class="op" id="7635359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635363">c</span><span class="op" id="7635364">,</span>&nbsp;<span class="ident" id="7635366">err</span>&nbsp;<span class="op" id="7635370">:=</span>&nbsp;<span class="ident" id="7635373">d</span><span class="op" id="7635374">.</span><span class="ident" id="7635375">Dial</span><span class="op" id="7635379">(</span><span class="string" id="7635380">&#34;tcp&#34;</span><span class="op" id="7635385">,</span>&nbsp;<span class="ident" id="7635387">ln</span><span class="op" id="7635389">.</span><span class="ident" id="7635390">Addr</span><span class="op" id="7635394">(</span><span class="op" id="7635395">)</span><span class="op" id="7635396">.</span><span class="ident" id="7635397">String</span><span class="op" id="7635403">(</span><span class="op" id="7635404">)</span><span class="op" id="7635405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635409">if</span>&nbsp;<span class="ident" id="7635412">err</span>&nbsp;<span class="op" id="7635416">!=</span>&nbsp;<span class="ident" id="7635419">nil</span>&nbsp;<span class="op" id="7635423">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635428">fails</span><span class="op" id="7635433">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635438">}</span>&nbsp;<span class="keyword" id="7635440">else</span>&nbsp;<span class="op" id="7635445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635450">c</span><span class="op" id="7635451">.</span><span class="ident" id="7635452">Close</span><span class="op" id="7635457">(</span><span class="op" id="7635458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635465">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635468">ln</span><span class="op" id="7635470">.</span><span class="ident" id="7635471">Close</span><span class="op" id="7635476">(</span><span class="op" id="7635477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635480">wg</span><span class="op" id="7635482">.</span><span class="ident" id="7635483">Wait</span><span class="op" id="7635487">(</span><span class="op" id="7635488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635491">if</span>&nbsp;<span class="ident" id="7635494">fails</span>&nbsp;<span class="op" id="7635500">&gt;</span>&nbsp;<span class="ident" id="7635502">attempts</span><span class="op" id="7635510">/</span><span class="num" id="7635511">9</span>&nbsp;<span class="op" id="7635513">{</span>&nbsp;<span class="comment" id="7635515">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635545">t</span><span class="op" id="7635546">.</span><span class="ident" id="7635547">Fatalf</span><span class="op" id="7635553">(</span><span class="string" id="7635554">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7635580">,</span>&nbsp;<span class="ident" id="7635582">fails</span><span class="op" id="7635587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635590">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635593">if</span>&nbsp;<span class="ident" id="7635596">fails</span>&nbsp;<span class="op" id="7635602">&gt;</span>&nbsp;<span class="num" id="7635604">0</span>&nbsp;<span class="op" id="7635606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635610">t</span><span class="op" id="7635611">.</span><span class="ident" id="7635612">Logf</span><span class="op" id="7635616">(</span><span class="string" id="7635617">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="7635640">,</span>&nbsp;<span class="ident" id="7635642">fails</span><span class="op" id="7635647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635650">}</span><br>
<span class="lineno"></span><span class="op" id="7635652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="7635655">func</span>&nbsp;<span class="ident" id="7635660">TestTCPReadWriteMallocs</span><span class="op" id="7635683">(</span><span class="ident" id="7635684">t</span>&nbsp;<span class="op" id="7635686">*</span><span class="ident" id="7635687">testing</span><span class="op" id="7635694">.</span><span class="ident" id="7635695">T</span><span class="op" id="7635696">)</span>&nbsp;<span class="op" id="7635698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635701">if</span>&nbsp;<span class="ident" id="7635704">testing</span><span class="op" id="7635711">.</span><span class="ident" id="7635712">Short</span><span class="op" id="7635717">(</span><span class="op" id="7635718">)</span>&nbsp;<span class="op" id="7635720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635724">t</span><span class="op" id="7635725">.</span><span class="ident" id="7635726">Skip</span><span class="op" id="7635730">(</span><span class="string" id="7635731">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7635768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635774">ln</span><span class="op" id="7635776">,</span>&nbsp;<span class="ident" id="7635778">err</span>&nbsp;<span class="op" id="7635782">:=</span>&nbsp;<span class="ident" id="7635785">Listen</span><span class="op" id="7635791">(</span><span class="string" id="7635792">&#34;tcp&#34;</span><span class="op" id="7635797">,</span>&nbsp;<span class="string" id="7635799">&#34;127.0.0.1:0&#34;</span><span class="op" id="7635812">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635815">if</span>&nbsp;<span class="ident" id="7635818">err</span>&nbsp;<span class="op" id="7635822">!=</span>&nbsp;<span class="ident" id="7635825">nil</span>&nbsp;<span class="op" id="7635829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635833">t</span><span class="op" id="7635834">.</span><span class="ident" id="7635835">Fatalf</span><span class="op" id="7635841">(</span><span class="string" id="7635842">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7635861">,</span>&nbsp;<span class="ident" id="7635863">err</span><span class="op" id="7635866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635872">defer</span>&nbsp;<span class="ident" id="7635878">ln</span><span class="op" id="7635880">.</span><span class="ident" id="7635881">Close</span><span class="op" id="7635886">(</span><span class="op" id="7635887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635890">var</span>&nbsp;<span class="ident" id="7635894">server</span>&nbsp;<span class="ident" id="7635901">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635907">errc</span>&nbsp;<span class="op" id="7635912">:=</span>&nbsp;<span class="builtinfunc" id="7635915">make</span><span class="op" id="7635919">(</span><span class="keyword" id="7635920">chan</span>&nbsp;<span class="builtintype" id="7635925">error</span><span class="op" id="7635930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635933">go</span>&nbsp;<span class="keyword" id="7635936">func</span><span class="op" id="7635940">(</span><span class="op" id="7635941">)</span>&nbsp;<span class="op" id="7635943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635947">var</span>&nbsp;<span class="ident" id="7635951">err</span>&nbsp;<span class="builtintype" id="7635955">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635963">server</span><span class="op" id="7635969">,</span>&nbsp;<span class="ident" id="7635971">err</span>&nbsp;<span class="op" id="7635975">=</span>&nbsp;<span class="ident" id="7635977">ln</span><span class="op" id="7635979">.</span><span class="ident" id="7635980">Accept</span><span class="op" id="7635986">(</span><span class="op" id="7635987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635991">errc</span>&nbsp;<span class="op" id="7635996">&lt;-</span>&nbsp;<span class="ident" id="7635999">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636004">}</span><span class="op" id="7636005">(</span><span class="op" id="7636006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636009">client</span><span class="op" id="7636015">,</span>&nbsp;<span class="ident" id="7636017">err</span>&nbsp;<span class="op" id="7636021">:=</span>&nbsp;<span class="ident" id="7636024">Dial</span><span class="op" id="7636028">(</span><span class="string" id="7636029">&#34;tcp&#34;</span><span class="op" id="7636034">,</span>&nbsp;<span class="ident" id="7636036">ln</span><span class="op" id="7636038">.</span><span class="ident" id="7636039">Addr</span><span class="op" id="7636043">(</span><span class="op" id="7636044">)</span><span class="op" id="7636045">.</span><span class="ident" id="7636046">String</span><span class="op" id="7636052">(</span><span class="op" id="7636053">)</span><span class="op" id="7636054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636057">if</span>&nbsp;<span class="ident" id="7636060">err</span>&nbsp;<span class="op" id="7636064">!=</span>&nbsp;<span class="ident" id="7636067">nil</span>&nbsp;<span class="op" id="7636071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636075">t</span><span class="op" id="7636076">.</span><span class="ident" id="7636077">Fatalf</span><span class="op" id="7636083">(</span><span class="string" id="7636084">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636101">,</span>&nbsp;<span class="ident" id="7636103">err</span><span class="op" id="7636106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636109">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636112">if</span>&nbsp;<span class="ident" id="7636115">err</span>&nbsp;<span class="op" id="7636119">:=</span>&nbsp;<span class="op" id="7636122">&lt;-</span><span class="ident" id="7636124">errc</span><span class="op" id="7636128">;</span>&nbsp;<span class="ident" id="7636130">err</span>&nbsp;<span class="op" id="7636134">!=</span>&nbsp;<span class="ident" id="7636137">nil</span>&nbsp;<span class="op" id="7636141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636145">t</span><span class="op" id="7636146">.</span><span class="ident" id="7636147">Fatalf</span><span class="op" id="7636153">(</span><span class="string" id="7636154">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636173">,</span>&nbsp;<span class="ident" id="7636175">err</span><span class="op" id="7636178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636184">defer</span>&nbsp;<span class="ident" id="7636190">server</span><span class="op" id="7636196">.</span><span class="ident" id="7636197">Close</span><span class="op" id="7636202">(</span><span class="op" id="7636203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636206">var</span>&nbsp;<span class="ident" id="7636210">buf</span>&nbsp;<span class="op" id="7636214">[</span><span class="num" id="7636215">128</span><span class="op" id="7636218">]</span><span class="builtintype" id="7636219">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636225">mallocs</span>&nbsp;<span class="op" id="7636233">:=</span>&nbsp;<span class="ident" id="7636236">testing</span><span class="op" id="7636243">.</span><span class="ident" id="7636244">AllocsPerRun</span><span class="op" id="7636256">(</span><span class="num" id="7636257">1000</span><span class="op" id="7636261">,</span>&nbsp;<span class="keyword" id="7636263">func</span><span class="op" id="7636267">(</span><span class="op" id="7636268">)</span>&nbsp;<span class="op" id="7636270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636274">_</span><span class="op" id="7636275">,</span>&nbsp;<span class="ident" id="7636277">err</span>&nbsp;<span class="op" id="7636281">:=</span>&nbsp;<span class="ident" id="7636284">server</span><span class="op" id="7636290">.</span><span class="ident" id="7636291">Write</span><span class="op" id="7636296">(</span><span class="ident" id="7636297">buf</span><span class="op" id="7636300">[</span><span class="op" id="7636301">:</span><span class="op" id="7636302">]</span><span class="op" id="7636303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636307">if</span>&nbsp;<span class="ident" id="7636310">err</span>&nbsp;<span class="op" id="7636314">!=</span>&nbsp;<span class="ident" id="7636317">nil</span>&nbsp;<span class="op" id="7636321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636326">t</span><span class="op" id="7636327">.</span><span class="ident" id="7636328">Fatalf</span><span class="op" id="7636334">(</span><span class="string" id="7636335">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636353">,</span>&nbsp;<span class="ident" id="7636355">err</span><span class="op" id="7636358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636362">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636366">_</span><span class="op" id="7636367">,</span>&nbsp;<span class="ident" id="7636369">err</span>&nbsp;<span class="op" id="7636373">=</span>&nbsp;<span class="ident" id="7636375">io</span><span class="op" id="7636377">.</span><span class="ident" id="7636378">ReadFull</span><span class="op" id="7636386">(</span><span class="ident" id="7636387">client</span><span class="op" id="7636393">,</span>&nbsp;<span class="ident" id="7636395">buf</span><span class="op" id="7636398">[</span><span class="op" id="7636399">:</span><span class="op" id="7636400">]</span><span class="op" id="7636401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636405">if</span>&nbsp;<span class="ident" id="7636408">err</span>&nbsp;<span class="op" id="7636412">!=</span>&nbsp;<span class="ident" id="7636415">nil</span>&nbsp;<span class="op" id="7636419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636424">t</span><span class="op" id="7636425">.</span><span class="ident" id="7636426">Fatalf</span><span class="op" id="7636432">(</span><span class="string" id="7636433">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636450">,</span>&nbsp;<span class="ident" id="7636452">err</span><span class="op" id="7636455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636462">}</span><span class="op" id="7636463">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636466">if</span>&nbsp;<span class="ident" id="7636469">mallocs</span>&nbsp;<span class="op" id="7636477">&gt;</span>&nbsp;<span class="num" id="7636479">0</span>&nbsp;<span class="op" id="7636481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636485">t</span><span class="op" id="7636486">.</span><span class="ident" id="7636487">Fatalf</span><span class="op" id="7636493">(</span><span class="string" id="7636494">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="7636517">,</span>&nbsp;<span class="ident" id="7636519">mallocs</span><span class="op" id="7636526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636529">}</span><br>
<span class="lineno"></span><span class="op" id="7636531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7636534">func</span>&nbsp;<span class="ident" id="7636539">TestTCPStress</span><span class="op" id="7636552">(</span><span class="ident" id="7636553">t</span>&nbsp;<span class="op" id="7636555">*</span><span class="ident" id="7636556">testing</span><span class="op" id="7636563">.</span><span class="ident" id="7636564">T</span><span class="op" id="7636565">)</span>&nbsp;<span class="op" id="7636567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636570">const</span>&nbsp;<span class="ident" id="7636576">conns</span>&nbsp;<span class="op" id="7636582">=</span>&nbsp;<span class="num" id="7636584">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636587">const</span>&nbsp;<span class="ident" id="7636593">msgLen</span>&nbsp;<span class="op" id="7636600">=</span>&nbsp;<span class="num" id="7636602">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636607">msgs</span>&nbsp;<span class="op" id="7636612">:=</span>&nbsp;<span class="builtintype" id="7636615">int</span><span class="op" id="7636618">(</span><span class="num" id="7636619">1e4</span><span class="op" id="7636622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636625">if</span>&nbsp;<span class="ident" id="7636628">testing</span><span class="op" id="7636635">.</span><span class="ident" id="7636636">Short</span><span class="op" id="7636641">(</span><span class="op" id="7636642">)</span>&nbsp;<span class="op" id="7636644">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636648">msgs</span>&nbsp;<span class="op" id="7636653">=</span>&nbsp;<span class="num" id="7636655">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636664">sendMsg</span>&nbsp;<span class="op" id="7636672">:=</span>&nbsp;<span class="keyword" id="7636675">func</span><span class="op" id="7636679">(</span><span class="ident" id="7636680">c</span>&nbsp;<span class="ident" id="7636682">Conn</span><span class="op" id="7636686">,</span>&nbsp;<span class="ident" id="7636688">buf</span>&nbsp;<span class="op" id="7636692">[</span><span class="op" id="7636693">]</span><span class="builtintype" id="7636694">byte</span><span class="op" id="7636698">)</span>&nbsp;<span class="builtintype" id="7636700">bool</span>&nbsp;<span class="op" id="7636705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636709">n</span><span class="op" id="7636710">,</span>&nbsp;<span class="ident" id="7636712">err</span>&nbsp;<span class="op" id="7636716">:=</span>&nbsp;<span class="ident" id="7636719">c</span><span class="op" id="7636720">.</span><span class="ident" id="7636721">Write</span><span class="op" id="7636726">(</span><span class="ident" id="7636727">buf</span><span class="op" id="7636730">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636734">if</span>&nbsp;<span class="ident" id="7636737">n</span>&nbsp;<span class="op" id="7636739">!=</span>&nbsp;<span class="builtinfunc" id="7636742">len</span><span class="op" id="7636745">(</span><span class="ident" id="7636746">buf</span><span class="op" id="7636749">)</span>&nbsp;<span class="op" id="7636751">||</span>&nbsp;<span class="ident" id="7636754">err</span>&nbsp;<span class="op" id="7636758">!=</span>&nbsp;<span class="ident" id="7636761">nil</span>&nbsp;<span class="op" id="7636765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636770">t</span><span class="op" id="7636771">.</span><span class="ident" id="7636772">Logf</span><span class="op" id="7636776">(</span><span class="string" id="7636777">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7636795">,</span>&nbsp;<span class="ident" id="7636797">err</span><span class="op" id="7636800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636805">return</span>&nbsp;<span class="builtintype" id="7636812">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636824">return</span>&nbsp;<span class="builtintype" id="7636831">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636840">recvMsg</span>&nbsp;<span class="op" id="7636848">:=</span>&nbsp;<span class="keyword" id="7636851">func</span><span class="op" id="7636855">(</span><span class="ident" id="7636856">c</span>&nbsp;<span class="ident" id="7636858">Conn</span><span class="op" id="7636862">,</span>&nbsp;<span class="ident" id="7636864">buf</span>&nbsp;<span class="op" id="7636868">[</span><span class="op" id="7636869">]</span><span class="builtintype" id="7636870">byte</span><span class="op" id="7636874">)</span>&nbsp;<span class="builtintype" id="7636876">bool</span>&nbsp;<span class="op" id="7636881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636885">for</span>&nbsp;<span class="ident" id="7636889">read</span>&nbsp;<span class="op" id="7636894">:=</span>&nbsp;<span class="num" id="7636897">0</span><span class="op" id="7636898">;</span>&nbsp;<span class="ident" id="7636900">read</span>&nbsp;<span class="op" id="7636905">!=</span>&nbsp;<span class="builtinfunc" id="7636908">len</span><span class="op" id="7636911">(</span><span class="ident" id="7636912">buf</span><span class="op" id="7636915">)</span><span class="op" id="7636916">;</span>&nbsp;<span class="op" id="7636918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636923">n</span><span class="op" id="7636924">,</span>&nbsp;<span class="ident" id="7636926">err</span>&nbsp;<span class="op" id="7636930">:=</span>&nbsp;<span class="ident" id="7636933">c</span><span class="op" id="7636934">.</span><span class="ident" id="7636935">Read</span><span class="op" id="7636939">(</span><span class="ident" id="7636940">buf</span><span class="op" id="7636943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636948">read</span>&nbsp;<span class="op" id="7636953">+=</span>&nbsp;<span class="ident" id="7636956">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636961">if</span>&nbsp;<span class="ident" id="7636964">err</span>&nbsp;<span class="op" id="7636968">!=</span>&nbsp;<span class="ident" id="7636971">nil</span>&nbsp;<span class="op" id="7636975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636981">t</span><span class="op" id="7636982">.</span><span class="ident" id="7636983">Logf</span><span class="op" id="7636987">(</span><span class="string" id="7636988">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7637005">,</span>&nbsp;<span class="ident" id="7637007">err</span><span class="op" id="7637010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637016">return</span>&nbsp;<span class="builtintype" id="7637023">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637036">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637040">return</span>&nbsp;<span class="builtintype" id="7637047">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637057">ln</span><span class="op" id="7637059">,</span>&nbsp;<span class="ident" id="7637061">err</span>&nbsp;<span class="op" id="7637065">:=</span>&nbsp;<span class="ident" id="7637068">Listen</span><span class="op" id="7637074">(</span><span class="string" id="7637075">&#34;tcp&#34;</span><span class="op" id="7637080">,</span>&nbsp;<span class="string" id="7637082">&#34;127.0.0.1:0&#34;</span><span class="op" id="7637095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637098">if</span>&nbsp;<span class="ident" id="7637101">err</span>&nbsp;<span class="op" id="7637105">!=</span>&nbsp;<span class="ident" id="7637108">nil</span>&nbsp;<span class="op" id="7637112">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637116">t</span><span class="op" id="7637117">.</span><span class="ident" id="7637118">Fatalf</span><span class="op" id="7637124">(</span><span class="string" id="7637125">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7637144">,</span>&nbsp;<span class="ident" id="7637146">err</span><span class="op" id="7637149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637155">defer</span>&nbsp;<span class="ident" id="7637161">ln</span><span class="op" id="7637163">.</span><span class="ident" id="7637164">Close</span><span class="op" id="7637169">(</span><span class="op" id="7637170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7637173">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637187">go</span>&nbsp;<span class="keyword" id="7637190">func</span><span class="op" id="7637194">(</span><span class="op" id="7637195">)</span>&nbsp;<span class="op" id="7637197">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637201">for</span>&nbsp;<span class="op" id="7637205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637210">c</span><span class="op" id="7637211">,</span>&nbsp;<span class="ident" id="7637213">err</span>&nbsp;<span class="op" id="7637217">:=</span>&nbsp;<span class="ident" id="7637220">ln</span><span class="op" id="7637222">.</span><span class="ident" id="7637223">Accept</span><span class="op" id="7637229">(</span><span class="op" id="7637230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637235">if</span>&nbsp;<span class="ident" id="7637238">err</span>&nbsp;<span class="op" id="7637242">!=</span>&nbsp;<span class="ident" id="7637245">nil</span>&nbsp;<span class="op" id="7637249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637255">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637264">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7637269">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637294">go</span>&nbsp;<span class="keyword" id="7637297">func</span><span class="op" id="7637301">(</span><span class="ident" id="7637302">c</span>&nbsp;<span class="ident" id="7637304">Conn</span><span class="op" id="7637308">)</span>&nbsp;<span class="op" id="7637310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637316">defer</span>&nbsp;<span class="ident" id="7637322">c</span><span class="op" id="7637323">.</span><span class="ident" id="7637324">Close</span><span class="op" id="7637329">(</span><span class="op" id="7637330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637336">var</span>&nbsp;<span class="ident" id="7637340">buf</span>&nbsp;<span class="op" id="7637344">[</span><span class="ident" id="7637345">msgLen</span><span class="op" id="7637351">]</span><span class="builtintype" id="7637352">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637361">for</span>&nbsp;<span class="ident" id="7637365">m</span>&nbsp;<span class="op" id="7637367">:=</span>&nbsp;<span class="num" id="7637370">0</span><span class="op" id="7637371">;</span>&nbsp;<span class="ident" id="7637373">m</span>&nbsp;<span class="op" id="7637375">&lt;</span>&nbsp;<span class="ident" id="7637377">msgs</span><span class="op" id="7637381">;</span>&nbsp;<span class="ident" id="7637383">m</span><span class="op" id="7637384">++</span>&nbsp;<span class="op" id="7637387">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637394">if</span>&nbsp;<span class="op" id="7637397">!</span><span class="ident" id="7637398">recvMsg</span><span class="op" id="7637405">(</span><span class="ident" id="7637406">c</span><span class="op" id="7637407">,</span>&nbsp;<span class="ident" id="7637409">buf</span><span class="op" id="7637412">[</span><span class="op" id="7637413">:</span><span class="op" id="7637414">]</span><span class="op" id="7637415">)</span>&nbsp;<span class="op" id="7637417">||</span>&nbsp;<span class="op" id="7637420">!</span><span class="ident" id="7637421">sendMsg</span><span class="op" id="7637428">(</span><span class="ident" id="7637429">c</span><span class="op" id="7637430">,</span>&nbsp;<span class="ident" id="7637432">buf</span><span class="op" id="7637435">[</span><span class="op" id="7637436">:</span><span class="op" id="7637437">]</span><span class="op" id="7637438">)</span>&nbsp;<span class="op" id="7637440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637448">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637470">}</span><span class="op" id="7637471">(</span><span class="ident" id="7637472">c</span><span class="op" id="7637473">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637480">}</span><span class="op" id="7637481">(</span><span class="op" id="7637482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637485">done</span>&nbsp;<span class="op" id="7637490">:=</span>&nbsp;<span class="builtinfunc" id="7637493">make</span><span class="op" id="7637497">(</span><span class="keyword" id="7637498">chan</span>&nbsp;<span class="builtintype" id="7637503">bool</span><span class="op" id="7637507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637510">for</span>&nbsp;<span class="ident" id="7637514">i</span>&nbsp;<span class="op" id="7637516">:=</span>&nbsp;<span class="num" id="7637519">0</span><span class="op" id="7637520">;</span>&nbsp;<span class="ident" id="7637522">i</span>&nbsp;<span class="op" id="7637524">&lt;</span>&nbsp;<span class="ident" id="7637526">conns</span><span class="op" id="7637531">;</span>&nbsp;<span class="ident" id="7637533">i</span><span class="op" id="7637534">++</span>&nbsp;<span class="op" id="7637537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7637541">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637565">go</span>&nbsp;<span class="keyword" id="7637568">func</span><span class="op" id="7637572">(</span><span class="op" id="7637573">)</span>&nbsp;<span class="op" id="7637575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637580">defer</span>&nbsp;<span class="keyword" id="7637586">func</span><span class="op" id="7637590">(</span><span class="op" id="7637591">)</span>&nbsp;<span class="op" id="7637593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637599">done</span>&nbsp;<span class="op" id="7637604">&lt;-</span>&nbsp;<span class="builtintype" id="7637607">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637615">}</span><span class="op" id="7637616">(</span><span class="op" id="7637617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637622">c</span><span class="op" id="7637623">,</span>&nbsp;<span class="ident" id="7637625">err</span>&nbsp;<span class="op" id="7637629">:=</span>&nbsp;<span class="ident" id="7637632">Dial</span><span class="op" id="7637636">(</span><span class="string" id="7637637">&#34;tcp&#34;</span><span class="op" id="7637642">,</span>&nbsp;<span class="ident" id="7637644">ln</span><span class="op" id="7637646">.</span><span class="ident" id="7637647">Addr</span><span class="op" id="7637651">(</span><span class="op" id="7637652">)</span><span class="op" id="7637653">.</span><span class="ident" id="7637654">String</span><span class="op" id="7637660">(</span><span class="op" id="7637661">)</span><span class="op" id="7637662">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637667">if</span>&nbsp;<span class="ident" id="7637670">err</span>&nbsp;<span class="op" id="7637674">!=</span>&nbsp;<span class="ident" id="7637677">nil</span>&nbsp;<span class="op" id="7637681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637687">t</span><span class="op" id="7637688">.</span><span class="ident" id="7637689">Logf</span><span class="op" id="7637693">(</span><span class="string" id="7637694">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7637711">,</span>&nbsp;<span class="ident" id="7637713">err</span><span class="op" id="7637716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637722">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637737">defer</span>&nbsp;<span class="ident" id="7637743">c</span><span class="op" id="7637744">.</span><span class="ident" id="7637745">Close</span><span class="op" id="7637750">(</span><span class="op" id="7637751">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637756">var</span>&nbsp;<span class="ident" id="7637760">buf</span>&nbsp;<span class="op" id="7637764">[</span><span class="ident" id="7637765">msgLen</span><span class="op" id="7637771">]</span><span class="builtintype" id="7637772">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637780">for</span>&nbsp;<span class="ident" id="7637784">m</span>&nbsp;<span class="op" id="7637786">:=</span>&nbsp;<span class="num" id="7637789">0</span><span class="op" id="7637790">;</span>&nbsp;<span class="ident" id="7637792">m</span>&nbsp;<span class="op" id="7637794">&lt;</span>&nbsp;<span class="ident" id="7637796">msgs</span><span class="op" id="7637800">;</span>&nbsp;<span class="ident" id="7637802">m</span><span class="op" id="7637803">++</span>&nbsp;<span class="op" id="7637806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637812">if</span>&nbsp;<span class="op" id="7637815">!</span><span class="ident" id="7637816">sendMsg</span><span class="op" id="7637823">(</span><span class="ident" id="7637824">c</span><span class="op" id="7637825">,</span>&nbsp;<span class="ident" id="7637827">buf</span><span class="op" id="7637830">[</span><span class="op" id="7637831">:</span><span class="op" id="7637832">]</span><span class="op" id="7637833">)</span>&nbsp;<span class="op" id="7637835">||</span>&nbsp;<span class="op" id="7637838">!</span><span class="ident" id="7637839">recvMsg</span><span class="op" id="7637846">(</span><span class="ident" id="7637847">c</span><span class="op" id="7637848">,</span>&nbsp;<span class="ident" id="7637850">buf</span><span class="op" id="7637853">[</span><span class="op" id="7637854">:</span><span class="op" id="7637855">]</span><span class="op" id="7637856">)</span>&nbsp;<span class="op" id="7637858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637865">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637875">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637884">}</span><span class="op" id="7637885">(</span><span class="op" id="7637886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637892">for</span>&nbsp;<span class="ident" id="7637896">i</span>&nbsp;<span class="op" id="7637898">:=</span>&nbsp;<span class="num" id="7637901">0</span><span class="op" id="7637902">;</span>&nbsp;<span class="ident" id="7637904">i</span>&nbsp;<span class="op" id="7637906">&lt;</span>&nbsp;<span class="ident" id="7637908">conns</span><span class="op" id="7637913">;</span>&nbsp;<span class="ident" id="7637915">i</span><span class="op" id="7637916">++</span>&nbsp;<span class="op" id="7637919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637923">&lt;-</span><span class="ident" id="7637925">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637931">}</span><br>
<span class="lineno"></span><span class="op" id="7637933">}</span>
</div>
</body>
</html>
