<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7229347">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7229402">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7229456">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7229507">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7229533">package</span>&nbsp;<span class="ident" id="7229541">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7229546">import</span>&nbsp;<span class="op" id="7229553">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229556">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229565">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229572">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229578">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229585">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229597">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229618">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229624">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229635">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229652">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229663">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229674">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229685">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7229696">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7229703">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="7229706">func</span>&nbsp;<span class="ident" id="7229711">newRequest</span><span class="op" id="7229721">(</span><span class="ident" id="7229722">httpreq</span>&nbsp;<span class="builtintype" id="7229730">string</span><span class="op" id="7229736">)</span>&nbsp;<span class="op" id="7229738">*</span><span class="ident" id="7229739">http</span><span class="op" id="7229743">.</span><span class="ident" id="7229744">Request</span>&nbsp;<span class="op" id="7229752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7229755">buf</span>&nbsp;<span class="op" id="7229759">:=</span>&nbsp;<span class="ident" id="7229762">bufio</span><span class="op" id="7229767">.</span><span class="ident" id="7229768">NewReader</span><span class="op" id="7229777">(</span><span class="ident" id="7229778">strings</span><span class="op" id="7229785">.</span><span class="ident" id="7229786">NewReader</span><span class="op" id="7229795">(</span><span class="ident" id="7229796">httpreq</span><span class="op" id="7229803">)</span><span class="op" id="7229804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7229807">req</span><span class="op" id="7229810">,</span>&nbsp;<span class="ident" id="7229812">err</span>&nbsp;<span class="op" id="7229816">:=</span>&nbsp;<span class="ident" id="7229819">http</span><span class="op" id="7229823">.</span><span class="ident" id="7229824">ReadRequest</span><span class="op" id="7229835">(</span><span class="ident" id="7229836">buf</span><span class="op" id="7229839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7229842">if</span>&nbsp;<span class="ident" id="7229845">err</span>&nbsp;<span class="op" id="7229849">!=</span>&nbsp;<span class="ident" id="7229852">nil</span>&nbsp;<span class="op" id="7229856">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7229860">panic</span><span class="op" id="7229865">(</span><span class="string" id="7229866">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="7229902">+</span>&nbsp;<span class="ident" id="7229904">httpreq</span><span class="op" id="7229911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7229914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7229917">req</span><span class="op" id="7229920">.</span><span class="ident" id="7229921">RemoteAddr</span>&nbsp;<span class="op" id="7229932">=</span>&nbsp;<span class="string" id="7229934">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7229945">return</span>&nbsp;<span class="ident" id="7229952">req</span><br>
<span class="lineno"></span><span class="op" id="7229956">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="7229959">func</span>&nbsp;<span class="ident" id="7229964">runCgiTest</span><span class="op" id="7229974">(</span><span class="ident" id="7229975">t</span>&nbsp;<span class="op" id="7229977">*</span><span class="ident" id="7229978">testing</span><span class="op" id="7229985">.</span><span class="ident" id="7229986">T</span><span class="op" id="7229987">,</span>&nbsp;<span class="ident" id="7229989">h</span>&nbsp;<span class="op" id="7229991">*</span><span class="ident" id="7229992">Handler</span><span class="op" id="7229999">,</span>&nbsp;<span class="ident" id="7230001">httpreq</span>&nbsp;<span class="builtintype" id="7230009">string</span><span class="op" id="7230015">,</span>&nbsp;<span class="ident" id="7230017">expectedMap</span>&nbsp;<span class="keyword" id="7230029">map</span><span class="op" id="7230032">[</span><span class="builtintype" id="7230033">string</span><span class="op" id="7230039">]</span><span class="builtintype" id="7230040">string</span><span class="op" id="7230046">)</span>&nbsp;<span class="op" id="7230048">*</span><span class="ident" id="7230049">httptest</span><span class="op" id="7230057">.</span><span class="ident" id="7230058">ResponseRecorder</span>&nbsp;<span class="op" id="7230075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230078">rw</span>&nbsp;<span class="op" id="7230081">:=</span>&nbsp;<span class="ident" id="7230084">httptest</span><span class="op" id="7230092">.</span><span class="ident" id="7230093">NewRecorder</span><span class="op" id="7230104">(</span><span class="op" id="7230105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230108">req</span>&nbsp;<span class="op" id="7230112">:=</span>&nbsp;<span class="ident" id="7230115">newRequest</span><span class="op" id="7230125">(</span><span class="ident" id="7230126">httpreq</span><span class="op" id="7230133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230136">h</span><span class="op" id="7230137">.</span><span class="ident" id="7230138">ServeHTTP</span><span class="op" id="7230147">(</span><span class="ident" id="7230148">rw</span><span class="op" id="7230150">,</span>&nbsp;<span class="ident" id="7230152">req</span><span class="op" id="7230155">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7230159">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230217">m</span>&nbsp;<span class="op" id="7230219">:=</span>&nbsp;<span class="builtinfunc" id="7230222">make</span><span class="op" id="7230226">(</span><span class="keyword" id="7230227">map</span><span class="op" id="7230230">[</span><span class="builtintype" id="7230231">string</span><span class="op" id="7230237">]</span><span class="builtintype" id="7230238">string</span><span class="op" id="7230244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230247">m</span><span class="op" id="7230248">[</span><span class="string" id="7230249">&#34;_body&#34;</span><span class="op" id="7230256">]</span>&nbsp;<span class="op" id="7230258">=</span>&nbsp;<span class="ident" id="7230260">rw</span><span class="op" id="7230262">.</span><span class="ident" id="7230263">Body</span><span class="op" id="7230267">.</span><span class="ident" id="7230268">String</span><span class="op" id="7230274">(</span><span class="op" id="7230275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230278">linesRead</span>&nbsp;<span class="op" id="7230288">:=</span>&nbsp;<span class="num" id="7230291">0</span><br>
<span class="lineno">45</span><span class="ident" id="7230293">readlines</span><span class="op" id="7230302">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230305">for</span>&nbsp;<span class="op" id="7230309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230313">line</span><span class="op" id="7230317">,</span>&nbsp;<span class="ident" id="7230319">err</span>&nbsp;<span class="op" id="7230323">:=</span>&nbsp;<span class="ident" id="7230326">rw</span><span class="op" id="7230328">.</span><span class="ident" id="7230329">Body</span><span class="op" id="7230333">.</span><span class="ident" id="7230334">ReadString</span><span class="op" id="7230344">(</span><span class="string" id="7230345">&#39;\n&#39;</span><span class="op" id="7230349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230353">switch</span>&nbsp;<span class="op" id="7230360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230364">case</span>&nbsp;<span class="ident" id="7230369">err</span>&nbsp;<span class="op" id="7230373">==</span>&nbsp;<span class="ident" id="7230376">io</span><span class="op" id="7230378">.</span><span class="ident" id="7230379">EOF</span><span class="op" id="7230382">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230387">break</span>&nbsp;<span class="ident" id="7230393">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230405">case</span>&nbsp;<span class="ident" id="7230410">err</span>&nbsp;<span class="op" id="7230414">!=</span>&nbsp;<span class="ident" id="7230417">nil</span><span class="op" id="7230420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230425">t</span><span class="op" id="7230426">.</span><span class="ident" id="7230427">Fatalf</span><span class="op" id="7230433">(</span><span class="string" id="7230434">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="7230473">,</span>&nbsp;<span class="ident" id="7230475">err</span><span class="op" id="7230478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7230482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230486">linesRead</span><span class="op" id="7230495">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230500">trimmedLine</span>&nbsp;<span class="op" id="7230512">:=</span>&nbsp;<span class="ident" id="7230515">strings</span><span class="op" id="7230522">.</span><span class="ident" id="7230523">TrimRight</span><span class="op" id="7230532">(</span><span class="ident" id="7230533">line</span><span class="op" id="7230537">,</span>&nbsp;<span class="string" id="7230539">&#34;\r\n&#34;</span><span class="op" id="7230545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230549">split</span>&nbsp;<span class="op" id="7230555">:=</span>&nbsp;<span class="ident" id="7230558">strings</span><span class="op" id="7230565">.</span><span class="ident" id="7230566">SplitN</span><span class="op" id="7230572">(</span><span class="ident" id="7230573">trimmedLine</span><span class="op" id="7230584">,</span>&nbsp;<span class="string" id="7230586">&#34;=&#34;</span><span class="op" id="7230589">,</span>&nbsp;<span class="num" id="7230591">2</span><span class="op" id="7230592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230596">if</span>&nbsp;<span class="builtinfunc" id="7230599">len</span><span class="op" id="7230602">(</span><span class="ident" id="7230603">split</span><span class="op" id="7230608">)</span>&nbsp;<span class="op" id="7230610">!=</span>&nbsp;<span class="num" id="7230613">2</span>&nbsp;<span class="op" id="7230615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230620">t</span><span class="op" id="7230621">.</span><span class="ident" id="7230622">Fatalf</span><span class="op" id="7230628">(</span><span class="string" id="7230629">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="7230699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7230705">len</span><span class="op" id="7230708">(</span><span class="ident" id="7230709">split</span><span class="op" id="7230714">)</span><span class="op" id="7230715">,</span>&nbsp;<span class="ident" id="7230717">linesRead</span><span class="op" id="7230726">,</span>&nbsp;<span class="ident" id="7230728">line</span><span class="op" id="7230732">,</span>&nbsp;<span class="ident" id="7230734">m</span><span class="op" id="7230735">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7230739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230743">m</span><span class="op" id="7230744">[</span><span class="ident" id="7230745">split</span><span class="op" id="7230750">[</span><span class="num" id="7230751">0</span><span class="op" id="7230752">]</span><span class="op" id="7230753">]</span>&nbsp;<span class="op" id="7230755">=</span>&nbsp;<span class="ident" id="7230757">split</span><span class="op" id="7230762">[</span><span class="num" id="7230763">1</span><span class="op" id="7230764">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7230767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230771">for</span>&nbsp;<span class="ident" id="7230775">key</span><span class="op" id="7230778">,</span>&nbsp;<span class="ident" id="7230780">expected</span>&nbsp;<span class="op" id="7230789">:=</span>&nbsp;<span class="keyword" id="7230792">range</span>&nbsp;<span class="ident" id="7230798">expectedMap</span>&nbsp;<span class="op" id="7230810">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230814">got</span>&nbsp;<span class="op" id="7230818">:=</span>&nbsp;<span class="ident" id="7230821">m</span><span class="op" id="7230822">[</span><span class="ident" id="7230823">key</span><span class="op" id="7230826">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230830">if</span>&nbsp;<span class="ident" id="7230833">key</span>&nbsp;<span class="op" id="7230837">==</span>&nbsp;<span class="string" id="7230840">&#34;cwd&#34;</span>&nbsp;<span class="op" id="7230846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7230851">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230893">fi1</span><span class="op" id="7230896">,</span>&nbsp;<span class="ident" id="7230898">_</span>&nbsp;<span class="op" id="7230900">:=</span>&nbsp;<span class="ident" id="7230903">os</span><span class="op" id="7230905">.</span><span class="ident" id="7230906">Stat</span><span class="op" id="7230910">(</span><span class="ident" id="7230911">got</span><span class="op" id="7230914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230919">fi2</span><span class="op" id="7230922">,</span>&nbsp;<span class="ident" id="7230924">_</span>&nbsp;<span class="op" id="7230926">:=</span>&nbsp;<span class="ident" id="7230929">os</span><span class="op" id="7230931">.</span><span class="ident" id="7230932">Stat</span><span class="op" id="7230936">(</span><span class="ident" id="7230937">expected</span><span class="op" id="7230945">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7230950">if</span>&nbsp;<span class="ident" id="7230953">os</span><span class="op" id="7230955">.</span><span class="ident" id="7230956">SameFile</span><span class="op" id="7230964">(</span><span class="ident" id="7230965">fi1</span><span class="op" id="7230968">,</span>&nbsp;<span class="ident" id="7230970">fi2</span><span class="op" id="7230973">)</span>&nbsp;<span class="op" id="7230975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7230981">got</span>&nbsp;<span class="op" id="7230985">=</span>&nbsp;<span class="ident" id="7230987">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7230999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7231003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7231007">if</span>&nbsp;<span class="ident" id="7231010">got</span>&nbsp;<span class="op" id="7231014">!=</span>&nbsp;<span class="ident" id="7231017">expected</span>&nbsp;<span class="op" id="7231026">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231031">t</span><span class="op" id="7231032">.</span><span class="ident" id="7231033">Errorf</span><span class="op" id="7231039">(</span><span class="string" id="7231040">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7231072">,</span>&nbsp;<span class="ident" id="7231074">key</span><span class="op" id="7231077">,</span>&nbsp;<span class="ident" id="7231079">got</span><span class="op" id="7231082">,</span>&nbsp;<span class="ident" id="7231084">expected</span><span class="op" id="7231092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7231096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7231099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7231102">return</span>&nbsp;<span class="ident" id="7231109">rw</span><br>
<span class="lineno"></span><span class="op" id="7231112">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7231115">var</span>&nbsp;<span class="ident" id="7231119">cgiTested</span><span class="op" id="7231128">,</span>&nbsp;<span class="ident" id="7231130">cgiWorks</span>&nbsp;<span class="builtintype" id="7231139">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7231145">func</span>&nbsp;<span class="ident" id="7231150">check</span><span class="op" id="7231155">(</span><span class="ident" id="7231156">t</span>&nbsp;<span class="op" id="7231158">*</span><span class="ident" id="7231159">testing</span><span class="op" id="7231166">.</span><span class="ident" id="7231167">T</span><span class="op" id="7231168">)</span>&nbsp;<span class="op" id="7231170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7231173">if</span>&nbsp;<span class="op" id="7231176">!</span><span class="ident" id="7231177">cgiTested</span>&nbsp;<span class="op" id="7231187">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231191">cgiTested</span>&nbsp;<span class="op" id="7231201">=</span>&nbsp;<span class="builtintype" id="7231203">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231210">cgiWorks</span>&nbsp;<span class="op" id="7231219">=</span>&nbsp;<span class="ident" id="7231221">exec</span><span class="op" id="7231225">.</span><span class="ident" id="7231226">Command</span><span class="op" id="7231233">(</span><span class="string" id="7231234">&#34;./testdata/test.cgi&#34;</span><span class="op" id="7231255">)</span><span class="op" id="7231256">.</span><span class="ident" id="7231257">Run</span><span class="op" id="7231260">(</span><span class="op" id="7231261">)</span>&nbsp;<span class="op" id="7231263">==</span>&nbsp;<span class="ident" id="7231266">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7231271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7231274">if</span>&nbsp;<span class="op" id="7231277">!</span><span class="ident" id="7231278">cgiWorks</span>&nbsp;<span class="op" id="7231287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7231291">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7231335">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231386">t</span><span class="op" id="7231387">.</span><span class="ident" id="7231388">Skip</span><span class="op" id="7231392">(</span><span class="string" id="7231393">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="7231426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7231429">}</span><br>
<span class="lineno"></span><span class="op" id="7231431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7231434">func</span>&nbsp;<span class="ident" id="7231439">TestCGIBasicGet</span><span class="op" id="7231454">(</span><span class="ident" id="7231455">t</span>&nbsp;<span class="op" id="7231457">*</span><span class="ident" id="7231458">testing</span><span class="op" id="7231465">.</span><span class="ident" id="7231466">T</span><span class="op" id="7231467">)</span>&nbsp;<span class="op" id="7231469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231472">check</span><span class="op" id="7231477">(</span><span class="ident" id="7231478">t</span><span class="op" id="7231479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231482">h</span>&nbsp;<span class="op" id="7231484">:=</span>&nbsp;<span class="op" id="7231487">&amp;</span><span class="ident" id="7231488">Handler</span><span class="op" id="7231495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231499">Path</span><span class="op" id="7231503">:</span>&nbsp;<span class="string" id="7231505">&#34;testdata/test.cgi&#34;</span><span class="op" id="7231524">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231528">Root</span><span class="op" id="7231532">:</span>&nbsp;<span class="string" id="7231534">&#34;/test.cgi&#34;</span><span class="op" id="7231545">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7231548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7231551">expectedMap</span>&nbsp;<span class="op" id="7231563">:=</span>&nbsp;<span class="keyword" id="7231566">map</span><span class="op" id="7231569">[</span><span class="builtintype" id="7231570">string</span><span class="op" id="7231576">]</span><span class="builtintype" id="7231577">string</span><span class="op" id="7231583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231587">&#34;test&#34;</span><span class="op" id="7231593">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231612">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7231623">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231627">&#34;param-a&#34;</span><span class="op" id="7231636">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231652">&#34;b&#34;</span><span class="op" id="7231655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231659">&#34;param-foo&#34;</span><span class="op" id="7231670">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231684">&#34;bar&#34;</span><span class="op" id="7231689">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231693">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7231716">:</span>&nbsp;<span class="string" id="7231718">&#34;CGI/1.1&#34;</span><span class="op" id="7231727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231731">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7231746">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231756">&#34;example.com&#34;</span><span class="op" id="7231769">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231773">&#34;env-PATH_INFO&#34;</span><span class="op" id="7231788">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231798">&#34;&#34;</span><span class="op" id="7231800">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231804">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7231822">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231829">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7231842">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231846">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7231863">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231871">&#34;1.2.3.4&#34;</span><span class="op" id="7231880">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231884">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7231901">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231909">&#34;1.2.3.4&#34;</span><span class="op" id="7231918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231922">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7231942">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231947">&#34;GET&#34;</span><span class="op" id="7231952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7231956">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7231973">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7231981">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7232004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232008">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7232029">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7232033">&#34;testdata/test.cgi&#34;</span><span class="op" id="7232052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232056">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7232073">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7232081">&#34;/test.cgi&#34;</span><span class="op" id="7232092">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232096">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7232113">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7232121">&#34;example.com&#34;</span><span class="op" id="7232134">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232138">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7232155">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7232163">&#34;80&#34;</span><span class="op" id="7232167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232171">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7232192">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7232196">&#34;go&#34;</span><span class="op" id="7232200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7232203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232206">replay</span>&nbsp;<span class="op" id="7232213">:=</span>&nbsp;<span class="ident" id="7232216">runCgiTest</span><span class="op" id="7232226">(</span><span class="ident" id="7232227">t</span><span class="op" id="7232228">,</span>&nbsp;<span class="ident" id="7232230">h</span><span class="op" id="7232231">,</span>&nbsp;<span class="string" id="7232233">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7232292">,</span>&nbsp;<span class="ident" id="7232294">expectedMap</span><span class="op" id="7232305">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7232309">if</span>&nbsp;<span class="ident" id="7232312">expected</span><span class="op" id="7232320">,</span>&nbsp;<span class="ident" id="7232322">got</span>&nbsp;<span class="op" id="7232326">:=</span>&nbsp;<span class="string" id="7232329">&#34;text/html&#34;</span><span class="op" id="7232340">,</span>&nbsp;<span class="ident" id="7232342">replay</span><span class="op" id="7232348">.</span><span class="ident" id="7232349">Header</span><span class="op" id="7232355">(</span><span class="op" id="7232356">)</span><span class="op" id="7232357">.</span><span class="ident" id="7232358">Get</span><span class="op" id="7232361">(</span><span class="string" id="7232362">&#34;Content-Type&#34;</span><span class="op" id="7232376">)</span><span class="op" id="7232377">;</span>&nbsp;<span class="ident" id="7232379">got</span>&nbsp;<span class="op" id="7232383">!=</span>&nbsp;<span class="ident" id="7232386">expected</span>&nbsp;<span class="op" id="7232395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232399">t</span><span class="op" id="7232400">.</span><span class="ident" id="7232401">Errorf</span><span class="op" id="7232407">(</span><span class="string" id="7232408">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7232447">,</span>&nbsp;<span class="ident" id="7232449">got</span><span class="op" id="7232452">,</span>&nbsp;<span class="ident" id="7232454">expected</span><span class="op" id="7232462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7232465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7232468">if</span>&nbsp;<span class="ident" id="7232471">expected</span><span class="op" id="7232479">,</span>&nbsp;<span class="ident" id="7232481">got</span>&nbsp;<span class="op" id="7232485">:=</span>&nbsp;<span class="string" id="7232488">&#34;X-Test-Value&#34;</span><span class="op" id="7232502">,</span>&nbsp;<span class="ident" id="7232504">replay</span><span class="op" id="7232510">.</span><span class="ident" id="7232511">Header</span><span class="op" id="7232517">(</span><span class="op" id="7232518">)</span><span class="op" id="7232519">.</span><span class="ident" id="7232520">Get</span><span class="op" id="7232523">(</span><span class="string" id="7232524">&#34;X-Test-Header&#34;</span><span class="op" id="7232539">)</span><span class="op" id="7232540">;</span>&nbsp;<span class="ident" id="7232542">got</span>&nbsp;<span class="op" id="7232546">!=</span>&nbsp;<span class="ident" id="7232549">expected</span>&nbsp;<span class="op" id="7232558">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232562">t</span><span class="op" id="7232563">.</span><span class="ident" id="7232564">Errorf</span><span class="op" id="7232570">(</span><span class="string" id="7232571">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7232611">,</span>&nbsp;<span class="ident" id="7232613">got</span><span class="op" id="7232616">,</span>&nbsp;<span class="ident" id="7232618">expected</span><span class="op" id="7232626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7232629">}</span><br>
<span class="lineno"></span><span class="op" id="7232631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7232634">func</span>&nbsp;<span class="ident" id="7232639">TestCGIBasicGetAbsPath</span><span class="op" id="7232661">(</span><span class="ident" id="7232662">t</span>&nbsp;<span class="op" id="7232664">*</span><span class="ident" id="7232665">testing</span><span class="op" id="7232672">.</span><span class="ident" id="7232673">T</span><span class="op" id="7232674">)</span>&nbsp;<span class="op" id="7232676">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232679">check</span><span class="op" id="7232684">(</span><span class="ident" id="7232685">t</span><span class="op" id="7232686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232689">pwd</span><span class="op" id="7232692">,</span>&nbsp;<span class="ident" id="7232694">err</span>&nbsp;<span class="op" id="7232698">:=</span>&nbsp;<span class="ident" id="7232701">os</span><span class="op" id="7232703">.</span><span class="ident" id="7232704">Getwd</span><span class="op" id="7232709">(</span><span class="op" id="7232710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7232713">if</span>&nbsp;<span class="ident" id="7232716">err</span>&nbsp;<span class="op" id="7232720">!=</span>&nbsp;<span class="ident" id="7232723">nil</span>&nbsp;<span class="op" id="7232727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232731">t</span><span class="op" id="7232732">.</span><span class="ident" id="7232733">Fatalf</span><span class="op" id="7232739">(</span><span class="string" id="7232740">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7232757">,</span>&nbsp;<span class="ident" id="7232759">err</span><span class="op" id="7232762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7232765">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232768">h</span>&nbsp;<span class="op" id="7232770">:=</span>&nbsp;<span class="op" id="7232773">&amp;</span><span class="ident" id="7232774">Handler</span><span class="op" id="7232781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232785">Path</span><span class="op" id="7232789">:</span>&nbsp;<span class="ident" id="7232791">pwd</span>&nbsp;<span class="op" id="7232795">+</span>&nbsp;<span class="string" id="7232797">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7232817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232821">Root</span><span class="op" id="7232825">:</span>&nbsp;<span class="string" id="7232827">&#34;/test.cgi&#34;</span><span class="op" id="7232838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7232841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7232844">expectedMap</span>&nbsp;<span class="op" id="7232856">:=</span>&nbsp;<span class="keyword" id="7232859">map</span><span class="op" id="7232862">[</span><span class="builtintype" id="7232863">string</span><span class="op" id="7232869">]</span><span class="builtintype" id="7232870">string</span><span class="op" id="7232876">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232880">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7232897">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7232903">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7232926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232930">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7232951">:</span>&nbsp;<span class="ident" id="7232953">pwd</span>&nbsp;<span class="op" id="7232957">+</span>&nbsp;<span class="string" id="7232959">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7232979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7232983">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7233000">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233006">&#34;/test.cgi&#34;</span><span class="op" id="7233017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7233020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233023">runCgiTest</span><span class="op" id="7233033">(</span><span class="ident" id="7233034">t</span><span class="op" id="7233035">,</span>&nbsp;<span class="ident" id="7233037">h</span><span class="op" id="7233038">,</span>&nbsp;<span class="string" id="7233040">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7233099">,</span>&nbsp;<span class="ident" id="7233101">expectedMap</span><span class="op" id="7233112">)</span><br>
<span class="lineno">145</span><span class="op" id="7233114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7233117">func</span>&nbsp;<span class="ident" id="7233122">TestPathInfo</span><span class="op" id="7233134">(</span><span class="ident" id="7233135">t</span>&nbsp;<span class="op" id="7233137">*</span><span class="ident" id="7233138">testing</span><span class="op" id="7233145">.</span><span class="ident" id="7233146">T</span><span class="op" id="7233147">)</span>&nbsp;<span class="op" id="7233149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233152">check</span><span class="op" id="7233157">(</span><span class="ident" id="7233158">t</span><span class="op" id="7233159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233162">h</span>&nbsp;<span class="op" id="7233164">:=</span>&nbsp;<span class="op" id="7233167">&amp;</span><span class="ident" id="7233168">Handler</span><span class="op" id="7233175">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233179">Path</span><span class="op" id="7233183">:</span>&nbsp;<span class="string" id="7233185">&#34;testdata/test.cgi&#34;</span><span class="op" id="7233204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233208">Root</span><span class="op" id="7233212">:</span>&nbsp;<span class="string" id="7233214">&#34;/test.cgi&#34;</span><span class="op" id="7233225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7233228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233231">expectedMap</span>&nbsp;<span class="op" id="7233243">:=</span>&nbsp;<span class="keyword" id="7233246">map</span><span class="op" id="7233249">[</span><span class="builtintype" id="7233250">string</span><span class="op" id="7233256">]</span><span class="builtintype" id="7233257">string</span><span class="op" id="7233263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233267">&#34;param-a&#34;</span><span class="op" id="7233276">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233290">&#34;b&#34;</span><span class="op" id="7233293">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233297">&#34;env-PATH_INFO&#34;</span><span class="op" id="7233312">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233320">&#34;/extrapath&#34;</span><span class="op" id="7233332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233336">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7233354">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233359">&#34;a=b&#34;</span><span class="op" id="7233364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233368">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7233385">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233391">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="7233416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233420">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7233441">:</span>&nbsp;<span class="string" id="7233443">&#34;testdata/test.cgi&#34;</span><span class="op" id="7233462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233466">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7233483">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233489">&#34;/test.cgi&#34;</span><span class="op" id="7233500">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7233503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233506">runCgiTest</span><span class="op" id="7233516">(</span><span class="ident" id="7233517">t</span><span class="op" id="7233518">,</span>&nbsp;<span class="ident" id="7233520">h</span><span class="op" id="7233521">,</span>&nbsp;<span class="string" id="7233523">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7233584">,</span>&nbsp;<span class="ident" id="7233586">expectedMap</span><span class="op" id="7233597">)</span><br>
<span class="lineno"></span><span class="op" id="7233599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7233602">func</span>&nbsp;<span class="ident" id="7233607">TestPathInfoDirRoot</span><span class="op" id="7233626">(</span><span class="ident" id="7233627">t</span>&nbsp;<span class="op" id="7233629">*</span><span class="ident" id="7233630">testing</span><span class="op" id="7233637">.</span><span class="ident" id="7233638">T</span><span class="op" id="7233639">)</span>&nbsp;<span class="op" id="7233641">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233644">check</span><span class="op" id="7233649">(</span><span class="ident" id="7233650">t</span><span class="op" id="7233651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233654">h</span>&nbsp;<span class="op" id="7233656">:=</span>&nbsp;<span class="op" id="7233659">&amp;</span><span class="ident" id="7233660">Handler</span><span class="op" id="7233667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233671">Path</span><span class="op" id="7233675">:</span>&nbsp;<span class="string" id="7233677">&#34;testdata/test.cgi&#34;</span><span class="op" id="7233696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233700">Root</span><span class="op" id="7233704">:</span>&nbsp;<span class="string" id="7233706">&#34;/myscript/&#34;</span><span class="op" id="7233718">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7233721">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233724">expectedMap</span>&nbsp;<span class="op" id="7233736">:=</span>&nbsp;<span class="keyword" id="7233739">map</span><span class="op" id="7233742">[</span><span class="builtintype" id="7233743">string</span><span class="op" id="7233749">]</span><span class="builtintype" id="7233750">string</span><span class="op" id="7233756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233760">&#34;env-PATH_INFO&#34;</span><span class="op" id="7233775">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233783">&#34;bar&#34;</span><span class="op" id="7233788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233792">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7233810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233815">&#34;a=b&#34;</span><span class="op" id="7233820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233824">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7233841">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233847">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7233866">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233870">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7233891">:</span>&nbsp;<span class="string" id="7233893">&#34;testdata/test.cgi&#34;</span><span class="op" id="7233912">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7233916">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7233933">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7233939">&#34;/myscript/&#34;</span><span class="op" id="7233951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7233954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7233957">runCgiTest</span><span class="op" id="7233967">(</span><span class="ident" id="7233968">t</span><span class="op" id="7233969">,</span>&nbsp;<span class="ident" id="7233971">h</span><span class="op" id="7233972">,</span>&nbsp;<span class="string" id="7233974">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7234029">,</span>&nbsp;<span class="ident" id="7234031">expectedMap</span><span class="op" id="7234042">)</span><br>
<span class="lineno"></span><span class="op" id="7234044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7234047">func</span>&nbsp;<span class="ident" id="7234052">TestDupHeaders</span><span class="op" id="7234066">(</span><span class="ident" id="7234067">t</span>&nbsp;<span class="op" id="7234069">*</span><span class="ident" id="7234070">testing</span><span class="op" id="7234077">.</span><span class="ident" id="7234078">T</span><span class="op" id="7234079">)</span>&nbsp;<span class="op" id="7234081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234084">check</span><span class="op" id="7234089">(</span><span class="ident" id="7234090">t</span><span class="op" id="7234091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234094">h</span>&nbsp;<span class="op" id="7234096">:=</span>&nbsp;<span class="op" id="7234099">&amp;</span><span class="ident" id="7234100">Handler</span><span class="op" id="7234107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234111">Path</span><span class="op" id="7234115">:</span>&nbsp;<span class="string" id="7234117">&#34;testdata/test.cgi&#34;</span><span class="op" id="7234136">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234139">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234142">expectedMap</span>&nbsp;<span class="op" id="7234154">:=</span>&nbsp;<span class="keyword" id="7234157">map</span><span class="op" id="7234160">[</span><span class="builtintype" id="7234161">string</span><span class="op" id="7234167">]</span><span class="builtintype" id="7234168">string</span><span class="op" id="7234174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234178">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7234195">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234201">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7234220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234224">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7234245">:</span>&nbsp;<span class="string" id="7234247">&#34;testdata/test.cgi&#34;</span><span class="op" id="7234266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234270">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="7234287">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234293">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="7234311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234315">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="7234331">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234338">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="7234350">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234356">runCgiTest</span><span class="op" id="7234366">(</span><span class="ident" id="7234367">t</span><span class="op" id="7234368">,</span>&nbsp;<span class="ident" id="7234370">h</span><span class="op" id="7234371">,</span>&nbsp;<span class="string" id="7234373">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="7234407">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234411">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="7234430">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234434">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="7234453">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234457">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="7234472">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234476">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="7234491">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234495">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="7234518">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234522">expectedMap</span><span class="op" id="7234533">)</span><br>
<span class="lineno"></span><span class="op" id="7234535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="7234538">func</span>&nbsp;<span class="ident" id="7234543">TestPathInfoNoRoot</span><span class="op" id="7234561">(</span><span class="ident" id="7234562">t</span>&nbsp;<span class="op" id="7234564">*</span><span class="ident" id="7234565">testing</span><span class="op" id="7234572">.</span><span class="ident" id="7234573">T</span><span class="op" id="7234574">)</span>&nbsp;<span class="op" id="7234576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234579">check</span><span class="op" id="7234584">(</span><span class="ident" id="7234585">t</span><span class="op" id="7234586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234589">h</span>&nbsp;<span class="op" id="7234591">:=</span>&nbsp;<span class="op" id="7234594">&amp;</span><span class="ident" id="7234595">Handler</span><span class="op" id="7234602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234606">Path</span><span class="op" id="7234610">:</span>&nbsp;<span class="string" id="7234612">&#34;testdata/test.cgi&#34;</span><span class="op" id="7234631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234635">Root</span><span class="op" id="7234639">:</span>&nbsp;<span class="string" id="7234641">&#34;&#34;</span><span class="op" id="7234643">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234649">expectedMap</span>&nbsp;<span class="op" id="7234661">:=</span>&nbsp;<span class="keyword" id="7234664">map</span><span class="op" id="7234667">[</span><span class="builtintype" id="7234668">string</span><span class="op" id="7234674">]</span><span class="builtintype" id="7234675">string</span><span class="op" id="7234681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234685">&#34;env-PATH_INFO&#34;</span><span class="op" id="7234700">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234708">&#34;/bar&#34;</span><span class="op" id="7234714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234718">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7234736">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234741">&#34;a=b&#34;</span><span class="op" id="7234746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234750">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7234767">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234773">&#34;/bar?a=b&#34;</span><span class="op" id="7234783">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234787">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7234808">:</span>&nbsp;<span class="string" id="7234810">&#34;testdata/test.cgi&#34;</span><span class="op" id="7234829">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7234833">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7234850">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7234856">&#34;/&#34;</span><span class="op" id="7234859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7234862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234865">runCgiTest</span><span class="op" id="7234875">(</span><span class="ident" id="7234876">t</span><span class="op" id="7234877">,</span>&nbsp;<span class="ident" id="7234879">h</span><span class="op" id="7234880">,</span>&nbsp;<span class="string" id="7234882">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7234928">,</span>&nbsp;<span class="ident" id="7234930">expectedMap</span><span class="op" id="7234941">)</span><br>
<span class="lineno"></span><span class="op" id="7234943">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7234946">func</span>&nbsp;<span class="ident" id="7234951">TestCGIBasicPost</span><span class="op" id="7234967">(</span><span class="ident" id="7234968">t</span>&nbsp;<span class="op" id="7234970">*</span><span class="ident" id="7234971">testing</span><span class="op" id="7234978">.</span><span class="ident" id="7234979">T</span><span class="op" id="7234980">)</span>&nbsp;<span class="op" id="7234982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234985">check</span><span class="op" id="7234990">(</span><span class="ident" id="7234991">t</span><span class="op" id="7234992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7234995">postReq</span>&nbsp;<span class="op" id="7235003">:=</span>&nbsp;<span class="string" id="7235006">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235139">h</span>&nbsp;<span class="op" id="7235141">:=</span>&nbsp;<span class="op" id="7235144">&amp;</span><span class="ident" id="7235145">Handler</span><span class="op" id="7235152">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235156">Path</span><span class="op" id="7235160">:</span>&nbsp;<span class="string" id="7235162">&#34;testdata/test.cgi&#34;</span><span class="op" id="7235181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235185">Root</span><span class="op" id="7235189">:</span>&nbsp;<span class="string" id="7235191">&#34;/test.cgi&#34;</span><span class="op" id="7235202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7235205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235208">expectedMap</span>&nbsp;<span class="op" id="7235220">:=</span>&nbsp;<span class="keyword" id="7235223">map</span><span class="op" id="7235226">[</span><span class="builtintype" id="7235227">string</span><span class="op" id="7235233">]</span><span class="builtintype" id="7235234">string</span><span class="op" id="7235240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7235244">&#34;test&#34;</span><span class="op" id="7235250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235266">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7235277">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7235281">&#34;param-postfoo&#34;</span><span class="op" id="7235296">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235303">&#34;postbar&#34;</span><span class="op" id="7235312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7235316">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7235336">:</span>&nbsp;<span class="string" id="7235338">&#34;POST&#34;</span><span class="op" id="7235344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7235348">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="7235368">:</span>&nbsp;<span class="string" id="7235370">&#34;15&#34;</span><span class="op" id="7235374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7235378">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7235395">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7235400">&#34;/test.cgi?a=b&#34;</span><span class="op" id="7235415">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7235418">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235421">runCgiTest</span><span class="op" id="7235431">(</span><span class="ident" id="7235432">t</span><span class="op" id="7235433">,</span>&nbsp;<span class="ident" id="7235435">h</span><span class="op" id="7235436">,</span>&nbsp;<span class="ident" id="7235438">postReq</span><span class="op" id="7235445">,</span>&nbsp;<span class="ident" id="7235447">expectedMap</span><span class="op" id="7235458">)</span><br>
<span class="lineno"></span><span class="op" id="7235460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7235463">func</span>&nbsp;<span class="ident" id="7235468">chunk</span><span class="op" id="7235473">(</span><span class="ident" id="7235474">s</span>&nbsp;<span class="builtintype" id="7235476">string</span><span class="op" id="7235482">)</span>&nbsp;<span class="builtintype" id="7235484">string</span>&nbsp;<span class="op" id="7235491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235494">return</span>&nbsp;<span class="ident" id="7235501">fmt</span><span class="op" id="7235504">.</span><span class="ident" id="7235505">Sprintf</span><span class="op" id="7235512">(</span><span class="string" id="7235513">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="7235527">,</span>&nbsp;<span class="builtinfunc" id="7235529">len</span><span class="op" id="7235532">(</span><span class="ident" id="7235533">s</span><span class="op" id="7235534">)</span><span class="op" id="7235535">,</span>&nbsp;<span class="ident" id="7235537">s</span><span class="op" id="7235538">)</span><br>
<span class="lineno">240</span><span class="op" id="7235540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7235543">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="7235591">func</span>&nbsp;<span class="ident" id="7235596">TestCGIPostChunked</span><span class="op" id="7235614">(</span><span class="ident" id="7235615">t</span>&nbsp;<span class="op" id="7235617">*</span><span class="ident" id="7235618">testing</span><span class="op" id="7235625">.</span><span class="ident" id="7235626">T</span><span class="op" id="7235627">)</span>&nbsp;<span class="op" id="7235629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235632">check</span><span class="op" id="7235637">(</span><span class="ident" id="7235638">t</span><span class="op" id="7235639">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235642">postReq</span>&nbsp;<span class="op" id="7235650">:=</span>&nbsp;<span class="string" id="7235653">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="7235778">+</span>&nbsp;<span class="ident" id="7235780">chunk</span><span class="op" id="7235785">(</span><span class="string" id="7235786">&#34;postfoo&#34;</span><span class="op" id="7235795">)</span>&nbsp;<span class="op" id="7235797">+</span>&nbsp;<span class="ident" id="7235799">chunk</span><span class="op" id="7235804">(</span><span class="string" id="7235805">&#34;=&#34;</span><span class="op" id="7235808">)</span>&nbsp;<span class="op" id="7235810">+</span>&nbsp;<span class="ident" id="7235812">chunk</span><span class="op" id="7235817">(</span><span class="string" id="7235818">&#34;postbar&#34;</span><span class="op" id="7235827">)</span>&nbsp;<span class="op" id="7235829">+</span>&nbsp;<span class="ident" id="7235831">chunk</span><span class="op" id="7235836">(</span><span class="string" id="7235837">&#34;&#34;</span><span class="op" id="7235839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235843">h</span>&nbsp;<span class="op" id="7235845">:=</span>&nbsp;<span class="op" id="7235848">&amp;</span><span class="ident" id="7235849">Handler</span><span class="op" id="7235856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235860">Path</span><span class="op" id="7235864">:</span>&nbsp;<span class="string" id="7235866">&#34;testdata/test.cgi&#34;</span><span class="op" id="7235885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235889">Root</span><span class="op" id="7235893">:</span>&nbsp;<span class="string" id="7235895">&#34;/test.cgi&#34;</span><span class="op" id="7235906">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7235909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235912">expectedMap</span>&nbsp;<span class="op" id="7235924">:=</span>&nbsp;<span class="keyword" id="7235927">map</span><span class="op" id="7235930">[</span><span class="builtintype" id="7235931">string</span><span class="op" id="7235937">]</span><span class="builtintype" id="7235938">string</span><span class="op" id="7235944">{</span><span class="op" id="7235945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7235948">resp</span>&nbsp;<span class="op" id="7235953">:=</span>&nbsp;<span class="ident" id="7235956">runCgiTest</span><span class="op" id="7235966">(</span><span class="ident" id="7235967">t</span><span class="op" id="7235968">,</span>&nbsp;<span class="ident" id="7235970">h</span><span class="op" id="7235971">,</span>&nbsp;<span class="ident" id="7235973">postReq</span><span class="op" id="7235980">,</span>&nbsp;<span class="ident" id="7235982">expectedMap</span><span class="op" id="7235993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7235996">if</span>&nbsp;<span class="ident" id="7235999">got</span><span class="op" id="7236002">,</span>&nbsp;<span class="ident" id="7236004">expected</span>&nbsp;<span class="op" id="7236013">:=</span>&nbsp;<span class="ident" id="7236016">resp</span><span class="op" id="7236020">.</span><span class="ident" id="7236021">Code</span><span class="op" id="7236025">,</span>&nbsp;<span class="ident" id="7236027">http</span><span class="op" id="7236031">.</span><span class="ident" id="7236032">StatusBadRequest</span><span class="op" id="7236048">;</span>&nbsp;<span class="ident" id="7236050">got</span>&nbsp;<span class="op" id="7236054">!=</span>&nbsp;<span class="ident" id="7236057">expected</span>&nbsp;<span class="op" id="7236066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236070">t</span><span class="op" id="7236071">.</span><span class="ident" id="7236072">Fatalf</span><span class="op" id="7236078">(</span><span class="string" id="7236079">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7236140">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236145">expected</span><span class="op" id="7236153">,</span>&nbsp;<span class="ident" id="7236155">got</span><span class="op" id="7236158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236161">}</span><br>
<span class="lineno"></span><span class="op" id="7236163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7236166">func</span>&nbsp;<span class="ident" id="7236171">TestRedirect</span><span class="op" id="7236183">(</span><span class="ident" id="7236184">t</span>&nbsp;<span class="op" id="7236186">*</span><span class="ident" id="7236187">testing</span><span class="op" id="7236194">.</span><span class="ident" id="7236195">T</span><span class="op" id="7236196">)</span>&nbsp;<span class="op" id="7236198">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236201">check</span><span class="op" id="7236206">(</span><span class="ident" id="7236207">t</span><span class="op" id="7236208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236211">h</span>&nbsp;<span class="op" id="7236213">:=</span>&nbsp;<span class="op" id="7236216">&amp;</span><span class="ident" id="7236217">Handler</span><span class="op" id="7236224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236228">Path</span><span class="op" id="7236232">:</span>&nbsp;<span class="string" id="7236234">&#34;testdata/test.cgi&#34;</span><span class="op" id="7236253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236257">Root</span><span class="op" id="7236261">:</span>&nbsp;<span class="string" id="7236263">&#34;/test.cgi&#34;</span><span class="op" id="7236274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236277">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236280">rec</span>&nbsp;<span class="op" id="7236284">:=</span>&nbsp;<span class="ident" id="7236287">runCgiTest</span><span class="op" id="7236297">(</span><span class="ident" id="7236298">t</span><span class="op" id="7236299">,</span>&nbsp;<span class="ident" id="7236301">h</span><span class="op" id="7236302">,</span>&nbsp;<span class="string" id="7236304">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7236371">,</span>&nbsp;<span class="ident" id="7236373">nil</span><span class="op" id="7236376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236379">if</span>&nbsp;<span class="ident" id="7236382">e</span><span class="op" id="7236383">,</span>&nbsp;<span class="ident" id="7236385">g</span>&nbsp;<span class="op" id="7236387">:=</span>&nbsp;<span class="num" id="7236390">302</span><span class="op" id="7236393">,</span>&nbsp;<span class="ident" id="7236395">rec</span><span class="op" id="7236398">.</span><span class="ident" id="7236399">Code</span><span class="op" id="7236403">;</span>&nbsp;<span class="ident" id="7236405">e</span>&nbsp;<span class="op" id="7236407">!=</span>&nbsp;<span class="ident" id="7236410">g</span>&nbsp;<span class="op" id="7236412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236416">t</span><span class="op" id="7236417">.</span><span class="ident" id="7236418">Errorf</span><span class="op" id="7236424">(</span><span class="string" id="7236425">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7236458">,</span>&nbsp;<span class="ident" id="7236460">e</span><span class="op" id="7236461">,</span>&nbsp;<span class="ident" id="7236463">g</span><span class="op" id="7236464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7236470">if</span>&nbsp;<span class="ident" id="7236473">e</span><span class="op" id="7236474">,</span>&nbsp;<span class="ident" id="7236476">g</span>&nbsp;<span class="op" id="7236478">:=</span>&nbsp;<span class="string" id="7236481">&#34;http://foo.com/&#34;</span><span class="op" id="7236498">,</span>&nbsp;<span class="ident" id="7236500">rec</span><span class="op" id="7236503">.</span><span class="ident" id="7236504">Header</span><span class="op" id="7236510">(</span><span class="op" id="7236511">)</span><span class="op" id="7236512">.</span><span class="ident" id="7236513">Get</span><span class="op" id="7236516">(</span><span class="string" id="7236517">&#34;Location&#34;</span><span class="op" id="7236527">)</span><span class="op" id="7236528">;</span>&nbsp;<span class="ident" id="7236530">e</span>&nbsp;<span class="op" id="7236532">!=</span>&nbsp;<span class="ident" id="7236535">g</span>&nbsp;<span class="op" id="7236537">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236541">t</span><span class="op" id="7236542">.</span><span class="ident" id="7236543">Errorf</span><span class="op" id="7236549">(</span><span class="string" id="7236550">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7236590">,</span>&nbsp;<span class="ident" id="7236592">e</span><span class="op" id="7236593">,</span>&nbsp;<span class="ident" id="7236595">g</span><span class="op" id="7236596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236599">}</span><br>
<span class="lineno"></span><span class="op" id="7236601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7236604">func</span>&nbsp;<span class="ident" id="7236609">TestInternalRedirect</span><span class="op" id="7236629">(</span><span class="ident" id="7236630">t</span>&nbsp;<span class="op" id="7236632">*</span><span class="ident" id="7236633">testing</span><span class="op" id="7236640">.</span><span class="ident" id="7236641">T</span><span class="op" id="7236642">)</span>&nbsp;<span class="op" id="7236644">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236647">check</span><span class="op" id="7236652">(</span><span class="ident" id="7236653">t</span><span class="op" id="7236654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236657">baseHandler</span>&nbsp;<span class="op" id="7236669">:=</span>&nbsp;<span class="ident" id="7236672">http</span><span class="op" id="7236676">.</span><span class="ident" id="7236677">HandlerFunc</span><span class="op" id="7236688">(</span><span class="keyword" id="7236689">func</span><span class="op" id="7236693">(</span><span class="ident" id="7236694">rw</span>&nbsp;<span class="ident" id="7236697">http</span><span class="op" id="7236701">.</span><span class="ident" id="7236702">ResponseWriter</span><span class="op" id="7236716">,</span>&nbsp;<span class="ident" id="7236718">req</span>&nbsp;<span class="op" id="7236722">*</span><span class="ident" id="7236723">http</span><span class="op" id="7236727">.</span><span class="ident" id="7236728">Request</span><span class="op" id="7236735">)</span>&nbsp;<span class="op" id="7236737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236741">fmt</span><span class="op" id="7236744">.</span><span class="ident" id="7236745">Fprintf</span><span class="op" id="7236752">(</span><span class="ident" id="7236753">rw</span><span class="op" id="7236755">,</span>&nbsp;<span class="string" id="7236757">&#34;basepath=%s\n&#34;</span><span class="op" id="7236772">,</span>&nbsp;<span class="ident" id="7236774">req</span><span class="op" id="7236777">.</span><span class="ident" id="7236778">URL</span><span class="op" id="7236781">.</span><span class="ident" id="7236782">Path</span><span class="op" id="7236786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236790">fmt</span><span class="op" id="7236793">.</span><span class="ident" id="7236794">Fprintf</span><span class="op" id="7236801">(</span><span class="ident" id="7236802">rw</span><span class="op" id="7236804">,</span>&nbsp;<span class="string" id="7236806">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="7236823">,</span>&nbsp;<span class="ident" id="7236825">req</span><span class="op" id="7236828">.</span><span class="ident" id="7236829">RemoteAddr</span><span class="op" id="7236839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236842">}</span><span class="op" id="7236843">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236846">h</span>&nbsp;<span class="op" id="7236848">:=</span>&nbsp;<span class="op" id="7236851">&amp;</span><span class="ident" id="7236852">Handler</span><span class="op" id="7236859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236863">Path</span><span class="op" id="7236867">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7236884">&#34;testdata/test.cgi&#34;</span><span class="op" id="7236903">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236907">Root</span><span class="op" id="7236911">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7236928">&#34;/test.cgi&#34;</span><span class="op" id="7236939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236943">PathLocationHandler</span><span class="op" id="7236962">:</span>&nbsp;<span class="ident" id="7236964">baseHandler</span><span class="op" id="7236975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7236978">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7236981">expectedMap</span>&nbsp;<span class="op" id="7236993">:=</span>&nbsp;<span class="keyword" id="7236996">map</span><span class="op" id="7236999">[</span><span class="builtintype" id="7237000">string</span><span class="op" id="7237006">]</span><span class="builtintype" id="7237007">string</span><span class="op" id="7237013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7237017">&#34;basepath&#34;</span><span class="op" id="7237027">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7237031">&#34;/foo&#34;</span><span class="op" id="7237037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7237041">&#34;remoteaddr&#34;</span><span class="op" id="7237053">:</span>&nbsp;<span class="string" id="7237055">&#34;1.2.3.4&#34;</span><span class="op" id="7237064">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237070">runCgiTest</span><span class="op" id="7237080">(</span><span class="ident" id="7237081">t</span><span class="op" id="7237082">,</span>&nbsp;<span class="ident" id="7237084">h</span><span class="op" id="7237085">,</span>&nbsp;<span class="string" id="7237087">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7237143">,</span>&nbsp;<span class="ident" id="7237145">expectedMap</span><span class="op" id="7237156">)</span><br>
<span class="lineno">295</span><span class="op" id="7237158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7237161">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="7237237">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="7237300">func</span>&nbsp;<span class="ident" id="7237305">TestCopyError</span><span class="op" id="7237318">(</span><span class="ident" id="7237319">t</span>&nbsp;<span class="op" id="7237321">*</span><span class="ident" id="7237322">testing</span><span class="op" id="7237329">.</span><span class="ident" id="7237330">T</span><span class="op" id="7237331">)</span>&nbsp;<span class="op" id="7237333">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237336">check</span><span class="op" id="7237341">(</span><span class="ident" id="7237342">t</span><span class="op" id="7237343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237346">if</span>&nbsp;<span class="ident" id="7237349">runtime</span><span class="op" id="7237356">.</span><span class="ident" id="7237357">GOOS</span>&nbsp;<span class="op" id="7237362">==</span>&nbsp;<span class="string" id="7237365">&#34;windows&#34;</span>&nbsp;<span class="op" id="7237375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237379">t</span><span class="op" id="7237380">.</span><span class="ident" id="7237381">Skipf</span><span class="op" id="7237386">(</span><span class="string" id="7237387">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7237408">,</span>&nbsp;<span class="ident" id="7237410">runtime</span><span class="op" id="7237417">.</span><span class="ident" id="7237418">GOOS</span><span class="op" id="7237422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237428">h</span>&nbsp;<span class="op" id="7237430">:=</span>&nbsp;<span class="op" id="7237433">&amp;</span><span class="ident" id="7237434">Handler</span><span class="op" id="7237441">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237445">Path</span><span class="op" id="7237449">:</span>&nbsp;<span class="string" id="7237451">&#34;testdata/test.cgi&#34;</span><span class="op" id="7237470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237474">Root</span><span class="op" id="7237478">:</span>&nbsp;<span class="string" id="7237480">&#34;/test.cgi&#34;</span><span class="op" id="7237491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237497">ts</span>&nbsp;<span class="op" id="7237500">:=</span>&nbsp;<span class="ident" id="7237503">httptest</span><span class="op" id="7237511">.</span><span class="ident" id="7237512">NewServer</span><span class="op" id="7237521">(</span><span class="ident" id="7237522">h</span><span class="op" id="7237523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237526">defer</span>&nbsp;<span class="ident" id="7237532">ts</span><span class="op" id="7237534">.</span><span class="ident" id="7237535">Close</span><span class="op" id="7237540">(</span><span class="op" id="7237541">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237545">conn</span><span class="op" id="7237549">,</span>&nbsp;<span class="ident" id="7237551">err</span>&nbsp;<span class="op" id="7237555">:=</span>&nbsp;<span class="ident" id="7237558">net</span><span class="op" id="7237561">.</span><span class="ident" id="7237562">Dial</span><span class="op" id="7237566">(</span><span class="string" id="7237567">&#34;tcp&#34;</span><span class="op" id="7237572">,</span>&nbsp;<span class="ident" id="7237574">ts</span><span class="op" id="7237576">.</span><span class="ident" id="7237577">Listener</span><span class="op" id="7237585">.</span><span class="ident" id="7237586">Addr</span><span class="op" id="7237590">(</span><span class="op" id="7237591">)</span><span class="op" id="7237592">.</span><span class="ident" id="7237593">String</span><span class="op" id="7237599">(</span><span class="op" id="7237600">)</span><span class="op" id="7237601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237604">if</span>&nbsp;<span class="ident" id="7237607">err</span>&nbsp;<span class="op" id="7237611">!=</span>&nbsp;<span class="ident" id="7237614">nil</span>&nbsp;<span class="op" id="7237618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237622">t</span><span class="op" id="7237623">.</span><span class="ident" id="7237624">Fatal</span><span class="op" id="7237629">(</span><span class="ident" id="7237630">err</span><span class="op" id="7237633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237636">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237639">req</span><span class="op" id="7237642">,</span>&nbsp;<span class="ident" id="7237644">_</span>&nbsp;<span class="op" id="7237646">:=</span>&nbsp;<span class="ident" id="7237649">http</span><span class="op" id="7237653">.</span><span class="ident" id="7237654">NewRequest</span><span class="op" id="7237664">(</span><span class="string" id="7237665">&#34;GET&#34;</span><span class="op" id="7237670">,</span>&nbsp;<span class="string" id="7237672">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="7237715">,</span>&nbsp;<span class="ident" id="7237717">nil</span><span class="op" id="7237720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237723">err</span>&nbsp;<span class="op" id="7237727">=</span>&nbsp;<span class="ident" id="7237729">req</span><span class="op" id="7237732">.</span><span class="ident" id="7237733">Write</span><span class="op" id="7237738">(</span><span class="ident" id="7237739">conn</span><span class="op" id="7237743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237746">if</span>&nbsp;<span class="ident" id="7237749">err</span>&nbsp;<span class="op" id="7237753">!=</span>&nbsp;<span class="ident" id="7237756">nil</span>&nbsp;<span class="op" id="7237760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237764">t</span><span class="op" id="7237765">.</span><span class="ident" id="7237766">Fatalf</span><span class="op" id="7237772">(</span><span class="string" id="7237773">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="7237784">,</span>&nbsp;<span class="ident" id="7237786">err</span><span class="op" id="7237789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237792">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237796">res</span><span class="op" id="7237799">,</span>&nbsp;<span class="ident" id="7237801">err</span>&nbsp;<span class="op" id="7237805">:=</span>&nbsp;<span class="ident" id="7237808">http</span><span class="op" id="7237812">.</span><span class="ident" id="7237813">ReadResponse</span><span class="op" id="7237825">(</span><span class="ident" id="7237826">bufio</span><span class="op" id="7237831">.</span><span class="ident" id="7237832">NewReader</span><span class="op" id="7237841">(</span><span class="ident" id="7237842">conn</span><span class="op" id="7237846">)</span><span class="op" id="7237847">,</span>&nbsp;<span class="ident" id="7237849">req</span><span class="op" id="7237852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237855">if</span>&nbsp;<span class="ident" id="7237858">err</span>&nbsp;<span class="op" id="7237862">!=</span>&nbsp;<span class="ident" id="7237865">nil</span>&nbsp;<span class="op" id="7237869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237873">t</span><span class="op" id="7237874">.</span><span class="ident" id="7237875">Fatalf</span><span class="op" id="7237881">(</span><span class="string" id="7237882">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="7237900">,</span>&nbsp;<span class="ident" id="7237902">err</span><span class="op" id="7237905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7237908">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237912">pidstr</span>&nbsp;<span class="op" id="7237919">:=</span>&nbsp;<span class="ident" id="7237922">res</span><span class="op" id="7237925">.</span><span class="ident" id="7237926">Header</span><span class="op" id="7237932">.</span><span class="ident" id="7237933">Get</span><span class="op" id="7237936">(</span><span class="string" id="7237937">&#34;X-CGI-Pid&#34;</span><span class="op" id="7237948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7237951">if</span>&nbsp;<span class="ident" id="7237954">pidstr</span>&nbsp;<span class="op" id="7237961">==</span>&nbsp;<span class="string" id="7237964">&#34;&#34;</span>&nbsp;<span class="op" id="7237967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7237971">t</span><span class="op" id="7237972">.</span><span class="ident" id="7237973">Fatalf</span><span class="op" id="7237979">(</span><span class="string" id="7237980">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="7238022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238025">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238028">pid</span><span class="op" id="7238031">,</span>&nbsp;<span class="ident" id="7238033">err</span>&nbsp;<span class="op" id="7238037">:=</span>&nbsp;<span class="ident" id="7238040">strconv</span><span class="op" id="7238047">.</span><span class="ident" id="7238048">Atoi</span><span class="op" id="7238052">(</span><span class="ident" id="7238053">pidstr</span><span class="op" id="7238059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238062">if</span>&nbsp;<span class="ident" id="7238065">err</span>&nbsp;<span class="op" id="7238069">!=</span>&nbsp;<span class="ident" id="7238072">nil</span>&nbsp;<span class="op" id="7238076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238080">t</span><span class="op" id="7238081">.</span><span class="ident" id="7238082">Fatalf</span><span class="op" id="7238088">(</span><span class="string" id="7238089">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="7238114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238121">var</span>&nbsp;<span class="ident" id="7238125">buf</span>&nbsp;<span class="op" id="7238129">[</span><span class="num" id="7238130">5000</span><span class="op" id="7238134">]</span><span class="builtintype" id="7238135">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238141">n</span><span class="op" id="7238142">,</span>&nbsp;<span class="ident" id="7238144">err</span>&nbsp;<span class="op" id="7238148">:=</span>&nbsp;<span class="ident" id="7238151">io</span><span class="op" id="7238153">.</span><span class="ident" id="7238154">ReadFull</span><span class="op" id="7238162">(</span><span class="ident" id="7238163">res</span><span class="op" id="7238166">.</span><span class="ident" id="7238167">Body</span><span class="op" id="7238171">,</span>&nbsp;<span class="ident" id="7238173">buf</span><span class="op" id="7238176">[</span><span class="op" id="7238177">:</span><span class="op" id="7238178">]</span><span class="op" id="7238179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238182">if</span>&nbsp;<span class="ident" id="7238185">err</span>&nbsp;<span class="op" id="7238189">!=</span>&nbsp;<span class="ident" id="7238192">nil</span>&nbsp;<span class="op" id="7238196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238200">t</span><span class="op" id="7238201">.</span><span class="ident" id="7238202">Fatalf</span><span class="op" id="7238208">(</span><span class="string" id="7238209">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="7238233">,</span>&nbsp;<span class="ident" id="7238235">n</span><span class="op" id="7238236">,</span>&nbsp;<span class="ident" id="7238238">err</span><span class="op" id="7238241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238244">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238248">childRunning</span>&nbsp;<span class="op" id="7238261">:=</span>&nbsp;<span class="keyword" id="7238264">func</span><span class="op" id="7238268">(</span><span class="op" id="7238269">)</span>&nbsp;<span class="builtintype" id="7238271">bool</span>&nbsp;<span class="op" id="7238276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238280">return</span>&nbsp;<span class="ident" id="7238287">isProcessRunning</span><span class="op" id="7238303">(</span><span class="ident" id="7238304">t</span><span class="op" id="7238305">,</span>&nbsp;<span class="ident" id="7238307">pid</span><span class="op" id="7238310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238317">if</span>&nbsp;<span class="op" id="7238320">!</span><span class="ident" id="7238321">childRunning</span><span class="op" id="7238333">(</span><span class="op" id="7238334">)</span>&nbsp;<span class="op" id="7238336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238340">t</span><span class="op" id="7238341">.</span><span class="ident" id="7238342">Fatalf</span><span class="op" id="7238348">(</span><span class="string" id="7238349">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="7238395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238401">conn</span><span class="op" id="7238405">.</span><span class="ident" id="7238406">Close</span><span class="op" id="7238411">(</span><span class="op" id="7238412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238416">tries</span>&nbsp;<span class="op" id="7238422">:=</span>&nbsp;<span class="num" id="7238425">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238428">for</span>&nbsp;<span class="ident" id="7238432">tries</span>&nbsp;<span class="op" id="7238438">&lt;</span>&nbsp;<span class="num" id="7238440">25</span>&nbsp;<span class="op" id="7238443">&amp;&amp;</span>&nbsp;<span class="ident" id="7238446">childRunning</span><span class="op" id="7238458">(</span><span class="op" id="7238459">)</span>&nbsp;<span class="op" id="7238461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238465">time</span><span class="op" id="7238469">.</span><span class="ident" id="7238470">Sleep</span><span class="op" id="7238475">(</span><span class="num" id="7238476">50</span>&nbsp;<span class="op" id="7238479">*</span>&nbsp;<span class="ident" id="7238481">time</span><span class="op" id="7238485">.</span><span class="ident" id="7238486">Millisecond</span>&nbsp;<span class="op" id="7238498">*</span>&nbsp;<span class="ident" id="7238500">time</span><span class="op" id="7238504">.</span><span class="ident" id="7238505">Duration</span><span class="op" id="7238513">(</span><span class="ident" id="7238514">tries</span><span class="op" id="7238519">)</span><span class="op" id="7238520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238524">tries</span><span class="op" id="7238529">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238533">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238536">if</span>&nbsp;<span class="ident" id="7238539">childRunning</span><span class="op" id="7238551">(</span><span class="op" id="7238552">)</span>&nbsp;<span class="op" id="7238554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238558">t</span><span class="op" id="7238559">.</span><span class="ident" id="7238560">Fatalf</span><span class="op" id="7238566">(</span><span class="string" id="7238567">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="7238611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238614">}</span><br>
<span class="lineno"></span><span class="op" id="7238616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="7238619">func</span>&nbsp;<span class="ident" id="7238624">TestDirUnix</span><span class="op" id="7238635">(</span><span class="ident" id="7238636">t</span>&nbsp;<span class="op" id="7238638">*</span><span class="ident" id="7238639">testing</span><span class="op" id="7238646">.</span><span class="ident" id="7238647">T</span><span class="op" id="7238648">)</span>&nbsp;<span class="op" id="7238650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238653">check</span><span class="op" id="7238658">(</span><span class="ident" id="7238659">t</span><span class="op" id="7238660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7238663">if</span>&nbsp;<span class="ident" id="7238666">runtime</span><span class="op" id="7238673">.</span><span class="ident" id="7238674">GOOS</span>&nbsp;<span class="op" id="7238679">==</span>&nbsp;<span class="string" id="7238682">&#34;windows&#34;</span>&nbsp;<span class="op" id="7238692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238696">t</span><span class="op" id="7238697">.</span><span class="ident" id="7238698">Skipf</span><span class="op" id="7238703">(</span><span class="string" id="7238704">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7238725">,</span>&nbsp;<span class="ident" id="7238727">runtime</span><span class="op" id="7238734">.</span><span class="ident" id="7238735">GOOS</span><span class="op" id="7238739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238742">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238745">cwd</span><span class="op" id="7238748">,</span>&nbsp;<span class="ident" id="7238750">_</span>&nbsp;<span class="op" id="7238752">:=</span>&nbsp;<span class="ident" id="7238755">os</span><span class="op" id="7238757">.</span><span class="ident" id="7238758">Getwd</span><span class="op" id="7238763">(</span><span class="op" id="7238764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238767">h</span>&nbsp;<span class="op" id="7238769">:=</span>&nbsp;<span class="op" id="7238772">&amp;</span><span class="ident" id="7238773">Handler</span><span class="op" id="7238780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238784">Path</span><span class="op" id="7238788">:</span>&nbsp;<span class="string" id="7238790">&#34;testdata/test.cgi&#34;</span><span class="op" id="7238809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238813">Root</span><span class="op" id="7238817">:</span>&nbsp;<span class="string" id="7238819">&#34;/test.cgi&#34;</span><span class="op" id="7238830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238834">Dir</span><span class="op" id="7238837">:</span>&nbsp;&nbsp;<span class="ident" id="7238840">cwd</span><span class="op" id="7238843">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238849">expectedMap</span>&nbsp;<span class="op" id="7238861">:=</span>&nbsp;<span class="keyword" id="7238864">map</span><span class="op" id="7238867">[</span><span class="builtintype" id="7238868">string</span><span class="op" id="7238874">]</span><span class="builtintype" id="7238875">string</span><span class="op" id="7238881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7238885">&#34;cwd&#34;</span><span class="op" id="7238890">:</span>&nbsp;<span class="ident" id="7238892">cwd</span><span class="op" id="7238895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7238898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238901">runCgiTest</span><span class="op" id="7238911">(</span><span class="ident" id="7238912">t</span><span class="op" id="7238913">,</span>&nbsp;<span class="ident" id="7238915">h</span><span class="op" id="7238916">,</span>&nbsp;<span class="string" id="7238918">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7238965">,</span>&nbsp;<span class="ident" id="7238967">expectedMap</span><span class="op" id="7238978">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7238982">cwd</span><span class="op" id="7238985">,</span>&nbsp;<span class="ident" id="7238987">_</span>&nbsp;<span class="op" id="7238989">=</span>&nbsp;<span class="ident" id="7238991">os</span><span class="op" id="7238993">.</span><span class="ident" id="7238994">Getwd</span><span class="op" id="7238999">(</span><span class="op" id="7239000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239003">cwd</span>&nbsp;<span class="op" id="7239007">=</span>&nbsp;<span class="ident" id="7239009">filepath</span><span class="op" id="7239017">.</span><span class="ident" id="7239018">Join</span><span class="op" id="7239022">(</span><span class="ident" id="7239023">cwd</span><span class="op" id="7239026">,</span>&nbsp;<span class="string" id="7239028">&#34;testdata&#34;</span><span class="op" id="7239038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239041">h</span>&nbsp;<span class="op" id="7239043">=</span>&nbsp;<span class="op" id="7239045">&amp;</span><span class="ident" id="7239046">Handler</span><span class="op" id="7239053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239057">Path</span><span class="op" id="7239061">:</span>&nbsp;<span class="string" id="7239063">&#34;testdata/test.cgi&#34;</span><span class="op" id="7239082">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239086">Root</span><span class="op" id="7239090">:</span>&nbsp;<span class="string" id="7239092">&#34;/test.cgi&#34;</span><span class="op" id="7239103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239109">expectedMap</span>&nbsp;<span class="op" id="7239121">=</span>&nbsp;<span class="keyword" id="7239123">map</span><span class="op" id="7239126">[</span><span class="builtintype" id="7239127">string</span><span class="op" id="7239133">]</span><span class="builtintype" id="7239134">string</span><span class="op" id="7239140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7239144">&#34;cwd&#34;</span><span class="op" id="7239149">:</span>&nbsp;<span class="ident" id="7239151">cwd</span><span class="op" id="7239154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239157">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239160">runCgiTest</span><span class="op" id="7239170">(</span><span class="ident" id="7239171">t</span><span class="op" id="7239172">,</span>&nbsp;<span class="ident" id="7239174">h</span><span class="op" id="7239175">,</span>&nbsp;<span class="string" id="7239177">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7239224">,</span>&nbsp;<span class="ident" id="7239226">expectedMap</span><span class="op" id="7239237">)</span><br>
<span class="lineno"></span><span class="op" id="7239239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7239242">func</span>&nbsp;<span class="ident" id="7239247">TestDirWindows</span><span class="op" id="7239261">(</span><span class="ident" id="7239262">t</span>&nbsp;<span class="op" id="7239264">*</span><span class="ident" id="7239265">testing</span><span class="op" id="7239272">.</span><span class="ident" id="7239273">T</span><span class="op" id="7239274">)</span>&nbsp;<span class="op" id="7239276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239279">if</span>&nbsp;<span class="ident" id="7239282">runtime</span><span class="op" id="7239289">.</span><span class="ident" id="7239290">GOOS</span>&nbsp;<span class="op" id="7239295">!=</span>&nbsp;<span class="string" id="7239298">&#34;windows&#34;</span>&nbsp;<span class="op" id="7239308">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239312">t</span><span class="op" id="7239313">.</span><span class="ident" id="7239314">Skip</span><span class="op" id="7239318">(</span><span class="string" id="7239319">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="7239352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239359">cgifile</span><span class="op" id="7239366">,</span>&nbsp;<span class="ident" id="7239368">_</span>&nbsp;<span class="op" id="7239370">:=</span>&nbsp;<span class="ident" id="7239373">filepath</span><span class="op" id="7239381">.</span><span class="ident" id="7239382">Abs</span><span class="op" id="7239385">(</span><span class="string" id="7239386">&#34;testdata/test.cgi&#34;</span><span class="op" id="7239405">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239409">var</span>&nbsp;<span class="ident" id="7239413">perl</span>&nbsp;<span class="builtintype" id="7239418">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239426">var</span>&nbsp;<span class="ident" id="7239430">err</span>&nbsp;<span class="builtintype" id="7239434">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239441">perl</span><span class="op" id="7239445">,</span>&nbsp;<span class="ident" id="7239447">err</span>&nbsp;<span class="op" id="7239451">=</span>&nbsp;<span class="ident" id="7239453">exec</span><span class="op" id="7239457">.</span><span class="ident" id="7239458">LookPath</span><span class="op" id="7239466">(</span><span class="string" id="7239467">&#34;perl&#34;</span><span class="op" id="7239473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239476">if</span>&nbsp;<span class="ident" id="7239479">err</span>&nbsp;<span class="op" id="7239483">!=</span>&nbsp;<span class="ident" id="7239486">nil</span>&nbsp;<span class="op" id="7239490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239494">t</span><span class="op" id="7239495">.</span><span class="ident" id="7239496">Skip</span><span class="op" id="7239500">(</span><span class="string" id="7239501">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7239533">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239539">perl</span><span class="op" id="7239543">,</span>&nbsp;<span class="ident" id="7239545">_</span>&nbsp;<span class="op" id="7239547">=</span>&nbsp;<span class="ident" id="7239549">filepath</span><span class="op" id="7239557">.</span><span class="ident" id="7239558">Abs</span><span class="op" id="7239561">(</span><span class="ident" id="7239562">perl</span><span class="op" id="7239566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239570">cwd</span><span class="op" id="7239573">,</span>&nbsp;<span class="ident" id="7239575">_</span>&nbsp;<span class="op" id="7239577">:=</span>&nbsp;<span class="ident" id="7239580">os</span><span class="op" id="7239582">.</span><span class="ident" id="7239583">Getwd</span><span class="op" id="7239588">(</span><span class="op" id="7239589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239592">h</span>&nbsp;<span class="op" id="7239594">:=</span>&nbsp;<span class="op" id="7239597">&amp;</span><span class="ident" id="7239598">Handler</span><span class="op" id="7239605">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239609">Path</span><span class="op" id="7239613">:</span>&nbsp;<span class="ident" id="7239615">perl</span><span class="op" id="7239619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239623">Root</span><span class="op" id="7239627">:</span>&nbsp;<span class="string" id="7239629">&#34;/test.cgi&#34;</span><span class="op" id="7239640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239644">Dir</span><span class="op" id="7239647">:</span>&nbsp;&nbsp;<span class="ident" id="7239650">cwd</span><span class="op" id="7239653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239657">Args</span><span class="op" id="7239661">:</span>&nbsp;<span class="op" id="7239663">[</span><span class="op" id="7239664">]</span><span class="builtintype" id="7239665">string</span><span class="op" id="7239671">{</span><span class="ident" id="7239672">cgifile</span><span class="op" id="7239679">}</span><span class="op" id="7239680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239684">Env</span><span class="op" id="7239687">:</span>&nbsp;&nbsp;<span class="op" id="7239690">[</span><span class="op" id="7239691">]</span><span class="builtintype" id="7239692">string</span><span class="op" id="7239698">{</span><span class="string" id="7239699">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7239718">+</span>&nbsp;<span class="ident" id="7239720">cgifile</span><span class="op" id="7239727">}</span><span class="op" id="7239728">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239734">expectedMap</span>&nbsp;<span class="op" id="7239746">:=</span>&nbsp;<span class="keyword" id="7239749">map</span><span class="op" id="7239752">[</span><span class="builtintype" id="7239753">string</span><span class="op" id="7239759">]</span><span class="builtintype" id="7239760">string</span><span class="op" id="7239766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7239770">&#34;cwd&#34;</span><span class="op" id="7239775">:</span>&nbsp;<span class="ident" id="7239777">cwd</span><span class="op" id="7239780">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7239783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239786">runCgiTest</span><span class="op" id="7239796">(</span><span class="ident" id="7239797">t</span><span class="op" id="7239798">,</span>&nbsp;<span class="ident" id="7239800">h</span><span class="op" id="7239801">,</span>&nbsp;<span class="string" id="7239803">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7239850">,</span>&nbsp;<span class="ident" id="7239852">expectedMap</span><span class="op" id="7239863">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7239867">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7239930">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7239958">cwd</span><span class="op" id="7239961">,</span>&nbsp;<span class="ident" id="7239963">_</span>&nbsp;<span class="op" id="7239965">=</span>&nbsp;<span class="ident" id="7239967">filepath</span><span class="op" id="7239975">.</span><span class="ident" id="7239976">Split</span><span class="op" id="7239981">(</span><span class="ident" id="7239982">perl</span><span class="op" id="7239986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7239989">if</span>&nbsp;<span class="ident" id="7239992">cwd</span>&nbsp;<span class="op" id="7239996">!=</span>&nbsp;<span class="string" id="7239999">&#34;&#34;</span>&nbsp;<span class="op" id="7240002">&amp;&amp;</span>&nbsp;<span class="ident" id="7240005">cwd</span><span class="op" id="7240008">[</span><span class="builtinfunc" id="7240009">len</span><span class="op" id="7240012">(</span><span class="ident" id="7240013">cwd</span><span class="op" id="7240016">)</span><span class="op" id="7240017">-</span><span class="num" id="7240018">1</span><span class="op" id="7240019">]</span>&nbsp;<span class="op" id="7240021">==</span>&nbsp;<span class="ident" id="7240024">filepath</span><span class="op" id="7240032">.</span><span class="ident" id="7240033">Separator</span>&nbsp;<span class="op" id="7240043">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240047">cwd</span>&nbsp;<span class="op" id="7240051">=</span>&nbsp;<span class="ident" id="7240053">cwd</span><span class="op" id="7240056">[</span><span class="op" id="7240057">:</span><span class="builtinfunc" id="7240058">len</span><span class="op" id="7240061">(</span><span class="ident" id="7240062">cwd</span><span class="op" id="7240065">)</span><span class="op" id="7240066">-</span><span class="num" id="7240067">1</span><span class="op" id="7240068">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240074">h</span>&nbsp;<span class="op" id="7240076">=</span>&nbsp;<span class="op" id="7240078">&amp;</span><span class="ident" id="7240079">Handler</span><span class="op" id="7240086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240090">Path</span><span class="op" id="7240094">:</span>&nbsp;<span class="ident" id="7240096">perl</span><span class="op" id="7240100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240104">Root</span><span class="op" id="7240108">:</span>&nbsp;<span class="string" id="7240110">&#34;/test.cgi&#34;</span><span class="op" id="7240121">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240125">Args</span><span class="op" id="7240129">:</span>&nbsp;<span class="op" id="7240131">[</span><span class="op" id="7240132">]</span><span class="builtintype" id="7240133">string</span><span class="op" id="7240139">{</span><span class="ident" id="7240140">cgifile</span><span class="op" id="7240147">}</span><span class="op" id="7240148">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240152">Env</span><span class="op" id="7240155">:</span>&nbsp;&nbsp;<span class="op" id="7240158">[</span><span class="op" id="7240159">]</span><span class="builtintype" id="7240160">string</span><span class="op" id="7240166">{</span><span class="string" id="7240167">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7240186">+</span>&nbsp;<span class="ident" id="7240188">cgifile</span><span class="op" id="7240195">}</span><span class="op" id="7240196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240202">expectedMap</span>&nbsp;<span class="op" id="7240214">=</span>&nbsp;<span class="keyword" id="7240216">map</span><span class="op" id="7240219">[</span><span class="builtintype" id="7240220">string</span><span class="op" id="7240226">]</span><span class="builtintype" id="7240227">string</span><span class="op" id="7240233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7240237">&#34;cwd&#34;</span><span class="op" id="7240242">:</span>&nbsp;<span class="ident" id="7240244">cwd</span><span class="op" id="7240247">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240253">runCgiTest</span><span class="op" id="7240263">(</span><span class="ident" id="7240264">t</span><span class="op" id="7240265">,</span>&nbsp;<span class="ident" id="7240267">h</span><span class="op" id="7240268">,</span>&nbsp;<span class="string" id="7240270">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7240317">,</span>&nbsp;<span class="ident" id="7240319">expectedMap</span><span class="op" id="7240330">)</span><br>
<span class="lineno"></span><span class="op" id="7240332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7240335">func</span>&nbsp;<span class="ident" id="7240340">TestEnvOverride</span><span class="op" id="7240355">(</span><span class="ident" id="7240356">t</span>&nbsp;<span class="op" id="7240358">*</span><span class="ident" id="7240359">testing</span><span class="op" id="7240366">.</span><span class="ident" id="7240367">T</span><span class="op" id="7240368">)</span>&nbsp;<span class="op" id="7240370">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240373">cgifile</span><span class="op" id="7240380">,</span>&nbsp;<span class="ident" id="7240382">_</span>&nbsp;<span class="op" id="7240384">:=</span>&nbsp;<span class="ident" id="7240387">filepath</span><span class="op" id="7240395">.</span><span class="ident" id="7240396">Abs</span><span class="op" id="7240399">(</span><span class="string" id="7240400">&#34;testdata/test.cgi&#34;</span><span class="op" id="7240419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240423">var</span>&nbsp;<span class="ident" id="7240427">perl</span>&nbsp;<span class="builtintype" id="7240432">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240440">var</span>&nbsp;<span class="ident" id="7240444">err</span>&nbsp;<span class="builtintype" id="7240448">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240455">perl</span><span class="op" id="7240459">,</span>&nbsp;<span class="ident" id="7240461">err</span>&nbsp;<span class="op" id="7240465">=</span>&nbsp;<span class="ident" id="7240467">exec</span><span class="op" id="7240471">.</span><span class="ident" id="7240472">LookPath</span><span class="op" id="7240480">(</span><span class="string" id="7240481">&#34;perl&#34;</span><span class="op" id="7240487">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7240490">if</span>&nbsp;<span class="ident" id="7240493">err</span>&nbsp;<span class="op" id="7240497">!=</span>&nbsp;<span class="ident" id="7240500">nil</span>&nbsp;<span class="op" id="7240504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240508">t</span><span class="op" id="7240509">.</span><span class="ident" id="7240510">Skipf</span><span class="op" id="7240515">(</span><span class="string" id="7240516">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7240548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240554">perl</span><span class="op" id="7240558">,</span>&nbsp;<span class="ident" id="7240560">_</span>&nbsp;<span class="op" id="7240562">=</span>&nbsp;<span class="ident" id="7240564">filepath</span><span class="op" id="7240572">.</span><span class="ident" id="7240573">Abs</span><span class="op" id="7240576">(</span><span class="ident" id="7240577">perl</span><span class="op" id="7240581">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240585">cwd</span><span class="op" id="7240588">,</span>&nbsp;<span class="ident" id="7240590">_</span>&nbsp;<span class="op" id="7240592">:=</span>&nbsp;<span class="ident" id="7240595">os</span><span class="op" id="7240597">.</span><span class="ident" id="7240598">Getwd</span><span class="op" id="7240603">(</span><span class="op" id="7240604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240607">h</span>&nbsp;<span class="op" id="7240609">:=</span>&nbsp;<span class="op" id="7240612">&amp;</span><span class="ident" id="7240613">Handler</span><span class="op" id="7240620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240624">Path</span><span class="op" id="7240628">:</span>&nbsp;<span class="ident" id="7240630">perl</span><span class="op" id="7240634">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240638">Root</span><span class="op" id="7240642">:</span>&nbsp;<span class="string" id="7240644">&#34;/test.cgi&#34;</span><span class="op" id="7240655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240659">Dir</span><span class="op" id="7240662">:</span>&nbsp;&nbsp;<span class="ident" id="7240665">cwd</span><span class="op" id="7240668">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240672">Args</span><span class="op" id="7240676">:</span>&nbsp;<span class="op" id="7240678">[</span><span class="op" id="7240679">]</span><span class="builtintype" id="7240680">string</span><span class="op" id="7240686">{</span><span class="ident" id="7240687">cgifile</span><span class="op" id="7240694">}</span><span class="op" id="7240695">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240699">Env</span><span class="op" id="7240702">:</span>&nbsp;<span class="op" id="7240704">[</span><span class="op" id="7240705">]</span><span class="builtintype" id="7240706">string</span><span class="op" id="7240712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7240717">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7240736">+</span>&nbsp;<span class="ident" id="7240738">cgifile</span><span class="op" id="7240745">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7240750">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="7240772">}</span><span class="op" id="7240773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240776">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240779">expectedMap</span>&nbsp;<span class="op" id="7240791">:=</span>&nbsp;<span class="keyword" id="7240794">map</span><span class="op" id="7240797">[</span><span class="builtintype" id="7240798">string</span><span class="op" id="7240804">]</span><span class="builtintype" id="7240805">string</span><span class="op" id="7240811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7240815">&#34;cwd&#34;</span><span class="op" id="7240820">:</span>&nbsp;<span class="ident" id="7240822">cwd</span><span class="op" id="7240825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7240829">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7240850">:</span>&nbsp;<span class="ident" id="7240852">cgifile</span><span class="op" id="7240859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7240863">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7240880">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7240886">&#34;/foo/bar&#34;</span><span class="op" id="7240896">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7240899">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7240902">runCgiTest</span><span class="op" id="7240912">(</span><span class="ident" id="7240913">t</span><span class="op" id="7240914">,</span>&nbsp;<span class="ident" id="7240916">h</span><span class="op" id="7240917">,</span>&nbsp;<span class="string" id="7240919">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7240966">,</span>&nbsp;<span class="ident" id="7240968">expectedMap</span><span class="op" id="7240979">)</span><br>
<span class="lineno"></span><span class="op" id="7240981">}</span>
</div>
</body>
</html>
