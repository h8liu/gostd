<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6124869">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6124924">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6124978">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6125029">package</span>&nbsp;<span class="ident" id="6125037">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6125043">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6125117">import</span>&nbsp;<span class="op" id="6125124">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125127">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125137">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125144">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125150">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125163">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125170">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125182">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125198">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125204">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125215">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6125223">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6125230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6125233">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6125314">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6125352">type</span>&nbsp;<span class="ident" id="6125357">request</span>&nbsp;<span class="keyword" id="6125365">struct</span>&nbsp;<span class="op" id="6125372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125375">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125385">*</span><span class="ident" id="6125386"><a href="/net/http/fcgi/child.go.html#6125144">io</a></span><span class="op" id="6125388">.</span><span class="ident" id="6125389">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125401">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6125411">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125419">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125429">map</span><span class="op" id="6125432">[</span><span class="builtintype" id="6125433">string</span><span class="op" id="6125439">]</span><span class="builtintype" id="6125440">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125448">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6125458">[</span><span class="num" id="6125459">1024</span><span class="op" id="6125463">]</span><span class="builtintype" id="6125464">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125470">rawParams</span>&nbsp;<span class="op" id="6125480">[</span><span class="op" id="6125481">]</span><span class="builtintype" id="6125482">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125488">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6125498">bool</span><br>
<span class="lineno"></span><span class="op" id="6125503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6125506">func</span>&nbsp;<span class="ident" id="6125511">newRequest</span><span class="op" id="6125521">(</span><span class="ident" id="6125522">reqId</span>&nbsp;<span class="builtintype" id="6125528">uint16</span><span class="op" id="6125534">,</span>&nbsp;<span class="ident" id="6125536">flags</span>&nbsp;<span class="builtintype" id="6125542">uint8</span><span class="op" id="6125547">)</span>&nbsp;<span class="op" id="6125549">*</span><span class="ident" id="6125550"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span>&nbsp;<span class="op" id="6125558">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125561">r</span>&nbsp;<span class="op" id="6125563">:=</span>&nbsp;<span class="op" id="6125566">&amp;</span><span class="ident" id="6125567"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span><span class="op" id="6125574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125578">reqId</span><span class="op" id="6125583">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6125588"><a href="/net/http/fcgi/child.go.html#6125522">reqId</a></span><span class="op" id="6125593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125597">params</span><span class="op" id="6125603">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6125607">map</span><span class="op" id="6125610">[</span><span class="builtintype" id="6125611">string</span><span class="op" id="6125617">]</span><span class="builtintype" id="6125618">string</span><span class="op" id="6125624">{</span><span class="op" id="6125625">}</span><span class="op" id="6125626">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125630">keepConn</span><span class="op" id="6125638">:</span>&nbsp;<span class="ident" id="6125640"><a href="/net/http/fcgi/child.go.html#6125536">flags</a></span><span class="op" id="6125645">&amp;</span><span class="ident" id="6125646"><a href="/net/http/fcgi/fcgi.go.html#6133142">flagKeepConn</a></span>&nbsp;<span class="op" id="6125659">!=</span>&nbsp;<span class="num" id="6125662">0</span><span class="op" id="6125663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125666">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125669"><a href="/net/http/fcgi/child.go.html#6125561">r</a></span><span class="op" id="6125670">.</span><span class="ident" id="6125671">rawParams</span>&nbsp;<span class="op" id="6125681">=</span>&nbsp;<span class="ident" id="6125683"><a href="/net/http/fcgi/child.go.html#6125561">r</a></span><span class="op" id="6125684">.</span><span class="ident" id="6125685">buf</span><span class="op" id="6125688">[</span><span class="op" id="6125689">:</span><span class="num" id="6125690">0</span><span class="op" id="6125691">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125694">return</span>&nbsp;<span class="ident" id="6125701"><a href="/net/http/fcgi/child.go.html#6125561">r</a></span><br>
<span class="lineno"></span><span class="op" id="6125703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6125706">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6125758">func</span>&nbsp;<span class="op" id="6125763">(</span><span class="ident" id="6125764">r</span>&nbsp;<span class="op" id="6125766">*</span><span class="ident" id="6125767"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span><span class="op" id="6125774">)</span>&nbsp;<span class="ident" id="6125776">parseParams</span><span class="op" id="6125787">(</span><span class="op" id="6125788">)</span>&nbsp;<span class="op" id="6125790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125793">text</span>&nbsp;<span class="op" id="6125798">:=</span>&nbsp;<span class="ident" id="6125801"><a href="/net/http/fcgi/child.go.html#6125764">r</a></span><span class="op" id="6125802">.</span><span class="ident" id="6125803">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125814"><a href="/net/http/fcgi/child.go.html#6125764">r</a></span><span class="op" id="6125815">.</span><span class="ident" id="6125816">rawParams</span>&nbsp;<span class="op" id="6125826">=</span>&nbsp;<span class="ident" id="6125828">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125833">for</span>&nbsp;<span class="builtinfunc" id="6125837">len</span><span class="op" id="6125840">(</span><span class="ident" id="6125841"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6125845">)</span>&nbsp;<span class="op" id="6125847">&gt;</span>&nbsp;<span class="num" id="6125849">0</span>&nbsp;<span class="op" id="6125851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125855">keyLen</span><span class="op" id="6125861">,</span>&nbsp;<span class="ident" id="6125863">n</span>&nbsp;<span class="op" id="6125865">:=</span>&nbsp;<span class="ident" id="6125868"><a href="/net/http/fcgi/fcgi.go.html#6136464">readSize</a></span><span class="op" id="6125876">(</span><span class="ident" id="6125877"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6125881">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125885">if</span>&nbsp;<span class="ident" id="6125888"><a href="/net/http/fcgi/child.go.html#6125863">n</a></span>&nbsp;<span class="op" id="6125890">==</span>&nbsp;<span class="num" id="6125893">0</span>&nbsp;<span class="op" id="6125895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125900">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125913"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span>&nbsp;<span class="op" id="6125918">=</span>&nbsp;<span class="ident" id="6125920"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6125924">[</span><span class="ident" id="6125925"><a href="/net/http/fcgi/child.go.html#6125863">n</a></span><span class="op" id="6125926">:</span><span class="op" id="6125927">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125931">valLen</span><span class="op" id="6125937">,</span>&nbsp;<span class="ident" id="6125939"><a href="/net/http/fcgi/child.go.html#6125863">n</a></span>&nbsp;<span class="op" id="6125941">:=</span>&nbsp;<span class="ident" id="6125944"><a href="/net/http/fcgi/fcgi.go.html#6136464">readSize</a></span><span class="op" id="6125952">(</span><span class="ident" id="6125953"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6125957">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125961">if</span>&nbsp;<span class="ident" id="6125964"><a href="/net/http/fcgi/child.go.html#6125863">n</a></span>&nbsp;<span class="op" id="6125966">==</span>&nbsp;<span class="num" id="6125969">0</span>&nbsp;<span class="op" id="6125971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125976">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125989"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span>&nbsp;<span class="op" id="6125994">=</span>&nbsp;<span class="ident" id="6125996"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6126000">[</span><span class="ident" id="6126001"><a href="/net/http/fcgi/child.go.html#6125863">n</a></span><span class="op" id="6126002">:</span><span class="op" id="6126003">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126007">key</span>&nbsp;<span class="op" id="6126011">:=</span>&nbsp;<span class="ident" id="6126014"><a href="/net/http/fcgi/fcgi.go.html#6136712">readString</a></span><span class="op" id="6126024">(</span><span class="ident" id="6126025"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6126029">,</span>&nbsp;<span class="ident" id="6126031"><a href="/net/http/fcgi/child.go.html#6125855">keyLen</a></span><span class="op" id="6126037">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126041"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span>&nbsp;<span class="op" id="6126046">=</span>&nbsp;<span class="ident" id="6126048"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6126052">[</span><span class="ident" id="6126053"><a href="/net/http/fcgi/child.go.html#6125855">keyLen</a></span><span class="op" id="6126059">:</span><span class="op" id="6126060">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126064">val</span>&nbsp;<span class="op" id="6126068">:=</span>&nbsp;<span class="ident" id="6126071"><a href="/net/http/fcgi/fcgi.go.html#6136712">readString</a></span><span class="op" id="6126081">(</span><span class="ident" id="6126082"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6126086">,</span>&nbsp;<span class="ident" id="6126088"><a href="/net/http/fcgi/child.go.html#6125931">valLen</a></span><span class="op" id="6126094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126098"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span>&nbsp;<span class="op" id="6126103">=</span>&nbsp;<span class="ident" id="6126105"><a href="/net/http/fcgi/child.go.html#6125793">text</a></span><span class="op" id="6126109">[</span><span class="ident" id="6126110"><a href="/net/http/fcgi/child.go.html#6125931">valLen</a></span><span class="op" id="6126116">:</span><span class="op" id="6126117">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126121"><a href="/net/http/fcgi/child.go.html#6125764">r</a></span><span class="op" id="6126122">.</span><span class="ident" id="6126123">params</span><span class="op" id="6126129">[</span><span class="ident" id="6126130"><a href="/net/http/fcgi/child.go.html#6126007">key</a></span><span class="op" id="6126133">]</span>&nbsp;<span class="op" id="6126135">=</span>&nbsp;<span class="ident" id="6126137"><a href="/net/http/fcgi/child.go.html#6126064">val</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126142">}</span><br>
<span class="lineno">65</span><span class="op" id="6126144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6126147">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6126191">type</span>&nbsp;<span class="ident" id="6126196">response</span>&nbsp;<span class="keyword" id="6126205">struct</span>&nbsp;<span class="op" id="6126212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126215">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6126227">*</span><span class="ident" id="6126228"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126237">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126249"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6126253">.</span><span class="ident" id="6126254">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126262">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6126274">*</span><span class="ident" id="6126275"><a href="/net/http/fcgi/fcgi.go.html#6137088">bufWriter</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126286">wroteHeader</span>&nbsp;<span class="builtintype" id="6126298">bool</span><br>
<span class="lineno"></span><span class="op" id="6126303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6126306">func</span>&nbsp;<span class="ident" id="6126311">newResponse</span><span class="op" id="6126322">(</span><span class="ident" id="6126323">c</span>&nbsp;<span class="op" id="6126325">*</span><span class="ident" id="6126326"><a href="/net/http/fcgi/child.go.html#6127436">child</a></span><span class="op" id="6126331">,</span>&nbsp;<span class="ident" id="6126333">req</span>&nbsp;<span class="op" id="6126337">*</span><span class="ident" id="6126338"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span><span class="op" id="6126345">)</span>&nbsp;<span class="op" id="6126347">*</span><span class="ident" id="6126348"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span>&nbsp;<span class="op" id="6126357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126360">return</span>&nbsp;<span class="op" id="6126367">&amp;</span><span class="ident" id="6126368"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span><span class="op" id="6126376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126380">req</span><span class="op" id="6126383">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126388"><a href="/net/http/fcgi/child.go.html#6126333">req</a></span><span class="op" id="6126391">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126395">header</span><span class="op" id="6126401">:</span>&nbsp;<span class="ident" id="6126403"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6126407">.</span><span class="ident" id="6126408">Header</span><span class="op" id="6126414">{</span><span class="op" id="6126415">}</span><span class="op" id="6126416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126420">w</span><span class="op" id="6126421">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6126428"><a href="/net/http/fcgi/fcgi.go.html#6137289">newWriter</a></span><span class="op" id="6126437">(</span><span class="ident" id="6126438"><a href="/net/http/fcgi/child.go.html#6126323">c</a></span><span class="op" id="6126439">.</span><span class="ident" id="6126440">conn</span><span class="op" id="6126444">,</span>&nbsp;<span class="ident" id="6126446"><a href="/net/http/fcgi/fcgi.go.html#6132859">typeStdout</a></span><span class="op" id="6126456">,</span>&nbsp;<span class="ident" id="6126458"><a href="/net/http/fcgi/child.go.html#6126333">req</a></span><span class="op" id="6126461">.</span><span class="ident" id="6126462">reqId</span><span class="op" id="6126467">)</span><span class="op" id="6126468">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126471">}</span><br>
<span class="lineno"></span><span class="op" id="6126473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6126476">func</span>&nbsp;<span class="op" id="6126481">(</span><span class="ident" id="6126482">r</span>&nbsp;<span class="op" id="6126484">*</span><span class="ident" id="6126485"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span><span class="op" id="6126493">)</span>&nbsp;<span class="ident" id="6126495">Header</span><span class="op" id="6126501">(</span><span class="op" id="6126502">)</span>&nbsp;<span class="ident" id="6126504"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6126508">.</span><span class="ident" id="6126509">Header</span>&nbsp;<span class="op" id="6126516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126519">return</span>&nbsp;<span class="ident" id="6126526"><a href="/net/http/fcgi/child.go.html#6126482">r</a></span><span class="op" id="6126527">.</span><span class="ident" id="6126528">header</span><br>
<span class="lineno">85</span><span class="op" id="6126535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6126538">func</span>&nbsp;<span class="op" id="6126543">(</span><span class="ident" id="6126544">r</span>&nbsp;<span class="op" id="6126546">*</span><span class="ident" id="6126547"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span><span class="op" id="6126555">)</span>&nbsp;<span class="ident" id="6126557">Write</span><span class="op" id="6126562">(</span><span class="ident" id="6126563">data</span>&nbsp;<span class="op" id="6126568">[</span><span class="op" id="6126569">]</span><span class="builtintype" id="6126570">byte</span><span class="op" id="6126574">)</span>&nbsp;<span class="op" id="6126576">(</span><span class="builtintype" id="6126577">int</span><span class="op" id="6126580">,</span>&nbsp;<span class="builtintype" id="6126582">error</span><span class="op" id="6126587">)</span>&nbsp;<span class="op" id="6126589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126592">if</span>&nbsp;<span class="op" id="6126595">!</span><span class="ident" id="6126596"><a href="/net/http/fcgi/child.go.html#6126544">r</a></span><span class="op" id="6126597">.</span><span class="ident" id="6126598">wroteHeader</span>&nbsp;<span class="op" id="6126610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126614"><a href="/net/http/fcgi/child.go.html#6126544">r</a></span><span class="op" id="6126615">.</span><span class="ident" id="6126616">WriteHeader</span><span class="op" id="6126627">(</span><span class="ident" id="6126628"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6126632">.</span><span class="ident" id="6126633">StatusOK</span><span class="op" id="6126641">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126647">return</span>&nbsp;<span class="ident" id="6126654"><a href="/net/http/fcgi/child.go.html#6126544">r</a></span><span class="op" id="6126655">.</span><span class="ident" id="6126656">w</span><span class="op" id="6126657">.</span><span class="ident" id="6126658">Write</span><span class="op" id="6126663">(</span><span class="ident" id="6126664"><a href="/net/http/fcgi/child.go.html#6126563">data</a></span><span class="op" id="6126668">)</span><br>
<span class="lineno"></span><span class="op" id="6126670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6126673">func</span>&nbsp;<span class="op" id="6126678">(</span><span class="ident" id="6126679">r</span>&nbsp;<span class="op" id="6126681">*</span><span class="ident" id="6126682"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span><span class="op" id="6126690">)</span>&nbsp;<span class="ident" id="6126692">WriteHeader</span><span class="op" id="6126703">(</span><span class="ident" id="6126704">code</span>&nbsp;<span class="builtintype" id="6126709">int</span><span class="op" id="6126712">)</span>&nbsp;<span class="op" id="6126714">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126717">if</span>&nbsp;<span class="ident" id="6126720"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126721">.</span><span class="ident" id="6126722">wroteHeader</span>&nbsp;<span class="op" id="6126734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126738">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126749"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126750">.</span><span class="ident" id="6126751">wroteHeader</span>&nbsp;<span class="op" id="6126763">=</span>&nbsp;<span class="builtintype" id="6126765">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126771">if</span>&nbsp;<span class="ident" id="6126774"><a href="/net/http/fcgi/child.go.html#6126704">code</a></span>&nbsp;<span class="op" id="6126779">==</span>&nbsp;<span class="ident" id="6126782"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6126786">.</span><span class="ident" id="6126787">StatusNotModified</span>&nbsp;<span class="op" id="6126805">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6126809">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126834"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126835">.</span><span class="ident" id="6126836">header</span><span class="op" id="6126842">.</span><span class="ident" id="6126843">Del</span><span class="op" id="6126846">(</span><span class="string" id="6126847">&#34;Content-Type&#34;</span><span class="op" id="6126861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126865"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126866">.</span><span class="ident" id="6126867">header</span><span class="op" id="6126873">.</span><span class="ident" id="6126874">Del</span><span class="op" id="6126877">(</span><span class="string" id="6126878">&#34;Content-Length&#34;</span><span class="op" id="6126894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126898"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126899">.</span><span class="ident" id="6126900">header</span><span class="op" id="6126906">.</span><span class="ident" id="6126907">Del</span><span class="op" id="6126910">(</span><span class="string" id="6126911">&#34;Transfer-Encoding&#34;</span><span class="op" id="6126930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126933">}</span>&nbsp;<span class="keyword" id="6126935">else</span>&nbsp;<span class="keyword" id="6126940">if</span>&nbsp;<span class="ident" id="6126943"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126944">.</span><span class="ident" id="6126945">header</span><span class="op" id="6126951">.</span><span class="ident" id="6126952">Get</span><span class="op" id="6126955">(</span><span class="string" id="6126956">&#34;Content-Type&#34;</span><span class="op" id="6126970">)</span>&nbsp;<span class="op" id="6126972">==</span>&nbsp;<span class="string" id="6126975">&#34;&#34;</span>&nbsp;<span class="op" id="6126978">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126982"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6126983">.</span><span class="ident" id="6126984">header</span><span class="op" id="6126990">.</span><span class="ident" id="6126991">Set</span><span class="op" id="6126994">(</span><span class="string" id="6126995">&#34;Content-Type&#34;</span><span class="op" id="6127009">,</span>&nbsp;<span class="string" id="6127011">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6127037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127044">if</span>&nbsp;<span class="ident" id="6127047"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6127048">.</span><span class="ident" id="6127049">header</span><span class="op" id="6127055">.</span><span class="ident" id="6127056">Get</span><span class="op" id="6127059">(</span><span class="string" id="6127060">&#34;Date&#34;</span><span class="op" id="6127066">)</span>&nbsp;<span class="op" id="6127068">==</span>&nbsp;<span class="string" id="6127071">&#34;&#34;</span>&nbsp;<span class="op" id="6127074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127078"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6127079">.</span><span class="ident" id="6127080">header</span><span class="op" id="6127086">.</span><span class="ident" id="6127087">Set</span><span class="op" id="6127090">(</span><span class="string" id="6127091">&#34;Date&#34;</span><span class="op" id="6127097">,</span>&nbsp;<span class="ident" id="6127099"><a href="/net/http/fcgi/child.go.html#6125223">time</a></span><span class="op" id="6127103">.</span><span class="ident" id="6127104">Now</span><span class="op" id="6127107">(</span><span class="op" id="6127108">)</span><span class="op" id="6127109">.</span><span class="ident" id="6127110">UTC</span><span class="op" id="6127113">(</span><span class="op" id="6127114">)</span><span class="op" id="6127115">.</span><span class="ident" id="6127116">Format</span><span class="op" id="6127122">(</span><span class="ident" id="6127123"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6127127">.</span><span class="ident" id="6127128">TimeFormat</span><span class="op" id="6127138">)</span><span class="op" id="6127139">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127146"><a href="/net/http/fcgi/child.go.html#6125137">fmt</a></span><span class="op" id="6127149">.</span><span class="ident" id="6127150">Fprintf</span><span class="op" id="6127157">(</span><span class="ident" id="6127158"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6127159">.</span><span class="ident" id="6127160">w</span><span class="op" id="6127161">,</span>&nbsp;<span class="string" id="6127163">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6127182">,</span>&nbsp;<span class="ident" id="6127184"><a href="/net/http/fcgi/child.go.html#6126704">code</a></span><span class="op" id="6127188">,</span>&nbsp;<span class="ident" id="6127190"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6127194">.</span><span class="ident" id="6127195">StatusText</span><span class="op" id="6127205">(</span><span class="ident" id="6127206"><a href="/net/http/fcgi/child.go.html#6126704">code</a></span><span class="op" id="6127210">)</span><span class="op" id="6127211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127214"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6127215">.</span><span class="ident" id="6127216">header</span><span class="op" id="6127222">.</span><span class="ident" id="6127223">Write</span><span class="op" id="6127228">(</span><span class="ident" id="6127229"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6127230">.</span><span class="ident" id="6127231">w</span><span class="op" id="6127232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127235"><a href="/net/http/fcgi/child.go.html#6126679">r</a></span><span class="op" id="6127236">.</span><span class="ident" id="6127237">w</span><span class="op" id="6127238">.</span><span class="ident" id="6127239">WriteString</span><span class="op" id="6127250">(</span><span class="string" id="6127251">&#34;\r\n&#34;</span><span class="op" id="6127257">)</span><br>
<span class="lineno">115</span><span class="op" id="6127259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6127262">func</span>&nbsp;<span class="op" id="6127267">(</span><span class="ident" id="6127268">r</span>&nbsp;<span class="op" id="6127270">*</span><span class="ident" id="6127271"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span><span class="op" id="6127279">)</span>&nbsp;<span class="ident" id="6127281">Flush</span><span class="op" id="6127286">(</span><span class="op" id="6127287">)</span>&nbsp;<span class="op" id="6127289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127292">if</span>&nbsp;<span class="op" id="6127295">!</span><span class="ident" id="6127296"><a href="/net/http/fcgi/child.go.html#6127268">r</a></span><span class="op" id="6127297">.</span><span class="ident" id="6127298">wroteHeader</span>&nbsp;<span class="op" id="6127310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127314"><a href="/net/http/fcgi/child.go.html#6127268">r</a></span><span class="op" id="6127315">.</span><span class="ident" id="6127316">WriteHeader</span><span class="op" id="6127327">(</span><span class="ident" id="6127328"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6127332">.</span><span class="ident" id="6127333">StatusOK</span><span class="op" id="6127341">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127347"><a href="/net/http/fcgi/child.go.html#6127268">r</a></span><span class="op" id="6127348">.</span><span class="ident" id="6127349">w</span><span class="op" id="6127350">.</span><span class="ident" id="6127351">Flush</span><span class="op" id="6127356">(</span><span class="op" id="6127357">)</span><br>
<span class="lineno"></span><span class="op" id="6127359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6127362">func</span>&nbsp;<span class="op" id="6127367">(</span><span class="ident" id="6127368">r</span>&nbsp;<span class="op" id="6127370">*</span><span class="ident" id="6127371"><a href="/net/http/fcgi/child.go.html#6126196">response</a></span><span class="op" id="6127379">)</span>&nbsp;<span class="ident" id="6127381">Close</span><span class="op" id="6127386">(</span><span class="op" id="6127387">)</span>&nbsp;<span class="builtintype" id="6127389">error</span>&nbsp;<span class="op" id="6127395">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127398"><a href="/net/http/fcgi/child.go.html#6127368">r</a></span><span class="op" id="6127399">.</span><span class="ident" id="6127400">Flush</span><span class="op" id="6127405">(</span><span class="op" id="6127406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127409">return</span>&nbsp;<span class="ident" id="6127416"><a href="/net/http/fcgi/child.go.html#6127368">r</a></span><span class="op" id="6127417">.</span><span class="ident" id="6127418">w</span><span class="op" id="6127419">.</span><span class="ident" id="6127420">Close</span><span class="op" id="6127425">(</span><span class="op" id="6127426">)</span><br>
<span class="lineno"></span><span class="op" id="6127428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6127431">type</span>&nbsp;<span class="ident" id="6127436">child</span>&nbsp;<span class="keyword" id="6127442">struct</span>&nbsp;<span class="op" id="6127449">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127452">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6127460">*</span><span class="ident" id="6127461"><a href="/net/http/fcgi/fcgi.go.html#6134294">conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127467">handler</span>&nbsp;<span class="ident" id="6127475"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6127479">.</span><span class="ident" id="6127480">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127490">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127499"><a href="/net/http/fcgi/child.go.html#6125215">sync</a></span><span class="op" id="6127503">.</span><span class="ident" id="6127504">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6127519">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127542">requests</span>&nbsp;<span class="keyword" id="6127551">map</span><span class="op" id="6127554">[</span><span class="builtintype" id="6127555">uint16</span><span class="op" id="6127561">]</span><span class="op" id="6127562">*</span><span class="ident" id="6127563"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span>&nbsp;<span class="comment" id="6127571">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6127594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6127597">func</span>&nbsp;<span class="ident" id="6127602">newChild</span><span class="op" id="6127610">(</span><span class="ident" id="6127611">rwc</span>&nbsp;<span class="ident" id="6127615"><a href="/net/http/fcgi/child.go.html#6125144">io</a></span><span class="op" id="6127617">.</span><span class="ident" id="6127618">ReadWriteCloser</span><span class="op" id="6127633">,</span>&nbsp;<span class="ident" id="6127635">handler</span>&nbsp;<span class="ident" id="6127643"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6127647">.</span><span class="ident" id="6127648">Handler</span><span class="op" id="6127655">)</span>&nbsp;<span class="op" id="6127657">*</span><span class="ident" id="6127658"><a href="/net/http/fcgi/child.go.html#6127436">child</a></span>&nbsp;<span class="op" id="6127664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127667">return</span>&nbsp;<span class="op" id="6127674">&amp;</span><span class="ident" id="6127675"><a href="/net/http/fcgi/child.go.html#6127436">child</a></span><span class="op" id="6127680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127684">conn</span><span class="op" id="6127688">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6127694"><a href="/net/http/fcgi/fcgi.go.html#6134416">newConn</a></span><span class="op" id="6127701">(</span><span class="ident" id="6127702"><a href="/net/http/fcgi/child.go.html#6127611">rwc</a></span><span class="op" id="6127705">)</span><span class="op" id="6127706">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127710">handler</span><span class="op" id="6127717">:</span>&nbsp;&nbsp;<span class="ident" id="6127720"><a href="/net/http/fcgi/child.go.html#6127635">handler</a></span><span class="op" id="6127727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127731">requests</span><span class="op" id="6127739">:</span>&nbsp;<span class="builtinfunc" id="6127741">make</span><span class="op" id="6127745">(</span><span class="keyword" id="6127746">map</span><span class="op" id="6127749">[</span><span class="builtintype" id="6127750">uint16</span><span class="op" id="6127756">]</span><span class="op" id="6127757">*</span><span class="ident" id="6127758"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span><span class="op" id="6127765">)</span><span class="op" id="6127766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127769">}</span><br>
<span class="lineno"></span><span class="op" id="6127771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6127774">func</span>&nbsp;<span class="op" id="6127779">(</span><span class="ident" id="6127780">c</span>&nbsp;<span class="op" id="6127782">*</span><span class="ident" id="6127783"><a href="/net/http/fcgi/child.go.html#6127436">child</a></span><span class="op" id="6127788">)</span>&nbsp;<span class="ident" id="6127790">serve</span><span class="op" id="6127795">(</span><span class="op" id="6127796">)</span>&nbsp;<span class="op" id="6127798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127801">defer</span>&nbsp;<span class="ident" id="6127807"><a href="/net/http/fcgi/child.go.html#6127780">c</a></span><span class="op" id="6127808">.</span><span class="ident" id="6127809">conn</span><span class="op" id="6127813">.</span><span class="ident" id="6127814">Close</span><span class="op" id="6127819">(</span><span class="op" id="6127820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127823">var</span>&nbsp;<span class="ident" id="6127827">rec</span>&nbsp;<span class="ident" id="6127831"><a href="/net/http/fcgi/fcgi.go.html#6134584">record</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127839">for</span>&nbsp;<span class="op" id="6127843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127847">if</span>&nbsp;<span class="ident" id="6127850">err</span>&nbsp;<span class="op" id="6127854">:=</span>&nbsp;<span class="ident" id="6127857"><a href="/net/http/fcgi/child.go.html#6127827">rec</a></span><span class="op" id="6127860">.</span><span class="ident" id="6127861">read</span><span class="op" id="6127865">(</span><span class="ident" id="6127866"><a href="/net/http/fcgi/child.go.html#6127780">c</a></span><span class="op" id="6127867">.</span><span class="ident" id="6127868">conn</span><span class="op" id="6127872">.</span><span class="ident" id="6127873">rwc</span><span class="op" id="6127876">)</span><span class="op" id="6127877">;</span>&nbsp;<span class="ident" id="6127879"><a href="/net/http/fcgi/child.go.html#6127850">err</a></span>&nbsp;<span class="op" id="6127883">!=</span>&nbsp;<span class="ident" id="6127886">nil</span>&nbsp;<span class="op" id="6127890">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127895">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127908">if</span>&nbsp;<span class="ident" id="6127911">err</span>&nbsp;<span class="op" id="6127915">:=</span>&nbsp;<span class="ident" id="6127918"><a href="/net/http/fcgi/child.go.html#6127780">c</a></span><span class="op" id="6127919">.</span><span class="ident" id="6127920">handleRecord</span><span class="op" id="6127932">(</span><span class="op" id="6127933">&amp;</span><span class="ident" id="6127934"><a href="/net/http/fcgi/child.go.html#6127827">rec</a></span><span class="op" id="6127937">)</span><span class="op" id="6127938">;</span>&nbsp;<span class="ident" id="6127940"><a href="/net/http/fcgi/child.go.html#6127911">err</a></span>&nbsp;<span class="op" id="6127944">!=</span>&nbsp;<span class="ident" id="6127947">nil</span>&nbsp;<span class="op" id="6127951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127956">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127965">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127968">}</span><br>
<span class="lineno"></span><span class="op" id="6127970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6127973">var</span>&nbsp;<span class="ident" id="6127977">errCloseConn</span>&nbsp;<span class="op" id="6127990">=</span>&nbsp;<span class="ident" id="6127992"><a href="/net/http/fcgi/child.go.html#6125127">errors</a></span><span class="op" id="6127998">.</span><span class="ident" id="6127999">New</span><span class="op" id="6128002">(</span><span class="string" id="6128003">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6128038">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6128041">var</span>&nbsp;<span class="ident" id="6128045">emptyBody</span>&nbsp;<span class="op" id="6128055">=</span>&nbsp;<span class="ident" id="6128057"><a href="/net/http/fcgi/child.go.html#6125150">ioutil</a></span><span class="op" id="6128063">.</span><span class="ident" id="6128064">NopCloser</span><span class="op" id="6128073">(</span><span class="ident" id="6128074"><a href="/net/http/fcgi/child.go.html#6125204">strings</a></span><span class="op" id="6128081">.</span><span class="ident" id="6128082">NewReader</span><span class="op" id="6128091">(</span><span class="string" id="6128092">&#34;&#34;</span><span class="op" id="6128094">)</span><span class="op" id="6128095">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6128098">func</span>&nbsp;<span class="op" id="6128103">(</span><span class="ident" id="6128104">c</span>&nbsp;<span class="op" id="6128106">*</span><span class="ident" id="6128107"><a href="/net/http/fcgi/child.go.html#6127436">child</a></span><span class="op" id="6128112">)</span>&nbsp;<span class="ident" id="6128114">handleRecord</span><span class="op" id="6128126">(</span><span class="ident" id="6128127">rec</span>&nbsp;<span class="op" id="6128131">*</span><span class="ident" id="6128132"><a href="/net/http/fcgi/fcgi.go.html#6134584">record</a></span><span class="op" id="6128138">)</span>&nbsp;<span class="builtintype" id="6128140">error</span>&nbsp;<span class="op" id="6128146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128149"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128150">.</span><span class="ident" id="6128151">mu</span><span class="op" id="6128153">.</span><span class="ident" id="6128154">Lock</span><span class="op" id="6128158">(</span><span class="op" id="6128159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128162">req</span><span class="op" id="6128165">,</span>&nbsp;<span class="ident" id="6128167">ok</span>&nbsp;<span class="op" id="6128170">:=</span>&nbsp;<span class="ident" id="6128173"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128174">.</span><span class="ident" id="6128175">requests</span><span class="op" id="6128183">[</span><span class="ident" id="6128184"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128187">.</span><span class="ident" id="6128188">h</span><span class="op" id="6128189">.</span><span class="ident" id="6128190">Id</span><span class="op" id="6128192">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128195"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128196">.</span><span class="ident" id="6128197">mu</span><span class="op" id="6128199">.</span><span class="ident" id="6128200">Unlock</span><span class="op" id="6128206">(</span><span class="op" id="6128207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128210">if</span>&nbsp;<span class="op" id="6128213">!</span><span class="ident" id="6128214"><a href="/net/http/fcgi/child.go.html#6128167">ok</a></span>&nbsp;<span class="op" id="6128217">&amp;&amp;</span>&nbsp;<span class="ident" id="6128220"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128223">.</span><span class="ident" id="6128224">h</span><span class="op" id="6128225">.</span><span class="ident" id="6128226">Type</span>&nbsp;<span class="op" id="6128231">!=</span>&nbsp;<span class="ident" id="6128234"><a href="/net/http/fcgi/fcgi.go.html#6132694">typeBeginRequest</a></span>&nbsp;<span class="op" id="6128251">&amp;&amp;</span>&nbsp;<span class="ident" id="6128254"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128257">.</span><span class="ident" id="6128258">h</span><span class="op" id="6128259">.</span><span class="ident" id="6128260">Type</span>&nbsp;<span class="op" id="6128265">!=</span>&nbsp;<span class="ident" id="6128268"><a href="/net/http/fcgi/fcgi.go.html#6132958">typeGetValues</a></span>&nbsp;<span class="op" id="6128282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6128286">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128336">return</span>&nbsp;<span class="ident" id="6128343">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128348">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128352">switch</span>&nbsp;<span class="ident" id="6128359"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128362">.</span><span class="ident" id="6128363">h</span><span class="op" id="6128364">.</span><span class="ident" id="6128365">Type</span>&nbsp;<span class="op" id="6128370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128373">case</span>&nbsp;<span class="ident" id="6128378"><a href="/net/http/fcgi/fcgi.go.html#6132694">typeBeginRequest</a></span><span class="op" id="6128394">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128398">if</span>&nbsp;<span class="ident" id="6128401"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span>&nbsp;<span class="op" id="6128405">!=</span>&nbsp;<span class="ident" id="6128408">nil</span>&nbsp;<span class="op" id="6128412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6128417">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6128480">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128531">return</span>&nbsp;<span class="ident" id="6128538"><a href="/net/http/fcgi/child.go.html#6125127">errors</a></span><span class="op" id="6128544">.</span><span class="ident" id="6128545">New</span><span class="op" id="6128548">(</span><span class="string" id="6128549">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6128594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128603">var</span>&nbsp;<span class="ident" id="6128607">br</span>&nbsp;<span class="ident" id="6128610"><a href="/net/http/fcgi/fcgi.go.html#6133608">beginRequest</a></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128625">if</span>&nbsp;<span class="ident" id="6128628">err</span>&nbsp;<span class="op" id="6128632">:=</span>&nbsp;<span class="ident" id="6128635"><a href="/net/http/fcgi/child.go.html#6128607">br</a></span><span class="op" id="6128637">.</span><span class="ident" id="6128638">read</span><span class="op" id="6128642">(</span><span class="ident" id="6128643"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128646">.</span><span class="ident" id="6128647">content</span><span class="op" id="6128654">(</span><span class="op" id="6128655">)</span><span class="op" id="6128656">)</span><span class="op" id="6128657">;</span>&nbsp;<span class="ident" id="6128659"><a href="/net/http/fcgi/child.go.html#6128628">err</a></span>&nbsp;<span class="op" id="6128663">!=</span>&nbsp;<span class="ident" id="6128666">nil</span>&nbsp;<span class="op" id="6128670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128675">return</span>&nbsp;<span class="ident" id="6128682"><a href="/net/http/fcgi/child.go.html#6128628">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128692">if</span>&nbsp;<span class="ident" id="6128695"><a href="/net/http/fcgi/child.go.html#6128607">br</a></span><span class="op" id="6128697">.</span><span class="ident" id="6128698">role</span>&nbsp;<span class="op" id="6128703">!=</span>&nbsp;<span class="ident" id="6128706"><a href="/net/http/fcgi/fcgi.go.html#6133237">roleResponder</a></span>&nbsp;<span class="op" id="6128720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128725"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128726">.</span><span class="ident" id="6128727">conn</span><span class="op" id="6128731">.</span><span class="ident" id="6128732">writeEndRequest</span><span class="op" id="6128747">(</span><span class="ident" id="6128748"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128751">.</span><span class="ident" id="6128752">h</span><span class="op" id="6128753">.</span><span class="ident" id="6128754">Id</span><span class="op" id="6128756">,</span>&nbsp;<span class="num" id="6128758">0</span><span class="op" id="6128759">,</span>&nbsp;<span class="ident" id="6128761"><a href="/net/http/fcgi/fcgi.go.html#6133407">statusUnknownRole</a></span><span class="op" id="6128778">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128783">return</span>&nbsp;<span class="ident" id="6128790">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128800"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span>&nbsp;<span class="op" id="6128804">=</span>&nbsp;<span class="ident" id="6128806"><a href="/net/http/fcgi/child.go.html#6125511">newRequest</a></span><span class="op" id="6128816">(</span><span class="ident" id="6128817"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128820">.</span><span class="ident" id="6128821">h</span><span class="op" id="6128822">.</span><span class="ident" id="6128823">Id</span><span class="op" id="6128825">,</span>&nbsp;<span class="ident" id="6128827"><a href="/net/http/fcgi/child.go.html#6128607">br</a></span><span class="op" id="6128829">.</span><span class="ident" id="6128830">flags</span><span class="op" id="6128835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128839"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128840">.</span><span class="ident" id="6128841">mu</span><span class="op" id="6128843">.</span><span class="ident" id="6128844">Lock</span><span class="op" id="6128848">(</span><span class="op" id="6128849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128853"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128854">.</span><span class="ident" id="6128855">requests</span><span class="op" id="6128863">[</span><span class="ident" id="6128864"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6128867">.</span><span class="ident" id="6128868">h</span><span class="op" id="6128869">.</span><span class="ident" id="6128870">Id</span><span class="op" id="6128872">]</span>&nbsp;<span class="op" id="6128874">=</span>&nbsp;<span class="ident" id="6128876"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128882"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6128883">.</span><span class="ident" id="6128884">mu</span><span class="op" id="6128886">.</span><span class="ident" id="6128887">Unlock</span><span class="op" id="6128893">(</span><span class="op" id="6128894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128898">return</span>&nbsp;<span class="ident" id="6128905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128910">case</span>&nbsp;<span class="ident" id="6128915"><a href="/net/http/fcgi/fcgi.go.html#6132793">typeParams</a></span><span class="op" id="6128925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6128929">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129000">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129073">if</span>&nbsp;<span class="builtinfunc" id="6129076">len</span><span class="op" id="6129079">(</span><span class="ident" id="6129080"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6129083">.</span><span class="ident" id="6129084">content</span><span class="op" id="6129091">(</span><span class="op" id="6129092">)</span><span class="op" id="6129093">)</span>&nbsp;<span class="op" id="6129095">&gt;</span>&nbsp;<span class="num" id="6129097">0</span>&nbsp;<span class="op" id="6129099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129104"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129107">.</span><span class="ident" id="6129108">rawParams</span>&nbsp;<span class="op" id="6129118">=</span>&nbsp;<span class="builtinfunc" id="6129120">append</span><span class="op" id="6129126">(</span><span class="ident" id="6129127"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129130">.</span><span class="ident" id="6129131">rawParams</span><span class="op" id="6129140">,</span>&nbsp;<span class="ident" id="6129142"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6129145">.</span><span class="ident" id="6129146">content</span><span class="op" id="6129153">(</span><span class="op" id="6129154">)</span><span class="op" id="6129155">...</span><span class="op" id="6129158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129163">return</span>&nbsp;<span class="ident" id="6129170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129180"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129183">.</span><span class="ident" id="6129184">parseParams</span><span class="op" id="6129195">(</span><span class="op" id="6129196">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129200">return</span>&nbsp;<span class="ident" id="6129207">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129212">case</span>&nbsp;<span class="ident" id="6129217"><a href="/net/http/fcgi/fcgi.go.html#6132826">typeStdin</a></span><span class="op" id="6129226">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129230">content</span>&nbsp;<span class="op" id="6129238">:=</span>&nbsp;<span class="ident" id="6129241"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6129244">.</span><span class="ident" id="6129245">content</span><span class="op" id="6129252">(</span><span class="op" id="6129253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129257">if</span>&nbsp;<span class="ident" id="6129260"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129263">.</span><span class="ident" id="6129264">pw</span>&nbsp;<span class="op" id="6129267">==</span>&nbsp;<span class="ident" id="6129270">nil</span>&nbsp;<span class="op" id="6129274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129279">var</span>&nbsp;<span class="ident" id="6129283">body</span>&nbsp;<span class="ident" id="6129288"><a href="/net/http/fcgi/child.go.html#6125144">io</a></span><span class="op" id="6129290">.</span><span class="ident" id="6129291">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129305">if</span>&nbsp;<span class="builtinfunc" id="6129308">len</span><span class="op" id="6129311">(</span><span class="ident" id="6129312"><a href="/net/http/fcgi/child.go.html#6129230">content</a></span><span class="op" id="6129319">)</span>&nbsp;<span class="op" id="6129321">&gt;</span>&nbsp;<span class="num" id="6129323">0</span>&nbsp;<span class="op" id="6129325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129331">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129395">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129438"><a href="/net/http/fcgi/child.go.html#6129283">body</a></span><span class="op" id="6129442">,</span>&nbsp;<span class="ident" id="6129444"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129447">.</span><span class="ident" id="6129448">pw</span>&nbsp;<span class="op" id="6129451">=</span>&nbsp;<span class="ident" id="6129453"><a href="/net/http/fcgi/child.go.html#6125144">io</a></span><span class="op" id="6129455">.</span><span class="ident" id="6129456">Pipe</span><span class="op" id="6129460">(</span><span class="op" id="6129461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129466">}</span>&nbsp;<span class="keyword" id="6129468">else</span>&nbsp;<span class="op" id="6129473">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129479"><a href="/net/http/fcgi/child.go.html#6129283">body</a></span>&nbsp;<span class="op" id="6129484">=</span>&nbsp;<span class="ident" id="6129486"><a href="/net/http/fcgi/child.go.html#6128045">emptyBody</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129504">go</span>&nbsp;<span class="ident" id="6129507"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6129508">.</span><span class="ident" id="6129509">serveRequest</span><span class="op" id="6129521">(</span><span class="ident" id="6129522"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129525">,</span>&nbsp;<span class="ident" id="6129527"><a href="/net/http/fcgi/child.go.html#6129283">body</a></span><span class="op" id="6129531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129539">if</span>&nbsp;<span class="builtinfunc" id="6129542">len</span><span class="op" id="6129545">(</span><span class="ident" id="6129546"><a href="/net/http/fcgi/child.go.html#6129230">content</a></span><span class="op" id="6129553">)</span>&nbsp;<span class="op" id="6129555">&gt;</span>&nbsp;<span class="num" id="6129557">0</span>&nbsp;<span class="op" id="6129559">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129564">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129632">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129695"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129698">.</span><span class="ident" id="6129699">pw</span><span class="op" id="6129701">.</span><span class="ident" id="6129702">Write</span><span class="op" id="6129707">(</span><span class="ident" id="6129708"><a href="/net/http/fcgi/child.go.html#6129230">content</a></span><span class="op" id="6129715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129719">}</span>&nbsp;<span class="keyword" id="6129721">else</span>&nbsp;<span class="keyword" id="6129726">if</span>&nbsp;<span class="ident" id="6129729"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129732">.</span><span class="ident" id="6129733">pw</span>&nbsp;<span class="op" id="6129736">!=</span>&nbsp;<span class="ident" id="6129739">nil</span>&nbsp;<span class="op" id="6129743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129748"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6129751">.</span><span class="ident" id="6129752">pw</span><span class="op" id="6129754">.</span><span class="ident" id="6129755">Close</span><span class="op" id="6129760">(</span><span class="op" id="6129761">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129769">return</span>&nbsp;<span class="ident" id="6129776">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129781">case</span>&nbsp;<span class="ident" id="6129786"><a href="/net/http/fcgi/fcgi.go.html#6132958">typeGetValues</a></span><span class="op" id="6129799">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129803">values</span>&nbsp;<span class="op" id="6129810">:=</span>&nbsp;<span class="keyword" id="6129813">map</span><span class="op" id="6129816">[</span><span class="builtintype" id="6129817">string</span><span class="op" id="6129823">]</span><span class="builtintype" id="6129824">string</span><span class="op" id="6129830">{</span><span class="string" id="6129831">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6129848">:</span>&nbsp;<span class="string" id="6129850">&#34;1&#34;</span><span class="op" id="6129853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129857"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6129858">.</span><span class="ident" id="6129859">conn</span><span class="op" id="6129863">.</span><span class="ident" id="6129864">writePairs</span><span class="op" id="6129874">(</span><span class="ident" id="6129875"><a href="/net/http/fcgi/fcgi.go.html#6132991">typeGetValuesResult</a></span><span class="op" id="6129894">,</span>&nbsp;<span class="num" id="6129896">0</span><span class="op" id="6129897">,</span>&nbsp;<span class="ident" id="6129899"><a href="/net/http/fcgi/child.go.html#6129803">values</a></span><span class="op" id="6129905">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129909">return</span>&nbsp;<span class="ident" id="6129916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129921">case</span>&nbsp;<span class="ident" id="6129926"><a href="/net/http/fcgi/fcgi.go.html#6132925">typeData</a></span><span class="op" id="6129934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6129938">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130005">return</span>&nbsp;<span class="ident" id="6130012">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130017">case</span>&nbsp;<span class="ident" id="6130022"><a href="/net/http/fcgi/fcgi.go.html#6132727">typeAbortRequest</a></span><span class="op" id="6130038">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6130042">println</span><span class="op" id="6130049">(</span><span class="string" id="6130050">&#34;abort&#34;</span><span class="op" id="6130057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130061"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6130062">.</span><span class="ident" id="6130063">mu</span><span class="op" id="6130065">.</span><span class="ident" id="6130066">Lock</span><span class="op" id="6130070">(</span><span class="op" id="6130071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6130075">delete</span><span class="op" id="6130081">(</span><span class="ident" id="6130082"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6130083">.</span><span class="ident" id="6130084">requests</span><span class="op" id="6130092">,</span>&nbsp;<span class="ident" id="6130094"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6130097">.</span><span class="ident" id="6130098">h</span><span class="op" id="6130099">.</span><span class="ident" id="6130100">Id</span><span class="op" id="6130102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130106"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6130107">.</span><span class="ident" id="6130108">mu</span><span class="op" id="6130110">.</span><span class="ident" id="6130111">Unlock</span><span class="op" id="6130117">(</span><span class="op" id="6130118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130122"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6130123">.</span><span class="ident" id="6130124">conn</span><span class="op" id="6130128">.</span><span class="ident" id="6130129">writeEndRequest</span><span class="op" id="6130144">(</span><span class="ident" id="6130145"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6130148">.</span><span class="ident" id="6130149">h</span><span class="op" id="6130150">.</span><span class="ident" id="6130151">Id</span><span class="op" id="6130153">,</span>&nbsp;<span class="num" id="6130155">0</span><span class="op" id="6130156">,</span>&nbsp;<span class="ident" id="6130158"><a href="/net/http/fcgi/fcgi.go.html#6133338">statusRequestComplete</a></span><span class="op" id="6130179">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130183">if</span>&nbsp;<span class="op" id="6130186">!</span><span class="ident" id="6130187"><a href="/net/http/fcgi/child.go.html#6128162">req</a></span><span class="op" id="6130190">.</span><span class="ident" id="6130191">keepConn</span>&nbsp;<span class="op" id="6130200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6130205">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130245">return</span>&nbsp;<span class="ident" id="6130252"><a href="/net/http/fcgi/child.go.html#6127977">errCloseConn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130271">return</span>&nbsp;<span class="ident" id="6130278">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130283">default</span><span class="op" id="6130290">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130294">b</span>&nbsp;<span class="op" id="6130296">:=</span>&nbsp;<span class="builtinfunc" id="6130299">make</span><span class="op" id="6130303">(</span><span class="op" id="6130304">[</span><span class="op" id="6130305">]</span><span class="builtintype" id="6130306">byte</span><span class="op" id="6130310">,</span>&nbsp;<span class="num" id="6130312">8</span><span class="op" id="6130313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130317"><a href="/net/http/fcgi/child.go.html#6130294">b</a></span><span class="op" id="6130318">[</span><span class="num" id="6130319">0</span><span class="op" id="6130320">]</span>&nbsp;<span class="op" id="6130322">=</span>&nbsp;<span class="builtintype" id="6130324">byte</span><span class="op" id="6130328">(</span><span class="ident" id="6130329"><a href="/net/http/fcgi/child.go.html#6128127">rec</a></span><span class="op" id="6130332">.</span><span class="ident" id="6130333">h</span><span class="op" id="6130334">.</span><span class="ident" id="6130335">Type</span><span class="op" id="6130339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130343"><a href="/net/http/fcgi/child.go.html#6128104">c</a></span><span class="op" id="6130344">.</span><span class="ident" id="6130345">conn</span><span class="op" id="6130349">.</span><span class="ident" id="6130350">writeRecord</span><span class="op" id="6130361">(</span><span class="ident" id="6130362"><a href="/net/http/fcgi/fcgi.go.html#6133025">typeUnknownType</a></span><span class="op" id="6130377">,</span>&nbsp;<span class="num" id="6130379">0</span><span class="op" id="6130380">,</span>&nbsp;<span class="ident" id="6130382"><a href="/net/http/fcgi/child.go.html#6130294">b</a></span><span class="op" id="6130383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130387">return</span>&nbsp;<span class="ident" id="6130394">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130399">}</span><br>
<span class="lineno"></span><span class="op" id="6130401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6130404">func</span>&nbsp;<span class="op" id="6130409">(</span><span class="ident" id="6130410">c</span>&nbsp;<span class="op" id="6130412">*</span><span class="ident" id="6130413"><a href="/net/http/fcgi/child.go.html#6127436">child</a></span><span class="op" id="6130418">)</span>&nbsp;<span class="ident" id="6130420">serveRequest</span><span class="op" id="6130432">(</span><span class="ident" id="6130433">req</span>&nbsp;<span class="op" id="6130437">*</span><span class="ident" id="6130438"><a href="/net/http/fcgi/child.go.html#6125357">request</a></span><span class="op" id="6130445">,</span>&nbsp;<span class="ident" id="6130447">body</span>&nbsp;<span class="ident" id="6130452"><a href="/net/http/fcgi/child.go.html#6125144">io</a></span><span class="op" id="6130454">.</span><span class="ident" id="6130455">ReadCloser</span><span class="op" id="6130465">)</span>&nbsp;<span class="op" id="6130467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130470">r</span>&nbsp;<span class="op" id="6130472">:=</span>&nbsp;<span class="ident" id="6130475"><a href="/net/http/fcgi/child.go.html#6126311">newResponse</a></span><span class="op" id="6130486">(</span><span class="ident" id="6130487"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130488">,</span>&nbsp;<span class="ident" id="6130490"><a href="/net/http/fcgi/child.go.html#6130433">req</a></span><span class="op" id="6130493">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130496">httpReq</span><span class="op" id="6130503">,</span>&nbsp;<span class="ident" id="6130505">err</span>&nbsp;<span class="op" id="6130509">:=</span>&nbsp;<span class="ident" id="6130512"><a href="/net/http/fcgi/child.go.html#6125182">cgi</a></span><span class="op" id="6130515">.</span><span class="ident" id="6130516">RequestFromMap</span><span class="op" id="6130530">(</span><span class="ident" id="6130531"><a href="/net/http/fcgi/child.go.html#6130433">req</a></span><span class="op" id="6130534">.</span><span class="ident" id="6130535">params</span><span class="op" id="6130541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6130544">if</span>&nbsp;<span class="ident" id="6130547"><a href="/net/http/fcgi/child.go.html#6130505">err</a></span>&nbsp;<span class="op" id="6130551">!=</span>&nbsp;<span class="ident" id="6130554">nil</span>&nbsp;<span class="op" id="6130558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6130562">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130606"><a href="/net/http/fcgi/child.go.html#6130470">r</a></span><span class="op" id="6130607">.</span><span class="ident" id="6130608">WriteHeader</span><span class="op" id="6130619">(</span><span class="ident" id="6130620"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6130624">.</span><span class="ident" id="6130625">StatusInternalServerError</span><span class="op" id="6130650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130654"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130655">.</span><span class="ident" id="6130656">conn</span><span class="op" id="6130660">.</span><span class="ident" id="6130661">writeRecord</span><span class="op" id="6130672">(</span><span class="ident" id="6130673"><a href="/net/http/fcgi/fcgi.go.html#6132892">typeStderr</a></span><span class="op" id="6130683">,</span>&nbsp;<span class="ident" id="6130685"><a href="/net/http/fcgi/child.go.html#6130433">req</a></span><span class="op" id="6130688">.</span><span class="ident" id="6130689">reqId</span><span class="op" id="6130694">,</span>&nbsp;<span class="op" id="6130696">[</span><span class="op" id="6130697">]</span><span class="builtintype" id="6130698">byte</span><span class="op" id="6130702">(</span><span class="ident" id="6130703"><a href="/net/http/fcgi/child.go.html#6130505">err</a></span><span class="op" id="6130706">.</span><span class="ident" id="6130707">Error</span><span class="op" id="6130712">(</span><span class="op" id="6130713">)</span><span class="op" id="6130714">)</span><span class="op" id="6130715">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130718">}</span>&nbsp;<span class="keyword" id="6130720">else</span>&nbsp;<span class="op" id="6130725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130729"><a href="/net/http/fcgi/child.go.html#6130496">httpReq</a></span><span class="op" id="6130736">.</span><span class="ident" id="6130737">Body</span>&nbsp;<span class="op" id="6130742">=</span>&nbsp;<span class="ident" id="6130744"><a href="/net/http/fcgi/child.go.html#6130447">body</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130751"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130752">.</span><span class="ident" id="6130753">handler</span><span class="op" id="6130760">.</span><span class="ident" id="6130761">ServeHTTP</span><span class="op" id="6130770">(</span><span class="ident" id="6130771"><a href="/net/http/fcgi/child.go.html#6130470">r</a></span><span class="op" id="6130772">,</span>&nbsp;<span class="ident" id="6130774"><a href="/net/http/fcgi/child.go.html#6130496">httpReq</a></span><span class="op" id="6130781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6130784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130787"><a href="/net/http/fcgi/child.go.html#6130470">r</a></span><span class="op" id="6130788">.</span><span class="ident" id="6130789">Close</span><span class="op" id="6130794">(</span><span class="op" id="6130795">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130798"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130799">.</span><span class="ident" id="6130800">mu</span><span class="op" id="6130802">.</span><span class="ident" id="6130803">Lock</span><span class="op" id="6130807">(</span><span class="op" id="6130808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6130811">delete</span><span class="op" id="6130817">(</span><span class="ident" id="6130818"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130819">.</span><span class="ident" id="6130820">requests</span><span class="op" id="6130828">,</span>&nbsp;<span class="ident" id="6130830"><a href="/net/http/fcgi/child.go.html#6130433">req</a></span><span class="op" id="6130833">.</span><span class="ident" id="6130834">reqId</span><span class="op" id="6130839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130842"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130843">.</span><span class="ident" id="6130844">mu</span><span class="op" id="6130846">.</span><span class="ident" id="6130847">Unlock</span><span class="op" id="6130853">(</span><span class="op" id="6130854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6130857"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6130858">.</span><span class="ident" id="6130859">conn</span><span class="op" id="6130863">.</span><span class="ident" id="6130864">writeEndRequest</span><span class="op" id="6130879">(</span><span class="ident" id="6130880"><a href="/net/http/fcgi/child.go.html#6130433">req</a></span><span class="op" id="6130883">.</span><span class="ident" id="6130884">reqId</span><span class="op" id="6130889">,</span>&nbsp;<span class="num" id="6130891">0</span><span class="op" id="6130892">,</span>&nbsp;<span class="ident" id="6130894"><a href="/net/http/fcgi/fcgi.go.html#6133338">statusRequestComplete</a></span><span class="op" id="6130915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6130919">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6130983">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131044">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131099">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131157">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131213">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6131271">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131310"><a href="/net/http/fcgi/child.go.html#6125144">io</a></span><span class="op" id="6131312">.</span><span class="ident" id="6131313">CopyN</span><span class="op" id="6131318">(</span><span class="ident" id="6131319"><a href="/net/http/fcgi/child.go.html#6125150">ioutil</a></span><span class="op" id="6131325">.</span><span class="ident" id="6131326">Discard</span><span class="op" id="6131333">,</span>&nbsp;<span class="ident" id="6131335"><a href="/net/http/fcgi/child.go.html#6130447">body</a></span><span class="op" id="6131339">,</span>&nbsp;<span class="num" id="6131341">100</span><span class="op" id="6131344">&lt;&lt;</span><span class="num" id="6131346">20</span><span class="op" id="6131348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131351"><a href="/net/http/fcgi/child.go.html#6130447">body</a></span><span class="op" id="6131355">.</span><span class="ident" id="6131356">Close</span><span class="op" id="6131361">(</span><span class="op" id="6131362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131366">if</span>&nbsp;<span class="op" id="6131369">!</span><span class="ident" id="6131370"><a href="/net/http/fcgi/child.go.html#6130433">req</a></span><span class="op" id="6131373">.</span><span class="ident" id="6131374">keepConn</span>&nbsp;<span class="op" id="6131383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131387"><a href="/net/http/fcgi/child.go.html#6130410">c</a></span><span class="op" id="6131388">.</span><span class="ident" id="6131389">conn</span><span class="op" id="6131393">.</span><span class="ident" id="6131394">Close</span><span class="op" id="6131399">(</span><span class="op" id="6131400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131403">}</span><br>
<span class="lineno"></span><span class="op" id="6131405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6131408">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6131488">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6131563">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6131584">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6131641">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6131693">func</span>&nbsp;<span class="ident" id="6131698">Serve</span><span class="op" id="6131703">(</span><span class="ident" id="6131704">l</span>&nbsp;<span class="ident" id="6131706"><a href="/net/http/fcgi/child.go.html#6125163">net</a></span><span class="op" id="6131709">.</span><span class="ident" id="6131710">Listener</span><span class="op" id="6131718">,</span>&nbsp;<span class="ident" id="6131720">handler</span>&nbsp;<span class="ident" id="6131728"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6131732">.</span><span class="ident" id="6131733">Handler</span><span class="op" id="6131740">)</span>&nbsp;<span class="builtintype" id="6131742">error</span>&nbsp;<span class="op" id="6131748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131751">if</span>&nbsp;<span class="ident" id="6131754"><a href="/net/http/fcgi/child.go.html#6131704">l</a></span>&nbsp;<span class="op" id="6131756">==</span>&nbsp;<span class="ident" id="6131759">nil</span>&nbsp;<span class="op" id="6131763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131767">var</span>&nbsp;<span class="ident" id="6131771">err</span>&nbsp;<span class="builtintype" id="6131775">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131783"><a href="/net/http/fcgi/child.go.html#6131704">l</a></span><span class="op" id="6131784">,</span>&nbsp;<span class="ident" id="6131786"><a href="/net/http/fcgi/child.go.html#6131771">err</a></span>&nbsp;<span class="op" id="6131790">=</span>&nbsp;<span class="ident" id="6131792"><a href="/net/http/fcgi/child.go.html#6125163">net</a></span><span class="op" id="6131795">.</span><span class="ident" id="6131796">FileListener</span><span class="op" id="6131808">(</span><span class="ident" id="6131809"><a href="/net/http/fcgi/child.go.html#6125198">os</a></span><span class="op" id="6131811">.</span><span class="ident" id="6131812">Stdin</span><span class="op" id="6131817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131821">if</span>&nbsp;<span class="ident" id="6131824"><a href="/net/http/fcgi/child.go.html#6131771">err</a></span>&nbsp;<span class="op" id="6131828">!=</span>&nbsp;<span class="ident" id="6131831">nil</span>&nbsp;<span class="op" id="6131835">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131840">return</span>&nbsp;<span class="ident" id="6131847"><a href="/net/http/fcgi/child.go.html#6131771">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131857">defer</span>&nbsp;<span class="ident" id="6131863"><a href="/net/http/fcgi/child.go.html#6131704">l</a></span><span class="op" id="6131864">.</span><span class="ident" id="6131865">Close</span><span class="op" id="6131870">(</span><span class="op" id="6131871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131877">if</span>&nbsp;<span class="ident" id="6131880"><a href="/net/http/fcgi/child.go.html#6131720">handler</a></span>&nbsp;<span class="op" id="6131888">==</span>&nbsp;<span class="ident" id="6131891">nil</span>&nbsp;<span class="op" id="6131895">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131899"><a href="/net/http/fcgi/child.go.html#6131720">handler</a></span>&nbsp;<span class="op" id="6131907">=</span>&nbsp;<span class="ident" id="6131909"><a href="/net/http/fcgi/child.go.html#6125170">http</a></span><span class="op" id="6131913">.</span><span class="ident" id="6131914">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131934">for</span>&nbsp;<span class="op" id="6131938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131942">rw</span><span class="op" id="6131944">,</span>&nbsp;<span class="ident" id="6131946">err</span>&nbsp;<span class="op" id="6131950">:=</span>&nbsp;<span class="ident" id="6131953"><a href="/net/http/fcgi/child.go.html#6131704">l</a></span><span class="op" id="6131954">.</span><span class="ident" id="6131955">Accept</span><span class="op" id="6131961">(</span><span class="op" id="6131962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131966">if</span>&nbsp;<span class="ident" id="6131969"><a href="/net/http/fcgi/child.go.html#6131946">err</a></span>&nbsp;<span class="op" id="6131973">!=</span>&nbsp;<span class="ident" id="6131976">nil</span>&nbsp;<span class="op" id="6131980">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6131985">return</span>&nbsp;<span class="ident" id="6131992"><a href="/net/http/fcgi/child.go.html#6131946">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6131998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132002">c</span>&nbsp;<span class="op" id="6132004">:=</span>&nbsp;<span class="ident" id="6132007"><a href="/net/http/fcgi/child.go.html#6127602">newChild</a></span><span class="op" id="6132015">(</span><span class="ident" id="6132016"><a href="/net/http/fcgi/child.go.html#6131942">rw</a></span><span class="op" id="6132018">,</span>&nbsp;<span class="ident" id="6132020"><a href="/net/http/fcgi/child.go.html#6131720">handler</a></span><span class="op" id="6132027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132031">go</span>&nbsp;<span class="ident" id="6132034"><a href="/net/http/fcgi/child.go.html#6132002">c</a></span><span class="op" id="6132035">.</span><span class="ident" id="6132036">serve</span><span class="op" id="6132041">(</span><span class="op" id="6132042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132045">}</span><br>
<span class="lineno">305</span><span class="op" id="6132047">}</span>
</div>
</body>
</html>
