<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7738219">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7738274">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7738328">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7738379">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7738444">package</span>&nbsp;<span class="ident" id="7738452">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7738460">import</span>&nbsp;<span class="op" id="7738467">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738470">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738478">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738491">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738497">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738508">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738519">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738530">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738541">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738552">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7738559">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7738562">func</span>&nbsp;<span class="ident" id="7738567">waitSig</span><span class="op" id="7738574">(</span><span class="ident" id="7738575">t</span>&nbsp;<span class="op" id="7738577">*</span><span class="ident" id="7738578">testing</span><span class="op" id="7738585">.</span><span class="ident" id="7738586">T</span><span class="op" id="7738587">,</span>&nbsp;<span class="ident" id="7738589">c</span>&nbsp;<span class="op" id="7738591">&lt;-</span><span class="keyword" id="7738593">chan</span>&nbsp;<span class="ident" id="7738598">os</span><span class="op" id="7738600">.</span><span class="ident" id="7738601">Signal</span><span class="op" id="7738607">,</span>&nbsp;<span class="ident" id="7738609">sig</span>&nbsp;<span class="ident" id="7738613">os</span><span class="op" id="7738615">.</span><span class="ident" id="7738616">Signal</span><span class="op" id="7738622">)</span>&nbsp;<span class="op" id="7738624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7738627">select</span>&nbsp;<span class="op" id="7738634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7738637">case</span>&nbsp;<span class="ident" id="7738642">s</span>&nbsp;<span class="op" id="7738644">:=</span>&nbsp;<span class="op" id="7738647">&lt;-</span><span class="ident" id="7738649">c</span><span class="op" id="7738650">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7738654">if</span>&nbsp;<span class="ident" id="7738657">s</span>&nbsp;<span class="op" id="7738659">!=</span>&nbsp;<span class="ident" id="7738662">sig</span>&nbsp;<span class="op" id="7738666">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7738671">t</span><span class="op" id="7738672">.</span><span class="ident" id="7738673">Fatalf</span><span class="op" id="7738679">(</span><span class="string" id="7738680">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7738704">,</span>&nbsp;<span class="ident" id="7738706">s</span><span class="op" id="7738707">,</span>&nbsp;<span class="ident" id="7738709">sig</span><span class="op" id="7738712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7738716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7738719">case</span>&nbsp;<span class="op" id="7738724">&lt;-</span><span class="ident" id="7738726">time</span><span class="op" id="7738730">.</span><span class="ident" id="7738731">After</span><span class="op" id="7738736">(</span><span class="num" id="7738737">1</span>&nbsp;<span class="op" id="7738739">*</span>&nbsp;<span class="ident" id="7738741">time</span><span class="op" id="7738745">.</span><span class="ident" id="7738746">Second</span><span class="op" id="7738752">)</span><span class="op" id="7738753">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7738757">t</span><span class="op" id="7738758">.</span><span class="ident" id="7738759">Fatalf</span><span class="op" id="7738765">(</span><span class="string" id="7738766">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7738790">,</span>&nbsp;<span class="ident" id="7738792">sig</span><span class="op" id="7738795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7738798">}</span><br>
<span class="lineno">30</span><span class="op" id="7738800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7738803">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7738845">func</span>&nbsp;<span class="ident" id="7738850">TestSignal</span><span class="op" id="7738860">(</span><span class="ident" id="7738861">t</span>&nbsp;<span class="op" id="7738863">*</span><span class="ident" id="7738864">testing</span><span class="op" id="7738871">.</span><span class="ident" id="7738872">T</span><span class="op" id="7738873">)</span>&nbsp;<span class="op" id="7738875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7738878">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7738897">c</span>&nbsp;<span class="op" id="7738899">:=</span>&nbsp;<span class="builtinfunc" id="7738902">make</span><span class="op" id="7738906">(</span><span class="keyword" id="7738907">chan</span>&nbsp;<span class="ident" id="7738912">os</span><span class="op" id="7738914">.</span><span class="ident" id="7738915">Signal</span><span class="op" id="7738921">,</span>&nbsp;<span class="num" id="7738923">1</span><span class="op" id="7738924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7738927">Notify</span><span class="op" id="7738933">(</span><span class="ident" id="7738934">c</span><span class="op" id="7738935">,</span>&nbsp;<span class="ident" id="7738937">syscall</span><span class="op" id="7738944">.</span><span class="ident" id="7738945">SIGHUP</span><span class="op" id="7738951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7738954">defer</span>&nbsp;<span class="ident" id="7738960">Stop</span><span class="op" id="7738964">(</span><span class="ident" id="7738965">c</span><span class="op" id="7738966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7738970">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739001">t</span><span class="op" id="7739002">.</span><span class="ident" id="7739003">Logf</span><span class="op" id="7739007">(</span><span class="string" id="7739008">&#34;sighup...&#34;</span><span class="op" id="7739019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739022">syscall</span><span class="op" id="7739029">.</span><span class="ident" id="7739030">Kill</span><span class="op" id="7739034">(</span><span class="ident" id="7739035">syscall</span><span class="op" id="7739042">.</span><span class="ident" id="7739043">Getpid</span><span class="op" id="7739049">(</span><span class="op" id="7739050">)</span><span class="op" id="7739051">,</span>&nbsp;<span class="ident" id="7739053">syscall</span><span class="op" id="7739060">.</span><span class="ident" id="7739061">SIGHUP</span><span class="op" id="7739067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739070">waitSig</span><span class="op" id="7739077">(</span><span class="ident" id="7739078">t</span><span class="op" id="7739079">,</span>&nbsp;<span class="ident" id="7739081">c</span><span class="op" id="7739082">,</span>&nbsp;<span class="ident" id="7739084">syscall</span><span class="op" id="7739091">.</span><span class="ident" id="7739092">SIGHUP</span><span class="op" id="7739098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7739102">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739137">c1</span>&nbsp;<span class="op" id="7739140">:=</span>&nbsp;<span class="builtinfunc" id="7739143">make</span><span class="op" id="7739147">(</span><span class="keyword" id="7739148">chan</span>&nbsp;<span class="ident" id="7739153">os</span><span class="op" id="7739155">.</span><span class="ident" id="7739156">Signal</span><span class="op" id="7739162">,</span>&nbsp;<span class="num" id="7739164">1</span><span class="op" id="7739165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739168">Notify</span><span class="op" id="7739174">(</span><span class="ident" id="7739175">c1</span><span class="op" id="7739177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7739181">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739214">t</span><span class="op" id="7739215">.</span><span class="ident" id="7739216">Logf</span><span class="op" id="7739220">(</span><span class="string" id="7739221">&#34;sigwinch...&#34;</span><span class="op" id="7739234">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739237">syscall</span><span class="op" id="7739244">.</span><span class="ident" id="7739245">Kill</span><span class="op" id="7739249">(</span><span class="ident" id="7739250">syscall</span><span class="op" id="7739257">.</span><span class="ident" id="7739258">Getpid</span><span class="op" id="7739264">(</span><span class="op" id="7739265">)</span><span class="op" id="7739266">,</span>&nbsp;<span class="ident" id="7739268">syscall</span><span class="op" id="7739275">.</span><span class="ident" id="7739276">SIGWINCH</span><span class="op" id="7739284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739287">waitSig</span><span class="op" id="7739294">(</span><span class="ident" id="7739295">t</span><span class="op" id="7739296">,</span>&nbsp;<span class="ident" id="7739298">c1</span><span class="op" id="7739300">,</span>&nbsp;<span class="ident" id="7739302">syscall</span><span class="op" id="7739309">.</span><span class="ident" id="7739310">SIGWINCH</span><span class="op" id="7739318">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7739322">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7739367">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7739417">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739455">t</span><span class="op" id="7739456">.</span><span class="ident" id="7739457">Logf</span><span class="op" id="7739461">(</span><span class="string" id="7739462">&#34;sighup...&#34;</span><span class="op" id="7739473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739476">syscall</span><span class="op" id="7739483">.</span><span class="ident" id="7739484">Kill</span><span class="op" id="7739488">(</span><span class="ident" id="7739489">syscall</span><span class="op" id="7739496">.</span><span class="ident" id="7739497">Getpid</span><span class="op" id="7739503">(</span><span class="op" id="7739504">)</span><span class="op" id="7739505">,</span>&nbsp;<span class="ident" id="7739507">syscall</span><span class="op" id="7739514">.</span><span class="ident" id="7739515">SIGHUP</span><span class="op" id="7739521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739524">waitSig</span><span class="op" id="7739531">(</span><span class="ident" id="7739532">t</span><span class="op" id="7739533">,</span>&nbsp;<span class="ident" id="7739535">c1</span><span class="op" id="7739537">,</span>&nbsp;<span class="ident" id="7739539">syscall</span><span class="op" id="7739546">.</span><span class="ident" id="7739547">SIGHUP</span><span class="op" id="7739553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739556">t</span><span class="op" id="7739557">.</span><span class="ident" id="7739558">Logf</span><span class="op" id="7739562">(</span><span class="string" id="7739563">&#34;sighup...&#34;</span><span class="op" id="7739574">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739577">syscall</span><span class="op" id="7739584">.</span><span class="ident" id="7739585">Kill</span><span class="op" id="7739589">(</span><span class="ident" id="7739590">syscall</span><span class="op" id="7739597">.</span><span class="ident" id="7739598">Getpid</span><span class="op" id="7739604">(</span><span class="op" id="7739605">)</span><span class="op" id="7739606">,</span>&nbsp;<span class="ident" id="7739608">syscall</span><span class="op" id="7739615">.</span><span class="ident" id="7739616">SIGHUP</span><span class="op" id="7739622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739625">waitSig</span><span class="op" id="7739632">(</span><span class="ident" id="7739633">t</span><span class="op" id="7739634">,</span>&nbsp;<span class="ident" id="7739636">c1</span><span class="op" id="7739638">,</span>&nbsp;<span class="ident" id="7739640">syscall</span><span class="op" id="7739647">.</span><span class="ident" id="7739648">SIGHUP</span><span class="op" id="7739654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7739658">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739710">waitSig</span><span class="op" id="7739717">(</span><span class="ident" id="7739718">t</span><span class="op" id="7739719">,</span>&nbsp;<span class="ident" id="7739721">c</span><span class="op" id="7739722">,</span>&nbsp;<span class="ident" id="7739724">syscall</span><span class="op" id="7739731">.</span><span class="ident" id="7739732">SIGHUP</span><span class="op" id="7739738">)</span><br>
<span class="lineno">65</span><span class="op" id="7739740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7739743">func</span>&nbsp;<span class="ident" id="7739748">TestStress</span><span class="op" id="7739758">(</span><span class="ident" id="7739759">t</span>&nbsp;<span class="op" id="7739761">*</span><span class="ident" id="7739762">testing</span><span class="op" id="7739769">.</span><span class="ident" id="7739770">T</span><span class="op" id="7739771">)</span>&nbsp;<span class="op" id="7739773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739776">dur</span>&nbsp;<span class="op" id="7739780">:=</span>&nbsp;<span class="num" id="7739783">3</span>&nbsp;<span class="op" id="7739785">*</span>&nbsp;<span class="ident" id="7739787">time</span><span class="op" id="7739791">.</span><span class="ident" id="7739792">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739800">if</span>&nbsp;<span class="ident" id="7739803">testing</span><span class="op" id="7739810">.</span><span class="ident" id="7739811">Short</span><span class="op" id="7739816">(</span><span class="op" id="7739817">)</span>&nbsp;<span class="op" id="7739819">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739823">dur</span>&nbsp;<span class="op" id="7739827">=</span>&nbsp;<span class="num" id="7739829">100</span>&nbsp;<span class="op" id="7739833">*</span>&nbsp;<span class="ident" id="7739835">time</span><span class="op" id="7739839">.</span><span class="ident" id="7739840">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7739853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739856">defer</span>&nbsp;<span class="ident" id="7739862">runtime</span><span class="op" id="7739869">.</span><span class="ident" id="7739870">GOMAXPROCS</span><span class="op" id="7739880">(</span><span class="ident" id="7739881">runtime</span><span class="op" id="7739888">.</span><span class="ident" id="7739889">GOMAXPROCS</span><span class="op" id="7739899">(</span><span class="num" id="7739900">4</span><span class="op" id="7739901">)</span><span class="op" id="7739902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739905">done</span>&nbsp;<span class="op" id="7739910">:=</span>&nbsp;<span class="builtinfunc" id="7739913">make</span><span class="op" id="7739917">(</span><span class="keyword" id="7739918">chan</span>&nbsp;<span class="builtintype" id="7739923">bool</span><span class="op" id="7739927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739930">finished</span>&nbsp;<span class="op" id="7739939">:=</span>&nbsp;<span class="builtinfunc" id="7739942">make</span><span class="op" id="7739946">(</span><span class="keyword" id="7739947">chan</span>&nbsp;<span class="builtintype" id="7739952">bool</span><span class="op" id="7739956">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739959">go</span>&nbsp;<span class="keyword" id="7739962">func</span><span class="op" id="7739966">(</span><span class="op" id="7739967">)</span>&nbsp;<span class="op" id="7739969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739973">sig</span>&nbsp;<span class="op" id="7739977">:=</span>&nbsp;<span class="builtinfunc" id="7739980">make</span><span class="op" id="7739984">(</span><span class="keyword" id="7739985">chan</span>&nbsp;<span class="ident" id="7739990">os</span><span class="op" id="7739992">.</span><span class="ident" id="7739993">Signal</span><span class="op" id="7739999">,</span>&nbsp;<span class="num" id="7740001">1</span><span class="op" id="7740002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740006">Notify</span><span class="op" id="7740012">(</span><span class="ident" id="7740013">sig</span><span class="op" id="7740016">,</span>&nbsp;<span class="ident" id="7740018">syscall</span><span class="op" id="7740025">.</span><span class="ident" id="7740026">SIGUSR1</span><span class="op" id="7740033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740037">defer</span>&nbsp;<span class="ident" id="7740043">Stop</span><span class="op" id="7740047">(</span><span class="ident" id="7740048">sig</span><span class="op" id="7740051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740054">Loop</span><span class="op" id="7740058">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740062">for</span>&nbsp;<span class="op" id="7740066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740071">select</span>&nbsp;<span class="op" id="7740078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740083">case</span>&nbsp;<span class="op" id="7740088">&lt;-</span><span class="ident" id="7740090">sig</span><span class="op" id="7740093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740098">case</span>&nbsp;<span class="op" id="7740103">&lt;-</span><span class="ident" id="7740105">done</span><span class="op" id="7740109">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740115">break</span>&nbsp;<span class="ident" id="7740121">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740137">finished</span>&nbsp;<span class="op" id="7740146">&lt;-</span>&nbsp;<span class="builtintype" id="7740149">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740155">}</span><span class="op" id="7740156">(</span><span class="op" id="7740157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740160">go</span>&nbsp;<span class="keyword" id="7740163">func</span><span class="op" id="7740167">(</span><span class="op" id="7740168">)</span>&nbsp;<span class="op" id="7740170">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740173">Loop</span><span class="op" id="7740177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740181">for</span>&nbsp;<span class="op" id="7740185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740190">select</span>&nbsp;<span class="op" id="7740197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740202">case</span>&nbsp;<span class="op" id="7740207">&lt;-</span><span class="ident" id="7740209">done</span><span class="op" id="7740213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740219">break</span>&nbsp;<span class="ident" id="7740225">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740233">default</span><span class="op" id="7740240">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740246">syscall</span><span class="op" id="7740253">.</span><span class="ident" id="7740254">Kill</span><span class="op" id="7740258">(</span><span class="ident" id="7740259">syscall</span><span class="op" id="7740266">.</span><span class="ident" id="7740267">Getpid</span><span class="op" id="7740273">(</span><span class="op" id="7740274">)</span><span class="op" id="7740275">,</span>&nbsp;<span class="ident" id="7740277">syscall</span><span class="op" id="7740284">.</span><span class="ident" id="7740285">SIGUSR1</span><span class="op" id="7740292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740298">runtime</span><span class="op" id="7740305">.</span><span class="ident" id="7740306">Gosched</span><span class="op" id="7740313">(</span><span class="op" id="7740314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740323">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740327">finished</span>&nbsp;<span class="op" id="7740336">&lt;-</span>&nbsp;<span class="builtintype" id="7740339">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740345">}</span><span class="op" id="7740346">(</span><span class="op" id="7740347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740350">time</span><span class="op" id="7740354">.</span><span class="ident" id="7740355">Sleep</span><span class="op" id="7740360">(</span><span class="ident" id="7740361">dur</span><span class="op" id="7740364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7740367">close</span><span class="op" id="7740372">(</span><span class="ident" id="7740373">done</span><span class="op" id="7740377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740380">&lt;-</span><span class="ident" id="7740382">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740392">&lt;-</span><span class="ident" id="7740394">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7740404">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7740475">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7740525">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740589">time</span><span class="op" id="7740593">.</span><span class="ident" id="7740594">Sleep</span><span class="op" id="7740599">(</span><span class="num" id="7740600">10</span>&nbsp;<span class="op" id="7740603">*</span>&nbsp;<span class="ident" id="7740605">time</span><span class="op" id="7740609">.</span><span class="ident" id="7740610">Millisecond</span><span class="op" id="7740621">)</span><br>
<span class="lineno">110</span><span class="op" id="7740623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7740626">var</span>&nbsp;<span class="ident" id="7740630">sendUncaughtSighup</span>&nbsp;<span class="op" id="7740649">=</span>&nbsp;<span class="ident" id="7740651">flag</span><span class="op" id="7740655">.</span><span class="ident" id="7740656">Int</span><span class="op" id="7740659">(</span><span class="string" id="7740660">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7740682">,</span>&nbsp;<span class="num" id="7740684">0</span><span class="op" id="7740685">,</span>&nbsp;<span class="string" id="7740687">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7740725">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7740728">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7740783">func</span>&nbsp;<span class="ident" id="7740788">TestStop</span><span class="op" id="7740796">(</span><span class="ident" id="7740797">t</span>&nbsp;<span class="op" id="7740799">*</span><span class="ident" id="7740800">testing</span><span class="op" id="7740807">.</span><span class="ident" id="7740808">T</span><span class="op" id="7740809">)</span>&nbsp;<span class="op" id="7740811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740814">sigs</span>&nbsp;<span class="op" id="7740819">:=</span>&nbsp;<span class="op" id="7740822">[</span><span class="op" id="7740823">]</span><span class="ident" id="7740824">syscall</span><span class="op" id="7740831">.</span><span class="ident" id="7740832">Signal</span><span class="op" id="7740838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740842">syscall</span><span class="op" id="7740849">.</span><span class="ident" id="7740850">SIGWINCH</span><span class="op" id="7740858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740862">syscall</span><span class="op" id="7740869">.</span><span class="ident" id="7740870">SIGHUP</span><span class="op" id="7740876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740879">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740883">for</span>&nbsp;<span class="ident" id="7740887">_</span><span class="op" id="7740888">,</span>&nbsp;<span class="ident" id="7740890">sig</span>&nbsp;<span class="op" id="7740894">:=</span>&nbsp;<span class="keyword" id="7740897">range</span>&nbsp;<span class="ident" id="7740903">sigs</span>&nbsp;<span class="op" id="7740908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7740912">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7740934">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7740979">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741050">if</span>&nbsp;<span class="ident" id="7741053">sig</span>&nbsp;<span class="op" id="7741057">!=</span>&nbsp;<span class="ident" id="7741060">syscall</span><span class="op" id="7741067">.</span><span class="ident" id="7741068">SIGHUP</span>&nbsp;<span class="op" id="7741075">||</span>&nbsp;<span class="op" id="7741078">*</span><span class="ident" id="7741079">sendUncaughtSighup</span>&nbsp;<span class="op" id="7741098">==</span>&nbsp;<span class="num" id="7741101">1</span>&nbsp;<span class="op" id="7741103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741108">syscall</span><span class="op" id="7741115">.</span><span class="ident" id="7741116">Kill</span><span class="op" id="7741120">(</span><span class="ident" id="7741121">syscall</span><span class="op" id="7741128">.</span><span class="ident" id="7741129">Getpid</span><span class="op" id="7741135">(</span><span class="op" id="7741136">)</span><span class="op" id="7741137">,</span>&nbsp;<span class="ident" id="7741139">sig</span><span class="op" id="7741142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741150">time</span><span class="op" id="7741154">.</span><span class="ident" id="7741155">Sleep</span><span class="op" id="7741160">(</span><span class="num" id="7741161">100</span>&nbsp;<span class="op" id="7741165">*</span>&nbsp;<span class="ident" id="7741167">time</span><span class="op" id="7741171">.</span><span class="ident" id="7741172">Millisecond</span><span class="op" id="7741183">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741188">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741208">c</span>&nbsp;<span class="op" id="7741210">:=</span>&nbsp;<span class="builtinfunc" id="7741213">make</span><span class="op" id="7741217">(</span><span class="keyword" id="7741218">chan</span>&nbsp;<span class="ident" id="7741223">os</span><span class="op" id="7741225">.</span><span class="ident" id="7741226">Signal</span><span class="op" id="7741232">,</span>&nbsp;<span class="num" id="7741234">1</span><span class="op" id="7741235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741239">Notify</span><span class="op" id="7741245">(</span><span class="ident" id="7741246">c</span><span class="op" id="7741247">,</span>&nbsp;<span class="ident" id="7741249">sig</span><span class="op" id="7741252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741256">defer</span>&nbsp;<span class="ident" id="7741262">Stop</span><span class="op" id="7741266">(</span><span class="ident" id="7741267">c</span><span class="op" id="7741268">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741273">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741308">syscall</span><span class="op" id="7741315">.</span><span class="ident" id="7741316">Kill</span><span class="op" id="7741320">(</span><span class="ident" id="7741321">syscall</span><span class="op" id="7741328">.</span><span class="ident" id="7741329">Getpid</span><span class="op" id="7741335">(</span><span class="op" id="7741336">)</span><span class="op" id="7741337">,</span>&nbsp;<span class="ident" id="7741339">sig</span><span class="op" id="7741342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741346">waitSig</span><span class="op" id="7741353">(</span><span class="ident" id="7741354">t</span><span class="op" id="7741355">,</span>&nbsp;<span class="ident" id="7741357">c</span><span class="op" id="7741358">,</span>&nbsp;<span class="ident" id="7741360">sig</span><span class="op" id="7741363">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741368">Stop</span><span class="op" id="7741372">(</span><span class="ident" id="7741373">c</span><span class="op" id="7741374">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741378">select</span>&nbsp;<span class="op" id="7741385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741389">case</span>&nbsp;<span class="ident" id="7741394">s</span>&nbsp;<span class="op" id="7741396">:=</span>&nbsp;<span class="op" id="7741399">&lt;-</span><span class="ident" id="7741401">c</span><span class="op" id="7741402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741407">t</span><span class="op" id="7741408">.</span><span class="ident" id="7741409">Fatalf</span><span class="op" id="7741415">(</span><span class="string" id="7741416">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7741438">,</span>&nbsp;<span class="ident" id="7741440">s</span><span class="op" id="7741441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741445">case</span>&nbsp;<span class="op" id="7741450">&lt;-</span><span class="ident" id="7741452">time</span><span class="op" id="7741456">.</span><span class="ident" id="7741457">After</span><span class="op" id="7741462">(</span><span class="num" id="7741463">100</span>&nbsp;<span class="op" id="7741467">*</span>&nbsp;<span class="ident" id="7741469">time</span><span class="op" id="7741473">.</span><span class="ident" id="7741474">Millisecond</span><span class="op" id="7741485">)</span><span class="op" id="7741486">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741491">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741524">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741546">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741591">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741662">if</span>&nbsp;<span class="ident" id="7741665">sig</span>&nbsp;<span class="op" id="7741669">!=</span>&nbsp;<span class="ident" id="7741672">syscall</span><span class="op" id="7741679">.</span><span class="ident" id="7741680">SIGHUP</span>&nbsp;<span class="op" id="7741687">||</span>&nbsp;<span class="op" id="7741690">*</span><span class="ident" id="7741691">sendUncaughtSighup</span>&nbsp;<span class="op" id="7741710">==</span>&nbsp;<span class="num" id="7741713">2</span>&nbsp;<span class="op" id="7741715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741720">syscall</span><span class="op" id="7741727">.</span><span class="ident" id="7741728">Kill</span><span class="op" id="7741732">(</span><span class="ident" id="7741733">syscall</span><span class="op" id="7741740">.</span><span class="ident" id="7741741">Getpid</span><span class="op" id="7741747">(</span><span class="op" id="7741748">)</span><span class="op" id="7741749">,</span>&nbsp;<span class="ident" id="7741751">sig</span><span class="op" id="7741754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741763">select</span>&nbsp;<span class="op" id="7741770">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741774">case</span>&nbsp;<span class="ident" id="7741779">s</span>&nbsp;<span class="op" id="7741781">:=</span>&nbsp;<span class="op" id="7741784">&lt;-</span><span class="ident" id="7741786">c</span><span class="op" id="7741787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741792">t</span><span class="op" id="7741793">.</span><span class="ident" id="7741794">Fatalf</span><span class="op" id="7741800">(</span><span class="string" id="7741801">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7741823">,</span>&nbsp;<span class="ident" id="7741825">s</span><span class="op" id="7741826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741830">case</span>&nbsp;<span class="op" id="7741835">&lt;-</span><span class="ident" id="7741837">time</span><span class="op" id="7741841">.</span><span class="ident" id="7741842">After</span><span class="op" id="7741847">(</span><span class="num" id="7741848">100</span>&nbsp;<span class="op" id="7741852">*</span>&nbsp;<span class="ident" id="7741854">time</span><span class="op" id="7741858">.</span><span class="ident" id="7741859">Millisecond</span><span class="op" id="7741870">)</span><span class="op" id="7741871">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7741876">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741904">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741907">}</span><br>
<span class="lineno"></span><span class="op" id="7741909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7741912">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7741993">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7742002">func</span>&nbsp;<span class="ident" id="7742007">TestNohup</span><span class="op" id="7742016">(</span><span class="ident" id="7742017">t</span>&nbsp;<span class="op" id="7742019">*</span><span class="ident" id="7742020">testing</span><span class="op" id="7742027">.</span><span class="ident" id="7742028">T</span><span class="op" id="7742029">)</span>&nbsp;<span class="op" id="7742031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742034">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742098">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742151">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742195">c</span>&nbsp;<span class="op" id="7742197">:=</span>&nbsp;<span class="builtinfunc" id="7742200">make</span><span class="op" id="7742204">(</span><span class="keyword" id="7742205">chan</span>&nbsp;<span class="ident" id="7742210">os</span><span class="op" id="7742212">.</span><span class="ident" id="7742213">Signal</span><span class="op" id="7742219">,</span>&nbsp;<span class="num" id="7742221">1</span><span class="op" id="7742222">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742225">Notify</span><span class="op" id="7742231">(</span><span class="ident" id="7742232">c</span><span class="op" id="7742233">,</span>&nbsp;<span class="ident" id="7742235">syscall</span><span class="op" id="7742242">.</span><span class="ident" id="7742243">SIGHUP</span><span class="op" id="7742249">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742253">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742326">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742393">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742459">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742538">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742616">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742620">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742703">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742786">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7742790">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742850">for</span>&nbsp;<span class="ident" id="7742854">i</span>&nbsp;<span class="op" id="7742856">:=</span>&nbsp;<span class="num" id="7742859">1</span><span class="op" id="7742860">;</span>&nbsp;<span class="ident" id="7742862">i</span>&nbsp;<span class="op" id="7742864">&lt;=</span>&nbsp;<span class="num" id="7742867">2</span><span class="op" id="7742868">;</span>&nbsp;<span class="ident" id="7742870">i</span><span class="op" id="7742871">++</span>&nbsp;<span class="op" id="7742874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742878">out</span><span class="op" id="7742881">,</span>&nbsp;<span class="ident" id="7742883">err</span>&nbsp;<span class="op" id="7742887">:=</span>&nbsp;<span class="ident" id="7742890">exec</span><span class="op" id="7742894">.</span><span class="ident" id="7742895">Command</span><span class="op" id="7742902">(</span><span class="ident" id="7742903">os</span><span class="op" id="7742905">.</span><span class="ident" id="7742906">Args</span><span class="op" id="7742910">[</span><span class="num" id="7742911">0</span><span class="op" id="7742912">]</span><span class="op" id="7742913">,</span>&nbsp;<span class="string" id="7742915">&#34;-test.run=TestStop&#34;</span><span class="op" id="7742935">,</span>&nbsp;<span class="string" id="7742937">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7742961">+</span><span class="ident" id="7742962">strconv</span><span class="op" id="7742969">.</span><span class="ident" id="7742970">Itoa</span><span class="op" id="7742974">(</span><span class="ident" id="7742975">i</span><span class="op" id="7742976">)</span><span class="op" id="7742977">)</span><span class="op" id="7742978">.</span><span class="ident" id="7742979">CombinedOutput</span><span class="op" id="7742993">(</span><span class="op" id="7742994">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742998">if</span>&nbsp;<span class="ident" id="7743001">err</span>&nbsp;<span class="op" id="7743005">==</span>&nbsp;<span class="ident" id="7743008">nil</span>&nbsp;<span class="op" id="7743012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743017">t</span><span class="op" id="7743018">.</span><span class="ident" id="7743019">Fatalf</span><span class="op" id="7743025">(</span><span class="string" id="7743026">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7743115">,</span>&nbsp;<span class="ident" id="7743117">i</span><span class="op" id="7743118">,</span>&nbsp;<span class="ident" id="7743120">out</span><span class="op" id="7743123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743134">Stop</span><span class="op" id="7743138">(</span><span class="ident" id="7743139">c</span><span class="op" id="7743140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7743144">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743202">_</span><span class="op" id="7743203">,</span>&nbsp;<span class="ident" id="7743205">err</span>&nbsp;<span class="op" id="7743209">:=</span>&nbsp;<span class="ident" id="7743212">os</span><span class="op" id="7743214">.</span><span class="ident" id="7743215">Stat</span><span class="op" id="7743219">(</span><span class="string" id="7743220">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7743236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743239">if</span>&nbsp;<span class="ident" id="7743242">err</span>&nbsp;<span class="op" id="7743246">!=</span>&nbsp;<span class="ident" id="7743249">nil</span>&nbsp;<span class="op" id="7743253">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743257">t</span><span class="op" id="7743258">.</span><span class="ident" id="7743259">Skip</span><span class="op" id="7743263">(</span><span class="string" id="7743264">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7743313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743320">for</span>&nbsp;<span class="ident" id="7743324">i</span>&nbsp;<span class="op" id="7743326">:=</span>&nbsp;<span class="num" id="7743329">1</span><span class="op" id="7743330">;</span>&nbsp;<span class="ident" id="7743332">i</span>&nbsp;<span class="op" id="7743334">&lt;=</span>&nbsp;<span class="num" id="7743337">2</span><span class="op" id="7743338">;</span>&nbsp;<span class="ident" id="7743340">i</span><span class="op" id="7743341">++</span>&nbsp;<span class="op" id="7743344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743348">os</span><span class="op" id="7743350">.</span><span class="ident" id="7743351">Remove</span><span class="op" id="7743357">(</span><span class="string" id="7743358">&#34;nohup.out&#34;</span><span class="op" id="7743369">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743373">out</span><span class="op" id="7743376">,</span>&nbsp;<span class="ident" id="7743378">err</span>&nbsp;<span class="op" id="7743382">:=</span>&nbsp;<span class="ident" id="7743385">exec</span><span class="op" id="7743389">.</span><span class="ident" id="7743390">Command</span><span class="op" id="7743397">(</span><span class="string" id="7743398">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7743414">,</span>&nbsp;<span class="ident" id="7743416">os</span><span class="op" id="7743418">.</span><span class="ident" id="7743419">Args</span><span class="op" id="7743423">[</span><span class="num" id="7743424">0</span><span class="op" id="7743425">]</span><span class="op" id="7743426">,</span>&nbsp;<span class="string" id="7743428">&#34;-test.run=TestStop&#34;</span><span class="op" id="7743448">,</span>&nbsp;<span class="string" id="7743450">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7743474">+</span><span class="ident" id="7743475">strconv</span><span class="op" id="7743482">.</span><span class="ident" id="7743483">Itoa</span><span class="op" id="7743487">(</span><span class="ident" id="7743488">i</span><span class="op" id="7743489">)</span><span class="op" id="7743490">)</span><span class="op" id="7743491">.</span><span class="ident" id="7743492">CombinedOutput</span><span class="op" id="7743506">(</span><span class="op" id="7743507">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743512">data</span><span class="op" id="7743516">,</span>&nbsp;<span class="ident" id="7743518">_</span>&nbsp;<span class="op" id="7743520">:=</span>&nbsp;<span class="ident" id="7743523">ioutil</span><span class="op" id="7743529">.</span><span class="ident" id="7743530">ReadFile</span><span class="op" id="7743538">(</span><span class="string" id="7743539">&#34;nohup.out&#34;</span><span class="op" id="7743550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743554">os</span><span class="op" id="7743556">.</span><span class="ident" id="7743557">Remove</span><span class="op" id="7743563">(</span><span class="string" id="7743564">&#34;nohup.out&#34;</span><span class="op" id="7743575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743579">if</span>&nbsp;<span class="ident" id="7743582">err</span>&nbsp;<span class="op" id="7743586">!=</span>&nbsp;<span class="ident" id="7743589">nil</span>&nbsp;<span class="op" id="7743593">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743598">t</span><span class="op" id="7743599">.</span><span class="ident" id="7743600">Fatalf</span><span class="op" id="7743606">(</span><span class="string" id="7743607">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7743718">,</span>&nbsp;<span class="ident" id="7743720">i</span><span class="op" id="7743721">,</span>&nbsp;<span class="ident" id="7743723">err</span><span class="op" id="7743726">,</span>&nbsp;<span class="ident" id="7743728">out</span><span class="op" id="7743731">,</span>&nbsp;<span class="ident" id="7743733">data</span><span class="op" id="7743737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743744">}</span><br>
<span class="lineno"></span><span class="op" id="7743746">}</span>
</div>
</body>
</html>
