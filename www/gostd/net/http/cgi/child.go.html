<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5521224">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5521279">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5521333">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5521384">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5521444">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5521457">package</span>&nbsp;<span class="ident" id="5521465">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5521470">import</span>&nbsp;<span class="op" id="5521477">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521480">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521489">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521503">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521513">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521520">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521526">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521539">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521546">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521558">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521569">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521575">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5521586">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5521596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5521599">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5521665">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5521727">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5521768">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5521828">func</span>&nbsp;<span class="ident" id="5521833">Request</span><span class="op" id="5521840">(</span><span class="op" id="5521841">)</span>&nbsp;<span class="op" id="5521843">(</span><span class="op" id="5521844">*</span><span class="ident" id="5521845">http</span><span class="op" id="5521849">.</span><span class="ident" id="5521850">Request</span><span class="op" id="5521857">,</span>&nbsp;<span class="builtintype" id="5521859">error</span><span class="op" id="5521864">)</span>&nbsp;<span class="op" id="5521866">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5521869">r</span><span class="op" id="5521870">,</span>&nbsp;<span class="ident" id="5521872">err</span>&nbsp;<span class="op" id="5521876">:=</span>&nbsp;<span class="ident" id="5521879">RequestFromMap</span><span class="op" id="5521893">(</span><span class="ident" id="5521894">envMap</span><span class="op" id="5521900">(</span><span class="ident" id="5521901">os</span><span class="op" id="5521903">.</span><span class="ident" id="5521904">Environ</span><span class="op" id="5521911">(</span><span class="op" id="5521912">)</span><span class="op" id="5521913">)</span><span class="op" id="5521914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5521917">if</span>&nbsp;<span class="ident" id="5521920">err</span>&nbsp;<span class="op" id="5521924">!=</span>&nbsp;<span class="ident" id="5521927">nil</span>&nbsp;<span class="op" id="5521931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5521935">return</span>&nbsp;<span class="ident" id="5521942">nil</span><span class="op" id="5521945">,</span>&nbsp;<span class="ident" id="5521947">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5521952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5521955">if</span>&nbsp;<span class="ident" id="5521958">r</span><span class="op" id="5521959">.</span><span class="ident" id="5521960">ContentLength</span>&nbsp;<span class="op" id="5521974">&gt;</span>&nbsp;<span class="num" id="5521976">0</span>&nbsp;<span class="op" id="5521978">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5521982">r</span><span class="op" id="5521983">.</span><span class="ident" id="5521984">Body</span>&nbsp;<span class="op" id="5521989">=</span>&nbsp;<span class="ident" id="5521991">ioutil</span><span class="op" id="5521997">.</span><span class="ident" id="5521998">NopCloser</span><span class="op" id="5522007">(</span><span class="ident" id="5522008">io</span><span class="op" id="5522010">.</span><span class="ident" id="5522011">LimitReader</span><span class="op" id="5522022">(</span><span class="ident" id="5522023">os</span><span class="op" id="5522025">.</span><span class="ident" id="5522026">Stdin</span><span class="op" id="5522031">,</span>&nbsp;<span class="ident" id="5522033">r</span><span class="op" id="5522034">.</span><span class="ident" id="5522035">ContentLength</span><span class="op" id="5522048">)</span><span class="op" id="5522049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5522052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522055">return</span>&nbsp;<span class="ident" id="5522062">r</span><span class="op" id="5522063">,</span>&nbsp;<span class="ident" id="5522065">nil</span><br>
<span class="lineno"></span><span class="op" id="5522069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5522072">func</span>&nbsp;<span class="ident" id="5522077">envMap</span><span class="op" id="5522083">(</span><span class="ident" id="5522084">env</span>&nbsp;<span class="op" id="5522088">[</span><span class="op" id="5522089">]</span><span class="builtintype" id="5522090">string</span><span class="op" id="5522096">)</span>&nbsp;<span class="keyword" id="5522098">map</span><span class="op" id="5522101">[</span><span class="builtintype" id="5522102">string</span><span class="op" id="5522108">]</span><span class="builtintype" id="5522109">string</span>&nbsp;<span class="op" id="5522116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522119">m</span>&nbsp;<span class="op" id="5522121">:=</span>&nbsp;<span class="builtinfunc" id="5522124">make</span><span class="op" id="5522128">(</span><span class="keyword" id="5522129">map</span><span class="op" id="5522132">[</span><span class="builtintype" id="5522133">string</span><span class="op" id="5522139">]</span><span class="builtintype" id="5522140">string</span><span class="op" id="5522146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522149">for</span>&nbsp;<span class="ident" id="5522153">_</span><span class="op" id="5522154">,</span>&nbsp;<span class="ident" id="5522156">kv</span>&nbsp;<span class="op" id="5522159">:=</span>&nbsp;<span class="keyword" id="5522162">range</span>&nbsp;<span class="ident" id="5522168">env</span>&nbsp;<span class="op" id="5522172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522176">if</span>&nbsp;<span class="ident" id="5522179">idx</span>&nbsp;<span class="op" id="5522183">:=</span>&nbsp;<span class="ident" id="5522186">strings</span><span class="op" id="5522193">.</span><span class="ident" id="5522194">Index</span><span class="op" id="5522199">(</span><span class="ident" id="5522200">kv</span><span class="op" id="5522202">,</span>&nbsp;<span class="string" id="5522204">&#34;=&#34;</span><span class="op" id="5522207">)</span><span class="op" id="5522208">;</span>&nbsp;<span class="ident" id="5522210">idx</span>&nbsp;<span class="op" id="5522214">!=</span>&nbsp;<span class="op" id="5522217">-</span><span class="num" id="5522218">1</span>&nbsp;<span class="op" id="5522220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522225">m</span><span class="op" id="5522226">[</span><span class="ident" id="5522227">kv</span><span class="op" id="5522229">[</span><span class="op" id="5522230">:</span><span class="ident" id="5522231">idx</span><span class="op" id="5522234">]</span><span class="op" id="5522235">]</span>&nbsp;<span class="op" id="5522237">=</span>&nbsp;<span class="ident" id="5522239">kv</span><span class="op" id="5522241">[</span><span class="ident" id="5522242">idx</span><span class="op" id="5522245">+</span><span class="num" id="5522246">1</span><span class="op" id="5522247">:</span><span class="op" id="5522248">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5522252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5522255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522258">return</span>&nbsp;<span class="ident" id="5522265">m</span><br>
<span class="lineno"></span><span class="op" id="5522267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5522270">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5522332">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5522387">func</span>&nbsp;<span class="ident" id="5522392">RequestFromMap</span><span class="op" id="5522406">(</span><span class="ident" id="5522407">params</span>&nbsp;<span class="keyword" id="5522414">map</span><span class="op" id="5522417">[</span><span class="builtintype" id="5522418">string</span><span class="op" id="5522424">]</span><span class="builtintype" id="5522425">string</span><span class="op" id="5522431">)</span>&nbsp;<span class="op" id="5522433">(</span><span class="op" id="5522434">*</span><span class="ident" id="5522435">http</span><span class="op" id="5522439">.</span><span class="ident" id="5522440">Request</span><span class="op" id="5522447">,</span>&nbsp;<span class="builtintype" id="5522449">error</span><span class="op" id="5522454">)</span>&nbsp;<span class="op" id="5522456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522459">r</span>&nbsp;<span class="op" id="5522461">:=</span>&nbsp;<span class="builtinfunc" id="5522464">new</span><span class="op" id="5522467">(</span><span class="ident" id="5522468">http</span><span class="op" id="5522472">.</span><span class="ident" id="5522473">Request</span><span class="op" id="5522480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522483">r</span><span class="op" id="5522484">.</span><span class="ident" id="5522485">Method</span>&nbsp;<span class="op" id="5522492">=</span>&nbsp;<span class="ident" id="5522494">params</span><span class="op" id="5522500">[</span><span class="string" id="5522501">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5522517">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522520">if</span>&nbsp;<span class="ident" id="5522523">r</span><span class="op" id="5522524">.</span><span class="ident" id="5522525">Method</span>&nbsp;<span class="op" id="5522532">==</span>&nbsp;<span class="string" id="5522535">&#34;&#34;</span>&nbsp;<span class="op" id="5522538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522542">return</span>&nbsp;<span class="ident" id="5522549">nil</span><span class="op" id="5522552">,</span>&nbsp;<span class="ident" id="5522554">errors</span><span class="op" id="5522560">.</span><span class="ident" id="5522561">New</span><span class="op" id="5522564">(</span><span class="string" id="5522565">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5522604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5522607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522611">r</span><span class="op" id="5522612">.</span><span class="ident" id="5522613">Proto</span>&nbsp;<span class="op" id="5522619">=</span>&nbsp;<span class="ident" id="5522621">params</span><span class="op" id="5522627">[</span><span class="string" id="5522628">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5522645">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522648">var</span>&nbsp;<span class="ident" id="5522652">ok</span>&nbsp;<span class="builtintype" id="5522655">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522661">r</span><span class="op" id="5522662">.</span><span class="ident" id="5522663">ProtoMajor</span><span class="op" id="5522673">,</span>&nbsp;<span class="ident" id="5522675">r</span><span class="op" id="5522676">.</span><span class="ident" id="5522677">ProtoMinor</span><span class="op" id="5522687">,</span>&nbsp;<span class="ident" id="5522689">ok</span>&nbsp;<span class="op" id="5522692">=</span>&nbsp;<span class="ident" id="5522694">http</span><span class="op" id="5522698">.</span><span class="ident" id="5522699">ParseHTTPVersion</span><span class="op" id="5522715">(</span><span class="ident" id="5522716">r</span><span class="op" id="5522717">.</span><span class="ident" id="5522718">Proto</span><span class="op" id="5522723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522726">if</span>&nbsp;<span class="op" id="5522729">!</span><span class="ident" id="5522730">ok</span>&nbsp;<span class="op" id="5522733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522737">return</span>&nbsp;<span class="ident" id="5522744">nil</span><span class="op" id="5522747">,</span>&nbsp;<span class="ident" id="5522749">errors</span><span class="op" id="5522755">.</span><span class="ident" id="5522756">New</span><span class="op" id="5522759">(</span><span class="string" id="5522760">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5522798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5522801">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522805">r</span><span class="op" id="5522806">.</span><span class="ident" id="5522807">Close</span>&nbsp;<span class="op" id="5522813">=</span>&nbsp;<span class="builtintype" id="5522815">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522821">r</span><span class="op" id="5522822">.</span><span class="ident" id="5522823">Trailer</span>&nbsp;<span class="op" id="5522831">=</span>&nbsp;<span class="ident" id="5522833">http</span><span class="op" id="5522837">.</span><span class="ident" id="5522838">Header</span><span class="op" id="5522844">{</span><span class="op" id="5522845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522848">r</span><span class="op" id="5522849">.</span><span class="ident" id="5522850">Header</span>&nbsp;<span class="op" id="5522857">=</span>&nbsp;<span class="ident" id="5522859">http</span><span class="op" id="5522863">.</span><span class="ident" id="5522864">Header</span><span class="op" id="5522870">{</span><span class="op" id="5522871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522875">r</span><span class="op" id="5522876">.</span><span class="ident" id="5522877">Host</span>&nbsp;<span class="op" id="5522882">=</span>&nbsp;<span class="ident" id="5522884">params</span><span class="op" id="5522890">[</span><span class="string" id="5522891">&#34;HTTP_HOST&#34;</span><span class="op" id="5522902">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5522906">if</span>&nbsp;<span class="ident" id="5522909">lenstr</span>&nbsp;<span class="op" id="5522916">:=</span>&nbsp;<span class="ident" id="5522919">params</span><span class="op" id="5522925">[</span><span class="string" id="5522926">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5522942">]</span><span class="op" id="5522943">;</span>&nbsp;<span class="ident" id="5522945">lenstr</span>&nbsp;<span class="op" id="5522952">!=</span>&nbsp;<span class="string" id="5522955">&#34;&#34;</span>&nbsp;<span class="op" id="5522958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5522962">clen</span><span class="op" id="5522966">,</span>&nbsp;<span class="ident" id="5522968">err</span>&nbsp;<span class="op" id="5522972">:=</span>&nbsp;<span class="ident" id="5522975">strconv</span><span class="op" id="5522982">.</span><span class="ident" id="5522983">ParseInt</span><span class="op" id="5522991">(</span><span class="ident" id="5522992">lenstr</span><span class="op" id="5522998">,</span>&nbsp;<span class="num" id="5523000">10</span><span class="op" id="5523002">,</span>&nbsp;<span class="num" id="5523004">64</span><span class="op" id="5523006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523010">if</span>&nbsp;<span class="ident" id="5523013">err</span>&nbsp;<span class="op" id="5523017">!=</span>&nbsp;<span class="ident" id="5523020">nil</span>&nbsp;<span class="op" id="5523024">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523029">return</span>&nbsp;<span class="ident" id="5523036">nil</span><span class="op" id="5523039">,</span>&nbsp;<span class="ident" id="5523041">errors</span><span class="op" id="5523047">.</span><span class="ident" id="5523048">New</span><span class="op" id="5523051">(</span><span class="string" id="5523052">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5523095">+</span>&nbsp;<span class="ident" id="5523097">lenstr</span><span class="op" id="5523103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523111">r</span><span class="op" id="5523112">.</span><span class="ident" id="5523113">ContentLength</span>&nbsp;<span class="op" id="5523127">=</span>&nbsp;<span class="ident" id="5523129">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523139">if</span>&nbsp;<span class="ident" id="5523142">ct</span>&nbsp;<span class="op" id="5523145">:=</span>&nbsp;<span class="ident" id="5523148">params</span><span class="op" id="5523154">[</span><span class="string" id="5523155">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5523169">]</span><span class="op" id="5523170">;</span>&nbsp;<span class="ident" id="5523172">ct</span>&nbsp;<span class="op" id="5523175">!=</span>&nbsp;<span class="string" id="5523178">&#34;&#34;</span>&nbsp;<span class="op" id="5523181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523185">r</span><span class="op" id="5523186">.</span><span class="ident" id="5523187">Header</span><span class="op" id="5523193">.</span><span class="ident" id="5523194">Set</span><span class="op" id="5523197">(</span><span class="string" id="5523198">&#34;Content-Type&#34;</span><span class="op" id="5523212">,</span>&nbsp;<span class="ident" id="5523214">ct</span><span class="op" id="5523216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5523223">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523278">for</span>&nbsp;<span class="ident" id="5523282">k</span><span class="op" id="5523283">,</span>&nbsp;<span class="ident" id="5523285">v</span>&nbsp;<span class="op" id="5523287">:=</span>&nbsp;<span class="keyword" id="5523290">range</span>&nbsp;<span class="ident" id="5523296">params</span>&nbsp;<span class="op" id="5523303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523307">if</span>&nbsp;<span class="op" id="5523310">!</span><span class="ident" id="5523311">strings</span><span class="op" id="5523318">.</span><span class="ident" id="5523319">HasPrefix</span><span class="op" id="5523328">(</span><span class="ident" id="5523329">k</span><span class="op" id="5523330">,</span>&nbsp;<span class="string" id="5523332">&#34;HTTP_&#34;</span><span class="op" id="5523339">)</span>&nbsp;<span class="op" id="5523341">||</span>&nbsp;<span class="ident" id="5523344">k</span>&nbsp;<span class="op" id="5523346">==</span>&nbsp;<span class="string" id="5523349">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5523361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523366">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523381">r</span><span class="op" id="5523382">.</span><span class="ident" id="5523383">Header</span><span class="op" id="5523389">.</span><span class="ident" id="5523390">Add</span><span class="op" id="5523393">(</span><span class="ident" id="5523394">strings</span><span class="op" id="5523401">.</span><span class="ident" id="5523402">Replace</span><span class="op" id="5523409">(</span><span class="ident" id="5523410">k</span><span class="op" id="5523411">[</span><span class="num" id="5523412">5</span><span class="op" id="5523413">:</span><span class="op" id="5523414">]</span><span class="op" id="5523415">,</span>&nbsp;<span class="string" id="5523417">&#34;_&#34;</span><span class="op" id="5523420">,</span>&nbsp;<span class="string" id="5523422">&#34;-&#34;</span><span class="op" id="5523425">,</span>&nbsp;<span class="op" id="5523427">-</span><span class="num" id="5523428">1</span><span class="op" id="5523429">)</span><span class="op" id="5523430">,</span>&nbsp;<span class="ident" id="5523432">v</span><span class="op" id="5523433">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5523440">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523498">uriStr</span>&nbsp;<span class="op" id="5523505">:=</span>&nbsp;<span class="ident" id="5523508">params</span><span class="op" id="5523514">[</span><span class="string" id="5523515">&#34;REQUEST_URI&#34;</span><span class="op" id="5523528">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523531">if</span>&nbsp;<span class="ident" id="5523534">uriStr</span>&nbsp;<span class="op" id="5523541">==</span>&nbsp;<span class="string" id="5523544">&#34;&#34;</span>&nbsp;<span class="op" id="5523547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5523551">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523609">uriStr</span>&nbsp;<span class="op" id="5523616">=</span>&nbsp;<span class="ident" id="5523618">params</span><span class="op" id="5523624">[</span><span class="string" id="5523625">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5523638">]</span>&nbsp;<span class="op" id="5523640">+</span>&nbsp;<span class="ident" id="5523642">params</span><span class="op" id="5523648">[</span><span class="string" id="5523649">&#34;PATH_INFO&#34;</span><span class="op" id="5523660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523664">s</span>&nbsp;<span class="op" id="5523666">:=</span>&nbsp;<span class="ident" id="5523669">params</span><span class="op" id="5523675">[</span><span class="string" id="5523676">&#34;QUERY_STRING&#34;</span><span class="op" id="5523690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523694">if</span>&nbsp;<span class="ident" id="5523697">s</span>&nbsp;<span class="op" id="5523699">!=</span>&nbsp;<span class="string" id="5523702">&#34;&#34;</span>&nbsp;<span class="op" id="5523705">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523710">uriStr</span>&nbsp;<span class="op" id="5523717">+=</span>&nbsp;<span class="string" id="5523720">&#34;?&#34;</span>&nbsp;<span class="op" id="5523724">+</span>&nbsp;<span class="ident" id="5523726">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5523737">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5523790">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523857">if</span>&nbsp;<span class="ident" id="5523860">s</span>&nbsp;<span class="op" id="5523862">:=</span>&nbsp;<span class="ident" id="5523865">params</span><span class="op" id="5523871">[</span><span class="string" id="5523872">&#34;HTTPS&#34;</span><span class="op" id="5523879">]</span><span class="op" id="5523880">;</span>&nbsp;<span class="ident" id="5523882">s</span>&nbsp;<span class="op" id="5523884">==</span>&nbsp;<span class="string" id="5523887">&#34;on&#34;</span>&nbsp;<span class="op" id="5523892">||</span>&nbsp;<span class="ident" id="5523895">s</span>&nbsp;<span class="op" id="5523897">==</span>&nbsp;<span class="string" id="5523900">&#34;ON&#34;</span>&nbsp;<span class="op" id="5523905">||</span>&nbsp;<span class="ident" id="5523908">s</span>&nbsp;<span class="op" id="5523910">==</span>&nbsp;<span class="string" id="5523913">&#34;1&#34;</span>&nbsp;<span class="op" id="5523917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5523921">r</span><span class="op" id="5523922">.</span><span class="ident" id="5523923">TLS</span>&nbsp;<span class="op" id="5523927">=</span>&nbsp;<span class="op" id="5523929">&amp;</span><span class="ident" id="5523930">tls</span><span class="op" id="5523933">.</span><span class="ident" id="5523934">ConnectionState</span><span class="op" id="5523949">{</span><span class="ident" id="5523950">HandshakeComplete</span><span class="op" id="5523967">:</span>&nbsp;<span class="builtintype" id="5523969">true</span><span class="op" id="5523973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5523976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5523980">if</span>&nbsp;<span class="ident" id="5523983">r</span><span class="op" id="5523984">.</span><span class="ident" id="5523985">Host</span>&nbsp;<span class="op" id="5523990">!=</span>&nbsp;<span class="string" id="5523993">&#34;&#34;</span>&nbsp;<span class="op" id="5523996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5524000">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524065">rawurl</span>&nbsp;<span class="op" id="5524072">:=</span>&nbsp;<span class="ident" id="5524075">r</span><span class="op" id="5524076">.</span><span class="ident" id="5524077">Host</span>&nbsp;<span class="op" id="5524082">+</span>&nbsp;<span class="ident" id="5524084">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524093">if</span>&nbsp;<span class="ident" id="5524096">r</span><span class="op" id="5524097">.</span><span class="ident" id="5524098">TLS</span>&nbsp;<span class="op" id="5524102">==</span>&nbsp;<span class="ident" id="5524105">nil</span>&nbsp;<span class="op" id="5524109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524114">rawurl</span>&nbsp;<span class="op" id="5524121">=</span>&nbsp;<span class="string" id="5524123">&#34;http://&#34;</span>&nbsp;<span class="op" id="5524133">+</span>&nbsp;<span class="ident" id="5524135">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5524144">}</span>&nbsp;<span class="keyword" id="5524146">else</span>&nbsp;<span class="op" id="5524151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524156">rawurl</span>&nbsp;<span class="op" id="5524163">=</span>&nbsp;<span class="string" id="5524165">&#34;https://&#34;</span>&nbsp;<span class="op" id="5524176">+</span>&nbsp;<span class="ident" id="5524178">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5524187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524191">url</span><span class="op" id="5524194">,</span>&nbsp;<span class="ident" id="5524196">err</span>&nbsp;<span class="op" id="5524200">:=</span>&nbsp;<span class="ident" id="5524203">url</span><span class="op" id="5524206">.</span><span class="ident" id="5524207">Parse</span><span class="op" id="5524212">(</span><span class="ident" id="5524213">rawurl</span><span class="op" id="5524219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524223">if</span>&nbsp;<span class="ident" id="5524226">err</span>&nbsp;<span class="op" id="5524230">!=</span>&nbsp;<span class="ident" id="5524233">nil</span>&nbsp;<span class="op" id="5524237">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524242">return</span>&nbsp;<span class="ident" id="5524249">nil</span><span class="op" id="5524252">,</span>&nbsp;<span class="ident" id="5524254">errors</span><span class="op" id="5524260">.</span><span class="ident" id="5524261">New</span><span class="op" id="5524264">(</span><span class="string" id="5524265">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5524322">+</span>&nbsp;<span class="ident" id="5524324">rawurl</span><span class="op" id="5524330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5524334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524338">r</span><span class="op" id="5524339">.</span><span class="ident" id="5524340">URL</span>&nbsp;<span class="op" id="5524344">=</span>&nbsp;<span class="ident" id="5524346">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5524351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5524354">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5524415">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524435">if</span>&nbsp;<span class="ident" id="5524438">r</span><span class="op" id="5524439">.</span><span class="ident" id="5524440">URL</span>&nbsp;<span class="op" id="5524444">==</span>&nbsp;<span class="ident" id="5524447">nil</span>&nbsp;<span class="op" id="5524451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524455">url</span><span class="op" id="5524458">,</span>&nbsp;<span class="ident" id="5524460">err</span>&nbsp;<span class="op" id="5524464">:=</span>&nbsp;<span class="ident" id="5524467">url</span><span class="op" id="5524470">.</span><span class="ident" id="5524471">Parse</span><span class="op" id="5524476">(</span><span class="ident" id="5524477">uriStr</span><span class="op" id="5524483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524487">if</span>&nbsp;<span class="ident" id="5524490">err</span>&nbsp;<span class="op" id="5524494">!=</span>&nbsp;<span class="ident" id="5524497">nil</span>&nbsp;<span class="op" id="5524501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524506">return</span>&nbsp;<span class="ident" id="5524513">nil</span><span class="op" id="5524516">,</span>&nbsp;<span class="ident" id="5524518">errors</span><span class="op" id="5524524">.</span><span class="ident" id="5524525">New</span><span class="op" id="5524528">(</span><span class="string" id="5524529">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5524577">+</span>&nbsp;<span class="ident" id="5524579">uriStr</span><span class="op" id="5524585">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5524589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524593">r</span><span class="op" id="5524594">.</span><span class="ident" id="5524595">URL</span>&nbsp;<span class="op" id="5524599">=</span>&nbsp;<span class="ident" id="5524601">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5524606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5524610">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5524672">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5524736">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5524757">r</span><span class="op" id="5524758">.</span><span class="ident" id="5524759">RemoteAddr</span>&nbsp;<span class="op" id="5524770">=</span>&nbsp;<span class="ident" id="5524772">net</span><span class="op" id="5524775">.</span><span class="ident" id="5524776">JoinHostPort</span><span class="op" id="5524788">(</span><span class="ident" id="5524789">params</span><span class="op" id="5524795">[</span><span class="string" id="5524796">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5524809">]</span><span class="op" id="5524810">,</span>&nbsp;<span class="string" id="5524812">&#34;0&#34;</span><span class="op" id="5524815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5524819">return</span>&nbsp;<span class="ident" id="5524826">r</span><span class="op" id="5524827">,</span>&nbsp;<span class="ident" id="5524829">nil</span><br>
<span class="lineno">140</span><span class="op" id="5524833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5524836">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5524903">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5524961">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5525025">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5525050">func</span>&nbsp;<span class="ident" id="5525055">Serve</span><span class="op" id="5525060">(</span><span class="ident" id="5525061">handler</span>&nbsp;<span class="ident" id="5525069">http</span><span class="op" id="5525073">.</span><span class="ident" id="5525074">Handler</span><span class="op" id="5525081">)</span>&nbsp;<span class="builtintype" id="5525083">error</span>&nbsp;<span class="op" id="5525089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525092">req</span><span class="op" id="5525095">,</span>&nbsp;<span class="ident" id="5525097">err</span>&nbsp;<span class="op" id="5525101">:=</span>&nbsp;<span class="ident" id="5525104">Request</span><span class="op" id="5525111">(</span><span class="op" id="5525112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525115">if</span>&nbsp;<span class="ident" id="5525118">err</span>&nbsp;<span class="op" id="5525122">!=</span>&nbsp;<span class="ident" id="5525125">nil</span>&nbsp;<span class="op" id="5525129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525133">return</span>&nbsp;<span class="ident" id="5525140">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525148">if</span>&nbsp;<span class="ident" id="5525151">handler</span>&nbsp;<span class="op" id="5525159">==</span>&nbsp;<span class="ident" id="5525162">nil</span>&nbsp;<span class="op" id="5525166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525170">handler</span>&nbsp;<span class="op" id="5525178">=</span>&nbsp;<span class="ident" id="5525180">http</span><span class="op" id="5525184">.</span><span class="ident" id="5525185">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525205">rw</span>&nbsp;<span class="op" id="5525208">:=</span>&nbsp;<span class="op" id="5525211">&amp;</span><span class="ident" id="5525212">response</span><span class="op" id="5525220">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525224">req</span><span class="op" id="5525227">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525232">req</span><span class="op" id="5525235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525239">header</span><span class="op" id="5525245">:</span>&nbsp;<span class="builtinfunc" id="5525247">make</span><span class="op" id="5525251">(</span><span class="ident" id="5525252">http</span><span class="op" id="5525256">.</span><span class="ident" id="5525257">Header</span><span class="op" id="5525263">)</span><span class="op" id="5525264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525268">bufw</span><span class="op" id="5525272">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5525276">bufio</span><span class="op" id="5525281">.</span><span class="ident" id="5525282">NewWriter</span><span class="op" id="5525291">(</span><span class="ident" id="5525292">os</span><span class="op" id="5525294">.</span><span class="ident" id="5525295">Stdout</span><span class="op" id="5525301">)</span><span class="op" id="5525302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525308">handler</span><span class="op" id="5525315">.</span><span class="ident" id="5525316">ServeHTTP</span><span class="op" id="5525325">(</span><span class="ident" id="5525326">rw</span><span class="op" id="5525328">,</span>&nbsp;<span class="ident" id="5525330">req</span><span class="op" id="5525333">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525336">rw</span><span class="op" id="5525338">.</span><span class="ident" id="5525339">Write</span><span class="op" id="5525344">(</span><span class="ident" id="5525345">nil</span><span class="op" id="5525348">)</span>&nbsp;<span class="comment" id="5525350">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525383">if</span>&nbsp;<span class="ident" id="5525386">err</span>&nbsp;<span class="op" id="5525390">=</span>&nbsp;<span class="ident" id="5525392">rw</span><span class="op" id="5525394">.</span><span class="ident" id="5525395">bufw</span><span class="op" id="5525399">.</span><span class="ident" id="5525400">Flush</span><span class="op" id="5525405">(</span><span class="op" id="5525406">)</span><span class="op" id="5525407">;</span>&nbsp;<span class="ident" id="5525409">err</span>&nbsp;<span class="op" id="5525413">!=</span>&nbsp;<span class="ident" id="5525416">nil</span>&nbsp;<span class="op" id="5525420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525424">return</span>&nbsp;<span class="ident" id="5525431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525439">return</span>&nbsp;<span class="ident" id="5525446">nil</span><br>
<span class="lineno">165</span><span class="op" id="5525450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525453">type</span>&nbsp;<span class="ident" id="5525458">response</span>&nbsp;<span class="keyword" id="5525467">struct</span>&nbsp;<span class="op" id="5525474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525477">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525488">*</span><span class="ident" id="5525489">http</span><span class="op" id="5525493">.</span><span class="ident" id="5525494">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525503">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525514">http</span><span class="op" id="5525518">.</span><span class="ident" id="5525519">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525527">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525538">*</span><span class="ident" id="5525539">bufio</span><span class="op" id="5525544">.</span><span class="ident" id="5525545">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525553">headerSent</span>&nbsp;<span class="builtintype" id="5525564">bool</span><br>
<span class="lineno"></span><span class="op" id="5525569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525572">func</span>&nbsp;<span class="op" id="5525577">(</span><span class="ident" id="5525578">r</span>&nbsp;<span class="op" id="5525580">*</span><span class="ident" id="5525581">response</span><span class="op" id="5525589">)</span>&nbsp;<span class="ident" id="5525591">Flush</span><span class="op" id="5525596">(</span><span class="op" id="5525597">)</span>&nbsp;<span class="op" id="5525599">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525602">r</span><span class="op" id="5525603">.</span><span class="ident" id="5525604">bufw</span><span class="op" id="5525608">.</span><span class="ident" id="5525609">Flush</span><span class="op" id="5525614">(</span><span class="op" id="5525615">)</span><br>
<span class="lineno"></span><span class="op" id="5525617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525620">func</span>&nbsp;<span class="op" id="5525625">(</span><span class="ident" id="5525626">r</span>&nbsp;<span class="op" id="5525628">*</span><span class="ident" id="5525629">response</span><span class="op" id="5525637">)</span>&nbsp;<span class="ident" id="5525639">Header</span><span class="op" id="5525645">(</span><span class="op" id="5525646">)</span>&nbsp;<span class="ident" id="5525648">http</span><span class="op" id="5525652">.</span><span class="ident" id="5525653">Header</span>&nbsp;<span class="op" id="5525660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525663">return</span>&nbsp;<span class="ident" id="5525670">r</span><span class="op" id="5525671">.</span><span class="ident" id="5525672">header</span><br>
<span class="lineno">180</span><span class="op" id="5525679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525682">func</span>&nbsp;<span class="op" id="5525687">(</span><span class="ident" id="5525688">r</span>&nbsp;<span class="op" id="5525690">*</span><span class="ident" id="5525691">response</span><span class="op" id="5525699">)</span>&nbsp;<span class="ident" id="5525701">Write</span><span class="op" id="5525706">(</span><span class="ident" id="5525707">p</span>&nbsp;<span class="op" id="5525709">[</span><span class="op" id="5525710">]</span><span class="builtintype" id="5525711">byte</span><span class="op" id="5525715">)</span>&nbsp;<span class="op" id="5525717">(</span><span class="ident" id="5525718">n</span>&nbsp;<span class="builtintype" id="5525720">int</span><span class="op" id="5525723">,</span>&nbsp;<span class="ident" id="5525725">err</span>&nbsp;<span class="builtintype" id="5525729">error</span><span class="op" id="5525734">)</span>&nbsp;<span class="op" id="5525736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525739">if</span>&nbsp;<span class="op" id="5525742">!</span><span class="ident" id="5525743">r</span><span class="op" id="5525744">.</span><span class="ident" id="5525745">headerSent</span>&nbsp;<span class="op" id="5525756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525760">r</span><span class="op" id="5525761">.</span><span class="ident" id="5525762">WriteHeader</span><span class="op" id="5525773">(</span><span class="ident" id="5525774">http</span><span class="op" id="5525778">.</span><span class="ident" id="5525779">StatusOK</span><span class="op" id="5525787">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5525790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525793">return</span>&nbsp;<span class="ident" id="5525800">r</span><span class="op" id="5525801">.</span><span class="ident" id="5525802">bufw</span><span class="op" id="5525806">.</span><span class="ident" id="5525807">Write</span><span class="op" id="5525812">(</span><span class="ident" id="5525813">p</span><span class="op" id="5525814">)</span><br>
<span class="lineno"></span><span class="op" id="5525816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525819">func</span>&nbsp;<span class="op" id="5525824">(</span><span class="ident" id="5525825">r</span>&nbsp;<span class="op" id="5525827">*</span><span class="ident" id="5525828">response</span><span class="op" id="5525836">)</span>&nbsp;<span class="ident" id="5525838">WriteHeader</span><span class="op" id="5525849">(</span><span class="ident" id="5525850">code</span>&nbsp;<span class="builtintype" id="5525855">int</span><span class="op" id="5525858">)</span>&nbsp;<span class="op" id="5525860">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525863">if</span>&nbsp;<span class="ident" id="5525866">r</span><span class="op" id="5525867">.</span><span class="ident" id="5525868">headerSent</span>&nbsp;<span class="op" id="5525879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5525883">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5525949">fmt</span><span class="op" id="5525952">.</span><span class="ident" id="5525953">Fprintf</span><span class="op" id="5525960">(</span><span class="ident" id="5525961">os</span><span class="op" id="5525963">.</span><span class="ident" id="5525964">Stderr</span><span class="op" id="5525970">,</span>&nbsp;<span class="string" id="5525972">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5526027">,</span>&nbsp;<span class="ident" id="5526029">r</span><span class="op" id="5526030">.</span><span class="ident" id="5526031">req</span><span class="op" id="5526034">.</span><span class="ident" id="5526035">URL</span><span class="op" id="5526038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5526042">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5526050">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526053">r</span><span class="op" id="5526054">.</span><span class="ident" id="5526055">headerSent</span>&nbsp;<span class="op" id="5526066">=</span>&nbsp;<span class="builtintype" id="5526068">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526074">fmt</span><span class="op" id="5526077">.</span><span class="ident" id="5526078">Fprintf</span><span class="op" id="5526085">(</span><span class="ident" id="5526086">r</span><span class="op" id="5526087">.</span><span class="ident" id="5526088">bufw</span><span class="op" id="5526092">,</span>&nbsp;<span class="string" id="5526094">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5526113">,</span>&nbsp;<span class="ident" id="5526115">code</span><span class="op" id="5526119">,</span>&nbsp;<span class="ident" id="5526121">http</span><span class="op" id="5526125">.</span><span class="ident" id="5526126">StatusText</span><span class="op" id="5526136">(</span><span class="ident" id="5526137">code</span><span class="op" id="5526141">)</span><span class="op" id="5526142">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5526146">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5526177">if</span>&nbsp;<span class="ident" id="5526180">_</span><span class="op" id="5526181">,</span>&nbsp;<span class="ident" id="5526183">hasType</span>&nbsp;<span class="op" id="5526191">:=</span>&nbsp;<span class="ident" id="5526194">r</span><span class="op" id="5526195">.</span><span class="ident" id="5526196">header</span><span class="op" id="5526202">[</span><span class="string" id="5526203">&#34;Content-Type&#34;</span><span class="op" id="5526217">]</span><span class="op" id="5526218">;</span>&nbsp;<span class="op" id="5526220">!</span><span class="ident" id="5526221">hasType</span>&nbsp;<span class="op" id="5526229">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526233">r</span><span class="op" id="5526234">.</span><span class="ident" id="5526235">header</span><span class="op" id="5526241">.</span><span class="ident" id="5526242">Add</span><span class="op" id="5526245">(</span><span class="string" id="5526246">&#34;Content-Type&#34;</span><span class="op" id="5526260">,</span>&nbsp;<span class="string" id="5526262">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5526288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5526291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526295">r</span><span class="op" id="5526296">.</span><span class="ident" id="5526297">header</span><span class="op" id="5526303">.</span><span class="ident" id="5526304">Write</span><span class="op" id="5526309">(</span><span class="ident" id="5526310">r</span><span class="op" id="5526311">.</span><span class="ident" id="5526312">bufw</span><span class="op" id="5526316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526319">r</span><span class="op" id="5526320">.</span><span class="ident" id="5526321">bufw</span><span class="op" id="5526325">.</span><span class="ident" id="5526326">WriteString</span><span class="op" id="5526337">(</span><span class="string" id="5526338">&#34;\r\n&#34;</span><span class="op" id="5526344">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5526347">r</span><span class="op" id="5526348">.</span><span class="ident" id="5526349">bufw</span><span class="op" id="5526353">.</span><span class="ident" id="5526354">Flush</span><span class="op" id="5526359">(</span><span class="op" id="5526360">)</span><br>
<span class="lineno"></span><span class="op" id="5526362">}</span>
</div>
</body>
</html>
