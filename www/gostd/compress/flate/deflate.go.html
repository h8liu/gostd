<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html" class="current">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4659747">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4659802">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4659856">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4659907">package</span>&nbsp;<span class="ident" id="4659915">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4659922">import</span>&nbsp;<span class="op" id="4659929">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4659932">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4659939">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4659945">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4659952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4659955">const</span>&nbsp;<span class="op" id="4659961">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4659964">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4659983">=</span>&nbsp;<span class="num" id="4659985">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4659988">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660007">=</span>&nbsp;<span class="num" id="4660009">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660012">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660031">=</span>&nbsp;<span class="num" id="4660033">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660036">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660055">=</span>&nbsp;<span class="num" id="4660057">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660060">DefaultCompression</span>&nbsp;<span class="op" id="4660079">=</span>&nbsp;<span class="op" id="4660081">-</span><span class="num" id="4660082">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660085">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660104">=</span>&nbsp;<span class="num" id="4660106">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660110">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660129">=</span>&nbsp;<span class="num" id="4660131">1</span>&nbsp;<span class="op" id="4660133">&lt;&lt;</span>&nbsp;<span class="ident" id="4660136">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660151">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660170">=</span>&nbsp;<span class="ident" id="4660172">windowSize</span>&nbsp;<span class="op" id="4660183">-</span>&nbsp;<span class="num" id="4660185">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660188">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4660207">=</span>&nbsp;<span class="num" id="4660209">15</span>&nbsp;&nbsp;<span class="comment" id="4660213">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660234">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660253">=</span>&nbsp;<span class="num" id="4660255">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4660259">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660312">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660331">=</span>&nbsp;<span class="num" id="4660333">258</span>&nbsp;<span class="comment" id="4660337">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660378">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660397">=</span>&nbsp;<span class="num" id="4660399">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4660403">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4660449">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4660524">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660564">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4660584">=</span>&nbsp;<span class="num" id="4660586">1</span>&nbsp;<span class="op" id="4660588">&lt;&lt;</span>&nbsp;<span class="num" id="4660591">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660595">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4660615">=</span>&nbsp;<span class="num" id="4660617">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660624">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660644">=</span>&nbsp;<span class="num" id="4660646">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660650">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660670">=</span>&nbsp;<span class="num" id="4660672">1</span>&nbsp;<span class="op" id="4660674">&lt;&lt;</span>&nbsp;<span class="ident" id="4660677">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660687">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660707">=</span>&nbsp;<span class="op" id="4660709">(</span><span class="num" id="4660710">1</span>&nbsp;<span class="op" id="4660712">&lt;&lt;</span>&nbsp;<span class="ident" id="4660715">hashBits</span><span class="op" id="4660723">)</span>&nbsp;<span class="op" id="4660725">-</span>&nbsp;<span class="num" id="4660727">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660730">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660750">=</span>&nbsp;<span class="op" id="4660752">(</span><span class="ident" id="4660753">hashBits</span>&nbsp;<span class="op" id="4660762">+</span>&nbsp;<span class="ident" id="4660764">minMatchLength</span>&nbsp;<span class="op" id="4660779">-</span>&nbsp;<span class="num" id="4660781">1</span><span class="op" id="4660782">)</span>&nbsp;<span class="op" id="4660784">/</span>&nbsp;<span class="ident" id="4660786">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660802">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660822">=</span>&nbsp;<span class="num" id="4660824">1</span>&nbsp;<span class="op" id="4660826">&lt;&lt;</span>&nbsp;<span class="num" id="4660829">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660834">skipNever</span>&nbsp;<span class="op" id="4660844">=</span>&nbsp;<span class="ident" id="4660846">math</span><span class="op" id="4660850">.</span><span class="ident" id="4660851">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4660860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4660863">type</span>&nbsp;<span class="ident" id="4660868">compressionLevel</span>&nbsp;<span class="keyword" id="4660885">struct</span>&nbsp;<span class="op" id="4660892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4660895">good</span><span class="op" id="4660899">,</span>&nbsp;<span class="ident" id="4660901">lazy</span><span class="op" id="4660905">,</span>&nbsp;<span class="ident" id="4660907">nice</span><span class="op" id="4660911">,</span>&nbsp;<span class="ident" id="4660913">chain</span><span class="op" id="4660918">,</span>&nbsp;<span class="ident" id="4660920">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4660936">int</span><br>
<span class="lineno"></span><span class="op" id="4660940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4660943">var</span>&nbsp;<span class="ident" id="4660947">levels</span>&nbsp;<span class="op" id="4660954">=</span>&nbsp;<span class="op" id="4660956">[</span><span class="op" id="4660957">]</span><span class="ident" id="4660958">compressionLevel</span><span class="op" id="4660974">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4660977">{</span><span class="op" id="4660978">}</span><span class="op" id="4660979">,</span>&nbsp;<span class="comment" id="4660981">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4660987">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661047">{</span><span class="num" id="4661048">3</span><span class="op" id="4661049">,</span>&nbsp;<span class="num" id="4661051">0</span><span class="op" id="4661052">,</span>&nbsp;<span class="num" id="4661054">8</span><span class="op" id="4661055">,</span>&nbsp;<span class="num" id="4661057">4</span><span class="op" id="4661058">,</span>&nbsp;<span class="num" id="4661060">4</span><span class="op" id="4661061">}</span><span class="op" id="4661062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661065">{</span><span class="num" id="4661066">3</span><span class="op" id="4661067">,</span>&nbsp;<span class="num" id="4661069">0</span><span class="op" id="4661070">,</span>&nbsp;<span class="num" id="4661072">16</span><span class="op" id="4661074">,</span>&nbsp;<span class="num" id="4661076">8</span><span class="op" id="4661077">,</span>&nbsp;<span class="num" id="4661079">5</span><span class="op" id="4661080">}</span><span class="op" id="4661081">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661084">{</span><span class="num" id="4661085">3</span><span class="op" id="4661086">,</span>&nbsp;<span class="num" id="4661088">0</span><span class="op" id="4661089">,</span>&nbsp;<span class="num" id="4661091">32</span><span class="op" id="4661093">,</span>&nbsp;<span class="num" id="4661095">32</span><span class="op" id="4661097">,</span>&nbsp;<span class="num" id="4661099">6</span><span class="op" id="4661100">}</span><span class="op" id="4661101">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661104">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661155">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661216">{</span><span class="num" id="4661217">4</span><span class="op" id="4661218">,</span>&nbsp;<span class="num" id="4661220">4</span><span class="op" id="4661221">,</span>&nbsp;<span class="num" id="4661223">16</span><span class="op" id="4661225">,</span>&nbsp;<span class="num" id="4661227">16</span><span class="op" id="4661229">,</span>&nbsp;<span class="ident" id="4661231">skipNever</span><span class="op" id="4661240">}</span><span class="op" id="4661241">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661244">{</span><span class="num" id="4661245">8</span><span class="op" id="4661246">,</span>&nbsp;<span class="num" id="4661248">16</span><span class="op" id="4661250">,</span>&nbsp;<span class="num" id="4661252">32</span><span class="op" id="4661254">,</span>&nbsp;<span class="num" id="4661256">32</span><span class="op" id="4661258">,</span>&nbsp;<span class="ident" id="4661260">skipNever</span><span class="op" id="4661269">}</span><span class="op" id="4661270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661273">{</span><span class="num" id="4661274">8</span><span class="op" id="4661275">,</span>&nbsp;<span class="num" id="4661277">16</span><span class="op" id="4661279">,</span>&nbsp;<span class="num" id="4661281">128</span><span class="op" id="4661284">,</span>&nbsp;<span class="num" id="4661286">128</span><span class="op" id="4661289">,</span>&nbsp;<span class="ident" id="4661291">skipNever</span><span class="op" id="4661300">}</span><span class="op" id="4661301">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661304">{</span><span class="num" id="4661305">8</span><span class="op" id="4661306">,</span>&nbsp;<span class="num" id="4661308">32</span><span class="op" id="4661310">,</span>&nbsp;<span class="num" id="4661312">128</span><span class="op" id="4661315">,</span>&nbsp;<span class="num" id="4661317">256</span><span class="op" id="4661320">,</span>&nbsp;<span class="ident" id="4661322">skipNever</span><span class="op" id="4661331">}</span><span class="op" id="4661332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661335">{</span><span class="num" id="4661336">32</span><span class="op" id="4661338">,</span>&nbsp;<span class="num" id="4661340">128</span><span class="op" id="4661343">,</span>&nbsp;<span class="num" id="4661345">258</span><span class="op" id="4661348">,</span>&nbsp;<span class="num" id="4661350">1024</span><span class="op" id="4661354">,</span>&nbsp;<span class="ident" id="4661356">skipNever</span><span class="op" id="4661365">}</span><span class="op" id="4661366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4661369">{</span><span class="num" id="4661370">32</span><span class="op" id="4661372">,</span>&nbsp;<span class="num" id="4661374">258</span><span class="op" id="4661377">,</span>&nbsp;<span class="num" id="4661379">258</span><span class="op" id="4661382">,</span>&nbsp;<span class="num" id="4661384">4096</span><span class="op" id="4661388">,</span>&nbsp;<span class="ident" id="4661390">skipNever</span><span class="op" id="4661399">}</span><span class="op" id="4661400">,</span><br>
<span class="lineno"></span><span class="op" id="4661402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4661405">type</span>&nbsp;<span class="ident" id="4661410">compressor</span>&nbsp;<span class="keyword" id="4661421">struct</span>&nbsp;<span class="op" id="4661428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661431">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661450">w</span>&nbsp;<span class="op" id="4661452">*</span><span class="ident" id="4661453">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661472">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661498">fill</span>&nbsp;<span class="keyword" id="4661503">func</span><span class="op" id="4661507">(</span><span class="op" id="4661508">*</span><span class="ident" id="4661509">compressor</span><span class="op" id="4661519">,</span>&nbsp;<span class="op" id="4661521">[</span><span class="op" id="4661522">]</span><span class="builtintype" id="4661523">byte</span><span class="op" id="4661527">)</span>&nbsp;<span class="builtintype" id="4661529">int</span>&nbsp;<span class="comment" id="4661533">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661557">step</span>&nbsp;<span class="keyword" id="4661562">func</span><span class="op" id="4661566">(</span><span class="op" id="4661567">*</span><span class="ident" id="4661568">compressor</span><span class="op" id="4661578">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661592">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661611">sync</span>&nbsp;<span class="builtintype" id="4661616">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661646">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661668">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661690">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661776">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661838">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4661913">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661943">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4661954">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661959">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4661970">[</span><span class="op" id="4661971">]</span><span class="builtintype" id="4661972">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661977">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4661988">[</span><span class="op" id="4661989">]</span><span class="builtintype" id="4661990">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4661995">hashOffset</span>&nbsp;<span class="builtintype" id="4662006">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4662012">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662074">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662088">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662093">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4662107">[</span><span class="op" id="4662108">]</span><span class="builtintype" id="4662109">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662115">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662129">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662134">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662148">int</span>&nbsp;&nbsp;<span class="comment" id="4662153">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662197">byteAvailable</span>&nbsp;<span class="builtintype" id="4662211">bool</span>&nbsp;<span class="comment" id="4662216">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4662269">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662294">tokens</span>&nbsp;<span class="op" id="4662301">[</span><span class="op" id="4662302">]</span><span class="ident" id="4662303">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4662311">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662329">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662344">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662349">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662364">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662369">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662384">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662389">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4662404">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662409">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4662424">error</span><br>
<span class="lineno"></span><span class="op" id="4662430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4662433">func</span>&nbsp;<span class="op" id="4662438">(</span><span class="ident" id="4662439">d</span>&nbsp;<span class="op" id="4662441">*</span><span class="ident" id="4662442">compressor</span><span class="op" id="4662452">)</span>&nbsp;<span class="ident" id="4662454">fillDeflate</span><span class="op" id="4662465">(</span><span class="ident" id="4662466">b</span>&nbsp;<span class="op" id="4662468">[</span><span class="op" id="4662469">]</span><span class="builtintype" id="4662470">byte</span><span class="op" id="4662474">)</span>&nbsp;<span class="builtintype" id="4662476">int</span>&nbsp;<span class="op" id="4662480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4662483">if</span>&nbsp;<span class="ident" id="4662486">d</span><span class="op" id="4662487">.</span><span class="ident" id="4662488">index</span>&nbsp;<span class="op" id="4662494">&gt;=</span>&nbsp;<span class="num" id="4662497">2</span><span class="op" id="4662498">*</span><span class="ident" id="4662499">windowSize</span><span class="op" id="4662509">-</span><span class="op" id="4662510">(</span><span class="ident" id="4662511">minMatchLength</span><span class="op" id="4662525">+</span><span class="ident" id="4662526">maxMatchLength</span><span class="op" id="4662540">)</span>&nbsp;<span class="op" id="4662542">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4662546">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4662582">copy</span><span class="op" id="4662586">(</span><span class="ident" id="4662587">d</span><span class="op" id="4662588">.</span><span class="ident" id="4662589">window</span><span class="op" id="4662595">,</span>&nbsp;<span class="ident" id="4662597">d</span><span class="op" id="4662598">.</span><span class="ident" id="4662599">window</span><span class="op" id="4662605">[</span><span class="ident" id="4662606">windowSize</span><span class="op" id="4662616">:</span><span class="num" id="4662617">2</span><span class="op" id="4662618">*</span><span class="ident" id="4662619">windowSize</span><span class="op" id="4662629">]</span><span class="op" id="4662630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662634">d</span><span class="op" id="4662635">.</span><span class="ident" id="4662636">index</span>&nbsp;<span class="op" id="4662642">-=</span>&nbsp;<span class="ident" id="4662645">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662658">d</span><span class="op" id="4662659">.</span><span class="ident" id="4662660">windowEnd</span>&nbsp;<span class="op" id="4662670">-=</span>&nbsp;<span class="ident" id="4662673">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4662686">if</span>&nbsp;<span class="ident" id="4662689">d</span><span class="op" id="4662690">.</span><span class="ident" id="4662691">blockStart</span>&nbsp;<span class="op" id="4662702">&gt;=</span>&nbsp;<span class="ident" id="4662705">windowSize</span>&nbsp;<span class="op" id="4662716">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662721">d</span><span class="op" id="4662722">.</span><span class="ident" id="4662723">blockStart</span>&nbsp;<span class="op" id="4662734">-=</span>&nbsp;<span class="ident" id="4662737">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4662750">}</span>&nbsp;<span class="keyword" id="4662752">else</span>&nbsp;<span class="op" id="4662757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662762">d</span><span class="op" id="4662763">.</span><span class="ident" id="4662764">blockStart</span>&nbsp;<span class="op" id="4662775">=</span>&nbsp;<span class="ident" id="4662777">math</span><span class="op" id="4662781">.</span><span class="ident" id="4662782">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4662793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662797">d</span><span class="op" id="4662798">.</span><span class="ident" id="4662799">hashOffset</span>&nbsp;<span class="op" id="4662810">+=</span>&nbsp;<span class="ident" id="4662813">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4662826">if</span>&nbsp;<span class="ident" id="4662829">d</span><span class="op" id="4662830">.</span><span class="ident" id="4662831">hashOffset</span>&nbsp;<span class="op" id="4662842">&gt;</span>&nbsp;<span class="ident" id="4662844">maxHashOffset</span>&nbsp;<span class="op" id="4662858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662863">delta</span>&nbsp;<span class="op" id="4662869">:=</span>&nbsp;<span class="ident" id="4662872">d</span><span class="op" id="4662873">.</span><span class="ident" id="4662874">hashOffset</span>&nbsp;<span class="op" id="4662885">-</span>&nbsp;<span class="num" id="4662887">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662892">d</span><span class="op" id="4662893">.</span><span class="ident" id="4662894">hashOffset</span>&nbsp;<span class="op" id="4662905">-=</span>&nbsp;<span class="ident" id="4662908">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662917">d</span><span class="op" id="4662918">.</span><span class="ident" id="4662919">chainHead</span>&nbsp;<span class="op" id="4662929">-=</span>&nbsp;<span class="ident" id="4662932">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4662941">for</span>&nbsp;<span class="ident" id="4662945">i</span><span class="op" id="4662946">,</span>&nbsp;<span class="ident" id="4662948">v</span>&nbsp;<span class="op" id="4662950">:=</span>&nbsp;<span class="keyword" id="4662953">range</span>&nbsp;<span class="ident" id="4662959">d</span><span class="op" id="4662960">.</span><span class="ident" id="4662961">hashPrev</span>&nbsp;<span class="op" id="4662970">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4662976">if</span>&nbsp;<span class="ident" id="4662979">v</span>&nbsp;<span class="op" id="4662981">&gt;</span>&nbsp;<span class="ident" id="4662983">delta</span>&nbsp;<span class="op" id="4662989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4662996">d</span><span class="op" id="4662997">.</span><span class="ident" id="4662998">hashPrev</span><span class="op" id="4663006">[</span><span class="ident" id="4663007">i</span><span class="op" id="4663008">]</span>&nbsp;<span class="op" id="4663010">-=</span>&nbsp;<span class="ident" id="4663013">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663023">}</span>&nbsp;<span class="keyword" id="4663025">else</span>&nbsp;<span class="op" id="4663030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663037">d</span><span class="op" id="4663038">.</span><span class="ident" id="4663039">hashPrev</span><span class="op" id="4663047">[</span><span class="ident" id="4663048">i</span><span class="op" id="4663049">]</span>&nbsp;<span class="op" id="4663051">=</span>&nbsp;<span class="num" id="4663053">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663059">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663069">for</span>&nbsp;<span class="ident" id="4663073">i</span><span class="op" id="4663074">,</span>&nbsp;<span class="ident" id="4663076">v</span>&nbsp;<span class="op" id="4663078">:=</span>&nbsp;<span class="keyword" id="4663081">range</span>&nbsp;<span class="ident" id="4663087">d</span><span class="op" id="4663088">.</span><span class="ident" id="4663089">hashHead</span>&nbsp;<span class="op" id="4663098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663104">if</span>&nbsp;<span class="ident" id="4663107">v</span>&nbsp;<span class="op" id="4663109">&gt;</span>&nbsp;<span class="ident" id="4663111">delta</span>&nbsp;<span class="op" id="4663117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663124">d</span><span class="op" id="4663125">.</span><span class="ident" id="4663126">hashHead</span><span class="op" id="4663134">[</span><span class="ident" id="4663135">i</span><span class="op" id="4663136">]</span>&nbsp;<span class="op" id="4663138">-=</span>&nbsp;<span class="ident" id="4663141">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663151">}</span>&nbsp;<span class="keyword" id="4663153">else</span>&nbsp;<span class="op" id="4663158">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663165">d</span><span class="op" id="4663166">.</span><span class="ident" id="4663167">hashHead</span><span class="op" id="4663175">[</span><span class="ident" id="4663176">i</span><span class="op" id="4663177">]</span>&nbsp;<span class="op" id="4663179">=</span>&nbsp;<span class="num" id="4663181">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663199">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663202">n</span>&nbsp;<span class="op" id="4663204">:=</span>&nbsp;<span class="builtinfunc" id="4663207">copy</span><span class="op" id="4663211">(</span><span class="ident" id="4663212">d</span><span class="op" id="4663213">.</span><span class="ident" id="4663214">window</span><span class="op" id="4663220">[</span><span class="ident" id="4663221">d</span><span class="op" id="4663222">.</span><span class="ident" id="4663223">windowEnd</span><span class="op" id="4663232">:</span><span class="op" id="4663233">]</span><span class="op" id="4663234">,</span>&nbsp;<span class="ident" id="4663236">b</span><span class="op" id="4663237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663240">d</span><span class="op" id="4663241">.</span><span class="ident" id="4663242">windowEnd</span>&nbsp;<span class="op" id="4663252">+=</span>&nbsp;<span class="ident" id="4663255">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663258">return</span>&nbsp;<span class="ident" id="4663265">n</span><br>
<span class="lineno"></span><span class="op" id="4663267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4663270">func</span>&nbsp;<span class="op" id="4663275">(</span><span class="ident" id="4663276">d</span>&nbsp;<span class="op" id="4663278">*</span><span class="ident" id="4663279">compressor</span><span class="op" id="4663289">)</span>&nbsp;<span class="ident" id="4663291">writeBlock</span><span class="op" id="4663301">(</span><span class="ident" id="4663302">tokens</span>&nbsp;<span class="op" id="4663309">[</span><span class="op" id="4663310">]</span><span class="ident" id="4663311">token</span><span class="op" id="4663316">,</span>&nbsp;<span class="ident" id="4663318">index</span>&nbsp;<span class="builtintype" id="4663324">int</span><span class="op" id="4663327">,</span>&nbsp;<span class="ident" id="4663329">eof</span>&nbsp;<span class="builtintype" id="4663333">bool</span><span class="op" id="4663337">)</span>&nbsp;<span class="builtintype" id="4663339">error</span>&nbsp;<span class="op" id="4663345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663348">if</span>&nbsp;<span class="ident" id="4663351">index</span>&nbsp;<span class="op" id="4663357">&gt;</span>&nbsp;<span class="num" id="4663359">0</span>&nbsp;<span class="op" id="4663361">||</span>&nbsp;<span class="ident" id="4663364">eof</span>&nbsp;<span class="op" id="4663368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663372">var</span>&nbsp;<span class="ident" id="4663376">window</span>&nbsp;<span class="op" id="4663383">[</span><span class="op" id="4663384">]</span><span class="builtintype" id="4663385">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663392">if</span>&nbsp;<span class="ident" id="4663395">d</span><span class="op" id="4663396">.</span><span class="ident" id="4663397">blockStart</span>&nbsp;<span class="op" id="4663408">&lt;=</span>&nbsp;<span class="ident" id="4663411">index</span>&nbsp;<span class="op" id="4663417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663422">window</span>&nbsp;<span class="op" id="4663429">=</span>&nbsp;<span class="ident" id="4663431">d</span><span class="op" id="4663432">.</span><span class="ident" id="4663433">window</span><span class="op" id="4663439">[</span><span class="ident" id="4663440">d</span><span class="op" id="4663441">.</span><span class="ident" id="4663442">blockStart</span><span class="op" id="4663452">:</span><span class="ident" id="4663453">index</span><span class="op" id="4663458">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663466">d</span><span class="op" id="4663467">.</span><span class="ident" id="4663468">blockStart</span>&nbsp;<span class="op" id="4663479">=</span>&nbsp;<span class="ident" id="4663481">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663489">d</span><span class="op" id="4663490">.</span><span class="ident" id="4663491">w</span><span class="op" id="4663492">.</span><span class="ident" id="4663493">writeBlock</span><span class="op" id="4663503">(</span><span class="ident" id="4663504">tokens</span><span class="op" id="4663510">,</span>&nbsp;<span class="ident" id="4663512">eof</span><span class="op" id="4663515">,</span>&nbsp;<span class="ident" id="4663517">window</span><span class="op" id="4663523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663527">return</span>&nbsp;<span class="ident" id="4663534">d</span><span class="op" id="4663535">.</span><span class="ident" id="4663536">w</span><span class="op" id="4663537">.</span><span class="ident" id="4663538">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663543">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663546">return</span>&nbsp;<span class="builtintype" id="4663553">nil</span><br>
<span class="lineno"></span><span class="op" id="4663557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4663560">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4663640">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4663702">func</span>&nbsp;<span class="op" id="4663707">(</span><span class="ident" id="4663708">d</span>&nbsp;<span class="op" id="4663710">*</span><span class="ident" id="4663711">compressor</span><span class="op" id="4663721">)</span>&nbsp;<span class="ident" id="4663723">findMatch</span><span class="op" id="4663732">(</span><span class="ident" id="4663733">pos</span>&nbsp;<span class="builtintype" id="4663737">int</span><span class="op" id="4663740">,</span>&nbsp;<span class="ident" id="4663742">prevHead</span>&nbsp;<span class="builtintype" id="4663751">int</span><span class="op" id="4663754">,</span>&nbsp;<span class="ident" id="4663756">prevLength</span>&nbsp;<span class="builtintype" id="4663767">int</span><span class="op" id="4663770">,</span>&nbsp;<span class="ident" id="4663772">lookahead</span>&nbsp;<span class="builtintype" id="4663782">int</span><span class="op" id="4663785">)</span>&nbsp;<span class="op" id="4663787">(</span><span class="ident" id="4663788">length</span><span class="op" id="4663794">,</span>&nbsp;<span class="ident" id="4663796">offset</span>&nbsp;<span class="builtintype" id="4663803">int</span><span class="op" id="4663806">,</span>&nbsp;<span class="ident" id="4663808">ok</span>&nbsp;<span class="builtintype" id="4663811">bool</span><span class="op" id="4663815">)</span>&nbsp;<span class="op" id="4663817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663820">minMatchLook</span>&nbsp;<span class="op" id="4663833">:=</span>&nbsp;<span class="ident" id="4663836">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4663852">if</span>&nbsp;<span class="ident" id="4663855">lookahead</span>&nbsp;<span class="op" id="4663865">&lt;</span>&nbsp;<span class="ident" id="4663867">minMatchLook</span>&nbsp;<span class="op" id="4663880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663884">minMatchLook</span>&nbsp;<span class="op" id="4663897">=</span>&nbsp;<span class="ident" id="4663899">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4663910">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4663914">win</span>&nbsp;<span class="op" id="4663918">:=</span>&nbsp;<span class="ident" id="4663921">d</span><span class="op" id="4663922">.</span><span class="ident" id="4663923">window</span><span class="op" id="4663929">[</span><span class="num" id="4663930">0</span>&nbsp;<span class="op" id="4663932">:</span>&nbsp;<span class="ident" id="4663934">pos</span><span class="op" id="4663937">+</span><span class="ident" id="4663938">minMatchLook</span><span class="op" id="4663950">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4663954">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664012">nice</span>&nbsp;<span class="op" id="4664017">:=</span>&nbsp;<span class="builtinfunc" id="4664020">len</span><span class="op" id="4664023">(</span><span class="ident" id="4664024">win</span><span class="op" id="4664027">)</span>&nbsp;<span class="op" id="4664029">-</span>&nbsp;<span class="ident" id="4664031">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664036">if</span>&nbsp;<span class="ident" id="4664039">d</span><span class="op" id="4664040">.</span><span class="ident" id="4664041">nice</span>&nbsp;<span class="op" id="4664046">&lt;</span>&nbsp;<span class="ident" id="4664048">nice</span>&nbsp;<span class="op" id="4664053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664057">nice</span>&nbsp;<span class="op" id="4664062">=</span>&nbsp;<span class="ident" id="4664064">d</span><span class="op" id="4664065">.</span><span class="ident" id="4664066">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4664076">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664149">tries</span>&nbsp;<span class="op" id="4664155">:=</span>&nbsp;<span class="ident" id="4664158">d</span><span class="op" id="4664159">.</span><span class="ident" id="4664160">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664167">length</span>&nbsp;<span class="op" id="4664174">=</span>&nbsp;<span class="ident" id="4664176">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664188">if</span>&nbsp;<span class="ident" id="4664191">length</span>&nbsp;<span class="op" id="4664198">&gt;=</span>&nbsp;<span class="ident" id="4664201">d</span><span class="op" id="4664202">.</span><span class="ident" id="4664203">good</span>&nbsp;<span class="op" id="4664208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664212">tries</span>&nbsp;<span class="op" id="4664218">&gt;&gt;=</span>&nbsp;<span class="num" id="4664222">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664225">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664229">w0</span>&nbsp;<span class="op" id="4664232">:=</span>&nbsp;<span class="ident" id="4664235">win</span><span class="op" id="4664238">[</span><span class="ident" id="4664239">pos</span><span class="op" id="4664242">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664245">w1</span>&nbsp;<span class="op" id="4664248">:=</span>&nbsp;<span class="ident" id="4664251">win</span><span class="op" id="4664254">[</span><span class="ident" id="4664255">pos</span><span class="op" id="4664258">+</span><span class="num" id="4664259">1</span><span class="op" id="4664260">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664263">wEnd</span>&nbsp;<span class="op" id="4664268">:=</span>&nbsp;<span class="ident" id="4664271">win</span><span class="op" id="4664274">[</span><span class="ident" id="4664275">pos</span><span class="op" id="4664278">+</span><span class="ident" id="4664279">length</span><span class="op" id="4664285">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664288">minIndex</span>&nbsp;<span class="op" id="4664297">:=</span>&nbsp;<span class="ident" id="4664300">pos</span>&nbsp;<span class="op" id="4664304">-</span>&nbsp;<span class="ident" id="4664306">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664319">for</span>&nbsp;<span class="ident" id="4664323">i</span>&nbsp;<span class="op" id="4664325">:=</span>&nbsp;<span class="ident" id="4664328">prevHead</span><span class="op" id="4664336">;</span>&nbsp;<span class="ident" id="4664338">tries</span>&nbsp;<span class="op" id="4664344">&gt;</span>&nbsp;<span class="num" id="4664346">0</span><span class="op" id="4664347">;</span>&nbsp;<span class="ident" id="4664349">tries</span><span class="op" id="4664354">--</span>&nbsp;<span class="op" id="4664357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664361">if</span>&nbsp;<span class="ident" id="4664364">w0</span>&nbsp;<span class="op" id="4664367">==</span>&nbsp;<span class="ident" id="4664370">win</span><span class="op" id="4664373">[</span><span class="ident" id="4664374">i</span><span class="op" id="4664375">]</span>&nbsp;<span class="op" id="4664377">&amp;&amp;</span>&nbsp;<span class="ident" id="4664380">w1</span>&nbsp;<span class="op" id="4664383">==</span>&nbsp;<span class="ident" id="4664386">win</span><span class="op" id="4664389">[</span><span class="ident" id="4664390">i</span><span class="op" id="4664391">+</span><span class="num" id="4664392">1</span><span class="op" id="4664393">]</span>&nbsp;<span class="op" id="4664395">&amp;&amp;</span>&nbsp;<span class="ident" id="4664398">wEnd</span>&nbsp;<span class="op" id="4664403">==</span>&nbsp;<span class="ident" id="4664406">win</span><span class="op" id="4664409">[</span><span class="ident" id="4664410">i</span><span class="op" id="4664411">+</span><span class="ident" id="4664412">length</span><span class="op" id="4664418">]</span>&nbsp;<span class="op" id="4664420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4664425">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664510">n</span>&nbsp;<span class="op" id="4664512">:=</span>&nbsp;<span class="num" id="4664515">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664520">for</span>&nbsp;<span class="ident" id="4664524">pos</span><span class="op" id="4664527">+</span><span class="ident" id="4664528">n</span>&nbsp;<span class="op" id="4664530">&lt;</span>&nbsp;<span class="builtinfunc" id="4664532">len</span><span class="op" id="4664535">(</span><span class="ident" id="4664536">win</span><span class="op" id="4664539">)</span>&nbsp;<span class="op" id="4664541">&amp;&amp;</span>&nbsp;<span class="ident" id="4664544">win</span><span class="op" id="4664547">[</span><span class="ident" id="4664548">i</span><span class="op" id="4664549">+</span><span class="ident" id="4664550">n</span><span class="op" id="4664551">]</span>&nbsp;<span class="op" id="4664553">==</span>&nbsp;<span class="ident" id="4664556">win</span><span class="op" id="4664559">[</span><span class="ident" id="4664560">pos</span><span class="op" id="4664563">+</span><span class="ident" id="4664564">n</span><span class="op" id="4664565">]</span>&nbsp;<span class="op" id="4664567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664573">n</span><span class="op" id="4664574">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664585">if</span>&nbsp;<span class="ident" id="4664588">n</span>&nbsp;<span class="op" id="4664590">&gt;</span>&nbsp;<span class="ident" id="4664592">length</span>&nbsp;<span class="op" id="4664599">&amp;&amp;</span>&nbsp;<span class="op" id="4664602">(</span><span class="ident" id="4664603">n</span>&nbsp;<span class="op" id="4664605">&gt;</span>&nbsp;<span class="num" id="4664607">3</span>&nbsp;<span class="op" id="4664609">||</span>&nbsp;<span class="ident" id="4664612">pos</span><span class="op" id="4664615">-</span><span class="ident" id="4664616">i</span>&nbsp;<span class="op" id="4664618">&lt;=</span>&nbsp;<span class="num" id="4664621">4096</span><span class="op" id="4664625">)</span>&nbsp;<span class="op" id="4664627">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664633">length</span>&nbsp;<span class="op" id="4664640">=</span>&nbsp;<span class="ident" id="4664642">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664648">offset</span>&nbsp;<span class="op" id="4664655">=</span>&nbsp;<span class="ident" id="4664657">pos</span>&nbsp;<span class="op" id="4664661">-</span>&nbsp;<span class="ident" id="4664663">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664669">ok</span>&nbsp;<span class="op" id="4664672">=</span>&nbsp;<span class="builtintype" id="4664674">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664683">if</span>&nbsp;<span class="ident" id="4664686">n</span>&nbsp;<span class="op" id="4664688">&gt;=</span>&nbsp;<span class="ident" id="4664691">nice</span>&nbsp;<span class="op" id="4664696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4664703">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664776">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4664792">wEnd</span>&nbsp;<span class="op" id="4664797">=</span>&nbsp;<span class="ident" id="4664799">win</span><span class="op" id="4664802">[</span><span class="ident" id="4664803">pos</span><span class="op" id="4664806">+</span><span class="ident" id="4664807">n</span><span class="op" id="4664808">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664817">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664821">if</span>&nbsp;<span class="ident" id="4664824">i</span>&nbsp;<span class="op" id="4664826">==</span>&nbsp;<span class="ident" id="4664829">minIndex</span>&nbsp;<span class="op" id="4664838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4664843">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664917">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4664925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4664929">if</span>&nbsp;<span class="ident" id="4664932">i</span>&nbsp;<span class="op" id="4664934">=</span>&nbsp;<span class="ident" id="4664936">d</span><span class="op" id="4664937">.</span><span class="ident" id="4664938">hashPrev</span><span class="op" id="4664946">[</span><span class="ident" id="4664947">i</span><span class="op" id="4664948">&amp;</span><span class="ident" id="4664949">windowMask</span><span class="op" id="4664959">]</span>&nbsp;<span class="op" id="4664961">-</span>&nbsp;<span class="ident" id="4664963">d</span><span class="op" id="4664964">.</span><span class="ident" id="4664965">hashOffset</span><span class="op" id="4664975">;</span>&nbsp;<span class="ident" id="4664977">i</span>&nbsp;<span class="op" id="4664979">&lt;</span>&nbsp;<span class="ident" id="4664981">minIndex</span>&nbsp;<span class="op" id="4664990">||</span>&nbsp;<span class="ident" id="4664993">i</span>&nbsp;<span class="op" id="4664995">&lt;</span>&nbsp;<span class="num" id="4664997">0</span>&nbsp;<span class="op" id="4664999">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665004">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4665012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4665015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665018">return</span><br>
<span class="lineno"></span><span class="op" id="4665025">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4665028">func</span>&nbsp;<span class="op" id="4665033">(</span><span class="ident" id="4665034">d</span>&nbsp;<span class="op" id="4665036">*</span><span class="ident" id="4665037">compressor</span><span class="op" id="4665047">)</span>&nbsp;<span class="ident" id="4665049">writeStoredBlock</span><span class="op" id="4665065">(</span><span class="ident" id="4665066">buf</span>&nbsp;<span class="op" id="4665070">[</span><span class="op" id="4665071">]</span><span class="builtintype" id="4665072">byte</span><span class="op" id="4665076">)</span>&nbsp;<span class="builtintype" id="4665078">error</span>&nbsp;<span class="op" id="4665084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665087">if</span>&nbsp;<span class="ident" id="4665090">d</span><span class="op" id="4665091">.</span><span class="ident" id="4665092">w</span><span class="op" id="4665093">.</span><span class="ident" id="4665094">writeStoredHeader</span><span class="op" id="4665111">(</span><span class="builtinfunc" id="4665112">len</span><span class="op" id="4665115">(</span><span class="ident" id="4665116">buf</span><span class="op" id="4665119">)</span><span class="op" id="4665120">,</span>&nbsp;<span class="builtintype" id="4665122">false</span><span class="op" id="4665127">)</span><span class="op" id="4665128">;</span>&nbsp;<span class="ident" id="4665130">d</span><span class="op" id="4665131">.</span><span class="ident" id="4665132">w</span><span class="op" id="4665133">.</span><span class="ident" id="4665134">err</span>&nbsp;<span class="op" id="4665138">!=</span>&nbsp;<span class="builtintype" id="4665141">nil</span>&nbsp;<span class="op" id="4665145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665149">return</span>&nbsp;<span class="ident" id="4665156">d</span><span class="op" id="4665157">.</span><span class="ident" id="4665158">w</span><span class="op" id="4665159">.</span><span class="ident" id="4665160">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4665165">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665168">d</span><span class="op" id="4665169">.</span><span class="ident" id="4665170">w</span><span class="op" id="4665171">.</span><span class="ident" id="4665172">writeBytes</span><span class="op" id="4665182">(</span><span class="ident" id="4665183">buf</span><span class="op" id="4665186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665189">return</span>&nbsp;<span class="ident" id="4665196">d</span><span class="op" id="4665197">.</span><span class="ident" id="4665198">w</span><span class="op" id="4665199">.</span><span class="ident" id="4665200">err</span><br>
<span class="lineno"></span><span class="op" id="4665204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4665207">func</span>&nbsp;<span class="op" id="4665212">(</span><span class="ident" id="4665213">d</span>&nbsp;<span class="op" id="4665215">*</span><span class="ident" id="4665216">compressor</span><span class="op" id="4665226">)</span>&nbsp;<span class="ident" id="4665228">initDeflate</span><span class="op" id="4665239">(</span><span class="op" id="4665240">)</span>&nbsp;<span class="op" id="4665242">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665245">d</span><span class="op" id="4665246">.</span><span class="ident" id="4665247">hashHead</span>&nbsp;<span class="op" id="4665256">=</span>&nbsp;<span class="builtinfunc" id="4665258">make</span><span class="op" id="4665262">(</span><span class="op" id="4665263">[</span><span class="op" id="4665264">]</span><span class="builtintype" id="4665265">int</span><span class="op" id="4665268">,</span>&nbsp;<span class="ident" id="4665270">hashSize</span><span class="op" id="4665278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665281">d</span><span class="op" id="4665282">.</span><span class="ident" id="4665283">hashPrev</span>&nbsp;<span class="op" id="4665292">=</span>&nbsp;<span class="builtinfunc" id="4665294">make</span><span class="op" id="4665298">(</span><span class="op" id="4665299">[</span><span class="op" id="4665300">]</span><span class="builtintype" id="4665301">int</span><span class="op" id="4665304">,</span>&nbsp;<span class="ident" id="4665306">windowSize</span><span class="op" id="4665316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665319">d</span><span class="op" id="4665320">.</span><span class="ident" id="4665321">window</span>&nbsp;<span class="op" id="4665328">=</span>&nbsp;<span class="builtinfunc" id="4665330">make</span><span class="op" id="4665334">(</span><span class="op" id="4665335">[</span><span class="op" id="4665336">]</span><span class="builtintype" id="4665337">byte</span><span class="op" id="4665341">,</span>&nbsp;<span class="num" id="4665343">2</span><span class="op" id="4665344">*</span><span class="ident" id="4665345">windowSize</span><span class="op" id="4665355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665358">d</span><span class="op" id="4665359">.</span><span class="ident" id="4665360">hashOffset</span>&nbsp;<span class="op" id="4665371">=</span>&nbsp;<span class="num" id="4665373">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665376">d</span><span class="op" id="4665377">.</span><span class="ident" id="4665378">tokens</span>&nbsp;<span class="op" id="4665385">=</span>&nbsp;<span class="builtinfunc" id="4665387">make</span><span class="op" id="4665391">(</span><span class="op" id="4665392">[</span><span class="op" id="4665393">]</span><span class="ident" id="4665394">token</span><span class="op" id="4665399">,</span>&nbsp;<span class="num" id="4665401">0</span><span class="op" id="4665402">,</span>&nbsp;<span class="ident" id="4665404">maxFlateBlockTokens</span><span class="op" id="4665423">+</span><span class="num" id="4665424">1</span><span class="op" id="4665425">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665428">d</span><span class="op" id="4665429">.</span><span class="ident" id="4665430">length</span>&nbsp;<span class="op" id="4665437">=</span>&nbsp;<span class="ident" id="4665439">minMatchLength</span>&nbsp;<span class="op" id="4665454">-</span>&nbsp;<span class="num" id="4665456">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665459">d</span><span class="op" id="4665460">.</span><span class="ident" id="4665461">offset</span>&nbsp;<span class="op" id="4665468">=</span>&nbsp;<span class="num" id="4665470">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665473">d</span><span class="op" id="4665474">.</span><span class="ident" id="4665475">byteAvailable</span>&nbsp;<span class="op" id="4665489">=</span>&nbsp;<span class="builtintype" id="4665491">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665498">d</span><span class="op" id="4665499">.</span><span class="ident" id="4665500">index</span>&nbsp;<span class="op" id="4665506">=</span>&nbsp;<span class="num" id="4665508">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665511">d</span><span class="op" id="4665512">.</span><span class="ident" id="4665513">hash</span>&nbsp;<span class="op" id="4665518">=</span>&nbsp;<span class="num" id="4665520">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665523">d</span><span class="op" id="4665524">.</span><span class="ident" id="4665525">chainHead</span>&nbsp;<span class="op" id="4665535">=</span>&nbsp;<span class="op" id="4665537">-</span><span class="num" id="4665538">1</span><br>
<span class="lineno"></span><span class="op" id="4665540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4665543">func</span>&nbsp;<span class="op" id="4665548">(</span><span class="ident" id="4665549">d</span>&nbsp;<span class="op" id="4665551">*</span><span class="ident" id="4665552">compressor</span><span class="op" id="4665562">)</span>&nbsp;<span class="ident" id="4665564">deflate</span><span class="op" id="4665571">(</span><span class="op" id="4665572">)</span>&nbsp;<span class="op" id="4665574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665577">if</span>&nbsp;<span class="ident" id="4665580">d</span><span class="op" id="4665581">.</span><span class="ident" id="4665582">windowEnd</span><span class="op" id="4665591">-</span><span class="ident" id="4665592">d</span><span class="op" id="4665593">.</span><span class="ident" id="4665594">index</span>&nbsp;<span class="op" id="4665600">&lt;</span>&nbsp;<span class="ident" id="4665602">minMatchLength</span><span class="op" id="4665616">+</span><span class="ident" id="4665617">maxMatchLength</span>&nbsp;<span class="op" id="4665632">&amp;&amp;</span>&nbsp;<span class="op" id="4665635">!</span><span class="ident" id="4665636">d</span><span class="op" id="4665637">.</span><span class="ident" id="4665638">sync</span>&nbsp;<span class="op" id="4665643">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665647">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4665655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665659">d</span><span class="op" id="4665660">.</span><span class="ident" id="4665661">maxInsertIndex</span>&nbsp;<span class="op" id="4665676">=</span>&nbsp;<span class="ident" id="4665678">d</span><span class="op" id="4665679">.</span><span class="ident" id="4665680">windowEnd</span>&nbsp;<span class="op" id="4665690">-</span>&nbsp;<span class="op" id="4665692">(</span><span class="ident" id="4665693">minMatchLength</span>&nbsp;<span class="op" id="4665708">-</span>&nbsp;<span class="num" id="4665710">1</span><span class="op" id="4665711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665714">if</span>&nbsp;<span class="ident" id="4665717">d</span><span class="op" id="4665718">.</span><span class="ident" id="4665719">index</span>&nbsp;<span class="op" id="4665725">&lt;</span>&nbsp;<span class="ident" id="4665727">d</span><span class="op" id="4665728">.</span><span class="ident" id="4665729">maxInsertIndex</span>&nbsp;<span class="op" id="4665744">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665748">d</span><span class="op" id="4665749">.</span><span class="ident" id="4665750">hash</span>&nbsp;<span class="op" id="4665755">=</span>&nbsp;<span class="builtintype" id="4665757">int</span><span class="op" id="4665760">(</span><span class="ident" id="4665761">d</span><span class="op" id="4665762">.</span><span class="ident" id="4665763">window</span><span class="op" id="4665769">[</span><span class="ident" id="4665770">d</span><span class="op" id="4665771">.</span><span class="ident" id="4665772">index</span><span class="op" id="4665777">]</span><span class="op" id="4665778">)</span><span class="op" id="4665779">&lt;&lt;</span><span class="ident" id="4665781">hashShift</span>&nbsp;<span class="op" id="4665791">+</span>&nbsp;<span class="builtintype" id="4665793">int</span><span class="op" id="4665796">(</span><span class="ident" id="4665797">d</span><span class="op" id="4665798">.</span><span class="ident" id="4665799">window</span><span class="op" id="4665805">[</span><span class="ident" id="4665806">d</span><span class="op" id="4665807">.</span><span class="ident" id="4665808">index</span><span class="op" id="4665813">+</span><span class="num" id="4665814">1</span><span class="op" id="4665815">]</span><span class="op" id="4665816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4665819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4665822">Loop</span><span class="op" id="4665826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665829">for</span>&nbsp;<span class="op" id="4665833">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665837">if</span>&nbsp;<span class="ident" id="4665840">d</span><span class="op" id="4665841">.</span><span class="ident" id="4665842">index</span>&nbsp;<span class="op" id="4665848">&gt;</span>&nbsp;<span class="ident" id="4665850">d</span><span class="op" id="4665851">.</span><span class="ident" id="4665852">windowEnd</span>&nbsp;<span class="op" id="4665862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4665867">panic</span><span class="op" id="4665872">(</span><span class="string" id="4665873">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4665892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4665896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4665900">lookahead</span>&nbsp;<span class="op" id="4665910">:=</span>&nbsp;<span class="ident" id="4665913">d</span><span class="op" id="4665914">.</span><span class="ident" id="4665915">windowEnd</span>&nbsp;<span class="op" id="4665925">-</span>&nbsp;<span class="ident" id="4665927">d</span><span class="op" id="4665928">.</span><span class="ident" id="4665929">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665937">if</span>&nbsp;<span class="ident" id="4665940">lookahead</span>&nbsp;<span class="op" id="4665950">&lt;</span>&nbsp;<span class="ident" id="4665952">minMatchLength</span><span class="op" id="4665966">+</span><span class="ident" id="4665967">maxMatchLength</span>&nbsp;<span class="op" id="4665982">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4665987">if</span>&nbsp;<span class="op" id="4665990">!</span><span class="ident" id="4665991">d</span><span class="op" id="4665992">.</span><span class="ident" id="4665993">sync</span>&nbsp;<span class="op" id="4665998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666004">break</span>&nbsp;<span class="ident" id="4666010">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666023">if</span>&nbsp;<span class="ident" id="4666026">d</span><span class="op" id="4666027">.</span><span class="ident" id="4666028">index</span>&nbsp;<span class="op" id="4666034">&gt;</span>&nbsp;<span class="ident" id="4666036">d</span><span class="op" id="4666037">.</span><span class="ident" id="4666038">windowEnd</span>&nbsp;<span class="op" id="4666048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4666054">panic</span><span class="op" id="4666059">(</span><span class="string" id="4666060">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4666079">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666089">if</span>&nbsp;<span class="ident" id="4666092">lookahead</span>&nbsp;<span class="op" id="4666102">==</span>&nbsp;<span class="num" id="4666105">0</span>&nbsp;<span class="op" id="4666107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4666113">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666155">if</span>&nbsp;<span class="ident" id="4666158">d</span><span class="op" id="4666159">.</span><span class="ident" id="4666160">byteAvailable</span>&nbsp;<span class="op" id="4666174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4666181">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666247">d</span><span class="op" id="4666248">.</span><span class="ident" id="4666249">tokens</span>&nbsp;<span class="op" id="4666256">=</span>&nbsp;<span class="builtinfunc" id="4666258">append</span><span class="op" id="4666264">(</span><span class="ident" id="4666265">d</span><span class="op" id="4666266">.</span><span class="ident" id="4666267">tokens</span><span class="op" id="4666273">,</span>&nbsp;<span class="ident" id="4666275">literalToken</span><span class="op" id="4666287">(</span><span class="builtintype" id="4666288">uint32</span><span class="op" id="4666294">(</span><span class="ident" id="4666295">d</span><span class="op" id="4666296">.</span><span class="ident" id="4666297">window</span><span class="op" id="4666303">[</span><span class="ident" id="4666304">d</span><span class="op" id="4666305">.</span><span class="ident" id="4666306">index</span><span class="op" id="4666311">-</span><span class="num" id="4666312">1</span><span class="op" id="4666313">]</span><span class="op" id="4666314">)</span><span class="op" id="4666315">)</span><span class="op" id="4666316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666323">d</span><span class="op" id="4666324">.</span><span class="ident" id="4666325">byteAvailable</span>&nbsp;<span class="op" id="4666339">=</span>&nbsp;<span class="builtintype" id="4666341">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666357">if</span>&nbsp;<span class="builtinfunc" id="4666360">len</span><span class="op" id="4666363">(</span><span class="ident" id="4666364">d</span><span class="op" id="4666365">.</span><span class="ident" id="4666366">tokens</span><span class="op" id="4666372">)</span>&nbsp;<span class="op" id="4666374">&gt;</span>&nbsp;<span class="num" id="4666376">0</span>&nbsp;<span class="op" id="4666378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666385">if</span>&nbsp;<span class="ident" id="4666388">d</span><span class="op" id="4666389">.</span><span class="ident" id="4666390">err</span>&nbsp;<span class="op" id="4666394">=</span>&nbsp;<span class="ident" id="4666396">d</span><span class="op" id="4666397">.</span><span class="ident" id="4666398">writeBlock</span><span class="op" id="4666408">(</span><span class="ident" id="4666409">d</span><span class="op" id="4666410">.</span><span class="ident" id="4666411">tokens</span><span class="op" id="4666417">,</span>&nbsp;<span class="ident" id="4666419">d</span><span class="op" id="4666420">.</span><span class="ident" id="4666421">index</span><span class="op" id="4666426">,</span>&nbsp;<span class="builtintype" id="4666428">false</span><span class="op" id="4666433">)</span><span class="op" id="4666434">;</span>&nbsp;<span class="ident" id="4666436">d</span><span class="op" id="4666437">.</span><span class="ident" id="4666438">err</span>&nbsp;<span class="op" id="4666442">!=</span>&nbsp;<span class="builtintype" id="4666445">nil</span>&nbsp;<span class="op" id="4666449">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666457">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666476">d</span><span class="op" id="4666477">.</span><span class="ident" id="4666478">tokens</span>&nbsp;<span class="op" id="4666485">=</span>&nbsp;<span class="ident" id="4666487">d</span><span class="op" id="4666488">.</span><span class="ident" id="4666489">tokens</span><span class="op" id="4666495">[</span><span class="op" id="4666496">:</span><span class="num" id="4666497">0</span><span class="op" id="4666498">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666510">break</span>&nbsp;<span class="ident" id="4666516">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666532">if</span>&nbsp;<span class="ident" id="4666535">d</span><span class="op" id="4666536">.</span><span class="ident" id="4666537">index</span>&nbsp;<span class="op" id="4666543">&lt;</span>&nbsp;<span class="ident" id="4666545">d</span><span class="op" id="4666546">.</span><span class="ident" id="4666547">maxInsertIndex</span>&nbsp;<span class="op" id="4666562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4666567">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666589">d</span><span class="op" id="4666590">.</span><span class="ident" id="4666591">hash</span>&nbsp;<span class="op" id="4666596">=</span>&nbsp;<span class="op" id="4666598">(</span><span class="ident" id="4666599">d</span><span class="op" id="4666600">.</span><span class="ident" id="4666601">hash</span><span class="op" id="4666605">&lt;&lt;</span><span class="ident" id="4666607">hashShift</span>&nbsp;<span class="op" id="4666617">+</span>&nbsp;<span class="builtintype" id="4666619">int</span><span class="op" id="4666622">(</span><span class="ident" id="4666623">d</span><span class="op" id="4666624">.</span><span class="ident" id="4666625">window</span><span class="op" id="4666631">[</span><span class="ident" id="4666632">d</span><span class="op" id="4666633">.</span><span class="ident" id="4666634">index</span><span class="op" id="4666639">+</span><span class="num" id="4666640">2</span><span class="op" id="4666641">]</span><span class="op" id="4666642">)</span><span class="op" id="4666643">)</span>&nbsp;<span class="op" id="4666645">&amp;</span>&nbsp;<span class="ident" id="4666647">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666659">d</span><span class="op" id="4666660">.</span><span class="ident" id="4666661">chainHead</span>&nbsp;<span class="op" id="4666671">=</span>&nbsp;<span class="ident" id="4666673">d</span><span class="op" id="4666674">.</span><span class="ident" id="4666675">hashHead</span><span class="op" id="4666683">[</span><span class="ident" id="4666684">d</span><span class="op" id="4666685">.</span><span class="ident" id="4666686">hash</span><span class="op" id="4666690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666695">d</span><span class="op" id="4666696">.</span><span class="ident" id="4666697">hashPrev</span><span class="op" id="4666705">[</span><span class="ident" id="4666706">d</span><span class="op" id="4666707">.</span><span class="ident" id="4666708">index</span><span class="op" id="4666713">&amp;</span><span class="ident" id="4666714">windowMask</span><span class="op" id="4666724">]</span>&nbsp;<span class="op" id="4666726">=</span>&nbsp;<span class="ident" id="4666728">d</span><span class="op" id="4666729">.</span><span class="ident" id="4666730">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666743">d</span><span class="op" id="4666744">.</span><span class="ident" id="4666745">hashHead</span><span class="op" id="4666753">[</span><span class="ident" id="4666754">d</span><span class="op" id="4666755">.</span><span class="ident" id="4666756">hash</span><span class="op" id="4666760">]</span>&nbsp;<span class="op" id="4666762">=</span>&nbsp;<span class="ident" id="4666764">d</span><span class="op" id="4666765">.</span><span class="ident" id="4666766">index</span>&nbsp;<span class="op" id="4666772">+</span>&nbsp;<span class="ident" id="4666774">d</span><span class="op" id="4666775">.</span><span class="ident" id="4666776">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666793">prevLength</span>&nbsp;<span class="op" id="4666804">:=</span>&nbsp;<span class="ident" id="4666807">d</span><span class="op" id="4666808">.</span><span class="ident" id="4666809">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666818">prevOffset</span>&nbsp;<span class="op" id="4666829">:=</span>&nbsp;<span class="ident" id="4666832">d</span><span class="op" id="4666833">.</span><span class="ident" id="4666834">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666843">d</span><span class="op" id="4666844">.</span><span class="ident" id="4666845">length</span>&nbsp;<span class="op" id="4666852">=</span>&nbsp;<span class="ident" id="4666854">minMatchLength</span>&nbsp;<span class="op" id="4666869">-</span>&nbsp;<span class="num" id="4666871">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666875">d</span><span class="op" id="4666876">.</span><span class="ident" id="4666877">offset</span>&nbsp;<span class="op" id="4666884">=</span>&nbsp;<span class="num" id="4666886">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666890">minIndex</span>&nbsp;<span class="op" id="4666899">:=</span>&nbsp;<span class="ident" id="4666902">d</span><span class="op" id="4666903">.</span><span class="ident" id="4666904">index</span>&nbsp;<span class="op" id="4666910">-</span>&nbsp;<span class="ident" id="4666912">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666925">if</span>&nbsp;<span class="ident" id="4666928">minIndex</span>&nbsp;<span class="op" id="4666937">&lt;</span>&nbsp;<span class="num" id="4666939">0</span>&nbsp;<span class="op" id="4666941">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4666946">minIndex</span>&nbsp;<span class="op" id="4666955">=</span>&nbsp;<span class="num" id="4666957">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4666961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4666966">if</span>&nbsp;<span class="ident" id="4666969">d</span><span class="op" id="4666970">.</span><span class="ident" id="4666971">chainHead</span><span class="op" id="4666980">-</span><span class="ident" id="4666981">d</span><span class="op" id="4666982">.</span><span class="ident" id="4666983">hashOffset</span>&nbsp;<span class="op" id="4666994">&gt;=</span>&nbsp;<span class="ident" id="4666997">minIndex</span>&nbsp;<span class="op" id="4667006">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4667012">(</span><span class="ident" id="4667013">d</span><span class="op" id="4667014">.</span><span class="ident" id="4667015">fastSkipHashing</span>&nbsp;<span class="op" id="4667031">!=</span>&nbsp;<span class="ident" id="4667034">skipNever</span>&nbsp;<span class="op" id="4667044">&amp;&amp;</span>&nbsp;<span class="ident" id="4667047">lookahead</span>&nbsp;<span class="op" id="4667057">&gt;</span>&nbsp;<span class="ident" id="4667059">minMatchLength</span><span class="op" id="4667073">-</span><span class="num" id="4667074">1</span>&nbsp;<span class="op" id="4667076">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4667083">d</span><span class="op" id="4667084">.</span><span class="ident" id="4667085">fastSkipHashing</span>&nbsp;<span class="op" id="4667101">==</span>&nbsp;<span class="ident" id="4667104">skipNever</span>&nbsp;<span class="op" id="4667114">&amp;&amp;</span>&nbsp;<span class="ident" id="4667117">lookahead</span>&nbsp;<span class="op" id="4667127">&gt;</span>&nbsp;<span class="ident" id="4667129">prevLength</span>&nbsp;<span class="op" id="4667140">&amp;&amp;</span>&nbsp;<span class="ident" id="4667143">prevLength</span>&nbsp;<span class="op" id="4667154">&lt;</span>&nbsp;<span class="ident" id="4667156">d</span><span class="op" id="4667157">.</span><span class="ident" id="4667158">lazy</span><span class="op" id="4667162">)</span>&nbsp;<span class="op" id="4667164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4667169">if</span>&nbsp;<span class="ident" id="4667172">newLength</span><span class="op" id="4667181">,</span>&nbsp;<span class="ident" id="4667183">newOffset</span><span class="op" id="4667192">,</span>&nbsp;<span class="ident" id="4667194">ok</span>&nbsp;<span class="op" id="4667197">:=</span>&nbsp;<span class="ident" id="4667200">d</span><span class="op" id="4667201">.</span><span class="ident" id="4667202">findMatch</span><span class="op" id="4667211">(</span><span class="ident" id="4667212">d</span><span class="op" id="4667213">.</span><span class="ident" id="4667214">index</span><span class="op" id="4667219">,</span>&nbsp;<span class="ident" id="4667221">d</span><span class="op" id="4667222">.</span><span class="ident" id="4667223">chainHead</span><span class="op" id="4667232">-</span><span class="ident" id="4667233">d</span><span class="op" id="4667234">.</span><span class="ident" id="4667235">hashOffset</span><span class="op" id="4667245">,</span>&nbsp;<span class="ident" id="4667247">minMatchLength</span><span class="op" id="4667261">-</span><span class="num" id="4667262">1</span><span class="op" id="4667263">,</span>&nbsp;<span class="ident" id="4667265">lookahead</span><span class="op" id="4667274">)</span><span class="op" id="4667275">;</span>&nbsp;<span class="ident" id="4667277">ok</span>&nbsp;<span class="op" id="4667280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4667286">d</span><span class="op" id="4667287">.</span><span class="ident" id="4667288">length</span>&nbsp;<span class="op" id="4667295">=</span>&nbsp;<span class="ident" id="4667297">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4667311">d</span><span class="op" id="4667312">.</span><span class="ident" id="4667313">offset</span>&nbsp;<span class="op" id="4667320">=</span>&nbsp;<span class="ident" id="4667322">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4667335">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4667339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4667343">if</span>&nbsp;<span class="ident" id="4667346">d</span><span class="op" id="4667347">.</span><span class="ident" id="4667348">fastSkipHashing</span>&nbsp;<span class="op" id="4667364">!=</span>&nbsp;<span class="ident" id="4667367">skipNever</span>&nbsp;<span class="op" id="4667377">&amp;&amp;</span>&nbsp;<span class="ident" id="4667380">d</span><span class="op" id="4667381">.</span><span class="ident" id="4667382">length</span>&nbsp;<span class="op" id="4667389">&gt;=</span>&nbsp;<span class="ident" id="4667392">minMatchLength</span>&nbsp;<span class="op" id="4667407">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4667413">d</span><span class="op" id="4667414">.</span><span class="ident" id="4667415">fastSkipHashing</span>&nbsp;<span class="op" id="4667431">==</span>&nbsp;<span class="ident" id="4667434">skipNever</span>&nbsp;<span class="op" id="4667444">&amp;&amp;</span>&nbsp;<span class="ident" id="4667447">prevLength</span>&nbsp;<span class="op" id="4667458">&gt;=</span>&nbsp;<span class="ident" id="4667461">minMatchLength</span>&nbsp;<span class="op" id="4667476">&amp;&amp;</span>&nbsp;<span class="ident" id="4667479">d</span><span class="op" id="4667480">.</span><span class="ident" id="4667481">length</span>&nbsp;<span class="op" id="4667488">&lt;=</span>&nbsp;<span class="ident" id="4667491">prevLength</span>&nbsp;<span class="op" id="4667502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4667507">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4667578">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4667623">if</span>&nbsp;<span class="ident" id="4667626">d</span><span class="op" id="4667627">.</span><span class="ident" id="4667628">fastSkipHashing</span>&nbsp;<span class="op" id="4667644">!=</span>&nbsp;<span class="ident" id="4667647">skipNever</span>&nbsp;<span class="op" id="4667657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4667663">d</span><span class="op" id="4667664">.</span><span class="ident" id="4667665">tokens</span>&nbsp;<span class="op" id="4667672">=</span>&nbsp;<span class="builtinfunc" id="4667674">append</span><span class="op" id="4667680">(</span><span class="ident" id="4667681">d</span><span class="op" id="4667682">.</span><span class="ident" id="4667683">tokens</span><span class="op" id="4667689">,</span>&nbsp;<span class="ident" id="4667691">matchToken</span><span class="op" id="4667701">(</span><span class="builtintype" id="4667702">uint32</span><span class="op" id="4667708">(</span><span class="ident" id="4667709">d</span><span class="op" id="4667710">.</span><span class="ident" id="4667711">length</span><span class="op" id="4667717">-</span><span class="ident" id="4667718">minMatchLength</span><span class="op" id="4667732">)</span><span class="op" id="4667733">,</span>&nbsp;<span class="builtintype" id="4667735">uint32</span><span class="op" id="4667741">(</span><span class="ident" id="4667742">d</span><span class="op" id="4667743">.</span><span class="ident" id="4667744">offset</span><span class="op" id="4667750">-</span><span class="ident" id="4667751">minOffsetSize</span><span class="op" id="4667764">)</span><span class="op" id="4667765">)</span><span class="op" id="4667766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4667771">}</span>&nbsp;<span class="keyword" id="4667773">else</span>&nbsp;<span class="op" id="4667778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4667784">d</span><span class="op" id="4667785">.</span><span class="ident" id="4667786">tokens</span>&nbsp;<span class="op" id="4667793">=</span>&nbsp;<span class="builtinfunc" id="4667795">append</span><span class="op" id="4667801">(</span><span class="ident" id="4667802">d</span><span class="op" id="4667803">.</span><span class="ident" id="4667804">tokens</span><span class="op" id="4667810">,</span>&nbsp;<span class="ident" id="4667812">matchToken</span><span class="op" id="4667822">(</span><span class="builtintype" id="4667823">uint32</span><span class="op" id="4667829">(</span><span class="ident" id="4667830">prevLength</span><span class="op" id="4667840">-</span><span class="ident" id="4667841">minMatchLength</span><span class="op" id="4667855">)</span><span class="op" id="4667856">,</span>&nbsp;<span class="builtintype" id="4667858">uint32</span><span class="op" id="4667864">(</span><span class="ident" id="4667865">prevOffset</span><span class="op" id="4667875">-</span><span class="ident" id="4667876">minOffsetSize</span><span class="op" id="4667889">)</span><span class="op" id="4667890">)</span><span class="op" id="4667891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4667896">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4667901">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4667972">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668041">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668110">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668123">if</span>&nbsp;<span class="ident" id="4668126">d</span><span class="op" id="4668127">.</span><span class="ident" id="4668128">length</span>&nbsp;<span class="op" id="4668135">&lt;=</span>&nbsp;<span class="ident" id="4668138">d</span><span class="op" id="4668139">.</span><span class="ident" id="4668140">fastSkipHashing</span>&nbsp;<span class="op" id="4668156">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668162">var</span>&nbsp;<span class="ident" id="4668166">newIndex</span>&nbsp;<span class="builtintype" id="4668175">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668183">if</span>&nbsp;<span class="ident" id="4668186">d</span><span class="op" id="4668187">.</span><span class="ident" id="4668188">fastSkipHashing</span>&nbsp;<span class="op" id="4668204">!=</span>&nbsp;<span class="ident" id="4668207">skipNever</span>&nbsp;<span class="op" id="4668217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668224">newIndex</span>&nbsp;<span class="op" id="4668233">=</span>&nbsp;<span class="ident" id="4668235">d</span><span class="op" id="4668236">.</span><span class="ident" id="4668237">index</span>&nbsp;<span class="op" id="4668243">+</span>&nbsp;<span class="ident" id="4668245">d</span><span class="op" id="4668246">.</span><span class="ident" id="4668247">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4668258">}</span>&nbsp;<span class="keyword" id="4668260">else</span>&nbsp;<span class="op" id="4668265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668272">newIndex</span>&nbsp;<span class="op" id="4668281">=</span>&nbsp;<span class="ident" id="4668283">d</span><span class="op" id="4668284">.</span><span class="ident" id="4668285">index</span>&nbsp;<span class="op" id="4668291">+</span>&nbsp;<span class="ident" id="4668293">prevLength</span>&nbsp;<span class="op" id="4668304">-</span>&nbsp;<span class="num" id="4668306">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4668312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668318">for</span>&nbsp;<span class="ident" id="4668322">d</span><span class="op" id="4668323">.</span><span class="ident" id="4668324">index</span><span class="op" id="4668329">++</span><span class="op" id="4668331">;</span>&nbsp;<span class="ident" id="4668333">d</span><span class="op" id="4668334">.</span><span class="ident" id="4668335">index</span>&nbsp;<span class="op" id="4668341">&lt;</span>&nbsp;<span class="ident" id="4668343">newIndex</span><span class="op" id="4668351">;</span>&nbsp;<span class="ident" id="4668353">d</span><span class="op" id="4668354">.</span><span class="ident" id="4668355">index</span><span class="op" id="4668360">++</span>&nbsp;<span class="op" id="4668363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668370">if</span>&nbsp;<span class="ident" id="4668373">d</span><span class="op" id="4668374">.</span><span class="ident" id="4668375">index</span>&nbsp;<span class="op" id="4668381">&lt;</span>&nbsp;<span class="ident" id="4668383">d</span><span class="op" id="4668384">.</span><span class="ident" id="4668385">maxInsertIndex</span>&nbsp;<span class="op" id="4668400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668408">d</span><span class="op" id="4668409">.</span><span class="ident" id="4668410">hash</span>&nbsp;<span class="op" id="4668415">=</span>&nbsp;<span class="op" id="4668417">(</span><span class="ident" id="4668418">d</span><span class="op" id="4668419">.</span><span class="ident" id="4668420">hash</span><span class="op" id="4668424">&lt;&lt;</span><span class="ident" id="4668426">hashShift</span>&nbsp;<span class="op" id="4668436">+</span>&nbsp;<span class="builtintype" id="4668438">int</span><span class="op" id="4668441">(</span><span class="ident" id="4668442">d</span><span class="op" id="4668443">.</span><span class="ident" id="4668444">window</span><span class="op" id="4668450">[</span><span class="ident" id="4668451">d</span><span class="op" id="4668452">.</span><span class="ident" id="4668453">index</span><span class="op" id="4668458">+</span><span class="num" id="4668459">2</span><span class="op" id="4668460">]</span><span class="op" id="4668461">)</span><span class="op" id="4668462">)</span>&nbsp;<span class="op" id="4668464">&amp;</span>&nbsp;<span class="ident" id="4668466">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668481">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668529">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668584">d</span><span class="op" id="4668585">.</span><span class="ident" id="4668586">hashPrev</span><span class="op" id="4668594">[</span><span class="ident" id="4668595">d</span><span class="op" id="4668596">.</span><span class="ident" id="4668597">index</span><span class="op" id="4668602">&amp;</span><span class="ident" id="4668603">windowMask</span><span class="op" id="4668613">]</span>&nbsp;<span class="op" id="4668615">=</span>&nbsp;<span class="ident" id="4668617">d</span><span class="op" id="4668618">.</span><span class="ident" id="4668619">hashHead</span><span class="op" id="4668627">[</span><span class="ident" id="4668628">d</span><span class="op" id="4668629">.</span><span class="ident" id="4668630">hash</span><span class="op" id="4668634">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668642">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668689">d</span><span class="op" id="4668690">.</span><span class="ident" id="4668691">hashHead</span><span class="op" id="4668699">[</span><span class="ident" id="4668700">d</span><span class="op" id="4668701">.</span><span class="ident" id="4668702">hash</span><span class="op" id="4668706">]</span>&nbsp;<span class="op" id="4668708">=</span>&nbsp;<span class="ident" id="4668710">d</span><span class="op" id="4668711">.</span><span class="ident" id="4668712">index</span>&nbsp;<span class="op" id="4668718">+</span>&nbsp;<span class="ident" id="4668720">d</span><span class="op" id="4668721">.</span><span class="ident" id="4668722">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4668738">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4668744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668750">if</span>&nbsp;<span class="ident" id="4668753">d</span><span class="op" id="4668754">.</span><span class="ident" id="4668755">fastSkipHashing</span>&nbsp;<span class="op" id="4668771">==</span>&nbsp;<span class="ident" id="4668774">skipNever</span>&nbsp;<span class="op" id="4668784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668791">d</span><span class="op" id="4668792">.</span><span class="ident" id="4668793">byteAvailable</span>&nbsp;<span class="op" id="4668807">=</span>&nbsp;<span class="builtintype" id="4668809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668820">d</span><span class="op" id="4668821">.</span><span class="ident" id="4668822">length</span>&nbsp;<span class="op" id="4668829">=</span>&nbsp;<span class="ident" id="4668831">minMatchLength</span>&nbsp;<span class="op" id="4668846">-</span>&nbsp;<span class="num" id="4668848">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4668854">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4668859">}</span>&nbsp;<span class="keyword" id="4668861">else</span>&nbsp;<span class="op" id="4668866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668872">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4668944">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4668972">d</span><span class="op" id="4668973">.</span><span class="ident" id="4668974">index</span>&nbsp;<span class="op" id="4668980">+=</span>&nbsp;<span class="ident" id="4668983">d</span><span class="op" id="4668984">.</span><span class="ident" id="4668985">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4668996">if</span>&nbsp;<span class="ident" id="4668999">d</span><span class="op" id="4669000">.</span><span class="ident" id="4669001">index</span>&nbsp;<span class="op" id="4669007">&lt;</span>&nbsp;<span class="ident" id="4669009">d</span><span class="op" id="4669010">.</span><span class="ident" id="4669011">maxInsertIndex</span>&nbsp;<span class="op" id="4669026">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669033">d</span><span class="op" id="4669034">.</span><span class="ident" id="4669035">hash</span>&nbsp;<span class="op" id="4669040">=</span>&nbsp;<span class="op" id="4669042">(</span><span class="builtintype" id="4669043">int</span><span class="op" id="4669046">(</span><span class="ident" id="4669047">d</span><span class="op" id="4669048">.</span><span class="ident" id="4669049">window</span><span class="op" id="4669055">[</span><span class="ident" id="4669056">d</span><span class="op" id="4669057">.</span><span class="ident" id="4669058">index</span><span class="op" id="4669063">]</span><span class="op" id="4669064">)</span><span class="op" id="4669065">&lt;&lt;</span><span class="ident" id="4669067">hashShift</span>&nbsp;<span class="op" id="4669077">+</span>&nbsp;<span class="builtintype" id="4669079">int</span><span class="op" id="4669082">(</span><span class="ident" id="4669083">d</span><span class="op" id="4669084">.</span><span class="ident" id="4669085">window</span><span class="op" id="4669091">[</span><span class="ident" id="4669092">d</span><span class="op" id="4669093">.</span><span class="ident" id="4669094">index</span><span class="op" id="4669099">+</span><span class="num" id="4669100">1</span><span class="op" id="4669101">]</span><span class="op" id="4669102">)</span><span class="op" id="4669103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669119">if</span>&nbsp;<span class="builtinfunc" id="4669122">len</span><span class="op" id="4669125">(</span><span class="ident" id="4669126">d</span><span class="op" id="4669127">.</span><span class="ident" id="4669128">tokens</span><span class="op" id="4669134">)</span>&nbsp;<span class="op" id="4669136">==</span>&nbsp;<span class="ident" id="4669139">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4669159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4669165">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669213">if</span>&nbsp;<span class="ident" id="4669216">d</span><span class="op" id="4669217">.</span><span class="ident" id="4669218">err</span>&nbsp;<span class="op" id="4669222">=</span>&nbsp;<span class="ident" id="4669224">d</span><span class="op" id="4669225">.</span><span class="ident" id="4669226">writeBlock</span><span class="op" id="4669236">(</span><span class="ident" id="4669237">d</span><span class="op" id="4669238">.</span><span class="ident" id="4669239">tokens</span><span class="op" id="4669245">,</span>&nbsp;<span class="ident" id="4669247">d</span><span class="op" id="4669248">.</span><span class="ident" id="4669249">index</span><span class="op" id="4669254">,</span>&nbsp;<span class="builtintype" id="4669256">false</span><span class="op" id="4669261">)</span><span class="op" id="4669262">;</span>&nbsp;<span class="ident" id="4669264">d</span><span class="op" id="4669265">.</span><span class="ident" id="4669266">err</span>&nbsp;<span class="op" id="4669270">!=</span>&nbsp;<span class="builtintype" id="4669273">nil</span>&nbsp;<span class="op" id="4669277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669284">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669301">d</span><span class="op" id="4669302">.</span><span class="ident" id="4669303">tokens</span>&nbsp;<span class="op" id="4669310">=</span>&nbsp;<span class="ident" id="4669312">d</span><span class="op" id="4669313">.</span><span class="ident" id="4669314">tokens</span><span class="op" id="4669320">[</span><span class="op" id="4669321">:</span><span class="num" id="4669322">0</span><span class="op" id="4669323">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669328">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669332">}</span>&nbsp;<span class="keyword" id="4669334">else</span>&nbsp;<span class="op" id="4669339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669344">if</span>&nbsp;<span class="ident" id="4669347">d</span><span class="op" id="4669348">.</span><span class="ident" id="4669349">fastSkipHashing</span>&nbsp;<span class="op" id="4669365">!=</span>&nbsp;<span class="ident" id="4669368">skipNever</span>&nbsp;<span class="op" id="4669378">||</span>&nbsp;<span class="ident" id="4669381">d</span><span class="op" id="4669382">.</span><span class="ident" id="4669383">byteAvailable</span>&nbsp;<span class="op" id="4669397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669403">i</span>&nbsp;<span class="op" id="4669405">:=</span>&nbsp;<span class="ident" id="4669408">d</span><span class="op" id="4669409">.</span><span class="ident" id="4669410">index</span>&nbsp;<span class="op" id="4669416">-</span>&nbsp;<span class="num" id="4669418">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669424">if</span>&nbsp;<span class="ident" id="4669427">d</span><span class="op" id="4669428">.</span><span class="ident" id="4669429">fastSkipHashing</span>&nbsp;<span class="op" id="4669445">!=</span>&nbsp;<span class="ident" id="4669448">skipNever</span>&nbsp;<span class="op" id="4669458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669465">i</span>&nbsp;<span class="op" id="4669467">=</span>&nbsp;<span class="ident" id="4669469">d</span><span class="op" id="4669470">.</span><span class="ident" id="4669471">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669487">d</span><span class="op" id="4669488">.</span><span class="ident" id="4669489">tokens</span>&nbsp;<span class="op" id="4669496">=</span>&nbsp;<span class="builtinfunc" id="4669498">append</span><span class="op" id="4669504">(</span><span class="ident" id="4669505">d</span><span class="op" id="4669506">.</span><span class="ident" id="4669507">tokens</span><span class="op" id="4669513">,</span>&nbsp;<span class="ident" id="4669515">literalToken</span><span class="op" id="4669527">(</span><span class="builtintype" id="4669528">uint32</span><span class="op" id="4669534">(</span><span class="ident" id="4669535">d</span><span class="op" id="4669536">.</span><span class="ident" id="4669537">window</span><span class="op" id="4669543">[</span><span class="ident" id="4669544">i</span><span class="op" id="4669545">]</span><span class="op" id="4669546">)</span><span class="op" id="4669547">)</span><span class="op" id="4669548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669554">if</span>&nbsp;<span class="builtinfunc" id="4669557">len</span><span class="op" id="4669560">(</span><span class="ident" id="4669561">d</span><span class="op" id="4669562">.</span><span class="ident" id="4669563">tokens</span><span class="op" id="4669569">)</span>&nbsp;<span class="op" id="4669571">==</span>&nbsp;<span class="ident" id="4669574">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4669594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669601">if</span>&nbsp;<span class="ident" id="4669604">d</span><span class="op" id="4669605">.</span><span class="ident" id="4669606">err</span>&nbsp;<span class="op" id="4669610">=</span>&nbsp;<span class="ident" id="4669612">d</span><span class="op" id="4669613">.</span><span class="ident" id="4669614">writeBlock</span><span class="op" id="4669624">(</span><span class="ident" id="4669625">d</span><span class="op" id="4669626">.</span><span class="ident" id="4669627">tokens</span><span class="op" id="4669633">,</span>&nbsp;<span class="ident" id="4669635">i</span><span class="op" id="4669636">+</span><span class="num" id="4669637">1</span><span class="op" id="4669638">,</span>&nbsp;<span class="builtintype" id="4669640">false</span><span class="op" id="4669645">)</span><span class="op" id="4669646">;</span>&nbsp;<span class="ident" id="4669648">d</span><span class="op" id="4669649">.</span><span class="ident" id="4669650">err</span>&nbsp;<span class="op" id="4669654">!=</span>&nbsp;<span class="builtintype" id="4669657">nil</span>&nbsp;<span class="op" id="4669661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669669">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669688">d</span><span class="op" id="4669689">.</span><span class="ident" id="4669690">tokens</span>&nbsp;<span class="op" id="4669697">=</span>&nbsp;<span class="ident" id="4669699">d</span><span class="op" id="4669700">.</span><span class="ident" id="4669701">tokens</span><span class="op" id="4669707">[</span><span class="op" id="4669708">:</span><span class="num" id="4669709">0</span><span class="op" id="4669710">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669726">d</span><span class="op" id="4669727">.</span><span class="ident" id="4669728">index</span><span class="op" id="4669733">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669739">if</span>&nbsp;<span class="ident" id="4669742">d</span><span class="op" id="4669743">.</span><span class="ident" id="4669744">fastSkipHashing</span>&nbsp;<span class="op" id="4669760">==</span>&nbsp;<span class="ident" id="4669763">skipNever</span>&nbsp;<span class="op" id="4669773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669779">d</span><span class="op" id="4669780">.</span><span class="ident" id="4669781">byteAvailable</span>&nbsp;<span class="op" id="4669795">=</span>&nbsp;<span class="builtintype" id="4669797">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4669812">}</span><br>
<span class="lineno">360</span><span class="op" id="4669814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4669817">func</span>&nbsp;<span class="op" id="4669822">(</span><span class="ident" id="4669823">d</span>&nbsp;<span class="op" id="4669825">*</span><span class="ident" id="4669826">compressor</span><span class="op" id="4669836">)</span>&nbsp;<span class="ident" id="4669838">fillStore</span><span class="op" id="4669847">(</span><span class="ident" id="4669848">b</span>&nbsp;<span class="op" id="4669850">[</span><span class="op" id="4669851">]</span><span class="builtintype" id="4669852">byte</span><span class="op" id="4669856">)</span>&nbsp;<span class="builtintype" id="4669858">int</span>&nbsp;<span class="op" id="4669862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669865">n</span>&nbsp;<span class="op" id="4669867">:=</span>&nbsp;<span class="builtinfunc" id="4669870">copy</span><span class="op" id="4669874">(</span><span class="ident" id="4669875">d</span><span class="op" id="4669876">.</span><span class="ident" id="4669877">window</span><span class="op" id="4669883">[</span><span class="ident" id="4669884">d</span><span class="op" id="4669885">.</span><span class="ident" id="4669886">windowEnd</span><span class="op" id="4669895">:</span><span class="op" id="4669896">]</span><span class="op" id="4669897">,</span>&nbsp;<span class="ident" id="4669899">b</span><span class="op" id="4669900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669903">d</span><span class="op" id="4669904">.</span><span class="ident" id="4669905">windowEnd</span>&nbsp;<span class="op" id="4669915">+=</span>&nbsp;<span class="ident" id="4669918">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669921">return</span>&nbsp;<span class="ident" id="4669928">n</span><br>
<span class="lineno"></span><span class="op" id="4669930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4669933">func</span>&nbsp;<span class="op" id="4669938">(</span><span class="ident" id="4669939">d</span>&nbsp;<span class="op" id="4669941">*</span><span class="ident" id="4669942">compressor</span><span class="op" id="4669952">)</span>&nbsp;<span class="ident" id="4669954">store</span><span class="op" id="4669959">(</span><span class="op" id="4669960">)</span>&nbsp;<span class="op" id="4669962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4669965">if</span>&nbsp;<span class="ident" id="4669968">d</span><span class="op" id="4669969">.</span><span class="ident" id="4669970">windowEnd</span>&nbsp;<span class="op" id="4669980">&gt;</span>&nbsp;<span class="num" id="4669982">0</span>&nbsp;<span class="op" id="4669984">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4669988">d</span><span class="op" id="4669989">.</span><span class="ident" id="4669990">err</span>&nbsp;<span class="op" id="4669994">=</span>&nbsp;<span class="ident" id="4669996">d</span><span class="op" id="4669997">.</span><span class="ident" id="4669998">writeStoredBlock</span><span class="op" id="4670014">(</span><span class="ident" id="4670015">d</span><span class="op" id="4670016">.</span><span class="ident" id="4670017">window</span><span class="op" id="4670023">[</span><span class="op" id="4670024">:</span><span class="ident" id="4670025">d</span><span class="op" id="4670026">.</span><span class="ident" id="4670027">windowEnd</span><span class="op" id="4670036">]</span><span class="op" id="4670037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4670040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670043">d</span><span class="op" id="4670044">.</span><span class="ident" id="4670045">windowEnd</span>&nbsp;<span class="op" id="4670055">=</span>&nbsp;<span class="num" id="4670057">0</span><br>
<span class="lineno"></span><span class="op" id="4670059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4670062">func</span>&nbsp;<span class="op" id="4670067">(</span><span class="ident" id="4670068">d</span>&nbsp;<span class="op" id="4670070">*</span><span class="ident" id="4670071">compressor</span><span class="op" id="4670081">)</span>&nbsp;<span class="ident" id="4670083">write</span><span class="op" id="4670088">(</span><span class="ident" id="4670089">b</span>&nbsp;<span class="op" id="4670091">[</span><span class="op" id="4670092">]</span><span class="builtintype" id="4670093">byte</span><span class="op" id="4670097">)</span>&nbsp;<span class="op" id="4670099">(</span><span class="ident" id="4670100">n</span>&nbsp;<span class="builtintype" id="4670102">int</span><span class="op" id="4670105">,</span>&nbsp;<span class="ident" id="4670107">err</span>&nbsp;<span class="builtintype" id="4670111">error</span><span class="op" id="4670116">)</span>&nbsp;<span class="op" id="4670118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670121">n</span>&nbsp;<span class="op" id="4670123">=</span>&nbsp;<span class="builtinfunc" id="4670125">len</span><span class="op" id="4670128">(</span><span class="ident" id="4670129">b</span><span class="op" id="4670130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670133">b</span>&nbsp;<span class="op" id="4670135">=</span>&nbsp;<span class="ident" id="4670137">b</span><span class="op" id="4670138">[</span><span class="ident" id="4670139">d</span><span class="op" id="4670140">.</span><span class="ident" id="4670141">fill</span><span class="op" id="4670145">(</span><span class="ident" id="4670146">d</span><span class="op" id="4670147">,</span>&nbsp;<span class="ident" id="4670149">b</span><span class="op" id="4670150">)</span><span class="op" id="4670151">:</span><span class="op" id="4670152">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670155">for</span>&nbsp;<span class="builtinfunc" id="4670159">len</span><span class="op" id="4670162">(</span><span class="ident" id="4670163">b</span><span class="op" id="4670164">)</span>&nbsp;<span class="op" id="4670166">&gt;</span>&nbsp;<span class="num" id="4670168">0</span>&nbsp;<span class="op" id="4670170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670174">d</span><span class="op" id="4670175">.</span><span class="ident" id="4670176">step</span><span class="op" id="4670180">(</span><span class="ident" id="4670181">d</span><span class="op" id="4670182">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670186">b</span>&nbsp;<span class="op" id="4670188">=</span>&nbsp;<span class="ident" id="4670190">b</span><span class="op" id="4670191">[</span><span class="ident" id="4670192">d</span><span class="op" id="4670193">.</span><span class="ident" id="4670194">fill</span><span class="op" id="4670198">(</span><span class="ident" id="4670199">d</span><span class="op" id="4670200">,</span>&nbsp;<span class="ident" id="4670202">b</span><span class="op" id="4670203">)</span><span class="op" id="4670204">:</span><span class="op" id="4670205">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4670208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670211">return</span>&nbsp;<span class="ident" id="4670218">n</span><span class="op" id="4670219">,</span>&nbsp;<span class="ident" id="4670221">d</span><span class="op" id="4670222">.</span><span class="ident" id="4670223">err</span><br>
<span class="lineno"></span><span class="op" id="4670227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4670230">func</span>&nbsp;<span class="op" id="4670235">(</span><span class="ident" id="4670236">d</span>&nbsp;<span class="op" id="4670238">*</span><span class="ident" id="4670239">compressor</span><span class="op" id="4670249">)</span>&nbsp;<span class="ident" id="4670251">syncFlush</span><span class="op" id="4670260">(</span><span class="op" id="4670261">)</span>&nbsp;<span class="builtintype" id="4670263">error</span>&nbsp;<span class="op" id="4670269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670272">d</span><span class="op" id="4670273">.</span><span class="ident" id="4670274">sync</span>&nbsp;<span class="op" id="4670279">=</span>&nbsp;<span class="builtintype" id="4670281">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670287">d</span><span class="op" id="4670288">.</span><span class="ident" id="4670289">step</span><span class="op" id="4670293">(</span><span class="ident" id="4670294">d</span><span class="op" id="4670295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670298">if</span>&nbsp;<span class="ident" id="4670301">d</span><span class="op" id="4670302">.</span><span class="ident" id="4670303">err</span>&nbsp;<span class="op" id="4670307">==</span>&nbsp;<span class="builtintype" id="4670310">nil</span>&nbsp;<span class="op" id="4670314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670318">d</span><span class="op" id="4670319">.</span><span class="ident" id="4670320">w</span><span class="op" id="4670321">.</span><span class="ident" id="4670322">writeStoredHeader</span><span class="op" id="4670339">(</span><span class="num" id="4670340">0</span><span class="op" id="4670341">,</span>&nbsp;<span class="builtintype" id="4670343">false</span><span class="op" id="4670348">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670352">d</span><span class="op" id="4670353">.</span><span class="ident" id="4670354">w</span><span class="op" id="4670355">.</span><span class="ident" id="4670356">flush</span><span class="op" id="4670361">(</span><span class="op" id="4670362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670366">d</span><span class="op" id="4670367">.</span><span class="ident" id="4670368">err</span>&nbsp;<span class="op" id="4670372">=</span>&nbsp;<span class="ident" id="4670374">d</span><span class="op" id="4670375">.</span><span class="ident" id="4670376">w</span><span class="op" id="4670377">.</span><span class="ident" id="4670378">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4670383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670386">d</span><span class="op" id="4670387">.</span><span class="ident" id="4670388">sync</span>&nbsp;<span class="op" id="4670393">=</span>&nbsp;<span class="builtintype" id="4670395">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670402">return</span>&nbsp;<span class="ident" id="4670409">d</span><span class="op" id="4670410">.</span><span class="ident" id="4670411">err</span><br>
<span class="lineno">395</span><span class="op" id="4670415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4670418">func</span>&nbsp;<span class="op" id="4670423">(</span><span class="ident" id="4670424">d</span>&nbsp;<span class="op" id="4670426">*</span><span class="ident" id="4670427">compressor</span><span class="op" id="4670437">)</span>&nbsp;<span class="ident" id="4670439">init</span><span class="op" id="4670443">(</span><span class="ident" id="4670444">w</span>&nbsp;<span class="ident" id="4670446">io</span><span class="op" id="4670448">.</span><span class="ident" id="4670449">Writer</span><span class="op" id="4670455">,</span>&nbsp;<span class="ident" id="4670457">level</span>&nbsp;<span class="builtintype" id="4670463">int</span><span class="op" id="4670466">)</span>&nbsp;<span class="op" id="4670468">(</span><span class="ident" id="4670469">err</span>&nbsp;<span class="builtintype" id="4670473">error</span><span class="op" id="4670478">)</span>&nbsp;<span class="op" id="4670480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670483">d</span><span class="op" id="4670484">.</span><span class="ident" id="4670485">w</span>&nbsp;<span class="op" id="4670487">=</span>&nbsp;<span class="ident" id="4670489">newHuffmanBitWriter</span><span class="op" id="4670508">(</span><span class="ident" id="4670509">w</span><span class="op" id="4670510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670514">switch</span>&nbsp;<span class="op" id="4670521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670524">case</span>&nbsp;<span class="ident" id="4670529">level</span>&nbsp;<span class="op" id="4670535">==</span>&nbsp;<span class="ident" id="4670538">NoCompression</span><span class="op" id="4670551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670555">d</span><span class="op" id="4670556">.</span><span class="ident" id="4670557">window</span>&nbsp;<span class="op" id="4670564">=</span>&nbsp;<span class="builtinfunc" id="4670566">make</span><span class="op" id="4670570">(</span><span class="op" id="4670571">[</span><span class="op" id="4670572">]</span><span class="builtintype" id="4670573">byte</span><span class="op" id="4670577">,</span>&nbsp;<span class="ident" id="4670579">maxStoreBlockSize</span><span class="op" id="4670596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670600">d</span><span class="op" id="4670601">.</span><span class="ident" id="4670602">fill</span>&nbsp;<span class="op" id="4670607">=</span>&nbsp;<span class="op" id="4670609">(</span><span class="op" id="4670610">*</span><span class="ident" id="4670611">compressor</span><span class="op" id="4670621">)</span><span class="op" id="4670622">.</span><span class="ident" id="4670623">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670635">d</span><span class="op" id="4670636">.</span><span class="ident" id="4670637">step</span>&nbsp;<span class="op" id="4670642">=</span>&nbsp;<span class="op" id="4670644">(</span><span class="op" id="4670645">*</span><span class="ident" id="4670646">compressor</span><span class="op" id="4670656">)</span><span class="op" id="4670657">.</span><span class="ident" id="4670658">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670665">case</span>&nbsp;<span class="ident" id="4670670">level</span>&nbsp;<span class="op" id="4670676">==</span>&nbsp;<span class="ident" id="4670679">DefaultCompression</span><span class="op" id="4670697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670701">level</span>&nbsp;<span class="op" id="4670707">=</span>&nbsp;<span class="num" id="4670709">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670713">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670726">case</span>&nbsp;<span class="num" id="4670731">1</span>&nbsp;<span class="op" id="4670733">&lt;=</span>&nbsp;<span class="ident" id="4670736">level</span>&nbsp;<span class="op" id="4670742">&amp;&amp;</span>&nbsp;<span class="ident" id="4670745">level</span>&nbsp;<span class="op" id="4670751">&lt;=</span>&nbsp;<span class="num" id="4670754">9</span><span class="op" id="4670755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670759">d</span><span class="op" id="4670760">.</span><span class="ident" id="4670761">compressionLevel</span>&nbsp;<span class="op" id="4670778">=</span>&nbsp;<span class="ident" id="4670780">levels</span><span class="op" id="4670786">[</span><span class="ident" id="4670787">level</span><span class="op" id="4670792">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670796">d</span><span class="op" id="4670797">.</span><span class="ident" id="4670798">initDeflate</span><span class="op" id="4670809">(</span><span class="op" id="4670810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670814">d</span><span class="op" id="4670815">.</span><span class="ident" id="4670816">fill</span>&nbsp;<span class="op" id="4670821">=</span>&nbsp;<span class="op" id="4670823">(</span><span class="op" id="4670824">*</span><span class="ident" id="4670825">compressor</span><span class="op" id="4670835">)</span><span class="op" id="4670836">.</span><span class="ident" id="4670837">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4670851">d</span><span class="op" id="4670852">.</span><span class="ident" id="4670853">step</span>&nbsp;<span class="op" id="4670858">=</span>&nbsp;<span class="op" id="4670860">(</span><span class="op" id="4670861">*</span><span class="ident" id="4670862">compressor</span><span class="op" id="4670872">)</span><span class="op" id="4670873">.</span><span class="ident" id="4670874">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670883">default</span><span class="op" id="4670890">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670894">return</span>&nbsp;<span class="ident" id="4670901">fmt</span><span class="op" id="4670904">.</span><span class="ident" id="4670905">Errorf</span><span class="op" id="4670911">(</span><span class="string" id="4670912">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4670978">,</span>&nbsp;<span class="ident" id="4670980">level</span><span class="op" id="4670985">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4670988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4670991">return</span>&nbsp;<span class="builtintype" id="4670998">nil</span><br>
<span class="lineno"></span><span class="op" id="4671002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4671005">var</span>&nbsp;<span class="ident" id="4671009">zeroes</span>&nbsp;<span class="op" id="4671016">[</span><span class="num" id="4671017">32</span><span class="op" id="4671019">]</span><span class="builtintype" id="4671020">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4671024">var</span>&nbsp;<span class="ident" id="4671028">bzeroes</span>&nbsp;<span class="op" id="4671036">[</span><span class="num" id="4671037">256</span><span class="op" id="4671040">]</span><span class="builtintype" id="4671041">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4671047">func</span>&nbsp;<span class="op" id="4671052">(</span><span class="ident" id="4671053">d</span>&nbsp;<span class="op" id="4671055">*</span><span class="ident" id="4671056">compressor</span><span class="op" id="4671066">)</span>&nbsp;<span class="ident" id="4671068">reset</span><span class="op" id="4671073">(</span><span class="ident" id="4671074">w</span>&nbsp;<span class="ident" id="4671076">io</span><span class="op" id="4671078">.</span><span class="ident" id="4671079">Writer</span><span class="op" id="4671085">)</span>&nbsp;<span class="op" id="4671087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671090">d</span><span class="op" id="4671091">.</span><span class="ident" id="4671092">w</span><span class="op" id="4671093">.</span><span class="ident" id="4671094">reset</span><span class="op" id="4671099">(</span><span class="ident" id="4671100">w</span><span class="op" id="4671101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671104">d</span><span class="op" id="4671105">.</span><span class="ident" id="4671106">sync</span>&nbsp;<span class="op" id="4671111">=</span>&nbsp;<span class="builtintype" id="4671113">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671120">d</span><span class="op" id="4671121">.</span><span class="ident" id="4671122">err</span>&nbsp;<span class="op" id="4671126">=</span>&nbsp;<span class="builtintype" id="4671128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671133">switch</span>&nbsp;<span class="ident" id="4671140">d</span><span class="op" id="4671141">.</span><span class="ident" id="4671142">compressionLevel</span><span class="op" id="4671158">.</span><span class="ident" id="4671159">chain</span>&nbsp;<span class="op" id="4671165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671168">case</span>&nbsp;<span class="num" id="4671173">0</span><span class="op" id="4671174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4671178">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671208">for</span>&nbsp;<span class="ident" id="4671212">i</span>&nbsp;<span class="op" id="4671214">:=</span>&nbsp;<span class="keyword" id="4671217">range</span>&nbsp;<span class="ident" id="4671223">d</span><span class="op" id="4671224">.</span><span class="ident" id="4671225">window</span>&nbsp;<span class="op" id="4671232">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671237">d</span><span class="op" id="4671238">.</span><span class="ident" id="4671239">window</span><span class="op" id="4671245">[</span><span class="ident" id="4671246">i</span><span class="op" id="4671247">]</span>&nbsp;<span class="op" id="4671249">=</span>&nbsp;<span class="num" id="4671251">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671259">d</span><span class="op" id="4671260">.</span><span class="ident" id="4671261">windowEnd</span>&nbsp;<span class="op" id="4671271">=</span>&nbsp;<span class="num" id="4671273">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671276">default</span><span class="op" id="4671283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671287">d</span><span class="op" id="4671288">.</span><span class="ident" id="4671289">chainHead</span>&nbsp;<span class="op" id="4671299">=</span>&nbsp;<span class="op" id="4671301">-</span><span class="num" id="4671302">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671306">for</span>&nbsp;<span class="ident" id="4671310">s</span>&nbsp;<span class="op" id="4671312">:=</span>&nbsp;<span class="ident" id="4671315">d</span><span class="op" id="4671316">.</span><span class="ident" id="4671317">hashHead</span><span class="op" id="4671325">;</span>&nbsp;<span class="builtinfunc" id="4671327">len</span><span class="op" id="4671330">(</span><span class="ident" id="4671331">s</span><span class="op" id="4671332">)</span>&nbsp;<span class="op" id="4671334">&gt;</span>&nbsp;<span class="num" id="4671336">0</span><span class="op" id="4671337">;</span>&nbsp;<span class="op" id="4671339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671344">n</span>&nbsp;<span class="op" id="4671346">:=</span>&nbsp;<span class="builtinfunc" id="4671349">copy</span><span class="op" id="4671353">(</span><span class="ident" id="4671354">s</span><span class="op" id="4671355">,</span>&nbsp;<span class="ident" id="4671357">zeroes</span><span class="op" id="4671363">[</span><span class="op" id="4671364">:</span><span class="op" id="4671365">]</span><span class="op" id="4671366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671371">s</span>&nbsp;<span class="op" id="4671373">=</span>&nbsp;<span class="ident" id="4671375">s</span><span class="op" id="4671376">[</span><span class="ident" id="4671377">n</span><span class="op" id="4671378">:</span><span class="op" id="4671379">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671387">for</span>&nbsp;<span class="ident" id="4671391">s</span>&nbsp;<span class="op" id="4671393">:=</span>&nbsp;<span class="ident" id="4671396">d</span><span class="op" id="4671397">.</span><span class="ident" id="4671398">hashPrev</span><span class="op" id="4671406">;</span>&nbsp;<span class="builtinfunc" id="4671408">len</span><span class="op" id="4671411">(</span><span class="ident" id="4671412">s</span><span class="op" id="4671413">)</span>&nbsp;<span class="op" id="4671415">&gt;</span>&nbsp;<span class="num" id="4671417">0</span><span class="op" id="4671418">;</span>&nbsp;<span class="ident" id="4671420">s</span>&nbsp;<span class="op" id="4671422">=</span>&nbsp;<span class="ident" id="4671424">s</span><span class="op" id="4671425">[</span><span class="builtinfunc" id="4671426">len</span><span class="op" id="4671429">(</span><span class="ident" id="4671430">zeroes</span><span class="op" id="4671436">)</span><span class="op" id="4671437">:</span><span class="op" id="4671438">]</span>&nbsp;<span class="op" id="4671440">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4671445">copy</span><span class="op" id="4671449">(</span><span class="ident" id="4671450">s</span><span class="op" id="4671451">,</span>&nbsp;<span class="ident" id="4671453">zeroes</span><span class="op" id="4671459">[</span><span class="op" id="4671460">:</span><span class="op" id="4671461">]</span><span class="op" id="4671462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671470">d</span><span class="op" id="4671471">.</span><span class="ident" id="4671472">hashOffset</span>&nbsp;<span class="op" id="4671483">=</span>&nbsp;<span class="num" id="4671485">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671490">d</span><span class="op" id="4671491">.</span><span class="ident" id="4671492">index</span><span class="op" id="4671497">,</span>&nbsp;<span class="ident" id="4671499">d</span><span class="op" id="4671500">.</span><span class="ident" id="4671501">windowEnd</span>&nbsp;<span class="op" id="4671511">=</span>&nbsp;<span class="num" id="4671513">0</span><span class="op" id="4671514">,</span>&nbsp;<span class="num" id="4671516">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671520">for</span>&nbsp;<span class="ident" id="4671524">s</span>&nbsp;<span class="op" id="4671526">:=</span>&nbsp;<span class="ident" id="4671529">d</span><span class="op" id="4671530">.</span><span class="ident" id="4671531">window</span><span class="op" id="4671537">;</span>&nbsp;<span class="builtinfunc" id="4671539">len</span><span class="op" id="4671542">(</span><span class="ident" id="4671543">s</span><span class="op" id="4671544">)</span>&nbsp;<span class="op" id="4671546">&gt;</span>&nbsp;<span class="num" id="4671548">0</span><span class="op" id="4671549">;</span>&nbsp;<span class="op" id="4671551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671556">n</span>&nbsp;<span class="op" id="4671558">:=</span>&nbsp;<span class="builtinfunc" id="4671561">copy</span><span class="op" id="4671565">(</span><span class="ident" id="4671566">s</span><span class="op" id="4671567">,</span>&nbsp;<span class="ident" id="4671569">bzeroes</span><span class="op" id="4671576">[</span><span class="op" id="4671577">:</span><span class="op" id="4671578">]</span><span class="op" id="4671579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671584">s</span>&nbsp;<span class="op" id="4671586">=</span>&nbsp;<span class="ident" id="4671588">s</span><span class="op" id="4671589">[</span><span class="ident" id="4671590">n</span><span class="op" id="4671591">:</span><span class="op" id="4671592">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671600">d</span><span class="op" id="4671601">.</span><span class="ident" id="4671602">blockStart</span><span class="op" id="4671612">,</span>&nbsp;<span class="ident" id="4671614">d</span><span class="op" id="4671615">.</span><span class="ident" id="4671616">byteAvailable</span>&nbsp;<span class="op" id="4671630">=</span>&nbsp;<span class="num" id="4671632">0</span><span class="op" id="4671633">,</span>&nbsp;<span class="builtintype" id="4671635">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671644">d</span><span class="op" id="4671645">.</span><span class="ident" id="4671646">tokens</span>&nbsp;<span class="op" id="4671653">=</span>&nbsp;<span class="ident" id="4671655">d</span><span class="op" id="4671656">.</span><span class="ident" id="4671657">tokens</span><span class="op" id="4671663">[</span><span class="op" id="4671664">:</span><span class="ident" id="4671665">maxFlateBlockTokens</span><span class="op" id="4671684">+</span><span class="num" id="4671685">1</span><span class="op" id="4671686">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671690">for</span>&nbsp;<span class="ident" id="4671694">i</span>&nbsp;<span class="op" id="4671696">:=</span>&nbsp;<span class="num" id="4671699">0</span><span class="op" id="4671700">;</span>&nbsp;<span class="ident" id="4671702">i</span>&nbsp;<span class="op" id="4671704">&lt;=</span>&nbsp;<span class="ident" id="4671707">maxFlateBlockTokens</span><span class="op" id="4671726">;</span>&nbsp;<span class="ident" id="4671728">i</span><span class="op" id="4671729">++</span>&nbsp;<span class="op" id="4671732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671737">d</span><span class="op" id="4671738">.</span><span class="ident" id="4671739">tokens</span><span class="op" id="4671745">[</span><span class="ident" id="4671746">i</span><span class="op" id="4671747">]</span>&nbsp;<span class="op" id="4671749">=</span>&nbsp;<span class="num" id="4671751">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671755">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671759">d</span><span class="op" id="4671760">.</span><span class="ident" id="4671761">tokens</span>&nbsp;<span class="op" id="4671768">=</span>&nbsp;<span class="ident" id="4671770">d</span><span class="op" id="4671771">.</span><span class="ident" id="4671772">tokens</span><span class="op" id="4671778">[</span><span class="op" id="4671779">:</span><span class="num" id="4671780">0</span><span class="op" id="4671781">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671785">d</span><span class="op" id="4671786">.</span><span class="ident" id="4671787">length</span>&nbsp;<span class="op" id="4671794">=</span>&nbsp;<span class="ident" id="4671796">minMatchLength</span>&nbsp;<span class="op" id="4671811">-</span>&nbsp;<span class="num" id="4671813">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671817">d</span><span class="op" id="4671818">.</span><span class="ident" id="4671819">offset</span>&nbsp;<span class="op" id="4671826">=</span>&nbsp;<span class="num" id="4671828">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671832">d</span><span class="op" id="4671833">.</span><span class="ident" id="4671834">hash</span>&nbsp;<span class="op" id="4671839">=</span>&nbsp;<span class="num" id="4671841">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671845">d</span><span class="op" id="4671846">.</span><span class="ident" id="4671847">maxInsertIndex</span>&nbsp;<span class="op" id="4671862">=</span>&nbsp;<span class="num" id="4671864">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671867">}</span><br>
<span class="lineno"></span><span class="op" id="4671869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4671872">func</span>&nbsp;<span class="op" id="4671877">(</span><span class="ident" id="4671878">d</span>&nbsp;<span class="op" id="4671880">*</span><span class="ident" id="4671881">compressor</span><span class="op" id="4671891">)</span>&nbsp;<span class="builtinfunc" id="4671893">close</span><span class="op" id="4671898">(</span><span class="op" id="4671899">)</span>&nbsp;<span class="builtintype" id="4671901">error</span>&nbsp;<span class="op" id="4671907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671910">d</span><span class="op" id="4671911">.</span><span class="ident" id="4671912">sync</span>&nbsp;<span class="op" id="4671917">=</span>&nbsp;<span class="builtintype" id="4671919">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4671925">d</span><span class="op" id="4671926">.</span><span class="ident" id="4671927">step</span><span class="op" id="4671931">(</span><span class="ident" id="4671932">d</span><span class="op" id="4671933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671936">if</span>&nbsp;<span class="ident" id="4671939">d</span><span class="op" id="4671940">.</span><span class="ident" id="4671941">err</span>&nbsp;<span class="op" id="4671945">!=</span>&nbsp;<span class="builtintype" id="4671948">nil</span>&nbsp;<span class="op" id="4671952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671956">return</span>&nbsp;<span class="ident" id="4671963">d</span><span class="op" id="4671964">.</span><span class="ident" id="4671965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4671970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4671973">if</span>&nbsp;<span class="ident" id="4671976">d</span><span class="op" id="4671977">.</span><span class="ident" id="4671978">w</span><span class="op" id="4671979">.</span><span class="ident" id="4671980">writeStoredHeader</span><span class="op" id="4671997">(</span><span class="num" id="4671998">0</span><span class="op" id="4671999">,</span>&nbsp;<span class="builtintype" id="4672001">true</span><span class="op" id="4672005">)</span><span class="op" id="4672006">;</span>&nbsp;<span class="ident" id="4672008">d</span><span class="op" id="4672009">.</span><span class="ident" id="4672010">w</span><span class="op" id="4672011">.</span><span class="ident" id="4672012">err</span>&nbsp;<span class="op" id="4672016">!=</span>&nbsp;<span class="builtintype" id="4672019">nil</span>&nbsp;<span class="op" id="4672023">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4672027">return</span>&nbsp;<span class="ident" id="4672034">d</span><span class="op" id="4672035">.</span><span class="ident" id="4672036">w</span><span class="op" id="4672037">.</span><span class="ident" id="4672038">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4672043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4672046">d</span><span class="op" id="4672047">.</span><span class="ident" id="4672048">w</span><span class="op" id="4672049">.</span><span class="ident" id="4672050">flush</span><span class="op" id="4672055">(</span><span class="op" id="4672056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4672059">return</span>&nbsp;<span class="ident" id="4672066">d</span><span class="op" id="4672067">.</span><span class="ident" id="4672068">w</span><span class="op" id="4672069">.</span><span class="ident" id="4672070">err</span><br>
<span class="lineno"></span><span class="op" id="4672074">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4672077">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4672148">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4672223">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4672288">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4672358">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4672435">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4672457">//</span><br>
<span class="lineno"></span><span class="comment" id="4672460">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4672533">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4672582">func</span>&nbsp;<span class="ident" id="4672587">NewWriter</span><span class="op" id="4672596">(</span><span class="ident" id="4672597">w</span>&nbsp;<span class="ident" id="4672599">io</span><span class="op" id="4672601">.</span><span class="ident" id="4672602">Writer</span><span class="op" id="4672608">,</span>&nbsp;<span class="ident" id="4672610">level</span>&nbsp;<span class="builtintype" id="4672616">int</span><span class="op" id="4672619">)</span>&nbsp;<span class="op" id="4672621">(</span><span class="op" id="4672622">*</span><span class="ident" id="4672623">Writer</span><span class="op" id="4672629">,</span>&nbsp;<span class="builtintype" id="4672631">error</span><span class="op" id="4672636">)</span>&nbsp;<span class="op" id="4672638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4672641">var</span>&nbsp;<span class="ident" id="4672645">dw</span>&nbsp;<span class="ident" id="4672648">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4672656">if</span>&nbsp;<span class="ident" id="4672659">err</span>&nbsp;<span class="op" id="4672663">:=</span>&nbsp;<span class="ident" id="4672666">dw</span><span class="op" id="4672668">.</span><span class="ident" id="4672669">d</span><span class="op" id="4672670">.</span><span class="ident" id="4672671">init</span><span class="op" id="4672675">(</span><span class="ident" id="4672676">w</span><span class="op" id="4672677">,</span>&nbsp;<span class="ident" id="4672679">level</span><span class="op" id="4672684">)</span><span class="op" id="4672685">;</span>&nbsp;<span class="ident" id="4672687">err</span>&nbsp;<span class="op" id="4672691">!=</span>&nbsp;<span class="builtintype" id="4672694">nil</span>&nbsp;<span class="op" id="4672698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4672702">return</span>&nbsp;<span class="builtintype" id="4672709">nil</span><span class="op" id="4672712">,</span>&nbsp;<span class="ident" id="4672714">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4672719">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4672722">return</span>&nbsp;<span class="op" id="4672729">&amp;</span><span class="ident" id="4672730">dw</span><span class="op" id="4672732">,</span>&nbsp;<span class="builtintype" id="4672734">nil</span><br>
<span class="lineno"></span><span class="op" id="4672738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4672741">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4672800">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4672865">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4672930">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4672990">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4673051">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4673071">func</span>&nbsp;<span class="ident" id="4673076">NewWriterDict</span><span class="op" id="4673089">(</span><span class="ident" id="4673090">w</span>&nbsp;<span class="ident" id="4673092">io</span><span class="op" id="4673094">.</span><span class="ident" id="4673095">Writer</span><span class="op" id="4673101">,</span>&nbsp;<span class="ident" id="4673103">level</span>&nbsp;<span class="builtintype" id="4673109">int</span><span class="op" id="4673112">,</span>&nbsp;<span class="ident" id="4673114">dict</span>&nbsp;<span class="op" id="4673119">[</span><span class="op" id="4673120">]</span><span class="builtintype" id="4673121">byte</span><span class="op" id="4673125">)</span>&nbsp;<span class="op" id="4673127">(</span><span class="op" id="4673128">*</span><span class="ident" id="4673129">Writer</span><span class="op" id="4673135">,</span>&nbsp;<span class="builtintype" id="4673137">error</span><span class="op" id="4673142">)</span>&nbsp;<span class="op" id="4673144">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673147">dw</span>&nbsp;<span class="op" id="4673150">:=</span>&nbsp;<span class="op" id="4673153">&amp;</span><span class="ident" id="4673154">dictWriter</span><span class="op" id="4673164">{</span><span class="ident" id="4673165">w</span><span class="op" id="4673166">,</span>&nbsp;<span class="builtintype" id="4673168">false</span><span class="op" id="4673173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673176">zw</span><span class="op" id="4673178">,</span>&nbsp;<span class="ident" id="4673180">err</span>&nbsp;<span class="op" id="4673184">:=</span>&nbsp;<span class="ident" id="4673187">NewWriter</span><span class="op" id="4673196">(</span><span class="ident" id="4673197">dw</span><span class="op" id="4673199">,</span>&nbsp;<span class="ident" id="4673201">level</span><span class="op" id="4673206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673209">if</span>&nbsp;<span class="ident" id="4673212">err</span>&nbsp;<span class="op" id="4673216">!=</span>&nbsp;<span class="builtintype" id="4673219">nil</span>&nbsp;<span class="op" id="4673223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673227">return</span>&nbsp;<span class="builtintype" id="4673234">nil</span><span class="op" id="4673237">,</span>&nbsp;<span class="ident" id="4673239">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4673244">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673247">zw</span><span class="op" id="4673249">.</span><span class="ident" id="4673250">Write</span><span class="op" id="4673255">(</span><span class="ident" id="4673256">dict</span><span class="op" id="4673260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673263">zw</span><span class="op" id="4673265">.</span><span class="ident" id="4673266">Flush</span><span class="op" id="4673271">(</span><span class="op" id="4673272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673275">dw</span><span class="op" id="4673277">.</span><span class="ident" id="4673278">enabled</span>&nbsp;<span class="op" id="4673286">=</span>&nbsp;<span class="builtintype" id="4673288">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673294">zw</span><span class="op" id="4673296">.</span><span class="ident" id="4673297">dict</span>&nbsp;<span class="op" id="4673302">=</span>&nbsp;<span class="builtinfunc" id="4673304">append</span><span class="op" id="4673310">(</span><span class="ident" id="4673311">zw</span><span class="op" id="4673313">.</span><span class="ident" id="4673314">dict</span><span class="op" id="4673318">,</span>&nbsp;<span class="ident" id="4673320">dict</span><span class="op" id="4673324">...</span><span class="op" id="4673327">)</span>&nbsp;<span class="comment" id="4673329">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673372">return</span>&nbsp;<span class="ident" id="4673379">zw</span><span class="op" id="4673381">,</span>&nbsp;<span class="ident" id="4673383">err</span><br>
<span class="lineno">510</span><span class="op" id="4673387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4673390">type</span>&nbsp;<span class="ident" id="4673395">dictWriter</span>&nbsp;<span class="keyword" id="4673406">struct</span>&nbsp;<span class="op" id="4673413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673416">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673424">io</span><span class="op" id="4673426">.</span><span class="ident" id="4673427">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673435">enabled</span>&nbsp;<span class="builtintype" id="4673443">bool</span><br>
<span class="lineno">515</span><span class="op" id="4673448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4673451">func</span>&nbsp;<span class="op" id="4673456">(</span><span class="ident" id="4673457">w</span>&nbsp;<span class="op" id="4673459">*</span><span class="ident" id="4673460">dictWriter</span><span class="op" id="4673470">)</span>&nbsp;<span class="ident" id="4673472">Write</span><span class="op" id="4673477">(</span><span class="ident" id="4673478">b</span>&nbsp;<span class="op" id="4673480">[</span><span class="op" id="4673481">]</span><span class="builtintype" id="4673482">byte</span><span class="op" id="4673486">)</span>&nbsp;<span class="op" id="4673488">(</span><span class="ident" id="4673489">n</span>&nbsp;<span class="builtintype" id="4673491">int</span><span class="op" id="4673494">,</span>&nbsp;<span class="ident" id="4673496">err</span>&nbsp;<span class="builtintype" id="4673500">error</span><span class="op" id="4673505">)</span>&nbsp;<span class="op" id="4673507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673510">if</span>&nbsp;<span class="ident" id="4673513">w</span><span class="op" id="4673514">.</span><span class="ident" id="4673515">enabled</span>&nbsp;<span class="op" id="4673523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673527">return</span>&nbsp;<span class="ident" id="4673534">w</span><span class="op" id="4673535">.</span><span class="ident" id="4673536">w</span><span class="op" id="4673537">.</span><span class="ident" id="4673538">Write</span><span class="op" id="4673543">(</span><span class="ident" id="4673544">b</span><span class="op" id="4673545">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4673548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673551">return</span>&nbsp;<span class="builtinfunc" id="4673558">len</span><span class="op" id="4673561">(</span><span class="ident" id="4673562">b</span><span class="op" id="4673563">)</span><span class="op" id="4673564">,</span>&nbsp;<span class="builtintype" id="4673566">nil</span><br>
<span class="lineno"></span><span class="op" id="4673570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4673573">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4673636">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4673698">type</span>&nbsp;<span class="ident" id="4673703">Writer</span>&nbsp;<span class="keyword" id="4673710">struct</span>&nbsp;<span class="op" id="4673717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673720">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673725">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4673737">dict</span>&nbsp;<span class="op" id="4673742">[</span><span class="op" id="4673743">]</span><span class="builtintype" id="4673744">byte</span><br>
<span class="lineno"></span><span class="op" id="4673749">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4673752">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4673811">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4673864">func</span>&nbsp;<span class="op" id="4673869">(</span><span class="ident" id="4673870">w</span>&nbsp;<span class="op" id="4673872">*</span><span class="ident" id="4673873">Writer</span><span class="op" id="4673879">)</span>&nbsp;<span class="ident" id="4673881">Write</span><span class="op" id="4673886">(</span><span class="ident" id="4673887">data</span>&nbsp;<span class="op" id="4673892">[</span><span class="op" id="4673893">]</span><span class="builtintype" id="4673894">byte</span><span class="op" id="4673898">)</span>&nbsp;<span class="op" id="4673900">(</span><span class="ident" id="4673901">n</span>&nbsp;<span class="builtintype" id="4673903">int</span><span class="op" id="4673906">,</span>&nbsp;<span class="ident" id="4673908">err</span>&nbsp;<span class="builtintype" id="4673912">error</span><span class="op" id="4673917">)</span>&nbsp;<span class="op" id="4673919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4673922">return</span>&nbsp;<span class="ident" id="4673929">w</span><span class="op" id="4673930">.</span><span class="ident" id="4673931">d</span><span class="op" id="4673932">.</span><span class="ident" id="4673933">write</span><span class="op" id="4673938">(</span><span class="ident" id="4673939">data</span><span class="op" id="4673943">)</span><br>
<span class="lineno">535</span><span class="op" id="4673945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4673948">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4674019">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4674090">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4674150">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4674208">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4674280">//</span><br>
<span class="lineno"></span><span class="comment" id="4674283">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4674363">func</span>&nbsp;<span class="op" id="4674368">(</span><span class="ident" id="4674369">w</span>&nbsp;<span class="op" id="4674371">*</span><span class="ident" id="4674372">Writer</span><span class="op" id="4674378">)</span>&nbsp;<span class="ident" id="4674380">Flush</span><span class="op" id="4674385">(</span><span class="op" id="4674386">)</span>&nbsp;<span class="builtintype" id="4674388">error</span>&nbsp;<span class="op" id="4674394">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4674397">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4674426">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4674478">return</span>&nbsp;<span class="ident" id="4674485">w</span><span class="op" id="4674486">.</span><span class="ident" id="4674487">d</span><span class="op" id="4674488">.</span><span class="ident" id="4674489">syncFlush</span><span class="op" id="4674498">(</span><span class="op" id="4674499">)</span><br>
<span class="lineno"></span><span class="op" id="4674501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4674504">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4674544">func</span>&nbsp;<span class="op" id="4674549">(</span><span class="ident" id="4674550">w</span>&nbsp;<span class="op" id="4674552">*</span><span class="ident" id="4674553">Writer</span><span class="op" id="4674559">)</span>&nbsp;<span class="ident" id="4674561">Close</span><span class="op" id="4674566">(</span><span class="op" id="4674567">)</span>&nbsp;<span class="builtintype" id="4674569">error</span>&nbsp;<span class="op" id="4674575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4674578">return</span>&nbsp;<span class="ident" id="4674585">w</span><span class="op" id="4674586">.</span><span class="ident" id="4674587">d</span><span class="op" id="4674588">.</span><span class="builtinfunc" id="4674589">close</span><span class="op" id="4674594">(</span><span class="op" id="4674595">)</span><br>
<span class="lineno"></span><span class="op" id="4674597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4674600">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4674664">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4674724">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4674757">func</span>&nbsp;<span class="op" id="4674762">(</span><span class="ident" id="4674763">w</span>&nbsp;<span class="op" id="4674765">*</span><span class="ident" id="4674766">Writer</span><span class="op" id="4674772">)</span>&nbsp;<span class="ident" id="4674774">Reset</span><span class="op" id="4674779">(</span><span class="ident" id="4674780">dst</span>&nbsp;<span class="ident" id="4674784">io</span><span class="op" id="4674786">.</span><span class="ident" id="4674787">Writer</span><span class="op" id="4674793">)</span>&nbsp;<span class="op" id="4674795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4674798">if</span>&nbsp;<span class="ident" id="4674801">dw</span><span class="op" id="4674803">,</span>&nbsp;<span class="ident" id="4674805">ok</span>&nbsp;<span class="op" id="4674808">:=</span>&nbsp;<span class="ident" id="4674811">w</span><span class="op" id="4674812">.</span><span class="ident" id="4674813">d</span><span class="op" id="4674814">.</span><span class="ident" id="4674815">w</span><span class="op" id="4674816">.</span><span class="ident" id="4674817">w</span><span class="op" id="4674818">.</span><span class="op" id="4674819">(</span><span class="op" id="4674820">*</span><span class="ident" id="4674821">dictWriter</span><span class="op" id="4674831">)</span><span class="op" id="4674832">;</span>&nbsp;<span class="ident" id="4674834">ok</span>&nbsp;<span class="op" id="4674837">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4674841">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4674879">dw</span><span class="op" id="4674881">.</span><span class="ident" id="4674882">w</span>&nbsp;<span class="op" id="4674884">=</span>&nbsp;<span class="ident" id="4674886">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4674892">w</span><span class="op" id="4674893">.</span><span class="ident" id="4674894">d</span><span class="op" id="4674895">.</span><span class="ident" id="4674896">reset</span><span class="op" id="4674901">(</span><span class="ident" id="4674902">dw</span><span class="op" id="4674904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4674908">dw</span><span class="op" id="4674910">.</span><span class="ident" id="4674911">enabled</span>&nbsp;<span class="op" id="4674919">=</span>&nbsp;<span class="builtintype" id="4674921">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4674929">w</span><span class="op" id="4674930">.</span><span class="ident" id="4674931">Write</span><span class="op" id="4674936">(</span><span class="ident" id="4674937">w</span><span class="op" id="4674938">.</span><span class="ident" id="4674939">dict</span><span class="op" id="4674943">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4674947">w</span><span class="op" id="4674948">.</span><span class="ident" id="4674949">Flush</span><span class="op" id="4674954">(</span><span class="op" id="4674955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4674959">dw</span><span class="op" id="4674961">.</span><span class="ident" id="4674962">enabled</span>&nbsp;<span class="op" id="4674970">=</span>&nbsp;<span class="builtintype" id="4674972">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4674978">}</span>&nbsp;<span class="keyword" id="4674980">else</span>&nbsp;<span class="op" id="4674985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4674989">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4675023">w</span><span class="op" id="4675024">.</span><span class="ident" id="4675025">d</span><span class="op" id="4675026">.</span><span class="ident" id="4675027">reset</span><span class="op" id="4675032">(</span><span class="ident" id="4675033">dst</span><span class="op" id="4675036">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4675039">}</span><br>
<span class="lineno"></span><span class="op" id="4675041">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
