<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4597937">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4597992">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4598046">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4598097">package</span>&nbsp;<span class="ident" id="4598105">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4598112">import</span>&nbsp;<span class="op" id="4598119">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598122">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598129">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4598135">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4598142">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4598145">const</span>&nbsp;<span class="op" id="4598151">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598154">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598173">=</span>&nbsp;<span class="num" id="4598175">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598178">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598197">=</span>&nbsp;<span class="num" id="4598199">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598202">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598221">=</span>&nbsp;<span class="num" id="4598223">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598226">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598245">=</span>&nbsp;<span class="num" id="4598247">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598250">DefaultCompression</span>&nbsp;<span class="op" id="4598269">=</span>&nbsp;<span class="op" id="4598271">-</span><span class="num" id="4598272">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598275">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598294">=</span>&nbsp;<span class="num" id="4598296">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598300">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598319">=</span>&nbsp;<span class="num" id="4598321">1</span>&nbsp;<span class="op" id="4598323">&lt;&lt;</span>&nbsp;<span class="ident" id="4598326">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598341">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598360">=</span>&nbsp;<span class="ident" id="4598362">windowSize</span>&nbsp;<span class="op" id="4598373">-</span>&nbsp;<span class="num" id="4598375">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598378">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4598397">=</span>&nbsp;<span class="num" id="4598399">15</span>&nbsp;&nbsp;<span class="comment" id="4598403">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598424">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598443">=</span>&nbsp;<span class="num" id="4598445">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4598449">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598502">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598521">=</span>&nbsp;<span class="num" id="4598523">258</span>&nbsp;<span class="comment" id="4598527">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598568">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598587">=</span>&nbsp;<span class="num" id="4598589">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4598593">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4598639">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4598714">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598754">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4598774">=</span>&nbsp;<span class="num" id="4598776">1</span>&nbsp;<span class="op" id="4598778">&lt;&lt;</span>&nbsp;<span class="num" id="4598781">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598785">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4598805">=</span>&nbsp;<span class="num" id="4598807">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598814">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598834">=</span>&nbsp;<span class="num" id="4598836">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598840">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598860">=</span>&nbsp;<span class="num" id="4598862">1</span>&nbsp;<span class="op" id="4598864">&lt;&lt;</span>&nbsp;<span class="ident" id="4598867">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598877">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598897">=</span>&nbsp;<span class="op" id="4598899">(</span><span class="num" id="4598900">1</span>&nbsp;<span class="op" id="4598902">&lt;&lt;</span>&nbsp;<span class="ident" id="4598905">hashBits</span><span class="op" id="4598913">)</span>&nbsp;<span class="op" id="4598915">-</span>&nbsp;<span class="num" id="4598917">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598920">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4598940">=</span>&nbsp;<span class="op" id="4598942">(</span><span class="ident" id="4598943">hashBits</span>&nbsp;<span class="op" id="4598952">+</span>&nbsp;<span class="ident" id="4598954">minMatchLength</span>&nbsp;<span class="op" id="4598969">-</span>&nbsp;<span class="num" id="4598971">1</span><span class="op" id="4598972">)</span>&nbsp;<span class="op" id="4598974">/</span>&nbsp;<span class="ident" id="4598976">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4598992">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4599012">=</span>&nbsp;<span class="num" id="4599014">1</span>&nbsp;<span class="op" id="4599016">&lt;&lt;</span>&nbsp;<span class="num" id="4599019">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599024">skipNever</span>&nbsp;<span class="op" id="4599034">=</span>&nbsp;<span class="ident" id="4599036">math</span><span class="op" id="4599040">.</span><span class="ident" id="4599041">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4599050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4599053">type</span>&nbsp;<span class="ident" id="4599058">compressionLevel</span>&nbsp;<span class="keyword" id="4599075">struct</span>&nbsp;<span class="op" id="4599082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599085">good</span><span class="op" id="4599089">,</span>&nbsp;<span class="ident" id="4599091">lazy</span><span class="op" id="4599095">,</span>&nbsp;<span class="ident" id="4599097">nice</span><span class="op" id="4599101">,</span>&nbsp;<span class="ident" id="4599103">chain</span><span class="op" id="4599108">,</span>&nbsp;<span class="ident" id="4599110">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4599126">int</span><br>
<span class="lineno"></span><span class="op" id="4599130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4599133">var</span>&nbsp;<span class="ident" id="4599137">levels</span>&nbsp;<span class="op" id="4599144">=</span>&nbsp;<span class="op" id="4599146">[</span><span class="op" id="4599147">]</span><span class="ident" id="4599148">compressionLevel</span><span class="op" id="4599164">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599167">{</span><span class="op" id="4599168">}</span><span class="op" id="4599169">,</span>&nbsp;<span class="comment" id="4599171">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599177">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599237">{</span><span class="num" id="4599238">3</span><span class="op" id="4599239">,</span>&nbsp;<span class="num" id="4599241">0</span><span class="op" id="4599242">,</span>&nbsp;<span class="num" id="4599244">8</span><span class="op" id="4599245">,</span>&nbsp;<span class="num" id="4599247">4</span><span class="op" id="4599248">,</span>&nbsp;<span class="num" id="4599250">4</span><span class="op" id="4599251">}</span><span class="op" id="4599252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599255">{</span><span class="num" id="4599256">3</span><span class="op" id="4599257">,</span>&nbsp;<span class="num" id="4599259">0</span><span class="op" id="4599260">,</span>&nbsp;<span class="num" id="4599262">16</span><span class="op" id="4599264">,</span>&nbsp;<span class="num" id="4599266">8</span><span class="op" id="4599267">,</span>&nbsp;<span class="num" id="4599269">5</span><span class="op" id="4599270">}</span><span class="op" id="4599271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599274">{</span><span class="num" id="4599275">3</span><span class="op" id="4599276">,</span>&nbsp;<span class="num" id="4599278">0</span><span class="op" id="4599279">,</span>&nbsp;<span class="num" id="4599281">32</span><span class="op" id="4599283">,</span>&nbsp;<span class="num" id="4599285">32</span><span class="op" id="4599287">,</span>&nbsp;<span class="num" id="4599289">6</span><span class="op" id="4599290">}</span><span class="op" id="4599291">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599294">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599345">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599406">{</span><span class="num" id="4599407">4</span><span class="op" id="4599408">,</span>&nbsp;<span class="num" id="4599410">4</span><span class="op" id="4599411">,</span>&nbsp;<span class="num" id="4599413">16</span><span class="op" id="4599415">,</span>&nbsp;<span class="num" id="4599417">16</span><span class="op" id="4599419">,</span>&nbsp;<span class="ident" id="4599421">skipNever</span><span class="op" id="4599430">}</span><span class="op" id="4599431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599434">{</span><span class="num" id="4599435">8</span><span class="op" id="4599436">,</span>&nbsp;<span class="num" id="4599438">16</span><span class="op" id="4599440">,</span>&nbsp;<span class="num" id="4599442">32</span><span class="op" id="4599444">,</span>&nbsp;<span class="num" id="4599446">32</span><span class="op" id="4599448">,</span>&nbsp;<span class="ident" id="4599450">skipNever</span><span class="op" id="4599459">}</span><span class="op" id="4599460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599463">{</span><span class="num" id="4599464">8</span><span class="op" id="4599465">,</span>&nbsp;<span class="num" id="4599467">16</span><span class="op" id="4599469">,</span>&nbsp;<span class="num" id="4599471">128</span><span class="op" id="4599474">,</span>&nbsp;<span class="num" id="4599476">128</span><span class="op" id="4599479">,</span>&nbsp;<span class="ident" id="4599481">skipNever</span><span class="op" id="4599490">}</span><span class="op" id="4599491">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599494">{</span><span class="num" id="4599495">8</span><span class="op" id="4599496">,</span>&nbsp;<span class="num" id="4599498">32</span><span class="op" id="4599500">,</span>&nbsp;<span class="num" id="4599502">128</span><span class="op" id="4599505">,</span>&nbsp;<span class="num" id="4599507">256</span><span class="op" id="4599510">,</span>&nbsp;<span class="ident" id="4599512">skipNever</span><span class="op" id="4599521">}</span><span class="op" id="4599522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599525">{</span><span class="num" id="4599526">32</span><span class="op" id="4599528">,</span>&nbsp;<span class="num" id="4599530">128</span><span class="op" id="4599533">,</span>&nbsp;<span class="num" id="4599535">258</span><span class="op" id="4599538">,</span>&nbsp;<span class="num" id="4599540">1024</span><span class="op" id="4599544">,</span>&nbsp;<span class="ident" id="4599546">skipNever</span><span class="op" id="4599555">}</span><span class="op" id="4599556">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4599559">{</span><span class="num" id="4599560">32</span><span class="op" id="4599562">,</span>&nbsp;<span class="num" id="4599564">258</span><span class="op" id="4599567">,</span>&nbsp;<span class="num" id="4599569">258</span><span class="op" id="4599572">,</span>&nbsp;<span class="num" id="4599574">4096</span><span class="op" id="4599578">,</span>&nbsp;<span class="ident" id="4599580">skipNever</span><span class="op" id="4599589">}</span><span class="op" id="4599590">,</span><br>
<span class="lineno"></span><span class="op" id="4599592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4599595">type</span>&nbsp;<span class="ident" id="4599600">compressor</span>&nbsp;<span class="keyword" id="4599611">struct</span>&nbsp;<span class="op" id="4599618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599621">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599640">w</span>&nbsp;<span class="op" id="4599642">*</span><span class="ident" id="4599643">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599662">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599688">fill</span>&nbsp;<span class="keyword" id="4599693">func</span><span class="op" id="4599697">(</span><span class="op" id="4599698">*</span><span class="ident" id="4599699">compressor</span><span class="op" id="4599709">,</span>&nbsp;<span class="op" id="4599711">[</span><span class="op" id="4599712">]</span><span class="builtintype" id="4599713">byte</span><span class="op" id="4599717">)</span>&nbsp;<span class="builtintype" id="4599719">int</span>&nbsp;<span class="comment" id="4599723">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599747">step</span>&nbsp;<span class="keyword" id="4599752">func</span><span class="op" id="4599756">(</span><span class="op" id="4599757">*</span><span class="ident" id="4599758">compressor</span><span class="op" id="4599768">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4599782">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4599801">sync</span>&nbsp;<span class="builtintype" id="4599806">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4599836">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599858">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599880">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4599966">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600028">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600103">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600133">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4600144">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600149">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4600160">[</span><span class="op" id="4600161">]</span><span class="builtintype" id="4600162">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600167">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4600178">[</span><span class="op" id="4600179">]</span><span class="builtintype" id="4600180">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600185">hashOffset</span>&nbsp;<span class="builtintype" id="4600196">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600202">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600264">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600278">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600283">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4600297">[</span><span class="op" id="4600298">]</span><span class="builtintype" id="4600299">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600305">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600319">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600324">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600338">int</span>&nbsp;&nbsp;<span class="comment" id="4600343">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600387">byteAvailable</span>&nbsp;<span class="builtintype" id="4600401">bool</span>&nbsp;<span class="comment" id="4600406">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600459">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600484">tokens</span>&nbsp;<span class="op" id="4600491">[</span><span class="op" id="4600492">]</span><span class="ident" id="4600493">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600501">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600519">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600534">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600539">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600554">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600559">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600574">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600579">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4600594">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600599">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4600614">error</span><br>
<span class="lineno"></span><span class="op" id="4600620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4600623">func</span>&nbsp;<span class="op" id="4600628">(</span><span class="ident" id="4600629">d</span>&nbsp;<span class="op" id="4600631">*</span><span class="ident" id="4600632">compressor</span><span class="op" id="4600642">)</span>&nbsp;<span class="ident" id="4600644">fillDeflate</span><span class="op" id="4600655">(</span><span class="ident" id="4600656">b</span>&nbsp;<span class="op" id="4600658">[</span><span class="op" id="4600659">]</span><span class="builtintype" id="4600660">byte</span><span class="op" id="4600664">)</span>&nbsp;<span class="builtintype" id="4600666">int</span>&nbsp;<span class="op" id="4600670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600673">if</span>&nbsp;<span class="ident" id="4600676">d</span><span class="op" id="4600677">.</span><span class="ident" id="4600678">index</span>&nbsp;<span class="op" id="4600684">&gt;=</span>&nbsp;<span class="num" id="4600687">2</span><span class="op" id="4600688">*</span><span class="ident" id="4600689">windowSize</span><span class="op" id="4600699">-</span><span class="op" id="4600700">(</span><span class="ident" id="4600701">minMatchLength</span><span class="op" id="4600715">+</span><span class="ident" id="4600716">maxMatchLength</span><span class="op" id="4600730">)</span>&nbsp;<span class="op" id="4600732">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4600736">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4600772">copy</span><span class="op" id="4600776">(</span><span class="ident" id="4600777">d</span><span class="op" id="4600778">.</span><span class="ident" id="4600779">window</span><span class="op" id="4600785">,</span>&nbsp;<span class="ident" id="4600787">d</span><span class="op" id="4600788">.</span><span class="ident" id="4600789">window</span><span class="op" id="4600795">[</span><span class="ident" id="4600796">windowSize</span><span class="op" id="4600806">:</span><span class="num" id="4600807">2</span><span class="op" id="4600808">*</span><span class="ident" id="4600809">windowSize</span><span class="op" id="4600819">]</span><span class="op" id="4600820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600824">d</span><span class="op" id="4600825">.</span><span class="ident" id="4600826">index</span>&nbsp;<span class="op" id="4600832">-=</span>&nbsp;<span class="ident" id="4600835">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600848">d</span><span class="op" id="4600849">.</span><span class="ident" id="4600850">windowEnd</span>&nbsp;<span class="op" id="4600860">-=</span>&nbsp;<span class="ident" id="4600863">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4600876">if</span>&nbsp;<span class="ident" id="4600879">d</span><span class="op" id="4600880">.</span><span class="ident" id="4600881">blockStart</span>&nbsp;<span class="op" id="4600892">&gt;=</span>&nbsp;<span class="ident" id="4600895">windowSize</span>&nbsp;<span class="op" id="4600906">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600911">d</span><span class="op" id="4600912">.</span><span class="ident" id="4600913">blockStart</span>&nbsp;<span class="op" id="4600924">-=</span>&nbsp;<span class="ident" id="4600927">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600940">}</span>&nbsp;<span class="keyword" id="4600942">else</span>&nbsp;<span class="op" id="4600947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600952">d</span><span class="op" id="4600953">.</span><span class="ident" id="4600954">blockStart</span>&nbsp;<span class="op" id="4600965">=</span>&nbsp;<span class="ident" id="4600967">math</span><span class="op" id="4600971">.</span><span class="ident" id="4600972">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4600983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4600987">d</span><span class="op" id="4600988">.</span><span class="ident" id="4600989">hashOffset</span>&nbsp;<span class="op" id="4601000">+=</span>&nbsp;<span class="ident" id="4601003">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601016">if</span>&nbsp;<span class="ident" id="4601019">d</span><span class="op" id="4601020">.</span><span class="ident" id="4601021">hashOffset</span>&nbsp;<span class="op" id="4601032">&gt;</span>&nbsp;<span class="ident" id="4601034">maxHashOffset</span>&nbsp;<span class="op" id="4601048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601053">delta</span>&nbsp;<span class="op" id="4601059">:=</span>&nbsp;<span class="ident" id="4601062">d</span><span class="op" id="4601063">.</span><span class="ident" id="4601064">hashOffset</span>&nbsp;<span class="op" id="4601075">-</span>&nbsp;<span class="num" id="4601077">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601082">d</span><span class="op" id="4601083">.</span><span class="ident" id="4601084">hashOffset</span>&nbsp;<span class="op" id="4601095">-=</span>&nbsp;<span class="ident" id="4601098">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601107">d</span><span class="op" id="4601108">.</span><span class="ident" id="4601109">chainHead</span>&nbsp;<span class="op" id="4601119">-=</span>&nbsp;<span class="ident" id="4601122">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601131">for</span>&nbsp;<span class="ident" id="4601135">i</span><span class="op" id="4601136">,</span>&nbsp;<span class="ident" id="4601138">v</span>&nbsp;<span class="op" id="4601140">:=</span>&nbsp;<span class="keyword" id="4601143">range</span>&nbsp;<span class="ident" id="4601149">d</span><span class="op" id="4601150">.</span><span class="ident" id="4601151">hashPrev</span>&nbsp;<span class="op" id="4601160">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601166">if</span>&nbsp;<span class="ident" id="4601169">v</span>&nbsp;<span class="op" id="4601171">&gt;</span>&nbsp;<span class="ident" id="4601173">delta</span>&nbsp;<span class="op" id="4601179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601186">d</span><span class="op" id="4601187">.</span><span class="ident" id="4601188">hashPrev</span><span class="op" id="4601196">[</span><span class="ident" id="4601197">i</span><span class="op" id="4601198">]</span>&nbsp;<span class="op" id="4601200">-=</span>&nbsp;<span class="ident" id="4601203">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601213">}</span>&nbsp;<span class="keyword" id="4601215">else</span>&nbsp;<span class="op" id="4601220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601227">d</span><span class="op" id="4601228">.</span><span class="ident" id="4601229">hashPrev</span><span class="op" id="4601237">[</span><span class="ident" id="4601238">i</span><span class="op" id="4601239">]</span>&nbsp;<span class="op" id="4601241">=</span>&nbsp;<span class="num" id="4601243">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601249">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601259">for</span>&nbsp;<span class="ident" id="4601263">i</span><span class="op" id="4601264">,</span>&nbsp;<span class="ident" id="4601266">v</span>&nbsp;<span class="op" id="4601268">:=</span>&nbsp;<span class="keyword" id="4601271">range</span>&nbsp;<span class="ident" id="4601277">d</span><span class="op" id="4601278">.</span><span class="ident" id="4601279">hashHead</span>&nbsp;<span class="op" id="4601288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601294">if</span>&nbsp;<span class="ident" id="4601297">v</span>&nbsp;<span class="op" id="4601299">&gt;</span>&nbsp;<span class="ident" id="4601301">delta</span>&nbsp;<span class="op" id="4601307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601314">d</span><span class="op" id="4601315">.</span><span class="ident" id="4601316">hashHead</span><span class="op" id="4601324">[</span><span class="ident" id="4601325">i</span><span class="op" id="4601326">]</span>&nbsp;<span class="op" id="4601328">-=</span>&nbsp;<span class="ident" id="4601331">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601341">}</span>&nbsp;<span class="keyword" id="4601343">else</span>&nbsp;<span class="op" id="4601348">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601355">d</span><span class="op" id="4601356">.</span><span class="ident" id="4601357">hashHead</span><span class="op" id="4601365">[</span><span class="ident" id="4601366">i</span><span class="op" id="4601367">]</span>&nbsp;<span class="op" id="4601369">=</span>&nbsp;<span class="num" id="4601371">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601389">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601392">n</span>&nbsp;<span class="op" id="4601394">:=</span>&nbsp;<span class="builtinfunc" id="4601397">copy</span><span class="op" id="4601401">(</span><span class="ident" id="4601402">d</span><span class="op" id="4601403">.</span><span class="ident" id="4601404">window</span><span class="op" id="4601410">[</span><span class="ident" id="4601411">d</span><span class="op" id="4601412">.</span><span class="ident" id="4601413">windowEnd</span><span class="op" id="4601422">:</span><span class="op" id="4601423">]</span><span class="op" id="4601424">,</span>&nbsp;<span class="ident" id="4601426">b</span><span class="op" id="4601427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601430">d</span><span class="op" id="4601431">.</span><span class="ident" id="4601432">windowEnd</span>&nbsp;<span class="op" id="4601442">+=</span>&nbsp;<span class="ident" id="4601445">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601448">return</span>&nbsp;<span class="ident" id="4601455">n</span><br>
<span class="lineno"></span><span class="op" id="4601457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4601460">func</span>&nbsp;<span class="op" id="4601465">(</span><span class="ident" id="4601466">d</span>&nbsp;<span class="op" id="4601468">*</span><span class="ident" id="4601469">compressor</span><span class="op" id="4601479">)</span>&nbsp;<span class="ident" id="4601481">writeBlock</span><span class="op" id="4601491">(</span><span class="ident" id="4601492">tokens</span>&nbsp;<span class="op" id="4601499">[</span><span class="op" id="4601500">]</span><span class="ident" id="4601501">token</span><span class="op" id="4601506">,</span>&nbsp;<span class="ident" id="4601508">index</span>&nbsp;<span class="builtintype" id="4601514">int</span><span class="op" id="4601517">,</span>&nbsp;<span class="ident" id="4601519">eof</span>&nbsp;<span class="builtintype" id="4601523">bool</span><span class="op" id="4601527">)</span>&nbsp;<span class="builtintype" id="4601529">error</span>&nbsp;<span class="op" id="4601535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601538">if</span>&nbsp;<span class="ident" id="4601541">index</span>&nbsp;<span class="op" id="4601547">&gt;</span>&nbsp;<span class="num" id="4601549">0</span>&nbsp;<span class="op" id="4601551">||</span>&nbsp;<span class="ident" id="4601554">eof</span>&nbsp;<span class="op" id="4601558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601562">var</span>&nbsp;<span class="ident" id="4601566">window</span>&nbsp;<span class="op" id="4601573">[</span><span class="op" id="4601574">]</span><span class="builtintype" id="4601575">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601582">if</span>&nbsp;<span class="ident" id="4601585">d</span><span class="op" id="4601586">.</span><span class="ident" id="4601587">blockStart</span>&nbsp;<span class="op" id="4601598">&lt;=</span>&nbsp;<span class="ident" id="4601601">index</span>&nbsp;<span class="op" id="4601607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601612">window</span>&nbsp;<span class="op" id="4601619">=</span>&nbsp;<span class="ident" id="4601621">d</span><span class="op" id="4601622">.</span><span class="ident" id="4601623">window</span><span class="op" id="4601629">[</span><span class="ident" id="4601630">d</span><span class="op" id="4601631">.</span><span class="ident" id="4601632">blockStart</span><span class="op" id="4601642">:</span><span class="ident" id="4601643">index</span><span class="op" id="4601648">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601656">d</span><span class="op" id="4601657">.</span><span class="ident" id="4601658">blockStart</span>&nbsp;<span class="op" id="4601669">=</span>&nbsp;<span class="ident" id="4601671">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4601679">d</span><span class="op" id="4601680">.</span><span class="ident" id="4601681">w</span><span class="op" id="4601682">.</span><span class="ident" id="4601683">writeBlock</span><span class="op" id="4601693">(</span><span class="ident" id="4601694">tokens</span><span class="op" id="4601700">,</span>&nbsp;<span class="ident" id="4601702">eof</span><span class="op" id="4601705">,</span>&nbsp;<span class="ident" id="4601707">window</span><span class="op" id="4601713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601717">return</span>&nbsp;<span class="ident" id="4601724">d</span><span class="op" id="4601725">.</span><span class="ident" id="4601726">w</span><span class="op" id="4601727">.</span><span class="ident" id="4601728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4601733">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4601736">return</span>&nbsp;<span class="ident" id="4601743">nil</span><br>
<span class="lineno"></span><span class="op" id="4601747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4601750">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4601830">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4601892">func</span>&nbsp;<span class="op" id="4601897">(</span><span class="ident" id="4601898">d</span>&nbsp;<span class="op" id="4601900">*</span><span class="ident" id="4601901">compressor</span><span class="op" id="4601911">)</span>&nbsp;<span class="ident" id="4601913">findMatch</span><span class="op" id="4601922">(</span><span class="ident" id="4601923">pos</span>&nbsp;<span class="builtintype" id="4601927">int</span><span class="op" id="4601930">,</span>&nbsp;<span class="ident" id="4601932">prevHead</span>&nbsp;<span class="builtintype" id="4601941">int</span><span class="op" id="4601944">,</span>&nbsp;<span class="ident" id="4601946">prevLength</span>&nbsp;<span class="builtintype" id="4601957">int</span><span class="op" id="4601960">,</span>&nbsp;<span class="ident" id="4601962">lookahead</span>&nbsp;<span class="builtintype" id="4601972">int</span><span class="op" id="4601975">)</span>&nbsp;<span class="op" id="4601977">(</span><span class="ident" id="4601978">length</span><span class="op" id="4601984">,</span>&nbsp;<span class="ident" id="4601986">offset</span>&nbsp;<span class="builtintype" id="4601993">int</span><span class="op" id="4601996">,</span>&nbsp;<span class="ident" id="4601998">ok</span>&nbsp;<span class="builtintype" id="4602001">bool</span><span class="op" id="4602005">)</span>&nbsp;<span class="op" id="4602007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602010">minMatchLook</span>&nbsp;<span class="op" id="4602023">:=</span>&nbsp;<span class="ident" id="4602026">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602042">if</span>&nbsp;<span class="ident" id="4602045">lookahead</span>&nbsp;<span class="op" id="4602055">&lt;</span>&nbsp;<span class="ident" id="4602057">minMatchLook</span>&nbsp;<span class="op" id="4602070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602074">minMatchLook</span>&nbsp;<span class="op" id="4602087">=</span>&nbsp;<span class="ident" id="4602089">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602100">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602104">win</span>&nbsp;<span class="op" id="4602108">:=</span>&nbsp;<span class="ident" id="4602111">d</span><span class="op" id="4602112">.</span><span class="ident" id="4602113">window</span><span class="op" id="4602119">[</span><span class="num" id="4602120">0</span>&nbsp;<span class="op" id="4602122">:</span>&nbsp;<span class="ident" id="4602124">pos</span><span class="op" id="4602127">+</span><span class="ident" id="4602128">minMatchLook</span><span class="op" id="4602140">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4602144">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602202">nice</span>&nbsp;<span class="op" id="4602207">:=</span>&nbsp;<span class="builtinfunc" id="4602210">len</span><span class="op" id="4602213">(</span><span class="ident" id="4602214">win</span><span class="op" id="4602217">)</span>&nbsp;<span class="op" id="4602219">-</span>&nbsp;<span class="ident" id="4602221">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602226">if</span>&nbsp;<span class="ident" id="4602229">d</span><span class="op" id="4602230">.</span><span class="ident" id="4602231">nice</span>&nbsp;<span class="op" id="4602236">&lt;</span>&nbsp;<span class="ident" id="4602238">nice</span>&nbsp;<span class="op" id="4602243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602247">nice</span>&nbsp;<span class="op" id="4602252">=</span>&nbsp;<span class="ident" id="4602254">d</span><span class="op" id="4602255">.</span><span class="ident" id="4602256">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4602266">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602339">tries</span>&nbsp;<span class="op" id="4602345">:=</span>&nbsp;<span class="ident" id="4602348">d</span><span class="op" id="4602349">.</span><span class="ident" id="4602350">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602357">length</span>&nbsp;<span class="op" id="4602364">=</span>&nbsp;<span class="ident" id="4602366">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602378">if</span>&nbsp;<span class="ident" id="4602381">length</span>&nbsp;<span class="op" id="4602388">&gt;=</span>&nbsp;<span class="ident" id="4602391">d</span><span class="op" id="4602392">.</span><span class="ident" id="4602393">good</span>&nbsp;<span class="op" id="4602398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602402">tries</span>&nbsp;<span class="op" id="4602408">&gt;&gt;=</span>&nbsp;<span class="num" id="4602412">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602415">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602419">w0</span>&nbsp;<span class="op" id="4602422">:=</span>&nbsp;<span class="ident" id="4602425">win</span><span class="op" id="4602428">[</span><span class="ident" id="4602429">pos</span><span class="op" id="4602432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602435">w1</span>&nbsp;<span class="op" id="4602438">:=</span>&nbsp;<span class="ident" id="4602441">win</span><span class="op" id="4602444">[</span><span class="ident" id="4602445">pos</span><span class="op" id="4602448">+</span><span class="num" id="4602449">1</span><span class="op" id="4602450">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602453">wEnd</span>&nbsp;<span class="op" id="4602458">:=</span>&nbsp;<span class="ident" id="4602461">win</span><span class="op" id="4602464">[</span><span class="ident" id="4602465">pos</span><span class="op" id="4602468">+</span><span class="ident" id="4602469">length</span><span class="op" id="4602475">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602478">minIndex</span>&nbsp;<span class="op" id="4602487">:=</span>&nbsp;<span class="ident" id="4602490">pos</span>&nbsp;<span class="op" id="4602494">-</span>&nbsp;<span class="ident" id="4602496">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602509">for</span>&nbsp;<span class="ident" id="4602513">i</span>&nbsp;<span class="op" id="4602515">:=</span>&nbsp;<span class="ident" id="4602518">prevHead</span><span class="op" id="4602526">;</span>&nbsp;<span class="ident" id="4602528">tries</span>&nbsp;<span class="op" id="4602534">&gt;</span>&nbsp;<span class="num" id="4602536">0</span><span class="op" id="4602537">;</span>&nbsp;<span class="ident" id="4602539">tries</span><span class="op" id="4602544">--</span>&nbsp;<span class="op" id="4602547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602551">if</span>&nbsp;<span class="ident" id="4602554">w0</span>&nbsp;<span class="op" id="4602557">==</span>&nbsp;<span class="ident" id="4602560">win</span><span class="op" id="4602563">[</span><span class="ident" id="4602564">i</span><span class="op" id="4602565">]</span>&nbsp;<span class="op" id="4602567">&amp;&amp;</span>&nbsp;<span class="ident" id="4602570">w1</span>&nbsp;<span class="op" id="4602573">==</span>&nbsp;<span class="ident" id="4602576">win</span><span class="op" id="4602579">[</span><span class="ident" id="4602580">i</span><span class="op" id="4602581">+</span><span class="num" id="4602582">1</span><span class="op" id="4602583">]</span>&nbsp;<span class="op" id="4602585">&amp;&amp;</span>&nbsp;<span class="ident" id="4602588">wEnd</span>&nbsp;<span class="op" id="4602593">==</span>&nbsp;<span class="ident" id="4602596">win</span><span class="op" id="4602599">[</span><span class="ident" id="4602600">i</span><span class="op" id="4602601">+</span><span class="ident" id="4602602">length</span><span class="op" id="4602608">]</span>&nbsp;<span class="op" id="4602610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4602615">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602700">n</span>&nbsp;<span class="op" id="4602702">:=</span>&nbsp;<span class="num" id="4602705">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602710">for</span>&nbsp;<span class="ident" id="4602714">pos</span><span class="op" id="4602717">+</span><span class="ident" id="4602718">n</span>&nbsp;<span class="op" id="4602720">&lt;</span>&nbsp;<span class="builtinfunc" id="4602722">len</span><span class="op" id="4602725">(</span><span class="ident" id="4602726">win</span><span class="op" id="4602729">)</span>&nbsp;<span class="op" id="4602731">&amp;&amp;</span>&nbsp;<span class="ident" id="4602734">win</span><span class="op" id="4602737">[</span><span class="ident" id="4602738">i</span><span class="op" id="4602739">+</span><span class="ident" id="4602740">n</span><span class="op" id="4602741">]</span>&nbsp;<span class="op" id="4602743">==</span>&nbsp;<span class="ident" id="4602746">win</span><span class="op" id="4602749">[</span><span class="ident" id="4602750">pos</span><span class="op" id="4602753">+</span><span class="ident" id="4602754">n</span><span class="op" id="4602755">]</span>&nbsp;<span class="op" id="4602757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602763">n</span><span class="op" id="4602764">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602775">if</span>&nbsp;<span class="ident" id="4602778">n</span>&nbsp;<span class="op" id="4602780">&gt;</span>&nbsp;<span class="ident" id="4602782">length</span>&nbsp;<span class="op" id="4602789">&amp;&amp;</span>&nbsp;<span class="op" id="4602792">(</span><span class="ident" id="4602793">n</span>&nbsp;<span class="op" id="4602795">&gt;</span>&nbsp;<span class="num" id="4602797">3</span>&nbsp;<span class="op" id="4602799">||</span>&nbsp;<span class="ident" id="4602802">pos</span><span class="op" id="4602805">-</span><span class="ident" id="4602806">i</span>&nbsp;<span class="op" id="4602808">&lt;=</span>&nbsp;<span class="num" id="4602811">4096</span><span class="op" id="4602815">)</span>&nbsp;<span class="op" id="4602817">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602823">length</span>&nbsp;<span class="op" id="4602830">=</span>&nbsp;<span class="ident" id="4602832">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602838">offset</span>&nbsp;<span class="op" id="4602845">=</span>&nbsp;<span class="ident" id="4602847">pos</span>&nbsp;<span class="op" id="4602851">-</span>&nbsp;<span class="ident" id="4602853">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602859">ok</span>&nbsp;<span class="op" id="4602862">=</span>&nbsp;<span class="builtintype" id="4602864">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602873">if</span>&nbsp;<span class="ident" id="4602876">n</span>&nbsp;<span class="op" id="4602878">&gt;=</span>&nbsp;<span class="ident" id="4602881">nice</span>&nbsp;<span class="op" id="4602886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4602893">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4602966">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4602976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4602982">wEnd</span>&nbsp;<span class="op" id="4602987">=</span>&nbsp;<span class="ident" id="4602989">win</span><span class="op" id="4602992">[</span><span class="ident" id="4602993">pos</span><span class="op" id="4602996">+</span><span class="ident" id="4602997">n</span><span class="op" id="4602998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603007">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603011">if</span>&nbsp;<span class="ident" id="4603014">i</span>&nbsp;<span class="op" id="4603016">==</span>&nbsp;<span class="ident" id="4603019">minIndex</span>&nbsp;<span class="op" id="4603028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4603033">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603107">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603119">if</span>&nbsp;<span class="ident" id="4603122">i</span>&nbsp;<span class="op" id="4603124">=</span>&nbsp;<span class="ident" id="4603126">d</span><span class="op" id="4603127">.</span><span class="ident" id="4603128">hashPrev</span><span class="op" id="4603136">[</span><span class="ident" id="4603137">i</span><span class="op" id="4603138">&amp;</span><span class="ident" id="4603139">windowMask</span><span class="op" id="4603149">]</span>&nbsp;<span class="op" id="4603151">-</span>&nbsp;<span class="ident" id="4603153">d</span><span class="op" id="4603154">.</span><span class="ident" id="4603155">hashOffset</span><span class="op" id="4603165">;</span>&nbsp;<span class="ident" id="4603167">i</span>&nbsp;<span class="op" id="4603169">&lt;</span>&nbsp;<span class="ident" id="4603171">minIndex</span>&nbsp;<span class="op" id="4603180">||</span>&nbsp;<span class="ident" id="4603183">i</span>&nbsp;<span class="op" id="4603185">&lt;</span>&nbsp;<span class="num" id="4603187">0</span>&nbsp;<span class="op" id="4603189">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603194">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603208">return</span><br>
<span class="lineno"></span><span class="op" id="4603215">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4603218">func</span>&nbsp;<span class="op" id="4603223">(</span><span class="ident" id="4603224">d</span>&nbsp;<span class="op" id="4603226">*</span><span class="ident" id="4603227">compressor</span><span class="op" id="4603237">)</span>&nbsp;<span class="ident" id="4603239">writeStoredBlock</span><span class="op" id="4603255">(</span><span class="ident" id="4603256">buf</span>&nbsp;<span class="op" id="4603260">[</span><span class="op" id="4603261">]</span><span class="builtintype" id="4603262">byte</span><span class="op" id="4603266">)</span>&nbsp;<span class="builtintype" id="4603268">error</span>&nbsp;<span class="op" id="4603274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603277">if</span>&nbsp;<span class="ident" id="4603280">d</span><span class="op" id="4603281">.</span><span class="ident" id="4603282">w</span><span class="op" id="4603283">.</span><span class="ident" id="4603284">writeStoredHeader</span><span class="op" id="4603301">(</span><span class="builtinfunc" id="4603302">len</span><span class="op" id="4603305">(</span><span class="ident" id="4603306">buf</span><span class="op" id="4603309">)</span><span class="op" id="4603310">,</span>&nbsp;<span class="builtintype" id="4603312">false</span><span class="op" id="4603317">)</span><span class="op" id="4603318">;</span>&nbsp;<span class="ident" id="4603320">d</span><span class="op" id="4603321">.</span><span class="ident" id="4603322">w</span><span class="op" id="4603323">.</span><span class="ident" id="4603324">err</span>&nbsp;<span class="op" id="4603328">!=</span>&nbsp;<span class="ident" id="4603331">nil</span>&nbsp;<span class="op" id="4603335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603339">return</span>&nbsp;<span class="ident" id="4603346">d</span><span class="op" id="4603347">.</span><span class="ident" id="4603348">w</span><span class="op" id="4603349">.</span><span class="ident" id="4603350">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603355">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603358">d</span><span class="op" id="4603359">.</span><span class="ident" id="4603360">w</span><span class="op" id="4603361">.</span><span class="ident" id="4603362">writeBytes</span><span class="op" id="4603372">(</span><span class="ident" id="4603373">buf</span><span class="op" id="4603376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603379">return</span>&nbsp;<span class="ident" id="4603386">d</span><span class="op" id="4603387">.</span><span class="ident" id="4603388">w</span><span class="op" id="4603389">.</span><span class="ident" id="4603390">err</span><br>
<span class="lineno"></span><span class="op" id="4603394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4603397">func</span>&nbsp;<span class="op" id="4603402">(</span><span class="ident" id="4603403">d</span>&nbsp;<span class="op" id="4603405">*</span><span class="ident" id="4603406">compressor</span><span class="op" id="4603416">)</span>&nbsp;<span class="ident" id="4603418">initDeflate</span><span class="op" id="4603429">(</span><span class="op" id="4603430">)</span>&nbsp;<span class="op" id="4603432">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603435">d</span><span class="op" id="4603436">.</span><span class="ident" id="4603437">hashHead</span>&nbsp;<span class="op" id="4603446">=</span>&nbsp;<span class="builtinfunc" id="4603448">make</span><span class="op" id="4603452">(</span><span class="op" id="4603453">[</span><span class="op" id="4603454">]</span><span class="builtintype" id="4603455">int</span><span class="op" id="4603458">,</span>&nbsp;<span class="ident" id="4603460">hashSize</span><span class="op" id="4603468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603471">d</span><span class="op" id="4603472">.</span><span class="ident" id="4603473">hashPrev</span>&nbsp;<span class="op" id="4603482">=</span>&nbsp;<span class="builtinfunc" id="4603484">make</span><span class="op" id="4603488">(</span><span class="op" id="4603489">[</span><span class="op" id="4603490">]</span><span class="builtintype" id="4603491">int</span><span class="op" id="4603494">,</span>&nbsp;<span class="ident" id="4603496">windowSize</span><span class="op" id="4603506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603509">d</span><span class="op" id="4603510">.</span><span class="ident" id="4603511">window</span>&nbsp;<span class="op" id="4603518">=</span>&nbsp;<span class="builtinfunc" id="4603520">make</span><span class="op" id="4603524">(</span><span class="op" id="4603525">[</span><span class="op" id="4603526">]</span><span class="builtintype" id="4603527">byte</span><span class="op" id="4603531">,</span>&nbsp;<span class="num" id="4603533">2</span><span class="op" id="4603534">*</span><span class="ident" id="4603535">windowSize</span><span class="op" id="4603545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603548">d</span><span class="op" id="4603549">.</span><span class="ident" id="4603550">hashOffset</span>&nbsp;<span class="op" id="4603561">=</span>&nbsp;<span class="num" id="4603563">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603566">d</span><span class="op" id="4603567">.</span><span class="ident" id="4603568">tokens</span>&nbsp;<span class="op" id="4603575">=</span>&nbsp;<span class="builtinfunc" id="4603577">make</span><span class="op" id="4603581">(</span><span class="op" id="4603582">[</span><span class="op" id="4603583">]</span><span class="ident" id="4603584">token</span><span class="op" id="4603589">,</span>&nbsp;<span class="num" id="4603591">0</span><span class="op" id="4603592">,</span>&nbsp;<span class="ident" id="4603594">maxFlateBlockTokens</span><span class="op" id="4603613">+</span><span class="num" id="4603614">1</span><span class="op" id="4603615">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603618">d</span><span class="op" id="4603619">.</span><span class="ident" id="4603620">length</span>&nbsp;<span class="op" id="4603627">=</span>&nbsp;<span class="ident" id="4603629">minMatchLength</span>&nbsp;<span class="op" id="4603644">-</span>&nbsp;<span class="num" id="4603646">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603649">d</span><span class="op" id="4603650">.</span><span class="ident" id="4603651">offset</span>&nbsp;<span class="op" id="4603658">=</span>&nbsp;<span class="num" id="4603660">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603663">d</span><span class="op" id="4603664">.</span><span class="ident" id="4603665">byteAvailable</span>&nbsp;<span class="op" id="4603679">=</span>&nbsp;<span class="builtintype" id="4603681">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603688">d</span><span class="op" id="4603689">.</span><span class="ident" id="4603690">index</span>&nbsp;<span class="op" id="4603696">=</span>&nbsp;<span class="num" id="4603698">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603701">d</span><span class="op" id="4603702">.</span><span class="ident" id="4603703">hash</span>&nbsp;<span class="op" id="4603708">=</span>&nbsp;<span class="num" id="4603710">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603713">d</span><span class="op" id="4603714">.</span><span class="ident" id="4603715">chainHead</span>&nbsp;<span class="op" id="4603725">=</span>&nbsp;<span class="op" id="4603727">-</span><span class="num" id="4603728">1</span><br>
<span class="lineno"></span><span class="op" id="4603730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4603733">func</span>&nbsp;<span class="op" id="4603738">(</span><span class="ident" id="4603739">d</span>&nbsp;<span class="op" id="4603741">*</span><span class="ident" id="4603742">compressor</span><span class="op" id="4603752">)</span>&nbsp;<span class="ident" id="4603754">deflate</span><span class="op" id="4603761">(</span><span class="op" id="4603762">)</span>&nbsp;<span class="op" id="4603764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603767">if</span>&nbsp;<span class="ident" id="4603770">d</span><span class="op" id="4603771">.</span><span class="ident" id="4603772">windowEnd</span><span class="op" id="4603781">-</span><span class="ident" id="4603782">d</span><span class="op" id="4603783">.</span><span class="ident" id="4603784">index</span>&nbsp;<span class="op" id="4603790">&lt;</span>&nbsp;<span class="ident" id="4603792">minMatchLength</span><span class="op" id="4603806">+</span><span class="ident" id="4603807">maxMatchLength</span>&nbsp;<span class="op" id="4603822">&amp;&amp;</span>&nbsp;<span class="op" id="4603825">!</span><span class="ident" id="4603826">d</span><span class="op" id="4603827">.</span><span class="ident" id="4603828">sync</span>&nbsp;<span class="op" id="4603833">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603837">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4603845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603849">d</span><span class="op" id="4603850">.</span><span class="ident" id="4603851">maxInsertIndex</span>&nbsp;<span class="op" id="4603866">=</span>&nbsp;<span class="ident" id="4603868">d</span><span class="op" id="4603869">.</span><span class="ident" id="4603870">windowEnd</span>&nbsp;<span class="op" id="4603880">-</span>&nbsp;<span class="op" id="4603882">(</span><span class="ident" id="4603883">minMatchLength</span>&nbsp;<span class="op" id="4603898">-</span>&nbsp;<span class="num" id="4603900">1</span><span class="op" id="4603901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4603904">if</span>&nbsp;<span class="ident" id="4603907">d</span><span class="op" id="4603908">.</span><span class="ident" id="4603909">index</span>&nbsp;<span class="op" id="4603915">&lt;</span>&nbsp;<span class="ident" id="4603917">d</span><span class="op" id="4603918">.</span><span class="ident" id="4603919">maxInsertIndex</span>&nbsp;<span class="op" id="4603934">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4603938">d</span><span class="op" id="4603939">.</span><span class="ident" id="4603940">hash</span>&nbsp;<span class="op" id="4603945">=</span>&nbsp;<span class="builtintype" id="4603947">int</span><span class="op" id="4603950">(</span><span class="ident" id="4603951">d</span><span class="op" id="4603952">.</span><span class="ident" id="4603953">window</span><span class="op" id="4603959">[</span><span class="ident" id="4603960">d</span><span class="op" id="4603961">.</span><span class="ident" id="4603962">index</span><span class="op" id="4603967">]</span><span class="op" id="4603968">)</span><span class="op" id="4603969">&lt;&lt;</span><span class="ident" id="4603971">hashShift</span>&nbsp;<span class="op" id="4603981">+</span>&nbsp;<span class="builtintype" id="4603983">int</span><span class="op" id="4603986">(</span><span class="ident" id="4603987">d</span><span class="op" id="4603988">.</span><span class="ident" id="4603989">window</span><span class="op" id="4603995">[</span><span class="ident" id="4603996">d</span><span class="op" id="4603997">.</span><span class="ident" id="4603998">index</span><span class="op" id="4604003">+</span><span class="num" id="4604004">1</span><span class="op" id="4604005">]</span><span class="op" id="4604006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4604012">Loop</span><span class="op" id="4604016">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604019">for</span>&nbsp;<span class="op" id="4604023">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604027">if</span>&nbsp;<span class="ident" id="4604030">d</span><span class="op" id="4604031">.</span><span class="ident" id="4604032">index</span>&nbsp;<span class="op" id="4604038">&gt;</span>&nbsp;<span class="ident" id="4604040">d</span><span class="op" id="4604041">.</span><span class="ident" id="4604042">windowEnd</span>&nbsp;<span class="op" id="4604052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4604057">panic</span><span class="op" id="4604062">(</span><span class="string" id="4604063">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4604082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604090">lookahead</span>&nbsp;<span class="op" id="4604100">:=</span>&nbsp;<span class="ident" id="4604103">d</span><span class="op" id="4604104">.</span><span class="ident" id="4604105">windowEnd</span>&nbsp;<span class="op" id="4604115">-</span>&nbsp;<span class="ident" id="4604117">d</span><span class="op" id="4604118">.</span><span class="ident" id="4604119">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604127">if</span>&nbsp;<span class="ident" id="4604130">lookahead</span>&nbsp;<span class="op" id="4604140">&lt;</span>&nbsp;<span class="ident" id="4604142">minMatchLength</span><span class="op" id="4604156">+</span><span class="ident" id="4604157">maxMatchLength</span>&nbsp;<span class="op" id="4604172">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604177">if</span>&nbsp;<span class="op" id="4604180">!</span><span class="ident" id="4604181">d</span><span class="op" id="4604182">.</span><span class="ident" id="4604183">sync</span>&nbsp;<span class="op" id="4604188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604194">break</span>&nbsp;<span class="ident" id="4604200">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604213">if</span>&nbsp;<span class="ident" id="4604216">d</span><span class="op" id="4604217">.</span><span class="ident" id="4604218">index</span>&nbsp;<span class="op" id="4604224">&gt;</span>&nbsp;<span class="ident" id="4604226">d</span><span class="op" id="4604227">.</span><span class="ident" id="4604228">windowEnd</span>&nbsp;<span class="op" id="4604238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4604244">panic</span><span class="op" id="4604249">(</span><span class="string" id="4604250">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4604269">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604279">if</span>&nbsp;<span class="ident" id="4604282">lookahead</span>&nbsp;<span class="op" id="4604292">==</span>&nbsp;<span class="num" id="4604295">0</span>&nbsp;<span class="op" id="4604297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604303">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604345">if</span>&nbsp;<span class="ident" id="4604348">d</span><span class="op" id="4604349">.</span><span class="ident" id="4604350">byteAvailable</span>&nbsp;<span class="op" id="4604364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604371">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604437">d</span><span class="op" id="4604438">.</span><span class="ident" id="4604439">tokens</span>&nbsp;<span class="op" id="4604446">=</span>&nbsp;<span class="builtinfunc" id="4604448">append</span><span class="op" id="4604454">(</span><span class="ident" id="4604455">d</span><span class="op" id="4604456">.</span><span class="ident" id="4604457">tokens</span><span class="op" id="4604463">,</span>&nbsp;<span class="ident" id="4604465">literalToken</span><span class="op" id="4604477">(</span><span class="builtintype" id="4604478">uint32</span><span class="op" id="4604484">(</span><span class="ident" id="4604485">d</span><span class="op" id="4604486">.</span><span class="ident" id="4604487">window</span><span class="op" id="4604493">[</span><span class="ident" id="4604494">d</span><span class="op" id="4604495">.</span><span class="ident" id="4604496">index</span><span class="op" id="4604501">-</span><span class="num" id="4604502">1</span><span class="op" id="4604503">]</span><span class="op" id="4604504">)</span><span class="op" id="4604505">)</span><span class="op" id="4604506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604513">d</span><span class="op" id="4604514">.</span><span class="ident" id="4604515">byteAvailable</span>&nbsp;<span class="op" id="4604529">=</span>&nbsp;<span class="builtintype" id="4604531">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604547">if</span>&nbsp;<span class="builtinfunc" id="4604550">len</span><span class="op" id="4604553">(</span><span class="ident" id="4604554">d</span><span class="op" id="4604555">.</span><span class="ident" id="4604556">tokens</span><span class="op" id="4604562">)</span>&nbsp;<span class="op" id="4604564">&gt;</span>&nbsp;<span class="num" id="4604566">0</span>&nbsp;<span class="op" id="4604568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604575">if</span>&nbsp;<span class="ident" id="4604578">d</span><span class="op" id="4604579">.</span><span class="ident" id="4604580">err</span>&nbsp;<span class="op" id="4604584">=</span>&nbsp;<span class="ident" id="4604586">d</span><span class="op" id="4604587">.</span><span class="ident" id="4604588">writeBlock</span><span class="op" id="4604598">(</span><span class="ident" id="4604599">d</span><span class="op" id="4604600">.</span><span class="ident" id="4604601">tokens</span><span class="op" id="4604607">,</span>&nbsp;<span class="ident" id="4604609">d</span><span class="op" id="4604610">.</span><span class="ident" id="4604611">index</span><span class="op" id="4604616">,</span>&nbsp;<span class="builtintype" id="4604618">false</span><span class="op" id="4604623">)</span><span class="op" id="4604624">;</span>&nbsp;<span class="ident" id="4604626">d</span><span class="op" id="4604627">.</span><span class="ident" id="4604628">err</span>&nbsp;<span class="op" id="4604632">!=</span>&nbsp;<span class="ident" id="4604635">nil</span>&nbsp;<span class="op" id="4604639">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604647">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604666">d</span><span class="op" id="4604667">.</span><span class="ident" id="4604668">tokens</span>&nbsp;<span class="op" id="4604675">=</span>&nbsp;<span class="ident" id="4604677">d</span><span class="op" id="4604678">.</span><span class="ident" id="4604679">tokens</span><span class="op" id="4604685">[</span><span class="op" id="4604686">:</span><span class="num" id="4604687">0</span><span class="op" id="4604688">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604700">break</span>&nbsp;<span class="ident" id="4604706">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604722">if</span>&nbsp;<span class="ident" id="4604725">d</span><span class="op" id="4604726">.</span><span class="ident" id="4604727">index</span>&nbsp;<span class="op" id="4604733">&lt;</span>&nbsp;<span class="ident" id="4604735">d</span><span class="op" id="4604736">.</span><span class="ident" id="4604737">maxInsertIndex</span>&nbsp;<span class="op" id="4604752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604757">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604779">d</span><span class="op" id="4604780">.</span><span class="ident" id="4604781">hash</span>&nbsp;<span class="op" id="4604786">=</span>&nbsp;<span class="op" id="4604788">(</span><span class="ident" id="4604789">d</span><span class="op" id="4604790">.</span><span class="ident" id="4604791">hash</span><span class="op" id="4604795">&lt;&lt;</span><span class="ident" id="4604797">hashShift</span>&nbsp;<span class="op" id="4604807">+</span>&nbsp;<span class="builtintype" id="4604809">int</span><span class="op" id="4604812">(</span><span class="ident" id="4604813">d</span><span class="op" id="4604814">.</span><span class="ident" id="4604815">window</span><span class="op" id="4604821">[</span><span class="ident" id="4604822">d</span><span class="op" id="4604823">.</span><span class="ident" id="4604824">index</span><span class="op" id="4604829">+</span><span class="num" id="4604830">2</span><span class="op" id="4604831">]</span><span class="op" id="4604832">)</span><span class="op" id="4604833">)</span>&nbsp;<span class="op" id="4604835">&amp;</span>&nbsp;<span class="ident" id="4604837">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604849">d</span><span class="op" id="4604850">.</span><span class="ident" id="4604851">chainHead</span>&nbsp;<span class="op" id="4604861">=</span>&nbsp;<span class="ident" id="4604863">d</span><span class="op" id="4604864">.</span><span class="ident" id="4604865">hashHead</span><span class="op" id="4604873">[</span><span class="ident" id="4604874">d</span><span class="op" id="4604875">.</span><span class="ident" id="4604876">hash</span><span class="op" id="4604880">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604885">d</span><span class="op" id="4604886">.</span><span class="ident" id="4604887">hashPrev</span><span class="op" id="4604895">[</span><span class="ident" id="4604896">d</span><span class="op" id="4604897">.</span><span class="ident" id="4604898">index</span><span class="op" id="4604903">&amp;</span><span class="ident" id="4604904">windowMask</span><span class="op" id="4604914">]</span>&nbsp;<span class="op" id="4604916">=</span>&nbsp;<span class="ident" id="4604918">d</span><span class="op" id="4604919">.</span><span class="ident" id="4604920">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604933">d</span><span class="op" id="4604934">.</span><span class="ident" id="4604935">hashHead</span><span class="op" id="4604943">[</span><span class="ident" id="4604944">d</span><span class="op" id="4604945">.</span><span class="ident" id="4604946">hash</span><span class="op" id="4604950">]</span>&nbsp;<span class="op" id="4604952">=</span>&nbsp;<span class="ident" id="4604954">d</span><span class="op" id="4604955">.</span><span class="ident" id="4604956">index</span>&nbsp;<span class="op" id="4604962">+</span>&nbsp;<span class="ident" id="4604964">d</span><span class="op" id="4604965">.</span><span class="ident" id="4604966">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604983">prevLength</span>&nbsp;<span class="op" id="4604994">:=</span>&nbsp;<span class="ident" id="4604997">d</span><span class="op" id="4604998">.</span><span class="ident" id="4604999">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605008">prevOffset</span>&nbsp;<span class="op" id="4605019">:=</span>&nbsp;<span class="ident" id="4605022">d</span><span class="op" id="4605023">.</span><span class="ident" id="4605024">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605033">d</span><span class="op" id="4605034">.</span><span class="ident" id="4605035">length</span>&nbsp;<span class="op" id="4605042">=</span>&nbsp;<span class="ident" id="4605044">minMatchLength</span>&nbsp;<span class="op" id="4605059">-</span>&nbsp;<span class="num" id="4605061">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605065">d</span><span class="op" id="4605066">.</span><span class="ident" id="4605067">offset</span>&nbsp;<span class="op" id="4605074">=</span>&nbsp;<span class="num" id="4605076">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605080">minIndex</span>&nbsp;<span class="op" id="4605089">:=</span>&nbsp;<span class="ident" id="4605092">d</span><span class="op" id="4605093">.</span><span class="ident" id="4605094">index</span>&nbsp;<span class="op" id="4605100">-</span>&nbsp;<span class="ident" id="4605102">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605115">if</span>&nbsp;<span class="ident" id="4605118">minIndex</span>&nbsp;<span class="op" id="4605127">&lt;</span>&nbsp;<span class="num" id="4605129">0</span>&nbsp;<span class="op" id="4605131">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605136">minIndex</span>&nbsp;<span class="op" id="4605145">=</span>&nbsp;<span class="num" id="4605147">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605156">if</span>&nbsp;<span class="ident" id="4605159">d</span><span class="op" id="4605160">.</span><span class="ident" id="4605161">chainHead</span><span class="op" id="4605170">-</span><span class="ident" id="4605171">d</span><span class="op" id="4605172">.</span><span class="ident" id="4605173">hashOffset</span>&nbsp;<span class="op" id="4605184">&gt;=</span>&nbsp;<span class="ident" id="4605187">minIndex</span>&nbsp;<span class="op" id="4605196">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605202">(</span><span class="ident" id="4605203">d</span><span class="op" id="4605204">.</span><span class="ident" id="4605205">fastSkipHashing</span>&nbsp;<span class="op" id="4605221">!=</span>&nbsp;<span class="ident" id="4605224">skipNever</span>&nbsp;<span class="op" id="4605234">&amp;&amp;</span>&nbsp;<span class="ident" id="4605237">lookahead</span>&nbsp;<span class="op" id="4605247">&gt;</span>&nbsp;<span class="ident" id="4605249">minMatchLength</span><span class="op" id="4605263">-</span><span class="num" id="4605264">1</span>&nbsp;<span class="op" id="4605266">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605273">d</span><span class="op" id="4605274">.</span><span class="ident" id="4605275">fastSkipHashing</span>&nbsp;<span class="op" id="4605291">==</span>&nbsp;<span class="ident" id="4605294">skipNever</span>&nbsp;<span class="op" id="4605304">&amp;&amp;</span>&nbsp;<span class="ident" id="4605307">lookahead</span>&nbsp;<span class="op" id="4605317">&gt;</span>&nbsp;<span class="ident" id="4605319">prevLength</span>&nbsp;<span class="op" id="4605330">&amp;&amp;</span>&nbsp;<span class="ident" id="4605333">prevLength</span>&nbsp;<span class="op" id="4605344">&lt;</span>&nbsp;<span class="ident" id="4605346">d</span><span class="op" id="4605347">.</span><span class="ident" id="4605348">lazy</span><span class="op" id="4605352">)</span>&nbsp;<span class="op" id="4605354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605359">if</span>&nbsp;<span class="ident" id="4605362">newLength</span><span class="op" id="4605371">,</span>&nbsp;<span class="ident" id="4605373">newOffset</span><span class="op" id="4605382">,</span>&nbsp;<span class="ident" id="4605384">ok</span>&nbsp;<span class="op" id="4605387">:=</span>&nbsp;<span class="ident" id="4605390">d</span><span class="op" id="4605391">.</span><span class="ident" id="4605392">findMatch</span><span class="op" id="4605401">(</span><span class="ident" id="4605402">d</span><span class="op" id="4605403">.</span><span class="ident" id="4605404">index</span><span class="op" id="4605409">,</span>&nbsp;<span class="ident" id="4605411">d</span><span class="op" id="4605412">.</span><span class="ident" id="4605413">chainHead</span><span class="op" id="4605422">-</span><span class="ident" id="4605423">d</span><span class="op" id="4605424">.</span><span class="ident" id="4605425">hashOffset</span><span class="op" id="4605435">,</span>&nbsp;<span class="ident" id="4605437">minMatchLength</span><span class="op" id="4605451">-</span><span class="num" id="4605452">1</span><span class="op" id="4605453">,</span>&nbsp;<span class="ident" id="4605455">lookahead</span><span class="op" id="4605464">)</span><span class="op" id="4605465">;</span>&nbsp;<span class="ident" id="4605467">ok</span>&nbsp;<span class="op" id="4605470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605476">d</span><span class="op" id="4605477">.</span><span class="ident" id="4605478">length</span>&nbsp;<span class="op" id="4605485">=</span>&nbsp;<span class="ident" id="4605487">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605501">d</span><span class="op" id="4605502">.</span><span class="ident" id="4605503">offset</span>&nbsp;<span class="op" id="4605510">=</span>&nbsp;<span class="ident" id="4605512">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605525">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605533">if</span>&nbsp;<span class="ident" id="4605536">d</span><span class="op" id="4605537">.</span><span class="ident" id="4605538">fastSkipHashing</span>&nbsp;<span class="op" id="4605554">!=</span>&nbsp;<span class="ident" id="4605557">skipNever</span>&nbsp;<span class="op" id="4605567">&amp;&amp;</span>&nbsp;<span class="ident" id="4605570">d</span><span class="op" id="4605571">.</span><span class="ident" id="4605572">length</span>&nbsp;<span class="op" id="4605579">&gt;=</span>&nbsp;<span class="ident" id="4605582">minMatchLength</span>&nbsp;<span class="op" id="4605597">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605603">d</span><span class="op" id="4605604">.</span><span class="ident" id="4605605">fastSkipHashing</span>&nbsp;<span class="op" id="4605621">==</span>&nbsp;<span class="ident" id="4605624">skipNever</span>&nbsp;<span class="op" id="4605634">&amp;&amp;</span>&nbsp;<span class="ident" id="4605637">prevLength</span>&nbsp;<span class="op" id="4605648">&gt;=</span>&nbsp;<span class="ident" id="4605651">minMatchLength</span>&nbsp;<span class="op" id="4605666">&amp;&amp;</span>&nbsp;<span class="ident" id="4605669">d</span><span class="op" id="4605670">.</span><span class="ident" id="4605671">length</span>&nbsp;<span class="op" id="4605678">&lt;=</span>&nbsp;<span class="ident" id="4605681">prevLength</span>&nbsp;<span class="op" id="4605692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605697">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605768">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605813">if</span>&nbsp;<span class="ident" id="4605816">d</span><span class="op" id="4605817">.</span><span class="ident" id="4605818">fastSkipHashing</span>&nbsp;<span class="op" id="4605834">!=</span>&nbsp;<span class="ident" id="4605837">skipNever</span>&nbsp;<span class="op" id="4605847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605853">d</span><span class="op" id="4605854">.</span><span class="ident" id="4605855">tokens</span>&nbsp;<span class="op" id="4605862">=</span>&nbsp;<span class="builtinfunc" id="4605864">append</span><span class="op" id="4605870">(</span><span class="ident" id="4605871">d</span><span class="op" id="4605872">.</span><span class="ident" id="4605873">tokens</span><span class="op" id="4605879">,</span>&nbsp;<span class="ident" id="4605881">matchToken</span><span class="op" id="4605891">(</span><span class="builtintype" id="4605892">uint32</span><span class="op" id="4605898">(</span><span class="ident" id="4605899">d</span><span class="op" id="4605900">.</span><span class="ident" id="4605901">length</span><span class="op" id="4605907">-</span><span class="ident" id="4605908">minMatchLength</span><span class="op" id="4605922">)</span><span class="op" id="4605923">,</span>&nbsp;<span class="builtintype" id="4605925">uint32</span><span class="op" id="4605931">(</span><span class="ident" id="4605932">d</span><span class="op" id="4605933">.</span><span class="ident" id="4605934">offset</span><span class="op" id="4605940">-</span><span class="ident" id="4605941">minOffsetSize</span><span class="op" id="4605954">)</span><span class="op" id="4605955">)</span><span class="op" id="4605956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605961">}</span>&nbsp;<span class="keyword" id="4605963">else</span>&nbsp;<span class="op" id="4605968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605974">d</span><span class="op" id="4605975">.</span><span class="ident" id="4605976">tokens</span>&nbsp;<span class="op" id="4605983">=</span>&nbsp;<span class="builtinfunc" id="4605985">append</span><span class="op" id="4605991">(</span><span class="ident" id="4605992">d</span><span class="op" id="4605993">.</span><span class="ident" id="4605994">tokens</span><span class="op" id="4606000">,</span>&nbsp;<span class="ident" id="4606002">matchToken</span><span class="op" id="4606012">(</span><span class="builtintype" id="4606013">uint32</span><span class="op" id="4606019">(</span><span class="ident" id="4606020">prevLength</span><span class="op" id="4606030">-</span><span class="ident" id="4606031">minMatchLength</span><span class="op" id="4606045">)</span><span class="op" id="4606046">,</span>&nbsp;<span class="builtintype" id="4606048">uint32</span><span class="op" id="4606054">(</span><span class="ident" id="4606055">prevOffset</span><span class="op" id="4606065">-</span><span class="ident" id="4606066">minOffsetSize</span><span class="op" id="4606079">)</span><span class="op" id="4606080">)</span><span class="op" id="4606081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606086">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606091">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606162">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606231">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606300">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606313">if</span>&nbsp;<span class="ident" id="4606316">d</span><span class="op" id="4606317">.</span><span class="ident" id="4606318">length</span>&nbsp;<span class="op" id="4606325">&lt;=</span>&nbsp;<span class="ident" id="4606328">d</span><span class="op" id="4606329">.</span><span class="ident" id="4606330">fastSkipHashing</span>&nbsp;<span class="op" id="4606346">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606352">var</span>&nbsp;<span class="ident" id="4606356">newIndex</span>&nbsp;<span class="builtintype" id="4606365">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606373">if</span>&nbsp;<span class="ident" id="4606376">d</span><span class="op" id="4606377">.</span><span class="ident" id="4606378">fastSkipHashing</span>&nbsp;<span class="op" id="4606394">!=</span>&nbsp;<span class="ident" id="4606397">skipNever</span>&nbsp;<span class="op" id="4606407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606414">newIndex</span>&nbsp;<span class="op" id="4606423">=</span>&nbsp;<span class="ident" id="4606425">d</span><span class="op" id="4606426">.</span><span class="ident" id="4606427">index</span>&nbsp;<span class="op" id="4606433">+</span>&nbsp;<span class="ident" id="4606435">d</span><span class="op" id="4606436">.</span><span class="ident" id="4606437">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606448">}</span>&nbsp;<span class="keyword" id="4606450">else</span>&nbsp;<span class="op" id="4606455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606462">newIndex</span>&nbsp;<span class="op" id="4606471">=</span>&nbsp;<span class="ident" id="4606473">d</span><span class="op" id="4606474">.</span><span class="ident" id="4606475">index</span>&nbsp;<span class="op" id="4606481">+</span>&nbsp;<span class="ident" id="4606483">prevLength</span>&nbsp;<span class="op" id="4606494">-</span>&nbsp;<span class="num" id="4606496">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606508">for</span>&nbsp;<span class="ident" id="4606512">d</span><span class="op" id="4606513">.</span><span class="ident" id="4606514">index</span><span class="op" id="4606519">++</span><span class="op" id="4606521">;</span>&nbsp;<span class="ident" id="4606523">d</span><span class="op" id="4606524">.</span><span class="ident" id="4606525">index</span>&nbsp;<span class="op" id="4606531">&lt;</span>&nbsp;<span class="ident" id="4606533">newIndex</span><span class="op" id="4606541">;</span>&nbsp;<span class="ident" id="4606543">d</span><span class="op" id="4606544">.</span><span class="ident" id="4606545">index</span><span class="op" id="4606550">++</span>&nbsp;<span class="op" id="4606553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606560">if</span>&nbsp;<span class="ident" id="4606563">d</span><span class="op" id="4606564">.</span><span class="ident" id="4606565">index</span>&nbsp;<span class="op" id="4606571">&lt;</span>&nbsp;<span class="ident" id="4606573">d</span><span class="op" id="4606574">.</span><span class="ident" id="4606575">maxInsertIndex</span>&nbsp;<span class="op" id="4606590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606598">d</span><span class="op" id="4606599">.</span><span class="ident" id="4606600">hash</span>&nbsp;<span class="op" id="4606605">=</span>&nbsp;<span class="op" id="4606607">(</span><span class="ident" id="4606608">d</span><span class="op" id="4606609">.</span><span class="ident" id="4606610">hash</span><span class="op" id="4606614">&lt;&lt;</span><span class="ident" id="4606616">hashShift</span>&nbsp;<span class="op" id="4606626">+</span>&nbsp;<span class="builtintype" id="4606628">int</span><span class="op" id="4606631">(</span><span class="ident" id="4606632">d</span><span class="op" id="4606633">.</span><span class="ident" id="4606634">window</span><span class="op" id="4606640">[</span><span class="ident" id="4606641">d</span><span class="op" id="4606642">.</span><span class="ident" id="4606643">index</span><span class="op" id="4606648">+</span><span class="num" id="4606649">2</span><span class="op" id="4606650">]</span><span class="op" id="4606651">)</span><span class="op" id="4606652">)</span>&nbsp;<span class="op" id="4606654">&amp;</span>&nbsp;<span class="ident" id="4606656">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606671">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606719">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606774">d</span><span class="op" id="4606775">.</span><span class="ident" id="4606776">hashPrev</span><span class="op" id="4606784">[</span><span class="ident" id="4606785">d</span><span class="op" id="4606786">.</span><span class="ident" id="4606787">index</span><span class="op" id="4606792">&amp;</span><span class="ident" id="4606793">windowMask</span><span class="op" id="4606803">]</span>&nbsp;<span class="op" id="4606805">=</span>&nbsp;<span class="ident" id="4606807">d</span><span class="op" id="4606808">.</span><span class="ident" id="4606809">hashHead</span><span class="op" id="4606817">[</span><span class="ident" id="4606818">d</span><span class="op" id="4606819">.</span><span class="ident" id="4606820">hash</span><span class="op" id="4606824">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606832">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606879">d</span><span class="op" id="4606880">.</span><span class="ident" id="4606881">hashHead</span><span class="op" id="4606889">[</span><span class="ident" id="4606890">d</span><span class="op" id="4606891">.</span><span class="ident" id="4606892">hash</span><span class="op" id="4606896">]</span>&nbsp;<span class="op" id="4606898">=</span>&nbsp;<span class="ident" id="4606900">d</span><span class="op" id="4606901">.</span><span class="ident" id="4606902">index</span>&nbsp;<span class="op" id="4606908">+</span>&nbsp;<span class="ident" id="4606910">d</span><span class="op" id="4606911">.</span><span class="ident" id="4606912">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606928">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606940">if</span>&nbsp;<span class="ident" id="4606943">d</span><span class="op" id="4606944">.</span><span class="ident" id="4606945">fastSkipHashing</span>&nbsp;<span class="op" id="4606961">==</span>&nbsp;<span class="ident" id="4606964">skipNever</span>&nbsp;<span class="op" id="4606974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606981">d</span><span class="op" id="4606982">.</span><span class="ident" id="4606983">byteAvailable</span>&nbsp;<span class="op" id="4606997">=</span>&nbsp;<span class="builtintype" id="4606999">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607010">d</span><span class="op" id="4607011">.</span><span class="ident" id="4607012">length</span>&nbsp;<span class="op" id="4607019">=</span>&nbsp;<span class="ident" id="4607021">minMatchLength</span>&nbsp;<span class="op" id="4607036">-</span>&nbsp;<span class="num" id="4607038">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607044">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607049">}</span>&nbsp;<span class="keyword" id="4607051">else</span>&nbsp;<span class="op" id="4607056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4607062">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4607134">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607162">d</span><span class="op" id="4607163">.</span><span class="ident" id="4607164">index</span>&nbsp;<span class="op" id="4607170">+=</span>&nbsp;<span class="ident" id="4607173">d</span><span class="op" id="4607174">.</span><span class="ident" id="4607175">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607186">if</span>&nbsp;<span class="ident" id="4607189">d</span><span class="op" id="4607190">.</span><span class="ident" id="4607191">index</span>&nbsp;<span class="op" id="4607197">&lt;</span>&nbsp;<span class="ident" id="4607199">d</span><span class="op" id="4607200">.</span><span class="ident" id="4607201">maxInsertIndex</span>&nbsp;<span class="op" id="4607216">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607223">d</span><span class="op" id="4607224">.</span><span class="ident" id="4607225">hash</span>&nbsp;<span class="op" id="4607230">=</span>&nbsp;<span class="op" id="4607232">(</span><span class="builtintype" id="4607233">int</span><span class="op" id="4607236">(</span><span class="ident" id="4607237">d</span><span class="op" id="4607238">.</span><span class="ident" id="4607239">window</span><span class="op" id="4607245">[</span><span class="ident" id="4607246">d</span><span class="op" id="4607247">.</span><span class="ident" id="4607248">index</span><span class="op" id="4607253">]</span><span class="op" id="4607254">)</span><span class="op" id="4607255">&lt;&lt;</span><span class="ident" id="4607257">hashShift</span>&nbsp;<span class="op" id="4607267">+</span>&nbsp;<span class="builtintype" id="4607269">int</span><span class="op" id="4607272">(</span><span class="ident" id="4607273">d</span><span class="op" id="4607274">.</span><span class="ident" id="4607275">window</span><span class="op" id="4607281">[</span><span class="ident" id="4607282">d</span><span class="op" id="4607283">.</span><span class="ident" id="4607284">index</span><span class="op" id="4607289">+</span><span class="num" id="4607290">1</span><span class="op" id="4607291">]</span><span class="op" id="4607292">)</span><span class="op" id="4607293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607309">if</span>&nbsp;<span class="builtinfunc" id="4607312">len</span><span class="op" id="4607315">(</span><span class="ident" id="4607316">d</span><span class="op" id="4607317">.</span><span class="ident" id="4607318">tokens</span><span class="op" id="4607324">)</span>&nbsp;<span class="op" id="4607326">==</span>&nbsp;<span class="ident" id="4607329">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4607349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4607355">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607403">if</span>&nbsp;<span class="ident" id="4607406">d</span><span class="op" id="4607407">.</span><span class="ident" id="4607408">err</span>&nbsp;<span class="op" id="4607412">=</span>&nbsp;<span class="ident" id="4607414">d</span><span class="op" id="4607415">.</span><span class="ident" id="4607416">writeBlock</span><span class="op" id="4607426">(</span><span class="ident" id="4607427">d</span><span class="op" id="4607428">.</span><span class="ident" id="4607429">tokens</span><span class="op" id="4607435">,</span>&nbsp;<span class="ident" id="4607437">d</span><span class="op" id="4607438">.</span><span class="ident" id="4607439">index</span><span class="op" id="4607444">,</span>&nbsp;<span class="builtintype" id="4607446">false</span><span class="op" id="4607451">)</span><span class="op" id="4607452">;</span>&nbsp;<span class="ident" id="4607454">d</span><span class="op" id="4607455">.</span><span class="ident" id="4607456">err</span>&nbsp;<span class="op" id="4607460">!=</span>&nbsp;<span class="ident" id="4607463">nil</span>&nbsp;<span class="op" id="4607467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607474">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607491">d</span><span class="op" id="4607492">.</span><span class="ident" id="4607493">tokens</span>&nbsp;<span class="op" id="4607500">=</span>&nbsp;<span class="ident" id="4607502">d</span><span class="op" id="4607503">.</span><span class="ident" id="4607504">tokens</span><span class="op" id="4607510">[</span><span class="op" id="4607511">:</span><span class="num" id="4607512">0</span><span class="op" id="4607513">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607518">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607522">}</span>&nbsp;<span class="keyword" id="4607524">else</span>&nbsp;<span class="op" id="4607529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607534">if</span>&nbsp;<span class="ident" id="4607537">d</span><span class="op" id="4607538">.</span><span class="ident" id="4607539">fastSkipHashing</span>&nbsp;<span class="op" id="4607555">!=</span>&nbsp;<span class="ident" id="4607558">skipNever</span>&nbsp;<span class="op" id="4607568">||</span>&nbsp;<span class="ident" id="4607571">d</span><span class="op" id="4607572">.</span><span class="ident" id="4607573">byteAvailable</span>&nbsp;<span class="op" id="4607587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607593">i</span>&nbsp;<span class="op" id="4607595">:=</span>&nbsp;<span class="ident" id="4607598">d</span><span class="op" id="4607599">.</span><span class="ident" id="4607600">index</span>&nbsp;<span class="op" id="4607606">-</span>&nbsp;<span class="num" id="4607608">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607614">if</span>&nbsp;<span class="ident" id="4607617">d</span><span class="op" id="4607618">.</span><span class="ident" id="4607619">fastSkipHashing</span>&nbsp;<span class="op" id="4607635">!=</span>&nbsp;<span class="ident" id="4607638">skipNever</span>&nbsp;<span class="op" id="4607648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607655">i</span>&nbsp;<span class="op" id="4607657">=</span>&nbsp;<span class="ident" id="4607659">d</span><span class="op" id="4607660">.</span><span class="ident" id="4607661">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607677">d</span><span class="op" id="4607678">.</span><span class="ident" id="4607679">tokens</span>&nbsp;<span class="op" id="4607686">=</span>&nbsp;<span class="builtinfunc" id="4607688">append</span><span class="op" id="4607694">(</span><span class="ident" id="4607695">d</span><span class="op" id="4607696">.</span><span class="ident" id="4607697">tokens</span><span class="op" id="4607703">,</span>&nbsp;<span class="ident" id="4607705">literalToken</span><span class="op" id="4607717">(</span><span class="builtintype" id="4607718">uint32</span><span class="op" id="4607724">(</span><span class="ident" id="4607725">d</span><span class="op" id="4607726">.</span><span class="ident" id="4607727">window</span><span class="op" id="4607733">[</span><span class="ident" id="4607734">i</span><span class="op" id="4607735">]</span><span class="op" id="4607736">)</span><span class="op" id="4607737">)</span><span class="op" id="4607738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607744">if</span>&nbsp;<span class="builtinfunc" id="4607747">len</span><span class="op" id="4607750">(</span><span class="ident" id="4607751">d</span><span class="op" id="4607752">.</span><span class="ident" id="4607753">tokens</span><span class="op" id="4607759">)</span>&nbsp;<span class="op" id="4607761">==</span>&nbsp;<span class="ident" id="4607764">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4607784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607791">if</span>&nbsp;<span class="ident" id="4607794">d</span><span class="op" id="4607795">.</span><span class="ident" id="4607796">err</span>&nbsp;<span class="op" id="4607800">=</span>&nbsp;<span class="ident" id="4607802">d</span><span class="op" id="4607803">.</span><span class="ident" id="4607804">writeBlock</span><span class="op" id="4607814">(</span><span class="ident" id="4607815">d</span><span class="op" id="4607816">.</span><span class="ident" id="4607817">tokens</span><span class="op" id="4607823">,</span>&nbsp;<span class="ident" id="4607825">i</span><span class="op" id="4607826">+</span><span class="num" id="4607827">1</span><span class="op" id="4607828">,</span>&nbsp;<span class="builtintype" id="4607830">false</span><span class="op" id="4607835">)</span><span class="op" id="4607836">;</span>&nbsp;<span class="ident" id="4607838">d</span><span class="op" id="4607839">.</span><span class="ident" id="4607840">err</span>&nbsp;<span class="op" id="4607844">!=</span>&nbsp;<span class="ident" id="4607847">nil</span>&nbsp;<span class="op" id="4607851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607859">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607878">d</span><span class="op" id="4607879">.</span><span class="ident" id="4607880">tokens</span>&nbsp;<span class="op" id="4607887">=</span>&nbsp;<span class="ident" id="4607889">d</span><span class="op" id="4607890">.</span><span class="ident" id="4607891">tokens</span><span class="op" id="4607897">[</span><span class="op" id="4607898">:</span><span class="num" id="4607899">0</span><span class="op" id="4607900">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607916">d</span><span class="op" id="4607917">.</span><span class="ident" id="4607918">index</span><span class="op" id="4607923">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607929">if</span>&nbsp;<span class="ident" id="4607932">d</span><span class="op" id="4607933">.</span><span class="ident" id="4607934">fastSkipHashing</span>&nbsp;<span class="op" id="4607950">==</span>&nbsp;<span class="ident" id="4607953">skipNever</span>&nbsp;<span class="op" id="4607963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607969">d</span><span class="op" id="4607970">.</span><span class="ident" id="4607971">byteAvailable</span>&nbsp;<span class="op" id="4607985">=</span>&nbsp;<span class="builtintype" id="4607987">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608002">}</span><br>
<span class="lineno">360</span><span class="op" id="4608004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4608007">func</span>&nbsp;<span class="op" id="4608012">(</span><span class="ident" id="4608013">d</span>&nbsp;<span class="op" id="4608015">*</span><span class="ident" id="4608016">compressor</span><span class="op" id="4608026">)</span>&nbsp;<span class="ident" id="4608028">fillStore</span><span class="op" id="4608037">(</span><span class="ident" id="4608038">b</span>&nbsp;<span class="op" id="4608040">[</span><span class="op" id="4608041">]</span><span class="builtintype" id="4608042">byte</span><span class="op" id="4608046">)</span>&nbsp;<span class="builtintype" id="4608048">int</span>&nbsp;<span class="op" id="4608052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608055">n</span>&nbsp;<span class="op" id="4608057">:=</span>&nbsp;<span class="builtinfunc" id="4608060">copy</span><span class="op" id="4608064">(</span><span class="ident" id="4608065">d</span><span class="op" id="4608066">.</span><span class="ident" id="4608067">window</span><span class="op" id="4608073">[</span><span class="ident" id="4608074">d</span><span class="op" id="4608075">.</span><span class="ident" id="4608076">windowEnd</span><span class="op" id="4608085">:</span><span class="op" id="4608086">]</span><span class="op" id="4608087">,</span>&nbsp;<span class="ident" id="4608089">b</span><span class="op" id="4608090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608093">d</span><span class="op" id="4608094">.</span><span class="ident" id="4608095">windowEnd</span>&nbsp;<span class="op" id="4608105">+=</span>&nbsp;<span class="ident" id="4608108">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608111">return</span>&nbsp;<span class="ident" id="4608118">n</span><br>
<span class="lineno"></span><span class="op" id="4608120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4608123">func</span>&nbsp;<span class="op" id="4608128">(</span><span class="ident" id="4608129">d</span>&nbsp;<span class="op" id="4608131">*</span><span class="ident" id="4608132">compressor</span><span class="op" id="4608142">)</span>&nbsp;<span class="ident" id="4608144">store</span><span class="op" id="4608149">(</span><span class="op" id="4608150">)</span>&nbsp;<span class="op" id="4608152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608155">if</span>&nbsp;<span class="ident" id="4608158">d</span><span class="op" id="4608159">.</span><span class="ident" id="4608160">windowEnd</span>&nbsp;<span class="op" id="4608170">&gt;</span>&nbsp;<span class="num" id="4608172">0</span>&nbsp;<span class="op" id="4608174">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608178">d</span><span class="op" id="4608179">.</span><span class="ident" id="4608180">err</span>&nbsp;<span class="op" id="4608184">=</span>&nbsp;<span class="ident" id="4608186">d</span><span class="op" id="4608187">.</span><span class="ident" id="4608188">writeStoredBlock</span><span class="op" id="4608204">(</span><span class="ident" id="4608205">d</span><span class="op" id="4608206">.</span><span class="ident" id="4608207">window</span><span class="op" id="4608213">[</span><span class="op" id="4608214">:</span><span class="ident" id="4608215">d</span><span class="op" id="4608216">.</span><span class="ident" id="4608217">windowEnd</span><span class="op" id="4608226">]</span><span class="op" id="4608227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608233">d</span><span class="op" id="4608234">.</span><span class="ident" id="4608235">windowEnd</span>&nbsp;<span class="op" id="4608245">=</span>&nbsp;<span class="num" id="4608247">0</span><br>
<span class="lineno"></span><span class="op" id="4608249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4608252">func</span>&nbsp;<span class="op" id="4608257">(</span><span class="ident" id="4608258">d</span>&nbsp;<span class="op" id="4608260">*</span><span class="ident" id="4608261">compressor</span><span class="op" id="4608271">)</span>&nbsp;<span class="ident" id="4608273">write</span><span class="op" id="4608278">(</span><span class="ident" id="4608279">b</span>&nbsp;<span class="op" id="4608281">[</span><span class="op" id="4608282">]</span><span class="builtintype" id="4608283">byte</span><span class="op" id="4608287">)</span>&nbsp;<span class="op" id="4608289">(</span><span class="ident" id="4608290">n</span>&nbsp;<span class="builtintype" id="4608292">int</span><span class="op" id="4608295">,</span>&nbsp;<span class="ident" id="4608297">err</span>&nbsp;<span class="builtintype" id="4608301">error</span><span class="op" id="4608306">)</span>&nbsp;<span class="op" id="4608308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608311">n</span>&nbsp;<span class="op" id="4608313">=</span>&nbsp;<span class="builtinfunc" id="4608315">len</span><span class="op" id="4608318">(</span><span class="ident" id="4608319">b</span><span class="op" id="4608320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608323">b</span>&nbsp;<span class="op" id="4608325">=</span>&nbsp;<span class="ident" id="4608327">b</span><span class="op" id="4608328">[</span><span class="ident" id="4608329">d</span><span class="op" id="4608330">.</span><span class="ident" id="4608331">fill</span><span class="op" id="4608335">(</span><span class="ident" id="4608336">d</span><span class="op" id="4608337">,</span>&nbsp;<span class="ident" id="4608339">b</span><span class="op" id="4608340">)</span><span class="op" id="4608341">:</span><span class="op" id="4608342">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608345">for</span>&nbsp;<span class="builtinfunc" id="4608349">len</span><span class="op" id="4608352">(</span><span class="ident" id="4608353">b</span><span class="op" id="4608354">)</span>&nbsp;<span class="op" id="4608356">&gt;</span>&nbsp;<span class="num" id="4608358">0</span>&nbsp;<span class="op" id="4608360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608364">d</span><span class="op" id="4608365">.</span><span class="ident" id="4608366">step</span><span class="op" id="4608370">(</span><span class="ident" id="4608371">d</span><span class="op" id="4608372">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608376">b</span>&nbsp;<span class="op" id="4608378">=</span>&nbsp;<span class="ident" id="4608380">b</span><span class="op" id="4608381">[</span><span class="ident" id="4608382">d</span><span class="op" id="4608383">.</span><span class="ident" id="4608384">fill</span><span class="op" id="4608388">(</span><span class="ident" id="4608389">d</span><span class="op" id="4608390">,</span>&nbsp;<span class="ident" id="4608392">b</span><span class="op" id="4608393">)</span><span class="op" id="4608394">:</span><span class="op" id="4608395">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608401">return</span>&nbsp;<span class="ident" id="4608408">n</span><span class="op" id="4608409">,</span>&nbsp;<span class="ident" id="4608411">d</span><span class="op" id="4608412">.</span><span class="ident" id="4608413">err</span><br>
<span class="lineno"></span><span class="op" id="4608417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4608420">func</span>&nbsp;<span class="op" id="4608425">(</span><span class="ident" id="4608426">d</span>&nbsp;<span class="op" id="4608428">*</span><span class="ident" id="4608429">compressor</span><span class="op" id="4608439">)</span>&nbsp;<span class="ident" id="4608441">syncFlush</span><span class="op" id="4608450">(</span><span class="op" id="4608451">)</span>&nbsp;<span class="builtintype" id="4608453">error</span>&nbsp;<span class="op" id="4608459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608462">d</span><span class="op" id="4608463">.</span><span class="ident" id="4608464">sync</span>&nbsp;<span class="op" id="4608469">=</span>&nbsp;<span class="builtintype" id="4608471">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608477">d</span><span class="op" id="4608478">.</span><span class="ident" id="4608479">step</span><span class="op" id="4608483">(</span><span class="ident" id="4608484">d</span><span class="op" id="4608485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608488">if</span>&nbsp;<span class="ident" id="4608491">d</span><span class="op" id="4608492">.</span><span class="ident" id="4608493">err</span>&nbsp;<span class="op" id="4608497">==</span>&nbsp;<span class="ident" id="4608500">nil</span>&nbsp;<span class="op" id="4608504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608508">d</span><span class="op" id="4608509">.</span><span class="ident" id="4608510">w</span><span class="op" id="4608511">.</span><span class="ident" id="4608512">writeStoredHeader</span><span class="op" id="4608529">(</span><span class="num" id="4608530">0</span><span class="op" id="4608531">,</span>&nbsp;<span class="builtintype" id="4608533">false</span><span class="op" id="4608538">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608542">d</span><span class="op" id="4608543">.</span><span class="ident" id="4608544">w</span><span class="op" id="4608545">.</span><span class="ident" id="4608546">flush</span><span class="op" id="4608551">(</span><span class="op" id="4608552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608556">d</span><span class="op" id="4608557">.</span><span class="ident" id="4608558">err</span>&nbsp;<span class="op" id="4608562">=</span>&nbsp;<span class="ident" id="4608564">d</span><span class="op" id="4608565">.</span><span class="ident" id="4608566">w</span><span class="op" id="4608567">.</span><span class="ident" id="4608568">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608576">d</span><span class="op" id="4608577">.</span><span class="ident" id="4608578">sync</span>&nbsp;<span class="op" id="4608583">=</span>&nbsp;<span class="builtintype" id="4608585">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608592">return</span>&nbsp;<span class="ident" id="4608599">d</span><span class="op" id="4608600">.</span><span class="ident" id="4608601">err</span><br>
<span class="lineno">395</span><span class="op" id="4608605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4608608">func</span>&nbsp;<span class="op" id="4608613">(</span><span class="ident" id="4608614">d</span>&nbsp;<span class="op" id="4608616">*</span><span class="ident" id="4608617">compressor</span><span class="op" id="4608627">)</span>&nbsp;<span class="ident" id="4608629">init</span><span class="op" id="4608633">(</span><span class="ident" id="4608634">w</span>&nbsp;<span class="ident" id="4608636">io</span><span class="op" id="4608638">.</span><span class="ident" id="4608639">Writer</span><span class="op" id="4608645">,</span>&nbsp;<span class="ident" id="4608647">level</span>&nbsp;<span class="builtintype" id="4608653">int</span><span class="op" id="4608656">)</span>&nbsp;<span class="op" id="4608658">(</span><span class="ident" id="4608659">err</span>&nbsp;<span class="builtintype" id="4608663">error</span><span class="op" id="4608668">)</span>&nbsp;<span class="op" id="4608670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608673">d</span><span class="op" id="4608674">.</span><span class="ident" id="4608675">w</span>&nbsp;<span class="op" id="4608677">=</span>&nbsp;<span class="ident" id="4608679">newHuffmanBitWriter</span><span class="op" id="4608698">(</span><span class="ident" id="4608699">w</span><span class="op" id="4608700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608704">switch</span>&nbsp;<span class="op" id="4608711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608714">case</span>&nbsp;<span class="ident" id="4608719">level</span>&nbsp;<span class="op" id="4608725">==</span>&nbsp;<span class="ident" id="4608728">NoCompression</span><span class="op" id="4608741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608745">d</span><span class="op" id="4608746">.</span><span class="ident" id="4608747">window</span>&nbsp;<span class="op" id="4608754">=</span>&nbsp;<span class="builtinfunc" id="4608756">make</span><span class="op" id="4608760">(</span><span class="op" id="4608761">[</span><span class="op" id="4608762">]</span><span class="builtintype" id="4608763">byte</span><span class="op" id="4608767">,</span>&nbsp;<span class="ident" id="4608769">maxStoreBlockSize</span><span class="op" id="4608786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608790">d</span><span class="op" id="4608791">.</span><span class="ident" id="4608792">fill</span>&nbsp;<span class="op" id="4608797">=</span>&nbsp;<span class="op" id="4608799">(</span><span class="op" id="4608800">*</span><span class="ident" id="4608801">compressor</span><span class="op" id="4608811">)</span><span class="op" id="4608812">.</span><span class="ident" id="4608813">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608825">d</span><span class="op" id="4608826">.</span><span class="ident" id="4608827">step</span>&nbsp;<span class="op" id="4608832">=</span>&nbsp;<span class="op" id="4608834">(</span><span class="op" id="4608835">*</span><span class="ident" id="4608836">compressor</span><span class="op" id="4608846">)</span><span class="op" id="4608847">.</span><span class="ident" id="4608848">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608855">case</span>&nbsp;<span class="ident" id="4608860">level</span>&nbsp;<span class="op" id="4608866">==</span>&nbsp;<span class="ident" id="4608869">DefaultCompression</span><span class="op" id="4608887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608891">level</span>&nbsp;<span class="op" id="4608897">=</span>&nbsp;<span class="num" id="4608899">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608903">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608916">case</span>&nbsp;<span class="num" id="4608921">1</span>&nbsp;<span class="op" id="4608923">&lt;=</span>&nbsp;<span class="ident" id="4608926">level</span>&nbsp;<span class="op" id="4608932">&amp;&amp;</span>&nbsp;<span class="ident" id="4608935">level</span>&nbsp;<span class="op" id="4608941">&lt;=</span>&nbsp;<span class="num" id="4608944">9</span><span class="op" id="4608945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608949">d</span><span class="op" id="4608950">.</span><span class="ident" id="4608951">compressionLevel</span>&nbsp;<span class="op" id="4608968">=</span>&nbsp;<span class="ident" id="4608970">levels</span><span class="op" id="4608976">[</span><span class="ident" id="4608977">level</span><span class="op" id="4608982">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608986">d</span><span class="op" id="4608987">.</span><span class="ident" id="4608988">initDeflate</span><span class="op" id="4608999">(</span><span class="op" id="4609000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609004">d</span><span class="op" id="4609005">.</span><span class="ident" id="4609006">fill</span>&nbsp;<span class="op" id="4609011">=</span>&nbsp;<span class="op" id="4609013">(</span><span class="op" id="4609014">*</span><span class="ident" id="4609015">compressor</span><span class="op" id="4609025">)</span><span class="op" id="4609026">.</span><span class="ident" id="4609027">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609041">d</span><span class="op" id="4609042">.</span><span class="ident" id="4609043">step</span>&nbsp;<span class="op" id="4609048">=</span>&nbsp;<span class="op" id="4609050">(</span><span class="op" id="4609051">*</span><span class="ident" id="4609052">compressor</span><span class="op" id="4609062">)</span><span class="op" id="4609063">.</span><span class="ident" id="4609064">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609073">default</span><span class="op" id="4609080">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609084">return</span>&nbsp;<span class="ident" id="4609091">fmt</span><span class="op" id="4609094">.</span><span class="ident" id="4609095">Errorf</span><span class="op" id="4609101">(</span><span class="string" id="4609102">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4609168">,</span>&nbsp;<span class="ident" id="4609170">level</span><span class="op" id="4609175">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609181">return</span>&nbsp;<span class="ident" id="4609188">nil</span><br>
<span class="lineno"></span><span class="op" id="4609192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4609195">var</span>&nbsp;<span class="ident" id="4609199">zeroes</span>&nbsp;<span class="op" id="4609206">[</span><span class="num" id="4609207">32</span><span class="op" id="4609209">]</span><span class="builtintype" id="4609210">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4609214">var</span>&nbsp;<span class="ident" id="4609218">bzeroes</span>&nbsp;<span class="op" id="4609226">[</span><span class="num" id="4609227">256</span><span class="op" id="4609230">]</span><span class="builtintype" id="4609231">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4609237">func</span>&nbsp;<span class="op" id="4609242">(</span><span class="ident" id="4609243">d</span>&nbsp;<span class="op" id="4609245">*</span><span class="ident" id="4609246">compressor</span><span class="op" id="4609256">)</span>&nbsp;<span class="ident" id="4609258">reset</span><span class="op" id="4609263">(</span><span class="ident" id="4609264">w</span>&nbsp;<span class="ident" id="4609266">io</span><span class="op" id="4609268">.</span><span class="ident" id="4609269">Writer</span><span class="op" id="4609275">)</span>&nbsp;<span class="op" id="4609277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609280">d</span><span class="op" id="4609281">.</span><span class="ident" id="4609282">w</span><span class="op" id="4609283">.</span><span class="ident" id="4609284">reset</span><span class="op" id="4609289">(</span><span class="ident" id="4609290">w</span><span class="op" id="4609291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609294">d</span><span class="op" id="4609295">.</span><span class="ident" id="4609296">sync</span>&nbsp;<span class="op" id="4609301">=</span>&nbsp;<span class="builtintype" id="4609303">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609310">d</span><span class="op" id="4609311">.</span><span class="ident" id="4609312">err</span>&nbsp;<span class="op" id="4609316">=</span>&nbsp;<span class="ident" id="4609318">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609323">switch</span>&nbsp;<span class="ident" id="4609330">d</span><span class="op" id="4609331">.</span><span class="ident" id="4609332">compressionLevel</span><span class="op" id="4609348">.</span><span class="ident" id="4609349">chain</span>&nbsp;<span class="op" id="4609355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609358">case</span>&nbsp;<span class="num" id="4609363">0</span><span class="op" id="4609364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609368">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609398">for</span>&nbsp;<span class="ident" id="4609402">i</span>&nbsp;<span class="op" id="4609404">:=</span>&nbsp;<span class="keyword" id="4609407">range</span>&nbsp;<span class="ident" id="4609413">d</span><span class="op" id="4609414">.</span><span class="ident" id="4609415">window</span>&nbsp;<span class="op" id="4609422">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609427">d</span><span class="op" id="4609428">.</span><span class="ident" id="4609429">window</span><span class="op" id="4609435">[</span><span class="ident" id="4609436">i</span><span class="op" id="4609437">]</span>&nbsp;<span class="op" id="4609439">=</span>&nbsp;<span class="num" id="4609441">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609449">d</span><span class="op" id="4609450">.</span><span class="ident" id="4609451">windowEnd</span>&nbsp;<span class="op" id="4609461">=</span>&nbsp;<span class="num" id="4609463">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609466">default</span><span class="op" id="4609473">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609477">d</span><span class="op" id="4609478">.</span><span class="ident" id="4609479">chainHead</span>&nbsp;<span class="op" id="4609489">=</span>&nbsp;<span class="op" id="4609491">-</span><span class="num" id="4609492">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609496">for</span>&nbsp;<span class="ident" id="4609500">s</span>&nbsp;<span class="op" id="4609502">:=</span>&nbsp;<span class="ident" id="4609505">d</span><span class="op" id="4609506">.</span><span class="ident" id="4609507">hashHead</span><span class="op" id="4609515">;</span>&nbsp;<span class="builtinfunc" id="4609517">len</span><span class="op" id="4609520">(</span><span class="ident" id="4609521">s</span><span class="op" id="4609522">)</span>&nbsp;<span class="op" id="4609524">&gt;</span>&nbsp;<span class="num" id="4609526">0</span><span class="op" id="4609527">;</span>&nbsp;<span class="op" id="4609529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609534">n</span>&nbsp;<span class="op" id="4609536">:=</span>&nbsp;<span class="builtinfunc" id="4609539">copy</span><span class="op" id="4609543">(</span><span class="ident" id="4609544">s</span><span class="op" id="4609545">,</span>&nbsp;<span class="ident" id="4609547">zeroes</span><span class="op" id="4609553">[</span><span class="op" id="4609554">:</span><span class="op" id="4609555">]</span><span class="op" id="4609556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609561">s</span>&nbsp;<span class="op" id="4609563">=</span>&nbsp;<span class="ident" id="4609565">s</span><span class="op" id="4609566">[</span><span class="ident" id="4609567">n</span><span class="op" id="4609568">:</span><span class="op" id="4609569">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609577">for</span>&nbsp;<span class="ident" id="4609581">s</span>&nbsp;<span class="op" id="4609583">:=</span>&nbsp;<span class="ident" id="4609586">d</span><span class="op" id="4609587">.</span><span class="ident" id="4609588">hashPrev</span><span class="op" id="4609596">;</span>&nbsp;<span class="builtinfunc" id="4609598">len</span><span class="op" id="4609601">(</span><span class="ident" id="4609602">s</span><span class="op" id="4609603">)</span>&nbsp;<span class="op" id="4609605">&gt;</span>&nbsp;<span class="num" id="4609607">0</span><span class="op" id="4609608">;</span>&nbsp;<span class="ident" id="4609610">s</span>&nbsp;<span class="op" id="4609612">=</span>&nbsp;<span class="ident" id="4609614">s</span><span class="op" id="4609615">[</span><span class="builtinfunc" id="4609616">len</span><span class="op" id="4609619">(</span><span class="ident" id="4609620">zeroes</span><span class="op" id="4609626">)</span><span class="op" id="4609627">:</span><span class="op" id="4609628">]</span>&nbsp;<span class="op" id="4609630">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4609635">copy</span><span class="op" id="4609639">(</span><span class="ident" id="4609640">s</span><span class="op" id="4609641">,</span>&nbsp;<span class="ident" id="4609643">zeroes</span><span class="op" id="4609649">[</span><span class="op" id="4609650">:</span><span class="op" id="4609651">]</span><span class="op" id="4609652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609660">d</span><span class="op" id="4609661">.</span><span class="ident" id="4609662">hashOffset</span>&nbsp;<span class="op" id="4609673">=</span>&nbsp;<span class="num" id="4609675">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609680">d</span><span class="op" id="4609681">.</span><span class="ident" id="4609682">index</span><span class="op" id="4609687">,</span>&nbsp;<span class="ident" id="4609689">d</span><span class="op" id="4609690">.</span><span class="ident" id="4609691">windowEnd</span>&nbsp;<span class="op" id="4609701">=</span>&nbsp;<span class="num" id="4609703">0</span><span class="op" id="4609704">,</span>&nbsp;<span class="num" id="4609706">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609710">for</span>&nbsp;<span class="ident" id="4609714">s</span>&nbsp;<span class="op" id="4609716">:=</span>&nbsp;<span class="ident" id="4609719">d</span><span class="op" id="4609720">.</span><span class="ident" id="4609721">window</span><span class="op" id="4609727">;</span>&nbsp;<span class="builtinfunc" id="4609729">len</span><span class="op" id="4609732">(</span><span class="ident" id="4609733">s</span><span class="op" id="4609734">)</span>&nbsp;<span class="op" id="4609736">&gt;</span>&nbsp;<span class="num" id="4609738">0</span><span class="op" id="4609739">;</span>&nbsp;<span class="op" id="4609741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609746">n</span>&nbsp;<span class="op" id="4609748">:=</span>&nbsp;<span class="builtinfunc" id="4609751">copy</span><span class="op" id="4609755">(</span><span class="ident" id="4609756">s</span><span class="op" id="4609757">,</span>&nbsp;<span class="ident" id="4609759">bzeroes</span><span class="op" id="4609766">[</span><span class="op" id="4609767">:</span><span class="op" id="4609768">]</span><span class="op" id="4609769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609774">s</span>&nbsp;<span class="op" id="4609776">=</span>&nbsp;<span class="ident" id="4609778">s</span><span class="op" id="4609779">[</span><span class="ident" id="4609780">n</span><span class="op" id="4609781">:</span><span class="op" id="4609782">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609790">d</span><span class="op" id="4609791">.</span><span class="ident" id="4609792">blockStart</span><span class="op" id="4609802">,</span>&nbsp;<span class="ident" id="4609804">d</span><span class="op" id="4609805">.</span><span class="ident" id="4609806">byteAvailable</span>&nbsp;<span class="op" id="4609820">=</span>&nbsp;<span class="num" id="4609822">0</span><span class="op" id="4609823">,</span>&nbsp;<span class="builtintype" id="4609825">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609834">d</span><span class="op" id="4609835">.</span><span class="ident" id="4609836">tokens</span>&nbsp;<span class="op" id="4609843">=</span>&nbsp;<span class="ident" id="4609845">d</span><span class="op" id="4609846">.</span><span class="ident" id="4609847">tokens</span><span class="op" id="4609853">[</span><span class="op" id="4609854">:</span><span class="ident" id="4609855">maxFlateBlockTokens</span><span class="op" id="4609874">+</span><span class="num" id="4609875">1</span><span class="op" id="4609876">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609880">for</span>&nbsp;<span class="ident" id="4609884">i</span>&nbsp;<span class="op" id="4609886">:=</span>&nbsp;<span class="num" id="4609889">0</span><span class="op" id="4609890">;</span>&nbsp;<span class="ident" id="4609892">i</span>&nbsp;<span class="op" id="4609894">&lt;=</span>&nbsp;<span class="ident" id="4609897">maxFlateBlockTokens</span><span class="op" id="4609916">;</span>&nbsp;<span class="ident" id="4609918">i</span><span class="op" id="4609919">++</span>&nbsp;<span class="op" id="4609922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609927">d</span><span class="op" id="4609928">.</span><span class="ident" id="4609929">tokens</span><span class="op" id="4609935">[</span><span class="ident" id="4609936">i</span><span class="op" id="4609937">]</span>&nbsp;<span class="op" id="4609939">=</span>&nbsp;<span class="num" id="4609941">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609945">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609949">d</span><span class="op" id="4609950">.</span><span class="ident" id="4609951">tokens</span>&nbsp;<span class="op" id="4609958">=</span>&nbsp;<span class="ident" id="4609960">d</span><span class="op" id="4609961">.</span><span class="ident" id="4609962">tokens</span><span class="op" id="4609968">[</span><span class="op" id="4609969">:</span><span class="num" id="4609970">0</span><span class="op" id="4609971">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609975">d</span><span class="op" id="4609976">.</span><span class="ident" id="4609977">length</span>&nbsp;<span class="op" id="4609984">=</span>&nbsp;<span class="ident" id="4609986">minMatchLength</span>&nbsp;<span class="op" id="4610001">-</span>&nbsp;<span class="num" id="4610003">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610007">d</span><span class="op" id="4610008">.</span><span class="ident" id="4610009">offset</span>&nbsp;<span class="op" id="4610016">=</span>&nbsp;<span class="num" id="4610018">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610022">d</span><span class="op" id="4610023">.</span><span class="ident" id="4610024">hash</span>&nbsp;<span class="op" id="4610029">=</span>&nbsp;<span class="num" id="4610031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610035">d</span><span class="op" id="4610036">.</span><span class="ident" id="4610037">maxInsertIndex</span>&nbsp;<span class="op" id="4610052">=</span>&nbsp;<span class="num" id="4610054">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610057">}</span><br>
<span class="lineno"></span><span class="op" id="4610059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4610062">func</span>&nbsp;<span class="op" id="4610067">(</span><span class="ident" id="4610068">d</span>&nbsp;<span class="op" id="4610070">*</span><span class="ident" id="4610071">compressor</span><span class="op" id="4610081">)</span>&nbsp;<span class="builtinfunc" id="4610083">close</span><span class="op" id="4610088">(</span><span class="op" id="4610089">)</span>&nbsp;<span class="builtintype" id="4610091">error</span>&nbsp;<span class="op" id="4610097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610100">d</span><span class="op" id="4610101">.</span><span class="ident" id="4610102">sync</span>&nbsp;<span class="op" id="4610107">=</span>&nbsp;<span class="builtintype" id="4610109">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610115">d</span><span class="op" id="4610116">.</span><span class="ident" id="4610117">step</span><span class="op" id="4610121">(</span><span class="ident" id="4610122">d</span><span class="op" id="4610123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610126">if</span>&nbsp;<span class="ident" id="4610129">d</span><span class="op" id="4610130">.</span><span class="ident" id="4610131">err</span>&nbsp;<span class="op" id="4610135">!=</span>&nbsp;<span class="ident" id="4610138">nil</span>&nbsp;<span class="op" id="4610142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610146">return</span>&nbsp;<span class="ident" id="4610153">d</span><span class="op" id="4610154">.</span><span class="ident" id="4610155">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610163">if</span>&nbsp;<span class="ident" id="4610166">d</span><span class="op" id="4610167">.</span><span class="ident" id="4610168">w</span><span class="op" id="4610169">.</span><span class="ident" id="4610170">writeStoredHeader</span><span class="op" id="4610187">(</span><span class="num" id="4610188">0</span><span class="op" id="4610189">,</span>&nbsp;<span class="builtintype" id="4610191">true</span><span class="op" id="4610195">)</span><span class="op" id="4610196">;</span>&nbsp;<span class="ident" id="4610198">d</span><span class="op" id="4610199">.</span><span class="ident" id="4610200">w</span><span class="op" id="4610201">.</span><span class="ident" id="4610202">err</span>&nbsp;<span class="op" id="4610206">!=</span>&nbsp;<span class="ident" id="4610209">nil</span>&nbsp;<span class="op" id="4610213">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610217">return</span>&nbsp;<span class="ident" id="4610224">d</span><span class="op" id="4610225">.</span><span class="ident" id="4610226">w</span><span class="op" id="4610227">.</span><span class="ident" id="4610228">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610236">d</span><span class="op" id="4610237">.</span><span class="ident" id="4610238">w</span><span class="op" id="4610239">.</span><span class="ident" id="4610240">flush</span><span class="op" id="4610245">(</span><span class="op" id="4610246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610249">return</span>&nbsp;<span class="ident" id="4610256">d</span><span class="op" id="4610257">.</span><span class="ident" id="4610258">w</span><span class="op" id="4610259">.</span><span class="ident" id="4610260">err</span><br>
<span class="lineno"></span><span class="op" id="4610264">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4610267">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4610338">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4610413">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4610478">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4610548">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4610625">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4610647">//</span><br>
<span class="lineno"></span><span class="comment" id="4610650">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4610723">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4610772">func</span>&nbsp;<span class="ident" id="4610777">NewWriter</span><span class="op" id="4610786">(</span><span class="ident" id="4610787">w</span>&nbsp;<span class="ident" id="4610789">io</span><span class="op" id="4610791">.</span><span class="ident" id="4610792">Writer</span><span class="op" id="4610798">,</span>&nbsp;<span class="ident" id="4610800">level</span>&nbsp;<span class="builtintype" id="4610806">int</span><span class="op" id="4610809">)</span>&nbsp;<span class="op" id="4610811">(</span><span class="op" id="4610812">*</span><span class="ident" id="4610813">Writer</span><span class="op" id="4610819">,</span>&nbsp;<span class="builtintype" id="4610821">error</span><span class="op" id="4610826">)</span>&nbsp;<span class="op" id="4610828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610831">var</span>&nbsp;<span class="ident" id="4610835">dw</span>&nbsp;<span class="ident" id="4610838">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610846">if</span>&nbsp;<span class="ident" id="4610849">err</span>&nbsp;<span class="op" id="4610853">:=</span>&nbsp;<span class="ident" id="4610856">dw</span><span class="op" id="4610858">.</span><span class="ident" id="4610859">d</span><span class="op" id="4610860">.</span><span class="ident" id="4610861">init</span><span class="op" id="4610865">(</span><span class="ident" id="4610866">w</span><span class="op" id="4610867">,</span>&nbsp;<span class="ident" id="4610869">level</span><span class="op" id="4610874">)</span><span class="op" id="4610875">;</span>&nbsp;<span class="ident" id="4610877">err</span>&nbsp;<span class="op" id="4610881">!=</span>&nbsp;<span class="ident" id="4610884">nil</span>&nbsp;<span class="op" id="4610888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610892">return</span>&nbsp;<span class="ident" id="4610899">nil</span><span class="op" id="4610902">,</span>&nbsp;<span class="ident" id="4610904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610909">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610912">return</span>&nbsp;<span class="op" id="4610919">&amp;</span><span class="ident" id="4610920">dw</span><span class="op" id="4610922">,</span>&nbsp;<span class="ident" id="4610924">nil</span><br>
<span class="lineno"></span><span class="op" id="4610928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4610931">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4610990">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4611055">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4611120">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4611180">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4611241">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4611261">func</span>&nbsp;<span class="ident" id="4611266">NewWriterDict</span><span class="op" id="4611279">(</span><span class="ident" id="4611280">w</span>&nbsp;<span class="ident" id="4611282">io</span><span class="op" id="4611284">.</span><span class="ident" id="4611285">Writer</span><span class="op" id="4611291">,</span>&nbsp;<span class="ident" id="4611293">level</span>&nbsp;<span class="builtintype" id="4611299">int</span><span class="op" id="4611302">,</span>&nbsp;<span class="ident" id="4611304">dict</span>&nbsp;<span class="op" id="4611309">[</span><span class="op" id="4611310">]</span><span class="builtintype" id="4611311">byte</span><span class="op" id="4611315">)</span>&nbsp;<span class="op" id="4611317">(</span><span class="op" id="4611318">*</span><span class="ident" id="4611319">Writer</span><span class="op" id="4611325">,</span>&nbsp;<span class="builtintype" id="4611327">error</span><span class="op" id="4611332">)</span>&nbsp;<span class="op" id="4611334">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611337">dw</span>&nbsp;<span class="op" id="4611340">:=</span>&nbsp;<span class="op" id="4611343">&amp;</span><span class="ident" id="4611344">dictWriter</span><span class="op" id="4611354">{</span><span class="ident" id="4611355">w</span><span class="op" id="4611356">,</span>&nbsp;<span class="builtintype" id="4611358">false</span><span class="op" id="4611363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611366">zw</span><span class="op" id="4611368">,</span>&nbsp;<span class="ident" id="4611370">err</span>&nbsp;<span class="op" id="4611374">:=</span>&nbsp;<span class="ident" id="4611377">NewWriter</span><span class="op" id="4611386">(</span><span class="ident" id="4611387">dw</span><span class="op" id="4611389">,</span>&nbsp;<span class="ident" id="4611391">level</span><span class="op" id="4611396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611399">if</span>&nbsp;<span class="ident" id="4611402">err</span>&nbsp;<span class="op" id="4611406">!=</span>&nbsp;<span class="ident" id="4611409">nil</span>&nbsp;<span class="op" id="4611413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611417">return</span>&nbsp;<span class="ident" id="4611424">nil</span><span class="op" id="4611427">,</span>&nbsp;<span class="ident" id="4611429">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611434">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611437">zw</span><span class="op" id="4611439">.</span><span class="ident" id="4611440">Write</span><span class="op" id="4611445">(</span><span class="ident" id="4611446">dict</span><span class="op" id="4611450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611453">zw</span><span class="op" id="4611455">.</span><span class="ident" id="4611456">Flush</span><span class="op" id="4611461">(</span><span class="op" id="4611462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611465">dw</span><span class="op" id="4611467">.</span><span class="ident" id="4611468">enabled</span>&nbsp;<span class="op" id="4611476">=</span>&nbsp;<span class="builtintype" id="4611478">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611484">zw</span><span class="op" id="4611486">.</span><span class="ident" id="4611487">dict</span>&nbsp;<span class="op" id="4611492">=</span>&nbsp;<span class="builtinfunc" id="4611494">append</span><span class="op" id="4611500">(</span><span class="ident" id="4611501">zw</span><span class="op" id="4611503">.</span><span class="ident" id="4611504">dict</span><span class="op" id="4611508">,</span>&nbsp;<span class="ident" id="4611510">dict</span><span class="op" id="4611514">...</span><span class="op" id="4611517">)</span>&nbsp;<span class="comment" id="4611519">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611562">return</span>&nbsp;<span class="ident" id="4611569">zw</span><span class="op" id="4611571">,</span>&nbsp;<span class="ident" id="4611573">err</span><br>
<span class="lineno">510</span><span class="op" id="4611577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4611580">type</span>&nbsp;<span class="ident" id="4611585">dictWriter</span>&nbsp;<span class="keyword" id="4611596">struct</span>&nbsp;<span class="op" id="4611603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611606">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4611614">io</span><span class="op" id="4611616">.</span><span class="ident" id="4611617">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611625">enabled</span>&nbsp;<span class="builtintype" id="4611633">bool</span><br>
<span class="lineno">515</span><span class="op" id="4611638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4611641">func</span>&nbsp;<span class="op" id="4611646">(</span><span class="ident" id="4611647">w</span>&nbsp;<span class="op" id="4611649">*</span><span class="ident" id="4611650">dictWriter</span><span class="op" id="4611660">)</span>&nbsp;<span class="ident" id="4611662">Write</span><span class="op" id="4611667">(</span><span class="ident" id="4611668">b</span>&nbsp;<span class="op" id="4611670">[</span><span class="op" id="4611671">]</span><span class="builtintype" id="4611672">byte</span><span class="op" id="4611676">)</span>&nbsp;<span class="op" id="4611678">(</span><span class="ident" id="4611679">n</span>&nbsp;<span class="builtintype" id="4611681">int</span><span class="op" id="4611684">,</span>&nbsp;<span class="ident" id="4611686">err</span>&nbsp;<span class="builtintype" id="4611690">error</span><span class="op" id="4611695">)</span>&nbsp;<span class="op" id="4611697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611700">if</span>&nbsp;<span class="ident" id="4611703">w</span><span class="op" id="4611704">.</span><span class="ident" id="4611705">enabled</span>&nbsp;<span class="op" id="4611713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611717">return</span>&nbsp;<span class="ident" id="4611724">w</span><span class="op" id="4611725">.</span><span class="ident" id="4611726">w</span><span class="op" id="4611727">.</span><span class="ident" id="4611728">Write</span><span class="op" id="4611733">(</span><span class="ident" id="4611734">b</span><span class="op" id="4611735">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611741">return</span>&nbsp;<span class="builtinfunc" id="4611748">len</span><span class="op" id="4611751">(</span><span class="ident" id="4611752">b</span><span class="op" id="4611753">)</span><span class="op" id="4611754">,</span>&nbsp;<span class="ident" id="4611756">nil</span><br>
<span class="lineno"></span><span class="op" id="4611760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4611763">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4611826">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4611888">type</span>&nbsp;<span class="ident" id="4611893">Writer</span>&nbsp;<span class="keyword" id="4611900">struct</span>&nbsp;<span class="op" id="4611907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611910">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4611915">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611927">dict</span>&nbsp;<span class="op" id="4611932">[</span><span class="op" id="4611933">]</span><span class="builtintype" id="4611934">byte</span><br>
<span class="lineno"></span><span class="op" id="4611939">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4611942">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4612001">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4612054">func</span>&nbsp;<span class="op" id="4612059">(</span><span class="ident" id="4612060">w</span>&nbsp;<span class="op" id="4612062">*</span><span class="ident" id="4612063">Writer</span><span class="op" id="4612069">)</span>&nbsp;<span class="ident" id="4612071">Write</span><span class="op" id="4612076">(</span><span class="ident" id="4612077">data</span>&nbsp;<span class="op" id="4612082">[</span><span class="op" id="4612083">]</span><span class="builtintype" id="4612084">byte</span><span class="op" id="4612088">)</span>&nbsp;<span class="op" id="4612090">(</span><span class="ident" id="4612091">n</span>&nbsp;<span class="builtintype" id="4612093">int</span><span class="op" id="4612096">,</span>&nbsp;<span class="ident" id="4612098">err</span>&nbsp;<span class="builtintype" id="4612102">error</span><span class="op" id="4612107">)</span>&nbsp;<span class="op" id="4612109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612112">return</span>&nbsp;<span class="ident" id="4612119">w</span><span class="op" id="4612120">.</span><span class="ident" id="4612121">d</span><span class="op" id="4612122">.</span><span class="ident" id="4612123">write</span><span class="op" id="4612128">(</span><span class="ident" id="4612129">data</span><span class="op" id="4612133">)</span><br>
<span class="lineno">535</span><span class="op" id="4612135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4612138">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4612209">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4612280">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4612340">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4612398">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4612470">//</span><br>
<span class="lineno"></span><span class="comment" id="4612473">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4612553">func</span>&nbsp;<span class="op" id="4612558">(</span><span class="ident" id="4612559">w</span>&nbsp;<span class="op" id="4612561">*</span><span class="ident" id="4612562">Writer</span><span class="op" id="4612568">)</span>&nbsp;<span class="ident" id="4612570">Flush</span><span class="op" id="4612575">(</span><span class="op" id="4612576">)</span>&nbsp;<span class="builtintype" id="4612578">error</span>&nbsp;<span class="op" id="4612584">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612587">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612616">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612668">return</span>&nbsp;<span class="ident" id="4612675">w</span><span class="op" id="4612676">.</span><span class="ident" id="4612677">d</span><span class="op" id="4612678">.</span><span class="ident" id="4612679">syncFlush</span><span class="op" id="4612688">(</span><span class="op" id="4612689">)</span><br>
<span class="lineno"></span><span class="op" id="4612691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4612694">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4612734">func</span>&nbsp;<span class="op" id="4612739">(</span><span class="ident" id="4612740">w</span>&nbsp;<span class="op" id="4612742">*</span><span class="ident" id="4612743">Writer</span><span class="op" id="4612749">)</span>&nbsp;<span class="ident" id="4612751">Close</span><span class="op" id="4612756">(</span><span class="op" id="4612757">)</span>&nbsp;<span class="builtintype" id="4612759">error</span>&nbsp;<span class="op" id="4612765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612768">return</span>&nbsp;<span class="ident" id="4612775">w</span><span class="op" id="4612776">.</span><span class="ident" id="4612777">d</span><span class="op" id="4612778">.</span><span class="builtinfunc" id="4612779">close</span><span class="op" id="4612784">(</span><span class="op" id="4612785">)</span><br>
<span class="lineno"></span><span class="op" id="4612787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4612790">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4612854">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4612914">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4612947">func</span>&nbsp;<span class="op" id="4612952">(</span><span class="ident" id="4612953">w</span>&nbsp;<span class="op" id="4612955">*</span><span class="ident" id="4612956">Writer</span><span class="op" id="4612962">)</span>&nbsp;<span class="ident" id="4612964">Reset</span><span class="op" id="4612969">(</span><span class="ident" id="4612970">dst</span>&nbsp;<span class="ident" id="4612974">io</span><span class="op" id="4612976">.</span><span class="ident" id="4612977">Writer</span><span class="op" id="4612983">)</span>&nbsp;<span class="op" id="4612985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4612988">if</span>&nbsp;<span class="ident" id="4612991">dw</span><span class="op" id="4612993">,</span>&nbsp;<span class="ident" id="4612995">ok</span>&nbsp;<span class="op" id="4612998">:=</span>&nbsp;<span class="ident" id="4613001">w</span><span class="op" id="4613002">.</span><span class="ident" id="4613003">d</span><span class="op" id="4613004">.</span><span class="ident" id="4613005">w</span><span class="op" id="4613006">.</span><span class="ident" id="4613007">w</span><span class="op" id="4613008">.</span><span class="op" id="4613009">(</span><span class="op" id="4613010">*</span><span class="ident" id="4613011">dictWriter</span><span class="op" id="4613021">)</span><span class="op" id="4613022">;</span>&nbsp;<span class="ident" id="4613024">ok</span>&nbsp;<span class="op" id="4613027">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4613031">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613069">dw</span><span class="op" id="4613071">.</span><span class="ident" id="4613072">w</span>&nbsp;<span class="op" id="4613074">=</span>&nbsp;<span class="ident" id="4613076">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613082">w</span><span class="op" id="4613083">.</span><span class="ident" id="4613084">d</span><span class="op" id="4613085">.</span><span class="ident" id="4613086">reset</span><span class="op" id="4613091">(</span><span class="ident" id="4613092">dw</span><span class="op" id="4613094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613098">dw</span><span class="op" id="4613100">.</span><span class="ident" id="4613101">enabled</span>&nbsp;<span class="op" id="4613109">=</span>&nbsp;<span class="builtintype" id="4613111">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613119">w</span><span class="op" id="4613120">.</span><span class="ident" id="4613121">Write</span><span class="op" id="4613126">(</span><span class="ident" id="4613127">w</span><span class="op" id="4613128">.</span><span class="ident" id="4613129">dict</span><span class="op" id="4613133">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613137">w</span><span class="op" id="4613138">.</span><span class="ident" id="4613139">Flush</span><span class="op" id="4613144">(</span><span class="op" id="4613145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613149">dw</span><span class="op" id="4613151">.</span><span class="ident" id="4613152">enabled</span>&nbsp;<span class="op" id="4613160">=</span>&nbsp;<span class="builtintype" id="4613162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613168">}</span>&nbsp;<span class="keyword" id="4613170">else</span>&nbsp;<span class="op" id="4613175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4613179">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4613213">w</span><span class="op" id="4613214">.</span><span class="ident" id="4613215">d</span><span class="op" id="4613216">.</span><span class="ident" id="4613217">reset</span><span class="op" id="4613222">(</span><span class="ident" id="4613223">dst</span><span class="op" id="4613226">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613229">}</span><br>
<span class="lineno"></span><span class="op" id="4613231">}</span>
</div>
</body>
</html>
