<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html" class="current">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6618880">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6618935">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6618989">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6619040">package</span>&nbsp;<span class="ident" id="6619048">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6619053">import</span>&nbsp;<span class="op" id="6619060">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619063">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619072">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619080">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619087">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619093">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619099">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619110">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619121">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619131">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619142">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619153">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619161">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6619172">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6619179">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6619182">func</span>&nbsp;<span class="ident" id="6619187">newLocalListener</span><span class="op" id="6619203">(</span><span class="ident" id="6619204">t</span>&nbsp;<span class="op" id="6619206">*</span><span class="ident" id="6619207">testing</span><span class="op" id="6619214">.</span><span class="ident" id="6619215">T</span><span class="op" id="6619216">)</span>&nbsp;<span class="ident" id="6619218">Listener</span>&nbsp;<span class="op" id="6619227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619230">ln</span><span class="op" id="6619232">,</span>&nbsp;<span class="ident" id="6619234">err</span>&nbsp;<span class="op" id="6619238">:=</span>&nbsp;<span class="ident" id="6619241">Listen</span><span class="op" id="6619247">(</span><span class="string" id="6619248">&#34;tcp&#34;</span><span class="op" id="6619253">,</span>&nbsp;<span class="string" id="6619255">&#34;127.0.0.1:0&#34;</span><span class="op" id="6619268">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619271">if</span>&nbsp;<span class="ident" id="6619274">err</span>&nbsp;<span class="op" id="6619278">!=</span>&nbsp;<span class="builtintype" id="6619281">nil</span>&nbsp;<span class="op" id="6619285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619289">ln</span><span class="op" id="6619291">,</span>&nbsp;<span class="ident" id="6619293">err</span>&nbsp;<span class="op" id="6619297">=</span>&nbsp;<span class="ident" id="6619299">Listen</span><span class="op" id="6619305">(</span><span class="string" id="6619306">&#34;tcp6&#34;</span><span class="op" id="6619312">,</span>&nbsp;<span class="string" id="6619314">&#34;[::1]:0&#34;</span><span class="op" id="6619323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6619326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619329">if</span>&nbsp;<span class="ident" id="6619332">err</span>&nbsp;<span class="op" id="6619336">!=</span>&nbsp;<span class="builtintype" id="6619339">nil</span>&nbsp;<span class="op" id="6619343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619347">t</span><span class="op" id="6619348">.</span><span class="ident" id="6619349">Fatal</span><span class="op" id="6619354">(</span><span class="ident" id="6619355">err</span><span class="op" id="6619358">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6619361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619364">return</span>&nbsp;<span class="ident" id="6619371">ln</span><br>
<span class="lineno"></span><span class="op" id="6619374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6619377">func</span>&nbsp;<span class="ident" id="6619382">TestDialTimeout</span><span class="op" id="6619397">(</span><span class="ident" id="6619398">t</span>&nbsp;<span class="op" id="6619400">*</span><span class="ident" id="6619401">testing</span><span class="op" id="6619408">.</span><span class="ident" id="6619409">T</span><span class="op" id="6619410">)</span>&nbsp;<span class="op" id="6619412">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619415">origBacklog</span>&nbsp;<span class="op" id="6619427">:=</span>&nbsp;<span class="ident" id="6619430">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619447">defer</span>&nbsp;<span class="keyword" id="6619453">func</span><span class="op" id="6619457">(</span><span class="op" id="6619458">)</span>&nbsp;<span class="op" id="6619460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619464">listenerBacklog</span>&nbsp;<span class="op" id="6619480">=</span>&nbsp;<span class="ident" id="6619482">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6619495">}</span><span class="op" id="6619496">(</span><span class="op" id="6619497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619500">listenerBacklog</span>&nbsp;<span class="op" id="6619516">=</span>&nbsp;<span class="num" id="6619518">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619522">ln</span>&nbsp;<span class="op" id="6619525">:=</span>&nbsp;<span class="ident" id="6619528">newLocalListener</span><span class="op" id="6619544">(</span><span class="ident" id="6619545">t</span><span class="op" id="6619546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619549">defer</span>&nbsp;<span class="ident" id="6619555">ln</span><span class="op" id="6619557">.</span><span class="ident" id="6619558">Close</span><span class="op" id="6619563">(</span><span class="op" id="6619564">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619568">errc</span>&nbsp;<span class="op" id="6619573">:=</span>&nbsp;<span class="builtinfunc" id="6619576">make</span><span class="op" id="6619580">(</span><span class="keyword" id="6619581">chan</span>&nbsp;<span class="builtintype" id="6619586">error</span><span class="op" id="6619591">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6619595">numConns</span>&nbsp;<span class="op" id="6619604">:=</span>&nbsp;<span class="ident" id="6619607">listenerBacklog</span>&nbsp;<span class="op" id="6619623">+</span>&nbsp;<span class="num" id="6619625">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6619631">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6619688">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619737">switch</span>&nbsp;<span class="ident" id="6619744">runtime</span><span class="op" id="6619751">.</span><span class="ident" id="6619752">GOOS</span>&nbsp;<span class="op" id="6619757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619760">case</span>&nbsp;<span class="string" id="6619765">&#34;linux&#34;</span><span class="op" id="6619772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6619776">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6619846">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6619916">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6619986">for</span>&nbsp;<span class="ident" id="6619990">i</span>&nbsp;<span class="op" id="6619992">:=</span>&nbsp;<span class="num" id="6619995">0</span><span class="op" id="6619996">;</span>&nbsp;<span class="ident" id="6619998">i</span>&nbsp;<span class="op" id="6620000">&lt;</span>&nbsp;<span class="ident" id="6620002">numConns</span><span class="op" id="6620010">;</span>&nbsp;<span class="ident" id="6620012">i</span><span class="op" id="6620013">++</span>&nbsp;<span class="op" id="6620016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6620021">go</span>&nbsp;<span class="keyword" id="6620024">func</span><span class="op" id="6620028">(</span><span class="op" id="6620029">)</span>&nbsp;<span class="op" id="6620031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6620037">_</span><span class="op" id="6620038">,</span>&nbsp;<span class="ident" id="6620040">err</span>&nbsp;<span class="op" id="6620044">:=</span>&nbsp;<span class="ident" id="6620047">DialTimeout</span><span class="op" id="6620058">(</span><span class="string" id="6620059">&#34;tcp&#34;</span><span class="op" id="6620064">,</span>&nbsp;<span class="ident" id="6620066">ln</span><span class="op" id="6620068">.</span><span class="ident" id="6620069">Addr</span><span class="op" id="6620073">(</span><span class="op" id="6620074">)</span><span class="op" id="6620075">.</span><span class="ident" id="6620076">String</span><span class="op" id="6620082">(</span><span class="op" id="6620083">)</span><span class="op" id="6620084">,</span>&nbsp;<span class="num" id="6620086">200</span><span class="op" id="6620089">*</span><span class="ident" id="6620090">time</span><span class="op" id="6620094">.</span><span class="ident" id="6620095">Millisecond</span><span class="op" id="6620106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6620112">errc</span>&nbsp;<span class="op" id="6620117">&lt;-</span>&nbsp;<span class="ident" id="6620120">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6620127">}</span><span class="op" id="6620128">(</span><span class="op" id="6620129">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6620133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6620136">case</span>&nbsp;<span class="string" id="6620141">&#34;darwin&#34;</span><span class="op" id="6620149">,</span>&nbsp;<span class="string" id="6620151">&#34;plan9&#34;</span><span class="op" id="6620158">,</span>&nbsp;<span class="string" id="6620160">&#34;windows&#34;</span><span class="op" id="6620169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620173">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620227">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620282">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620336">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620359">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620364">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620426">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620482">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620536">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620596">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620601">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620668">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6620765">go</span>&nbsp;<span class="keyword" id="6620768">func</span><span class="op" id="6620772">(</span><span class="op" id="6620773">)</span>&nbsp;<span class="op" id="6620775">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6620780">c</span><span class="op" id="6620781">,</span>&nbsp;<span class="ident" id="6620783">err</span>&nbsp;<span class="op" id="6620787">:=</span>&nbsp;<span class="ident" id="6620790">DialTimeout</span><span class="op" id="6620801">(</span><span class="string" id="6620802">&#34;tcp&#34;</span><span class="op" id="6620807">,</span>&nbsp;<span class="string" id="6620809">&#34;127.0.71.111:49151&#34;</span><span class="op" id="6620829">,</span>&nbsp;<span class="num" id="6620831">200</span><span class="op" id="6620834">*</span><span class="ident" id="6620835">time</span><span class="op" id="6620839">.</span><span class="ident" id="6620840">Millisecond</span><span class="op" id="6620851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6620856">if</span>&nbsp;<span class="ident" id="6620859">err</span>&nbsp;<span class="op" id="6620863">==</span>&nbsp;<span class="builtintype" id="6620866">nil</span>&nbsp;<span class="op" id="6620870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6620876">err</span>&nbsp;<span class="op" id="6620880">=</span>&nbsp;<span class="ident" id="6620882">fmt</span><span class="op" id="6620885">.</span><span class="ident" id="6620886">Errorf</span><span class="op" id="6620892">(</span><span class="string" id="6620893">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="6620923">,</span>&nbsp;<span class="ident" id="6620925">c</span><span class="op" id="6620926">.</span><span class="ident" id="6620927">RemoteAddr</span><span class="op" id="6620937">(</span><span class="op" id="6620938">)</span><span class="op" id="6620939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6620945">c</span><span class="op" id="6620946">.</span><span class="ident" id="6620947">Close</span><span class="op" id="6620952">(</span><span class="op" id="6620953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6620958">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6620963">errc</span>&nbsp;<span class="op" id="6620968">&lt;-</span>&nbsp;<span class="ident" id="6620971">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6620977">}</span><span class="op" id="6620978">(</span><span class="op" id="6620979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6620982">default</span><span class="op" id="6620989">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6620993">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621014">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621080">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621136">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621152">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621214">t</span><span class="op" id="6621215">.</span><span class="ident" id="6621216">Skipf</span><span class="op" id="6621221">(</span><span class="string" id="6621222">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="6621254">,</span>&nbsp;<span class="ident" id="6621256">runtime</span><span class="op" id="6621263">.</span><span class="ident" id="6621264">GOOS</span><span class="op" id="6621268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621271">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621275">connected</span>&nbsp;<span class="op" id="6621285">:=</span>&nbsp;<span class="num" id="6621288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621291">for</span>&nbsp;<span class="op" id="6621295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621299">select</span>&nbsp;<span class="op" id="6621306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621310">case</span>&nbsp;<span class="op" id="6621315">&lt;-</span><span class="ident" id="6621317">time</span><span class="op" id="6621321">.</span><span class="ident" id="6621322">After</span><span class="op" id="6621327">(</span><span class="num" id="6621328">15</span>&nbsp;<span class="op" id="6621331">*</span>&nbsp;<span class="ident" id="6621333">time</span><span class="op" id="6621337">.</span><span class="ident" id="6621338">Second</span><span class="op" id="6621344">)</span><span class="op" id="6621345">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621350">t</span><span class="op" id="6621351">.</span><span class="ident" id="6621352">Fatal</span><span class="op" id="6621357">(</span><span class="string" id="6621358">&#34;too&nbsp;slow&#34;</span><span class="op" id="6621368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621372">case</span>&nbsp;<span class="ident" id="6621377">err</span>&nbsp;<span class="op" id="6621381">:=</span>&nbsp;<span class="op" id="6621384">&lt;-</span><span class="ident" id="6621386">errc</span><span class="op" id="6621390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621395">if</span>&nbsp;<span class="ident" id="6621398">err</span>&nbsp;<span class="op" id="6621402">==</span>&nbsp;<span class="builtintype" id="6621405">nil</span>&nbsp;<span class="op" id="6621409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621415">connected</span><span class="op" id="6621424">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621431">if</span>&nbsp;<span class="ident" id="6621434">connected</span>&nbsp;<span class="op" id="6621444">==</span>&nbsp;<span class="ident" id="6621447">numConns</span>&nbsp;<span class="op" id="6621456">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621463">t</span><span class="op" id="6621464">.</span><span class="ident" id="6621465">Fatal</span><span class="op" id="6621470">(</span><span class="string" id="6621471">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="6621525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621536">}</span>&nbsp;<span class="keyword" id="6621538">else</span>&nbsp;<span class="op" id="6621543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621549">terr</span><span class="op" id="6621553">,</span>&nbsp;<span class="ident" id="6621555">ok</span>&nbsp;<span class="op" id="6621558">:=</span>&nbsp;<span class="ident" id="6621561">err</span><span class="op" id="6621564">.</span><span class="op" id="6621565">(</span><span class="ident" id="6621566">timeout</span><span class="op" id="6621573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621579">if</span>&nbsp;<span class="op" id="6621582">!</span><span class="ident" id="6621583">ok</span>&nbsp;<span class="op" id="6621586">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621593">t</span><span class="op" id="6621594">.</span><span class="ident" id="6621595">Fatalf</span><span class="op" id="6621601">(</span><span class="string" id="6621602">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="6621651">,</span>&nbsp;<span class="ident" id="6621653">err</span><span class="op" id="6621656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621668">if</span>&nbsp;<span class="op" id="6621671">!</span><span class="ident" id="6621672">terr</span><span class="op" id="6621676">.</span><span class="ident" id="6621677">Timeout</span><span class="op" id="6621684">(</span><span class="op" id="6621685">)</span>&nbsp;<span class="op" id="6621687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621694">t</span><span class="op" id="6621695">.</span><span class="ident" id="6621696">Fatalf</span><span class="op" id="6621702">(</span><span class="string" id="6621703">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="6621732">,</span>&nbsp;<span class="ident" id="6621734">err</span><span class="op" id="6621737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621743">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621749">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621786">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621803">}</span><br>
<span class="lineno">115</span><span class="op" id="6621805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6621808">func</span>&nbsp;<span class="ident" id="6621813">TestSelfConnect</span><span class="op" id="6621828">(</span><span class="ident" id="6621829">t</span>&nbsp;<span class="op" id="6621831">*</span><span class="ident" id="6621832">testing</span><span class="op" id="6621839">.</span><span class="ident" id="6621840">T</span><span class="op" id="6621841">)</span>&nbsp;<span class="op" id="6621843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6621846">if</span>&nbsp;<span class="ident" id="6621849">runtime</span><span class="op" id="6621856">.</span><span class="ident" id="6621857">GOOS</span>&nbsp;<span class="op" id="6621862">==</span>&nbsp;<span class="string" id="6621865">&#34;windows&#34;</span>&nbsp;<span class="op" id="6621875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621879">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6621926">t</span><span class="op" id="6621927">.</span><span class="ident" id="6621928">Skip</span><span class="op" id="6621932">(</span><span class="string" id="6621933">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="6621972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6621975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6621979">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6622028">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6622061">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622116">l</span><span class="op" id="6622117">,</span>&nbsp;<span class="ident" id="6622119">err</span>&nbsp;<span class="op" id="6622123">:=</span>&nbsp;<span class="ident" id="6622126">Listen</span><span class="op" id="6622132">(</span><span class="string" id="6622133">&#34;tcp&#34;</span><span class="op" id="6622138">,</span>&nbsp;<span class="string" id="6622140">&#34;127.0.0.1:0&#34;</span><span class="op" id="6622153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622156">if</span>&nbsp;<span class="ident" id="6622159">err</span>&nbsp;<span class="op" id="6622163">!=</span>&nbsp;<span class="builtintype" id="6622166">nil</span>&nbsp;<span class="op" id="6622170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622174">t</span><span class="op" id="6622175">.</span><span class="ident" id="6622176">Fatal</span><span class="op" id="6622181">(</span><span class="ident" id="6622182">err</span><span class="op" id="6622185">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622191">c</span><span class="op" id="6622192">,</span>&nbsp;<span class="ident" id="6622194">err</span>&nbsp;<span class="op" id="6622198">:=</span>&nbsp;<span class="ident" id="6622201">Dial</span><span class="op" id="6622205">(</span><span class="string" id="6622206">&#34;tcp&#34;</span><span class="op" id="6622211">,</span>&nbsp;<span class="ident" id="6622213">l</span><span class="op" id="6622214">.</span><span class="ident" id="6622215">Addr</span><span class="op" id="6622219">(</span><span class="op" id="6622220">)</span><span class="op" id="6622221">.</span><span class="ident" id="6622222">String</span><span class="op" id="6622228">(</span><span class="op" id="6622229">)</span><span class="op" id="6622230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622233">if</span>&nbsp;<span class="ident" id="6622236">err</span>&nbsp;<span class="op" id="6622240">!=</span>&nbsp;<span class="builtintype" id="6622243">nil</span>&nbsp;<span class="op" id="6622247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622251">t</span><span class="op" id="6622252">.</span><span class="ident" id="6622253">Fatal</span><span class="op" id="6622258">(</span><span class="ident" id="6622259">err</span><span class="op" id="6622262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622265">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622268">addr</span>&nbsp;<span class="op" id="6622273">:=</span>&nbsp;<span class="ident" id="6622276">c</span><span class="op" id="6622277">.</span><span class="ident" id="6622278">LocalAddr</span><span class="op" id="6622287">(</span><span class="op" id="6622288">)</span><span class="op" id="6622289">.</span><span class="ident" id="6622290">String</span><span class="op" id="6622296">(</span><span class="op" id="6622297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622300">c</span><span class="op" id="6622301">.</span><span class="ident" id="6622302">Close</span><span class="op" id="6622307">(</span><span class="op" id="6622308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622311">l</span><span class="op" id="6622312">.</span><span class="ident" id="6622313">Close</span><span class="op" id="6622318">(</span><span class="op" id="6622319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6622323">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622370">n</span>&nbsp;<span class="op" id="6622372">:=</span>&nbsp;<span class="num" id="6622375">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622383">if</span>&nbsp;<span class="ident" id="6622386">testing</span><span class="op" id="6622393">.</span><span class="ident" id="6622394">Short</span><span class="op" id="6622399">(</span><span class="op" id="6622400">)</span>&nbsp;<span class="op" id="6622402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622406">n</span>&nbsp;<span class="op" id="6622408">=</span>&nbsp;<span class="num" id="6622410">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622419">switch</span>&nbsp;<span class="ident" id="6622426">runtime</span><span class="op" id="6622433">.</span><span class="ident" id="6622434">GOOS</span>&nbsp;<span class="op" id="6622439">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622442">case</span>&nbsp;<span class="string" id="6622447">&#34;darwin&#34;</span><span class="op" id="6622455">,</span>&nbsp;<span class="string" id="6622457">&#34;dragonfly&#34;</span><span class="op" id="6622468">,</span>&nbsp;<span class="string" id="6622470">&#34;freebsd&#34;</span><span class="op" id="6622479">,</span>&nbsp;<span class="string" id="6622481">&#34;netbsd&#34;</span><span class="op" id="6622489">,</span>&nbsp;<span class="string" id="6622491">&#34;openbsd&#34;</span><span class="op" id="6622500">,</span>&nbsp;<span class="string" id="6622502">&#34;plan9&#34;</span><span class="op" id="6622509">,</span>&nbsp;<span class="string" id="6622511">&#34;solaris&#34;</span><span class="op" id="6622520">,</span>&nbsp;<span class="string" id="6622522">&#34;windows&#34;</span><span class="op" id="6622531">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6622535">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6622585">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622640">n</span>&nbsp;<span class="op" id="6622642">=</span>&nbsp;<span class="num" id="6622644">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622649">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622652">for</span>&nbsp;<span class="ident" id="6622656">i</span>&nbsp;<span class="op" id="6622658">:=</span>&nbsp;<span class="num" id="6622661">0</span><span class="op" id="6622662">;</span>&nbsp;<span class="ident" id="6622664">i</span>&nbsp;<span class="op" id="6622666">&lt;</span>&nbsp;<span class="ident" id="6622668">n</span><span class="op" id="6622669">;</span>&nbsp;<span class="ident" id="6622671">i</span><span class="op" id="6622672">++</span>&nbsp;<span class="op" id="6622675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622679">c</span><span class="op" id="6622680">,</span>&nbsp;<span class="ident" id="6622682">err</span>&nbsp;<span class="op" id="6622686">:=</span>&nbsp;<span class="ident" id="6622689">DialTimeout</span><span class="op" id="6622700">(</span><span class="string" id="6622701">&#34;tcp&#34;</span><span class="op" id="6622706">,</span>&nbsp;<span class="ident" id="6622708">addr</span><span class="op" id="6622712">,</span>&nbsp;<span class="ident" id="6622714">time</span><span class="op" id="6622718">.</span><span class="ident" id="6622719">Millisecond</span><span class="op" id="6622730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622734">if</span>&nbsp;<span class="ident" id="6622737">err</span>&nbsp;<span class="op" id="6622741">==</span>&nbsp;<span class="builtintype" id="6622744">nil</span>&nbsp;<span class="op" id="6622748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6622753">if</span>&nbsp;<span class="ident" id="6622756">c</span><span class="op" id="6622757">.</span><span class="ident" id="6622758">LocalAddr</span><span class="op" id="6622767">(</span><span class="op" id="6622768">)</span><span class="op" id="6622769">.</span><span class="ident" id="6622770">String</span><span class="op" id="6622776">(</span><span class="op" id="6622777">)</span>&nbsp;<span class="op" id="6622779">==</span>&nbsp;<span class="ident" id="6622782">addr</span>&nbsp;<span class="op" id="6622787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622793">t</span><span class="op" id="6622794">.</span><span class="ident" id="6622795">Errorf</span><span class="op" id="6622801">(</span><span class="string" id="6622802">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="6622829">,</span>&nbsp;<span class="ident" id="6622831">i</span><span class="op" id="6622832">,</span>&nbsp;<span class="ident" id="6622834">addr</span><span class="op" id="6622838">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622843">}</span>&nbsp;<span class="keyword" id="6622845">else</span>&nbsp;<span class="op" id="6622850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622856">t</span><span class="op" id="6622857">.</span><span class="ident" id="6622858">Logf</span><span class="op" id="6622862">(</span><span class="string" id="6622863">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="6622925">,</span>&nbsp;<span class="ident" id="6622927">i</span><span class="op" id="6622928">,</span>&nbsp;<span class="ident" id="6622930">addr</span><span class="op" id="6622934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6622944">c</span><span class="op" id="6622945">.</span><span class="ident" id="6622946">Close</span><span class="op" id="6622951">(</span><span class="op" id="6622952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622956">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6622959">}</span><br>
<span class="lineno"></span><span class="op" id="6622961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6622964">var</span>&nbsp;<span class="ident" id="6622968">runErrorTest</span>&nbsp;<span class="op" id="6622981">=</span>&nbsp;<span class="ident" id="6622983">flag</span><span class="op" id="6622987">.</span><span class="ident" id="6622988">Bool</span><span class="op" id="6622992">(</span><span class="string" id="6622993">&#34;run_error_test&#34;</span><span class="op" id="6623009">,</span>&nbsp;<span class="builtintype" id="6623011">false</span><span class="op" id="6623016">,</span>&nbsp;<span class="string" id="6623018">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="6623058">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6623061">type</span>&nbsp;<span class="ident" id="6623066">DialErrorTest</span>&nbsp;<span class="keyword" id="6623080">struct</span>&nbsp;<span class="op" id="6623087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6623090">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6623098">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6623106">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6623114">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6623122">Pattern</span>&nbsp;<span class="builtintype" id="6623130">string</span><br>
<span class="lineno"></span><span class="op" id="6623137">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6623140">var</span>&nbsp;<span class="ident" id="6623144">dialErrorTests</span>&nbsp;<span class="op" id="6623159">=</span>&nbsp;<span class="op" id="6623161">[</span><span class="op" id="6623162">]</span><span class="ident" id="6623163">DialErrorTest</span><span class="op" id="6623176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623183">&#34;datakit&#34;</span><span class="op" id="6623192">,</span>&nbsp;<span class="string" id="6623194">&#34;mh/astro/r70&#34;</span><span class="op" id="6623208">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623212">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="6623264">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623267">}</span><span class="op" id="6623268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623275">&#34;tcp&#34;</span><span class="op" id="6623280">,</span>&nbsp;<span class="string" id="6623282">&#34;127.0.0.1:&#34;</span><span class="op" id="6623297">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623301">&#34;dial&nbsp;tcp&nbsp;127.0.0.1::&nbsp;unknown&nbsp;port&nbsp;tcp/&#34;</span><span class="op" id="6623347">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623350">}</span><span class="op" id="6623351">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623358">&#34;tcp&#34;</span><span class="op" id="6623363">,</span>&nbsp;<span class="string" id="6623365">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="6623394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623398">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6623487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623490">}</span><span class="op" id="6623491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623494">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623498">&#34;tcp&#34;</span><span class="op" id="6623503">,</span>&nbsp;<span class="string" id="6623505">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="6623548">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623552">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6623669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623672">}</span><span class="op" id="6623673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623680">&#34;tcp&#34;</span><span class="op" id="6623685">,</span>&nbsp;<span class="string" id="6623687">&#34;no-such-name:80&#34;</span><span class="op" id="6623704">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623708">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="6623782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623785">}</span><span class="op" id="6623786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623793">&#34;tcp&#34;</span><span class="op" id="6623798">,</span>&nbsp;<span class="string" id="6623800">&#34;mh/astro/r70:http&#34;</span><span class="op" id="6623819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623823">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="6623893">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623896">}</span><span class="op" id="6623897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623904">&#34;unix&#34;</span><span class="op" id="6623910">,</span>&nbsp;<span class="string" id="6623912">&#34;/etc/file-not-found&#34;</span><span class="op" id="6623933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6623937">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6623995">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6623998">}</span><span class="op" id="6623999">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6624006">&#34;unix&#34;</span><span class="op" id="6624012">,</span>&nbsp;<span class="string" id="6624014">&#34;/etc/&#34;</span><span class="op" id="6624021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6624025">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6624113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624116">}</span><span class="op" id="6624117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624120">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6624124">&#34;unixpacket&#34;</span><span class="op" id="6624136">,</span>&nbsp;<span class="string" id="6624138">&#34;/etc/file-not-found&#34;</span><span class="op" id="6624159">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6624163">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6624227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624230">}</span><span class="op" id="6624231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6624238">&#34;unixpacket&#34;</span><span class="op" id="6624250">,</span>&nbsp;<span class="string" id="6624252">&#34;/etc/&#34;</span><span class="op" id="6624259">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6624263">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6624357">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624360">}</span><span class="op" id="6624361">,</span><br>
<span class="lineno"></span><span class="op" id="6624363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6624366">var</span>&nbsp;<span class="ident" id="6624370">duplicateErrorPattern</span>&nbsp;<span class="op" id="6624392">=</span>&nbsp;<span class="string" id="6624394">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6624417">func</span>&nbsp;<span class="ident" id="6624422">TestDialError</span><span class="op" id="6624435">(</span><span class="ident" id="6624436">t</span>&nbsp;<span class="op" id="6624438">*</span><span class="ident" id="6624439">testing</span><span class="op" id="6624446">.</span><span class="ident" id="6624447">T</span><span class="op" id="6624448">)</span>&nbsp;<span class="op" id="6624450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624453">if</span>&nbsp;<span class="op" id="6624456">!</span><span class="op" id="6624457">*</span><span class="ident" id="6624458">runErrorTest</span>&nbsp;<span class="op" id="6624471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624475">t</span><span class="op" id="6624476">.</span><span class="ident" id="6624477">Logf</span><span class="op" id="6624481">(</span><span class="string" id="6624482">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="6624528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624532">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624543">for</span>&nbsp;<span class="ident" id="6624547">i</span><span class="op" id="6624548">,</span>&nbsp;<span class="ident" id="6624550">tt</span>&nbsp;<span class="op" id="6624553">:=</span>&nbsp;<span class="keyword" id="6624556">range</span>&nbsp;<span class="ident" id="6624562">dialErrorTests</span>&nbsp;<span class="op" id="6624577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624581">c</span><span class="op" id="6624582">,</span>&nbsp;<span class="ident" id="6624584">err</span>&nbsp;<span class="op" id="6624588">:=</span>&nbsp;<span class="ident" id="6624591">Dial</span><span class="op" id="6624595">(</span><span class="ident" id="6624596">tt</span><span class="op" id="6624598">.</span><span class="ident" id="6624599">Net</span><span class="op" id="6624602">,</span>&nbsp;<span class="ident" id="6624604">tt</span><span class="op" id="6624606">.</span><span class="ident" id="6624607">Raddr</span><span class="op" id="6624612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624616">if</span>&nbsp;<span class="ident" id="6624619">c</span>&nbsp;<span class="op" id="6624621">!=</span>&nbsp;<span class="builtintype" id="6624624">nil</span>&nbsp;<span class="op" id="6624628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624633">c</span><span class="op" id="6624634">.</span><span class="ident" id="6624635">Close</span><span class="op" id="6624640">(</span><span class="op" id="6624641">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624649">if</span>&nbsp;<span class="ident" id="6624652">err</span>&nbsp;<span class="op" id="6624656">==</span>&nbsp;<span class="builtintype" id="6624659">nil</span>&nbsp;<span class="op" id="6624663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624668">t</span><span class="op" id="6624669">.</span><span class="ident" id="6624670">Errorf</span><span class="op" id="6624676">(</span><span class="string" id="6624677">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6624713">,</span>&nbsp;<span class="ident" id="6624715">i</span><span class="op" id="6624716">,</span>&nbsp;<span class="ident" id="6624718">tt</span><span class="op" id="6624720">.</span><span class="ident" id="6624721">Pattern</span><span class="op" id="6624728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624733">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624744">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624748">s</span>&nbsp;<span class="op" id="6624750">:=</span>&nbsp;<span class="ident" id="6624753">err</span><span class="op" id="6624756">.</span><span class="ident" id="6624757">Error</span><span class="op" id="6624762">(</span><span class="op" id="6624763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624767">match</span><span class="op" id="6624772">,</span>&nbsp;<span class="ident" id="6624774">_</span>&nbsp;<span class="op" id="6624776">:=</span>&nbsp;<span class="ident" id="6624779">regexp</span><span class="op" id="6624785">.</span><span class="ident" id="6624786">MatchString</span><span class="op" id="6624797">(</span><span class="ident" id="6624798">tt</span><span class="op" id="6624800">.</span><span class="ident" id="6624801">Pattern</span><span class="op" id="6624808">,</span>&nbsp;<span class="ident" id="6624810">s</span><span class="op" id="6624811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624815">if</span>&nbsp;<span class="op" id="6624818">!</span><span class="ident" id="6624819">match</span>&nbsp;<span class="op" id="6624825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624830">t</span><span class="op" id="6624831">.</span><span class="ident" id="6624832">Errorf</span><span class="op" id="6624838">(</span><span class="string" id="6624839">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6624868">,</span>&nbsp;<span class="ident" id="6624870">i</span><span class="op" id="6624871">,</span>&nbsp;<span class="ident" id="6624873">s</span><span class="op" id="6624874">,</span>&nbsp;<span class="ident" id="6624876">tt</span><span class="op" id="6624878">.</span><span class="ident" id="6624879">Pattern</span><span class="op" id="6624886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6624890">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624894">match</span><span class="op" id="6624899">,</span>&nbsp;<span class="ident" id="6624901">_</span>&nbsp;<span class="op" id="6624903">=</span>&nbsp;<span class="ident" id="6624905">regexp</span><span class="op" id="6624911">.</span><span class="ident" id="6624912">MatchString</span><span class="op" id="6624923">(</span><span class="ident" id="6624924">duplicateErrorPattern</span><span class="op" id="6624945">,</span>&nbsp;<span class="ident" id="6624947">s</span><span class="op" id="6624948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6624952">if</span>&nbsp;<span class="ident" id="6624955">match</span>&nbsp;<span class="op" id="6624961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6624966">t</span><span class="op" id="6624967">.</span><span class="ident" id="6624968">Errorf</span><span class="op" id="6624974">(</span><span class="string" id="6624975">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="6625018">,</span>&nbsp;<span class="ident" id="6625020">i</span><span class="op" id="6625021">,</span>&nbsp;<span class="ident" id="6625023">s</span><span class="op" id="6625024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625031">}</span><br>
<span class="lineno">240</span><span class="op" id="6625033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6625036">var</span>&nbsp;<span class="ident" id="6625040">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6625069">=</span>&nbsp;<span class="op" id="6625071">[</span><span class="op" id="6625072">]</span><span class="keyword" id="6625073">struct</span>&nbsp;<span class="op" id="6625080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625083">net</span>&nbsp;&nbsp;<span class="builtintype" id="6625088">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625096">addr</span>&nbsp;<span class="builtintype" id="6625101">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625109">err</span>&nbsp;&nbsp;<span class="builtintype" id="6625114">error</span><br>
<span class="lineno"></span><span class="op" id="6625120">}</span><span class="op" id="6625121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625124">{</span><span class="string" id="6625125">&#34;foo&#34;</span><span class="op" id="6625130">,</span>&nbsp;<span class="string" id="6625132">&#34;bar&#34;</span><span class="op" id="6625137">,</span>&nbsp;<span class="op" id="6625139">&amp;</span><span class="ident" id="6625140">OpError</span><span class="op" id="6625147">{</span><span class="ident" id="6625148">Op</span><span class="op" id="6625150">:</span>&nbsp;<span class="string" id="6625152">&#34;dial&#34;</span><span class="op" id="6625158">,</span>&nbsp;<span class="ident" id="6625160">Net</span><span class="op" id="6625163">:</span>&nbsp;<span class="string" id="6625165">&#34;foo&#34;</span><span class="op" id="6625170">,</span>&nbsp;<span class="ident" id="6625172">Addr</span><span class="op" id="6625176">:</span>&nbsp;<span class="builtintype" id="6625178">nil</span><span class="op" id="6625181">,</span>&nbsp;<span class="ident" id="6625183">Err</span><span class="op" id="6625186">:</span>&nbsp;<span class="ident" id="6625188">UnknownNetworkError</span><span class="op" id="6625207">(</span><span class="string" id="6625208">&#34;foo&#34;</span><span class="op" id="6625213">)</span><span class="op" id="6625214">}</span><span class="op" id="6625215">}</span><span class="op" id="6625216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625219">{</span><span class="string" id="6625220">&#34;baz&#34;</span><span class="op" id="6625225">,</span>&nbsp;<span class="string" id="6625227">&#34;&#34;</span><span class="op" id="6625229">,</span>&nbsp;<span class="op" id="6625231">&amp;</span><span class="ident" id="6625232">OpError</span><span class="op" id="6625239">{</span><span class="ident" id="6625240">Op</span><span class="op" id="6625242">:</span>&nbsp;<span class="string" id="6625244">&#34;listen&#34;</span><span class="op" id="6625252">,</span>&nbsp;<span class="ident" id="6625254">Net</span><span class="op" id="6625257">:</span>&nbsp;<span class="string" id="6625259">&#34;baz&#34;</span><span class="op" id="6625264">,</span>&nbsp;<span class="ident" id="6625266">Addr</span><span class="op" id="6625270">:</span>&nbsp;<span class="builtintype" id="6625272">nil</span><span class="op" id="6625275">,</span>&nbsp;<span class="ident" id="6625277">Err</span><span class="op" id="6625280">:</span>&nbsp;<span class="ident" id="6625282">UnknownNetworkError</span><span class="op" id="6625301">(</span><span class="string" id="6625302">&#34;baz&#34;</span><span class="op" id="6625307">)</span><span class="op" id="6625308">}</span><span class="op" id="6625309">}</span><span class="op" id="6625310">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625313">{</span><span class="string" id="6625314">&#34;tcp&#34;</span><span class="op" id="6625319">,</span>&nbsp;<span class="string" id="6625321">&#34;&#34;</span><span class="op" id="6625323">,</span>&nbsp;<span class="op" id="6625325">&amp;</span><span class="ident" id="6625326">OpError</span><span class="op" id="6625333">{</span><span class="ident" id="6625334">Op</span><span class="op" id="6625336">:</span>&nbsp;<span class="string" id="6625338">&#34;dial&#34;</span><span class="op" id="6625344">,</span>&nbsp;<span class="ident" id="6625346">Net</span><span class="op" id="6625349">:</span>&nbsp;<span class="string" id="6625351">&#34;tcp&#34;</span><span class="op" id="6625356">,</span>&nbsp;<span class="ident" id="6625358">Addr</span><span class="op" id="6625362">:</span>&nbsp;<span class="builtintype" id="6625364">nil</span><span class="op" id="6625367">,</span>&nbsp;<span class="ident" id="6625369">Err</span><span class="op" id="6625372">:</span>&nbsp;<span class="ident" id="6625374">errMissingAddress</span><span class="op" id="6625391">}</span><span class="op" id="6625392">}</span><span class="op" id="6625393">,</span><br>
<span class="lineno">250</span><span class="op" id="6625395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6625398">func</span>&nbsp;<span class="ident" id="6625403">TestInvalidDialAndListenArgs</span><span class="op" id="6625431">(</span><span class="ident" id="6625432">t</span>&nbsp;<span class="op" id="6625434">*</span><span class="ident" id="6625435">testing</span><span class="op" id="6625442">.</span><span class="ident" id="6625443">T</span><span class="op" id="6625444">)</span>&nbsp;<span class="op" id="6625446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625449">for</span>&nbsp;<span class="ident" id="6625453">_</span><span class="op" id="6625454">,</span>&nbsp;<span class="ident" id="6625456">tt</span>&nbsp;<span class="op" id="6625459">:=</span>&nbsp;<span class="keyword" id="6625462">range</span>&nbsp;<span class="ident" id="6625468">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6625497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625501">var</span>&nbsp;<span class="ident" id="6625505">err</span>&nbsp;<span class="builtintype" id="6625509">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625517">switch</span>&nbsp;<span class="ident" id="6625524">tt</span><span class="op" id="6625526">.</span><span class="ident" id="6625527">err</span><span class="op" id="6625530">.</span><span class="op" id="6625531">(</span><span class="op" id="6625532">*</span><span class="ident" id="6625533">OpError</span><span class="op" id="6625540">)</span><span class="op" id="6625541">.</span><span class="ident" id="6625542">Op</span>&nbsp;<span class="op" id="6625545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625549">case</span>&nbsp;<span class="string" id="6625554">&#34;dial&#34;</span><span class="op" id="6625560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625565">_</span><span class="op" id="6625566">,</span>&nbsp;<span class="ident" id="6625568">err</span>&nbsp;<span class="op" id="6625572">=</span>&nbsp;<span class="ident" id="6625574">Dial</span><span class="op" id="6625578">(</span><span class="ident" id="6625579">tt</span><span class="op" id="6625581">.</span><span class="ident" id="6625582">net</span><span class="op" id="6625585">,</span>&nbsp;<span class="ident" id="6625587">tt</span><span class="op" id="6625589">.</span><span class="ident" id="6625590">addr</span><span class="op" id="6625594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625598">case</span>&nbsp;<span class="string" id="6625603">&#34;listen&#34;</span><span class="op" id="6625611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625616">_</span><span class="op" id="6625617">,</span>&nbsp;<span class="ident" id="6625619">err</span>&nbsp;<span class="op" id="6625623">=</span>&nbsp;<span class="ident" id="6625625">Listen</span><span class="op" id="6625631">(</span><span class="ident" id="6625632">tt</span><span class="op" id="6625634">.</span><span class="ident" id="6625635">net</span><span class="op" id="6625638">,</span>&nbsp;<span class="ident" id="6625640">tt</span><span class="op" id="6625642">.</span><span class="ident" id="6625643">addr</span><span class="op" id="6625647">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625655">if</span>&nbsp;<span class="op" id="6625658">!</span><span class="ident" id="6625659">reflect</span><span class="op" id="6625666">.</span><span class="ident" id="6625667">DeepEqual</span><span class="op" id="6625676">(</span><span class="ident" id="6625677">tt</span><span class="op" id="6625679">.</span><span class="ident" id="6625680">err</span><span class="op" id="6625683">,</span>&nbsp;<span class="ident" id="6625685">err</span><span class="op" id="6625688">)</span>&nbsp;<span class="op" id="6625690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625695">t</span><span class="op" id="6625696">.</span><span class="ident" id="6625697">Fatalf</span><span class="op" id="6625703">(</span><span class="string" id="6625704">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="6625727">,</span>&nbsp;<span class="ident" id="6625729">err</span><span class="op" id="6625732">,</span>&nbsp;<span class="ident" id="6625734">tt</span><span class="op" id="6625736">.</span><span class="ident" id="6625737">err</span><span class="op" id="6625740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625747">}</span><br>
<span class="lineno">265</span><span class="op" id="6625749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6625752">func</span>&nbsp;<span class="ident" id="6625757">TestDialTimeoutFDLeak</span><span class="op" id="6625778">(</span><span class="ident" id="6625779">t</span>&nbsp;<span class="op" id="6625781">*</span><span class="ident" id="6625782">testing</span><span class="op" id="6625789">.</span><span class="ident" id="6625790">T</span><span class="op" id="6625791">)</span>&nbsp;<span class="op" id="6625793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625796">if</span>&nbsp;<span class="ident" id="6625799">runtime</span><span class="op" id="6625806">.</span><span class="ident" id="6625807">GOOS</span>&nbsp;<span class="op" id="6625812">!=</span>&nbsp;<span class="string" id="6625815">&#34;linux&#34;</span>&nbsp;<span class="op" id="6625823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6625827">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625872">t</span><span class="op" id="6625873">.</span><span class="ident" id="6625874">Skipf</span><span class="op" id="6625879">(</span><span class="string" id="6625880">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6625901">,</span>&nbsp;<span class="ident" id="6625903">runtime</span><span class="op" id="6625910">.</span><span class="ident" id="6625911">GOOS</span><span class="op" id="6625915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6625918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625922">ln</span>&nbsp;<span class="op" id="6625925">:=</span>&nbsp;<span class="ident" id="6625928">newLocalListener</span><span class="op" id="6625944">(</span><span class="ident" id="6625945">t</span><span class="op" id="6625946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625949">defer</span>&nbsp;<span class="ident" id="6625955">ln</span><span class="op" id="6625957">.</span><span class="ident" id="6625958">Close</span><span class="op" id="6625963">(</span><span class="op" id="6625964">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6625968">type</span>&nbsp;<span class="ident" id="6625973">connErr</span>&nbsp;<span class="keyword" id="6625981">struct</span>&nbsp;<span class="op" id="6625988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6625992">conn</span>&nbsp;<span class="ident" id="6625997">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626004">err</span>&nbsp;&nbsp;<span class="builtintype" id="6626009">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626016">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626019">dials</span>&nbsp;<span class="op" id="6626025">:=</span>&nbsp;<span class="ident" id="6626028">listenerBacklog</span>&nbsp;<span class="op" id="6626044">+</span>&nbsp;<span class="num" id="6626046">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6626051">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626131">maxGoodConnect</span>&nbsp;<span class="op" id="6626146">:=</span>&nbsp;<span class="ident" id="6626149">listenerBacklog</span>&nbsp;<span class="op" id="6626165">+</span>&nbsp;<span class="ident" id="6626167">runtime</span><span class="op" id="6626174">.</span><span class="ident" id="6626175">NumCPU</span><span class="op" id="6626181">(</span><span class="op" id="6626182">)</span><span class="op" id="6626183">*</span><span class="num" id="6626184">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626188">resc</span>&nbsp;<span class="op" id="6626193">:=</span>&nbsp;<span class="builtinfunc" id="6626196">make</span><span class="op" id="6626200">(</span><span class="keyword" id="6626201">chan</span>&nbsp;<span class="ident" id="6626206">connErr</span><span class="op" id="6626213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626216">for</span>&nbsp;<span class="ident" id="6626220">i</span>&nbsp;<span class="op" id="6626222">:=</span>&nbsp;<span class="num" id="6626225">0</span><span class="op" id="6626226">;</span>&nbsp;<span class="ident" id="6626228">i</span>&nbsp;<span class="op" id="6626230">&lt;</span>&nbsp;<span class="ident" id="6626232">dials</span><span class="op" id="6626237">;</span>&nbsp;<span class="ident" id="6626239">i</span><span class="op" id="6626240">++</span>&nbsp;<span class="op" id="6626243">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626247">go</span>&nbsp;<span class="keyword" id="6626250">func</span><span class="op" id="6626254">(</span><span class="op" id="6626255">)</span>&nbsp;<span class="op" id="6626257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626262">conn</span><span class="op" id="6626266">,</span>&nbsp;<span class="ident" id="6626268">err</span>&nbsp;<span class="op" id="6626272">:=</span>&nbsp;<span class="ident" id="6626275">DialTimeout</span><span class="op" id="6626286">(</span><span class="string" id="6626287">&#34;tcp&#34;</span><span class="op" id="6626292">,</span>&nbsp;<span class="ident" id="6626294">ln</span><span class="op" id="6626296">.</span><span class="ident" id="6626297">Addr</span><span class="op" id="6626301">(</span><span class="op" id="6626302">)</span><span class="op" id="6626303">.</span><span class="ident" id="6626304">String</span><span class="op" id="6626310">(</span><span class="op" id="6626311">)</span><span class="op" id="6626312">,</span>&nbsp;<span class="num" id="6626314">500</span><span class="op" id="6626317">*</span><span class="ident" id="6626318">time</span><span class="op" id="6626322">.</span><span class="ident" id="6626323">Millisecond</span><span class="op" id="6626334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626339">resc</span>&nbsp;<span class="op" id="6626344">&lt;-</span>&nbsp;<span class="ident" id="6626347">connErr</span><span class="op" id="6626354">{</span><span class="ident" id="6626355">conn</span><span class="op" id="6626359">,</span>&nbsp;<span class="ident" id="6626361">err</span><span class="op" id="6626364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626368">}</span><span class="op" id="6626369">(</span><span class="op" id="6626370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626373">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626377">var</span>&nbsp;<span class="ident" id="6626381">firstErr</span>&nbsp;<span class="builtintype" id="6626390">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626398">var</span>&nbsp;<span class="ident" id="6626402">ngood</span>&nbsp;<span class="builtintype" id="6626408">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626413">var</span>&nbsp;<span class="ident" id="6626417">toClose</span>&nbsp;<span class="op" id="6626425">[</span><span class="op" id="6626426">]</span><span class="ident" id="6626427">io</span><span class="op" id="6626429">.</span><span class="ident" id="6626430">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626438">for</span>&nbsp;<span class="ident" id="6626442">i</span>&nbsp;<span class="op" id="6626444">:=</span>&nbsp;<span class="num" id="6626447">0</span><span class="op" id="6626448">;</span>&nbsp;<span class="ident" id="6626450">i</span>&nbsp;<span class="op" id="6626452">&lt;</span>&nbsp;<span class="ident" id="6626454">dials</span><span class="op" id="6626459">;</span>&nbsp;<span class="ident" id="6626461">i</span><span class="op" id="6626462">++</span>&nbsp;<span class="op" id="6626465">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626469">ce</span>&nbsp;<span class="op" id="6626472">:=</span>&nbsp;<span class="op" id="6626475">&lt;-</span><span class="ident" id="6626477">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626484">if</span>&nbsp;<span class="ident" id="6626487">ce</span><span class="op" id="6626489">.</span><span class="ident" id="6626490">err</span>&nbsp;<span class="op" id="6626494">==</span>&nbsp;<span class="builtintype" id="6626497">nil</span>&nbsp;<span class="op" id="6626501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626506">ngood</span><span class="op" id="6626511">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626517">if</span>&nbsp;<span class="ident" id="6626520">ngood</span>&nbsp;<span class="op" id="6626526">&gt;</span>&nbsp;<span class="ident" id="6626528">maxGoodConnect</span>&nbsp;<span class="op" id="6626543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626549">t</span><span class="op" id="6626550">.</span><span class="ident" id="6626551">Errorf</span><span class="op" id="6626557">(</span><span class="string" id="6626558">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="6626597">,</span>&nbsp;<span class="ident" id="6626599">ngood</span><span class="op" id="6626604">,</span>&nbsp;<span class="ident" id="6626606">maxGoodConnect</span><span class="op" id="6626620">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626630">toClose</span>&nbsp;<span class="op" id="6626638">=</span>&nbsp;<span class="builtinfunc" id="6626640">append</span><span class="op" id="6626646">(</span><span class="ident" id="6626647">toClose</span><span class="op" id="6626654">,</span>&nbsp;<span class="ident" id="6626656">ce</span><span class="op" id="6626658">.</span><span class="ident" id="6626659">conn</span><span class="op" id="6626663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626668">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626683">err</span>&nbsp;<span class="op" id="6626687">:=</span>&nbsp;<span class="ident" id="6626690">ce</span><span class="op" id="6626692">.</span><span class="ident" id="6626693">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626699">if</span>&nbsp;<span class="ident" id="6626702">firstErr</span>&nbsp;<span class="op" id="6626711">==</span>&nbsp;<span class="string" id="6626714">&#34;&#34;</span>&nbsp;<span class="op" id="6626717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626722">firstErr</span>&nbsp;<span class="op" id="6626731">=</span>&nbsp;<span class="ident" id="6626733">err</span><span class="op" id="6626736">.</span><span class="ident" id="6626737">Error</span><span class="op" id="6626742">(</span><span class="op" id="6626743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626747">}</span>&nbsp;<span class="keyword" id="6626749">else</span>&nbsp;<span class="keyword" id="6626754">if</span>&nbsp;<span class="ident" id="6626757">err</span><span class="op" id="6626760">.</span><span class="ident" id="6626761">Error</span><span class="op" id="6626766">(</span><span class="op" id="6626767">)</span>&nbsp;<span class="op" id="6626769">!=</span>&nbsp;<span class="ident" id="6626772">firstErr</span>&nbsp;<span class="op" id="6626781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626786">t</span><span class="op" id="6626787">.</span><span class="ident" id="6626788">Fatalf</span><span class="op" id="6626794">(</span><span class="string" id="6626795">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="6626853">,</span>&nbsp;<span class="ident" id="6626855">firstErr</span><span class="op" id="6626863">,</span>&nbsp;<span class="ident" id="6626865">err</span><span class="op" id="6626868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626872">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626878">for</span>&nbsp;<span class="ident" id="6626882">_</span><span class="op" id="6626883">,</span>&nbsp;<span class="ident" id="6626885">c</span>&nbsp;<span class="op" id="6626887">:=</span>&nbsp;<span class="keyword" id="6626890">range</span>&nbsp;<span class="ident" id="6626896">toClose</span>&nbsp;<span class="op" id="6626904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6626908">c</span><span class="op" id="6626909">.</span><span class="ident" id="6626910">Close</span><span class="op" id="6626915">(</span><span class="op" id="6626916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6626919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626922">for</span>&nbsp;<span class="ident" id="6626926">i</span>&nbsp;<span class="op" id="6626928">:=</span>&nbsp;<span class="num" id="6626931">0</span><span class="op" id="6626932">;</span>&nbsp;<span class="ident" id="6626934">i</span>&nbsp;<span class="op" id="6626936">&lt;</span>&nbsp;<span class="num" id="6626938">100</span><span class="op" id="6626941">;</span>&nbsp;<span class="ident" id="6626943">i</span><span class="op" id="6626944">++</span>&nbsp;<span class="op" id="6626947">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6626951">if</span>&nbsp;<span class="ident" id="6626954">got</span>&nbsp;<span class="op" id="6626958">:=</span>&nbsp;<span class="ident" id="6626961">numFD</span><span class="op" id="6626966">(</span><span class="op" id="6626967">)</span><span class="op" id="6626968">;</span>&nbsp;<span class="ident" id="6626970">got</span>&nbsp;<span class="op" id="6626974">&lt;</span>&nbsp;<span class="ident" id="6626976">dials</span>&nbsp;<span class="op" id="6626982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6626987">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627006">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627019">time</span><span class="op" id="6627023">.</span><span class="ident" id="6627024">Sleep</span><span class="op" id="6627029">(</span><span class="num" id="6627030">10</span>&nbsp;<span class="op" id="6627033">*</span>&nbsp;<span class="ident" id="6627035">time</span><span class="op" id="6627039">.</span><span class="ident" id="6627040">Millisecond</span><span class="op" id="6627051">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627057">if</span>&nbsp;<span class="ident" id="6627060">got</span>&nbsp;<span class="op" id="6627064">:=</span>&nbsp;<span class="ident" id="6627067">numFD</span><span class="op" id="6627072">(</span><span class="op" id="6627073">)</span><span class="op" id="6627074">;</span>&nbsp;<span class="ident" id="6627076">got</span>&nbsp;<span class="op" id="6627080">&gt;=</span>&nbsp;<span class="ident" id="6627083">dials</span>&nbsp;<span class="op" id="6627089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627093">t</span><span class="op" id="6627094">.</span><span class="ident" id="6627095">Errorf</span><span class="op" id="6627101">(</span><span class="string" id="6627102">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="6627144">,</span>&nbsp;<span class="ident" id="6627146">dials</span><span class="op" id="6627151">,</span>&nbsp;<span class="ident" id="6627153">got</span><span class="op" id="6627156">,</span>&nbsp;<span class="ident" id="6627158">dials</span><span class="op" id="6627163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627166">}</span><br>
<span class="lineno"></span><span class="op" id="6627168">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6627171">func</span>&nbsp;<span class="ident" id="6627176">numTCP</span><span class="op" id="6627182">(</span><span class="op" id="6627183">)</span>&nbsp;<span class="op" id="6627185">(</span><span class="ident" id="6627186">ntcp</span><span class="op" id="6627190">,</span>&nbsp;<span class="ident" id="6627192">nopen</span><span class="op" id="6627197">,</span>&nbsp;<span class="ident" id="6627199">nclose</span>&nbsp;<span class="builtintype" id="6627206">int</span><span class="op" id="6627209">,</span>&nbsp;<span class="ident" id="6627211">err</span>&nbsp;<span class="builtintype" id="6627215">error</span><span class="op" id="6627220">)</span>&nbsp;<span class="op" id="6627222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627225">lsof</span><span class="op" id="6627229">,</span>&nbsp;<span class="ident" id="6627231">err</span>&nbsp;<span class="op" id="6627235">:=</span>&nbsp;<span class="ident" id="6627238">exec</span><span class="op" id="6627242">.</span><span class="ident" id="6627243">Command</span><span class="op" id="6627250">(</span><span class="string" id="6627251">&#34;lsof&#34;</span><span class="op" id="6627257">,</span>&nbsp;<span class="string" id="6627259">&#34;-n&#34;</span><span class="op" id="6627263">,</span>&nbsp;<span class="string" id="6627265">&#34;-p&#34;</span><span class="op" id="6627269">,</span>&nbsp;<span class="ident" id="6627271">strconv</span><span class="op" id="6627278">.</span><span class="ident" id="6627279">Itoa</span><span class="op" id="6627283">(</span><span class="ident" id="6627284">os</span><span class="op" id="6627286">.</span><span class="ident" id="6627287">Getpid</span><span class="op" id="6627293">(</span><span class="op" id="6627294">)</span><span class="op" id="6627295">)</span><span class="op" id="6627296">)</span><span class="op" id="6627297">.</span><span class="ident" id="6627298">Output</span><span class="op" id="6627304">(</span><span class="op" id="6627305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627308">if</span>&nbsp;<span class="ident" id="6627311">err</span>&nbsp;<span class="op" id="6627315">!=</span>&nbsp;<span class="builtintype" id="6627318">nil</span>&nbsp;<span class="op" id="6627322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627326">return</span>&nbsp;<span class="num" id="6627333">0</span><span class="op" id="6627334">,</span>&nbsp;<span class="num" id="6627336">0</span><span class="op" id="6627337">,</span>&nbsp;<span class="num" id="6627339">0</span><span class="op" id="6627340">,</span>&nbsp;<span class="ident" id="6627342">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627350">ntcp</span>&nbsp;<span class="op" id="6627355">+=</span>&nbsp;<span class="ident" id="6627358">bytes</span><span class="op" id="6627363">.</span><span class="ident" id="6627364">Count</span><span class="op" id="6627369">(</span><span class="ident" id="6627370">lsof</span><span class="op" id="6627374">,</span>&nbsp;<span class="op" id="6627376">[</span><span class="op" id="6627377">]</span><span class="builtintype" id="6627378">byte</span><span class="op" id="6627382">(</span><span class="string" id="6627383">&#34;TCP&#34;</span><span class="op" id="6627388">)</span><span class="op" id="6627389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627392">for</span>&nbsp;<span class="ident" id="6627396">_</span><span class="op" id="6627397">,</span>&nbsp;<span class="ident" id="6627399">state</span>&nbsp;<span class="op" id="6627405">:=</span>&nbsp;<span class="keyword" id="6627408">range</span>&nbsp;<span class="op" id="6627414">[</span><span class="op" id="6627415">]</span><span class="builtintype" id="6627416">string</span><span class="op" id="6627422">{</span><span class="string" id="6627423">&#34;LISTEN&#34;</span><span class="op" id="6627431">,</span>&nbsp;<span class="string" id="6627433">&#34;SYN_SENT&#34;</span><span class="op" id="6627443">,</span>&nbsp;<span class="string" id="6627445">&#34;SYN_RECEIVED&#34;</span><span class="op" id="6627459">,</span>&nbsp;<span class="string" id="6627461">&#34;ESTABLISHED&#34;</span><span class="op" id="6627474">}</span>&nbsp;<span class="op" id="6627476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627480">nopen</span>&nbsp;<span class="op" id="6627486">+=</span>&nbsp;<span class="ident" id="6627489">bytes</span><span class="op" id="6627494">.</span><span class="ident" id="6627495">Count</span><span class="op" id="6627500">(</span><span class="ident" id="6627501">lsof</span><span class="op" id="6627505">,</span>&nbsp;<span class="op" id="6627507">[</span><span class="op" id="6627508">]</span><span class="builtintype" id="6627509">byte</span><span class="op" id="6627513">(</span><span class="ident" id="6627514">state</span><span class="op" id="6627519">)</span><span class="op" id="6627520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627523">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627526">for</span>&nbsp;<span class="ident" id="6627530">_</span><span class="op" id="6627531">,</span>&nbsp;<span class="ident" id="6627533">state</span>&nbsp;<span class="op" id="6627539">:=</span>&nbsp;<span class="keyword" id="6627542">range</span>&nbsp;<span class="op" id="6627548">[</span><span class="op" id="6627549">]</span><span class="builtintype" id="6627550">string</span><span class="op" id="6627556">{</span><span class="string" id="6627557">&#34;CLOSED&#34;</span><span class="op" id="6627565">,</span>&nbsp;<span class="string" id="6627567">&#34;CLOSE_WAIT&#34;</span><span class="op" id="6627579">,</span>&nbsp;<span class="string" id="6627581">&#34;LAST_ACK&#34;</span><span class="op" id="6627591">,</span>&nbsp;<span class="string" id="6627593">&#34;FIN_WAIT_1&#34;</span><span class="op" id="6627605">,</span>&nbsp;<span class="string" id="6627607">&#34;FIN_WAIT_2&#34;</span><span class="op" id="6627619">,</span>&nbsp;<span class="string" id="6627621">&#34;CLOSING&#34;</span><span class="op" id="6627630">,</span>&nbsp;<span class="string" id="6627632">&#34;TIME_WAIT&#34;</span><span class="op" id="6627643">}</span>&nbsp;<span class="op" id="6627645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627649">nclose</span>&nbsp;<span class="op" id="6627656">+=</span>&nbsp;<span class="ident" id="6627659">bytes</span><span class="op" id="6627664">.</span><span class="ident" id="6627665">Count</span><span class="op" id="6627670">(</span><span class="ident" id="6627671">lsof</span><span class="op" id="6627675">,</span>&nbsp;<span class="op" id="6627677">[</span><span class="op" id="6627678">]</span><span class="builtintype" id="6627679">byte</span><span class="op" id="6627683">(</span><span class="ident" id="6627684">state</span><span class="op" id="6627689">)</span><span class="op" id="6627690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627696">return</span>&nbsp;<span class="ident" id="6627703">ntcp</span><span class="op" id="6627707">,</span>&nbsp;<span class="ident" id="6627709">nopen</span><span class="op" id="6627714">,</span>&nbsp;<span class="ident" id="6627716">nclose</span><span class="op" id="6627722">,</span>&nbsp;<span class="builtintype" id="6627724">nil</span><br>
<span class="lineno"></span><span class="op" id="6627728">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="6627731">func</span>&nbsp;<span class="ident" id="6627736">TestDialMultiFDLeak</span><span class="op" id="6627755">(</span><span class="ident" id="6627756">t</span>&nbsp;<span class="op" id="6627758">*</span><span class="ident" id="6627759">testing</span><span class="op" id="6627766">.</span><span class="ident" id="6627767">T</span><span class="op" id="6627768">)</span>&nbsp;<span class="op" id="6627770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627773">t</span><span class="op" id="6627774">.</span><span class="ident" id="6627775">Skip</span><span class="op" id="6627779">(</span><span class="string" id="6627780">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="6627816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627820">if</span>&nbsp;<span class="op" id="6627823">!</span><span class="ident" id="6627824">supportsIPv4</span>&nbsp;<span class="op" id="6627837">||</span>&nbsp;<span class="op" id="6627840">!</span><span class="ident" id="6627841">supportsIPv6</span>&nbsp;<span class="op" id="6627854">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627858">t</span><span class="op" id="6627859">.</span><span class="ident" id="6627860">Skip</span><span class="op" id="6627864">(</span><span class="string" id="6627865">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="6627901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6627904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6627908">halfDeadServer</span>&nbsp;<span class="op" id="6627923">:=</span>&nbsp;<span class="keyword" id="6627926">func</span><span class="op" id="6627930">(</span><span class="ident" id="6627931">dss</span>&nbsp;<span class="op" id="6627935">*</span><span class="ident" id="6627936">dualStackServer</span><span class="op" id="6627951">,</span>&nbsp;<span class="ident" id="6627953">ln</span>&nbsp;<span class="ident" id="6627956">Listener</span><span class="op" id="6627964">)</span>&nbsp;<span class="op" id="6627966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627970">for</span>&nbsp;<span class="op" id="6627974">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6627979">if</span>&nbsp;<span class="ident" id="6627982">c</span><span class="op" id="6627983">,</span>&nbsp;<span class="ident" id="6627985">err</span>&nbsp;<span class="op" id="6627989">:=</span>&nbsp;<span class="ident" id="6627992">ln</span><span class="op" id="6627994">.</span><span class="ident" id="6627995">Accept</span><span class="op" id="6628001">(</span><span class="op" id="6628002">)</span><span class="op" id="6628003">;</span>&nbsp;<span class="ident" id="6628005">err</span>&nbsp;<span class="op" id="6628009">!=</span>&nbsp;<span class="builtintype" id="6628012">nil</span>&nbsp;<span class="op" id="6628016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6628022">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628032">}</span>&nbsp;<span class="keyword" id="6628034">else</span>&nbsp;<span class="op" id="6628039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6628045">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6628078">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6628121">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628134">dss</span><span class="op" id="6628137">.</span><span class="ident" id="6628138">putConn</span><span class="op" id="6628145">(</span><span class="ident" id="6628146">c</span><span class="op" id="6628147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628159">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628162">dss</span><span class="op" id="6628165">,</span>&nbsp;<span class="ident" id="6628167">err</span>&nbsp;<span class="op" id="6628171">:=</span>&nbsp;<span class="ident" id="6628174">newDualStackServer</span><span class="op" id="6628192">(</span><span class="op" id="6628193">[</span><span class="op" id="6628194">]</span><span class="ident" id="6628195">streamListener</span><span class="op" id="6628209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628213">{</span><span class="ident" id="6628214">net</span><span class="op" id="6628217">:</span>&nbsp;<span class="string" id="6628219">&#34;tcp4&#34;</span><span class="op" id="6628225">,</span>&nbsp;<span class="ident" id="6628227">addr</span><span class="op" id="6628231">:</span>&nbsp;<span class="string" id="6628233">&#34;127.0.0.1&#34;</span><span class="op" id="6628244">}</span><span class="op" id="6628245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628249">{</span><span class="ident" id="6628250">net</span><span class="op" id="6628253">:</span>&nbsp;<span class="string" id="6628255">&#34;tcp6&#34;</span><span class="op" id="6628261">,</span>&nbsp;<span class="ident" id="6628263">addr</span><span class="op" id="6628267">:</span>&nbsp;<span class="string" id="6628269">&#34;[::1]&#34;</span><span class="op" id="6628276">}</span><span class="op" id="6628277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628280">}</span><span class="op" id="6628281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6628284">if</span>&nbsp;<span class="ident" id="6628287">err</span>&nbsp;<span class="op" id="6628291">!=</span>&nbsp;<span class="builtintype" id="6628294">nil</span>&nbsp;<span class="op" id="6628298">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628302">t</span><span class="op" id="6628303">.</span><span class="ident" id="6628304">Fatalf</span><span class="op" id="6628310">(</span><span class="string" id="6628311">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6628342">,</span>&nbsp;<span class="ident" id="6628344">err</span><span class="op" id="6628347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6628353">defer</span>&nbsp;<span class="ident" id="6628359">dss</span><span class="op" id="6628362">.</span><span class="ident" id="6628363">teardown</span><span class="op" id="6628371">(</span><span class="op" id="6628372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6628375">if</span>&nbsp;<span class="ident" id="6628378">err</span>&nbsp;<span class="op" id="6628382">:=</span>&nbsp;<span class="ident" id="6628385">dss</span><span class="op" id="6628388">.</span><span class="ident" id="6628389">buildup</span><span class="op" id="6628396">(</span><span class="ident" id="6628397">halfDeadServer</span><span class="op" id="6628411">)</span><span class="op" id="6628412">;</span>&nbsp;<span class="ident" id="6628414">err</span>&nbsp;<span class="op" id="6628418">!=</span>&nbsp;<span class="builtintype" id="6628421">nil</span>&nbsp;<span class="op" id="6628425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628429">t</span><span class="op" id="6628430">.</span><span class="ident" id="6628431">Fatalf</span><span class="op" id="6628437">(</span><span class="string" id="6628438">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6628474">,</span>&nbsp;<span class="ident" id="6628476">err</span><span class="op" id="6628479">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628486">_</span><span class="op" id="6628487">,</span>&nbsp;<span class="ident" id="6628489">before</span><span class="op" id="6628495">,</span>&nbsp;<span class="ident" id="6628497">_</span><span class="op" id="6628498">,</span>&nbsp;<span class="ident" id="6628500">err</span>&nbsp;<span class="op" id="6628504">:=</span>&nbsp;<span class="ident" id="6628507">numTCP</span><span class="op" id="6628513">(</span><span class="op" id="6628514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6628517">if</span>&nbsp;<span class="ident" id="6628520">err</span>&nbsp;<span class="op" id="6628524">!=</span>&nbsp;<span class="builtintype" id="6628527">nil</span>&nbsp;<span class="op" id="6628531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628535">t</span><span class="op" id="6628536">.</span><span class="ident" id="6628537">Skipf</span><span class="op" id="6628542">(</span><span class="string" id="6628543">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6628593">,</span>&nbsp;<span class="ident" id="6628595">err</span><span class="op" id="6628598">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6628605">var</span>&nbsp;<span class="ident" id="6628609">wg</span>&nbsp;<span class="ident" id="6628612">sync</span><span class="op" id="6628616">.</span><span class="ident" id="6628617">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628628">portnum</span><span class="op" id="6628635">,</span>&nbsp;<span class="ident" id="6628637">_</span><span class="op" id="6628638">,</span>&nbsp;<span class="ident" id="6628640">_</span>&nbsp;<span class="op" id="6628642">:=</span>&nbsp;<span class="ident" id="6628645">dtoi</span><span class="op" id="6628649">(</span><span class="ident" id="6628650">dss</span><span class="op" id="6628653">.</span><span class="ident" id="6628654">port</span><span class="op" id="6628658">,</span>&nbsp;<span class="num" id="6628660">0</span><span class="op" id="6628661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6628664">ras</span>&nbsp;<span class="op" id="6628668">:=</span>&nbsp;<span class="ident" id="6628671">addrList</span><span class="op" id="6628679">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6628683">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628736">&amp;</span><span class="ident" id="6628737">TCPAddr</span><span class="op" id="6628744">{</span><span class="ident" id="6628745">IP</span><span class="op" id="6628747">:</span>&nbsp;<span class="ident" id="6628749">IPv4</span><span class="op" id="6628753">(</span><span class="num" id="6628754">198</span><span class="op" id="6628757">,</span>&nbsp;<span class="num" id="6628759">18</span><span class="op" id="6628761">,</span>&nbsp;<span class="num" id="6628763">0</span><span class="op" id="6628764">,</span>&nbsp;<span class="num" id="6628766">254</span><span class="op" id="6628769">)</span><span class="op" id="6628770">,</span>&nbsp;<span class="ident" id="6628772">Port</span><span class="op" id="6628776">:</span>&nbsp;<span class="ident" id="6628778">portnum</span><span class="op" id="6628785">}</span><span class="op" id="6628786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628790">&amp;</span><span class="ident" id="6628791">TCPAddr</span><span class="op" id="6628798">{</span><span class="ident" id="6628799">IP</span><span class="op" id="6628801">:</span>&nbsp;<span class="ident" id="6628803">ParseIP</span><span class="op" id="6628810">(</span><span class="string" id="6628811">&#34;2001:2::254&#34;</span><span class="op" id="6628824">)</span><span class="op" id="6628825">,</span>&nbsp;<span class="ident" id="6628827">Port</span><span class="op" id="6628831">:</span>&nbsp;<span class="ident" id="6628833">portnum</span><span class="op" id="6628840">}</span><span class="op" id="6628841">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6628846">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628883">&amp;</span><span class="ident" id="6628884">TCPAddr</span><span class="op" id="6628891">{</span><span class="ident" id="6628892">IP</span><span class="op" id="6628894">:</span>&nbsp;<span class="ident" id="6628896">IPv4</span><span class="op" id="6628900">(</span><span class="num" id="6628901">127</span><span class="op" id="6628904">,</span>&nbsp;<span class="num" id="6628906">0</span><span class="op" id="6628907">,</span>&nbsp;<span class="num" id="6628909">0</span><span class="op" id="6628910">,</span>&nbsp;<span class="num" id="6628912">1</span><span class="op" id="6628913">)</span><span class="op" id="6628914">,</span>&nbsp;<span class="ident" id="6628916">Port</span><span class="op" id="6628920">:</span>&nbsp;<span class="ident" id="6628922">portnum</span><span class="op" id="6628929">}</span><span class="op" id="6628930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6628934">&amp;</span><span class="ident" id="6628935">TCPAddr</span><span class="op" id="6628942">{</span><span class="ident" id="6628943">IP</span><span class="op" id="6628945">:</span>&nbsp;<span class="ident" id="6628947">IPv6loopback</span><span class="op" id="6628959">,</span>&nbsp;<span class="ident" id="6628961">Port</span><span class="op" id="6628965">:</span>&nbsp;<span class="ident" id="6628967">portnum</span><span class="op" id="6628974">}</span><span class="op" id="6628975">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6628980">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629032">&amp;</span><span class="ident" id="6629033">TCPAddr</span><span class="op" id="6629040">{</span><span class="ident" id="6629041">IP</span><span class="op" id="6629043">:</span>&nbsp;<span class="ident" id="6629045">IPv4</span><span class="op" id="6629049">(</span><span class="num" id="6629050">127</span><span class="op" id="6629053">,</span>&nbsp;<span class="num" id="6629055">0</span><span class="op" id="6629056">,</span>&nbsp;<span class="num" id="6629058">0</span><span class="op" id="6629059">,</span>&nbsp;<span class="num" id="6629061">1</span><span class="op" id="6629062">)</span><span class="op" id="6629063">,</span>&nbsp;<span class="ident" id="6629065">Port</span><span class="op" id="6629069">:</span>&nbsp;<span class="ident" id="6629071">portnum</span><span class="op" id="6629078">}</span><span class="op" id="6629079">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629083">&amp;</span><span class="ident" id="6629084">TCPAddr</span><span class="op" id="6629091">{</span><span class="ident" id="6629092">IP</span><span class="op" id="6629094">:</span>&nbsp;<span class="ident" id="6629096">IPv6loopback</span><span class="op" id="6629108">,</span>&nbsp;<span class="ident" id="6629110">Port</span><span class="op" id="6629114">:</span>&nbsp;<span class="ident" id="6629116">portnum</span><span class="op" id="6629123">}</span><span class="op" id="6629124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629130">const</span>&nbsp;<span class="ident" id="6629136">T1</span>&nbsp;<span class="op" id="6629139">=</span>&nbsp;<span class="num" id="6629141">10</span>&nbsp;<span class="op" id="6629144">*</span>&nbsp;<span class="ident" id="6629146">time</span><span class="op" id="6629150">.</span><span class="ident" id="6629151">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629164">const</span>&nbsp;<span class="ident" id="6629170">T2</span>&nbsp;<span class="op" id="6629173">=</span>&nbsp;<span class="num" id="6629175">2</span>&nbsp;<span class="op" id="6629177">*</span>&nbsp;<span class="ident" id="6629179">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629183">const</span>&nbsp;<span class="ident" id="6629189">N</span>&nbsp;<span class="op" id="6629191">=</span>&nbsp;<span class="num" id="6629193">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629197">for</span>&nbsp;<span class="ident" id="6629201">i</span>&nbsp;<span class="op" id="6629203">:=</span>&nbsp;<span class="num" id="6629206">0</span><span class="op" id="6629207">;</span>&nbsp;<span class="ident" id="6629209">i</span>&nbsp;<span class="op" id="6629211">&lt;</span>&nbsp;<span class="ident" id="6629213">N</span><span class="op" id="6629214">;</span>&nbsp;<span class="ident" id="6629216">i</span><span class="op" id="6629217">++</span>&nbsp;<span class="op" id="6629220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629224">wg</span><span class="op" id="6629226">.</span><span class="ident" id="6629227">Add</span><span class="op" id="6629230">(</span><span class="num" id="6629231">1</span><span class="op" id="6629232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629236">go</span>&nbsp;<span class="keyword" id="6629239">func</span><span class="op" id="6629243">(</span><span class="op" id="6629244">)</span>&nbsp;<span class="op" id="6629246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629251">defer</span>&nbsp;<span class="ident" id="6629257">wg</span><span class="op" id="6629259">.</span><span class="ident" id="6629260">Done</span><span class="op" id="6629264">(</span><span class="op" id="6629265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629270">if</span>&nbsp;<span class="ident" id="6629273">c</span><span class="op" id="6629274">,</span>&nbsp;<span class="ident" id="6629276">err</span>&nbsp;<span class="op" id="6629280">:=</span>&nbsp;<span class="ident" id="6629283">dialMulti</span><span class="op" id="6629292">(</span><span class="string" id="6629293">&#34;tcp&#34;</span><span class="op" id="6629298">,</span>&nbsp;<span class="string" id="6629300">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="6629320">,</span>&nbsp;<span class="builtintype" id="6629322">nil</span><span class="op" id="6629325">,</span>&nbsp;<span class="ident" id="6629327">ras</span><span class="op" id="6629330">,</span>&nbsp;<span class="ident" id="6629332">time</span><span class="op" id="6629336">.</span><span class="ident" id="6629337">Now</span><span class="op" id="6629340">(</span><span class="op" id="6629341">)</span><span class="op" id="6629342">.</span><span class="ident" id="6629343">Add</span><span class="op" id="6629346">(</span><span class="ident" id="6629347">T1</span><span class="op" id="6629349">)</span><span class="op" id="6629350">)</span><span class="op" id="6629351">;</span>&nbsp;<span class="ident" id="6629353">err</span>&nbsp;<span class="op" id="6629357">==</span>&nbsp;<span class="builtintype" id="6629360">nil</span>&nbsp;<span class="op" id="6629364">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629370">c</span><span class="op" id="6629371">.</span><span class="ident" id="6629372">Close</span><span class="op" id="6629377">(</span><span class="op" id="6629378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629387">}</span><span class="op" id="6629388">(</span><span class="op" id="6629389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629395">wg</span><span class="op" id="6629397">.</span><span class="ident" id="6629398">Wait</span><span class="op" id="6629402">(</span><span class="op" id="6629403">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629406">time</span><span class="op" id="6629410">.</span><span class="ident" id="6629411">Sleep</span><span class="op" id="6629416">(</span><span class="ident" id="6629417">T2</span><span class="op" id="6629419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629423">ntcp</span><span class="op" id="6629427">,</span>&nbsp;<span class="ident" id="6629429">after</span><span class="op" id="6629434">,</span>&nbsp;<span class="ident" id="6629436">nclose</span><span class="op" id="6629442">,</span>&nbsp;<span class="ident" id="6629444">err</span>&nbsp;<span class="op" id="6629448">:=</span>&nbsp;<span class="ident" id="6629451">numTCP</span><span class="op" id="6629457">(</span><span class="op" id="6629458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629461">if</span>&nbsp;<span class="ident" id="6629464">err</span>&nbsp;<span class="op" id="6629468">!=</span>&nbsp;<span class="builtintype" id="6629471">nil</span>&nbsp;<span class="op" id="6629475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629479">t</span><span class="op" id="6629480">.</span><span class="ident" id="6629481">Skipf</span><span class="op" id="6629486">(</span><span class="string" id="6629487">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6629537">,</span>&nbsp;<span class="ident" id="6629539">err</span><span class="op" id="6629542">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629548">t</span><span class="op" id="6629549">.</span><span class="ident" id="6629550">Logf</span><span class="op" id="6629554">(</span><span class="string" id="6629555">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="6629614">,</span>&nbsp;<span class="ident" id="6629616">ntcp</span><span class="op" id="6629620">,</span>&nbsp;<span class="ident" id="6629622">after</span><span class="op" id="6629627">,</span>&nbsp;<span class="ident" id="6629629">nclose</span><span class="op" id="6629635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629639">if</span>&nbsp;<span class="ident" id="6629642">after</span>&nbsp;<span class="op" id="6629648">!=</span>&nbsp;<span class="ident" id="6629651">before</span>&nbsp;<span class="op" id="6629658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629662">t</span><span class="op" id="6629663">.</span><span class="ident" id="6629664">Fatalf</span><span class="op" id="6629670">(</span><span class="string" id="6629671">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="6629706">,</span>&nbsp;<span class="ident" id="6629708">after</span><span class="op" id="6629713">,</span>&nbsp;<span class="ident" id="6629715">before</span><span class="op" id="6629721">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629724">}</span><br>
<span class="lineno"></span><span class="op" id="6629726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6629729">func</span>&nbsp;<span class="ident" id="6629734">numFD</span><span class="op" id="6629739">(</span><span class="op" id="6629740">)</span>&nbsp;<span class="builtintype" id="6629742">int</span>&nbsp;<span class="op" id="6629746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629749">if</span>&nbsp;<span class="ident" id="6629752">runtime</span><span class="op" id="6629759">.</span><span class="ident" id="6629760">GOOS</span>&nbsp;<span class="op" id="6629765">==</span>&nbsp;<span class="string" id="6629768">&#34;linux&#34;</span>&nbsp;<span class="op" id="6629776">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629780">f</span><span class="op" id="6629781">,</span>&nbsp;<span class="ident" id="6629783">err</span>&nbsp;<span class="op" id="6629787">:=</span>&nbsp;<span class="ident" id="6629790">os</span><span class="op" id="6629792">.</span><span class="ident" id="6629793">Open</span><span class="op" id="6629797">(</span><span class="string" id="6629798">&#34;/proc/self/fd&#34;</span><span class="op" id="6629813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629817">if</span>&nbsp;<span class="ident" id="6629820">err</span>&nbsp;<span class="op" id="6629824">!=</span>&nbsp;<span class="builtintype" id="6629827">nil</span>&nbsp;<span class="op" id="6629831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6629836">panic</span><span class="op" id="6629841">(</span><span class="ident" id="6629842">err</span><span class="op" id="6629845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629853">defer</span>&nbsp;<span class="ident" id="6629859">f</span><span class="op" id="6629860">.</span><span class="ident" id="6629861">Close</span><span class="op" id="6629866">(</span><span class="op" id="6629867">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6629871">names</span><span class="op" id="6629876">,</span>&nbsp;<span class="ident" id="6629878">err</span>&nbsp;<span class="op" id="6629882">:=</span>&nbsp;<span class="ident" id="6629885">f</span><span class="op" id="6629886">.</span><span class="ident" id="6629887">Readdirnames</span><span class="op" id="6629899">(</span><span class="num" id="6629900">0</span><span class="op" id="6629901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629905">if</span>&nbsp;<span class="ident" id="6629908">err</span>&nbsp;<span class="op" id="6629912">!=</span>&nbsp;<span class="builtintype" id="6629915">nil</span>&nbsp;<span class="op" id="6629919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6629924">panic</span><span class="op" id="6629929">(</span><span class="ident" id="6629930">err</span><span class="op" id="6629933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6629941">return</span>&nbsp;<span class="builtinfunc" id="6629948">len</span><span class="op" id="6629951">(</span><span class="ident" id="6629952">names</span><span class="op" id="6629957">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6629960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6629963">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6630019">panic</span><span class="op" id="6630024">(</span><span class="string" id="6630025">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="6630054">+</span>&nbsp;<span class="ident" id="6630056">runtime</span><span class="op" id="6630063">.</span><span class="ident" id="6630064">GOOS</span><span class="op" id="6630068">)</span><br>
<span class="lineno"></span><span class="op" id="6630070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6630073">func</span>&nbsp;<span class="ident" id="6630078">TestDialer</span><span class="op" id="6630088">(</span><span class="ident" id="6630089">t</span>&nbsp;<span class="op" id="6630091">*</span><span class="ident" id="6630092">testing</span><span class="op" id="6630099">.</span><span class="ident" id="6630100">T</span><span class="op" id="6630101">)</span>&nbsp;<span class="op" id="6630103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630106">ln</span><span class="op" id="6630108">,</span>&nbsp;<span class="ident" id="6630110">err</span>&nbsp;<span class="op" id="6630114">:=</span>&nbsp;<span class="ident" id="6630117">Listen</span><span class="op" id="6630123">(</span><span class="string" id="6630124">&#34;tcp4&#34;</span><span class="op" id="6630130">,</span>&nbsp;<span class="string" id="6630132">&#34;127.0.0.1:0&#34;</span><span class="op" id="6630145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630148">if</span>&nbsp;<span class="ident" id="6630151">err</span>&nbsp;<span class="op" id="6630155">!=</span>&nbsp;<span class="builtintype" id="6630158">nil</span>&nbsp;<span class="op" id="6630162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630166">t</span><span class="op" id="6630167">.</span><span class="ident" id="6630168">Fatalf</span><span class="op" id="6630174">(</span><span class="string" id="6630175">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6630194">,</span>&nbsp;<span class="ident" id="6630196">err</span><span class="op" id="6630199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630202">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630205">defer</span>&nbsp;<span class="ident" id="6630211">ln</span><span class="op" id="6630213">.</span><span class="ident" id="6630214">Close</span><span class="op" id="6630219">(</span><span class="op" id="6630220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630223">ch</span>&nbsp;<span class="op" id="6630226">:=</span>&nbsp;<span class="builtinfunc" id="6630229">make</span><span class="op" id="6630233">(</span><span class="keyword" id="6630234">chan</span>&nbsp;<span class="builtintype" id="6630239">error</span><span class="op" id="6630244">,</span>&nbsp;<span class="num" id="6630246">1</span><span class="op" id="6630247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630250">go</span>&nbsp;<span class="keyword" id="6630253">func</span><span class="op" id="6630257">(</span><span class="op" id="6630258">)</span>&nbsp;<span class="op" id="6630260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630264">c</span><span class="op" id="6630265">,</span>&nbsp;<span class="ident" id="6630267">err</span>&nbsp;<span class="op" id="6630271">:=</span>&nbsp;<span class="ident" id="6630274">ln</span><span class="op" id="6630276">.</span><span class="ident" id="6630277">Accept</span><span class="op" id="6630283">(</span><span class="op" id="6630284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630288">if</span>&nbsp;<span class="ident" id="6630291">err</span>&nbsp;<span class="op" id="6630295">!=</span>&nbsp;<span class="builtintype" id="6630298">nil</span>&nbsp;<span class="op" id="6630302">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630307">ch</span>&nbsp;<span class="op" id="6630310">&lt;-</span>&nbsp;<span class="ident" id="6630313">fmt</span><span class="op" id="6630316">.</span><span class="ident" id="6630317">Errorf</span><span class="op" id="6630323">(</span><span class="string" id="6630324">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6630343">,</span>&nbsp;<span class="ident" id="6630345">err</span><span class="op" id="6630348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630353">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630366">defer</span>&nbsp;<span class="ident" id="6630372">c</span><span class="op" id="6630373">.</span><span class="ident" id="6630374">Close</span><span class="op" id="6630379">(</span><span class="op" id="6630380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630384">ch</span>&nbsp;<span class="op" id="6630387">&lt;-</span>&nbsp;<span class="builtintype" id="6630390">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630395">}</span><span class="op" id="6630396">(</span><span class="op" id="6630397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630401">laddr</span><span class="op" id="6630406">,</span>&nbsp;<span class="ident" id="6630408">err</span>&nbsp;<span class="op" id="6630412">:=</span>&nbsp;<span class="ident" id="6630415">ResolveTCPAddr</span><span class="op" id="6630429">(</span><span class="string" id="6630430">&#34;tcp4&#34;</span><span class="op" id="6630436">,</span>&nbsp;<span class="string" id="6630438">&#34;127.0.0.1:0&#34;</span><span class="op" id="6630451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630454">if</span>&nbsp;<span class="ident" id="6630457">err</span>&nbsp;<span class="op" id="6630461">!=</span>&nbsp;<span class="builtintype" id="6630464">nil</span>&nbsp;<span class="op" id="6630468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630472">t</span><span class="op" id="6630473">.</span><span class="ident" id="6630474">Fatalf</span><span class="op" id="6630480">(</span><span class="string" id="6630481">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6630508">,</span>&nbsp;<span class="ident" id="6630510">err</span><span class="op" id="6630513">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630519">d</span>&nbsp;<span class="op" id="6630521">:=</span>&nbsp;<span class="op" id="6630524">&amp;</span><span class="ident" id="6630525">Dialer</span><span class="op" id="6630531">{</span><span class="ident" id="6630532">LocalAddr</span><span class="op" id="6630541">:</span>&nbsp;<span class="ident" id="6630543">laddr</span><span class="op" id="6630548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630551">c</span><span class="op" id="6630552">,</span>&nbsp;<span class="ident" id="6630554">err</span>&nbsp;<span class="op" id="6630558">:=</span>&nbsp;<span class="ident" id="6630561">d</span><span class="op" id="6630562">.</span><span class="ident" id="6630563">Dial</span><span class="op" id="6630567">(</span><span class="string" id="6630568">&#34;tcp4&#34;</span><span class="op" id="6630574">,</span>&nbsp;<span class="ident" id="6630576">ln</span><span class="op" id="6630578">.</span><span class="ident" id="6630579">Addr</span><span class="op" id="6630583">(</span><span class="op" id="6630584">)</span><span class="op" id="6630585">.</span><span class="ident" id="6630586">String</span><span class="op" id="6630592">(</span><span class="op" id="6630593">)</span><span class="op" id="6630594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630597">if</span>&nbsp;<span class="ident" id="6630600">err</span>&nbsp;<span class="op" id="6630604">!=</span>&nbsp;<span class="builtintype" id="6630607">nil</span>&nbsp;<span class="op" id="6630611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630615">t</span><span class="op" id="6630616">.</span><span class="ident" id="6630617">Fatalf</span><span class="op" id="6630623">(</span><span class="string" id="6630624">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6630641">,</span>&nbsp;<span class="ident" id="6630643">err</span><span class="op" id="6630646">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630652">defer</span>&nbsp;<span class="ident" id="6630658">c</span><span class="op" id="6630659">.</span><span class="ident" id="6630660">Close</span><span class="op" id="6630665">(</span><span class="op" id="6630666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630669">c</span><span class="op" id="6630670">.</span><span class="ident" id="6630671">Read</span><span class="op" id="6630675">(</span><span class="builtinfunc" id="6630676">make</span><span class="op" id="6630680">(</span><span class="op" id="6630681">[</span><span class="op" id="6630682">]</span><span class="builtintype" id="6630683">byte</span><span class="op" id="6630687">,</span>&nbsp;<span class="num" id="6630689">1</span><span class="op" id="6630690">)</span><span class="op" id="6630691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630694">err</span>&nbsp;<span class="op" id="6630698">=</span>&nbsp;<span class="op" id="6630700">&lt;-</span><span class="ident" id="6630702">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630706">if</span>&nbsp;<span class="ident" id="6630709">err</span>&nbsp;<span class="op" id="6630713">!=</span>&nbsp;<span class="builtintype" id="6630716">nil</span>&nbsp;<span class="op" id="6630720">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630724">t</span><span class="op" id="6630725">.</span><span class="ident" id="6630726">Error</span><span class="op" id="6630731">(</span><span class="ident" id="6630732">err</span><span class="op" id="6630735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630738">}</span><br>
<span class="lineno"></span><span class="op" id="6630740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6630743">func</span>&nbsp;<span class="ident" id="6630748">TestDialDualStackLocalhost</span><span class="op" id="6630774">(</span><span class="ident" id="6630775">t</span>&nbsp;<span class="op" id="6630777">*</span><span class="ident" id="6630778">testing</span><span class="op" id="6630785">.</span><span class="ident" id="6630786">T</span><span class="op" id="6630787">)</span>&nbsp;<span class="op" id="6630789">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630792">switch</span>&nbsp;<span class="ident" id="6630799">runtime</span><span class="op" id="6630806">.</span><span class="ident" id="6630807">GOOS</span>&nbsp;<span class="op" id="6630812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630815">case</span>&nbsp;<span class="string" id="6630820">&#34;nacl&#34;</span><span class="op" id="6630826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630830">t</span><span class="op" id="6630831">.</span><span class="ident" id="6630832">Skipf</span><span class="op" id="6630837">(</span><span class="string" id="6630838">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6630859">,</span>&nbsp;<span class="ident" id="6630861">runtime</span><span class="op" id="6630868">.</span><span class="ident" id="6630869">GOOS</span><span class="op" id="6630873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6630880">if</span>&nbsp;<span class="ident" id="6630883">ips</span><span class="op" id="6630886">,</span>&nbsp;<span class="ident" id="6630888">err</span>&nbsp;<span class="op" id="6630892">:=</span>&nbsp;<span class="ident" id="6630895">LookupIP</span><span class="op" id="6630903">(</span><span class="string" id="6630904">&#34;localhost&#34;</span><span class="op" id="6630915">)</span><span class="op" id="6630916">;</span>&nbsp;<span class="ident" id="6630918">err</span>&nbsp;<span class="op" id="6630922">!=</span>&nbsp;<span class="builtintype" id="6630925">nil</span>&nbsp;<span class="op" id="6630929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6630933">t</span><span class="op" id="6630934">.</span><span class="ident" id="6630935">Fatalf</span><span class="op" id="6630941">(</span><span class="string" id="6630942">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6630963">,</span>&nbsp;<span class="ident" id="6630965">err</span><span class="op" id="6630968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6630971">}</span>&nbsp;<span class="keyword" id="6630973">else</span>&nbsp;<span class="keyword" id="6630978">if</span>&nbsp;<span class="builtinfunc" id="6630981">len</span><span class="op" id="6630984">(</span><span class="ident" id="6630985">ips</span><span class="op" id="6630988">)</span>&nbsp;<span class="op" id="6630990">&lt;</span>&nbsp;<span class="num" id="6630992">2</span>&nbsp;<span class="op" id="6630994">||</span>&nbsp;<span class="op" id="6630997">!</span><span class="ident" id="6630998">supportsIPv4</span>&nbsp;<span class="op" id="6631011">||</span>&nbsp;<span class="op" id="6631014">!</span><span class="ident" id="6631015">supportsIPv6</span>&nbsp;<span class="op" id="6631028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631032">t</span><span class="op" id="6631033">.</span><span class="ident" id="6631034">Skip</span><span class="op" id="6631038">(</span><span class="string" id="6631039">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="6631111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631114">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631118">touchAndByeServer</span>&nbsp;<span class="op" id="6631136">:=</span>&nbsp;<span class="keyword" id="6631139">func</span><span class="op" id="6631143">(</span><span class="ident" id="6631144">dss</span>&nbsp;<span class="op" id="6631148">*</span><span class="ident" id="6631149">dualStackServer</span><span class="op" id="6631164">,</span>&nbsp;<span class="ident" id="6631166">ln</span>&nbsp;<span class="ident" id="6631169">Listener</span><span class="op" id="6631177">)</span>&nbsp;<span class="op" id="6631179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631183">for</span>&nbsp;<span class="op" id="6631187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631192">if</span>&nbsp;<span class="ident" id="6631195">c</span><span class="op" id="6631196">,</span>&nbsp;<span class="ident" id="6631198">err</span>&nbsp;<span class="op" id="6631202">:=</span>&nbsp;<span class="ident" id="6631205">ln</span><span class="op" id="6631207">.</span><span class="ident" id="6631208">Accept</span><span class="op" id="6631214">(</span><span class="op" id="6631215">)</span><span class="op" id="6631216">;</span>&nbsp;<span class="ident" id="6631218">err</span>&nbsp;<span class="op" id="6631222">!=</span>&nbsp;<span class="builtintype" id="6631225">nil</span>&nbsp;<span class="op" id="6631229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631235">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631245">}</span>&nbsp;<span class="keyword" id="6631247">else</span>&nbsp;<span class="op" id="6631252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631258">c</span><span class="op" id="6631259">.</span><span class="ident" id="6631260">Close</span><span class="op" id="6631265">(</span><span class="op" id="6631266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631278">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631281">dss</span><span class="op" id="6631284">,</span>&nbsp;<span class="ident" id="6631286">err</span>&nbsp;<span class="op" id="6631290">:=</span>&nbsp;<span class="ident" id="6631293">newDualStackServer</span><span class="op" id="6631311">(</span><span class="op" id="6631312">[</span><span class="op" id="6631313">]</span><span class="ident" id="6631314">streamListener</span><span class="op" id="6631328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631332">{</span><span class="ident" id="6631333">net</span><span class="op" id="6631336">:</span>&nbsp;<span class="string" id="6631338">&#34;tcp4&#34;</span><span class="op" id="6631344">,</span>&nbsp;<span class="ident" id="6631346">addr</span><span class="op" id="6631350">:</span>&nbsp;<span class="string" id="6631352">&#34;127.0.0.1&#34;</span><span class="op" id="6631363">}</span><span class="op" id="6631364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631368">{</span><span class="ident" id="6631369">net</span><span class="op" id="6631372">:</span>&nbsp;<span class="string" id="6631374">&#34;tcp6&#34;</span><span class="op" id="6631380">,</span>&nbsp;<span class="ident" id="6631382">addr</span><span class="op" id="6631386">:</span>&nbsp;<span class="string" id="6631388">&#34;[::1]&#34;</span><span class="op" id="6631395">}</span><span class="op" id="6631396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631399">}</span><span class="op" id="6631400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631403">if</span>&nbsp;<span class="ident" id="6631406">err</span>&nbsp;<span class="op" id="6631410">!=</span>&nbsp;<span class="builtintype" id="6631413">nil</span>&nbsp;<span class="op" id="6631417">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631421">t</span><span class="op" id="6631422">.</span><span class="ident" id="6631423">Fatalf</span><span class="op" id="6631429">(</span><span class="string" id="6631430">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6631461">,</span>&nbsp;<span class="ident" id="6631463">err</span><span class="op" id="6631466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631472">defer</span>&nbsp;<span class="ident" id="6631478">dss</span><span class="op" id="6631481">.</span><span class="ident" id="6631482">teardown</span><span class="op" id="6631490">(</span><span class="op" id="6631491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631494">if</span>&nbsp;<span class="ident" id="6631497">err</span>&nbsp;<span class="op" id="6631501">:=</span>&nbsp;<span class="ident" id="6631504">dss</span><span class="op" id="6631507">.</span><span class="ident" id="6631508">buildup</span><span class="op" id="6631515">(</span><span class="ident" id="6631516">touchAndByeServer</span><span class="op" id="6631533">)</span><span class="op" id="6631534">;</span>&nbsp;<span class="ident" id="6631536">err</span>&nbsp;<span class="op" id="6631540">!=</span>&nbsp;<span class="builtintype" id="6631543">nil</span>&nbsp;<span class="op" id="6631547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631551">t</span><span class="op" id="6631552">.</span><span class="ident" id="6631553">Fatalf</span><span class="op" id="6631559">(</span><span class="string" id="6631560">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6631596">,</span>&nbsp;<span class="ident" id="6631598">err</span><span class="op" id="6631601">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631608">d</span>&nbsp;<span class="op" id="6631610">:=</span>&nbsp;<span class="op" id="6631613">&amp;</span><span class="ident" id="6631614">Dialer</span><span class="op" id="6631620">{</span><span class="ident" id="6631621">DualStack</span><span class="op" id="6631630">:</span>&nbsp;<span class="builtintype" id="6631632">true</span><span class="op" id="6631636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631639">for</span>&nbsp;<span class="keyword" id="6631643">range</span>&nbsp;<span class="ident" id="6631649">dss</span><span class="op" id="6631652">.</span><span class="ident" id="6631653">lns</span>&nbsp;<span class="op" id="6631657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631661">if</span>&nbsp;<span class="ident" id="6631664">c</span><span class="op" id="6631665">,</span>&nbsp;<span class="ident" id="6631667">err</span>&nbsp;<span class="op" id="6631671">:=</span>&nbsp;<span class="ident" id="6631674">d</span><span class="op" id="6631675">.</span><span class="ident" id="6631676">Dial</span><span class="op" id="6631680">(</span><span class="string" id="6631681">&#34;tcp&#34;</span><span class="op" id="6631686">,</span>&nbsp;<span class="string" id="6631688">&#34;localhost:&#34;</span><span class="op" id="6631700">+</span><span class="ident" id="6631701">dss</span><span class="op" id="6631704">.</span><span class="ident" id="6631705">port</span><span class="op" id="6631709">)</span><span class="op" id="6631710">;</span>&nbsp;<span class="ident" id="6631712">err</span>&nbsp;<span class="op" id="6631716">!=</span>&nbsp;<span class="builtintype" id="6631719">nil</span>&nbsp;<span class="op" id="6631723">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631728">t</span><span class="op" id="6631729">.</span><span class="ident" id="6631730">Errorf</span><span class="op" id="6631736">(</span><span class="string" id="6631737">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6631754">,</span>&nbsp;<span class="ident" id="6631756">err</span><span class="op" id="6631759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631763">}</span>&nbsp;<span class="keyword" id="6631765">else</span>&nbsp;<span class="op" id="6631770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6631775">if</span>&nbsp;<span class="ident" id="6631778">addr</span>&nbsp;<span class="op" id="6631783">:=</span>&nbsp;<span class="ident" id="6631786">c</span><span class="op" id="6631787">.</span><span class="ident" id="6631788">LocalAddr</span><span class="op" id="6631797">(</span><span class="op" id="6631798">)</span><span class="op" id="6631799">.</span><span class="op" id="6631800">(</span><span class="op" id="6631801">*</span><span class="ident" id="6631802">TCPAddr</span><span class="op" id="6631809">)</span><span class="op" id="6631810">;</span>&nbsp;<span class="ident" id="6631812">addr</span><span class="op" id="6631816">.</span><span class="ident" id="6631817">IP</span><span class="op" id="6631819">.</span><span class="ident" id="6631820">To4</span><span class="op" id="6631823">(</span><span class="op" id="6631824">)</span>&nbsp;<span class="op" id="6631826">!=</span>&nbsp;<span class="builtintype" id="6631829">nil</span>&nbsp;<span class="op" id="6631833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631839">dss</span><span class="op" id="6631842">.</span><span class="ident" id="6631843">teardownNetwork</span><span class="op" id="6631858">(</span><span class="string" id="6631859">&#34;tcp4&#34;</span><span class="op" id="6631865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631870">}</span>&nbsp;<span class="keyword" id="6631872">else</span>&nbsp;<span class="keyword" id="6631877">if</span>&nbsp;<span class="ident" id="6631880">addr</span><span class="op" id="6631884">.</span><span class="ident" id="6631885">IP</span><span class="op" id="6631887">.</span><span class="ident" id="6631888">To16</span><span class="op" id="6631892">(</span><span class="op" id="6631893">)</span>&nbsp;<span class="op" id="6631895">!=</span>&nbsp;<span class="builtintype" id="6631898">nil</span>&nbsp;<span class="op" id="6631902">&amp;&amp;</span>&nbsp;<span class="ident" id="6631905">addr</span><span class="op" id="6631909">.</span><span class="ident" id="6631910">IP</span><span class="op" id="6631912">.</span><span class="ident" id="6631913">To4</span><span class="op" id="6631916">(</span><span class="op" id="6631917">)</span>&nbsp;<span class="op" id="6631919">==</span>&nbsp;<span class="builtintype" id="6631922">nil</span>&nbsp;<span class="op" id="6631926">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631932">dss</span><span class="op" id="6631935">.</span><span class="ident" id="6631936">teardownNetwork</span><span class="op" id="6631951">(</span><span class="string" id="6631952">&#34;tcp6&#34;</span><span class="op" id="6631958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6631968">c</span><span class="op" id="6631969">.</span><span class="ident" id="6631970">Close</span><span class="op" id="6631975">(</span><span class="op" id="6631976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6631983">}</span><br>
<span class="lineno">515</span><span class="op" id="6631985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6631988">func</span>&nbsp;<span class="ident" id="6631993">TestDialerKeepAlive</span><span class="op" id="6632012">(</span><span class="ident" id="6632013">t</span>&nbsp;<span class="op" id="6632015">*</span><span class="ident" id="6632016">testing</span><span class="op" id="6632023">.</span><span class="ident" id="6632024">T</span><span class="op" id="6632025">)</span>&nbsp;<span class="op" id="6632027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632030">ln</span>&nbsp;<span class="op" id="6632033">:=</span>&nbsp;<span class="ident" id="6632036">newLocalListener</span><span class="op" id="6632052">(</span><span class="ident" id="6632053">t</span><span class="op" id="6632054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632057">defer</span>&nbsp;<span class="ident" id="6632063">ln</span><span class="op" id="6632065">.</span><span class="ident" id="6632066">Close</span><span class="op" id="6632071">(</span><span class="op" id="6632072">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632075">defer</span>&nbsp;<span class="keyword" id="6632081">func</span><span class="op" id="6632085">(</span><span class="op" id="6632086">)</span>&nbsp;<span class="op" id="6632088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632092">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6632113">=</span>&nbsp;<span class="keyword" id="6632115">func</span><span class="op" id="6632119">(</span><span class="op" id="6632120">)</span>&nbsp;<span class="op" id="6632122">{</span><span class="op" id="6632123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632126">}</span><span class="op" id="6632127">(</span><span class="op" id="6632128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632131">go</span>&nbsp;<span class="keyword" id="6632134">func</span><span class="op" id="6632138">(</span><span class="op" id="6632139">)</span>&nbsp;<span class="op" id="6632141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632145">for</span>&nbsp;<span class="op" id="6632149">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632154">c</span><span class="op" id="6632155">,</span>&nbsp;<span class="ident" id="6632157">err</span>&nbsp;<span class="op" id="6632161">:=</span>&nbsp;<span class="ident" id="6632164">ln</span><span class="op" id="6632166">.</span><span class="ident" id="6632167">Accept</span><span class="op" id="6632173">(</span><span class="op" id="6632174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632179">if</span>&nbsp;<span class="ident" id="6632182">err</span>&nbsp;<span class="op" id="6632186">!=</span>&nbsp;<span class="builtintype" id="6632189">nil</span>&nbsp;<span class="op" id="6632193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632199">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632214">c</span><span class="op" id="6632215">.</span><span class="ident" id="6632216">Close</span><span class="op" id="6632221">(</span><span class="op" id="6632222">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632229">}</span><span class="op" id="6632230">(</span><span class="op" id="6632231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632234">for</span>&nbsp;<span class="ident" id="6632238">_</span><span class="op" id="6632239">,</span>&nbsp;<span class="ident" id="6632241">keepAlive</span>&nbsp;<span class="op" id="6632251">:=</span>&nbsp;<span class="keyword" id="6632254">range</span>&nbsp;<span class="op" id="6632260">[</span><span class="op" id="6632261">]</span><span class="builtintype" id="6632262">bool</span><span class="op" id="6632266">{</span><span class="builtintype" id="6632267">false</span><span class="op" id="6632272">,</span>&nbsp;<span class="builtintype" id="6632274">true</span><span class="op" id="6632278">}</span>&nbsp;<span class="op" id="6632280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632284">got</span>&nbsp;<span class="op" id="6632288">:=</span>&nbsp;<span class="builtintype" id="6632291">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632299">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6632320">=</span>&nbsp;<span class="keyword" id="6632322">func</span><span class="op" id="6632326">(</span><span class="op" id="6632327">)</span>&nbsp;<span class="op" id="6632329">{</span>&nbsp;<span class="ident" id="6632331">got</span>&nbsp;<span class="op" id="6632335">=</span>&nbsp;<span class="builtintype" id="6632337">true</span>&nbsp;<span class="op" id="6632342">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632346">var</span>&nbsp;<span class="ident" id="6632350">d</span>&nbsp;<span class="ident" id="6632352">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632361">if</span>&nbsp;<span class="ident" id="6632364">keepAlive</span>&nbsp;<span class="op" id="6632374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632379">d</span><span class="op" id="6632380">.</span><span class="ident" id="6632381">KeepAlive</span>&nbsp;<span class="op" id="6632391">=</span>&nbsp;<span class="num" id="6632393">30</span>&nbsp;<span class="op" id="6632396">*</span>&nbsp;<span class="ident" id="6632398">time</span><span class="op" id="6632402">.</span><span class="ident" id="6632403">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632416">c</span><span class="op" id="6632417">,</span>&nbsp;<span class="ident" id="6632419">err</span>&nbsp;<span class="op" id="6632423">:=</span>&nbsp;<span class="ident" id="6632426">d</span><span class="op" id="6632427">.</span><span class="ident" id="6632428">Dial</span><span class="op" id="6632432">(</span><span class="string" id="6632433">&#34;tcp&#34;</span><span class="op" id="6632438">,</span>&nbsp;<span class="ident" id="6632440">ln</span><span class="op" id="6632442">.</span><span class="ident" id="6632443">Addr</span><span class="op" id="6632447">(</span><span class="op" id="6632448">)</span><span class="op" id="6632449">.</span><span class="ident" id="6632450">String</span><span class="op" id="6632456">(</span><span class="op" id="6632457">)</span><span class="op" id="6632458">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632462">if</span>&nbsp;<span class="ident" id="6632465">err</span>&nbsp;<span class="op" id="6632469">!=</span>&nbsp;<span class="builtintype" id="6632472">nil</span>&nbsp;<span class="op" id="6632476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632481">t</span><span class="op" id="6632482">.</span><span class="ident" id="6632483">Fatal</span><span class="op" id="6632488">(</span><span class="ident" id="6632489">err</span><span class="op" id="6632492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632500">c</span><span class="op" id="6632501">.</span><span class="ident" id="6632502">Close</span><span class="op" id="6632507">(</span><span class="op" id="6632508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6632512">if</span>&nbsp;<span class="ident" id="6632515">got</span>&nbsp;<span class="op" id="6632519">!=</span>&nbsp;<span class="ident" id="6632522">keepAlive</span>&nbsp;<span class="op" id="6632532">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6632537">t</span><span class="op" id="6632538">.</span><span class="ident" id="6632539">Errorf</span><span class="op" id="6632545">(</span><span class="string" id="6632546">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6632604">,</span>&nbsp;<span class="ident" id="6632606">d</span><span class="op" id="6632607">.</span><span class="ident" id="6632608">KeepAlive</span><span class="op" id="6632617">,</span>&nbsp;<span class="ident" id="6632619">got</span><span class="op" id="6632622">,</span>&nbsp;<span class="op" id="6632624">!</span><span class="ident" id="6632625">got</span><span class="op" id="6632628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6632635">}</span><br>
<span class="lineno"></span><span class="op" id="6632637">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
