<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html" class="current">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3063163">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3063218">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3063272">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3063323">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3063393">package</span>&nbsp;<span class="ident" id="3063401">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3063406">import</span>&nbsp;<span class="op" id="3063413">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063416">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063422">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063428">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063439">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063454">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063465">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3063472">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3063475">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3063503">type</span>&nbsp;<span class="ident" id="3063508">netFD</span>&nbsp;<span class="keyword" id="3063514">struct</span>&nbsp;<span class="op" id="3063521">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063524">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063599">fdmu</span>&nbsp;<span class="ident" id="3063604">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063614">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063640">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3063652">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063657">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3063669">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063674">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3063686">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063691">isConnected</span>&nbsp;<span class="builtintype" id="3063703">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063709">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3063721">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063729">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063741">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063747">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063759">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063766">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063782">pd</span>&nbsp;<span class="ident" id="3063785">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3063794">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3063797">func</span>&nbsp;<span class="ident" id="3063802">sysInit</span><span class="op" id="3063809">(</span><span class="op" id="3063810">)</span>&nbsp;<span class="op" id="3063812">{</span><br>
<span class="lineno"></span><span class="op" id="3063814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3063817">func</span>&nbsp;<span class="ident" id="3063822">dial</span><span class="op" id="3063826">(</span><span class="ident" id="3063827">network</span>&nbsp;<span class="builtintype" id="3063835">string</span><span class="op" id="3063841">,</span>&nbsp;<span class="ident" id="3063843">ra</span>&nbsp;<span class="ident" id="3063846">Addr</span><span class="op" id="3063850">,</span>&nbsp;<span class="ident" id="3063852">dialer</span>&nbsp;<span class="keyword" id="3063859">func</span><span class="op" id="3063863">(</span><span class="ident" id="3063864">time</span><span class="op" id="3063868">.</span><span class="ident" id="3063869">Time</span><span class="op" id="3063873">)</span>&nbsp;<span class="op" id="3063875">(</span><span class="ident" id="3063876">Conn</span><span class="op" id="3063880">,</span>&nbsp;<span class="builtintype" id="3063882">error</span><span class="op" id="3063887">)</span><span class="op" id="3063888">,</span>&nbsp;<span class="ident" id="3063890">deadline</span>&nbsp;<span class="ident" id="3063899">time</span><span class="op" id="3063903">.</span><span class="ident" id="3063904">Time</span><span class="op" id="3063908">)</span>&nbsp;<span class="op" id="3063910">(</span><span class="ident" id="3063911">Conn</span><span class="op" id="3063915">,</span>&nbsp;<span class="builtintype" id="3063917">error</span><span class="op" id="3063922">)</span>&nbsp;<span class="op" id="3063924">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3063927">return</span>&nbsp;<span class="ident" id="3063934">dialer</span><span class="op" id="3063940">(</span><span class="ident" id="3063941">deadline</span><span class="op" id="3063949">)</span><br>
<span class="lineno"></span><span class="op" id="3063951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3063954">func</span>&nbsp;<span class="ident" id="3063959">newFD</span><span class="op" id="3063964">(</span><span class="ident" id="3063965">sysfd</span><span class="op" id="3063970">,</span>&nbsp;<span class="ident" id="3063972">family</span><span class="op" id="3063978">,</span>&nbsp;<span class="ident" id="3063980">sotype</span>&nbsp;<span class="builtintype" id="3063987">int</span><span class="op" id="3063990">,</span>&nbsp;<span class="ident" id="3063992">net</span>&nbsp;<span class="builtintype" id="3063996">string</span><span class="op" id="3064002">)</span>&nbsp;<span class="op" id="3064004">(</span><span class="op" id="3064005">*</span><span class="ident" id="3064006">netFD</span><span class="op" id="3064011">,</span>&nbsp;<span class="builtintype" id="3064013">error</span><span class="op" id="3064018">)</span>&nbsp;<span class="op" id="3064020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064023">return</span>&nbsp;<span class="op" id="3064030">&amp;</span><span class="ident" id="3064031">netFD</span><span class="op" id="3064036">{</span><span class="ident" id="3064037">sysfd</span><span class="op" id="3064042">:</span>&nbsp;<span class="ident" id="3064044">sysfd</span><span class="op" id="3064049">,</span>&nbsp;<span class="ident" id="3064051">family</span><span class="op" id="3064057">:</span>&nbsp;<span class="ident" id="3064059">family</span><span class="op" id="3064065">,</span>&nbsp;<span class="ident" id="3064067">sotype</span><span class="op" id="3064073">:</span>&nbsp;<span class="ident" id="3064075">sotype</span><span class="op" id="3064081">,</span>&nbsp;<span class="ident" id="3064083">net</span><span class="op" id="3064086">:</span>&nbsp;<span class="ident" id="3064088">net</span><span class="op" id="3064091">}</span><span class="op" id="3064092">,</span>&nbsp;<span class="ident" id="3064094">nil</span><br>
<span class="lineno">45</span><span class="op" id="3064098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3064101">func</span>&nbsp;<span class="op" id="3064106">(</span><span class="ident" id="3064107">fd</span>&nbsp;<span class="op" id="3064110">*</span><span class="ident" id="3064111">netFD</span><span class="op" id="3064116">)</span>&nbsp;<span class="ident" id="3064118">init</span><span class="op" id="3064122">(</span><span class="op" id="3064123">)</span>&nbsp;<span class="builtintype" id="3064125">error</span>&nbsp;<span class="op" id="3064131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064134">if</span>&nbsp;<span class="ident" id="3064137">err</span>&nbsp;<span class="op" id="3064141">:=</span>&nbsp;<span class="ident" id="3064144">fd</span><span class="op" id="3064146">.</span><span class="ident" id="3064147">pd</span><span class="op" id="3064149">.</span><span class="ident" id="3064150">Init</span><span class="op" id="3064154">(</span><span class="ident" id="3064155">fd</span><span class="op" id="3064157">)</span><span class="op" id="3064158">;</span>&nbsp;<span class="ident" id="3064160">err</span>&nbsp;<span class="op" id="3064164">!=</span>&nbsp;<span class="ident" id="3064167">nil</span>&nbsp;<span class="op" id="3064171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064175">return</span>&nbsp;<span class="ident" id="3064182">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064190">return</span>&nbsp;<span class="ident" id="3064197">nil</span><br>
<span class="lineno"></span><span class="op" id="3064201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3064204">func</span>&nbsp;<span class="op" id="3064209">(</span><span class="ident" id="3064210">fd</span>&nbsp;<span class="op" id="3064213">*</span><span class="ident" id="3064214">netFD</span><span class="op" id="3064219">)</span>&nbsp;<span class="ident" id="3064221">setAddr</span><span class="op" id="3064228">(</span><span class="ident" id="3064229">laddr</span><span class="op" id="3064234">,</span>&nbsp;<span class="ident" id="3064236">raddr</span>&nbsp;<span class="ident" id="3064242">Addr</span><span class="op" id="3064246">)</span>&nbsp;<span class="op" id="3064248">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064251">fd</span><span class="op" id="3064253">.</span><span class="ident" id="3064254">laddr</span>&nbsp;<span class="op" id="3064260">=</span>&nbsp;<span class="ident" id="3064262">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064269">fd</span><span class="op" id="3064271">.</span><span class="ident" id="3064272">raddr</span>&nbsp;<span class="op" id="3064278">=</span>&nbsp;<span class="ident" id="3064280">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064287">runtime</span><span class="op" id="3064294">.</span><span class="ident" id="3064295">SetFinalizer</span><span class="op" id="3064307">(</span><span class="ident" id="3064308">fd</span><span class="op" id="3064310">,</span>&nbsp;<span class="op" id="3064312">(</span><span class="op" id="3064313">*</span><span class="ident" id="3064314">netFD</span><span class="op" id="3064319">)</span><span class="op" id="3064320">.</span><span class="ident" id="3064321">Close</span><span class="op" id="3064326">)</span><br>
<span class="lineno"></span><span class="op" id="3064328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3064331">func</span>&nbsp;<span class="op" id="3064336">(</span><span class="ident" id="3064337">fd</span>&nbsp;<span class="op" id="3064340">*</span><span class="ident" id="3064341">netFD</span><span class="op" id="3064346">)</span>&nbsp;<span class="ident" id="3064348">name</span><span class="op" id="3064352">(</span><span class="op" id="3064353">)</span>&nbsp;<span class="builtintype" id="3064355">string</span>&nbsp;<span class="op" id="3064362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064365">var</span>&nbsp;<span class="ident" id="3064369">ls</span><span class="op" id="3064371">,</span>&nbsp;<span class="ident" id="3064373">rs</span>&nbsp;<span class="builtintype" id="3064376">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064384">if</span>&nbsp;<span class="ident" id="3064387">fd</span><span class="op" id="3064389">.</span><span class="ident" id="3064390">laddr</span>&nbsp;<span class="op" id="3064396">!=</span>&nbsp;<span class="ident" id="3064399">nil</span>&nbsp;<span class="op" id="3064403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064407">ls</span>&nbsp;<span class="op" id="3064410">=</span>&nbsp;<span class="ident" id="3064412">fd</span><span class="op" id="3064414">.</span><span class="ident" id="3064415">laddr</span><span class="op" id="3064420">.</span><span class="ident" id="3064421">String</span><span class="op" id="3064427">(</span><span class="op" id="3064428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064431">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064434">if</span>&nbsp;<span class="ident" id="3064437">fd</span><span class="op" id="3064439">.</span><span class="ident" id="3064440">raddr</span>&nbsp;<span class="op" id="3064446">!=</span>&nbsp;<span class="ident" id="3064449">nil</span>&nbsp;<span class="op" id="3064453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064457">rs</span>&nbsp;<span class="op" id="3064460">=</span>&nbsp;<span class="ident" id="3064462">fd</span><span class="op" id="3064464">.</span><span class="ident" id="3064465">raddr</span><span class="op" id="3064470">.</span><span class="ident" id="3064471">String</span><span class="op" id="3064477">(</span><span class="op" id="3064478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064484">return</span>&nbsp;<span class="ident" id="3064491">fd</span><span class="op" id="3064493">.</span><span class="ident" id="3064494">net</span>&nbsp;<span class="op" id="3064498">+</span>&nbsp;<span class="string" id="3064500">&#34;:&#34;</span>&nbsp;<span class="op" id="3064504">+</span>&nbsp;<span class="ident" id="3064506">ls</span>&nbsp;<span class="op" id="3064509">+</span>&nbsp;<span class="string" id="3064511">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3064516">+</span>&nbsp;<span class="ident" id="3064518">rs</span><br>
<span class="lineno"></span><span class="op" id="3064521">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3064524">func</span>&nbsp;<span class="op" id="3064529">(</span><span class="ident" id="3064530">fd</span>&nbsp;<span class="op" id="3064533">*</span><span class="ident" id="3064534">netFD</span><span class="op" id="3064539">)</span>&nbsp;<span class="ident" id="3064541">connect</span><span class="op" id="3064548">(</span><span class="ident" id="3064549">la</span><span class="op" id="3064551">,</span>&nbsp;<span class="ident" id="3064553">ra</span>&nbsp;<span class="ident" id="3064556">syscall</span><span class="op" id="3064563">.</span><span class="ident" id="3064564">Sockaddr</span><span class="op" id="3064572">,</span>&nbsp;<span class="ident" id="3064574">deadline</span>&nbsp;<span class="ident" id="3064583">time</span><span class="op" id="3064587">.</span><span class="ident" id="3064588">Time</span><span class="op" id="3064592">)</span>&nbsp;<span class="builtintype" id="3064594">error</span>&nbsp;<span class="op" id="3064600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3064603">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3064646">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3064692">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064738">switch</span>&nbsp;<span class="ident" id="3064745">err</span>&nbsp;<span class="op" id="3064749">:=</span>&nbsp;<span class="ident" id="3064752">syscall</span><span class="op" id="3064759">.</span><span class="ident" id="3064760">Connect</span><span class="op" id="3064767">(</span><span class="ident" id="3064768">fd</span><span class="op" id="3064770">.</span><span class="ident" id="3064771">sysfd</span><span class="op" id="3064776">,</span>&nbsp;<span class="ident" id="3064778">ra</span><span class="op" id="3064780">)</span><span class="op" id="3064781">;</span>&nbsp;<span class="ident" id="3064783">err</span>&nbsp;<span class="op" id="3064787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064790">case</span>&nbsp;<span class="ident" id="3064795">syscall</span><span class="op" id="3064802">.</span><span class="ident" id="3064803">EINPROGRESS</span><span class="op" id="3064814">,</span>&nbsp;<span class="ident" id="3064816">syscall</span><span class="op" id="3064823">.</span><span class="ident" id="3064824">EALREADY</span><span class="op" id="3064832">,</span>&nbsp;<span class="ident" id="3064834">syscall</span><span class="op" id="3064841">.</span><span class="ident" id="3064842">EINTR</span><span class="op" id="3064847">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064850">case</span>&nbsp;<span class="ident" id="3064855">nil</span><span class="op" id="3064858">,</span>&nbsp;<span class="ident" id="3064860">syscall</span><span class="op" id="3064867">.</span><span class="ident" id="3064868">EISCONN</span><span class="op" id="3064875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064879">if</span>&nbsp;<span class="op" id="3064882">!</span><span class="ident" id="3064883">deadline</span><span class="op" id="3064891">.</span><span class="ident" id="3064892">IsZero</span><span class="op" id="3064898">(</span><span class="op" id="3064899">)</span>&nbsp;<span class="op" id="3064901">&amp;&amp;</span>&nbsp;<span class="ident" id="3064904">deadline</span><span class="op" id="3064912">.</span><span class="ident" id="3064913">Before</span><span class="op" id="3064919">(</span><span class="ident" id="3064920">time</span><span class="op" id="3064924">.</span><span class="ident" id="3064925">Now</span><span class="op" id="3064928">(</span><span class="op" id="3064929">)</span><span class="op" id="3064930">)</span>&nbsp;<span class="op" id="3064932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064937">return</span>&nbsp;<span class="ident" id="3064944">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064961">if</span>&nbsp;<span class="ident" id="3064964">err</span>&nbsp;<span class="op" id="3064968">:=</span>&nbsp;<span class="ident" id="3064971">fd</span><span class="op" id="3064973">.</span><span class="ident" id="3064974">init</span><span class="op" id="3064978">(</span><span class="op" id="3064979">)</span><span class="op" id="3064980">;</span>&nbsp;<span class="ident" id="3064982">err</span>&nbsp;<span class="op" id="3064986">!=</span>&nbsp;<span class="ident" id="3064989">nil</span>&nbsp;<span class="op" id="3064993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064998">return</span>&nbsp;<span class="ident" id="3065005">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065015">return</span>&nbsp;<span class="ident" id="3065022">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065027">case</span>&nbsp;<span class="ident" id="3065032">syscall</span><span class="op" id="3065039">.</span><span class="ident" id="3065040">EINVAL</span><span class="op" id="3065046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065050">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065102">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065155">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065209">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065263">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065312">if</span>&nbsp;<span class="ident" id="3065315">runtime</span><span class="op" id="3065322">.</span><span class="ident" id="3065323">GOOS</span>&nbsp;<span class="op" id="3065328">==</span>&nbsp;<span class="string" id="3065331">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3065341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065346">return</span>&nbsp;<span class="ident" id="3065353">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065363">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065376">default</span><span class="op" id="3065383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065387">return</span>&nbsp;<span class="ident" id="3065394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065402">if</span>&nbsp;<span class="ident" id="3065405">err</span>&nbsp;<span class="op" id="3065409">:=</span>&nbsp;<span class="ident" id="3065412">fd</span><span class="op" id="3065414">.</span><span class="ident" id="3065415">init</span><span class="op" id="3065419">(</span><span class="op" id="3065420">)</span><span class="op" id="3065421">;</span>&nbsp;<span class="ident" id="3065423">err</span>&nbsp;<span class="op" id="3065427">!=</span>&nbsp;<span class="ident" id="3065430">nil</span>&nbsp;<span class="op" id="3065434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065438">return</span>&nbsp;<span class="ident" id="3065445">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065453">if</span>&nbsp;<span class="op" id="3065456">!</span><span class="ident" id="3065457">deadline</span><span class="op" id="3065465">.</span><span class="ident" id="3065466">IsZero</span><span class="op" id="3065472">(</span><span class="op" id="3065473">)</span>&nbsp;<span class="op" id="3065475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065479">fd</span><span class="op" id="3065481">.</span><span class="ident" id="3065482">setWriteDeadline</span><span class="op" id="3065498">(</span><span class="ident" id="3065499">deadline</span><span class="op" id="3065507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065511">defer</span>&nbsp;<span class="ident" id="3065517">fd</span><span class="op" id="3065519">.</span><span class="ident" id="3065520">setWriteDeadline</span><span class="op" id="3065536">(</span><span class="ident" id="3065537">noDeadline</span><span class="op" id="3065547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065550">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065553">for</span>&nbsp;<span class="op" id="3065557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065561">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065612">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065666">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065714">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065770">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065825">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065878">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3065931">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065945">if</span>&nbsp;<span class="ident" id="3065948">err</span>&nbsp;<span class="op" id="3065952">:=</span>&nbsp;<span class="ident" id="3065955">fd</span><span class="op" id="3065957">.</span><span class="ident" id="3065958">pd</span><span class="op" id="3065960">.</span><span class="ident" id="3065961">WaitWrite</span><span class="op" id="3065970">(</span><span class="op" id="3065971">)</span><span class="op" id="3065972">;</span>&nbsp;<span class="ident" id="3065974">err</span>&nbsp;<span class="op" id="3065978">!=</span>&nbsp;<span class="ident" id="3065981">nil</span>&nbsp;<span class="op" id="3065985">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065990">return</span>&nbsp;<span class="ident" id="3065997">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066007">nerr</span><span class="op" id="3066011">,</span>&nbsp;<span class="ident" id="3066013">err</span>&nbsp;<span class="op" id="3066017">:=</span>&nbsp;<span class="ident" id="3066020">syscall</span><span class="op" id="3066027">.</span><span class="ident" id="3066028">GetsockoptInt</span><span class="op" id="3066041">(</span><span class="ident" id="3066042">fd</span><span class="op" id="3066044">.</span><span class="ident" id="3066045">sysfd</span><span class="op" id="3066050">,</span>&nbsp;<span class="ident" id="3066052">syscall</span><span class="op" id="3066059">.</span><span class="ident" id="3066060">SOL_SOCKET</span><span class="op" id="3066070">,</span>&nbsp;<span class="ident" id="3066072">syscall</span><span class="op" id="3066079">.</span><span class="ident" id="3066080">SO_ERROR</span><span class="op" id="3066088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066092">if</span>&nbsp;<span class="ident" id="3066095">err</span>&nbsp;<span class="op" id="3066099">!=</span>&nbsp;<span class="ident" id="3066102">nil</span>&nbsp;<span class="op" id="3066106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066111">return</span>&nbsp;<span class="ident" id="3066118">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066128">switch</span>&nbsp;<span class="ident" id="3066135">err</span>&nbsp;<span class="op" id="3066139">:=</span>&nbsp;<span class="ident" id="3066142">syscall</span><span class="op" id="3066149">.</span><span class="ident" id="3066150">Errno</span><span class="op" id="3066155">(</span><span class="ident" id="3066156">nerr</span><span class="op" id="3066160">)</span><span class="op" id="3066161">;</span>&nbsp;<span class="ident" id="3066163">err</span>&nbsp;<span class="op" id="3066167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066171">case</span>&nbsp;<span class="ident" id="3066176">syscall</span><span class="op" id="3066183">.</span><span class="ident" id="3066184">EINPROGRESS</span><span class="op" id="3066195">,</span>&nbsp;<span class="ident" id="3066197">syscall</span><span class="op" id="3066204">.</span><span class="ident" id="3066205">EALREADY</span><span class="op" id="3066213">,</span>&nbsp;<span class="ident" id="3066215">syscall</span><span class="op" id="3066222">.</span><span class="ident" id="3066223">EINTR</span><span class="op" id="3066228">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066232">case</span>&nbsp;<span class="ident" id="3066237">syscall</span><span class="op" id="3066244">.</span><span class="ident" id="3066245">Errno</span><span class="op" id="3066250">(</span><span class="num" id="3066251">0</span><span class="op" id="3066252">)</span><span class="op" id="3066253">,</span>&nbsp;<span class="ident" id="3066255">syscall</span><span class="op" id="3066262">.</span><span class="ident" id="3066263">EISCONN</span><span class="op" id="3066270">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066275">return</span>&nbsp;<span class="ident" id="3066282">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066288">default</span><span class="op" id="3066295">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066300">return</span>&nbsp;<span class="ident" id="3066307">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066316">}</span><br>
<span class="lineno"></span><span class="op" id="3066318">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3066321">func</span>&nbsp;<span class="op" id="3066326">(</span><span class="ident" id="3066327">fd</span>&nbsp;<span class="op" id="3066330">*</span><span class="ident" id="3066331">netFD</span><span class="op" id="3066336">)</span>&nbsp;<span class="ident" id="3066338">destroy</span><span class="op" id="3066345">(</span><span class="op" id="3066346">)</span>&nbsp;<span class="op" id="3066348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3066351">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3066425">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066474">fd</span><span class="op" id="3066476">.</span><span class="ident" id="3066477">pd</span><span class="op" id="3066479">.</span><span class="ident" id="3066480">Close</span><span class="op" id="3066485">(</span><span class="op" id="3066486">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066489">closesocket</span><span class="op" id="3066500">(</span><span class="ident" id="3066501">fd</span><span class="op" id="3066503">.</span><span class="ident" id="3066504">sysfd</span><span class="op" id="3066509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066512">fd</span><span class="op" id="3066514">.</span><span class="ident" id="3066515">sysfd</span>&nbsp;<span class="op" id="3066521">=</span>&nbsp;<span class="op" id="3066523">-</span><span class="num" id="3066524">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066527">runtime</span><span class="op" id="3066534">.</span><span class="ident" id="3066535">SetFinalizer</span><span class="op" id="3066547">(</span><span class="ident" id="3066548">fd</span><span class="op" id="3066550">,</span>&nbsp;<span class="ident" id="3066552">nil</span><span class="op" id="3066555">)</span><br>
<span class="lineno"></span><span class="op" id="3066557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3066560">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3066591">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3066637">func</span>&nbsp;<span class="op" id="3066642">(</span><span class="ident" id="3066643">fd</span>&nbsp;<span class="op" id="3066646">*</span><span class="ident" id="3066647">netFD</span><span class="op" id="3066652">)</span>&nbsp;<span class="ident" id="3066654">incref</span><span class="op" id="3066660">(</span><span class="op" id="3066661">)</span>&nbsp;<span class="builtintype" id="3066663">error</span>&nbsp;<span class="op" id="3066669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066672">if</span>&nbsp;<span class="op" id="3066675">!</span><span class="ident" id="3066676">fd</span><span class="op" id="3066678">.</span><span class="ident" id="3066679">fdmu</span><span class="op" id="3066683">.</span><span class="ident" id="3066684">Incref</span><span class="op" id="3066690">(</span><span class="op" id="3066691">)</span>&nbsp;<span class="op" id="3066693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066697">return</span>&nbsp;<span class="ident" id="3066704">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066719">return</span>&nbsp;<span class="ident" id="3066726">nil</span><br>
<span class="lineno"></span><span class="op" id="3066730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3066733">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3066805">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3066844">func</span>&nbsp;<span class="op" id="3066849">(</span><span class="ident" id="3066850">fd</span>&nbsp;<span class="op" id="3066853">*</span><span class="ident" id="3066854">netFD</span><span class="op" id="3066859">)</span>&nbsp;<span class="ident" id="3066861">decref</span><span class="op" id="3066867">(</span><span class="op" id="3066868">)</span>&nbsp;<span class="op" id="3066870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066873">if</span>&nbsp;<span class="ident" id="3066876">fd</span><span class="op" id="3066878">.</span><span class="ident" id="3066879">fdmu</span><span class="op" id="3066883">.</span><span class="ident" id="3066884">Decref</span><span class="op" id="3066890">(</span><span class="op" id="3066891">)</span>&nbsp;<span class="op" id="3066893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066897">fd</span><span class="op" id="3066899">.</span><span class="ident" id="3066900">destroy</span><span class="op" id="3066907">(</span><span class="op" id="3066908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066911">}</span><br>
<span class="lineno">155</span><span class="op" id="3066913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3066916">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3066968">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3067014">func</span>&nbsp;<span class="op" id="3067019">(</span><span class="ident" id="3067020">fd</span>&nbsp;<span class="op" id="3067023">*</span><span class="ident" id="3067024">netFD</span><span class="op" id="3067029">)</span>&nbsp;<span class="ident" id="3067031">readLock</span><span class="op" id="3067039">(</span><span class="op" id="3067040">)</span>&nbsp;<span class="builtintype" id="3067042">error</span>&nbsp;<span class="op" id="3067048">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067051">if</span>&nbsp;<span class="op" id="3067054">!</span><span class="ident" id="3067055">fd</span><span class="op" id="3067057">.</span><span class="ident" id="3067058">fdmu</span><span class="op" id="3067062">.</span><span class="ident" id="3067063">RWLock</span><span class="op" id="3067069">(</span><span class="builtintype" id="3067070">true</span><span class="op" id="3067074">)</span>&nbsp;<span class="op" id="3067076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067080">return</span>&nbsp;<span class="ident" id="3067087">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3067099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067102">return</span>&nbsp;<span class="ident" id="3067109">nil</span><br>
<span class="lineno"></span><span class="op" id="3067113">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3067116">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3067173">func</span>&nbsp;<span class="op" id="3067178">(</span><span class="ident" id="3067179">fd</span>&nbsp;<span class="op" id="3067182">*</span><span class="ident" id="3067183">netFD</span><span class="op" id="3067188">)</span>&nbsp;<span class="ident" id="3067190">readUnlock</span><span class="op" id="3067200">(</span><span class="op" id="3067201">)</span>&nbsp;<span class="op" id="3067203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067206">if</span>&nbsp;<span class="ident" id="3067209">fd</span><span class="op" id="3067211">.</span><span class="ident" id="3067212">fdmu</span><span class="op" id="3067216">.</span><span class="ident" id="3067217">RWUnlock</span><span class="op" id="3067225">(</span><span class="builtintype" id="3067226">true</span><span class="op" id="3067230">)</span>&nbsp;<span class="op" id="3067232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3067236">fd</span><span class="op" id="3067238">.</span><span class="ident" id="3067239">destroy</span><span class="op" id="3067246">(</span><span class="op" id="3067247">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3067250">}</span><br>
<span class="lineno"></span><span class="op" id="3067252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3067255">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3067307">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3067353">func</span>&nbsp;<span class="op" id="3067358">(</span><span class="ident" id="3067359">fd</span>&nbsp;<span class="op" id="3067362">*</span><span class="ident" id="3067363">netFD</span><span class="op" id="3067368">)</span>&nbsp;<span class="ident" id="3067370">writeLock</span><span class="op" id="3067379">(</span><span class="op" id="3067380">)</span>&nbsp;<span class="builtintype" id="3067382">error</span>&nbsp;<span class="op" id="3067388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067391">if</span>&nbsp;<span class="op" id="3067394">!</span><span class="ident" id="3067395">fd</span><span class="op" id="3067397">.</span><span class="ident" id="3067398">fdmu</span><span class="op" id="3067402">.</span><span class="ident" id="3067403">RWLock</span><span class="op" id="3067409">(</span><span class="builtintype" id="3067410">false</span><span class="op" id="3067415">)</span>&nbsp;<span class="op" id="3067417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067421">return</span>&nbsp;<span class="ident" id="3067428">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3067440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067443">return</span>&nbsp;<span class="ident" id="3067450">nil</span><br>
<span class="lineno">180</span><span class="op" id="3067454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3067457">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3067514">func</span>&nbsp;<span class="op" id="3067519">(</span><span class="ident" id="3067520">fd</span>&nbsp;<span class="op" id="3067523">*</span><span class="ident" id="3067524">netFD</span><span class="op" id="3067529">)</span>&nbsp;<span class="ident" id="3067531">writeUnlock</span><span class="op" id="3067542">(</span><span class="op" id="3067543">)</span>&nbsp;<span class="op" id="3067545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067548">if</span>&nbsp;<span class="ident" id="3067551">fd</span><span class="op" id="3067553">.</span><span class="ident" id="3067554">fdmu</span><span class="op" id="3067558">.</span><span class="ident" id="3067559">RWUnlock</span><span class="op" id="3067567">(</span><span class="builtintype" id="3067568">false</span><span class="op" id="3067573">)</span>&nbsp;<span class="op" id="3067575">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3067579">fd</span><span class="op" id="3067581">.</span><span class="ident" id="3067582">destroy</span><span class="op" id="3067589">(</span><span class="op" id="3067590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3067593">}</span><br>
<span class="lineno"></span><span class="op" id="3067595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3067598">func</span>&nbsp;<span class="op" id="3067603">(</span><span class="ident" id="3067604">fd</span>&nbsp;<span class="op" id="3067607">*</span><span class="ident" id="3067608">netFD</span><span class="op" id="3067613">)</span>&nbsp;<span class="ident" id="3067615">Close</span><span class="op" id="3067620">(</span><span class="op" id="3067621">)</span>&nbsp;<span class="builtintype" id="3067623">error</span>&nbsp;<span class="op" id="3067629">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3067632">fd</span><span class="op" id="3067634">.</span><span class="ident" id="3067635">pd</span><span class="op" id="3067637">.</span><span class="ident" id="3067638">Lock</span><span class="op" id="3067642">(</span><span class="op" id="3067643">)</span>&nbsp;<span class="comment" id="3067645">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067700">if</span>&nbsp;<span class="op" id="3067703">!</span><span class="ident" id="3067704">fd</span><span class="op" id="3067706">.</span><span class="ident" id="3067707">fdmu</span><span class="op" id="3067711">.</span><span class="ident" id="3067712">IncrefAndClose</span><span class="op" id="3067726">(</span><span class="op" id="3067727">)</span>&nbsp;<span class="op" id="3067729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3067733">fd</span><span class="op" id="3067735">.</span><span class="ident" id="3067736">pd</span><span class="op" id="3067738">.</span><span class="ident" id="3067739">Unlock</span><span class="op" id="3067745">(</span><span class="op" id="3067746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067750">return</span>&nbsp;<span class="ident" id="3067757">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3067769">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3067772">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3067828">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3067884">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3067946">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3068009">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068071">doWakeup</span>&nbsp;<span class="op" id="3068080">:=</span>&nbsp;<span class="ident" id="3068083">fd</span><span class="op" id="3068085">.</span><span class="ident" id="3068086">pd</span><span class="op" id="3068088">.</span><span class="ident" id="3068089">Evict</span><span class="op" id="3068094">(</span><span class="op" id="3068095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068098">fd</span><span class="op" id="3068100">.</span><span class="ident" id="3068101">pd</span><span class="op" id="3068103">.</span><span class="ident" id="3068104">Unlock</span><span class="op" id="3068110">(</span><span class="op" id="3068111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068114">fd</span><span class="op" id="3068116">.</span><span class="ident" id="3068117">decref</span><span class="op" id="3068123">(</span><span class="op" id="3068124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068127">if</span>&nbsp;<span class="ident" id="3068130">doWakeup</span>&nbsp;<span class="op" id="3068139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068143">fd</span><span class="op" id="3068145">.</span><span class="ident" id="3068146">pd</span><span class="op" id="3068148">.</span><span class="ident" id="3068149">Wakeup</span><span class="op" id="3068155">(</span><span class="op" id="3068156">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068162">return</span>&nbsp;<span class="ident" id="3068169">nil</span><br>
<span class="lineno"></span><span class="op" id="3068173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3068176">func</span>&nbsp;<span class="op" id="3068181">(</span><span class="ident" id="3068182">fd</span>&nbsp;<span class="op" id="3068185">*</span><span class="ident" id="3068186">netFD</span><span class="op" id="3068191">)</span>&nbsp;<span class="ident" id="3068193">shutdown</span><span class="op" id="3068201">(</span><span class="ident" id="3068202">how</span>&nbsp;<span class="builtintype" id="3068206">int</span><span class="op" id="3068209">)</span>&nbsp;<span class="builtintype" id="3068211">error</span>&nbsp;<span class="op" id="3068217">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068220">if</span>&nbsp;<span class="ident" id="3068223">err</span>&nbsp;<span class="op" id="3068227">:=</span>&nbsp;<span class="ident" id="3068230">fd</span><span class="op" id="3068232">.</span><span class="ident" id="3068233">incref</span><span class="op" id="3068239">(</span><span class="op" id="3068240">)</span><span class="op" id="3068241">;</span>&nbsp;<span class="ident" id="3068243">err</span>&nbsp;<span class="op" id="3068247">!=</span>&nbsp;<span class="ident" id="3068250">nil</span>&nbsp;<span class="op" id="3068254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068258">return</span>&nbsp;<span class="ident" id="3068265">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068273">defer</span>&nbsp;<span class="ident" id="3068279">fd</span><span class="op" id="3068281">.</span><span class="ident" id="3068282">decref</span><span class="op" id="3068288">(</span><span class="op" id="3068289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068292">err</span>&nbsp;<span class="op" id="3068296">:=</span>&nbsp;<span class="ident" id="3068299">syscall</span><span class="op" id="3068306">.</span><span class="ident" id="3068307">Shutdown</span><span class="op" id="3068315">(</span><span class="ident" id="3068316">fd</span><span class="op" id="3068318">.</span><span class="ident" id="3068319">sysfd</span><span class="op" id="3068324">,</span>&nbsp;<span class="ident" id="3068326">how</span><span class="op" id="3068329">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068332">if</span>&nbsp;<span class="ident" id="3068335">err</span>&nbsp;<span class="op" id="3068339">!=</span>&nbsp;<span class="ident" id="3068342">nil</span>&nbsp;<span class="op" id="3068346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068350">return</span>&nbsp;<span class="op" id="3068357">&amp;</span><span class="ident" id="3068358">OpError</span><span class="op" id="3068365">{</span><span class="string" id="3068366">&#34;shutdown&#34;</span><span class="op" id="3068376">,</span>&nbsp;<span class="ident" id="3068378">fd</span><span class="op" id="3068380">.</span><span class="ident" id="3068381">net</span><span class="op" id="3068384">,</span>&nbsp;<span class="ident" id="3068386">fd</span><span class="op" id="3068388">.</span><span class="ident" id="3068389">laddr</span><span class="op" id="3068394">,</span>&nbsp;<span class="ident" id="3068396">err</span><span class="op" id="3068399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068405">return</span>&nbsp;<span class="ident" id="3068412">nil</span><br>
<span class="lineno"></span><span class="op" id="3068416">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3068419">func</span>&nbsp;<span class="op" id="3068424">(</span><span class="ident" id="3068425">fd</span>&nbsp;<span class="op" id="3068428">*</span><span class="ident" id="3068429">netFD</span><span class="op" id="3068434">)</span>&nbsp;<span class="ident" id="3068436">closeRead</span><span class="op" id="3068445">(</span><span class="op" id="3068446">)</span>&nbsp;<span class="builtintype" id="3068448">error</span>&nbsp;<span class="op" id="3068454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068457">return</span>&nbsp;<span class="ident" id="3068464">fd</span><span class="op" id="3068466">.</span><span class="ident" id="3068467">shutdown</span><span class="op" id="3068475">(</span><span class="ident" id="3068476">syscall</span><span class="op" id="3068483">.</span><span class="ident" id="3068484">SHUT_RD</span><span class="op" id="3068491">)</span><br>
<span class="lineno"></span><span class="op" id="3068493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3068496">func</span>&nbsp;<span class="op" id="3068501">(</span><span class="ident" id="3068502">fd</span>&nbsp;<span class="op" id="3068505">*</span><span class="ident" id="3068506">netFD</span><span class="op" id="3068511">)</span>&nbsp;<span class="ident" id="3068513">closeWrite</span><span class="op" id="3068523">(</span><span class="op" id="3068524">)</span>&nbsp;<span class="builtintype" id="3068526">error</span>&nbsp;<span class="op" id="3068532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068535">return</span>&nbsp;<span class="ident" id="3068542">fd</span><span class="op" id="3068544">.</span><span class="ident" id="3068545">shutdown</span><span class="op" id="3068553">(</span><span class="ident" id="3068554">syscall</span><span class="op" id="3068561">.</span><span class="ident" id="3068562">SHUT_WR</span><span class="op" id="3068569">)</span><br>
<span class="lineno"></span><span class="op" id="3068571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3068574">func</span>&nbsp;<span class="op" id="3068579">(</span><span class="ident" id="3068580">fd</span>&nbsp;<span class="op" id="3068583">*</span><span class="ident" id="3068584">netFD</span><span class="op" id="3068589">)</span>&nbsp;<span class="ident" id="3068591">Read</span><span class="op" id="3068595">(</span><span class="ident" id="3068596">p</span>&nbsp;<span class="op" id="3068598">[</span><span class="op" id="3068599">]</span><span class="builtintype" id="3068600">byte</span><span class="op" id="3068604">)</span>&nbsp;<span class="op" id="3068606">(</span><span class="ident" id="3068607">n</span>&nbsp;<span class="builtintype" id="3068609">int</span><span class="op" id="3068612">,</span>&nbsp;<span class="ident" id="3068614">err</span>&nbsp;<span class="builtintype" id="3068618">error</span><span class="op" id="3068623">)</span>&nbsp;<span class="op" id="3068625">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068628">if</span>&nbsp;<span class="ident" id="3068631">err</span>&nbsp;<span class="op" id="3068635">:=</span>&nbsp;<span class="ident" id="3068638">fd</span><span class="op" id="3068640">.</span><span class="ident" id="3068641">readLock</span><span class="op" id="3068649">(</span><span class="op" id="3068650">)</span><span class="op" id="3068651">;</span>&nbsp;<span class="ident" id="3068653">err</span>&nbsp;<span class="op" id="3068657">!=</span>&nbsp;<span class="ident" id="3068660">nil</span>&nbsp;<span class="op" id="3068664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068668">return</span>&nbsp;<span class="num" id="3068675">0</span><span class="op" id="3068676">,</span>&nbsp;<span class="ident" id="3068678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068686">defer</span>&nbsp;<span class="ident" id="3068692">fd</span><span class="op" id="3068694">.</span><span class="ident" id="3068695">readUnlock</span><span class="op" id="3068705">(</span><span class="op" id="3068706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068709">if</span>&nbsp;<span class="ident" id="3068712">err</span>&nbsp;<span class="op" id="3068716">:=</span>&nbsp;<span class="ident" id="3068719">fd</span><span class="op" id="3068721">.</span><span class="ident" id="3068722">pd</span><span class="op" id="3068724">.</span><span class="ident" id="3068725">PrepareRead</span><span class="op" id="3068736">(</span><span class="op" id="3068737">)</span><span class="op" id="3068738">;</span>&nbsp;<span class="ident" id="3068740">err</span>&nbsp;<span class="op" id="3068744">!=</span>&nbsp;<span class="ident" id="3068747">nil</span>&nbsp;<span class="op" id="3068751">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068755">return</span>&nbsp;<span class="num" id="3068762">0</span><span class="op" id="3068763">,</span>&nbsp;<span class="op" id="3068765">&amp;</span><span class="ident" id="3068766">OpError</span><span class="op" id="3068773">{</span><span class="string" id="3068774">&#34;read&#34;</span><span class="op" id="3068780">,</span>&nbsp;<span class="ident" id="3068782">fd</span><span class="op" id="3068784">.</span><span class="ident" id="3068785">net</span><span class="op" id="3068788">,</span>&nbsp;<span class="ident" id="3068790">fd</span><span class="op" id="3068792">.</span><span class="ident" id="3068793">raddr</span><span class="op" id="3068798">,</span>&nbsp;<span class="ident" id="3068800">err</span><span class="op" id="3068803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068809">for</span>&nbsp;<span class="op" id="3068813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068817">n</span><span class="op" id="3068818">,</span>&nbsp;<span class="ident" id="3068820">err</span>&nbsp;<span class="op" id="3068824">=</span>&nbsp;<span class="ident" id="3068826">syscall</span><span class="op" id="3068833">.</span><span class="ident" id="3068834">Read</span><span class="op" id="3068838">(</span><span class="builtintype" id="3068839">int</span><span class="op" id="3068842">(</span><span class="ident" id="3068843">fd</span><span class="op" id="3068845">.</span><span class="ident" id="3068846">sysfd</span><span class="op" id="3068851">)</span><span class="op" id="3068852">,</span>&nbsp;<span class="ident" id="3068854">p</span><span class="op" id="3068855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068859">if</span>&nbsp;<span class="ident" id="3068862">err</span>&nbsp;<span class="op" id="3068866">!=</span>&nbsp;<span class="ident" id="3068869">nil</span>&nbsp;<span class="op" id="3068873">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068878">n</span>&nbsp;<span class="op" id="3068880">=</span>&nbsp;<span class="num" id="3068882">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068887">if</span>&nbsp;<span class="ident" id="3068890">err</span>&nbsp;<span class="op" id="3068894">==</span>&nbsp;<span class="ident" id="3068897">syscall</span><span class="op" id="3068904">.</span><span class="ident" id="3068905">EAGAIN</span>&nbsp;<span class="op" id="3068912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068918">if</span>&nbsp;<span class="ident" id="3068921">err</span>&nbsp;<span class="op" id="3068925">=</span>&nbsp;<span class="ident" id="3068927">fd</span><span class="op" id="3068929">.</span><span class="ident" id="3068930">pd</span><span class="op" id="3068932">.</span><span class="ident" id="3068933">WaitRead</span><span class="op" id="3068941">(</span><span class="op" id="3068942">)</span><span class="op" id="3068943">;</span>&nbsp;<span class="ident" id="3068945">err</span>&nbsp;<span class="op" id="3068949">==</span>&nbsp;<span class="ident" id="3068952">nil</span>&nbsp;<span class="op" id="3068956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068963">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068976">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068989">err</span>&nbsp;<span class="op" id="3068993">=</span>&nbsp;<span class="ident" id="3068995">chkReadErr</span><span class="op" id="3069005">(</span><span class="ident" id="3069006">n</span><span class="op" id="3069007">,</span>&nbsp;<span class="ident" id="3069009">err</span><span class="op" id="3069012">,</span>&nbsp;<span class="ident" id="3069014">fd</span><span class="op" id="3069016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069020">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069027">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069030">if</span>&nbsp;<span class="ident" id="3069033">err</span>&nbsp;<span class="op" id="3069037">!=</span>&nbsp;<span class="ident" id="3069040">nil</span>&nbsp;<span class="op" id="3069044">&amp;&amp;</span>&nbsp;<span class="ident" id="3069047">err</span>&nbsp;<span class="op" id="3069051">!=</span>&nbsp;<span class="ident" id="3069054">io</span><span class="op" id="3069056">.</span><span class="ident" id="3069057">EOF</span>&nbsp;<span class="op" id="3069061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069065">err</span>&nbsp;<span class="op" id="3069069">=</span>&nbsp;<span class="op" id="3069071">&amp;</span><span class="ident" id="3069072">OpError</span><span class="op" id="3069079">{</span><span class="string" id="3069080">&#34;read&#34;</span><span class="op" id="3069086">,</span>&nbsp;<span class="ident" id="3069088">fd</span><span class="op" id="3069090">.</span><span class="ident" id="3069091">net</span><span class="op" id="3069094">,</span>&nbsp;<span class="ident" id="3069096">fd</span><span class="op" id="3069098">.</span><span class="ident" id="3069099">raddr</span><span class="op" id="3069104">,</span>&nbsp;<span class="ident" id="3069106">err</span><span class="op" id="3069109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069115">return</span><br>
<span class="lineno"></span><span class="op" id="3069122">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3069125">func</span>&nbsp;<span class="op" id="3069130">(</span><span class="ident" id="3069131">fd</span>&nbsp;<span class="op" id="3069134">*</span><span class="ident" id="3069135">netFD</span><span class="op" id="3069140">)</span>&nbsp;<span class="ident" id="3069142">readFrom</span><span class="op" id="3069150">(</span><span class="ident" id="3069151">p</span>&nbsp;<span class="op" id="3069153">[</span><span class="op" id="3069154">]</span><span class="builtintype" id="3069155">byte</span><span class="op" id="3069159">)</span>&nbsp;<span class="op" id="3069161">(</span><span class="ident" id="3069162">n</span>&nbsp;<span class="builtintype" id="3069164">int</span><span class="op" id="3069167">,</span>&nbsp;<span class="ident" id="3069169">sa</span>&nbsp;<span class="ident" id="3069172">syscall</span><span class="op" id="3069179">.</span><span class="ident" id="3069180">Sockaddr</span><span class="op" id="3069188">,</span>&nbsp;<span class="ident" id="3069190">err</span>&nbsp;<span class="builtintype" id="3069194">error</span><span class="op" id="3069199">)</span>&nbsp;<span class="op" id="3069201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069204">if</span>&nbsp;<span class="ident" id="3069207">err</span>&nbsp;<span class="op" id="3069211">:=</span>&nbsp;<span class="ident" id="3069214">fd</span><span class="op" id="3069216">.</span><span class="ident" id="3069217">readLock</span><span class="op" id="3069225">(</span><span class="op" id="3069226">)</span><span class="op" id="3069227">;</span>&nbsp;<span class="ident" id="3069229">err</span>&nbsp;<span class="op" id="3069233">!=</span>&nbsp;<span class="ident" id="3069236">nil</span>&nbsp;<span class="op" id="3069240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069244">return</span>&nbsp;<span class="num" id="3069251">0</span><span class="op" id="3069252">,</span>&nbsp;<span class="ident" id="3069254">nil</span><span class="op" id="3069257">,</span>&nbsp;<span class="ident" id="3069259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069264">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069267">defer</span>&nbsp;<span class="ident" id="3069273">fd</span><span class="op" id="3069275">.</span><span class="ident" id="3069276">readUnlock</span><span class="op" id="3069286">(</span><span class="op" id="3069287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069290">if</span>&nbsp;<span class="ident" id="3069293">err</span>&nbsp;<span class="op" id="3069297">:=</span>&nbsp;<span class="ident" id="3069300">fd</span><span class="op" id="3069302">.</span><span class="ident" id="3069303">pd</span><span class="op" id="3069305">.</span><span class="ident" id="3069306">PrepareRead</span><span class="op" id="3069317">(</span><span class="op" id="3069318">)</span><span class="op" id="3069319">;</span>&nbsp;<span class="ident" id="3069321">err</span>&nbsp;<span class="op" id="3069325">!=</span>&nbsp;<span class="ident" id="3069328">nil</span>&nbsp;<span class="op" id="3069332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069336">return</span>&nbsp;<span class="num" id="3069343">0</span><span class="op" id="3069344">,</span>&nbsp;<span class="ident" id="3069346">nil</span><span class="op" id="3069349">,</span>&nbsp;<span class="op" id="3069351">&amp;</span><span class="ident" id="3069352">OpError</span><span class="op" id="3069359">{</span><span class="string" id="3069360">&#34;read&#34;</span><span class="op" id="3069366">,</span>&nbsp;<span class="ident" id="3069368">fd</span><span class="op" id="3069370">.</span><span class="ident" id="3069371">net</span><span class="op" id="3069374">,</span>&nbsp;<span class="ident" id="3069376">fd</span><span class="op" id="3069378">.</span><span class="ident" id="3069379">laddr</span><span class="op" id="3069384">,</span>&nbsp;<span class="ident" id="3069386">err</span><span class="op" id="3069389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069395">for</span>&nbsp;<span class="op" id="3069399">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069403">n</span><span class="op" id="3069404">,</span>&nbsp;<span class="ident" id="3069406">sa</span><span class="op" id="3069408">,</span>&nbsp;<span class="ident" id="3069410">err</span>&nbsp;<span class="op" id="3069414">=</span>&nbsp;<span class="ident" id="3069416">syscall</span><span class="op" id="3069423">.</span><span class="ident" id="3069424">Recvfrom</span><span class="op" id="3069432">(</span><span class="ident" id="3069433">fd</span><span class="op" id="3069435">.</span><span class="ident" id="3069436">sysfd</span><span class="op" id="3069441">,</span>&nbsp;<span class="ident" id="3069443">p</span><span class="op" id="3069444">,</span>&nbsp;<span class="num" id="3069446">0</span><span class="op" id="3069447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069451">if</span>&nbsp;<span class="ident" id="3069454">err</span>&nbsp;<span class="op" id="3069458">!=</span>&nbsp;<span class="ident" id="3069461">nil</span>&nbsp;<span class="op" id="3069465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069470">n</span>&nbsp;<span class="op" id="3069472">=</span>&nbsp;<span class="num" id="3069474">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069479">if</span>&nbsp;<span class="ident" id="3069482">err</span>&nbsp;<span class="op" id="3069486">==</span>&nbsp;<span class="ident" id="3069489">syscall</span><span class="op" id="3069496">.</span><span class="ident" id="3069497">EAGAIN</span>&nbsp;<span class="op" id="3069504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069510">if</span>&nbsp;<span class="ident" id="3069513">err</span>&nbsp;<span class="op" id="3069517">=</span>&nbsp;<span class="ident" id="3069519">fd</span><span class="op" id="3069521">.</span><span class="ident" id="3069522">pd</span><span class="op" id="3069524">.</span><span class="ident" id="3069525">WaitRead</span><span class="op" id="3069533">(</span><span class="op" id="3069534">)</span><span class="op" id="3069535">;</span>&nbsp;<span class="ident" id="3069537">err</span>&nbsp;<span class="op" id="3069541">==</span>&nbsp;<span class="ident" id="3069544">nil</span>&nbsp;<span class="op" id="3069548">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069555">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069581">err</span>&nbsp;<span class="op" id="3069585">=</span>&nbsp;<span class="ident" id="3069587">chkReadErr</span><span class="op" id="3069597">(</span><span class="ident" id="3069598">n</span><span class="op" id="3069599">,</span>&nbsp;<span class="ident" id="3069601">err</span><span class="op" id="3069604">,</span>&nbsp;<span class="ident" id="3069606">fd</span><span class="op" id="3069608">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069612">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069622">if</span>&nbsp;<span class="ident" id="3069625">err</span>&nbsp;<span class="op" id="3069629">!=</span>&nbsp;<span class="ident" id="3069632">nil</span>&nbsp;<span class="op" id="3069636">&amp;&amp;</span>&nbsp;<span class="ident" id="3069639">err</span>&nbsp;<span class="op" id="3069643">!=</span>&nbsp;<span class="ident" id="3069646">io</span><span class="op" id="3069648">.</span><span class="ident" id="3069649">EOF</span>&nbsp;<span class="op" id="3069653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069657">err</span>&nbsp;<span class="op" id="3069661">=</span>&nbsp;<span class="op" id="3069663">&amp;</span><span class="ident" id="3069664">OpError</span><span class="op" id="3069671">{</span><span class="string" id="3069672">&#34;read&#34;</span><span class="op" id="3069678">,</span>&nbsp;<span class="ident" id="3069680">fd</span><span class="op" id="3069682">.</span><span class="ident" id="3069683">net</span><span class="op" id="3069686">,</span>&nbsp;<span class="ident" id="3069688">fd</span><span class="op" id="3069690">.</span><span class="ident" id="3069691">laddr</span><span class="op" id="3069696">,</span>&nbsp;<span class="ident" id="3069698">err</span><span class="op" id="3069701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069704">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069707">return</span><br>
<span class="lineno"></span><span class="op" id="3069714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3069717">func</span>&nbsp;<span class="op" id="3069722">(</span><span class="ident" id="3069723">fd</span>&nbsp;<span class="op" id="3069726">*</span><span class="ident" id="3069727">netFD</span><span class="op" id="3069732">)</span>&nbsp;<span class="ident" id="3069734">readMsg</span><span class="op" id="3069741">(</span><span class="ident" id="3069742">p</span>&nbsp;<span class="op" id="3069744">[</span><span class="op" id="3069745">]</span><span class="builtintype" id="3069746">byte</span><span class="op" id="3069750">,</span>&nbsp;<span class="ident" id="3069752">oob</span>&nbsp;<span class="op" id="3069756">[</span><span class="op" id="3069757">]</span><span class="builtintype" id="3069758">byte</span><span class="op" id="3069762">)</span>&nbsp;<span class="op" id="3069764">(</span><span class="ident" id="3069765">n</span><span class="op" id="3069766">,</span>&nbsp;<span class="ident" id="3069768">oobn</span><span class="op" id="3069772">,</span>&nbsp;<span class="ident" id="3069774">flags</span>&nbsp;<span class="builtintype" id="3069780">int</span><span class="op" id="3069783">,</span>&nbsp;<span class="ident" id="3069785">sa</span>&nbsp;<span class="ident" id="3069788">syscall</span><span class="op" id="3069795">.</span><span class="ident" id="3069796">Sockaddr</span><span class="op" id="3069804">,</span>&nbsp;<span class="ident" id="3069806">err</span>&nbsp;<span class="builtintype" id="3069810">error</span><span class="op" id="3069815">)</span>&nbsp;<span class="op" id="3069817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069820">if</span>&nbsp;<span class="ident" id="3069823">err</span>&nbsp;<span class="op" id="3069827">:=</span>&nbsp;<span class="ident" id="3069830">fd</span><span class="op" id="3069832">.</span><span class="ident" id="3069833">readLock</span><span class="op" id="3069841">(</span><span class="op" id="3069842">)</span><span class="op" id="3069843">;</span>&nbsp;<span class="ident" id="3069845">err</span>&nbsp;<span class="op" id="3069849">!=</span>&nbsp;<span class="ident" id="3069852">nil</span>&nbsp;<span class="op" id="3069856">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069860">return</span>&nbsp;<span class="num" id="3069867">0</span><span class="op" id="3069868">,</span>&nbsp;<span class="num" id="3069870">0</span><span class="op" id="3069871">,</span>&nbsp;<span class="num" id="3069873">0</span><span class="op" id="3069874">,</span>&nbsp;<span class="ident" id="3069876">nil</span><span class="op" id="3069879">,</span>&nbsp;<span class="ident" id="3069881">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069889">defer</span>&nbsp;<span class="ident" id="3069895">fd</span><span class="op" id="3069897">.</span><span class="ident" id="3069898">readUnlock</span><span class="op" id="3069908">(</span><span class="op" id="3069909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069912">if</span>&nbsp;<span class="ident" id="3069915">err</span>&nbsp;<span class="op" id="3069919">:=</span>&nbsp;<span class="ident" id="3069922">fd</span><span class="op" id="3069924">.</span><span class="ident" id="3069925">pd</span><span class="op" id="3069927">.</span><span class="ident" id="3069928">PrepareRead</span><span class="op" id="3069939">(</span><span class="op" id="3069940">)</span><span class="op" id="3069941">;</span>&nbsp;<span class="ident" id="3069943">err</span>&nbsp;<span class="op" id="3069947">!=</span>&nbsp;<span class="ident" id="3069950">nil</span>&nbsp;<span class="op" id="3069954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069958">return</span>&nbsp;<span class="num" id="3069965">0</span><span class="op" id="3069966">,</span>&nbsp;<span class="num" id="3069968">0</span><span class="op" id="3069969">,</span>&nbsp;<span class="num" id="3069971">0</span><span class="op" id="3069972">,</span>&nbsp;<span class="ident" id="3069974">nil</span><span class="op" id="3069977">,</span>&nbsp;<span class="op" id="3069979">&amp;</span><span class="ident" id="3069980">OpError</span><span class="op" id="3069987">{</span><span class="string" id="3069988">&#34;read&#34;</span><span class="op" id="3069994">,</span>&nbsp;<span class="ident" id="3069996">fd</span><span class="op" id="3069998">.</span><span class="ident" id="3069999">net</span><span class="op" id="3070002">,</span>&nbsp;<span class="ident" id="3070004">fd</span><span class="op" id="3070006">.</span><span class="ident" id="3070007">laddr</span><span class="op" id="3070012">,</span>&nbsp;<span class="ident" id="3070014">err</span><span class="op" id="3070017">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070023">for</span>&nbsp;<span class="op" id="3070027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070031">n</span><span class="op" id="3070032">,</span>&nbsp;<span class="ident" id="3070034">oobn</span><span class="op" id="3070038">,</span>&nbsp;<span class="ident" id="3070040">flags</span><span class="op" id="3070045">,</span>&nbsp;<span class="ident" id="3070047">sa</span><span class="op" id="3070049">,</span>&nbsp;<span class="ident" id="3070051">err</span>&nbsp;<span class="op" id="3070055">=</span>&nbsp;<span class="ident" id="3070057">syscall</span><span class="op" id="3070064">.</span><span class="ident" id="3070065">Recvmsg</span><span class="op" id="3070072">(</span><span class="ident" id="3070073">fd</span><span class="op" id="3070075">.</span><span class="ident" id="3070076">sysfd</span><span class="op" id="3070081">,</span>&nbsp;<span class="ident" id="3070083">p</span><span class="op" id="3070084">,</span>&nbsp;<span class="ident" id="3070086">oob</span><span class="op" id="3070089">,</span>&nbsp;<span class="num" id="3070091">0</span><span class="op" id="3070092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070096">if</span>&nbsp;<span class="ident" id="3070099">err</span>&nbsp;<span class="op" id="3070103">!=</span>&nbsp;<span class="ident" id="3070106">nil</span>&nbsp;<span class="op" id="3070110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3070115">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070161">if</span>&nbsp;<span class="ident" id="3070164">err</span>&nbsp;<span class="op" id="3070168">==</span>&nbsp;<span class="ident" id="3070171">syscall</span><span class="op" id="3070178">.</span><span class="ident" id="3070179">EAGAIN</span>&nbsp;<span class="op" id="3070186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070192">if</span>&nbsp;<span class="ident" id="3070195">err</span>&nbsp;<span class="op" id="3070199">=</span>&nbsp;<span class="ident" id="3070201">fd</span><span class="op" id="3070203">.</span><span class="ident" id="3070204">pd</span><span class="op" id="3070206">.</span><span class="ident" id="3070207">WaitRead</span><span class="op" id="3070215">(</span><span class="op" id="3070216">)</span><span class="op" id="3070217">;</span>&nbsp;<span class="ident" id="3070219">err</span>&nbsp;<span class="op" id="3070223">==</span>&nbsp;<span class="ident" id="3070226">nil</span>&nbsp;<span class="op" id="3070230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070237">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070255">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070263">err</span>&nbsp;<span class="op" id="3070267">=</span>&nbsp;<span class="ident" id="3070269">chkReadErr</span><span class="op" id="3070279">(</span><span class="ident" id="3070280">n</span><span class="op" id="3070281">,</span>&nbsp;<span class="ident" id="3070283">err</span><span class="op" id="3070286">,</span>&nbsp;<span class="ident" id="3070288">fd</span><span class="op" id="3070290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070294">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070304">if</span>&nbsp;<span class="ident" id="3070307">err</span>&nbsp;<span class="op" id="3070311">!=</span>&nbsp;<span class="ident" id="3070314">nil</span>&nbsp;<span class="op" id="3070318">&amp;&amp;</span>&nbsp;<span class="ident" id="3070321">err</span>&nbsp;<span class="op" id="3070325">!=</span>&nbsp;<span class="ident" id="3070328">io</span><span class="op" id="3070330">.</span><span class="ident" id="3070331">EOF</span>&nbsp;<span class="op" id="3070335">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070339">err</span>&nbsp;<span class="op" id="3070343">=</span>&nbsp;<span class="op" id="3070345">&amp;</span><span class="ident" id="3070346">OpError</span><span class="op" id="3070353">{</span><span class="string" id="3070354">&#34;read&#34;</span><span class="op" id="3070360">,</span>&nbsp;<span class="ident" id="3070362">fd</span><span class="op" id="3070364">.</span><span class="ident" id="3070365">net</span><span class="op" id="3070368">,</span>&nbsp;<span class="ident" id="3070370">fd</span><span class="op" id="3070372">.</span><span class="ident" id="3070373">laddr</span><span class="op" id="3070378">,</span>&nbsp;<span class="ident" id="3070380">err</span><span class="op" id="3070383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070389">return</span><br>
<span class="lineno"></span><span class="op" id="3070396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3070399">func</span>&nbsp;<span class="ident" id="3070404">chkReadErr</span><span class="op" id="3070414">(</span><span class="ident" id="3070415">n</span>&nbsp;<span class="builtintype" id="3070417">int</span><span class="op" id="3070420">,</span>&nbsp;<span class="ident" id="3070422">err</span>&nbsp;<span class="builtintype" id="3070426">error</span><span class="op" id="3070431">,</span>&nbsp;<span class="ident" id="3070433">fd</span>&nbsp;<span class="op" id="3070436">*</span><span class="ident" id="3070437">netFD</span><span class="op" id="3070442">)</span>&nbsp;<span class="builtintype" id="3070444">error</span>&nbsp;<span class="op" id="3070450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070453">if</span>&nbsp;<span class="ident" id="3070456">n</span>&nbsp;<span class="op" id="3070458">==</span>&nbsp;<span class="num" id="3070461">0</span>&nbsp;<span class="op" id="3070463">&amp;&amp;</span>&nbsp;<span class="ident" id="3070466">err</span>&nbsp;<span class="op" id="3070470">==</span>&nbsp;<span class="ident" id="3070473">nil</span>&nbsp;<span class="op" id="3070477">&amp;&amp;</span>&nbsp;<span class="ident" id="3070480">fd</span><span class="op" id="3070482">.</span><span class="ident" id="3070483">sotype</span>&nbsp;<span class="op" id="3070490">!=</span>&nbsp;<span class="ident" id="3070493">syscall</span><span class="op" id="3070500">.</span><span class="ident" id="3070501">SOCK_DGRAM</span>&nbsp;<span class="op" id="3070512">&amp;&amp;</span>&nbsp;<span class="ident" id="3070515">fd</span><span class="op" id="3070517">.</span><span class="ident" id="3070518">sotype</span>&nbsp;<span class="op" id="3070525">!=</span>&nbsp;<span class="ident" id="3070528">syscall</span><span class="op" id="3070535">.</span><span class="ident" id="3070536">SOCK_RAW</span>&nbsp;<span class="op" id="3070545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070549">return</span>&nbsp;<span class="ident" id="3070556">io</span><span class="op" id="3070558">.</span><span class="ident" id="3070559">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070567">return</span>&nbsp;<span class="ident" id="3070574">err</span><br>
<span class="lineno">315</span><span class="op" id="3070578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3070581">func</span>&nbsp;<span class="op" id="3070586">(</span><span class="ident" id="3070587">fd</span>&nbsp;<span class="op" id="3070590">*</span><span class="ident" id="3070591">netFD</span><span class="op" id="3070596">)</span>&nbsp;<span class="ident" id="3070598">Write</span><span class="op" id="3070603">(</span><span class="ident" id="3070604">p</span>&nbsp;<span class="op" id="3070606">[</span><span class="op" id="3070607">]</span><span class="builtintype" id="3070608">byte</span><span class="op" id="3070612">)</span>&nbsp;<span class="op" id="3070614">(</span><span class="ident" id="3070615">nn</span>&nbsp;<span class="builtintype" id="3070618">int</span><span class="op" id="3070621">,</span>&nbsp;<span class="ident" id="3070623">err</span>&nbsp;<span class="builtintype" id="3070627">error</span><span class="op" id="3070632">)</span>&nbsp;<span class="op" id="3070634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070637">if</span>&nbsp;<span class="ident" id="3070640">err</span>&nbsp;<span class="op" id="3070644">:=</span>&nbsp;<span class="ident" id="3070647">fd</span><span class="op" id="3070649">.</span><span class="ident" id="3070650">writeLock</span><span class="op" id="3070659">(</span><span class="op" id="3070660">)</span><span class="op" id="3070661">;</span>&nbsp;<span class="ident" id="3070663">err</span>&nbsp;<span class="op" id="3070667">!=</span>&nbsp;<span class="ident" id="3070670">nil</span>&nbsp;<span class="op" id="3070674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070678">return</span>&nbsp;<span class="num" id="3070685">0</span><span class="op" id="3070686">,</span>&nbsp;<span class="ident" id="3070688">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070696">defer</span>&nbsp;<span class="ident" id="3070702">fd</span><span class="op" id="3070704">.</span><span class="ident" id="3070705">writeUnlock</span><span class="op" id="3070716">(</span><span class="op" id="3070717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070720">if</span>&nbsp;<span class="ident" id="3070723">err</span>&nbsp;<span class="op" id="3070727">:=</span>&nbsp;<span class="ident" id="3070730">fd</span><span class="op" id="3070732">.</span><span class="ident" id="3070733">pd</span><span class="op" id="3070735">.</span><span class="ident" id="3070736">PrepareWrite</span><span class="op" id="3070748">(</span><span class="op" id="3070749">)</span><span class="op" id="3070750">;</span>&nbsp;<span class="ident" id="3070752">err</span>&nbsp;<span class="op" id="3070756">!=</span>&nbsp;<span class="ident" id="3070759">nil</span>&nbsp;<span class="op" id="3070763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070767">return</span>&nbsp;<span class="num" id="3070774">0</span><span class="op" id="3070775">,</span>&nbsp;<span class="op" id="3070777">&amp;</span><span class="ident" id="3070778">OpError</span><span class="op" id="3070785">{</span><span class="string" id="3070786">&#34;write&#34;</span><span class="op" id="3070793">,</span>&nbsp;<span class="ident" id="3070795">fd</span><span class="op" id="3070797">.</span><span class="ident" id="3070798">net</span><span class="op" id="3070801">,</span>&nbsp;<span class="ident" id="3070803">fd</span><span class="op" id="3070805">.</span><span class="ident" id="3070806">raddr</span><span class="op" id="3070811">,</span>&nbsp;<span class="ident" id="3070813">err</span><span class="op" id="3070816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070819">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070822">for</span>&nbsp;<span class="op" id="3070826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070830">var</span>&nbsp;<span class="ident" id="3070834">n</span>&nbsp;<span class="builtintype" id="3070836">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070842">n</span><span class="op" id="3070843">,</span>&nbsp;<span class="ident" id="3070845">err</span>&nbsp;<span class="op" id="3070849">=</span>&nbsp;<span class="ident" id="3070851">syscall</span><span class="op" id="3070858">.</span><span class="ident" id="3070859">Write</span><span class="op" id="3070864">(</span><span class="builtintype" id="3070865">int</span><span class="op" id="3070868">(</span><span class="ident" id="3070869">fd</span><span class="op" id="3070871">.</span><span class="ident" id="3070872">sysfd</span><span class="op" id="3070877">)</span><span class="op" id="3070878">,</span>&nbsp;<span class="ident" id="3070880">p</span><span class="op" id="3070881">[</span><span class="ident" id="3070882">nn</span><span class="op" id="3070884">:</span><span class="op" id="3070885">]</span><span class="op" id="3070886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070890">if</span>&nbsp;<span class="ident" id="3070893">n</span>&nbsp;<span class="op" id="3070895">&gt;</span>&nbsp;<span class="num" id="3070897">0</span>&nbsp;<span class="op" id="3070899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070904">nn</span>&nbsp;<span class="op" id="3070907">+=</span>&nbsp;<span class="ident" id="3070910">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070918">if</span>&nbsp;<span class="ident" id="3070921">nn</span>&nbsp;<span class="op" id="3070924">==</span>&nbsp;<span class="builtinfunc" id="3070927">len</span><span class="op" id="3070930">(</span><span class="ident" id="3070931">p</span><span class="op" id="3070932">)</span>&nbsp;<span class="op" id="3070934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070939">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070951">if</span>&nbsp;<span class="ident" id="3070954">err</span>&nbsp;<span class="op" id="3070958">==</span>&nbsp;<span class="ident" id="3070961">syscall</span><span class="op" id="3070968">.</span><span class="ident" id="3070969">EAGAIN</span>&nbsp;<span class="op" id="3070976">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070981">if</span>&nbsp;<span class="ident" id="3070984">err</span>&nbsp;<span class="op" id="3070988">=</span>&nbsp;<span class="ident" id="3070990">fd</span><span class="op" id="3070992">.</span><span class="ident" id="3070993">pd</span><span class="op" id="3070995">.</span><span class="ident" id="3070996">WaitWrite</span><span class="op" id="3071005">(</span><span class="op" id="3071006">)</span><span class="op" id="3071007">;</span>&nbsp;<span class="ident" id="3071009">err</span>&nbsp;<span class="op" id="3071013">==</span>&nbsp;<span class="ident" id="3071016">nil</span>&nbsp;<span class="op" id="3071020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071026">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071046">if</span>&nbsp;<span class="ident" id="3071049">err</span>&nbsp;<span class="op" id="3071053">!=</span>&nbsp;<span class="ident" id="3071056">nil</span>&nbsp;<span class="op" id="3071060">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071065">n</span>&nbsp;<span class="op" id="3071067">=</span>&nbsp;<span class="num" id="3071069">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071074">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071086">if</span>&nbsp;<span class="ident" id="3071089">n</span>&nbsp;<span class="op" id="3071091">==</span>&nbsp;<span class="num" id="3071094">0</span>&nbsp;<span class="op" id="3071096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071101">err</span>&nbsp;<span class="op" id="3071105">=</span>&nbsp;<span class="ident" id="3071107">io</span><span class="op" id="3071109">.</span><span class="ident" id="3071110">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071130">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071144">if</span>&nbsp;<span class="ident" id="3071147">err</span>&nbsp;<span class="op" id="3071151">!=</span>&nbsp;<span class="ident" id="3071154">nil</span>&nbsp;<span class="op" id="3071158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071162">err</span>&nbsp;<span class="op" id="3071166">=</span>&nbsp;<span class="op" id="3071168">&amp;</span><span class="ident" id="3071169">OpError</span><span class="op" id="3071176">{</span><span class="string" id="3071177">&#34;write&#34;</span><span class="op" id="3071184">,</span>&nbsp;<span class="ident" id="3071186">fd</span><span class="op" id="3071188">.</span><span class="ident" id="3071189">net</span><span class="op" id="3071192">,</span>&nbsp;<span class="ident" id="3071194">fd</span><span class="op" id="3071196">.</span><span class="ident" id="3071197">raddr</span><span class="op" id="3071202">,</span>&nbsp;<span class="ident" id="3071204">err</span><span class="op" id="3071207">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071213">return</span>&nbsp;<span class="ident" id="3071220">nn</span><span class="op" id="3071222">,</span>&nbsp;<span class="ident" id="3071224">err</span><br>
<span class="lineno"></span><span class="op" id="3071228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3071231">func</span>&nbsp;<span class="op" id="3071236">(</span><span class="ident" id="3071237">fd</span>&nbsp;<span class="op" id="3071240">*</span><span class="ident" id="3071241">netFD</span><span class="op" id="3071246">)</span>&nbsp;<span class="ident" id="3071248">writeTo</span><span class="op" id="3071255">(</span><span class="ident" id="3071256">p</span>&nbsp;<span class="op" id="3071258">[</span><span class="op" id="3071259">]</span><span class="builtintype" id="3071260">byte</span><span class="op" id="3071264">,</span>&nbsp;<span class="ident" id="3071266">sa</span>&nbsp;<span class="ident" id="3071269">syscall</span><span class="op" id="3071276">.</span><span class="ident" id="3071277">Sockaddr</span><span class="op" id="3071285">)</span>&nbsp;<span class="op" id="3071287">(</span><span class="ident" id="3071288">n</span>&nbsp;<span class="builtintype" id="3071290">int</span><span class="op" id="3071293">,</span>&nbsp;<span class="ident" id="3071295">err</span>&nbsp;<span class="builtintype" id="3071299">error</span><span class="op" id="3071304">)</span>&nbsp;<span class="op" id="3071306">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071309">if</span>&nbsp;<span class="ident" id="3071312">err</span>&nbsp;<span class="op" id="3071316">:=</span>&nbsp;<span class="ident" id="3071319">fd</span><span class="op" id="3071321">.</span><span class="ident" id="3071322">writeLock</span><span class="op" id="3071331">(</span><span class="op" id="3071332">)</span><span class="op" id="3071333">;</span>&nbsp;<span class="ident" id="3071335">err</span>&nbsp;<span class="op" id="3071339">!=</span>&nbsp;<span class="ident" id="3071342">nil</span>&nbsp;<span class="op" id="3071346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071350">return</span>&nbsp;<span class="num" id="3071357">0</span><span class="op" id="3071358">,</span>&nbsp;<span class="ident" id="3071360">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071368">defer</span>&nbsp;<span class="ident" id="3071374">fd</span><span class="op" id="3071376">.</span><span class="ident" id="3071377">writeUnlock</span><span class="op" id="3071388">(</span><span class="op" id="3071389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071392">if</span>&nbsp;<span class="ident" id="3071395">err</span>&nbsp;<span class="op" id="3071399">:=</span>&nbsp;<span class="ident" id="3071402">fd</span><span class="op" id="3071404">.</span><span class="ident" id="3071405">pd</span><span class="op" id="3071407">.</span><span class="ident" id="3071408">PrepareWrite</span><span class="op" id="3071420">(</span><span class="op" id="3071421">)</span><span class="op" id="3071422">;</span>&nbsp;<span class="ident" id="3071424">err</span>&nbsp;<span class="op" id="3071428">!=</span>&nbsp;<span class="ident" id="3071431">nil</span>&nbsp;<span class="op" id="3071435">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071439">return</span>&nbsp;<span class="num" id="3071446">0</span><span class="op" id="3071447">,</span>&nbsp;<span class="op" id="3071449">&amp;</span><span class="ident" id="3071450">OpError</span><span class="op" id="3071457">{</span><span class="string" id="3071458">&#34;write&#34;</span><span class="op" id="3071465">,</span>&nbsp;<span class="ident" id="3071467">fd</span><span class="op" id="3071469">.</span><span class="ident" id="3071470">net</span><span class="op" id="3071473">,</span>&nbsp;<span class="ident" id="3071475">fd</span><span class="op" id="3071477">.</span><span class="ident" id="3071478">raddr</span><span class="op" id="3071483">,</span>&nbsp;<span class="ident" id="3071485">err</span><span class="op" id="3071488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071494">for</span>&nbsp;<span class="op" id="3071498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071502">err</span>&nbsp;<span class="op" id="3071506">=</span>&nbsp;<span class="ident" id="3071508">syscall</span><span class="op" id="3071515">.</span><span class="ident" id="3071516">Sendto</span><span class="op" id="3071522">(</span><span class="ident" id="3071523">fd</span><span class="op" id="3071525">.</span><span class="ident" id="3071526">sysfd</span><span class="op" id="3071531">,</span>&nbsp;<span class="ident" id="3071533">p</span><span class="op" id="3071534">,</span>&nbsp;<span class="num" id="3071536">0</span><span class="op" id="3071537">,</span>&nbsp;<span class="ident" id="3071539">sa</span><span class="op" id="3071541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071545">if</span>&nbsp;<span class="ident" id="3071548">err</span>&nbsp;<span class="op" id="3071552">==</span>&nbsp;<span class="ident" id="3071555">syscall</span><span class="op" id="3071562">.</span><span class="ident" id="3071563">EAGAIN</span>&nbsp;<span class="op" id="3071570">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071575">if</span>&nbsp;<span class="ident" id="3071578">err</span>&nbsp;<span class="op" id="3071582">=</span>&nbsp;<span class="ident" id="3071584">fd</span><span class="op" id="3071586">.</span><span class="ident" id="3071587">pd</span><span class="op" id="3071589">.</span><span class="ident" id="3071590">WaitWrite</span><span class="op" id="3071599">(</span><span class="op" id="3071600">)</span><span class="op" id="3071601">;</span>&nbsp;<span class="ident" id="3071603">err</span>&nbsp;<span class="op" id="3071607">==</span>&nbsp;<span class="ident" id="3071610">nil</span>&nbsp;<span class="op" id="3071614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071620">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071640">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071650">if</span>&nbsp;<span class="ident" id="3071653">err</span>&nbsp;<span class="op" id="3071657">==</span>&nbsp;<span class="ident" id="3071660">nil</span>&nbsp;<span class="op" id="3071664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071668">n</span>&nbsp;<span class="op" id="3071670">=</span>&nbsp;<span class="builtinfunc" id="3071672">len</span><span class="op" id="3071675">(</span><span class="ident" id="3071676">p</span><span class="op" id="3071677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071680">}</span>&nbsp;<span class="keyword" id="3071682">else</span>&nbsp;<span class="op" id="3071687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071691">err</span>&nbsp;<span class="op" id="3071695">=</span>&nbsp;<span class="op" id="3071697">&amp;</span><span class="ident" id="3071698">OpError</span><span class="op" id="3071705">{</span><span class="string" id="3071706">&#34;write&#34;</span><span class="op" id="3071713">,</span>&nbsp;<span class="ident" id="3071715">fd</span><span class="op" id="3071717">.</span><span class="ident" id="3071718">net</span><span class="op" id="3071721">,</span>&nbsp;<span class="ident" id="3071723">fd</span><span class="op" id="3071725">.</span><span class="ident" id="3071726">raddr</span><span class="op" id="3071731">,</span>&nbsp;<span class="ident" id="3071733">err</span><span class="op" id="3071736">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071742">return</span><br>
<span class="lineno"></span><span class="op" id="3071749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3071752">func</span>&nbsp;<span class="op" id="3071757">(</span><span class="ident" id="3071758">fd</span>&nbsp;<span class="op" id="3071761">*</span><span class="ident" id="3071762">netFD</span><span class="op" id="3071767">)</span>&nbsp;<span class="ident" id="3071769">writeMsg</span><span class="op" id="3071777">(</span><span class="ident" id="3071778">p</span>&nbsp;<span class="op" id="3071780">[</span><span class="op" id="3071781">]</span><span class="builtintype" id="3071782">byte</span><span class="op" id="3071786">,</span>&nbsp;<span class="ident" id="3071788">oob</span>&nbsp;<span class="op" id="3071792">[</span><span class="op" id="3071793">]</span><span class="builtintype" id="3071794">byte</span><span class="op" id="3071798">,</span>&nbsp;<span class="ident" id="3071800">sa</span>&nbsp;<span class="ident" id="3071803">syscall</span><span class="op" id="3071810">.</span><span class="ident" id="3071811">Sockaddr</span><span class="op" id="3071819">)</span>&nbsp;<span class="op" id="3071821">(</span><span class="ident" id="3071822">n</span>&nbsp;<span class="builtintype" id="3071824">int</span><span class="op" id="3071827">,</span>&nbsp;<span class="ident" id="3071829">oobn</span>&nbsp;<span class="builtintype" id="3071834">int</span><span class="op" id="3071837">,</span>&nbsp;<span class="ident" id="3071839">err</span>&nbsp;<span class="builtintype" id="3071843">error</span><span class="op" id="3071848">)</span>&nbsp;<span class="op" id="3071850">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071853">if</span>&nbsp;<span class="ident" id="3071856">err</span>&nbsp;<span class="op" id="3071860">:=</span>&nbsp;<span class="ident" id="3071863">fd</span><span class="op" id="3071865">.</span><span class="ident" id="3071866">writeLock</span><span class="op" id="3071875">(</span><span class="op" id="3071876">)</span><span class="op" id="3071877">;</span>&nbsp;<span class="ident" id="3071879">err</span>&nbsp;<span class="op" id="3071883">!=</span>&nbsp;<span class="ident" id="3071886">nil</span>&nbsp;<span class="op" id="3071890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071894">return</span>&nbsp;<span class="num" id="3071901">0</span><span class="op" id="3071902">,</span>&nbsp;<span class="num" id="3071904">0</span><span class="op" id="3071905">,</span>&nbsp;<span class="ident" id="3071907">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071915">defer</span>&nbsp;<span class="ident" id="3071921">fd</span><span class="op" id="3071923">.</span><span class="ident" id="3071924">writeUnlock</span><span class="op" id="3071935">(</span><span class="op" id="3071936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071939">if</span>&nbsp;<span class="ident" id="3071942">err</span>&nbsp;<span class="op" id="3071946">:=</span>&nbsp;<span class="ident" id="3071949">fd</span><span class="op" id="3071951">.</span><span class="ident" id="3071952">pd</span><span class="op" id="3071954">.</span><span class="ident" id="3071955">PrepareWrite</span><span class="op" id="3071967">(</span><span class="op" id="3071968">)</span><span class="op" id="3071969">;</span>&nbsp;<span class="ident" id="3071971">err</span>&nbsp;<span class="op" id="3071975">!=</span>&nbsp;<span class="ident" id="3071978">nil</span>&nbsp;<span class="op" id="3071982">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071986">return</span>&nbsp;<span class="num" id="3071993">0</span><span class="op" id="3071994">,</span>&nbsp;<span class="num" id="3071996">0</span><span class="op" id="3071997">,</span>&nbsp;<span class="op" id="3071999">&amp;</span><span class="ident" id="3072000">OpError</span><span class="op" id="3072007">{</span><span class="string" id="3072008">&#34;write&#34;</span><span class="op" id="3072015">,</span>&nbsp;<span class="ident" id="3072017">fd</span><span class="op" id="3072019">.</span><span class="ident" id="3072020">net</span><span class="op" id="3072023">,</span>&nbsp;<span class="ident" id="3072025">fd</span><span class="op" id="3072027">.</span><span class="ident" id="3072028">raddr</span><span class="op" id="3072033">,</span>&nbsp;<span class="ident" id="3072035">err</span><span class="op" id="3072038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072044">for</span>&nbsp;<span class="op" id="3072048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072052">n</span><span class="op" id="3072053">,</span>&nbsp;<span class="ident" id="3072055">err</span>&nbsp;<span class="op" id="3072059">=</span>&nbsp;<span class="ident" id="3072061">syscall</span><span class="op" id="3072068">.</span><span class="ident" id="3072069">SendmsgN</span><span class="op" id="3072077">(</span><span class="ident" id="3072078">fd</span><span class="op" id="3072080">.</span><span class="ident" id="3072081">sysfd</span><span class="op" id="3072086">,</span>&nbsp;<span class="ident" id="3072088">p</span><span class="op" id="3072089">,</span>&nbsp;<span class="ident" id="3072091">oob</span><span class="op" id="3072094">,</span>&nbsp;<span class="ident" id="3072096">sa</span><span class="op" id="3072098">,</span>&nbsp;<span class="num" id="3072100">0</span><span class="op" id="3072101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072105">if</span>&nbsp;<span class="ident" id="3072108">err</span>&nbsp;<span class="op" id="3072112">==</span>&nbsp;<span class="ident" id="3072115">syscall</span><span class="op" id="3072122">.</span><span class="ident" id="3072123">EAGAIN</span>&nbsp;<span class="op" id="3072130">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072135">if</span>&nbsp;<span class="ident" id="3072138">err</span>&nbsp;<span class="op" id="3072142">=</span>&nbsp;<span class="ident" id="3072144">fd</span><span class="op" id="3072146">.</span><span class="ident" id="3072147">pd</span><span class="op" id="3072149">.</span><span class="ident" id="3072150">WaitWrite</span><span class="op" id="3072159">(</span><span class="op" id="3072160">)</span><span class="op" id="3072161">;</span>&nbsp;<span class="ident" id="3072163">err</span>&nbsp;<span class="op" id="3072167">==</span>&nbsp;<span class="ident" id="3072170">nil</span>&nbsp;<span class="op" id="3072174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072180">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072200">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072210">if</span>&nbsp;<span class="ident" id="3072213">err</span>&nbsp;<span class="op" id="3072217">==</span>&nbsp;<span class="ident" id="3072220">nil</span>&nbsp;<span class="op" id="3072224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072228">oobn</span>&nbsp;<span class="op" id="3072233">=</span>&nbsp;<span class="builtinfunc" id="3072235">len</span><span class="op" id="3072238">(</span><span class="ident" id="3072239">oob</span><span class="op" id="3072242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072245">}</span>&nbsp;<span class="keyword" id="3072247">else</span>&nbsp;<span class="op" id="3072252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072256">err</span>&nbsp;<span class="op" id="3072260">=</span>&nbsp;<span class="op" id="3072262">&amp;</span><span class="ident" id="3072263">OpError</span><span class="op" id="3072270">{</span><span class="string" id="3072271">&#34;write&#34;</span><span class="op" id="3072278">,</span>&nbsp;<span class="ident" id="3072280">fd</span><span class="op" id="3072282">.</span><span class="ident" id="3072283">net</span><span class="op" id="3072286">,</span>&nbsp;<span class="ident" id="3072288">fd</span><span class="op" id="3072290">.</span><span class="ident" id="3072291">raddr</span><span class="op" id="3072296">,</span>&nbsp;<span class="ident" id="3072298">err</span><span class="op" id="3072301">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072307">return</span><br>
<span class="lineno"></span><span class="op" id="3072314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3072317">func</span>&nbsp;<span class="op" id="3072322">(</span><span class="ident" id="3072323">fd</span>&nbsp;<span class="op" id="3072326">*</span><span class="ident" id="3072327">netFD</span><span class="op" id="3072332">)</span>&nbsp;<span class="ident" id="3072334">accept</span><span class="op" id="3072340">(</span><span class="op" id="3072341">)</span>&nbsp;<span class="op" id="3072343">(</span><span class="ident" id="3072344">netfd</span>&nbsp;<span class="op" id="3072350">*</span><span class="ident" id="3072351">netFD</span><span class="op" id="3072356">,</span>&nbsp;<span class="ident" id="3072358">err</span>&nbsp;<span class="builtintype" id="3072362">error</span><span class="op" id="3072367">)</span>&nbsp;<span class="op" id="3072369">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072372">if</span>&nbsp;<span class="ident" id="3072375">err</span>&nbsp;<span class="op" id="3072379">:=</span>&nbsp;<span class="ident" id="3072382">fd</span><span class="op" id="3072384">.</span><span class="ident" id="3072385">readLock</span><span class="op" id="3072393">(</span><span class="op" id="3072394">)</span><span class="op" id="3072395">;</span>&nbsp;<span class="ident" id="3072397">err</span>&nbsp;<span class="op" id="3072401">!=</span>&nbsp;<span class="ident" id="3072404">nil</span>&nbsp;<span class="op" id="3072408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072412">return</span>&nbsp;<span class="ident" id="3072419">nil</span><span class="op" id="3072422">,</span>&nbsp;<span class="ident" id="3072424">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072432">defer</span>&nbsp;<span class="ident" id="3072438">fd</span><span class="op" id="3072440">.</span><span class="ident" id="3072441">readUnlock</span><span class="op" id="3072451">(</span><span class="op" id="3072452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072456">var</span>&nbsp;<span class="ident" id="3072460">s</span>&nbsp;<span class="builtintype" id="3072462">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072467">var</span>&nbsp;<span class="ident" id="3072471">rsa</span>&nbsp;<span class="ident" id="3072475">syscall</span><span class="op" id="3072482">.</span><span class="ident" id="3072483">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072493">if</span>&nbsp;<span class="ident" id="3072496">err</span>&nbsp;<span class="op" id="3072500">=</span>&nbsp;<span class="ident" id="3072502">fd</span><span class="op" id="3072504">.</span><span class="ident" id="3072505">pd</span><span class="op" id="3072507">.</span><span class="ident" id="3072508">PrepareRead</span><span class="op" id="3072519">(</span><span class="op" id="3072520">)</span><span class="op" id="3072521">;</span>&nbsp;<span class="ident" id="3072523">err</span>&nbsp;<span class="op" id="3072527">!=</span>&nbsp;<span class="ident" id="3072530">nil</span>&nbsp;<span class="op" id="3072534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072538">return</span>&nbsp;<span class="ident" id="3072545">nil</span><span class="op" id="3072548">,</span>&nbsp;<span class="op" id="3072550">&amp;</span><span class="ident" id="3072551">OpError</span><span class="op" id="3072558">{</span><span class="string" id="3072559">&#34;accept&#34;</span><span class="op" id="3072567">,</span>&nbsp;<span class="ident" id="3072569">fd</span><span class="op" id="3072571">.</span><span class="ident" id="3072572">net</span><span class="op" id="3072575">,</span>&nbsp;<span class="ident" id="3072577">fd</span><span class="op" id="3072579">.</span><span class="ident" id="3072580">laddr</span><span class="op" id="3072585">,</span>&nbsp;<span class="ident" id="3072587">err</span><span class="op" id="3072590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072593">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072596">for</span>&nbsp;<span class="op" id="3072600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072604">s</span><span class="op" id="3072605">,</span>&nbsp;<span class="ident" id="3072607">rsa</span><span class="op" id="3072610">,</span>&nbsp;<span class="ident" id="3072612">err</span>&nbsp;<span class="op" id="3072616">=</span>&nbsp;<span class="ident" id="3072618">accept</span><span class="op" id="3072624">(</span><span class="ident" id="3072625">fd</span><span class="op" id="3072627">.</span><span class="ident" id="3072628">sysfd</span><span class="op" id="3072633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072637">if</span>&nbsp;<span class="ident" id="3072640">err</span>&nbsp;<span class="op" id="3072644">!=</span>&nbsp;<span class="ident" id="3072647">nil</span>&nbsp;<span class="op" id="3072651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072656">if</span>&nbsp;<span class="ident" id="3072659">err</span>&nbsp;<span class="op" id="3072663">==</span>&nbsp;<span class="ident" id="3072666">syscall</span><span class="op" id="3072673">.</span><span class="ident" id="3072674">EAGAIN</span>&nbsp;<span class="op" id="3072681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072687">if</span>&nbsp;<span class="ident" id="3072690">err</span>&nbsp;<span class="op" id="3072694">=</span>&nbsp;<span class="ident" id="3072696">fd</span><span class="op" id="3072698">.</span><span class="ident" id="3072699">pd</span><span class="op" id="3072701">.</span><span class="ident" id="3072702">WaitRead</span><span class="op" id="3072710">(</span><span class="op" id="3072711">)</span><span class="op" id="3072712">;</span>&nbsp;<span class="ident" id="3072714">err</span>&nbsp;<span class="op" id="3072718">==</span>&nbsp;<span class="ident" id="3072721">nil</span>&nbsp;<span class="op" id="3072725">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072732">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072750">}</span>&nbsp;<span class="keyword" id="3072752">else</span>&nbsp;<span class="keyword" id="3072757">if</span>&nbsp;<span class="ident" id="3072760">err</span>&nbsp;<span class="op" id="3072764">==</span>&nbsp;<span class="ident" id="3072767">syscall</span><span class="op" id="3072774">.</span><span class="ident" id="3072775">ECONNABORTED</span>&nbsp;<span class="op" id="3072788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3072794">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3072857">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072923">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072940">return</span>&nbsp;<span class="ident" id="3072947">nil</span><span class="op" id="3072950">,</span>&nbsp;<span class="op" id="3072952">&amp;</span><span class="ident" id="3072953">OpError</span><span class="op" id="3072960">{</span><span class="string" id="3072961">&#34;accept&#34;</span><span class="op" id="3072969">,</span>&nbsp;<span class="ident" id="3072971">fd</span><span class="op" id="3072973">.</span><span class="ident" id="3072974">net</span><span class="op" id="3072977">,</span>&nbsp;<span class="ident" id="3072979">fd</span><span class="op" id="3072981">.</span><span class="ident" id="3072982">laddr</span><span class="op" id="3072987">,</span>&nbsp;<span class="ident" id="3072989">err</span><span class="op" id="3072992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073000">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073011">if</span>&nbsp;<span class="ident" id="3073014">netfd</span><span class="op" id="3073019">,</span>&nbsp;<span class="ident" id="3073021">err</span>&nbsp;<span class="op" id="3073025">=</span>&nbsp;<span class="ident" id="3073027">newFD</span><span class="op" id="3073032">(</span><span class="ident" id="3073033">s</span><span class="op" id="3073034">,</span>&nbsp;<span class="ident" id="3073036">fd</span><span class="op" id="3073038">.</span><span class="ident" id="3073039">family</span><span class="op" id="3073045">,</span>&nbsp;<span class="ident" id="3073047">fd</span><span class="op" id="3073049">.</span><span class="ident" id="3073050">sotype</span><span class="op" id="3073056">,</span>&nbsp;<span class="ident" id="3073058">fd</span><span class="op" id="3073060">.</span><span class="ident" id="3073061">net</span><span class="op" id="3073064">)</span><span class="op" id="3073065">;</span>&nbsp;<span class="ident" id="3073067">err</span>&nbsp;<span class="op" id="3073071">!=</span>&nbsp;<span class="ident" id="3073074">nil</span>&nbsp;<span class="op" id="3073078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073082">closesocket</span><span class="op" id="3073093">(</span><span class="ident" id="3073094">s</span><span class="op" id="3073095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073099">return</span>&nbsp;<span class="ident" id="3073106">nil</span><span class="op" id="3073109">,</span>&nbsp;<span class="ident" id="3073111">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073119">if</span>&nbsp;<span class="ident" id="3073122">err</span>&nbsp;<span class="op" id="3073126">=</span>&nbsp;<span class="ident" id="3073128">netfd</span><span class="op" id="3073133">.</span><span class="ident" id="3073134">init</span><span class="op" id="3073138">(</span><span class="op" id="3073139">)</span><span class="op" id="3073140">;</span>&nbsp;<span class="ident" id="3073142">err</span>&nbsp;<span class="op" id="3073146">!=</span>&nbsp;<span class="ident" id="3073149">nil</span>&nbsp;<span class="op" id="3073153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073157">fd</span><span class="op" id="3073159">.</span><span class="ident" id="3073160">Close</span><span class="op" id="3073165">(</span><span class="op" id="3073166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073170">return</span>&nbsp;<span class="ident" id="3073177">nil</span><span class="op" id="3073180">,</span>&nbsp;<span class="ident" id="3073182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073187">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073190">lsa</span><span class="op" id="3073193">,</span>&nbsp;<span class="ident" id="3073195">_</span>&nbsp;<span class="op" id="3073197">:=</span>&nbsp;<span class="ident" id="3073200">syscall</span><span class="op" id="3073207">.</span><span class="ident" id="3073208">Getsockname</span><span class="op" id="3073219">(</span><span class="ident" id="3073220">netfd</span><span class="op" id="3073225">.</span><span class="ident" id="3073226">sysfd</span><span class="op" id="3073231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073234">netfd</span><span class="op" id="3073239">.</span><span class="ident" id="3073240">setAddr</span><span class="op" id="3073247">(</span><span class="ident" id="3073248">netfd</span><span class="op" id="3073253">.</span><span class="ident" id="3073254">addrFunc</span><span class="op" id="3073262">(</span><span class="op" id="3073263">)</span><span class="op" id="3073264">(</span><span class="ident" id="3073265">lsa</span><span class="op" id="3073268">)</span><span class="op" id="3073269">,</span>&nbsp;<span class="ident" id="3073271">netfd</span><span class="op" id="3073276">.</span><span class="ident" id="3073277">addrFunc</span><span class="op" id="3073285">(</span><span class="op" id="3073286">)</span><span class="op" id="3073287">(</span><span class="ident" id="3073288">rsa</span><span class="op" id="3073291">)</span><span class="op" id="3073292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073295">return</span>&nbsp;<span class="ident" id="3073302">netfd</span><span class="op" id="3073307">,</span>&nbsp;<span class="ident" id="3073309">nil</span><br>
<span class="lineno"></span><span class="op" id="3073313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3073316">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3073383">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3073438">var</span>&nbsp;<span class="ident" id="3073442">tryDupCloexec</span>&nbsp;<span class="op" id="3073456">=</span>&nbsp;<span class="builtintype" id="3073458">int32</span><span class="op" id="3073463">(</span><span class="num" id="3073464">1</span><span class="op" id="3073465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3073468">func</span>&nbsp;<span class="ident" id="3073473">dupCloseOnExec</span><span class="op" id="3073487">(</span><span class="ident" id="3073488">fd</span>&nbsp;<span class="builtintype" id="3073491">int</span><span class="op" id="3073494">)</span>&nbsp;<span class="op" id="3073496">(</span><span class="ident" id="3073497">newfd</span>&nbsp;<span class="builtintype" id="3073503">int</span><span class="op" id="3073506">,</span>&nbsp;<span class="ident" id="3073508">err</span>&nbsp;<span class="builtintype" id="3073512">error</span><span class="op" id="3073517">)</span>&nbsp;<span class="op" id="3073519">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073522">if</span>&nbsp;<span class="ident" id="3073525">atomic</span><span class="op" id="3073531">.</span><span class="ident" id="3073532">LoadInt32</span><span class="op" id="3073541">(</span><span class="op" id="3073542">&amp;</span><span class="ident" id="3073543">tryDupCloexec</span><span class="op" id="3073556">)</span>&nbsp;<span class="op" id="3073558">==</span>&nbsp;<span class="num" id="3073561">1</span>&nbsp;<span class="op" id="3073563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073567">r0</span><span class="op" id="3073569">,</span>&nbsp;<span class="ident" id="3073571">_</span><span class="op" id="3073572">,</span>&nbsp;<span class="ident" id="3073574">e1</span>&nbsp;<span class="op" id="3073577">:=</span>&nbsp;<span class="ident" id="3073580">syscall</span><span class="op" id="3073587">.</span><span class="ident" id="3073588">Syscall</span><span class="op" id="3073595">(</span><span class="ident" id="3073596">syscall</span><span class="op" id="3073603">.</span><span class="ident" id="3073604">SYS_FCNTL</span><span class="op" id="3073613">,</span>&nbsp;<span class="builtintype" id="3073615">uintptr</span><span class="op" id="3073622">(</span><span class="ident" id="3073623">fd</span><span class="op" id="3073625">)</span><span class="op" id="3073626">,</span>&nbsp;<span class="ident" id="3073628">syscall</span><span class="op" id="3073635">.</span><span class="ident" id="3073636">F_DUPFD_CLOEXEC</span><span class="op" id="3073651">,</span>&nbsp;<span class="num" id="3073653">0</span><span class="op" id="3073654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073658">if</span>&nbsp;<span class="ident" id="3073661">runtime</span><span class="op" id="3073668">.</span><span class="ident" id="3073669">GOOS</span>&nbsp;<span class="op" id="3073674">==</span>&nbsp;<span class="string" id="3073677">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3073686">&amp;&amp;</span>&nbsp;<span class="ident" id="3073689">e1</span>&nbsp;<span class="op" id="3073692">==</span>&nbsp;<span class="ident" id="3073695">syscall</span><span class="op" id="3073702">.</span><span class="ident" id="3073703">EBADF</span>&nbsp;<span class="op" id="3073709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073714">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073764">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073811">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073859">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073908">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073952">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3073996">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074041">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074064">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074119">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074134">e1</span>&nbsp;<span class="op" id="3074137">=</span>&nbsp;<span class="ident" id="3074139">syscall</span><span class="op" id="3074146">.</span><span class="ident" id="3074147">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074156">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074160">switch</span>&nbsp;<span class="ident" id="3074167">e1</span>&nbsp;<span class="op" id="3074170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074174">case</span>&nbsp;<span class="num" id="3074179">0</span><span class="op" id="3074180">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074185">return</span>&nbsp;<span class="builtintype" id="3074192">int</span><span class="op" id="3074195">(</span><span class="ident" id="3074196">r0</span><span class="op" id="3074198">)</span><span class="op" id="3074199">,</span>&nbsp;<span class="ident" id="3074201">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074207">case</span>&nbsp;<span class="ident" id="3074212">syscall</span><span class="op" id="3074219">.</span><span class="ident" id="3074220">EINVAL</span><span class="op" id="3074226">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074231">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074279">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074298">atomic</span><span class="op" id="3074304">.</span><span class="ident" id="3074305">StoreInt32</span><span class="op" id="3074315">(</span><span class="op" id="3074316">&amp;</span><span class="ident" id="3074317">tryDupCloexec</span><span class="op" id="3074330">,</span>&nbsp;<span class="num" id="3074332">0</span><span class="op" id="3074333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074337">default</span><span class="op" id="3074344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074349">return</span>&nbsp;<span class="op" id="3074356">-</span><span class="num" id="3074357">1</span><span class="op" id="3074358">,</span>&nbsp;<span class="ident" id="3074360">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074365">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074371">return</span>&nbsp;<span class="ident" id="3074378">dupCloseOnExecOld</span><span class="op" id="3074395">(</span><span class="ident" id="3074396">fd</span><span class="op" id="3074398">)</span><br>
<span class="lineno"></span><span class="op" id="3074400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3074403">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3074468">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3074518">func</span>&nbsp;<span class="ident" id="3074523">dupCloseOnExecOld</span><span class="op" id="3074540">(</span><span class="ident" id="3074541">fd</span>&nbsp;<span class="builtintype" id="3074544">int</span><span class="op" id="3074547">)</span>&nbsp;<span class="op" id="3074549">(</span><span class="ident" id="3074550">newfd</span>&nbsp;<span class="builtintype" id="3074556">int</span><span class="op" id="3074559">,</span>&nbsp;<span class="ident" id="3074561">err</span>&nbsp;<span class="builtintype" id="3074565">error</span><span class="op" id="3074570">)</span>&nbsp;<span class="op" id="3074572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074575">syscall</span><span class="op" id="3074582">.</span><span class="ident" id="3074583">ForkLock</span><span class="op" id="3074591">.</span><span class="ident" id="3074592">RLock</span><span class="op" id="3074597">(</span><span class="op" id="3074598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074601">defer</span>&nbsp;<span class="ident" id="3074607">syscall</span><span class="op" id="3074614">.</span><span class="ident" id="3074615">ForkLock</span><span class="op" id="3074623">.</span><span class="ident" id="3074624">RUnlock</span><span class="op" id="3074631">(</span><span class="op" id="3074632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074635">newfd</span><span class="op" id="3074640">,</span>&nbsp;<span class="ident" id="3074642">err</span>&nbsp;<span class="op" id="3074646">=</span>&nbsp;<span class="ident" id="3074648">syscall</span><span class="op" id="3074655">.</span><span class="ident" id="3074656">Dup</span><span class="op" id="3074659">(</span><span class="ident" id="3074660">fd</span><span class="op" id="3074662">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074665">if</span>&nbsp;<span class="ident" id="3074668">err</span>&nbsp;<span class="op" id="3074672">!=</span>&nbsp;<span class="ident" id="3074675">nil</span>&nbsp;<span class="op" id="3074679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074683">return</span>&nbsp;<span class="op" id="3074690">-</span><span class="num" id="3074691">1</span><span class="op" id="3074692">,</span>&nbsp;<span class="ident" id="3074694">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074702">syscall</span><span class="op" id="3074709">.</span><span class="ident" id="3074710">CloseOnExec</span><span class="op" id="3074721">(</span><span class="ident" id="3074722">newfd</span><span class="op" id="3074727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074730">return</span><br>
<span class="lineno">490</span><span class="op" id="3074737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3074740">func</span>&nbsp;<span class="op" id="3074745">(</span><span class="ident" id="3074746">fd</span>&nbsp;<span class="op" id="3074749">*</span><span class="ident" id="3074750">netFD</span><span class="op" id="3074755">)</span>&nbsp;<span class="ident" id="3074757">dup</span><span class="op" id="3074760">(</span><span class="op" id="3074761">)</span>&nbsp;<span class="op" id="3074763">(</span><span class="ident" id="3074764">f</span>&nbsp;<span class="op" id="3074766">*</span><span class="ident" id="3074767">os</span><span class="op" id="3074769">.</span><span class="ident" id="3074770">File</span><span class="op" id="3074774">,</span>&nbsp;<span class="ident" id="3074776">err</span>&nbsp;<span class="builtintype" id="3074780">error</span><span class="op" id="3074785">)</span>&nbsp;<span class="op" id="3074787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074790">ns</span><span class="op" id="3074792">,</span>&nbsp;<span class="ident" id="3074794">err</span>&nbsp;<span class="op" id="3074798">:=</span>&nbsp;<span class="ident" id="3074801">dupCloseOnExec</span><span class="op" id="3074815">(</span><span class="ident" id="3074816">fd</span><span class="op" id="3074818">.</span><span class="ident" id="3074819">sysfd</span><span class="op" id="3074824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074827">if</span>&nbsp;<span class="ident" id="3074830">err</span>&nbsp;<span class="op" id="3074834">!=</span>&nbsp;<span class="ident" id="3074837">nil</span>&nbsp;<span class="op" id="3074841">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074845">return</span>&nbsp;<span class="ident" id="3074852">nil</span><span class="op" id="3074855">,</span>&nbsp;<span class="op" id="3074857">&amp;</span><span class="ident" id="3074858">OpError</span><span class="op" id="3074865">{</span><span class="string" id="3074866">&#34;dup&#34;</span><span class="op" id="3074871">,</span>&nbsp;<span class="ident" id="3074873">fd</span><span class="op" id="3074875">.</span><span class="ident" id="3074876">net</span><span class="op" id="3074879">,</span>&nbsp;<span class="ident" id="3074881">fd</span><span class="op" id="3074883">.</span><span class="ident" id="3074884">laddr</span><span class="op" id="3074889">,</span>&nbsp;<span class="ident" id="3074891">err</span><span class="op" id="3074894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074901">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3074970">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3075033">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3075107">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075163">if</span>&nbsp;<span class="ident" id="3075166">err</span>&nbsp;<span class="op" id="3075170">=</span>&nbsp;<span class="ident" id="3075172">syscall</span><span class="op" id="3075179">.</span><span class="ident" id="3075180">SetNonblock</span><span class="op" id="3075191">(</span><span class="ident" id="3075192">ns</span><span class="op" id="3075194">,</span>&nbsp;<span class="builtintype" id="3075196">false</span><span class="op" id="3075201">)</span><span class="op" id="3075202">;</span>&nbsp;<span class="ident" id="3075204">err</span>&nbsp;<span class="op" id="3075208">!=</span>&nbsp;<span class="ident" id="3075211">nil</span>&nbsp;<span class="op" id="3075215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075219">return</span>&nbsp;<span class="ident" id="3075226">nil</span><span class="op" id="3075229">,</span>&nbsp;<span class="op" id="3075231">&amp;</span><span class="ident" id="3075232">OpError</span><span class="op" id="3075239">{</span><span class="string" id="3075240">&#34;setnonblock&#34;</span><span class="op" id="3075253">,</span>&nbsp;<span class="ident" id="3075255">fd</span><span class="op" id="3075257">.</span><span class="ident" id="3075258">net</span><span class="op" id="3075261">,</span>&nbsp;<span class="ident" id="3075263">fd</span><span class="op" id="3075265">.</span><span class="ident" id="3075266">laddr</span><span class="op" id="3075271">,</span>&nbsp;<span class="ident" id="3075273">err</span><span class="op" id="3075276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3075279">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075283">return</span>&nbsp;<span class="ident" id="3075290">os</span><span class="op" id="3075292">.</span><span class="ident" id="3075293">NewFile</span><span class="op" id="3075300">(</span><span class="builtintype" id="3075301">uintptr</span><span class="op" id="3075308">(</span><span class="ident" id="3075309">ns</span><span class="op" id="3075311">)</span><span class="op" id="3075312">,</span>&nbsp;<span class="ident" id="3075314">fd</span><span class="op" id="3075316">.</span><span class="ident" id="3075317">name</span><span class="op" id="3075321">(</span><span class="op" id="3075322">)</span><span class="op" id="3075323">)</span><span class="op" id="3075324">,</span>&nbsp;<span class="ident" id="3075326">nil</span><br>
<span class="lineno"></span><span class="op" id="3075330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3075333">func</span>&nbsp;<span class="ident" id="3075338">closesocket</span><span class="op" id="3075349">(</span><span class="ident" id="3075350">s</span>&nbsp;<span class="builtintype" id="3075352">int</span><span class="op" id="3075355">)</span>&nbsp;<span class="builtintype" id="3075357">error</span>&nbsp;<span class="op" id="3075363">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075366">return</span>&nbsp;<span class="ident" id="3075373">syscall</span><span class="op" id="3075380">.</span><span class="ident" id="3075381">Close</span><span class="op" id="3075386">(</span><span class="ident" id="3075387">s</span><span class="op" id="3075388">)</span><br>
<span class="lineno"></span><span class="op" id="3075390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3075393">func</span>&nbsp;<span class="ident" id="3075398">skipRawSocketTests</span><span class="op" id="3075416">(</span><span class="op" id="3075417">)</span>&nbsp;<span class="op" id="3075419">(</span><span class="ident" id="3075420">skip</span>&nbsp;<span class="builtintype" id="3075425">bool</span><span class="op" id="3075429">,</span>&nbsp;<span class="ident" id="3075431">skipmsg</span>&nbsp;<span class="builtintype" id="3075439">string</span><span class="op" id="3075445">,</span>&nbsp;<span class="ident" id="3075447">err</span>&nbsp;<span class="builtintype" id="3075451">error</span><span class="op" id="3075456">)</span>&nbsp;<span class="op" id="3075458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075461">if</span>&nbsp;<span class="ident" id="3075464">os</span><span class="op" id="3075466">.</span><span class="ident" id="3075467">Getuid</span><span class="op" id="3075473">(</span><span class="op" id="3075474">)</span>&nbsp;<span class="op" id="3075476">!=</span>&nbsp;<span class="num" id="3075479">0</span>&nbsp;<span class="op" id="3075481">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075485">return</span>&nbsp;<span class="builtintype" id="3075492">true</span><span class="op" id="3075496">,</span>&nbsp;<span class="string" id="3075498">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3075527">,</span>&nbsp;<span class="ident" id="3075529">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3075534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3075537">return</span>&nbsp;<span class="builtintype" id="3075544">false</span><span class="op" id="3075549">,</span>&nbsp;<span class="string" id="3075551">&#34;&#34;</span><span class="op" id="3075553">,</span>&nbsp;<span class="ident" id="3075555">nil</span><br>
<span class="lineno"></span><span class="op" id="3075559">}</span>
</div>
</body>
</html>
