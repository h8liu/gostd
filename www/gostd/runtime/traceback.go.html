<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html" class="current">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1709449">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1709504">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1709558">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1709609">package</span>&nbsp;<span class="ident" id="1709617">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1709626">import</span>&nbsp;<span class="string" id="1709633">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1709643">//&nbsp;The&nbsp;code&nbsp;in&nbsp;this&nbsp;file&nbsp;implements&nbsp;stack&nbsp;trace&nbsp;walking&nbsp;for&nbsp;all&nbsp;architectures.</span><br>
<span class="lineno">10</span><span class="comment" id="1709722">//&nbsp;The&nbsp;most&nbsp;important&nbsp;fact&nbsp;about&nbsp;a&nbsp;given&nbsp;architecture&nbsp;is&nbsp;whether&nbsp;it&nbsp;uses&nbsp;a&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span><span class="comment" id="1709812">//&nbsp;On&nbsp;systems&nbsp;with&nbsp;link&nbsp;registers,&nbsp;the&nbsp;prologue&nbsp;for&nbsp;a&nbsp;non-leaf&nbsp;function&nbsp;stores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1709895">//&nbsp;incoming&nbsp;value&nbsp;of&nbsp;LR&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;newly&nbsp;allocated&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno"></span><span class="comment" id="1709969">//&nbsp;On&nbsp;systems&nbsp;without&nbsp;link&nbsp;registers,&nbsp;the&nbsp;architecture&nbsp;pushes&nbsp;a&nbsp;return&nbsp;PC&nbsp;during</span><br>
<span class="lineno"></span><span class="comment" id="1710050">//&nbsp;the&nbsp;call&nbsp;instruction,&nbsp;so&nbsp;the&nbsp;return&nbsp;PC&nbsp;ends&nbsp;up&nbsp;above&nbsp;the&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno">15</span><span class="comment" id="1710123">//&nbsp;In&nbsp;this&nbsp;file,&nbsp;the&nbsp;return&nbsp;PC&nbsp;is&nbsp;always&nbsp;called&nbsp;LR,&nbsp;no&nbsp;matter&nbsp;how&nbsp;it&nbsp;was&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="1710203">//</span><br>
<span class="lineno"></span><span class="comment" id="1710206">//&nbsp;To&nbsp;date,&nbsp;the&nbsp;opposite&nbsp;of&nbsp;a&nbsp;link&nbsp;register&nbsp;architecture&nbsp;is&nbsp;an&nbsp;x86&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="comment" id="1710287">//&nbsp;This&nbsp;code&nbsp;may&nbsp;need&nbsp;to&nbsp;change&nbsp;if&nbsp;some&nbsp;other&nbsp;kind&nbsp;of&nbsp;non-link-register</span><br>
<span class="lineno"></span><span class="comment" id="1710359">//&nbsp;architecture&nbsp;comes&nbsp;along.</span><br>
<span class="lineno">20</span><span class="comment" id="1710388">//</span><br>
<span class="lineno"></span><span class="comment" id="1710391">//&nbsp;The&nbsp;other&nbsp;important&nbsp;fact&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;pointer:&nbsp;on&nbsp;32-bit&nbsp;systems&nbsp;the&nbsp;LR</span><br>
<span class="lineno"></span><span class="comment" id="1710470">//&nbsp;takes&nbsp;up&nbsp;only&nbsp;4&nbsp;bytes&nbsp;on&nbsp;the&nbsp;stack,&nbsp;while&nbsp;on&nbsp;64-bit&nbsp;systems&nbsp;it&nbsp;takes&nbsp;up&nbsp;8&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1710554">//&nbsp;Typically&nbsp;this&nbsp;is&nbsp;ptrSize.</span><br>
<span class="lineno"></span><span class="comment" id="1710584">//</span><br>
<span class="lineno">25</span><span class="comment" id="1710587">//&nbsp;As&nbsp;an&nbsp;exception,&nbsp;amd64p32&nbsp;has&nbsp;ptrSize&nbsp;==&nbsp;4&nbsp;but&nbsp;the&nbsp;CALL&nbsp;instruction&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="1710664">//&nbsp;stores&nbsp;an&nbsp;8-byte&nbsp;return&nbsp;PC&nbsp;onto&nbsp;the&nbsp;stack.&nbsp;To&nbsp;accommodate&nbsp;this,&nbsp;we&nbsp;use&nbsp;regSize</span><br>
<span class="lineno"></span><span class="comment" id="1710746">//&nbsp;as&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;architecture-pushed&nbsp;return&nbsp;PC.</span><br>
<span class="lineno"></span><span class="comment" id="1710799">//</span><br>
<span class="lineno"></span><span class="comment" id="1710802">//&nbsp;usesLR&nbsp;is&nbsp;defined&nbsp;below.&nbsp;ptrSize&nbsp;and&nbsp;regSize&nbsp;are&nbsp;defined&nbsp;in&nbsp;stubs.go.</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1710876">const</span>&nbsp;<span class="ident" id="1710882">usesLR</span>&nbsp;<span class="op" id="1710889">=</span>&nbsp;<span class="ident" id="1710891">GOARCH</span>&nbsp;<span class="op" id="1710898">!=</span>&nbsp;<span class="string" id="1710901">&#34;amd64&#34;</span>&nbsp;<span class="op" id="1710909">&amp;&amp;</span>&nbsp;<span class="ident" id="1710912">GOARCH</span>&nbsp;<span class="op" id="1710919">!=</span>&nbsp;<span class="string" id="1710922">&#34;amd64p32&#34;</span>&nbsp;<span class="op" id="1710933">&amp;&amp;</span>&nbsp;<span class="ident" id="1710936">GOARCH</span>&nbsp;<span class="op" id="1710943">!=</span>&nbsp;<span class="string" id="1710946">&#34;386&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1710953">var</span>&nbsp;<span class="op" id="1710957">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1710960">//&nbsp;initialized&nbsp;in&nbsp;tracebackinit</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1710993">deferprocPC</span>&nbsp;<span class="builtintype" id="1711005">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711014">goexitPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1711026">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711035">jmpdeferPC</span>&nbsp;&nbsp;<span class="builtintype" id="1711047">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711056">mcallPC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1711068">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711077">morestackPC</span>&nbsp;<span class="builtintype" id="1711089">uintptr</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711098">mstartPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1711110">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711119">newprocPC</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1711131">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711140">rt0_goPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1711152">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711161">sigpanicPC</span>&nbsp;&nbsp;<span class="builtintype" id="1711173">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711183">externalthreadhandlerp</span>&nbsp;<span class="builtintype" id="1711206">uintptr</span>&nbsp;<span class="comment" id="1711214">//&nbsp;initialized&nbsp;elsewhere</span><br>
<span class="lineno"></span><span class="op" id="1711239">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1711242">func</span>&nbsp;<span class="ident" id="1711247">tracebackinit</span><span class="op" id="1711260">(</span><span class="op" id="1711261">)</span>&nbsp;<span class="op" id="1711263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1711266">//&nbsp;Go&nbsp;variable&nbsp;initialization&nbsp;happens&nbsp;late&nbsp;during&nbsp;runtime&nbsp;startup.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1711334">//&nbsp;Instead&nbsp;of&nbsp;initializing&nbsp;the&nbsp;variables&nbsp;above&nbsp;in&nbsp;the&nbsp;declarations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1711403">//&nbsp;schedinit&nbsp;calls&nbsp;this&nbsp;function&nbsp;so&nbsp;that&nbsp;the&nbsp;variables&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1711463">//&nbsp;initialized&nbsp;and&nbsp;available&nbsp;earlier&nbsp;in&nbsp;the&nbsp;startup&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711526">deferprocPC</span>&nbsp;<span class="op" id="1711538">=</span>&nbsp;<span class="ident" id="1711540">funcPC</span><span class="op" id="1711546">(</span><span class="ident" id="1711547">deferproc</span><span class="op" id="1711556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711559">goexitPC</span>&nbsp;<span class="op" id="1711568">=</span>&nbsp;<span class="ident" id="1711570">funcPC</span><span class="op" id="1711576">(</span><span class="ident" id="1711577">goexit</span><span class="op" id="1711583">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711586">jmpdeferPC</span>&nbsp;<span class="op" id="1711597">=</span>&nbsp;<span class="ident" id="1711599">funcPC</span><span class="op" id="1711605">(</span><span class="ident" id="1711606">jmpdefer</span><span class="op" id="1711614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711617">mcallPC</span>&nbsp;<span class="op" id="1711625">=</span>&nbsp;<span class="ident" id="1711627">funcPC</span><span class="op" id="1711633">(</span><span class="ident" id="1711634">mcall</span><span class="op" id="1711639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711642">morestackPC</span>&nbsp;<span class="op" id="1711654">=</span>&nbsp;<span class="ident" id="1711656">funcPC</span><span class="op" id="1711662">(</span><span class="ident" id="1711663">morestack</span><span class="op" id="1711672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711675">mstartPC</span>&nbsp;<span class="op" id="1711684">=</span>&nbsp;<span class="ident" id="1711686">funcPC</span><span class="op" id="1711692">(</span><span class="ident" id="1711693">mstart</span><span class="op" id="1711699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711702">newprocPC</span>&nbsp;<span class="op" id="1711712">=</span>&nbsp;<span class="ident" id="1711714">funcPC</span><span class="op" id="1711720">(</span><span class="ident" id="1711721">newproc</span><span class="op" id="1711728">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711731">rt0_goPC</span>&nbsp;<span class="op" id="1711740">=</span>&nbsp;<span class="ident" id="1711742">funcPC</span><span class="op" id="1711748">(</span><span class="ident" id="1711749">rt0_go</span><span class="op" id="1711755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1711758">sigpanicPC</span>&nbsp;<span class="op" id="1711769">=</span>&nbsp;<span class="ident" id="1711771">funcPC</span><span class="op" id="1711777">(</span><span class="ident" id="1711778">sigpanic</span><span class="op" id="1711786">)</span><br>
<span class="lineno"></span><span class="op" id="1711788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1711791">//&nbsp;Traceback&nbsp;over&nbsp;the&nbsp;deferred&nbsp;function&nbsp;calls.</span><br>
<span class="lineno">65</span><span class="comment" id="1711838">//&nbsp;Report&nbsp;them&nbsp;like&nbsp;calls&nbsp;that&nbsp;have&nbsp;been&nbsp;invoked&nbsp;but&nbsp;not&nbsp;started&nbsp;executing&nbsp;yet.</span><br>
<span class="lineno"></span><span class="keyword" id="1711918">func</span>&nbsp;<span class="ident" id="1711923">tracebackdefers</span><span class="op" id="1711938">(</span><span class="ident" id="1711939">gp</span>&nbsp;<span class="op" id="1711942">*</span><span class="ident" id="1711943">g</span><span class="op" id="1711944">,</span>&nbsp;<span class="ident" id="1711946">callback</span>&nbsp;<span class="keyword" id="1711955">func</span><span class="op" id="1711959">(</span><span class="op" id="1711960">*</span><span class="ident" id="1711961">stkframe</span><span class="op" id="1711969">,</span>&nbsp;<span class="ident" id="1711971">unsafe</span><span class="op" id="1711977">.</span><span class="ident" id="1711978">Pointer</span><span class="op" id="1711985">)</span>&nbsp;<span class="builtintype" id="1711987">bool</span><span class="op" id="1711991">,</span>&nbsp;<span class="ident" id="1711993">v</span>&nbsp;<span class="ident" id="1711995">unsafe</span><span class="op" id="1712001">.</span><span class="ident" id="1712002">Pointer</span><span class="op" id="1712009">)</span>&nbsp;<span class="op" id="1712011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1712014">var</span>&nbsp;<span class="ident" id="1712018">frame</span>&nbsp;<span class="ident" id="1712024">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1712034">for</span>&nbsp;<span class="ident" id="1712038">d</span>&nbsp;<span class="op" id="1712040">:=</span>&nbsp;<span class="ident" id="1712043">gp</span><span class="op" id="1712045">.</span><span class="ident" id="1712046">_defer</span><span class="op" id="1712052">;</span>&nbsp;<span class="ident" id="1712054">d</span>&nbsp;<span class="op" id="1712056">!=</span>&nbsp;<span class="ident" id="1712059">nil</span><span class="op" id="1712062">;</span>&nbsp;<span class="ident" id="1712064">d</span>&nbsp;<span class="op" id="1712066">=</span>&nbsp;<span class="ident" id="1712068">d</span><span class="op" id="1712069">.</span><span class="ident" id="1712070">link</span>&nbsp;<span class="op" id="1712075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712079">fn</span>&nbsp;<span class="op" id="1712082">:=</span>&nbsp;<span class="ident" id="1712085">d</span><span class="op" id="1712086">.</span><span class="ident" id="1712087">fn</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1712092">if</span>&nbsp;<span class="ident" id="1712095">fn</span>&nbsp;<span class="op" id="1712098">==</span>&nbsp;<span class="ident" id="1712101">nil</span>&nbsp;<span class="op" id="1712105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1712110">//&nbsp;Defer&nbsp;of&nbsp;nil&nbsp;function.&nbsp;Args&nbsp;don&#39;t&nbsp;matter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712158">frame</span><span class="op" id="1712163">.</span><span class="ident" id="1712164">pc</span>&nbsp;<span class="op" id="1712167">=</span>&nbsp;<span class="num" id="1712169">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712174">frame</span><span class="op" id="1712179">.</span><span class="ident" id="1712180">fn</span>&nbsp;<span class="op" id="1712183">=</span>&nbsp;<span class="ident" id="1712185">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712192">frame</span><span class="op" id="1712197">.</span><span class="ident" id="1712198">argp</span>&nbsp;<span class="op" id="1712203">=</span>&nbsp;<span class="num" id="1712205">0</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712210">frame</span><span class="op" id="1712215">.</span><span class="ident" id="1712216">arglen</span>&nbsp;<span class="op" id="1712223">=</span>&nbsp;<span class="num" id="1712225">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712230">frame</span><span class="op" id="1712235">.</span><span class="ident" id="1712236">argmap</span>&nbsp;<span class="op" id="1712243">=</span>&nbsp;<span class="ident" id="1712245">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1712251">}</span>&nbsp;<span class="keyword" id="1712253">else</span>&nbsp;<span class="op" id="1712258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712263">frame</span><span class="op" id="1712268">.</span><span class="ident" id="1712269">pc</span>&nbsp;<span class="op" id="1712272">=</span>&nbsp;<span class="builtintype" id="1712274">uintptr</span><span class="op" id="1712281">(</span><span class="ident" id="1712282">fn</span><span class="op" id="1712284">.</span><span class="ident" id="1712285">fn</span><span class="op" id="1712287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712292">f</span>&nbsp;<span class="op" id="1712294">:=</span>&nbsp;<span class="ident" id="1712297">findfunc</span><span class="op" id="1712305">(</span><span class="ident" id="1712306">frame</span><span class="op" id="1712311">.</span><span class="ident" id="1712312">pc</span><span class="op" id="1712314">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1712319">if</span>&nbsp;<span class="ident" id="1712322">f</span>&nbsp;<span class="op" id="1712324">==</span>&nbsp;<span class="ident" id="1712327">nil</span>&nbsp;<span class="op" id="1712331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1712337">print</span><span class="op" id="1712342">(</span><span class="string" id="1712343">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;in&nbsp;defer&nbsp;&#34;</span><span class="op" id="1712374">,</span>&nbsp;<span class="ident" id="1712376">hex</span><span class="op" id="1712379">(</span><span class="ident" id="1712380">frame</span><span class="op" id="1712385">.</span><span class="ident" id="1712386">pc</span><span class="op" id="1712388">)</span><span class="op" id="1712389">,</span>&nbsp;<span class="string" id="1712391">&#34;\n&#34;</span><span class="op" id="1712395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712401">gothrow</span><span class="op" id="1712408">(</span><span class="string" id="1712409">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1712421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1712426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712431">frame</span><span class="op" id="1712436">.</span><span class="ident" id="1712437">fn</span>&nbsp;<span class="op" id="1712440">=</span>&nbsp;<span class="ident" id="1712442">f</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712447">frame</span><span class="op" id="1712452">.</span><span class="ident" id="1712453">argp</span>&nbsp;<span class="op" id="1712458">=</span>&nbsp;<span class="builtintype" id="1712460">uintptr</span><span class="op" id="1712467">(</span><span class="ident" id="1712468">deferArgs</span><span class="op" id="1712477">(</span><span class="ident" id="1712478">d</span><span class="op" id="1712479">)</span><span class="op" id="1712480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712485">setArgInfo</span><span class="op" id="1712495">(</span><span class="op" id="1712496">&amp;</span><span class="ident" id="1712497">frame</span><span class="op" id="1712502">,</span>&nbsp;<span class="ident" id="1712504">f</span><span class="op" id="1712505">,</span>&nbsp;<span class="builtintype" id="1712507">true</span><span class="op" id="1712511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1712515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1712519">frame</span><span class="op" id="1712524">.</span><span class="ident" id="1712525">continpc</span>&nbsp;<span class="op" id="1712534">=</span>&nbsp;<span class="ident" id="1712536">frame</span><span class="op" id="1712541">.</span><span class="ident" id="1712542">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1712547">if</span>&nbsp;<span class="op" id="1712550">!</span><span class="ident" id="1712551">callback</span><span class="op" id="1712559">(</span><span class="op" id="1712560">(</span><span class="op" id="1712561">*</span><span class="ident" id="1712562">stkframe</span><span class="op" id="1712570">)</span><span class="op" id="1712571">(</span><span class="ident" id="1712572">noescape</span><span class="op" id="1712580">(</span><span class="ident" id="1712581">unsafe</span><span class="op" id="1712587">.</span><span class="ident" id="1712588">Pointer</span><span class="op" id="1712595">(</span><span class="op" id="1712596">&amp;</span><span class="ident" id="1712597">frame</span><span class="op" id="1712602">)</span><span class="op" id="1712603">)</span><span class="op" id="1712604">)</span><span class="op" id="1712605">,</span>&nbsp;<span class="ident" id="1712607">v</span><span class="op" id="1712608">)</span>&nbsp;<span class="op" id="1712610">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1712615">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1712624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1712627">}</span><br>
<span class="lineno"></span><span class="op" id="1712629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="1712632">//&nbsp;Generic&nbsp;traceback.&nbsp;&nbsp;Handles&nbsp;runtime&nbsp;stack&nbsp;prints&nbsp;(pcbuf&nbsp;==&nbsp;nil),</span><br>
<span class="lineno"></span><span class="comment" id="1712700">//&nbsp;the&nbsp;runtime.Callers&nbsp;function&nbsp;(pcbuf&nbsp;!=&nbsp;nil),&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="1712771">//&nbsp;collector&nbsp;(callback&nbsp;!=&nbsp;nil).&nbsp;&nbsp;A&nbsp;little&nbsp;clunky&nbsp;to&nbsp;merge&nbsp;these,&nbsp;but&nbsp;avoids</span><br>
<span class="lineno"></span><span class="comment" id="1712847">//&nbsp;duplicating&nbsp;the&nbsp;code&nbsp;and&nbsp;all&nbsp;its&nbsp;subtlety.</span><br>
<span class="lineno"></span><span class="keyword" id="1712893">func</span>&nbsp;<span class="ident" id="1712898">gentraceback</span><span class="op" id="1712910">(</span><span class="ident" id="1712911">pc0</span>&nbsp;<span class="builtintype" id="1712915">uintptr</span><span class="op" id="1712922">,</span>&nbsp;<span class="ident" id="1712924">sp0</span>&nbsp;<span class="builtintype" id="1712928">uintptr</span><span class="op" id="1712935">,</span>&nbsp;<span class="ident" id="1712937">lr0</span>&nbsp;<span class="builtintype" id="1712941">uintptr</span><span class="op" id="1712948">,</span>&nbsp;<span class="ident" id="1712950">gp</span>&nbsp;<span class="op" id="1712953">*</span><span class="ident" id="1712954">g</span><span class="op" id="1712955">,</span>&nbsp;<span class="ident" id="1712957">skip</span>&nbsp;<span class="builtintype" id="1712962">int</span><span class="op" id="1712965">,</span>&nbsp;<span class="ident" id="1712967">pcbuf</span>&nbsp;<span class="op" id="1712973">*</span><span class="builtintype" id="1712974">uintptr</span><span class="op" id="1712981">,</span>&nbsp;<span class="ident" id="1712983">max</span>&nbsp;<span class="builtintype" id="1712987">int</span><span class="op" id="1712990">,</span>&nbsp;<span class="ident" id="1712992">callback</span>&nbsp;<span class="keyword" id="1713001">func</span><span class="op" id="1713005">(</span><span class="op" id="1713006">*</span><span class="ident" id="1713007">stkframe</span><span class="op" id="1713015">,</span>&nbsp;<span class="ident" id="1713017">unsafe</span><span class="op" id="1713023">.</span><span class="ident" id="1713024">Pointer</span><span class="op" id="1713031">)</span>&nbsp;<span class="builtintype" id="1713033">bool</span><span class="op" id="1713037">,</span>&nbsp;<span class="ident" id="1713039">v</span>&nbsp;<span class="ident" id="1713041">unsafe</span><span class="op" id="1713047">.</span><span class="ident" id="1713048">Pointer</span><span class="op" id="1713055">,</span>&nbsp;<span class="ident" id="1713057">flags</span>&nbsp;<span class="builtintype" id="1713063">uint</span><span class="op" id="1713067">)</span>&nbsp;<span class="builtintype" id="1713069">int</span>&nbsp;<span class="op" id="1713073">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1713076">if</span>&nbsp;<span class="ident" id="1713079">goexitPC</span>&nbsp;<span class="op" id="1713088">==</span>&nbsp;<span class="num" id="1713091">0</span>&nbsp;<span class="op" id="1713093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1713097">gothrow</span><span class="op" id="1713104">(</span><span class="string" id="1713105">&#34;gentraceback&nbsp;before&nbsp;goexitPC&nbsp;initialization&#34;</span><span class="op" id="1713150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1713153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1713156">g</span>&nbsp;<span class="op" id="1713158">:=</span>&nbsp;<span class="ident" id="1713161">getg</span><span class="op" id="1713165">(</span><span class="op" id="1713166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1713169">if</span>&nbsp;<span class="ident" id="1713172">g</span>&nbsp;<span class="op" id="1713174">==</span>&nbsp;<span class="ident" id="1713177">gp</span>&nbsp;<span class="op" id="1713180">&amp;&amp;</span>&nbsp;<span class="ident" id="1713183">g</span>&nbsp;<span class="op" id="1713185">==</span>&nbsp;<span class="ident" id="1713188">g</span><span class="op" id="1713189">.</span><span class="ident" id="1713190">m</span><span class="op" id="1713191">.</span><span class="ident" id="1713192">curg</span>&nbsp;<span class="op" id="1713197">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713201">//&nbsp;The&nbsp;starting&nbsp;sp&nbsp;has&nbsp;been&nbsp;passed&nbsp;in&nbsp;as&nbsp;a&nbsp;uintptr,&nbsp;and&nbsp;the&nbsp;caller&nbsp;may</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713274">//&nbsp;have&nbsp;other&nbsp;uintptr-typed&nbsp;stack&nbsp;references&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713330">//&nbsp;If&nbsp;during&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;that&nbsp;got&nbsp;us&nbsp;here&nbsp;or&nbsp;during&nbsp;one&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713400">//&nbsp;callbacks&nbsp;below&nbsp;the&nbsp;stack&nbsp;must&nbsp;be&nbsp;grown,&nbsp;all&nbsp;these&nbsp;uintptr&nbsp;references</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713475">//&nbsp;to&nbsp;the&nbsp;stack&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;and&nbsp;gentraceback&nbsp;will&nbsp;continue</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713545">//&nbsp;to&nbsp;inspect&nbsp;the&nbsp;old&nbsp;stack&nbsp;memory,&nbsp;which&nbsp;may&nbsp;no&nbsp;longer&nbsp;be&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713613">//&nbsp;Even&nbsp;if&nbsp;all&nbsp;the&nbsp;variables&nbsp;were&nbsp;updated&nbsp;correctly,&nbsp;it&nbsp;is&nbsp;not&nbsp;clear&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713689">//&nbsp;we&nbsp;want&nbsp;to&nbsp;expose&nbsp;a&nbsp;traceback&nbsp;that&nbsp;begins&nbsp;on&nbsp;one&nbsp;stack&nbsp;and&nbsp;ends</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713758">//&nbsp;on&nbsp;another&nbsp;stack.&nbsp;That&nbsp;could&nbsp;confuse&nbsp;callers&nbsp;quite&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713821">//&nbsp;Instead,&nbsp;we&nbsp;require&nbsp;that&nbsp;gentraceback&nbsp;and&nbsp;any&nbsp;other&nbsp;function&nbsp;that</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713892">//&nbsp;accepts&nbsp;an&nbsp;sp&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;(typically&nbsp;obtained&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1713960">//&nbsp;calling&nbsp;getcallersp)&nbsp;must&nbsp;not&nbsp;run&nbsp;on&nbsp;that&nbsp;goroutine&#39;s&nbsp;stack&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1714029">//&nbsp;instead&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714059">gothrow</span><span class="op" id="1714066">(</span><span class="string" id="1714067">&#34;gentraceback&nbsp;cannot&nbsp;trace&nbsp;user&nbsp;goroutine&nbsp;on&nbsp;its&nbsp;own&nbsp;stack&#34;</span><span class="op" id="1714126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714129">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714132">gotraceback</span>&nbsp;<span class="op" id="1714144">:=</span>&nbsp;<span class="ident" id="1714147">gotraceback</span><span class="op" id="1714158">(</span><span class="ident" id="1714159">nil</span><span class="op" id="1714162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714165">if</span>&nbsp;<span class="ident" id="1714168">pc0</span>&nbsp;<span class="op" id="1714172">==</span>&nbsp;<span class="op" id="1714175">^</span><span class="builtintype" id="1714176">uintptr</span><span class="op" id="1714183">(</span><span class="num" id="1714184">0</span><span class="op" id="1714185">)</span>&nbsp;<span class="op" id="1714187">&amp;&amp;</span>&nbsp;<span class="ident" id="1714190">sp0</span>&nbsp;<span class="op" id="1714194">==</span>&nbsp;<span class="op" id="1714197">^</span><span class="builtintype" id="1714198">uintptr</span><span class="op" id="1714205">(</span><span class="num" id="1714206">0</span><span class="op" id="1714207">)</span>&nbsp;<span class="op" id="1714209">{</span>&nbsp;<span class="comment" id="1714211">//&nbsp;Signal&nbsp;to&nbsp;fetch&nbsp;saved&nbsp;values&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714254">if</span>&nbsp;<span class="ident" id="1714257">gp</span><span class="op" id="1714259">.</span><span class="ident" id="1714260">syscallsp</span>&nbsp;<span class="op" id="1714270">!=</span>&nbsp;<span class="num" id="1714273">0</span>&nbsp;<span class="op" id="1714275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714280">pc0</span>&nbsp;<span class="op" id="1714284">=</span>&nbsp;<span class="ident" id="1714286">gp</span><span class="op" id="1714288">.</span><span class="ident" id="1714289">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714302">sp0</span>&nbsp;<span class="op" id="1714306">=</span>&nbsp;<span class="ident" id="1714308">gp</span><span class="op" id="1714310">.</span><span class="ident" id="1714311">syscallsp</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714324">if</span>&nbsp;<span class="ident" id="1714327">usesLR</span>&nbsp;<span class="op" id="1714334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714340">lr0</span>&nbsp;<span class="op" id="1714344">=</span>&nbsp;<span class="num" id="1714346">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714355">}</span>&nbsp;<span class="keyword" id="1714357">else</span>&nbsp;<span class="op" id="1714362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714367">pc0</span>&nbsp;<span class="op" id="1714371">=</span>&nbsp;<span class="ident" id="1714373">gp</span><span class="op" id="1714375">.</span><span class="ident" id="1714376">sched</span><span class="op" id="1714381">.</span><span class="ident" id="1714382">pc</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714388">sp0</span>&nbsp;<span class="op" id="1714392">=</span>&nbsp;<span class="ident" id="1714394">gp</span><span class="op" id="1714396">.</span><span class="ident" id="1714397">sched</span><span class="op" id="1714402">.</span><span class="ident" id="1714403">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714409">if</span>&nbsp;<span class="ident" id="1714412">usesLR</span>&nbsp;<span class="op" id="1714419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714425">lr0</span>&nbsp;<span class="op" id="1714429">=</span>&nbsp;<span class="ident" id="1714431">gp</span><span class="op" id="1714433">.</span><span class="ident" id="1714434">sched</span><span class="op" id="1714439">.</span><span class="ident" id="1714440">lr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714450">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714457">nprint</span>&nbsp;<span class="op" id="1714464">:=</span>&nbsp;<span class="num" id="1714467">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714470">var</span>&nbsp;<span class="ident" id="1714474">frame</span>&nbsp;<span class="ident" id="1714480">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714490">frame</span><span class="op" id="1714495">.</span><span class="ident" id="1714496">pc</span>&nbsp;<span class="op" id="1714499">=</span>&nbsp;<span class="ident" id="1714501">pc0</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714506">frame</span><span class="op" id="1714511">.</span><span class="ident" id="1714512">sp</span>&nbsp;<span class="op" id="1714515">=</span>&nbsp;<span class="ident" id="1714517">sp0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714522">if</span>&nbsp;<span class="ident" id="1714525">usesLR</span>&nbsp;<span class="op" id="1714532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714536">frame</span><span class="op" id="1714541">.</span><span class="ident" id="1714542">lr</span>&nbsp;<span class="op" id="1714545">=</span>&nbsp;<span class="ident" id="1714547">lr0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714555">waspanic</span>&nbsp;<span class="op" id="1714564">:=</span>&nbsp;<span class="builtintype" id="1714567">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714574">wasnewproc</span>&nbsp;<span class="op" id="1714585">:=</span>&nbsp;<span class="builtintype" id="1714588">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714595">printing</span>&nbsp;<span class="op" id="1714604">:=</span>&nbsp;<span class="ident" id="1714607">pcbuf</span>&nbsp;<span class="op" id="1714613">==</span>&nbsp;<span class="ident" id="1714616">nil</span>&nbsp;<span class="op" id="1714620">&amp;&amp;</span>&nbsp;<span class="ident" id="1714623">callback</span>&nbsp;<span class="op" id="1714632">==</span>&nbsp;<span class="ident" id="1714635">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714640">_defer</span>&nbsp;<span class="op" id="1714647">:=</span>&nbsp;<span class="ident" id="1714650">gp</span><span class="op" id="1714652">.</span><span class="ident" id="1714653">_defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714662">for</span>&nbsp;<span class="ident" id="1714666">_defer</span>&nbsp;<span class="op" id="1714673">!=</span>&nbsp;<span class="ident" id="1714676">nil</span>&nbsp;<span class="op" id="1714680">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1714683">uintptr</span><span class="op" id="1714690">(</span><span class="ident" id="1714691">_defer</span><span class="op" id="1714697">.</span><span class="ident" id="1714698">argp</span><span class="op" id="1714702">)</span>&nbsp;<span class="op" id="1714704">==</span>&nbsp;<span class="ident" id="1714707">_NoArgs</span>&nbsp;<span class="op" id="1714715">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714719">_defer</span>&nbsp;<span class="op" id="1714726">=</span>&nbsp;<span class="ident" id="1714728">_defer</span><span class="op" id="1714734">.</span><span class="ident" id="1714735">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1714745">//&nbsp;If&nbsp;the&nbsp;PC&nbsp;is&nbsp;zero,&nbsp;it&#39;s&nbsp;likely&nbsp;a&nbsp;nil&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1714801">//&nbsp;Start&nbsp;in&nbsp;the&nbsp;caller&#39;s&nbsp;frame.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714834">if</span>&nbsp;<span class="ident" id="1714837">frame</span><span class="op" id="1714842">.</span><span class="ident" id="1714843">pc</span>&nbsp;<span class="op" id="1714846">==</span>&nbsp;<span class="num" id="1714849">0</span>&nbsp;<span class="op" id="1714851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1714855">if</span>&nbsp;<span class="ident" id="1714858">usesLR</span>&nbsp;<span class="op" id="1714865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714870">frame</span><span class="op" id="1714875">.</span><span class="ident" id="1714876">pc</span>&nbsp;<span class="op" id="1714879">=</span>&nbsp;<span class="op" id="1714881">*</span><span class="op" id="1714882">(</span><span class="op" id="1714883">*</span><span class="builtintype" id="1714884">uintptr</span><span class="op" id="1714891">)</span><span class="op" id="1714892">(</span><span class="ident" id="1714893">unsafe</span><span class="op" id="1714899">.</span><span class="ident" id="1714900">Pointer</span><span class="op" id="1714907">(</span><span class="ident" id="1714908">frame</span><span class="op" id="1714913">.</span><span class="ident" id="1714914">sp</span><span class="op" id="1714916">)</span><span class="op" id="1714917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714922">frame</span><span class="op" id="1714927">.</span><span class="ident" id="1714928">lr</span>&nbsp;<span class="op" id="1714931">=</span>&nbsp;<span class="num" id="1714933">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1714937">}</span>&nbsp;<span class="keyword" id="1714939">else</span>&nbsp;<span class="op" id="1714944">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1714949">frame</span><span class="op" id="1714954">.</span><span class="ident" id="1714955">pc</span>&nbsp;<span class="op" id="1714958">=</span>&nbsp;<span class="builtintype" id="1714960">uintptr</span><span class="op" id="1714967">(</span><span class="op" id="1714968">*</span><span class="op" id="1714969">(</span><span class="op" id="1714970">*</span><span class="ident" id="1714971">uintreg</span><span class="op" id="1714978">)</span><span class="op" id="1714979">(</span><span class="ident" id="1714980">unsafe</span><span class="op" id="1714986">.</span><span class="ident" id="1714987">Pointer</span><span class="op" id="1714994">(</span><span class="ident" id="1714995">frame</span><span class="op" id="1715000">.</span><span class="ident" id="1715001">sp</span><span class="op" id="1715003">)</span><span class="op" id="1715004">)</span><span class="op" id="1715005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715010">frame</span><span class="op" id="1715015">.</span><span class="ident" id="1715016">sp</span>&nbsp;<span class="op" id="1715019">+=</span>&nbsp;<span class="ident" id="1715022">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715039">f</span>&nbsp;<span class="op" id="1715041">:=</span>&nbsp;<span class="ident" id="1715044">findfunc</span><span class="op" id="1715052">(</span><span class="ident" id="1715053">frame</span><span class="op" id="1715058">.</span><span class="ident" id="1715059">pc</span><span class="op" id="1715061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715064">if</span>&nbsp;<span class="ident" id="1715067">f</span>&nbsp;<span class="op" id="1715069">==</span>&nbsp;<span class="ident" id="1715072">nil</span>&nbsp;<span class="op" id="1715076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715080">if</span>&nbsp;<span class="ident" id="1715083">callback</span>&nbsp;<span class="op" id="1715092">!=</span>&nbsp;<span class="ident" id="1715095">nil</span>&nbsp;<span class="op" id="1715099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1715104">print</span><span class="op" id="1715109">(</span><span class="string" id="1715110">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;&#34;</span><span class="op" id="1715132">,</span>&nbsp;<span class="ident" id="1715134">hex</span><span class="op" id="1715137">(</span><span class="ident" id="1715138">frame</span><span class="op" id="1715143">.</span><span class="ident" id="1715144">pc</span><span class="op" id="1715146">)</span><span class="op" id="1715147">,</span>&nbsp;<span class="string" id="1715149">&#34;\n&#34;</span><span class="op" id="1715153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715158">gothrow</span><span class="op" id="1715165">(</span><span class="string" id="1715166">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1715178">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715186">return</span>&nbsp;<span class="num" id="1715193">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715199">frame</span><span class="op" id="1715204">.</span><span class="ident" id="1715205">fn</span>&nbsp;<span class="op" id="1715208">=</span>&nbsp;<span class="ident" id="1715210">f</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715214">n</span>&nbsp;<span class="op" id="1715216">:=</span>&nbsp;<span class="num" id="1715219">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715222">for</span>&nbsp;<span class="ident" id="1715226">n</span>&nbsp;<span class="op" id="1715228">&lt;</span>&nbsp;<span class="ident" id="1715230">max</span>&nbsp;<span class="op" id="1715234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715238">//&nbsp;Typically:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715254">//&nbsp;&nbsp;&nbsp;&nbsp;pc&nbsp;is&nbsp;the&nbsp;PC&nbsp;of&nbsp;the&nbsp;running&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715297">//&nbsp;&nbsp;&nbsp;&nbsp;sp&nbsp;is&nbsp;the&nbsp;stack&nbsp;pointer&nbsp;at&nbsp;that&nbsp;program&nbsp;counter.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715351">//&nbsp;&nbsp;&nbsp;&nbsp;fp&nbsp;is&nbsp;the&nbsp;frame&nbsp;pointer&nbsp;(caller&#39;s&nbsp;stack&nbsp;pointer)&nbsp;at&nbsp;that&nbsp;program&nbsp;counter,&nbsp;or&nbsp;nil&nbsp;if&nbsp;unknown.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715449">//&nbsp;&nbsp;&nbsp;&nbsp;stk&nbsp;is&nbsp;the&nbsp;stack&nbsp;containing&nbsp;sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715486">//&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;caller&#39;s&nbsp;program&nbsp;counter&nbsp;is&nbsp;lr,&nbsp;unless&nbsp;lr&nbsp;is&nbsp;zero,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;is&nbsp;*(uintptr*)sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715581">f</span>&nbsp;<span class="op" id="1715583">=</span>&nbsp;<span class="ident" id="1715585">frame</span><span class="op" id="1715590">.</span><span class="ident" id="1715591">fn</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715597">//&nbsp;Found&nbsp;an&nbsp;actual&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715628">//&nbsp;Derive&nbsp;frame&nbsp;pointer&nbsp;and&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715673">if</span>&nbsp;<span class="ident" id="1715676">frame</span><span class="op" id="1715681">.</span><span class="ident" id="1715682">fp</span>&nbsp;<span class="op" id="1715685">==</span>&nbsp;<span class="num" id="1715688">0</span>&nbsp;<span class="op" id="1715690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715695">frame</span><span class="op" id="1715700">.</span><span class="ident" id="1715701">fp</span>&nbsp;<span class="op" id="1715704">=</span>&nbsp;<span class="ident" id="1715706">frame</span><span class="op" id="1715711">.</span><span class="ident" id="1715712">sp</span>&nbsp;<span class="op" id="1715715">+</span>&nbsp;<span class="builtintype" id="1715717">uintptr</span><span class="op" id="1715724">(</span><span class="ident" id="1715725">funcspdelta</span><span class="op" id="1715736">(</span><span class="ident" id="1715737">f</span><span class="op" id="1715738">,</span>&nbsp;<span class="ident" id="1715740">frame</span><span class="op" id="1715745">.</span><span class="ident" id="1715746">pc</span><span class="op" id="1715748">)</span><span class="op" id="1715749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715754">if</span>&nbsp;<span class="op" id="1715757">!</span><span class="ident" id="1715758">usesLR</span>&nbsp;<span class="op" id="1715765">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715771">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715850">frame</span><span class="op" id="1715855">.</span><span class="ident" id="1715856">fp</span>&nbsp;<span class="op" id="1715859">+=</span>&nbsp;<span class="ident" id="1715862">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715881">var</span>&nbsp;<span class="ident" id="1715885">flr</span>&nbsp;<span class="op" id="1715889">*</span><span class="ident" id="1715890">_func</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1715898">if</span>&nbsp;<span class="ident" id="1715901">topofstack</span><span class="op" id="1715911">(</span><span class="ident" id="1715912">f</span><span class="op" id="1715913">)</span>&nbsp;<span class="op" id="1715915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715920">frame</span><span class="op" id="1715925">.</span><span class="ident" id="1715926">lr</span>&nbsp;<span class="op" id="1715929">=</span>&nbsp;<span class="num" id="1715931">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1715936">flr</span>&nbsp;<span class="op" id="1715940">=</span>&nbsp;<span class="ident" id="1715942">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1715948">}</span>&nbsp;<span class="keyword" id="1715950">else</span>&nbsp;<span class="keyword" id="1715955">if</span>&nbsp;<span class="ident" id="1715958">usesLR</span>&nbsp;<span class="op" id="1715965">&amp;&amp;</span>&nbsp;<span class="ident" id="1715968">f</span><span class="op" id="1715969">.</span><span class="ident" id="1715970">entry</span>&nbsp;<span class="op" id="1715976">==</span>&nbsp;<span class="ident" id="1715979">jmpdeferPC</span>&nbsp;<span class="op" id="1715990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1715995">//&nbsp;jmpdefer&nbsp;modifies&nbsp;SP/LR/PC&nbsp;non-atomically.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716044">//&nbsp;If&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;arrives&nbsp;during&nbsp;jmpdefer,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716100">//&nbsp;the&nbsp;stack&nbsp;unwind&nbsp;may&nbsp;see&nbsp;a&nbsp;mismatched&nbsp;register&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716157">//&nbsp;and&nbsp;get&nbsp;confused.&nbsp;Stop&nbsp;if&nbsp;we&nbsp;see&nbsp;PC&nbsp;within&nbsp;jmpdefer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716215">//&nbsp;to&nbsp;avoid&nbsp;that&nbsp;confusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716246">//&nbsp;See&nbsp;golang.org/issue/8153.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1716279">if</span>&nbsp;<span class="ident" id="1716282">callback</span>&nbsp;<span class="op" id="1716291">!=</span>&nbsp;<span class="ident" id="1716294">nil</span>&nbsp;<span class="op" id="1716298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1716304">gothrow</span><span class="op" id="1716311">(</span><span class="string" id="1716312">&#34;traceback_arm:&nbsp;found&nbsp;jmpdefer&nbsp;when&nbsp;tracing&nbsp;with&nbsp;callback&#34;</span><span class="op" id="1716370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1716375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1716380">frame</span><span class="op" id="1716385">.</span><span class="ident" id="1716386">lr</span>&nbsp;<span class="op" id="1716389">=</span>&nbsp;<span class="num" id="1716391">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1716395">}</span>&nbsp;<span class="keyword" id="1716397">else</span>&nbsp;<span class="op" id="1716402">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1716407">if</span>&nbsp;<span class="ident" id="1716410">usesLR</span>&nbsp;<span class="op" id="1716417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1716423">if</span>&nbsp;<span class="ident" id="1716426">n</span>&nbsp;<span class="op" id="1716428">==</span>&nbsp;<span class="num" id="1716431">0</span>&nbsp;<span class="op" id="1716433">&amp;&amp;</span>&nbsp;<span class="ident" id="1716436">frame</span><span class="op" id="1716441">.</span><span class="ident" id="1716442">sp</span>&nbsp;<span class="op" id="1716445">&lt;</span>&nbsp;<span class="ident" id="1716447">frame</span><span class="op" id="1716452">.</span><span class="ident" id="1716453">fp</span>&nbsp;<span class="op" id="1716456">||</span>&nbsp;<span class="ident" id="1716459">frame</span><span class="op" id="1716464">.</span><span class="ident" id="1716465">lr</span>&nbsp;<span class="op" id="1716468">==</span>&nbsp;<span class="num" id="1716471">0</span>&nbsp;<span class="op" id="1716473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1716480">frame</span><span class="op" id="1716485">.</span><span class="ident" id="1716486">lr</span>&nbsp;<span class="op" id="1716489">=</span>&nbsp;<span class="op" id="1716491">*</span><span class="op" id="1716492">(</span><span class="op" id="1716493">*</span><span class="builtintype" id="1716494">uintptr</span><span class="op" id="1716501">)</span><span class="op" id="1716502">(</span><span class="ident" id="1716503">unsafe</span><span class="op" id="1716509">.</span><span class="ident" id="1716510">Pointer</span><span class="op" id="1716517">(</span><span class="ident" id="1716518">frame</span><span class="op" id="1716523">.</span><span class="ident" id="1716524">sp</span><span class="op" id="1716526">)</span><span class="op" id="1716527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1716533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1716538">}</span>&nbsp;<span class="keyword" id="1716540">else</span>&nbsp;<span class="op" id="1716545">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1716551">if</span>&nbsp;<span class="ident" id="1716554">frame</span><span class="op" id="1716559">.</span><span class="ident" id="1716560">lr</span>&nbsp;<span class="op" id="1716563">==</span>&nbsp;<span class="num" id="1716566">0</span>&nbsp;<span class="op" id="1716568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1716575">frame</span><span class="op" id="1716580">.</span><span class="ident" id="1716581">lr</span>&nbsp;<span class="op" id="1716584">=</span>&nbsp;<span class="builtintype" id="1716586">uintptr</span><span class="op" id="1716593">(</span><span class="op" id="1716594">*</span><span class="op" id="1716595">(</span><span class="op" id="1716596">*</span><span class="ident" id="1716597">uintreg</span><span class="op" id="1716604">)</span><span class="op" id="1716605">(</span><span class="ident" id="1716606">unsafe</span><span class="op" id="1716612">.</span><span class="ident" id="1716613">Pointer</span><span class="op" id="1716620">(</span><span class="ident" id="1716621">frame</span><span class="op" id="1716626">.</span><span class="ident" id="1716627">fp</span>&nbsp;<span class="op" id="1716630">-</span>&nbsp;<span class="ident" id="1716632">regSize</span><span class="op" id="1716639">)</span><span class="op" id="1716640">)</span><span class="op" id="1716641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1716647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1716652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1716657">flr</span>&nbsp;<span class="op" id="1716661">=</span>&nbsp;<span class="ident" id="1716663">findfunc</span><span class="op" id="1716671">(</span><span class="ident" id="1716672">frame</span><span class="op" id="1716677">.</span><span class="ident" id="1716678">lr</span><span class="op" id="1716680">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1716685">if</span>&nbsp;<span class="ident" id="1716688">flr</span>&nbsp;<span class="op" id="1716692">==</span>&nbsp;<span class="ident" id="1716695">nil</span>&nbsp;<span class="op" id="1716699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716705">//&nbsp;This&nbsp;happens&nbsp;if&nbsp;you&nbsp;get&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;at&nbsp;just&nbsp;the&nbsp;wrong&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716782">//&nbsp;In&nbsp;that&nbsp;context&nbsp;it&nbsp;is&nbsp;okay&nbsp;to&nbsp;stop&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716831">//&nbsp;But&nbsp;if&nbsp;callback&nbsp;is&nbsp;set,&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;and&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1716904">//&nbsp;get&nbsp;everything,&nbsp;so&nbsp;crash&nbsp;loudly.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1716944">if</span>&nbsp;<span class="ident" id="1716947">callback</span>&nbsp;<span class="op" id="1716956">!=</span>&nbsp;<span class="ident" id="1716959">nil</span>&nbsp;<span class="op" id="1716963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1716970">print</span><span class="op" id="1716975">(</span><span class="string" id="1716976">&#34;runtime:&nbsp;unexpected&nbsp;return&nbsp;pc&nbsp;for&nbsp;&#34;</span><span class="op" id="1717012">,</span>&nbsp;<span class="ident" id="1717014">gofuncname</span><span class="op" id="1717024">(</span><span class="ident" id="1717025">f</span><span class="op" id="1717026">)</span><span class="op" id="1717027">,</span>&nbsp;<span class="string" id="1717029">&#34;&nbsp;called&nbsp;from&nbsp;&#34;</span><span class="op" id="1717044">,</span>&nbsp;<span class="ident" id="1717046">hex</span><span class="op" id="1717049">(</span><span class="ident" id="1717050">frame</span><span class="op" id="1717055">.</span><span class="ident" id="1717056">lr</span><span class="op" id="1717058">)</span><span class="op" id="1717059">,</span>&nbsp;<span class="string" id="1717061">&#34;\n&#34;</span><span class="op" id="1717065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1717072">gothrow</span><span class="op" id="1717079">(</span><span class="string" id="1717080">&#34;unknown&nbsp;caller&nbsp;pc&#34;</span><span class="op" id="1717099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1717105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1717110">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1717114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1717119">frame</span><span class="op" id="1717124">.</span><span class="ident" id="1717125">varp</span>&nbsp;<span class="op" id="1717130">=</span>&nbsp;<span class="ident" id="1717132">frame</span><span class="op" id="1717137">.</span><span class="ident" id="1717138">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1717143">if</span>&nbsp;<span class="op" id="1717146">!</span><span class="ident" id="1717147">usesLR</span>&nbsp;<span class="op" id="1717154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717159">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1717237">frame</span><span class="op" id="1717242">.</span><span class="ident" id="1717243">varp</span>&nbsp;<span class="op" id="1717248">-=</span>&nbsp;<span class="ident" id="1717251">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1717261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717266">//&nbsp;Derive&nbsp;size&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717297">//&nbsp;Most&nbsp;functions&nbsp;have&nbsp;a&nbsp;fixed-size&nbsp;argument&nbsp;block,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717351">//&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;metadata&nbsp;about&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717401">//&nbsp;Not&nbsp;all,&nbsp;though:&nbsp;there&nbsp;are&nbsp;some&nbsp;variadic&nbsp;functions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717457">//&nbsp;in&nbsp;package&nbsp;runtime&nbsp;and&nbsp;reflect,&nbsp;and&nbsp;for&nbsp;those&nbsp;we&nbsp;use&nbsp;call-specific</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717529">//&nbsp;metadata&nbsp;recorded&nbsp;by&nbsp;f&#39;s&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1717567">if</span>&nbsp;<span class="ident" id="1717570">callback</span>&nbsp;<span class="op" id="1717579">!=</span>&nbsp;<span class="ident" id="1717582">nil</span>&nbsp;<span class="op" id="1717586">||</span>&nbsp;<span class="ident" id="1717589">printing</span>&nbsp;<span class="op" id="1717598">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1717603">frame</span><span class="op" id="1717608">.</span><span class="ident" id="1717609">argp</span>&nbsp;<span class="op" id="1717614">=</span>&nbsp;<span class="ident" id="1717616">frame</span><span class="op" id="1717621">.</span><span class="ident" id="1717622">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1717628">if</span>&nbsp;<span class="ident" id="1717631">usesLR</span>&nbsp;<span class="op" id="1717638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1717644">frame</span><span class="op" id="1717649">.</span><span class="ident" id="1717650">argp</span>&nbsp;<span class="op" id="1717655">+=</span>&nbsp;<span class="ident" id="1717658">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1717669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1717674">setArgInfo</span><span class="op" id="1717684">(</span><span class="op" id="1717685">&amp;</span><span class="ident" id="1717686">frame</span><span class="op" id="1717691">,</span>&nbsp;<span class="ident" id="1717693">f</span><span class="op" id="1717694">,</span>&nbsp;<span class="ident" id="1717696">callback</span>&nbsp;<span class="op" id="1717705">!=</span>&nbsp;<span class="ident" id="1717708">nil</span><span class="op" id="1717711">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1717715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717720">//&nbsp;Determine&nbsp;function&nbsp;SP&nbsp;where&nbsp;deferproc&nbsp;would&nbsp;find&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1717789">var</span>&nbsp;<span class="ident" id="1717793">sparg</span>&nbsp;<span class="builtintype" id="1717799">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1717809">if</span>&nbsp;<span class="ident" id="1717812">usesLR</span>&nbsp;<span class="op" id="1717819">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717824">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack&nbsp;plus&nbsp;1&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717910">//&nbsp;for&nbsp;the&nbsp;saved&nbsp;LR.&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1717996">//&nbsp;however,&nbsp;the&nbsp;SP&nbsp;is&nbsp;three&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718052">//&nbsp;If&nbsp;the&nbsp;function&nbsp;has&nbsp;no&nbsp;frame&nbsp;at&nbsp;all&nbsp;-&nbsp;perhaps&nbsp;it&nbsp;just&nbsp;started,&nbsp;or&nbsp;perhaps</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718132">//&nbsp;it&nbsp;is&nbsp;a&nbsp;leaf&nbsp;with&nbsp;no&nbsp;local&nbsp;variables&nbsp;-&nbsp;then&nbsp;we&nbsp;cannot&nbsp;possibly&nbsp;find&nbsp;its</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718210">//&nbsp;SP&nbsp;in&nbsp;a&nbsp;defer,&nbsp;and&nbsp;we&nbsp;might&nbsp;confuse&nbsp;its&nbsp;SP&nbsp;for&nbsp;its&nbsp;caller&#39;s&nbsp;SP,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718283">//&nbsp;leave&nbsp;sparg=0&nbsp;in&nbsp;that&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1718317">if</span>&nbsp;<span class="ident" id="1718320">frame</span><span class="op" id="1718325">.</span><span class="ident" id="1718326">fp</span>&nbsp;<span class="op" id="1718329">!=</span>&nbsp;<span class="ident" id="1718332">frame</span><span class="op" id="1718337">.</span><span class="ident" id="1718338">sp</span>&nbsp;<span class="op" id="1718341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1718347">sparg</span>&nbsp;<span class="op" id="1718353">=</span>&nbsp;<span class="ident" id="1718355">frame</span><span class="op" id="1718360">.</span><span class="ident" id="1718361">sp</span>&nbsp;<span class="op" id="1718364">+</span>&nbsp;<span class="ident" id="1718366">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1718378">if</span>&nbsp;<span class="ident" id="1718381">wasnewproc</span>&nbsp;<span class="op" id="1718392">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1718399">sparg</span>&nbsp;<span class="op" id="1718405">+=</span>&nbsp;<span class="num" id="1718408">3</span>&nbsp;<span class="op" id="1718410">*</span>&nbsp;<span class="ident" id="1718412">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1718424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1718429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1718433">}</span>&nbsp;<span class="keyword" id="1718435">else</span>&nbsp;<span class="op" id="1718440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718445">//&nbsp;On&nbsp;x86&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack,&nbsp;so&nbsp;SP&nbsp;exactly.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718510">//&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,&nbsp;however,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718587">//&nbsp;the&nbsp;SP&nbsp;is&nbsp;two&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1718632">sparg</span>&nbsp;<span class="op" id="1718638">=</span>&nbsp;<span class="ident" id="1718640">frame</span><span class="op" id="1718645">.</span><span class="ident" id="1718646">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1718652">if</span>&nbsp;<span class="ident" id="1718655">wasnewproc</span>&nbsp;<span class="op" id="1718666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1718672">sparg</span>&nbsp;<span class="op" id="1718678">+=</span>&nbsp;<span class="num" id="1718681">2</span>&nbsp;<span class="op" id="1718683">*</span>&nbsp;<span class="ident" id="1718685">ptrSize</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1718696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1718700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718705">//&nbsp;Determine&nbsp;frame&#39;s&nbsp;&#39;continuation&nbsp;PC&#39;,&nbsp;where&nbsp;it&nbsp;can&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718770">//&nbsp;Normally&nbsp;this&nbsp;is&nbsp;the&nbsp;return&nbsp;address&nbsp;on&nbsp;the&nbsp;stack,&nbsp;but&nbsp;if&nbsp;sigpanic</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718841">//&nbsp;is&nbsp;immediately&nbsp;below&nbsp;this&nbsp;function&nbsp;on&nbsp;the&nbsp;stack,&nbsp;then&nbsp;the&nbsp;frame</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718910">//&nbsp;stopped&nbsp;executing&nbsp;due&nbsp;to&nbsp;a&nbsp;trap,&nbsp;and&nbsp;frame.pc&nbsp;is&nbsp;probably&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1718977">//&nbsp;a&nbsp;safe&nbsp;point&nbsp;for&nbsp;looking&nbsp;up&nbsp;liveness&nbsp;information.&nbsp;In&nbsp;this&nbsp;panicking&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1719056">//&nbsp;the&nbsp;function&nbsp;either&nbsp;doesn&#39;t&nbsp;return&nbsp;at&nbsp;all&nbsp;(if&nbsp;it&nbsp;has&nbsp;no&nbsp;defers&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1719134">//&nbsp;defers&nbsp;do&nbsp;not&nbsp;recover)&nbsp;or&nbsp;it&nbsp;returns&nbsp;from&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;to</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1719201">//&nbsp;deferproc&nbsp;a&nbsp;second&nbsp;time&nbsp;(if&nbsp;the&nbsp;corresponding&nbsp;deferred&nbsp;func&nbsp;recovers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1719277">//&nbsp;It&nbsp;suffices&nbsp;to&nbsp;assume&nbsp;that&nbsp;the&nbsp;most&nbsp;recent&nbsp;deferproc&nbsp;is&nbsp;the&nbsp;one&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1719351">//&nbsp;returns;&nbsp;everything&nbsp;live&nbsp;at&nbsp;earlier&nbsp;deferprocs&nbsp;is&nbsp;still&nbsp;live&nbsp;at&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1719430">frame</span><span class="op" id="1719435">.</span><span class="ident" id="1719436">continpc</span>&nbsp;<span class="op" id="1719445">=</span>&nbsp;<span class="ident" id="1719447">frame</span><span class="op" id="1719452">.</span><span class="ident" id="1719453">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719458">if</span>&nbsp;<span class="ident" id="1719461">waspanic</span>&nbsp;<span class="op" id="1719470">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719475">if</span>&nbsp;<span class="ident" id="1719478">_defer</span>&nbsp;<span class="op" id="1719485">!=</span>&nbsp;<span class="ident" id="1719488">nil</span>&nbsp;<span class="op" id="1719492">&amp;&amp;</span>&nbsp;<span class="ident" id="1719495">_defer</span><span class="op" id="1719501">.</span><span class="ident" id="1719502">argp</span>&nbsp;<span class="op" id="1719507">==</span>&nbsp;<span class="ident" id="1719510">sparg</span>&nbsp;<span class="op" id="1719516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1719522">frame</span><span class="op" id="1719527">.</span><span class="ident" id="1719528">continpc</span>&nbsp;<span class="op" id="1719537">=</span>&nbsp;<span class="ident" id="1719539">_defer</span><span class="op" id="1719545">.</span><span class="ident" id="1719546">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719552">}</span>&nbsp;<span class="keyword" id="1719554">else</span>&nbsp;<span class="op" id="1719559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1719565">frame</span><span class="op" id="1719570">.</span><span class="ident" id="1719571">continpc</span>&nbsp;<span class="op" id="1719580">=</span>&nbsp;<span class="num" id="1719582">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719587">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1719596">//&nbsp;Unwind&nbsp;our&nbsp;local&nbsp;defer&nbsp;stack&nbsp;past&nbsp;this&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719647">for</span>&nbsp;<span class="ident" id="1719651">_defer</span>&nbsp;<span class="op" id="1719658">!=</span>&nbsp;<span class="ident" id="1719661">nil</span>&nbsp;<span class="op" id="1719665">&amp;&amp;</span>&nbsp;<span class="op" id="1719668">(</span><span class="ident" id="1719669">_defer</span><span class="op" id="1719675">.</span><span class="ident" id="1719676">argp</span>&nbsp;<span class="op" id="1719681">==</span>&nbsp;<span class="ident" id="1719684">sparg</span>&nbsp;<span class="op" id="1719690">||</span>&nbsp;<span class="ident" id="1719693">_defer</span><span class="op" id="1719699">.</span><span class="ident" id="1719700">argp</span>&nbsp;<span class="op" id="1719705">==</span>&nbsp;<span class="ident" id="1719708">_NoArgs</span><span class="op" id="1719715">)</span>&nbsp;<span class="op" id="1719717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1719722">_defer</span>&nbsp;<span class="op" id="1719729">=</span>&nbsp;<span class="ident" id="1719731">_defer</span><span class="op" id="1719737">.</span><span class="ident" id="1719738">link</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719750">if</span>&nbsp;<span class="ident" id="1719753">skip</span>&nbsp;<span class="op" id="1719758">&gt;</span>&nbsp;<span class="num" id="1719760">0</span>&nbsp;<span class="op" id="1719762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1719767">skip</span><span class="op" id="1719771">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719777">goto</span>&nbsp;<span class="ident" id="1719782">skipped</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719797">if</span>&nbsp;<span class="ident" id="1719800">pcbuf</span>&nbsp;<span class="op" id="1719806">!=</span>&nbsp;<span class="ident" id="1719809">nil</span>&nbsp;<span class="op" id="1719813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719818">(</span><span class="op" id="1719819">*</span><span class="op" id="1719820">[</span><span class="num" id="1719821">1</span>&nbsp;<span class="op" id="1719823">&lt;&lt;</span>&nbsp;<span class="num" id="1719826">20</span><span class="op" id="1719828">]</span><span class="builtintype" id="1719829">uintptr</span><span class="op" id="1719836">)</span><span class="op" id="1719837">(</span><span class="ident" id="1719838">unsafe</span><span class="op" id="1719844">.</span><span class="ident" id="1719845">Pointer</span><span class="op" id="1719852">(</span><span class="ident" id="1719853">pcbuf</span><span class="op" id="1719858">)</span><span class="op" id="1719859">)</span><span class="op" id="1719860">[</span><span class="ident" id="1719861">n</span><span class="op" id="1719862">]</span>&nbsp;<span class="op" id="1719864">=</span>&nbsp;<span class="ident" id="1719866">frame</span><span class="op" id="1719871">.</span><span class="ident" id="1719872">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719877">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719881">if</span>&nbsp;<span class="ident" id="1719884">callback</span>&nbsp;<span class="op" id="1719893">!=</span>&nbsp;<span class="ident" id="1719896">nil</span>&nbsp;<span class="op" id="1719900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719905">if</span>&nbsp;<span class="op" id="1719908">!</span><span class="ident" id="1719909">callback</span><span class="op" id="1719917">(</span><span class="op" id="1719918">(</span><span class="op" id="1719919">*</span><span class="ident" id="1719920">stkframe</span><span class="op" id="1719928">)</span><span class="op" id="1719929">(</span><span class="ident" id="1719930">noescape</span><span class="op" id="1719938">(</span><span class="ident" id="1719939">unsafe</span><span class="op" id="1719945">.</span><span class="ident" id="1719946">Pointer</span><span class="op" id="1719953">(</span><span class="op" id="1719954">&amp;</span><span class="ident" id="1719955">frame</span><span class="op" id="1719960">)</span><span class="op" id="1719961">)</span><span class="op" id="1719962">)</span><span class="op" id="1719963">,</span>&nbsp;<span class="ident" id="1719965">v</span><span class="op" id="1719966">)</span>&nbsp;<span class="op" id="1719968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719974">return</span>&nbsp;<span class="ident" id="1719981">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1719990">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1719994">if</span>&nbsp;<span class="ident" id="1719997">printing</span>&nbsp;<span class="op" id="1720006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720011">if</span>&nbsp;<span class="op" id="1720014">(</span><span class="ident" id="1720015">flags</span><span class="op" id="1720020">&amp;</span><span class="ident" id="1720021">_TraceRuntimeFrames</span><span class="op" id="1720040">)</span>&nbsp;<span class="op" id="1720042">!=</span>&nbsp;<span class="num" id="1720045">0</span>&nbsp;<span class="op" id="1720047">||</span>&nbsp;<span class="ident" id="1720050">showframe</span><span class="op" id="1720059">(</span><span class="ident" id="1720060">f</span><span class="op" id="1720061">,</span>&nbsp;<span class="ident" id="1720063">gp</span><span class="op" id="1720065">)</span>&nbsp;<span class="op" id="1720067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1720073">//&nbsp;Print&nbsp;during&nbsp;crash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1720100">//&nbsp;&nbsp;&nbsp;&nbsp;main(0x1,&nbsp;0x2,&nbsp;0x3)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1720127">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/home/rsc/go/src/runtime/x.go:23&nbsp;+0xf</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1720173">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720180">tracepc</span>&nbsp;<span class="op" id="1720188">:=</span>&nbsp;<span class="ident" id="1720191">frame</span><span class="op" id="1720196">.</span><span class="ident" id="1720197">pc</span>&nbsp;<span class="comment" id="1720200">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720249">if</span>&nbsp;<span class="op" id="1720252">(</span><span class="ident" id="1720253">n</span>&nbsp;<span class="op" id="1720255">&gt;</span>&nbsp;<span class="num" id="1720257">0</span>&nbsp;<span class="op" id="1720259">||</span>&nbsp;<span class="ident" id="1720262">flags</span><span class="op" id="1720267">&amp;</span><span class="ident" id="1720268">_TraceTrap</span>&nbsp;<span class="op" id="1720279">==</span>&nbsp;<span class="num" id="1720282">0</span><span class="op" id="1720283">)</span>&nbsp;<span class="op" id="1720285">&amp;&amp;</span>&nbsp;<span class="ident" id="1720288">frame</span><span class="op" id="1720293">.</span><span class="ident" id="1720294">pc</span>&nbsp;<span class="op" id="1720297">&gt;</span>&nbsp;<span class="ident" id="1720299">f</span><span class="op" id="1720300">.</span><span class="ident" id="1720301">entry</span>&nbsp;<span class="op" id="1720307">&amp;&amp;</span>&nbsp;<span class="op" id="1720310">!</span><span class="ident" id="1720311">waspanic</span>&nbsp;<span class="op" id="1720320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720327">tracepc</span><span class="op" id="1720334">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720341">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720347">print</span><span class="op" id="1720352">(</span><span class="ident" id="1720353">gofuncname</span><span class="op" id="1720363">(</span><span class="ident" id="1720364">f</span><span class="op" id="1720365">)</span><span class="op" id="1720366">,</span>&nbsp;<span class="string" id="1720368">&#34;(&#34;</span><span class="op" id="1720371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720377">argp</span>&nbsp;<span class="op" id="1720382">:=</span>&nbsp;<span class="op" id="1720385">(</span><span class="op" id="1720386">*</span><span class="op" id="1720387">[</span><span class="num" id="1720388">100</span><span class="op" id="1720391">]</span><span class="builtintype" id="1720392">uintptr</span><span class="op" id="1720399">)</span><span class="op" id="1720400">(</span><span class="ident" id="1720401">unsafe</span><span class="op" id="1720407">.</span><span class="ident" id="1720408">Pointer</span><span class="op" id="1720415">(</span><span class="ident" id="1720416">frame</span><span class="op" id="1720421">.</span><span class="ident" id="1720422">argp</span><span class="op" id="1720426">)</span><span class="op" id="1720427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720433">for</span>&nbsp;<span class="ident" id="1720437">i</span>&nbsp;<span class="op" id="1720439">:=</span>&nbsp;<span class="builtintype" id="1720442">uintptr</span><span class="op" id="1720449">(</span><span class="num" id="1720450">0</span><span class="op" id="1720451">)</span><span class="op" id="1720452">;</span>&nbsp;<span class="ident" id="1720454">i</span>&nbsp;<span class="op" id="1720456">&lt;</span>&nbsp;<span class="ident" id="1720458">frame</span><span class="op" id="1720463">.</span><span class="ident" id="1720464">arglen</span><span class="op" id="1720470">/</span><span class="ident" id="1720471">ptrSize</span><span class="op" id="1720478">;</span>&nbsp;<span class="ident" id="1720480">i</span><span class="op" id="1720481">++</span>&nbsp;<span class="op" id="1720484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720491">if</span>&nbsp;<span class="ident" id="1720494">i</span>&nbsp;<span class="op" id="1720496">&gt;=</span>&nbsp;<span class="num" id="1720499">10</span>&nbsp;<span class="op" id="1720502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720510">print</span><span class="op" id="1720515">(</span><span class="string" id="1720516">&#34;,&nbsp;...&#34;</span><span class="op" id="1720523">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720531">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720549">if</span>&nbsp;<span class="ident" id="1720552">i</span>&nbsp;<span class="op" id="1720554">!=</span>&nbsp;<span class="num" id="1720557">0</span>&nbsp;<span class="op" id="1720559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720567">print</span><span class="op" id="1720572">(</span><span class="string" id="1720573">&#34;,&nbsp;&#34;</span><span class="op" id="1720577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720584">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720591">print</span><span class="op" id="1720596">(</span><span class="ident" id="1720597">hex</span><span class="op" id="1720600">(</span><span class="ident" id="1720601">argp</span><span class="op" id="1720605">[</span><span class="ident" id="1720606">i</span><span class="op" id="1720607">]</span><span class="op" id="1720608">)</span><span class="op" id="1720609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720621">print</span><span class="op" id="1720626">(</span><span class="string" id="1720627">&#34;)\n&#34;</span><span class="op" id="1720632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720638">var</span>&nbsp;<span class="ident" id="1720642">file</span>&nbsp;<span class="builtintype" id="1720647">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720658">line</span>&nbsp;<span class="op" id="1720663">:=</span>&nbsp;<span class="ident" id="1720666">funcline</span><span class="op" id="1720674">(</span><span class="ident" id="1720675">f</span><span class="op" id="1720676">,</span>&nbsp;<span class="ident" id="1720678">tracepc</span><span class="op" id="1720685">,</span>&nbsp;<span class="op" id="1720687">&amp;</span><span class="ident" id="1720688">file</span><span class="op" id="1720692">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720698">print</span><span class="op" id="1720703">(</span><span class="string" id="1720704">&#34;\t&#34;</span><span class="op" id="1720708">,</span>&nbsp;<span class="ident" id="1720710">file</span><span class="op" id="1720714">,</span>&nbsp;<span class="string" id="1720716">&#34;:&#34;</span><span class="op" id="1720719">,</span>&nbsp;<span class="ident" id="1720721">line</span><span class="op" id="1720725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720731">if</span>&nbsp;<span class="ident" id="1720734">frame</span><span class="op" id="1720739">.</span><span class="ident" id="1720740">pc</span>&nbsp;<span class="op" id="1720743">&gt;</span>&nbsp;<span class="ident" id="1720745">f</span><span class="op" id="1720746">.</span><span class="ident" id="1720747">entry</span>&nbsp;<span class="op" id="1720753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720760">print</span><span class="op" id="1720765">(</span><span class="string" id="1720766">&#34;&nbsp;+&#34;</span><span class="op" id="1720770">,</span>&nbsp;<span class="ident" id="1720772">hex</span><span class="op" id="1720775">(</span><span class="ident" id="1720776">frame</span><span class="op" id="1720781">.</span><span class="ident" id="1720782">pc</span><span class="op" id="1720784">-</span><span class="ident" id="1720785">f</span><span class="op" id="1720786">.</span><span class="ident" id="1720787">entry</span><span class="op" id="1720792">)</span><span class="op" id="1720793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1720805">if</span>&nbsp;<span class="ident" id="1720808">g</span><span class="op" id="1720809">.</span><span class="ident" id="1720810">m</span><span class="op" id="1720811">.</span><span class="ident" id="1720812">throwing</span>&nbsp;<span class="op" id="1720821">&gt;</span>&nbsp;<span class="num" id="1720823">0</span>&nbsp;<span class="op" id="1720825">&amp;&amp;</span>&nbsp;<span class="ident" id="1720828">gp</span>&nbsp;<span class="op" id="1720831">==</span>&nbsp;<span class="ident" id="1720834">g</span><span class="op" id="1720835">.</span><span class="ident" id="1720836">m</span><span class="op" id="1720837">.</span><span class="ident" id="1720838">curg</span>&nbsp;<span class="op" id="1720843">||</span>&nbsp;<span class="ident" id="1720846">gotraceback</span>&nbsp;<span class="op" id="1720858">&gt;=</span>&nbsp;<span class="num" id="1720861">2</span>&nbsp;<span class="op" id="1720863">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720870">print</span><span class="op" id="1720875">(</span><span class="string" id="1720876">&#34;&nbsp;fp=&#34;</span><span class="op" id="1720882">,</span>&nbsp;<span class="ident" id="1720884">hex</span><span class="op" id="1720887">(</span><span class="ident" id="1720888">frame</span><span class="op" id="1720893">.</span><span class="ident" id="1720894">fp</span><span class="op" id="1720896">)</span><span class="op" id="1720897">,</span>&nbsp;<span class="string" id="1720899">&#34;&nbsp;sp=&#34;</span><span class="op" id="1720905">,</span>&nbsp;<span class="ident" id="1720907">hex</span><span class="op" id="1720910">(</span><span class="ident" id="1720911">frame</span><span class="op" id="1720916">.</span><span class="ident" id="1720917">sp</span><span class="op" id="1720919">)</span><span class="op" id="1720920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1720932">print</span><span class="op" id="1720937">(</span><span class="string" id="1720938">&#34;\n&#34;</span><span class="op" id="1720942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720948">nprint</span><span class="op" id="1720954">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720960">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1720964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720968">n</span><span class="op" id="1720969">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720974">skipped</span><span class="op" id="1720981">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1720985">waspanic</span>&nbsp;<span class="op" id="1720994">=</span>&nbsp;<span class="ident" id="1720996">f</span><span class="op" id="1720997">.</span><span class="ident" id="1720998">entry</span>&nbsp;<span class="op" id="1721004">==</span>&nbsp;<span class="ident" id="1721007">sigpanicPC</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721020">wasnewproc</span>&nbsp;<span class="op" id="1721031">=</span>&nbsp;<span class="ident" id="1721033">f</span><span class="op" id="1721034">.</span><span class="ident" id="1721035">entry</span>&nbsp;<span class="op" id="1721041">==</span>&nbsp;<span class="ident" id="1721044">newprocPC</span>&nbsp;<span class="op" id="1721054">||</span>&nbsp;<span class="ident" id="1721057">f</span><span class="op" id="1721058">.</span><span class="ident" id="1721059">entry</span>&nbsp;<span class="op" id="1721065">==</span>&nbsp;<span class="ident" id="1721068">deferprocPC</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721083">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;past&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1721132">if</span>&nbsp;<span class="ident" id="1721135">flr</span>&nbsp;<span class="op" id="1721139">==</span>&nbsp;<span class="ident" id="1721142">nil</span>&nbsp;<span class="op" id="1721146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1721151">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1721159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721164">//&nbsp;Unwind&nbsp;to&nbsp;next&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721191">frame</span><span class="op" id="1721196">.</span><span class="ident" id="1721197">fn</span>&nbsp;<span class="op" id="1721200">=</span>&nbsp;<span class="ident" id="1721202">flr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721208">frame</span><span class="op" id="1721213">.</span><span class="ident" id="1721214">pc</span>&nbsp;<span class="op" id="1721217">=</span>&nbsp;<span class="ident" id="1721219">frame</span><span class="op" id="1721224">.</span><span class="ident" id="1721225">lr</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721230">frame</span><span class="op" id="1721235">.</span><span class="ident" id="1721236">lr</span>&nbsp;<span class="op" id="1721239">=</span>&nbsp;<span class="num" id="1721241">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721245">frame</span><span class="op" id="1721250">.</span><span class="ident" id="1721251">sp</span>&nbsp;<span class="op" id="1721254">=</span>&nbsp;<span class="ident" id="1721256">frame</span><span class="op" id="1721261">.</span><span class="ident" id="1721262">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721267">frame</span><span class="op" id="1721272">.</span><span class="ident" id="1721273">fp</span>&nbsp;<span class="op" id="1721276">=</span>&nbsp;<span class="num" id="1721278">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721282">frame</span><span class="op" id="1721287">.</span><span class="ident" id="1721288">argmap</span>&nbsp;<span class="op" id="1721295">=</span>&nbsp;<span class="ident" id="1721297">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721304">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;sighandler&nbsp;saves&nbsp;the&nbsp;LR&nbsp;on&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721374">//&nbsp;before&nbsp;faking&nbsp;a&nbsp;call&nbsp;to&nbsp;sigpanic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1721413">if</span>&nbsp;<span class="ident" id="1721416">usesLR</span>&nbsp;<span class="op" id="1721423">&amp;&amp;</span>&nbsp;<span class="ident" id="1721426">waspanic</span>&nbsp;<span class="op" id="1721435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721440">x</span>&nbsp;<span class="op" id="1721442">:=</span>&nbsp;<span class="op" id="1721445">*</span><span class="op" id="1721446">(</span><span class="op" id="1721447">*</span><span class="builtintype" id="1721448">uintptr</span><span class="op" id="1721455">)</span><span class="op" id="1721456">(</span><span class="ident" id="1721457">unsafe</span><span class="op" id="1721463">.</span><span class="ident" id="1721464">Pointer</span><span class="op" id="1721471">(</span><span class="ident" id="1721472">frame</span><span class="op" id="1721477">.</span><span class="ident" id="1721478">sp</span><span class="op" id="1721480">)</span><span class="op" id="1721481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721486">frame</span><span class="op" id="1721491">.</span><span class="ident" id="1721492">sp</span>&nbsp;<span class="op" id="1721495">+=</span>&nbsp;<span class="ident" id="1721498">ptrSize</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721509">f</span>&nbsp;<span class="op" id="1721511">=</span>&nbsp;<span class="ident" id="1721513">findfunc</span><span class="op" id="1721521">(</span><span class="ident" id="1721522">frame</span><span class="op" id="1721527">.</span><span class="ident" id="1721528">pc</span><span class="op" id="1721530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721535">frame</span><span class="op" id="1721540">.</span><span class="ident" id="1721541">fn</span>&nbsp;<span class="op" id="1721544">=</span>&nbsp;<span class="ident" id="1721546">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1721551">if</span>&nbsp;<span class="ident" id="1721554">f</span>&nbsp;<span class="op" id="1721556">==</span>&nbsp;<span class="ident" id="1721559">nil</span>&nbsp;<span class="op" id="1721563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721569">frame</span><span class="op" id="1721574">.</span><span class="ident" id="1721575">pc</span>&nbsp;<span class="op" id="1721578">=</span>&nbsp;<span class="ident" id="1721580">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1721585">}</span>&nbsp;<span class="keyword" id="1721587">else</span>&nbsp;<span class="keyword" id="1721592">if</span>&nbsp;<span class="ident" id="1721595">f</span><span class="op" id="1721596">.</span><span class="ident" id="1721597">frame</span>&nbsp;<span class="op" id="1721603">==</span>&nbsp;<span class="num" id="1721606">0</span>&nbsp;<span class="op" id="1721608">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721614">frame</span><span class="op" id="1721619">.</span><span class="ident" id="1721620">lr</span>&nbsp;<span class="op" id="1721623">=</span>&nbsp;<span class="ident" id="1721625">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1721630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1721634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1721637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1721641">if</span>&nbsp;<span class="ident" id="1721644">pcbuf</span>&nbsp;<span class="op" id="1721650">==</span>&nbsp;<span class="ident" id="1721653">nil</span>&nbsp;<span class="op" id="1721657">&amp;&amp;</span>&nbsp;<span class="ident" id="1721660">callback</span>&nbsp;<span class="op" id="1721669">==</span>&nbsp;<span class="ident" id="1721672">nil</span>&nbsp;<span class="op" id="1721676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1721680">n</span>&nbsp;<span class="op" id="1721682">=</span>&nbsp;<span class="ident" id="1721684">nprint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1721692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721696">//&nbsp;If&nbsp;callback&nbsp;!=&nbsp;nil,&nbsp;we&#39;re&nbsp;being&nbsp;called&nbsp;to&nbsp;gather&nbsp;stack&nbsp;information&nbsp;during</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721774">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth.&nbsp;In&nbsp;that&nbsp;context,&nbsp;require&nbsp;that&nbsp;we&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721852">//&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;not,&nbsp;then&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;somewhere&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1721929">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth&nbsp;may&nbsp;not&nbsp;have&nbsp;seen&nbsp;the&nbsp;correct&nbsp;picture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722006">//&nbsp;of&nbsp;the&nbsp;stack.&nbsp;Crash&nbsp;now&nbsp;instead&nbsp;of&nbsp;silently&nbsp;executing&nbsp;the&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722087">//&nbsp;or&nbsp;stack&nbsp;copy&nbsp;incorrectly&nbsp;and&nbsp;setting&nbsp;up&nbsp;for&nbsp;a&nbsp;mysterious&nbsp;crash&nbsp;later.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722162">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722166">//&nbsp;Note&nbsp;that&nbsp;panic&nbsp;!=&nbsp;nil&nbsp;is&nbsp;okay&nbsp;here:&nbsp;there&nbsp;can&nbsp;be&nbsp;leftover&nbsp;panics,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722237">//&nbsp;because&nbsp;the&nbsp;defers&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;do&nbsp;not&nbsp;nest&nbsp;in&nbsp;frame&nbsp;order&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722309">//&nbsp;they&nbsp;do&nbsp;on&nbsp;the&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;you&nbsp;have:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722354">//</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722358">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;1&nbsp;defers&nbsp;d1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722380">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;2&nbsp;defers&nbsp;d2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722402">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;3&nbsp;defers&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722424">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;4&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722443">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;4&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722485">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5,&nbsp;running&nbsp;d3,&nbsp;defers&nbsp;d4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722520">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722539">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722581">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;6,&nbsp;running&nbsp;d4,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722623">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;6,&nbsp;running&nbsp;d2,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722665">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722669">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d4,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d4&nbsp;-&gt;&nbsp;d3,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722736">//&nbsp;is&nbsp;nested&nbsp;properly,&nbsp;and&nbsp;we&#39;ll&nbsp;treat&nbsp;frame&nbsp;3&nbsp;as&nbsp;resumable,&nbsp;because&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722809">//&nbsp;can&nbsp;find&nbsp;d3.&nbsp;(And&nbsp;in&nbsp;fact&nbsp;frame&nbsp;3&nbsp;is&nbsp;resumable.&nbsp;If&nbsp;d4&nbsp;recovers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722876">//&nbsp;and&nbsp;frame&nbsp;5&nbsp;continues&nbsp;running,&nbsp;d3,&nbsp;d3&nbsp;can&nbsp;recover&nbsp;and&nbsp;we&#39;ll</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722940">//&nbsp;resume&nbsp;execution&nbsp;in&nbsp;(returning&nbsp;from)&nbsp;frame&nbsp;3.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722991">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1722995">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d2,&nbsp;however,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d2&nbsp;-&gt;&nbsp;d3,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723065">//&nbsp;which&nbsp;is&nbsp;inverted.&nbsp;The&nbsp;scan&nbsp;will&nbsp;match&nbsp;d2&nbsp;to&nbsp;frame&nbsp;2&nbsp;but&nbsp;having</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723133">//&nbsp;d2&nbsp;on&nbsp;the&nbsp;stack&nbsp;until&nbsp;then&nbsp;means&nbsp;it&nbsp;will&nbsp;not&nbsp;match&nbsp;d3&nbsp;to&nbsp;frame&nbsp;3.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723203">//&nbsp;This&nbsp;is&nbsp;okay:&nbsp;if&nbsp;we&#39;re&nbsp;running&nbsp;d2,&nbsp;then&nbsp;all&nbsp;the&nbsp;defers&nbsp;after&nbsp;d2&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723276">//&nbsp;completed&nbsp;and&nbsp;their&nbsp;corresponding&nbsp;frames&nbsp;are&nbsp;dead.&nbsp;Not&nbsp;finding&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723346">//&nbsp;for&nbsp;frame&nbsp;3&nbsp;means&nbsp;we&#39;ll&nbsp;set&nbsp;frame&nbsp;3&#39;s&nbsp;continpc&nbsp;==&nbsp;0,&nbsp;which&nbsp;is&nbsp;correct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723420">//&nbsp;(frame&nbsp;3&nbsp;is&nbsp;dead).&nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;walk&nbsp;the&nbsp;panic&nbsp;stack&nbsp;can&nbsp;thus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723491">//&nbsp;contain&nbsp;defers&nbsp;(d3&nbsp;in&nbsp;this&nbsp;case)&nbsp;for&nbsp;dead&nbsp;frames.&nbsp;The&nbsp;inversion&nbsp;here</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723564">//&nbsp;always&nbsp;indicates&nbsp;a&nbsp;dead&nbsp;frame,&nbsp;and&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;inversion&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723638">//&nbsp;scan&nbsp;is&nbsp;to&nbsp;hide&nbsp;those&nbsp;dead&nbsp;frames,&nbsp;so&nbsp;the&nbsp;scan&nbsp;is&nbsp;still&nbsp;okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723704">//&nbsp;what&#39;s&nbsp;left&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;are&nbsp;exactly&nbsp;(and&nbsp;only)&nbsp;the&nbsp;dead&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723779">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723783">//&nbsp;We&nbsp;require&nbsp;callback&nbsp;!=&nbsp;nil&nbsp;here&nbsp;because&nbsp;only&nbsp;when&nbsp;callback&nbsp;!=&nbsp;nil</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723853">//&nbsp;do&nbsp;we&nbsp;know&nbsp;that&nbsp;gentraceback&nbsp;is&nbsp;being&nbsp;called&nbsp;in&nbsp;a&nbsp;&#34;must&nbsp;be&nbsp;correct&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723925">//&nbsp;context&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;&#34;best&nbsp;effort&#34;&nbsp;context.&nbsp;The&nbsp;tracebacks&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723996">//&nbsp;callbacks&nbsp;only&nbsp;happen&nbsp;when&nbsp;everything&nbsp;is&nbsp;stopped&nbsp;nicely.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724057">//&nbsp;At&nbsp;other&nbsp;times,&nbsp;such&nbsp;as&nbsp;when&nbsp;gathering&nbsp;a&nbsp;stack&nbsp;for&nbsp;a&nbsp;profiling&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724131">//&nbsp;or&nbsp;when&nbsp;printing&nbsp;a&nbsp;traceback&nbsp;during&nbsp;a&nbsp;crash,&nbsp;everything&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724202">//&nbsp;stopped&nbsp;nicely,&nbsp;and&nbsp;the&nbsp;stack&nbsp;walk&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;complete.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724270">//&nbsp;It&#39;s&nbsp;okay&nbsp;in&nbsp;those&nbsp;situations&nbsp;not&nbsp;to&nbsp;use&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724342">//&nbsp;incomplete&nbsp;information&nbsp;then&nbsp;is&nbsp;still&nbsp;better&nbsp;than&nbsp;nothing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724404">if</span>&nbsp;<span class="ident" id="1724407">callback</span>&nbsp;<span class="op" id="1724416">!=</span>&nbsp;<span class="ident" id="1724419">nil</span>&nbsp;<span class="op" id="1724423">&amp;&amp;</span>&nbsp;<span class="ident" id="1724426">n</span>&nbsp;<span class="op" id="1724428">&lt;</span>&nbsp;<span class="ident" id="1724430">max</span>&nbsp;<span class="op" id="1724434">&amp;&amp;</span>&nbsp;<span class="ident" id="1724437">_defer</span>&nbsp;<span class="op" id="1724444">!=</span>&nbsp;<span class="ident" id="1724447">nil</span>&nbsp;<span class="op" id="1724451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724455">if</span>&nbsp;<span class="ident" id="1724458">_defer</span>&nbsp;<span class="op" id="1724465">!=</span>&nbsp;<span class="ident" id="1724468">nil</span>&nbsp;<span class="op" id="1724472">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1724477">print</span><span class="op" id="1724482">(</span><span class="string" id="1724483">&#34;runtime:&nbsp;g&#34;</span><span class="op" id="1724495">,</span>&nbsp;<span class="ident" id="1724497">gp</span><span class="op" id="1724499">.</span><span class="ident" id="1724500">goid</span><span class="op" id="1724504">,</span>&nbsp;<span class="string" id="1724506">&#34;:&nbsp;leftover&nbsp;defer&nbsp;argp=&#34;</span><span class="op" id="1724530">,</span>&nbsp;<span class="ident" id="1724532">hex</span><span class="op" id="1724535">(</span><span class="ident" id="1724536">_defer</span><span class="op" id="1724542">.</span><span class="ident" id="1724543">argp</span><span class="op" id="1724547">)</span><span class="op" id="1724548">,</span>&nbsp;<span class="string" id="1724550">&#34;&nbsp;pc=&#34;</span><span class="op" id="1724556">,</span>&nbsp;<span class="ident" id="1724558">hex</span><span class="op" id="1724561">(</span><span class="ident" id="1724562">_defer</span><span class="op" id="1724568">.</span><span class="ident" id="1724569">pc</span><span class="op" id="1724571">)</span><span class="op" id="1724572">,</span>&nbsp;<span class="string" id="1724574">&#34;\n&#34;</span><span class="op" id="1724578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1724582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724586">for</span>&nbsp;<span class="ident" id="1724590">_defer</span>&nbsp;<span class="op" id="1724597">=</span>&nbsp;<span class="ident" id="1724599">gp</span><span class="op" id="1724601">.</span><span class="ident" id="1724602">_defer</span><span class="op" id="1724608">;</span>&nbsp;<span class="ident" id="1724610">_defer</span>&nbsp;<span class="op" id="1724617">!=</span>&nbsp;<span class="ident" id="1724620">nil</span><span class="op" id="1724623">;</span>&nbsp;<span class="ident" id="1724625">_defer</span>&nbsp;<span class="op" id="1724632">=</span>&nbsp;<span class="ident" id="1724634">_defer</span><span class="op" id="1724640">.</span><span class="ident" id="1724641">link</span>&nbsp;<span class="op" id="1724646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1724651">print</span><span class="op" id="1724656">(</span><span class="string" id="1724657">&#34;\tdefer&nbsp;&#34;</span><span class="op" id="1724667">,</span>&nbsp;<span class="ident" id="1724669">_defer</span><span class="op" id="1724675">,</span>&nbsp;<span class="string" id="1724677">&#34;&nbsp;argp=&#34;</span><span class="op" id="1724685">,</span>&nbsp;<span class="ident" id="1724687">hex</span><span class="op" id="1724690">(</span><span class="ident" id="1724691">_defer</span><span class="op" id="1724697">.</span><span class="ident" id="1724698">argp</span><span class="op" id="1724702">)</span><span class="op" id="1724703">,</span>&nbsp;<span class="string" id="1724705">&#34;&nbsp;pc=&#34;</span><span class="op" id="1724711">,</span>&nbsp;<span class="ident" id="1724713">hex</span><span class="op" id="1724716">(</span><span class="ident" id="1724717">_defer</span><span class="op" id="1724723">.</span><span class="ident" id="1724724">pc</span><span class="op" id="1724726">)</span><span class="op" id="1724727">,</span>&nbsp;<span class="string" id="1724729">&#34;\n&#34;</span><span class="op" id="1724733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1724737">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724741">gothrow</span><span class="op" id="1724748">(</span><span class="string" id="1724749">&#34;traceback&nbsp;has&nbsp;leftover&nbsp;defers&#34;</span><span class="op" id="1724780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1724783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724787">return</span>&nbsp;<span class="ident" id="1724794">n</span><br>
<span class="lineno"></span><span class="op" id="1724796">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1724799">func</span>&nbsp;<span class="ident" id="1724804">setArgInfo</span><span class="op" id="1724814">(</span><span class="ident" id="1724815">frame</span>&nbsp;<span class="op" id="1724821">*</span><span class="ident" id="1724822">stkframe</span><span class="op" id="1724830">,</span>&nbsp;<span class="ident" id="1724832">f</span>&nbsp;<span class="op" id="1724834">*</span><span class="ident" id="1724835">_func</span><span class="op" id="1724840">,</span>&nbsp;<span class="ident" id="1724842">needArgMap</span>&nbsp;<span class="builtintype" id="1724853">bool</span><span class="op" id="1724857">)</span>&nbsp;<span class="op" id="1724859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724862">frame</span><span class="op" id="1724867">.</span><span class="ident" id="1724868">arglen</span>&nbsp;<span class="op" id="1724875">=</span>&nbsp;<span class="builtintype" id="1724877">uintptr</span><span class="op" id="1724884">(</span><span class="ident" id="1724885">f</span><span class="op" id="1724886">.</span><span class="ident" id="1724887">args</span><span class="op" id="1724891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724894">if</span>&nbsp;<span class="ident" id="1724897">needArgMap</span>&nbsp;<span class="op" id="1724908">&amp;&amp;</span>&nbsp;<span class="ident" id="1724911">f</span><span class="op" id="1724912">.</span><span class="ident" id="1724913">args</span>&nbsp;<span class="op" id="1724918">==</span>&nbsp;<span class="ident" id="1724921">_ArgsSizeUnknown</span>&nbsp;<span class="op" id="1724938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724942">//&nbsp;Extract&nbsp;argument&nbsp;bitmaps&nbsp;for&nbsp;reflect&nbsp;stubs&nbsp;from&nbsp;the&nbsp;calls&nbsp;they&nbsp;made&nbsp;to&nbsp;reflect.</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725027">switch</span>&nbsp;<span class="ident" id="1725034">gofuncname</span><span class="op" id="1725044">(</span><span class="ident" id="1725045">f</span><span class="op" id="1725046">)</span>&nbsp;<span class="op" id="1725048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725052">case</span>&nbsp;<span class="string" id="1725057">&#34;reflect.makeFuncStub&#34;</span><span class="op" id="1725079">,</span>&nbsp;<span class="string" id="1725081">&#34;reflect.methodValueCall&#34;</span><span class="op" id="1725106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725111">arg0</span>&nbsp;<span class="op" id="1725116">:=</span>&nbsp;<span class="ident" id="1725119">frame</span><span class="op" id="1725124">.</span><span class="ident" id="1725125">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725131">if</span>&nbsp;<span class="ident" id="1725134">usesLR</span>&nbsp;<span class="op" id="1725141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725147">arg0</span>&nbsp;<span class="op" id="1725152">+=</span>&nbsp;<span class="ident" id="1725155">ptrSize</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725171">fn</span>&nbsp;<span class="op" id="1725174">:=</span>&nbsp;<span class="op" id="1725177">*</span><span class="op" id="1725178">(</span><span class="op" id="1725179">*</span><span class="op" id="1725180">*</span><span class="op" id="1725181">[</span><span class="num" id="1725182">2</span><span class="op" id="1725183">]</span><span class="builtintype" id="1725184">uintptr</span><span class="op" id="1725191">)</span><span class="op" id="1725192">(</span><span class="ident" id="1725193">unsafe</span><span class="op" id="1725199">.</span><span class="ident" id="1725200">Pointer</span><span class="op" id="1725207">(</span><span class="ident" id="1725208">arg0</span><span class="op" id="1725212">)</span><span class="op" id="1725213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725218">if</span>&nbsp;<span class="ident" id="1725221">fn</span><span class="op" id="1725223">[</span><span class="num" id="1725224">0</span><span class="op" id="1725225">]</span>&nbsp;<span class="op" id="1725227">!=</span>&nbsp;<span class="ident" id="1725230">f</span><span class="op" id="1725231">.</span><span class="ident" id="1725232">entry</span>&nbsp;<span class="op" id="1725238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1725244">print</span><span class="op" id="1725249">(</span><span class="string" id="1725250">&#34;runtime:&nbsp;confused&nbsp;by&nbsp;&#34;</span><span class="op" id="1725273">,</span>&nbsp;<span class="ident" id="1725275">gofuncname</span><span class="op" id="1725285">(</span><span class="ident" id="1725286">f</span><span class="op" id="1725287">)</span><span class="op" id="1725288">,</span>&nbsp;<span class="string" id="1725290">&#34;\n&#34;</span><span class="op" id="1725294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725300">gothrow</span><span class="op" id="1725307">(</span><span class="string" id="1725308">&#34;reflect&nbsp;mismatch&#34;</span><span class="op" id="1725326">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725336">bv</span>&nbsp;<span class="op" id="1725339">:=</span>&nbsp;<span class="op" id="1725342">(</span><span class="op" id="1725343">*</span><span class="ident" id="1725344">bitvector</span><span class="op" id="1725353">)</span><span class="op" id="1725354">(</span><span class="ident" id="1725355">unsafe</span><span class="op" id="1725361">.</span><span class="ident" id="1725362">Pointer</span><span class="op" id="1725369">(</span><span class="ident" id="1725370">fn</span><span class="op" id="1725372">[</span><span class="num" id="1725373">1</span><span class="op" id="1725374">]</span><span class="op" id="1725375">)</span><span class="op" id="1725376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725381">frame</span><span class="op" id="1725386">.</span><span class="ident" id="1725387">arglen</span>&nbsp;<span class="op" id="1725394">=</span>&nbsp;<span class="builtintype" id="1725396">uintptr</span><span class="op" id="1725403">(</span><span class="ident" id="1725404">bv</span><span class="op" id="1725406">.</span><span class="ident" id="1725407">n</span>&nbsp;<span class="op" id="1725409">/</span>&nbsp;<span class="num" id="1725411">2</span>&nbsp;<span class="op" id="1725413">*</span>&nbsp;<span class="ident" id="1725415">ptrSize</span><span class="op" id="1725422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725427">frame</span><span class="op" id="1725432">.</span><span class="ident" id="1725433">argmap</span>&nbsp;<span class="op" id="1725440">=</span>&nbsp;<span class="ident" id="1725442">bv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725447">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725450">}</span><br>
<span class="lineno"></span><span class="op" id="1725452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1725455">func</span>&nbsp;<span class="ident" id="1725460">printcreatedby</span><span class="op" id="1725474">(</span><span class="ident" id="1725475">gp</span>&nbsp;<span class="op" id="1725478">*</span><span class="ident" id="1725479">g</span><span class="op" id="1725480">)</span>&nbsp;<span class="op" id="1725482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1725485">//&nbsp;Show&nbsp;what&nbsp;created&nbsp;goroutine,&nbsp;except&nbsp;main&nbsp;goroutine&nbsp;(goid&nbsp;1).</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725550">pc</span>&nbsp;<span class="op" id="1725553">:=</span>&nbsp;<span class="ident" id="1725556">gp</span><span class="op" id="1725558">.</span><span class="ident" id="1725559">gopc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725565">f</span>&nbsp;<span class="op" id="1725567">:=</span>&nbsp;<span class="ident" id="1725570">findfunc</span><span class="op" id="1725578">(</span><span class="ident" id="1725579">pc</span><span class="op" id="1725581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725584">if</span>&nbsp;<span class="ident" id="1725587">f</span>&nbsp;<span class="op" id="1725589">!=</span>&nbsp;<span class="ident" id="1725592">nil</span>&nbsp;<span class="op" id="1725596">&amp;&amp;</span>&nbsp;<span class="ident" id="1725599">showframe</span><span class="op" id="1725608">(</span><span class="ident" id="1725609">f</span><span class="op" id="1725610">,</span>&nbsp;<span class="ident" id="1725612">gp</span><span class="op" id="1725614">)</span>&nbsp;<span class="op" id="1725616">&amp;&amp;</span>&nbsp;<span class="ident" id="1725619">gp</span><span class="op" id="1725621">.</span><span class="ident" id="1725622">goid</span>&nbsp;<span class="op" id="1725627">!=</span>&nbsp;<span class="num" id="1725630">1</span>&nbsp;<span class="op" id="1725632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1725636">print</span><span class="op" id="1725641">(</span><span class="string" id="1725642">&#34;created&nbsp;by&nbsp;&#34;</span><span class="op" id="1725655">,</span>&nbsp;<span class="ident" id="1725657">gofuncname</span><span class="op" id="1725667">(</span><span class="ident" id="1725668">f</span><span class="op" id="1725669">)</span><span class="op" id="1725670">,</span>&nbsp;<span class="string" id="1725672">&#34;\n&#34;</span><span class="op" id="1725676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725680">tracepc</span>&nbsp;<span class="op" id="1725688">:=</span>&nbsp;<span class="ident" id="1725691">pc</span>&nbsp;<span class="comment" id="1725694">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725741">if</span>&nbsp;<span class="ident" id="1725744">pc</span>&nbsp;<span class="op" id="1725747">&gt;</span>&nbsp;<span class="ident" id="1725749">f</span><span class="op" id="1725750">.</span><span class="ident" id="1725751">entry</span>&nbsp;<span class="op" id="1725757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725762">tracepc</span>&nbsp;<span class="op" id="1725770">-=</span>&nbsp;<span class="ident" id="1725773">_PCQuantum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725790">var</span>&nbsp;<span class="ident" id="1725794">file</span>&nbsp;<span class="builtintype" id="1725799">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725808">line</span>&nbsp;<span class="op" id="1725813">:=</span>&nbsp;<span class="ident" id="1725816">funcline</span><span class="op" id="1725824">(</span><span class="ident" id="1725825">f</span><span class="op" id="1725826">,</span>&nbsp;<span class="ident" id="1725828">tracepc</span><span class="op" id="1725835">,</span>&nbsp;<span class="op" id="1725837">&amp;</span><span class="ident" id="1725838">file</span><span class="op" id="1725842">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1725846">print</span><span class="op" id="1725851">(</span><span class="string" id="1725852">&#34;\t&#34;</span><span class="op" id="1725856">,</span>&nbsp;<span class="ident" id="1725858">file</span><span class="op" id="1725862">,</span>&nbsp;<span class="string" id="1725864">&#34;:&#34;</span><span class="op" id="1725867">,</span>&nbsp;<span class="ident" id="1725869">line</span><span class="op" id="1725873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725877">if</span>&nbsp;<span class="ident" id="1725880">pc</span>&nbsp;<span class="op" id="1725883">&gt;</span>&nbsp;<span class="ident" id="1725885">f</span><span class="op" id="1725886">.</span><span class="ident" id="1725887">entry</span>&nbsp;<span class="op" id="1725893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1725898">print</span><span class="op" id="1725903">(</span><span class="string" id="1725904">&#34;&nbsp;+&#34;</span><span class="op" id="1725908">,</span>&nbsp;<span class="ident" id="1725910">hex</span><span class="op" id="1725913">(</span><span class="ident" id="1725914">pc</span><span class="op" id="1725916">-</span><span class="ident" id="1725917">f</span><span class="op" id="1725918">.</span><span class="ident" id="1725919">entry</span><span class="op" id="1725924">)</span><span class="op" id="1725925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1725933">print</span><span class="op" id="1725938">(</span><span class="string" id="1725939">&#34;\n&#34;</span><span class="op" id="1725943">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725946">}</span><br>
<span class="lineno"></span><span class="op" id="1725948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1725951">func</span>&nbsp;<span class="ident" id="1725956">traceback</span><span class="op" id="1725965">(</span><span class="ident" id="1725966">pc</span>&nbsp;<span class="builtintype" id="1725969">uintptr</span><span class="op" id="1725976">,</span>&nbsp;<span class="ident" id="1725978">sp</span>&nbsp;<span class="builtintype" id="1725981">uintptr</span><span class="op" id="1725988">,</span>&nbsp;<span class="ident" id="1725990">lr</span>&nbsp;<span class="builtintype" id="1725993">uintptr</span><span class="op" id="1726000">,</span>&nbsp;<span class="ident" id="1726002">gp</span>&nbsp;<span class="op" id="1726005">*</span><span class="ident" id="1726006">g</span><span class="op" id="1726007">)</span>&nbsp;<span class="op" id="1726009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726012">traceback1</span><span class="op" id="1726022">(</span><span class="ident" id="1726023">pc</span><span class="op" id="1726025">,</span>&nbsp;<span class="ident" id="1726027">sp</span><span class="op" id="1726029">,</span>&nbsp;<span class="ident" id="1726031">lr</span><span class="op" id="1726033">,</span>&nbsp;<span class="ident" id="1726035">gp</span><span class="op" id="1726037">,</span>&nbsp;<span class="num" id="1726039">0</span><span class="op" id="1726040">)</span><br>
<span class="lineno">495</span><span class="op" id="1726042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1726045">//&nbsp;tracebacktrap&nbsp;is&nbsp;like&nbsp;traceback&nbsp;but&nbsp;expects&nbsp;that&nbsp;the&nbsp;PC&nbsp;and&nbsp;SP&nbsp;were&nbsp;obtained</span><br>
<span class="lineno"></span><span class="comment" id="1726125">//&nbsp;from&nbsp;a&nbsp;trap,&nbsp;not&nbsp;from&nbsp;gp-&gt;sched&nbsp;or&nbsp;gp-&gt;syscallpc/gp-&gt;syscallsp&nbsp;or&nbsp;getcallerpc/getcallersp.</span><br>
<span class="lineno"></span><span class="comment" id="1726219">//&nbsp;Because&nbsp;they&nbsp;are&nbsp;from&nbsp;a&nbsp;trap&nbsp;instead&nbsp;of&nbsp;from&nbsp;a&nbsp;saved&nbsp;pair,</span><br>
<span class="lineno">500</span><span class="comment" id="1726281">//&nbsp;the&nbsp;initial&nbsp;PC&nbsp;must&nbsp;not&nbsp;be&nbsp;rewound&nbsp;to&nbsp;the&nbsp;previous&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="1726348">//&nbsp;(All&nbsp;the&nbsp;saved&nbsp;pairs&nbsp;record&nbsp;a&nbsp;PC&nbsp;that&nbsp;is&nbsp;a&nbsp;return&nbsp;address,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="1726416">//&nbsp;rewind&nbsp;it&nbsp;into&nbsp;the&nbsp;CALL&nbsp;instruction.)</span><br>
<span class="lineno"></span><span class="keyword" id="1726457">func</span>&nbsp;<span class="ident" id="1726462">tracebacktrap</span><span class="op" id="1726475">(</span><span class="ident" id="1726476">pc</span>&nbsp;<span class="builtintype" id="1726479">uintptr</span><span class="op" id="1726486">,</span>&nbsp;<span class="ident" id="1726488">sp</span>&nbsp;<span class="builtintype" id="1726491">uintptr</span><span class="op" id="1726498">,</span>&nbsp;<span class="ident" id="1726500">lr</span>&nbsp;<span class="builtintype" id="1726503">uintptr</span><span class="op" id="1726510">,</span>&nbsp;<span class="ident" id="1726512">gp</span>&nbsp;<span class="op" id="1726515">*</span><span class="ident" id="1726516">g</span><span class="op" id="1726517">)</span>&nbsp;<span class="op" id="1726519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726522">traceback1</span><span class="op" id="1726532">(</span><span class="ident" id="1726533">pc</span><span class="op" id="1726535">,</span>&nbsp;<span class="ident" id="1726537">sp</span><span class="op" id="1726539">,</span>&nbsp;<span class="ident" id="1726541">lr</span><span class="op" id="1726543">,</span>&nbsp;<span class="ident" id="1726545">gp</span><span class="op" id="1726547">,</span>&nbsp;<span class="ident" id="1726549">_TraceTrap</span><span class="op" id="1726559">)</span><br>
<span class="lineno">505</span><span class="op" id="1726561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1726564">func</span>&nbsp;<span class="ident" id="1726569">traceback1</span><span class="op" id="1726579">(</span><span class="ident" id="1726580">pc</span>&nbsp;<span class="builtintype" id="1726583">uintptr</span><span class="op" id="1726590">,</span>&nbsp;<span class="ident" id="1726592">sp</span>&nbsp;<span class="builtintype" id="1726595">uintptr</span><span class="op" id="1726602">,</span>&nbsp;<span class="ident" id="1726604">lr</span>&nbsp;<span class="builtintype" id="1726607">uintptr</span><span class="op" id="1726614">,</span>&nbsp;<span class="ident" id="1726616">gp</span>&nbsp;<span class="op" id="1726619">*</span><span class="ident" id="1726620">g</span><span class="op" id="1726621">,</span>&nbsp;<span class="ident" id="1726623">flags</span>&nbsp;<span class="builtintype" id="1726629">uint</span><span class="op" id="1726633">)</span>&nbsp;<span class="op" id="1726635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726638">var</span>&nbsp;<span class="ident" id="1726642">n</span>&nbsp;<span class="builtintype" id="1726644">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726649">if</span>&nbsp;<span class="ident" id="1726652">readgstatus</span><span class="op" id="1726663">(</span><span class="ident" id="1726664">gp</span><span class="op" id="1726666">)</span><span class="op" id="1726667">&amp;^</span><span class="ident" id="1726669">_Gscan</span>&nbsp;<span class="op" id="1726676">==</span>&nbsp;<span class="ident" id="1726679">_Gsyscall</span>&nbsp;<span class="op" id="1726689">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726693">//&nbsp;Override&nbsp;registers&nbsp;if&nbsp;blocked&nbsp;in&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726744">pc</span>&nbsp;<span class="op" id="1726747">=</span>&nbsp;<span class="ident" id="1726749">gp</span><span class="op" id="1726751">.</span><span class="ident" id="1726752">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726764">sp</span>&nbsp;<span class="op" id="1726767">=</span>&nbsp;<span class="ident" id="1726769">gp</span><span class="op" id="1726771">.</span><span class="ident" id="1726772">syscallsp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726784">flags</span>&nbsp;<span class="op" id="1726790">&amp;^=</span>&nbsp;<span class="ident" id="1726794">_TraceTrap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726806">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726809">//&nbsp;Print&nbsp;traceback.&nbsp;By&nbsp;default,&nbsp;omits&nbsp;runtime&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726864">//&nbsp;If&nbsp;that&nbsp;means&nbsp;we&nbsp;print&nbsp;nothing&nbsp;at&nbsp;all,&nbsp;repeat&nbsp;forcing&nbsp;all&nbsp;frames&nbsp;printed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726942">n</span>&nbsp;<span class="op" id="1726944">=</span>&nbsp;<span class="ident" id="1726946">gentraceback</span><span class="op" id="1726958">(</span><span class="ident" id="1726959">pc</span><span class="op" id="1726961">,</span>&nbsp;<span class="ident" id="1726963">sp</span><span class="op" id="1726965">,</span>&nbsp;<span class="ident" id="1726967">lr</span><span class="op" id="1726969">,</span>&nbsp;<span class="ident" id="1726971">gp</span><span class="op" id="1726973">,</span>&nbsp;<span class="num" id="1726975">0</span><span class="op" id="1726976">,</span>&nbsp;<span class="ident" id="1726978">nil</span><span class="op" id="1726981">,</span>&nbsp;<span class="ident" id="1726983">_TracebackMaxFrames</span><span class="op" id="1727002">,</span>&nbsp;<span class="ident" id="1727004">nil</span><span class="op" id="1727007">,</span>&nbsp;<span class="ident" id="1727009">nil</span><span class="op" id="1727012">,</span>&nbsp;<span class="ident" id="1727014">flags</span><span class="op" id="1727019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727022">if</span>&nbsp;<span class="ident" id="1727025">n</span>&nbsp;<span class="op" id="1727027">==</span>&nbsp;<span class="num" id="1727030">0</span>&nbsp;<span class="op" id="1727032">&amp;&amp;</span>&nbsp;<span class="op" id="1727035">(</span><span class="ident" id="1727036">flags</span><span class="op" id="1727041">&amp;</span><span class="ident" id="1727042">_TraceRuntimeFrames</span><span class="op" id="1727061">)</span>&nbsp;<span class="op" id="1727063">==</span>&nbsp;<span class="num" id="1727066">0</span>&nbsp;<span class="op" id="1727068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727072">n</span>&nbsp;<span class="op" id="1727074">=</span>&nbsp;<span class="ident" id="1727076">gentraceback</span><span class="op" id="1727088">(</span><span class="ident" id="1727089">pc</span><span class="op" id="1727091">,</span>&nbsp;<span class="ident" id="1727093">sp</span><span class="op" id="1727095">,</span>&nbsp;<span class="ident" id="1727097">lr</span><span class="op" id="1727099">,</span>&nbsp;<span class="ident" id="1727101">gp</span><span class="op" id="1727103">,</span>&nbsp;<span class="num" id="1727105">0</span><span class="op" id="1727106">,</span>&nbsp;<span class="ident" id="1727108">nil</span><span class="op" id="1727111">,</span>&nbsp;<span class="ident" id="1727113">_TracebackMaxFrames</span><span class="op" id="1727132">,</span>&nbsp;<span class="ident" id="1727134">nil</span><span class="op" id="1727137">,</span>&nbsp;<span class="ident" id="1727139">nil</span><span class="op" id="1727142">,</span>&nbsp;<span class="ident" id="1727144">flags</span><span class="op" id="1727149">|</span><span class="ident" id="1727150">_TraceRuntimeFrames</span><span class="op" id="1727169">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727175">if</span>&nbsp;<span class="ident" id="1727178">n</span>&nbsp;<span class="op" id="1727180">==</span>&nbsp;<span class="ident" id="1727183">_TracebackMaxFrames</span>&nbsp;<span class="op" id="1727203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1727207">print</span><span class="op" id="1727212">(</span><span class="string" id="1727213">&#34;...additional&nbsp;frames&nbsp;elided...\n&#34;</span><span class="op" id="1727247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727253">printcreatedby</span><span class="op" id="1727267">(</span><span class="ident" id="1727268">gp</span><span class="op" id="1727270">)</span><br>
<span class="lineno">525</span><span class="op" id="1727272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1727275">func</span>&nbsp;<span class="ident" id="1727280">callers</span><span class="op" id="1727287">(</span><span class="ident" id="1727288">skip</span>&nbsp;<span class="builtintype" id="1727293">int</span><span class="op" id="1727296">,</span>&nbsp;<span class="ident" id="1727298">pcbuf</span>&nbsp;<span class="op" id="1727304">*</span><span class="builtintype" id="1727305">uintptr</span><span class="op" id="1727312">,</span>&nbsp;<span class="ident" id="1727314">m</span>&nbsp;<span class="builtintype" id="1727316">int</span><span class="op" id="1727319">)</span>&nbsp;<span class="builtintype" id="1727321">int</span>&nbsp;<span class="op" id="1727325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727328">sp</span>&nbsp;<span class="op" id="1727331">:=</span>&nbsp;<span class="ident" id="1727334">getcallersp</span><span class="op" id="1727345">(</span><span class="ident" id="1727346">unsafe</span><span class="op" id="1727352">.</span><span class="ident" id="1727353">Pointer</span><span class="op" id="1727360">(</span><span class="op" id="1727361">&amp;</span><span class="ident" id="1727362">skip</span><span class="op" id="1727366">)</span><span class="op" id="1727367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727370">pc</span>&nbsp;<span class="op" id="1727373">:=</span>&nbsp;<span class="builtintype" id="1727376">uintptr</span><span class="op" id="1727383">(</span><span class="ident" id="1727384">getcallerpc</span><span class="op" id="1727395">(</span><span class="ident" id="1727396">unsafe</span><span class="op" id="1727402">.</span><span class="ident" id="1727403">Pointer</span><span class="op" id="1727410">(</span><span class="op" id="1727411">&amp;</span><span class="ident" id="1727412">skip</span><span class="op" id="1727416">)</span><span class="op" id="1727417">)</span><span class="op" id="1727418">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727421">var</span>&nbsp;<span class="ident" id="1727425">n</span>&nbsp;<span class="builtintype" id="1727427">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727432">onM</span><span class="op" id="1727435">(</span><span class="keyword" id="1727436">func</span><span class="op" id="1727440">(</span><span class="op" id="1727441">)</span>&nbsp;<span class="op" id="1727443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727447">n</span>&nbsp;<span class="op" id="1727449">=</span>&nbsp;<span class="ident" id="1727451">gentraceback</span><span class="op" id="1727463">(</span><span class="ident" id="1727464">pc</span><span class="op" id="1727466">,</span>&nbsp;<span class="ident" id="1727468">sp</span><span class="op" id="1727470">,</span>&nbsp;<span class="num" id="1727472">0</span><span class="op" id="1727473">,</span>&nbsp;<span class="ident" id="1727475">getg</span><span class="op" id="1727479">(</span><span class="op" id="1727480">)</span><span class="op" id="1727481">,</span>&nbsp;<span class="ident" id="1727483">skip</span><span class="op" id="1727487">,</span>&nbsp;<span class="ident" id="1727489">pcbuf</span><span class="op" id="1727494">,</span>&nbsp;<span class="ident" id="1727496">m</span><span class="op" id="1727497">,</span>&nbsp;<span class="ident" id="1727499">nil</span><span class="op" id="1727502">,</span>&nbsp;<span class="ident" id="1727504">nil</span><span class="op" id="1727507">,</span>&nbsp;<span class="num" id="1727509">0</span><span class="op" id="1727510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727513">}</span><span class="op" id="1727514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727517">return</span>&nbsp;<span class="ident" id="1727524">n</span><br>
<span class="lineno">535</span><span class="op" id="1727526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1727529">func</span>&nbsp;<span class="ident" id="1727534">gcallers</span><span class="op" id="1727542">(</span><span class="ident" id="1727543">gp</span>&nbsp;<span class="op" id="1727546">*</span><span class="ident" id="1727547">g</span><span class="op" id="1727548">,</span>&nbsp;<span class="ident" id="1727550">skip</span>&nbsp;<span class="builtintype" id="1727555">int</span><span class="op" id="1727558">,</span>&nbsp;<span class="ident" id="1727560">pcbuf</span>&nbsp;<span class="op" id="1727566">*</span><span class="builtintype" id="1727567">uintptr</span><span class="op" id="1727574">,</span>&nbsp;<span class="ident" id="1727576">m</span>&nbsp;<span class="builtintype" id="1727578">int</span><span class="op" id="1727581">)</span>&nbsp;<span class="builtintype" id="1727583">int</span>&nbsp;<span class="op" id="1727587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727590">return</span>&nbsp;<span class="ident" id="1727597">gentraceback</span><span class="op" id="1727609">(</span><span class="op" id="1727610">^</span><span class="builtintype" id="1727611">uintptr</span><span class="op" id="1727618">(</span><span class="num" id="1727619">0</span><span class="op" id="1727620">)</span><span class="op" id="1727621">,</span>&nbsp;<span class="op" id="1727623">^</span><span class="builtintype" id="1727624">uintptr</span><span class="op" id="1727631">(</span><span class="num" id="1727632">0</span><span class="op" id="1727633">)</span><span class="op" id="1727634">,</span>&nbsp;<span class="num" id="1727636">0</span><span class="op" id="1727637">,</span>&nbsp;<span class="ident" id="1727639">gp</span><span class="op" id="1727641">,</span>&nbsp;<span class="ident" id="1727643">skip</span><span class="op" id="1727647">,</span>&nbsp;<span class="ident" id="1727649">pcbuf</span><span class="op" id="1727654">,</span>&nbsp;<span class="ident" id="1727656">m</span><span class="op" id="1727657">,</span>&nbsp;<span class="ident" id="1727659">nil</span><span class="op" id="1727662">,</span>&nbsp;<span class="ident" id="1727664">nil</span><span class="op" id="1727667">,</span>&nbsp;<span class="num" id="1727669">0</span><span class="op" id="1727670">)</span><br>
<span class="lineno"></span><span class="op" id="1727672">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="1727675">func</span>&nbsp;<span class="ident" id="1727680">showframe</span><span class="op" id="1727689">(</span><span class="ident" id="1727690">f</span>&nbsp;<span class="op" id="1727692">*</span><span class="ident" id="1727693">_func</span><span class="op" id="1727698">,</span>&nbsp;<span class="ident" id="1727700">gp</span>&nbsp;<span class="op" id="1727703">*</span><span class="ident" id="1727704">g</span><span class="op" id="1727705">)</span>&nbsp;<span class="builtintype" id="1727707">bool</span>&nbsp;<span class="op" id="1727712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727715">g</span>&nbsp;<span class="op" id="1727717">:=</span>&nbsp;<span class="ident" id="1727720">getg</span><span class="op" id="1727724">(</span><span class="op" id="1727725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727728">if</span>&nbsp;<span class="ident" id="1727731">g</span><span class="op" id="1727732">.</span><span class="ident" id="1727733">m</span><span class="op" id="1727734">.</span><span class="ident" id="1727735">throwing</span>&nbsp;<span class="op" id="1727744">&gt;</span>&nbsp;<span class="num" id="1727746">0</span>&nbsp;<span class="op" id="1727748">&amp;&amp;</span>&nbsp;<span class="ident" id="1727751">gp</span>&nbsp;<span class="op" id="1727754">!=</span>&nbsp;<span class="ident" id="1727757">nil</span>&nbsp;<span class="op" id="1727761">&amp;&amp;</span>&nbsp;<span class="op" id="1727764">(</span><span class="ident" id="1727765">gp</span>&nbsp;<span class="op" id="1727768">==</span>&nbsp;<span class="ident" id="1727771">g</span><span class="op" id="1727772">.</span><span class="ident" id="1727773">m</span><span class="op" id="1727774">.</span><span class="ident" id="1727775">curg</span>&nbsp;<span class="op" id="1727780">||</span>&nbsp;<span class="ident" id="1727783">gp</span>&nbsp;<span class="op" id="1727786">==</span>&nbsp;<span class="ident" id="1727789">g</span><span class="op" id="1727790">.</span><span class="ident" id="1727791">m</span><span class="op" id="1727792">.</span><span class="ident" id="1727793">caughtsig</span><span class="op" id="1727802">)</span>&nbsp;<span class="op" id="1727804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727808">return</span>&nbsp;<span class="builtintype" id="1727815">true</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727824">traceback</span>&nbsp;<span class="op" id="1727834">:=</span>&nbsp;<span class="ident" id="1727837">gotraceback</span><span class="op" id="1727848">(</span><span class="ident" id="1727849">nil</span><span class="op" id="1727852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727855">name</span>&nbsp;<span class="op" id="1727860">:=</span>&nbsp;<span class="ident" id="1727863">gostringnocopy</span><span class="op" id="1727877">(</span><span class="ident" id="1727878">funcname</span><span class="op" id="1727886">(</span><span class="ident" id="1727887">f</span><span class="op" id="1727888">)</span><span class="op" id="1727889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727893">//&nbsp;Special&nbsp;case:&nbsp;always&nbsp;show&nbsp;runtime.panic&nbsp;frame,&nbsp;so&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727959">//&nbsp;see&nbsp;where&nbsp;a&nbsp;panic&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728021">//&nbsp;See&nbsp;golang.org/issue/5832.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728052">if</span>&nbsp;<span class="ident" id="1728055">name</span>&nbsp;<span class="op" id="1728060">==</span>&nbsp;<span class="string" id="1728063">&#34;runtime.panic&#34;</span>&nbsp;<span class="op" id="1728079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728083">return</span>&nbsp;<span class="builtintype" id="1728090">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728096">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728100">return</span>&nbsp;<span class="ident" id="1728107">traceback</span>&nbsp;<span class="op" id="1728117">&gt;</span>&nbsp;<span class="num" id="1728119">1</span>&nbsp;<span class="op" id="1728121">||</span>&nbsp;<span class="ident" id="1728124">f</span>&nbsp;<span class="op" id="1728126">!=</span>&nbsp;<span class="ident" id="1728129">nil</span>&nbsp;<span class="op" id="1728133">&amp;&amp;</span>&nbsp;<span class="ident" id="1728136">contains</span><span class="op" id="1728144">(</span><span class="ident" id="1728145">name</span><span class="op" id="1728149">,</span>&nbsp;<span class="string" id="1728151">&#34;.&#34;</span><span class="op" id="1728154">)</span>&nbsp;<span class="op" id="1728156">&amp;&amp;</span>&nbsp;<span class="op" id="1728159">(</span><span class="op" id="1728160">!</span><span class="ident" id="1728161">hasprefix</span><span class="op" id="1728170">(</span><span class="ident" id="1728171">name</span><span class="op" id="1728175">,</span>&nbsp;<span class="string" id="1728177">&#34;runtime.&#34;</span><span class="op" id="1728187">)</span>&nbsp;<span class="op" id="1728189">||</span>&nbsp;<span class="ident" id="1728192">isExportedRuntime</span><span class="op" id="1728209">(</span><span class="ident" id="1728210">name</span><span class="op" id="1728214">)</span><span class="op" id="1728215">)</span><br>
<span class="lineno"></span><span class="op" id="1728217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1728220">//&nbsp;isExportedRuntime&nbsp;reports&nbsp;whether&nbsp;name&nbsp;is&nbsp;an&nbsp;exported&nbsp;runtime&nbsp;function.</span><br>
<span class="lineno">560</span><span class="comment" id="1728295">//&nbsp;It&nbsp;is&nbsp;only&nbsp;for&nbsp;runtime&nbsp;functions,&nbsp;so&nbsp;ASCII&nbsp;A-Z&nbsp;is&nbsp;fine.</span><br>
<span class="lineno"></span><span class="keyword" id="1728354">func</span>&nbsp;<span class="ident" id="1728359">isExportedRuntime</span><span class="op" id="1728376">(</span><span class="ident" id="1728377">name</span>&nbsp;<span class="builtintype" id="1728382">string</span><span class="op" id="1728388">)</span>&nbsp;<span class="builtintype" id="1728390">bool</span>&nbsp;<span class="op" id="1728395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728398">const</span>&nbsp;<span class="ident" id="1728404">n</span>&nbsp;<span class="op" id="1728406">=</span>&nbsp;<span class="builtinfunc" id="1728408">len</span><span class="op" id="1728411">(</span><span class="string" id="1728412">&#34;runtime.&#34;</span><span class="op" id="1728422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728425">return</span>&nbsp;<span class="builtinfunc" id="1728432">len</span><span class="op" id="1728435">(</span><span class="ident" id="1728436">name</span><span class="op" id="1728440">)</span>&nbsp;<span class="op" id="1728442">&gt;</span>&nbsp;<span class="ident" id="1728444">n</span>&nbsp;<span class="op" id="1728446">&amp;&amp;</span>&nbsp;<span class="ident" id="1728449">name</span><span class="op" id="1728453">[</span><span class="op" id="1728454">:</span><span class="ident" id="1728455">n</span><span class="op" id="1728456">]</span>&nbsp;<span class="op" id="1728458">==</span>&nbsp;<span class="string" id="1728461">&#34;runtime.&#34;</span>&nbsp;<span class="op" id="1728472">&amp;&amp;</span>&nbsp;<span class="string" id="1728475">&#39;A&#39;</span>&nbsp;<span class="op" id="1728479">&lt;=</span>&nbsp;<span class="ident" id="1728482">name</span><span class="op" id="1728486">[</span><span class="ident" id="1728487">n</span><span class="op" id="1728488">]</span>&nbsp;<span class="op" id="1728490">&amp;&amp;</span>&nbsp;<span class="ident" id="1728493">name</span><span class="op" id="1728497">[</span><span class="ident" id="1728498">n</span><span class="op" id="1728499">]</span>&nbsp;<span class="op" id="1728501">&lt;=</span>&nbsp;<span class="string" id="1728504">&#39;Z&#39;</span><br>
<span class="lineno"></span><span class="op" id="1728508">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1728511">var</span>&nbsp;<span class="ident" id="1728515">gStatusStrings</span>&nbsp;<span class="op" id="1728530">=</span>&nbsp;<span class="op" id="1728532">[</span><span class="op" id="1728533">...</span><span class="op" id="1728536">]</span><span class="builtintype" id="1728537">string</span><span class="op" id="1728543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728546">_Gidle</span><span class="op" id="1728552">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1728559">&#34;idle&#34;</span><span class="op" id="1728565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728568">_Grunnable</span><span class="op" id="1728578">:</span>&nbsp;&nbsp;<span class="string" id="1728581">&#34;runnable&#34;</span><span class="op" id="1728591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728594">_Grunning</span><span class="op" id="1728603">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1728607">&#34;running&#34;</span><span class="op" id="1728616">,</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728619">_Gsyscall</span><span class="op" id="1728628">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1728632">&#34;syscall&#34;</span><span class="op" id="1728641">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728644">_Gwaiting</span><span class="op" id="1728653">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1728657">&#34;waiting&#34;</span><span class="op" id="1728666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728669">_Gdead</span><span class="op" id="1728675">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1728682">&#34;dead&#34;</span><span class="op" id="1728688">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728691">_Genqueue</span><span class="op" id="1728700">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1728704">&#34;enqueue&#34;</span><span class="op" id="1728713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728716">_Gcopystack</span><span class="op" id="1728727">:</span>&nbsp;<span class="string" id="1728729">&#34;copystack&#34;</span><span class="op" id="1728740">,</span><br>
<span class="lineno">575</span><span class="op" id="1728742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1728745">var</span>&nbsp;<span class="ident" id="1728749">gScanStatusStrings</span>&nbsp;<span class="op" id="1728768">=</span>&nbsp;<span class="op" id="1728770">[</span><span class="op" id="1728771">...</span><span class="op" id="1728774">]</span><span class="builtintype" id="1728775">string</span><span class="op" id="1728781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1728784">0</span><span class="op" id="1728785">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1728796">&#34;scan&#34;</span><span class="op" id="1728802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728805">_Grunnable</span><span class="op" id="1728815">:</span>&nbsp;<span class="string" id="1728817">&#34;scanrunnable&#34;</span><span class="op" id="1728831">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728834">_Grunning</span><span class="op" id="1728843">:</span>&nbsp;&nbsp;<span class="string" id="1728846">&#34;scanrunning&#34;</span><span class="op" id="1728859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728862">_Gsyscall</span><span class="op" id="1728871">:</span>&nbsp;&nbsp;<span class="string" id="1728874">&#34;scansyscall&#34;</span><span class="op" id="1728887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728890">_Gwaiting</span><span class="op" id="1728899">:</span>&nbsp;&nbsp;<span class="string" id="1728902">&#34;scanwaiting&#34;</span><span class="op" id="1728915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728918">_Gdead</span><span class="op" id="1728924">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1728930">&#34;scandead&#34;</span><span class="op" id="1728940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728943">_Genqueue</span><span class="op" id="1728952">:</span>&nbsp;&nbsp;<span class="string" id="1728955">&#34;scanenqueue&#34;</span><span class="op" id="1728968">,</span><br>
<span class="lineno">585</span><span class="op" id="1728970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1728973">func</span>&nbsp;<span class="ident" id="1728978">goroutineheader</span><span class="op" id="1728993">(</span><span class="ident" id="1728994">gp</span>&nbsp;<span class="op" id="1728997">*</span><span class="ident" id="1728998">g</span><span class="op" id="1728999">)</span>&nbsp;<span class="op" id="1729001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729004">gpstatus</span>&nbsp;<span class="op" id="1729013">:=</span>&nbsp;<span class="ident" id="1729016">readgstatus</span><span class="op" id="1729027">(</span><span class="ident" id="1729028">gp</span><span class="op" id="1729030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729034">//&nbsp;Basic&nbsp;string&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729058">var</span>&nbsp;<span class="ident" id="1729062">status</span>&nbsp;<span class="builtintype" id="1729069">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729077">if</span>&nbsp;<span class="num" id="1729080">0</span>&nbsp;<span class="op" id="1729082">&lt;=</span>&nbsp;<span class="ident" id="1729085">gpstatus</span>&nbsp;<span class="op" id="1729094">&amp;&amp;</span>&nbsp;<span class="ident" id="1729097">gpstatus</span>&nbsp;<span class="op" id="1729106">&lt;</span>&nbsp;<span class="builtintype" id="1729108">uint32</span><span class="op" id="1729114">(</span><span class="builtinfunc" id="1729115">len</span><span class="op" id="1729118">(</span><span class="ident" id="1729119">gStatusStrings</span><span class="op" id="1729133">)</span><span class="op" id="1729134">)</span>&nbsp;<span class="op" id="1729136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729140">status</span>&nbsp;<span class="op" id="1729147">=</span>&nbsp;<span class="ident" id="1729149">gStatusStrings</span><span class="op" id="1729163">[</span><span class="ident" id="1729164">gpstatus</span><span class="op" id="1729172">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729175">}</span>&nbsp;<span class="keyword" id="1729177">else</span>&nbsp;<span class="keyword" id="1729182">if</span>&nbsp;<span class="ident" id="1729185">gpstatus</span><span class="op" id="1729193">&amp;</span><span class="ident" id="1729194">_Gscan</span>&nbsp;<span class="op" id="1729201">!=</span>&nbsp;<span class="num" id="1729204">0</span>&nbsp;<span class="op" id="1729206">&amp;&amp;</span>&nbsp;<span class="num" id="1729209">0</span>&nbsp;<span class="op" id="1729211">&lt;=</span>&nbsp;<span class="ident" id="1729214">gpstatus</span><span class="op" id="1729222">&amp;^</span><span class="ident" id="1729224">_Gscan</span>&nbsp;<span class="op" id="1729231">&amp;&amp;</span>&nbsp;<span class="ident" id="1729234">gpstatus</span><span class="op" id="1729242">&amp;^</span><span class="ident" id="1729244">_Gscan</span>&nbsp;<span class="op" id="1729251">&lt;</span>&nbsp;<span class="builtintype" id="1729253">uint32</span><span class="op" id="1729259">(</span><span class="builtinfunc" id="1729260">len</span><span class="op" id="1729263">(</span><span class="ident" id="1729264">gStatusStrings</span><span class="op" id="1729278">)</span><span class="op" id="1729279">)</span>&nbsp;<span class="op" id="1729281">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729285">status</span>&nbsp;<span class="op" id="1729292">=</span>&nbsp;<span class="ident" id="1729294">gStatusStrings</span><span class="op" id="1729308">[</span><span class="ident" id="1729309">gpstatus</span><span class="op" id="1729317">&amp;^</span><span class="ident" id="1729319">_Gscan</span><span class="op" id="1729325">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729328">}</span>&nbsp;<span class="keyword" id="1729330">else</span>&nbsp;<span class="op" id="1729335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729339">status</span>&nbsp;<span class="op" id="1729346">=</span>&nbsp;<span class="string" id="1729348">&#34;???&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729359">//&nbsp;Override.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729373">if</span>&nbsp;<span class="op" id="1729376">(</span><span class="ident" id="1729377">gpstatus</span>&nbsp;<span class="op" id="1729386">==</span>&nbsp;<span class="ident" id="1729389">_Gwaiting</span>&nbsp;<span class="op" id="1729399">||</span>&nbsp;<span class="ident" id="1729402">gpstatus</span>&nbsp;<span class="op" id="1729411">==</span>&nbsp;<span class="ident" id="1729414">_Gscanwaiting</span><span class="op" id="1729427">)</span>&nbsp;<span class="op" id="1729429">&amp;&amp;</span>&nbsp;<span class="ident" id="1729432">gp</span><span class="op" id="1729434">.</span><span class="ident" id="1729435">waitreason</span>&nbsp;<span class="op" id="1729446">!=</span>&nbsp;<span class="string" id="1729449">&#34;&#34;</span>&nbsp;<span class="op" id="1729452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729456">status</span>&nbsp;<span class="op" id="1729463">=</span>&nbsp;<span class="ident" id="1729465">gp</span><span class="op" id="1729467">.</span><span class="ident" id="1729468">waitreason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729484">//&nbsp;approx&nbsp;time&nbsp;the&nbsp;G&nbsp;is&nbsp;blocked,&nbsp;in&nbsp;minutes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729529">var</span>&nbsp;<span class="ident" id="1729533">waitfor</span>&nbsp;<span class="ident" id="1729541">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729548">gpstatus</span>&nbsp;<span class="op" id="1729557">&amp;^=</span>&nbsp;<span class="ident" id="1729561">_Gscan</span>&nbsp;<span class="comment" id="1729568">//&nbsp;drop&nbsp;the&nbsp;scan&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729590">if</span>&nbsp;<span class="op" id="1729593">(</span><span class="ident" id="1729594">gpstatus</span>&nbsp;<span class="op" id="1729603">==</span>&nbsp;<span class="ident" id="1729606">_Gwaiting</span>&nbsp;<span class="op" id="1729616">||</span>&nbsp;<span class="ident" id="1729619">gpstatus</span>&nbsp;<span class="op" id="1729628">==</span>&nbsp;<span class="ident" id="1729631">_Gsyscall</span><span class="op" id="1729640">)</span>&nbsp;<span class="op" id="1729642">&amp;&amp;</span>&nbsp;<span class="ident" id="1729645">gp</span><span class="op" id="1729647">.</span><span class="ident" id="1729648">waitsince</span>&nbsp;<span class="op" id="1729658">!=</span>&nbsp;<span class="num" id="1729661">0</span>&nbsp;<span class="op" id="1729663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729667">waitfor</span>&nbsp;<span class="op" id="1729675">=</span>&nbsp;<span class="op" id="1729677">(</span><span class="ident" id="1729678">nanotime</span><span class="op" id="1729686">(</span><span class="op" id="1729687">)</span>&nbsp;<span class="op" id="1729689">-</span>&nbsp;<span class="ident" id="1729691">gp</span><span class="op" id="1729693">.</span><span class="ident" id="1729694">waitsince</span><span class="op" id="1729703">)</span>&nbsp;<span class="op" id="1729705">/</span>&nbsp;<span class="num" id="1729707">60e9</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1729716">print</span><span class="op" id="1729721">(</span><span class="string" id="1729722">&#34;goroutine&nbsp;&#34;</span><span class="op" id="1729734">,</span>&nbsp;<span class="ident" id="1729736">gp</span><span class="op" id="1729738">.</span><span class="ident" id="1729739">goid</span><span class="op" id="1729743">,</span>&nbsp;<span class="string" id="1729745">&#34;&nbsp;[&#34;</span><span class="op" id="1729749">,</span>&nbsp;<span class="ident" id="1729751">status</span><span class="op" id="1729757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729760">if</span>&nbsp;<span class="ident" id="1729763">waitfor</span>&nbsp;<span class="op" id="1729771">&gt;=</span>&nbsp;<span class="num" id="1729774">1</span>&nbsp;<span class="op" id="1729776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1729780">print</span><span class="op" id="1729785">(</span><span class="string" id="1729786">&#34;,&nbsp;&#34;</span><span class="op" id="1729790">,</span>&nbsp;<span class="ident" id="1729792">waitfor</span><span class="op" id="1729799">,</span>&nbsp;<span class="string" id="1729801">&#34;&nbsp;minutes&#34;</span><span class="op" id="1729811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729814">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729817">if</span>&nbsp;<span class="ident" id="1729820">gp</span><span class="op" id="1729822">.</span><span class="ident" id="1729823">lockedm</span>&nbsp;<span class="op" id="1729831">!=</span>&nbsp;<span class="ident" id="1729834">nil</span>&nbsp;<span class="op" id="1729838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1729842">print</span><span class="op" id="1729847">(</span><span class="string" id="1729848">&#34;,&nbsp;locked&nbsp;to&nbsp;thread&#34;</span><span class="op" id="1729868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1729874">print</span><span class="op" id="1729879">(</span><span class="string" id="1729880">&#34;]:\n&#34;</span><span class="op" id="1729886">)</span><br>
<span class="lineno"></span><span class="op" id="1729888">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="1729891">func</span>&nbsp;<span class="ident" id="1729896">tracebackothers</span><span class="op" id="1729911">(</span><span class="ident" id="1729912">me</span>&nbsp;<span class="op" id="1729915">*</span><span class="ident" id="1729916">g</span><span class="op" id="1729917">)</span>&nbsp;<span class="op" id="1729919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729922">level</span>&nbsp;<span class="op" id="1729928">:=</span>&nbsp;<span class="ident" id="1729931">gotraceback</span><span class="op" id="1729942">(</span><span class="ident" id="1729943">nil</span><span class="op" id="1729946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729950">//&nbsp;Show&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;first,&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730011">g</span>&nbsp;<span class="op" id="1730013">:=</span>&nbsp;<span class="ident" id="1730016">getg</span><span class="op" id="1730020">(</span><span class="op" id="1730021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730024">gp</span>&nbsp;<span class="op" id="1730027">:=</span>&nbsp;<span class="ident" id="1730030">g</span><span class="op" id="1730031">.</span><span class="ident" id="1730032">m</span><span class="op" id="1730033">.</span><span class="ident" id="1730034">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730040">if</span>&nbsp;<span class="ident" id="1730043">gp</span>&nbsp;<span class="op" id="1730046">!=</span>&nbsp;<span class="ident" id="1730049">nil</span>&nbsp;<span class="op" id="1730053">&amp;&amp;</span>&nbsp;<span class="ident" id="1730056">gp</span>&nbsp;<span class="op" id="1730059">!=</span>&nbsp;<span class="ident" id="1730062">me</span>&nbsp;<span class="op" id="1730065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1730069">print</span><span class="op" id="1730074">(</span><span class="string" id="1730075">&#34;\n&#34;</span><span class="op" id="1730079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730083">goroutineheader</span><span class="op" id="1730098">(</span><span class="ident" id="1730099">gp</span><span class="op" id="1730101">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730105">traceback</span><span class="op" id="1730114">(</span><span class="op" id="1730115">^</span><span class="builtintype" id="1730116">uintptr</span><span class="op" id="1730123">(</span><span class="num" id="1730124">0</span><span class="op" id="1730125">)</span><span class="op" id="1730126">,</span>&nbsp;<span class="op" id="1730128">^</span><span class="builtintype" id="1730129">uintptr</span><span class="op" id="1730136">(</span><span class="num" id="1730137">0</span><span class="op" id="1730138">)</span><span class="op" id="1730139">,</span>&nbsp;<span class="num" id="1730141">0</span><span class="op" id="1730142">,</span>&nbsp;<span class="ident" id="1730144">gp</span><span class="op" id="1730146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730153">lock</span><span class="op" id="1730157">(</span><span class="op" id="1730158">&amp;</span><span class="ident" id="1730159">allglock</span><span class="op" id="1730167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730170">for</span>&nbsp;<span class="ident" id="1730174">_</span><span class="op" id="1730175">,</span>&nbsp;<span class="ident" id="1730177">gp</span>&nbsp;<span class="op" id="1730180">:=</span>&nbsp;<span class="keyword" id="1730183">range</span>&nbsp;<span class="ident" id="1730189">allgs</span>&nbsp;<span class="op" id="1730195">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730199">if</span>&nbsp;<span class="ident" id="1730202">gp</span>&nbsp;<span class="op" id="1730205">==</span>&nbsp;<span class="ident" id="1730208">me</span>&nbsp;<span class="op" id="1730211">||</span>&nbsp;<span class="ident" id="1730214">gp</span>&nbsp;<span class="op" id="1730217">==</span>&nbsp;<span class="ident" id="1730220">g</span><span class="op" id="1730221">.</span><span class="ident" id="1730222">m</span><span class="op" id="1730223">.</span><span class="ident" id="1730224">curg</span>&nbsp;<span class="op" id="1730229">||</span>&nbsp;<span class="ident" id="1730232">readgstatus</span><span class="op" id="1730243">(</span><span class="ident" id="1730244">gp</span><span class="op" id="1730246">)</span>&nbsp;<span class="op" id="1730248">==</span>&nbsp;<span class="ident" id="1730251">_Gdead</span>&nbsp;<span class="op" id="1730258">||</span>&nbsp;<span class="ident" id="1730261">gp</span><span class="op" id="1730263">.</span><span class="ident" id="1730264">issystem</span>&nbsp;<span class="op" id="1730273">&amp;&amp;</span>&nbsp;<span class="ident" id="1730276">level</span>&nbsp;<span class="op" id="1730282">&lt;</span>&nbsp;<span class="num" id="1730284">2</span>&nbsp;<span class="op" id="1730286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730291">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1730306">print</span><span class="op" id="1730311">(</span><span class="string" id="1730312">&#34;\n&#34;</span><span class="op" id="1730316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730320">goroutineheader</span><span class="op" id="1730335">(</span><span class="ident" id="1730336">gp</span><span class="op" id="1730338">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730342">if</span>&nbsp;<span class="ident" id="1730345">readgstatus</span><span class="op" id="1730356">(</span><span class="ident" id="1730357">gp</span><span class="op" id="1730359">)</span><span class="op" id="1730360">&amp;^</span><span class="ident" id="1730362">_Gscan</span>&nbsp;<span class="op" id="1730369">==</span>&nbsp;<span class="ident" id="1730372">_Grunning</span>&nbsp;<span class="op" id="1730382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1730387">print</span><span class="op" id="1730392">(</span><span class="string" id="1730393">&#34;\tgoroutine&nbsp;running&nbsp;on&nbsp;other&nbsp;thread;&nbsp;stack&nbsp;unavailable\n&#34;</span><span class="op" id="1730451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730456">printcreatedby</span><span class="op" id="1730470">(</span><span class="ident" id="1730471">gp</span><span class="op" id="1730473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730477">}</span>&nbsp;<span class="keyword" id="1730479">else</span>&nbsp;<span class="op" id="1730484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730489">traceback</span><span class="op" id="1730498">(</span><span class="op" id="1730499">^</span><span class="builtintype" id="1730500">uintptr</span><span class="op" id="1730507">(</span><span class="num" id="1730508">0</span><span class="op" id="1730509">)</span><span class="op" id="1730510">,</span>&nbsp;<span class="op" id="1730512">^</span><span class="builtintype" id="1730513">uintptr</span><span class="op" id="1730520">(</span><span class="num" id="1730521">0</span><span class="op" id="1730522">)</span><span class="op" id="1730523">,</span>&nbsp;<span class="num" id="1730525">0</span><span class="op" id="1730526">,</span>&nbsp;<span class="ident" id="1730528">gp</span><span class="op" id="1730530">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730540">unlock</span><span class="op" id="1730546">(</span><span class="op" id="1730547">&amp;</span><span class="ident" id="1730548">allglock</span><span class="op" id="1730556">)</span><br>
<span class="lineno"></span><span class="op" id="1730558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="1730561">//&nbsp;Does&nbsp;f&nbsp;mark&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;goroutine&nbsp;stack?</span><br>
<span class="lineno"></span><span class="keyword" id="1730606">func</span>&nbsp;<span class="ident" id="1730611">topofstack</span><span class="op" id="1730621">(</span><span class="ident" id="1730622">f</span>&nbsp;<span class="op" id="1730624">*</span><span class="ident" id="1730625">_func</span><span class="op" id="1730630">)</span>&nbsp;<span class="builtintype" id="1730632">bool</span>&nbsp;<span class="op" id="1730637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730640">pc</span>&nbsp;<span class="op" id="1730643">:=</span>&nbsp;<span class="ident" id="1730646">f</span><span class="op" id="1730647">.</span><span class="ident" id="1730648">entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730655">return</span>&nbsp;<span class="ident" id="1730662">pc</span>&nbsp;<span class="op" id="1730665">==</span>&nbsp;<span class="ident" id="1730668">goexitPC</span>&nbsp;<span class="op" id="1730677">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730682">pc</span>&nbsp;<span class="op" id="1730685">==</span>&nbsp;<span class="ident" id="1730688">mstartPC</span>&nbsp;<span class="op" id="1730697">||</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730702">pc</span>&nbsp;<span class="op" id="1730705">==</span>&nbsp;<span class="ident" id="1730708">mcallPC</span>&nbsp;<span class="op" id="1730716">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730721">pc</span>&nbsp;<span class="op" id="1730724">==</span>&nbsp;<span class="ident" id="1730727">morestackPC</span>&nbsp;<span class="op" id="1730739">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730744">pc</span>&nbsp;<span class="op" id="1730747">==</span>&nbsp;<span class="ident" id="1730750">rt0_goPC</span>&nbsp;<span class="op" id="1730759">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730764">externalthreadhandlerp</span>&nbsp;<span class="op" id="1730787">!=</span>&nbsp;<span class="num" id="1730790">0</span>&nbsp;<span class="op" id="1730792">&amp;&amp;</span>&nbsp;<span class="ident" id="1730795">pc</span>&nbsp;<span class="op" id="1730798">==</span>&nbsp;<span class="ident" id="1730801">externalthreadhandlerp</span><br>
<span class="lineno"></span><span class="op" id="1730824">}</span>
</div>
</body>
</html>
