<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4571308">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4571363">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4571417">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4571468">package</span>&nbsp;<span class="ident" id="4571476">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4571486">import</span>&nbsp;<span class="op" id="4571493">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4571496">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4571505">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4571512">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4571520">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4571526">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4571543">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="4571565">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4571568">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4571629">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="4571700">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4571790">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="4571858">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="4571871">func</span>&nbsp;<span class="ident" id="4571876">escapeTemplate</span><span class="op" id="4571890">(</span><span class="ident" id="4571891">tmpl</span>&nbsp;<span class="op" id="4571896">*</span><span class="ident" id="4571897">Template</span><span class="op" id="4571905">,</span>&nbsp;<span class="ident" id="4571907">node</span>&nbsp;<span class="ident" id="4571912">parse</span><span class="op" id="4571917">.</span><span class="ident" id="4571918">Node</span><span class="op" id="4571922">,</span>&nbsp;<span class="ident" id="4571924">name</span>&nbsp;<span class="builtintype" id="4571929">string</span><span class="op" id="4571935">)</span>&nbsp;<span class="builtintype" id="4571937">error</span>&nbsp;<span class="op" id="4571943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571946">e</span>&nbsp;<span class="op" id="4571948">:=</span>&nbsp;<span class="ident" id="4571951">newEscaper</span><span class="op" id="4571961">(</span><span class="ident" id="4571962">tmpl</span><span class="op" id="4571966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4571969">c</span><span class="op" id="4571970">,</span>&nbsp;<span class="ident" id="4571972">_</span>&nbsp;<span class="op" id="4571974">:=</span>&nbsp;<span class="ident" id="4571977">e</span><span class="op" id="4571978">.</span><span class="ident" id="4571979">escapeTree</span><span class="op" id="4571989">(</span><span class="ident" id="4571990">context</span><span class="op" id="4571997">{</span><span class="op" id="4571998">}</span><span class="op" id="4571999">,</span>&nbsp;<span class="ident" id="4572001">node</span><span class="op" id="4572005">,</span>&nbsp;<span class="ident" id="4572007">name</span><span class="op" id="4572011">,</span>&nbsp;<span class="num" id="4572013">0</span><span class="op" id="4572014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572017">var</span>&nbsp;<span class="ident" id="4572021">err</span>&nbsp;<span class="builtintype" id="4572025">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572032">if</span>&nbsp;<span class="ident" id="4572035">c</span><span class="op" id="4572036">.</span><span class="ident" id="4572037">err</span>&nbsp;<span class="op" id="4572041">!=</span>&nbsp;<span class="ident" id="4572044">nil</span>&nbsp;<span class="op" id="4572048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572052">err</span><span class="op" id="4572055">,</span>&nbsp;<span class="ident" id="4572057">c</span><span class="op" id="4572058">.</span><span class="ident" id="4572059">err</span><span class="op" id="4572062">.</span><span class="ident" id="4572063">Name</span>&nbsp;<span class="op" id="4572068">=</span>&nbsp;<span class="ident" id="4572070">c</span><span class="op" id="4572071">.</span><span class="ident" id="4572072">err</span><span class="op" id="4572075">,</span>&nbsp;<span class="ident" id="4572077">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572083">}</span>&nbsp;<span class="keyword" id="4572085">else</span>&nbsp;<span class="keyword" id="4572090">if</span>&nbsp;<span class="ident" id="4572093">c</span><span class="op" id="4572094">.</span><span class="ident" id="4572095">state</span>&nbsp;<span class="op" id="4572101">!=</span>&nbsp;<span class="ident" id="4572104">stateText</span>&nbsp;<span class="op" id="4572114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572118">err</span>&nbsp;<span class="op" id="4572122">=</span>&nbsp;<span class="op" id="4572124">&amp;</span><span class="ident" id="4572125">Error</span><span class="op" id="4572130">{</span><span class="ident" id="4572131">ErrEndContext</span><span class="op" id="4572144">,</span>&nbsp;<span class="ident" id="4572146">nil</span><span class="op" id="4572149">,</span>&nbsp;<span class="ident" id="4572151">name</span><span class="op" id="4572155">,</span>&nbsp;<span class="num" id="4572157">0</span><span class="op" id="4572158">,</span>&nbsp;<span class="ident" id="4572160">fmt</span><span class="op" id="4572163">.</span><span class="ident" id="4572164">Sprintf</span><span class="op" id="4572171">(</span><span class="string" id="4572172">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="4572204">,</span>&nbsp;<span class="ident" id="4572206">c</span><span class="op" id="4572207">)</span><span class="op" id="4572208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572211">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572214">if</span>&nbsp;<span class="ident" id="4572217">err</span>&nbsp;<span class="op" id="4572221">!=</span>&nbsp;<span class="ident" id="4572224">nil</span>&nbsp;<span class="op" id="4572228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4572232">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572276">if</span>&nbsp;<span class="ident" id="4572279">t</span>&nbsp;<span class="op" id="4572281">:=</span>&nbsp;<span class="ident" id="4572284">tmpl</span><span class="op" id="4572288">.</span><span class="ident" id="4572289">set</span><span class="op" id="4572292">[</span><span class="ident" id="4572293">name</span><span class="op" id="4572297">]</span><span class="op" id="4572298">;</span>&nbsp;<span class="ident" id="4572300">t</span>&nbsp;<span class="op" id="4572302">!=</span>&nbsp;<span class="ident" id="4572305">nil</span>&nbsp;<span class="op" id="4572309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572314">t</span><span class="op" id="4572315">.</span><span class="ident" id="4572316">escapeErr</span>&nbsp;<span class="op" id="4572326">=</span>&nbsp;<span class="ident" id="4572328">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572335">t</span><span class="op" id="4572336">.</span><span class="ident" id="4572337">text</span><span class="op" id="4572341">.</span><span class="ident" id="4572342">Tree</span>&nbsp;<span class="op" id="4572347">=</span>&nbsp;<span class="ident" id="4572349">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572356">t</span><span class="op" id="4572357">.</span><span class="ident" id="4572358">Tree</span>&nbsp;<span class="op" id="4572363">=</span>&nbsp;<span class="ident" id="4572365">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572375">return</span>&nbsp;<span class="ident" id="4572382">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572390">e</span><span class="op" id="4572391">.</span><span class="ident" id="4572392">commit</span><span class="op" id="4572398">(</span><span class="op" id="4572399">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572402">if</span>&nbsp;<span class="ident" id="4572405">t</span>&nbsp;<span class="op" id="4572407">:=</span>&nbsp;<span class="ident" id="4572410">tmpl</span><span class="op" id="4572414">.</span><span class="ident" id="4572415">set</span><span class="op" id="4572418">[</span><span class="ident" id="4572419">name</span><span class="op" id="4572423">]</span><span class="op" id="4572424">;</span>&nbsp;<span class="ident" id="4572426">t</span>&nbsp;<span class="op" id="4572428">!=</span>&nbsp;<span class="ident" id="4572431">nil</span>&nbsp;<span class="op" id="4572435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572439">t</span><span class="op" id="4572440">.</span><span class="ident" id="4572441">escapeErr</span>&nbsp;<span class="op" id="4572451">=</span>&nbsp;<span class="ident" id="4572453">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4572464">t</span><span class="op" id="4572465">.</span><span class="ident" id="4572466">Tree</span>&nbsp;<span class="op" id="4572471">=</span>&nbsp;<span class="ident" id="4572473">t</span><span class="op" id="4572474">.</span><span class="ident" id="4572475">text</span><span class="op" id="4572479">.</span><span class="ident" id="4572480">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4572486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4572489">return</span>&nbsp;<span class="ident" id="4572496">nil</span><br>
<span class="lineno">45</span><span class="op" id="4572500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4572503">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4572577">var</span>&nbsp;<span class="ident" id="4572581">funcMap</span>&nbsp;<span class="op" id="4572589">=</span>&nbsp;<span class="ident" id="4572591">template</span><span class="op" id="4572599">.</span><span class="ident" id="4572600">FuncMap</span><span class="op" id="4572607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572610">&#34;html_template_attrescaper&#34;</span><span class="op" id="4572637">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4572643">attrEscaper</span><span class="op" id="4572654">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572657">&#34;html_template_commentescaper&#34;</span><span class="op" id="4572687">:</span>&nbsp;&nbsp;<span class="ident" id="4572690">commentEscaper</span><span class="op" id="4572704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572707">&#34;html_template_cssescaper&#34;</span><span class="op" id="4572733">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4572740">cssEscaper</span><span class="op" id="4572750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572753">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4572783">:</span>&nbsp;&nbsp;<span class="ident" id="4572786">cssValueFilter</span><span class="op" id="4572800">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572803">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4572833">:</span>&nbsp;&nbsp;<span class="ident" id="4572836">htmlNameFilter</span><span class="op" id="4572850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572853">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4572880">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4572886">htmlEscaper</span><span class="op" id="4572897">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572900">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4572931">:</span>&nbsp;<span class="ident" id="4572933">jsRegexpEscaper</span><span class="op" id="4572948">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572951">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4572979">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4572984">jsStrEscaper</span><span class="op" id="4572996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4572999">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4573027">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4573032">jsValEscaper</span><span class="op" id="4573044">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573047">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4573077">:</span>&nbsp;&nbsp;<span class="ident" id="4573080">htmlNospaceEscaper</span><span class="op" id="4573098">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573101">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4573130">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4573134">rcdataEscaper</span><span class="op" id="4573147">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573150">&#34;html_template_urlescaper&#34;</span><span class="op" id="4573176">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4573183">urlEscaper</span><span class="op" id="4573193">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573196">&#34;html_template_urlfilter&#34;</span><span class="op" id="4573221">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4573229">urlFilter</span><span class="op" id="4573238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573241">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4573270">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4573274">urlNormalizer</span><span class="op" id="4573287">,</span><br>
<span class="lineno"></span><span class="op" id="4573289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4573292">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="4573370">var</span>&nbsp;<span class="ident" id="4573374">equivEscapers</span>&nbsp;<span class="op" id="4573388">=</span>&nbsp;<span class="keyword" id="4573390">map</span><span class="op" id="4573393">[</span><span class="builtintype" id="4573394">string</span><span class="op" id="4573400">]</span><span class="builtintype" id="4573401">string</span><span class="op" id="4573407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573410">&#34;html_template_attrescaper&#34;</span><span class="op" id="4573437">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4573442">&#34;html&#34;</span><span class="op" id="4573448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573451">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4573478">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4573483">&#34;html&#34;</span><span class="op" id="4573489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573492">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4573522">:</span>&nbsp;<span class="string" id="4573524">&#34;html&#34;</span><span class="op" id="4573530">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573533">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4573562">:</span>&nbsp;&nbsp;<span class="string" id="4573565">&#34;html&#34;</span><span class="op" id="4573571">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573574">&#34;html_template_urlescaper&#34;</span><span class="op" id="4573600">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4573606">&#34;urlquery&#34;</span><span class="op" id="4573616">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4573619">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4573648">:</span>&nbsp;&nbsp;<span class="string" id="4573651">&#34;urlquery&#34;</span><span class="op" id="4573661">,</span><br>
<span class="lineno"></span><span class="op" id="4573663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4573666">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="4573745">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="4573774">type</span>&nbsp;<span class="ident" id="4573779">escaper</span>&nbsp;<span class="keyword" id="4573787">struct</span>&nbsp;<span class="op" id="4573794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573797">tmpl</span>&nbsp;<span class="op" id="4573802">*</span><span class="ident" id="4573803">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573813">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573884">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4573935">output</span>&nbsp;<span class="keyword" id="4573942">map</span><span class="op" id="4573945">[</span><span class="builtintype" id="4573946">string</span><span class="op" id="4573952">]</span><span class="ident" id="4573953">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4573962">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574035">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574088">derived</span>&nbsp;<span class="keyword" id="4574096">map</span><span class="op" id="4574099">[</span><span class="builtintype" id="4574100">string</span><span class="op" id="4574106">]</span><span class="op" id="4574107">*</span><span class="ident" id="4574108">template</span><span class="op" id="4574116">.</span><span class="ident" id="4574117">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574127">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574195">called</span>&nbsp;<span class="keyword" id="4574202">map</span><span class="op" id="4574205">[</span><span class="builtintype" id="4574206">string</span><span class="op" id="4574212">]</span><span class="builtintype" id="4574213">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574219">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574286">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574352">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574414">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="4574432">map</span><span class="op" id="4574435">[</span><span class="op" id="4574436">*</span><span class="ident" id="4574437">parse</span><span class="op" id="4574442">.</span><span class="ident" id="4574443">ActionNode</span><span class="op" id="4574453">]</span><span class="op" id="4574454">[</span><span class="op" id="4574455">]</span><span class="builtintype" id="4574456">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574464">templateNodeEdits</span>&nbsp;<span class="keyword" id="4574482">map</span><span class="op" id="4574485">[</span><span class="op" id="4574486">*</span><span class="ident" id="4574487">parse</span><span class="op" id="4574492">.</span><span class="ident" id="4574493">TemplateNode</span><span class="op" id="4574505">]</span><span class="builtintype" id="4574506">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574514">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4574532">map</span><span class="op" id="4574535">[</span><span class="op" id="4574536">*</span><span class="ident" id="4574537">parse</span><span class="op" id="4574542">.</span><span class="ident" id="4574543">TextNode</span><span class="op" id="4574551">]</span><span class="op" id="4574552">[</span><span class="op" id="4574553">]</span><span class="builtintype" id="4574554">byte</span><br>
<span class="lineno"></span><span class="op" id="4574559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4574562">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4574619">func</span>&nbsp;<span class="ident" id="4574624">newEscaper</span><span class="op" id="4574634">(</span><span class="ident" id="4574635">t</span>&nbsp;<span class="op" id="4574637">*</span><span class="ident" id="4574638">Template</span><span class="op" id="4574646">)</span>&nbsp;<span class="op" id="4574648">*</span><span class="ident" id="4574649">escaper</span>&nbsp;<span class="op" id="4574657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574660">return</span>&nbsp;<span class="op" id="4574667">&amp;</span><span class="ident" id="4574668">escaper</span><span class="op" id="4574675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574679">t</span><span class="op" id="4574680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574684">map</span><span class="op" id="4574687">[</span><span class="builtintype" id="4574688">string</span><span class="op" id="4574694">]</span><span class="ident" id="4574695">context</span><span class="op" id="4574702">{</span><span class="op" id="4574703">}</span><span class="op" id="4574704">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574708">map</span><span class="op" id="4574711">[</span><span class="builtintype" id="4574712">string</span><span class="op" id="4574718">]</span><span class="op" id="4574719">*</span><span class="ident" id="4574720">template</span><span class="op" id="4574728">.</span><span class="ident" id="4574729">Template</span><span class="op" id="4574737">{</span><span class="op" id="4574738">}</span><span class="op" id="4574739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574743">map</span><span class="op" id="4574746">[</span><span class="builtintype" id="4574747">string</span><span class="op" id="4574753">]</span><span class="builtintype" id="4574754">bool</span><span class="op" id="4574758">{</span><span class="op" id="4574759">}</span><span class="op" id="4574760">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574764">map</span><span class="op" id="4574767">[</span><span class="op" id="4574768">*</span><span class="ident" id="4574769">parse</span><span class="op" id="4574774">.</span><span class="ident" id="4574775">ActionNode</span><span class="op" id="4574785">]</span><span class="op" id="4574786">[</span><span class="op" id="4574787">]</span><span class="builtintype" id="4574788">string</span><span class="op" id="4574794">{</span><span class="op" id="4574795">}</span><span class="op" id="4574796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574800">map</span><span class="op" id="4574803">[</span><span class="op" id="4574804">*</span><span class="ident" id="4574805">parse</span><span class="op" id="4574810">.</span><span class="ident" id="4574811">TemplateNode</span><span class="op" id="4574823">]</span><span class="builtintype" id="4574824">string</span><span class="op" id="4574830">{</span><span class="op" id="4574831">}</span><span class="op" id="4574832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4574836">map</span><span class="op" id="4574839">[</span><span class="op" id="4574840">*</span><span class="ident" id="4574841">parse</span><span class="op" id="4574846">.</span><span class="ident" id="4574847">TextNode</span><span class="op" id="4574855">]</span><span class="op" id="4574856">[</span><span class="op" id="4574857">]</span><span class="builtintype" id="4574858">byte</span><span class="op" id="4574862">{</span><span class="op" id="4574863">}</span><span class="op" id="4574864">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4574867">}</span><br>
<span class="lineno"></span><span class="op" id="4574869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4574872">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="4574953">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="4575029">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4575108">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="4575185">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="4575209">const</span>&nbsp;<span class="ident" id="4575215">filterFailsafe</span>&nbsp;<span class="op" id="4575230">=</span>&nbsp;<span class="string" id="4575232">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="4575244">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4575279">func</span>&nbsp;<span class="op" id="4575284">(</span><span class="ident" id="4575285">e</span>&nbsp;<span class="op" id="4575287">*</span><span class="ident" id="4575288">escaper</span><span class="op" id="4575295">)</span>&nbsp;<span class="ident" id="4575297">escape</span><span class="op" id="4575303">(</span><span class="ident" id="4575304">c</span>&nbsp;<span class="ident" id="4575306">context</span><span class="op" id="4575313">,</span>&nbsp;<span class="ident" id="4575315">n</span>&nbsp;<span class="ident" id="4575317">parse</span><span class="op" id="4575322">.</span><span class="ident" id="4575323">Node</span><span class="op" id="4575327">)</span>&nbsp;<span class="ident" id="4575329">context</span>&nbsp;<span class="op" id="4575337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575340">switch</span>&nbsp;<span class="ident" id="4575347">n</span>&nbsp;<span class="op" id="4575349">:=</span>&nbsp;<span class="ident" id="4575352">n</span><span class="op" id="4575353">.</span><span class="op" id="4575354">(</span><span class="keyword" id="4575355">type</span><span class="op" id="4575359">)</span>&nbsp;<span class="op" id="4575361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575364">case</span>&nbsp;<span class="op" id="4575369">*</span><span class="ident" id="4575370">parse</span><span class="op" id="4575375">.</span><span class="ident" id="4575376">ActionNode</span><span class="op" id="4575386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575390">return</span>&nbsp;<span class="ident" id="4575397">e</span><span class="op" id="4575398">.</span><span class="ident" id="4575399">escapeAction</span><span class="op" id="4575411">(</span><span class="ident" id="4575412">c</span><span class="op" id="4575413">,</span>&nbsp;<span class="ident" id="4575415">n</span><span class="op" id="4575416">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575419">case</span>&nbsp;<span class="op" id="4575424">*</span><span class="ident" id="4575425">parse</span><span class="op" id="4575430">.</span><span class="ident" id="4575431">IfNode</span><span class="op" id="4575437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575441">return</span>&nbsp;<span class="ident" id="4575448">e</span><span class="op" id="4575449">.</span><span class="ident" id="4575450">escapeBranch</span><span class="op" id="4575462">(</span><span class="ident" id="4575463">c</span><span class="op" id="4575464">,</span>&nbsp;<span class="op" id="4575466">&amp;</span><span class="ident" id="4575467">n</span><span class="op" id="4575468">.</span><span class="ident" id="4575469">BranchNode</span><span class="op" id="4575479">,</span>&nbsp;<span class="string" id="4575481">&#34;if&#34;</span><span class="op" id="4575485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575488">case</span>&nbsp;<span class="op" id="4575493">*</span><span class="ident" id="4575494">parse</span><span class="op" id="4575499">.</span><span class="ident" id="4575500">ListNode</span><span class="op" id="4575508">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575512">return</span>&nbsp;<span class="ident" id="4575519">e</span><span class="op" id="4575520">.</span><span class="ident" id="4575521">escapeList</span><span class="op" id="4575531">(</span><span class="ident" id="4575532">c</span><span class="op" id="4575533">,</span>&nbsp;<span class="ident" id="4575535">n</span><span class="op" id="4575536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575539">case</span>&nbsp;<span class="op" id="4575544">*</span><span class="ident" id="4575545">parse</span><span class="op" id="4575550">.</span><span class="ident" id="4575551">RangeNode</span><span class="op" id="4575560">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575564">return</span>&nbsp;<span class="ident" id="4575571">e</span><span class="op" id="4575572">.</span><span class="ident" id="4575573">escapeBranch</span><span class="op" id="4575585">(</span><span class="ident" id="4575586">c</span><span class="op" id="4575587">,</span>&nbsp;<span class="op" id="4575589">&amp;</span><span class="ident" id="4575590">n</span><span class="op" id="4575591">.</span><span class="ident" id="4575592">BranchNode</span><span class="op" id="4575602">,</span>&nbsp;<span class="string" id="4575604">&#34;range&#34;</span><span class="op" id="4575611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575614">case</span>&nbsp;<span class="op" id="4575619">*</span><span class="ident" id="4575620">parse</span><span class="op" id="4575625">.</span><span class="ident" id="4575626">TemplateNode</span><span class="op" id="4575638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575642">return</span>&nbsp;<span class="ident" id="4575649">e</span><span class="op" id="4575650">.</span><span class="ident" id="4575651">escapeTemplate</span><span class="op" id="4575665">(</span><span class="ident" id="4575666">c</span><span class="op" id="4575667">,</span>&nbsp;<span class="ident" id="4575669">n</span><span class="op" id="4575670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575673">case</span>&nbsp;<span class="op" id="4575678">*</span><span class="ident" id="4575679">parse</span><span class="op" id="4575684">.</span><span class="ident" id="4575685">TextNode</span><span class="op" id="4575693">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575697">return</span>&nbsp;<span class="ident" id="4575704">e</span><span class="op" id="4575705">.</span><span class="ident" id="4575706">escapeText</span><span class="op" id="4575716">(</span><span class="ident" id="4575717">c</span><span class="op" id="4575718">,</span>&nbsp;<span class="ident" id="4575720">n</span><span class="op" id="4575721">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575724">case</span>&nbsp;<span class="op" id="4575729">*</span><span class="ident" id="4575730">parse</span><span class="op" id="4575735">.</span><span class="ident" id="4575736">WithNode</span><span class="op" id="4575744">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575748">return</span>&nbsp;<span class="ident" id="4575755">e</span><span class="op" id="4575756">.</span><span class="ident" id="4575757">escapeBranch</span><span class="op" id="4575769">(</span><span class="ident" id="4575770">c</span><span class="op" id="4575771">,</span>&nbsp;<span class="op" id="4575773">&amp;</span><span class="ident" id="4575774">n</span><span class="op" id="4575775">.</span><span class="ident" id="4575776">BranchNode</span><span class="op" id="4575786">,</span>&nbsp;<span class="string" id="4575788">&#34;with&#34;</span><span class="op" id="4575794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4575797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4575800">panic</span><span class="op" id="4575805">(</span><span class="string" id="4575806">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="4575818">+</span>&nbsp;<span class="ident" id="4575820">n</span><span class="op" id="4575821">.</span><span class="ident" id="4575822">String</span><span class="op" id="4575828">(</span><span class="op" id="4575829">)</span>&nbsp;<span class="op" id="4575831">+</span>&nbsp;<span class="string" id="4575833">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="4575852">)</span><br>
<span class="lineno"></span><span class="op" id="4575854">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="4575857">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4575906">func</span>&nbsp;<span class="op" id="4575911">(</span><span class="ident" id="4575912">e</span>&nbsp;<span class="op" id="4575914">*</span><span class="ident" id="4575915">escaper</span><span class="op" id="4575922">)</span>&nbsp;<span class="ident" id="4575924">escapeAction</span><span class="op" id="4575936">(</span><span class="ident" id="4575937">c</span>&nbsp;<span class="ident" id="4575939">context</span><span class="op" id="4575946">,</span>&nbsp;<span class="ident" id="4575948">n</span>&nbsp;<span class="op" id="4575950">*</span><span class="ident" id="4575951">parse</span><span class="op" id="4575956">.</span><span class="ident" id="4575957">ActionNode</span><span class="op" id="4575967">)</span>&nbsp;<span class="ident" id="4575969">context</span>&nbsp;<span class="op" id="4575977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4575980">if</span>&nbsp;<span class="builtinfunc" id="4575983">len</span><span class="op" id="4575986">(</span><span class="ident" id="4575987">n</span><span class="op" id="4575988">.</span><span class="ident" id="4575989">Pipe</span><span class="op" id="4575993">.</span><span class="ident" id="4575994">Decl</span><span class="op" id="4575998">)</span>&nbsp;<span class="op" id="4576000">!=</span>&nbsp;<span class="num" id="4576003">0</span>&nbsp;<span class="op" id="4576005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576009">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576065">return</span>&nbsp;<span class="ident" id="4576072">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576078">c</span>&nbsp;<span class="op" id="4576080">=</span>&nbsp;<span class="ident" id="4576082">nudge</span><span class="op" id="4576087">(</span><span class="ident" id="4576088">c</span><span class="op" id="4576089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576092">s</span>&nbsp;<span class="op" id="4576094">:=</span>&nbsp;<span class="builtinfunc" id="4576097">make</span><span class="op" id="4576101">(</span><span class="op" id="4576102">[</span><span class="op" id="4576103">]</span><span class="builtintype" id="4576104">string</span><span class="op" id="4576110">,</span>&nbsp;<span class="num" id="4576112">0</span><span class="op" id="4576113">,</span>&nbsp;<span class="num" id="4576115">3</span><span class="op" id="4576116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576119">switch</span>&nbsp;<span class="ident" id="4576126">c</span><span class="op" id="4576127">.</span><span class="ident" id="4576128">state</span>&nbsp;<span class="op" id="4576134">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576137">case</span>&nbsp;<span class="ident" id="4576142">stateError</span><span class="op" id="4576152">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576156">return</span>&nbsp;<span class="ident" id="4576163">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576166">case</span>&nbsp;<span class="ident" id="4576171">stateURL</span><span class="op" id="4576179">,</span>&nbsp;<span class="ident" id="4576181">stateCSSDqStr</span><span class="op" id="4576194">,</span>&nbsp;<span class="ident" id="4576196">stateCSSSqStr</span><span class="op" id="4576209">,</span>&nbsp;<span class="ident" id="4576211">stateCSSDqURL</span><span class="op" id="4576224">,</span>&nbsp;<span class="ident" id="4576226">stateCSSSqURL</span><span class="op" id="4576239">,</span>&nbsp;<span class="ident" id="4576241">stateCSSURL</span><span class="op" id="4576252">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576256">switch</span>&nbsp;<span class="ident" id="4576263">c</span><span class="op" id="4576264">.</span><span class="ident" id="4576265">urlPart</span>&nbsp;<span class="op" id="4576273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576277">case</span>&nbsp;<span class="ident" id="4576282">urlPartNone</span><span class="op" id="4576293">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576298">s</span>&nbsp;<span class="op" id="4576300">=</span>&nbsp;<span class="builtinfunc" id="4576302">append</span><span class="op" id="4576308">(</span><span class="ident" id="4576309">s</span><span class="op" id="4576310">,</span>&nbsp;<span class="string" id="4576312">&#34;html_template_urlfilter&#34;</span><span class="op" id="4576337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576342">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576356">case</span>&nbsp;<span class="ident" id="4576361">urlPartPreQuery</span><span class="op" id="4576376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576381">switch</span>&nbsp;<span class="ident" id="4576388">c</span><span class="op" id="4576389">.</span><span class="ident" id="4576390">state</span>&nbsp;<span class="op" id="4576396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576401">case</span>&nbsp;<span class="ident" id="4576406">stateCSSDqStr</span><span class="op" id="4576419">,</span>&nbsp;<span class="ident" id="4576421">stateCSSSqStr</span><span class="op" id="4576434">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576440">s</span>&nbsp;<span class="op" id="4576442">=</span>&nbsp;<span class="builtinfunc" id="4576444">append</span><span class="op" id="4576450">(</span><span class="ident" id="4576451">s</span><span class="op" id="4576452">,</span>&nbsp;<span class="string" id="4576454">&#34;html_template_cssescaper&#34;</span><span class="op" id="4576480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576485">default</span><span class="op" id="4576492">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576498">s</span>&nbsp;<span class="op" id="4576500">=</span>&nbsp;<span class="builtinfunc" id="4576502">append</span><span class="op" id="4576508">(</span><span class="ident" id="4576509">s</span><span class="op" id="4576510">,</span>&nbsp;<span class="string" id="4576512">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4576541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576550">case</span>&nbsp;<span class="ident" id="4576555">urlPartQueryOrFrag</span><span class="op" id="4576573">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576578">s</span>&nbsp;<span class="op" id="4576580">=</span>&nbsp;<span class="builtinfunc" id="4576582">append</span><span class="op" id="4576588">(</span><span class="ident" id="4576589">s</span><span class="op" id="4576590">,</span>&nbsp;<span class="string" id="4576592">&#34;html_template_urlescaper&#34;</span><span class="op" id="4576618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576622">case</span>&nbsp;<span class="ident" id="4576627">urlPartUnknown</span><span class="op" id="4576641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576646">return</span>&nbsp;<span class="ident" id="4576653">context</span><span class="op" id="4576660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576666">state</span><span class="op" id="4576671">:</span>&nbsp;<span class="ident" id="4576673">stateError</span><span class="op" id="4576683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576689">err</span><span class="op" id="4576692">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4576696">errorf</span><span class="op" id="4576702">(</span><span class="ident" id="4576703">ErrAmbigContext</span><span class="op" id="4576718">,</span>&nbsp;<span class="ident" id="4576720">n</span><span class="op" id="4576721">,</span>&nbsp;<span class="ident" id="4576723">n</span><span class="op" id="4576724">.</span><span class="ident" id="4576725">Line</span><span class="op" id="4576729">,</span>&nbsp;<span class="string" id="4576731">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="4576771">,</span>&nbsp;<span class="ident" id="4576773">n</span><span class="op" id="4576774">)</span><span class="op" id="4576775">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576784">default</span><span class="op" id="4576791">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4576796">panic</span><span class="op" id="4576801">(</span><span class="ident" id="4576802">c</span><span class="op" id="4576803">.</span><span class="ident" id="4576804">urlPart</span><span class="op" id="4576811">.</span><span class="ident" id="4576812">String</span><span class="op" id="4576818">(</span><span class="op" id="4576819">)</span><span class="op" id="4576820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576827">case</span>&nbsp;<span class="ident" id="4576832">stateJS</span><span class="op" id="4576839">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576843">s</span>&nbsp;<span class="op" id="4576845">=</span>&nbsp;<span class="builtinfunc" id="4576847">append</span><span class="op" id="4576853">(</span><span class="ident" id="4576854">s</span><span class="op" id="4576855">,</span>&nbsp;<span class="string" id="4576857">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="4576885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4576889">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576939">c</span><span class="op" id="4576940">.</span><span class="ident" id="4576941">jsCtx</span>&nbsp;<span class="op" id="4576947">=</span>&nbsp;<span class="ident" id="4576949">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576961">case</span>&nbsp;<span class="ident" id="4576966">stateJSDqStr</span><span class="op" id="4576978">,</span>&nbsp;<span class="ident" id="4576980">stateJSSqStr</span><span class="op" id="4576992">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576996">s</span>&nbsp;<span class="op" id="4576998">=</span>&nbsp;<span class="builtinfunc" id="4577000">append</span><span class="op" id="4577006">(</span><span class="ident" id="4577007">s</span><span class="op" id="4577008">,</span>&nbsp;<span class="string" id="4577010">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4577038">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577041">case</span>&nbsp;<span class="ident" id="4577046">stateJSRegexp</span><span class="op" id="4577059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577063">s</span>&nbsp;<span class="op" id="4577065">=</span>&nbsp;<span class="builtinfunc" id="4577067">append</span><span class="op" id="4577073">(</span><span class="ident" id="4577074">s</span><span class="op" id="4577075">,</span>&nbsp;<span class="string" id="4577077">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4577108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577111">case</span>&nbsp;<span class="ident" id="4577116">stateCSS</span><span class="op" id="4577124">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577128">s</span>&nbsp;<span class="op" id="4577130">=</span>&nbsp;<span class="builtinfunc" id="4577132">append</span><span class="op" id="4577138">(</span><span class="ident" id="4577139">s</span><span class="op" id="4577140">,</span>&nbsp;<span class="string" id="4577142">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="4577172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577175">case</span>&nbsp;<span class="ident" id="4577180">stateText</span><span class="op" id="4577189">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577193">s</span>&nbsp;<span class="op" id="4577195">=</span>&nbsp;<span class="builtinfunc" id="4577197">append</span><span class="op" id="4577203">(</span><span class="ident" id="4577204">s</span><span class="op" id="4577205">,</span>&nbsp;<span class="string" id="4577207">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4577234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577237">case</span>&nbsp;<span class="ident" id="4577242">stateRCDATA</span><span class="op" id="4577253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577257">s</span>&nbsp;<span class="op" id="4577259">=</span>&nbsp;<span class="builtinfunc" id="4577261">append</span><span class="op" id="4577267">(</span><span class="ident" id="4577268">s</span><span class="op" id="4577269">,</span>&nbsp;<span class="string" id="4577271">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="4577300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577303">case</span>&nbsp;<span class="ident" id="4577308">stateAttr</span><span class="op" id="4577317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4577321">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577355">case</span>&nbsp;<span class="ident" id="4577360">stateAttrName</span><span class="op" id="4577373">,</span>&nbsp;<span class="ident" id="4577375">stateTag</span><span class="op" id="4577383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577387">c</span><span class="op" id="4577388">.</span><span class="ident" id="4577389">state</span>&nbsp;<span class="op" id="4577395">=</span>&nbsp;<span class="ident" id="4577397">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577413">s</span>&nbsp;<span class="op" id="4577415">=</span>&nbsp;<span class="builtinfunc" id="4577417">append</span><span class="op" id="4577423">(</span><span class="ident" id="4577424">s</span><span class="op" id="4577425">,</span>&nbsp;<span class="string" id="4577427">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="4577457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577460">default</span><span class="op" id="4577467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577471">if</span>&nbsp;<span class="ident" id="4577474">isComment</span><span class="op" id="4577483">(</span><span class="ident" id="4577484">c</span><span class="op" id="4577485">.</span><span class="ident" id="4577486">state</span><span class="op" id="4577491">)</span>&nbsp;<span class="op" id="4577493">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577498">s</span>&nbsp;<span class="op" id="4577500">=</span>&nbsp;<span class="builtinfunc" id="4577502">append</span><span class="op" id="4577508">(</span><span class="ident" id="4577509">s</span><span class="op" id="4577510">,</span>&nbsp;<span class="string" id="4577512">&#34;html_template_commentescaper&#34;</span><span class="op" id="4577542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577546">}</span>&nbsp;<span class="keyword" id="4577548">else</span>&nbsp;<span class="op" id="4577553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4577558">panic</span><span class="op" id="4577563">(</span><span class="string" id="4577564">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="4577584">+</span>&nbsp;<span class="ident" id="4577586">c</span><span class="op" id="4577587">.</span><span class="ident" id="4577588">state</span><span class="op" id="4577593">.</span><span class="ident" id="4577594">String</span><span class="op" id="4577600">(</span><span class="op" id="4577601">)</span><span class="op" id="4577602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577609">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577612">switch</span>&nbsp;<span class="ident" id="4577619">c</span><span class="op" id="4577620">.</span><span class="ident" id="4577621">delim</span>&nbsp;<span class="op" id="4577627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577630">case</span>&nbsp;<span class="ident" id="4577635">delimNone</span><span class="op" id="4577644">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4577648">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577699">case</span>&nbsp;<span class="ident" id="4577704">delimSpaceOrTagEnd</span><span class="op" id="4577722">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577726">s</span>&nbsp;<span class="op" id="4577728">=</span>&nbsp;<span class="builtinfunc" id="4577730">append</span><span class="op" id="4577736">(</span><span class="ident" id="4577737">s</span><span class="op" id="4577738">,</span>&nbsp;<span class="string" id="4577740">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4577770">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577773">default</span><span class="op" id="4577780">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577784">s</span>&nbsp;<span class="op" id="4577786">=</span>&nbsp;<span class="builtinfunc" id="4577788">append</span><span class="op" id="4577794">(</span><span class="ident" id="4577795">s</span><span class="op" id="4577796">,</span>&nbsp;<span class="string" id="4577798">&#34;html_template_attrescaper&#34;</span><span class="op" id="4577825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577831">e</span><span class="op" id="4577832">.</span><span class="ident" id="4577833">editActionNode</span><span class="op" id="4577847">(</span><span class="ident" id="4577848">n</span><span class="op" id="4577849">,</span>&nbsp;<span class="ident" id="4577851">s</span><span class="op" id="4577852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577855">return</span>&nbsp;<span class="ident" id="4577862">c</span><br>
<span class="lineno">205</span><span class="op" id="4577864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4577867">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="4577952">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="4578015">func</span>&nbsp;<span class="ident" id="4578020">allIdents</span><span class="op" id="4578029">(</span><span class="ident" id="4578030">node</span>&nbsp;<span class="ident" id="4578035">parse</span><span class="op" id="4578040">.</span><span class="ident" id="4578041">Node</span><span class="op" id="4578045">)</span>&nbsp;<span class="op" id="4578047">[</span><span class="op" id="4578048">]</span><span class="builtintype" id="4578049">string</span>&nbsp;<span class="op" id="4578056">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578059">switch</span>&nbsp;<span class="ident" id="4578066">node</span>&nbsp;<span class="op" id="4578071">:=</span>&nbsp;<span class="ident" id="4578074">node</span><span class="op" id="4578078">.</span><span class="op" id="4578079">(</span><span class="keyword" id="4578080">type</span><span class="op" id="4578084">)</span>&nbsp;<span class="op" id="4578086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578089">case</span>&nbsp;<span class="op" id="4578094">*</span><span class="ident" id="4578095">parse</span><span class="op" id="4578100">.</span><span class="ident" id="4578101">IdentifierNode</span><span class="op" id="4578115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578119">return</span>&nbsp;<span class="op" id="4578126">[</span><span class="op" id="4578127">]</span><span class="builtintype" id="4578128">string</span><span class="op" id="4578134">{</span><span class="ident" id="4578135">node</span><span class="op" id="4578139">.</span><span class="ident" id="4578140">Ident</span><span class="op" id="4578145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578148">case</span>&nbsp;<span class="op" id="4578153">*</span><span class="ident" id="4578154">parse</span><span class="op" id="4578159">.</span><span class="ident" id="4578160">FieldNode</span><span class="op" id="4578169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578173">return</span>&nbsp;<span class="ident" id="4578180">node</span><span class="op" id="4578184">.</span><span class="ident" id="4578185">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4578195">panic</span><span class="op" id="4578200">(</span><span class="string" id="4578201">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="4578238">)</span><br>
<span class="lineno"></span><span class="op" id="4578240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4578243">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="4578313">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="4578347">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="4578420">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4578497">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="4578571">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="4578601">func</span>&nbsp;<span class="ident" id="4578606">ensurePipelineContains</span><span class="op" id="4578628">(</span><span class="ident" id="4578629">p</span>&nbsp;<span class="op" id="4578631">*</span><span class="ident" id="4578632">parse</span><span class="op" id="4578637">.</span><span class="ident" id="4578638">PipeNode</span><span class="op" id="4578646">,</span>&nbsp;<span class="ident" id="4578648">s</span>&nbsp;<span class="op" id="4578650">[</span><span class="op" id="4578651">]</span><span class="builtintype" id="4578652">string</span><span class="op" id="4578658">)</span>&nbsp;<span class="op" id="4578660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578663">if</span>&nbsp;<span class="builtinfunc" id="4578666">len</span><span class="op" id="4578669">(</span><span class="ident" id="4578670">s</span><span class="op" id="4578671">)</span>&nbsp;<span class="op" id="4578673">==</span>&nbsp;<span class="num" id="4578676">0</span>&nbsp;<span class="op" id="4578678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578682">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578693">n</span>&nbsp;<span class="op" id="4578695">:=</span>&nbsp;<span class="builtinfunc" id="4578698">len</span><span class="op" id="4578701">(</span><span class="ident" id="4578702">p</span><span class="op" id="4578703">.</span><span class="ident" id="4578704">Cmds</span><span class="op" id="4578708">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4578711">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578769">idents</span>&nbsp;<span class="op" id="4578776">:=</span>&nbsp;<span class="ident" id="4578779">p</span><span class="op" id="4578780">.</span><span class="ident" id="4578781">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578787">for</span>&nbsp;<span class="ident" id="4578791">i</span>&nbsp;<span class="op" id="4578793">:=</span>&nbsp;<span class="ident" id="4578796">n</span>&nbsp;<span class="op" id="4578798">-</span>&nbsp;<span class="num" id="4578800">1</span><span class="op" id="4578801">;</span>&nbsp;<span class="ident" id="4578803">i</span>&nbsp;<span class="op" id="4578805">&gt;=</span>&nbsp;<span class="num" id="4578808">0</span><span class="op" id="4578809">;</span>&nbsp;<span class="ident" id="4578811">i</span><span class="op" id="4578812">--</span>&nbsp;<span class="op" id="4578815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578819">if</span>&nbsp;<span class="ident" id="4578822">cmd</span>&nbsp;<span class="op" id="4578826">:=</span>&nbsp;<span class="ident" id="4578829">p</span><span class="op" id="4578830">.</span><span class="ident" id="4578831">Cmds</span><span class="op" id="4578835">[</span><span class="ident" id="4578836">i</span><span class="op" id="4578837">]</span><span class="op" id="4578838">;</span>&nbsp;<span class="builtinfunc" id="4578840">len</span><span class="op" id="4578843">(</span><span class="ident" id="4578844">cmd</span><span class="op" id="4578847">.</span><span class="ident" id="4578848">Args</span><span class="op" id="4578852">)</span>&nbsp;<span class="op" id="4578854">!=</span>&nbsp;<span class="num" id="4578857">0</span>&nbsp;<span class="op" id="4578859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578864">if</span>&nbsp;<span class="ident" id="4578867">_</span><span class="op" id="4578868">,</span>&nbsp;<span class="ident" id="4578870">ok</span>&nbsp;<span class="op" id="4578873">:=</span>&nbsp;<span class="ident" id="4578876">cmd</span><span class="op" id="4578879">.</span><span class="ident" id="4578880">Args</span><span class="op" id="4578884">[</span><span class="num" id="4578885">0</span><span class="op" id="4578886">]</span><span class="op" id="4578887">.</span><span class="op" id="4578888">(</span><span class="op" id="4578889">*</span><span class="ident" id="4578890">parse</span><span class="op" id="4578895">.</span><span class="ident" id="4578896">IdentifierNode</span><span class="op" id="4578910">)</span><span class="op" id="4578911">;</span>&nbsp;<span class="ident" id="4578913">ok</span>&nbsp;<span class="op" id="4578916">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578922">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578942">idents</span>&nbsp;<span class="op" id="4578949">=</span>&nbsp;<span class="ident" id="4578951">p</span><span class="op" id="4578952">.</span><span class="ident" id="4578953">Cmds</span><span class="op" id="4578957">[</span><span class="ident" id="4578958">i</span><span class="op" id="4578959">+</span><span class="num" id="4578960">1</span><span class="op" id="4578961">:</span><span class="op" id="4578962">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578965">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578968">dups</span>&nbsp;<span class="op" id="4578973">:=</span>&nbsp;<span class="num" id="4578976">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578979">for</span>&nbsp;<span class="ident" id="4578983">_</span><span class="op" id="4578984">,</span>&nbsp;<span class="ident" id="4578986">idNode</span>&nbsp;<span class="op" id="4578993">:=</span>&nbsp;<span class="keyword" id="4578996">range</span>&nbsp;<span class="ident" id="4579002">idents</span>&nbsp;<span class="op" id="4579009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579013">for</span>&nbsp;<span class="ident" id="4579017">_</span><span class="op" id="4579018">,</span>&nbsp;<span class="ident" id="4579020">ident</span>&nbsp;<span class="op" id="4579026">:=</span>&nbsp;<span class="keyword" id="4579029">range</span>&nbsp;<span class="ident" id="4579035">allIdents</span><span class="op" id="4579044">(</span><span class="ident" id="4579045">idNode</span><span class="op" id="4579051">.</span><span class="ident" id="4579052">Args</span><span class="op" id="4579056">[</span><span class="num" id="4579057">0</span><span class="op" id="4579058">]</span><span class="op" id="4579059">)</span>&nbsp;<span class="op" id="4579061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579066">if</span>&nbsp;<span class="ident" id="4579069">escFnsEq</span><span class="op" id="4579077">(</span><span class="ident" id="4579078">s</span><span class="op" id="4579079">[</span><span class="ident" id="4579080">dups</span><span class="op" id="4579084">]</span><span class="op" id="4579085">,</span>&nbsp;<span class="ident" id="4579087">ident</span><span class="op" id="4579092">)</span>&nbsp;<span class="op" id="4579094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579100">dups</span><span class="op" id="4579104">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579111">if</span>&nbsp;<span class="ident" id="4579114">dups</span>&nbsp;<span class="op" id="4579119">==</span>&nbsp;<span class="builtinfunc" id="4579122">len</span><span class="op" id="4579125">(</span><span class="ident" id="4579126">s</span><span class="op" id="4579127">)</span>&nbsp;<span class="op" id="4579129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579136">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579156">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579162">newCmds</span>&nbsp;<span class="op" id="4579170">:=</span>&nbsp;<span class="builtinfunc" id="4579173">make</span><span class="op" id="4579177">(</span><span class="op" id="4579178">[</span><span class="op" id="4579179">]</span><span class="op" id="4579180">*</span><span class="ident" id="4579181">parse</span><span class="op" id="4579186">.</span><span class="ident" id="4579187">CommandNode</span><span class="op" id="4579198">,</span>&nbsp;<span class="ident" id="4579200">n</span><span class="op" id="4579201">-</span><span class="builtinfunc" id="4579202">len</span><span class="op" id="4579205">(</span><span class="ident" id="4579206">idents</span><span class="op" id="4579212">)</span><span class="op" id="4579213">,</span>&nbsp;<span class="ident" id="4579215">n</span><span class="op" id="4579216">+</span><span class="builtinfunc" id="4579217">len</span><span class="op" id="4579220">(</span><span class="ident" id="4579221">s</span><span class="op" id="4579222">)</span><span class="op" id="4579223">-</span><span class="ident" id="4579224">dups</span><span class="op" id="4579228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4579231">copy</span><span class="op" id="4579235">(</span><span class="ident" id="4579236">newCmds</span><span class="op" id="4579243">,</span>&nbsp;<span class="ident" id="4579245">p</span><span class="op" id="4579246">.</span><span class="ident" id="4579247">Cmds</span><span class="op" id="4579251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4579254">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579321">for</span>&nbsp;<span class="ident" id="4579325">_</span><span class="op" id="4579326">,</span>&nbsp;<span class="ident" id="4579328">idNode</span>&nbsp;<span class="op" id="4579335">:=</span>&nbsp;<span class="keyword" id="4579338">range</span>&nbsp;<span class="ident" id="4579344">idents</span>&nbsp;<span class="op" id="4579351">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579355">pos</span>&nbsp;<span class="op" id="4579359">:=</span>&nbsp;<span class="ident" id="4579362">idNode</span><span class="op" id="4579368">.</span><span class="ident" id="4579369">Args</span><span class="op" id="4579373">[</span><span class="num" id="4579374">0</span><span class="op" id="4579375">]</span><span class="op" id="4579376">.</span><span class="ident" id="4579377">Position</span><span class="op" id="4579385">(</span><span class="op" id="4579386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579390">for</span>&nbsp;<span class="ident" id="4579394">_</span><span class="op" id="4579395">,</span>&nbsp;<span class="ident" id="4579397">ident</span>&nbsp;<span class="op" id="4579403">:=</span>&nbsp;<span class="keyword" id="4579406">range</span>&nbsp;<span class="ident" id="4579412">allIdents</span><span class="op" id="4579421">(</span><span class="ident" id="4579422">idNode</span><span class="op" id="4579428">.</span><span class="ident" id="4579429">Args</span><span class="op" id="4579433">[</span><span class="num" id="4579434">0</span><span class="op" id="4579435">]</span><span class="op" id="4579436">)</span>&nbsp;<span class="op" id="4579438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579443">i</span>&nbsp;<span class="op" id="4579445">:=</span>&nbsp;<span class="ident" id="4579448">indexOfStr</span><span class="op" id="4579458">(</span><span class="ident" id="4579459">ident</span><span class="op" id="4579464">,</span>&nbsp;<span class="ident" id="4579466">s</span><span class="op" id="4579467">,</span>&nbsp;<span class="ident" id="4579469">escFnsEq</span><span class="op" id="4579477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579482">if</span>&nbsp;<span class="ident" id="4579485">i</span>&nbsp;<span class="op" id="4579487">!=</span>&nbsp;<span class="op" id="4579490">-</span><span class="num" id="4579491">1</span>&nbsp;<span class="op" id="4579493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579499">for</span>&nbsp;<span class="ident" id="4579503">_</span><span class="op" id="4579504">,</span>&nbsp;<span class="ident" id="4579506">name</span>&nbsp;<span class="op" id="4579511">:=</span>&nbsp;<span class="keyword" id="4579514">range</span>&nbsp;<span class="ident" id="4579520">s</span><span class="op" id="4579521">[</span><span class="op" id="4579522">:</span><span class="ident" id="4579523">i</span><span class="op" id="4579524">]</span>&nbsp;<span class="op" id="4579526">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579533">newCmds</span>&nbsp;<span class="op" id="4579541">=</span>&nbsp;<span class="ident" id="4579543">appendCmd</span><span class="op" id="4579552">(</span><span class="ident" id="4579553">newCmds</span><span class="op" id="4579560">,</span>&nbsp;<span class="ident" id="4579562">newIdentCmd</span><span class="op" id="4579573">(</span><span class="ident" id="4579574">name</span><span class="op" id="4579578">,</span>&nbsp;<span class="ident" id="4579580">pos</span><span class="op" id="4579583">)</span><span class="op" id="4579584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579596">s</span>&nbsp;<span class="op" id="4579598">=</span>&nbsp;<span class="ident" id="4579600">s</span><span class="op" id="4579601">[</span><span class="ident" id="4579602">i</span><span class="op" id="4579603">+</span><span class="num" id="4579604">1</span><span class="op" id="4579605">:</span><span class="op" id="4579606">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579615">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579619">newCmds</span>&nbsp;<span class="op" id="4579627">=</span>&nbsp;<span class="ident" id="4579629">appendCmd</span><span class="op" id="4579638">(</span><span class="ident" id="4579639">newCmds</span><span class="op" id="4579646">,</span>&nbsp;<span class="ident" id="4579648">idNode</span><span class="op" id="4579654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4579660">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579697">for</span>&nbsp;<span class="ident" id="4579701">_</span><span class="op" id="4579702">,</span>&nbsp;<span class="ident" id="4579704">name</span>&nbsp;<span class="op" id="4579709">:=</span>&nbsp;<span class="keyword" id="4579712">range</span>&nbsp;<span class="ident" id="4579718">s</span>&nbsp;<span class="op" id="4579720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579724">newCmds</span>&nbsp;<span class="op" id="4579732">=</span>&nbsp;<span class="ident" id="4579734">appendCmd</span><span class="op" id="4579743">(</span><span class="ident" id="4579744">newCmds</span><span class="op" id="4579751">,</span>&nbsp;<span class="ident" id="4579753">newIdentCmd</span><span class="op" id="4579764">(</span><span class="ident" id="4579765">name</span><span class="op" id="4579769">,</span>&nbsp;<span class="ident" id="4579771">p</span><span class="op" id="4579772">.</span><span class="ident" id="4579773">Position</span><span class="op" id="4579781">(</span><span class="op" id="4579782">)</span><span class="op" id="4579783">)</span><span class="op" id="4579784">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579790">p</span><span class="op" id="4579791">.</span><span class="ident" id="4579792">Cmds</span>&nbsp;<span class="op" id="4579797">=</span>&nbsp;<span class="ident" id="4579799">newCmds</span><br>
<span class="lineno"></span><span class="op" id="4579807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4579810">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="4579890">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="4579904">var</span>&nbsp;<span class="ident" id="4579908">redundantFuncs</span>&nbsp;<span class="op" id="4579923">=</span>&nbsp;<span class="keyword" id="4579925">map</span><span class="op" id="4579928">[</span><span class="builtintype" id="4579929">string</span><span class="op" id="4579935">]</span><span class="keyword" id="4579936">map</span><span class="op" id="4579939">[</span><span class="builtintype" id="4579940">string</span><span class="op" id="4579946">]</span><span class="builtintype" id="4579947">bool</span><span class="op" id="4579951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4579954">&#34;html_template_commentescaper&#34;</span><span class="op" id="4579984">:</span>&nbsp;<span class="op" id="4579986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4579990">&#34;html_template_attrescaper&#34;</span><span class="op" id="4580017">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4580022">true</span><span class="op" id="4580026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580030">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="4580060">:</span>&nbsp;<span class="builtintype" id="4580062">true</span><span class="op" id="4580066">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580070">&#34;html_template_htmlescaper&#34;</span><span class="op" id="4580097">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4580102">true</span><span class="op" id="4580106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580109">}</span><span class="op" id="4580110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580113">&#34;html_template_cssescaper&#34;</span><span class="op" id="4580139">:</span>&nbsp;<span class="op" id="4580141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580145">&#34;html_template_attrescaper&#34;</span><span class="op" id="4580172">:</span>&nbsp;<span class="builtintype" id="4580174">true</span><span class="op" id="4580178">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580181">}</span><span class="op" id="4580182">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580185">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="4580216">:</span>&nbsp;<span class="op" id="4580218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580222">&#34;html_template_attrescaper&#34;</span><span class="op" id="4580249">:</span>&nbsp;<span class="builtintype" id="4580251">true</span><span class="op" id="4580255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580258">}</span><span class="op" id="4580259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580262">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="4580290">:</span>&nbsp;<span class="op" id="4580292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580296">&#34;html_template_attrescaper&#34;</span><span class="op" id="4580323">:</span>&nbsp;<span class="builtintype" id="4580325">true</span><span class="op" id="4580329">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580332">}</span><span class="op" id="4580333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580336">&#34;html_template_urlescaper&#34;</span><span class="op" id="4580362">:</span>&nbsp;<span class="op" id="4580364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4580368">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="4580397">:</span>&nbsp;<span class="builtintype" id="4580399">true</span><span class="op" id="4580403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580406">}</span><span class="op" id="4580407">,</span><br>
<span class="lineno"></span><span class="op" id="4580409">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="4580412">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="4580486">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="4580535">func</span>&nbsp;<span class="ident" id="4580540">appendCmd</span><span class="op" id="4580549">(</span><span class="ident" id="4580550">cmds</span>&nbsp;<span class="op" id="4580555">[</span><span class="op" id="4580556">]</span><span class="op" id="4580557">*</span><span class="ident" id="4580558">parse</span><span class="op" id="4580563">.</span><span class="ident" id="4580564">CommandNode</span><span class="op" id="4580575">,</span>&nbsp;<span class="ident" id="4580577">cmd</span>&nbsp;<span class="op" id="4580581">*</span><span class="ident" id="4580582">parse</span><span class="op" id="4580587">.</span><span class="ident" id="4580588">CommandNode</span><span class="op" id="4580599">)</span>&nbsp;<span class="op" id="4580601">[</span><span class="op" id="4580602">]</span><span class="op" id="4580603">*</span><span class="ident" id="4580604">parse</span><span class="op" id="4580609">.</span><span class="ident" id="4580610">CommandNode</span>&nbsp;<span class="op" id="4580622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580625">if</span>&nbsp;<span class="ident" id="4580628">n</span>&nbsp;<span class="op" id="4580630">:=</span>&nbsp;<span class="builtinfunc" id="4580633">len</span><span class="op" id="4580636">(</span><span class="ident" id="4580637">cmds</span><span class="op" id="4580641">)</span><span class="op" id="4580642">;</span>&nbsp;<span class="ident" id="4580644">n</span>&nbsp;<span class="op" id="4580646">!=</span>&nbsp;<span class="num" id="4580649">0</span>&nbsp;<span class="op" id="4580651">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580655">last</span><span class="op" id="4580659">,</span>&nbsp;<span class="ident" id="4580661">ok</span>&nbsp;<span class="op" id="4580664">:=</span>&nbsp;<span class="ident" id="4580667">cmds</span><span class="op" id="4580671">[</span><span class="ident" id="4580672">n</span><span class="op" id="4580673">-</span><span class="num" id="4580674">1</span><span class="op" id="4580675">]</span><span class="op" id="4580676">.</span><span class="ident" id="4580677">Args</span><span class="op" id="4580681">[</span><span class="num" id="4580682">0</span><span class="op" id="4580683">]</span><span class="op" id="4580684">.</span><span class="op" id="4580685">(</span><span class="op" id="4580686">*</span><span class="ident" id="4580687">parse</span><span class="op" id="4580692">.</span><span class="ident" id="4580693">IdentifierNode</span><span class="op" id="4580707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580711">next</span><span class="op" id="4580715">,</span>&nbsp;<span class="ident" id="4580717">_</span>&nbsp;<span class="op" id="4580719">:=</span>&nbsp;<span class="ident" id="4580722">cmd</span><span class="op" id="4580725">.</span><span class="ident" id="4580726">Args</span><span class="op" id="4580730">[</span><span class="num" id="4580731">0</span><span class="op" id="4580732">]</span><span class="op" id="4580733">.</span><span class="op" id="4580734">(</span><span class="op" id="4580735">*</span><span class="ident" id="4580736">parse</span><span class="op" id="4580741">.</span><span class="ident" id="4580742">IdentifierNode</span><span class="op" id="4580756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580760">if</span>&nbsp;<span class="ident" id="4580763">ok</span>&nbsp;<span class="op" id="4580766">&amp;&amp;</span>&nbsp;<span class="ident" id="4580769">redundantFuncs</span><span class="op" id="4580783">[</span><span class="ident" id="4580784">last</span><span class="op" id="4580788">.</span><span class="ident" id="4580789">Ident</span><span class="op" id="4580794">]</span><span class="op" id="4580795">[</span><span class="ident" id="4580796">next</span><span class="op" id="4580800">.</span><span class="ident" id="4580801">Ident</span><span class="op" id="4580806">]</span>&nbsp;<span class="op" id="4580808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580813">return</span>&nbsp;<span class="ident" id="4580820">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580827">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580833">return</span>&nbsp;<span class="builtinfunc" id="4580840">append</span><span class="op" id="4580846">(</span><span class="ident" id="4580847">cmds</span><span class="op" id="4580851">,</span>&nbsp;<span class="ident" id="4580853">cmd</span><span class="op" id="4580856">)</span><br>
<span class="lineno"></span><span class="op" id="4580858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4580861">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="4580941">func</span>&nbsp;<span class="ident" id="4580946">indexOfStr</span><span class="op" id="4580956">(</span><span class="ident" id="4580957">s</span>&nbsp;<span class="builtintype" id="4580959">string</span><span class="op" id="4580965">,</span>&nbsp;<span class="ident" id="4580967">strs</span>&nbsp;<span class="op" id="4580972">[</span><span class="op" id="4580973">]</span><span class="builtintype" id="4580974">string</span><span class="op" id="4580980">,</span>&nbsp;<span class="ident" id="4580982">eq</span>&nbsp;<span class="keyword" id="4580985">func</span><span class="op" id="4580989">(</span><span class="ident" id="4580990">a</span><span class="op" id="4580991">,</span>&nbsp;<span class="ident" id="4580993">b</span>&nbsp;<span class="builtintype" id="4580995">string</span><span class="op" id="4581001">)</span>&nbsp;<span class="builtintype" id="4581003">bool</span><span class="op" id="4581007">)</span>&nbsp;<span class="builtintype" id="4581009">int</span>&nbsp;<span class="op" id="4581013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581016">for</span>&nbsp;<span class="ident" id="4581020">i</span><span class="op" id="4581021">,</span>&nbsp;<span class="ident" id="4581023">t</span>&nbsp;<span class="op" id="4581025">:=</span>&nbsp;<span class="keyword" id="4581028">range</span>&nbsp;<span class="ident" id="4581034">strs</span>&nbsp;<span class="op" id="4581039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581043">if</span>&nbsp;<span class="ident" id="4581046">eq</span><span class="op" id="4581048">(</span><span class="ident" id="4581049">s</span><span class="op" id="4581050">,</span>&nbsp;<span class="ident" id="4581052">t</span><span class="op" id="4581053">)</span>&nbsp;<span class="op" id="4581055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581060">return</span>&nbsp;<span class="ident" id="4581067">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4581071">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4581074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581077">return</span>&nbsp;<span class="op" id="4581084">-</span><span class="num" id="4581085">1</span><br>
<span class="lineno"></span><span class="op" id="4581087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4581090">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="4581161">func</span>&nbsp;<span class="ident" id="4581166">escFnsEq</span><span class="op" id="4581174">(</span><span class="ident" id="4581175">a</span><span class="op" id="4581176">,</span>&nbsp;<span class="ident" id="4581178">b</span>&nbsp;<span class="builtintype" id="4581180">string</span><span class="op" id="4581186">)</span>&nbsp;<span class="builtintype" id="4581188">bool</span>&nbsp;<span class="op" id="4581193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581196">if</span>&nbsp;<span class="ident" id="4581199">e</span>&nbsp;<span class="op" id="4581201">:=</span>&nbsp;<span class="ident" id="4581204">equivEscapers</span><span class="op" id="4581217">[</span><span class="ident" id="4581218">a</span><span class="op" id="4581219">]</span><span class="op" id="4581220">;</span>&nbsp;<span class="ident" id="4581222">e</span>&nbsp;<span class="op" id="4581224">!=</span>&nbsp;<span class="string" id="4581227">&#34;&#34;</span>&nbsp;<span class="op" id="4581230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581234">a</span>&nbsp;<span class="op" id="4581236">=</span>&nbsp;<span class="ident" id="4581238">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4581241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581244">if</span>&nbsp;<span class="ident" id="4581247">e</span>&nbsp;<span class="op" id="4581249">:=</span>&nbsp;<span class="ident" id="4581252">equivEscapers</span><span class="op" id="4581265">[</span><span class="ident" id="4581266">b</span><span class="op" id="4581267">]</span><span class="op" id="4581268">;</span>&nbsp;<span class="ident" id="4581270">e</span>&nbsp;<span class="op" id="4581272">!=</span>&nbsp;<span class="string" id="4581275">&#34;&#34;</span>&nbsp;<span class="op" id="4581278">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581282">b</span>&nbsp;<span class="op" id="4581284">=</span>&nbsp;<span class="ident" id="4581286">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4581289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581292">return</span>&nbsp;<span class="ident" id="4581299">a</span>&nbsp;<span class="op" id="4581301">==</span>&nbsp;<span class="ident" id="4581304">b</span><br>
<span class="lineno"></span><span class="op" id="4581306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="4581309">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4581380">func</span>&nbsp;<span class="ident" id="4581385">newIdentCmd</span><span class="op" id="4581396">(</span><span class="ident" id="4581397">identifier</span>&nbsp;<span class="builtintype" id="4581408">string</span><span class="op" id="4581414">,</span>&nbsp;<span class="ident" id="4581416">pos</span>&nbsp;<span class="ident" id="4581420">parse</span><span class="op" id="4581425">.</span><span class="ident" id="4581426">Pos</span><span class="op" id="4581429">)</span>&nbsp;<span class="op" id="4581431">*</span><span class="ident" id="4581432">parse</span><span class="op" id="4581437">.</span><span class="ident" id="4581438">CommandNode</span>&nbsp;<span class="op" id="4581450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4581453">return</span>&nbsp;<span class="op" id="4581460">&amp;</span><span class="ident" id="4581461">parse</span><span class="op" id="4581466">.</span><span class="ident" id="4581467">CommandNode</span><span class="op" id="4581478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581482">NodeType</span><span class="op" id="4581490">:</span>&nbsp;<span class="ident" id="4581492">parse</span><span class="op" id="4581497">.</span><span class="ident" id="4581498">NodeCommand</span><span class="op" id="4581509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4581513">Args</span><span class="op" id="4581517">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4581523">[</span><span class="op" id="4581524">]</span><span class="ident" id="4581525">parse</span><span class="op" id="4581530">.</span><span class="ident" id="4581531">Node</span><span class="op" id="4581535">{</span><span class="ident" id="4581536">parse</span><span class="op" id="4581541">.</span><span class="ident" id="4581542">NewIdentifier</span><span class="op" id="4581555">(</span><span class="ident" id="4581556">identifier</span><span class="op" id="4581566">)</span><span class="op" id="4581567">.</span><span class="ident" id="4581568">SetTree</span><span class="op" id="4581575">(</span><span class="ident" id="4581576">nil</span><span class="op" id="4581579">)</span><span class="op" id="4581580">.</span><span class="ident" id="4581581">SetPos</span><span class="op" id="4581587">(</span><span class="ident" id="4581588">pos</span><span class="op" id="4581591">)</span><span class="op" id="4581592">}</span><span class="op" id="4581593">,</span>&nbsp;<span class="comment" id="4581595">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4581614">}</span><br>
<span class="lineno"></span><span class="op" id="4581616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4581619">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4581694">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="4581733">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="4581758">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="4581776">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="4581855">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="4581874">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="4581933">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="4581996">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="4582074">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4582106">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="4582172">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="4582237">func</span>&nbsp;<span class="ident" id="4582242">nudge</span><span class="op" id="4582247">(</span><span class="ident" id="4582248">c</span>&nbsp;<span class="ident" id="4582250">context</span><span class="op" id="4582257">)</span>&nbsp;<span class="ident" id="4582259">context</span>&nbsp;<span class="op" id="4582267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582270">switch</span>&nbsp;<span class="ident" id="4582277">c</span><span class="op" id="4582278">.</span><span class="ident" id="4582279">state</span>&nbsp;<span class="op" id="4582285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582288">case</span>&nbsp;<span class="ident" id="4582293">stateTag</span><span class="op" id="4582301">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582305">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582364">c</span><span class="op" id="4582365">.</span><span class="ident" id="4582366">state</span>&nbsp;<span class="op" id="4582372">=</span>&nbsp;<span class="ident" id="4582374">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582389">case</span>&nbsp;<span class="ident" id="4582394">stateBeforeValue</span><span class="op" id="4582410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582414">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582476">c</span><span class="op" id="4582477">.</span><span class="ident" id="4582478">state</span><span class="op" id="4582483">,</span>&nbsp;<span class="ident" id="4582485">c</span><span class="op" id="4582486">.</span><span class="ident" id="4582487">delim</span><span class="op" id="4582492">,</span>&nbsp;<span class="ident" id="4582494">c</span><span class="op" id="4582495">.</span><span class="ident" id="4582496">attr</span>&nbsp;<span class="op" id="4582501">=</span>&nbsp;<span class="ident" id="4582503">attrStartStates</span><span class="op" id="4582518">[</span><span class="ident" id="4582519">c</span><span class="op" id="4582520">.</span><span class="ident" id="4582521">attr</span><span class="op" id="4582525">]</span><span class="op" id="4582526">,</span>&nbsp;<span class="ident" id="4582528">delimSpaceOrTagEnd</span><span class="op" id="4582546">,</span>&nbsp;<span class="ident" id="4582548">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582558">case</span>&nbsp;<span class="ident" id="4582563">stateAfterName</span><span class="op" id="4582577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4582581">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4582640">c</span><span class="op" id="4582641">.</span><span class="ident" id="4582642">state</span><span class="op" id="4582647">,</span>&nbsp;<span class="ident" id="4582649">c</span><span class="op" id="4582650">.</span><span class="ident" id="4582651">attr</span>&nbsp;<span class="op" id="4582656">=</span>&nbsp;<span class="ident" id="4582658">stateAttrName</span><span class="op" id="4582671">,</span>&nbsp;<span class="ident" id="4582673">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4582683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582686">return</span>&nbsp;<span class="ident" id="4582693">c</span><br>
<span class="lineno"></span><span class="op" id="4582695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="4582698">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4582773">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4582852">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="4582882">func</span>&nbsp;<span class="ident" id="4582887">join</span><span class="op" id="4582891">(</span><span class="ident" id="4582892">a</span><span class="op" id="4582893">,</span>&nbsp;<span class="ident" id="4582895">b</span>&nbsp;<span class="ident" id="4582897">context</span><span class="op" id="4582904">,</span>&nbsp;<span class="ident" id="4582906">node</span>&nbsp;<span class="ident" id="4582911">parse</span><span class="op" id="4582916">.</span><span class="ident" id="4582917">Node</span><span class="op" id="4582921">,</span>&nbsp;<span class="ident" id="4582923">nodeName</span>&nbsp;<span class="builtintype" id="4582932">string</span><span class="op" id="4582938">)</span>&nbsp;<span class="ident" id="4582940">context</span>&nbsp;<span class="op" id="4582948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582951">if</span>&nbsp;<span class="ident" id="4582954">a</span><span class="op" id="4582955">.</span><span class="ident" id="4582956">state</span>&nbsp;<span class="op" id="4582962">==</span>&nbsp;<span class="ident" id="4582965">stateError</span>&nbsp;<span class="op" id="4582976">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582980">return</span>&nbsp;<span class="ident" id="4582987">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4582990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4582993">if</span>&nbsp;<span class="ident" id="4582996">b</span><span class="op" id="4582997">.</span><span class="ident" id="4582998">state</span>&nbsp;<span class="op" id="4583004">==</span>&nbsp;<span class="ident" id="4583007">stateError</span>&nbsp;<span class="op" id="4583018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583022">return</span>&nbsp;<span class="ident" id="4583029">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583032">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583035">if</span>&nbsp;<span class="ident" id="4583038">a</span><span class="op" id="4583039">.</span><span class="ident" id="4583040">eq</span><span class="op" id="4583042">(</span><span class="ident" id="4583043">b</span><span class="op" id="4583044">)</span>&nbsp;<span class="op" id="4583046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583050">return</span>&nbsp;<span class="ident" id="4583057">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583064">c</span>&nbsp;<span class="op" id="4583066">:=</span>&nbsp;<span class="ident" id="4583069">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583072">c</span><span class="op" id="4583073">.</span><span class="ident" id="4583074">urlPart</span>&nbsp;<span class="op" id="4583082">=</span>&nbsp;<span class="ident" id="4583084">b</span><span class="op" id="4583085">.</span><span class="ident" id="4583086">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583095">if</span>&nbsp;<span class="ident" id="4583098">c</span><span class="op" id="4583099">.</span><span class="ident" id="4583100">eq</span><span class="op" id="4583102">(</span><span class="ident" id="4583103">b</span><span class="op" id="4583104">)</span>&nbsp;<span class="op" id="4583106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583110">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583152">c</span><span class="op" id="4583153">.</span><span class="ident" id="4583154">urlPart</span>&nbsp;<span class="op" id="4583162">=</span>&nbsp;<span class="ident" id="4583164">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583181">return</span>&nbsp;<span class="ident" id="4583188">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583195">c</span>&nbsp;<span class="op" id="4583197">=</span>&nbsp;<span class="ident" id="4583199">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583202">c</span><span class="op" id="4583203">.</span><span class="ident" id="4583204">jsCtx</span>&nbsp;<span class="op" id="4583210">=</span>&nbsp;<span class="ident" id="4583212">b</span><span class="op" id="4583213">.</span><span class="ident" id="4583214">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583221">if</span>&nbsp;<span class="ident" id="4583224">c</span><span class="op" id="4583225">.</span><span class="ident" id="4583226">eq</span><span class="op" id="4583228">(</span><span class="ident" id="4583229">b</span><span class="op" id="4583230">)</span>&nbsp;<span class="op" id="4583232">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583236">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583276">c</span><span class="op" id="4583277">.</span><span class="ident" id="4583278">jsCtx</span>&nbsp;<span class="op" id="4583284">=</span>&nbsp;<span class="ident" id="4583286">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583301">return</span>&nbsp;<span class="ident" id="4583308">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583315">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583372">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583392">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583429">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4583493">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583523">if</span>&nbsp;<span class="ident" id="4583526">c</span><span class="op" id="4583527">,</span>&nbsp;<span class="ident" id="4583529">d</span>&nbsp;<span class="op" id="4583531">:=</span>&nbsp;<span class="ident" id="4583534">nudge</span><span class="op" id="4583539">(</span><span class="ident" id="4583540">a</span><span class="op" id="4583541">)</span><span class="op" id="4583542">,</span>&nbsp;<span class="ident" id="4583544">nudge</span><span class="op" id="4583549">(</span><span class="ident" id="4583550">b</span><span class="op" id="4583551">)</span><span class="op" id="4583552">;</span>&nbsp;<span class="op" id="4583554">!</span><span class="op" id="4583555">(</span><span class="ident" id="4583556">c</span><span class="op" id="4583557">.</span><span class="ident" id="4583558">eq</span><span class="op" id="4583560">(</span><span class="ident" id="4583561">a</span><span class="op" id="4583562">)</span>&nbsp;<span class="op" id="4583564">&amp;&amp;</span>&nbsp;<span class="ident" id="4583567">d</span><span class="op" id="4583568">.</span><span class="ident" id="4583569">eq</span><span class="op" id="4583571">(</span><span class="ident" id="4583572">b</span><span class="op" id="4583573">)</span><span class="op" id="4583574">)</span>&nbsp;<span class="op" id="4583576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583580">if</span>&nbsp;<span class="ident" id="4583583">e</span>&nbsp;<span class="op" id="4583585">:=</span>&nbsp;<span class="ident" id="4583588">join</span><span class="op" id="4583592">(</span><span class="ident" id="4583593">c</span><span class="op" id="4583594">,</span>&nbsp;<span class="ident" id="4583596">d</span><span class="op" id="4583597">,</span>&nbsp;<span class="ident" id="4583599">node</span><span class="op" id="4583603">,</span>&nbsp;<span class="ident" id="4583605">nodeName</span><span class="op" id="4583613">)</span><span class="op" id="4583614">;</span>&nbsp;<span class="ident" id="4583616">e</span><span class="op" id="4583617">.</span><span class="ident" id="4583618">state</span>&nbsp;<span class="op" id="4583624">!=</span>&nbsp;<span class="ident" id="4583627">stateError</span>&nbsp;<span class="op" id="4583638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583643">return</span>&nbsp;<span class="ident" id="4583650">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583657">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4583661">return</span>&nbsp;<span class="ident" id="4583668">context</span><span class="op" id="4583675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583679">state</span><span class="op" id="4583684">:</span>&nbsp;<span class="ident" id="4583686">stateError</span><span class="op" id="4583696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583700">err</span><span class="op" id="4583703">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4583707">errorf</span><span class="op" id="4583713">(</span><span class="ident" id="4583714">ErrBranchEnd</span><span class="op" id="4583726">,</span>&nbsp;<span class="ident" id="4583728">node</span><span class="op" id="4583732">,</span>&nbsp;<span class="num" id="4583734">0</span><span class="op" id="4583735">,</span>&nbsp;<span class="string" id="4583737">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="4583788">,</span>&nbsp;<span class="ident" id="4583790">nodeName</span><span class="op" id="4583798">,</span>&nbsp;<span class="ident" id="4583800">a</span><span class="op" id="4583801">,</span>&nbsp;<span class="ident" id="4583803">b</span><span class="op" id="4583804">)</span><span class="op" id="4583805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4583808">}</span><br>
<span class="lineno">410</span><span class="op" id="4583810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4583813">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4583887">func</span>&nbsp;<span class="op" id="4583892">(</span><span class="ident" id="4583893">e</span>&nbsp;<span class="op" id="4583895">*</span><span class="ident" id="4583896">escaper</span><span class="op" id="4583903">)</span>&nbsp;<span class="ident" id="4583905">escapeBranch</span><span class="op" id="4583917">(</span><span class="ident" id="4583918">c</span>&nbsp;<span class="ident" id="4583920">context</span><span class="op" id="4583927">,</span>&nbsp;<span class="ident" id="4583929">n</span>&nbsp;<span class="op" id="4583931">*</span><span class="ident" id="4583932">parse</span><span class="op" id="4583937">.</span><span class="ident" id="4583938">BranchNode</span><span class="op" id="4583948">,</span>&nbsp;<span class="ident" id="4583950">nodeName</span>&nbsp;<span class="builtintype" id="4583959">string</span><span class="op" id="4583965">)</span>&nbsp;<span class="ident" id="4583967">context</span>&nbsp;<span class="op" id="4583975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4583978">c0</span>&nbsp;<span class="op" id="4583981">:=</span>&nbsp;<span class="ident" id="4583984">e</span><span class="op" id="4583985">.</span><span class="ident" id="4583986">escapeList</span><span class="op" id="4583996">(</span><span class="ident" id="4583997">c</span><span class="op" id="4583998">,</span>&nbsp;<span class="ident" id="4584000">n</span><span class="op" id="4584001">.</span><span class="ident" id="4584002">List</span><span class="op" id="4584006">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584009">if</span>&nbsp;<span class="ident" id="4584012">nodeName</span>&nbsp;<span class="op" id="4584021">==</span>&nbsp;<span class="string" id="4584024">&#34;range&#34;</span>&nbsp;<span class="op" id="4584032">&amp;&amp;</span>&nbsp;<span class="ident" id="4584035">c0</span><span class="op" id="4584037">.</span><span class="ident" id="4584038">state</span>&nbsp;<span class="op" id="4584044">!=</span>&nbsp;<span class="ident" id="4584047">stateError</span>&nbsp;<span class="op" id="4584058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584062">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584131">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584200">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584232">c1</span><span class="op" id="4584234">,</span>&nbsp;<span class="ident" id="4584236">_</span>&nbsp;<span class="op" id="4584238">:=</span>&nbsp;<span class="ident" id="4584241">e</span><span class="op" id="4584242">.</span><span class="ident" id="4584243">escapeListConditionally</span><span class="op" id="4584266">(</span><span class="ident" id="4584267">c0</span><span class="op" id="4584269">,</span>&nbsp;<span class="ident" id="4584271">n</span><span class="op" id="4584272">.</span><span class="ident" id="4584273">List</span><span class="op" id="4584277">,</span>&nbsp;<span class="ident" id="4584279">nil</span><span class="op" id="4584282">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584286">c0</span>&nbsp;<span class="op" id="4584289">=</span>&nbsp;<span class="ident" id="4584291">join</span><span class="op" id="4584295">(</span><span class="ident" id="4584296">c0</span><span class="op" id="4584298">,</span>&nbsp;<span class="ident" id="4584300">c1</span><span class="op" id="4584302">,</span>&nbsp;<span class="ident" id="4584304">n</span><span class="op" id="4584305">,</span>&nbsp;<span class="ident" id="4584307">nodeName</span><span class="op" id="4584315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584319">if</span>&nbsp;<span class="ident" id="4584322">c0</span><span class="op" id="4584324">.</span><span class="ident" id="4584325">state</span>&nbsp;<span class="op" id="4584331">==</span>&nbsp;<span class="ident" id="4584334">stateError</span>&nbsp;<span class="op" id="4584345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584350">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584407">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4584464">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584491">c0</span><span class="op" id="4584493">.</span><span class="ident" id="4584494">err</span><span class="op" id="4584497">.</span><span class="ident" id="4584498">Line</span>&nbsp;<span class="op" id="4584503">=</span>&nbsp;<span class="ident" id="4584505">n</span><span class="op" id="4584506">.</span><span class="ident" id="4584507">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584515">c0</span><span class="op" id="4584517">.</span><span class="ident" id="4584518">err</span><span class="op" id="4584521">.</span><span class="ident" id="4584522">Description</span>&nbsp;<span class="op" id="4584534">=</span>&nbsp;<span class="string" id="4584536">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="4584563">+</span>&nbsp;<span class="ident" id="4584565">c0</span><span class="op" id="4584567">.</span><span class="ident" id="4584568">err</span><span class="op" id="4584571">.</span><span class="ident" id="4584572">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584587">return</span>&nbsp;<span class="ident" id="4584594">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584602">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584605">c1</span>&nbsp;<span class="op" id="4584608">:=</span>&nbsp;<span class="ident" id="4584611">e</span><span class="op" id="4584612">.</span><span class="ident" id="4584613">escapeList</span><span class="op" id="4584623">(</span><span class="ident" id="4584624">c</span><span class="op" id="4584625">,</span>&nbsp;<span class="ident" id="4584627">n</span><span class="op" id="4584628">.</span><span class="ident" id="4584629">ElseList</span><span class="op" id="4584637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584640">return</span>&nbsp;<span class="ident" id="4584647">join</span><span class="op" id="4584651">(</span><span class="ident" id="4584652">c0</span><span class="op" id="4584654">,</span>&nbsp;<span class="ident" id="4584656">c1</span><span class="op" id="4584658">,</span>&nbsp;<span class="ident" id="4584660">n</span><span class="op" id="4584661">,</span>&nbsp;<span class="ident" id="4584663">nodeName</span><span class="op" id="4584671">)</span><br>
<span class="lineno"></span><span class="op" id="4584673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4584676">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="4584720">func</span>&nbsp;<span class="op" id="4584725">(</span><span class="ident" id="4584726">e</span>&nbsp;<span class="op" id="4584728">*</span><span class="ident" id="4584729">escaper</span><span class="op" id="4584736">)</span>&nbsp;<span class="ident" id="4584738">escapeList</span><span class="op" id="4584748">(</span><span class="ident" id="4584749">c</span>&nbsp;<span class="ident" id="4584751">context</span><span class="op" id="4584758">,</span>&nbsp;<span class="ident" id="4584760">n</span>&nbsp;<span class="op" id="4584762">*</span><span class="ident" id="4584763">parse</span><span class="op" id="4584768">.</span><span class="ident" id="4584769">ListNode</span><span class="op" id="4584777">)</span>&nbsp;<span class="ident" id="4584779">context</span>&nbsp;<span class="op" id="4584787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584790">if</span>&nbsp;<span class="ident" id="4584793">n</span>&nbsp;<span class="op" id="4584795">==</span>&nbsp;<span class="ident" id="4584798">nil</span>&nbsp;<span class="op" id="4584802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584806">return</span>&nbsp;<span class="ident" id="4584813">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584819">for</span>&nbsp;<span class="ident" id="4584823">_</span><span class="op" id="4584824">,</span>&nbsp;<span class="ident" id="4584826">m</span>&nbsp;<span class="op" id="4584828">:=</span>&nbsp;<span class="keyword" id="4584831">range</span>&nbsp;<span class="ident" id="4584837">n</span><span class="op" id="4584838">.</span><span class="ident" id="4584839">Nodes</span>&nbsp;<span class="op" id="4584845">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4584849">c</span>&nbsp;<span class="op" id="4584851">=</span>&nbsp;<span class="ident" id="4584853">e</span><span class="op" id="4584854">.</span><span class="ident" id="4584855">escape</span><span class="op" id="4584861">(</span><span class="ident" id="4584862">c</span><span class="op" id="4584863">,</span>&nbsp;<span class="ident" id="4584865">m</span><span class="op" id="4584866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4584869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4584872">return</span>&nbsp;<span class="ident" id="4584879">c</span><br>
<span class="lineno"></span><span class="op" id="4584881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="4584884">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4584960">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="4585032">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="4585112">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="4585159">func</span>&nbsp;<span class="op" id="4585164">(</span><span class="ident" id="4585165">e</span>&nbsp;<span class="op" id="4585167">*</span><span class="ident" id="4585168">escaper</span><span class="op" id="4585175">)</span>&nbsp;<span class="ident" id="4585177">escapeListConditionally</span><span class="op" id="4585200">(</span><span class="ident" id="4585201">c</span>&nbsp;<span class="ident" id="4585203">context</span><span class="op" id="4585210">,</span>&nbsp;<span class="ident" id="4585212">n</span>&nbsp;<span class="op" id="4585214">*</span><span class="ident" id="4585215">parse</span><span class="op" id="4585220">.</span><span class="ident" id="4585221">ListNode</span><span class="op" id="4585229">,</span>&nbsp;<span class="ident" id="4585231">filter</span>&nbsp;<span class="keyword" id="4585238">func</span><span class="op" id="4585242">(</span><span class="op" id="4585243">*</span><span class="ident" id="4585244">escaper</span><span class="op" id="4585251">,</span>&nbsp;<span class="ident" id="4585253">context</span><span class="op" id="4585260">)</span>&nbsp;<span class="builtintype" id="4585262">bool</span><span class="op" id="4585266">)</span>&nbsp;<span class="op" id="4585268">(</span><span class="ident" id="4585269">context</span><span class="op" id="4585276">,</span>&nbsp;<span class="builtintype" id="4585278">bool</span><span class="op" id="4585282">)</span>&nbsp;<span class="op" id="4585284">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585287">e1</span>&nbsp;<span class="op" id="4585290">:=</span>&nbsp;<span class="ident" id="4585293">newEscaper</span><span class="op" id="4585303">(</span><span class="ident" id="4585304">e</span><span class="op" id="4585305">.</span><span class="ident" id="4585306">tmpl</span><span class="op" id="4585310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4585313">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585354">for</span>&nbsp;<span class="ident" id="4585358">k</span><span class="op" id="4585359">,</span>&nbsp;<span class="ident" id="4585361">v</span>&nbsp;<span class="op" id="4585363">:=</span>&nbsp;<span class="keyword" id="4585366">range</span>&nbsp;<span class="ident" id="4585372">e</span><span class="op" id="4585373">.</span><span class="ident" id="4585374">output</span>&nbsp;<span class="op" id="4585381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585385">e1</span><span class="op" id="4585387">.</span><span class="ident" id="4585388">output</span><span class="op" id="4585394">[</span><span class="ident" id="4585395">k</span><span class="op" id="4585396">]</span>&nbsp;<span class="op" id="4585398">=</span>&nbsp;<span class="ident" id="4585400">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585403">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585406">c</span>&nbsp;<span class="op" id="4585408">=</span>&nbsp;<span class="ident" id="4585410">e1</span><span class="op" id="4585412">.</span><span class="ident" id="4585413">escapeList</span><span class="op" id="4585423">(</span><span class="ident" id="4585424">c</span><span class="op" id="4585425">,</span>&nbsp;<span class="ident" id="4585427">n</span><span class="op" id="4585428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585431">ok</span>&nbsp;<span class="op" id="4585434">:=</span>&nbsp;<span class="ident" id="4585437">filter</span>&nbsp;<span class="op" id="4585444">!=</span>&nbsp;<span class="ident" id="4585447">nil</span>&nbsp;<span class="op" id="4585451">&amp;&amp;</span>&nbsp;<span class="ident" id="4585454">filter</span><span class="op" id="4585460">(</span><span class="ident" id="4585461">e1</span><span class="op" id="4585463">,</span>&nbsp;<span class="ident" id="4585465">c</span><span class="op" id="4585466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585469">if</span>&nbsp;<span class="ident" id="4585472">ok</span>&nbsp;<span class="op" id="4585475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4585479">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585531">for</span>&nbsp;<span class="ident" id="4585535">k</span><span class="op" id="4585536">,</span>&nbsp;<span class="ident" id="4585538">v</span>&nbsp;<span class="op" id="4585540">:=</span>&nbsp;<span class="keyword" id="4585543">range</span>&nbsp;<span class="ident" id="4585549">e1</span><span class="op" id="4585551">.</span><span class="ident" id="4585552">output</span>&nbsp;<span class="op" id="4585559">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585564">e</span><span class="op" id="4585565">.</span><span class="ident" id="4585566">output</span><span class="op" id="4585572">[</span><span class="ident" id="4585573">k</span><span class="op" id="4585574">]</span>&nbsp;<span class="op" id="4585576">=</span>&nbsp;<span class="ident" id="4585578">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585586">for</span>&nbsp;<span class="ident" id="4585590">k</span><span class="op" id="4585591">,</span>&nbsp;<span class="ident" id="4585593">v</span>&nbsp;<span class="op" id="4585595">:=</span>&nbsp;<span class="keyword" id="4585598">range</span>&nbsp;<span class="ident" id="4585604">e1</span><span class="op" id="4585606">.</span><span class="ident" id="4585607">derived</span>&nbsp;<span class="op" id="4585615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585620">e</span><span class="op" id="4585621">.</span><span class="ident" id="4585622">derived</span><span class="op" id="4585629">[</span><span class="ident" id="4585630">k</span><span class="op" id="4585631">]</span>&nbsp;<span class="op" id="4585633">=</span>&nbsp;<span class="ident" id="4585635">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585639">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585643">for</span>&nbsp;<span class="ident" id="4585647">k</span><span class="op" id="4585648">,</span>&nbsp;<span class="ident" id="4585650">v</span>&nbsp;<span class="op" id="4585652">:=</span>&nbsp;<span class="keyword" id="4585655">range</span>&nbsp;<span class="ident" id="4585661">e1</span><span class="op" id="4585663">.</span><span class="ident" id="4585664">called</span>&nbsp;<span class="op" id="4585671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585676">e</span><span class="op" id="4585677">.</span><span class="ident" id="4585678">called</span><span class="op" id="4585684">[</span><span class="ident" id="4585685">k</span><span class="op" id="4585686">]</span>&nbsp;<span class="op" id="4585688">=</span>&nbsp;<span class="ident" id="4585690">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585698">for</span>&nbsp;<span class="ident" id="4585702">k</span><span class="op" id="4585703">,</span>&nbsp;<span class="ident" id="4585705">v</span>&nbsp;<span class="op" id="4585707">:=</span>&nbsp;<span class="keyword" id="4585710">range</span>&nbsp;<span class="ident" id="4585716">e1</span><span class="op" id="4585718">.</span><span class="ident" id="4585719">actionNodeEdits</span>&nbsp;<span class="op" id="4585735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585740">e</span><span class="op" id="4585741">.</span><span class="ident" id="4585742">editActionNode</span><span class="op" id="4585756">(</span><span class="ident" id="4585757">k</span><span class="op" id="4585758">,</span>&nbsp;<span class="ident" id="4585760">v</span><span class="op" id="4585761">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585769">for</span>&nbsp;<span class="ident" id="4585773">k</span><span class="op" id="4585774">,</span>&nbsp;<span class="ident" id="4585776">v</span>&nbsp;<span class="op" id="4585778">:=</span>&nbsp;<span class="keyword" id="4585781">range</span>&nbsp;<span class="ident" id="4585787">e1</span><span class="op" id="4585789">.</span><span class="ident" id="4585790">templateNodeEdits</span>&nbsp;<span class="op" id="4585808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585813">e</span><span class="op" id="4585814">.</span><span class="ident" id="4585815">editTemplateNode</span><span class="op" id="4585831">(</span><span class="ident" id="4585832">k</span><span class="op" id="4585833">,</span>&nbsp;<span class="ident" id="4585835">v</span><span class="op" id="4585836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585844">for</span>&nbsp;<span class="ident" id="4585848">k</span><span class="op" id="4585849">,</span>&nbsp;<span class="ident" id="4585851">v</span>&nbsp;<span class="op" id="4585853">:=</span>&nbsp;<span class="keyword" id="4585856">range</span>&nbsp;<span class="ident" id="4585862">e1</span><span class="op" id="4585864">.</span><span class="ident" id="4585865">textNodeEdits</span>&nbsp;<span class="op" id="4585879">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4585884">e</span><span class="op" id="4585885">.</span><span class="ident" id="4585886">editTextNode</span><span class="op" id="4585898">(</span><span class="ident" id="4585899">k</span><span class="op" id="4585900">,</span>&nbsp;<span class="ident" id="4585902">v</span><span class="op" id="4585903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4585910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4585913">return</span>&nbsp;<span class="ident" id="4585920">c</span><span class="op" id="4585921">,</span>&nbsp;<span class="ident" id="4585923">ok</span><br>
<span class="lineno"></span><span class="op" id="4585926">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4585929">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4585981">func</span>&nbsp;<span class="op" id="4585986">(</span><span class="ident" id="4585987">e</span>&nbsp;<span class="op" id="4585989">*</span><span class="ident" id="4585990">escaper</span><span class="op" id="4585997">)</span>&nbsp;<span class="ident" id="4585999">escapeTemplate</span><span class="op" id="4586013">(</span><span class="ident" id="4586014">c</span>&nbsp;<span class="ident" id="4586016">context</span><span class="op" id="4586023">,</span>&nbsp;<span class="ident" id="4586025">n</span>&nbsp;<span class="op" id="4586027">*</span><span class="ident" id="4586028">parse</span><span class="op" id="4586033">.</span><span class="ident" id="4586034">TemplateNode</span><span class="op" id="4586046">)</span>&nbsp;<span class="ident" id="4586048">context</span>&nbsp;<span class="op" id="4586056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586059">c</span><span class="op" id="4586060">,</span>&nbsp;<span class="ident" id="4586062">name</span>&nbsp;<span class="op" id="4586067">:=</span>&nbsp;<span class="ident" id="4586070">e</span><span class="op" id="4586071">.</span><span class="ident" id="4586072">escapeTree</span><span class="op" id="4586082">(</span><span class="ident" id="4586083">c</span><span class="op" id="4586084">,</span>&nbsp;<span class="ident" id="4586086">n</span><span class="op" id="4586087">,</span>&nbsp;<span class="ident" id="4586089">n</span><span class="op" id="4586090">.</span><span class="ident" id="4586091">Name</span><span class="op" id="4586095">,</span>&nbsp;<span class="ident" id="4586097">n</span><span class="op" id="4586098">.</span><span class="ident" id="4586099">Line</span><span class="op" id="4586103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586106">if</span>&nbsp;<span class="ident" id="4586109">name</span>&nbsp;<span class="op" id="4586114">!=</span>&nbsp;<span class="ident" id="4586117">n</span><span class="op" id="4586118">.</span><span class="ident" id="4586119">Name</span>&nbsp;<span class="op" id="4586124">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586128">e</span><span class="op" id="4586129">.</span><span class="ident" id="4586130">editTemplateNode</span><span class="op" id="4586146">(</span><span class="ident" id="4586147">n</span><span class="op" id="4586148">,</span>&nbsp;<span class="ident" id="4586150">name</span><span class="op" id="4586154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586160">return</span>&nbsp;<span class="ident" id="4586167">c</span><br>
<span class="lineno"></span><span class="op" id="4586169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="4586172">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4586246">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="4586291">func</span>&nbsp;<span class="op" id="4586296">(</span><span class="ident" id="4586297">e</span>&nbsp;<span class="op" id="4586299">*</span><span class="ident" id="4586300">escaper</span><span class="op" id="4586307">)</span>&nbsp;<span class="ident" id="4586309">escapeTree</span><span class="op" id="4586319">(</span><span class="ident" id="4586320">c</span>&nbsp;<span class="ident" id="4586322">context</span><span class="op" id="4586329">,</span>&nbsp;<span class="ident" id="4586331">node</span>&nbsp;<span class="ident" id="4586336">parse</span><span class="op" id="4586341">.</span><span class="ident" id="4586342">Node</span><span class="op" id="4586346">,</span>&nbsp;<span class="ident" id="4586348">name</span>&nbsp;<span class="builtintype" id="4586353">string</span><span class="op" id="4586359">,</span>&nbsp;<span class="ident" id="4586361">line</span>&nbsp;<span class="builtintype" id="4586366">int</span><span class="op" id="4586369">)</span>&nbsp;<span class="op" id="4586371">(</span><span class="ident" id="4586372">context</span><span class="op" id="4586379">,</span>&nbsp;<span class="builtintype" id="4586381">string</span><span class="op" id="4586387">)</span>&nbsp;<span class="op" id="4586389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4586392">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4586466">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586482">dname</span>&nbsp;<span class="op" id="4586488">:=</span>&nbsp;<span class="ident" id="4586491">c</span><span class="op" id="4586492">.</span><span class="ident" id="4586493">mangle</span><span class="op" id="4586499">(</span><span class="ident" id="4586500">name</span><span class="op" id="4586504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586507">e</span><span class="op" id="4586508">.</span><span class="ident" id="4586509">called</span><span class="op" id="4586515">[</span><span class="ident" id="4586516">dname</span><span class="op" id="4586521">]</span>&nbsp;<span class="op" id="4586523">=</span>&nbsp;<span class="builtintype" id="4586525">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586531">if</span>&nbsp;<span class="ident" id="4586534">out</span><span class="op" id="4586537">,</span>&nbsp;<span class="ident" id="4586539">ok</span>&nbsp;<span class="op" id="4586542">:=</span>&nbsp;<span class="ident" id="4586545">e</span><span class="op" id="4586546">.</span><span class="ident" id="4586547">output</span><span class="op" id="4586553">[</span><span class="ident" id="4586554">dname</span><span class="op" id="4586559">]</span><span class="op" id="4586560">;</span>&nbsp;<span class="ident" id="4586562">ok</span>&nbsp;<span class="op" id="4586565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4586569">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586591">return</span>&nbsp;<span class="ident" id="4586598">out</span><span class="op" id="4586601">,</span>&nbsp;<span class="ident" id="4586603">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586613">t</span>&nbsp;<span class="op" id="4586615">:=</span>&nbsp;<span class="ident" id="4586618">e</span><span class="op" id="4586619">.</span><span class="ident" id="4586620">template</span><span class="op" id="4586628">(</span><span class="ident" id="4586629">name</span><span class="op" id="4586633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586636">if</span>&nbsp;<span class="ident" id="4586639">t</span>&nbsp;<span class="op" id="4586641">==</span>&nbsp;<span class="ident" id="4586644">nil</span>&nbsp;<span class="op" id="4586648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4586652">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4586733">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586788">if</span>&nbsp;<span class="ident" id="4586791">e</span><span class="op" id="4586792">.</span><span class="ident" id="4586793">tmpl</span><span class="op" id="4586797">.</span><span class="ident" id="4586798">set</span><span class="op" id="4586801">[</span><span class="ident" id="4586802">name</span><span class="op" id="4586806">]</span>&nbsp;<span class="op" id="4586808">!=</span>&nbsp;<span class="ident" id="4586811">nil</span>&nbsp;<span class="op" id="4586815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586820">return</span>&nbsp;<span class="ident" id="4586827">context</span><span class="op" id="4586834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586840">state</span><span class="op" id="4586845">:</span>&nbsp;<span class="ident" id="4586847">stateError</span><span class="op" id="4586857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586863">err</span><span class="op" id="4586866">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4586870">errorf</span><span class="op" id="4586876">(</span><span class="ident" id="4586877">ErrNoSuchTemplate</span><span class="op" id="4586894">,</span>&nbsp;<span class="ident" id="4586896">node</span><span class="op" id="4586900">,</span>&nbsp;<span class="ident" id="4586902">line</span><span class="op" id="4586906">,</span>&nbsp;<span class="string" id="4586908">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="4586947">,</span>&nbsp;<span class="ident" id="4586949">name</span><span class="op" id="4586953">)</span><span class="op" id="4586954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586959">}</span><span class="op" id="4586960">,</span>&nbsp;<span class="ident" id="4586962">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4586970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4586974">return</span>&nbsp;<span class="ident" id="4586981">context</span><span class="op" id="4586988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4586993">state</span><span class="op" id="4586998">:</span>&nbsp;<span class="ident" id="4587000">stateError</span><span class="op" id="4587010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587015">err</span><span class="op" id="4587018">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4587022">errorf</span><span class="op" id="4587028">(</span><span class="ident" id="4587029">ErrNoSuchTemplate</span><span class="op" id="4587046">,</span>&nbsp;<span class="ident" id="4587048">node</span><span class="op" id="4587052">,</span>&nbsp;<span class="ident" id="4587054">line</span><span class="op" id="4587058">,</span>&nbsp;<span class="string" id="4587060">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4587081">,</span>&nbsp;<span class="ident" id="4587083">name</span><span class="op" id="4587087">)</span><span class="op" id="4587088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587092">}</span><span class="op" id="4587093">,</span>&nbsp;<span class="ident" id="4587095">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587105">if</span>&nbsp;<span class="ident" id="4587108">dname</span>&nbsp;<span class="op" id="4587114">!=</span>&nbsp;<span class="ident" id="4587117">name</span>&nbsp;<span class="op" id="4587122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4587126">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4587197">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587261">dt</span>&nbsp;<span class="op" id="4587264">:=</span>&nbsp;<span class="ident" id="4587267">e</span><span class="op" id="4587268">.</span><span class="ident" id="4587269">template</span><span class="op" id="4587277">(</span><span class="ident" id="4587278">dname</span><span class="op" id="4587283">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587287">if</span>&nbsp;<span class="ident" id="4587290">dt</span>&nbsp;<span class="op" id="4587293">==</span>&nbsp;<span class="ident" id="4587296">nil</span>&nbsp;<span class="op" id="4587300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587305">dt</span>&nbsp;<span class="op" id="4587308">=</span>&nbsp;<span class="ident" id="4587310">template</span><span class="op" id="4587318">.</span><span class="ident" id="4587319">New</span><span class="op" id="4587322">(</span><span class="ident" id="4587323">dname</span><span class="op" id="4587328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587333">dt</span><span class="op" id="4587335">.</span><span class="ident" id="4587336">Tree</span>&nbsp;<span class="op" id="4587341">=</span>&nbsp;<span class="op" id="4587343">&amp;</span><span class="ident" id="4587344">parse</span><span class="op" id="4587349">.</span><span class="ident" id="4587350">Tree</span><span class="op" id="4587354">{</span><span class="ident" id="4587355">Name</span><span class="op" id="4587359">:</span>&nbsp;<span class="ident" id="4587361">dname</span><span class="op" id="4587366">,</span>&nbsp;<span class="ident" id="4587368">Root</span><span class="op" id="4587372">:</span>&nbsp;<span class="ident" id="4587374">t</span><span class="op" id="4587375">.</span><span class="ident" id="4587376">Root</span><span class="op" id="4587380">.</span><span class="ident" id="4587381">CopyList</span><span class="op" id="4587389">(</span><span class="op" id="4587390">)</span><span class="op" id="4587391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587396">e</span><span class="op" id="4587397">.</span><span class="ident" id="4587398">derived</span><span class="op" id="4587405">[</span><span class="ident" id="4587406">dname</span><span class="op" id="4587411">]</span>&nbsp;<span class="op" id="4587413">=</span>&nbsp;<span class="ident" id="4587415">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587420">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587424">t</span>&nbsp;<span class="op" id="4587426">=</span>&nbsp;<span class="ident" id="4587428">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587435">return</span>&nbsp;<span class="ident" id="4587442">e</span><span class="op" id="4587443">.</span><span class="ident" id="4587444">computeOutCtx</span><span class="op" id="4587457">(</span><span class="ident" id="4587458">c</span><span class="op" id="4587459">,</span>&nbsp;<span class="ident" id="4587461">t</span><span class="op" id="4587462">)</span><span class="op" id="4587463">,</span>&nbsp;<span class="ident" id="4587465">dname</span><br>
<span class="lineno"></span><span class="op" id="4587471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="4587474">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4587554">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="4587600">func</span>&nbsp;<span class="op" id="4587605">(</span><span class="ident" id="4587606">e</span>&nbsp;<span class="op" id="4587608">*</span><span class="ident" id="4587609">escaper</span><span class="op" id="4587616">)</span>&nbsp;<span class="ident" id="4587618">computeOutCtx</span><span class="op" id="4587631">(</span><span class="ident" id="4587632">c</span>&nbsp;<span class="ident" id="4587634">context</span><span class="op" id="4587641">,</span>&nbsp;<span class="ident" id="4587643">t</span>&nbsp;<span class="op" id="4587645">*</span><span class="ident" id="4587646">template</span><span class="op" id="4587654">.</span><span class="ident" id="4587655">Template</span><span class="op" id="4587663">)</span>&nbsp;<span class="ident" id="4587665">context</span>&nbsp;<span class="op" id="4587673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4587676">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587713">c1</span><span class="op" id="4587715">,</span>&nbsp;<span class="ident" id="4587717">ok</span>&nbsp;<span class="op" id="4587720">:=</span>&nbsp;<span class="ident" id="4587723">e</span><span class="op" id="4587724">.</span><span class="ident" id="4587725">escapeTemplateBody</span><span class="op" id="4587743">(</span><span class="ident" id="4587744">c</span><span class="op" id="4587745">,</span>&nbsp;<span class="ident" id="4587747">t</span><span class="op" id="4587748">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587751">if</span>&nbsp;<span class="op" id="4587754">!</span><span class="ident" id="4587755">ok</span>&nbsp;<span class="op" id="4587758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4587762">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587828">if</span>&nbsp;<span class="ident" id="4587831">c2</span><span class="op" id="4587833">,</span>&nbsp;<span class="ident" id="4587835">ok2</span>&nbsp;<span class="op" id="4587839">:=</span>&nbsp;<span class="ident" id="4587842">e</span><span class="op" id="4587843">.</span><span class="ident" id="4587844">escapeTemplateBody</span><span class="op" id="4587862">(</span><span class="ident" id="4587863">c1</span><span class="op" id="4587865">,</span>&nbsp;<span class="ident" id="4587867">t</span><span class="op" id="4587868">)</span><span class="op" id="4587869">;</span>&nbsp;<span class="ident" id="4587871">ok2</span>&nbsp;<span class="op" id="4587875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4587880">c1</span><span class="op" id="4587882">,</span>&nbsp;<span class="ident" id="4587884">ok</span>&nbsp;<span class="op" id="4587887">=</span>&nbsp;<span class="ident" id="4587889">c2</span><span class="op" id="4587891">,</span>&nbsp;<span class="builtintype" id="4587893">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587900">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4587904">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4587966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4587969">if</span>&nbsp;<span class="op" id="4587972">!</span><span class="ident" id="4587973">ok</span>&nbsp;<span class="op" id="4587976">&amp;&amp;</span>&nbsp;<span class="ident" id="4587979">c1</span><span class="op" id="4587981">.</span><span class="ident" id="4587982">state</span>&nbsp;<span class="op" id="4587988">!=</span>&nbsp;<span class="ident" id="4587991">stateError</span>&nbsp;<span class="op" id="4588002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588006">return</span>&nbsp;<span class="ident" id="4588013">context</span><span class="op" id="4588020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4588025">state</span><span class="op" id="4588030">:</span>&nbsp;<span class="ident" id="4588032">stateError</span><span class="op" id="4588042">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4588047">err</span><span class="op" id="4588050">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4588054">errorf</span><span class="op" id="4588060">(</span><span class="ident" id="4588061">ErrOutputContext</span><span class="op" id="4588077">,</span>&nbsp;<span class="ident" id="4588079">t</span><span class="op" id="4588080">.</span><span class="ident" id="4588081">Tree</span><span class="op" id="4588085">.</span><span class="ident" id="4588086">Root</span><span class="op" id="4588090">,</span>&nbsp;<span class="num" id="4588092">0</span><span class="op" id="4588093">,</span>&nbsp;<span class="string" id="4588095">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="4588142">,</span>&nbsp;<span class="ident" id="4588144">t</span><span class="op" id="4588145">.</span><span class="ident" id="4588146">Name</span><span class="op" id="4588150">(</span><span class="op" id="4588151">)</span><span class="op" id="4588152">)</span><span class="op" id="4588153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588163">return</span>&nbsp;<span class="ident" id="4588170">c1</span><br>
<span class="lineno"></span><span class="op" id="4588173">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="4588176">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="4588251">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4588328">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="4588355">func</span>&nbsp;<span class="op" id="4588360">(</span><span class="ident" id="4588361">e</span>&nbsp;<span class="op" id="4588363">*</span><span class="ident" id="4588364">escaper</span><span class="op" id="4588371">)</span>&nbsp;<span class="ident" id="4588373">escapeTemplateBody</span><span class="op" id="4588391">(</span><span class="ident" id="4588392">c</span>&nbsp;<span class="ident" id="4588394">context</span><span class="op" id="4588401">,</span>&nbsp;<span class="ident" id="4588403">t</span>&nbsp;<span class="op" id="4588405">*</span><span class="ident" id="4588406">template</span><span class="op" id="4588414">.</span><span class="ident" id="4588415">Template</span><span class="op" id="4588423">)</span>&nbsp;<span class="op" id="4588425">(</span><span class="ident" id="4588426">context</span><span class="op" id="4588433">,</span>&nbsp;<span class="builtintype" id="4588435">bool</span><span class="op" id="4588439">)</span>&nbsp;<span class="op" id="4588441">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4588444">filter</span>&nbsp;<span class="op" id="4588451">:=</span>&nbsp;<span class="keyword" id="4588454">func</span><span class="op" id="4588458">(</span><span class="ident" id="4588459">e1</span>&nbsp;<span class="op" id="4588462">*</span><span class="ident" id="4588463">escaper</span><span class="op" id="4588470">,</span>&nbsp;<span class="ident" id="4588472">c1</span>&nbsp;<span class="ident" id="4588475">context</span><span class="op" id="4588482">)</span>&nbsp;<span class="builtintype" id="4588484">bool</span>&nbsp;<span class="op" id="4588489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588493">if</span>&nbsp;<span class="ident" id="4588496">c1</span><span class="op" id="4588498">.</span><span class="ident" id="4588499">state</span>&nbsp;<span class="op" id="4588505">==</span>&nbsp;<span class="ident" id="4588508">stateError</span>&nbsp;<span class="op" id="4588519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588524">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588566">return</span>&nbsp;<span class="builtintype" id="4588573">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588581">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588585">if</span>&nbsp;<span class="op" id="4588588">!</span><span class="ident" id="4588589">e1</span><span class="op" id="4588591">.</span><span class="ident" id="4588592">called</span><span class="op" id="4588598">[</span><span class="ident" id="4588599">t</span><span class="op" id="4588600">.</span><span class="ident" id="4588601">Name</span><span class="op" id="4588605">(</span><span class="op" id="4588606">)</span><span class="op" id="4588607">]</span>&nbsp;<span class="op" id="4588609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588614">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588666">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588697">return</span>&nbsp;<span class="builtintype" id="4588704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588711">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588715">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4588777">return</span>&nbsp;<span class="ident" id="4588784">c</span><span class="op" id="4588785">.</span><span class="ident" id="4588786">eq</span><span class="op" id="4588788">(</span><span class="ident" id="4588789">c1</span><span class="op" id="4588791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4588794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588797">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588870">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4588944">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589014">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589042">e</span><span class="op" id="4589043">.</span><span class="ident" id="4589044">output</span><span class="op" id="4589050">[</span><span class="ident" id="4589051">t</span><span class="op" id="4589052">.</span><span class="ident" id="4589053">Name</span><span class="op" id="4589057">(</span><span class="op" id="4589058">)</span><span class="op" id="4589059">]</span>&nbsp;<span class="op" id="4589061">=</span>&nbsp;<span class="ident" id="4589063">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589066">return</span>&nbsp;<span class="ident" id="4589073">e</span><span class="op" id="4589074">.</span><span class="ident" id="4589075">escapeListConditionally</span><span class="op" id="4589098">(</span><span class="ident" id="4589099">c</span><span class="op" id="4589100">,</span>&nbsp;<span class="ident" id="4589102">t</span><span class="op" id="4589103">.</span><span class="ident" id="4589104">Tree</span><span class="op" id="4589108">.</span><span class="ident" id="4589109">Root</span><span class="op" id="4589113">,</span>&nbsp;<span class="ident" id="4589115">filter</span><span class="op" id="4589121">)</span><br>
<span class="lineno"></span><span class="op" id="4589123">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="4589126">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4589200">var</span>&nbsp;<span class="ident" id="4589204">delimEnds</span>&nbsp;<span class="op" id="4589214">=</span>&nbsp;<span class="op" id="4589216">[</span><span class="op" id="4589217">...</span><span class="op" id="4589220">]</span><span class="builtintype" id="4589221">string</span><span class="op" id="4589227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589230">delimDoubleQuote</span><span class="op" id="4589246">:</span>&nbsp;<span class="string" id="4589248">`&#34;`</span><span class="op" id="4589251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589254">delimSingleQuote</span><span class="op" id="4589270">:</span>&nbsp;<span class="string" id="4589272">&#34;&#39;&#34;</span><span class="op" id="4589275">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589278">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589347">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589392">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589432">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589506">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589578">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4589628">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589634">delimSpaceOrTagEnd</span><span class="op" id="4589652">:</span>&nbsp;<span class="string" id="4589654">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="4589666">,</span><br>
<span class="lineno"></span><span class="op" id="4589668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="4589671">var</span>&nbsp;<span class="ident" id="4589675">doctypeBytes</span>&nbsp;<span class="op" id="4589688">=</span>&nbsp;<span class="op" id="4589690">[</span><span class="op" id="4589691">]</span><span class="builtintype" id="4589692">byte</span><span class="op" id="4589696">(</span><span class="string" id="4589697">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="4589708">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4589711">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="4589755">func</span>&nbsp;<span class="op" id="4589760">(</span><span class="ident" id="4589761">e</span>&nbsp;<span class="op" id="4589763">*</span><span class="ident" id="4589764">escaper</span><span class="op" id="4589771">)</span>&nbsp;<span class="ident" id="4589773">escapeText</span><span class="op" id="4589783">(</span><span class="ident" id="4589784">c</span>&nbsp;<span class="ident" id="4589786">context</span><span class="op" id="4589793">,</span>&nbsp;<span class="ident" id="4589795">n</span>&nbsp;<span class="op" id="4589797">*</span><span class="ident" id="4589798">parse</span><span class="op" id="4589803">.</span><span class="ident" id="4589804">TextNode</span><span class="op" id="4589812">)</span>&nbsp;<span class="ident" id="4589814">context</span>&nbsp;<span class="op" id="4589822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589825">s</span><span class="op" id="4589826">,</span>&nbsp;<span class="ident" id="4589828">written</span><span class="op" id="4589835">,</span>&nbsp;<span class="ident" id="4589837">i</span><span class="op" id="4589838">,</span>&nbsp;<span class="ident" id="4589840">b</span>&nbsp;<span class="op" id="4589842">:=</span>&nbsp;<span class="ident" id="4589845">n</span><span class="op" id="4589846">.</span><span class="ident" id="4589847">Text</span><span class="op" id="4589851">,</span>&nbsp;<span class="num" id="4589853">0</span><span class="op" id="4589854">,</span>&nbsp;<span class="num" id="4589856">0</span><span class="op" id="4589857">,</span>&nbsp;<span class="builtinfunc" id="4589859">new</span><span class="op" id="4589862">(</span><span class="ident" id="4589863">bytes</span><span class="op" id="4589868">.</span><span class="ident" id="4589869">Buffer</span><span class="op" id="4589875">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589878">for</span>&nbsp;<span class="ident" id="4589882">i</span>&nbsp;<span class="op" id="4589884">!=</span>&nbsp;<span class="builtinfunc" id="4589887">len</span><span class="op" id="4589890">(</span><span class="ident" id="4589891">s</span><span class="op" id="4589892">)</span>&nbsp;<span class="op" id="4589894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589898">c1</span><span class="op" id="4589900">,</span>&nbsp;<span class="ident" id="4589902">nread</span>&nbsp;<span class="op" id="4589908">:=</span>&nbsp;<span class="ident" id="4589911">contextAfterText</span><span class="op" id="4589927">(</span><span class="ident" id="4589928">c</span><span class="op" id="4589929">,</span>&nbsp;<span class="ident" id="4589931">s</span><span class="op" id="4589932">[</span><span class="ident" id="4589933">i</span><span class="op" id="4589934">:</span><span class="op" id="4589935">]</span><span class="op" id="4589936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4589940">i1</span>&nbsp;<span class="op" id="4589943">:=</span>&nbsp;<span class="ident" id="4589946">i</span>&nbsp;<span class="op" id="4589948">+</span>&nbsp;<span class="ident" id="4589950">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4589958">if</span>&nbsp;<span class="ident" id="4589961">c</span><span class="op" id="4589962">.</span><span class="ident" id="4589963">state</span>&nbsp;<span class="op" id="4589969">==</span>&nbsp;<span class="ident" id="4589972">stateText</span>&nbsp;<span class="op" id="4589982">||</span>&nbsp;<span class="ident" id="4589985">c</span><span class="op" id="4589986">.</span><span class="ident" id="4589987">state</span>&nbsp;<span class="op" id="4589993">==</span>&nbsp;<span class="ident" id="4589996">stateRCDATA</span>&nbsp;<span class="op" id="4590008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590013">end</span>&nbsp;<span class="op" id="4590017">:=</span>&nbsp;<span class="ident" id="4590020">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590026">if</span>&nbsp;<span class="ident" id="4590029">c1</span><span class="op" id="4590031">.</span><span class="ident" id="4590032">state</span>&nbsp;<span class="op" id="4590038">!=</span>&nbsp;<span class="ident" id="4590041">c</span><span class="op" id="4590042">.</span><span class="ident" id="4590043">state</span>&nbsp;<span class="op" id="4590049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590055">for</span>&nbsp;<span class="ident" id="4590059">j</span>&nbsp;<span class="op" id="4590061">:=</span>&nbsp;<span class="ident" id="4590064">end</span>&nbsp;<span class="op" id="4590068">-</span>&nbsp;<span class="num" id="4590070">1</span><span class="op" id="4590071">;</span>&nbsp;<span class="ident" id="4590073">j</span>&nbsp;<span class="op" id="4590075">&gt;=</span>&nbsp;<span class="ident" id="4590078">i</span><span class="op" id="4590079">;</span>&nbsp;<span class="ident" id="4590081">j</span><span class="op" id="4590082">--</span>&nbsp;<span class="op" id="4590085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590092">if</span>&nbsp;<span class="ident" id="4590095">s</span><span class="op" id="4590096">[</span><span class="ident" id="4590097">j</span><span class="op" id="4590098">]</span>&nbsp;<span class="op" id="4590100">==</span>&nbsp;<span class="string" id="4590103">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4590107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590115">end</span>&nbsp;<span class="op" id="4590119">=</span>&nbsp;<span class="ident" id="4590121">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590129">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590156">for</span>&nbsp;<span class="ident" id="4590160">j</span>&nbsp;<span class="op" id="4590162">:=</span>&nbsp;<span class="ident" id="4590165">i</span><span class="op" id="4590166">;</span>&nbsp;<span class="ident" id="4590168">j</span>&nbsp;<span class="op" id="4590170">&lt;</span>&nbsp;<span class="ident" id="4590172">end</span><span class="op" id="4590175">;</span>&nbsp;<span class="ident" id="4590177">j</span><span class="op" id="4590178">++</span>&nbsp;<span class="op" id="4590181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590187">if</span>&nbsp;<span class="ident" id="4590190">s</span><span class="op" id="4590191">[</span><span class="ident" id="4590192">j</span><span class="op" id="4590193">]</span>&nbsp;<span class="op" id="4590195">==</span>&nbsp;<span class="string" id="4590198">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="4590202">&amp;&amp;</span>&nbsp;<span class="op" id="4590205">!</span><span class="ident" id="4590206">bytes</span><span class="op" id="4590211">.</span><span class="ident" id="4590212">HasPrefix</span><span class="op" id="4590221">(</span><span class="ident" id="4590222">bytes</span><span class="op" id="4590227">.</span><span class="ident" id="4590228">ToUpper</span><span class="op" id="4590235">(</span><span class="ident" id="4590236">s</span><span class="op" id="4590237">[</span><span class="ident" id="4590238">j</span><span class="op" id="4590239">:</span><span class="op" id="4590240">]</span><span class="op" id="4590241">)</span><span class="op" id="4590242">,</span>&nbsp;<span class="ident" id="4590244">doctypeBytes</span><span class="op" id="4590256">)</span>&nbsp;<span class="op" id="4590258">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590265">b</span><span class="op" id="4590266">.</span><span class="ident" id="4590267">Write</span><span class="op" id="4590272">(</span><span class="ident" id="4590273">s</span><span class="op" id="4590274">[</span><span class="ident" id="4590275">written</span><span class="op" id="4590282">:</span><span class="ident" id="4590283">j</span><span class="op" id="4590284">]</span><span class="op" id="4590285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590292">b</span><span class="op" id="4590293">.</span><span class="ident" id="4590294">WriteString</span><span class="op" id="4590305">(</span><span class="string" id="4590306">&#34;&amp;lt;&#34;</span><span class="op" id="4590312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590319">written</span>&nbsp;<span class="op" id="4590327">=</span>&nbsp;<span class="ident" id="4590329">j</span>&nbsp;<span class="op" id="4590331">+</span>&nbsp;<span class="num" id="4590333">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590344">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590348">}</span>&nbsp;<span class="keyword" id="4590350">else</span>&nbsp;<span class="keyword" id="4590355">if</span>&nbsp;<span class="ident" id="4590358">isComment</span><span class="op" id="4590367">(</span><span class="ident" id="4590368">c</span><span class="op" id="4590369">.</span><span class="ident" id="4590370">state</span><span class="op" id="4590375">)</span>&nbsp;<span class="op" id="4590377">&amp;&amp;</span>&nbsp;<span class="ident" id="4590380">c</span><span class="op" id="4590381">.</span><span class="ident" id="4590382">delim</span>&nbsp;<span class="op" id="4590388">==</span>&nbsp;<span class="ident" id="4590391">delimNone</span>&nbsp;<span class="op" id="4590401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590406">switch</span>&nbsp;<span class="ident" id="4590413">c</span><span class="op" id="4590414">.</span><span class="ident" id="4590415">state</span>&nbsp;<span class="op" id="4590421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590426">case</span>&nbsp;<span class="ident" id="4590431">stateJSBlockCmt</span><span class="op" id="4590446">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590452">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590488">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590537">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590589">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590639">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590687">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4590736">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590767">if</span>&nbsp;<span class="ident" id="4590770">bytes</span><span class="op" id="4590775">.</span><span class="ident" id="4590776">IndexAny</span><span class="op" id="4590784">(</span><span class="ident" id="4590785">s</span><span class="op" id="4590786">[</span><span class="ident" id="4590787">written</span><span class="op" id="4590794">:</span><span class="ident" id="4590795">i1</span><span class="op" id="4590797">]</span><span class="op" id="4590798">,</span>&nbsp;<span class="string" id="4590800">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="4590818">)</span>&nbsp;<span class="op" id="4590820">!=</span>&nbsp;<span class="op" id="4590823">-</span><span class="num" id="4590824">1</span>&nbsp;<span class="op" id="4590826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590833">b</span><span class="op" id="4590834">.</span><span class="ident" id="4590835">WriteByte</span><span class="op" id="4590844">(</span><span class="string" id="4590845">&#39;\n&#39;</span><span class="op" id="4590849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590855">}</span>&nbsp;<span class="keyword" id="4590857">else</span>&nbsp;<span class="op" id="4590862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590869">b</span><span class="op" id="4590870">.</span><span class="ident" id="4590871">WriteByte</span><span class="op" id="4590880">(</span><span class="string" id="4590881">&#39;&nbsp;&#39;</span><span class="op" id="4590884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590890">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590895">case</span>&nbsp;<span class="ident" id="4590900">stateCSSBlockCmt</span><span class="op" id="4590916">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590922">b</span><span class="op" id="4590923">.</span><span class="ident" id="4590924">WriteByte</span><span class="op" id="4590933">(</span><span class="string" id="4590934">&#39;&nbsp;&#39;</span><span class="op" id="4590937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4590947">written</span>&nbsp;<span class="op" id="4590955">=</span>&nbsp;<span class="ident" id="4590957">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4590962">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4590966">if</span>&nbsp;<span class="ident" id="4590969">c</span><span class="op" id="4590970">.</span><span class="ident" id="4590971">state</span>&nbsp;<span class="op" id="4590977">!=</span>&nbsp;<span class="ident" id="4590980">c1</span><span class="op" id="4590982">.</span><span class="ident" id="4590983">state</span>&nbsp;<span class="op" id="4590989">&amp;&amp;</span>&nbsp;<span class="ident" id="4590992">isComment</span><span class="op" id="4591001">(</span><span class="ident" id="4591002">c1</span><span class="op" id="4591004">.</span><span class="ident" id="4591005">state</span><span class="op" id="4591010">)</span>&nbsp;<span class="op" id="4591012">&amp;&amp;</span>&nbsp;<span class="ident" id="4591015">c1</span><span class="op" id="4591017">.</span><span class="ident" id="4591018">delim</span>&nbsp;<span class="op" id="4591024">==</span>&nbsp;<span class="ident" id="4591027">delimNone</span>&nbsp;<span class="op" id="4591037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591042">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591108">cs</span>&nbsp;<span class="op" id="4591111">:=</span>&nbsp;<span class="ident" id="4591114">i1</span>&nbsp;<span class="op" id="4591117">-</span>&nbsp;<span class="num" id="4591119">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591124">if</span>&nbsp;<span class="ident" id="4591127">c1</span><span class="op" id="4591129">.</span><span class="ident" id="4591130">state</span>&nbsp;<span class="op" id="4591136">==</span>&nbsp;<span class="ident" id="4591139">stateHTMLCmt</span>&nbsp;<span class="op" id="4591152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591158">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591196">cs</span>&nbsp;<span class="op" id="4591199">-=</span>&nbsp;<span class="num" id="4591202">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591212">b</span><span class="op" id="4591213">.</span><span class="ident" id="4591214">Write</span><span class="op" id="4591219">(</span><span class="ident" id="4591220">s</span><span class="op" id="4591221">[</span><span class="ident" id="4591222">written</span><span class="op" id="4591229">:</span><span class="ident" id="4591230">cs</span><span class="op" id="4591232">]</span><span class="op" id="4591233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591238">written</span>&nbsp;<span class="op" id="4591246">=</span>&nbsp;<span class="ident" id="4591248">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591253">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591257">if</span>&nbsp;<span class="ident" id="4591260">i</span>&nbsp;<span class="op" id="4591262">==</span>&nbsp;<span class="ident" id="4591265">i1</span>&nbsp;<span class="op" id="4591268">&amp;&amp;</span>&nbsp;<span class="ident" id="4591271">c</span><span class="op" id="4591272">.</span><span class="ident" id="4591273">state</span>&nbsp;<span class="op" id="4591279">==</span>&nbsp;<span class="ident" id="4591282">c1</span><span class="op" id="4591284">.</span><span class="ident" id="4591285">state</span>&nbsp;<span class="op" id="4591291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4591296">panic</span><span class="op" id="4591301">(</span><span class="ident" id="4591302">fmt</span><span class="op" id="4591305">.</span><span class="ident" id="4591306">Sprintf</span><span class="op" id="4591313">(</span><span class="string" id="4591314">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="4591353">,</span>&nbsp;<span class="ident" id="4591355">c</span><span class="op" id="4591356">,</span>&nbsp;<span class="ident" id="4591358">c1</span><span class="op" id="4591360">,</span>&nbsp;<span class="ident" id="4591362">s</span><span class="op" id="4591363">[</span><span class="op" id="4591364">:</span><span class="ident" id="4591365">i</span><span class="op" id="4591366">]</span><span class="op" id="4591367">,</span>&nbsp;<span class="ident" id="4591369">s</span><span class="op" id="4591370">[</span><span class="ident" id="4591371">i</span><span class="op" id="4591372">:</span><span class="op" id="4591373">]</span><span class="op" id="4591374">)</span><span class="op" id="4591375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591383">c</span><span class="op" id="4591384">,</span>&nbsp;<span class="ident" id="4591386">i</span>&nbsp;<span class="op" id="4591388">=</span>&nbsp;<span class="ident" id="4591390">c1</span><span class="op" id="4591392">,</span>&nbsp;<span class="ident" id="4591394">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591398">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591402">if</span>&nbsp;<span class="ident" id="4591405">written</span>&nbsp;<span class="op" id="4591413">!=</span>&nbsp;<span class="num" id="4591416">0</span>&nbsp;<span class="op" id="4591418">&amp;&amp;</span>&nbsp;<span class="ident" id="4591421">c</span><span class="op" id="4591422">.</span><span class="ident" id="4591423">state</span>&nbsp;<span class="op" id="4591429">!=</span>&nbsp;<span class="ident" id="4591432">stateError</span>&nbsp;<span class="op" id="4591443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591447">if</span>&nbsp;<span class="op" id="4591450">!</span><span class="ident" id="4591451">isComment</span><span class="op" id="4591460">(</span><span class="ident" id="4591461">c</span><span class="op" id="4591462">.</span><span class="ident" id="4591463">state</span><span class="op" id="4591468">)</span>&nbsp;<span class="op" id="4591470">||</span>&nbsp;<span class="ident" id="4591473">c</span><span class="op" id="4591474">.</span><span class="ident" id="4591475">delim</span>&nbsp;<span class="op" id="4591481">!=</span>&nbsp;<span class="ident" id="4591484">delimNone</span>&nbsp;<span class="op" id="4591494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591499">b</span><span class="op" id="4591500">.</span><span class="ident" id="4591501">Write</span><span class="op" id="4591506">(</span><span class="ident" id="4591507">n</span><span class="op" id="4591508">.</span><span class="ident" id="4591509">Text</span><span class="op" id="4591513">[</span><span class="ident" id="4591514">written</span><span class="op" id="4591521">:</span><span class="op" id="4591522">]</span><span class="op" id="4591523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591527">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591531">e</span><span class="op" id="4591532">.</span><span class="ident" id="4591533">editTextNode</span><span class="op" id="4591545">(</span><span class="ident" id="4591546">n</span><span class="op" id="4591547">,</span>&nbsp;<span class="ident" id="4591549">b</span><span class="op" id="4591550">.</span><span class="ident" id="4591551">Bytes</span><span class="op" id="4591556">(</span><span class="op" id="4591557">)</span><span class="op" id="4591558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591564">return</span>&nbsp;<span class="ident" id="4591571">c</span><br>
<span class="lineno"></span><span class="op" id="4591573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="4591576">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4591656">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="4591734">func</span>&nbsp;<span class="ident" id="4591739">contextAfterText</span><span class="op" id="4591755">(</span><span class="ident" id="4591756">c</span>&nbsp;<span class="ident" id="4591758">context</span><span class="op" id="4591765">,</span>&nbsp;<span class="ident" id="4591767">s</span>&nbsp;<span class="op" id="4591769">[</span><span class="op" id="4591770">]</span><span class="builtintype" id="4591771">byte</span><span class="op" id="4591775">)</span>&nbsp;<span class="op" id="4591777">(</span><span class="ident" id="4591778">context</span><span class="op" id="4591785">,</span>&nbsp;<span class="builtintype" id="4591787">int</span><span class="op" id="4591790">)</span>&nbsp;<span class="op" id="4591792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591795">if</span>&nbsp;<span class="ident" id="4591798">c</span><span class="op" id="4591799">.</span><span class="ident" id="4591800">delim</span>&nbsp;<span class="op" id="4591806">==</span>&nbsp;<span class="ident" id="4591809">delimNone</span>&nbsp;<span class="op" id="4591819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4591823">c1</span><span class="op" id="4591825">,</span>&nbsp;<span class="ident" id="4591827">i</span>&nbsp;<span class="op" id="4591829">:=</span>&nbsp;<span class="ident" id="4591832">tSpecialTagEnd</span><span class="op" id="4591846">(</span><span class="ident" id="4591847">c</span><span class="op" id="4591848">,</span>&nbsp;<span class="ident" id="4591850">s</span><span class="op" id="4591851">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591855">if</span>&nbsp;<span class="ident" id="4591858">i</span>&nbsp;<span class="op" id="4591860">==</span>&nbsp;<span class="num" id="4591863">0</span>&nbsp;<span class="op" id="4591865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591870">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591926">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4591976">return</span>&nbsp;<span class="ident" id="4591983">c1</span><span class="op" id="4591985">,</span>&nbsp;<span class="num" id="4591987">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4591991">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4591995">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592040">return</span>&nbsp;<span class="ident" id="4592047">transitionFunc</span><span class="op" id="4592061">[</span><span class="ident" id="4592062">c</span><span class="op" id="4592063">.</span><span class="ident" id="4592064">state</span><span class="op" id="4592069">]</span><span class="op" id="4592070">(</span><span class="ident" id="4592071">c</span><span class="op" id="4592072">,</span>&nbsp;<span class="ident" id="4592074">s</span><span class="op" id="4592075">[</span><span class="op" id="4592076">:</span><span class="ident" id="4592077">i</span><span class="op" id="4592078">]</span><span class="op" id="4592079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592086">i</span>&nbsp;<span class="op" id="4592088">:=</span>&nbsp;<span class="ident" id="4592091">bytes</span><span class="op" id="4592096">.</span><span class="ident" id="4592097">IndexAny</span><span class="op" id="4592105">(</span><span class="ident" id="4592106">s</span><span class="op" id="4592107">,</span>&nbsp;<span class="ident" id="4592109">delimEnds</span><span class="op" id="4592118">[</span><span class="ident" id="4592119">c</span><span class="op" id="4592120">.</span><span class="ident" id="4592121">delim</span><span class="op" id="4592126">]</span><span class="op" id="4592127">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592130">if</span>&nbsp;<span class="ident" id="4592133">i</span>&nbsp;<span class="op" id="4592135">==</span>&nbsp;<span class="op" id="4592138">-</span><span class="num" id="4592139">1</span>&nbsp;<span class="op" id="4592141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592145">i</span>&nbsp;<span class="op" id="4592147">=</span>&nbsp;<span class="builtinfunc" id="4592149">len</span><span class="op" id="4592152">(</span><span class="ident" id="4592153">s</span><span class="op" id="4592154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592160">if</span>&nbsp;<span class="ident" id="4592163">c</span><span class="op" id="4592164">.</span><span class="ident" id="4592165">delim</span>&nbsp;<span class="op" id="4592171">==</span>&nbsp;<span class="ident" id="4592174">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4592193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592197">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592274">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592322">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592380">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592446">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592496">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592549">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592594">if</span>&nbsp;<span class="ident" id="4592597">j</span>&nbsp;<span class="op" id="4592599">:=</span>&nbsp;<span class="ident" id="4592602">bytes</span><span class="op" id="4592607">.</span><span class="ident" id="4592608">IndexAny</span><span class="op" id="4592616">(</span><span class="ident" id="4592617">s</span><span class="op" id="4592618">[</span><span class="op" id="4592619">:</span><span class="ident" id="4592620">i</span><span class="op" id="4592621">]</span><span class="op" id="4592622">,</span>&nbsp;<span class="string" id="4592624">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="4592632">)</span><span class="op" id="4592633">;</span>&nbsp;<span class="ident" id="4592635">j</span>&nbsp;<span class="op" id="4592637">&gt;=</span>&nbsp;<span class="num" id="4592640">0</span>&nbsp;<span class="op" id="4592642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592647">return</span>&nbsp;<span class="ident" id="4592654">context</span><span class="op" id="4592661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592667">state</span><span class="op" id="4592672">:</span>&nbsp;<span class="ident" id="4592674">stateError</span><span class="op" id="4592684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4592690">err</span><span class="op" id="4592693">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4592697">errorf</span><span class="op" id="4592703">(</span><span class="ident" id="4592704">ErrBadHTML</span><span class="op" id="4592714">,</span>&nbsp;<span class="ident" id="4592716">nil</span><span class="op" id="4592719">,</span>&nbsp;<span class="num" id="4592721">0</span><span class="op" id="4592722">,</span>&nbsp;<span class="string" id="4592724">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="4592749">,</span>&nbsp;<span class="ident" id="4592751">s</span><span class="op" id="4592752">[</span><span class="ident" id="4592753">j</span><span class="op" id="4592754">:</span><span class="ident" id="4592755">j</span><span class="op" id="4592756">+</span><span class="num" id="4592757">1</span><span class="op" id="4592758">]</span><span class="op" id="4592759">,</span>&nbsp;<span class="ident" id="4592761">s</span><span class="op" id="4592762">[</span><span class="op" id="4592763">:</span><span class="ident" id="4592764">i</span><span class="op" id="4592765">]</span><span class="op" id="4592766">)</span><span class="op" id="4592767">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592772">}</span><span class="op" id="4592773">,</span>&nbsp;<span class="builtinfunc" id="4592775">len</span><span class="op" id="4592778">(</span><span class="ident" id="4592779">s</span><span class="op" id="4592780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4592787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4592790">if</span>&nbsp;<span class="ident" id="4592793">i</span>&nbsp;<span class="op" id="4592795">==</span>&nbsp;<span class="builtinfunc" id="4592798">len</span><span class="op" id="4592801">(</span><span class="ident" id="4592802">s</span><span class="op" id="4592803">)</span>&nbsp;<span class="op" id="4592805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592809">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592843">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592901">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4592952">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593007">for</span>&nbsp;<span class="ident" id="4593011">u</span>&nbsp;<span class="op" id="4593013">:=</span>&nbsp;<span class="op" id="4593016">[</span><span class="op" id="4593017">]</span><span class="builtintype" id="4593018">byte</span><span class="op" id="4593022">(</span><span class="ident" id="4593023">html</span><span class="op" id="4593027">.</span><span class="ident" id="4593028">UnescapeString</span><span class="op" id="4593042">(</span><span class="builtintype" id="4593043">string</span><span class="op" id="4593049">(</span><span class="ident" id="4593050">s</span><span class="op" id="4593051">)</span><span class="op" id="4593052">)</span><span class="op" id="4593053">)</span><span class="op" id="4593054">;</span>&nbsp;<span class="builtinfunc" id="4593056">len</span><span class="op" id="4593059">(</span><span class="ident" id="4593060">u</span><span class="op" id="4593061">)</span>&nbsp;<span class="op" id="4593063">!=</span>&nbsp;<span class="num" id="4593066">0</span><span class="op" id="4593067">;</span>&nbsp;<span class="op" id="4593069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593074">c1</span><span class="op" id="4593076">,</span>&nbsp;<span class="ident" id="4593078">i1</span>&nbsp;<span class="op" id="4593081">:=</span>&nbsp;<span class="ident" id="4593084">transitionFunc</span><span class="op" id="4593098">[</span><span class="ident" id="4593099">c</span><span class="op" id="4593100">.</span><span class="ident" id="4593101">state</span><span class="op" id="4593106">]</span><span class="op" id="4593107">(</span><span class="ident" id="4593108">c</span><span class="op" id="4593109">,</span>&nbsp;<span class="ident" id="4593111">u</span><span class="op" id="4593112">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593117">c</span><span class="op" id="4593118">,</span>&nbsp;<span class="ident" id="4593120">u</span>&nbsp;<span class="op" id="4593122">=</span>&nbsp;<span class="ident" id="4593124">c1</span><span class="op" id="4593126">,</span>&nbsp;<span class="ident" id="4593128">u</span><span class="op" id="4593129">[</span><span class="ident" id="4593130">i1</span><span class="op" id="4593132">:</span><span class="op" id="4593133">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593141">return</span>&nbsp;<span class="ident" id="4593148">c</span><span class="op" id="4593149">,</span>&nbsp;<span class="builtinfunc" id="4593151">len</span><span class="op" id="4593154">(</span><span class="ident" id="4593155">s</span><span class="op" id="4593156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593162">if</span>&nbsp;<span class="ident" id="4593165">c</span><span class="op" id="4593166">.</span><span class="ident" id="4593167">delim</span>&nbsp;<span class="op" id="4593173">!=</span>&nbsp;<span class="ident" id="4593176">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="4593195">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593199">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593223">i</span><span class="op" id="4593224">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593231">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4593293">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593327">return</span>&nbsp;<span class="ident" id="4593334">context</span><span class="op" id="4593341">{</span><span class="ident" id="4593342">state</span><span class="op" id="4593347">:</span>&nbsp;<span class="ident" id="4593349">stateTag</span><span class="op" id="4593357">,</span>&nbsp;<span class="ident" id="4593359">element</span><span class="op" id="4593366">:</span>&nbsp;<span class="ident" id="4593368">c</span><span class="op" id="4593369">.</span><span class="ident" id="4593370">element</span><span class="op" id="4593377">}</span><span class="op" id="4593378">,</span>&nbsp;<span class="ident" id="4593380">i</span><br>
<span class="lineno"></span><span class="op" id="4593382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4593385">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4593460">func</span>&nbsp;<span class="op" id="4593465">(</span><span class="ident" id="4593466">e</span>&nbsp;<span class="op" id="4593468">*</span><span class="ident" id="4593469">escaper</span><span class="op" id="4593476">)</span>&nbsp;<span class="ident" id="4593478">editActionNode</span><span class="op" id="4593492">(</span><span class="ident" id="4593493">n</span>&nbsp;<span class="op" id="4593495">*</span><span class="ident" id="4593496">parse</span><span class="op" id="4593501">.</span><span class="ident" id="4593502">ActionNode</span><span class="op" id="4593512">,</span>&nbsp;<span class="ident" id="4593514">cmds</span>&nbsp;<span class="op" id="4593519">[</span><span class="op" id="4593520">]</span><span class="builtintype" id="4593521">string</span><span class="op" id="4593527">)</span>&nbsp;<span class="op" id="4593529">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593532">if</span>&nbsp;<span class="ident" id="4593535">_</span><span class="op" id="4593536">,</span>&nbsp;<span class="ident" id="4593538">ok</span>&nbsp;<span class="op" id="4593541">:=</span>&nbsp;<span class="ident" id="4593544">e</span><span class="op" id="4593545">.</span><span class="ident" id="4593546">actionNodeEdits</span><span class="op" id="4593561">[</span><span class="ident" id="4593562">n</span><span class="op" id="4593563">]</span><span class="op" id="4593564">;</span>&nbsp;<span class="ident" id="4593566">ok</span>&nbsp;<span class="op" id="4593569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4593573">panic</span><span class="op" id="4593578">(</span><span class="ident" id="4593579">fmt</span><span class="op" id="4593582">.</span><span class="ident" id="4593583">Sprintf</span><span class="op" id="4593590">(</span><span class="string" id="4593591">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4593625">,</span>&nbsp;<span class="ident" id="4593627">n</span><span class="op" id="4593628">)</span><span class="op" id="4593629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593635">e</span><span class="op" id="4593636">.</span><span class="ident" id="4593637">actionNodeEdits</span><span class="op" id="4593652">[</span><span class="ident" id="4593653">n</span><span class="op" id="4593654">]</span>&nbsp;<span class="op" id="4593656">=</span>&nbsp;<span class="ident" id="4593658">cmds</span><br>
<span class="lineno"></span><span class="op" id="4593663">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="4593666">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="4593746">func</span>&nbsp;<span class="op" id="4593751">(</span><span class="ident" id="4593752">e</span>&nbsp;<span class="op" id="4593754">*</span><span class="ident" id="4593755">escaper</span><span class="op" id="4593762">)</span>&nbsp;<span class="ident" id="4593764">editTemplateNode</span><span class="op" id="4593780">(</span><span class="ident" id="4593781">n</span>&nbsp;<span class="op" id="4593783">*</span><span class="ident" id="4593784">parse</span><span class="op" id="4593789">.</span><span class="ident" id="4593790">TemplateNode</span><span class="op" id="4593802">,</span>&nbsp;<span class="ident" id="4593804">callee</span>&nbsp;<span class="builtintype" id="4593811">string</span><span class="op" id="4593817">)</span>&nbsp;<span class="op" id="4593819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4593822">if</span>&nbsp;<span class="ident" id="4593825">_</span><span class="op" id="4593826">,</span>&nbsp;<span class="ident" id="4593828">ok</span>&nbsp;<span class="op" id="4593831">:=</span>&nbsp;<span class="ident" id="4593834">e</span><span class="op" id="4593835">.</span><span class="ident" id="4593836">templateNodeEdits</span><span class="op" id="4593853">[</span><span class="ident" id="4593854">n</span><span class="op" id="4593855">]</span><span class="op" id="4593856">;</span>&nbsp;<span class="ident" id="4593858">ok</span>&nbsp;<span class="op" id="4593861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4593865">panic</span><span class="op" id="4593870">(</span><span class="ident" id="4593871">fmt</span><span class="op" id="4593874">.</span><span class="ident" id="4593875">Sprintf</span><span class="op" id="4593882">(</span><span class="string" id="4593883">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4593917">,</span>&nbsp;<span class="ident" id="4593919">n</span><span class="op" id="4593920">)</span><span class="op" id="4593921">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4593924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4593927">e</span><span class="op" id="4593928">.</span><span class="ident" id="4593929">templateNodeEdits</span><span class="op" id="4593946">[</span><span class="ident" id="4593947">n</span><span class="op" id="4593948">]</span>&nbsp;<span class="op" id="4593950">=</span>&nbsp;<span class="ident" id="4593952">callee</span><br>
<span class="lineno"></span><span class="op" id="4593959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4593962">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="4594028">func</span>&nbsp;<span class="op" id="4594033">(</span><span class="ident" id="4594034">e</span>&nbsp;<span class="op" id="4594036">*</span><span class="ident" id="4594037">escaper</span><span class="op" id="4594044">)</span>&nbsp;<span class="ident" id="4594046">editTextNode</span><span class="op" id="4594058">(</span><span class="ident" id="4594059">n</span>&nbsp;<span class="op" id="4594061">*</span><span class="ident" id="4594062">parse</span><span class="op" id="4594067">.</span><span class="ident" id="4594068">TextNode</span><span class="op" id="4594076">,</span>&nbsp;<span class="ident" id="4594078">text</span>&nbsp;<span class="op" id="4594083">[</span><span class="op" id="4594084">]</span><span class="builtintype" id="4594085">byte</span><span class="op" id="4594089">)</span>&nbsp;<span class="op" id="4594091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594094">if</span>&nbsp;<span class="ident" id="4594097">_</span><span class="op" id="4594098">,</span>&nbsp;<span class="ident" id="4594100">ok</span>&nbsp;<span class="op" id="4594103">:=</span>&nbsp;<span class="ident" id="4594106">e</span><span class="op" id="4594107">.</span><span class="ident" id="4594108">textNodeEdits</span><span class="op" id="4594121">[</span><span class="ident" id="4594122">n</span><span class="op" id="4594123">]</span><span class="op" id="4594124">;</span>&nbsp;<span class="ident" id="4594126">ok</span>&nbsp;<span class="op" id="4594129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4594133">panic</span><span class="op" id="4594138">(</span><span class="ident" id="4594139">fmt</span><span class="op" id="4594142">.</span><span class="ident" id="4594143">Sprintf</span><span class="op" id="4594150">(</span><span class="string" id="4594151">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="4594185">,</span>&nbsp;<span class="ident" id="4594187">n</span><span class="op" id="4594188">)</span><span class="op" id="4594189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594195">e</span><span class="op" id="4594196">.</span><span class="ident" id="4594197">textNodeEdits</span><span class="op" id="4594210">[</span><span class="ident" id="4594211">n</span><span class="op" id="4594212">]</span>&nbsp;<span class="op" id="4594214">=</span>&nbsp;<span class="ident" id="4594216">text</span><br>
<span class="lineno">735</span><span class="op" id="4594221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4594224">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="4594303">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="4594368">func</span>&nbsp;<span class="op" id="4594373">(</span><span class="ident" id="4594374">e</span>&nbsp;<span class="op" id="4594376">*</span><span class="ident" id="4594377">escaper</span><span class="op" id="4594384">)</span>&nbsp;<span class="ident" id="4594386">commit</span><span class="op" id="4594392">(</span><span class="op" id="4594393">)</span>&nbsp;<span class="op" id="4594395">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594398">for</span>&nbsp;<span class="ident" id="4594402">name</span>&nbsp;<span class="op" id="4594407">:=</span>&nbsp;<span class="keyword" id="4594410">range</span>&nbsp;<span class="ident" id="4594416">e</span><span class="op" id="4594417">.</span><span class="ident" id="4594418">output</span>&nbsp;<span class="op" id="4594425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594429">e</span><span class="op" id="4594430">.</span><span class="ident" id="4594431">template</span><span class="op" id="4594439">(</span><span class="ident" id="4594440">name</span><span class="op" id="4594444">)</span><span class="op" id="4594445">.</span><span class="ident" id="4594446">Funcs</span><span class="op" id="4594451">(</span><span class="ident" id="4594452">funcMap</span><span class="op" id="4594459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594465">for</span>&nbsp;<span class="ident" id="4594469">_</span><span class="op" id="4594470">,</span>&nbsp;<span class="ident" id="4594472">t</span>&nbsp;<span class="op" id="4594474">:=</span>&nbsp;<span class="keyword" id="4594477">range</span>&nbsp;<span class="ident" id="4594483">e</span><span class="op" id="4594484">.</span><span class="ident" id="4594485">derived</span>&nbsp;<span class="op" id="4594493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594497">if</span>&nbsp;<span class="ident" id="4594500">_</span><span class="op" id="4594501">,</span>&nbsp;<span class="ident" id="4594503">err</span>&nbsp;<span class="op" id="4594507">:=</span>&nbsp;<span class="ident" id="4594510">e</span><span class="op" id="4594511">.</span><span class="ident" id="4594512">tmpl</span><span class="op" id="4594516">.</span><span class="ident" id="4594517">text</span><span class="op" id="4594521">.</span><span class="ident" id="4594522">AddParseTree</span><span class="op" id="4594534">(</span><span class="ident" id="4594535">t</span><span class="op" id="4594536">.</span><span class="ident" id="4594537">Name</span><span class="op" id="4594541">(</span><span class="op" id="4594542">)</span><span class="op" id="4594543">,</span>&nbsp;<span class="ident" id="4594545">t</span><span class="op" id="4594546">.</span><span class="ident" id="4594547">Tree</span><span class="op" id="4594551">)</span><span class="op" id="4594552">;</span>&nbsp;<span class="ident" id="4594554">err</span>&nbsp;<span class="op" id="4594558">!=</span>&nbsp;<span class="ident" id="4594561">nil</span>&nbsp;<span class="op" id="4594565">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4594570">panic</span><span class="op" id="4594575">(</span><span class="string" id="4594576">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="4594607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594617">for</span>&nbsp;<span class="ident" id="4594621">n</span><span class="op" id="4594622">,</span>&nbsp;<span class="ident" id="4594624">s</span>&nbsp;<span class="op" id="4594626">:=</span>&nbsp;<span class="keyword" id="4594629">range</span>&nbsp;<span class="ident" id="4594635">e</span><span class="op" id="4594636">.</span><span class="ident" id="4594637">actionNodeEdits</span>&nbsp;<span class="op" id="4594653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594657">ensurePipelineContains</span><span class="op" id="4594679">(</span><span class="ident" id="4594680">n</span><span class="op" id="4594681">.</span><span class="ident" id="4594682">Pipe</span><span class="op" id="4594686">,</span>&nbsp;<span class="ident" id="4594688">s</span><span class="op" id="4594689">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594695">for</span>&nbsp;<span class="ident" id="4594699">n</span><span class="op" id="4594700">,</span>&nbsp;<span class="ident" id="4594702">name</span>&nbsp;<span class="op" id="4594707">:=</span>&nbsp;<span class="keyword" id="4594710">range</span>&nbsp;<span class="ident" id="4594716">e</span><span class="op" id="4594717">.</span><span class="ident" id="4594718">templateNodeEdits</span>&nbsp;<span class="op" id="4594736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594740">n</span><span class="op" id="4594741">.</span><span class="ident" id="4594742">Name</span>&nbsp;<span class="op" id="4594747">=</span>&nbsp;<span class="ident" id="4594749">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594758">for</span>&nbsp;<span class="ident" id="4594762">n</span><span class="op" id="4594763">,</span>&nbsp;<span class="ident" id="4594765">s</span>&nbsp;<span class="op" id="4594767">:=</span>&nbsp;<span class="keyword" id="4594770">range</span>&nbsp;<span class="ident" id="4594776">e</span><span class="op" id="4594777">.</span><span class="ident" id="4594778">textNodeEdits</span>&nbsp;<span class="op" id="4594792">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594796">n</span><span class="op" id="4594797">.</span><span class="ident" id="4594798">Text</span>&nbsp;<span class="op" id="4594803">=</span>&nbsp;<span class="ident" id="4594805">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4594808">}</span><br>
<span class="lineno"></span><span class="op" id="4594810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4594813">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="4594883">func</span>&nbsp;<span class="op" id="4594888">(</span><span class="ident" id="4594889">e</span>&nbsp;<span class="op" id="4594891">*</span><span class="ident" id="4594892">escaper</span><span class="op" id="4594899">)</span>&nbsp;<span class="ident" id="4594901">template</span><span class="op" id="4594909">(</span><span class="ident" id="4594910">name</span>&nbsp;<span class="builtintype" id="4594915">string</span><span class="op" id="4594921">)</span>&nbsp;<span class="op" id="4594923">*</span><span class="ident" id="4594924">template</span><span class="op" id="4594932">.</span><span class="ident" id="4594933">Template</span>&nbsp;<span class="op" id="4594942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594945">t</span>&nbsp;<span class="op" id="4594947">:=</span>&nbsp;<span class="ident" id="4594950">e</span><span class="op" id="4594951">.</span><span class="ident" id="4594952">tmpl</span><span class="op" id="4594956">.</span><span class="ident" id="4594957">text</span><span class="op" id="4594961">.</span><span class="ident" id="4594962">Lookup</span><span class="op" id="4594968">(</span><span class="ident" id="4594969">name</span><span class="op" id="4594973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4594976">if</span>&nbsp;<span class="ident" id="4594979">t</span>&nbsp;<span class="op" id="4594981">==</span>&nbsp;<span class="ident" id="4594984">nil</span>&nbsp;<span class="op" id="4594988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4594992">t</span>&nbsp;<span class="op" id="4594994">=</span>&nbsp;<span class="ident" id="4594996">e</span><span class="op" id="4594997">.</span><span class="ident" id="4594998">derived</span><span class="op" id="4595005">[</span><span class="ident" id="4595006">name</span><span class="op" id="4595010">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4595013">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595016">return</span>&nbsp;<span class="ident" id="4595023">t</span><br>
<span class="lineno"></span><span class="op" id="4595025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4595028">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4595098">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4595160">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4595240">func</span>&nbsp;<span class="ident" id="4595245">HTMLEscape</span><span class="op" id="4595255">(</span><span class="ident" id="4595256">w</span>&nbsp;<span class="ident" id="4595258">io</span><span class="op" id="4595260">.</span><span class="ident" id="4595261">Writer</span><span class="op" id="4595267">,</span>&nbsp;<span class="ident" id="4595269">b</span>&nbsp;<span class="op" id="4595271">[</span><span class="op" id="4595272">]</span><span class="builtintype" id="4595273">byte</span><span class="op" id="4595277">)</span>&nbsp;<span class="op" id="4595279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595282">template</span><span class="op" id="4595290">.</span><span class="ident" id="4595291">HTMLEscape</span><span class="op" id="4595301">(</span><span class="ident" id="4595302">w</span><span class="op" id="4595303">,</span>&nbsp;<span class="ident" id="4595305">b</span><span class="op" id="4595306">)</span><br>
<span class="lineno"></span><span class="op" id="4595308">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="4595311">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4595393">func</span>&nbsp;<span class="ident" id="4595398">HTMLEscapeString</span><span class="op" id="4595414">(</span><span class="ident" id="4595415">s</span>&nbsp;<span class="builtintype" id="4595417">string</span><span class="op" id="4595423">)</span>&nbsp;<span class="builtintype" id="4595425">string</span>&nbsp;<span class="op" id="4595432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595435">return</span>&nbsp;<span class="ident" id="4595442">template</span><span class="op" id="4595450">.</span><span class="ident" id="4595451">HTMLEscapeString</span><span class="op" id="4595467">(</span><span class="ident" id="4595468">s</span><span class="op" id="4595469">)</span><br>
<span class="lineno"></span><span class="op" id="4595471">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="4595474">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4595540">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4595576">func</span>&nbsp;<span class="ident" id="4595581">HTMLEscaper</span><span class="op" id="4595592">(</span><span class="ident" id="4595593">args</span>&nbsp;<span class="op" id="4595598">...</span><span class="keyword" id="4595601">interface</span><span class="op" id="4595610">{</span><span class="op" id="4595611">}</span><span class="op" id="4595612">)</span>&nbsp;<span class="builtintype" id="4595614">string</span>&nbsp;<span class="op" id="4595621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595624">return</span>&nbsp;<span class="ident" id="4595631">template</span><span class="op" id="4595639">.</span><span class="ident" id="4595640">HTMLEscaper</span><span class="op" id="4595651">(</span><span class="ident" id="4595652">args</span><span class="op" id="4595656">...</span><span class="op" id="4595659">)</span><br>
<span class="lineno">785</span><span class="op" id="4595661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4595664">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="4595748">func</span>&nbsp;<span class="ident" id="4595753">JSEscape</span><span class="op" id="4595761">(</span><span class="ident" id="4595762">w</span>&nbsp;<span class="ident" id="4595764">io</span><span class="op" id="4595766">.</span><span class="ident" id="4595767">Writer</span><span class="op" id="4595773">,</span>&nbsp;<span class="ident" id="4595775">b</span>&nbsp;<span class="op" id="4595777">[</span><span class="op" id="4595778">]</span><span class="builtintype" id="4595779">byte</span><span class="op" id="4595783">)</span>&nbsp;<span class="op" id="4595785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4595788">template</span><span class="op" id="4595796">.</span><span class="ident" id="4595797">JSEscape</span><span class="op" id="4595805">(</span><span class="ident" id="4595806">w</span><span class="op" id="4595807">,</span>&nbsp;<span class="ident" id="4595809">b</span><span class="op" id="4595810">)</span><br>
<span class="lineno">790</span><span class="op" id="4595812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4595815">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="4595901">func</span>&nbsp;<span class="ident" id="4595906">JSEscapeString</span><span class="op" id="4595920">(</span><span class="ident" id="4595921">s</span>&nbsp;<span class="builtintype" id="4595923">string</span><span class="op" id="4595929">)</span>&nbsp;<span class="builtintype" id="4595931">string</span>&nbsp;<span class="op" id="4595938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4595941">return</span>&nbsp;<span class="ident" id="4595948">template</span><span class="op" id="4595956">.</span><span class="ident" id="4595957">JSEscapeString</span><span class="op" id="4595971">(</span><span class="ident" id="4595972">s</span><span class="op" id="4595973">)</span><br>
<span class="lineno">795</span><span class="op" id="4595975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4595978">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="4596048">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="4596084">func</span>&nbsp;<span class="ident" id="4596089">JSEscaper</span><span class="op" id="4596098">(</span><span class="ident" id="4596099">args</span>&nbsp;<span class="op" id="4596104">...</span><span class="keyword" id="4596107">interface</span><span class="op" id="4596116">{</span><span class="op" id="4596117">}</span><span class="op" id="4596118">)</span>&nbsp;<span class="builtintype" id="4596120">string</span>&nbsp;<span class="op" id="4596127">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4596130">return</span>&nbsp;<span class="ident" id="4596137">template</span><span class="op" id="4596145">.</span><span class="ident" id="4596146">JSEscaper</span><span class="op" id="4596155">(</span><span class="ident" id="4596156">args</span><span class="op" id="4596160">...</span><span class="op" id="4596163">)</span><br>
<span class="lineno"></span><span class="op" id="4596165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4596168">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4596246">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="4596312">func</span>&nbsp;<span class="ident" id="4596317">URLQueryEscaper</span><span class="op" id="4596332">(</span><span class="ident" id="4596333">args</span>&nbsp;<span class="op" id="4596338">...</span><span class="keyword" id="4596341">interface</span><span class="op" id="4596350">{</span><span class="op" id="4596351">}</span><span class="op" id="4596352">)</span>&nbsp;<span class="builtintype" id="4596354">string</span>&nbsp;<span class="op" id="4596361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4596364">return</span>&nbsp;<span class="ident" id="4596371">template</span><span class="op" id="4596379">.</span><span class="ident" id="4596380">URLQueryEscaper</span><span class="op" id="4596395">(</span><span class="ident" id="4596396">args</span><span class="op" id="4596400">...</span><span class="op" id="4596403">)</span><br>
<span class="lineno"></span><span class="op" id="4596405">}</span>
</div>
</body>
</html>
