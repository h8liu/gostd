<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8346960">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8347016">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8347070">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8347121">package</span>&nbsp;<span class="ident" id="8347129">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8347136">import</span>&nbsp;<span class="op" id="8347143">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8347146">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8347157">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8347168">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8347175">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8347178">func</span>&nbsp;<span class="ident" id="8347183">TestReadGCStats</span><span class="op" id="8347198">(</span><span class="ident" id="8347199">t</span>&nbsp;<span class="op" id="8347201">*</span><span class="ident" id="8347202">testing</span><span class="op" id="8347209">.</span><span class="ident" id="8347210">T</span><span class="op" id="8347211">)</span>&nbsp;<span class="op" id="8347213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347216">defer</span>&nbsp;<span class="ident" id="8347222">SetGCPercent</span><span class="op" id="8347234">(</span><span class="ident" id="8347235">SetGCPercent</span><span class="op" id="8347247">(</span><span class="op" id="8347248">-</span><span class="num" id="8347249">1</span><span class="op" id="8347250">)</span><span class="op" id="8347251">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347255">var</span>&nbsp;<span class="ident" id="8347259">stats</span>&nbsp;<span class="ident" id="8347265">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347274">var</span>&nbsp;<span class="ident" id="8347278">mstats</span>&nbsp;<span class="ident" id="8347285">runtime</span><span class="op" id="8347292">.</span><span class="ident" id="8347293">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347303">var</span>&nbsp;<span class="ident" id="8347307">min</span><span class="op" id="8347310">,</span>&nbsp;<span class="ident" id="8347312">max</span>&nbsp;<span class="ident" id="8347316">time</span><span class="op" id="8347320">.</span><span class="ident" id="8347321">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8347332">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8347388">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347456">stats</span><span class="op" id="8347461">.</span><span class="ident" id="8347462">PauseQuantiles</span>&nbsp;<span class="op" id="8347477">=</span>&nbsp;<span class="builtinfunc" id="8347479">make</span><span class="op" id="8347483">(</span><span class="op" id="8347484">[</span><span class="op" id="8347485">]</span><span class="ident" id="8347486">time</span><span class="op" id="8347490">.</span><span class="ident" id="8347491">Duration</span><span class="op" id="8347499">,</span>&nbsp;<span class="num" id="8347501">10</span><span class="op" id="8347503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347506">ReadGCStats</span><span class="op" id="8347517">(</span><span class="op" id="8347518">&amp;</span><span class="ident" id="8347519">stats</span><span class="op" id="8347524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347527">runtime</span><span class="op" id="8347534">.</span><span class="ident" id="8347535">GC</span><span class="op" id="8347537">(</span><span class="op" id="8347538">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8347542">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347608">ReadGCStats</span><span class="op" id="8347619">(</span><span class="op" id="8347620">&amp;</span><span class="ident" id="8347621">stats</span><span class="op" id="8347626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347629">runtime</span><span class="op" id="8347636">.</span><span class="ident" id="8347637">ReadMemStats</span><span class="op" id="8347649">(</span><span class="op" id="8347650">&amp;</span><span class="ident" id="8347651">mstats</span><span class="op" id="8347657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347661">if</span>&nbsp;<span class="ident" id="8347664">stats</span><span class="op" id="8347669">.</span><span class="ident" id="8347670">NumGC</span>&nbsp;<span class="op" id="8347676">!=</span>&nbsp;<span class="ident" id="8347679">int64</span><span class="op" id="8347684">(</span><span class="ident" id="8347685">mstats</span><span class="op" id="8347691">.</span><span class="ident" id="8347692">NumGC</span><span class="op" id="8347697">)</span>&nbsp;<span class="op" id="8347699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347703">t</span><span class="op" id="8347704">.</span><span class="ident" id="8347705">Errorf</span><span class="op" id="8347711">(</span><span class="string" id="8347712">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8347753">,</span>&nbsp;<span class="ident" id="8347755">stats</span><span class="op" id="8347760">.</span><span class="ident" id="8347761">NumGC</span><span class="op" id="8347766">,</span>&nbsp;<span class="ident" id="8347768">mstats</span><span class="op" id="8347774">.</span><span class="ident" id="8347775">NumGC</span><span class="op" id="8347780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347786">if</span>&nbsp;<span class="ident" id="8347789">stats</span><span class="op" id="8347794">.</span><span class="ident" id="8347795">PauseTotal</span>&nbsp;<span class="op" id="8347806">!=</span>&nbsp;<span class="ident" id="8347809">time</span><span class="op" id="8347813">.</span><span class="ident" id="8347814">Duration</span><span class="op" id="8347822">(</span><span class="ident" id="8347823">mstats</span><span class="op" id="8347829">.</span><span class="ident" id="8347830">PauseTotalNs</span><span class="op" id="8347842">)</span>&nbsp;<span class="op" id="8347844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347848">t</span><span class="op" id="8347849">.</span><span class="ident" id="8347850">Errorf</span><span class="op" id="8347856">(</span><span class="string" id="8347857">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8347910">,</span>&nbsp;<span class="ident" id="8347912">stats</span><span class="op" id="8347917">.</span><span class="ident" id="8347918">PauseTotal</span><span class="op" id="8347928">,</span>&nbsp;<span class="ident" id="8347930">mstats</span><span class="op" id="8347936">.</span><span class="ident" id="8347937">PauseTotalNs</span><span class="op" id="8347949">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347955">if</span>&nbsp;<span class="ident" id="8347958">stats</span><span class="op" id="8347963">.</span><span class="ident" id="8347964">LastGC</span><span class="op" id="8347970">.</span><span class="ident" id="8347971">UnixNano</span><span class="op" id="8347979">(</span><span class="op" id="8347980">)</span>&nbsp;<span class="op" id="8347982">!=</span>&nbsp;<span class="ident" id="8347985">int64</span><span class="op" id="8347990">(</span><span class="ident" id="8347991">mstats</span><span class="op" id="8347997">.</span><span class="ident" id="8347998">LastGC</span><span class="op" id="8348004">)</span>&nbsp;<span class="op" id="8348006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348010">t</span><span class="op" id="8348011">.</span><span class="ident" id="8348012">Errorf</span><span class="op" id="8348018">(</span><span class="string" id="8348019">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8348071">,</span>&nbsp;<span class="ident" id="8348073">stats</span><span class="op" id="8348078">.</span><span class="ident" id="8348079">LastGC</span><span class="op" id="8348085">.</span><span class="ident" id="8348086">UnixNano</span><span class="op" id="8348094">(</span><span class="op" id="8348095">)</span><span class="op" id="8348096">,</span>&nbsp;<span class="ident" id="8348098">mstats</span><span class="op" id="8348104">.</span><span class="ident" id="8348105">LastGC</span><span class="op" id="8348111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348117">n</span>&nbsp;<span class="op" id="8348119">:=</span>&nbsp;<span class="builtintype" id="8348122">int</span><span class="op" id="8348125">(</span><span class="ident" id="8348126">mstats</span><span class="op" id="8348132">.</span><span class="ident" id="8348133">NumGC</span><span class="op" id="8348138">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348141">if</span>&nbsp;<span class="ident" id="8348144">n</span>&nbsp;<span class="op" id="8348146">&gt;</span>&nbsp;<span class="builtinfunc" id="8348148">len</span><span class="op" id="8348151">(</span><span class="ident" id="8348152">mstats</span><span class="op" id="8348158">.</span><span class="ident" id="8348159">PauseNs</span><span class="op" id="8348166">)</span>&nbsp;<span class="op" id="8348168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348172">n</span>&nbsp;<span class="op" id="8348174">=</span>&nbsp;<span class="builtinfunc" id="8348176">len</span><span class="op" id="8348179">(</span><span class="ident" id="8348180">mstats</span><span class="op" id="8348186">.</span><span class="ident" id="8348187">PauseNs</span><span class="op" id="8348194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348200">if</span>&nbsp;<span class="builtinfunc" id="8348203">len</span><span class="op" id="8348206">(</span><span class="ident" id="8348207">stats</span><span class="op" id="8348212">.</span><span class="ident" id="8348213">Pause</span><span class="op" id="8348218">)</span>&nbsp;<span class="op" id="8348220">!=</span>&nbsp;<span class="ident" id="8348223">n</span>&nbsp;<span class="op" id="8348225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348229">t</span><span class="op" id="8348230">.</span><span class="ident" id="8348231">Errorf</span><span class="op" id="8348237">(</span><span class="string" id="8348238">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8348270">,</span>&nbsp;<span class="builtinfunc" id="8348272">len</span><span class="op" id="8348275">(</span><span class="ident" id="8348276">stats</span><span class="op" id="8348281">.</span><span class="ident" id="8348282">Pause</span><span class="op" id="8348287">)</span><span class="op" id="8348288">,</span>&nbsp;<span class="ident" id="8348290">n</span><span class="op" id="8348291">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348294">}</span>&nbsp;<span class="keyword" id="8348296">else</span>&nbsp;<span class="op" id="8348301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348305">off</span>&nbsp;<span class="op" id="8348309">:=</span>&nbsp;<span class="op" id="8348312">(</span><span class="builtintype" id="8348313">int</span><span class="op" id="8348316">(</span><span class="ident" id="8348317">mstats</span><span class="op" id="8348323">.</span><span class="ident" id="8348324">NumGC</span><span class="op" id="8348329">)</span>&nbsp;<span class="op" id="8348331">+</span>&nbsp;<span class="builtinfunc" id="8348333">len</span><span class="op" id="8348336">(</span><span class="ident" id="8348337">mstats</span><span class="op" id="8348343">.</span><span class="ident" id="8348344">PauseNs</span><span class="op" id="8348351">)</span>&nbsp;<span class="op" id="8348353">-</span>&nbsp;<span class="num" id="8348355">1</span><span class="op" id="8348356">)</span>&nbsp;<span class="op" id="8348358">%</span>&nbsp;<span class="builtinfunc" id="8348360">len</span><span class="op" id="8348363">(</span><span class="ident" id="8348364">mstats</span><span class="op" id="8348370">.</span><span class="ident" id="8348371">PauseNs</span><span class="op" id="8348378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348382">for</span>&nbsp;<span class="ident" id="8348386">i</span>&nbsp;<span class="op" id="8348388">:=</span>&nbsp;<span class="num" id="8348391">0</span><span class="op" id="8348392">;</span>&nbsp;<span class="ident" id="8348394">i</span>&nbsp;<span class="op" id="8348396">&lt;</span>&nbsp;<span class="ident" id="8348398">n</span><span class="op" id="8348399">;</span>&nbsp;<span class="ident" id="8348401">i</span><span class="op" id="8348402">++</span>&nbsp;<span class="op" id="8348405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348410">dt</span>&nbsp;<span class="op" id="8348413">:=</span>&nbsp;<span class="ident" id="8348416">stats</span><span class="op" id="8348421">.</span><span class="ident" id="8348422">Pause</span><span class="op" id="8348427">[</span><span class="ident" id="8348428">i</span><span class="op" id="8348429">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348434">if</span>&nbsp;<span class="ident" id="8348437">dt</span>&nbsp;<span class="op" id="8348440">!=</span>&nbsp;<span class="ident" id="8348443">time</span><span class="op" id="8348447">.</span><span class="ident" id="8348448">Duration</span><span class="op" id="8348456">(</span><span class="ident" id="8348457">mstats</span><span class="op" id="8348463">.</span><span class="ident" id="8348464">PauseNs</span><span class="op" id="8348471">[</span><span class="ident" id="8348472">off</span><span class="op" id="8348475">]</span><span class="op" id="8348476">)</span>&nbsp;<span class="op" id="8348478">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348484">t</span><span class="op" id="8348485">.</span><span class="ident" id="8348486">Errorf</span><span class="op" id="8348492">(</span><span class="string" id="8348493">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8348524">,</span>&nbsp;<span class="ident" id="8348526">i</span><span class="op" id="8348527">,</span>&nbsp;<span class="ident" id="8348529">dt</span><span class="op" id="8348531">,</span>&nbsp;<span class="ident" id="8348533">mstats</span><span class="op" id="8348539">.</span><span class="ident" id="8348540">PauseNs</span><span class="op" id="8348547">[</span><span class="ident" id="8348548">off</span><span class="op" id="8348551">]</span><span class="op" id="8348552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348562">if</span>&nbsp;<span class="ident" id="8348565">max</span>&nbsp;<span class="op" id="8348569">&lt;</span>&nbsp;<span class="ident" id="8348571">dt</span>&nbsp;<span class="op" id="8348574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348580">max</span>&nbsp;<span class="op" id="8348584">=</span>&nbsp;<span class="ident" id="8348586">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348592">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348597">if</span>&nbsp;<span class="ident" id="8348600">min</span>&nbsp;<span class="op" id="8348604">&gt;</span>&nbsp;<span class="ident" id="8348606">dt</span>&nbsp;<span class="op" id="8348609">||</span>&nbsp;<span class="ident" id="8348612">i</span>&nbsp;<span class="op" id="8348614">==</span>&nbsp;<span class="num" id="8348617">0</span>&nbsp;<span class="op" id="8348619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348625">min</span>&nbsp;<span class="op" id="8348629">=</span>&nbsp;<span class="ident" id="8348631">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348642">off</span>&nbsp;<span class="op" id="8348646">=</span>&nbsp;<span class="op" id="8348648">(</span><span class="ident" id="8348649">off</span>&nbsp;<span class="op" id="8348653">+</span>&nbsp;<span class="builtinfunc" id="8348655">len</span><span class="op" id="8348658">(</span><span class="ident" id="8348659">mstats</span><span class="op" id="8348665">.</span><span class="ident" id="8348666">PauseNs</span><span class="op" id="8348673">)</span>&nbsp;<span class="op" id="8348675">-</span>&nbsp;<span class="num" id="8348677">1</span><span class="op" id="8348678">)</span>&nbsp;<span class="op" id="8348680">%</span>&nbsp;<span class="builtinfunc" id="8348682">len</span><span class="op" id="8348685">(</span><span class="ident" id="8348686">mstats</span><span class="op" id="8348692">.</span><span class="ident" id="8348693">PauseNs</span><span class="op" id="8348700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348704">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348711">q</span>&nbsp;<span class="op" id="8348713">:=</span>&nbsp;<span class="ident" id="8348716">stats</span><span class="op" id="8348721">.</span><span class="ident" id="8348722">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348738">nq</span>&nbsp;<span class="op" id="8348741">:=</span>&nbsp;<span class="builtinfunc" id="8348744">len</span><span class="op" id="8348747">(</span><span class="ident" id="8348748">q</span><span class="op" id="8348749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348752">if</span>&nbsp;<span class="ident" id="8348755">q</span><span class="op" id="8348756">[</span><span class="num" id="8348757">0</span><span class="op" id="8348758">]</span>&nbsp;<span class="op" id="8348760">!=</span>&nbsp;<span class="ident" id="8348763">min</span>&nbsp;<span class="op" id="8348767">||</span>&nbsp;<span class="ident" id="8348770">q</span><span class="op" id="8348771">[</span><span class="ident" id="8348772">nq</span><span class="op" id="8348774">-</span><span class="num" id="8348775">1</span><span class="op" id="8348776">]</span>&nbsp;<span class="op" id="8348778">!=</span>&nbsp;<span class="ident" id="8348781">max</span>&nbsp;<span class="op" id="8348785">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348789">t</span><span class="op" id="8348790">.</span><span class="ident" id="8348791">Errorf</span><span class="op" id="8348797">(</span><span class="string" id="8348798">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="8348856">,</span>&nbsp;<span class="ident" id="8348858">q</span><span class="op" id="8348859">[</span><span class="num" id="8348860">0</span><span class="op" id="8348861">]</span><span class="op" id="8348862">,</span>&nbsp;<span class="ident" id="8348864">q</span><span class="op" id="8348865">[</span><span class="ident" id="8348866">nq</span><span class="op" id="8348868">-</span><span class="num" id="8348869">1</span><span class="op" id="8348870">]</span><span class="op" id="8348871">,</span>&nbsp;<span class="ident" id="8348873">min</span><span class="op" id="8348876">,</span>&nbsp;<span class="ident" id="8348878">max</span><span class="op" id="8348881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348888">for</span>&nbsp;<span class="ident" id="8348892">i</span>&nbsp;<span class="op" id="8348894">:=</span>&nbsp;<span class="num" id="8348897">0</span><span class="op" id="8348898">;</span>&nbsp;<span class="ident" id="8348900">i</span>&nbsp;<span class="op" id="8348902">&lt;</span>&nbsp;<span class="ident" id="8348904">nq</span><span class="op" id="8348906">-</span><span class="num" id="8348907">1</span><span class="op" id="8348908">;</span>&nbsp;<span class="ident" id="8348910">i</span><span class="op" id="8348911">++</span>&nbsp;<span class="op" id="8348914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348918">if</span>&nbsp;<span class="ident" id="8348921">q</span><span class="op" id="8348922">[</span><span class="ident" id="8348923">i</span><span class="op" id="8348924">]</span>&nbsp;<span class="op" id="8348926">&gt;</span>&nbsp;<span class="ident" id="8348928">q</span><span class="op" id="8348929">[</span><span class="ident" id="8348930">i</span><span class="op" id="8348931">+</span><span class="num" id="8348932">1</span><span class="op" id="8348933">]</span>&nbsp;<span class="op" id="8348935">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348940">t</span><span class="op" id="8348941">.</span><span class="ident" id="8348942">Errorf</span><span class="op" id="8348948">(</span><span class="string" id="8348949">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="8349008">,</span>&nbsp;<span class="ident" id="8349010">i</span><span class="op" id="8349011">,</span>&nbsp;<span class="ident" id="8349013">q</span><span class="op" id="8349014">[</span><span class="ident" id="8349015">i</span><span class="op" id="8349016">]</span><span class="op" id="8349017">,</span>&nbsp;<span class="ident" id="8349019">i</span><span class="op" id="8349020">+</span><span class="num" id="8349021">1</span><span class="op" id="8349022">,</span>&nbsp;<span class="ident" id="8349024">q</span><span class="op" id="8349025">[</span><span class="ident" id="8349026">i</span><span class="op" id="8349027">+</span><span class="num" id="8349028">1</span><span class="op" id="8349029">]</span><span class="op" id="8349030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8349041">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349081">if</span>&nbsp;<span class="builtinfunc" id="8349084">len</span><span class="op" id="8349087">(</span><span class="ident" id="8349088">stats</span><span class="op" id="8349093">.</span><span class="ident" id="8349094">PauseEnd</span><span class="op" id="8349102">)</span>&nbsp;<span class="op" id="8349104">!=</span>&nbsp;<span class="ident" id="8349107">n</span>&nbsp;<span class="op" id="8349109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349113">t</span><span class="op" id="8349114">.</span><span class="ident" id="8349115">Fatalf</span><span class="op" id="8349121">(</span><span class="string" id="8349122">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8349157">,</span>&nbsp;<span class="builtinfunc" id="8349159">len</span><span class="op" id="8349162">(</span><span class="ident" id="8349163">stats</span><span class="op" id="8349168">.</span><span class="ident" id="8349169">PauseEnd</span><span class="op" id="8349177">)</span><span class="op" id="8349178">,</span>&nbsp;<span class="ident" id="8349180">n</span><span class="op" id="8349181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349187">off</span>&nbsp;<span class="op" id="8349191">:=</span>&nbsp;<span class="op" id="8349194">(</span><span class="builtintype" id="8349195">int</span><span class="op" id="8349198">(</span><span class="ident" id="8349199">mstats</span><span class="op" id="8349205">.</span><span class="ident" id="8349206">NumGC</span><span class="op" id="8349211">)</span>&nbsp;<span class="op" id="8349213">+</span>&nbsp;<span class="builtinfunc" id="8349215">len</span><span class="op" id="8349218">(</span><span class="ident" id="8349219">mstats</span><span class="op" id="8349225">.</span><span class="ident" id="8349226">PauseEnd</span><span class="op" id="8349234">)</span>&nbsp;<span class="op" id="8349236">-</span>&nbsp;<span class="num" id="8349238">1</span><span class="op" id="8349239">)</span>&nbsp;<span class="op" id="8349241">%</span>&nbsp;<span class="builtinfunc" id="8349243">len</span><span class="op" id="8349246">(</span><span class="ident" id="8349247">mstats</span><span class="op" id="8349253">.</span><span class="ident" id="8349254">PauseEnd</span><span class="op" id="8349262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349265">for</span>&nbsp;<span class="ident" id="8349269">i</span>&nbsp;<span class="op" id="8349271">:=</span>&nbsp;<span class="num" id="8349274">0</span><span class="op" id="8349275">;</span>&nbsp;<span class="ident" id="8349277">i</span>&nbsp;<span class="op" id="8349279">&lt;</span>&nbsp;<span class="ident" id="8349281">n</span><span class="op" id="8349282">;</span>&nbsp;<span class="ident" id="8349284">i</span><span class="op" id="8349285">++</span>&nbsp;<span class="op" id="8349288">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349292">dt</span>&nbsp;<span class="op" id="8349295">:=</span>&nbsp;<span class="ident" id="8349298">stats</span><span class="op" id="8349303">.</span><span class="ident" id="8349304">PauseEnd</span><span class="op" id="8349312">[</span><span class="ident" id="8349313">i</span><span class="op" id="8349314">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349318">if</span>&nbsp;<span class="ident" id="8349321">dt</span><span class="op" id="8349323">.</span><span class="ident" id="8349324">UnixNano</span><span class="op" id="8349332">(</span><span class="op" id="8349333">)</span>&nbsp;<span class="op" id="8349335">!=</span>&nbsp;<span class="ident" id="8349338">int64</span><span class="op" id="8349343">(</span><span class="ident" id="8349344">mstats</span><span class="op" id="8349350">.</span><span class="ident" id="8349351">PauseEnd</span><span class="op" id="8349359">[</span><span class="ident" id="8349360">off</span><span class="op" id="8349363">]</span><span class="op" id="8349364">)</span>&nbsp;<span class="op" id="8349366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349371">t</span><span class="op" id="8349372">.</span><span class="ident" id="8349373">Errorf</span><span class="op" id="8349379">(</span><span class="string" id="8349380">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8349414">,</span>&nbsp;<span class="ident" id="8349416">i</span><span class="op" id="8349417">,</span>&nbsp;<span class="ident" id="8349419">dt</span><span class="op" id="8349421">,</span>&nbsp;<span class="ident" id="8349423">mstats</span><span class="op" id="8349429">.</span><span class="ident" id="8349430">PauseEnd</span><span class="op" id="8349438">[</span><span class="ident" id="8349439">off</span><span class="op" id="8349442">]</span><span class="op" id="8349443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349451">off</span>&nbsp;<span class="op" id="8349455">=</span>&nbsp;<span class="op" id="8349457">(</span><span class="ident" id="8349458">off</span>&nbsp;<span class="op" id="8349462">+</span>&nbsp;<span class="builtinfunc" id="8349464">len</span><span class="op" id="8349467">(</span><span class="ident" id="8349468">mstats</span><span class="op" id="8349474">.</span><span class="ident" id="8349475">PauseEnd</span><span class="op" id="8349483">)</span>&nbsp;<span class="op" id="8349485">-</span>&nbsp;<span class="num" id="8349487">1</span><span class="op" id="8349488">)</span>&nbsp;<span class="op" id="8349490">%</span>&nbsp;<span class="builtinfunc" id="8349492">len</span><span class="op" id="8349495">(</span><span class="ident" id="8349496">mstats</span><span class="op" id="8349502">.</span><span class="ident" id="8349503">PauseEnd</span><span class="op" id="8349511">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349514">}</span><br>
<span class="lineno"></span><span class="op" id="8349516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8349519">var</span>&nbsp;<span class="ident" id="8349523">big</span>&nbsp;<span class="op" id="8349527">=</span>&nbsp;<span class="builtinfunc" id="8349529">make</span><span class="op" id="8349533">(</span><span class="op" id="8349534">[</span><span class="op" id="8349535">]</span><span class="builtintype" id="8349536">byte</span><span class="op" id="8349540">,</span>&nbsp;<span class="num" id="8349542">1</span><span class="op" id="8349543">&lt;&lt;</span><span class="num" id="8349545">20</span><span class="op" id="8349547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="8349550">func</span>&nbsp;<span class="ident" id="8349555">TestFreeOSMemory</span><span class="op" id="8349571">(</span><span class="ident" id="8349572">t</span>&nbsp;<span class="op" id="8349574">*</span><span class="ident" id="8349575">testing</span><span class="op" id="8349582">.</span><span class="ident" id="8349583">T</span><span class="op" id="8349584">)</span>&nbsp;<span class="op" id="8349586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349589">var</span>&nbsp;<span class="ident" id="8349593">ms1</span><span class="op" id="8349596">,</span>&nbsp;<span class="ident" id="8349598">ms2</span>&nbsp;<span class="ident" id="8349602">runtime</span><span class="op" id="8349609">.</span><span class="ident" id="8349610">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349621">if</span>&nbsp;<span class="ident" id="8349624">big</span>&nbsp;<span class="op" id="8349628">==</span>&nbsp;<span class="ident" id="8349631">nil</span>&nbsp;<span class="op" id="8349635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349639">t</span><span class="op" id="8349640">.</span><span class="ident" id="8349641">Skip</span><span class="op" id="8349645">(</span><span class="string" id="8349646">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="8349692">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349698">big</span>&nbsp;<span class="op" id="8349702">=</span>&nbsp;<span class="ident" id="8349704">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349709">runtime</span><span class="op" id="8349716">.</span><span class="ident" id="8349717">GC</span><span class="op" id="8349719">(</span><span class="op" id="8349720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349723">runtime</span><span class="op" id="8349730">.</span><span class="ident" id="8349731">ReadMemStats</span><span class="op" id="8349743">(</span><span class="op" id="8349744">&amp;</span><span class="ident" id="8349745">ms1</span><span class="op" id="8349748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349751">FreeOSMemory</span><span class="op" id="8349763">(</span><span class="op" id="8349764">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349767">runtime</span><span class="op" id="8349774">.</span><span class="ident" id="8349775">ReadMemStats</span><span class="op" id="8349787">(</span><span class="op" id="8349788">&amp;</span><span class="ident" id="8349789">ms2</span><span class="op" id="8349792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349795">if</span>&nbsp;<span class="ident" id="8349798">ms1</span><span class="op" id="8349801">.</span><span class="ident" id="8349802">HeapReleased</span>&nbsp;<span class="op" id="8349815">&gt;=</span>&nbsp;<span class="ident" id="8349818">ms2</span><span class="op" id="8349821">.</span><span class="ident" id="8349822">HeapReleased</span>&nbsp;<span class="op" id="8349835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349839">t</span><span class="op" id="8349840">.</span><span class="ident" id="8349841">Errorf</span><span class="op" id="8349847">(</span><span class="string" id="8349848">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="8349902">,</span>&nbsp;<span class="ident" id="8349904">ms1</span><span class="op" id="8349907">.</span><span class="ident" id="8349908">HeapReleased</span><span class="op" id="8349920">,</span>&nbsp;<span class="ident" id="8349922">ms2</span><span class="op" id="8349925">.</span><span class="ident" id="8349926">HeapReleased</span><span class="op" id="8349938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349941">}</span><br>
<span class="lineno"></span><span class="op" id="8349943">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="8349946">func</span>&nbsp;<span class="ident" id="8349951">TestSetGCPercent</span><span class="op" id="8349967">(</span><span class="ident" id="8349968">t</span>&nbsp;<span class="op" id="8349970">*</span><span class="ident" id="8349971">testing</span><span class="op" id="8349978">.</span><span class="ident" id="8349979">T</span><span class="op" id="8349980">)</span>&nbsp;<span class="op" id="8349982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8349985">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8350049">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8350113">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350142">old</span>&nbsp;<span class="op" id="8350146">:=</span>&nbsp;<span class="ident" id="8350149">SetGCPercent</span><span class="op" id="8350161">(</span><span class="num" id="8350162">123</span><span class="op" id="8350165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8350168">new</span>&nbsp;<span class="op" id="8350172">:=</span>&nbsp;<span class="ident" id="8350175">SetGCPercent</span><span class="op" id="8350187">(</span><span class="ident" id="8350188">old</span><span class="op" id="8350191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350194">if</span>&nbsp;<span class="builtinfunc" id="8350197">new</span>&nbsp;<span class="op" id="8350201">!=</span>&nbsp;<span class="num" id="8350204">123</span>&nbsp;<span class="op" id="8350208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350212">t</span><span class="op" id="8350213">.</span><span class="ident" id="8350214">Errorf</span><span class="op" id="8350220">(</span><span class="string" id="8350221">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="8350272">,</span>&nbsp;<span class="builtinfunc" id="8350274">new</span><span class="op" id="8350277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350280">}</span><br>
<span class="lineno">115</span><span class="op" id="8350282">}</span>
</div>
</body>
</html>
