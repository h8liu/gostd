<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html" class="current">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4643287">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4643342">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4643396">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4643447">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="4643518">package</span>&nbsp;<span class="ident" id="4643526">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4643531">import</span>&nbsp;<span class="op" id="4643538">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643541">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643551">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643567">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643581">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643596">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643612">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643622">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643635">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643642">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4643653">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4643660">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4643663">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4643714">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4643757">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4643815">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="4643844">func</span>&nbsp;<span class="ident" id="4643849">Server</span><span class="op" id="4643855">(</span><span class="ident" id="4643856">conn</span>&nbsp;<span class="ident" id="4643861">net</span><span class="op" id="4643864">.</span><span class="ident" id="4643865">Conn</span><span class="op" id="4643869">,</span>&nbsp;<span class="ident" id="4643871">config</span>&nbsp;<span class="op" id="4643878">*</span><span class="ident" id="4643879">Config</span><span class="op" id="4643885">)</span>&nbsp;<span class="op" id="4643887">*</span><span class="ident" id="4643888">Conn</span>&nbsp;<span class="op" id="4643893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643896">return</span>&nbsp;<span class="op" id="4643903">&amp;</span><span class="ident" id="4643904">Conn</span><span class="op" id="4643908">{</span><span class="ident" id="4643909">conn</span><span class="op" id="4643913">:</span>&nbsp;<span class="ident" id="4643915">conn</span><span class="op" id="4643919">,</span>&nbsp;<span class="ident" id="4643921">config</span><span class="op" id="4643927">:</span>&nbsp;<span class="ident" id="4643929">config</span><span class="op" id="4643935">}</span><br>
<span class="lineno"></span><span class="op" id="4643937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4643940">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="4643991">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4644034">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4644099">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="4644136">func</span>&nbsp;<span class="ident" id="4644141">Client</span><span class="op" id="4644147">(</span><span class="ident" id="4644148">conn</span>&nbsp;<span class="ident" id="4644153">net</span><span class="op" id="4644156">.</span><span class="ident" id="4644157">Conn</span><span class="op" id="4644161">,</span>&nbsp;<span class="ident" id="4644163">config</span>&nbsp;<span class="op" id="4644170">*</span><span class="ident" id="4644171">Config</span><span class="op" id="4644177">)</span>&nbsp;<span class="op" id="4644179">*</span><span class="ident" id="4644180">Conn</span>&nbsp;<span class="op" id="4644185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644188">return</span>&nbsp;<span class="op" id="4644195">&amp;</span><span class="ident" id="4644196">Conn</span><span class="op" id="4644200">{</span><span class="ident" id="4644201">conn</span><span class="op" id="4644205">:</span>&nbsp;<span class="ident" id="4644207">conn</span><span class="op" id="4644211">,</span>&nbsp;<span class="ident" id="4644213">config</span><span class="op" id="4644219">:</span>&nbsp;<span class="ident" id="4644221">config</span><span class="op" id="4644227">,</span>&nbsp;<span class="ident" id="4644229">isClient</span><span class="op" id="4644237">:</span>&nbsp;<span class="builtintype" id="4644239">true</span><span class="op" id="4644243">}</span><br>
<span class="lineno">35</span><span class="op" id="4644245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4644248">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4644328">type</span>&nbsp;<span class="ident" id="4644333">listener</span>&nbsp;<span class="keyword" id="4644342">struct</span>&nbsp;<span class="op" id="4644349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644352">net</span><span class="op" id="4644355">.</span><span class="ident" id="4644356">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644366">config</span>&nbsp;<span class="op" id="4644373">*</span><span class="ident" id="4644374">Config</span><br>
<span class="lineno"></span><span class="op" id="4644381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4644384">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4644450">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="4644495">func</span>&nbsp;<span class="op" id="4644500">(</span><span class="ident" id="4644501">l</span>&nbsp;<span class="op" id="4644503">*</span><span class="ident" id="4644504">listener</span><span class="op" id="4644512">)</span>&nbsp;<span class="ident" id="4644514">Accept</span><span class="op" id="4644520">(</span><span class="op" id="4644521">)</span>&nbsp;<span class="op" id="4644523">(</span><span class="ident" id="4644524">c</span>&nbsp;<span class="ident" id="4644526">net</span><span class="op" id="4644529">.</span><span class="ident" id="4644530">Conn</span><span class="op" id="4644534">,</span>&nbsp;<span class="ident" id="4644536">err</span>&nbsp;<span class="builtintype" id="4644540">error</span><span class="op" id="4644545">)</span>&nbsp;<span class="op" id="4644547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644550">c</span><span class="op" id="4644551">,</span>&nbsp;<span class="ident" id="4644553">err</span>&nbsp;<span class="op" id="4644557">=</span>&nbsp;<span class="ident" id="4644559">l</span><span class="op" id="4644560">.</span><span class="ident" id="4644561">Listener</span><span class="op" id="4644569">.</span><span class="ident" id="4644570">Accept</span><span class="op" id="4644576">(</span><span class="op" id="4644577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644580">if</span>&nbsp;<span class="ident" id="4644583">err</span>&nbsp;<span class="op" id="4644587">!=</span>&nbsp;<span class="ident" id="4644590">nil</span>&nbsp;<span class="op" id="4644594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644598">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644606">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644609">c</span>&nbsp;<span class="op" id="4644611">=</span>&nbsp;<span class="ident" id="4644613">Server</span><span class="op" id="4644619">(</span><span class="ident" id="4644620">c</span><span class="op" id="4644621">,</span>&nbsp;<span class="ident" id="4644623">l</span><span class="op" id="4644624">.</span><span class="ident" id="4644625">config</span><span class="op" id="4644631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644634">return</span><br>
<span class="lineno"></span><span class="op" id="4644641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4644644">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="4644718">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4644769">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4644827">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4644856">func</span>&nbsp;<span class="ident" id="4644861">NewListener</span><span class="op" id="4644872">(</span><span class="ident" id="4644873">inner</span>&nbsp;<span class="ident" id="4644879">net</span><span class="op" id="4644882">.</span><span class="ident" id="4644883">Listener</span><span class="op" id="4644891">,</span>&nbsp;<span class="ident" id="4644893">config</span>&nbsp;<span class="op" id="4644900">*</span><span class="ident" id="4644901">Config</span><span class="op" id="4644907">)</span>&nbsp;<span class="ident" id="4644909">net</span><span class="op" id="4644912">.</span><span class="ident" id="4644913">Listener</span>&nbsp;<span class="op" id="4644922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644925">l</span>&nbsp;<span class="op" id="4644927">:=</span>&nbsp;<span class="builtinfunc" id="4644930">new</span><span class="op" id="4644933">(</span><span class="ident" id="4644934">listener</span><span class="op" id="4644942">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644945">l</span><span class="op" id="4644946">.</span><span class="ident" id="4644947">Listener</span>&nbsp;<span class="op" id="4644956">=</span>&nbsp;<span class="ident" id="4644958">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644965">l</span><span class="op" id="4644966">.</span><span class="ident" id="4644967">config</span>&nbsp;<span class="op" id="4644974">=</span>&nbsp;<span class="ident" id="4644976">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644984">return</span>&nbsp;<span class="ident" id="4644991">l</span><br>
<span class="lineno"></span><span class="op" id="4644993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4644996">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4645058">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="4645101">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4645159">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4645188">func</span>&nbsp;<span class="ident" id="4645193">Listen</span><span class="op" id="4645199">(</span><span class="ident" id="4645200">network</span><span class="op" id="4645207">,</span>&nbsp;<span class="ident" id="4645209">laddr</span>&nbsp;<span class="builtintype" id="4645215">string</span><span class="op" id="4645221">,</span>&nbsp;<span class="ident" id="4645223">config</span>&nbsp;<span class="op" id="4645230">*</span><span class="ident" id="4645231">Config</span><span class="op" id="4645237">)</span>&nbsp;<span class="op" id="4645239">(</span><span class="ident" id="4645240">net</span><span class="op" id="4645243">.</span><span class="ident" id="4645244">Listener</span><span class="op" id="4645252">,</span>&nbsp;<span class="builtintype" id="4645254">error</span><span class="op" id="4645259">)</span>&nbsp;<span class="op" id="4645261">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645264">if</span>&nbsp;<span class="ident" id="4645267">config</span>&nbsp;<span class="op" id="4645274">==</span>&nbsp;<span class="ident" id="4645277">nil</span>&nbsp;<span class="op" id="4645281">||</span>&nbsp;<span class="builtinfunc" id="4645284">len</span><span class="op" id="4645287">(</span><span class="ident" id="4645288">config</span><span class="op" id="4645294">.</span><span class="ident" id="4645295">Certificates</span><span class="op" id="4645307">)</span>&nbsp;<span class="op" id="4645309">==</span>&nbsp;<span class="num" id="4645312">0</span>&nbsp;<span class="op" id="4645314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645318">return</span>&nbsp;<span class="ident" id="4645325">nil</span><span class="op" id="4645328">,</span>&nbsp;<span class="ident" id="4645330">errors</span><span class="op" id="4645336">.</span><span class="ident" id="4645337">New</span><span class="op" id="4645340">(</span><span class="string" id="4645341">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="4645387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4645390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645393">l</span><span class="op" id="4645394">,</span>&nbsp;<span class="ident" id="4645396">err</span>&nbsp;<span class="op" id="4645400">:=</span>&nbsp;<span class="ident" id="4645403">net</span><span class="op" id="4645406">.</span><span class="ident" id="4645407">Listen</span><span class="op" id="4645413">(</span><span class="ident" id="4645414">network</span><span class="op" id="4645421">,</span>&nbsp;<span class="ident" id="4645423">laddr</span><span class="op" id="4645428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645431">if</span>&nbsp;<span class="ident" id="4645434">err</span>&nbsp;<span class="op" id="4645438">!=</span>&nbsp;<span class="ident" id="4645441">nil</span>&nbsp;<span class="op" id="4645445">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645449">return</span>&nbsp;<span class="ident" id="4645456">nil</span><span class="op" id="4645459">,</span>&nbsp;<span class="ident" id="4645461">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4645466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645469">return</span>&nbsp;<span class="ident" id="4645476">NewListener</span><span class="op" id="4645487">(</span><span class="ident" id="4645488">l</span><span class="op" id="4645489">,</span>&nbsp;<span class="ident" id="4645491">config</span><span class="op" id="4645497">)</span><span class="op" id="4645498">,</span>&nbsp;<span class="ident" id="4645500">nil</span><br>
<span class="lineno"></span><span class="op" id="4645504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4645507">type</span>&nbsp;<span class="ident" id="4645512">timeoutError</span>&nbsp;<span class="keyword" id="4645525">struct</span><span class="op" id="4645531">{</span><span class="op" id="4645532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4645535">func</span>&nbsp;<span class="op" id="4645540">(</span><span class="ident" id="4645541">timeoutError</span><span class="op" id="4645553">)</span>&nbsp;<span class="ident" id="4645555">Error</span><span class="op" id="4645560">(</span><span class="op" id="4645561">)</span>&nbsp;<span class="builtintype" id="4645563">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4645572">{</span>&nbsp;<span class="keyword" id="4645574">return</span>&nbsp;<span class="string" id="4645581">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="4645613">}</span><br>
<span class="lineno"></span><span class="keyword" id="4645615">func</span>&nbsp;<span class="op" id="4645620">(</span><span class="ident" id="4645621">timeoutError</span><span class="op" id="4645633">)</span>&nbsp;<span class="ident" id="4645635">Timeout</span><span class="op" id="4645642">(</span><span class="op" id="4645643">)</span>&nbsp;<span class="builtintype" id="4645645">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4645652">{</span>&nbsp;<span class="keyword" id="4645654">return</span>&nbsp;<span class="builtintype" id="4645661">true</span>&nbsp;<span class="op" id="4645666">}</span><br>
<span class="lineno"></span><span class="keyword" id="4645668">func</span>&nbsp;<span class="op" id="4645673">(</span><span class="ident" id="4645674">timeoutError</span><span class="op" id="4645686">)</span>&nbsp;<span class="ident" id="4645688">Temporary</span><span class="op" id="4645697">(</span><span class="op" id="4645698">)</span>&nbsp;<span class="builtintype" id="4645700">bool</span>&nbsp;<span class="op" id="4645705">{</span>&nbsp;<span class="keyword" id="4645707">return</span>&nbsp;<span class="builtintype" id="4645714">true</span>&nbsp;<span class="op" id="4645719">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4645722">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4645800">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4645879">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="4645950">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="4645975">//</span><br>
<span class="lineno"></span><span class="comment" id="4645978">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="4646053">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4646121">func</span>&nbsp;<span class="ident" id="4646126">DialWithDialer</span><span class="op" id="4646140">(</span><span class="ident" id="4646141">dialer</span>&nbsp;<span class="op" id="4646148">*</span><span class="ident" id="4646149">net</span><span class="op" id="4646152">.</span><span class="ident" id="4646153">Dialer</span><span class="op" id="4646159">,</span>&nbsp;<span class="ident" id="4646161">network</span><span class="op" id="4646168">,</span>&nbsp;<span class="ident" id="4646170">addr</span>&nbsp;<span class="builtintype" id="4646175">string</span><span class="op" id="4646181">,</span>&nbsp;<span class="ident" id="4646183">config</span>&nbsp;<span class="op" id="4646190">*</span><span class="ident" id="4646191">Config</span><span class="op" id="4646197">)</span>&nbsp;<span class="op" id="4646199">(</span><span class="op" id="4646200">*</span><span class="ident" id="4646201">Conn</span><span class="op" id="4646205">,</span>&nbsp;<span class="builtintype" id="4646207">error</span><span class="op" id="4646212">)</span>&nbsp;<span class="op" id="4646214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4646217">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4646286">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4646358">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646401">timeout</span>&nbsp;<span class="op" id="4646409">:=</span>&nbsp;<span class="ident" id="4646412">dialer</span><span class="op" id="4646418">.</span><span class="ident" id="4646419">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646429">if</span>&nbsp;<span class="op" id="4646432">!</span><span class="ident" id="4646433">dialer</span><span class="op" id="4646439">.</span><span class="ident" id="4646440">Deadline</span><span class="op" id="4646448">.</span><span class="ident" id="4646449">IsZero</span><span class="op" id="4646455">(</span><span class="op" id="4646456">)</span>&nbsp;<span class="op" id="4646458">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646462">deadlineTimeout</span>&nbsp;<span class="op" id="4646478">:=</span>&nbsp;<span class="ident" id="4646481">dialer</span><span class="op" id="4646487">.</span><span class="ident" id="4646488">Deadline</span><span class="op" id="4646496">.</span><span class="ident" id="4646497">Sub</span><span class="op" id="4646500">(</span><span class="ident" id="4646501">time</span><span class="op" id="4646505">.</span><span class="ident" id="4646506">Now</span><span class="op" id="4646509">(</span><span class="op" id="4646510">)</span><span class="op" id="4646511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646515">if</span>&nbsp;<span class="ident" id="4646518">timeout</span>&nbsp;<span class="op" id="4646526">==</span>&nbsp;<span class="num" id="4646529">0</span>&nbsp;<span class="op" id="4646531">||</span>&nbsp;<span class="ident" id="4646534">deadlineTimeout</span>&nbsp;<span class="op" id="4646550">&lt;</span>&nbsp;<span class="ident" id="4646552">timeout</span>&nbsp;<span class="op" id="4646560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646565">timeout</span>&nbsp;<span class="op" id="4646573">=</span>&nbsp;<span class="ident" id="4646575">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646596">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646600">var</span>&nbsp;<span class="ident" id="4646604">errChannel</span>&nbsp;<span class="keyword" id="4646615">chan</span>&nbsp;<span class="builtintype" id="4646620">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646628">if</span>&nbsp;<span class="ident" id="4646631">timeout</span>&nbsp;<span class="op" id="4646639">!=</span>&nbsp;<span class="num" id="4646642">0</span>&nbsp;<span class="op" id="4646644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646648">errChannel</span>&nbsp;<span class="op" id="4646659">=</span>&nbsp;<span class="builtinfunc" id="4646661">make</span><span class="op" id="4646665">(</span><span class="keyword" id="4646666">chan</span>&nbsp;<span class="builtintype" id="4646671">error</span><span class="op" id="4646676">,</span>&nbsp;<span class="num" id="4646678">2</span><span class="op" id="4646679">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646683">time</span><span class="op" id="4646687">.</span><span class="ident" id="4646688">AfterFunc</span><span class="op" id="4646697">(</span><span class="ident" id="4646698">timeout</span><span class="op" id="4646705">,</span>&nbsp;<span class="keyword" id="4646707">func</span><span class="op" id="4646711">(</span><span class="op" id="4646712">)</span>&nbsp;<span class="op" id="4646714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646719">errChannel</span>&nbsp;<span class="op" id="4646730">&lt;-</span>&nbsp;<span class="ident" id="4646733">timeoutError</span><span class="op" id="4646745">{</span><span class="op" id="4646746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646750">}</span><span class="op" id="4646751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646758">rawConn</span><span class="op" id="4646765">,</span>&nbsp;<span class="ident" id="4646767">err</span>&nbsp;<span class="op" id="4646771">:=</span>&nbsp;<span class="ident" id="4646774">dialer</span><span class="op" id="4646780">.</span><span class="ident" id="4646781">Dial</span><span class="op" id="4646785">(</span><span class="ident" id="4646786">network</span><span class="op" id="4646793">,</span>&nbsp;<span class="ident" id="4646795">addr</span><span class="op" id="4646799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646802">if</span>&nbsp;<span class="ident" id="4646805">err</span>&nbsp;<span class="op" id="4646809">!=</span>&nbsp;<span class="ident" id="4646812">nil</span>&nbsp;<span class="op" id="4646816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646820">return</span>&nbsp;<span class="ident" id="4646827">nil</span><span class="op" id="4646830">,</span>&nbsp;<span class="ident" id="4646832">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646841">colonPos</span>&nbsp;<span class="op" id="4646850">:=</span>&nbsp;<span class="ident" id="4646853">strings</span><span class="op" id="4646860">.</span><span class="ident" id="4646861">LastIndex</span><span class="op" id="4646870">(</span><span class="ident" id="4646871">addr</span><span class="op" id="4646875">,</span>&nbsp;<span class="string" id="4646877">&#34;:&#34;</span><span class="op" id="4646880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646883">if</span>&nbsp;<span class="ident" id="4646886">colonPos</span>&nbsp;<span class="op" id="4646895">==</span>&nbsp;<span class="op" id="4646898">-</span><span class="num" id="4646899">1</span>&nbsp;<span class="op" id="4646901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646905">colonPos</span>&nbsp;<span class="op" id="4646914">=</span>&nbsp;<span class="builtinfunc" id="4646916">len</span><span class="op" id="4646919">(</span><span class="ident" id="4646920">addr</span><span class="op" id="4646924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646930">hostname</span>&nbsp;<span class="op" id="4646939">:=</span>&nbsp;<span class="ident" id="4646942">addr</span><span class="op" id="4646946">[</span><span class="op" id="4646947">:</span><span class="ident" id="4646948">colonPos</span><span class="op" id="4646956">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646960">if</span>&nbsp;<span class="ident" id="4646963">config</span>&nbsp;<span class="op" id="4646970">==</span>&nbsp;<span class="ident" id="4646973">nil</span>&nbsp;<span class="op" id="4646977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646981">config</span>&nbsp;<span class="op" id="4646988">=</span>&nbsp;<span class="ident" id="4646990">defaultConfig</span><span class="op" id="4647003">(</span><span class="op" id="4647004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647010">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647060">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647103">if</span>&nbsp;<span class="ident" id="4647106">config</span><span class="op" id="4647112">.</span><span class="ident" id="4647113">ServerName</span>&nbsp;<span class="op" id="4647124">==</span>&nbsp;<span class="string" id="4647127">&#34;&#34;</span>&nbsp;<span class="op" id="4647130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647134">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647191">c</span>&nbsp;<span class="op" id="4647193">:=</span>&nbsp;<span class="op" id="4647196">*</span><span class="ident" id="4647197">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647206">c</span><span class="op" id="4647207">.</span><span class="ident" id="4647208">ServerName</span>&nbsp;<span class="op" id="4647219">=</span>&nbsp;<span class="ident" id="4647221">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647232">config</span>&nbsp;<span class="op" id="4647239">=</span>&nbsp;<span class="op" id="4647241">&amp;</span><span class="ident" id="4647242">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647249">conn</span>&nbsp;<span class="op" id="4647254">:=</span>&nbsp;<span class="ident" id="4647257">Client</span><span class="op" id="4647263">(</span><span class="ident" id="4647264">rawConn</span><span class="op" id="4647271">,</span>&nbsp;<span class="ident" id="4647273">config</span><span class="op" id="4647279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647283">if</span>&nbsp;<span class="ident" id="4647286">timeout</span>&nbsp;<span class="op" id="4647294">==</span>&nbsp;<span class="num" id="4647297">0</span>&nbsp;<span class="op" id="4647299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647303">err</span>&nbsp;<span class="op" id="4647307">=</span>&nbsp;<span class="ident" id="4647309">conn</span><span class="op" id="4647313">.</span><span class="ident" id="4647314">Handshake</span><span class="op" id="4647323">(</span><span class="op" id="4647324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647327">}</span>&nbsp;<span class="keyword" id="4647329">else</span>&nbsp;<span class="op" id="4647334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647338">go</span>&nbsp;<span class="keyword" id="4647341">func</span><span class="op" id="4647345">(</span><span class="op" id="4647346">)</span>&nbsp;<span class="op" id="4647348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647353">errChannel</span>&nbsp;<span class="op" id="4647364">&lt;-</span>&nbsp;<span class="ident" id="4647367">conn</span><span class="op" id="4647371">.</span><span class="ident" id="4647372">Handshake</span><span class="op" id="4647381">(</span><span class="op" id="4647382">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647386">}</span><span class="op" id="4647387">(</span><span class="op" id="4647388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647393">err</span>&nbsp;<span class="op" id="4647397">=</span>&nbsp;<span class="op" id="4647399">&lt;-</span><span class="ident" id="4647401">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647417">if</span>&nbsp;<span class="ident" id="4647420">err</span>&nbsp;<span class="op" id="4647424">!=</span>&nbsp;<span class="ident" id="4647427">nil</span>&nbsp;<span class="op" id="4647431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647435">rawConn</span><span class="op" id="4647442">.</span><span class="ident" id="4647443">Close</span><span class="op" id="4647448">(</span><span class="op" id="4647449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647453">return</span>&nbsp;<span class="ident" id="4647460">nil</span><span class="op" id="4647463">,</span>&nbsp;<span class="ident" id="4647465">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647474">return</span>&nbsp;<span class="ident" id="4647481">conn</span><span class="op" id="4647485">,</span>&nbsp;<span class="ident" id="4647487">nil</span><br>
<span class="lineno"></span><span class="op" id="4647491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4647494">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="4647555">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="4647618">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4647637">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4647693">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="4647752">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4647773">func</span>&nbsp;<span class="ident" id="4647778">Dial</span><span class="op" id="4647782">(</span><span class="ident" id="4647783">network</span><span class="op" id="4647790">,</span>&nbsp;<span class="ident" id="4647792">addr</span>&nbsp;<span class="builtintype" id="4647797">string</span><span class="op" id="4647803">,</span>&nbsp;<span class="ident" id="4647805">config</span>&nbsp;<span class="op" id="4647812">*</span><span class="ident" id="4647813">Config</span><span class="op" id="4647819">)</span>&nbsp;<span class="op" id="4647821">(</span><span class="op" id="4647822">*</span><span class="ident" id="4647823">Conn</span><span class="op" id="4647827">,</span>&nbsp;<span class="builtintype" id="4647829">error</span><span class="op" id="4647834">)</span>&nbsp;<span class="op" id="4647836">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647839">return</span>&nbsp;<span class="ident" id="4647846">DialWithDialer</span><span class="op" id="4647860">(</span><span class="builtinfunc" id="4647861">new</span><span class="op" id="4647864">(</span><span class="ident" id="4647865">net</span><span class="op" id="4647868">.</span><span class="ident" id="4647869">Dialer</span><span class="op" id="4647875">)</span><span class="op" id="4647876">,</span>&nbsp;<span class="ident" id="4647878">network</span><span class="op" id="4647885">,</span>&nbsp;<span class="ident" id="4647887">addr</span><span class="op" id="4647891">,</span>&nbsp;<span class="ident" id="4647893">config</span><span class="op" id="4647899">)</span><br>
<span class="lineno"></span><span class="op" id="4647901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4647904">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4647981">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="4648032">func</span>&nbsp;<span class="ident" id="4648037">LoadX509KeyPair</span><span class="op" id="4648052">(</span><span class="ident" id="4648053">certFile</span><span class="op" id="4648061">,</span>&nbsp;<span class="ident" id="4648063">keyFile</span>&nbsp;<span class="builtintype" id="4648071">string</span><span class="op" id="4648077">)</span>&nbsp;<span class="op" id="4648079">(</span><span class="ident" id="4648080">cert</span>&nbsp;<span class="ident" id="4648085">Certificate</span><span class="op" id="4648096">,</span>&nbsp;<span class="ident" id="4648098">err</span>&nbsp;<span class="builtintype" id="4648102">error</span><span class="op" id="4648107">)</span>&nbsp;<span class="op" id="4648109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648112">certPEMBlock</span><span class="op" id="4648124">,</span>&nbsp;<span class="ident" id="4648126">err</span>&nbsp;<span class="op" id="4648130">:=</span>&nbsp;<span class="ident" id="4648133">ioutil</span><span class="op" id="4648139">.</span><span class="ident" id="4648140">ReadFile</span><span class="op" id="4648148">(</span><span class="ident" id="4648149">certFile</span><span class="op" id="4648157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648160">if</span>&nbsp;<span class="ident" id="4648163">err</span>&nbsp;<span class="op" id="4648167">!=</span>&nbsp;<span class="ident" id="4648170">nil</span>&nbsp;<span class="op" id="4648174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648178">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648186">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648189">keyPEMBlock</span><span class="op" id="4648200">,</span>&nbsp;<span class="ident" id="4648202">err</span>&nbsp;<span class="op" id="4648206">:=</span>&nbsp;<span class="ident" id="4648209">ioutil</span><span class="op" id="4648215">.</span><span class="ident" id="4648216">ReadFile</span><span class="op" id="4648224">(</span><span class="ident" id="4648225">keyFile</span><span class="op" id="4648232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648235">if</span>&nbsp;<span class="ident" id="4648238">err</span>&nbsp;<span class="op" id="4648242">!=</span>&nbsp;<span class="ident" id="4648245">nil</span>&nbsp;<span class="op" id="4648249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648253">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648264">return</span>&nbsp;<span class="ident" id="4648271">X509KeyPair</span><span class="op" id="4648282">(</span><span class="ident" id="4648283">certPEMBlock</span><span class="op" id="4648295">,</span>&nbsp;<span class="ident" id="4648297">keyPEMBlock</span><span class="op" id="4648308">)</span><br>
<span class="lineno">180</span><span class="op" id="4648310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4648313">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4648376">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4648397">func</span>&nbsp;<span class="ident" id="4648402">X509KeyPair</span><span class="op" id="4648413">(</span><span class="ident" id="4648414">certPEMBlock</span><span class="op" id="4648426">,</span>&nbsp;<span class="ident" id="4648428">keyPEMBlock</span>&nbsp;<span class="op" id="4648440">[</span><span class="op" id="4648441">]</span><span class="builtintype" id="4648442">byte</span><span class="op" id="4648446">)</span>&nbsp;<span class="op" id="4648448">(</span><span class="ident" id="4648449">cert</span>&nbsp;<span class="ident" id="4648454">Certificate</span><span class="op" id="4648465">,</span>&nbsp;<span class="ident" id="4648467">err</span>&nbsp;<span class="builtintype" id="4648471">error</span><span class="op" id="4648476">)</span>&nbsp;<span class="op" id="4648478">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648481">var</span>&nbsp;<span class="ident" id="4648485">certDERBlock</span>&nbsp;<span class="op" id="4648498">*</span><span class="ident" id="4648499">pem</span><span class="op" id="4648502">.</span><span class="ident" id="4648503">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648510">for</span>&nbsp;<span class="op" id="4648514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648518">certDERBlock</span><span class="op" id="4648530">,</span>&nbsp;<span class="ident" id="4648532">certPEMBlock</span>&nbsp;<span class="op" id="4648545">=</span>&nbsp;<span class="ident" id="4648547">pem</span><span class="op" id="4648550">.</span><span class="ident" id="4648551">Decode</span><span class="op" id="4648557">(</span><span class="ident" id="4648558">certPEMBlock</span><span class="op" id="4648570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648574">if</span>&nbsp;<span class="ident" id="4648577">certDERBlock</span>&nbsp;<span class="op" id="4648590">==</span>&nbsp;<span class="ident" id="4648593">nil</span>&nbsp;<span class="op" id="4648597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648602">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648614">if</span>&nbsp;<span class="ident" id="4648617">certDERBlock</span><span class="op" id="4648629">.</span><span class="ident" id="4648630">Type</span>&nbsp;<span class="op" id="4648635">==</span>&nbsp;<span class="string" id="4648638">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="4648652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648657">cert</span><span class="op" id="4648661">.</span><span class="ident" id="4648662">Certificate</span>&nbsp;<span class="op" id="4648674">=</span>&nbsp;<span class="builtinfunc" id="4648676">append</span><span class="op" id="4648682">(</span><span class="ident" id="4648683">cert</span><span class="op" id="4648687">.</span><span class="ident" id="4648688">Certificate</span><span class="op" id="4648699">,</span>&nbsp;<span class="ident" id="4648701">certDERBlock</span><span class="op" id="4648713">.</span><span class="ident" id="4648714">Bytes</span><span class="op" id="4648719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648726">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648730">if</span>&nbsp;<span class="builtinfunc" id="4648733">len</span><span class="op" id="4648736">(</span><span class="ident" id="4648737">cert</span><span class="op" id="4648741">.</span><span class="ident" id="4648742">Certificate</span><span class="op" id="4648753">)</span>&nbsp;<span class="op" id="4648755">==</span>&nbsp;<span class="num" id="4648758">0</span>&nbsp;<span class="op" id="4648760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648764">err</span>&nbsp;<span class="op" id="4648768">=</span>&nbsp;<span class="ident" id="4648770">errors</span><span class="op" id="4648776">.</span><span class="ident" id="4648777">New</span><span class="op" id="4648780">(</span><span class="string" id="4648781">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4648831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648835">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648843">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648847">var</span>&nbsp;<span class="ident" id="4648851">keyDERBlock</span>&nbsp;<span class="op" id="4648863">*</span><span class="ident" id="4648864">pem</span><span class="op" id="4648867">.</span><span class="ident" id="4648868">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648875">for</span>&nbsp;<span class="op" id="4648879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648883">keyDERBlock</span><span class="op" id="4648894">,</span>&nbsp;<span class="ident" id="4648896">keyPEMBlock</span>&nbsp;<span class="op" id="4648908">=</span>&nbsp;<span class="ident" id="4648910">pem</span><span class="op" id="4648913">.</span><span class="ident" id="4648914">Decode</span><span class="op" id="4648920">(</span><span class="ident" id="4648921">keyPEMBlock</span><span class="op" id="4648932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648936">if</span>&nbsp;<span class="ident" id="4648939">keyDERBlock</span>&nbsp;<span class="op" id="4648951">==</span>&nbsp;<span class="ident" id="4648954">nil</span>&nbsp;<span class="op" id="4648958">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648963">err</span>&nbsp;<span class="op" id="4648967">=</span>&nbsp;<span class="ident" id="4648969">errors</span><span class="op" id="4648975">.</span><span class="ident" id="4648976">New</span><span class="op" id="4648979">(</span><span class="string" id="4648980">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4649022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649027">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649040">if</span>&nbsp;<span class="ident" id="4649043">keyDERBlock</span><span class="op" id="4649054">.</span><span class="ident" id="4649055">Type</span>&nbsp;<span class="op" id="4649060">==</span>&nbsp;<span class="string" id="4649063">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="4649077">||</span>&nbsp;<span class="ident" id="4649080">strings</span><span class="op" id="4649087">.</span><span class="ident" id="4649088">HasSuffix</span><span class="op" id="4649097">(</span><span class="ident" id="4649098">keyDERBlock</span><span class="op" id="4649109">.</span><span class="ident" id="4649110">Type</span><span class="op" id="4649114">,</span>&nbsp;<span class="string" id="4649116">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="4649130">)</span>&nbsp;<span class="op" id="4649132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649137">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649152">cert</span><span class="op" id="4649156">.</span><span class="ident" id="4649157">PrivateKey</span><span class="op" id="4649167">,</span>&nbsp;<span class="ident" id="4649169">err</span>&nbsp;<span class="op" id="4649173">=</span>&nbsp;<span class="ident" id="4649175">parsePrivateKey</span><span class="op" id="4649190">(</span><span class="ident" id="4649191">keyDERBlock</span><span class="op" id="4649202">.</span><span class="ident" id="4649203">Bytes</span><span class="op" id="4649208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649211">if</span>&nbsp;<span class="ident" id="4649214">err</span>&nbsp;<span class="op" id="4649218">!=</span>&nbsp;<span class="ident" id="4649221">nil</span>&nbsp;<span class="op" id="4649225">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649229">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649241">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649312">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649373">x509Cert</span><span class="op" id="4649381">,</span>&nbsp;<span class="ident" id="4649383">err</span>&nbsp;<span class="op" id="4649387">:=</span>&nbsp;<span class="ident" id="4649390">x509</span><span class="op" id="4649394">.</span><span class="ident" id="4649395">ParseCertificate</span><span class="op" id="4649411">(</span><span class="ident" id="4649412">cert</span><span class="op" id="4649416">.</span><span class="ident" id="4649417">Certificate</span><span class="op" id="4649428">[</span><span class="num" id="4649429">0</span><span class="op" id="4649430">]</span><span class="op" id="4649431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649434">if</span>&nbsp;<span class="ident" id="4649437">err</span>&nbsp;<span class="op" id="4649441">!=</span>&nbsp;<span class="ident" id="4649444">nil</span>&nbsp;<span class="op" id="4649448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649452">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649464">switch</span>&nbsp;<span class="ident" id="4649471">pub</span>&nbsp;<span class="op" id="4649475">:=</span>&nbsp;<span class="ident" id="4649478">x509Cert</span><span class="op" id="4649486">.</span><span class="ident" id="4649487">PublicKey</span><span class="op" id="4649496">.</span><span class="op" id="4649497">(</span><span class="keyword" id="4649498">type</span><span class="op" id="4649502">)</span>&nbsp;<span class="op" id="4649504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649507">case</span>&nbsp;<span class="op" id="4649512">*</span><span class="ident" id="4649513">rsa</span><span class="op" id="4649516">.</span><span class="ident" id="4649517">PublicKey</span><span class="op" id="4649526">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649530">priv</span><span class="op" id="4649534">,</span>&nbsp;<span class="ident" id="4649536">ok</span>&nbsp;<span class="op" id="4649539">:=</span>&nbsp;<span class="ident" id="4649542">cert</span><span class="op" id="4649546">.</span><span class="ident" id="4649547">PrivateKey</span><span class="op" id="4649557">.</span><span class="op" id="4649558">(</span><span class="op" id="4649559">*</span><span class="ident" id="4649560">rsa</span><span class="op" id="4649563">.</span><span class="ident" id="4649564">PrivateKey</span><span class="op" id="4649574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649578">if</span>&nbsp;<span class="op" id="4649581">!</span><span class="ident" id="4649582">ok</span>&nbsp;<span class="op" id="4649585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649590">err</span>&nbsp;<span class="op" id="4649594">=</span>&nbsp;<span class="ident" id="4649596">errors</span><span class="op" id="4649602">.</span><span class="ident" id="4649603">New</span><span class="op" id="4649606">(</span><span class="string" id="4649607">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4649668">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649673">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649686">if</span>&nbsp;<span class="ident" id="4649689">pub</span><span class="op" id="4649692">.</span><span class="ident" id="4649693">N</span><span class="op" id="4649694">.</span><span class="ident" id="4649695">Cmp</span><span class="op" id="4649698">(</span><span class="ident" id="4649699">priv</span><span class="op" id="4649703">.</span><span class="ident" id="4649704">N</span><span class="op" id="4649705">)</span>&nbsp;<span class="op" id="4649707">!=</span>&nbsp;<span class="num" id="4649710">0</span>&nbsp;<span class="op" id="4649712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649717">err</span>&nbsp;<span class="op" id="4649721">=</span>&nbsp;<span class="ident" id="4649723">errors</span><span class="op" id="4649729">.</span><span class="ident" id="4649730">New</span><span class="op" id="4649733">(</span><span class="string" id="4649734">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4649785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649790">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649802">case</span>&nbsp;<span class="op" id="4649807">*</span><span class="ident" id="4649808">ecdsa</span><span class="op" id="4649813">.</span><span class="ident" id="4649814">PublicKey</span><span class="op" id="4649823">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649827">priv</span><span class="op" id="4649831">,</span>&nbsp;<span class="ident" id="4649833">ok</span>&nbsp;<span class="op" id="4649836">:=</span>&nbsp;<span class="ident" id="4649839">cert</span><span class="op" id="4649843">.</span><span class="ident" id="4649844">PrivateKey</span><span class="op" id="4649854">.</span><span class="op" id="4649855">(</span><span class="op" id="4649856">*</span><span class="ident" id="4649857">ecdsa</span><span class="op" id="4649862">.</span><span class="ident" id="4649863">PrivateKey</span><span class="op" id="4649873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649877">if</span>&nbsp;<span class="op" id="4649880">!</span><span class="ident" id="4649881">ok</span>&nbsp;<span class="op" id="4649884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649889">err</span>&nbsp;<span class="op" id="4649893">=</span>&nbsp;<span class="ident" id="4649895">errors</span><span class="op" id="4649901">.</span><span class="ident" id="4649902">New</span><span class="op" id="4649905">(</span><span class="string" id="4649906">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4649967">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649972">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649986">if</span>&nbsp;<span class="ident" id="4649989">pub</span><span class="op" id="4649992">.</span><span class="ident" id="4649993">X</span><span class="op" id="4649994">.</span><span class="ident" id="4649995">Cmp</span><span class="op" id="4649998">(</span><span class="ident" id="4649999">priv</span><span class="op" id="4650003">.</span><span class="ident" id="4650004">X</span><span class="op" id="4650005">)</span>&nbsp;<span class="op" id="4650007">!=</span>&nbsp;<span class="num" id="4650010">0</span>&nbsp;<span class="op" id="4650012">||</span>&nbsp;<span class="ident" id="4650015">pub</span><span class="op" id="4650018">.</span><span class="ident" id="4650019">Y</span><span class="op" id="4650020">.</span><span class="ident" id="4650021">Cmp</span><span class="op" id="4650024">(</span><span class="ident" id="4650025">priv</span><span class="op" id="4650029">.</span><span class="ident" id="4650030">Y</span><span class="op" id="4650031">)</span>&nbsp;<span class="op" id="4650033">!=</span>&nbsp;<span class="num" id="4650036">0</span>&nbsp;<span class="op" id="4650038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4650043">err</span>&nbsp;<span class="op" id="4650047">=</span>&nbsp;<span class="ident" id="4650049">errors</span><span class="op" id="4650055">.</span><span class="ident" id="4650056">New</span><span class="op" id="4650059">(</span><span class="string" id="4650060">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4650111">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650116">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650128">default</span><span class="op" id="4650135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4650139">err</span>&nbsp;<span class="op" id="4650143">=</span>&nbsp;<span class="ident" id="4650145">errors</span><span class="op" id="4650151">.</span><span class="ident" id="4650152">New</span><span class="op" id="4650155">(</span><span class="string" id="4650156">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="4650198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650202">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650214">return</span><br>
<span class="lineno"></span><span class="op" id="4650221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="4650224">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="4650301">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4650379">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="4650458">func</span>&nbsp;<span class="ident" id="4650463">parsePrivateKey</span><span class="op" id="4650478">(</span><span class="ident" id="4650479">der</span>&nbsp;<span class="op" id="4650483">[</span><span class="op" id="4650484">]</span><span class="builtintype" id="4650485">byte</span><span class="op" id="4650489">)</span>&nbsp;<span class="op" id="4650491">(</span><span class="ident" id="4650492">crypto</span><span class="op" id="4650498">.</span><span class="ident" id="4650499">PrivateKey</span><span class="op" id="4650509">,</span>&nbsp;<span class="builtintype" id="4650511">error</span><span class="op" id="4650516">)</span>&nbsp;<span class="op" id="4650518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650521">if</span>&nbsp;<span class="ident" id="4650524">key</span><span class="op" id="4650527">,</span>&nbsp;<span class="ident" id="4650529">err</span>&nbsp;<span class="op" id="4650533">:=</span>&nbsp;<span class="ident" id="4650536">x509</span><span class="op" id="4650540">.</span><span class="ident" id="4650541">ParsePKCS1PrivateKey</span><span class="op" id="4650561">(</span><span class="ident" id="4650562">der</span><span class="op" id="4650565">)</span><span class="op" id="4650566">;</span>&nbsp;<span class="ident" id="4650568">err</span>&nbsp;<span class="op" id="4650572">==</span>&nbsp;<span class="ident" id="4650575">nil</span>&nbsp;<span class="op" id="4650579">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650583">return</span>&nbsp;<span class="ident" id="4650590">key</span><span class="op" id="4650593">,</span>&nbsp;<span class="ident" id="4650595">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650603">if</span>&nbsp;<span class="ident" id="4650606">key</span><span class="op" id="4650609">,</span>&nbsp;<span class="ident" id="4650611">err</span>&nbsp;<span class="op" id="4650615">:=</span>&nbsp;<span class="ident" id="4650618">x509</span><span class="op" id="4650622">.</span><span class="ident" id="4650623">ParsePKCS8PrivateKey</span><span class="op" id="4650643">(</span><span class="ident" id="4650644">der</span><span class="op" id="4650647">)</span><span class="op" id="4650648">;</span>&nbsp;<span class="ident" id="4650650">err</span>&nbsp;<span class="op" id="4650654">==</span>&nbsp;<span class="ident" id="4650657">nil</span>&nbsp;<span class="op" id="4650661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650665">switch</span>&nbsp;<span class="ident" id="4650672">key</span>&nbsp;<span class="op" id="4650676">:=</span>&nbsp;<span class="ident" id="4650679">key</span><span class="op" id="4650682">.</span><span class="op" id="4650683">(</span><span class="keyword" id="4650684">type</span><span class="op" id="4650688">)</span>&nbsp;<span class="op" id="4650690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650694">case</span>&nbsp;<span class="op" id="4650699">*</span><span class="ident" id="4650700">rsa</span><span class="op" id="4650703">.</span><span class="ident" id="4650704">PrivateKey</span><span class="op" id="4650714">,</span>&nbsp;<span class="op" id="4650716">*</span><span class="ident" id="4650717">ecdsa</span><span class="op" id="4650722">.</span><span class="ident" id="4650723">PrivateKey</span><span class="op" id="4650733">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650738">return</span>&nbsp;<span class="ident" id="4650745">key</span><span class="op" id="4650748">,</span>&nbsp;<span class="ident" id="4650750">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650756">default</span><span class="op" id="4650763">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650768">return</span>&nbsp;<span class="ident" id="4650775">nil</span><span class="op" id="4650778">,</span>&nbsp;<span class="ident" id="4650780">errors</span><span class="op" id="4650786">.</span><span class="ident" id="4650787">New</span><span class="op" id="4650790">(</span><span class="string" id="4650791">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="4650854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650861">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650864">if</span>&nbsp;<span class="ident" id="4650867">key</span><span class="op" id="4650870">,</span>&nbsp;<span class="ident" id="4650872">err</span>&nbsp;<span class="op" id="4650876">:=</span>&nbsp;<span class="ident" id="4650879">x509</span><span class="op" id="4650883">.</span><span class="ident" id="4650884">ParseECPrivateKey</span><span class="op" id="4650901">(</span><span class="ident" id="4650902">der</span><span class="op" id="4650905">)</span><span class="op" id="4650906">;</span>&nbsp;<span class="ident" id="4650908">err</span>&nbsp;<span class="op" id="4650912">==</span>&nbsp;<span class="ident" id="4650915">nil</span>&nbsp;<span class="op" id="4650919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650923">return</span>&nbsp;<span class="ident" id="4650930">key</span><span class="op" id="4650933">,</span>&nbsp;<span class="ident" id="4650935">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650944">return</span>&nbsp;<span class="ident" id="4650951">nil</span><span class="op" id="4650954">,</span>&nbsp;<span class="ident" id="4650956">errors</span><span class="op" id="4650962">.</span><span class="ident" id="4650963">New</span><span class="op" id="4650966">(</span><span class="string" id="4650967">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="4651008">)</span><br>
<span class="lineno">275</span><span class="op" id="4651010">}</span>
</div>
</body>
</html>
