<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html" class="current">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4461479">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4461534">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4461588">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4461639">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4461685">package</span>&nbsp;<span class="ident" id="4461693">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4461698">import</span>&nbsp;<span class="op" id="4461705">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461708">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461717">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461734">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461751">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461766">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461776">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461783">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461789">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461796">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4461804">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4461811">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4461814">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4461857">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4461898">type</span>&nbsp;<span class="ident" id="4461903">Conn</span>&nbsp;<span class="keyword" id="4461908">struct</span>&nbsp;<span class="op" id="4461915">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4461918">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461931">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461940"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4461943">.</span><span class="ident" id="4461944"><a href="/gostd/net/net.go.html#3334417">Conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461950">isClient</span>&nbsp;<span class="builtintype" id="4461959">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4461966">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462024">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462042"><a href="/gostd/crypto/tls/conn.go.html#4461796">sync</a></span><span class="op" id="4462046">.</span><span class="ident" id="4462047"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span>&nbsp;<span class="comment" id="4462053">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462104">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4462122">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462133">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462168">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4462186">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462197">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462213">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4462231">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462242">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462274">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4462292">*</span><span class="ident" id="4462293"><a href="/gostd/crypto/tls/common.go.html#4450481">Config</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462303">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462343">handshakeComplete</span>&nbsp;<span class="builtintype" id="4462361">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462367">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4462385">bool</span>&nbsp;<span class="comment" id="4462390">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462443">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4462461">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462469">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4462487">[</span><span class="op" id="4462488">]</span><span class="builtintype" id="4462489">byte</span>&nbsp;<span class="comment" id="4462494">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462520">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4462538">[</span><span class="op" id="4462539">]</span><span class="op" id="4462540">*</span><span class="ident" id="4462541"><a href="/gostd/crypto/tls/conn.go.html#4461751">x509</a></span><span class="op" id="4462545">.</span><span class="ident" id="4462546"><a href="/gostd/crypto/x509/x509.go.html#4659766">Certificate</a></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462559">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462628">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462677">verifiedChains</span>&nbsp;<span class="op" id="4462692">[</span><span class="op" id="4462693">]</span><span class="op" id="4462694">[</span><span class="op" id="4462695">]</span><span class="op" id="4462696">*</span><span class="ident" id="4462697"><a href="/gostd/crypto/tls/conn.go.html#4461751">x509</a></span><span class="op" id="4462701">.</span><span class="ident" id="4462702"><a href="/gostd/crypto/x509/x509.go.html#4659766">Certificate</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462715">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462788">serverName</span>&nbsp;<span class="builtintype" id="4462799">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462807">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462874">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462937">firstFinished</span>&nbsp;<span class="op" id="4462951">[</span><span class="num" id="4462952">12</span><span class="op" id="4462954">]</span><span class="builtintype" id="4462955">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462962">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4462985">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462993">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4463016">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463023">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463040">in</span><span class="op" id="4463042">,</span>&nbsp;<span class="ident" id="4463044">out</span>&nbsp;&nbsp;<span class="ident" id="4463049"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463062">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463087">rawInput</span>&nbsp;<span class="op" id="4463096">*</span><span class="ident" id="4463097"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463109">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463143">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463152">*</span><span class="ident" id="4463153"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463165">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463205">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463214"><a href="/gostd/crypto/tls/conn.go.html#4461708">bytes</a></span><span class="op" id="4463219">.</span><span class="ident" id="4463220"><a href="/gostd/bytes/buffer.go.html#1383251">Buffer</a></span>&nbsp;<span class="comment" id="4463227">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463266">tmp</span>&nbsp;<span class="op" id="4463270">[</span><span class="num" id="4463271">16</span><span class="op" id="4463273">]</span><span class="builtintype" id="4463274">byte</span><br>
<span class="lineno"></span><span class="op" id="4463279">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4463282">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4463313">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4463362">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4463395">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4463443">func</span>&nbsp;<span class="op" id="4463448">(</span><span class="ident" id="4463449">c</span>&nbsp;<span class="op" id="4463451">*</span><span class="ident" id="4463452"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4463456">)</span>&nbsp;<span class="ident" id="4463458">LocalAddr</span><span class="op" id="4463467">(</span><span class="op" id="4463468">)</span>&nbsp;<span class="ident" id="4463470"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4463473">.</span><span class="ident" id="4463474"><a href="/gostd/net/net.go.html#3334179">Addr</a></span>&nbsp;<span class="op" id="4463479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463482">return</span>&nbsp;<span class="ident" id="4463489"><a href="/gostd/crypto/tls/conn.go.html#4463449">c</a></span><span class="op" id="4463490">.</span><span class="ident" id="4463491"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4463495">.</span><span class="ident" id="4463496"><a href="/gostd/net/net.go.html#3335052">LocalAddr</a></span><span class="op" id="4463505">(</span><span class="op" id="4463506">)</span><br>
<span class="lineno"></span><span class="op" id="4463508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4463511">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4463561">func</span>&nbsp;<span class="op" id="4463566">(</span><span class="ident" id="4463567">c</span>&nbsp;<span class="op" id="4463569">*</span><span class="ident" id="4463570"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4463574">)</span>&nbsp;<span class="ident" id="4463576">RemoteAddr</span><span class="op" id="4463586">(</span><span class="op" id="4463587">)</span>&nbsp;<span class="ident" id="4463589"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4463592">.</span><span class="ident" id="4463593"><a href="/gostd/net/net.go.html#3334179">Addr</a></span>&nbsp;<span class="op" id="4463598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463601">return</span>&nbsp;<span class="ident" id="4463608"><a href="/gostd/crypto/tls/conn.go.html#4463567">c</a></span><span class="op" id="4463609">.</span><span class="ident" id="4463610"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4463614">.</span><span class="ident" id="4463615"><a href="/gostd/net/net.go.html#3335122">RemoteAddr</a></span><span class="op" id="4463625">(</span><span class="op" id="4463626">)</span><br>
<span class="lineno"></span><span class="op" id="4463628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4463631">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4463712">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4463774">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4463881">func</span>&nbsp;<span class="op" id="4463886">(</span><span class="ident" id="4463887">c</span>&nbsp;<span class="op" id="4463889">*</span><span class="ident" id="4463890"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4463894">)</span>&nbsp;<span class="ident" id="4463896">SetDeadline</span><span class="op" id="4463907">(</span><span class="ident" id="4463908">t</span>&nbsp;<span class="ident" id="4463910"><a href="/gostd/crypto/tls/conn.go.html#4461804">time</a></span><span class="op" id="4463914">.</span><span class="ident" id="4463915"><a href="/gostd/time/time.go.html#2722087">Time</a></span><span class="op" id="4463919">)</span>&nbsp;<span class="builtintype" id="4463921">error</span>&nbsp;<span class="op" id="4463927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463930">return</span>&nbsp;<span class="ident" id="4463937"><a href="/gostd/crypto/tls/conn.go.html#4463887">c</a></span><span class="op" id="4463938">.</span><span class="ident" id="4463939"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4463943">.</span><span class="ident" id="4463944"><a href="/gostd/net/net.go.html#3335726">SetDeadline</a></span><span class="op" id="4463955">(</span><span class="ident" id="4463956"><a href="/gostd/crypto/tls/conn.go.html#4463908">t</a></span><span class="op" id="4463957">)</span><br>
<span class="lineno">80</span><span class="op" id="4463959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4463962">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4464034">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4464086">func</span>&nbsp;<span class="op" id="4464091">(</span><span class="ident" id="4464092">c</span>&nbsp;<span class="op" id="4464094">*</span><span class="ident" id="4464095"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4464099">)</span>&nbsp;<span class="ident" id="4464101">SetReadDeadline</span><span class="op" id="4464116">(</span><span class="ident" id="4464117">t</span>&nbsp;<span class="ident" id="4464119"><a href="/gostd/crypto/tls/conn.go.html#4461804">time</a></span><span class="op" id="4464123">.</span><span class="ident" id="4464124"><a href="/gostd/time/time.go.html#2722087">Time</a></span><span class="op" id="4464128">)</span>&nbsp;<span class="builtintype" id="4464130">error</span>&nbsp;<span class="op" id="4464136">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4464139">return</span>&nbsp;<span class="ident" id="4464146"><a href="/gostd/crypto/tls/conn.go.html#4464092">c</a></span><span class="op" id="4464147">.</span><span class="ident" id="4464148"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4464152">.</span><span class="ident" id="4464153"><a href="/gostd/net/net.go.html#3335873">SetReadDeadline</a></span><span class="op" id="4464168">(</span><span class="ident" id="4464169"><a href="/gostd/crypto/tls/conn.go.html#4464117">t</a></span><span class="op" id="4464170">)</span><br>
<span class="lineno"></span><span class="op" id="4464172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4464175">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4464249">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4464302">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4464409">func</span>&nbsp;<span class="op" id="4464414">(</span><span class="ident" id="4464415">c</span>&nbsp;<span class="op" id="4464417">*</span><span class="ident" id="4464418"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4464422">)</span>&nbsp;<span class="ident" id="4464424">SetWriteDeadline</span><span class="op" id="4464440">(</span><span class="ident" id="4464441">t</span>&nbsp;<span class="ident" id="4464443"><a href="/gostd/crypto/tls/conn.go.html#4461804">time</a></span><span class="op" id="4464447">.</span><span class="ident" id="4464448"><a href="/gostd/time/time.go.html#2722087">Time</a></span><span class="op" id="4464452">)</span>&nbsp;<span class="builtintype" id="4464454">error</span>&nbsp;<span class="op" id="4464460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4464463">return</span>&nbsp;<span class="ident" id="4464470"><a href="/gostd/crypto/tls/conn.go.html#4464415">c</a></span><span class="op" id="4464471">.</span><span class="ident" id="4464472"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4464476">.</span><span class="ident" id="4464477"><a href="/gostd/net/net.go.html#3336140">SetWriteDeadline</a></span><span class="op" id="4464493">(</span><span class="ident" id="4464494"><a href="/gostd/crypto/tls/conn.go.html#4464441">t</a></span><span class="op" id="4464495">)</span><br>
<span class="lineno"></span><span class="op" id="4464497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4464500">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4464559">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4464603">type</span>&nbsp;<span class="ident" id="4464608">halfConn</span>&nbsp;<span class="keyword" id="4464617">struct</span>&nbsp;<span class="op" id="4464624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464627"><a href="/gostd/crypto/tls/conn.go.html#4461796">sync</a></span><span class="op" id="4464631">.</span><span class="ident" id="4464632"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464640">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4464648">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4464660">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464686">version</span>&nbsp;<span class="builtintype" id="4464694">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4464706">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464727">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4464735">interface</span><span class="op" id="4464744">{</span><span class="op" id="4464745">}</span>&nbsp;<span class="comment" id="4464747">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464768">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464776"><a href="/gostd/crypto/tls/cipher_suites.go.html#4437372">macFunction</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464789">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464797">[</span><span class="num" id="4464798">8</span><span class="op" id="4464799">]</span><span class="builtintype" id="4464800">byte</span>&nbsp;<span class="comment" id="4464805">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464832">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4464840">*</span><span class="ident" id="4464841"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span>&nbsp;&nbsp;<span class="comment" id="4464848">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464873">nextCipher</span>&nbsp;<span class="keyword" id="4464884">interface</span><span class="op" id="4464893">{</span><span class="op" id="4464894">}</span>&nbsp;<span class="comment" id="4464896">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464922">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464933"><a href="/gostd/crypto/tls/cipher_suites.go.html#4437372">macFunction</a></span>&nbsp;<span class="comment" id="4464945">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4464969">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465024">inDigestBuf</span><span class="op" id="4465035">,</span>&nbsp;<span class="ident" id="4465037">outDigestBuf</span>&nbsp;<span class="op" id="4465050">[</span><span class="op" id="4465051">]</span><span class="builtintype" id="4465052">byte</span><br>
<span class="lineno"></span><span class="op" id="4465057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4465060">func</span>&nbsp;<span class="op" id="4465065">(</span><span class="ident" id="4465066">hc</span>&nbsp;<span class="op" id="4465069">*</span><span class="ident" id="4465070"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4465078">)</span>&nbsp;<span class="ident" id="4465080">setErrorLocked</span><span class="op" id="4465094">(</span><span class="ident" id="4465095">err</span>&nbsp;<span class="builtintype" id="4465099">error</span><span class="op" id="4465104">)</span>&nbsp;<span class="builtintype" id="4465106">error</span>&nbsp;<span class="op" id="4465112">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465115"><a href="/gostd/crypto/tls/conn.go.html#4465066">hc</a></span><span class="op" id="4465117">.</span><span class="ident" id="4465118"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span>&nbsp;<span class="op" id="4465122">=</span>&nbsp;<span class="ident" id="4465124"><a href="/gostd/crypto/tls/conn.go.html#4465095">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465129">return</span>&nbsp;<span class="ident" id="4465136"><a href="/gostd/crypto/tls/conn.go.html#4465095">err</a></span><br>
<span class="lineno"></span><span class="op" id="4465140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4465143">func</span>&nbsp;<span class="op" id="4465148">(</span><span class="ident" id="4465149">hc</span>&nbsp;<span class="op" id="4465152">*</span><span class="ident" id="4465153"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4465161">)</span>&nbsp;<span class="builtintype" id="4465163">error</span><span class="op" id="4465168">(</span><span class="op" id="4465169">)</span>&nbsp;<span class="builtintype" id="4465171">error</span>&nbsp;<span class="op" id="4465177">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465180"><a href="/gostd/crypto/tls/conn.go.html#4465149">hc</a></span><span class="op" id="4465182">.</span><span class="ident" id="4465183"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4465187">(</span><span class="op" id="4465188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465191">err</span>&nbsp;<span class="op" id="4465195">:=</span>&nbsp;<span class="ident" id="4465198"><a href="/gostd/crypto/tls/conn.go.html#4465149">hc</a></span><span class="op" id="4465200">.</span><span class="ident" id="4465201"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465206"><a href="/gostd/crypto/tls/conn.go.html#4465149">hc</a></span><span class="op" id="4465208">.</span><span class="ident" id="4465209"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4465215">(</span><span class="op" id="4465216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465219">return</span>&nbsp;<span class="ident" id="4465226"><a href="/gostd/crypto/tls/conn.go.html#4465191">err</a></span><br>
<span class="lineno"></span><span class="op" id="4465230">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4465233">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4465289">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4465337">func</span>&nbsp;<span class="op" id="4465342">(</span><span class="ident" id="4465343">hc</span>&nbsp;<span class="op" id="4465346">*</span><span class="ident" id="4465347"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4465355">)</span>&nbsp;<span class="ident" id="4465357">prepareCipherSpec</span><span class="op" id="4465374">(</span><span class="ident" id="4465375">version</span>&nbsp;<span class="builtintype" id="4465383">uint16</span><span class="op" id="4465389">,</span>&nbsp;<span class="ident" id="4465391">cipher</span>&nbsp;<span class="keyword" id="4465398">interface</span><span class="op" id="4465407">{</span><span class="op" id="4465408">}</span><span class="op" id="4465409">,</span>&nbsp;<span class="ident" id="4465411">mac</span>&nbsp;<span class="ident" id="4465415"><a href="/gostd/crypto/tls/cipher_suites.go.html#4437372">macFunction</a></span><span class="op" id="4465426">)</span>&nbsp;<span class="op" id="4465428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465431"><a href="/gostd/crypto/tls/conn.go.html#4465343">hc</a></span><span class="op" id="4465433">.</span><span class="ident" id="4465434"><a href="/gostd/crypto/tls/conn.go.html#4464686">version</a></span>&nbsp;<span class="op" id="4465442">=</span>&nbsp;<span class="ident" id="4465444"><a href="/gostd/crypto/tls/conn.go.html#4465375">version</a></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465453"><a href="/gostd/crypto/tls/conn.go.html#4465343">hc</a></span><span class="op" id="4465455">.</span><span class="ident" id="4465456"><a href="/gostd/crypto/tls/conn.go.html#4464873">nextCipher</a></span>&nbsp;<span class="op" id="4465467">=</span>&nbsp;<span class="ident" id="4465469"><a href="/gostd/crypto/tls/conn.go.html#4465391">cipher</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465477"><a href="/gostd/crypto/tls/conn.go.html#4465343">hc</a></span><span class="op" id="4465479">.</span><span class="ident" id="4465480"><a href="/gostd/crypto/tls/conn.go.html#4464922">nextMac</a></span>&nbsp;<span class="op" id="4465488">=</span>&nbsp;<span class="ident" id="4465490"><a href="/gostd/crypto/tls/conn.go.html#4465411">mac</a></span><br>
<span class="lineno"></span><span class="op" id="4465494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4465497">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4465555">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4465610">func</span>&nbsp;<span class="op" id="4465615">(</span><span class="ident" id="4465616">hc</span>&nbsp;<span class="op" id="4465619">*</span><span class="ident" id="4465620"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4465628">)</span>&nbsp;<span class="ident" id="4465630">changeCipherSpec</span><span class="op" id="4465646">(</span><span class="op" id="4465647">)</span>&nbsp;<span class="builtintype" id="4465649">error</span>&nbsp;<span class="op" id="4465655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465658">if</span>&nbsp;<span class="ident" id="4465661"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465663">.</span><span class="ident" id="4465664"><a href="/gostd/crypto/tls/conn.go.html#4464873">nextCipher</a></span>&nbsp;<span class="op" id="4465675">==</span>&nbsp;<span class="builtintype" id="4465678">nil</span>&nbsp;<span class="op" id="4465682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465686">return</span>&nbsp;<span class="ident" id="4465693"><a href="/gostd/crypto/tls/alert.go.html#4431016">alertInternalError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4465713">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465716"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465718">.</span><span class="ident" id="4465719"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span>&nbsp;<span class="op" id="4465726">=</span>&nbsp;<span class="ident" id="4465728"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465730">.</span><span class="ident" id="4465731"><a href="/gostd/crypto/tls/conn.go.html#4464873">nextCipher</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465743"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465745">.</span><span class="ident" id="4465746"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span>&nbsp;<span class="op" id="4465750">=</span>&nbsp;<span class="ident" id="4465752"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465754">.</span><span class="ident" id="4465755"><a href="/gostd/crypto/tls/conn.go.html#4464922">nextMac</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465764"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465766">.</span><span class="ident" id="4465767"><a href="/gostd/crypto/tls/conn.go.html#4464873">nextCipher</a></span>&nbsp;<span class="op" id="4465778">=</span>&nbsp;<span class="builtintype" id="4465780">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465785"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465787">.</span><span class="ident" id="4465788"><a href="/gostd/crypto/tls/conn.go.html#4464922">nextMac</a></span>&nbsp;<span class="op" id="4465796">=</span>&nbsp;<span class="builtintype" id="4465798">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465803">for</span>&nbsp;<span class="ident" id="4465807">i</span>&nbsp;<span class="op" id="4465809">:=</span>&nbsp;<span class="keyword" id="4465812">range</span>&nbsp;<span class="ident" id="4465818"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465820">.</span><span class="ident" id="4465821"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span>&nbsp;<span class="op" id="4465825">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465829"><a href="/gostd/crypto/tls/conn.go.html#4465616">hc</a></span><span class="op" id="4465831">.</span><span class="ident" id="4465832"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4465835">[</span><span class="ident" id="4465836"><a href="/gostd/crypto/tls/conn.go.html#4465807">i</a></span><span class="op" id="4465837">]</span>&nbsp;<span class="op" id="4465839">=</span>&nbsp;<span class="num" id="4465841">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4465844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465847">return</span>&nbsp;<span class="builtintype" id="4465854">nil</span><br>
<span class="lineno"></span><span class="op" id="4465858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4465861">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4465903">func</span>&nbsp;<span class="op" id="4465908">(</span><span class="ident" id="4465909">hc</span>&nbsp;<span class="op" id="4465912">*</span><span class="ident" id="4465913"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4465921">)</span>&nbsp;<span class="ident" id="4465923">incSeq</span><span class="op" id="4465929">(</span><span class="op" id="4465930">)</span>&nbsp;<span class="op" id="4465932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465935">for</span>&nbsp;<span class="ident" id="4465939">i</span>&nbsp;<span class="op" id="4465941">:=</span>&nbsp;<span class="num" id="4465944">7</span><span class="op" id="4465945">;</span>&nbsp;<span class="ident" id="4465947"><a href="/gostd/crypto/tls/conn.go.html#4465939">i</a></span>&nbsp;<span class="op" id="4465949">&gt;=</span>&nbsp;<span class="num" id="4465952">0</span><span class="op" id="4465953">;</span>&nbsp;<span class="ident" id="4465955"><a href="/gostd/crypto/tls/conn.go.html#4465939">i</a></span><span class="op" id="4465956">--</span>&nbsp;<span class="op" id="4465959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465963"><a href="/gostd/crypto/tls/conn.go.html#4465909">hc</a></span><span class="op" id="4465965">.</span><span class="ident" id="4465966"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4465969">[</span><span class="ident" id="4465970"><a href="/gostd/crypto/tls/conn.go.html#4465939">i</a></span><span class="op" id="4465971">]</span><span class="op" id="4465972">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465977">if</span>&nbsp;<span class="ident" id="4465980"><a href="/gostd/crypto/tls/conn.go.html#4465909">hc</a></span><span class="op" id="4465982">.</span><span class="ident" id="4465983"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4465986">[</span><span class="ident" id="4465987"><a href="/gostd/crypto/tls/conn.go.html#4465939">i</a></span><span class="op" id="4465988">]</span>&nbsp;<span class="op" id="4465990">!=</span>&nbsp;<span class="num" id="4465993">0</span>&nbsp;<span class="op" id="4465995">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466000">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4466016">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4466061">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4466107">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4466140">panic</span><span class="op" id="4466145">(</span><span class="string" id="4466146">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4466179">)</span><br>
<span class="lineno"></span><span class="op" id="4466181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4466184">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4466232">func</span>&nbsp;<span class="op" id="4466237">(</span><span class="ident" id="4466238">hc</span>&nbsp;<span class="op" id="4466241">*</span><span class="ident" id="4466242"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4466250">)</span>&nbsp;<span class="ident" id="4466252">resetSeq</span><span class="op" id="4466260">(</span><span class="op" id="4466261">)</span>&nbsp;<span class="op" id="4466263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466266">for</span>&nbsp;<span class="ident" id="4466270">i</span>&nbsp;<span class="op" id="4466272">:=</span>&nbsp;<span class="keyword" id="4466275">range</span>&nbsp;<span class="ident" id="4466281"><a href="/gostd/crypto/tls/conn.go.html#4466238">hc</a></span><span class="op" id="4466283">.</span><span class="ident" id="4466284"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span>&nbsp;<span class="op" id="4466288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466292"><a href="/gostd/crypto/tls/conn.go.html#4466238">hc</a></span><span class="op" id="4466294">.</span><span class="ident" id="4466295"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4466298">[</span><span class="ident" id="4466299"><a href="/gostd/crypto/tls/conn.go.html#4466270">i</a></span><span class="op" id="4466300">]</span>&nbsp;<span class="op" id="4466302">=</span>&nbsp;<span class="num" id="4466304">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466307">}</span><br>
<span class="lineno">170</span><span class="op" id="4466309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4466312">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4466392">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4466469">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4466529">func</span>&nbsp;<span class="ident" id="4466534">removePadding</span><span class="op" id="4466547">(</span><span class="ident" id="4466548">payload</span>&nbsp;<span class="op" id="4466556">[</span><span class="op" id="4466557">]</span><span class="builtintype" id="4466558">byte</span><span class="op" id="4466562">)</span>&nbsp;<span class="op" id="4466564">(</span><span class="op" id="4466565">[</span><span class="op" id="4466566">]</span><span class="builtintype" id="4466567">byte</span><span class="op" id="4466571">,</span>&nbsp;<span class="builtintype" id="4466573">byte</span><span class="op" id="4466577">)</span>&nbsp;<span class="op" id="4466579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466582">if</span>&nbsp;<span class="builtinfunc" id="4466585">len</span><span class="op" id="4466588">(</span><span class="ident" id="4466589"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466596">)</span>&nbsp;<span class="op" id="4466598">&lt;</span>&nbsp;<span class="num" id="4466600">1</span>&nbsp;<span class="op" id="4466602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466606">return</span>&nbsp;<span class="ident" id="4466613"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466620">,</span>&nbsp;<span class="num" id="4466622">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466629">paddingLen</span>&nbsp;<span class="op" id="4466640">:=</span>&nbsp;<span class="ident" id="4466643"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466650">[</span><span class="builtinfunc" id="4466651">len</span><span class="op" id="4466654">(</span><span class="ident" id="4466655"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466662">)</span><span class="op" id="4466663">-</span><span class="num" id="4466664">1</span><span class="op" id="4466665">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466668">t</span>&nbsp;<span class="op" id="4466670">:=</span>&nbsp;<span class="builtintype" id="4466673">uint</span><span class="op" id="4466677">(</span><span class="builtinfunc" id="4466678">len</span><span class="op" id="4466681">(</span><span class="ident" id="4466682"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466689">)</span><span class="op" id="4466690">-</span><span class="num" id="4466691">1</span><span class="op" id="4466692">)</span>&nbsp;<span class="op" id="4466694">-</span>&nbsp;<span class="builtintype" id="4466696">uint</span><span class="op" id="4466700">(</span><span class="ident" id="4466701"><a href="/gostd/crypto/tls/conn.go.html#4466629">paddingLen</a></span><span class="op" id="4466711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4466714">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466780">good</span>&nbsp;<span class="op" id="4466785">:=</span>&nbsp;<span class="builtintype" id="4466788">byte</span><span class="op" id="4466792">(</span><span class="builtintype" id="4466793">int32</span><span class="op" id="4466798">(</span><span class="op" id="4466799">^</span><span class="ident" id="4466800"><a href="/gostd/crypto/tls/conn.go.html#4466668">t</a></span><span class="op" id="4466801">)</span>&nbsp;<span class="op" id="4466803">&gt;&gt;</span>&nbsp;<span class="num" id="4466806">31</span><span class="op" id="4466808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466812">toCheck</span>&nbsp;<span class="op" id="4466820">:=</span>&nbsp;<span class="num" id="4466823">255</span>&nbsp;<span class="comment" id="4466827">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4466867">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466937">if</span>&nbsp;<span class="ident" id="4466940"><a href="/gostd/crypto/tls/conn.go.html#4466812">toCheck</a></span><span class="op" id="4466947">+</span><span class="num" id="4466948">1</span>&nbsp;<span class="op" id="4466950">&gt;</span>&nbsp;<span class="builtinfunc" id="4466952">len</span><span class="op" id="4466955">(</span><span class="ident" id="4466956"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466963">)</span>&nbsp;<span class="op" id="4466965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466969"><a href="/gostd/crypto/tls/conn.go.html#4466812">toCheck</a></span>&nbsp;<span class="op" id="4466977">=</span>&nbsp;<span class="builtinfunc" id="4466979">len</span><span class="op" id="4466982">(</span><span class="ident" id="4466983"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4466990">)</span>&nbsp;<span class="op" id="4466992">-</span>&nbsp;<span class="num" id="4466994">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466997">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467001">for</span>&nbsp;<span class="ident" id="4467005">i</span>&nbsp;<span class="op" id="4467007">:=</span>&nbsp;<span class="num" id="4467010">0</span><span class="op" id="4467011">;</span>&nbsp;<span class="ident" id="4467013"><a href="/gostd/crypto/tls/conn.go.html#4467005">i</a></span>&nbsp;<span class="op" id="4467015">&lt;</span>&nbsp;<span class="ident" id="4467017"><a href="/gostd/crypto/tls/conn.go.html#4466812">toCheck</a></span><span class="op" id="4467024">;</span>&nbsp;<span class="ident" id="4467026"><a href="/gostd/crypto/tls/conn.go.html#4467005">i</a></span><span class="op" id="4467027">++</span>&nbsp;<span class="op" id="4467030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467034">t</span>&nbsp;<span class="op" id="4467036">:=</span>&nbsp;<span class="builtintype" id="4467039">uint</span><span class="op" id="4467043">(</span><span class="ident" id="4467044"><a href="/gostd/crypto/tls/conn.go.html#4466629">paddingLen</a></span><span class="op" id="4467054">)</span>&nbsp;<span class="op" id="4467056">-</span>&nbsp;<span class="builtintype" id="4467058">uint</span><span class="op" id="4467062">(</span><span class="ident" id="4467063"><a href="/gostd/crypto/tls/conn.go.html#4467005">i</a></span><span class="op" id="4467064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4467068">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467118">mask</span>&nbsp;<span class="op" id="4467123">:=</span>&nbsp;<span class="builtintype" id="4467126">byte</span><span class="op" id="4467130">(</span><span class="builtintype" id="4467131">int32</span><span class="op" id="4467136">(</span><span class="op" id="4467137">^</span><span class="ident" id="4467138"><a href="/gostd/crypto/tls/conn.go.html#4467034">t</a></span><span class="op" id="4467139">)</span>&nbsp;<span class="op" id="4467141">&gt;&gt;</span>&nbsp;<span class="num" id="4467144">31</span><span class="op" id="4467146">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467150">b</span>&nbsp;<span class="op" id="4467152">:=</span>&nbsp;<span class="ident" id="4467155"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4467162">[</span><span class="builtinfunc" id="4467163">len</span><span class="op" id="4467166">(</span><span class="ident" id="4467167"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4467174">)</span><span class="op" id="4467175">-</span><span class="num" id="4467176">1</span><span class="op" id="4467177">-</span><span class="ident" id="4467178"><a href="/gostd/crypto/tls/conn.go.html#4467005">i</a></span><span class="op" id="4467179">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467183"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467188">&amp;^=</span>&nbsp;<span class="ident" id="4467192"><a href="/gostd/crypto/tls/conn.go.html#4467118">mask</a></span><span class="op" id="4467196">&amp;</span><span class="ident" id="4467197"><a href="/gostd/crypto/tls/conn.go.html#4466629">paddingLen</a></span>&nbsp;<span class="op" id="4467208">^</span>&nbsp;<span class="ident" id="4467210"><a href="/gostd/crypto/tls/conn.go.html#4467118">mask</a></span><span class="op" id="4467214">&amp;</span><span class="ident" id="4467215"><a href="/gostd/crypto/tls/conn.go.html#4467150">b</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4467222">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4467291">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467309"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467314">&amp;=</span>&nbsp;<span class="ident" id="4467317"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467322">&lt;&lt;</span>&nbsp;<span class="num" id="4467325">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467328"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467333">&amp;=</span>&nbsp;<span class="ident" id="4467336"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467341">&lt;&lt;</span>&nbsp;<span class="num" id="4467344">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467347"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467352">&amp;=</span>&nbsp;<span class="ident" id="4467355"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467360">&lt;&lt;</span>&nbsp;<span class="num" id="4467363">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467366"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span>&nbsp;<span class="op" id="4467371">=</span>&nbsp;<span class="builtintype" id="4467373">uint8</span><span class="op" id="4467378">(</span><span class="builtintype" id="4467379">int8</span><span class="op" id="4467383">(</span><span class="ident" id="4467384"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span><span class="op" id="4467388">)</span>&nbsp;<span class="op" id="4467390">&gt;&gt;</span>&nbsp;<span class="num" id="4467393">7</span><span class="op" id="4467394">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467398">toRemove</span>&nbsp;<span class="op" id="4467407">:=</span>&nbsp;<span class="ident" id="4467410"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span><span class="op" id="4467414">&amp;</span><span class="ident" id="4467415"><a href="/gostd/crypto/tls/conn.go.html#4466629">paddingLen</a></span>&nbsp;<span class="op" id="4467426">+</span>&nbsp;<span class="num" id="4467428">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467431">return</span>&nbsp;<span class="ident" id="4467438"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4467445">[</span><span class="op" id="4467446">:</span><span class="builtinfunc" id="4467447">len</span><span class="op" id="4467450">(</span><span class="ident" id="4467451"><a href="/gostd/crypto/tls/conn.go.html#4466548">payload</a></span><span class="op" id="4467458">)</span><span class="op" id="4467459">-</span><span class="builtintype" id="4467460">int</span><span class="op" id="4467463">(</span><span class="ident" id="4467464"><a href="/gostd/crypto/tls/conn.go.html#4467398">toRemove</a></span><span class="op" id="4467472">)</span><span class="op" id="4467473">]</span><span class="op" id="4467474">,</span>&nbsp;<span class="ident" id="4467476"><a href="/gostd/crypto/tls/conn.go.html#4466780">good</a></span><br>
<span class="lineno"></span><span class="op" id="4467481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4467484">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4467562">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4467637">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4467674">func</span>&nbsp;<span class="ident" id="4467679">removePaddingSSL30</span><span class="op" id="4467697">(</span><span class="ident" id="4467698">payload</span>&nbsp;<span class="op" id="4467706">[</span><span class="op" id="4467707">]</span><span class="builtintype" id="4467708">byte</span><span class="op" id="4467712">)</span>&nbsp;<span class="op" id="4467714">(</span><span class="op" id="4467715">[</span><span class="op" id="4467716">]</span><span class="builtintype" id="4467717">byte</span><span class="op" id="4467721">,</span>&nbsp;<span class="builtintype" id="4467723">byte</span><span class="op" id="4467727">)</span>&nbsp;<span class="op" id="4467729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467732">if</span>&nbsp;<span class="builtinfunc" id="4467735">len</span><span class="op" id="4467738">(</span><span class="ident" id="4467739"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467746">)</span>&nbsp;<span class="op" id="4467748">&lt;</span>&nbsp;<span class="num" id="4467750">1</span>&nbsp;<span class="op" id="4467752">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467756">return</span>&nbsp;<span class="ident" id="4467763"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467770">,</span>&nbsp;<span class="num" id="4467772">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467779">paddingLen</span>&nbsp;<span class="op" id="4467790">:=</span>&nbsp;<span class="builtintype" id="4467793">int</span><span class="op" id="4467796">(</span><span class="ident" id="4467797"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467804">[</span><span class="builtinfunc" id="4467805">len</span><span class="op" id="4467808">(</span><span class="ident" id="4467809"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467816">)</span><span class="op" id="4467817">-</span><span class="num" id="4467818">1</span><span class="op" id="4467819">]</span><span class="op" id="4467820">)</span>&nbsp;<span class="op" id="4467822">+</span>&nbsp;<span class="num" id="4467824">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467827">if</span>&nbsp;<span class="ident" id="4467830"><a href="/gostd/crypto/tls/conn.go.html#4467779">paddingLen</a></span>&nbsp;<span class="op" id="4467841">&gt;</span>&nbsp;<span class="builtinfunc" id="4467843">len</span><span class="op" id="4467846">(</span><span class="ident" id="4467847"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467854">)</span>&nbsp;<span class="op" id="4467856">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467860">return</span>&nbsp;<span class="ident" id="4467867"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467874">,</span>&nbsp;<span class="num" id="4467876">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467883">return</span>&nbsp;<span class="ident" id="4467890"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467897">[</span><span class="op" id="4467898">:</span><span class="builtinfunc" id="4467899">len</span><span class="op" id="4467902">(</span><span class="ident" id="4467903"><a href="/gostd/crypto/tls/conn.go.html#4467698">payload</a></span><span class="op" id="4467910">)</span><span class="op" id="4467911">-</span><span class="ident" id="4467912"><a href="/gostd/crypto/tls/conn.go.html#4467779">paddingLen</a></span><span class="op" id="4467922">]</span><span class="op" id="4467923">,</span>&nbsp;<span class="num" id="4467925">255</span><br>
<span class="lineno"></span><span class="op" id="4467929">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4467932">func</span>&nbsp;<span class="ident" id="4467937">roundUp</span><span class="op" id="4467944">(</span><span class="ident" id="4467945">a</span><span class="op" id="4467946">,</span>&nbsp;<span class="ident" id="4467948">b</span>&nbsp;<span class="builtintype" id="4467950">int</span><span class="op" id="4467953">)</span>&nbsp;<span class="builtintype" id="4467955">int</span>&nbsp;<span class="op" id="4467959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467962">return</span>&nbsp;<span class="ident" id="4467969"><a href="/gostd/crypto/tls/conn.go.html#4467945">a</a></span>&nbsp;<span class="op" id="4467971">+</span>&nbsp;<span class="op" id="4467973">(</span><span class="ident" id="4467974"><a href="/gostd/crypto/tls/conn.go.html#4467948">b</a></span><span class="op" id="4467975">-</span><span class="ident" id="4467976"><a href="/gostd/crypto/tls/conn.go.html#4467945">a</a></span><span class="op" id="4467977">%</span><span class="ident" id="4467978"><a href="/gostd/crypto/tls/conn.go.html#4467948">b</a></span><span class="op" id="4467979">)</span><span class="op" id="4467980">%</span><span class="ident" id="4467981"><a href="/gostd/crypto/tls/conn.go.html#4467948">b</a></span><br>
<span class="lineno"></span><span class="op" id="4467983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4467986">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4468060">type</span>&nbsp;<span class="ident" id="4468065">cbcMode</span>&nbsp;<span class="keyword" id="4468073">interface</span>&nbsp;<span class="op" id="4468083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468086"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4468092">.</span><span class="ident" id="4468093"><a href="/gostd/crypto/cipher/cipher.go.html#4411369">BlockMode</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468104">SetIV</span><span class="op" id="4468109">(</span><span class="op" id="4468110">[</span><span class="op" id="4468111">]</span><span class="builtintype" id="4468112">byte</span><span class="op" id="4468116">)</span><br>
<span class="lineno"></span><span class="op" id="4468118">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4468121">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4468196">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4468276">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4468346">func</span>&nbsp;<span class="op" id="4468351">(</span><span class="ident" id="4468352">hc</span>&nbsp;<span class="op" id="4468355">*</span><span class="ident" id="4468356"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4468364">)</span>&nbsp;<span class="ident" id="4468366">decrypt</span><span class="op" id="4468373">(</span><span class="ident" id="4468374">b</span>&nbsp;<span class="op" id="4468376">*</span><span class="ident" id="4468377"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4468382">)</span>&nbsp;<span class="op" id="4468384">(</span><span class="ident" id="4468385">ok</span>&nbsp;<span class="builtintype" id="4468388">bool</span><span class="op" id="4468392">,</span>&nbsp;<span class="ident" id="4468394">prefixLen</span>&nbsp;<span class="builtintype" id="4468404">int</span><span class="op" id="4468407">,</span>&nbsp;<span class="ident" id="4468409">alertValue</span>&nbsp;<span class="ident" id="4468420"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4468425">)</span>&nbsp;<span class="op" id="4468427">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4468430">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468451">payload</span>&nbsp;<span class="op" id="4468459">:=</span>&nbsp;<span class="ident" id="4468462"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4468463">.</span><span class="ident" id="4468464"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4468468">[</span><span class="ident" id="4468469"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4468484">:</span><span class="op" id="4468485">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468489">macSize</span>&nbsp;<span class="op" id="4468497">:=</span>&nbsp;<span class="num" id="4468500">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468503">if</span>&nbsp;<span class="ident" id="4468506"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4468508">.</span><span class="ident" id="4468509"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span>&nbsp;<span class="op" id="4468513">!=</span>&nbsp;<span class="builtintype" id="4468516">nil</span>&nbsp;<span class="op" id="4468520">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468524"><a href="/gostd/crypto/tls/conn.go.html#4468489">macSize</a></span>&nbsp;<span class="op" id="4468532">=</span>&nbsp;<span class="ident" id="4468534"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4468536">.</span><span class="ident" id="4468537"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span><span class="op" id="4468540">.</span><span class="ident" id="4468541"><a href="/gostd/crypto/tls/cipher_suites.go.html#4437397">Size</a></span><span class="op" id="4468545">(</span><span class="op" id="4468546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4468549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468553">paddingGood</span>&nbsp;<span class="op" id="4468565">:=</span>&nbsp;<span class="builtintype" id="4468568">byte</span><span class="op" id="4468572">(</span><span class="num" id="4468573">255</span><span class="op" id="4468576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468579">explicitIVLen</span>&nbsp;<span class="op" id="4468593">:=</span>&nbsp;<span class="num" id="4468596">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4468600">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468612">if</span>&nbsp;<span class="ident" id="4468615"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4468617">.</span><span class="ident" id="4468618"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span>&nbsp;<span class="op" id="4468625">!=</span>&nbsp;<span class="builtintype" id="4468628">nil</span>&nbsp;<span class="op" id="4468632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468636">switch</span>&nbsp;<span class="ident" id="4468643">c</span>&nbsp;<span class="op" id="4468645">:=</span>&nbsp;<span class="ident" id="4468648"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4468650">.</span><span class="ident" id="4468651"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span><span class="op" id="4468657">.</span><span class="op" id="4468658">(</span><span class="keyword" id="4468659">type</span><span class="op" id="4468663">)</span>&nbsp;<span class="op" id="4468665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468669">case</span>&nbsp;<span class="ident" id="4468674"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4468680">.</span><span class="ident" id="4468681"><a href="/gostd/crypto/cipher/cipher.go.html#4411082">Stream</a></span><span class="op" id="4468687">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468692"><a href="/gostd/crypto/tls/conn.go.html#4468643">c</a></span><span class="op" id="4468693">.</span><span class="ident" id="4468694"><a href="/gostd/crypto/cipher/cipher.go.html#4411241">XORKeyStream</a></span><span class="op" id="4468706">(</span><span class="ident" id="4468707"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4468714">,</span>&nbsp;<span class="ident" id="4468716"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4468723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468727">case</span>&nbsp;<span class="ident" id="4468732"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4468738">.</span><span class="ident" id="4468739"><a href="/gostd/crypto/cipher/gcm.go.html#4413722">AEAD</a></span><span class="op" id="4468743">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468748"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4468762">=</span>&nbsp;<span class="num" id="4468764">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468769">if</span>&nbsp;<span class="builtinfunc" id="4468772">len</span><span class="op" id="4468775">(</span><span class="ident" id="4468776"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4468783">)</span>&nbsp;<span class="op" id="4468785">&lt;</span>&nbsp;<span class="ident" id="4468787"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4468801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468807">return</span>&nbsp;<span class="builtintype" id="4468814">false</span><span class="op" id="4468819">,</span>&nbsp;<span class="num" id="4468821">0</span><span class="op" id="4468822">,</span>&nbsp;<span class="ident" id="4468824"><a href="/gostd/crypto/tls/alert.go.html#4430336">alertBadRecordMAC</a></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4468845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468850">nonce</span>&nbsp;<span class="op" id="4468856">:=</span>&nbsp;<span class="ident" id="4468859"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4468866">[</span><span class="op" id="4468867">:</span><span class="num" id="4468868">8</span><span class="op" id="4468869">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468874"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span>&nbsp;<span class="op" id="4468882">=</span>&nbsp;<span class="ident" id="4468884"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4468891">[</span><span class="num" id="4468892">8</span><span class="op" id="4468893">:</span><span class="op" id="4468894">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468900">var</span>&nbsp;<span class="ident" id="4468904">additionalData</span>&nbsp;<span class="op" id="4468919">[</span><span class="num" id="4468920">13</span><span class="op" id="4468922">]</span><span class="builtintype" id="4468923">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4468931">copy</span><span class="op" id="4468935">(</span><span class="ident" id="4468936"><a href="/gostd/crypto/tls/conn.go.html#4468904">additionalData</a></span><span class="op" id="4468950">[</span><span class="op" id="4468951">:</span><span class="op" id="4468952">]</span><span class="op" id="4468953">,</span>&nbsp;<span class="ident" id="4468955"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4468957">.</span><span class="ident" id="4468958"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4468961">[</span><span class="op" id="4468962">:</span><span class="op" id="4468963">]</span><span class="op" id="4468964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4468969">copy</span><span class="op" id="4468973">(</span><span class="ident" id="4468974"><a href="/gostd/crypto/tls/conn.go.html#4468904">additionalData</a></span><span class="op" id="4468988">[</span><span class="num" id="4468989">8</span><span class="op" id="4468990">:</span><span class="op" id="4468991">]</span><span class="op" id="4468992">,</span>&nbsp;<span class="ident" id="4468994"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4468995">.</span><span class="ident" id="4468996"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4469000">[</span><span class="op" id="4469001">:</span><span class="num" id="4469002">3</span><span class="op" id="4469003">]</span><span class="op" id="4469004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469009">n</span>&nbsp;<span class="op" id="4469011">:=</span>&nbsp;<span class="builtinfunc" id="4469014">len</span><span class="op" id="4469017">(</span><span class="ident" id="4469018"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469025">)</span>&nbsp;<span class="op" id="4469027">-</span>&nbsp;<span class="ident" id="4469029"><a href="/gostd/crypto/tls/conn.go.html#4468643">c</a></span><span class="op" id="4469030">.</span><span class="ident" id="4469031"><a href="/gostd/crypto/cipher/gcm.go.html#4413943">Overhead</a></span><span class="op" id="4469039">(</span><span class="op" id="4469040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469045"><a href="/gostd/crypto/tls/conn.go.html#4468904">additionalData</a></span><span class="op" id="4469059">[</span><span class="num" id="4469060">11</span><span class="op" id="4469062">]</span>&nbsp;<span class="op" id="4469064">=</span>&nbsp;<span class="builtintype" id="4469066">byte</span><span class="op" id="4469070">(</span><span class="ident" id="4469071"><a href="/gostd/crypto/tls/conn.go.html#4469009">n</a></span>&nbsp;<span class="op" id="4469073">&gt;&gt;</span>&nbsp;<span class="num" id="4469076">8</span><span class="op" id="4469077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469082"><a href="/gostd/crypto/tls/conn.go.html#4468904">additionalData</a></span><span class="op" id="4469096">[</span><span class="num" id="4469097">12</span><span class="op" id="4469099">]</span>&nbsp;<span class="op" id="4469101">=</span>&nbsp;<span class="builtintype" id="4469103">byte</span><span class="op" id="4469107">(</span><span class="ident" id="4469108"><a href="/gostd/crypto/tls/conn.go.html#4469009">n</a></span><span class="op" id="4469109">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469114">var</span>&nbsp;<span class="ident" id="4469118">err</span>&nbsp;<span class="builtintype" id="4469122">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469131"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469138">,</span>&nbsp;<span class="ident" id="4469140"><a href="/gostd/crypto/tls/conn.go.html#4469118">err</a></span>&nbsp;<span class="op" id="4469144">=</span>&nbsp;<span class="ident" id="4469146"><a href="/gostd/crypto/tls/conn.go.html#4468643">c</a></span><span class="op" id="4469147">.</span><span class="ident" id="4469148"><a href="/gostd/crypto/cipher/gcm.go.html#4414674">Open</a></span><span class="op" id="4469152">(</span><span class="ident" id="4469153"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469160">[</span><span class="op" id="4469161">:</span><span class="num" id="4469162">0</span><span class="op" id="4469163">]</span><span class="op" id="4469164">,</span>&nbsp;<span class="ident" id="4469166"><a href="/gostd/crypto/tls/conn.go.html#4468850">nonce</a></span><span class="op" id="4469171">,</span>&nbsp;<span class="ident" id="4469173"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469180">,</span>&nbsp;<span class="ident" id="4469182"><a href="/gostd/crypto/tls/conn.go.html#4468904">additionalData</a></span><span class="op" id="4469196">[</span><span class="op" id="4469197">:</span><span class="op" id="4469198">]</span><span class="op" id="4469199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469204">if</span>&nbsp;<span class="ident" id="4469207"><a href="/gostd/crypto/tls/conn.go.html#4469118">err</a></span>&nbsp;<span class="op" id="4469211">!=</span>&nbsp;<span class="builtintype" id="4469214">nil</span>&nbsp;<span class="op" id="4469218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469224">return</span>&nbsp;<span class="builtintype" id="4469231">false</span><span class="op" id="4469236">,</span>&nbsp;<span class="num" id="4469238">0</span><span class="op" id="4469239">,</span>&nbsp;<span class="ident" id="4469241"><a href="/gostd/crypto/tls/alert.go.html#4430336">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469262">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469267"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4469268">.</span><span class="ident" id="4469269"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4469275">(</span><span class="ident" id="4469276"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4469292">+</span>&nbsp;<span class="ident" id="4469294"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4469308">+</span>&nbsp;<span class="builtinfunc" id="4469310">len</span><span class="op" id="4469313">(</span><span class="ident" id="4469314"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469321">)</span><span class="op" id="4469322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469326">case</span>&nbsp;<span class="ident" id="4469331"><a href="/gostd/crypto/tls/conn.go.html#4468065">cbcMode</a></span><span class="op" id="4469338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469343">blockSize</span>&nbsp;<span class="op" id="4469353">:=</span>&nbsp;<span class="ident" id="4469356"><a href="/gostd/crypto/tls/conn.go.html#4468643">c</a></span><span class="op" id="4469357">.</span><span class="ident" id="4469358"><a href="/gostd/crypto/cipher/cipher.go.html#4411437">BlockSize</a></span><span class="op" id="4469367">(</span><span class="op" id="4469368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469373">if</span>&nbsp;<span class="ident" id="4469376"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4469378">.</span><span class="ident" id="4469379"><a href="/gostd/crypto/tls/conn.go.html#4464686">version</a></span>&nbsp;<span class="op" id="4469387">&gt;=</span>&nbsp;<span class="ident" id="4469390"><a href="/gostd/crypto/tls/common.go.html#4442486">VersionTLS11</a></span>&nbsp;<span class="op" id="4469403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469409"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4469423">=</span>&nbsp;<span class="ident" id="4469425"><a href="/gostd/crypto/tls/conn.go.html#4469343">blockSize</a></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469444">if</span>&nbsp;<span class="builtinfunc" id="4469447">len</span><span class="op" id="4469450">(</span><span class="ident" id="4469451"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469458">)</span><span class="op" id="4469459">%</span><span class="ident" id="4469460"><a href="/gostd/crypto/tls/conn.go.html#4469343">blockSize</a></span>&nbsp;<span class="op" id="4469470">!=</span>&nbsp;<span class="num" id="4469473">0</span>&nbsp;<span class="op" id="4469475">||</span>&nbsp;<span class="builtinfunc" id="4469478">len</span><span class="op" id="4469481">(</span><span class="ident" id="4469482"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469489">)</span>&nbsp;<span class="op" id="4469491">&lt;</span>&nbsp;<span class="ident" id="4469493"><a href="/gostd/crypto/tls/conn.go.html#4467937">roundUp</a></span><span class="op" id="4469500">(</span><span class="ident" id="4469501"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span><span class="op" id="4469514">+</span><span class="ident" id="4469515"><a href="/gostd/crypto/tls/conn.go.html#4468489">macSize</a></span><span class="op" id="4469522">+</span><span class="num" id="4469523">1</span><span class="op" id="4469524">,</span>&nbsp;<span class="ident" id="4469526"><a href="/gostd/crypto/tls/conn.go.html#4469343">blockSize</a></span><span class="op" id="4469535">)</span>&nbsp;<span class="op" id="4469537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469543">return</span>&nbsp;<span class="builtintype" id="4469550">false</span><span class="op" id="4469555">,</span>&nbsp;<span class="num" id="4469557">0</span><span class="op" id="4469558">,</span>&nbsp;<span class="ident" id="4469560"><a href="/gostd/crypto/tls/alert.go.html#4430336">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469581">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469587">if</span>&nbsp;<span class="ident" id="4469590"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4469604">&gt;</span>&nbsp;<span class="num" id="4469606">0</span>&nbsp;<span class="op" id="4469608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469614"><a href="/gostd/crypto/tls/conn.go.html#4468643">c</a></span><span class="op" id="4469615">.</span><span class="ident" id="4469616"><a href="/gostd/crypto/tls/conn.go.html#4468104">SetIV</a></span><span class="op" id="4469621">(</span><span class="ident" id="4469622"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469629">[</span><span class="op" id="4469630">:</span><span class="ident" id="4469631"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span><span class="op" id="4469644">]</span><span class="op" id="4469645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469651"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span>&nbsp;<span class="op" id="4469659">=</span>&nbsp;<span class="ident" id="4469661"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469668">[</span><span class="ident" id="4469669"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span><span class="op" id="4469682">:</span><span class="op" id="4469683">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469688">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469693"><a href="/gostd/crypto/tls/conn.go.html#4468643">c</a></span><span class="op" id="4469694">.</span><span class="ident" id="4469695"><a href="/gostd/crypto/cipher/cipher.go.html#4411618">CryptBlocks</a></span><span class="op" id="4469706">(</span><span class="ident" id="4469707"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469714">,</span>&nbsp;<span class="ident" id="4469716"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469728">if</span>&nbsp;<span class="ident" id="4469731"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4469733">.</span><span class="ident" id="4469734"><a href="/gostd/crypto/tls/conn.go.html#4464686">version</a></span>&nbsp;<span class="op" id="4469742">==</span>&nbsp;<span class="ident" id="4469745"><a href="/gostd/crypto/tls/common.go.html#4442440">VersionSSL30</a></span>&nbsp;<span class="op" id="4469758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469764"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469771">,</span>&nbsp;<span class="ident" id="4469773"><a href="/gostd/crypto/tls/conn.go.html#4468553">paddingGood</a></span>&nbsp;<span class="op" id="4469785">=</span>&nbsp;<span class="ident" id="4469787"><a href="/gostd/crypto/tls/conn.go.html#4467679">removePaddingSSL30</a></span><span class="op" id="4469805">(</span><span class="ident" id="4469806"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469818">}</span>&nbsp;<span class="keyword" id="4469820">else</span>&nbsp;<span class="op" id="4469825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469831"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469838">,</span>&nbsp;<span class="ident" id="4469840"><a href="/gostd/crypto/tls/conn.go.html#4468553">paddingGood</a></span>&nbsp;<span class="op" id="4469852">=</span>&nbsp;<span class="ident" id="4469854"><a href="/gostd/crypto/tls/conn.go.html#4466534">removePadding</a></span><span class="op" id="4469867">(</span><span class="ident" id="4469868"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469875">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469885"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4469886">.</span><span class="ident" id="4469887"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4469893">(</span><span class="ident" id="4469894"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4469910">+</span>&nbsp;<span class="ident" id="4469912"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4469926">+</span>&nbsp;<span class="builtinfunc" id="4469928">len</span><span class="op" id="4469931">(</span><span class="ident" id="4469932"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4469939">)</span><span class="op" id="4469940">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469946">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470005">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470062">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470119">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470175">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470225">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470283">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470303">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470309">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470365">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470395">default</span><span class="op" id="4470402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4470407">panic</span><span class="op" id="4470412">(</span><span class="string" id="4470413">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4470434">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470445">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470466">if</span>&nbsp;<span class="ident" id="4470469"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4470471">.</span><span class="ident" id="4470472"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span>&nbsp;<span class="op" id="4470476">!=</span>&nbsp;<span class="builtintype" id="4470479">nil</span>&nbsp;<span class="op" id="4470483">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470487">if</span>&nbsp;<span class="builtinfunc" id="4470490">len</span><span class="op" id="4470493">(</span><span class="ident" id="4470494"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4470501">)</span>&nbsp;<span class="op" id="4470503">&lt;</span>&nbsp;<span class="ident" id="4470505"><a href="/gostd/crypto/tls/conn.go.html#4468489">macSize</a></span>&nbsp;<span class="op" id="4470513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470518">return</span>&nbsp;<span class="builtintype" id="4470525">false</span><span class="op" id="4470530">,</span>&nbsp;<span class="num" id="4470532">0</span><span class="op" id="4470533">,</span>&nbsp;<span class="ident" id="4470535"><a href="/gostd/crypto/tls/alert.go.html#4430336">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4470560">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470595">n</span>&nbsp;<span class="op" id="4470597">:=</span>&nbsp;<span class="builtinfunc" id="4470600">len</span><span class="op" id="4470603">(</span><span class="ident" id="4470604"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4470611">)</span>&nbsp;<span class="op" id="4470613">-</span>&nbsp;<span class="ident" id="4470615"><a href="/gostd/crypto/tls/conn.go.html#4468489">macSize</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470625"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4470626">.</span><span class="ident" id="4470627"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4470631">[</span><span class="num" id="4470632">3</span><span class="op" id="4470633">]</span>&nbsp;<span class="op" id="4470635">=</span>&nbsp;<span class="builtintype" id="4470637">byte</span><span class="op" id="4470641">(</span><span class="ident" id="4470642"><a href="/gostd/crypto/tls/conn.go.html#4470595">n</a></span>&nbsp;<span class="op" id="4470644">&gt;&gt;</span>&nbsp;<span class="num" id="4470647">8</span><span class="op" id="4470648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470652"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4470653">.</span><span class="ident" id="4470654"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4470658">[</span><span class="num" id="4470659">4</span><span class="op" id="4470660">]</span>&nbsp;<span class="op" id="4470662">=</span>&nbsp;<span class="builtintype" id="4470664">byte</span><span class="op" id="4470668">(</span><span class="ident" id="4470669"><a href="/gostd/crypto/tls/conn.go.html#4470595">n</a></span><span class="op" id="4470670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470674"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4470675">.</span><span class="ident" id="4470676"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4470682">(</span><span class="ident" id="4470683"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4470699">+</span>&nbsp;<span class="ident" id="4470701"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span>&nbsp;<span class="op" id="4470715">+</span>&nbsp;<span class="ident" id="4470717"><a href="/gostd/crypto/tls/conn.go.html#4470595">n</a></span><span class="op" id="4470718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470722">remoteMAC</span>&nbsp;<span class="op" id="4470732">:=</span>&nbsp;<span class="ident" id="4470735"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4470742">[</span><span class="ident" id="4470743"><a href="/gostd/crypto/tls/conn.go.html#4470595">n</a></span><span class="op" id="4470744">:</span><span class="op" id="4470745">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470749">localMAC</span>&nbsp;<span class="op" id="4470758">:=</span>&nbsp;<span class="ident" id="4470761"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4470763">.</span><span class="ident" id="4470764"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span><span class="op" id="4470767">.</span><span class="ident" id="4470768"><a href="/gostd/crypto/tls/cipher_suites.go.html#4437409">MAC</a></span><span class="op" id="4470771">(</span><span class="ident" id="4470772"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4470774">.</span><span class="ident" id="4470775"><a href="/gostd/crypto/tls/conn.go.html#4465024">inDigestBuf</a></span><span class="op" id="4470786">,</span>&nbsp;<span class="ident" id="4470788"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4470790">.</span><span class="ident" id="4470791"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4470794">[</span><span class="num" id="4470795">0</span><span class="op" id="4470796">:</span><span class="op" id="4470797">]</span><span class="op" id="4470798">,</span>&nbsp;<span class="ident" id="4470800"><a href="/gostd/crypto/tls/conn.go.html#4468374">b</a></span><span class="op" id="4470801">.</span><span class="ident" id="4470802"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4470806">[</span><span class="op" id="4470807">:</span><span class="ident" id="4470808"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4470823">]</span><span class="op" id="4470824">,</span>&nbsp;<span class="ident" id="4470826"><a href="/gostd/crypto/tls/conn.go.html#4468451">payload</a></span><span class="op" id="4470833">[</span><span class="op" id="4470834">:</span><span class="ident" id="4470835"><a href="/gostd/crypto/tls/conn.go.html#4470595">n</a></span><span class="op" id="4470836">]</span><span class="op" id="4470837">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470842">if</span>&nbsp;<span class="ident" id="4470845"><a href="/gostd/crypto/tls/conn.go.html#4461734">subtle</a></span><span class="op" id="4470851">.</span><span class="ident" id="4470852"><a href="/gostd/crypto/subtle/constant_time.go.html#4428560">ConstantTimeCompare</a></span><span class="op" id="4470871">(</span><span class="ident" id="4470872"><a href="/gostd/crypto/tls/conn.go.html#4470749">localMAC</a></span><span class="op" id="4470880">,</span>&nbsp;<span class="ident" id="4470882"><a href="/gostd/crypto/tls/conn.go.html#4470722">remoteMAC</a></span><span class="op" id="4470891">)</span>&nbsp;<span class="op" id="4470893">!=</span>&nbsp;<span class="num" id="4470896">1</span>&nbsp;<span class="op" id="4470898">||</span>&nbsp;<span class="ident" id="4470901"><a href="/gostd/crypto/tls/conn.go.html#4468553">paddingGood</a></span>&nbsp;<span class="op" id="4470913">!=</span>&nbsp;<span class="num" id="4470916">255</span>&nbsp;<span class="op" id="4470920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470925">return</span>&nbsp;<span class="builtintype" id="4470932">false</span><span class="op" id="4470937">,</span>&nbsp;<span class="num" id="4470939">0</span><span class="op" id="4470940">,</span>&nbsp;<span class="ident" id="4470942"><a href="/gostd/crypto/tls/alert.go.html#4430336">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470962">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470966"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4470968">.</span><span class="ident" id="4470969"><a href="/gostd/crypto/tls/conn.go.html#4465024">inDigestBuf</a></span>&nbsp;<span class="op" id="4470981">=</span>&nbsp;<span class="ident" id="4470983"><a href="/gostd/crypto/tls/conn.go.html#4470749">localMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470996"><a href="/gostd/crypto/tls/conn.go.html#4468352">hc</a></span><span class="op" id="4470998">.</span><span class="ident" id="4470999"><a href="/gostd/crypto/tls/conn.go.html#4465923">incSeq</a></span><span class="op" id="4471005">(</span><span class="op" id="4471006">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471010">return</span>&nbsp;<span class="builtintype" id="4471017">true</span><span class="op" id="4471021">,</span>&nbsp;<span class="ident" id="4471023"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4471039">+</span>&nbsp;<span class="ident" id="4471041"><a href="/gostd/crypto/tls/conn.go.html#4468579">explicitIVLen</a></span><span class="op" id="4471054">,</span>&nbsp;<span class="num" id="4471056">0</span><br>
<span class="lineno">335</span><span class="op" id="4471058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4471061">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4471139">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4471214">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4471294">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4471370">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4471385">func</span>&nbsp;<span class="ident" id="4471390">padToBlockSize</span><span class="op" id="4471404">(</span><span class="ident" id="4471405">payload</span>&nbsp;<span class="op" id="4471413">[</span><span class="op" id="4471414">]</span><span class="builtintype" id="4471415">byte</span><span class="op" id="4471419">,</span>&nbsp;<span class="ident" id="4471421">blockSize</span>&nbsp;<span class="builtintype" id="4471431">int</span><span class="op" id="4471434">)</span>&nbsp;<span class="op" id="4471436">(</span><span class="ident" id="4471437">prefix</span><span class="op" id="4471443">,</span>&nbsp;<span class="ident" id="4471445">finalBlock</span>&nbsp;<span class="op" id="4471456">[</span><span class="op" id="4471457">]</span><span class="builtintype" id="4471458">byte</span><span class="op" id="4471462">)</span>&nbsp;<span class="op" id="4471464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471467">overrun</span>&nbsp;<span class="op" id="4471475">:=</span>&nbsp;<span class="builtinfunc" id="4471478">len</span><span class="op" id="4471481">(</span><span class="ident" id="4471482"><a href="/gostd/crypto/tls/conn.go.html#4471405">payload</a></span><span class="op" id="4471489">)</span>&nbsp;<span class="op" id="4471491">%</span>&nbsp;<span class="ident" id="4471493"><a href="/gostd/crypto/tls/conn.go.html#4471421">blockSize</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471504">paddingLen</span>&nbsp;<span class="op" id="4471515">:=</span>&nbsp;<span class="ident" id="4471518"><a href="/gostd/crypto/tls/conn.go.html#4471421">blockSize</a></span>&nbsp;<span class="op" id="4471528">-</span>&nbsp;<span class="ident" id="4471530"><a href="/gostd/crypto/tls/conn.go.html#4471467">overrun</a></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471539"><a href="/gostd/crypto/tls/conn.go.html#4471437">prefix</a></span>&nbsp;<span class="op" id="4471546">=</span>&nbsp;<span class="ident" id="4471548"><a href="/gostd/crypto/tls/conn.go.html#4471405">payload</a></span><span class="op" id="4471555">[</span><span class="op" id="4471556">:</span><span class="builtinfunc" id="4471557">len</span><span class="op" id="4471560">(</span><span class="ident" id="4471561"><a href="/gostd/crypto/tls/conn.go.html#4471405">payload</a></span><span class="op" id="4471568">)</span><span class="op" id="4471569">-</span><span class="ident" id="4471570"><a href="/gostd/crypto/tls/conn.go.html#4471467">overrun</a></span><span class="op" id="4471577">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471580"><a href="/gostd/crypto/tls/conn.go.html#4471445">finalBlock</a></span>&nbsp;<span class="op" id="4471591">=</span>&nbsp;<span class="builtinfunc" id="4471593">make</span><span class="op" id="4471597">(</span><span class="op" id="4471598">[</span><span class="op" id="4471599">]</span><span class="builtintype" id="4471600">byte</span><span class="op" id="4471604">,</span>&nbsp;<span class="ident" id="4471606"><a href="/gostd/crypto/tls/conn.go.html#4471421">blockSize</a></span><span class="op" id="4471615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4471618">copy</span><span class="op" id="4471622">(</span><span class="ident" id="4471623"><a href="/gostd/crypto/tls/conn.go.html#4471445">finalBlock</a></span><span class="op" id="4471633">,</span>&nbsp;<span class="ident" id="4471635"><a href="/gostd/crypto/tls/conn.go.html#4471405">payload</a></span><span class="op" id="4471642">[</span><span class="builtinfunc" id="4471643">len</span><span class="op" id="4471646">(</span><span class="ident" id="4471647"><a href="/gostd/crypto/tls/conn.go.html#4471405">payload</a></span><span class="op" id="4471654">)</span><span class="op" id="4471655">-</span><span class="ident" id="4471656"><a href="/gostd/crypto/tls/conn.go.html#4471467">overrun</a></span><span class="op" id="4471663">:</span><span class="op" id="4471664">]</span><span class="op" id="4471665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471668">for</span>&nbsp;<span class="ident" id="4471672">i</span>&nbsp;<span class="op" id="4471674">:=</span>&nbsp;<span class="ident" id="4471677"><a href="/gostd/crypto/tls/conn.go.html#4471467">overrun</a></span><span class="op" id="4471684">;</span>&nbsp;<span class="ident" id="4471686"><a href="/gostd/crypto/tls/conn.go.html#4471672">i</a></span>&nbsp;<span class="op" id="4471688">&lt;</span>&nbsp;<span class="ident" id="4471690"><a href="/gostd/crypto/tls/conn.go.html#4471421">blockSize</a></span><span class="op" id="4471699">;</span>&nbsp;<span class="ident" id="4471701"><a href="/gostd/crypto/tls/conn.go.html#4471672">i</a></span><span class="op" id="4471702">++</span>&nbsp;<span class="op" id="4471705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471709"><a href="/gostd/crypto/tls/conn.go.html#4471445">finalBlock</a></span><span class="op" id="4471719">[</span><span class="ident" id="4471720"><a href="/gostd/crypto/tls/conn.go.html#4471672">i</a></span><span class="op" id="4471721">]</span>&nbsp;<span class="op" id="4471723">=</span>&nbsp;<span class="builtintype" id="4471725">byte</span><span class="op" id="4471729">(</span><span class="ident" id="4471730"><a href="/gostd/crypto/tls/conn.go.html#4471504">paddingLen</a></span>&nbsp;<span class="op" id="4471741">-</span>&nbsp;<span class="num" id="4471743">1</span><span class="op" id="4471744">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471750">return</span><br>
<span class="lineno"></span><span class="op" id="4471757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4471760">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4471804">func</span>&nbsp;<span class="op" id="4471809">(</span><span class="ident" id="4471810">hc</span>&nbsp;<span class="op" id="4471813">*</span><span class="ident" id="4471814"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4471822">)</span>&nbsp;<span class="ident" id="4471824">encrypt</span><span class="op" id="4471831">(</span><span class="ident" id="4471832">b</span>&nbsp;<span class="op" id="4471834">*</span><span class="ident" id="4471835"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4471840">,</span>&nbsp;<span class="ident" id="4471842">explicitIVLen</span>&nbsp;<span class="builtintype" id="4471856">int</span><span class="op" id="4471859">)</span>&nbsp;<span class="op" id="4471861">(</span><span class="builtintype" id="4471862">bool</span><span class="op" id="4471866">,</span>&nbsp;<span class="ident" id="4471868"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4471873">)</span>&nbsp;<span class="op" id="4471875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4471878">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471886">if</span>&nbsp;<span class="ident" id="4471889"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4471891">.</span><span class="ident" id="4471892"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span>&nbsp;<span class="op" id="4471896">!=</span>&nbsp;<span class="builtintype" id="4471899">nil</span>&nbsp;<span class="op" id="4471903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471907">mac</span>&nbsp;<span class="op" id="4471911">:=</span>&nbsp;<span class="ident" id="4471914"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4471916">.</span><span class="ident" id="4471917"><a href="/gostd/crypto/tls/conn.go.html#4464768">mac</a></span><span class="op" id="4471920">.</span><span class="ident" id="4471921"><a href="/gostd/crypto/tls/cipher_suites.go.html#4437409">MAC</a></span><span class="op" id="4471924">(</span><span class="ident" id="4471925"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4471927">.</span><span class="ident" id="4471928"><a href="/gostd/crypto/tls/conn.go.html#4465037">outDigestBuf</a></span><span class="op" id="4471940">,</span>&nbsp;<span class="ident" id="4471942"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4471944">.</span><span class="ident" id="4471945"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4471948">[</span><span class="num" id="4471949">0</span><span class="op" id="4471950">:</span><span class="op" id="4471951">]</span><span class="op" id="4471952">,</span>&nbsp;<span class="ident" id="4471954"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4471955">.</span><span class="ident" id="4471956"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4471960">[</span><span class="op" id="4471961">:</span><span class="ident" id="4471962"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4471977">]</span><span class="op" id="4471978">,</span>&nbsp;<span class="ident" id="4471980"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4471981">.</span><span class="ident" id="4471982"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4471986">[</span><span class="ident" id="4471987"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4472002">+</span><span class="ident" id="4472003"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4472016">:</span><span class="op" id="4472017">]</span><span class="op" id="4472018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472023">n</span>&nbsp;<span class="op" id="4472025">:=</span>&nbsp;<span class="builtinfunc" id="4472028">len</span><span class="op" id="4472031">(</span><span class="ident" id="4472032"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472033">.</span><span class="ident" id="4472034"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472042"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472043">.</span><span class="ident" id="4472044"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4472050">(</span><span class="ident" id="4472051"><a href="/gostd/crypto/tls/conn.go.html#4472023">n</a></span>&nbsp;<span class="op" id="4472053">+</span>&nbsp;<span class="builtinfunc" id="4472055">len</span><span class="op" id="4472058">(</span><span class="ident" id="4472059"><a href="/gostd/crypto/tls/conn.go.html#4471907">mac</a></span><span class="op" id="4472062">)</span><span class="op" id="4472063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4472067">copy</span><span class="op" id="4472071">(</span><span class="ident" id="4472072"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472073">.</span><span class="ident" id="4472074"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472078">[</span><span class="ident" id="4472079"><a href="/gostd/crypto/tls/conn.go.html#4472023">n</a></span><span class="op" id="4472080">:</span><span class="op" id="4472081">]</span><span class="op" id="4472082">,</span>&nbsp;<span class="ident" id="4472084"><a href="/gostd/crypto/tls/conn.go.html#4471907">mac</a></span><span class="op" id="4472087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472091"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4472093">.</span><span class="ident" id="4472094"><a href="/gostd/crypto/tls/conn.go.html#4465037">outDigestBuf</a></span>&nbsp;<span class="op" id="4472107">=</span>&nbsp;<span class="ident" id="4472109"><a href="/gostd/crypto/tls/conn.go.html#4471907">mac</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472114">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472118">payload</span>&nbsp;<span class="op" id="4472126">:=</span>&nbsp;<span class="ident" id="4472129"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472130">.</span><span class="ident" id="4472131"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472135">[</span><span class="ident" id="4472136"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4472151">:</span><span class="op" id="4472152">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4472156">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472168">if</span>&nbsp;<span class="ident" id="4472171"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4472173">.</span><span class="ident" id="4472174"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span>&nbsp;<span class="op" id="4472181">!=</span>&nbsp;<span class="builtintype" id="4472184">nil</span>&nbsp;<span class="op" id="4472188">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472192">switch</span>&nbsp;<span class="ident" id="4472199">c</span>&nbsp;<span class="op" id="4472201">:=</span>&nbsp;<span class="ident" id="4472204"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4472206">.</span><span class="ident" id="4472207"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span><span class="op" id="4472213">.</span><span class="op" id="4472214">(</span><span class="keyword" id="4472215">type</span><span class="op" id="4472219">)</span>&nbsp;<span class="op" id="4472221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472225">case</span>&nbsp;<span class="ident" id="4472230"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4472236">.</span><span class="ident" id="4472237"><a href="/gostd/crypto/cipher/cipher.go.html#4411082">Stream</a></span><span class="op" id="4472243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472248"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4472249">.</span><span class="ident" id="4472250"><a href="/gostd/crypto/cipher/cipher.go.html#4411241">XORKeyStream</a></span><span class="op" id="4472262">(</span><span class="ident" id="4472263"><a href="/gostd/crypto/tls/conn.go.html#4472118">payload</a></span><span class="op" id="4472270">,</span>&nbsp;<span class="ident" id="4472272"><a href="/gostd/crypto/tls/conn.go.html#4472118">payload</a></span><span class="op" id="4472279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472283">case</span>&nbsp;<span class="ident" id="4472288"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4472294">.</span><span class="ident" id="4472295"><a href="/gostd/crypto/cipher/gcm.go.html#4413722">AEAD</a></span><span class="op" id="4472299">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472304">payloadLen</span>&nbsp;<span class="op" id="4472315">:=</span>&nbsp;<span class="builtinfunc" id="4472318">len</span><span class="op" id="4472321">(</span><span class="ident" id="4472322"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472323">.</span><span class="ident" id="4472324"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472328">)</span>&nbsp;<span class="op" id="4472330">-</span>&nbsp;<span class="ident" id="4472332"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4472348">-</span>&nbsp;<span class="ident" id="4472350"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472367"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472368">.</span><span class="ident" id="4472369"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4472375">(</span><span class="builtinfunc" id="4472376">len</span><span class="op" id="4472379">(</span><span class="ident" id="4472380"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472381">.</span><span class="ident" id="4472382"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472386">)</span>&nbsp;<span class="op" id="4472388">+</span>&nbsp;<span class="ident" id="4472390"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4472391">.</span><span class="ident" id="4472392"><a href="/gostd/crypto/cipher/gcm.go.html#4413943">Overhead</a></span><span class="op" id="4472400">(</span><span class="op" id="4472401">)</span><span class="op" id="4472402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472407">nonce</span>&nbsp;<span class="op" id="4472413">:=</span>&nbsp;<span class="ident" id="4472416"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472417">.</span><span class="ident" id="4472418"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472422">[</span><span class="ident" id="4472423"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4472439">:</span>&nbsp;<span class="ident" id="4472441"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4472456">+</span><span class="ident" id="4472457"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4472470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472475">payload</span>&nbsp;<span class="op" id="4472483">:=</span>&nbsp;<span class="ident" id="4472486"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472487">.</span><span class="ident" id="4472488"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472492">[</span><span class="ident" id="4472493"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4472508">+</span><span class="ident" id="4472509"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4472522">:</span><span class="op" id="4472523">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472528"><a href="/gostd/crypto/tls/conn.go.html#4472475">payload</a></span>&nbsp;<span class="op" id="4472536">=</span>&nbsp;<span class="ident" id="4472538"><a href="/gostd/crypto/tls/conn.go.html#4472475">payload</a></span><span class="op" id="4472545">[</span><span class="op" id="4472546">:</span><span class="ident" id="4472547"><a href="/gostd/crypto/tls/conn.go.html#4472304">payloadLen</a></span><span class="op" id="4472557">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472563">var</span>&nbsp;<span class="ident" id="4472567">additionalData</span>&nbsp;<span class="op" id="4472582">[</span><span class="num" id="4472583">13</span><span class="op" id="4472585">]</span><span class="builtintype" id="4472586">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4472594">copy</span><span class="op" id="4472598">(</span><span class="ident" id="4472599"><a href="/gostd/crypto/tls/conn.go.html#4472567">additionalData</a></span><span class="op" id="4472613">[</span><span class="op" id="4472614">:</span><span class="op" id="4472615">]</span><span class="op" id="4472616">,</span>&nbsp;<span class="ident" id="4472618"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4472620">.</span><span class="ident" id="4472621"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4472624">[</span><span class="op" id="4472625">:</span><span class="op" id="4472626">]</span><span class="op" id="4472627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4472632">copy</span><span class="op" id="4472636">(</span><span class="ident" id="4472637"><a href="/gostd/crypto/tls/conn.go.html#4472567">additionalData</a></span><span class="op" id="4472651">[</span><span class="num" id="4472652">8</span><span class="op" id="4472653">:</span><span class="op" id="4472654">]</span><span class="op" id="4472655">,</span>&nbsp;<span class="ident" id="4472657"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4472658">.</span><span class="ident" id="4472659"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4472663">[</span><span class="op" id="4472664">:</span><span class="num" id="4472665">3</span><span class="op" id="4472666">]</span><span class="op" id="4472667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472672"><a href="/gostd/crypto/tls/conn.go.html#4472567">additionalData</a></span><span class="op" id="4472686">[</span><span class="num" id="4472687">11</span><span class="op" id="4472689">]</span>&nbsp;<span class="op" id="4472691">=</span>&nbsp;<span class="builtintype" id="4472693">byte</span><span class="op" id="4472697">(</span><span class="ident" id="4472698"><a href="/gostd/crypto/tls/conn.go.html#4472304">payloadLen</a></span>&nbsp;<span class="op" id="4472709">&gt;&gt;</span>&nbsp;<span class="num" id="4472712">8</span><span class="op" id="4472713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472718"><a href="/gostd/crypto/tls/conn.go.html#4472567">additionalData</a></span><span class="op" id="4472732">[</span><span class="num" id="4472733">12</span><span class="op" id="4472735">]</span>&nbsp;<span class="op" id="4472737">=</span>&nbsp;<span class="builtintype" id="4472739">byte</span><span class="op" id="4472743">(</span><span class="ident" id="4472744"><a href="/gostd/crypto/tls/conn.go.html#4472304">payloadLen</a></span><span class="op" id="4472754">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472760"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4472761">.</span><span class="ident" id="4472762"><a href="/gostd/crypto/cipher/gcm.go.html#4414259">Seal</a></span><span class="op" id="4472766">(</span><span class="ident" id="4472767"><a href="/gostd/crypto/tls/conn.go.html#4472475">payload</a></span><span class="op" id="4472774">[</span><span class="op" id="4472775">:</span><span class="num" id="4472776">0</span><span class="op" id="4472777">]</span><span class="op" id="4472778">,</span>&nbsp;<span class="ident" id="4472780"><a href="/gostd/crypto/tls/conn.go.html#4472407">nonce</a></span><span class="op" id="4472785">,</span>&nbsp;<span class="ident" id="4472787"><a href="/gostd/crypto/tls/conn.go.html#4472475">payload</a></span><span class="op" id="4472794">,</span>&nbsp;<span class="ident" id="4472796"><a href="/gostd/crypto/tls/conn.go.html#4472567">additionalData</a></span><span class="op" id="4472810">[</span><span class="op" id="4472811">:</span><span class="op" id="4472812">]</span><span class="op" id="4472813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472817">case</span>&nbsp;<span class="ident" id="4472822"><a href="/gostd/crypto/tls/conn.go.html#4468065">cbcMode</a></span><span class="op" id="4472829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472834">blockSize</span>&nbsp;<span class="op" id="4472844">:=</span>&nbsp;<span class="ident" id="4472847"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4472848">.</span><span class="ident" id="4472849"><a href="/gostd/crypto/cipher/cipher.go.html#4411437">BlockSize</a></span><span class="op" id="4472858">(</span><span class="op" id="4472859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472864">if</span>&nbsp;<span class="ident" id="4472867"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span>&nbsp;<span class="op" id="4472881">&gt;</span>&nbsp;<span class="num" id="4472883">0</span>&nbsp;<span class="op" id="4472885">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472891"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4472892">.</span><span class="ident" id="4472893"><a href="/gostd/crypto/tls/conn.go.html#4468104">SetIV</a></span><span class="op" id="4472898">(</span><span class="ident" id="4472899"><a href="/gostd/crypto/tls/conn.go.html#4472118">payload</a></span><span class="op" id="4472906">[</span><span class="op" id="4472907">:</span><span class="ident" id="4472908"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4472921">]</span><span class="op" id="4472922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472928"><a href="/gostd/crypto/tls/conn.go.html#4472118">payload</a></span>&nbsp;<span class="op" id="4472936">=</span>&nbsp;<span class="ident" id="4472938"><a href="/gostd/crypto/tls/conn.go.html#4472118">payload</a></span><span class="op" id="4472945">[</span><span class="ident" id="4472946"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4472959">:</span><span class="op" id="4472960">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472970">prefix</span><span class="op" id="4472976">,</span>&nbsp;<span class="ident" id="4472978">finalBlock</span>&nbsp;<span class="op" id="4472989">:=</span>&nbsp;<span class="ident" id="4472992"><a href="/gostd/crypto/tls/conn.go.html#4471390">padToBlockSize</a></span><span class="op" id="4473006">(</span><span class="ident" id="4473007"><a href="/gostd/crypto/tls/conn.go.html#4472118">payload</a></span><span class="op" id="4473014">,</span>&nbsp;<span class="ident" id="4473016"><a href="/gostd/crypto/tls/conn.go.html#4472834">blockSize</a></span><span class="op" id="4473025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473030"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4473031">.</span><span class="ident" id="4473032"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4473038">(</span><span class="ident" id="4473039"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4473055">+</span>&nbsp;<span class="ident" id="4473057"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span>&nbsp;<span class="op" id="4473071">+</span>&nbsp;<span class="builtinfunc" id="4473073">len</span><span class="op" id="4473076">(</span><span class="ident" id="4473077"><a href="/gostd/crypto/tls/conn.go.html#4472970">prefix</a></span><span class="op" id="4473083">)</span>&nbsp;<span class="op" id="4473085">+</span>&nbsp;<span class="builtinfunc" id="4473087">len</span><span class="op" id="4473090">(</span><span class="ident" id="4473091"><a href="/gostd/crypto/tls/conn.go.html#4472978">finalBlock</a></span><span class="op" id="4473101">)</span><span class="op" id="4473102">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473107"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4473108">.</span><span class="ident" id="4473109"><a href="/gostd/crypto/cipher/cipher.go.html#4411618">CryptBlocks</a></span><span class="op" id="4473120">(</span><span class="ident" id="4473121"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4473122">.</span><span class="ident" id="4473123"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473127">[</span><span class="ident" id="4473128"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4473143">+</span><span class="ident" id="4473144"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4473157">:</span><span class="op" id="4473158">]</span><span class="op" id="4473159">,</span>&nbsp;<span class="ident" id="4473161"><a href="/gostd/crypto/tls/conn.go.html#4472970">prefix</a></span><span class="op" id="4473167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473172"><a href="/gostd/crypto/tls/conn.go.html#4472199">c</a></span><span class="op" id="4473173">.</span><span class="ident" id="4473174"><a href="/gostd/crypto/cipher/cipher.go.html#4411618">CryptBlocks</a></span><span class="op" id="4473185">(</span><span class="ident" id="4473186"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4473187">.</span><span class="ident" id="4473188"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473192">[</span><span class="ident" id="4473193"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4473208">+</span><span class="ident" id="4473209"><a href="/gostd/crypto/tls/conn.go.html#4471842">explicitIVLen</a></span><span class="op" id="4473222">+</span><span class="builtinfunc" id="4473223">len</span><span class="op" id="4473226">(</span><span class="ident" id="4473227"><a href="/gostd/crypto/tls/conn.go.html#4472970">prefix</a></span><span class="op" id="4473233">)</span><span class="op" id="4473234">:</span><span class="op" id="4473235">]</span><span class="op" id="4473236">,</span>&nbsp;<span class="ident" id="4473238"><a href="/gostd/crypto/tls/conn.go.html#4472978">finalBlock</a></span><span class="op" id="4473248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473252">default</span><span class="op" id="4473259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4473264">panic</span><span class="op" id="4473269">(</span><span class="string" id="4473270">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4473291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473295">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4473302">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473365">n</span>&nbsp;<span class="op" id="4473367">:=</span>&nbsp;<span class="builtinfunc" id="4473370">len</span><span class="op" id="4473373">(</span><span class="ident" id="4473374"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4473375">.</span><span class="ident" id="4473376"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473380">)</span>&nbsp;<span class="op" id="4473382">-</span>&nbsp;<span class="ident" id="4473384"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473401"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4473402">.</span><span class="ident" id="4473403"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473407">[</span><span class="num" id="4473408">3</span><span class="op" id="4473409">]</span>&nbsp;<span class="op" id="4473411">=</span>&nbsp;<span class="builtintype" id="4473413">byte</span><span class="op" id="4473417">(</span><span class="ident" id="4473418"><a href="/gostd/crypto/tls/conn.go.html#4473365">n</a></span>&nbsp;<span class="op" id="4473420">&gt;&gt;</span>&nbsp;<span class="num" id="4473423">8</span><span class="op" id="4473424">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473427"><a href="/gostd/crypto/tls/conn.go.html#4471832">b</a></span><span class="op" id="4473428">.</span><span class="ident" id="4473429"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473433">[</span><span class="num" id="4473434">4</span><span class="op" id="4473435">]</span>&nbsp;<span class="op" id="4473437">=</span>&nbsp;<span class="builtintype" id="4473439">byte</span><span class="op" id="4473443">(</span><span class="ident" id="4473444"><a href="/gostd/crypto/tls/conn.go.html#4473365">n</a></span><span class="op" id="4473445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473448"><a href="/gostd/crypto/tls/conn.go.html#4471810">hc</a></span><span class="op" id="4473450">.</span><span class="ident" id="4473451"><a href="/gostd/crypto/tls/conn.go.html#4465923">incSeq</a></span><span class="op" id="4473457">(</span><span class="op" id="4473458">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473462">return</span>&nbsp;<span class="builtintype" id="4473469">true</span><span class="op" id="4473473">,</span>&nbsp;<span class="num" id="4473475">0</span><br>
<span class="lineno"></span><span class="op" id="4473477">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4473480">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4473516">type</span>&nbsp;<span class="ident" id="4473521">block</span>&nbsp;<span class="keyword" id="4473527">struct</span>&nbsp;<span class="op" id="4473534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473537">data</span>&nbsp;<span class="op" id="4473542">[</span><span class="op" id="4473543">]</span><span class="builtintype" id="4473544">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473550">off</span>&nbsp;&nbsp;<span class="builtintype" id="4473555">int</span>&nbsp;<span class="comment" id="4473559">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473578">link</span>&nbsp;<span class="op" id="4473583">*</span><span class="ident" id="4473584"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><br>
<span class="lineno"></span><span class="op" id="4473590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4473593">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4473654">func</span>&nbsp;<span class="op" id="4473659">(</span><span class="ident" id="4473660">b</span>&nbsp;<span class="op" id="4473662">*</span><span class="ident" id="4473663"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4473668">)</span>&nbsp;<span class="ident" id="4473670">resize</span><span class="op" id="4473676">(</span><span class="ident" id="4473677">n</span>&nbsp;<span class="builtintype" id="4473679">int</span><span class="op" id="4473682">)</span>&nbsp;<span class="op" id="4473684">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473687">if</span>&nbsp;<span class="ident" id="4473690"><a href="/gostd/crypto/tls/conn.go.html#4473677">n</a></span>&nbsp;<span class="op" id="4473692">&gt;</span>&nbsp;<span class="builtinfunc" id="4473694">cap</span><span class="op" id="4473697">(</span><span class="ident" id="4473698"><a href="/gostd/crypto/tls/conn.go.html#4473660">b</a></span><span class="op" id="4473699">.</span><span class="ident" id="4473700"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473704">)</span>&nbsp;<span class="op" id="4473706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473710"><a href="/gostd/crypto/tls/conn.go.html#4473660">b</a></span><span class="op" id="4473711">.</span><span class="ident" id="4473712"><a href="/gostd/crypto/tls/conn.go.html#4473841">reserve</a></span><span class="op" id="4473719">(</span><span class="ident" id="4473720"><a href="/gostd/crypto/tls/conn.go.html#4473677">n</a></span><span class="op" id="4473721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473727"><a href="/gostd/crypto/tls/conn.go.html#4473660">b</a></span><span class="op" id="4473728">.</span><span class="ident" id="4473729"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span>&nbsp;<span class="op" id="4473734">=</span>&nbsp;<span class="ident" id="4473736"><a href="/gostd/crypto/tls/conn.go.html#4473660">b</a></span><span class="op" id="4473737">.</span><span class="ident" id="4473738"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473742">[</span><span class="num" id="4473743">0</span><span class="op" id="4473744">:</span><span class="ident" id="4473745"><a href="/gostd/crypto/tls/conn.go.html#4473677">n</a></span><span class="op" id="4473746">]</span><br>
<span class="lineno"></span><span class="op" id="4473748">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4473751">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4473825">func</span>&nbsp;<span class="op" id="4473830">(</span><span class="ident" id="4473831">b</span>&nbsp;<span class="op" id="4473833">*</span><span class="ident" id="4473834"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4473839">)</span>&nbsp;<span class="ident" id="4473841">reserve</span><span class="op" id="4473848">(</span><span class="ident" id="4473849">n</span>&nbsp;<span class="builtintype" id="4473851">int</span><span class="op" id="4473854">)</span>&nbsp;<span class="op" id="4473856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473859">if</span>&nbsp;<span class="builtinfunc" id="4473862">cap</span><span class="op" id="4473865">(</span><span class="ident" id="4473866"><a href="/gostd/crypto/tls/conn.go.html#4473831">b</a></span><span class="op" id="4473867">.</span><span class="ident" id="4473868"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473872">)</span>&nbsp;<span class="op" id="4473874">&gt;=</span>&nbsp;<span class="ident" id="4473877"><a href="/gostd/crypto/tls/conn.go.html#4473849">n</a></span>&nbsp;<span class="op" id="4473879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473883">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473894">m</span>&nbsp;<span class="op" id="4473896">:=</span>&nbsp;<span class="builtinfunc" id="4473899">cap</span><span class="op" id="4473902">(</span><span class="ident" id="4473903"><a href="/gostd/crypto/tls/conn.go.html#4473831">b</a></span><span class="op" id="4473904">.</span><span class="ident" id="4473905"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473912">if</span>&nbsp;<span class="ident" id="4473915"><a href="/gostd/crypto/tls/conn.go.html#4473894">m</a></span>&nbsp;<span class="op" id="4473917">==</span>&nbsp;<span class="num" id="4473920">0</span>&nbsp;<span class="op" id="4473922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473926"><a href="/gostd/crypto/tls/conn.go.html#4473894">m</a></span>&nbsp;<span class="op" id="4473928">=</span>&nbsp;<span class="num" id="4473930">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473936">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473939">for</span>&nbsp;<span class="ident" id="4473943"><a href="/gostd/crypto/tls/conn.go.html#4473894">m</a></span>&nbsp;<span class="op" id="4473945">&lt;</span>&nbsp;<span class="ident" id="4473947"><a href="/gostd/crypto/tls/conn.go.html#4473849">n</a></span>&nbsp;<span class="op" id="4473949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473953"><a href="/gostd/crypto/tls/conn.go.html#4473894">m</a></span>&nbsp;<span class="op" id="4473955">*=</span>&nbsp;<span class="num" id="4473958">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4473964">data</span>&nbsp;<span class="op" id="4473969">:=</span>&nbsp;<span class="builtinfunc" id="4473972">make</span><span class="op" id="4473976">(</span><span class="op" id="4473977">[</span><span class="op" id="4473978">]</span><span class="builtintype" id="4473979">byte</span><span class="op" id="4473983">,</span>&nbsp;<span class="builtinfunc" id="4473985">len</span><span class="op" id="4473988">(</span><span class="ident" id="4473989"><a href="/gostd/crypto/tls/conn.go.html#4473831">b</a></span><span class="op" id="4473990">.</span><span class="ident" id="4473991"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4473995">)</span><span class="op" id="4473996">,</span>&nbsp;<span class="ident" id="4473998"><a href="/gostd/crypto/tls/conn.go.html#4473894">m</a></span><span class="op" id="4473999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4474002">copy</span><span class="op" id="4474006">(</span><span class="ident" id="4474007"><a href="/gostd/crypto/tls/conn.go.html#4473964">data</a></span><span class="op" id="4474011">,</span>&nbsp;<span class="ident" id="4474013"><a href="/gostd/crypto/tls/conn.go.html#4473831">b</a></span><span class="op" id="4474014">.</span><span class="ident" id="4474015"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474019">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474022"><a href="/gostd/crypto/tls/conn.go.html#4473831">b</a></span><span class="op" id="4474023">.</span><span class="ident" id="4474024"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span>&nbsp;<span class="op" id="4474029">=</span>&nbsp;<span class="ident" id="4474031"><a href="/gostd/crypto/tls/conn.go.html#4473964">data</a></span><br>
<span class="lineno"></span><span class="op" id="4474036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4474039">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4474110">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4474139">func</span>&nbsp;<span class="op" id="4474144">(</span><span class="ident" id="4474145">b</span>&nbsp;<span class="op" id="4474147">*</span><span class="ident" id="4474148"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4474153">)</span>&nbsp;<span class="ident" id="4474155">readFromUntil</span><span class="op" id="4474168">(</span><span class="ident" id="4474169">r</span>&nbsp;<span class="ident" id="4474171"><a href="/gostd/crypto/tls/conn.go.html#4461783">io</a></span><span class="op" id="4474173">.</span><span class="ident" id="4474174"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><span class="op" id="4474180">,</span>&nbsp;<span class="ident" id="4474182">n</span>&nbsp;<span class="builtintype" id="4474184">int</span><span class="op" id="4474187">)</span>&nbsp;<span class="builtintype" id="4474189">error</span>&nbsp;<span class="op" id="4474195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4474198">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474213">if</span>&nbsp;<span class="builtinfunc" id="4474216">len</span><span class="op" id="4474219">(</span><span class="ident" id="4474220"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474221">.</span><span class="ident" id="4474222"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474226">)</span>&nbsp;<span class="op" id="4474228">&gt;=</span>&nbsp;<span class="ident" id="4474231"><a href="/gostd/crypto/tls/conn.go.html#4474182">n</a></span>&nbsp;<span class="op" id="4474233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474237">return</span>&nbsp;<span class="builtintype" id="4474244">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4474249">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4474253">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474281"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474282">.</span><span class="ident" id="4474283"><a href="/gostd/crypto/tls/conn.go.html#4473841">reserve</a></span><span class="op" id="4474290">(</span><span class="ident" id="4474291"><a href="/gostd/crypto/tls/conn.go.html#4474182">n</a></span><span class="op" id="4474292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474295">for</span>&nbsp;<span class="op" id="4474299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474303">m</span><span class="op" id="4474304">,</span>&nbsp;<span class="ident" id="4474306">err</span>&nbsp;<span class="op" id="4474310">:=</span>&nbsp;<span class="ident" id="4474313"><a href="/gostd/crypto/tls/conn.go.html#4474169">r</a></span><span class="op" id="4474314">.</span><span class="ident" id="4474315"><a href="/gostd/io/io.go.html#1421843">Read</a></span><span class="op" id="4474319">(</span><span class="ident" id="4474320"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474321">.</span><span class="ident" id="4474322"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474326">[</span><span class="builtinfunc" id="4474327">len</span><span class="op" id="4474330">(</span><span class="ident" id="4474331"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474332">.</span><span class="ident" id="4474333"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474337">)</span><span class="op" id="4474338">:</span><span class="builtinfunc" id="4474339">cap</span><span class="op" id="4474342">(</span><span class="ident" id="4474343"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474344">.</span><span class="ident" id="4474345"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474349">)</span><span class="op" id="4474350">]</span><span class="op" id="4474351">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474355"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474356">.</span><span class="ident" id="4474357"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span>&nbsp;<span class="op" id="4474362">=</span>&nbsp;<span class="ident" id="4474364"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474365">.</span><span class="ident" id="4474366"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474370">[</span><span class="num" id="4474371">0</span>&nbsp;<span class="op" id="4474373">:</span>&nbsp;<span class="builtinfunc" id="4474375">len</span><span class="op" id="4474378">(</span><span class="ident" id="4474379"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474380">.</span><span class="ident" id="4474381"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474385">)</span><span class="op" id="4474386">+</span><span class="ident" id="4474387"><a href="/gostd/crypto/tls/conn.go.html#4474303">m</a></span><span class="op" id="4474388">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474392">if</span>&nbsp;<span class="builtinfunc" id="4474395">len</span><span class="op" id="4474398">(</span><span class="ident" id="4474399"><a href="/gostd/crypto/tls/conn.go.html#4474145">b</a></span><span class="op" id="4474400">.</span><span class="ident" id="4474401"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474405">)</span>&nbsp;<span class="op" id="4474407">&gt;=</span>&nbsp;<span class="ident" id="4474410"><a href="/gostd/crypto/tls/conn.go.html#4474182">n</a></span>&nbsp;<span class="op" id="4474412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4474417">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4474463">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474513">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4474521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474525">if</span>&nbsp;<span class="ident" id="4474528"><a href="/gostd/crypto/tls/conn.go.html#4474306">err</a></span>&nbsp;<span class="op" id="4474532">!=</span>&nbsp;<span class="builtintype" id="4474535">nil</span>&nbsp;<span class="op" id="4474539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474544">return</span>&nbsp;<span class="ident" id="4474551"><a href="/gostd/crypto/tls/conn.go.html#4474306">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4474557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4474560">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474563">return</span>&nbsp;<span class="builtintype" id="4474570">nil</span><br>
<span class="lineno"></span><span class="op" id="4474574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4474577">func</span>&nbsp;<span class="op" id="4474582">(</span><span class="ident" id="4474583">b</span>&nbsp;<span class="op" id="4474585">*</span><span class="ident" id="4474586"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4474591">)</span>&nbsp;<span class="ident" id="4474593">Read</span><span class="op" id="4474597">(</span><span class="ident" id="4474598">p</span>&nbsp;<span class="op" id="4474600">[</span><span class="op" id="4474601">]</span><span class="builtintype" id="4474602">byte</span><span class="op" id="4474606">)</span>&nbsp;<span class="op" id="4474608">(</span><span class="ident" id="4474609">n</span>&nbsp;<span class="builtintype" id="4474611">int</span><span class="op" id="4474614">,</span>&nbsp;<span class="ident" id="4474616">err</span>&nbsp;<span class="builtintype" id="4474620">error</span><span class="op" id="4474625">)</span>&nbsp;<span class="op" id="4474627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474630"><a href="/gostd/crypto/tls/conn.go.html#4474609">n</a></span>&nbsp;<span class="op" id="4474632">=</span>&nbsp;<span class="builtinfunc" id="4474634">copy</span><span class="op" id="4474638">(</span><span class="ident" id="4474639"><a href="/gostd/crypto/tls/conn.go.html#4474598">p</a></span><span class="op" id="4474640">,</span>&nbsp;<span class="ident" id="4474642"><a href="/gostd/crypto/tls/conn.go.html#4474583">b</a></span><span class="op" id="4474643">.</span><span class="ident" id="4474644"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4474648">[</span><span class="ident" id="4474649"><a href="/gostd/crypto/tls/conn.go.html#4474583">b</a></span><span class="op" id="4474650">.</span><span class="ident" id="4474651"><a href="/gostd/crypto/tls/conn.go.html#4473550">off</a></span><span class="op" id="4474654">:</span><span class="op" id="4474655">]</span><span class="op" id="4474656">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474659"><a href="/gostd/crypto/tls/conn.go.html#4474583">b</a></span><span class="op" id="4474660">.</span><span class="ident" id="4474661"><a href="/gostd/crypto/tls/conn.go.html#4473550">off</a></span>&nbsp;<span class="op" id="4474665">+=</span>&nbsp;<span class="ident" id="4474668"><a href="/gostd/crypto/tls/conn.go.html#4474609">n</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474671">return</span><br>
<span class="lineno"></span><span class="op" id="4474678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4474681">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4474749">func</span>&nbsp;<span class="op" id="4474754">(</span><span class="ident" id="4474755">hc</span>&nbsp;<span class="op" id="4474758">*</span><span class="ident" id="4474759"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4474767">)</span>&nbsp;<span class="ident" id="4474769">newBlock</span><span class="op" id="4474777">(</span><span class="op" id="4474778">)</span>&nbsp;<span class="op" id="4474780">*</span><span class="ident" id="4474781"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span>&nbsp;<span class="op" id="4474787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474790">b</span>&nbsp;<span class="op" id="4474792">:=</span>&nbsp;<span class="ident" id="4474795"><a href="/gostd/crypto/tls/conn.go.html#4474755">hc</a></span><span class="op" id="4474797">.</span><span class="ident" id="4474798"><a href="/gostd/crypto/tls/conn.go.html#4464832">bfree</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474805">if</span>&nbsp;<span class="ident" id="4474808"><a href="/gostd/crypto/tls/conn.go.html#4474790">b</a></span>&nbsp;<span class="op" id="4474810">==</span>&nbsp;<span class="builtintype" id="4474813">nil</span>&nbsp;<span class="op" id="4474817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474821">return</span>&nbsp;<span class="builtinfunc" id="4474828">new</span><span class="op" id="4474831">(</span><span class="ident" id="4474832"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4474837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4474840">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474843"><a href="/gostd/crypto/tls/conn.go.html#4474755">hc</a></span><span class="op" id="4474845">.</span><span class="ident" id="4474846"><a href="/gostd/crypto/tls/conn.go.html#4464832">bfree</a></span>&nbsp;<span class="op" id="4474852">=</span>&nbsp;<span class="ident" id="4474854"><a href="/gostd/crypto/tls/conn.go.html#4474790">b</a></span><span class="op" id="4474855">.</span><span class="ident" id="4474856"><a href="/gostd/crypto/tls/conn.go.html#4473578">link</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474862"><a href="/gostd/crypto/tls/conn.go.html#4474790">b</a></span><span class="op" id="4474863">.</span><span class="ident" id="4474864"><a href="/gostd/crypto/tls/conn.go.html#4473578">link</a></span>&nbsp;<span class="op" id="4474869">=</span>&nbsp;<span class="builtintype" id="4474871">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4474876"><a href="/gostd/crypto/tls/conn.go.html#4474790">b</a></span><span class="op" id="4474877">.</span><span class="ident" id="4474878"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4474884">(</span><span class="num" id="4474885">0</span><span class="op" id="4474886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4474889">return</span>&nbsp;<span class="ident" id="4474896"><a href="/gostd/crypto/tls/conn.go.html#4474790">b</a></span><br>
<span class="lineno"></span><span class="op" id="4474898">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4474901">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4474949">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4475015">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4475077">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4475104">func</span>&nbsp;<span class="op" id="4475109">(</span><span class="ident" id="4475110">hc</span>&nbsp;<span class="op" id="4475113">*</span><span class="ident" id="4475114"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4475122">)</span>&nbsp;<span class="ident" id="4475124">freeBlock</span><span class="op" id="4475133">(</span><span class="ident" id="4475134">b</span>&nbsp;<span class="op" id="4475136">*</span><span class="ident" id="4475137"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4475142">)</span>&nbsp;<span class="op" id="4475144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475147"><a href="/gostd/crypto/tls/conn.go.html#4475134">b</a></span><span class="op" id="4475148">.</span><span class="ident" id="4475149"><a href="/gostd/crypto/tls/conn.go.html#4473578">link</a></span>&nbsp;<span class="op" id="4475154">=</span>&nbsp;<span class="ident" id="4475156"><a href="/gostd/crypto/tls/conn.go.html#4475110">hc</a></span><span class="op" id="4475158">.</span><span class="ident" id="4475159"><a href="/gostd/crypto/tls/conn.go.html#4464832">bfree</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475166"><a href="/gostd/crypto/tls/conn.go.html#4475110">hc</a></span><span class="op" id="4475168">.</span><span class="ident" id="4475169"><a href="/gostd/crypto/tls/conn.go.html#4464832">bfree</a></span>&nbsp;<span class="op" id="4475175">=</span>&nbsp;<span class="ident" id="4475177"><a href="/gostd/crypto/tls/conn.go.html#4475134">b</a></span><br>
<span class="lineno"></span><span class="op" id="4475179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4475182">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4475236">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4475282">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4475335">func</span>&nbsp;<span class="op" id="4475340">(</span><span class="ident" id="4475341">hc</span>&nbsp;<span class="op" id="4475344">*</span><span class="ident" id="4475345"><a href="/gostd/crypto/tls/conn.go.html#4464608">halfConn</a></span><span class="op" id="4475353">)</span>&nbsp;<span class="ident" id="4475355">splitBlock</span><span class="op" id="4475365">(</span><span class="ident" id="4475366">b</span>&nbsp;<span class="op" id="4475368">*</span><span class="ident" id="4475369"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4475374">,</span>&nbsp;<span class="ident" id="4475376">n</span>&nbsp;<span class="builtintype" id="4475378">int</span><span class="op" id="4475381">)</span>&nbsp;<span class="op" id="4475383">(</span><span class="op" id="4475384">*</span><span class="ident" id="4475385"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4475390">,</span>&nbsp;<span class="op" id="4475392">*</span><span class="ident" id="4475393"><a href="/gostd/crypto/tls/conn.go.html#4473521">block</a></span><span class="op" id="4475398">)</span>&nbsp;<span class="op" id="4475400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4475403">if</span>&nbsp;<span class="builtinfunc" id="4475406">len</span><span class="op" id="4475409">(</span><span class="ident" id="4475410"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475411">.</span><span class="ident" id="4475412"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4475416">)</span>&nbsp;<span class="op" id="4475418">&lt;=</span>&nbsp;<span class="ident" id="4475421"><a href="/gostd/crypto/tls/conn.go.html#4475376">n</a></span>&nbsp;<span class="op" id="4475423">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4475427">return</span>&nbsp;<span class="ident" id="4475434"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475435">,</span>&nbsp;<span class="builtintype" id="4475437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4475442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475445">bb</span>&nbsp;<span class="op" id="4475448">:=</span>&nbsp;<span class="ident" id="4475451"><a href="/gostd/crypto/tls/conn.go.html#4475341">hc</a></span><span class="op" id="4475453">.</span><span class="ident" id="4475454"><a href="/gostd/crypto/tls/conn.go.html#4474769">newBlock</a></span><span class="op" id="4475462">(</span><span class="op" id="4475463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475466"><a href="/gostd/crypto/tls/conn.go.html#4475445">bb</a></span><span class="op" id="4475468">.</span><span class="ident" id="4475469"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4475475">(</span><span class="builtinfunc" id="4475476">len</span><span class="op" id="4475479">(</span><span class="ident" id="4475480"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475481">.</span><span class="ident" id="4475482"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4475486">)</span>&nbsp;<span class="op" id="4475488">-</span>&nbsp;<span class="ident" id="4475490"><a href="/gostd/crypto/tls/conn.go.html#4475376">n</a></span><span class="op" id="4475491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4475494">copy</span><span class="op" id="4475498">(</span><span class="ident" id="4475499"><a href="/gostd/crypto/tls/conn.go.html#4475445">bb</a></span><span class="op" id="4475501">.</span><span class="ident" id="4475502"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4475506">,</span>&nbsp;<span class="ident" id="4475508"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475509">.</span><span class="ident" id="4475510"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4475514">[</span><span class="ident" id="4475515"><a href="/gostd/crypto/tls/conn.go.html#4475376">n</a></span><span class="op" id="4475516">:</span><span class="op" id="4475517">]</span><span class="op" id="4475518">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475521"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475522">.</span><span class="ident" id="4475523"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span>&nbsp;<span class="op" id="4475528">=</span>&nbsp;<span class="ident" id="4475530"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475531">.</span><span class="ident" id="4475532"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4475536">[</span><span class="num" id="4475537">0</span><span class="op" id="4475538">:</span><span class="ident" id="4475539"><a href="/gostd/crypto/tls/conn.go.html#4475376">n</a></span><span class="op" id="4475540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4475543">return</span>&nbsp;<span class="ident" id="4475550"><a href="/gostd/crypto/tls/conn.go.html#4475366">b</a></span><span class="op" id="4475551">,</span>&nbsp;<span class="ident" id="4475553"><a href="/gostd/crypto/tls/conn.go.html#4475445">bb</a></span><br>
<span class="lineno"></span><span class="op" id="4475556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4475559">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4475619">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4475658">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4475694">func</span>&nbsp;<span class="op" id="4475699">(</span><span class="ident" id="4475700">c</span>&nbsp;<span class="op" id="4475702">*</span><span class="ident" id="4475703"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4475707">)</span>&nbsp;<span class="ident" id="4475709">readRecord</span><span class="op" id="4475719">(</span><span class="ident" id="4475720">want</span>&nbsp;<span class="ident" id="4475725"><a href="/gostd/crypto/tls/common.go.html#4442907">recordType</a></span><span class="op" id="4475735">)</span>&nbsp;<span class="builtintype" id="4475737">error</span>&nbsp;<span class="op" id="4475743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4475746">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4475790">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4475841">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4475903">switch</span>&nbsp;<span class="ident" id="4475910"><a href="/gostd/crypto/tls/conn.go.html#4475720">want</a></span>&nbsp;<span class="op" id="4475915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4475918">default</span><span class="op" id="4475925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475929"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4475930">.</span><span class="ident" id="4475931"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4475940">(</span><span class="ident" id="4475941"><a href="/gostd/crypto/tls/alert.go.html#4431016">alertInternalError</a></span><span class="op" id="4475959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4475963">return</span>&nbsp;<span class="ident" id="4475970"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4475971">.</span><span class="ident" id="4475972"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4475974">.</span><span class="ident" id="4475975"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4475989">(</span><span class="ident" id="4475990"><a href="/gostd/crypto/tls/conn.go.html#4461766">errors</a></span><span class="op" id="4475996">.</span><span class="ident" id="4475997"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4476000">(</span><span class="string" id="4476001">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4476037">)</span><span class="op" id="4476038">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476041">case</span>&nbsp;<span class="ident" id="4476046"><a href="/gostd/crypto/tls/common.go.html#4443022">recordTypeHandshake</a></span><span class="op" id="4476065">,</span>&nbsp;<span class="ident" id="4476067"><a href="/gostd/crypto/tls/common.go.html#4442934">recordTypeChangeCipherSpec</a></span><span class="op" id="4476093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476097">if</span>&nbsp;<span class="ident" id="4476100"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476101">.</span><span class="ident" id="4476102"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4476120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4476125"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476126">.</span><span class="ident" id="4476127"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4476136">(</span><span class="ident" id="4476137"><a href="/gostd/crypto/tls/alert.go.html#4431016">alertInternalError</a></span><span class="op" id="4476155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476160">return</span>&nbsp;<span class="ident" id="4476167"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476168">.</span><span class="ident" id="4476169"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4476171">.</span><span class="ident" id="4476172"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4476186">(</span><span class="ident" id="4476187"><a href="/gostd/crypto/tls/conn.go.html#4461766">errors</a></span><span class="op" id="4476193">.</span><span class="ident" id="4476194"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4476197">(</span><span class="string" id="4476198">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4476269">)</span><span class="op" id="4476270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4476274">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476277">case</span>&nbsp;<span class="ident" id="4476282"><a href="/gostd/crypto/tls/common.go.html#4443066">recordTypeApplicationData</a></span><span class="op" id="4476307">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476311">if</span>&nbsp;<span class="op" id="4476314">!</span><span class="ident" id="4476315"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476316">.</span><span class="ident" id="4476317"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4476335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4476340"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476341">.</span><span class="ident" id="4476342"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4476351">(</span><span class="ident" id="4476352"><a href="/gostd/crypto/tls/alert.go.html#4431016">alertInternalError</a></span><span class="op" id="4476370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476375">return</span>&nbsp;<span class="ident" id="4476382"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476383">.</span><span class="ident" id="4476384"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4476386">.</span><span class="ident" id="4476387"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4476401">(</span><span class="ident" id="4476402"><a href="/gostd/crypto/tls/conn.go.html#4461766">errors</a></span><span class="op" id="4476408">.</span><span class="ident" id="4476409"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4476412">(</span><span class="string" id="4476413">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4476479">)</span><span class="op" id="4476480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4476484">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4476487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4476490">Again</span><span class="op" id="4476495">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476498">if</span>&nbsp;<span class="ident" id="4476501"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476502">.</span><span class="ident" id="4476503"><a href="/gostd/crypto/tls/conn.go.html#4463087">rawInput</a></span>&nbsp;<span class="op" id="4476512">==</span>&nbsp;<span class="builtintype" id="4476515">nil</span>&nbsp;<span class="op" id="4476519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4476523"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476524">.</span><span class="ident" id="4476525"><a href="/gostd/crypto/tls/conn.go.html#4463087">rawInput</a></span>&nbsp;<span class="op" id="4476534">=</span>&nbsp;<span class="ident" id="4476536"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476537">.</span><span class="ident" id="4476538"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4476540">.</span><span class="ident" id="4476541"><a href="/gostd/crypto/tls/conn.go.html#4474769">newBlock</a></span><span class="op" id="4476549">(</span><span class="op" id="4476550">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4476553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4476556">b</span>&nbsp;<span class="op" id="4476558">:=</span>&nbsp;<span class="ident" id="4476561"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476562">.</span><span class="ident" id="4476563"><a href="/gostd/crypto/tls/conn.go.html#4463087">rawInput</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476574">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476600">if</span>&nbsp;<span class="ident" id="4476603">err</span>&nbsp;<span class="op" id="4476607">:=</span>&nbsp;<span class="ident" id="4476610"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4476611">.</span><span class="ident" id="4476612"><a href="/gostd/crypto/tls/conn.go.html#4474155">readFromUntil</a></span><span class="op" id="4476625">(</span><span class="ident" id="4476626"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476627">.</span><span class="ident" id="4476628"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4476632">,</span>&nbsp;<span class="ident" id="4476634"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4476649">)</span><span class="op" id="4476650">;</span>&nbsp;<span class="ident" id="4476652"><a href="/gostd/crypto/tls/conn.go.html#4476603">err</a></span>&nbsp;<span class="op" id="4476656">!=</span>&nbsp;<span class="builtintype" id="4476659">nil</span>&nbsp;<span class="op" id="4476663">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476667">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476725">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476779">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476814">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476838">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4476870">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476877">if</span>&nbsp;<span class="ident" id="4476880">e</span><span class="op" id="4476881">,</span>&nbsp;<span class="ident" id="4476883">ok</span>&nbsp;<span class="op" id="4476886">:=</span>&nbsp;<span class="ident" id="4476889"><a href="/gostd/crypto/tls/conn.go.html#4476603">err</a></span><span class="op" id="4476892">.</span><span class="op" id="4476893">(</span><span class="ident" id="4476894"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4476897">.</span><span class="ident" id="4476898"><a href="/gostd/net/net.go.html#3338570">Error</a></span><span class="op" id="4476903">)</span><span class="op" id="4476904">;</span>&nbsp;<span class="op" id="4476906">!</span><span class="ident" id="4476907"><a href="/gostd/crypto/tls/conn.go.html#4476883">ok</a></span>&nbsp;<span class="op" id="4476910">||</span>&nbsp;<span class="op" id="4476913">!</span><span class="ident" id="4476914"><a href="/gostd/crypto/tls/conn.go.html#4476880">e</a></span><span class="op" id="4476915">.</span><span class="ident" id="4476916"><a href="/gostd/net/net.go.html#3338641">Temporary</a></span><span class="op" id="4476925">(</span><span class="op" id="4476926">)</span>&nbsp;<span class="op" id="4476928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4476933"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4476934">.</span><span class="ident" id="4476935"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4476937">.</span><span class="ident" id="4476938"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4476952">(</span><span class="ident" id="4476953"><a href="/gostd/crypto/tls/conn.go.html#4476603">err</a></span><span class="op" id="4476956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4476960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4476964">return</span>&nbsp;<span class="ident" id="4476971"><a href="/gostd/crypto/tls/conn.go.html#4476603">err</a></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4476976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4476979">typ</span>&nbsp;<span class="op" id="4476983">:=</span>&nbsp;<span class="ident" id="4476986"><a href="/gostd/crypto/tls/common.go.html#4442907">recordType</a></span><span class="op" id="4476996">(</span><span class="ident" id="4476997"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4476998">.</span><span class="ident" id="4476999"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4477003">[</span><span class="num" id="4477004">0</span><span class="op" id="4477005">]</span><span class="op" id="4477006">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477010">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477079">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477152">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477224">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477245">if</span>&nbsp;<span class="ident" id="4477248"><a href="/gostd/crypto/tls/conn.go.html#4475720">want</a></span>&nbsp;<span class="op" id="4477253">==</span>&nbsp;<span class="ident" id="4477256"><a href="/gostd/crypto/tls/common.go.html#4443022">recordTypeHandshake</a></span>&nbsp;<span class="op" id="4477276">&amp;&amp;</span>&nbsp;<span class="ident" id="4477279"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4477283">==</span>&nbsp;<span class="num" id="4477286">0x80</span>&nbsp;<span class="op" id="4477291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4477295"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477296">.</span><span class="ident" id="4477297"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4477306">(</span><span class="ident" id="4477307"><a href="/gostd/crypto/tls/alert.go.html#4430936">alertProtocolVersion</a></span><span class="op" id="4477327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477331">return</span>&nbsp;<span class="ident" id="4477338"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477339">.</span><span class="ident" id="4477340"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4477342">.</span><span class="ident" id="4477343"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4477357">(</span><span class="ident" id="4477358"><a href="/gostd/crypto/tls/conn.go.html#4461766">errors</a></span><span class="op" id="4477364">.</span><span class="ident" id="4477365"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4477368">(</span><span class="string" id="4477369">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4477412">)</span><span class="op" id="4477413">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4477416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4477420">vers</span>&nbsp;<span class="op" id="4477425">:=</span>&nbsp;<span class="builtintype" id="4477428">uint16</span><span class="op" id="4477434">(</span><span class="ident" id="4477435"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4477436">.</span><span class="ident" id="4477437"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4477441">[</span><span class="num" id="4477442">1</span><span class="op" id="4477443">]</span><span class="op" id="4477444">)</span><span class="op" id="4477445">&lt;&lt;</span><span class="num" id="4477447">8</span>&nbsp;<span class="op" id="4477449">|</span>&nbsp;<span class="builtintype" id="4477451">uint16</span><span class="op" id="4477457">(</span><span class="ident" id="4477458"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4477459">.</span><span class="ident" id="4477460"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4477464">[</span><span class="num" id="4477465">2</span><span class="op" id="4477466">]</span><span class="op" id="4477467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4477470">n</span>&nbsp;<span class="op" id="4477472">:=</span>&nbsp;<span class="builtintype" id="4477475">int</span><span class="op" id="4477478">(</span><span class="ident" id="4477479"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4477480">.</span><span class="ident" id="4477481"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4477485">[</span><span class="num" id="4477486">3</span><span class="op" id="4477487">]</span><span class="op" id="4477488">)</span><span class="op" id="4477489">&lt;&lt;</span><span class="num" id="4477491">8</span>&nbsp;<span class="op" id="4477493">|</span>&nbsp;<span class="builtintype" id="4477495">int</span><span class="op" id="4477498">(</span><span class="ident" id="4477499"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4477500">.</span><span class="ident" id="4477501"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4477505">[</span><span class="num" id="4477506">4</span><span class="op" id="4477507">]</span><span class="op" id="4477508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477511">if</span>&nbsp;<span class="ident" id="4477514"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477515">.</span><span class="ident" id="4477516"><a href="/gostd/crypto/tls/conn.go.html#4462213">haveVers</a></span>&nbsp;<span class="op" id="4477525">&amp;&amp;</span>&nbsp;<span class="ident" id="4477528"><a href="/gostd/crypto/tls/conn.go.html#4477420">vers</a></span>&nbsp;<span class="op" id="4477533">!=</span>&nbsp;<span class="ident" id="4477536"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477537">.</span><span class="ident" id="4477538"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span>&nbsp;<span class="op" id="4477543">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4477547"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477548">.</span><span class="ident" id="4477549"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4477558">(</span><span class="ident" id="4477559"><a href="/gostd/crypto/tls/alert.go.html#4430936">alertProtocolVersion</a></span><span class="op" id="4477579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477583">return</span>&nbsp;<span class="ident" id="4477590"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477591">.</span><span class="ident" id="4477592"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4477594">.</span><span class="ident" id="4477595"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4477609">(</span><span class="ident" id="4477610"><a href="/gostd/crypto/tls/conn.go.html#4461776">fmt</a></span><span class="op" id="4477613">.</span><span class="ident" id="4477614"><a href="/gostd/fmt/print.go.html#2143886">Errorf</a></span><span class="op" id="4477620">(</span><span class="string" id="4477621">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4477685">,</span>&nbsp;<span class="ident" id="4477687"><a href="/gostd/crypto/tls/conn.go.html#4477420">vers</a></span><span class="op" id="4477691">,</span>&nbsp;<span class="ident" id="4477693"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477694">.</span><span class="ident" id="4477695"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span><span class="op" id="4477699">)</span><span class="op" id="4477700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4477703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477706">if</span>&nbsp;<span class="ident" id="4477709"><a href="/gostd/crypto/tls/conn.go.html#4477470">n</a></span>&nbsp;<span class="op" id="4477711">&gt;</span>&nbsp;<span class="ident" id="4477713"><a href="/gostd/crypto/tls/common.go.html#4442611">maxCiphertext</a></span>&nbsp;<span class="op" id="4477727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4477731"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477732">.</span><span class="ident" id="4477733"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4477742">(</span><span class="ident" id="4477743"><a href="/gostd/crypto/tls/alert.go.html#4430416">alertRecordOverflow</a></span><span class="op" id="4477762">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477766">return</span>&nbsp;<span class="ident" id="4477773"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477774">.</span><span class="ident" id="4477775"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4477777">.</span><span class="ident" id="4477778"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4477792">(</span><span class="ident" id="4477793"><a href="/gostd/crypto/tls/conn.go.html#4461776">fmt</a></span><span class="op" id="4477796">.</span><span class="ident" id="4477797"><a href="/gostd/fmt/print.go.html#2143886">Errorf</a></span><span class="op" id="4477803">(</span><span class="string" id="4477804">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4477851">,</span>&nbsp;<span class="ident" id="4477853"><a href="/gostd/crypto/tls/conn.go.html#4477470">n</a></span><span class="op" id="4477854">)</span><span class="op" id="4477855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4477858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4477861">if</span>&nbsp;<span class="op" id="4477864">!</span><span class="ident" id="4477865"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4477866">.</span><span class="ident" id="4477867"><a href="/gostd/crypto/tls/conn.go.html#4462213">haveVers</a></span>&nbsp;<span class="op" id="4477876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477880">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477921">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4477958">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4478015">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4478052">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4478108">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4478157">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4478213">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478242">if</span>&nbsp;<span class="op" id="4478245">(</span><span class="ident" id="4478246"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4478250">!=</span>&nbsp;<span class="ident" id="4478253"><a href="/gostd/crypto/tls/common.go.html#4442978">recordTypeAlert</a></span>&nbsp;<span class="op" id="4478269">&amp;&amp;</span>&nbsp;<span class="ident" id="4478272"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4478276">!=</span>&nbsp;<span class="ident" id="4478279"><a href="/gostd/crypto/tls/conn.go.html#4475720">want</a></span><span class="op" id="4478283">)</span>&nbsp;<span class="op" id="4478285">||</span>&nbsp;<span class="ident" id="4478288"><a href="/gostd/crypto/tls/conn.go.html#4477420">vers</a></span>&nbsp;<span class="op" id="4478293">&gt;=</span>&nbsp;<span class="num" id="4478296">0x1000</span>&nbsp;<span class="op" id="4478303">||</span>&nbsp;<span class="ident" id="4478306"><a href="/gostd/crypto/tls/conn.go.html#4477470">n</a></span>&nbsp;<span class="op" id="4478308">&gt;=</span>&nbsp;<span class="num" id="4478311">0x3000</span>&nbsp;<span class="op" id="4478318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478323"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478324">.</span><span class="ident" id="4478325"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4478334">(</span><span class="ident" id="4478335"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4478357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478362">return</span>&nbsp;<span class="ident" id="4478369"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478370">.</span><span class="ident" id="4478371"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478373">.</span><span class="ident" id="4478374"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4478388">(</span><span class="ident" id="4478389"><a href="/gostd/crypto/tls/conn.go.html#4461776">fmt</a></span><span class="op" id="4478392">.</span><span class="ident" id="4478393"><a href="/gostd/fmt/print.go.html#2143886">Errorf</a></span><span class="op" id="4478399">(</span><span class="string" id="4478400">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4478454">)</span><span class="op" id="4478455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4478459">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4478462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478465">if</span>&nbsp;<span class="ident" id="4478468">err</span>&nbsp;<span class="op" id="4478472">:=</span>&nbsp;<span class="ident" id="4478475"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478476">.</span><span class="ident" id="4478477"><a href="/gostd/crypto/tls/conn.go.html#4474155">readFromUntil</a></span><span class="op" id="4478490">(</span><span class="ident" id="4478491"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478492">.</span><span class="ident" id="4478493"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4478497">,</span>&nbsp;<span class="ident" id="4478499"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4478514">+</span><span class="ident" id="4478515"><a href="/gostd/crypto/tls/conn.go.html#4477470">n</a></span><span class="op" id="4478516">)</span><span class="op" id="4478517">;</span>&nbsp;<span class="ident" id="4478519"><a href="/gostd/crypto/tls/conn.go.html#4478468">err</a></span>&nbsp;<span class="op" id="4478523">!=</span>&nbsp;<span class="builtintype" id="4478526">nil</span>&nbsp;<span class="op" id="4478530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478534">if</span>&nbsp;<span class="ident" id="4478537"><a href="/gostd/crypto/tls/conn.go.html#4478468">err</a></span>&nbsp;<span class="op" id="4478541">==</span>&nbsp;<span class="ident" id="4478544"><a href="/gostd/crypto/tls/conn.go.html#4461783">io</a></span><span class="op" id="4478546">.</span><span class="ident" id="4478547"><a href="/gostd/io/io.go.html#1419950">EOF</a></span>&nbsp;<span class="op" id="4478551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478556"><a href="/gostd/crypto/tls/conn.go.html#4478468">err</a></span>&nbsp;<span class="op" id="4478560">=</span>&nbsp;<span class="ident" id="4478562"><a href="/gostd/crypto/tls/conn.go.html#4461783">io</a></span><span class="op" id="4478564">.</span><span class="ident" id="4478565"><a href="/gostd/io/io.go.html#1420096">ErrUnexpectedEOF</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4478584">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478588">if</span>&nbsp;<span class="ident" id="4478591">e</span><span class="op" id="4478592">,</span>&nbsp;<span class="ident" id="4478594">ok</span>&nbsp;<span class="op" id="4478597">:=</span>&nbsp;<span class="ident" id="4478600"><a href="/gostd/crypto/tls/conn.go.html#4478468">err</a></span><span class="op" id="4478603">.</span><span class="op" id="4478604">(</span><span class="ident" id="4478605"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4478608">.</span><span class="ident" id="4478609"><a href="/gostd/net/net.go.html#3338570">Error</a></span><span class="op" id="4478614">)</span><span class="op" id="4478615">;</span>&nbsp;<span class="op" id="4478617">!</span><span class="ident" id="4478618"><a href="/gostd/crypto/tls/conn.go.html#4478594">ok</a></span>&nbsp;<span class="op" id="4478621">||</span>&nbsp;<span class="op" id="4478624">!</span><span class="ident" id="4478625"><a href="/gostd/crypto/tls/conn.go.html#4478591">e</a></span><span class="op" id="4478626">.</span><span class="ident" id="4478627"><a href="/gostd/net/net.go.html#3338641">Temporary</a></span><span class="op" id="4478636">(</span><span class="op" id="4478637">)</span>&nbsp;<span class="op" id="4478639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478644"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478645">.</span><span class="ident" id="4478646"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478648">.</span><span class="ident" id="4478649"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4478663">(</span><span class="ident" id="4478664"><a href="/gostd/crypto/tls/conn.go.html#4478468">err</a></span><span class="op" id="4478667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4478671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478675">return</span>&nbsp;<span class="ident" id="4478682"><a href="/gostd/crypto/tls/conn.go.html#4478468">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4478687">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4478691">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478712"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478713">,</span>&nbsp;<span class="ident" id="4478715"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478716">.</span><span class="ident" id="4478717"><a href="/gostd/crypto/tls/conn.go.html#4463087">rawInput</a></span>&nbsp;<span class="op" id="4478726">=</span>&nbsp;<span class="ident" id="4478728"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478729">.</span><span class="ident" id="4478730"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478732">.</span><span class="ident" id="4478733"><a href="/gostd/crypto/tls/conn.go.html#4475355">splitBlock</a></span><span class="op" id="4478743">(</span><span class="ident" id="4478744"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478745">,</span>&nbsp;<span class="ident" id="4478747"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4478762">+</span><span class="ident" id="4478763"><a href="/gostd/crypto/tls/conn.go.html#4477470">n</a></span><span class="op" id="4478764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478767">ok</span><span class="op" id="4478769">,</span>&nbsp;<span class="ident" id="4478771">off</span><span class="op" id="4478774">,</span>&nbsp;<span class="ident" id="4478776">err</span>&nbsp;<span class="op" id="4478780">:=</span>&nbsp;<span class="ident" id="4478783"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478784">.</span><span class="ident" id="4478785"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478787">.</span><span class="ident" id="4478788"><a href="/gostd/crypto/tls/conn.go.html#4468366">decrypt</a></span><span class="op" id="4478795">(</span><span class="ident" id="4478796"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478800">if</span>&nbsp;<span class="op" id="4478803">!</span><span class="ident" id="4478804"><a href="/gostd/crypto/tls/conn.go.html#4478767">ok</a></span>&nbsp;<span class="op" id="4478807">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478811"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478812">.</span><span class="ident" id="4478813"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478815">.</span><span class="ident" id="4478816"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4478830">(</span><span class="ident" id="4478831"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478832">.</span><span class="ident" id="4478833"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4478842">(</span><span class="ident" id="4478843"><a href="/gostd/crypto/tls/conn.go.html#4478776">err</a></span><span class="op" id="4478846">)</span><span class="op" id="4478847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4478850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478853"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478854">.</span><span class="ident" id="4478855"><a href="/gostd/crypto/tls/conn.go.html#4473550">off</a></span>&nbsp;<span class="op" id="4478859">=</span>&nbsp;<span class="ident" id="4478861"><a href="/gostd/crypto/tls/conn.go.html#4478771">off</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478866">data</span>&nbsp;<span class="op" id="4478871">:=</span>&nbsp;<span class="ident" id="4478874"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478875">.</span><span class="ident" id="4478876"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4478880">[</span><span class="ident" id="4478881"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478882">.</span><span class="ident" id="4478883"><a href="/gostd/crypto/tls/conn.go.html#4473550">off</a></span><span class="op" id="4478886">:</span><span class="op" id="4478887">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478890">if</span>&nbsp;<span class="builtinfunc" id="4478893">len</span><span class="op" id="4478896">(</span><span class="ident" id="4478897"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4478901">)</span>&nbsp;<span class="op" id="4478903">&gt;</span>&nbsp;<span class="ident" id="4478905"><a href="/gostd/crypto/tls/common.go.html#4442543">maxPlaintext</a></span>&nbsp;<span class="op" id="4478918">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478922">err</span>&nbsp;<span class="op" id="4478926">:=</span>&nbsp;<span class="ident" id="4478929"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478930">.</span><span class="ident" id="4478931"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4478940">(</span><span class="ident" id="4478941"><a href="/gostd/crypto/tls/alert.go.html#4430416">alertRecordOverflow</a></span><span class="op" id="4478960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4478964"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478965">.</span><span class="ident" id="4478966"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478968">.</span><span class="ident" id="4478969"><a href="/gostd/crypto/tls/conn.go.html#4475124">freeBlock</a></span><span class="op" id="4478978">(</span><span class="ident" id="4478979"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4478980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4478984">return</span>&nbsp;<span class="ident" id="4478991"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4478992">.</span><span class="ident" id="4478993"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4478995">.</span><span class="ident" id="4478996"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479010">(</span><span class="ident" id="4479011"><a href="/gostd/crypto/tls/conn.go.html#4478922">err</a></span><span class="op" id="4479014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479021">switch</span>&nbsp;<span class="ident" id="4479028"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4479032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479035">default</span><span class="op" id="4479042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479046"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479047">.</span><span class="ident" id="4479048"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479050">.</span><span class="ident" id="4479051"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479065">(</span><span class="ident" id="4479066"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479067">.</span><span class="ident" id="4479068"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4479077">(</span><span class="ident" id="4479078"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4479100">)</span><span class="op" id="4479101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479105">case</span>&nbsp;<span class="ident" id="4479110"><a href="/gostd/crypto/tls/common.go.html#4442978">recordTypeAlert</a></span><span class="op" id="4479125">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479129">if</span>&nbsp;<span class="builtinfunc" id="4479132">len</span><span class="op" id="4479135">(</span><span class="ident" id="4479136"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4479140">)</span>&nbsp;<span class="op" id="4479142">!=</span>&nbsp;<span class="num" id="4479145">2</span>&nbsp;<span class="op" id="4479147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479152"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479153">.</span><span class="ident" id="4479154"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479156">.</span><span class="ident" id="4479157"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479171">(</span><span class="ident" id="4479172"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479173">.</span><span class="ident" id="4479174"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4479183">(</span><span class="ident" id="4479184"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4479206">)</span><span class="op" id="4479207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479212">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479224">if</span>&nbsp;<span class="ident" id="4479227"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4479232">(</span><span class="ident" id="4479233"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4479237">[</span><span class="num" id="4479238">1</span><span class="op" id="4479239">]</span><span class="op" id="4479240">)</span>&nbsp;<span class="op" id="4479242">==</span>&nbsp;<span class="ident" id="4479245"><a href="/gostd/crypto/tls/alert.go.html#4430257">alertCloseNotify</a></span>&nbsp;<span class="op" id="4479262">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479267"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479268">.</span><span class="ident" id="4479269"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479271">.</span><span class="ident" id="4479272"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479286">(</span><span class="ident" id="4479287"><a href="/gostd/crypto/tls/conn.go.html#4461783">io</a></span><span class="op" id="4479289">.</span><span class="ident" id="4479290"><a href="/gostd/io/io.go.html#1419950">EOF</a></span><span class="op" id="4479293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479298">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479310">switch</span>&nbsp;<span class="ident" id="4479317"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4479321">[</span><span class="num" id="4479322">0</span><span class="op" id="4479323">]</span>&nbsp;<span class="op" id="4479325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479329">case</span>&nbsp;<span class="ident" id="4479334"><a href="/gostd/crypto/tls/alert.go.html#4430200">alertLevelWarning</a></span><span class="op" id="4479351">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4479356">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479380"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479381">.</span><span class="ident" id="4479382"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479384">.</span><span class="ident" id="4479385"><a href="/gostd/crypto/tls/conn.go.html#4475124">freeBlock</a></span><span class="op" id="4479394">(</span><span class="ident" id="4479395"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4479396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479401">goto</span>&nbsp;<span class="ident" id="4479406"><a href="/gostd/crypto/tls/conn.go.html#4476490">Again</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479414">case</span>&nbsp;<span class="ident" id="4479419"><a href="/gostd/crypto/tls/alert.go.html#4430223">alertLevelError</a></span><span class="op" id="4479434">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479439"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479440">.</span><span class="ident" id="4479441"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479443">.</span><span class="ident" id="4479444"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479458">(</span><span class="op" id="4479459">&amp;</span><span class="ident" id="4479460"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4479463">.</span><span class="ident" id="4479464"><a href="/gostd/net/net.go.html#3341562">OpError</a></span><span class="op" id="4479471">{</span><span class="ident" id="4479472"><a href="/gostd/net/net.go.html#3341659">Op</a></span><span class="op" id="4479474">:</span>&nbsp;<span class="string" id="4479476">&#34;remote&nbsp;error&#34;</span><span class="op" id="4479490">,</span>&nbsp;<span class="ident" id="4479492"><a href="/gostd/net/net.go.html#3341902">Err</a></span><span class="op" id="4479495">:</span>&nbsp;<span class="ident" id="4479497"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4479502">(</span><span class="ident" id="4479503"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4479507">[</span><span class="num" id="4479508">1</span><span class="op" id="4479509">]</span><span class="op" id="4479510">)</span><span class="op" id="4479511">}</span><span class="op" id="4479512">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479516">default</span><span class="op" id="4479523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479528"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479529">.</span><span class="ident" id="4479530"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479532">.</span><span class="ident" id="4479533"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479547">(</span><span class="ident" id="4479548"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479549">.</span><span class="ident" id="4479550"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4479559">(</span><span class="ident" id="4479560"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4479582">)</span><span class="op" id="4479583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479591">case</span>&nbsp;<span class="ident" id="4479596"><a href="/gostd/crypto/tls/common.go.html#4442934">recordTypeChangeCipherSpec</a></span><span class="op" id="4479622">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479626">if</span>&nbsp;<span class="ident" id="4479629"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4479633">!=</span>&nbsp;<span class="ident" id="4479636"><a href="/gostd/crypto/tls/conn.go.html#4475720">want</a></span>&nbsp;<span class="op" id="4479641">||</span>&nbsp;<span class="builtinfunc" id="4479644">len</span><span class="op" id="4479647">(</span><span class="ident" id="4479648"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4479652">)</span>&nbsp;<span class="op" id="4479654">!=</span>&nbsp;<span class="num" id="4479657">1</span>&nbsp;<span class="op" id="4479659">||</span>&nbsp;<span class="ident" id="4479662"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4479666">[</span><span class="num" id="4479667">0</span><span class="op" id="4479668">]</span>&nbsp;<span class="op" id="4479670">!=</span>&nbsp;<span class="num" id="4479673">1</span>&nbsp;<span class="op" id="4479675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479680"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479681">.</span><span class="ident" id="4479682"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479684">.</span><span class="ident" id="4479685"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479699">(</span><span class="ident" id="4479700"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479701">.</span><span class="ident" id="4479702"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4479711">(</span><span class="ident" id="4479712"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4479734">)</span><span class="op" id="4479735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479740">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479752">err</span>&nbsp;<span class="op" id="4479756">:=</span>&nbsp;<span class="ident" id="4479759"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479760">.</span><span class="ident" id="4479761"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479763">.</span><span class="ident" id="4479764"><a href="/gostd/crypto/tls/conn.go.html#4465630">changeCipherSpec</a></span><span class="op" id="4479780">(</span><span class="op" id="4479781">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479785">if</span>&nbsp;<span class="ident" id="4479788"><a href="/gostd/crypto/tls/conn.go.html#4479752">err</a></span>&nbsp;<span class="op" id="4479792">!=</span>&nbsp;<span class="builtintype" id="4479795">nil</span>&nbsp;<span class="op" id="4479799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479804"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479805">.</span><span class="ident" id="4479806"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479808">.</span><span class="ident" id="4479809"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479823">(</span><span class="ident" id="4479824"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479825">.</span><span class="ident" id="4479826"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4479835">(</span><span class="ident" id="4479836"><a href="/gostd/crypto/tls/conn.go.html#4479752">err</a></span><span class="op" id="4479839">.</span><span class="op" id="4479840">(</span><span class="ident" id="4479841"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4479846">)</span><span class="op" id="4479847">)</span><span class="op" id="4479848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479856">case</span>&nbsp;<span class="ident" id="4479861"><a href="/gostd/crypto/tls/common.go.html#4443066">recordTypeApplicationData</a></span><span class="op" id="4479886">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479890">if</span>&nbsp;<span class="ident" id="4479893"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4479897">!=</span>&nbsp;<span class="ident" id="4479900"><a href="/gostd/crypto/tls/conn.go.html#4475720">want</a></span>&nbsp;<span class="op" id="4479905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479910"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479911">.</span><span class="ident" id="4479912"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4479914">.</span><span class="ident" id="4479915"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4479929">(</span><span class="ident" id="4479930"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479931">.</span><span class="ident" id="4479932"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4479941">(</span><span class="ident" id="4479942"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4479964">)</span><span class="op" id="4479965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4479970">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4479978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479982"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4479983">.</span><span class="ident" id="4479984"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span>&nbsp;<span class="op" id="4479990">=</span>&nbsp;<span class="ident" id="4479992"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4479996"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span>&nbsp;<span class="op" id="4479998">=</span>&nbsp;<span class="builtintype" id="4480000">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480006">case</span>&nbsp;<span class="ident" id="4480011"><a href="/gostd/crypto/tls/common.go.html#4443022">recordTypeHandshake</a></span><span class="op" id="4480030">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4480034">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480093">if</span>&nbsp;<span class="ident" id="4480096"><a href="/gostd/crypto/tls/conn.go.html#4476979">typ</a></span>&nbsp;<span class="op" id="4480100">!=</span>&nbsp;<span class="ident" id="4480103"><a href="/gostd/crypto/tls/conn.go.html#4475720">want</a></span>&nbsp;<span class="op" id="4480108">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480113">return</span>&nbsp;<span class="ident" id="4480120"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4480121">.</span><span class="ident" id="4480122"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4480124">.</span><span class="ident" id="4480125"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4480139">(</span><span class="ident" id="4480140"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4480141">.</span><span class="ident" id="4480142"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4480151">(</span><span class="ident" id="4480152"><a href="/gostd/crypto/tls/alert.go.html#4431136">alertNoRenegotiation</a></span><span class="op" id="4480172">)</span><span class="op" id="4480173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4480177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480181"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4480182">.</span><span class="ident" id="4480183"><a href="/gostd/crypto/tls/conn.go.html#4463205">hand</a></span><span class="op" id="4480187">.</span><span class="ident" id="4480188"><a href="/gostd/bytes/buffer.go.html#1387016">Write</a></span><span class="op" id="4480193">(</span><span class="ident" id="4480194"><a href="/gostd/crypto/tls/conn.go.html#4478866">data</a></span><span class="op" id="4480198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4480201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480205">if</span>&nbsp;<span class="ident" id="4480208"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span>&nbsp;<span class="op" id="4480210">!=</span>&nbsp;<span class="builtintype" id="4480213">nil</span>&nbsp;<span class="op" id="4480217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480221"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4480222">.</span><span class="ident" id="4480223"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4480225">.</span><span class="ident" id="4480226"><a href="/gostd/crypto/tls/conn.go.html#4475124">freeBlock</a></span><span class="op" id="4480235">(</span><span class="ident" id="4480236"><a href="/gostd/crypto/tls/conn.go.html#4476556">b</a></span><span class="op" id="4480237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4480240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480243">return</span>&nbsp;<span class="ident" id="4480250"><a href="/gostd/crypto/tls/conn.go.html#4475700">c</a></span><span class="op" id="4480251">.</span><span class="ident" id="4480252"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4480254">.</span><span class="ident" id="4480255"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span><br>
<span class="lineno"></span><span class="op" id="4480259">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4480262">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4480302">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4480323">func</span>&nbsp;<span class="op" id="4480328">(</span><span class="ident" id="4480329">c</span>&nbsp;<span class="op" id="4480331">*</span><span class="ident" id="4480332"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4480336">)</span>&nbsp;<span class="ident" id="4480338">sendAlertLocked</span><span class="op" id="4480353">(</span><span class="ident" id="4480354">err</span>&nbsp;<span class="ident" id="4480358"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4480363">)</span>&nbsp;<span class="builtintype" id="4480365">error</span>&nbsp;<span class="op" id="4480371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480374">switch</span>&nbsp;<span class="ident" id="4480381"><a href="/gostd/crypto/tls/conn.go.html#4480354">err</a></span>&nbsp;<span class="op" id="4480385">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480388">case</span>&nbsp;<span class="ident" id="4480393"><a href="/gostd/crypto/tls/alert.go.html#4431136">alertNoRenegotiation</a></span><span class="op" id="4480413">,</span>&nbsp;<span class="ident" id="4480415"><a href="/gostd/crypto/tls/alert.go.html#4430257">alertCloseNotify</a></span><span class="op" id="4480431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480435"><a href="/gostd/crypto/tls/conn.go.html#4480329">c</a></span><span class="op" id="4480436">.</span><span class="ident" id="4480437"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4480440">[</span><span class="num" id="4480441">0</span><span class="op" id="4480442">]</span>&nbsp;<span class="op" id="4480444">=</span>&nbsp;<span class="ident" id="4480446"><a href="/gostd/crypto/tls/alert.go.html#4430200">alertLevelWarning</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480465">default</span><span class="op" id="4480472">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480476"><a href="/gostd/crypto/tls/conn.go.html#4480329">c</a></span><span class="op" id="4480477">.</span><span class="ident" id="4480478"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4480481">[</span><span class="num" id="4480482">0</span><span class="op" id="4480483">]</span>&nbsp;<span class="op" id="4480485">=</span>&nbsp;<span class="ident" id="4480487"><a href="/gostd/crypto/tls/alert.go.html#4430223">alertLevelError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4480504">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480507"><a href="/gostd/crypto/tls/conn.go.html#4480329">c</a></span><span class="op" id="4480508">.</span><span class="ident" id="4480509"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4480512">[</span><span class="num" id="4480513">1</span><span class="op" id="4480514">]</span>&nbsp;<span class="op" id="4480516">=</span>&nbsp;<span class="builtintype" id="4480518">byte</span><span class="op" id="4480522">(</span><span class="ident" id="4480523"><a href="/gostd/crypto/tls/conn.go.html#4480354">err</a></span><span class="op" id="4480526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480529"><a href="/gostd/crypto/tls/conn.go.html#4480329">c</a></span><span class="op" id="4480530">.</span><span class="ident" id="4480531"><a href="/gostd/crypto/tls/conn.go.html#4481088">writeRecord</a></span><span class="op" id="4480542">(</span><span class="ident" id="4480543"><a href="/gostd/crypto/tls/common.go.html#4442978">recordTypeAlert</a></span><span class="op" id="4480558">,</span>&nbsp;<span class="ident" id="4480560"><a href="/gostd/crypto/tls/conn.go.html#4480329">c</a></span><span class="op" id="4480561">.</span><span class="ident" id="4480562"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4480565">[</span><span class="num" id="4480566">0</span><span class="op" id="4480567">:</span><span class="num" id="4480568">2</span><span class="op" id="4480569">]</span><span class="op" id="4480570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4480573">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480634">if</span>&nbsp;<span class="ident" id="4480637"><a href="/gostd/crypto/tls/conn.go.html#4480354">err</a></span>&nbsp;<span class="op" id="4480641">!=</span>&nbsp;<span class="ident" id="4480644"><a href="/gostd/crypto/tls/alert.go.html#4430257">alertCloseNotify</a></span>&nbsp;<span class="op" id="4480661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480665">return</span>&nbsp;<span class="ident" id="4480672"><a href="/gostd/crypto/tls/conn.go.html#4480329">c</a></span><span class="op" id="4480673">.</span><span class="ident" id="4480674"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4480677">.</span><span class="ident" id="4480678"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4480692">(</span><span class="op" id="4480693">&amp;</span><span class="ident" id="4480694"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4480697">.</span><span class="ident" id="4480698"><a href="/gostd/net/net.go.html#3341562">OpError</a></span><span class="op" id="4480705">{</span><span class="ident" id="4480706"><a href="/gostd/net/net.go.html#3341659">Op</a></span><span class="op" id="4480708">:</span>&nbsp;<span class="string" id="4480710">&#34;local&nbsp;error&#34;</span><span class="op" id="4480723">,</span>&nbsp;<span class="ident" id="4480725"><a href="/gostd/net/net.go.html#3341902">Err</a></span><span class="op" id="4480728">:</span>&nbsp;<span class="ident" id="4480730"><a href="/gostd/crypto/tls/conn.go.html#4480354">err</a></span><span class="op" id="4480733">}</span><span class="op" id="4480734">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4480737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480740">return</span>&nbsp;<span class="builtintype" id="4480747">nil</span><br>
<span class="lineno"></span><span class="op" id="4480751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4480754">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4480794">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4480814">func</span>&nbsp;<span class="op" id="4480819">(</span><span class="ident" id="4480820">c</span>&nbsp;<span class="op" id="4480822">*</span><span class="ident" id="4480823"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4480827">)</span>&nbsp;<span class="ident" id="4480829">sendAlert</span><span class="op" id="4480838">(</span><span class="ident" id="4480839">err</span>&nbsp;<span class="ident" id="4480843"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4480848">)</span>&nbsp;<span class="builtintype" id="4480850">error</span>&nbsp;<span class="op" id="4480856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4480859"><a href="/gostd/crypto/tls/conn.go.html#4480820">c</a></span><span class="op" id="4480860">.</span><span class="ident" id="4480861"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4480864">.</span><span class="ident" id="4480865"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4480869">(</span><span class="op" id="4480870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480873">defer</span>&nbsp;<span class="ident" id="4480879"><a href="/gostd/crypto/tls/conn.go.html#4480820">c</a></span><span class="op" id="4480880">.</span><span class="ident" id="4480881"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4480884">.</span><span class="ident" id="4480885"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4480891">(</span><span class="op" id="4480892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4480895">return</span>&nbsp;<span class="ident" id="4480902"><a href="/gostd/crypto/tls/conn.go.html#4480820">c</a></span><span class="op" id="4480903">.</span><span class="ident" id="4480904"><a href="/gostd/crypto/tls/conn.go.html#4480338">sendAlertLocked</a></span><span class="op" id="4480919">(</span><span class="ident" id="4480920"><a href="/gostd/crypto/tls/conn.go.html#4480839">err</a></span><span class="op" id="4480923">)</span><br>
<span class="lineno">690</span><span class="op" id="4480925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4480928">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4480995">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4481052">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4481073">func</span>&nbsp;<span class="op" id="4481078">(</span><span class="ident" id="4481079">c</span>&nbsp;<span class="op" id="4481081">*</span><span class="ident" id="4481082"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4481086">)</span>&nbsp;<span class="ident" id="4481088">writeRecord</span><span class="op" id="4481099">(</span><span class="ident" id="4481100">typ</span>&nbsp;<span class="ident" id="4481104"><a href="/gostd/crypto/tls/common.go.html#4442907">recordType</a></span><span class="op" id="4481114">,</span>&nbsp;<span class="ident" id="4481116">data</span>&nbsp;<span class="op" id="4481121">[</span><span class="op" id="4481122">]</span><span class="builtintype" id="4481123">byte</span><span class="op" id="4481127">)</span>&nbsp;<span class="op" id="4481129">(</span><span class="ident" id="4481130">n</span>&nbsp;<span class="builtintype" id="4481132">int</span><span class="op" id="4481135">,</span>&nbsp;<span class="ident" id="4481137">err</span>&nbsp;<span class="builtintype" id="4481141">error</span><span class="op" id="4481146">)</span>&nbsp;<span class="op" id="4481148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481151">b</span>&nbsp;<span class="op" id="4481153">:=</span>&nbsp;<span class="ident" id="4481156"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4481157">.</span><span class="ident" id="4481158"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4481161">.</span><span class="ident" id="4481162"><a href="/gostd/crypto/tls/conn.go.html#4474769">newBlock</a></span><span class="op" id="4481170">(</span><span class="op" id="4481171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481174">for</span>&nbsp;<span class="builtinfunc" id="4481178">len</span><span class="op" id="4481181">(</span><span class="ident" id="4481182"><a href="/gostd/crypto/tls/conn.go.html#4481116">data</a></span><span class="op" id="4481186">)</span>&nbsp;<span class="op" id="4481188">&gt;</span>&nbsp;<span class="num" id="4481190">0</span>&nbsp;<span class="op" id="4481192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481196">m</span>&nbsp;<span class="op" id="4481198">:=</span>&nbsp;<span class="builtinfunc" id="4481201">len</span><span class="op" id="4481204">(</span><span class="ident" id="4481205"><a href="/gostd/crypto/tls/conn.go.html#4481116">data</a></span><span class="op" id="4481209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481213">if</span>&nbsp;<span class="ident" id="4481216"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span>&nbsp;<span class="op" id="4481218">&gt;</span>&nbsp;<span class="ident" id="4481220"><a href="/gostd/crypto/tls/common.go.html#4442543">maxPlaintext</a></span>&nbsp;<span class="op" id="4481233">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481238"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span>&nbsp;<span class="op" id="4481240">=</span>&nbsp;<span class="ident" id="4481242"><a href="/gostd/crypto/tls/common.go.html#4442543">maxPlaintext</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4481257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481261">explicitIVLen</span>&nbsp;<span class="op" id="4481275">:=</span>&nbsp;<span class="num" id="4481278">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481282">explicitIVIsSeq</span>&nbsp;<span class="op" id="4481298">:=</span>&nbsp;<span class="builtintype" id="4481301">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481310">var</span>&nbsp;<span class="ident" id="4481314">cbc</span>&nbsp;<span class="ident" id="4481318"><a href="/gostd/crypto/tls/conn.go.html#4468065">cbcMode</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481328">if</span>&nbsp;<span class="ident" id="4481331"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4481332">.</span><span class="ident" id="4481333"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4481336">.</span><span class="ident" id="4481337"><a href="/gostd/crypto/tls/conn.go.html#4464686">version</a></span>&nbsp;<span class="op" id="4481345">&gt;=</span>&nbsp;<span class="ident" id="4481348"><a href="/gostd/crypto/tls/common.go.html#4442486">VersionTLS11</a></span>&nbsp;<span class="op" id="4481361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481366">var</span>&nbsp;<span class="ident" id="4481370">ok</span>&nbsp;<span class="builtintype" id="4481373">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481381">if</span>&nbsp;<span class="ident" id="4481384"><a href="/gostd/crypto/tls/conn.go.html#4481314">cbc</a></span><span class="op" id="4481387">,</span>&nbsp;<span class="ident" id="4481389"><a href="/gostd/crypto/tls/conn.go.html#4481370">ok</a></span>&nbsp;<span class="op" id="4481392">=</span>&nbsp;<span class="ident" id="4481394"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4481395">.</span><span class="ident" id="4481396"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4481399">.</span><span class="ident" id="4481400"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span><span class="op" id="4481406">.</span><span class="op" id="4481407">(</span><span class="ident" id="4481408"><a href="/gostd/crypto/tls/conn.go.html#4468065">cbcMode</a></span><span class="op" id="4481415">)</span><span class="op" id="4481416">;</span>&nbsp;<span class="ident" id="4481418"><a href="/gostd/crypto/tls/conn.go.html#4481370">ok</a></span>&nbsp;<span class="op" id="4481421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481427"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span>&nbsp;<span class="op" id="4481441">=</span>&nbsp;<span class="ident" id="4481443"><a href="/gostd/crypto/tls/conn.go.html#4481314">cbc</a></span><span class="op" id="4481446">.</span><span class="ident" id="4481447"><a href="/gostd/crypto/cipher/cipher.go.html#4411437">BlockSize</a></span><span class="op" id="4481456">(</span><span class="op" id="4481457">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4481462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4481466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481470">if</span>&nbsp;<span class="ident" id="4481473"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span>&nbsp;<span class="op" id="4481487">==</span>&nbsp;<span class="num" id="4481490">0</span>&nbsp;<span class="op" id="4481492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481497">if</span>&nbsp;<span class="ident" id="4481500">_</span><span class="op" id="4481501">,</span>&nbsp;<span class="ident" id="4481503">ok</span>&nbsp;<span class="op" id="4481506">:=</span>&nbsp;<span class="ident" id="4481509"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4481510">.</span><span class="ident" id="4481511"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4481514">.</span><span class="ident" id="4481515"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span><span class="op" id="4481521">.</span><span class="op" id="4481522">(</span><span class="ident" id="4481523"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4481529">.</span><span class="ident" id="4481530"><a href="/gostd/crypto/cipher/gcm.go.html#4413722">AEAD</a></span><span class="op" id="4481534">)</span><span class="op" id="4481535">;</span>&nbsp;<span class="ident" id="4481537"><a href="/gostd/crypto/tls/conn.go.html#4481503">ok</a></span>&nbsp;<span class="op" id="4481540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481546"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span>&nbsp;<span class="op" id="4481560">=</span>&nbsp;<span class="num" id="4481562">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481568">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481614">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481661">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481711">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481758">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481809">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481830"><a href="/gostd/crypto/tls/conn.go.html#4481282">explicitIVIsSeq</a></span>&nbsp;<span class="op" id="4481846">=</span>&nbsp;<span class="builtintype" id="4481848">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4481856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4481860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481864"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4481865">.</span><span class="ident" id="4481866"><a href="/gostd/crypto/tls/conn.go.html#4473670">resize</a></span><span class="op" id="4481872">(</span><span class="ident" id="4481873"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4481889">+</span>&nbsp;<span class="ident" id="4481891"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span>&nbsp;<span class="op" id="4481905">+</span>&nbsp;<span class="ident" id="4481907"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span><span class="op" id="4481908">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481912"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4481913">.</span><span class="ident" id="4481914"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4481918">[</span><span class="num" id="4481919">0</span><span class="op" id="4481920">]</span>&nbsp;<span class="op" id="4481922">=</span>&nbsp;<span class="builtintype" id="4481924">byte</span><span class="op" id="4481928">(</span><span class="ident" id="4481929"><a href="/gostd/crypto/tls/conn.go.html#4481100">typ</a></span><span class="op" id="4481932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4481936">vers</span>&nbsp;<span class="op" id="4481941">:=</span>&nbsp;<span class="ident" id="4481944"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4481945">.</span><span class="ident" id="4481946"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4481953">if</span>&nbsp;<span class="ident" id="4481956"><a href="/gostd/crypto/tls/conn.go.html#4481936">vers</a></span>&nbsp;<span class="op" id="4481961">==</span>&nbsp;<span class="num" id="4481964">0</span>&nbsp;<span class="op" id="4481966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4481971">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4482024">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482080"><a href="/gostd/crypto/tls/conn.go.html#4481936">vers</a></span>&nbsp;<span class="op" id="4482085">=</span>&nbsp;<span class="ident" id="4482087"><a href="/gostd/crypto/tls/common.go.html#4442463">VersionTLS10</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482106"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482107">.</span><span class="ident" id="4482108"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482112">[</span><span class="num" id="4482113">1</span><span class="op" id="4482114">]</span>&nbsp;<span class="op" id="4482116">=</span>&nbsp;<span class="builtintype" id="4482118">byte</span><span class="op" id="4482122">(</span><span class="ident" id="4482123"><a href="/gostd/crypto/tls/conn.go.html#4481936">vers</a></span>&nbsp;<span class="op" id="4482128">&gt;&gt;</span>&nbsp;<span class="num" id="4482131">8</span><span class="op" id="4482132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482136"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482137">.</span><span class="ident" id="4482138"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482142">[</span><span class="num" id="4482143">2</span><span class="op" id="4482144">]</span>&nbsp;<span class="op" id="4482146">=</span>&nbsp;<span class="builtintype" id="4482148">byte</span><span class="op" id="4482152">(</span><span class="ident" id="4482153"><a href="/gostd/crypto/tls/conn.go.html#4481936">vers</a></span><span class="op" id="4482157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482161"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482162">.</span><span class="ident" id="4482163"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482167">[</span><span class="num" id="4482168">3</span><span class="op" id="4482169">]</span>&nbsp;<span class="op" id="4482171">=</span>&nbsp;<span class="builtintype" id="4482173">byte</span><span class="op" id="4482177">(</span><span class="ident" id="4482178"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span>&nbsp;<span class="op" id="4482180">&gt;&gt;</span>&nbsp;<span class="num" id="4482183">8</span><span class="op" id="4482184">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482188"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482189">.</span><span class="ident" id="4482190"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482194">[</span><span class="num" id="4482195">4</span><span class="op" id="4482196">]</span>&nbsp;<span class="op" id="4482198">=</span>&nbsp;<span class="builtintype" id="4482200">byte</span><span class="op" id="4482204">(</span><span class="ident" id="4482205"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span><span class="op" id="4482206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482210">if</span>&nbsp;<span class="ident" id="4482213"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span>&nbsp;<span class="op" id="4482227">&gt;</span>&nbsp;<span class="num" id="4482229">0</span>&nbsp;<span class="op" id="4482231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482236">explicitIV</span>&nbsp;<span class="op" id="4482247">:=</span>&nbsp;<span class="ident" id="4482250"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482251">.</span><span class="ident" id="4482252"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482256">[</span><span class="ident" id="4482257"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span>&nbsp;<span class="op" id="4482273">:</span>&nbsp;<span class="ident" id="4482275"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4482290">+</span><span class="ident" id="4482291"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span><span class="op" id="4482304">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482309">if</span>&nbsp;<span class="ident" id="4482312"><a href="/gostd/crypto/tls/conn.go.html#4481282">explicitIVIsSeq</a></span>&nbsp;<span class="op" id="4482328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4482334">copy</span><span class="op" id="4482338">(</span><span class="ident" id="4482339"><a href="/gostd/crypto/tls/conn.go.html#4482236">explicitIV</a></span><span class="op" id="4482349">,</span>&nbsp;<span class="ident" id="4482351"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482352">.</span><span class="ident" id="4482353"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4482356">.</span><span class="ident" id="4482357"><a href="/gostd/crypto/tls/conn.go.html#4464789">seq</a></span><span class="op" id="4482360">[</span><span class="op" id="4482361">:</span><span class="op" id="4482362">]</span><span class="op" id="4482363">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482368">}</span>&nbsp;<span class="keyword" id="4482370">else</span>&nbsp;<span class="op" id="4482375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482381">if</span>&nbsp;<span class="ident" id="4482384">_</span><span class="op" id="4482385">,</span>&nbsp;<span class="ident" id="4482387"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span>&nbsp;<span class="op" id="4482391">=</span>&nbsp;<span class="ident" id="4482393"><a href="/gostd/crypto/tls/conn.go.html#4461783">io</a></span><span class="op" id="4482395">.</span><span class="ident" id="4482396"><a href="/gostd/io/io.go.html#1429706">ReadFull</a></span><span class="op" id="4482404">(</span><span class="ident" id="4482405"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482406">.</span><span class="ident" id="4482407"><a href="/gostd/crypto/tls/conn.go.html#4462274">config</a></span><span class="op" id="4482413">.</span><span class="ident" id="4482414"><a href="/gostd/crypto/tls/common.go.html#4455096">rand</a></span><span class="op" id="4482418">(</span><span class="op" id="4482419">)</span><span class="op" id="4482420">,</span>&nbsp;<span class="ident" id="4482422"><a href="/gostd/crypto/tls/conn.go.html#4482236">explicitIV</a></span><span class="op" id="4482432">)</span><span class="op" id="4482433">;</span>&nbsp;<span class="ident" id="4482435"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span>&nbsp;<span class="op" id="4482439">!=</span>&nbsp;<span class="builtintype" id="4482442">nil</span>&nbsp;<span class="op" id="4482446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482453">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482468">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4482476">copy</span><span class="op" id="4482480">(</span><span class="ident" id="4482481"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482482">.</span><span class="ident" id="4482483"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482487">[</span><span class="ident" id="4482488"><a href="/gostd/crypto/tls/common.go.html#4442680">recordHeaderLen</a></span><span class="op" id="4482503">+</span><span class="ident" id="4482504"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span><span class="op" id="4482517">:</span><span class="op" id="4482518">]</span><span class="op" id="4482519">,</span>&nbsp;<span class="ident" id="4482521"><a href="/gostd/crypto/tls/conn.go.html#4481116">data</a></span><span class="op" id="4482525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482529"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482530">.</span><span class="ident" id="4482531"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4482534">.</span><span class="ident" id="4482535"><a href="/gostd/crypto/tls/conn.go.html#4471824">encrypt</a></span><span class="op" id="4482542">(</span><span class="ident" id="4482543"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482544">,</span>&nbsp;<span class="ident" id="4482546"><a href="/gostd/crypto/tls/conn.go.html#4481261">explicitIVLen</a></span><span class="op" id="4482559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482563">_</span><span class="op" id="4482564">,</span>&nbsp;<span class="ident" id="4482566"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span>&nbsp;<span class="op" id="4482570">=</span>&nbsp;<span class="ident" id="4482572"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482573">.</span><span class="ident" id="4482574"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4482578">.</span><span class="ident" id="4482579"><a href="/gostd/net/net.go.html#3334839">Write</a></span><span class="op" id="4482584">(</span><span class="ident" id="4482585"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482586">.</span><span class="ident" id="4482587"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4482591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482595">if</span>&nbsp;<span class="ident" id="4482598"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span>&nbsp;<span class="op" id="4482602">!=</span>&nbsp;<span class="builtintype" id="4482605">nil</span>&nbsp;<span class="op" id="4482609">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482614">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482626"><a href="/gostd/crypto/tls/conn.go.html#4481130">n</a></span>&nbsp;<span class="op" id="4482628">+=</span>&nbsp;<span class="ident" id="4482631"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482635"><a href="/gostd/crypto/tls/conn.go.html#4481116">data</a></span>&nbsp;<span class="op" id="4482640">=</span>&nbsp;<span class="ident" id="4482642"><a href="/gostd/crypto/tls/conn.go.html#4481116">data</a></span><span class="op" id="4482646">[</span><span class="ident" id="4482647"><a href="/gostd/crypto/tls/conn.go.html#4481196">m</a></span><span class="op" id="4482648">:</span><span class="op" id="4482649">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4482652">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482655"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482656">.</span><span class="ident" id="4482657"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4482660">.</span><span class="ident" id="4482661"><a href="/gostd/crypto/tls/conn.go.html#4475124">freeBlock</a></span><span class="op" id="4482670">(</span><span class="ident" id="4482671"><a href="/gostd/crypto/tls/conn.go.html#4481151">b</a></span><span class="op" id="4482672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482676">if</span>&nbsp;<span class="ident" id="4482679"><a href="/gostd/crypto/tls/conn.go.html#4481100">typ</a></span>&nbsp;<span class="op" id="4482683">==</span>&nbsp;<span class="ident" id="4482686"><a href="/gostd/crypto/tls/common.go.html#4442934">recordTypeChangeCipherSpec</a></span>&nbsp;<span class="op" id="4482713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482717"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span>&nbsp;<span class="op" id="4482721">=</span>&nbsp;<span class="ident" id="4482723"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482724">.</span><span class="ident" id="4482725"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4482728">.</span><span class="ident" id="4482729"><a href="/gostd/crypto/tls/conn.go.html#4465630">changeCipherSpec</a></span><span class="op" id="4482745">(</span><span class="op" id="4482746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482750">if</span>&nbsp;<span class="ident" id="4482753"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span>&nbsp;<span class="op" id="4482757">!=</span>&nbsp;<span class="builtintype" id="4482760">nil</span>&nbsp;<span class="op" id="4482764">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4482769">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4482807">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482850"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482851">.</span><span class="ident" id="4482852"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4482855">[</span><span class="num" id="4482856">0</span><span class="op" id="4482857">]</span>&nbsp;<span class="op" id="4482859">=</span>&nbsp;<span class="ident" id="4482861"><a href="/gostd/crypto/tls/alert.go.html#4430223">alertLevelError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482880"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482881">.</span><span class="ident" id="4482882"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4482885">[</span><span class="num" id="4482886">1</span><span class="op" id="4482887">]</span>&nbsp;<span class="op" id="4482889">=</span>&nbsp;<span class="builtintype" id="4482891">byte</span><span class="op" id="4482895">(</span><span class="ident" id="4482896"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span><span class="op" id="4482899">.</span><span class="op" id="4482900">(</span><span class="ident" id="4482901"><a href="/gostd/crypto/tls/alert.go.html#4430162">alert</a></span><span class="op" id="4482906">)</span><span class="op" id="4482907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4482912"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482913">.</span><span class="ident" id="4482914"><a href="/gostd/crypto/tls/conn.go.html#4481088">writeRecord</a></span><span class="op" id="4482925">(</span><span class="ident" id="4482926"><a href="/gostd/crypto/tls/common.go.html#4442978">recordTypeAlert</a></span><span class="op" id="4482941">,</span>&nbsp;<span class="ident" id="4482943"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482944">.</span><span class="ident" id="4482945"><a href="/gostd/crypto/tls/conn.go.html#4463266">tmp</a></span><span class="op" id="4482948">[</span><span class="num" id="4482949">0</span><span class="op" id="4482950">:</span><span class="num" id="4482951">2</span><span class="op" id="4482952">]</span><span class="op" id="4482953">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4482958">return</span>&nbsp;<span class="ident" id="4482965"><a href="/gostd/crypto/tls/conn.go.html#4481130">n</a></span><span class="op" id="4482966">,</span>&nbsp;<span class="ident" id="4482968"><a href="/gostd/crypto/tls/conn.go.html#4481079">c</a></span><span class="op" id="4482969">.</span><span class="ident" id="4482970"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4482973">.</span><span class="ident" id="4482974"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4482988">(</span><span class="op" id="4482989">&amp;</span><span class="ident" id="4482990"><a href="/gostd/crypto/tls/conn.go.html#4461789">net</a></span><span class="op" id="4482993">.</span><span class="ident" id="4482994"><a href="/gostd/net/net.go.html#3341562">OpError</a></span><span class="op" id="4483001">{</span><span class="ident" id="4483002"><a href="/gostd/net/net.go.html#3341659">Op</a></span><span class="op" id="4483004">:</span>&nbsp;<span class="string" id="4483006">&#34;local&nbsp;error&#34;</span><span class="op" id="4483019">,</span>&nbsp;<span class="ident" id="4483021"><a href="/gostd/net/net.go.html#3341902">Err</a></span><span class="op" id="4483024">:</span>&nbsp;<span class="ident" id="4483026"><a href="/gostd/crypto/tls/conn.go.html#4481137">err</a></span><span class="op" id="4483029">}</span><span class="op" id="4483030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483040">return</span><br>
<span class="lineno"></span><span class="op" id="4483047">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4483050">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4483105">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4483126">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4483162">func</span>&nbsp;<span class="op" id="4483167">(</span><span class="ident" id="4483168">c</span>&nbsp;<span class="op" id="4483170">*</span><span class="ident" id="4483171"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4483175">)</span>&nbsp;<span class="ident" id="4483177">readHandshake</span><span class="op" id="4483190">(</span><span class="op" id="4483191">)</span>&nbsp;<span class="op" id="4483193">(</span><span class="keyword" id="4483194">interface</span><span class="op" id="4483203">{</span><span class="op" id="4483204">}</span><span class="op" id="4483205">,</span>&nbsp;<span class="builtintype" id="4483207">error</span><span class="op" id="4483212">)</span>&nbsp;<span class="op" id="4483214">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483217">for</span>&nbsp;<span class="ident" id="4483221"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483222">.</span><span class="ident" id="4483223"><a href="/gostd/crypto/tls/conn.go.html#4463205">hand</a></span><span class="op" id="4483227">.</span><span class="ident" id="4483228"><a href="/gostd/bytes/buffer.go.html#1384893">Len</a></span><span class="op" id="4483231">(</span><span class="op" id="4483232">)</span>&nbsp;<span class="op" id="4483234">&lt;</span>&nbsp;<span class="num" id="4483236">4</span>&nbsp;<span class="op" id="4483238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483242">if</span>&nbsp;<span class="ident" id="4483245">err</span>&nbsp;<span class="op" id="4483249">:=</span>&nbsp;<span class="ident" id="4483252"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483253">.</span><span class="ident" id="4483254"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4483256">.</span><span class="ident" id="4483257"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span><span class="op" id="4483260">;</span>&nbsp;<span class="ident" id="4483262"><a href="/gostd/crypto/tls/conn.go.html#4483245">err</a></span>&nbsp;<span class="op" id="4483266">!=</span>&nbsp;<span class="builtintype" id="4483269">nil</span>&nbsp;<span class="op" id="4483273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483278">return</span>&nbsp;<span class="builtintype" id="4483285">nil</span><span class="op" id="4483288">,</span>&nbsp;<span class="ident" id="4483290"><a href="/gostd/crypto/tls/conn.go.html#4483245">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483300">if</span>&nbsp;<span class="ident" id="4483303">err</span>&nbsp;<span class="op" id="4483307">:=</span>&nbsp;<span class="ident" id="4483310"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483311">.</span><span class="ident" id="4483312"><a href="/gostd/crypto/tls/conn.go.html#4475709">readRecord</a></span><span class="op" id="4483322">(</span><span class="ident" id="4483323"><a href="/gostd/crypto/tls/common.go.html#4443022">recordTypeHandshake</a></span><span class="op" id="4483342">)</span><span class="op" id="4483343">;</span>&nbsp;<span class="ident" id="4483345"><a href="/gostd/crypto/tls/conn.go.html#4483303">err</a></span>&nbsp;<span class="op" id="4483349">!=</span>&nbsp;<span class="builtintype" id="4483352">nil</span>&nbsp;<span class="op" id="4483356">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483361">return</span>&nbsp;<span class="builtintype" id="4483368">nil</span><span class="op" id="4483371">,</span>&nbsp;<span class="ident" id="4483373"><a href="/gostd/crypto/tls/conn.go.html#4483303">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483386">data</span>&nbsp;<span class="op" id="4483391">:=</span>&nbsp;<span class="ident" id="4483394"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483395">.</span><span class="ident" id="4483396"><a href="/gostd/crypto/tls/conn.go.html#4463205">hand</a></span><span class="op" id="4483400">.</span><span class="ident" id="4483401"><a href="/gostd/bytes/buffer.go.html#1384454">Bytes</a></span><span class="op" id="4483406">(</span><span class="op" id="4483407">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483410">n</span>&nbsp;<span class="op" id="4483412">:=</span>&nbsp;<span class="builtintype" id="4483415">int</span><span class="op" id="4483418">(</span><span class="ident" id="4483419"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span><span class="op" id="4483423">[</span><span class="num" id="4483424">1</span><span class="op" id="4483425">]</span><span class="op" id="4483426">)</span><span class="op" id="4483427">&lt;&lt;</span><span class="num" id="4483429">16</span>&nbsp;<span class="op" id="4483432">|</span>&nbsp;<span class="builtintype" id="4483434">int</span><span class="op" id="4483437">(</span><span class="ident" id="4483438"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span><span class="op" id="4483442">[</span><span class="num" id="4483443">2</span><span class="op" id="4483444">]</span><span class="op" id="4483445">)</span><span class="op" id="4483446">&lt;&lt;</span><span class="num" id="4483448">8</span>&nbsp;<span class="op" id="4483450">|</span>&nbsp;<span class="builtintype" id="4483452">int</span><span class="op" id="4483455">(</span><span class="ident" id="4483456"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span><span class="op" id="4483460">[</span><span class="num" id="4483461">3</span><span class="op" id="4483462">]</span><span class="op" id="4483463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483466">if</span>&nbsp;<span class="ident" id="4483469"><a href="/gostd/crypto/tls/conn.go.html#4483410">n</a></span>&nbsp;<span class="op" id="4483471">&gt;</span>&nbsp;<span class="ident" id="4483473"><a href="/gostd/crypto/tls/common.go.html#4442736">maxHandshake</a></span>&nbsp;<span class="op" id="4483486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483490">return</span>&nbsp;<span class="builtintype" id="4483497">nil</span><span class="op" id="4483500">,</span>&nbsp;<span class="ident" id="4483502"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483503">.</span><span class="ident" id="4483504"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4483506">.</span><span class="ident" id="4483507"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4483521">(</span><span class="ident" id="4483522"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483523">.</span><span class="ident" id="4483524"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4483533">(</span><span class="ident" id="4483534"><a href="/gostd/crypto/tls/alert.go.html#4431016">alertInternalError</a></span><span class="op" id="4483552">)</span><span class="op" id="4483553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483559">for</span>&nbsp;<span class="ident" id="4483563"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483564">.</span><span class="ident" id="4483565"><a href="/gostd/crypto/tls/conn.go.html#4463205">hand</a></span><span class="op" id="4483569">.</span><span class="ident" id="4483570"><a href="/gostd/bytes/buffer.go.html#1384893">Len</a></span><span class="op" id="4483573">(</span><span class="op" id="4483574">)</span>&nbsp;<span class="op" id="4483576">&lt;</span>&nbsp;<span class="num" id="4483578">4</span><span class="op" id="4483579">+</span><span class="ident" id="4483580"><a href="/gostd/crypto/tls/conn.go.html#4483410">n</a></span>&nbsp;<span class="op" id="4483582">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483586">if</span>&nbsp;<span class="ident" id="4483589">err</span>&nbsp;<span class="op" id="4483593">:=</span>&nbsp;<span class="ident" id="4483596"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483597">.</span><span class="ident" id="4483598"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4483600">.</span><span class="ident" id="4483601"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span><span class="op" id="4483604">;</span>&nbsp;<span class="ident" id="4483606"><a href="/gostd/crypto/tls/conn.go.html#4483589">err</a></span>&nbsp;<span class="op" id="4483610">!=</span>&nbsp;<span class="builtintype" id="4483613">nil</span>&nbsp;<span class="op" id="4483617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483622">return</span>&nbsp;<span class="builtintype" id="4483629">nil</span><span class="op" id="4483632">,</span>&nbsp;<span class="ident" id="4483634"><a href="/gostd/crypto/tls/conn.go.html#4483589">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483644">if</span>&nbsp;<span class="ident" id="4483647">err</span>&nbsp;<span class="op" id="4483651">:=</span>&nbsp;<span class="ident" id="4483654"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483655">.</span><span class="ident" id="4483656"><a href="/gostd/crypto/tls/conn.go.html#4475709">readRecord</a></span><span class="op" id="4483666">(</span><span class="ident" id="4483667"><a href="/gostd/crypto/tls/common.go.html#4443022">recordTypeHandshake</a></span><span class="op" id="4483686">)</span><span class="op" id="4483687">;</span>&nbsp;<span class="ident" id="4483689"><a href="/gostd/crypto/tls/conn.go.html#4483647">err</a></span>&nbsp;<span class="op" id="4483693">!=</span>&nbsp;<span class="builtintype" id="4483696">nil</span>&nbsp;<span class="op" id="4483700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483705">return</span>&nbsp;<span class="builtintype" id="4483712">nil</span><span class="op" id="4483715">,</span>&nbsp;<span class="ident" id="4483717"><a href="/gostd/crypto/tls/conn.go.html#4483647">err</a></span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4483726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483729"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span>&nbsp;<span class="op" id="4483734">=</span>&nbsp;<span class="ident" id="4483736"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4483737">.</span><span class="ident" id="4483738"><a href="/gostd/crypto/tls/conn.go.html#4463205">hand</a></span><span class="op" id="4483742">.</span><span class="ident" id="4483743"><a href="/gostd/bytes/buffer.go.html#1391570">Next</a></span><span class="op" id="4483747">(</span><span class="num" id="4483748">4</span>&nbsp;<span class="op" id="4483750">+</span>&nbsp;<span class="ident" id="4483752"><a href="/gostd/crypto/tls/conn.go.html#4483410">n</a></span><span class="op" id="4483753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483756">var</span>&nbsp;<span class="ident" id="4483760">m</span>&nbsp;<span class="ident" id="4483762"><a href="/gostd/crypto/tls/common.go.html#4458876">handshakeMessage</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483780">switch</span>&nbsp;<span class="ident" id="4483787"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span><span class="op" id="4483791">[</span><span class="num" id="4483792">0</span><span class="op" id="4483793">]</span>&nbsp;<span class="op" id="4483795">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483798">case</span>&nbsp;<span class="ident" id="4483803"><a href="/gostd/crypto/tls/common.go.html#4443153">typeClientHello</a></span><span class="op" id="4483818">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483822"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4483824">=</span>&nbsp;<span class="builtinfunc" id="4483826">new</span><span class="op" id="4483829">(</span><span class="ident" id="4483830"><a href="/gostd/crypto/tls/handshake_messages.go.html#4508266">clientHelloMsg</a></span><span class="op" id="4483844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483847">case</span>&nbsp;<span class="ident" id="4483852"><a href="/gostd/crypto/tls/common.go.html#4443187">typeServerHello</a></span><span class="op" id="4483867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483871"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4483873">=</span>&nbsp;<span class="builtinfunc" id="4483875">new</span><span class="op" id="4483878">(</span><span class="ident" id="4483879"><a href="/gostd/crypto/tls/handshake_messages.go.html#4519382">serverHelloMsg</a></span><span class="op" id="4483893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483896">case</span>&nbsp;<span class="ident" id="4483901"><a href="/gostd/crypto/tls/common.go.html#4443221">typeNewSessionTicket</a></span><span class="op" id="4483921">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483925"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4483927">=</span>&nbsp;<span class="builtinfunc" id="4483929">new</span><span class="op" id="4483932">(</span><span class="ident" id="4483933"><a href="/gostd/crypto/tls/handshake_messages.go.html#4536457">newSessionTicketMsg</a></span><span class="op" id="4483952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4483955">case</span>&nbsp;<span class="ident" id="4483960"><a href="/gostd/crypto/tls/common.go.html#4443255">typeCertificate</a></span><span class="op" id="4483975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4483979"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4483981">=</span>&nbsp;<span class="builtinfunc" id="4483983">new</span><span class="op" id="4483986">(</span><span class="ident" id="4483987"><a href="/gostd/crypto/tls/handshake_messages.go.html#4524760">certificateMsg</a></span><span class="op" id="4484001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484004">case</span>&nbsp;<span class="ident" id="4484009"><a href="/gostd/crypto/tls/common.go.html#4443325">typeCertificateRequest</a></span><span class="op" id="4484031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484035"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484037">=</span>&nbsp;<span class="op" id="4484039">&amp;</span><span class="ident" id="4484040"><a href="/gostd/crypto/tls/handshake_messages.go.html#4531305">certificateRequestMsg</a></span><span class="op" id="4484061">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484066"><a href="/gostd/crypto/tls/handshake_messages.go.html#4531502">hasSignatureAndHash</a></span><span class="op" id="4484085">:</span>&nbsp;<span class="ident" id="4484087"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4484088">.</span><span class="ident" id="4484089"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span>&nbsp;<span class="op" id="4484094">&gt;=</span>&nbsp;<span class="ident" id="4484097"><a href="/gostd/crypto/tls/common.go.html#4442509">VersionTLS12</a></span><span class="op" id="4484109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4484113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484116">case</span>&nbsp;<span class="ident" id="4484121"><a href="/gostd/crypto/tls/common.go.html#4443500">typeCertificateStatus</a></span><span class="op" id="4484142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484146"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484148">=</span>&nbsp;<span class="builtinfunc" id="4484150">new</span><span class="op" id="4484153">(</span><span class="ident" id="4484154"><a href="/gostd/crypto/tls/handshake_messages.go.html#4527157">certificateStatusMsg</a></span><span class="op" id="4484174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484177">case</span>&nbsp;<span class="ident" id="4484182"><a href="/gostd/crypto/tls/common.go.html#4443290">typeServerKeyExchange</a></span><span class="op" id="4484203">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484207"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484209">=</span>&nbsp;<span class="builtinfunc" id="4484211">new</span><span class="op" id="4484214">(</span><span class="ident" id="4484215"><a href="/gostd/crypto/tls/handshake_messages.go.html#4526463">serverKeyExchangeMsg</a></span><span class="op" id="4484235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484238">case</span>&nbsp;<span class="ident" id="4484243"><a href="/gostd/crypto/tls/common.go.html#4443360">typeServerHelloDone</a></span><span class="op" id="4484262">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484266"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484268">=</span>&nbsp;<span class="builtinfunc" id="4484270">new</span><span class="op" id="4484273">(</span><span class="ident" id="4484274"><a href="/gostd/crypto/tls/handshake_messages.go.html#4528418">serverHelloDoneMsg</a></span><span class="op" id="4484292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484295">case</span>&nbsp;<span class="ident" id="4484300"><a href="/gostd/crypto/tls/common.go.html#4443430">typeClientKeyExchange</a></span><span class="op" id="4484321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484325"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484327">=</span>&nbsp;<span class="builtinfunc" id="4484329">new</span><span class="op" id="4484332">(</span><span class="ident" id="4484333"><a href="/gostd/crypto/tls/handshake_messages.go.html#4528753">clientKeyExchangeMsg</a></span><span class="op" id="4484353">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484356">case</span>&nbsp;<span class="ident" id="4484361"><a href="/gostd/crypto/tls/common.go.html#4443395">typeCertificateVerify</a></span><span class="op" id="4484382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484386"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484388">=</span>&nbsp;<span class="op" id="4484390">&amp;</span><span class="ident" id="4484391"><a href="/gostd/crypto/tls/handshake_messages.go.html#4534730">certificateVerifyMsg</a></span><span class="op" id="4484411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484416"><a href="/gostd/crypto/tls/handshake_messages.go.html#4534789">hasSignatureAndHash</a></span><span class="op" id="4484435">:</span>&nbsp;<span class="ident" id="4484437"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4484438">.</span><span class="ident" id="4484439"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span>&nbsp;<span class="op" id="4484444">&gt;=</span>&nbsp;<span class="ident" id="4484447"><a href="/gostd/crypto/tls/common.go.html#4442509">VersionTLS12</a></span><span class="op" id="4484459">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4484463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484466">case</span>&nbsp;<span class="ident" id="4484471"><a href="/gostd/crypto/tls/common.go.html#4443535">typeNextProtocol</a></span><span class="op" id="4484487">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484491"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484493">=</span>&nbsp;<span class="builtinfunc" id="4484495">new</span><span class="op" id="4484498">(</span><span class="ident" id="4484499"><a href="/gostd/crypto/tls/handshake_messages.go.html#4530220">nextProtoMsg</a></span><span class="op" id="4484511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484514">case</span>&nbsp;<span class="ident" id="4484519"><a href="/gostd/crypto/tls/common.go.html#4443465">typeFinished</a></span><span class="op" id="4484531">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484535"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span>&nbsp;<span class="op" id="4484537">=</span>&nbsp;<span class="builtinfunc" id="4484539">new</span><span class="op" id="4484542">(</span><span class="ident" id="4484543"><a href="/gostd/crypto/tls/handshake_messages.go.html#4529593">finishedMsg</a></span><span class="op" id="4484554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484557">default</span><span class="op" id="4484564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484568">return</span>&nbsp;<span class="builtintype" id="4484575">nil</span><span class="op" id="4484578">,</span>&nbsp;<span class="ident" id="4484580"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4484581">.</span><span class="ident" id="4484582"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4484584">.</span><span class="ident" id="4484585"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4484599">(</span><span class="ident" id="4484600"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4484601">.</span><span class="ident" id="4484602"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4484611">(</span><span class="ident" id="4484612"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4484634">)</span><span class="op" id="4484635">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4484638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4484642">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4484682">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4484732">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4484787"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span>&nbsp;<span class="op" id="4484792">=</span>&nbsp;<span class="builtinfunc" id="4484794">append</span><span class="op" id="4484800">(</span><span class="op" id="4484801">[</span><span class="op" id="4484802">]</span><span class="builtintype" id="4484803">byte</span><span class="op" id="4484807">(</span><span class="builtintype" id="4484808">nil</span><span class="op" id="4484811">)</span><span class="op" id="4484812">,</span>&nbsp;<span class="ident" id="4484814"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span><span class="op" id="4484818">...</span><span class="op" id="4484821">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484825">if</span>&nbsp;<span class="op" id="4484828">!</span><span class="ident" id="4484829"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span><span class="op" id="4484830">.</span><span class="ident" id="4484831"><a href="/gostd/crypto/tls/common.go.html#4458924">unmarshal</a></span><span class="op" id="4484840">(</span><span class="ident" id="4484841"><a href="/gostd/crypto/tls/conn.go.html#4483386">data</a></span><span class="op" id="4484845">)</span>&nbsp;<span class="op" id="4484847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484851">return</span>&nbsp;<span class="builtintype" id="4484858">nil</span><span class="op" id="4484861">,</span>&nbsp;<span class="ident" id="4484863"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4484864">.</span><span class="ident" id="4484865"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4484867">.</span><span class="ident" id="4484868"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4484882">(</span><span class="ident" id="4484883"><a href="/gostd/crypto/tls/conn.go.html#4483168">c</a></span><span class="op" id="4484884">.</span><span class="ident" id="4484885"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4484894">(</span><span class="ident" id="4484895"><a href="/gostd/crypto/tls/alert.go.html#4430296">alertUnexpectedMessage</a></span><span class="op" id="4484917">)</span><span class="op" id="4484918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4484921">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4484924">return</span>&nbsp;<span class="ident" id="4484931"><a href="/gostd/crypto/tls/conn.go.html#4483760">m</a></span><span class="op" id="4484932">,</span>&nbsp;<span class="builtintype" id="4484934">nil</span><br>
<span class="lineno"></span><span class="op" id="4484938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4484941">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4484981">func</span>&nbsp;<span class="op" id="4484986">(</span><span class="ident" id="4484987">c</span>&nbsp;<span class="op" id="4484989">*</span><span class="ident" id="4484990"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4484994">)</span>&nbsp;<span class="ident" id="4484996">Write</span><span class="op" id="4485001">(</span><span class="ident" id="4485002">b</span>&nbsp;<span class="op" id="4485004">[</span><span class="op" id="4485005">]</span><span class="builtintype" id="4485006">byte</span><span class="op" id="4485010">)</span>&nbsp;<span class="op" id="4485012">(</span><span class="builtintype" id="4485013">int</span><span class="op" id="4485016">,</span>&nbsp;<span class="builtintype" id="4485018">error</span><span class="op" id="4485023">)</span>&nbsp;<span class="op" id="4485025">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485028">if</span>&nbsp;<span class="ident" id="4485031">err</span>&nbsp;<span class="op" id="4485035">:=</span>&nbsp;<span class="ident" id="4485038"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485039">.</span><span class="ident" id="4485040"><a href="/gostd/crypto/tls/conn.go.html#4488474">Handshake</a></span><span class="op" id="4485049">(</span><span class="op" id="4485050">)</span><span class="op" id="4485051">;</span>&nbsp;<span class="ident" id="4485053"><a href="/gostd/crypto/tls/conn.go.html#4485031">err</a></span>&nbsp;<span class="op" id="4485057">!=</span>&nbsp;<span class="builtintype" id="4485060">nil</span>&nbsp;<span class="op" id="4485064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485068">return</span>&nbsp;<span class="num" id="4485075">0</span><span class="op" id="4485076">,</span>&nbsp;<span class="ident" id="4485078"><a href="/gostd/crypto/tls/conn.go.html#4485031">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4485083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4485087"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485088">.</span><span class="ident" id="4485089"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4485092">.</span><span class="ident" id="4485093"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4485097">(</span><span class="op" id="4485098">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485101">defer</span>&nbsp;<span class="ident" id="4485107"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485108">.</span><span class="ident" id="4485109"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4485112">.</span><span class="ident" id="4485113"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4485119">(</span><span class="op" id="4485120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485124">if</span>&nbsp;<span class="ident" id="4485127">err</span>&nbsp;<span class="op" id="4485131">:=</span>&nbsp;<span class="ident" id="4485134"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485135">.</span><span class="ident" id="4485136"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4485139">.</span><span class="ident" id="4485140"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span><span class="op" id="4485143">;</span>&nbsp;<span class="ident" id="4485145"><a href="/gostd/crypto/tls/conn.go.html#4485127">err</a></span>&nbsp;<span class="op" id="4485149">!=</span>&nbsp;<span class="builtintype" id="4485152">nil</span>&nbsp;<span class="op" id="4485156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485160">return</span>&nbsp;<span class="num" id="4485167">0</span><span class="op" id="4485168">,</span>&nbsp;<span class="ident" id="4485170"><a href="/gostd/crypto/tls/conn.go.html#4485127">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4485175">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485179">if</span>&nbsp;<span class="op" id="4485182">!</span><span class="ident" id="4485183"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485184">.</span><span class="ident" id="4485185"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4485203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485207">return</span>&nbsp;<span class="num" id="4485214">0</span><span class="op" id="4485215">,</span>&nbsp;<span class="ident" id="4485217"><a href="/gostd/crypto/tls/alert.go.html#4431016">alertInternalError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4485237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485241">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485303">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485368">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485429">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485490">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485494">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485539">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4485595">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485660">var</span>&nbsp;<span class="ident" id="4485664">m</span>&nbsp;<span class="builtintype" id="4485666">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485671">if</span>&nbsp;<span class="builtinfunc" id="4485674">len</span><span class="op" id="4485677">(</span><span class="ident" id="4485678"><a href="/gostd/crypto/tls/conn.go.html#4485002">b</a></span><span class="op" id="4485679">)</span>&nbsp;<span class="op" id="4485681">&gt;</span>&nbsp;<span class="num" id="4485683">1</span>&nbsp;<span class="op" id="4485685">&amp;&amp;</span>&nbsp;<span class="ident" id="4485688"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485689">.</span><span class="ident" id="4485690"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span>&nbsp;<span class="op" id="4485695">&lt;=</span>&nbsp;<span class="ident" id="4485698"><a href="/gostd/crypto/tls/common.go.html#4442463">VersionTLS10</a></span>&nbsp;<span class="op" id="4485711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485715">if</span>&nbsp;<span class="ident" id="4485718">_</span><span class="op" id="4485719">,</span>&nbsp;<span class="ident" id="4485721">ok</span>&nbsp;<span class="op" id="4485724">:=</span>&nbsp;<span class="ident" id="4485727"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485728">.</span><span class="ident" id="4485729"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4485732">.</span><span class="ident" id="4485733"><a href="/gostd/crypto/tls/conn.go.html#4464727">cipher</a></span><span class="op" id="4485739">.</span><span class="op" id="4485740">(</span><span class="ident" id="4485741"><a href="/gostd/crypto/tls/conn.go.html#4461717">cipher</a></span><span class="op" id="4485747">.</span><span class="ident" id="4485748"><a href="/gostd/crypto/cipher/cipher.go.html#4411369">BlockMode</a></span><span class="op" id="4485757">)</span><span class="op" id="4485758">;</span>&nbsp;<span class="ident" id="4485760"><a href="/gostd/crypto/tls/conn.go.html#4485721">ok</a></span>&nbsp;<span class="op" id="4485763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4485768">n</span><span class="op" id="4485769">,</span>&nbsp;<span class="ident" id="4485771">err</span>&nbsp;<span class="op" id="4485775">:=</span>&nbsp;<span class="ident" id="4485778"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485779">.</span><span class="ident" id="4485780"><a href="/gostd/crypto/tls/conn.go.html#4481088">writeRecord</a></span><span class="op" id="4485791">(</span><span class="ident" id="4485792"><a href="/gostd/crypto/tls/common.go.html#4443066">recordTypeApplicationData</a></span><span class="op" id="4485817">,</span>&nbsp;<span class="ident" id="4485819"><a href="/gostd/crypto/tls/conn.go.html#4485002">b</a></span><span class="op" id="4485820">[</span><span class="op" id="4485821">:</span><span class="num" id="4485822">1</span><span class="op" id="4485823">]</span><span class="op" id="4485824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485829">if</span>&nbsp;<span class="ident" id="4485832"><a href="/gostd/crypto/tls/conn.go.html#4485771">err</a></span>&nbsp;<span class="op" id="4485836">!=</span>&nbsp;<span class="builtintype" id="4485839">nil</span>&nbsp;<span class="op" id="4485843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485849">return</span>&nbsp;<span class="ident" id="4485856"><a href="/gostd/crypto/tls/conn.go.html#4485768">n</a></span><span class="op" id="4485857">,</span>&nbsp;<span class="ident" id="4485859"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485860">.</span><span class="ident" id="4485861"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4485864">.</span><span class="ident" id="4485865"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4485879">(</span><span class="ident" id="4485880"><a href="/gostd/crypto/tls/conn.go.html#4485771">err</a></span><span class="op" id="4485883">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4485888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4485893"><a href="/gostd/crypto/tls/conn.go.html#4485664">m</a></span><span class="op" id="4485894">,</span>&nbsp;<span class="ident" id="4485896"><a href="/gostd/crypto/tls/conn.go.html#4485002">b</a></span>&nbsp;<span class="op" id="4485898">=</span>&nbsp;<span class="num" id="4485900">1</span><span class="op" id="4485901">,</span>&nbsp;<span class="ident" id="4485903"><a href="/gostd/crypto/tls/conn.go.html#4485002">b</a></span><span class="op" id="4485904">[</span><span class="num" id="4485905">1</span><span class="op" id="4485906">:</span><span class="op" id="4485907">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4485911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4485914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4485918">n</span><span class="op" id="4485919">,</span>&nbsp;<span class="ident" id="4485921">err</span>&nbsp;<span class="op" id="4485925">:=</span>&nbsp;<span class="ident" id="4485928"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485929">.</span><span class="ident" id="4485930"><a href="/gostd/crypto/tls/conn.go.html#4481088">writeRecord</a></span><span class="op" id="4485941">(</span><span class="ident" id="4485942"><a href="/gostd/crypto/tls/common.go.html#4443066">recordTypeApplicationData</a></span><span class="op" id="4485967">,</span>&nbsp;<span class="ident" id="4485969"><a href="/gostd/crypto/tls/conn.go.html#4485002">b</a></span><span class="op" id="4485970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4485973">return</span>&nbsp;<span class="ident" id="4485980"><a href="/gostd/crypto/tls/conn.go.html#4485918">n</a></span>&nbsp;<span class="op" id="4485982">+</span>&nbsp;<span class="ident" id="4485984"><a href="/gostd/crypto/tls/conn.go.html#4485664">m</a></span><span class="op" id="4485985">,</span>&nbsp;<span class="ident" id="4485987"><a href="/gostd/crypto/tls/conn.go.html#4484987">c</a></span><span class="op" id="4485988">.</span><span class="ident" id="4485989"><a href="/gostd/crypto/tls/conn.go.html#4463044">out</a></span><span class="op" id="4485992">.</span><span class="ident" id="4485993"><a href="/gostd/crypto/tls/conn.go.html#4465080">setErrorLocked</a></span><span class="op" id="4486007">(</span><span class="ident" id="4486008"><a href="/gostd/crypto/tls/conn.go.html#4485921">err</a></span><span class="op" id="4486011">)</span><br>
<span class="lineno"></span><span class="op" id="4486013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4486016">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4486094">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4486160">func</span>&nbsp;<span class="op" id="4486165">(</span><span class="ident" id="4486166">c</span>&nbsp;<span class="op" id="4486168">*</span><span class="ident" id="4486169"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4486173">)</span>&nbsp;<span class="ident" id="4486175">Read</span><span class="op" id="4486179">(</span><span class="ident" id="4486180">b</span>&nbsp;<span class="op" id="4486182">[</span><span class="op" id="4486183">]</span><span class="builtintype" id="4486184">byte</span><span class="op" id="4486188">)</span>&nbsp;<span class="op" id="4486190">(</span><span class="ident" id="4486191">n</span>&nbsp;<span class="builtintype" id="4486193">int</span><span class="op" id="4486196">,</span>&nbsp;<span class="ident" id="4486198">err</span>&nbsp;<span class="builtintype" id="4486202">error</span><span class="op" id="4486207">)</span>&nbsp;<span class="op" id="4486209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486212">if</span>&nbsp;<span class="ident" id="4486215"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span>&nbsp;<span class="op" id="4486219">=</span>&nbsp;<span class="ident" id="4486221"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486222">.</span><span class="ident" id="4486223"><a href="/gostd/crypto/tls/conn.go.html#4488474">Handshake</a></span><span class="op" id="4486232">(</span><span class="op" id="4486233">)</span><span class="op" id="4486234">;</span>&nbsp;<span class="ident" id="4486236"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span>&nbsp;<span class="op" id="4486240">!=</span>&nbsp;<span class="builtintype" id="4486243">nil</span>&nbsp;<span class="op" id="4486247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486251">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4486259">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486262">if</span>&nbsp;<span class="builtinfunc" id="4486265">len</span><span class="op" id="4486268">(</span><span class="ident" id="4486269"><a href="/gostd/crypto/tls/conn.go.html#4486180">b</a></span><span class="op" id="4486270">)</span>&nbsp;<span class="op" id="4486272">==</span>&nbsp;<span class="num" id="4486275">0</span>&nbsp;<span class="op" id="4486277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4486281">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4486340">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486393">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4486401">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486405"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486406">.</span><span class="ident" id="4486407"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4486409">.</span><span class="ident" id="4486410"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4486414">(</span><span class="op" id="4486415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486418">defer</span>&nbsp;<span class="ident" id="4486424"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486425">.</span><span class="ident" id="4486426"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4486428">.</span><span class="ident" id="4486429"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4486435">(</span><span class="op" id="4486436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4486440">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4486510">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486578">const</span>&nbsp;<span class="ident" id="4486584">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4486611">=</span>&nbsp;<span class="num" id="4486613">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486618">for</span>&nbsp;<span class="ident" id="4486622">emptyRecordCount</span>&nbsp;<span class="op" id="4486639">:=</span>&nbsp;<span class="num" id="4486642">0</span><span class="op" id="4486643">;</span>&nbsp;<span class="ident" id="4486645"><a href="/gostd/crypto/tls/conn.go.html#4486622">emptyRecordCount</a></span>&nbsp;<span class="op" id="4486662">&lt;=</span>&nbsp;<span class="ident" id="4486665"><a href="/gostd/crypto/tls/conn.go.html#4486584">maxConsecutiveEmptyRecords</a></span><span class="op" id="4486691">;</span>&nbsp;<span class="ident" id="4486693"><a href="/gostd/crypto/tls/conn.go.html#4486622">emptyRecordCount</a></span><span class="op" id="4486709">++</span>&nbsp;<span class="op" id="4486712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486716">for</span>&nbsp;<span class="ident" id="4486720"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486721">.</span><span class="ident" id="4486722"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span>&nbsp;<span class="op" id="4486728">==</span>&nbsp;<span class="builtintype" id="4486731">nil</span>&nbsp;<span class="op" id="4486735">&amp;&amp;</span>&nbsp;<span class="ident" id="4486738"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486739">.</span><span class="ident" id="4486740"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4486742">.</span><span class="ident" id="4486743"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span>&nbsp;<span class="op" id="4486747">==</span>&nbsp;<span class="builtintype" id="4486750">nil</span>&nbsp;<span class="op" id="4486754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486759">if</span>&nbsp;<span class="ident" id="4486762">err</span>&nbsp;<span class="op" id="4486766">:=</span>&nbsp;<span class="ident" id="4486769"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486770">.</span><span class="ident" id="4486771"><a href="/gostd/crypto/tls/conn.go.html#4475709">readRecord</a></span><span class="op" id="4486781">(</span><span class="ident" id="4486782"><a href="/gostd/crypto/tls/common.go.html#4443066">recordTypeApplicationData</a></span><span class="op" id="4486807">)</span><span class="op" id="4486808">;</span>&nbsp;<span class="ident" id="4486810"><a href="/gostd/crypto/tls/conn.go.html#4486762">err</a></span>&nbsp;<span class="op" id="4486814">!=</span>&nbsp;<span class="builtintype" id="4486817">nil</span>&nbsp;<span class="op" id="4486821">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4486827">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486858">return</span>&nbsp;<span class="num" id="4486865">0</span><span class="op" id="4486866">,</span>&nbsp;<span class="ident" id="4486868"><a href="/gostd/crypto/tls/conn.go.html#4486762">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4486875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4486879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486883">if</span>&nbsp;<span class="ident" id="4486886">err</span>&nbsp;<span class="op" id="4486890">:=</span>&nbsp;<span class="ident" id="4486893"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486894">.</span><span class="ident" id="4486895"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4486897">.</span><span class="ident" id="4486898"><a href="/gostd/crypto/tls/conn.go.html#4464640">err</a></span><span class="op" id="4486901">;</span>&nbsp;<span class="ident" id="4486903"><a href="/gostd/crypto/tls/conn.go.html#4486886">err</a></span>&nbsp;<span class="op" id="4486907">!=</span>&nbsp;<span class="builtintype" id="4486910">nil</span>&nbsp;<span class="op" id="4486914">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486919">return</span>&nbsp;<span class="num" id="4486926">0</span><span class="op" id="4486927">,</span>&nbsp;<span class="ident" id="4486929"><a href="/gostd/crypto/tls/conn.go.html#4486886">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4486935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486940"><a href="/gostd/crypto/tls/conn.go.html#4486191">n</a></span><span class="op" id="4486941">,</span>&nbsp;<span class="ident" id="4486943"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span>&nbsp;<span class="op" id="4486947">=</span>&nbsp;<span class="ident" id="4486949"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486950">.</span><span class="ident" id="4486951"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span><span class="op" id="4486956">.</span><span class="ident" id="4486957"><a href="/gostd/crypto/tls/conn.go.html#4474593">Read</a></span><span class="op" id="4486961">(</span><span class="ident" id="4486962"><a href="/gostd/crypto/tls/conn.go.html#4486180">b</a></span><span class="op" id="4486963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4486967">if</span>&nbsp;<span class="ident" id="4486970"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486971">.</span><span class="ident" id="4486972"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span><span class="op" id="4486977">.</span><span class="ident" id="4486978"><a href="/gostd/crypto/tls/conn.go.html#4473550">off</a></span>&nbsp;<span class="op" id="4486982">&gt;=</span>&nbsp;<span class="builtinfunc" id="4486985">len</span><span class="op" id="4486988">(</span><span class="ident" id="4486989"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4486990">.</span><span class="ident" id="4486991"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span><span class="op" id="4486996">.</span><span class="ident" id="4486997"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4487001">)</span>&nbsp;<span class="op" id="4487003">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4487008"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4487009">.</span><span class="ident" id="4487010"><a href="/gostd/crypto/tls/conn.go.html#4463040">in</a></span><span class="op" id="4487012">.</span><span class="ident" id="4487013"><a href="/gostd/crypto/tls/conn.go.html#4475124">freeBlock</a></span><span class="op" id="4487022">(</span><span class="ident" id="4487023"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4487024">.</span><span class="ident" id="4487025"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span><span class="op" id="4487030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4487035"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4487036">.</span><span class="ident" id="4487037"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span>&nbsp;<span class="op" id="4487043">=</span>&nbsp;<span class="builtintype" id="4487045">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4487051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487056">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487113">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487172">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487225">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487279">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487332">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487388">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487445">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487495">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487509">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4487558">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4487596">if</span>&nbsp;<span class="ident" id="4487599">ri</span>&nbsp;<span class="op" id="4487602">:=</span>&nbsp;<span class="ident" id="4487605"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4487606">.</span><span class="ident" id="4487607"><a href="/gostd/crypto/tls/conn.go.html#4463087">rawInput</a></span><span class="op" id="4487615">;</span>&nbsp;<span class="ident" id="4487617"><a href="/gostd/crypto/tls/conn.go.html#4487599">ri</a></span>&nbsp;<span class="op" id="4487620">!=</span>&nbsp;<span class="builtintype" id="4487623">nil</span>&nbsp;<span class="op" id="4487627">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4487633"><a href="/gostd/crypto/tls/conn.go.html#4486191">n</a></span>&nbsp;<span class="op" id="4487635">!=</span>&nbsp;<span class="num" id="4487638">0</span>&nbsp;<span class="op" id="4487640">&amp;&amp;</span>&nbsp;<span class="ident" id="4487643"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span>&nbsp;<span class="op" id="4487647">==</span>&nbsp;<span class="builtintype" id="4487650">nil</span>&nbsp;<span class="op" id="4487654">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4487660"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4487661">.</span><span class="ident" id="4487662"><a href="/gostd/crypto/tls/conn.go.html#4463143">input</a></span>&nbsp;<span class="op" id="4487668">==</span>&nbsp;<span class="builtintype" id="4487671">nil</span>&nbsp;<span class="op" id="4487675">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4487678">len</span><span class="op" id="4487681">(</span><span class="ident" id="4487682"><a href="/gostd/crypto/tls/conn.go.html#4487599">ri</a></span><span class="op" id="4487684">.</span><span class="ident" id="4487685"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4487689">)</span>&nbsp;<span class="op" id="4487691">&gt;</span>&nbsp;<span class="num" id="4487693">0</span>&nbsp;<span class="op" id="4487695">&amp;&amp;</span>&nbsp;<span class="ident" id="4487698"><a href="/gostd/crypto/tls/common.go.html#4442907">recordType</a></span><span class="op" id="4487708">(</span><span class="ident" id="4487709"><a href="/gostd/crypto/tls/conn.go.html#4487599">ri</a></span><span class="op" id="4487711">.</span><span class="ident" id="4487712"><a href="/gostd/crypto/tls/conn.go.html#4473537">data</a></span><span class="op" id="4487716">[</span><span class="num" id="4487717">0</span><span class="op" id="4487718">]</span><span class="op" id="4487719">)</span>&nbsp;<span class="op" id="4487721">==</span>&nbsp;<span class="ident" id="4487724"><a href="/gostd/crypto/tls/common.go.html#4442978">recordTypeAlert</a></span>&nbsp;<span class="op" id="4487740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4487745">if</span>&nbsp;<span class="ident" id="4487748">recErr</span>&nbsp;<span class="op" id="4487755">:=</span>&nbsp;<span class="ident" id="4487758"><a href="/gostd/crypto/tls/conn.go.html#4486166">c</a></span><span class="op" id="4487759">.</span><span class="ident" id="4487760"><a href="/gostd/crypto/tls/conn.go.html#4475709">readRecord</a></span><span class="op" id="4487770">(</span><span class="ident" id="4487771"><a href="/gostd/crypto/tls/common.go.html#4443066">recordTypeApplicationData</a></span><span class="op" id="4487796">)</span><span class="op" id="4487797">;</span>&nbsp;<span class="ident" id="4487799"><a href="/gostd/crypto/tls/conn.go.html#4487748">recErr</a></span>&nbsp;<span class="op" id="4487806">!=</span>&nbsp;<span class="builtintype" id="4487809">nil</span>&nbsp;<span class="op" id="4487813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4487819"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span>&nbsp;<span class="op" id="4487823">=</span>&nbsp;<span class="ident" id="4487825"><a href="/gostd/crypto/tls/conn.go.html#4487748">recErr</a></span>&nbsp;<span class="comment" id="4487832">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4487868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4487872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4487877">if</span>&nbsp;<span class="ident" id="4487880"><a href="/gostd/crypto/tls/conn.go.html#4486191">n</a></span>&nbsp;<span class="op" id="4487882">!=</span>&nbsp;<span class="num" id="4487885">0</span>&nbsp;<span class="op" id="4487887">||</span>&nbsp;<span class="ident" id="4487890"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span>&nbsp;<span class="op" id="4487894">!=</span>&nbsp;<span class="builtintype" id="4487897">nil</span>&nbsp;<span class="op" id="4487901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4487906">return</span>&nbsp;<span class="ident" id="4487913"><a href="/gostd/crypto/tls/conn.go.html#4486191">n</a></span><span class="op" id="4487914">,</span>&nbsp;<span class="ident" id="4487916"><a href="/gostd/crypto/tls/conn.go.html#4486198">err</a></span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4487922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4487925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4487929">return</span>&nbsp;<span class="num" id="4487936">0</span><span class="op" id="4487937">,</span>&nbsp;<span class="ident" id="4487939"><a href="/gostd/crypto/tls/conn.go.html#4461783">io</a></span><span class="op" id="4487941">.</span><span class="ident" id="4487942"><a href="/gostd/io/io.go.html#1420336">ErrNoProgress</a></span><br>
<span class="lineno"></span><span class="op" id="4487956">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4487959">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4487991">func</span>&nbsp;<span class="op" id="4487996">(</span><span class="ident" id="4487997">c</span>&nbsp;<span class="op" id="4487999">*</span><span class="ident" id="4488000"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4488004">)</span>&nbsp;<span class="ident" id="4488006">Close</span><span class="op" id="4488011">(</span><span class="op" id="4488012">)</span>&nbsp;<span class="builtintype" id="4488014">error</span>&nbsp;<span class="op" id="4488020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488023">var</span>&nbsp;<span class="ident" id="4488027">alertErr</span>&nbsp;<span class="builtintype" id="4488036">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488044"><a href="/gostd/crypto/tls/conn.go.html#4487997">c</a></span><span class="op" id="4488045">.</span><span class="ident" id="4488046"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4488060">.</span><span class="ident" id="4488061"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4488065">(</span><span class="op" id="4488066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488069">defer</span>&nbsp;<span class="ident" id="4488075"><a href="/gostd/crypto/tls/conn.go.html#4487997">c</a></span><span class="op" id="4488076">.</span><span class="ident" id="4488077"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4488091">.</span><span class="ident" id="4488092"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4488098">(</span><span class="op" id="4488099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488102">if</span>&nbsp;<span class="ident" id="4488105"><a href="/gostd/crypto/tls/conn.go.html#4487997">c</a></span><span class="op" id="4488106">.</span><span class="ident" id="4488107"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4488125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488129"><a href="/gostd/crypto/tls/conn.go.html#4488027">alertErr</a></span>&nbsp;<span class="op" id="4488138">=</span>&nbsp;<span class="ident" id="4488140"><a href="/gostd/crypto/tls/conn.go.html#4487997">c</a></span><span class="op" id="4488141">.</span><span class="ident" id="4488142"><a href="/gostd/crypto/tls/conn.go.html#4480829">sendAlert</a></span><span class="op" id="4488151">(</span><span class="ident" id="4488152"><a href="/gostd/crypto/tls/alert.go.html#4430257">alertCloseNotify</a></span><span class="op" id="4488168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4488171">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488175">if</span>&nbsp;<span class="ident" id="4488178">err</span>&nbsp;<span class="op" id="4488182">:=</span>&nbsp;<span class="ident" id="4488185"><a href="/gostd/crypto/tls/conn.go.html#4487997">c</a></span><span class="op" id="4488186">.</span><span class="ident" id="4488187"><a href="/gostd/crypto/tls/conn.go.html#4461931">conn</a></span><span class="op" id="4488191">.</span><span class="ident" id="4488192"><a href="/gostd/net/net.go.html#3334987">Close</a></span><span class="op" id="4488197">(</span><span class="op" id="4488198">)</span><span class="op" id="4488199">;</span>&nbsp;<span class="ident" id="4488201"><a href="/gostd/crypto/tls/conn.go.html#4488178">err</a></span>&nbsp;<span class="op" id="4488205">!=</span>&nbsp;<span class="builtintype" id="4488208">nil</span>&nbsp;<span class="op" id="4488212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488216">return</span>&nbsp;<span class="ident" id="4488223"><a href="/gostd/crypto/tls/conn.go.html#4488178">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4488228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488231">return</span>&nbsp;<span class="ident" id="4488238"><a href="/gostd/crypto/tls/conn.go.html#4488027">alertErr</a></span><br>
<span class="lineno">960</span><span class="op" id="4488247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4488250">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4488299">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4488339">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4488392">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4488459">func</span>&nbsp;<span class="op" id="4488464">(</span><span class="ident" id="4488465">c</span>&nbsp;<span class="op" id="4488467">*</span><span class="ident" id="4488468"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4488472">)</span>&nbsp;<span class="ident" id="4488474">Handshake</span><span class="op" id="4488483">(</span><span class="op" id="4488484">)</span>&nbsp;<span class="builtintype" id="4488486">error</span>&nbsp;<span class="op" id="4488492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488495"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488496">.</span><span class="ident" id="4488497"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4488511">.</span><span class="ident" id="4488512"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4488516">(</span><span class="op" id="4488517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488520">defer</span>&nbsp;<span class="ident" id="4488526"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488527">.</span><span class="ident" id="4488528"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4488542">.</span><span class="ident" id="4488543"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4488549">(</span><span class="op" id="4488550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488553">if</span>&nbsp;<span class="ident" id="4488556">err</span>&nbsp;<span class="op" id="4488560">:=</span>&nbsp;<span class="ident" id="4488563"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488564">.</span><span class="ident" id="4488565"><a href="/gostd/crypto/tls/conn.go.html#4462104">handshakeErr</a></span><span class="op" id="4488577">;</span>&nbsp;<span class="ident" id="4488579"><a href="/gostd/crypto/tls/conn.go.html#4488556">err</a></span>&nbsp;<span class="op" id="4488583">!=</span>&nbsp;<span class="builtintype" id="4488586">nil</span>&nbsp;<span class="op" id="4488590">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488594">return</span>&nbsp;<span class="ident" id="4488601"><a href="/gostd/crypto/tls/conn.go.html#4488556">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4488606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488609">if</span>&nbsp;<span class="ident" id="4488612"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488613">.</span><span class="ident" id="4488614"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4488632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488636">return</span>&nbsp;<span class="builtintype" id="4488643">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4488648">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488652">if</span>&nbsp;<span class="ident" id="4488655"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488656">.</span><span class="ident" id="4488657"><a href="/gostd/crypto/tls/conn.go.html#4461950">isClient</a></span>&nbsp;<span class="op" id="4488666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488670"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488671">.</span><span class="ident" id="4488672"><a href="/gostd/crypto/tls/conn.go.html#4462104">handshakeErr</a></span>&nbsp;<span class="op" id="4488685">=</span>&nbsp;<span class="ident" id="4488687"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488688">.</span><span class="ident" id="4488689"><a href="/gostd/crypto/tls/handshake_client.go.html#4490789">clientHandshake</a></span><span class="op" id="4488704">(</span><span class="op" id="4488705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4488708">}</span>&nbsp;<span class="keyword" id="4488710">else</span>&nbsp;<span class="op" id="4488715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488719"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488720">.</span><span class="ident" id="4488721"><a href="/gostd/crypto/tls/conn.go.html#4462104">handshakeErr</a></span>&nbsp;<span class="op" id="4488734">=</span>&nbsp;<span class="ident" id="4488736"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488737">.</span><span class="ident" id="4488738"><a href="/gostd/crypto/tls/handshake_server.go.html#4539247">serverHandshake</a></span><span class="op" id="4488753">(</span><span class="op" id="4488754">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4488757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488760">return</span>&nbsp;<span class="ident" id="4488767"><a href="/gostd/crypto/tls/conn.go.html#4488465">c</a></span><span class="op" id="4488768">.</span><span class="ident" id="4488769"><a href="/gostd/crypto/tls/conn.go.html#4462104">handshakeErr</a></span><br>
<span class="lineno"></span><span class="op" id="4488782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4488785">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4488852">func</span>&nbsp;<span class="op" id="4488857">(</span><span class="ident" id="4488858">c</span>&nbsp;<span class="op" id="4488860">*</span><span class="ident" id="4488861"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4488865">)</span>&nbsp;<span class="ident" id="4488867">ConnectionState</span><span class="op" id="4488882">(</span><span class="op" id="4488883">)</span>&nbsp;<span class="ident" id="4488885"><a href="/gostd/crypto/tls/common.go.html#4446494">ConnectionState</a></span>&nbsp;<span class="op" id="4488901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488904"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4488905">.</span><span class="ident" id="4488906"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4488920">.</span><span class="ident" id="4488921"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4488925">(</span><span class="op" id="4488926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488929">defer</span>&nbsp;<span class="ident" id="4488935"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4488936">.</span><span class="ident" id="4488937"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4488951">.</span><span class="ident" id="4488952"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4488958">(</span><span class="op" id="4488959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4488963">var</span>&nbsp;<span class="ident" id="4488967">state</span>&nbsp;<span class="ident" id="4488973"><a href="/gostd/crypto/tls/common.go.html#4446494">ConnectionState</a></span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4488990"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4488995">.</span><span class="ident" id="4488996"><a href="/gostd/crypto/tls/common.go.html#4446628">HandshakeComplete</a></span>&nbsp;<span class="op" id="4489014">=</span>&nbsp;<span class="ident" id="4489016"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489017">.</span><span class="ident" id="4489018"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489037">if</span>&nbsp;<span class="ident" id="4489040"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489041">.</span><span class="ident" id="4489042"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4489060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489064"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489069">.</span><span class="ident" id="4489070"><a href="/gostd/crypto/tls/common.go.html#4446520">Version</a></span>&nbsp;<span class="op" id="4489078">=</span>&nbsp;<span class="ident" id="4489080"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489081">.</span><span class="ident" id="4489082"><a href="/gostd/crypto/tls/conn.go.html#4462168">vers</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489089"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489094">.</span><span class="ident" id="4489095"><a href="/gostd/crypto/tls/common.go.html#4446910">NegotiatedProtocol</a></span>&nbsp;<span class="op" id="4489114">=</span>&nbsp;<span class="ident" id="4489116"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489117">.</span><span class="ident" id="4489118"><a href="/gostd/crypto/tls/conn.go.html#4462962">clientProtocol</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489135"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489140">.</span><span class="ident" id="4489141"><a href="/gostd/crypto/tls/common.go.html#4446707">DidResume</a></span>&nbsp;<span class="op" id="4489151">=</span>&nbsp;<span class="ident" id="4489153"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489154">.</span><span class="ident" id="4489155"><a href="/gostd/crypto/tls/conn.go.html#4462367">didResume</a></span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489167"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489172">.</span><span class="ident" id="4489173"><a href="/gostd/crypto/tls/common.go.html#4447013">NegotiatedProtocolIsMutual</a></span>&nbsp;<span class="op" id="4489200">=</span>&nbsp;<span class="op" id="4489202">!</span><span class="ident" id="4489203"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489204">.</span><span class="ident" id="4489205"><a href="/gostd/crypto/tls/conn.go.html#4462993">clientProtocolFallback</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489230"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489235">.</span><span class="ident" id="4489236"><a href="/gostd/crypto/tls/common.go.html#4446805">CipherSuite</a></span>&nbsp;<span class="op" id="4489248">=</span>&nbsp;<span class="ident" id="4489250"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489251">.</span><span class="ident" id="4489252"><a href="/gostd/crypto/tls/conn.go.html#4462443">cipherSuite</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489266"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489271">.</span><span class="ident" id="4489272"><a href="/gostd/crypto/tls/common.go.html#4447223">PeerCertificates</a></span>&nbsp;<span class="op" id="4489289">=</span>&nbsp;<span class="ident" id="4489291"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489292">.</span><span class="ident" id="4489293"><a href="/gostd/crypto/tls/conn.go.html#4462520">peerCertificates</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489312"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489317">.</span><span class="ident" id="4489318"><a href="/gostd/crypto/tls/common.go.html#4447319">VerifiedChains</a></span>&nbsp;<span class="op" id="4489333">=</span>&nbsp;<span class="ident" id="4489335"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489336">.</span><span class="ident" id="4489337"><a href="/gostd/crypto/tls/conn.go.html#4462677">verifiedChains</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489354"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489359">.</span><span class="ident" id="4489360"><a href="/gostd/crypto/tls/common.go.html#4447111">ServerName</a></span>&nbsp;<span class="op" id="4489371">=</span>&nbsp;<span class="ident" id="4489373"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489374">.</span><span class="ident" id="4489375"><a href="/gostd/crypto/tls/conn.go.html#4462788">serverName</a></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489388">if</span>&nbsp;<span class="op" id="4489391">!</span><span class="ident" id="4489392"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489393">.</span><span class="ident" id="4489394"><a href="/gostd/crypto/tls/conn.go.html#4462367">didResume</a></span>&nbsp;<span class="op" id="4489404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489409"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><span class="op" id="4489414">.</span><span class="ident" id="4489415"><a href="/gostd/crypto/tls/common.go.html#4447787">TLSUnique</a></span>&nbsp;<span class="op" id="4489425">=</span>&nbsp;<span class="ident" id="4489427"><a href="/gostd/crypto/tls/conn.go.html#4488858">c</a></span><span class="op" id="4489428">.</span><span class="ident" id="4489429"><a href="/gostd/crypto/tls/conn.go.html#4462937">firstFinished</a></span><span class="op" id="4489442">[</span><span class="op" id="4489443">:</span><span class="op" id="4489444">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4489448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4489451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489455">return</span>&nbsp;<span class="ident" id="4489462"><a href="/gostd/crypto/tls/conn.go.html#4488967">state</a></span><br>
<span class="lineno"></span><span class="op" id="4489468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4489471">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4489545">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4489590">func</span>&nbsp;<span class="op" id="4489595">(</span><span class="ident" id="4489596">c</span>&nbsp;<span class="op" id="4489598">*</span><span class="ident" id="4489599"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4489603">)</span>&nbsp;<span class="ident" id="4489605">OCSPResponse</span><span class="op" id="4489617">(</span><span class="op" id="4489618">)</span>&nbsp;<span class="op" id="4489620">[</span><span class="op" id="4489621">]</span><span class="builtintype" id="4489622">byte</span>&nbsp;<span class="op" id="4489627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489630"><a href="/gostd/crypto/tls/conn.go.html#4489596">c</a></span><span class="op" id="4489631">.</span><span class="ident" id="4489632"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4489646">.</span><span class="ident" id="4489647"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4489651">(</span><span class="op" id="4489652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489655">defer</span>&nbsp;<span class="ident" id="4489661"><a href="/gostd/crypto/tls/conn.go.html#4489596">c</a></span><span class="op" id="4489662">.</span><span class="ident" id="4489663"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4489677">.</span><span class="ident" id="4489678"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4489684">(</span><span class="op" id="4489685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489689">return</span>&nbsp;<span class="ident" id="4489696"><a href="/gostd/crypto/tls/conn.go.html#4489596">c</a></span><span class="op" id="4489697">.</span><span class="ident" id="4489698"><a href="/gostd/crypto/tls/conn.go.html#4462469">ocspResponse</a></span><br>
<span class="lineno">1015</span><span class="op" id="4489711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4489714">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4489784">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4489859">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4489886">func</span>&nbsp;<span class="op" id="4489891">(</span><span class="ident" id="4489892">c</span>&nbsp;<span class="op" id="4489894">*</span><span class="ident" id="4489895"><a href="/gostd/crypto/tls/conn.go.html#4461903">Conn</a></span><span class="op" id="4489899">)</span>&nbsp;<span class="ident" id="4489901">VerifyHostname</span><span class="op" id="4489915">(</span><span class="ident" id="4489916">host</span>&nbsp;<span class="builtintype" id="4489921">string</span><span class="op" id="4489927">)</span>&nbsp;<span class="builtintype" id="4489929">error</span>&nbsp;<span class="op" id="4489935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4489938"><a href="/gostd/crypto/tls/conn.go.html#4489892">c</a></span><span class="op" id="4489939">.</span><span class="ident" id="4489940"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4489954">.</span><span class="ident" id="4489955"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="4489959">(</span><span class="op" id="4489960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489963">defer</span>&nbsp;<span class="ident" id="4489969"><a href="/gostd/crypto/tls/conn.go.html#4489892">c</a></span><span class="op" id="4489970">.</span><span class="ident" id="4489971"><a href="/gostd/crypto/tls/conn.go.html#4462024">handshakeMutex</a></span><span class="op" id="4489985">.</span><span class="ident" id="4489986"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="4489992">(</span><span class="op" id="4489993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4489996">if</span>&nbsp;<span class="op" id="4489999">!</span><span class="ident" id="4490000"><a href="/gostd/crypto/tls/conn.go.html#4489892">c</a></span><span class="op" id="4490001">.</span><span class="ident" id="4490002"><a href="/gostd/crypto/tls/conn.go.html#4461950">isClient</a></span>&nbsp;<span class="op" id="4490011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4490015">return</span>&nbsp;<span class="ident" id="4490022"><a href="/gostd/crypto/tls/conn.go.html#4461766">errors</a></span><span class="op" id="4490028">.</span><span class="ident" id="4490029"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4490032">(</span><span class="string" id="4490033">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4490086">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4490089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4490092">if</span>&nbsp;<span class="op" id="4490095">!</span><span class="ident" id="4490096"><a href="/gostd/crypto/tls/conn.go.html#4489892">c</a></span><span class="op" id="4490097">.</span><span class="ident" id="4490098"><a href="/gostd/crypto/tls/conn.go.html#4462343">handshakeComplete</a></span>&nbsp;<span class="op" id="4490116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4490120">return</span>&nbsp;<span class="ident" id="4490127"><a href="/gostd/crypto/tls/conn.go.html#4461766">errors</a></span><span class="op" id="4490133">.</span><span class="ident" id="4490134"><a href="/gostd/errors/errors.go.html#1418493">New</a></span><span class="op" id="4490137">(</span><span class="string" id="4490138">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4490181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4490184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4490187">return</span>&nbsp;<span class="ident" id="4490194"><a href="/gostd/crypto/tls/conn.go.html#4489892">c</a></span><span class="op" id="4490195">.</span><span class="ident" id="4490196"><a href="/gostd/crypto/tls/conn.go.html#4462520">peerCertificates</a></span><span class="op" id="4490212">[</span><span class="num" id="4490213">0</span><span class="op" id="4490214">]</span><span class="op" id="4490215">.</span><span class="ident" id="4490216"><a href="/gostd/crypto/x509/verify.go.html#4642893">VerifyHostname</a></span><span class="op" id="4490230">(</span><span class="ident" id="4490231"><a href="/gostd/crypto/tls/conn.go.html#4489916">host</a></span><span class="op" id="4490235">)</span><br>
<span class="lineno">1030</span><span class="op" id="4490237">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
