<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8311296">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8311351">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8311405">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8311456">package</span>&nbsp;<span class="ident" id="8311464">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8311469">import</span>&nbsp;<span class="op" id="8311476">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311479">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311486">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311492">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311503">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311514">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311522">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8311533">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="8311540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8311543">func</span>&nbsp;<span class="ident" id="8311548">BenchmarkTCP4OneShot</span><span class="op" id="8311568">(</span><span class="ident" id="8311569">b</span>&nbsp;<span class="op" id="8311571">*</span><span class="ident" id="8311572">testing</span><span class="op" id="8311579">.</span><span class="ident" id="8311580">B</span><span class="op" id="8311581">)</span>&nbsp;<span class="op" id="8311583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8311586">benchmarkTCP</span><span class="op" id="8311598">(</span><span class="ident" id="8311599">b</span><span class="op" id="8311600">,</span>&nbsp;<span class="builtintype" id="8311602">false</span><span class="op" id="8311607">,</span>&nbsp;<span class="builtintype" id="8311609">false</span><span class="op" id="8311614">,</span>&nbsp;<span class="string" id="8311616">&#34;127.0.0.1:0&#34;</span><span class="op" id="8311629">)</span><br>
<span class="lineno"></span><span class="op" id="8311631">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8311634">func</span>&nbsp;<span class="ident" id="8311639">BenchmarkTCP4OneShotTimeout</span><span class="op" id="8311666">(</span><span class="ident" id="8311667">b</span>&nbsp;<span class="op" id="8311669">*</span><span class="ident" id="8311670">testing</span><span class="op" id="8311677">.</span><span class="ident" id="8311678">B</span><span class="op" id="8311679">)</span>&nbsp;<span class="op" id="8311681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8311684">benchmarkTCP</span><span class="op" id="8311696">(</span><span class="ident" id="8311697">b</span><span class="op" id="8311698">,</span>&nbsp;<span class="builtintype" id="8311700">false</span><span class="op" id="8311705">,</span>&nbsp;<span class="builtintype" id="8311707">true</span><span class="op" id="8311711">,</span>&nbsp;<span class="string" id="8311713">&#34;127.0.0.1:0&#34;</span><span class="op" id="8311726">)</span><br>
<span class="lineno"></span><span class="op" id="8311728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8311731">func</span>&nbsp;<span class="ident" id="8311736">BenchmarkTCP4Persistent</span><span class="op" id="8311759">(</span><span class="ident" id="8311760">b</span>&nbsp;<span class="op" id="8311762">*</span><span class="ident" id="8311763">testing</span><span class="op" id="8311770">.</span><span class="ident" id="8311771">B</span><span class="op" id="8311772">)</span>&nbsp;<span class="op" id="8311774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8311777">benchmarkTCP</span><span class="op" id="8311789">(</span><span class="ident" id="8311790">b</span><span class="op" id="8311791">,</span>&nbsp;<span class="builtintype" id="8311793">true</span><span class="op" id="8311797">,</span>&nbsp;<span class="builtintype" id="8311799">false</span><span class="op" id="8311804">,</span>&nbsp;<span class="string" id="8311806">&#34;127.0.0.1:0&#34;</span><span class="op" id="8311819">)</span><br>
<span class="lineno"></span><span class="op" id="8311821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8311824">func</span>&nbsp;<span class="ident" id="8311829">BenchmarkTCP4PersistentTimeout</span><span class="op" id="8311859">(</span><span class="ident" id="8311860">b</span>&nbsp;<span class="op" id="8311862">*</span><span class="ident" id="8311863">testing</span><span class="op" id="8311870">.</span><span class="ident" id="8311871">B</span><span class="op" id="8311872">)</span>&nbsp;<span class="op" id="8311874">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8311877">benchmarkTCP</span><span class="op" id="8311889">(</span><span class="ident" id="8311890">b</span><span class="op" id="8311891">,</span>&nbsp;<span class="builtintype" id="8311893">true</span><span class="op" id="8311897">,</span>&nbsp;<span class="builtintype" id="8311899">true</span><span class="op" id="8311903">,</span>&nbsp;<span class="string" id="8311905">&#34;127.0.0.1:0&#34;</span><span class="op" id="8311918">)</span><br>
<span class="lineno"></span><span class="op" id="8311920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8311923">func</span>&nbsp;<span class="ident" id="8311928">BenchmarkTCP6OneShot</span><span class="op" id="8311948">(</span><span class="ident" id="8311949">b</span>&nbsp;<span class="op" id="8311951">*</span><span class="ident" id="8311952">testing</span><span class="op" id="8311959">.</span><span class="ident" id="8311960">B</span><span class="op" id="8311961">)</span>&nbsp;<span class="op" id="8311963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8311966">if</span>&nbsp;<span class="op" id="8311969">!</span><span class="ident" id="8311970">supportsIPv6</span>&nbsp;<span class="op" id="8311983">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8311987">b</span><span class="op" id="8311988">.</span><span class="ident" id="8311989">Skip</span><span class="op" id="8311993">(</span><span class="string" id="8311994">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8312017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312023">benchmarkTCP</span><span class="op" id="8312035">(</span><span class="ident" id="8312036">b</span><span class="op" id="8312037">,</span>&nbsp;<span class="builtintype" id="8312039">false</span><span class="op" id="8312044">,</span>&nbsp;<span class="builtintype" id="8312046">false</span><span class="op" id="8312051">,</span>&nbsp;<span class="string" id="8312053">&#34;[::1]:0&#34;</span><span class="op" id="8312062">)</span><br>
<span class="lineno"></span><span class="op" id="8312064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="8312067">func</span>&nbsp;<span class="ident" id="8312072">BenchmarkTCP6OneShotTimeout</span><span class="op" id="8312099">(</span><span class="ident" id="8312100">b</span>&nbsp;<span class="op" id="8312102">*</span><span class="ident" id="8312103">testing</span><span class="op" id="8312110">.</span><span class="ident" id="8312111">B</span><span class="op" id="8312112">)</span>&nbsp;<span class="op" id="8312114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312117">if</span>&nbsp;<span class="op" id="8312120">!</span><span class="ident" id="8312121">supportsIPv6</span>&nbsp;<span class="op" id="8312134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312138">b</span><span class="op" id="8312139">.</span><span class="ident" id="8312140">Skip</span><span class="op" id="8312144">(</span><span class="string" id="8312145">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8312168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312174">benchmarkTCP</span><span class="op" id="8312186">(</span><span class="ident" id="8312187">b</span><span class="op" id="8312188">,</span>&nbsp;<span class="builtintype" id="8312190">false</span><span class="op" id="8312195">,</span>&nbsp;<span class="builtintype" id="8312197">true</span><span class="op" id="8312201">,</span>&nbsp;<span class="string" id="8312203">&#34;[::1]:0&#34;</span><span class="op" id="8312212">)</span><br>
<span class="lineno">45</span><span class="op" id="8312214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8312217">func</span>&nbsp;<span class="ident" id="8312222">BenchmarkTCP6Persistent</span><span class="op" id="8312245">(</span><span class="ident" id="8312246">b</span>&nbsp;<span class="op" id="8312248">*</span><span class="ident" id="8312249">testing</span><span class="op" id="8312256">.</span><span class="ident" id="8312257">B</span><span class="op" id="8312258">)</span>&nbsp;<span class="op" id="8312260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312263">if</span>&nbsp;<span class="op" id="8312266">!</span><span class="ident" id="8312267">supportsIPv6</span>&nbsp;<span class="op" id="8312280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312284">b</span><span class="op" id="8312285">.</span><span class="ident" id="8312286">Skip</span><span class="op" id="8312290">(</span><span class="string" id="8312291">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8312314">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312320">benchmarkTCP</span><span class="op" id="8312332">(</span><span class="ident" id="8312333">b</span><span class="op" id="8312334">,</span>&nbsp;<span class="builtintype" id="8312336">true</span><span class="op" id="8312340">,</span>&nbsp;<span class="builtintype" id="8312342">false</span><span class="op" id="8312347">,</span>&nbsp;<span class="string" id="8312349">&#34;[::1]:0&#34;</span><span class="op" id="8312358">)</span><br>
<span class="lineno"></span><span class="op" id="8312360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8312363">func</span>&nbsp;<span class="ident" id="8312368">BenchmarkTCP6PersistentTimeout</span><span class="op" id="8312398">(</span><span class="ident" id="8312399">b</span>&nbsp;<span class="op" id="8312401">*</span><span class="ident" id="8312402">testing</span><span class="op" id="8312409">.</span><span class="ident" id="8312410">B</span><span class="op" id="8312411">)</span>&nbsp;<span class="op" id="8312413">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312416">if</span>&nbsp;<span class="op" id="8312419">!</span><span class="ident" id="8312420">supportsIPv6</span>&nbsp;<span class="op" id="8312433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312437">b</span><span class="op" id="8312438">.</span><span class="ident" id="8312439">Skip</span><span class="op" id="8312443">(</span><span class="string" id="8312444">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8312467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312473">benchmarkTCP</span><span class="op" id="8312485">(</span><span class="ident" id="8312486">b</span><span class="op" id="8312487">,</span>&nbsp;<span class="builtintype" id="8312489">true</span><span class="op" id="8312493">,</span>&nbsp;<span class="builtintype" id="8312495">true</span><span class="op" id="8312499">,</span>&nbsp;<span class="string" id="8312501">&#34;[::1]:0&#34;</span><span class="op" id="8312510">)</span><br>
<span class="lineno"></span><span class="op" id="8312512">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="8312515">func</span>&nbsp;<span class="ident" id="8312520">benchmarkTCP</span><span class="op" id="8312532">(</span><span class="ident" id="8312533">b</span>&nbsp;<span class="op" id="8312535">*</span><span class="ident" id="8312536">testing</span><span class="op" id="8312543">.</span><span class="ident" id="8312544">B</span><span class="op" id="8312545">,</span>&nbsp;<span class="ident" id="8312547">persistent</span><span class="op" id="8312557">,</span>&nbsp;<span class="ident" id="8312559">timeout</span>&nbsp;<span class="builtintype" id="8312567">bool</span><span class="op" id="8312571">,</span>&nbsp;<span class="ident" id="8312573">laddr</span>&nbsp;<span class="builtintype" id="8312579">string</span><span class="op" id="8312585">)</span>&nbsp;<span class="op" id="8312587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312590">const</span>&nbsp;<span class="ident" id="8312596">msgLen</span>&nbsp;<span class="op" id="8312603">=</span>&nbsp;<span class="num" id="8312605">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312610">conns</span>&nbsp;<span class="op" id="8312616">:=</span>&nbsp;<span class="ident" id="8312619">b</span><span class="op" id="8312620">.</span><span class="ident" id="8312621">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312624">numConcurrent</span>&nbsp;<span class="op" id="8312638">:=</span>&nbsp;<span class="ident" id="8312641">runtime</span><span class="op" id="8312648">.</span><span class="ident" id="8312649">GOMAXPROCS</span><span class="op" id="8312659">(</span><span class="op" id="8312660">-</span><span class="num" id="8312661">1</span><span class="op" id="8312662">)</span>&nbsp;<span class="op" id="8312664">*</span>&nbsp;<span class="num" id="8312666">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312669">msgs</span>&nbsp;<span class="op" id="8312674">:=</span>&nbsp;<span class="num" id="8312677">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312680">if</span>&nbsp;<span class="ident" id="8312683">persistent</span>&nbsp;<span class="op" id="8312694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312698">conns</span>&nbsp;<span class="op" id="8312704">=</span>&nbsp;<span class="ident" id="8312706">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312722">msgs</span>&nbsp;<span class="op" id="8312727">=</span>&nbsp;<span class="ident" id="8312729">b</span><span class="op" id="8312730">.</span><span class="ident" id="8312731">N</span>&nbsp;<span class="op" id="8312733">/</span>&nbsp;<span class="ident" id="8312735">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312743">if</span>&nbsp;<span class="ident" id="8312746">msgs</span>&nbsp;<span class="op" id="8312751">==</span>&nbsp;<span class="num" id="8312754">0</span>&nbsp;<span class="op" id="8312756">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312761">msgs</span>&nbsp;<span class="op" id="8312766">=</span>&nbsp;<span class="num" id="8312768">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312776">if</span>&nbsp;<span class="ident" id="8312779">conns</span>&nbsp;<span class="op" id="8312785">&gt;</span>&nbsp;<span class="ident" id="8312787">b</span><span class="op" id="8312788">.</span><span class="ident" id="8312789">N</span>&nbsp;<span class="op" id="8312791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312796">conns</span>&nbsp;<span class="op" id="8312802">=</span>&nbsp;<span class="ident" id="8312804">b</span><span class="op" id="8312805">.</span><span class="ident" id="8312806">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312810">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312816">sendMsg</span>&nbsp;<span class="op" id="8312824">:=</span>&nbsp;<span class="keyword" id="8312827">func</span><span class="op" id="8312831">(</span><span class="ident" id="8312832">c</span>&nbsp;<span class="ident" id="8312834">Conn</span><span class="op" id="8312838">,</span>&nbsp;<span class="ident" id="8312840">buf</span>&nbsp;<span class="op" id="8312844">[</span><span class="op" id="8312845">]</span><span class="builtintype" id="8312846">byte</span><span class="op" id="8312850">)</span>&nbsp;<span class="builtintype" id="8312852">bool</span>&nbsp;<span class="op" id="8312857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312861">n</span><span class="op" id="8312862">,</span>&nbsp;<span class="ident" id="8312864">err</span>&nbsp;<span class="op" id="8312868">:=</span>&nbsp;<span class="ident" id="8312871">c</span><span class="op" id="8312872">.</span><span class="ident" id="8312873">Write</span><span class="op" id="8312878">(</span><span class="ident" id="8312879">buf</span><span class="op" id="8312882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312886">if</span>&nbsp;<span class="ident" id="8312889">n</span>&nbsp;<span class="op" id="8312891">!=</span>&nbsp;<span class="builtinfunc" id="8312894">len</span><span class="op" id="8312897">(</span><span class="ident" id="8312898">buf</span><span class="op" id="8312901">)</span>&nbsp;<span class="op" id="8312903">||</span>&nbsp;<span class="ident" id="8312906">err</span>&nbsp;<span class="op" id="8312910">!=</span>&nbsp;<span class="ident" id="8312913">nil</span>&nbsp;<span class="op" id="8312917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312922">b</span><span class="op" id="8312923">.</span><span class="ident" id="8312924">Logf</span><span class="op" id="8312928">(</span><span class="string" id="8312929">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8312947">,</span>&nbsp;<span class="ident" id="8312949">err</span><span class="op" id="8312952">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312957">return</span>&nbsp;<span class="builtintype" id="8312964">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8312976">return</span>&nbsp;<span class="builtintype" id="8312983">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8312989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8312992">recvMsg</span>&nbsp;<span class="op" id="8313000">:=</span>&nbsp;<span class="keyword" id="8313003">func</span><span class="op" id="8313007">(</span><span class="ident" id="8313008">c</span>&nbsp;<span class="ident" id="8313010">Conn</span><span class="op" id="8313014">,</span>&nbsp;<span class="ident" id="8313016">buf</span>&nbsp;<span class="op" id="8313020">[</span><span class="op" id="8313021">]</span><span class="builtintype" id="8313022">byte</span><span class="op" id="8313026">)</span>&nbsp;<span class="builtintype" id="8313028">bool</span>&nbsp;<span class="op" id="8313033">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313037">for</span>&nbsp;<span class="ident" id="8313041">read</span>&nbsp;<span class="op" id="8313046">:=</span>&nbsp;<span class="num" id="8313049">0</span><span class="op" id="8313050">;</span>&nbsp;<span class="ident" id="8313052">read</span>&nbsp;<span class="op" id="8313057">!=</span>&nbsp;<span class="builtinfunc" id="8313060">len</span><span class="op" id="8313063">(</span><span class="ident" id="8313064">buf</span><span class="op" id="8313067">)</span><span class="op" id="8313068">;</span>&nbsp;<span class="op" id="8313070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313075">n</span><span class="op" id="8313076">,</span>&nbsp;<span class="ident" id="8313078">err</span>&nbsp;<span class="op" id="8313082">:=</span>&nbsp;<span class="ident" id="8313085">c</span><span class="op" id="8313086">.</span><span class="ident" id="8313087">Read</span><span class="op" id="8313091">(</span><span class="ident" id="8313092">buf</span><span class="op" id="8313095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313100">read</span>&nbsp;<span class="op" id="8313105">+=</span>&nbsp;<span class="ident" id="8313108">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313113">if</span>&nbsp;<span class="ident" id="8313116">err</span>&nbsp;<span class="op" id="8313120">!=</span>&nbsp;<span class="ident" id="8313123">nil</span>&nbsp;<span class="op" id="8313127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313133">b</span><span class="op" id="8313134">.</span><span class="ident" id="8313135">Logf</span><span class="op" id="8313139">(</span><span class="string" id="8313140">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8313157">,</span>&nbsp;<span class="ident" id="8313159">err</span><span class="op" id="8313162">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313168">return</span>&nbsp;<span class="builtintype" id="8313175">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313192">return</span>&nbsp;<span class="builtintype" id="8313199">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313205">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313208">ln</span><span class="op" id="8313210">,</span>&nbsp;<span class="ident" id="8313212">err</span>&nbsp;<span class="op" id="8313216">:=</span>&nbsp;<span class="ident" id="8313219">Listen</span><span class="op" id="8313225">(</span><span class="string" id="8313226">&#34;tcp&#34;</span><span class="op" id="8313231">,</span>&nbsp;<span class="ident" id="8313233">laddr</span><span class="op" id="8313238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313241">if</span>&nbsp;<span class="ident" id="8313244">err</span>&nbsp;<span class="op" id="8313248">!=</span>&nbsp;<span class="ident" id="8313251">nil</span>&nbsp;<span class="op" id="8313255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313259">b</span><span class="op" id="8313260">.</span><span class="ident" id="8313261">Fatalf</span><span class="op" id="8313267">(</span><span class="string" id="8313268">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8313287">,</span>&nbsp;<span class="ident" id="8313289">err</span><span class="op" id="8313292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313298">defer</span>&nbsp;<span class="ident" id="8313304">ln</span><span class="op" id="8313306">.</span><span class="ident" id="8313307">Close</span><span class="op" id="8313312">(</span><span class="op" id="8313313">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313316">serverSem</span>&nbsp;<span class="op" id="8313326">:=</span>&nbsp;<span class="builtinfunc" id="8313329">make</span><span class="op" id="8313333">(</span><span class="keyword" id="8313334">chan</span>&nbsp;<span class="builtintype" id="8313339">bool</span><span class="op" id="8313343">,</span>&nbsp;<span class="ident" id="8313345">numConcurrent</span><span class="op" id="8313358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8313361">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313375">go</span>&nbsp;<span class="keyword" id="8313378">func</span><span class="op" id="8313382">(</span><span class="op" id="8313383">)</span>&nbsp;<span class="op" id="8313385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313389">for</span>&nbsp;<span class="op" id="8313393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313398">c</span><span class="op" id="8313399">,</span>&nbsp;<span class="ident" id="8313401">err</span>&nbsp;<span class="op" id="8313405">:=</span>&nbsp;<span class="ident" id="8313408">ln</span><span class="op" id="8313410">.</span><span class="ident" id="8313411">Accept</span><span class="op" id="8313417">(</span><span class="op" id="8313418">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313423">if</span>&nbsp;<span class="ident" id="8313426">err</span>&nbsp;<span class="op" id="8313430">!=</span>&nbsp;<span class="ident" id="8313433">nil</span>&nbsp;<span class="op" id="8313437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313443">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313457">serverSem</span>&nbsp;<span class="op" id="8313467">&lt;-</span>&nbsp;<span class="builtintype" id="8313470">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8313478">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313503">go</span>&nbsp;<span class="keyword" id="8313506">func</span><span class="op" id="8313510">(</span><span class="ident" id="8313511">c</span>&nbsp;<span class="ident" id="8313513">Conn</span><span class="op" id="8313517">)</span>&nbsp;<span class="op" id="8313519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313525">defer</span>&nbsp;<span class="keyword" id="8313531">func</span><span class="op" id="8313535">(</span><span class="op" id="8313536">)</span>&nbsp;<span class="op" id="8313538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313545">c</span><span class="op" id="8313546">.</span><span class="ident" id="8313547">Close</span><span class="op" id="8313552">(</span><span class="op" id="8313553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313560">&lt;-</span><span class="ident" id="8313562">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313576">}</span><span class="op" id="8313577">(</span><span class="op" id="8313578">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313584">if</span>&nbsp;<span class="ident" id="8313587">timeout</span>&nbsp;<span class="op" id="8313595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313602">c</span><span class="op" id="8313603">.</span><span class="ident" id="8313604">SetDeadline</span><span class="op" id="8313615">(</span><span class="ident" id="8313616">time</span><span class="op" id="8313620">.</span><span class="ident" id="8313621">Now</span><span class="op" id="8313624">(</span><span class="op" id="8313625">)</span><span class="op" id="8313626">.</span><span class="ident" id="8313627">Add</span><span class="op" id="8313630">(</span><span class="ident" id="8313631">time</span><span class="op" id="8313635">.</span><span class="ident" id="8313636">Hour</span><span class="op" id="8313640">)</span><span class="op" id="8313641">)</span>&nbsp;<span class="comment" id="8313643">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313678">var</span>&nbsp;<span class="ident" id="8313682">buf</span>&nbsp;<span class="op" id="8313686">[</span><span class="ident" id="8313687">msgLen</span><span class="op" id="8313693">]</span><span class="builtintype" id="8313694">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313703">for</span>&nbsp;<span class="ident" id="8313707">m</span>&nbsp;<span class="op" id="8313709">:=</span>&nbsp;<span class="num" id="8313712">0</span><span class="op" id="8313713">;</span>&nbsp;<span class="ident" id="8313715">m</span>&nbsp;<span class="op" id="8313717">&lt;</span>&nbsp;<span class="ident" id="8313719">msgs</span><span class="op" id="8313723">;</span>&nbsp;<span class="ident" id="8313725">m</span><span class="op" id="8313726">++</span>&nbsp;<span class="op" id="8313729">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313736">if</span>&nbsp;<span class="op" id="8313739">!</span><span class="ident" id="8313740">recvMsg</span><span class="op" id="8313747">(</span><span class="ident" id="8313748">c</span><span class="op" id="8313749">,</span>&nbsp;<span class="ident" id="8313751">buf</span><span class="op" id="8313754">[</span><span class="op" id="8313755">:</span><span class="op" id="8313756">]</span><span class="op" id="8313757">)</span>&nbsp;<span class="op" id="8313759">||</span>&nbsp;<span class="op" id="8313762">!</span><span class="ident" id="8313763">sendMsg</span><span class="op" id="8313770">(</span><span class="ident" id="8313771">c</span><span class="op" id="8313772">,</span>&nbsp;<span class="ident" id="8313774">buf</span><span class="op" id="8313777">[</span><span class="op" id="8313778">:</span><span class="op" id="8313779">]</span><span class="op" id="8313780">)</span>&nbsp;<span class="op" id="8313782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313790">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313812">}</span><span class="op" id="8313813">(</span><span class="ident" id="8313814">c</span><span class="op" id="8313815">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313822">}</span><span class="op" id="8313823">(</span><span class="op" id="8313824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313827">clientSem</span>&nbsp;<span class="op" id="8313837">:=</span>&nbsp;<span class="builtinfunc" id="8313840">make</span><span class="op" id="8313844">(</span><span class="keyword" id="8313845">chan</span>&nbsp;<span class="builtintype" id="8313850">bool</span><span class="op" id="8313854">,</span>&nbsp;<span class="ident" id="8313856">numConcurrent</span><span class="op" id="8313869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313872">for</span>&nbsp;<span class="ident" id="8313876">i</span>&nbsp;<span class="op" id="8313878">:=</span>&nbsp;<span class="num" id="8313881">0</span><span class="op" id="8313882">;</span>&nbsp;<span class="ident" id="8313884">i</span>&nbsp;<span class="op" id="8313886">&lt;</span>&nbsp;<span class="ident" id="8313888">conns</span><span class="op" id="8313893">;</span>&nbsp;<span class="ident" id="8313895">i</span><span class="op" id="8313896">++</span>&nbsp;<span class="op" id="8313899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8313903">clientSem</span>&nbsp;<span class="op" id="8313913">&lt;-</span>&nbsp;<span class="builtintype" id="8313916">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8313923">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313947">go</span>&nbsp;<span class="keyword" id="8313950">func</span><span class="op" id="8313954">(</span><span class="op" id="8313955">)</span>&nbsp;<span class="op" id="8313957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8313962">defer</span>&nbsp;<span class="keyword" id="8313968">func</span><span class="op" id="8313972">(</span><span class="op" id="8313973">)</span>&nbsp;<span class="op" id="8313975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313981">&lt;-</span><span class="ident" id="8313983">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8313996">}</span><span class="op" id="8313997">(</span><span class="op" id="8313998">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314003">c</span><span class="op" id="8314004">,</span>&nbsp;<span class="ident" id="8314006">err</span>&nbsp;<span class="op" id="8314010">:=</span>&nbsp;<span class="ident" id="8314013">Dial</span><span class="op" id="8314017">(</span><span class="string" id="8314018">&#34;tcp&#34;</span><span class="op" id="8314023">,</span>&nbsp;<span class="ident" id="8314025">ln</span><span class="op" id="8314027">.</span><span class="ident" id="8314028">Addr</span><span class="op" id="8314032">(</span><span class="op" id="8314033">)</span><span class="op" id="8314034">.</span><span class="ident" id="8314035">String</span><span class="op" id="8314041">(</span><span class="op" id="8314042">)</span><span class="op" id="8314043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314048">if</span>&nbsp;<span class="ident" id="8314051">err</span>&nbsp;<span class="op" id="8314055">!=</span>&nbsp;<span class="ident" id="8314058">nil</span>&nbsp;<span class="op" id="8314062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314068">b</span><span class="op" id="8314069">.</span><span class="ident" id="8314070">Logf</span><span class="op" id="8314074">(</span><span class="string" id="8314075">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8314092">,</span>&nbsp;<span class="ident" id="8314094">err</span><span class="op" id="8314097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314103">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314113">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314118">defer</span>&nbsp;<span class="ident" id="8314124">c</span><span class="op" id="8314125">.</span><span class="ident" id="8314126">Close</span><span class="op" id="8314131">(</span><span class="op" id="8314132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314137">if</span>&nbsp;<span class="ident" id="8314140">timeout</span>&nbsp;<span class="op" id="8314148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314154">c</span><span class="op" id="8314155">.</span><span class="ident" id="8314156">SetDeadline</span><span class="op" id="8314167">(</span><span class="ident" id="8314168">time</span><span class="op" id="8314172">.</span><span class="ident" id="8314173">Now</span><span class="op" id="8314176">(</span><span class="op" id="8314177">)</span><span class="op" id="8314178">.</span><span class="ident" id="8314179">Add</span><span class="op" id="8314182">(</span><span class="ident" id="8314183">time</span><span class="op" id="8314187">.</span><span class="ident" id="8314188">Hour</span><span class="op" id="8314192">)</span><span class="op" id="8314193">)</span>&nbsp;<span class="comment" id="8314195">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314228">var</span>&nbsp;<span class="ident" id="8314232">buf</span>&nbsp;<span class="op" id="8314236">[</span><span class="ident" id="8314237">msgLen</span><span class="op" id="8314243">]</span><span class="builtintype" id="8314244">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314252">for</span>&nbsp;<span class="ident" id="8314256">m</span>&nbsp;<span class="op" id="8314258">:=</span>&nbsp;<span class="num" id="8314261">0</span><span class="op" id="8314262">;</span>&nbsp;<span class="ident" id="8314264">m</span>&nbsp;<span class="op" id="8314266">&lt;</span>&nbsp;<span class="ident" id="8314268">msgs</span><span class="op" id="8314272">;</span>&nbsp;<span class="ident" id="8314274">m</span><span class="op" id="8314275">++</span>&nbsp;<span class="op" id="8314278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314284">if</span>&nbsp;<span class="op" id="8314287">!</span><span class="ident" id="8314288">sendMsg</span><span class="op" id="8314295">(</span><span class="ident" id="8314296">c</span><span class="op" id="8314297">,</span>&nbsp;<span class="ident" id="8314299">buf</span><span class="op" id="8314302">[</span><span class="op" id="8314303">:</span><span class="op" id="8314304">]</span><span class="op" id="8314305">)</span>&nbsp;<span class="op" id="8314307">||</span>&nbsp;<span class="op" id="8314310">!</span><span class="ident" id="8314311">recvMsg</span><span class="op" id="8314318">(</span><span class="ident" id="8314319">c</span><span class="op" id="8314320">,</span>&nbsp;<span class="ident" id="8314322">buf</span><span class="op" id="8314325">[</span><span class="op" id="8314326">:</span><span class="op" id="8314327">]</span><span class="op" id="8314328">)</span>&nbsp;<span class="op" id="8314330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314337">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314352">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314356">}</span><span class="op" id="8314357">(</span><span class="op" id="8314358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314364">for</span>&nbsp;<span class="ident" id="8314368">i</span>&nbsp;<span class="op" id="8314370">:=</span>&nbsp;<span class="num" id="8314373">0</span><span class="op" id="8314374">;</span>&nbsp;<span class="ident" id="8314376">i</span>&nbsp;<span class="op" id="8314378">&lt;</span>&nbsp;<span class="ident" id="8314380">numConcurrent</span><span class="op" id="8314393">;</span>&nbsp;<span class="ident" id="8314395">i</span><span class="op" id="8314396">++</span>&nbsp;<span class="op" id="8314399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314403">clientSem</span>&nbsp;<span class="op" id="8314413">&lt;-</span>&nbsp;<span class="builtintype" id="8314416">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314423">serverSem</span>&nbsp;<span class="op" id="8314433">&lt;-</span>&nbsp;<span class="builtintype" id="8314436">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314442">}</span><br>
<span class="lineno"></span><span class="op" id="8314444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8314447">func</span>&nbsp;<span class="ident" id="8314452">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="8314484">(</span><span class="ident" id="8314485">b</span>&nbsp;<span class="op" id="8314487">*</span><span class="ident" id="8314488">testing</span><span class="op" id="8314495">.</span><span class="ident" id="8314496">B</span><span class="op" id="8314497">)</span>&nbsp;<span class="op" id="8314499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314502">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8314533">(</span><span class="ident" id="8314534">b</span><span class="op" id="8314535">,</span>&nbsp;<span class="string" id="8314537">&#34;127.0.0.1:0&#34;</span><span class="op" id="8314550">)</span><br>
<span class="lineno">160</span><span class="op" id="8314552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8314555">func</span>&nbsp;<span class="ident" id="8314560">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="8314592">(</span><span class="ident" id="8314593">b</span>&nbsp;<span class="op" id="8314595">*</span><span class="ident" id="8314596">testing</span><span class="op" id="8314603">.</span><span class="ident" id="8314604">B</span><span class="op" id="8314605">)</span>&nbsp;<span class="op" id="8314607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8314610">if</span>&nbsp;<span class="op" id="8314613">!</span><span class="ident" id="8314614">supportsIPv6</span>&nbsp;<span class="op" id="8314627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314631">b</span><span class="op" id="8314632">.</span><span class="ident" id="8314633">Skip</span><span class="op" id="8314637">(</span><span class="string" id="8314638">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8314661">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8314664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8314667">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8314698">(</span><span class="ident" id="8314699">b</span><span class="op" id="8314700">,</span>&nbsp;<span class="string" id="8314702">&#34;[::1]:0&#34;</span><span class="op" id="8314711">)</span><br>
<span class="lineno"></span><span class="op" id="8314713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8314716">func</span>&nbsp;<span class="ident" id="8314721">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8314752">(</span><span class="ident" id="8314753">b</span>&nbsp;<span class="op" id="8314755">*</span><span class="ident" id="8314756">testing</span><span class="op" id="8314763">.</span><span class="ident" id="8314764">B</span><span class="op" id="8314765">,</span>&nbsp;<span class="ident" id="8314767">laddr</span>&nbsp;<span class="builtintype" id="8314773">string</span><span class="op" id="8314779">)</span>&nbsp;<span class="op" id="8314781">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8314784">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8314842">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8314925">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8315007">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315058">b</span><span class="op" id="8315059">.</span><span class="ident" id="8315060">StopTimer</span><span class="op" id="8315069">(</span><span class="op" id="8315070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315074">P</span>&nbsp;<span class="op" id="8315076">:=</span>&nbsp;<span class="ident" id="8315079">runtime</span><span class="op" id="8315086">.</span><span class="ident" id="8315087">GOMAXPROCS</span><span class="op" id="8315097">(</span><span class="num" id="8315098">0</span><span class="op" id="8315099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315102">N</span>&nbsp;<span class="op" id="8315104">:=</span>&nbsp;<span class="ident" id="8315107">b</span><span class="op" id="8315108">.</span><span class="ident" id="8315109">N</span>&nbsp;<span class="op" id="8315111">/</span>&nbsp;<span class="ident" id="8315113">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315116">W</span>&nbsp;<span class="op" id="8315118">:=</span>&nbsp;<span class="num" id="8315121">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8315128">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315167">clients</span>&nbsp;<span class="op" id="8315175">:=</span>&nbsp;<span class="builtinfunc" id="8315178">make</span><span class="op" id="8315182">(</span><span class="op" id="8315183">[</span><span class="op" id="8315184">]</span><span class="ident" id="8315185">Conn</span><span class="op" id="8315189">,</span>&nbsp;<span class="ident" id="8315191">P</span><span class="op" id="8315192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315195">servers</span>&nbsp;<span class="op" id="8315203">:=</span>&nbsp;<span class="builtinfunc" id="8315206">make</span><span class="op" id="8315210">(</span><span class="op" id="8315211">[</span><span class="op" id="8315212">]</span><span class="ident" id="8315213">Conn</span><span class="op" id="8315217">,</span>&nbsp;<span class="ident" id="8315219">P</span><span class="op" id="8315220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315223">ln</span><span class="op" id="8315225">,</span>&nbsp;<span class="ident" id="8315227">err</span>&nbsp;<span class="op" id="8315231">:=</span>&nbsp;<span class="ident" id="8315234">Listen</span><span class="op" id="8315240">(</span><span class="string" id="8315241">&#34;tcp&#34;</span><span class="op" id="8315246">,</span>&nbsp;<span class="ident" id="8315248">laddr</span><span class="op" id="8315253">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315256">if</span>&nbsp;<span class="ident" id="8315259">err</span>&nbsp;<span class="op" id="8315263">!=</span>&nbsp;<span class="ident" id="8315266">nil</span>&nbsp;<span class="op" id="8315270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315274">b</span><span class="op" id="8315275">.</span><span class="ident" id="8315276">Fatalf</span><span class="op" id="8315282">(</span><span class="string" id="8315283">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8315302">,</span>&nbsp;<span class="ident" id="8315304">err</span><span class="op" id="8315307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315313">defer</span>&nbsp;<span class="ident" id="8315319">ln</span><span class="op" id="8315321">.</span><span class="ident" id="8315322">Close</span><span class="op" id="8315327">(</span><span class="op" id="8315328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315331">done</span>&nbsp;<span class="op" id="8315336">:=</span>&nbsp;<span class="builtinfunc" id="8315339">make</span><span class="op" id="8315343">(</span><span class="keyword" id="8315344">chan</span>&nbsp;<span class="builtintype" id="8315349">bool</span><span class="op" id="8315353">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315356">go</span>&nbsp;<span class="keyword" id="8315359">func</span><span class="op" id="8315363">(</span><span class="op" id="8315364">)</span>&nbsp;<span class="op" id="8315366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315370">for</span>&nbsp;<span class="ident" id="8315374">p</span>&nbsp;<span class="op" id="8315376">:=</span>&nbsp;<span class="num" id="8315379">0</span><span class="op" id="8315380">;</span>&nbsp;<span class="ident" id="8315382">p</span>&nbsp;<span class="op" id="8315384">&lt;</span>&nbsp;<span class="ident" id="8315386">P</span><span class="op" id="8315387">;</span>&nbsp;<span class="ident" id="8315389">p</span><span class="op" id="8315390">++</span>&nbsp;<span class="op" id="8315393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315398">s</span><span class="op" id="8315399">,</span>&nbsp;<span class="ident" id="8315401">err</span>&nbsp;<span class="op" id="8315405">:=</span>&nbsp;<span class="ident" id="8315408">ln</span><span class="op" id="8315410">.</span><span class="ident" id="8315411">Accept</span><span class="op" id="8315417">(</span><span class="op" id="8315418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315423">if</span>&nbsp;<span class="ident" id="8315426">err</span>&nbsp;<span class="op" id="8315430">!=</span>&nbsp;<span class="ident" id="8315433">nil</span>&nbsp;<span class="op" id="8315437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315443">b</span><span class="op" id="8315444">.</span><span class="ident" id="8315445">Errorf</span><span class="op" id="8315451">(</span><span class="string" id="8315452">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8315471">,</span>&nbsp;<span class="ident" id="8315473">err</span><span class="op" id="8315476">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315482">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315497">servers</span><span class="op" id="8315504">[</span><span class="ident" id="8315505">p</span><span class="op" id="8315506">]</span>&nbsp;<span class="op" id="8315508">=</span>&nbsp;<span class="ident" id="8315510">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315518">done</span>&nbsp;<span class="op" id="8315523">&lt;-</span>&nbsp;<span class="builtintype" id="8315526">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315532">}</span><span class="op" id="8315533">(</span><span class="op" id="8315534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315537">for</span>&nbsp;<span class="ident" id="8315541">p</span>&nbsp;<span class="op" id="8315543">:=</span>&nbsp;<span class="num" id="8315546">0</span><span class="op" id="8315547">;</span>&nbsp;<span class="ident" id="8315549">p</span>&nbsp;<span class="op" id="8315551">&lt;</span>&nbsp;<span class="ident" id="8315553">P</span><span class="op" id="8315554">;</span>&nbsp;<span class="ident" id="8315556">p</span><span class="op" id="8315557">++</span>&nbsp;<span class="op" id="8315560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315564">c</span><span class="op" id="8315565">,</span>&nbsp;<span class="ident" id="8315567">err</span>&nbsp;<span class="op" id="8315571">:=</span>&nbsp;<span class="ident" id="8315574">Dial</span><span class="op" id="8315578">(</span><span class="string" id="8315579">&#34;tcp&#34;</span><span class="op" id="8315584">,</span>&nbsp;<span class="ident" id="8315586">ln</span><span class="op" id="8315588">.</span><span class="ident" id="8315589">Addr</span><span class="op" id="8315593">(</span><span class="op" id="8315594">)</span><span class="op" id="8315595">.</span><span class="ident" id="8315596">String</span><span class="op" id="8315602">(</span><span class="op" id="8315603">)</span><span class="op" id="8315604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315608">if</span>&nbsp;<span class="ident" id="8315611">err</span>&nbsp;<span class="op" id="8315615">!=</span>&nbsp;<span class="ident" id="8315618">nil</span>&nbsp;<span class="op" id="8315622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315627">b</span><span class="op" id="8315628">.</span><span class="ident" id="8315629">Fatalf</span><span class="op" id="8315635">(</span><span class="string" id="8315636">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8315653">,</span>&nbsp;<span class="ident" id="8315655">err</span><span class="op" id="8315658">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315666">clients</span><span class="op" id="8315673">[</span><span class="ident" id="8315674">p</span><span class="op" id="8315675">]</span>&nbsp;<span class="op" id="8315677">=</span>&nbsp;<span class="ident" id="8315679">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315685">&lt;-</span><span class="ident" id="8315687">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315694">b</span><span class="op" id="8315695">.</span><span class="ident" id="8315696">StartTimer</span><span class="op" id="8315706">(</span><span class="op" id="8315707">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315711">var</span>&nbsp;<span class="ident" id="8315715">wg</span>&nbsp;<span class="ident" id="8315718">sync</span><span class="op" id="8315722">.</span><span class="ident" id="8315723">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315734">wg</span><span class="op" id="8315736">.</span><span class="ident" id="8315737">Add</span><span class="op" id="8315740">(</span><span class="num" id="8315741">4</span>&nbsp;<span class="op" id="8315743">*</span>&nbsp;<span class="ident" id="8315745">P</span><span class="op" id="8315746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315749">for</span>&nbsp;<span class="ident" id="8315753">p</span>&nbsp;<span class="op" id="8315755">:=</span>&nbsp;<span class="num" id="8315758">0</span><span class="op" id="8315759">;</span>&nbsp;<span class="ident" id="8315761">p</span>&nbsp;<span class="op" id="8315763">&lt;</span>&nbsp;<span class="ident" id="8315765">P</span><span class="op" id="8315766">;</span>&nbsp;<span class="ident" id="8315768">p</span><span class="op" id="8315769">++</span>&nbsp;<span class="op" id="8315772">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8315776">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315796">go</span>&nbsp;<span class="keyword" id="8315799">func</span><span class="op" id="8315803">(</span><span class="ident" id="8315804">c</span>&nbsp;<span class="ident" id="8315806">Conn</span><span class="op" id="8315810">)</span>&nbsp;<span class="op" id="8315812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315817">defer</span>&nbsp;<span class="ident" id="8315823">wg</span><span class="op" id="8315825">.</span><span class="ident" id="8315826">Done</span><span class="op" id="8315830">(</span><span class="op" id="8315831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315836">var</span>&nbsp;<span class="ident" id="8315840">buf</span>&nbsp;<span class="op" id="8315844">[</span><span class="num" id="8315845">1</span><span class="op" id="8315846">]</span><span class="builtintype" id="8315847">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315855">for</span>&nbsp;<span class="ident" id="8315859">i</span>&nbsp;<span class="op" id="8315861">:=</span>&nbsp;<span class="num" id="8315864">0</span><span class="op" id="8315865">;</span>&nbsp;<span class="ident" id="8315867">i</span>&nbsp;<span class="op" id="8315869">&lt;</span>&nbsp;<span class="ident" id="8315871">N</span><span class="op" id="8315872">;</span>&nbsp;<span class="ident" id="8315874">i</span><span class="op" id="8315875">++</span>&nbsp;<span class="op" id="8315878">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315884">v</span>&nbsp;<span class="op" id="8315886">:=</span>&nbsp;<span class="builtintype" id="8315889">byte</span><span class="op" id="8315893">(</span><span class="ident" id="8315894">i</span><span class="op" id="8315895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315901">for</span>&nbsp;<span class="ident" id="8315905">w</span>&nbsp;<span class="op" id="8315907">:=</span>&nbsp;<span class="num" id="8315910">0</span><span class="op" id="8315911">;</span>&nbsp;<span class="ident" id="8315913">w</span>&nbsp;<span class="op" id="8315915">&lt;</span>&nbsp;<span class="ident" id="8315917">W</span><span class="op" id="8315918">;</span>&nbsp;<span class="ident" id="8315920">w</span><span class="op" id="8315921">++</span>&nbsp;<span class="op" id="8315924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315931">v</span>&nbsp;<span class="op" id="8315933">*=</span>&nbsp;<span class="ident" id="8315936">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8315942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315948">buf</span><span class="op" id="8315951">[</span><span class="num" id="8315952">0</span><span class="op" id="8315953">]</span>&nbsp;<span class="op" id="8315955">=</span>&nbsp;<span class="ident" id="8315957">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8315963">_</span><span class="op" id="8315964">,</span>&nbsp;<span class="ident" id="8315966">err</span>&nbsp;<span class="op" id="8315970">:=</span>&nbsp;<span class="ident" id="8315973">c</span><span class="op" id="8315974">.</span><span class="ident" id="8315975">Write</span><span class="op" id="8315980">(</span><span class="ident" id="8315981">buf</span><span class="op" id="8315984">[</span><span class="op" id="8315985">:</span><span class="op" id="8315986">]</span><span class="op" id="8315987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8315993">if</span>&nbsp;<span class="ident" id="8315996">err</span>&nbsp;<span class="op" id="8316000">!=</span>&nbsp;<span class="ident" id="8316003">nil</span>&nbsp;<span class="op" id="8316007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316014">b</span><span class="op" id="8316015">.</span><span class="ident" id="8316016">Errorf</span><span class="op" id="8316022">(</span><span class="string" id="8316023">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8316041">,</span>&nbsp;<span class="ident" id="8316043">err</span><span class="op" id="8316046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316053">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316064">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316073">}</span><span class="op" id="8316074">(</span><span class="ident" id="8316075">clients</span><span class="op" id="8316082">[</span><span class="ident" id="8316083">p</span><span class="op" id="8316084">]</span><span class="op" id="8316085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8316090">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316141">pipe</span>&nbsp;<span class="op" id="8316146">:=</span>&nbsp;<span class="builtinfunc" id="8316149">make</span><span class="op" id="8316153">(</span><span class="keyword" id="8316154">chan</span>&nbsp;<span class="builtintype" id="8316159">byte</span><span class="op" id="8316163">,</span>&nbsp;<span class="num" id="8316165">128</span><span class="op" id="8316168">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8316173">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316193">go</span>&nbsp;<span class="keyword" id="8316196">func</span><span class="op" id="8316200">(</span><span class="ident" id="8316201">s</span>&nbsp;<span class="ident" id="8316203">Conn</span><span class="op" id="8316207">)</span>&nbsp;<span class="op" id="8316209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316214">defer</span>&nbsp;<span class="ident" id="8316220">wg</span><span class="op" id="8316222">.</span><span class="ident" id="8316223">Done</span><span class="op" id="8316227">(</span><span class="op" id="8316228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316233">var</span>&nbsp;<span class="ident" id="8316237">buf</span>&nbsp;<span class="op" id="8316241">[</span><span class="num" id="8316242">1</span><span class="op" id="8316243">]</span><span class="builtintype" id="8316244">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316252">for</span>&nbsp;<span class="ident" id="8316256">i</span>&nbsp;<span class="op" id="8316258">:=</span>&nbsp;<span class="num" id="8316261">0</span><span class="op" id="8316262">;</span>&nbsp;<span class="ident" id="8316264">i</span>&nbsp;<span class="op" id="8316266">&lt;</span>&nbsp;<span class="ident" id="8316268">N</span><span class="op" id="8316269">;</span>&nbsp;<span class="ident" id="8316271">i</span><span class="op" id="8316272">++</span>&nbsp;<span class="op" id="8316275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316281">_</span><span class="op" id="8316282">,</span>&nbsp;<span class="ident" id="8316284">err</span>&nbsp;<span class="op" id="8316288">:=</span>&nbsp;<span class="ident" id="8316291">s</span><span class="op" id="8316292">.</span><span class="ident" id="8316293">Read</span><span class="op" id="8316297">(</span><span class="ident" id="8316298">buf</span><span class="op" id="8316301">[</span><span class="op" id="8316302">:</span><span class="op" id="8316303">]</span><span class="op" id="8316304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316310">if</span>&nbsp;<span class="ident" id="8316313">err</span>&nbsp;<span class="op" id="8316317">!=</span>&nbsp;<span class="ident" id="8316320">nil</span>&nbsp;<span class="op" id="8316324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316331">b</span><span class="op" id="8316332">.</span><span class="ident" id="8316333">Errorf</span><span class="op" id="8316339">(</span><span class="string" id="8316340">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8316357">,</span>&nbsp;<span class="ident" id="8316359">err</span><span class="op" id="8316362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316369">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316386">pipe</span>&nbsp;<span class="op" id="8316391">&lt;-</span>&nbsp;<span class="ident" id="8316394">buf</span><span class="op" id="8316397">[</span><span class="num" id="8316398">0</span><span class="op" id="8316399">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316408">}</span><span class="op" id="8316409">(</span><span class="ident" id="8316410">servers</span><span class="op" id="8316417">[</span><span class="ident" id="8316418">p</span><span class="op" id="8316419">]</span><span class="op" id="8316420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8316425">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316445">go</span>&nbsp;<span class="keyword" id="8316448">func</span><span class="op" id="8316452">(</span><span class="ident" id="8316453">s</span>&nbsp;<span class="ident" id="8316455">Conn</span><span class="op" id="8316459">)</span>&nbsp;<span class="op" id="8316461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316466">defer</span>&nbsp;<span class="ident" id="8316472">wg</span><span class="op" id="8316474">.</span><span class="ident" id="8316475">Done</span><span class="op" id="8316479">(</span><span class="op" id="8316480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316485">var</span>&nbsp;<span class="ident" id="8316489">buf</span>&nbsp;<span class="op" id="8316493">[</span><span class="num" id="8316494">1</span><span class="op" id="8316495">]</span><span class="builtintype" id="8316496">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316504">for</span>&nbsp;<span class="ident" id="8316508">i</span>&nbsp;<span class="op" id="8316510">:=</span>&nbsp;<span class="num" id="8316513">0</span><span class="op" id="8316514">;</span>&nbsp;<span class="ident" id="8316516">i</span>&nbsp;<span class="op" id="8316518">&lt;</span>&nbsp;<span class="ident" id="8316520">N</span><span class="op" id="8316521">;</span>&nbsp;<span class="ident" id="8316523">i</span><span class="op" id="8316524">++</span>&nbsp;<span class="op" id="8316527">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316533">v</span>&nbsp;<span class="op" id="8316535">:=</span>&nbsp;<span class="op" id="8316538">&lt;-</span><span class="ident" id="8316540">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316549">for</span>&nbsp;<span class="ident" id="8316553">w</span>&nbsp;<span class="op" id="8316555">:=</span>&nbsp;<span class="num" id="8316558">0</span><span class="op" id="8316559">;</span>&nbsp;<span class="ident" id="8316561">w</span>&nbsp;<span class="op" id="8316563">&lt;</span>&nbsp;<span class="ident" id="8316565">W</span><span class="op" id="8316566">;</span>&nbsp;<span class="ident" id="8316568">w</span><span class="op" id="8316569">++</span>&nbsp;<span class="op" id="8316572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316579">v</span>&nbsp;<span class="op" id="8316581">*=</span>&nbsp;<span class="ident" id="8316584">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316596">buf</span><span class="op" id="8316599">[</span><span class="num" id="8316600">0</span><span class="op" id="8316601">]</span>&nbsp;<span class="op" id="8316603">=</span>&nbsp;<span class="ident" id="8316605">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316611">_</span><span class="op" id="8316612">,</span>&nbsp;<span class="ident" id="8316614">err</span>&nbsp;<span class="op" id="8316618">:=</span>&nbsp;<span class="ident" id="8316621">s</span><span class="op" id="8316622">.</span><span class="ident" id="8316623">Write</span><span class="op" id="8316628">(</span><span class="ident" id="8316629">buf</span><span class="op" id="8316632">[</span><span class="op" id="8316633">:</span><span class="op" id="8316634">]</span><span class="op" id="8316635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316641">if</span>&nbsp;<span class="ident" id="8316644">err</span>&nbsp;<span class="op" id="8316648">!=</span>&nbsp;<span class="ident" id="8316651">nil</span>&nbsp;<span class="op" id="8316655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316662">b</span><span class="op" id="8316663">.</span><span class="ident" id="8316664">Errorf</span><span class="op" id="8316670">(</span><span class="string" id="8316671">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8316689">,</span>&nbsp;<span class="ident" id="8316691">err</span><span class="op" id="8316694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316701">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316712">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316722">s</span><span class="op" id="8316723">.</span><span class="ident" id="8316724">Close</span><span class="op" id="8316729">(</span><span class="op" id="8316730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316734">}</span><span class="op" id="8316735">(</span><span class="ident" id="8316736">servers</span><span class="op" id="8316743">[</span><span class="ident" id="8316744">p</span><span class="op" id="8316745">]</span><span class="op" id="8316746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8316751">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316771">go</span>&nbsp;<span class="keyword" id="8316774">func</span><span class="op" id="8316778">(</span><span class="ident" id="8316779">c</span>&nbsp;<span class="ident" id="8316781">Conn</span><span class="op" id="8316785">)</span>&nbsp;<span class="op" id="8316787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316792">defer</span>&nbsp;<span class="ident" id="8316798">wg</span><span class="op" id="8316800">.</span><span class="ident" id="8316801">Done</span><span class="op" id="8316805">(</span><span class="op" id="8316806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316811">var</span>&nbsp;<span class="ident" id="8316815">buf</span>&nbsp;<span class="op" id="8316819">[</span><span class="num" id="8316820">1</span><span class="op" id="8316821">]</span><span class="builtintype" id="8316822">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316830">for</span>&nbsp;<span class="ident" id="8316834">i</span>&nbsp;<span class="op" id="8316836">:=</span>&nbsp;<span class="num" id="8316839">0</span><span class="op" id="8316840">;</span>&nbsp;<span class="ident" id="8316842">i</span>&nbsp;<span class="op" id="8316844">&lt;</span>&nbsp;<span class="ident" id="8316846">N</span><span class="op" id="8316847">;</span>&nbsp;<span class="ident" id="8316849">i</span><span class="op" id="8316850">++</span>&nbsp;<span class="op" id="8316853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316859">_</span><span class="op" id="8316860">,</span>&nbsp;<span class="ident" id="8316862">err</span>&nbsp;<span class="op" id="8316866">:=</span>&nbsp;<span class="ident" id="8316869">c</span><span class="op" id="8316870">.</span><span class="ident" id="8316871">Read</span><span class="op" id="8316875">(</span><span class="ident" id="8316876">buf</span><span class="op" id="8316879">[</span><span class="op" id="8316880">:</span><span class="op" id="8316881">]</span><span class="op" id="8316882">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316888">if</span>&nbsp;<span class="ident" id="8316891">err</span>&nbsp;<span class="op" id="8316895">!=</span>&nbsp;<span class="ident" id="8316898">nil</span>&nbsp;<span class="op" id="8316902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316909">b</span><span class="op" id="8316910">.</span><span class="ident" id="8316911">Errorf</span><span class="op" id="8316917">(</span><span class="string" id="8316918">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8316935">,</span>&nbsp;<span class="ident" id="8316937">err</span><span class="op" id="8316940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8316947">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316963">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316968">c</span><span class="op" id="8316969">.</span><span class="ident" id="8316970">Close</span><span class="op" id="8316975">(</span><span class="op" id="8316976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316980">}</span><span class="op" id="8316981">(</span><span class="ident" id="8316982">clients</span><span class="op" id="8316989">[</span><span class="ident" id="8316990">p</span><span class="op" id="8316991">]</span><span class="op" id="8316992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8316995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8316998">wg</span><span class="op" id="8317000">.</span><span class="ident" id="8317001">Wait</span><span class="op" id="8317005">(</span><span class="op" id="8317006">)</span><br>
<span class="lineno"></span><span class="op" id="8317008">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="8317011">type</span>&nbsp;<span class="ident" id="8317016">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="8317035">struct</span>&nbsp;<span class="op" id="8317042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8317045">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8317059">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8317067">litAddrOrName</span>&nbsp;<span class="builtintype" id="8317081">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8317089">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8317103">*</span><span class="ident" id="8317104">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8317113">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8317127">error</span><br>
<span class="lineno"></span><span class="op" id="8317133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8317136">var</span>&nbsp;<span class="ident" id="8317140">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8317160">=</span>&nbsp;<span class="op" id="8317162">[</span><span class="op" id="8317163">]</span><span class="ident" id="8317164">resolveTCPAddrTest</span><span class="op" id="8317182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317185">{</span><span class="string" id="8317186">&#34;tcp&#34;</span><span class="op" id="8317191">,</span>&nbsp;<span class="string" id="8317193">&#34;127.0.0.1:0&#34;</span><span class="op" id="8317206">,</span>&nbsp;<span class="op" id="8317208">&amp;</span><span class="ident" id="8317209">TCPAddr</span><span class="op" id="8317216">{</span><span class="ident" id="8317217">IP</span><span class="op" id="8317219">:</span>&nbsp;<span class="ident" id="8317221">IPv4</span><span class="op" id="8317225">(</span><span class="num" id="8317226">127</span><span class="op" id="8317229">,</span>&nbsp;<span class="num" id="8317231">0</span><span class="op" id="8317232">,</span>&nbsp;<span class="num" id="8317234">0</span><span class="op" id="8317235">,</span>&nbsp;<span class="num" id="8317237">1</span><span class="op" id="8317238">)</span><span class="op" id="8317239">,</span>&nbsp;<span class="ident" id="8317241">Port</span><span class="op" id="8317245">:</span>&nbsp;<span class="num" id="8317247">0</span><span class="op" id="8317248">}</span><span class="op" id="8317249">,</span>&nbsp;<span class="ident" id="8317251">nil</span><span class="op" id="8317254">}</span><span class="op" id="8317255">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317258">{</span><span class="string" id="8317259">&#34;tcp4&#34;</span><span class="op" id="8317265">,</span>&nbsp;<span class="string" id="8317267">&#34;127.0.0.1:65535&#34;</span><span class="op" id="8317284">,</span>&nbsp;<span class="op" id="8317286">&amp;</span><span class="ident" id="8317287">TCPAddr</span><span class="op" id="8317294">{</span><span class="ident" id="8317295">IP</span><span class="op" id="8317297">:</span>&nbsp;<span class="ident" id="8317299">IPv4</span><span class="op" id="8317303">(</span><span class="num" id="8317304">127</span><span class="op" id="8317307">,</span>&nbsp;<span class="num" id="8317309">0</span><span class="op" id="8317310">,</span>&nbsp;<span class="num" id="8317312">0</span><span class="op" id="8317313">,</span>&nbsp;<span class="num" id="8317315">1</span><span class="op" id="8317316">)</span><span class="op" id="8317317">,</span>&nbsp;<span class="ident" id="8317319">Port</span><span class="op" id="8317323">:</span>&nbsp;<span class="num" id="8317325">65535</span><span class="op" id="8317330">}</span><span class="op" id="8317331">,</span>&nbsp;<span class="ident" id="8317333">nil</span><span class="op" id="8317336">}</span><span class="op" id="8317337">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317341">{</span><span class="string" id="8317342">&#34;tcp&#34;</span><span class="op" id="8317347">,</span>&nbsp;<span class="string" id="8317349">&#34;[::1]:1&#34;</span><span class="op" id="8317358">,</span>&nbsp;<span class="op" id="8317360">&amp;</span><span class="ident" id="8317361">TCPAddr</span><span class="op" id="8317368">{</span><span class="ident" id="8317369">IP</span><span class="op" id="8317371">:</span>&nbsp;<span class="ident" id="8317373">ParseIP</span><span class="op" id="8317380">(</span><span class="string" id="8317381">&#34;::1&#34;</span><span class="op" id="8317386">)</span><span class="op" id="8317387">,</span>&nbsp;<span class="ident" id="8317389">Port</span><span class="op" id="8317393">:</span>&nbsp;<span class="num" id="8317395">1</span><span class="op" id="8317396">}</span><span class="op" id="8317397">,</span>&nbsp;<span class="ident" id="8317399">nil</span><span class="op" id="8317402">}</span><span class="op" id="8317403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317406">{</span><span class="string" id="8317407">&#34;tcp6&#34;</span><span class="op" id="8317413">,</span>&nbsp;<span class="string" id="8317415">&#34;[::1]:65534&#34;</span><span class="op" id="8317428">,</span>&nbsp;<span class="op" id="8317430">&amp;</span><span class="ident" id="8317431">TCPAddr</span><span class="op" id="8317438">{</span><span class="ident" id="8317439">IP</span><span class="op" id="8317441">:</span>&nbsp;<span class="ident" id="8317443">ParseIP</span><span class="op" id="8317450">(</span><span class="string" id="8317451">&#34;::1&#34;</span><span class="op" id="8317456">)</span><span class="op" id="8317457">,</span>&nbsp;<span class="ident" id="8317459">Port</span><span class="op" id="8317463">:</span>&nbsp;<span class="num" id="8317465">65534</span><span class="op" id="8317470">}</span><span class="op" id="8317471">,</span>&nbsp;<span class="ident" id="8317473">nil</span><span class="op" id="8317476">}</span><span class="op" id="8317477">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317481">{</span><span class="string" id="8317482">&#34;tcp&#34;</span><span class="op" id="8317487">,</span>&nbsp;<span class="string" id="8317489">&#34;[::1%en0]:1&#34;</span><span class="op" id="8317502">,</span>&nbsp;<span class="op" id="8317504">&amp;</span><span class="ident" id="8317505">TCPAddr</span><span class="op" id="8317512">{</span><span class="ident" id="8317513">IP</span><span class="op" id="8317515">:</span>&nbsp;<span class="ident" id="8317517">ParseIP</span><span class="op" id="8317524">(</span><span class="string" id="8317525">&#34;::1&#34;</span><span class="op" id="8317530">)</span><span class="op" id="8317531">,</span>&nbsp;<span class="ident" id="8317533">Port</span><span class="op" id="8317537">:</span>&nbsp;<span class="num" id="8317539">1</span><span class="op" id="8317540">,</span>&nbsp;<span class="ident" id="8317542">Zone</span><span class="op" id="8317546">:</span>&nbsp;<span class="string" id="8317548">&#34;en0&#34;</span><span class="op" id="8317553">}</span><span class="op" id="8317554">,</span>&nbsp;<span class="ident" id="8317556">nil</span><span class="op" id="8317559">}</span><span class="op" id="8317560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317563">{</span><span class="string" id="8317564">&#34;tcp6&#34;</span><span class="op" id="8317570">,</span>&nbsp;<span class="string" id="8317572">&#34;[::1%911]:2&#34;</span><span class="op" id="8317585">,</span>&nbsp;<span class="op" id="8317587">&amp;</span><span class="ident" id="8317588">TCPAddr</span><span class="op" id="8317595">{</span><span class="ident" id="8317596">IP</span><span class="op" id="8317598">:</span>&nbsp;<span class="ident" id="8317600">ParseIP</span><span class="op" id="8317607">(</span><span class="string" id="8317608">&#34;::1&#34;</span><span class="op" id="8317613">)</span><span class="op" id="8317614">,</span>&nbsp;<span class="ident" id="8317616">Port</span><span class="op" id="8317620">:</span>&nbsp;<span class="num" id="8317622">2</span><span class="op" id="8317623">,</span>&nbsp;<span class="ident" id="8317625">Zone</span><span class="op" id="8317629">:</span>&nbsp;<span class="string" id="8317631">&#34;911&#34;</span><span class="op" id="8317636">}</span><span class="op" id="8317637">,</span>&nbsp;<span class="ident" id="8317639">nil</span><span class="op" id="8317642">}</span><span class="op" id="8317643">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317647">{</span><span class="string" id="8317648">&#34;&#34;</span><span class="op" id="8317650">,</span>&nbsp;<span class="string" id="8317652">&#34;127.0.0.1:0&#34;</span><span class="op" id="8317665">,</span>&nbsp;<span class="op" id="8317667">&amp;</span><span class="ident" id="8317668">TCPAddr</span><span class="op" id="8317675">{</span><span class="ident" id="8317676">IP</span><span class="op" id="8317678">:</span>&nbsp;<span class="ident" id="8317680">IPv4</span><span class="op" id="8317684">(</span><span class="num" id="8317685">127</span><span class="op" id="8317688">,</span>&nbsp;<span class="num" id="8317690">0</span><span class="op" id="8317691">,</span>&nbsp;<span class="num" id="8317693">0</span><span class="op" id="8317694">,</span>&nbsp;<span class="num" id="8317696">1</span><span class="op" id="8317697">)</span><span class="op" id="8317698">,</span>&nbsp;<span class="ident" id="8317700">Port</span><span class="op" id="8317704">:</span>&nbsp;<span class="num" id="8317706">0</span><span class="op" id="8317707">}</span><span class="op" id="8317708">,</span>&nbsp;<span class="ident" id="8317710">nil</span><span class="op" id="8317713">}</span><span class="op" id="8317714">,</span>&nbsp;<span class="comment" id="8317716">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317736">{</span><span class="string" id="8317737">&#34;&#34;</span><span class="op" id="8317739">,</span>&nbsp;<span class="string" id="8317741">&#34;[::1]:0&#34;</span><span class="op" id="8317750">,</span>&nbsp;<span class="op" id="8317752">&amp;</span><span class="ident" id="8317753">TCPAddr</span><span class="op" id="8317760">{</span><span class="ident" id="8317761">IP</span><span class="op" id="8317763">:</span>&nbsp;<span class="ident" id="8317765">ParseIP</span><span class="op" id="8317772">(</span><span class="string" id="8317773">&#34;::1&#34;</span><span class="op" id="8317778">)</span><span class="op" id="8317779">,</span>&nbsp;<span class="ident" id="8317781">Port</span><span class="op" id="8317785">:</span>&nbsp;<span class="num" id="8317787">0</span><span class="op" id="8317788">}</span><span class="op" id="8317789">,</span>&nbsp;<span class="ident" id="8317791">nil</span><span class="op" id="8317794">}</span><span class="op" id="8317795">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8317805">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317826">{</span><span class="string" id="8317827">&#34;tcp&#34;</span><span class="op" id="8317832">,</span>&nbsp;<span class="string" id="8317834">&#34;:12345&#34;</span><span class="op" id="8317842">,</span>&nbsp;<span class="op" id="8317844">&amp;</span><span class="ident" id="8317845">TCPAddr</span><span class="op" id="8317852">{</span><span class="ident" id="8317853">Port</span><span class="op" id="8317857">:</span>&nbsp;<span class="num" id="8317859">12345</span><span class="op" id="8317864">}</span><span class="op" id="8317865">,</span>&nbsp;<span class="ident" id="8317867">nil</span><span class="op" id="8317870">}</span><span class="op" id="8317871">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8317875">{</span><span class="string" id="8317876">&#34;http&#34;</span><span class="op" id="8317882">,</span>&nbsp;<span class="string" id="8317884">&#34;127.0.0.1:0&#34;</span><span class="op" id="8317897">,</span>&nbsp;<span class="ident" id="8317899">nil</span><span class="op" id="8317902">,</span>&nbsp;<span class="ident" id="8317904">UnknownNetworkError</span><span class="op" id="8317923">(</span><span class="string" id="8317924">&#34;http&#34;</span><span class="op" id="8317930">)</span><span class="op" id="8317931">}</span><span class="op" id="8317932">,</span><br>
<span class="lineno"></span><span class="op" id="8317934">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="8317937">func</span>&nbsp;<span class="ident" id="8317942">init</span><span class="op" id="8317946">(</span><span class="op" id="8317947">)</span>&nbsp;<span class="op" id="8317949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8317952">if</span>&nbsp;<span class="ident" id="8317955">ifi</span>&nbsp;<span class="op" id="8317959">:=</span>&nbsp;<span class="ident" id="8317962">loopbackInterface</span><span class="op" id="8317979">(</span><span class="op" id="8317980">)</span><span class="op" id="8317981">;</span>&nbsp;<span class="ident" id="8317983">ifi</span>&nbsp;<span class="op" id="8317987">!=</span>&nbsp;<span class="ident" id="8317990">nil</span>&nbsp;<span class="op" id="8317994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8317998">index</span>&nbsp;<span class="op" id="8318004">:=</span>&nbsp;<span class="ident" id="8318007">fmt</span><span class="op" id="8318010">.</span><span class="ident" id="8318011">Sprintf</span><span class="op" id="8318018">(</span><span class="string" id="8318019">&#34;%v&#34;</span><span class="op" id="8318023">,</span>&nbsp;<span class="ident" id="8318025">ifi</span><span class="op" id="8318028">.</span><span class="ident" id="8318029">Index</span><span class="op" id="8318034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318038">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8318058">=</span>&nbsp;<span class="builtinfunc" id="8318060">append</span><span class="op" id="8318066">(</span><span class="ident" id="8318067">resolveTCPAddrTests</span><span class="op" id="8318086">,</span>&nbsp;<span class="op" id="8318088">[</span><span class="op" id="8318089">]</span><span class="ident" id="8318090">resolveTCPAddrTest</span><span class="op" id="8318108">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318113">{</span><span class="string" id="8318114">&#34;tcp6&#34;</span><span class="op" id="8318120">,</span>&nbsp;<span class="string" id="8318122">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8318134">+</span>&nbsp;<span class="ident" id="8318136">ifi</span><span class="op" id="8318139">.</span><span class="ident" id="8318140">Name</span>&nbsp;<span class="op" id="8318145">+</span>&nbsp;<span class="string" id="8318147">&#34;]:3&#34;</span><span class="op" id="8318152">,</span>&nbsp;<span class="op" id="8318154">&amp;</span><span class="ident" id="8318155">TCPAddr</span><span class="op" id="8318162">{</span><span class="ident" id="8318163">IP</span><span class="op" id="8318165">:</span>&nbsp;<span class="ident" id="8318167">ParseIP</span><span class="op" id="8318174">(</span><span class="string" id="8318175">&#34;fe80::1&#34;</span><span class="op" id="8318184">)</span><span class="op" id="8318185">,</span>&nbsp;<span class="ident" id="8318187">Port</span><span class="op" id="8318191">:</span>&nbsp;<span class="num" id="8318193">3</span><span class="op" id="8318194">,</span>&nbsp;<span class="ident" id="8318196">Zone</span><span class="op" id="8318200">:</span>&nbsp;<span class="ident" id="8318202">zoneToString</span><span class="op" id="8318214">(</span><span class="ident" id="8318215">ifi</span><span class="op" id="8318218">.</span><span class="ident" id="8318219">Index</span><span class="op" id="8318224">)</span><span class="op" id="8318225">}</span><span class="op" id="8318226">,</span>&nbsp;<span class="ident" id="8318228">nil</span><span class="op" id="8318231">}</span><span class="op" id="8318232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318237">{</span><span class="string" id="8318238">&#34;tcp6&#34;</span><span class="op" id="8318244">,</span>&nbsp;<span class="string" id="8318246">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8318258">+</span>&nbsp;<span class="ident" id="8318260">index</span>&nbsp;<span class="op" id="8318266">+</span>&nbsp;<span class="string" id="8318268">&#34;]:4&#34;</span><span class="op" id="8318273">,</span>&nbsp;<span class="op" id="8318275">&amp;</span><span class="ident" id="8318276">TCPAddr</span><span class="op" id="8318283">{</span><span class="ident" id="8318284">IP</span><span class="op" id="8318286">:</span>&nbsp;<span class="ident" id="8318288">ParseIP</span><span class="op" id="8318295">(</span><span class="string" id="8318296">&#34;fe80::1&#34;</span><span class="op" id="8318305">)</span><span class="op" id="8318306">,</span>&nbsp;<span class="ident" id="8318308">Port</span><span class="op" id="8318312">:</span>&nbsp;<span class="num" id="8318314">4</span><span class="op" id="8318315">,</span>&nbsp;<span class="ident" id="8318317">Zone</span><span class="op" id="8318321">:</span>&nbsp;<span class="ident" id="8318323">index</span><span class="op" id="8318328">}</span><span class="op" id="8318329">,</span>&nbsp;<span class="ident" id="8318331">nil</span><span class="op" id="8318334">}</span><span class="op" id="8318335">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318339">}</span><span class="op" id="8318340">...</span><span class="op" id="8318343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318349">if</span>&nbsp;<span class="ident" id="8318352">ips</span><span class="op" id="8318355">,</span>&nbsp;<span class="ident" id="8318357">err</span>&nbsp;<span class="op" id="8318361">:=</span>&nbsp;<span class="ident" id="8318364">LookupIP</span><span class="op" id="8318372">(</span><span class="string" id="8318373">&#34;localhost&#34;</span><span class="op" id="8318384">)</span><span class="op" id="8318385">;</span>&nbsp;<span class="ident" id="8318387">err</span>&nbsp;<span class="op" id="8318391">==</span>&nbsp;<span class="ident" id="8318394">nil</span>&nbsp;<span class="op" id="8318398">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="8318401">len</span><span class="op" id="8318404">(</span><span class="ident" id="8318405">ips</span><span class="op" id="8318408">)</span>&nbsp;<span class="op" id="8318410">&gt;</span>&nbsp;<span class="num" id="8318412">1</span>&nbsp;<span class="op" id="8318414">&amp;&amp;</span>&nbsp;<span class="ident" id="8318417">supportsIPv4</span>&nbsp;<span class="op" id="8318430">&amp;&amp;</span>&nbsp;<span class="ident" id="8318433">supportsIPv6</span>&nbsp;<span class="op" id="8318446">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318450">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8318470">=</span>&nbsp;<span class="builtinfunc" id="8318472">append</span><span class="op" id="8318478">(</span><span class="ident" id="8318479">resolveTCPAddrTests</span><span class="op" id="8318498">,</span>&nbsp;<span class="op" id="8318500">[</span><span class="op" id="8318501">]</span><span class="ident" id="8318502">resolveTCPAddrTest</span><span class="op" id="8318520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318525">{</span><span class="string" id="8318526">&#34;tcp&#34;</span><span class="op" id="8318531">,</span>&nbsp;<span class="string" id="8318533">&#34;localhost:5&#34;</span><span class="op" id="8318546">,</span>&nbsp;<span class="op" id="8318548">&amp;</span><span class="ident" id="8318549">TCPAddr</span><span class="op" id="8318556">{</span><span class="ident" id="8318557">IP</span><span class="op" id="8318559">:</span>&nbsp;<span class="ident" id="8318561">IPv4</span><span class="op" id="8318565">(</span><span class="num" id="8318566">127</span><span class="op" id="8318569">,</span>&nbsp;<span class="num" id="8318571">0</span><span class="op" id="8318572">,</span>&nbsp;<span class="num" id="8318574">0</span><span class="op" id="8318575">,</span>&nbsp;<span class="num" id="8318577">1</span><span class="op" id="8318578">)</span><span class="op" id="8318579">,</span>&nbsp;<span class="ident" id="8318581">Port</span><span class="op" id="8318585">:</span>&nbsp;<span class="num" id="8318587">5</span><span class="op" id="8318588">}</span><span class="op" id="8318589">,</span>&nbsp;<span class="ident" id="8318591">nil</span><span class="op" id="8318594">}</span><span class="op" id="8318595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318600">{</span><span class="string" id="8318601">&#34;tcp4&#34;</span><span class="op" id="8318607">,</span>&nbsp;<span class="string" id="8318609">&#34;localhost:6&#34;</span><span class="op" id="8318622">,</span>&nbsp;<span class="op" id="8318624">&amp;</span><span class="ident" id="8318625">TCPAddr</span><span class="op" id="8318632">{</span><span class="ident" id="8318633">IP</span><span class="op" id="8318635">:</span>&nbsp;<span class="ident" id="8318637">IPv4</span><span class="op" id="8318641">(</span><span class="num" id="8318642">127</span><span class="op" id="8318645">,</span>&nbsp;<span class="num" id="8318647">0</span><span class="op" id="8318648">,</span>&nbsp;<span class="num" id="8318650">0</span><span class="op" id="8318651">,</span>&nbsp;<span class="num" id="8318653">1</span><span class="op" id="8318654">)</span><span class="op" id="8318655">,</span>&nbsp;<span class="ident" id="8318657">Port</span><span class="op" id="8318661">:</span>&nbsp;<span class="num" id="8318663">6</span><span class="op" id="8318664">}</span><span class="op" id="8318665">,</span>&nbsp;<span class="ident" id="8318667">nil</span><span class="op" id="8318670">}</span><span class="op" id="8318671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318676">{</span><span class="string" id="8318677">&#34;tcp6&#34;</span><span class="op" id="8318683">,</span>&nbsp;<span class="string" id="8318685">&#34;localhost:7&#34;</span><span class="op" id="8318698">,</span>&nbsp;<span class="op" id="8318700">&amp;</span><span class="ident" id="8318701">TCPAddr</span><span class="op" id="8318708">{</span><span class="ident" id="8318709">IP</span><span class="op" id="8318711">:</span>&nbsp;<span class="ident" id="8318713">IPv6loopback</span><span class="op" id="8318725">,</span>&nbsp;<span class="ident" id="8318727">Port</span><span class="op" id="8318731">:</span>&nbsp;<span class="num" id="8318733">7</span><span class="op" id="8318734">}</span><span class="op" id="8318735">,</span>&nbsp;<span class="ident" id="8318737">nil</span><span class="op" id="8318740">}</span><span class="op" id="8318741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318745">}</span><span class="op" id="8318746">...</span><span class="op" id="8318749">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318752">}</span><br>
<span class="lineno"></span><span class="op" id="8318754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8318757">func</span>&nbsp;<span class="ident" id="8318762">TestResolveTCPAddr</span><span class="op" id="8318780">(</span><span class="ident" id="8318781">t</span>&nbsp;<span class="op" id="8318783">*</span><span class="ident" id="8318784">testing</span><span class="op" id="8318791">.</span><span class="ident" id="8318792">T</span><span class="op" id="8318793">)</span>&nbsp;<span class="op" id="8318795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318798">for</span>&nbsp;<span class="ident" id="8318802">_</span><span class="op" id="8318803">,</span>&nbsp;<span class="ident" id="8318805">tt</span>&nbsp;<span class="op" id="8318808">:=</span>&nbsp;<span class="keyword" id="8318811">range</span>&nbsp;<span class="ident" id="8318817">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8318837">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318841">addr</span><span class="op" id="8318845">,</span>&nbsp;<span class="ident" id="8318847">err</span>&nbsp;<span class="op" id="8318851">:=</span>&nbsp;<span class="ident" id="8318854">ResolveTCPAddr</span><span class="op" id="8318868">(</span><span class="ident" id="8318869">tt</span><span class="op" id="8318871">.</span><span class="ident" id="8318872">net</span><span class="op" id="8318875">,</span>&nbsp;<span class="ident" id="8318877">tt</span><span class="op" id="8318879">.</span><span class="ident" id="8318880">litAddrOrName</span><span class="op" id="8318893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8318897">if</span>&nbsp;<span class="ident" id="8318900">err</span>&nbsp;<span class="op" id="8318904">!=</span>&nbsp;<span class="ident" id="8318907">tt</span><span class="op" id="8318909">.</span><span class="ident" id="8318910">err</span>&nbsp;<span class="op" id="8318914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8318919">t</span><span class="op" id="8318920">.</span><span class="ident" id="8318921">Fatalf</span><span class="op" id="8318927">(</span><span class="string" id="8318928">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8318963">,</span>&nbsp;<span class="ident" id="8318965">tt</span><span class="op" id="8318967">.</span><span class="ident" id="8318968">net</span><span class="op" id="8318971">,</span>&nbsp;<span class="ident" id="8318973">tt</span><span class="op" id="8318975">.</span><span class="ident" id="8318976">litAddrOrName</span><span class="op" id="8318989">,</span>&nbsp;<span class="ident" id="8318991">err</span><span class="op" id="8318994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8318998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319002">if</span>&nbsp;<span class="op" id="8319005">!</span><span class="ident" id="8319006">reflect</span><span class="op" id="8319013">.</span><span class="ident" id="8319014">DeepEqual</span><span class="op" id="8319023">(</span><span class="ident" id="8319024">addr</span><span class="op" id="8319028">,</span>&nbsp;<span class="ident" id="8319030">tt</span><span class="op" id="8319032">.</span><span class="ident" id="8319033">addr</span><span class="op" id="8319037">)</span>&nbsp;<span class="op" id="8319039">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319044">t</span><span class="op" id="8319045">.</span><span class="ident" id="8319046">Fatalf</span><span class="op" id="8319052">(</span><span class="string" id="8319053">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8319093">,</span>&nbsp;<span class="ident" id="8319095">tt</span><span class="op" id="8319097">.</span><span class="ident" id="8319098">net</span><span class="op" id="8319101">,</span>&nbsp;<span class="ident" id="8319103">tt</span><span class="op" id="8319105">.</span><span class="ident" id="8319106">litAddrOrName</span><span class="op" id="8319119">,</span>&nbsp;<span class="ident" id="8319121">addr</span><span class="op" id="8319125">,</span>&nbsp;<span class="ident" id="8319127">tt</span><span class="op" id="8319129">.</span><span class="ident" id="8319130">addr</span><span class="op" id="8319134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319142">if</span>&nbsp;<span class="ident" id="8319145">err</span>&nbsp;<span class="op" id="8319149">==</span>&nbsp;<span class="ident" id="8319152">nil</span>&nbsp;<span class="op" id="8319156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319161">str</span>&nbsp;<span class="op" id="8319165">:=</span>&nbsp;<span class="ident" id="8319168">addr</span><span class="op" id="8319172">.</span><span class="ident" id="8319173">String</span><span class="op" id="8319179">(</span><span class="op" id="8319180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319185">addr1</span><span class="op" id="8319190">,</span>&nbsp;<span class="ident" id="8319192">err</span>&nbsp;<span class="op" id="8319196">:=</span>&nbsp;<span class="ident" id="8319199">ResolveTCPAddr</span><span class="op" id="8319213">(</span><span class="ident" id="8319214">tt</span><span class="op" id="8319216">.</span><span class="ident" id="8319217">net</span><span class="op" id="8319220">,</span>&nbsp;<span class="ident" id="8319222">str</span><span class="op" id="8319225">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319230">if</span>&nbsp;<span class="ident" id="8319233">err</span>&nbsp;<span class="op" id="8319237">!=</span>&nbsp;<span class="ident" id="8319240">nil</span>&nbsp;<span class="op" id="8319244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319250">t</span><span class="op" id="8319251">.</span><span class="ident" id="8319252">Fatalf</span><span class="op" id="8319258">(</span><span class="string" id="8319259">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="8319297">,</span>&nbsp;<span class="ident" id="8319299">tt</span><span class="op" id="8319301">.</span><span class="ident" id="8319302">net</span><span class="op" id="8319305">,</span>&nbsp;<span class="ident" id="8319307">str</span><span class="op" id="8319310">,</span>&nbsp;<span class="ident" id="8319312">tt</span><span class="op" id="8319314">.</span><span class="ident" id="8319315">litAddrOrName</span><span class="op" id="8319328">,</span>&nbsp;<span class="ident" id="8319330">err</span><span class="op" id="8319333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319343">if</span>&nbsp;<span class="op" id="8319346">!</span><span class="ident" id="8319347">reflect</span><span class="op" id="8319354">.</span><span class="ident" id="8319355">DeepEqual</span><span class="op" id="8319364">(</span><span class="ident" id="8319365">addr1</span><span class="op" id="8319370">,</span>&nbsp;<span class="ident" id="8319372">addr</span><span class="op" id="8319376">)</span>&nbsp;<span class="op" id="8319378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319384">t</span><span class="op" id="8319385">.</span><span class="ident" id="8319386">Fatalf</span><span class="op" id="8319392">(</span><span class="string" id="8319393">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8319443">,</span>&nbsp;<span class="ident" id="8319445">tt</span><span class="op" id="8319447">.</span><span class="ident" id="8319448">net</span><span class="op" id="8319451">,</span>&nbsp;<span class="ident" id="8319453">str</span><span class="op" id="8319456">,</span>&nbsp;<span class="ident" id="8319458">tt</span><span class="op" id="8319460">.</span><span class="ident" id="8319461">litAddrOrName</span><span class="op" id="8319474">,</span>&nbsp;<span class="ident" id="8319476">addr1</span><span class="op" id="8319481">,</span>&nbsp;<span class="ident" id="8319483">addr</span><span class="op" id="8319487">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319499">}</span><br>
<span class="lineno"></span><span class="op" id="8319501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="8319504">var</span>&nbsp;<span class="ident" id="8319508">tcpListenerNameTests</span>&nbsp;<span class="op" id="8319529">=</span>&nbsp;<span class="op" id="8319531">[</span><span class="op" id="8319532">]</span><span class="keyword" id="8319533">struct</span>&nbsp;<span class="op" id="8319540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319543">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8319549">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319557">laddr</span>&nbsp;<span class="op" id="8319563">*</span><span class="ident" id="8319564">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="8319572">}</span><span class="op" id="8319573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319576">{</span><span class="string" id="8319577">&#34;tcp4&#34;</span><span class="op" id="8319583">,</span>&nbsp;<span class="op" id="8319585">&amp;</span><span class="ident" id="8319586">TCPAddr</span><span class="op" id="8319593">{</span><span class="ident" id="8319594">IP</span><span class="op" id="8319596">:</span>&nbsp;<span class="ident" id="8319598">IPv4</span><span class="op" id="8319602">(</span><span class="num" id="8319603">127</span><span class="op" id="8319606">,</span>&nbsp;<span class="num" id="8319608">0</span><span class="op" id="8319609">,</span>&nbsp;<span class="num" id="8319611">0</span><span class="op" id="8319612">,</span>&nbsp;<span class="num" id="8319614">1</span><span class="op" id="8319615">)</span><span class="op" id="8319616">}</span><span class="op" id="8319617">}</span><span class="op" id="8319618">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319621">{</span><span class="string" id="8319622">&#34;tcp4&#34;</span><span class="op" id="8319628">,</span>&nbsp;<span class="op" id="8319630">&amp;</span><span class="ident" id="8319631">TCPAddr</span><span class="op" id="8319638">{</span><span class="op" id="8319639">}</span><span class="op" id="8319640">}</span><span class="op" id="8319641">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319644">{</span><span class="string" id="8319645">&#34;tcp4&#34;</span><span class="op" id="8319651">,</span>&nbsp;<span class="ident" id="8319653">nil</span><span class="op" id="8319656">}</span><span class="op" id="8319657">,</span><br>
<span class="lineno"></span><span class="op" id="8319659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8319662">func</span>&nbsp;<span class="ident" id="8319667">TestTCPListenerName</span><span class="op" id="8319686">(</span><span class="ident" id="8319687">t</span>&nbsp;<span class="op" id="8319689">*</span><span class="ident" id="8319690">testing</span><span class="op" id="8319697">.</span><span class="ident" id="8319698">T</span><span class="op" id="8319699">)</span>&nbsp;<span class="op" id="8319701">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319704">if</span>&nbsp;<span class="ident" id="8319707">testing</span><span class="op" id="8319714">.</span><span class="ident" id="8319715">Short</span><span class="op" id="8319720">(</span><span class="op" id="8319721">)</span>&nbsp;<span class="op" id="8319723">||</span>&nbsp;<span class="op" id="8319726">!</span><span class="op" id="8319727">*</span><span class="ident" id="8319728">testExternal</span>&nbsp;<span class="op" id="8319741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319745">t</span><span class="op" id="8319746">.</span><span class="ident" id="8319747">Skip</span><span class="op" id="8319751">(</span><span class="string" id="8319752">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8319793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319800">for</span>&nbsp;<span class="ident" id="8319804">_</span><span class="op" id="8319805">,</span>&nbsp;<span class="ident" id="8319807">tt</span>&nbsp;<span class="op" id="8319810">:=</span>&nbsp;<span class="keyword" id="8319813">range</span>&nbsp;<span class="ident" id="8319819">tcpListenerNameTests</span>&nbsp;<span class="op" id="8319840">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319844">ln</span><span class="op" id="8319846">,</span>&nbsp;<span class="ident" id="8319848">err</span>&nbsp;<span class="op" id="8319852">:=</span>&nbsp;<span class="ident" id="8319855">ListenTCP</span><span class="op" id="8319864">(</span><span class="ident" id="8319865">tt</span><span class="op" id="8319867">.</span><span class="ident" id="8319868">net</span><span class="op" id="8319871">,</span>&nbsp;<span class="ident" id="8319873">tt</span><span class="op" id="8319875">.</span><span class="ident" id="8319876">laddr</span><span class="op" id="8319881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319885">if</span>&nbsp;<span class="ident" id="8319888">err</span>&nbsp;<span class="op" id="8319892">!=</span>&nbsp;<span class="ident" id="8319895">nil</span>&nbsp;<span class="op" id="8319899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319904">t</span><span class="op" id="8319905">.</span><span class="ident" id="8319906">Fatalf</span><span class="op" id="8319912">(</span><span class="string" id="8319913">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8319935">,</span>&nbsp;<span class="ident" id="8319937">err</span><span class="op" id="8319940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8319944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319948">defer</span>&nbsp;<span class="ident" id="8319954">ln</span><span class="op" id="8319956">.</span><span class="ident" id="8319957">Close</span><span class="op" id="8319962">(</span><span class="op" id="8319963">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8319967">la</span>&nbsp;<span class="op" id="8319970">:=</span>&nbsp;<span class="ident" id="8319973">ln</span><span class="op" id="8319975">.</span><span class="ident" id="8319976">Addr</span><span class="op" id="8319980">(</span><span class="op" id="8319981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8319985">if</span>&nbsp;<span class="ident" id="8319988">a</span><span class="op" id="8319989">,</span>&nbsp;<span class="ident" id="8319991">ok</span>&nbsp;<span class="op" id="8319994">:=</span>&nbsp;<span class="ident" id="8319997">la</span><span class="op" id="8319999">.</span><span class="op" id="8320000">(</span><span class="op" id="8320001">*</span><span class="ident" id="8320002">TCPAddr</span><span class="op" id="8320009">)</span><span class="op" id="8320010">;</span>&nbsp;<span class="op" id="8320012">!</span><span class="ident" id="8320013">ok</span>&nbsp;<span class="op" id="8320016">||</span>&nbsp;<span class="ident" id="8320019">a</span><span class="op" id="8320020">.</span><span class="ident" id="8320021">Port</span>&nbsp;<span class="op" id="8320026">==</span>&nbsp;<span class="num" id="8320029">0</span>&nbsp;<span class="op" id="8320031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320036">t</span><span class="op" id="8320037">.</span><span class="ident" id="8320038">Fatalf</span><span class="op" id="8320044">(</span><span class="string" id="8320045">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="8320106">,</span>&nbsp;<span class="ident" id="8320108">la</span><span class="op" id="8320110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320117">}</span><br>
<span class="lineno">375</span><span class="op" id="8320119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8320122">func</span>&nbsp;<span class="ident" id="8320127">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="8320154">(</span><span class="ident" id="8320155">t</span>&nbsp;<span class="op" id="8320157">*</span><span class="ident" id="8320158">testing</span><span class="op" id="8320165">.</span><span class="ident" id="8320166">T</span><span class="op" id="8320167">)</span>&nbsp;<span class="op" id="8320169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320172">if</span>&nbsp;<span class="ident" id="8320175">testing</span><span class="op" id="8320182">.</span><span class="ident" id="8320183">Short</span><span class="op" id="8320188">(</span><span class="op" id="8320189">)</span>&nbsp;<span class="op" id="8320191">||</span>&nbsp;<span class="op" id="8320194">!</span><span class="op" id="8320195">*</span><span class="ident" id="8320196">testExternal</span>&nbsp;<span class="op" id="8320209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320213">t</span><span class="op" id="8320214">.</span><span class="ident" id="8320215">Skip</span><span class="op" id="8320219">(</span><span class="string" id="8320220">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8320261">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320267">if</span>&nbsp;<span class="op" id="8320270">!</span><span class="ident" id="8320271">supportsIPv6</span>&nbsp;<span class="op" id="8320284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320288">t</span><span class="op" id="8320289">.</span><span class="ident" id="8320290">Skip</span><span class="op" id="8320294">(</span><span class="string" id="8320295">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8320318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320324">ifi</span>&nbsp;<span class="op" id="8320328">:=</span>&nbsp;<span class="ident" id="8320331">loopbackInterface</span><span class="op" id="8320348">(</span><span class="op" id="8320349">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320352">if</span>&nbsp;<span class="ident" id="8320355">ifi</span>&nbsp;<span class="op" id="8320359">==</span>&nbsp;<span class="ident" id="8320362">nil</span>&nbsp;<span class="op" id="8320366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320370">t</span><span class="op" id="8320371">.</span><span class="ident" id="8320372">Skip</span><span class="op" id="8320376">(</span><span class="string" id="8320377">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="8320407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320413">laddr</span>&nbsp;<span class="op" id="8320419">:=</span>&nbsp;<span class="ident" id="8320422">ipv6LinkLocalUnicastAddr</span><span class="op" id="8320446">(</span><span class="ident" id="8320447">ifi</span><span class="op" id="8320450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320453">if</span>&nbsp;<span class="ident" id="8320456">laddr</span>&nbsp;<span class="op" id="8320462">==</span>&nbsp;<span class="string" id="8320465">&#34;&#34;</span>&nbsp;<span class="op" id="8320468">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320472">t</span><span class="op" id="8320473">.</span><span class="ident" id="8320474">Skip</span><span class="op" id="8320478">(</span><span class="string" id="8320479">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="8320523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320530">type</span>&nbsp;<span class="ident" id="8320535">test</span>&nbsp;<span class="keyword" id="8320540">struct</span>&nbsp;<span class="op" id="8320547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320551">net</span><span class="op" id="8320554">,</span>&nbsp;<span class="ident" id="8320556">addr</span>&nbsp;&nbsp;<span class="builtintype" id="8320562">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320571">nameLookup</span>&nbsp;<span class="builtintype" id="8320582">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320591">var</span>&nbsp;<span class="ident" id="8320595">tests</span>&nbsp;<span class="op" id="8320601">=</span>&nbsp;<span class="op" id="8320603">[</span><span class="op" id="8320604">]</span><span class="ident" id="8320605">test</span><span class="op" id="8320609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320613">{</span><span class="string" id="8320614">&#34;tcp&#34;</span><span class="op" id="8320619">,</span>&nbsp;<span class="string" id="8320621">&#34;[&#34;</span>&nbsp;<span class="op" id="8320625">+</span>&nbsp;<span class="ident" id="8320627">laddr</span>&nbsp;<span class="op" id="8320633">+</span>&nbsp;<span class="string" id="8320635">&#34;%&#34;</span>&nbsp;<span class="op" id="8320639">+</span>&nbsp;<span class="ident" id="8320641">ifi</span><span class="op" id="8320644">.</span><span class="ident" id="8320645">Name</span>&nbsp;<span class="op" id="8320650">+</span>&nbsp;<span class="string" id="8320652">&#34;]:0&#34;</span><span class="op" id="8320657">,</span>&nbsp;<span class="builtintype" id="8320659">false</span><span class="op" id="8320664">}</span><span class="op" id="8320665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320669">{</span><span class="string" id="8320670">&#34;tcp6&#34;</span><span class="op" id="8320676">,</span>&nbsp;<span class="string" id="8320678">&#34;[&#34;</span>&nbsp;<span class="op" id="8320682">+</span>&nbsp;<span class="ident" id="8320684">laddr</span>&nbsp;<span class="op" id="8320690">+</span>&nbsp;<span class="string" id="8320692">&#34;%&#34;</span>&nbsp;<span class="op" id="8320696">+</span>&nbsp;<span class="ident" id="8320698">ifi</span><span class="op" id="8320701">.</span><span class="ident" id="8320702">Name</span>&nbsp;<span class="op" id="8320707">+</span>&nbsp;<span class="string" id="8320709">&#34;]:0&#34;</span><span class="op" id="8320714">,</span>&nbsp;<span class="builtintype" id="8320716">false</span><span class="op" id="8320721">}</span><span class="op" id="8320722">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320728">switch</span>&nbsp;<span class="ident" id="8320735">runtime</span><span class="op" id="8320742">.</span><span class="ident" id="8320743">GOOS</span>&nbsp;<span class="op" id="8320748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320751">case</span>&nbsp;<span class="string" id="8320756">&#34;darwin&#34;</span><span class="op" id="8320764">,</span>&nbsp;<span class="string" id="8320766">&#34;freebsd&#34;</span><span class="op" id="8320775">,</span>&nbsp;<span class="string" id="8320777">&#34;openbsd&#34;</span><span class="op" id="8320786">,</span>&nbsp;<span class="string" id="8320788">&#34;netbsd&#34;</span><span class="op" id="8320796">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320800">tests</span>&nbsp;<span class="op" id="8320806">=</span>&nbsp;<span class="builtinfunc" id="8320808">append</span><span class="op" id="8320814">(</span><span class="ident" id="8320815">tests</span><span class="op" id="8320820">,</span>&nbsp;<span class="op" id="8320822">[</span><span class="op" id="8320823">]</span><span class="ident" id="8320824">test</span><span class="op" id="8320828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320833">{</span><span class="string" id="8320834">&#34;tcp&#34;</span><span class="op" id="8320839">,</span>&nbsp;<span class="string" id="8320841">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8320855">+</span>&nbsp;<span class="ident" id="8320857">ifi</span><span class="op" id="8320860">.</span><span class="ident" id="8320861">Name</span>&nbsp;<span class="op" id="8320866">+</span>&nbsp;<span class="string" id="8320868">&#34;]:0&#34;</span><span class="op" id="8320873">,</span>&nbsp;<span class="builtintype" id="8320875">true</span><span class="op" id="8320879">}</span><span class="op" id="8320880">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320885">{</span><span class="string" id="8320886">&#34;tcp6&#34;</span><span class="op" id="8320892">,</span>&nbsp;<span class="string" id="8320894">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8320908">+</span>&nbsp;<span class="ident" id="8320910">ifi</span><span class="op" id="8320913">.</span><span class="ident" id="8320914">Name</span>&nbsp;<span class="op" id="8320919">+</span>&nbsp;<span class="string" id="8320921">&#34;]:0&#34;</span><span class="op" id="8320926">,</span>&nbsp;<span class="builtintype" id="8320928">true</span><span class="op" id="8320932">}</span><span class="op" id="8320933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320937">}</span><span class="op" id="8320938">...</span><span class="op" id="8320941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8320944">case</span>&nbsp;<span class="string" id="8320949">&#34;linux&#34;</span><span class="op" id="8320956">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8320960">tests</span>&nbsp;<span class="op" id="8320966">=</span>&nbsp;<span class="builtinfunc" id="8320968">append</span><span class="op" id="8320974">(</span><span class="ident" id="8320975">tests</span><span class="op" id="8320980">,</span>&nbsp;<span class="op" id="8320982">[</span><span class="op" id="8320983">]</span><span class="ident" id="8320984">test</span><span class="op" id="8320988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8320993">{</span><span class="string" id="8320994">&#34;tcp&#34;</span><span class="op" id="8320999">,</span>&nbsp;<span class="string" id="8321001">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8321019">+</span>&nbsp;<span class="ident" id="8321021">ifi</span><span class="op" id="8321024">.</span><span class="ident" id="8321025">Name</span>&nbsp;<span class="op" id="8321030">+</span>&nbsp;<span class="string" id="8321032">&#34;]:0&#34;</span><span class="op" id="8321037">,</span>&nbsp;<span class="builtintype" id="8321039">true</span><span class="op" id="8321043">}</span><span class="op" id="8321044">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321049">{</span><span class="string" id="8321050">&#34;tcp6&#34;</span><span class="op" id="8321056">,</span>&nbsp;<span class="string" id="8321058">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8321076">+</span>&nbsp;<span class="ident" id="8321078">ifi</span><span class="op" id="8321081">.</span><span class="ident" id="8321082">Name</span>&nbsp;<span class="op" id="8321087">+</span>&nbsp;<span class="string" id="8321089">&#34;]:0&#34;</span><span class="op" id="8321094">,</span>&nbsp;<span class="builtintype" id="8321096">true</span><span class="op" id="8321100">}</span><span class="op" id="8321101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321105">}</span><span class="op" id="8321106">...</span><span class="op" id="8321109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321115">for</span>&nbsp;<span class="ident" id="8321119">_</span><span class="op" id="8321120">,</span>&nbsp;<span class="ident" id="8321122">tt</span>&nbsp;<span class="op" id="8321125">:=</span>&nbsp;<span class="keyword" id="8321128">range</span>&nbsp;<span class="ident" id="8321134">tests</span>&nbsp;<span class="op" id="8321140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321144">ln</span><span class="op" id="8321146">,</span>&nbsp;<span class="ident" id="8321148">err</span>&nbsp;<span class="op" id="8321152">:=</span>&nbsp;<span class="ident" id="8321155">Listen</span><span class="op" id="8321161">(</span><span class="ident" id="8321162">tt</span><span class="op" id="8321164">.</span><span class="ident" id="8321165">net</span><span class="op" id="8321168">,</span>&nbsp;<span class="ident" id="8321170">tt</span><span class="op" id="8321172">.</span><span class="ident" id="8321173">addr</span><span class="op" id="8321177">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321181">if</span>&nbsp;<span class="ident" id="8321184">err</span>&nbsp;<span class="op" id="8321188">!=</span>&nbsp;<span class="ident" id="8321191">nil</span>&nbsp;<span class="op" id="8321195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8321200">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8321246">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321295">t</span><span class="op" id="8321296">.</span><span class="ident" id="8321297">Logf</span><span class="op" id="8321301">(</span><span class="string" id="8321302">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8321321">,</span>&nbsp;<span class="ident" id="8321323">err</span><span class="op" id="8321326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321331">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321346">defer</span>&nbsp;<span class="ident" id="8321352">ln</span><span class="op" id="8321354">.</span><span class="ident" id="8321355">Close</span><span class="op" id="8321360">(</span><span class="op" id="8321361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321365">if</span>&nbsp;<span class="ident" id="8321368">la</span><span class="op" id="8321370">,</span>&nbsp;<span class="ident" id="8321372">ok</span>&nbsp;<span class="op" id="8321375">:=</span>&nbsp;<span class="ident" id="8321378">ln</span><span class="op" id="8321380">.</span><span class="ident" id="8321381">Addr</span><span class="op" id="8321385">(</span><span class="op" id="8321386">)</span><span class="op" id="8321387">.</span><span class="op" id="8321388">(</span><span class="op" id="8321389">*</span><span class="ident" id="8321390">TCPAddr</span><span class="op" id="8321397">)</span><span class="op" id="8321398">;</span>&nbsp;<span class="op" id="8321400">!</span><span class="ident" id="8321401">ok</span>&nbsp;<span class="op" id="8321404">||</span>&nbsp;<span class="op" id="8321407">!</span><span class="ident" id="8321408">tt</span><span class="op" id="8321410">.</span><span class="ident" id="8321411">nameLookup</span>&nbsp;<span class="op" id="8321422">&amp;&amp;</span>&nbsp;<span class="ident" id="8321425">la</span><span class="op" id="8321427">.</span><span class="ident" id="8321428">Zone</span>&nbsp;<span class="op" id="8321433">==</span>&nbsp;<span class="string" id="8321436">&#34;&#34;</span>&nbsp;<span class="op" id="8321439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321444">t</span><span class="op" id="8321445">.</span><span class="ident" id="8321446">Fatalf</span><span class="op" id="8321452">(</span><span class="string" id="8321453">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8321509">,</span>&nbsp;<span class="ident" id="8321511">la</span><span class="op" id="8321513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321517">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321522">done</span>&nbsp;<span class="op" id="8321527">:=</span>&nbsp;<span class="builtinfunc" id="8321530">make</span><span class="op" id="8321534">(</span><span class="keyword" id="8321535">chan</span>&nbsp;<span class="builtintype" id="8321540">int</span><span class="op" id="8321543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321547">go</span>&nbsp;<span class="ident" id="8321550">transponder</span><span class="op" id="8321561">(</span><span class="ident" id="8321562">t</span><span class="op" id="8321563">,</span>&nbsp;<span class="ident" id="8321565">ln</span><span class="op" id="8321567">,</span>&nbsp;<span class="ident" id="8321569">done</span><span class="op" id="8321573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321578">c</span><span class="op" id="8321579">,</span>&nbsp;<span class="ident" id="8321581">err</span>&nbsp;<span class="op" id="8321585">:=</span>&nbsp;<span class="ident" id="8321588">Dial</span><span class="op" id="8321592">(</span><span class="ident" id="8321593">tt</span><span class="op" id="8321595">.</span><span class="ident" id="8321596">net</span><span class="op" id="8321599">,</span>&nbsp;<span class="ident" id="8321601">ln</span><span class="op" id="8321603">.</span><span class="ident" id="8321604">Addr</span><span class="op" id="8321608">(</span><span class="op" id="8321609">)</span><span class="op" id="8321610">.</span><span class="ident" id="8321611">String</span><span class="op" id="8321617">(</span><span class="op" id="8321618">)</span><span class="op" id="8321619">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321623">if</span>&nbsp;<span class="ident" id="8321626">err</span>&nbsp;<span class="op" id="8321630">!=</span>&nbsp;<span class="ident" id="8321633">nil</span>&nbsp;<span class="op" id="8321637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321642">t</span><span class="op" id="8321643">.</span><span class="ident" id="8321644">Fatalf</span><span class="op" id="8321650">(</span><span class="string" id="8321651">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8321668">,</span>&nbsp;<span class="ident" id="8321670">err</span><span class="op" id="8321673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321681">defer</span>&nbsp;<span class="ident" id="8321687">c</span><span class="op" id="8321688">.</span><span class="ident" id="8321689">Close</span><span class="op" id="8321694">(</span><span class="op" id="8321695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321699">if</span>&nbsp;<span class="ident" id="8321702">la</span><span class="op" id="8321704">,</span>&nbsp;<span class="ident" id="8321706">ok</span>&nbsp;<span class="op" id="8321709">:=</span>&nbsp;<span class="ident" id="8321712">c</span><span class="op" id="8321713">.</span><span class="ident" id="8321714">LocalAddr</span><span class="op" id="8321723">(</span><span class="op" id="8321724">)</span><span class="op" id="8321725">.</span><span class="op" id="8321726">(</span><span class="op" id="8321727">*</span><span class="ident" id="8321728">TCPAddr</span><span class="op" id="8321735">)</span><span class="op" id="8321736">;</span>&nbsp;<span class="op" id="8321738">!</span><span class="ident" id="8321739">ok</span>&nbsp;<span class="op" id="8321742">||</span>&nbsp;<span class="op" id="8321745">!</span><span class="ident" id="8321746">tt</span><span class="op" id="8321748">.</span><span class="ident" id="8321749">nameLookup</span>&nbsp;<span class="op" id="8321760">&amp;&amp;</span>&nbsp;<span class="ident" id="8321763">la</span><span class="op" id="8321765">.</span><span class="ident" id="8321766">Zone</span>&nbsp;<span class="op" id="8321771">==</span>&nbsp;<span class="string" id="8321774">&#34;&#34;</span>&nbsp;<span class="op" id="8321777">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321782">t</span><span class="op" id="8321783">.</span><span class="ident" id="8321784">Fatalf</span><span class="op" id="8321790">(</span><span class="string" id="8321791">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8321847">,</span>&nbsp;<span class="ident" id="8321849">la</span><span class="op" id="8321851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8321855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8321859">if</span>&nbsp;<span class="ident" id="8321862">ra</span><span class="op" id="8321864">,</span>&nbsp;<span class="ident" id="8321866">ok</span>&nbsp;<span class="op" id="8321869">:=</span>&nbsp;<span class="ident" id="8321872">c</span><span class="op" id="8321873">.</span><span class="ident" id="8321874">RemoteAddr</span><span class="op" id="8321884">(</span><span class="op" id="8321885">)</span><span class="op" id="8321886">.</span><span class="op" id="8321887">(</span><span class="op" id="8321888">*</span><span class="ident" id="8321889">TCPAddr</span><span class="op" id="8321896">)</span><span class="op" id="8321897">;</span>&nbsp;<span class="op" id="8321899">!</span><span class="ident" id="8321900">ok</span>&nbsp;<span class="op" id="8321903">||</span>&nbsp;<span class="op" id="8321906">!</span><span class="ident" id="8321907">tt</span><span class="op" id="8321909">.</span><span class="ident" id="8321910">nameLookup</span>&nbsp;<span class="op" id="8321921">&amp;&amp;</span>&nbsp;<span class="ident" id="8321924">ra</span><span class="op" id="8321926">.</span><span class="ident" id="8321927">Zone</span>&nbsp;<span class="op" id="8321932">==</span>&nbsp;<span class="string" id="8321935">&#34;&#34;</span>&nbsp;<span class="op" id="8321938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8321943">t</span><span class="op" id="8321944">.</span><span class="ident" id="8321945">Fatalf</span><span class="op" id="8321951">(</span><span class="string" id="8321952">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8322008">,</span>&nbsp;<span class="ident" id="8322010">ra</span><span class="op" id="8322012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322016">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322021">if</span>&nbsp;<span class="ident" id="8322024">_</span><span class="op" id="8322025">,</span>&nbsp;<span class="ident" id="8322027">err</span>&nbsp;<span class="op" id="8322031">:=</span>&nbsp;<span class="ident" id="8322034">c</span><span class="op" id="8322035">.</span><span class="ident" id="8322036">Write</span><span class="op" id="8322041">(</span><span class="op" id="8322042">[</span><span class="op" id="8322043">]</span><span class="builtintype" id="8322044">byte</span><span class="op" id="8322048">(</span><span class="string" id="8322049">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="8322079">)</span><span class="op" id="8322080">)</span><span class="op" id="8322081">;</span>&nbsp;<span class="ident" id="8322083">err</span>&nbsp;<span class="op" id="8322087">!=</span>&nbsp;<span class="ident" id="8322090">nil</span>&nbsp;<span class="op" id="8322094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322099">t</span><span class="op" id="8322100">.</span><span class="ident" id="8322101">Fatalf</span><span class="op" id="8322107">(</span><span class="string" id="8322108">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8322131">,</span>&nbsp;<span class="ident" id="8322133">err</span><span class="op" id="8322136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322144">b</span>&nbsp;<span class="op" id="8322146">:=</span>&nbsp;<span class="builtinfunc" id="8322149">make</span><span class="op" id="8322153">(</span><span class="op" id="8322154">[</span><span class="op" id="8322155">]</span><span class="builtintype" id="8322156">byte</span><span class="op" id="8322160">,</span>&nbsp;<span class="num" id="8322162">32</span><span class="op" id="8322164">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322168">if</span>&nbsp;<span class="ident" id="8322171">_</span><span class="op" id="8322172">,</span>&nbsp;<span class="ident" id="8322174">err</span>&nbsp;<span class="op" id="8322178">:=</span>&nbsp;<span class="ident" id="8322181">c</span><span class="op" id="8322182">.</span><span class="ident" id="8322183">Read</span><span class="op" id="8322187">(</span><span class="ident" id="8322188">b</span><span class="op" id="8322189">)</span><span class="op" id="8322190">;</span>&nbsp;<span class="ident" id="8322192">err</span>&nbsp;<span class="op" id="8322196">!=</span>&nbsp;<span class="ident" id="8322199">nil</span>&nbsp;<span class="op" id="8322203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322208">t</span><span class="op" id="8322209">.</span><span class="ident" id="8322210">Fatalf</span><span class="op" id="8322216">(</span><span class="string" id="8322217">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8322239">,</span>&nbsp;<span class="ident" id="8322241">err</span><span class="op" id="8322244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322253">&lt;-</span><span class="ident" id="8322255">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322261">}</span><br>
<span class="lineno"></span><span class="op" id="8322263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8322266">func</span>&nbsp;<span class="ident" id="8322271">TestTCPConcurrentAccept</span><span class="op" id="8322294">(</span><span class="ident" id="8322295">t</span>&nbsp;<span class="op" id="8322297">*</span><span class="ident" id="8322298">testing</span><span class="op" id="8322305">.</span><span class="ident" id="8322306">T</span><span class="op" id="8322307">)</span>&nbsp;<span class="op" id="8322309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322312">defer</span>&nbsp;<span class="ident" id="8322318">runtime</span><span class="op" id="8322325">.</span><span class="ident" id="8322326">GOMAXPROCS</span><span class="op" id="8322336">(</span><span class="ident" id="8322337">runtime</span><span class="op" id="8322344">.</span><span class="ident" id="8322345">GOMAXPROCS</span><span class="op" id="8322355">(</span><span class="num" id="8322356">4</span><span class="op" id="8322357">)</span><span class="op" id="8322358">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322361">ln</span><span class="op" id="8322363">,</span>&nbsp;<span class="ident" id="8322365">err</span>&nbsp;<span class="op" id="8322369">:=</span>&nbsp;<span class="ident" id="8322372">Listen</span><span class="op" id="8322378">(</span><span class="string" id="8322379">&#34;tcp&#34;</span><span class="op" id="8322384">,</span>&nbsp;<span class="string" id="8322386">&#34;127.0.0.1:0&#34;</span><span class="op" id="8322399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322402">if</span>&nbsp;<span class="ident" id="8322405">err</span>&nbsp;<span class="op" id="8322409">!=</span>&nbsp;<span class="ident" id="8322412">nil</span>&nbsp;<span class="op" id="8322416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322420">t</span><span class="op" id="8322421">.</span><span class="ident" id="8322422">Fatalf</span><span class="op" id="8322428">(</span><span class="string" id="8322429">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8322448">,</span>&nbsp;<span class="ident" id="8322450">err</span><span class="op" id="8322453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322459">const</span>&nbsp;<span class="ident" id="8322465">N</span>&nbsp;<span class="op" id="8322467">=</span>&nbsp;<span class="num" id="8322469">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322473">var</span>&nbsp;<span class="ident" id="8322477">wg</span>&nbsp;<span class="ident" id="8322480">sync</span><span class="op" id="8322484">.</span><span class="ident" id="8322485">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322496">wg</span><span class="op" id="8322498">.</span><span class="ident" id="8322499">Add</span><span class="op" id="8322502">(</span><span class="ident" id="8322503">N</span><span class="op" id="8322504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322507">for</span>&nbsp;<span class="ident" id="8322511">i</span>&nbsp;<span class="op" id="8322513">:=</span>&nbsp;<span class="num" id="8322516">0</span><span class="op" id="8322517">;</span>&nbsp;<span class="ident" id="8322519">i</span>&nbsp;<span class="op" id="8322521">&lt;</span>&nbsp;<span class="ident" id="8322523">N</span><span class="op" id="8322524">;</span>&nbsp;<span class="ident" id="8322526">i</span><span class="op" id="8322527">++</span>&nbsp;<span class="op" id="8322530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322534">go</span>&nbsp;<span class="keyword" id="8322537">func</span><span class="op" id="8322541">(</span><span class="op" id="8322542">)</span>&nbsp;<span class="op" id="8322544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322549">for</span>&nbsp;<span class="op" id="8322553">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322559">c</span><span class="op" id="8322560">,</span>&nbsp;<span class="ident" id="8322562">err</span>&nbsp;<span class="op" id="8322566">:=</span>&nbsp;<span class="ident" id="8322569">ln</span><span class="op" id="8322571">.</span><span class="ident" id="8322572">Accept</span><span class="op" id="8322578">(</span><span class="op" id="8322579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322585">if</span>&nbsp;<span class="ident" id="8322588">err</span>&nbsp;<span class="op" id="8322592">!=</span>&nbsp;<span class="ident" id="8322595">nil</span>&nbsp;<span class="op" id="8322599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322606">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322622">c</span><span class="op" id="8322623">.</span><span class="ident" id="8322624">Close</span><span class="op" id="8322629">(</span><span class="op" id="8322630">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322640">wg</span><span class="op" id="8322642">.</span><span class="ident" id="8322643">Done</span><span class="op" id="8322647">(</span><span class="op" id="8322648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322652">}</span><span class="op" id="8322653">(</span><span class="op" id="8322654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322660">attempts</span>&nbsp;<span class="op" id="8322669">:=</span>&nbsp;<span class="num" id="8322672">10</span>&nbsp;<span class="op" id="8322675">*</span>&nbsp;<span class="ident" id="8322677">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322680">fails</span>&nbsp;<span class="op" id="8322686">:=</span>&nbsp;<span class="num" id="8322689">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322692">d</span>&nbsp;<span class="op" id="8322694">:=</span>&nbsp;<span class="op" id="8322697">&amp;</span><span class="ident" id="8322698">Dialer</span><span class="op" id="8322704">{</span><span class="ident" id="8322705">Timeout</span><span class="op" id="8322712">:</span>&nbsp;<span class="num" id="8322714">200</span>&nbsp;<span class="op" id="8322718">*</span>&nbsp;<span class="ident" id="8322720">time</span><span class="op" id="8322724">.</span><span class="ident" id="8322725">Millisecond</span><span class="op" id="8322736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322739">for</span>&nbsp;<span class="ident" id="8322743">i</span>&nbsp;<span class="op" id="8322745">:=</span>&nbsp;<span class="num" id="8322748">0</span><span class="op" id="8322749">;</span>&nbsp;<span class="ident" id="8322751">i</span>&nbsp;<span class="op" id="8322753">&lt;</span>&nbsp;<span class="ident" id="8322755">attempts</span><span class="op" id="8322763">;</span>&nbsp;<span class="ident" id="8322765">i</span><span class="op" id="8322766">++</span>&nbsp;<span class="op" id="8322769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322773">c</span><span class="op" id="8322774">,</span>&nbsp;<span class="ident" id="8322776">err</span>&nbsp;<span class="op" id="8322780">:=</span>&nbsp;<span class="ident" id="8322783">d</span><span class="op" id="8322784">.</span><span class="ident" id="8322785">Dial</span><span class="op" id="8322789">(</span><span class="string" id="8322790">&#34;tcp&#34;</span><span class="op" id="8322795">,</span>&nbsp;<span class="ident" id="8322797">ln</span><span class="op" id="8322799">.</span><span class="ident" id="8322800">Addr</span><span class="op" id="8322804">(</span><span class="op" id="8322805">)</span><span class="op" id="8322806">.</span><span class="ident" id="8322807">String</span><span class="op" id="8322813">(</span><span class="op" id="8322814">)</span><span class="op" id="8322815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322819">if</span>&nbsp;<span class="ident" id="8322822">err</span>&nbsp;<span class="op" id="8322826">!=</span>&nbsp;<span class="ident" id="8322829">nil</span>&nbsp;<span class="op" id="8322833">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322838">fails</span><span class="op" id="8322843">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322848">}</span>&nbsp;<span class="keyword" id="8322850">else</span>&nbsp;<span class="op" id="8322855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322860">c</span><span class="op" id="8322861">.</span><span class="ident" id="8322862">Close</span><span class="op" id="8322867">(</span><span class="op" id="8322868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8322875">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322878">ln</span><span class="op" id="8322880">.</span><span class="ident" id="8322881">Close</span><span class="op" id="8322886">(</span><span class="op" id="8322887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322890">wg</span><span class="op" id="8322892">.</span><span class="ident" id="8322893">Wait</span><span class="op" id="8322897">(</span><span class="op" id="8322898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8322901">if</span>&nbsp;<span class="ident" id="8322904">fails</span>&nbsp;<span class="op" id="8322910">&gt;</span>&nbsp;<span class="ident" id="8322912">attempts</span><span class="op" id="8322920">/</span><span class="num" id="8322921">9</span>&nbsp;<span class="op" id="8322923">{</span>&nbsp;<span class="comment" id="8322925">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8322955">t</span><span class="op" id="8322956">.</span><span class="ident" id="8322957">Fatalf</span><span class="op" id="8322963">(</span><span class="string" id="8322964">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8322990">,</span>&nbsp;<span class="ident" id="8322992">fails</span><span class="op" id="8322997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323000">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323003">if</span>&nbsp;<span class="ident" id="8323006">fails</span>&nbsp;<span class="op" id="8323012">&gt;</span>&nbsp;<span class="num" id="8323014">0</span>&nbsp;<span class="op" id="8323016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323020">t</span><span class="op" id="8323021">.</span><span class="ident" id="8323022">Logf</span><span class="op" id="8323026">(</span><span class="string" id="8323027">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="8323050">,</span>&nbsp;<span class="ident" id="8323052">fails</span><span class="op" id="8323057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323060">}</span><br>
<span class="lineno"></span><span class="op" id="8323062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="8323065">func</span>&nbsp;<span class="ident" id="8323070">TestTCPReadWriteMallocs</span><span class="op" id="8323093">(</span><span class="ident" id="8323094">t</span>&nbsp;<span class="op" id="8323096">*</span><span class="ident" id="8323097">testing</span><span class="op" id="8323104">.</span><span class="ident" id="8323105">T</span><span class="op" id="8323106">)</span>&nbsp;<span class="op" id="8323108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323111">if</span>&nbsp;<span class="ident" id="8323114">testing</span><span class="op" id="8323121">.</span><span class="ident" id="8323122">Short</span><span class="op" id="8323127">(</span><span class="op" id="8323128">)</span>&nbsp;<span class="op" id="8323130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323134">t</span><span class="op" id="8323135">.</span><span class="ident" id="8323136">Skip</span><span class="op" id="8323140">(</span><span class="string" id="8323141">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8323178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323184">ln</span><span class="op" id="8323186">,</span>&nbsp;<span class="ident" id="8323188">err</span>&nbsp;<span class="op" id="8323192">:=</span>&nbsp;<span class="ident" id="8323195">Listen</span><span class="op" id="8323201">(</span><span class="string" id="8323202">&#34;tcp&#34;</span><span class="op" id="8323207">,</span>&nbsp;<span class="string" id="8323209">&#34;127.0.0.1:0&#34;</span><span class="op" id="8323222">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323225">if</span>&nbsp;<span class="ident" id="8323228">err</span>&nbsp;<span class="op" id="8323232">!=</span>&nbsp;<span class="ident" id="8323235">nil</span>&nbsp;<span class="op" id="8323239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323243">t</span><span class="op" id="8323244">.</span><span class="ident" id="8323245">Fatalf</span><span class="op" id="8323251">(</span><span class="string" id="8323252">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8323271">,</span>&nbsp;<span class="ident" id="8323273">err</span><span class="op" id="8323276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323282">defer</span>&nbsp;<span class="ident" id="8323288">ln</span><span class="op" id="8323290">.</span><span class="ident" id="8323291">Close</span><span class="op" id="8323296">(</span><span class="op" id="8323297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323300">var</span>&nbsp;<span class="ident" id="8323304">server</span>&nbsp;<span class="ident" id="8323311">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323317">errc</span>&nbsp;<span class="op" id="8323322">:=</span>&nbsp;<span class="builtinfunc" id="8323325">make</span><span class="op" id="8323329">(</span><span class="keyword" id="8323330">chan</span>&nbsp;<span class="builtintype" id="8323335">error</span><span class="op" id="8323340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323343">go</span>&nbsp;<span class="keyword" id="8323346">func</span><span class="op" id="8323350">(</span><span class="op" id="8323351">)</span>&nbsp;<span class="op" id="8323353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323357">var</span>&nbsp;<span class="ident" id="8323361">err</span>&nbsp;<span class="builtintype" id="8323365">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323373">server</span><span class="op" id="8323379">,</span>&nbsp;<span class="ident" id="8323381">err</span>&nbsp;<span class="op" id="8323385">=</span>&nbsp;<span class="ident" id="8323387">ln</span><span class="op" id="8323389">.</span><span class="ident" id="8323390">Accept</span><span class="op" id="8323396">(</span><span class="op" id="8323397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323401">errc</span>&nbsp;<span class="op" id="8323406">&lt;-</span>&nbsp;<span class="ident" id="8323409">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323414">}</span><span class="op" id="8323415">(</span><span class="op" id="8323416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323419">client</span><span class="op" id="8323425">,</span>&nbsp;<span class="ident" id="8323427">err</span>&nbsp;<span class="op" id="8323431">:=</span>&nbsp;<span class="ident" id="8323434">Dial</span><span class="op" id="8323438">(</span><span class="string" id="8323439">&#34;tcp&#34;</span><span class="op" id="8323444">,</span>&nbsp;<span class="ident" id="8323446">ln</span><span class="op" id="8323448">.</span><span class="ident" id="8323449">Addr</span><span class="op" id="8323453">(</span><span class="op" id="8323454">)</span><span class="op" id="8323455">.</span><span class="ident" id="8323456">String</span><span class="op" id="8323462">(</span><span class="op" id="8323463">)</span><span class="op" id="8323464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323467">if</span>&nbsp;<span class="ident" id="8323470">err</span>&nbsp;<span class="op" id="8323474">!=</span>&nbsp;<span class="ident" id="8323477">nil</span>&nbsp;<span class="op" id="8323481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323485">t</span><span class="op" id="8323486">.</span><span class="ident" id="8323487">Fatalf</span><span class="op" id="8323493">(</span><span class="string" id="8323494">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8323511">,</span>&nbsp;<span class="ident" id="8323513">err</span><span class="op" id="8323516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323519">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323522">if</span>&nbsp;<span class="ident" id="8323525">err</span>&nbsp;<span class="op" id="8323529">:=</span>&nbsp;<span class="op" id="8323532">&lt;-</span><span class="ident" id="8323534">errc</span><span class="op" id="8323538">;</span>&nbsp;<span class="ident" id="8323540">err</span>&nbsp;<span class="op" id="8323544">!=</span>&nbsp;<span class="ident" id="8323547">nil</span>&nbsp;<span class="op" id="8323551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323555">t</span><span class="op" id="8323556">.</span><span class="ident" id="8323557">Fatalf</span><span class="op" id="8323563">(</span><span class="string" id="8323564">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8323583">,</span>&nbsp;<span class="ident" id="8323585">err</span><span class="op" id="8323588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323594">defer</span>&nbsp;<span class="ident" id="8323600">server</span><span class="op" id="8323606">.</span><span class="ident" id="8323607">Close</span><span class="op" id="8323612">(</span><span class="op" id="8323613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323616">var</span>&nbsp;<span class="ident" id="8323620">buf</span>&nbsp;<span class="op" id="8323624">[</span><span class="num" id="8323625">128</span><span class="op" id="8323628">]</span><span class="builtintype" id="8323629">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323635">mallocs</span>&nbsp;<span class="op" id="8323643">:=</span>&nbsp;<span class="ident" id="8323646">testing</span><span class="op" id="8323653">.</span><span class="ident" id="8323654">AllocsPerRun</span><span class="op" id="8323666">(</span><span class="num" id="8323667">1000</span><span class="op" id="8323671">,</span>&nbsp;<span class="keyword" id="8323673">func</span><span class="op" id="8323677">(</span><span class="op" id="8323678">)</span>&nbsp;<span class="op" id="8323680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323684">_</span><span class="op" id="8323685">,</span>&nbsp;<span class="ident" id="8323687">err</span>&nbsp;<span class="op" id="8323691">:=</span>&nbsp;<span class="ident" id="8323694">server</span><span class="op" id="8323700">.</span><span class="ident" id="8323701">Write</span><span class="op" id="8323706">(</span><span class="ident" id="8323707">buf</span><span class="op" id="8323710">[</span><span class="op" id="8323711">:</span><span class="op" id="8323712">]</span><span class="op" id="8323713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323717">if</span>&nbsp;<span class="ident" id="8323720">err</span>&nbsp;<span class="op" id="8323724">!=</span>&nbsp;<span class="ident" id="8323727">nil</span>&nbsp;<span class="op" id="8323731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323736">t</span><span class="op" id="8323737">.</span><span class="ident" id="8323738">Fatalf</span><span class="op" id="8323744">(</span><span class="string" id="8323745">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8323763">,</span>&nbsp;<span class="ident" id="8323765">err</span><span class="op" id="8323768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323772">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323776">_</span><span class="op" id="8323777">,</span>&nbsp;<span class="ident" id="8323779">err</span>&nbsp;<span class="op" id="8323783">=</span>&nbsp;<span class="ident" id="8323785">io</span><span class="op" id="8323787">.</span><span class="ident" id="8323788">ReadFull</span><span class="op" id="8323796">(</span><span class="ident" id="8323797">client</span><span class="op" id="8323803">,</span>&nbsp;<span class="ident" id="8323805">buf</span><span class="op" id="8323808">[</span><span class="op" id="8323809">:</span><span class="op" id="8323810">]</span><span class="op" id="8323811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323815">if</span>&nbsp;<span class="ident" id="8323818">err</span>&nbsp;<span class="op" id="8323822">!=</span>&nbsp;<span class="ident" id="8323825">nil</span>&nbsp;<span class="op" id="8323829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323834">t</span><span class="op" id="8323835">.</span><span class="ident" id="8323836">Fatalf</span><span class="op" id="8323842">(</span><span class="string" id="8323843">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8323860">,</span>&nbsp;<span class="ident" id="8323862">err</span><span class="op" id="8323865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323872">}</span><span class="op" id="8323873">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323876">if</span>&nbsp;<span class="ident" id="8323879">mallocs</span>&nbsp;<span class="op" id="8323887">&gt;</span>&nbsp;<span class="num" id="8323889">0</span>&nbsp;<span class="op" id="8323891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8323895">t</span><span class="op" id="8323896">.</span><span class="ident" id="8323897">Fatalf</span><span class="op" id="8323903">(</span><span class="string" id="8323904">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="8323927">,</span>&nbsp;<span class="ident" id="8323929">mallocs</span><span class="op" id="8323936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8323939">}</span><br>
<span class="lineno"></span><span class="op" id="8323941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8323944">func</span>&nbsp;<span class="ident" id="8323949">TestTCPStress</span><span class="op" id="8323962">(</span><span class="ident" id="8323963">t</span>&nbsp;<span class="op" id="8323965">*</span><span class="ident" id="8323966">testing</span><span class="op" id="8323973">.</span><span class="ident" id="8323974">T</span><span class="op" id="8323975">)</span>&nbsp;<span class="op" id="8323977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323980">const</span>&nbsp;<span class="ident" id="8323986">conns</span>&nbsp;<span class="op" id="8323992">=</span>&nbsp;<span class="num" id="8323994">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8323997">const</span>&nbsp;<span class="ident" id="8324003">msgLen</span>&nbsp;<span class="op" id="8324010">=</span>&nbsp;<span class="num" id="8324012">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324017">msgs</span>&nbsp;<span class="op" id="8324022">:=</span>&nbsp;<span class="builtintype" id="8324025">int</span><span class="op" id="8324028">(</span><span class="num" id="8324029">1e4</span><span class="op" id="8324032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324035">if</span>&nbsp;<span class="ident" id="8324038">testing</span><span class="op" id="8324045">.</span><span class="ident" id="8324046">Short</span><span class="op" id="8324051">(</span><span class="op" id="8324052">)</span>&nbsp;<span class="op" id="8324054">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324058">msgs</span>&nbsp;<span class="op" id="8324063">=</span>&nbsp;<span class="num" id="8324065">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324074">sendMsg</span>&nbsp;<span class="op" id="8324082">:=</span>&nbsp;<span class="keyword" id="8324085">func</span><span class="op" id="8324089">(</span><span class="ident" id="8324090">c</span>&nbsp;<span class="ident" id="8324092">Conn</span><span class="op" id="8324096">,</span>&nbsp;<span class="ident" id="8324098">buf</span>&nbsp;<span class="op" id="8324102">[</span><span class="op" id="8324103">]</span><span class="builtintype" id="8324104">byte</span><span class="op" id="8324108">)</span>&nbsp;<span class="builtintype" id="8324110">bool</span>&nbsp;<span class="op" id="8324115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324119">n</span><span class="op" id="8324120">,</span>&nbsp;<span class="ident" id="8324122">err</span>&nbsp;<span class="op" id="8324126">:=</span>&nbsp;<span class="ident" id="8324129">c</span><span class="op" id="8324130">.</span><span class="ident" id="8324131">Write</span><span class="op" id="8324136">(</span><span class="ident" id="8324137">buf</span><span class="op" id="8324140">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324144">if</span>&nbsp;<span class="ident" id="8324147">n</span>&nbsp;<span class="op" id="8324149">!=</span>&nbsp;<span class="builtinfunc" id="8324152">len</span><span class="op" id="8324155">(</span><span class="ident" id="8324156">buf</span><span class="op" id="8324159">)</span>&nbsp;<span class="op" id="8324161">||</span>&nbsp;<span class="ident" id="8324164">err</span>&nbsp;<span class="op" id="8324168">!=</span>&nbsp;<span class="ident" id="8324171">nil</span>&nbsp;<span class="op" id="8324175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324180">t</span><span class="op" id="8324181">.</span><span class="ident" id="8324182">Logf</span><span class="op" id="8324186">(</span><span class="string" id="8324187">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8324205">,</span>&nbsp;<span class="ident" id="8324207">err</span><span class="op" id="8324210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324215">return</span>&nbsp;<span class="builtintype" id="8324222">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324234">return</span>&nbsp;<span class="builtintype" id="8324241">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324250">recvMsg</span>&nbsp;<span class="op" id="8324258">:=</span>&nbsp;<span class="keyword" id="8324261">func</span><span class="op" id="8324265">(</span><span class="ident" id="8324266">c</span>&nbsp;<span class="ident" id="8324268">Conn</span><span class="op" id="8324272">,</span>&nbsp;<span class="ident" id="8324274">buf</span>&nbsp;<span class="op" id="8324278">[</span><span class="op" id="8324279">]</span><span class="builtintype" id="8324280">byte</span><span class="op" id="8324284">)</span>&nbsp;<span class="builtintype" id="8324286">bool</span>&nbsp;<span class="op" id="8324291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324295">for</span>&nbsp;<span class="ident" id="8324299">read</span>&nbsp;<span class="op" id="8324304">:=</span>&nbsp;<span class="num" id="8324307">0</span><span class="op" id="8324308">;</span>&nbsp;<span class="ident" id="8324310">read</span>&nbsp;<span class="op" id="8324315">!=</span>&nbsp;<span class="builtinfunc" id="8324318">len</span><span class="op" id="8324321">(</span><span class="ident" id="8324322">buf</span><span class="op" id="8324325">)</span><span class="op" id="8324326">;</span>&nbsp;<span class="op" id="8324328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324333">n</span><span class="op" id="8324334">,</span>&nbsp;<span class="ident" id="8324336">err</span>&nbsp;<span class="op" id="8324340">:=</span>&nbsp;<span class="ident" id="8324343">c</span><span class="op" id="8324344">.</span><span class="ident" id="8324345">Read</span><span class="op" id="8324349">(</span><span class="ident" id="8324350">buf</span><span class="op" id="8324353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324358">read</span>&nbsp;<span class="op" id="8324363">+=</span>&nbsp;<span class="ident" id="8324366">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324371">if</span>&nbsp;<span class="ident" id="8324374">err</span>&nbsp;<span class="op" id="8324378">!=</span>&nbsp;<span class="ident" id="8324381">nil</span>&nbsp;<span class="op" id="8324385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324391">t</span><span class="op" id="8324392">.</span><span class="ident" id="8324393">Logf</span><span class="op" id="8324397">(</span><span class="string" id="8324398">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8324415">,</span>&nbsp;<span class="ident" id="8324417">err</span><span class="op" id="8324420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324426">return</span>&nbsp;<span class="builtintype" id="8324433">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324446">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324450">return</span>&nbsp;<span class="builtintype" id="8324457">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324467">ln</span><span class="op" id="8324469">,</span>&nbsp;<span class="ident" id="8324471">err</span>&nbsp;<span class="op" id="8324475">:=</span>&nbsp;<span class="ident" id="8324478">Listen</span><span class="op" id="8324484">(</span><span class="string" id="8324485">&#34;tcp&#34;</span><span class="op" id="8324490">,</span>&nbsp;<span class="string" id="8324492">&#34;127.0.0.1:0&#34;</span><span class="op" id="8324505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324508">if</span>&nbsp;<span class="ident" id="8324511">err</span>&nbsp;<span class="op" id="8324515">!=</span>&nbsp;<span class="ident" id="8324518">nil</span>&nbsp;<span class="op" id="8324522">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324526">t</span><span class="op" id="8324527">.</span><span class="ident" id="8324528">Fatalf</span><span class="op" id="8324534">(</span><span class="string" id="8324535">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8324554">,</span>&nbsp;<span class="ident" id="8324556">err</span><span class="op" id="8324559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324565">defer</span>&nbsp;<span class="ident" id="8324571">ln</span><span class="op" id="8324573">.</span><span class="ident" id="8324574">Close</span><span class="op" id="8324579">(</span><span class="op" id="8324580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8324583">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324597">go</span>&nbsp;<span class="keyword" id="8324600">func</span><span class="op" id="8324604">(</span><span class="op" id="8324605">)</span>&nbsp;<span class="op" id="8324607">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324611">for</span>&nbsp;<span class="op" id="8324615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324620">c</span><span class="op" id="8324621">,</span>&nbsp;<span class="ident" id="8324623">err</span>&nbsp;<span class="op" id="8324627">:=</span>&nbsp;<span class="ident" id="8324630">ln</span><span class="op" id="8324632">.</span><span class="ident" id="8324633">Accept</span><span class="op" id="8324639">(</span><span class="op" id="8324640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324645">if</span>&nbsp;<span class="ident" id="8324648">err</span>&nbsp;<span class="op" id="8324652">!=</span>&nbsp;<span class="ident" id="8324655">nil</span>&nbsp;<span class="op" id="8324659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324665">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324674">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8324679">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324704">go</span>&nbsp;<span class="keyword" id="8324707">func</span><span class="op" id="8324711">(</span><span class="ident" id="8324712">c</span>&nbsp;<span class="ident" id="8324714">Conn</span><span class="op" id="8324718">)</span>&nbsp;<span class="op" id="8324720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324726">defer</span>&nbsp;<span class="ident" id="8324732">c</span><span class="op" id="8324733">.</span><span class="ident" id="8324734">Close</span><span class="op" id="8324739">(</span><span class="op" id="8324740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324746">var</span>&nbsp;<span class="ident" id="8324750">buf</span>&nbsp;<span class="op" id="8324754">[</span><span class="ident" id="8324755">msgLen</span><span class="op" id="8324761">]</span><span class="builtintype" id="8324762">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324771">for</span>&nbsp;<span class="ident" id="8324775">m</span>&nbsp;<span class="op" id="8324777">:=</span>&nbsp;<span class="num" id="8324780">0</span><span class="op" id="8324781">;</span>&nbsp;<span class="ident" id="8324783">m</span>&nbsp;<span class="op" id="8324785">&lt;</span>&nbsp;<span class="ident" id="8324787">msgs</span><span class="op" id="8324791">;</span>&nbsp;<span class="ident" id="8324793">m</span><span class="op" id="8324794">++</span>&nbsp;<span class="op" id="8324797">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324804">if</span>&nbsp;<span class="op" id="8324807">!</span><span class="ident" id="8324808">recvMsg</span><span class="op" id="8324815">(</span><span class="ident" id="8324816">c</span><span class="op" id="8324817">,</span>&nbsp;<span class="ident" id="8324819">buf</span><span class="op" id="8324822">[</span><span class="op" id="8324823">:</span><span class="op" id="8324824">]</span><span class="op" id="8324825">)</span>&nbsp;<span class="op" id="8324827">||</span>&nbsp;<span class="op" id="8324830">!</span><span class="ident" id="8324831">sendMsg</span><span class="op" id="8324838">(</span><span class="ident" id="8324839">c</span><span class="op" id="8324840">,</span>&nbsp;<span class="ident" id="8324842">buf</span><span class="op" id="8324845">[</span><span class="op" id="8324846">:</span><span class="op" id="8324847">]</span><span class="op" id="8324848">)</span>&nbsp;<span class="op" id="8324850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324858">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324880">}</span><span class="op" id="8324881">(</span><span class="ident" id="8324882">c</span><span class="op" id="8324883">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8324890">}</span><span class="op" id="8324891">(</span><span class="op" id="8324892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8324895">done</span>&nbsp;<span class="op" id="8324900">:=</span>&nbsp;<span class="builtinfunc" id="8324903">make</span><span class="op" id="8324907">(</span><span class="keyword" id="8324908">chan</span>&nbsp;<span class="builtintype" id="8324913">bool</span><span class="op" id="8324917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324920">for</span>&nbsp;<span class="ident" id="8324924">i</span>&nbsp;<span class="op" id="8324926">:=</span>&nbsp;<span class="num" id="8324929">0</span><span class="op" id="8324930">;</span>&nbsp;<span class="ident" id="8324932">i</span>&nbsp;<span class="op" id="8324934">&lt;</span>&nbsp;<span class="ident" id="8324936">conns</span><span class="op" id="8324941">;</span>&nbsp;<span class="ident" id="8324943">i</span><span class="op" id="8324944">++</span>&nbsp;<span class="op" id="8324947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8324951">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324975">go</span>&nbsp;<span class="keyword" id="8324978">func</span><span class="op" id="8324982">(</span><span class="op" id="8324983">)</span>&nbsp;<span class="op" id="8324985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8324990">defer</span>&nbsp;<span class="keyword" id="8324996">func</span><span class="op" id="8325000">(</span><span class="op" id="8325001">)</span>&nbsp;<span class="op" id="8325003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8325009">done</span>&nbsp;<span class="op" id="8325014">&lt;-</span>&nbsp;<span class="builtintype" id="8325017">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325025">}</span><span class="op" id="8325026">(</span><span class="op" id="8325027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8325032">c</span><span class="op" id="8325033">,</span>&nbsp;<span class="ident" id="8325035">err</span>&nbsp;<span class="op" id="8325039">:=</span>&nbsp;<span class="ident" id="8325042">Dial</span><span class="op" id="8325046">(</span><span class="string" id="8325047">&#34;tcp&#34;</span><span class="op" id="8325052">,</span>&nbsp;<span class="ident" id="8325054">ln</span><span class="op" id="8325056">.</span><span class="ident" id="8325057">Addr</span><span class="op" id="8325061">(</span><span class="op" id="8325062">)</span><span class="op" id="8325063">.</span><span class="ident" id="8325064">String</span><span class="op" id="8325070">(</span><span class="op" id="8325071">)</span><span class="op" id="8325072">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325077">if</span>&nbsp;<span class="ident" id="8325080">err</span>&nbsp;<span class="op" id="8325084">!=</span>&nbsp;<span class="ident" id="8325087">nil</span>&nbsp;<span class="op" id="8325091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8325097">t</span><span class="op" id="8325098">.</span><span class="ident" id="8325099">Logf</span><span class="op" id="8325103">(</span><span class="string" id="8325104">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8325121">,</span>&nbsp;<span class="ident" id="8325123">err</span><span class="op" id="8325126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325132">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325147">defer</span>&nbsp;<span class="ident" id="8325153">c</span><span class="op" id="8325154">.</span><span class="ident" id="8325155">Close</span><span class="op" id="8325160">(</span><span class="op" id="8325161">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325166">var</span>&nbsp;<span class="ident" id="8325170">buf</span>&nbsp;<span class="op" id="8325174">[</span><span class="ident" id="8325175">msgLen</span><span class="op" id="8325181">]</span><span class="builtintype" id="8325182">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325190">for</span>&nbsp;<span class="ident" id="8325194">m</span>&nbsp;<span class="op" id="8325196">:=</span>&nbsp;<span class="num" id="8325199">0</span><span class="op" id="8325200">;</span>&nbsp;<span class="ident" id="8325202">m</span>&nbsp;<span class="op" id="8325204">&lt;</span>&nbsp;<span class="ident" id="8325206">msgs</span><span class="op" id="8325210">;</span>&nbsp;<span class="ident" id="8325212">m</span><span class="op" id="8325213">++</span>&nbsp;<span class="op" id="8325216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325222">if</span>&nbsp;<span class="op" id="8325225">!</span><span class="ident" id="8325226">sendMsg</span><span class="op" id="8325233">(</span><span class="ident" id="8325234">c</span><span class="op" id="8325235">,</span>&nbsp;<span class="ident" id="8325237">buf</span><span class="op" id="8325240">[</span><span class="op" id="8325241">:</span><span class="op" id="8325242">]</span><span class="op" id="8325243">)</span>&nbsp;<span class="op" id="8325245">||</span>&nbsp;<span class="op" id="8325248">!</span><span class="ident" id="8325249">recvMsg</span><span class="op" id="8325256">(</span><span class="ident" id="8325257">c</span><span class="op" id="8325258">,</span>&nbsp;<span class="ident" id="8325260">buf</span><span class="op" id="8325263">[</span><span class="op" id="8325264">:</span><span class="op" id="8325265">]</span><span class="op" id="8325266">)</span>&nbsp;<span class="op" id="8325268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325275">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325285">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325294">}</span><span class="op" id="8325295">(</span><span class="op" id="8325296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8325302">for</span>&nbsp;<span class="ident" id="8325306">i</span>&nbsp;<span class="op" id="8325308">:=</span>&nbsp;<span class="num" id="8325311">0</span><span class="op" id="8325312">;</span>&nbsp;<span class="ident" id="8325314">i</span>&nbsp;<span class="op" id="8325316">&lt;</span>&nbsp;<span class="ident" id="8325318">conns</span><span class="op" id="8325323">;</span>&nbsp;<span class="ident" id="8325325">i</span><span class="op" id="8325326">++</span>&nbsp;<span class="op" id="8325329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325333">&lt;-</span><span class="ident" id="8325335">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8325341">}</span><br>
<span class="lineno"></span><span class="op" id="8325343">}</span>
</div>
</body>
</html>
