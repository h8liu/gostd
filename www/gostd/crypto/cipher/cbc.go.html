<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3613044">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3613099">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3613153">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3613204">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3613242">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3613316">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3613389">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3613423">package</span>&nbsp;<span class="ident" id="3613431">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3613439">type</span>&nbsp;<span class="ident" id="3613444">cbc</span>&nbsp;<span class="keyword" id="3613448">struct</span>&nbsp;<span class="op" id="3613455">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613458">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613468">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613475">blockSize</span>&nbsp;<span class="builtintype" id="3613485">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613490">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613500">[</span><span class="op" id="3613501">]</span><span class="builtintype" id="3613502">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613508">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3613518">[</span><span class="op" id="3613519">]</span><span class="builtintype" id="3613520">byte</span><br>
<span class="lineno"></span><span class="op" id="3613525">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3613528">func</span>&nbsp;<span class="ident" id="3613533">newCBC</span><span class="op" id="3613539">(</span><span class="ident" id="3613540">b</span>&nbsp;<span class="ident" id="3613542">Block</span><span class="op" id="3613547">,</span>&nbsp;<span class="ident" id="3613549">iv</span>&nbsp;<span class="op" id="3613552">[</span><span class="op" id="3613553">]</span><span class="builtintype" id="3613554">byte</span><span class="op" id="3613558">)</span>&nbsp;<span class="op" id="3613560">*</span><span class="ident" id="3613561">cbc</span>&nbsp;<span class="op" id="3613565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613568">return</span>&nbsp;<span class="op" id="3613575">&amp;</span><span class="ident" id="3613576">cbc</span><span class="op" id="3613579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613583">b</span><span class="op" id="3613584">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613594">b</span><span class="op" id="3613595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613599">blockSize</span><span class="op" id="3613608">:</span>&nbsp;<span class="ident" id="3613610">b</span><span class="op" id="3613611">.</span><span class="ident" id="3613612">BlockSize</span><span class="op" id="3613621">(</span><span class="op" id="3613622">)</span><span class="op" id="3613623">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613627">iv</span><span class="op" id="3613629">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613638">dup</span><span class="op" id="3613641">(</span><span class="ident" id="3613642">iv</span><span class="op" id="3613644">)</span><span class="op" id="3613645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613649">tmp</span><span class="op" id="3613652">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3613660">make</span><span class="op" id="3613664">(</span><span class="op" id="3613665">[</span><span class="op" id="3613666">]</span><span class="builtintype" id="3613667">byte</span><span class="op" id="3613671">,</span>&nbsp;<span class="ident" id="3613673">b</span><span class="op" id="3613674">.</span><span class="ident" id="3613675">BlockSize</span><span class="op" id="3613684">(</span><span class="op" id="3613685">)</span><span class="op" id="3613686">)</span><span class="op" id="3613687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3613690">}</span><br>
<span class="lineno"></span><span class="op" id="3613692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3613695">type</span>&nbsp;<span class="ident" id="3613700">cbcEncrypter</span>&nbsp;<span class="ident" id="3613713">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3613718">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3613797">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3613870">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3613893">func</span>&nbsp;<span class="ident" id="3613898">NewCBCEncrypter</span><span class="op" id="3613913">(</span><span class="ident" id="3613914">b</span>&nbsp;<span class="ident" id="3613916">Block</span><span class="op" id="3613921">,</span>&nbsp;<span class="ident" id="3613923">iv</span>&nbsp;<span class="op" id="3613926">[</span><span class="op" id="3613927">]</span><span class="builtintype" id="3613928">byte</span><span class="op" id="3613932">)</span>&nbsp;<span class="ident" id="3613934">BlockMode</span>&nbsp;<span class="op" id="3613944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3613947">if</span>&nbsp;<span class="builtinfunc" id="3613950">len</span><span class="op" id="3613953">(</span><span class="ident" id="3613954">iv</span><span class="op" id="3613956">)</span>&nbsp;<span class="op" id="3613958">!=</span>&nbsp;<span class="ident" id="3613961">b</span><span class="op" id="3613962">.</span><span class="ident" id="3613963">BlockSize</span><span class="op" id="3613972">(</span><span class="op" id="3613973">)</span>&nbsp;<span class="op" id="3613975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3613979">panic</span><span class="op" id="3613984">(</span><span class="string" id="3613985">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3614042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614048">return</span>&nbsp;<span class="op" id="3614055">(</span><span class="op" id="3614056">*</span><span class="ident" id="3614057">cbcEncrypter</span><span class="op" id="3614069">)</span><span class="op" id="3614070">(</span><span class="ident" id="3614071">newCBC</span><span class="op" id="3614077">(</span><span class="ident" id="3614078">b</span><span class="op" id="3614079">,</span>&nbsp;<span class="ident" id="3614081">iv</span><span class="op" id="3614083">)</span><span class="op" id="3614084">)</span><br>
<span class="lineno">40</span><span class="op" id="3614086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3614089">func</span>&nbsp;<span class="op" id="3614094">(</span><span class="ident" id="3614095">x</span>&nbsp;<span class="op" id="3614097">*</span><span class="ident" id="3614098">cbcEncrypter</span><span class="op" id="3614110">)</span>&nbsp;<span class="ident" id="3614112">BlockSize</span><span class="op" id="3614121">(</span><span class="op" id="3614122">)</span>&nbsp;<span class="builtintype" id="3614124">int</span>&nbsp;<span class="op" id="3614128">{</span>&nbsp;<span class="keyword" id="3614130">return</span>&nbsp;<span class="ident" id="3614137">x</span><span class="op" id="3614138">.</span><span class="ident" id="3614139">blockSize</span>&nbsp;<span class="op" id="3614149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3614152">func</span>&nbsp;<span class="op" id="3614157">(</span><span class="ident" id="3614158">x</span>&nbsp;<span class="op" id="3614160">*</span><span class="ident" id="3614161">cbcEncrypter</span><span class="op" id="3614173">)</span>&nbsp;<span class="ident" id="3614175">CryptBlocks</span><span class="op" id="3614186">(</span><span class="ident" id="3614187">dst</span><span class="op" id="3614190">,</span>&nbsp;<span class="ident" id="3614192">src</span>&nbsp;<span class="op" id="3614196">[</span><span class="op" id="3614197">]</span><span class="builtintype" id="3614198">byte</span><span class="op" id="3614202">)</span>&nbsp;<span class="op" id="3614204">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614207">if</span>&nbsp;<span class="builtinfunc" id="3614210">len</span><span class="op" id="3614213">(</span><span class="ident" id="3614214">src</span><span class="op" id="3614217">)</span><span class="op" id="3614218">%</span><span class="ident" id="3614219">x</span><span class="op" id="3614220">.</span><span class="ident" id="3614221">blockSize</span>&nbsp;<span class="op" id="3614231">!=</span>&nbsp;<span class="num" id="3614234">0</span>&nbsp;<span class="op" id="3614236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3614240">panic</span><span class="op" id="3614245">(</span><span class="string" id="3614246">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3614284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614290">if</span>&nbsp;<span class="builtinfunc" id="3614293">len</span><span class="op" id="3614296">(</span><span class="ident" id="3614297">dst</span><span class="op" id="3614300">)</span>&nbsp;<span class="op" id="3614302">&lt;</span>&nbsp;<span class="builtinfunc" id="3614304">len</span><span class="op" id="3614307">(</span><span class="ident" id="3614308">src</span><span class="op" id="3614311">)</span>&nbsp;<span class="op" id="3614313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3614317">panic</span><span class="op" id="3614322">(</span><span class="string" id="3614323">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3614365">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614372">iv</span>&nbsp;<span class="op" id="3614375">:=</span>&nbsp;<span class="ident" id="3614378">x</span><span class="op" id="3614379">.</span><span class="ident" id="3614380">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614385">for</span>&nbsp;<span class="builtinfunc" id="3614389">len</span><span class="op" id="3614392">(</span><span class="ident" id="3614393">src</span><span class="op" id="3614396">)</span>&nbsp;<span class="op" id="3614398">&gt;</span>&nbsp;<span class="num" id="3614400">0</span>&nbsp;<span class="op" id="3614402">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3614406">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614456">xorBytes</span><span class="op" id="3614464">(</span><span class="ident" id="3614465">dst</span><span class="op" id="3614468">[</span><span class="op" id="3614469">:</span><span class="ident" id="3614470">x</span><span class="op" id="3614471">.</span><span class="ident" id="3614472">blockSize</span><span class="op" id="3614481">]</span><span class="op" id="3614482">,</span>&nbsp;<span class="ident" id="3614484">src</span><span class="op" id="3614487">[</span><span class="op" id="3614488">:</span><span class="ident" id="3614489">x</span><span class="op" id="3614490">.</span><span class="ident" id="3614491">blockSize</span><span class="op" id="3614500">]</span><span class="op" id="3614501">,</span>&nbsp;<span class="ident" id="3614503">iv</span><span class="op" id="3614505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614509">x</span><span class="op" id="3614510">.</span><span class="ident" id="3614511">b</span><span class="op" id="3614512">.</span><span class="ident" id="3614513">Encrypt</span><span class="op" id="3614520">(</span><span class="ident" id="3614521">dst</span><span class="op" id="3614524">[</span><span class="op" id="3614525">:</span><span class="ident" id="3614526">x</span><span class="op" id="3614527">.</span><span class="ident" id="3614528">blockSize</span><span class="op" id="3614537">]</span><span class="op" id="3614538">,</span>&nbsp;<span class="ident" id="3614540">dst</span><span class="op" id="3614543">[</span><span class="op" id="3614544">:</span><span class="ident" id="3614545">x</span><span class="op" id="3614546">.</span><span class="ident" id="3614547">blockSize</span><span class="op" id="3614556">]</span><span class="op" id="3614557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3614562">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614622">iv</span>&nbsp;<span class="op" id="3614625">=</span>&nbsp;<span class="ident" id="3614627">dst</span><span class="op" id="3614630">[</span><span class="op" id="3614631">:</span><span class="ident" id="3614632">x</span><span class="op" id="3614633">.</span><span class="ident" id="3614634">blockSize</span><span class="op" id="3614643">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614647">src</span>&nbsp;<span class="op" id="3614651">=</span>&nbsp;<span class="ident" id="3614653">src</span><span class="op" id="3614656">[</span><span class="ident" id="3614657">x</span><span class="op" id="3614658">.</span><span class="ident" id="3614659">blockSize</span><span class="op" id="3614668">:</span><span class="op" id="3614669">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614673">dst</span>&nbsp;<span class="op" id="3614677">=</span>&nbsp;<span class="ident" id="3614679">dst</span><span class="op" id="3614682">[</span><span class="ident" id="3614683">x</span><span class="op" id="3614684">.</span><span class="ident" id="3614685">blockSize</span><span class="op" id="3614694">:</span><span class="op" id="3614695">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3614702">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3614749">copy</span><span class="op" id="3614753">(</span><span class="ident" id="3614754">x</span><span class="op" id="3614755">.</span><span class="ident" id="3614756">iv</span><span class="op" id="3614758">,</span>&nbsp;<span class="ident" id="3614760">iv</span><span class="op" id="3614762">)</span><br>
<span class="lineno"></span><span class="op" id="3614764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3614767">func</span>&nbsp;<span class="op" id="3614772">(</span><span class="ident" id="3614773">x</span>&nbsp;<span class="op" id="3614775">*</span><span class="ident" id="3614776">cbcEncrypter</span><span class="op" id="3614788">)</span>&nbsp;<span class="ident" id="3614790">SetIV</span><span class="op" id="3614795">(</span><span class="ident" id="3614796">iv</span>&nbsp;<span class="op" id="3614799">[</span><span class="op" id="3614800">]</span><span class="builtintype" id="3614801">byte</span><span class="op" id="3614805">)</span>&nbsp;<span class="op" id="3614807">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614810">if</span>&nbsp;<span class="builtinfunc" id="3614813">len</span><span class="op" id="3614816">(</span><span class="ident" id="3614817">iv</span><span class="op" id="3614819">)</span>&nbsp;<span class="op" id="3614821">!=</span>&nbsp;<span class="builtinfunc" id="3614824">len</span><span class="op" id="3614827">(</span><span class="ident" id="3614828">x</span><span class="op" id="3614829">.</span><span class="ident" id="3614830">iv</span><span class="op" id="3614832">)</span>&nbsp;<span class="op" id="3614834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3614838">panic</span><span class="op" id="3614843">(</span><span class="string" id="3614844">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3614873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3614879">copy</span><span class="op" id="3614883">(</span><span class="ident" id="3614884">x</span><span class="op" id="3614885">.</span><span class="ident" id="3614886">iv</span><span class="op" id="3614888">,</span>&nbsp;<span class="ident" id="3614890">iv</span><span class="op" id="3614892">)</span><br>
<span class="lineno"></span><span class="op" id="3614894">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3614897">type</span>&nbsp;<span class="ident" id="3614902">cbcDecrypter</span>&nbsp;<span class="ident" id="3614915">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3614920">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3614999">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3615072">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3615142">func</span>&nbsp;<span class="ident" id="3615147">NewCBCDecrypter</span><span class="op" id="3615162">(</span><span class="ident" id="3615163">b</span>&nbsp;<span class="ident" id="3615165">Block</span><span class="op" id="3615170">,</span>&nbsp;<span class="ident" id="3615172">iv</span>&nbsp;<span class="op" id="3615175">[</span><span class="op" id="3615176">]</span><span class="builtintype" id="3615177">byte</span><span class="op" id="3615181">)</span>&nbsp;<span class="ident" id="3615183">BlockMode</span>&nbsp;<span class="op" id="3615193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615196">if</span>&nbsp;<span class="builtinfunc" id="3615199">len</span><span class="op" id="3615202">(</span><span class="ident" id="3615203">iv</span><span class="op" id="3615205">)</span>&nbsp;<span class="op" id="3615207">!=</span>&nbsp;<span class="ident" id="3615210">b</span><span class="op" id="3615211">.</span><span class="ident" id="3615212">BlockSize</span><span class="op" id="3615221">(</span><span class="op" id="3615222">)</span>&nbsp;<span class="op" id="3615224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3615228">panic</span><span class="op" id="3615233">(</span><span class="string" id="3615234">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3615291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615294">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615297">return</span>&nbsp;<span class="op" id="3615304">(</span><span class="op" id="3615305">*</span><span class="ident" id="3615306">cbcDecrypter</span><span class="op" id="3615318">)</span><span class="op" id="3615319">(</span><span class="ident" id="3615320">newCBC</span><span class="op" id="3615326">(</span><span class="ident" id="3615327">b</span><span class="op" id="3615328">,</span>&nbsp;<span class="ident" id="3615330">iv</span><span class="op" id="3615332">)</span><span class="op" id="3615333">)</span><br>
<span class="lineno"></span><span class="op" id="3615335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3615338">func</span>&nbsp;<span class="op" id="3615343">(</span><span class="ident" id="3615344">x</span>&nbsp;<span class="op" id="3615346">*</span><span class="ident" id="3615347">cbcDecrypter</span><span class="op" id="3615359">)</span>&nbsp;<span class="ident" id="3615361">BlockSize</span><span class="op" id="3615370">(</span><span class="op" id="3615371">)</span>&nbsp;<span class="builtintype" id="3615373">int</span>&nbsp;<span class="op" id="3615377">{</span>&nbsp;<span class="keyword" id="3615379">return</span>&nbsp;<span class="ident" id="3615386">x</span><span class="op" id="3615387">.</span><span class="ident" id="3615388">blockSize</span>&nbsp;<span class="op" id="3615398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3615401">func</span>&nbsp;<span class="op" id="3615406">(</span><span class="ident" id="3615407">x</span>&nbsp;<span class="op" id="3615409">*</span><span class="ident" id="3615410">cbcDecrypter</span><span class="op" id="3615422">)</span>&nbsp;<span class="ident" id="3615424">CryptBlocks</span><span class="op" id="3615435">(</span><span class="ident" id="3615436">dst</span><span class="op" id="3615439">,</span>&nbsp;<span class="ident" id="3615441">src</span>&nbsp;<span class="op" id="3615445">[</span><span class="op" id="3615446">]</span><span class="builtintype" id="3615447">byte</span><span class="op" id="3615451">)</span>&nbsp;<span class="op" id="3615453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615456">if</span>&nbsp;<span class="builtinfunc" id="3615459">len</span><span class="op" id="3615462">(</span><span class="ident" id="3615463">src</span><span class="op" id="3615466">)</span><span class="op" id="3615467">%</span><span class="ident" id="3615468">x</span><span class="op" id="3615469">.</span><span class="ident" id="3615470">blockSize</span>&nbsp;<span class="op" id="3615480">!=</span>&nbsp;<span class="num" id="3615483">0</span>&nbsp;<span class="op" id="3615485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3615489">panic</span><span class="op" id="3615494">(</span><span class="string" id="3615495">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3615533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615539">if</span>&nbsp;<span class="builtinfunc" id="3615542">len</span><span class="op" id="3615545">(</span><span class="ident" id="3615546">dst</span><span class="op" id="3615549">)</span>&nbsp;<span class="op" id="3615551">&lt;</span>&nbsp;<span class="builtinfunc" id="3615553">len</span><span class="op" id="3615556">(</span><span class="ident" id="3615557">src</span><span class="op" id="3615560">)</span>&nbsp;<span class="op" id="3615562">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3615566">panic</span><span class="op" id="3615571">(</span><span class="string" id="3615572">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3615614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615620">if</span>&nbsp;<span class="builtinfunc" id="3615623">len</span><span class="op" id="3615626">(</span><span class="ident" id="3615627">src</span><span class="op" id="3615630">)</span>&nbsp;<span class="op" id="3615632">==</span>&nbsp;<span class="num" id="3615635">0</span>&nbsp;<span class="op" id="3615637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615641">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615649">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3615653">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3615754">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615827">end</span>&nbsp;<span class="op" id="3615831">:=</span>&nbsp;<span class="builtinfunc" id="3615834">len</span><span class="op" id="3615837">(</span><span class="ident" id="3615838">src</span><span class="op" id="3615841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615844">start</span>&nbsp;<span class="op" id="3615850">:=</span>&nbsp;<span class="ident" id="3615853">end</span>&nbsp;<span class="op" id="3615857">-</span>&nbsp;<span class="ident" id="3615859">x</span><span class="op" id="3615860">.</span><span class="ident" id="3615861">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615872">prev</span>&nbsp;<span class="op" id="3615877">:=</span>&nbsp;<span class="ident" id="3615880">start</span>&nbsp;<span class="op" id="3615886">-</span>&nbsp;<span class="ident" id="3615888">x</span><span class="op" id="3615889">.</span><span class="ident" id="3615890">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3615902">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3615970">copy</span><span class="op" id="3615974">(</span><span class="ident" id="3615975">x</span><span class="op" id="3615976">.</span><span class="ident" id="3615977">tmp</span><span class="op" id="3615980">,</span>&nbsp;<span class="ident" id="3615982">src</span><span class="op" id="3615985">[</span><span class="ident" id="3615986">start</span><span class="op" id="3615991">:</span><span class="ident" id="3615992">end</span><span class="op" id="3615995">]</span><span class="op" id="3615996">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3616000">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616039">for</span>&nbsp;<span class="ident" id="3616043">start</span>&nbsp;<span class="op" id="3616049">&gt;</span>&nbsp;<span class="num" id="3616051">0</span>&nbsp;<span class="op" id="3616053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616057">x</span><span class="op" id="3616058">.</span><span class="ident" id="3616059">b</span><span class="op" id="3616060">.</span><span class="ident" id="3616061">Decrypt</span><span class="op" id="3616068">(</span><span class="ident" id="3616069">dst</span><span class="op" id="3616072">[</span><span class="ident" id="3616073">start</span><span class="op" id="3616078">:</span><span class="ident" id="3616079">end</span><span class="op" id="3616082">]</span><span class="op" id="3616083">,</span>&nbsp;<span class="ident" id="3616085">src</span><span class="op" id="3616088">[</span><span class="ident" id="3616089">start</span><span class="op" id="3616094">:</span><span class="ident" id="3616095">end</span><span class="op" id="3616098">]</span><span class="op" id="3616099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616103">xorBytes</span><span class="op" id="3616111">(</span><span class="ident" id="3616112">dst</span><span class="op" id="3616115">[</span><span class="ident" id="3616116">start</span><span class="op" id="3616121">:</span><span class="ident" id="3616122">end</span><span class="op" id="3616125">]</span><span class="op" id="3616126">,</span>&nbsp;<span class="ident" id="3616128">dst</span><span class="op" id="3616131">[</span><span class="ident" id="3616132">start</span><span class="op" id="3616137">:</span><span class="ident" id="3616138">end</span><span class="op" id="3616141">]</span><span class="op" id="3616142">,</span>&nbsp;<span class="ident" id="3616144">src</span><span class="op" id="3616147">[</span><span class="ident" id="3616148">prev</span><span class="op" id="3616152">:</span><span class="ident" id="3616153">start</span><span class="op" id="3616158">]</span><span class="op" id="3616159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616164">end</span>&nbsp;<span class="op" id="3616168">=</span>&nbsp;<span class="ident" id="3616170">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616178">start</span>&nbsp;<span class="op" id="3616184">=</span>&nbsp;<span class="ident" id="3616186">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616193">prev</span>&nbsp;<span class="op" id="3616198">-=</span>&nbsp;<span class="ident" id="3616201">x</span><span class="op" id="3616202">.</span><span class="ident" id="3616203">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3616218">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616279">x</span><span class="op" id="3616280">.</span><span class="ident" id="3616281">b</span><span class="op" id="3616282">.</span><span class="ident" id="3616283">Decrypt</span><span class="op" id="3616290">(</span><span class="ident" id="3616291">dst</span><span class="op" id="3616294">[</span><span class="ident" id="3616295">start</span><span class="op" id="3616300">:</span><span class="ident" id="3616301">end</span><span class="op" id="3616304">]</span><span class="op" id="3616305">,</span>&nbsp;<span class="ident" id="3616307">src</span><span class="op" id="3616310">[</span><span class="ident" id="3616311">start</span><span class="op" id="3616316">:</span><span class="ident" id="3616317">end</span><span class="op" id="3616320">]</span><span class="op" id="3616321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616324">xorBytes</span><span class="op" id="3616332">(</span><span class="ident" id="3616333">dst</span><span class="op" id="3616336">[</span><span class="ident" id="3616337">start</span><span class="op" id="3616342">:</span><span class="ident" id="3616343">end</span><span class="op" id="3616346">]</span><span class="op" id="3616347">,</span>&nbsp;<span class="ident" id="3616349">dst</span><span class="op" id="3616352">[</span><span class="ident" id="3616353">start</span><span class="op" id="3616358">:</span><span class="ident" id="3616359">end</span><span class="op" id="3616362">]</span><span class="op" id="3616363">,</span>&nbsp;<span class="ident" id="3616365">x</span><span class="op" id="3616366">.</span><span class="ident" id="3616367">iv</span><span class="op" id="3616369">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3616373">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616430">x</span><span class="op" id="3616431">.</span><span class="ident" id="3616432">iv</span><span class="op" id="3616434">,</span>&nbsp;<span class="ident" id="3616436">x</span><span class="op" id="3616437">.</span><span class="ident" id="3616438">tmp</span>&nbsp;<span class="op" id="3616442">=</span>&nbsp;<span class="ident" id="3616444">x</span><span class="op" id="3616445">.</span><span class="ident" id="3616446">tmp</span><span class="op" id="3616449">,</span>&nbsp;<span class="ident" id="3616451">x</span><span class="op" id="3616452">.</span><span class="ident" id="3616453">iv</span><br>
<span class="lineno"></span><span class="op" id="3616456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3616459">func</span>&nbsp;<span class="op" id="3616464">(</span><span class="ident" id="3616465">x</span>&nbsp;<span class="op" id="3616467">*</span><span class="ident" id="3616468">cbcDecrypter</span><span class="op" id="3616480">)</span>&nbsp;<span class="ident" id="3616482">SetIV</span><span class="op" id="3616487">(</span><span class="ident" id="3616488">iv</span>&nbsp;<span class="op" id="3616491">[</span><span class="op" id="3616492">]</span><span class="builtintype" id="3616493">byte</span><span class="op" id="3616497">)</span>&nbsp;<span class="op" id="3616499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616502">if</span>&nbsp;<span class="builtinfunc" id="3616505">len</span><span class="op" id="3616508">(</span><span class="ident" id="3616509">iv</span><span class="op" id="3616511">)</span>&nbsp;<span class="op" id="3616513">!=</span>&nbsp;<span class="builtinfunc" id="3616516">len</span><span class="op" id="3616519">(</span><span class="ident" id="3616520">x</span><span class="op" id="3616521">.</span><span class="ident" id="3616522">iv</span><span class="op" id="3616524">)</span>&nbsp;<span class="op" id="3616526">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3616530">panic</span><span class="op" id="3616535">(</span><span class="string" id="3616536">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3616565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3616571">copy</span><span class="op" id="3616575">(</span><span class="ident" id="3616576">x</span><span class="op" id="3616577">.</span><span class="ident" id="3616578">iv</span><span class="op" id="3616580">,</span>&nbsp;<span class="ident" id="3616582">iv</span><span class="op" id="3616584">)</span><br>
<span class="lineno"></span><span class="op" id="3616586">}</span>
</div>
</body>
</html>
