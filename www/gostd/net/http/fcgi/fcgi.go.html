<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5502586">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5502641">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5502695">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5502746">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="5502795">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="5502846">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="5502923">package</span>&nbsp;<span class="ident" id="5502931">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5502937">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5503016">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503030">import</span>&nbsp;<span class="op" id="5503037">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503040">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503049">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503058">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503077">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503087">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503093">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="5503100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5503103">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5503146">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="5503201">type</span>&nbsp;<span class="ident" id="5503206">recType</span>&nbsp;<span class="builtintype" id="5503214">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5503221">const</span>&nbsp;<span class="op" id="5503227">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503230">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503250">recType</span>&nbsp;<span class="op" id="5503258">=</span>&nbsp;<span class="num" id="5503260">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503263">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503283">recType</span>&nbsp;<span class="op" id="5503291">=</span>&nbsp;<span class="num" id="5503293">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503296">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503316">recType</span>&nbsp;<span class="op" id="5503324">=</span>&nbsp;<span class="num" id="5503326">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503329">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503349">recType</span>&nbsp;<span class="op" id="5503357">=</span>&nbsp;<span class="num" id="5503359">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503362">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503382">recType</span>&nbsp;<span class="op" id="5503390">=</span>&nbsp;<span class="num" id="5503392">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503395">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503415">recType</span>&nbsp;<span class="op" id="5503423">=</span>&nbsp;<span class="num" id="5503425">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503428">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503448">recType</span>&nbsp;<span class="op" id="5503456">=</span>&nbsp;<span class="num" id="5503458">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503461">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503481">recType</span>&nbsp;<span class="op" id="5503489">=</span>&nbsp;<span class="num" id="5503491">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503494">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503514">recType</span>&nbsp;<span class="op" id="5503522">=</span>&nbsp;<span class="num" id="5503524">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503527">typeGetValuesResult</span>&nbsp;<span class="ident" id="5503547">recType</span>&nbsp;<span class="op" id="5503555">=</span>&nbsp;<span class="num" id="5503557">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503561">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503581">recType</span>&nbsp;<span class="op" id="5503589">=</span>&nbsp;<span class="num" id="5503591">11</span><br>
<span class="lineno"></span><span class="op" id="5503594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5503597">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="5503672">const</span>&nbsp;<span class="ident" id="5503678">flagKeepConn</span>&nbsp;<span class="op" id="5503691">=</span>&nbsp;<span class="num" id="5503693">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503696">const</span>&nbsp;<span class="op" id="5503702">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503705">maxWrite</span>&nbsp;<span class="op" id="5503714">=</span>&nbsp;<span class="num" id="5503716">65535</span>&nbsp;<span class="comment" id="5503722">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503746">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5503755">=</span>&nbsp;<span class="num" id="5503757">255</span><br>
<span class="lineno"></span><span class="op" id="5503761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503764">const</span>&nbsp;<span class="op" id="5503770">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503773">roleResponder</span>&nbsp;<span class="op" id="5503787">=</span>&nbsp;<span class="ident" id="5503789">iota</span>&nbsp;<span class="op" id="5503794">+</span>&nbsp;<span class="num" id="5503796">1</span>&nbsp;<span class="comment" id="5503798">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503835">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503851">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="5503862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503865">const</span>&nbsp;<span class="op" id="5503871">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503874">statusRequestComplete</span>&nbsp;<span class="op" id="5503896">=</span>&nbsp;<span class="ident" id="5503898">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503904">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503925">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503943">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="5503961">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5503964">const</span>&nbsp;<span class="ident" id="5503970">headerLen</span>&nbsp;<span class="op" id="5503980">=</span>&nbsp;<span class="num" id="5503982">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503985">type</span>&nbsp;<span class="ident" id="5503990">header</span>&nbsp;<span class="keyword" id="5503997">struct</span>&nbsp;<span class="op" id="5504004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504007">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5504021">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504028">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504042">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504051">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5504065">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504073">ContentLength</span>&nbsp;<span class="builtintype" id="5504087">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504095">PaddingLength</span>&nbsp;<span class="builtintype" id="5504109">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504116">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5504130">uint8</span><br>
<span class="lineno">70</span><span class="op" id="5504136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5504139">type</span>&nbsp;<span class="ident" id="5504144">beginRequest</span>&nbsp;<span class="keyword" id="5504157">struct</span>&nbsp;<span class="op" id="5504164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504167">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5504176">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504184">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5504193">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504200">reserved</span>&nbsp;<span class="op" id="5504209">[</span><span class="num" id="5504210">5</span><span class="op" id="5504211">]</span><span class="builtintype" id="5504212">uint8</span><br>
<span class="lineno"></span><span class="op" id="5504218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5504221">func</span>&nbsp;<span class="op" id="5504226">(</span><span class="ident" id="5504227">br</span>&nbsp;<span class="op" id="5504230">*</span><span class="ident" id="5504231">beginRequest</span><span class="op" id="5504243">)</span>&nbsp;<span class="ident" id="5504245">read</span><span class="op" id="5504249">(</span><span class="ident" id="5504250">content</span>&nbsp;<span class="op" id="5504258">[</span><span class="op" id="5504259">]</span><span class="builtintype" id="5504260">byte</span><span class="op" id="5504264">)</span>&nbsp;<span class="builtintype" id="5504266">error</span>&nbsp;<span class="op" id="5504272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504275">if</span>&nbsp;<span class="builtinfunc" id="5504278">len</span><span class="op" id="5504281">(</span><span class="ident" id="5504282">content</span><span class="op" id="5504289">)</span>&nbsp;<span class="op" id="5504291">!=</span>&nbsp;<span class="num" id="5504294">8</span>&nbsp;<span class="op" id="5504296">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504300">return</span>&nbsp;<span class="ident" id="5504307">errors</span><span class="op" id="5504313">.</span><span class="ident" id="5504314">New</span><span class="op" id="5504317">(</span><span class="string" id="5504318">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="5504354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5504357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504360">br</span><span class="op" id="5504362">.</span><span class="ident" id="5504363">role</span>&nbsp;<span class="op" id="5504368">=</span>&nbsp;<span class="ident" id="5504370">binary</span><span class="op" id="5504376">.</span><span class="ident" id="5504377">BigEndian</span><span class="op" id="5504386">.</span><span class="ident" id="5504387">Uint16</span><span class="op" id="5504393">(</span><span class="ident" id="5504394">content</span><span class="op" id="5504401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504404">br</span><span class="op" id="5504406">.</span><span class="ident" id="5504407">flags</span>&nbsp;<span class="op" id="5504413">=</span>&nbsp;<span class="ident" id="5504415">content</span><span class="op" id="5504422">[</span><span class="num" id="5504423">2</span><span class="op" id="5504424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504427">return</span>&nbsp;<span class="ident" id="5504434">nil</span><br>
<span class="lineno">85</span><span class="op" id="5504438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5504441">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="5504498">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="5504562">var</span>&nbsp;<span class="ident" id="5504566">pad</span>&nbsp;<span class="op" id="5504570">[</span><span class="ident" id="5504571">maxPad</span><span class="op" id="5504577">]</span><span class="builtintype" id="5504578">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="5504584">func</span>&nbsp;<span class="op" id="5504589">(</span><span class="ident" id="5504590">h</span>&nbsp;<span class="op" id="5504592">*</span><span class="ident" id="5504593">header</span><span class="op" id="5504599">)</span>&nbsp;<span class="ident" id="5504601">init</span><span class="op" id="5504605">(</span><span class="ident" id="5504606">recType</span>&nbsp;<span class="ident" id="5504614">recType</span><span class="op" id="5504621">,</span>&nbsp;<span class="ident" id="5504623">reqId</span>&nbsp;<span class="builtintype" id="5504629">uint16</span><span class="op" id="5504635">,</span>&nbsp;<span class="ident" id="5504637">contentLength</span>&nbsp;<span class="builtintype" id="5504651">int</span><span class="op" id="5504654">)</span>&nbsp;<span class="op" id="5504656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504659">h</span><span class="op" id="5504660">.</span><span class="ident" id="5504661">Version</span>&nbsp;<span class="op" id="5504669">=</span>&nbsp;<span class="num" id="5504671">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504674">h</span><span class="op" id="5504675">.</span><span class="ident" id="5504676">Type</span>&nbsp;<span class="op" id="5504681">=</span>&nbsp;<span class="ident" id="5504683">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504692">h</span><span class="op" id="5504693">.</span><span class="ident" id="5504694">Id</span>&nbsp;<span class="op" id="5504697">=</span>&nbsp;<span class="ident" id="5504699">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504706">h</span><span class="op" id="5504707">.</span><span class="ident" id="5504708">ContentLength</span>&nbsp;<span class="op" id="5504722">=</span>&nbsp;<span class="builtintype" id="5504724">uint16</span><span class="op" id="5504730">(</span><span class="ident" id="5504731">contentLength</span><span class="op" id="5504744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504747">h</span><span class="op" id="5504748">.</span><span class="ident" id="5504749">PaddingLength</span>&nbsp;<span class="op" id="5504763">=</span>&nbsp;<span class="builtintype" id="5504765">uint8</span><span class="op" id="5504770">(</span><span class="op" id="5504771">-</span><span class="ident" id="5504772">contentLength</span>&nbsp;<span class="op" id="5504786">&amp;</span>&nbsp;<span class="num" id="5504788">7</span><span class="op" id="5504789">)</span><br>
<span class="lineno"></span><span class="op" id="5504791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5504794">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="5504825">type</span>&nbsp;<span class="ident" id="5504830">conn</span>&nbsp;<span class="keyword" id="5504835">struct</span>&nbsp;<span class="op" id="5504842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504845">mutex</span>&nbsp;<span class="ident" id="5504851">sync</span><span class="op" id="5504855">.</span><span class="ident" id="5504856">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504863">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5504869">io</span><span class="op" id="5504871">.</span><span class="ident" id="5504872">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504890">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504915">buf</span>&nbsp;<span class="ident" id="5504919">bytes</span><span class="op" id="5504924">.</span><span class="ident" id="5504925">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504933">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5504937">header</span><br>
<span class="lineno"></span><span class="op" id="5504944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5504947">func</span>&nbsp;<span class="ident" id="5504952">newConn</span><span class="op" id="5504959">(</span><span class="ident" id="5504960">rwc</span>&nbsp;<span class="ident" id="5504964">io</span><span class="op" id="5504966">.</span><span class="ident" id="5504967">ReadWriteCloser</span><span class="op" id="5504982">)</span>&nbsp;<span class="op" id="5504984">*</span><span class="ident" id="5504985">conn</span>&nbsp;<span class="op" id="5504990">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504993">return</span>&nbsp;<span class="op" id="5505000">&amp;</span><span class="ident" id="5505001">conn</span><span class="op" id="5505005">{</span><span class="ident" id="5505006">rwc</span><span class="op" id="5505009">:</span>&nbsp;<span class="ident" id="5505011">rwc</span><span class="op" id="5505014">}</span><br>
<span class="lineno"></span><span class="op" id="5505016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5505019">func</span>&nbsp;<span class="op" id="5505024">(</span><span class="ident" id="5505025">c</span>&nbsp;<span class="op" id="5505027">*</span><span class="ident" id="5505028">conn</span><span class="op" id="5505032">)</span>&nbsp;<span class="ident" id="5505034">Close</span><span class="op" id="5505039">(</span><span class="op" id="5505040">)</span>&nbsp;<span class="builtintype" id="5505042">error</span>&nbsp;<span class="op" id="5505048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505051">c</span><span class="op" id="5505052">.</span><span class="ident" id="5505053">mutex</span><span class="op" id="5505058">.</span><span class="ident" id="5505059">Lock</span><span class="op" id="5505063">(</span><span class="op" id="5505064">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505067">defer</span>&nbsp;<span class="ident" id="5505073">c</span><span class="op" id="5505074">.</span><span class="ident" id="5505075">mutex</span><span class="op" id="5505080">.</span><span class="ident" id="5505081">Unlock</span><span class="op" id="5505087">(</span><span class="op" id="5505088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505091">return</span>&nbsp;<span class="ident" id="5505098">c</span><span class="op" id="5505099">.</span><span class="ident" id="5505100">rwc</span><span class="op" id="5505103">.</span><span class="ident" id="5505104">Close</span><span class="op" id="5505109">(</span><span class="op" id="5505110">)</span><br>
<span class="lineno"></span><span class="op" id="5505112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5505115">type</span>&nbsp;<span class="ident" id="5505120">record</span>&nbsp;<span class="keyword" id="5505127">struct</span>&nbsp;<span class="op" id="5505134">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505137">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5505141">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505149">buf</span>&nbsp;<span class="op" id="5505153">[</span><span class="ident" id="5505154">maxWrite</span>&nbsp;<span class="op" id="5505163">+</span>&nbsp;<span class="ident" id="5505165">maxPad</span><span class="op" id="5505171">]</span><span class="builtintype" id="5505172">byte</span><br>
<span class="lineno"></span><span class="op" id="5505177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5505180">func</span>&nbsp;<span class="op" id="5505185">(</span><span class="ident" id="5505186">rec</span>&nbsp;<span class="op" id="5505190">*</span><span class="ident" id="5505191">record</span><span class="op" id="5505197">)</span>&nbsp;<span class="ident" id="5505199">read</span><span class="op" id="5505203">(</span><span class="ident" id="5505204">r</span>&nbsp;<span class="ident" id="5505206">io</span><span class="op" id="5505208">.</span><span class="ident" id="5505209">Reader</span><span class="op" id="5505215">)</span>&nbsp;<span class="op" id="5505217">(</span><span class="ident" id="5505218">err</span>&nbsp;<span class="builtintype" id="5505222">error</span><span class="op" id="5505227">)</span>&nbsp;<span class="op" id="5505229">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505232">if</span>&nbsp;<span class="ident" id="5505235">err</span>&nbsp;<span class="op" id="5505239">=</span>&nbsp;<span class="ident" id="5505241">binary</span><span class="op" id="5505247">.</span><span class="ident" id="5505248">Read</span><span class="op" id="5505252">(</span><span class="ident" id="5505253">r</span><span class="op" id="5505254">,</span>&nbsp;<span class="ident" id="5505256">binary</span><span class="op" id="5505262">.</span><span class="ident" id="5505263">BigEndian</span><span class="op" id="5505272">,</span>&nbsp;<span class="op" id="5505274">&amp;</span><span class="ident" id="5505275">rec</span><span class="op" id="5505278">.</span><span class="ident" id="5505279">h</span><span class="op" id="5505280">)</span><span class="op" id="5505281">;</span>&nbsp;<span class="ident" id="5505283">err</span>&nbsp;<span class="op" id="5505287">!=</span>&nbsp;<span class="ident" id="5505290">nil</span>&nbsp;<span class="op" id="5505294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505298">return</span>&nbsp;<span class="ident" id="5505305">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505313">if</span>&nbsp;<span class="ident" id="5505316">rec</span><span class="op" id="5505319">.</span><span class="ident" id="5505320">h</span><span class="op" id="5505321">.</span><span class="ident" id="5505322">Version</span>&nbsp;<span class="op" id="5505330">!=</span>&nbsp;<span class="num" id="5505333">1</span>&nbsp;<span class="op" id="5505335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505339">return</span>&nbsp;<span class="ident" id="5505346">errors</span><span class="op" id="5505352">.</span><span class="ident" id="5505353">New</span><span class="op" id="5505356">(</span><span class="string" id="5505357">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="5505387">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505393">n</span>&nbsp;<span class="op" id="5505395">:=</span>&nbsp;<span class="builtintype" id="5505398">int</span><span class="op" id="5505401">(</span><span class="ident" id="5505402">rec</span><span class="op" id="5505405">.</span><span class="ident" id="5505406">h</span><span class="op" id="5505407">.</span><span class="ident" id="5505408">ContentLength</span><span class="op" id="5505421">)</span>&nbsp;<span class="op" id="5505423">+</span>&nbsp;<span class="builtintype" id="5505425">int</span><span class="op" id="5505428">(</span><span class="ident" id="5505429">rec</span><span class="op" id="5505432">.</span><span class="ident" id="5505433">h</span><span class="op" id="5505434">.</span><span class="ident" id="5505435">PaddingLength</span><span class="op" id="5505448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505451">if</span>&nbsp;<span class="ident" id="5505454">_</span><span class="op" id="5505455">,</span>&nbsp;<span class="ident" id="5505457">err</span>&nbsp;<span class="op" id="5505461">=</span>&nbsp;<span class="ident" id="5505463">io</span><span class="op" id="5505465">.</span><span class="ident" id="5505466">ReadFull</span><span class="op" id="5505474">(</span><span class="ident" id="5505475">r</span><span class="op" id="5505476">,</span>&nbsp;<span class="ident" id="5505478">rec</span><span class="op" id="5505481">.</span><span class="ident" id="5505482">buf</span><span class="op" id="5505485">[</span><span class="op" id="5505486">:</span><span class="ident" id="5505487">n</span><span class="op" id="5505488">]</span><span class="op" id="5505489">)</span><span class="op" id="5505490">;</span>&nbsp;<span class="ident" id="5505492">err</span>&nbsp;<span class="op" id="5505496">!=</span>&nbsp;<span class="ident" id="5505499">nil</span>&nbsp;<span class="op" id="5505503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505507">return</span>&nbsp;<span class="ident" id="5505514">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505519">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505522">return</span>&nbsp;<span class="ident" id="5505529">nil</span><br>
<span class="lineno"></span><span class="op" id="5505533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5505536">func</span>&nbsp;<span class="op" id="5505541">(</span><span class="ident" id="5505542">r</span>&nbsp;<span class="op" id="5505544">*</span><span class="ident" id="5505545">record</span><span class="op" id="5505551">)</span>&nbsp;<span class="ident" id="5505553">content</span><span class="op" id="5505560">(</span><span class="op" id="5505561">)</span>&nbsp;<span class="op" id="5505563">[</span><span class="op" id="5505564">]</span><span class="builtintype" id="5505565">byte</span>&nbsp;<span class="op" id="5505570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505573">return</span>&nbsp;<span class="ident" id="5505580">r</span><span class="op" id="5505581">.</span><span class="ident" id="5505582">buf</span><span class="op" id="5505585">[</span><span class="op" id="5505586">:</span><span class="ident" id="5505587">r</span><span class="op" id="5505588">.</span><span class="ident" id="5505589">h</span><span class="op" id="5505590">.</span><span class="ident" id="5505591">ContentLength</span><span class="op" id="5505604">]</span><br>
<span class="lineno">140</span><span class="op" id="5505606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5505609">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="5505658">func</span>&nbsp;<span class="op" id="5505663">(</span><span class="ident" id="5505664">c</span>&nbsp;<span class="op" id="5505666">*</span><span class="ident" id="5505667">conn</span><span class="op" id="5505671">)</span>&nbsp;<span class="ident" id="5505673">writeRecord</span><span class="op" id="5505684">(</span><span class="ident" id="5505685">recType</span>&nbsp;<span class="ident" id="5505693">recType</span><span class="op" id="5505700">,</span>&nbsp;<span class="ident" id="5505702">reqId</span>&nbsp;<span class="builtintype" id="5505708">uint16</span><span class="op" id="5505714">,</span>&nbsp;<span class="ident" id="5505716">b</span>&nbsp;<span class="op" id="5505718">[</span><span class="op" id="5505719">]</span><span class="builtintype" id="5505720">byte</span><span class="op" id="5505724">)</span>&nbsp;<span class="builtintype" id="5505726">error</span>&nbsp;<span class="op" id="5505732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505735">c</span><span class="op" id="5505736">.</span><span class="ident" id="5505737">mutex</span><span class="op" id="5505742">.</span><span class="ident" id="5505743">Lock</span><span class="op" id="5505747">(</span><span class="op" id="5505748">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505751">defer</span>&nbsp;<span class="ident" id="5505757">c</span><span class="op" id="5505758">.</span><span class="ident" id="5505759">mutex</span><span class="op" id="5505764">.</span><span class="ident" id="5505765">Unlock</span><span class="op" id="5505771">(</span><span class="op" id="5505772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505775">c</span><span class="op" id="5505776">.</span><span class="ident" id="5505777">buf</span><span class="op" id="5505780">.</span><span class="ident" id="5505781">Reset</span><span class="op" id="5505786">(</span><span class="op" id="5505787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505790">c</span><span class="op" id="5505791">.</span><span class="ident" id="5505792">h</span><span class="op" id="5505793">.</span><span class="ident" id="5505794">init</span><span class="op" id="5505798">(</span><span class="ident" id="5505799">recType</span><span class="op" id="5505806">,</span>&nbsp;<span class="ident" id="5505808">reqId</span><span class="op" id="5505813">,</span>&nbsp;<span class="builtinfunc" id="5505815">len</span><span class="op" id="5505818">(</span><span class="ident" id="5505819">b</span><span class="op" id="5505820">)</span><span class="op" id="5505821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505824">if</span>&nbsp;<span class="ident" id="5505827">err</span>&nbsp;<span class="op" id="5505831">:=</span>&nbsp;<span class="ident" id="5505834">binary</span><span class="op" id="5505840">.</span><span class="ident" id="5505841">Write</span><span class="op" id="5505846">(</span><span class="op" id="5505847">&amp;</span><span class="ident" id="5505848">c</span><span class="op" id="5505849">.</span><span class="ident" id="5505850">buf</span><span class="op" id="5505853">,</span>&nbsp;<span class="ident" id="5505855">binary</span><span class="op" id="5505861">.</span><span class="ident" id="5505862">BigEndian</span><span class="op" id="5505871">,</span>&nbsp;<span class="ident" id="5505873">c</span><span class="op" id="5505874">.</span><span class="ident" id="5505875">h</span><span class="op" id="5505876">)</span><span class="op" id="5505877">;</span>&nbsp;<span class="ident" id="5505879">err</span>&nbsp;<span class="op" id="5505883">!=</span>&nbsp;<span class="ident" id="5505886">nil</span>&nbsp;<span class="op" id="5505890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505894">return</span>&nbsp;<span class="ident" id="5505901">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505909">if</span>&nbsp;<span class="ident" id="5505912">_</span><span class="op" id="5505913">,</span>&nbsp;<span class="ident" id="5505915">err</span>&nbsp;<span class="op" id="5505919">:=</span>&nbsp;<span class="ident" id="5505922">c</span><span class="op" id="5505923">.</span><span class="ident" id="5505924">buf</span><span class="op" id="5505927">.</span><span class="ident" id="5505928">Write</span><span class="op" id="5505933">(</span><span class="ident" id="5505934">b</span><span class="op" id="5505935">)</span><span class="op" id="5505936">;</span>&nbsp;<span class="ident" id="5505938">err</span>&nbsp;<span class="op" id="5505942">!=</span>&nbsp;<span class="ident" id="5505945">nil</span>&nbsp;<span class="op" id="5505949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505953">return</span>&nbsp;<span class="ident" id="5505960">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505968">if</span>&nbsp;<span class="ident" id="5505971">_</span><span class="op" id="5505972">,</span>&nbsp;<span class="ident" id="5505974">err</span>&nbsp;<span class="op" id="5505978">:=</span>&nbsp;<span class="ident" id="5505981">c</span><span class="op" id="5505982">.</span><span class="ident" id="5505983">buf</span><span class="op" id="5505986">.</span><span class="ident" id="5505987">Write</span><span class="op" id="5505992">(</span><span class="ident" id="5505993">pad</span><span class="op" id="5505996">[</span><span class="op" id="5505997">:</span><span class="ident" id="5505998">c</span><span class="op" id="5505999">.</span><span class="ident" id="5506000">h</span><span class="op" id="5506001">.</span><span class="ident" id="5506002">PaddingLength</span><span class="op" id="5506015">]</span><span class="op" id="5506016">)</span><span class="op" id="5506017">;</span>&nbsp;<span class="ident" id="5506019">err</span>&nbsp;<span class="op" id="5506023">!=</span>&nbsp;<span class="ident" id="5506026">nil</span>&nbsp;<span class="op" id="5506030">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506034">return</span>&nbsp;<span class="ident" id="5506041">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506049">_</span><span class="op" id="5506050">,</span>&nbsp;<span class="ident" id="5506052">err</span>&nbsp;<span class="op" id="5506056">:=</span>&nbsp;<span class="ident" id="5506059">c</span><span class="op" id="5506060">.</span><span class="ident" id="5506061">rwc</span><span class="op" id="5506064">.</span><span class="ident" id="5506065">Write</span><span class="op" id="5506070">(</span><span class="ident" id="5506071">c</span><span class="op" id="5506072">.</span><span class="ident" id="5506073">buf</span><span class="op" id="5506076">.</span><span class="ident" id="5506077">Bytes</span><span class="op" id="5506082">(</span><span class="op" id="5506083">)</span><span class="op" id="5506084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506087">return</span>&nbsp;<span class="ident" id="5506094">err</span><br>
<span class="lineno"></span><span class="op" id="5506098">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="5506101">func</span>&nbsp;<span class="op" id="5506106">(</span><span class="ident" id="5506107">c</span>&nbsp;<span class="op" id="5506109">*</span><span class="ident" id="5506110">conn</span><span class="op" id="5506114">)</span>&nbsp;<span class="ident" id="5506116">writeBeginRequest</span><span class="op" id="5506133">(</span><span class="ident" id="5506134">reqId</span>&nbsp;<span class="builtintype" id="5506140">uint16</span><span class="op" id="5506146">,</span>&nbsp;<span class="ident" id="5506148">role</span>&nbsp;<span class="builtintype" id="5506153">uint16</span><span class="op" id="5506159">,</span>&nbsp;<span class="ident" id="5506161">flags</span>&nbsp;<span class="builtintype" id="5506167">uint8</span><span class="op" id="5506172">)</span>&nbsp;<span class="builtintype" id="5506174">error</span>&nbsp;<span class="op" id="5506180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506183">b</span>&nbsp;<span class="op" id="5506185">:=</span>&nbsp;<span class="op" id="5506188">[</span><span class="num" id="5506189">8</span><span class="op" id="5506190">]</span><span class="builtintype" id="5506191">byte</span><span class="op" id="5506195">{</span><span class="builtintype" id="5506196">byte</span><span class="op" id="5506200">(</span><span class="ident" id="5506201">role</span>&nbsp;<span class="op" id="5506206">&gt;&gt;</span>&nbsp;<span class="num" id="5506209">8</span><span class="op" id="5506210">)</span><span class="op" id="5506211">,</span>&nbsp;<span class="builtintype" id="5506213">byte</span><span class="op" id="5506217">(</span><span class="ident" id="5506218">role</span><span class="op" id="5506222">)</span><span class="op" id="5506223">,</span>&nbsp;<span class="ident" id="5506225">flags</span><span class="op" id="5506230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506233">return</span>&nbsp;<span class="ident" id="5506240">c</span><span class="op" id="5506241">.</span><span class="ident" id="5506242">writeRecord</span><span class="op" id="5506253">(</span><span class="ident" id="5506254">typeBeginRequest</span><span class="op" id="5506270">,</span>&nbsp;<span class="ident" id="5506272">reqId</span><span class="op" id="5506277">,</span>&nbsp;<span class="ident" id="5506279">b</span><span class="op" id="5506280">[</span><span class="op" id="5506281">:</span><span class="op" id="5506282">]</span><span class="op" id="5506283">)</span><br>
<span class="lineno"></span><span class="op" id="5506285">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="5506288">func</span>&nbsp;<span class="op" id="5506293">(</span><span class="ident" id="5506294">c</span>&nbsp;<span class="op" id="5506296">*</span><span class="ident" id="5506297">conn</span><span class="op" id="5506301">)</span>&nbsp;<span class="ident" id="5506303">writeEndRequest</span><span class="op" id="5506318">(</span><span class="ident" id="5506319">reqId</span>&nbsp;<span class="builtintype" id="5506325">uint16</span><span class="op" id="5506331">,</span>&nbsp;<span class="ident" id="5506333">appStatus</span>&nbsp;<span class="builtintype" id="5506343">int</span><span class="op" id="5506346">,</span>&nbsp;<span class="ident" id="5506348">protocolStatus</span>&nbsp;<span class="builtintype" id="5506363">uint8</span><span class="op" id="5506368">)</span>&nbsp;<span class="builtintype" id="5506370">error</span>&nbsp;<span class="op" id="5506376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506379">b</span>&nbsp;<span class="op" id="5506381">:=</span>&nbsp;<span class="builtinfunc" id="5506384">make</span><span class="op" id="5506388">(</span><span class="op" id="5506389">[</span><span class="op" id="5506390">]</span><span class="builtintype" id="5506391">byte</span><span class="op" id="5506395">,</span>&nbsp;<span class="num" id="5506397">8</span><span class="op" id="5506398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506401">binary</span><span class="op" id="5506407">.</span><span class="ident" id="5506408">BigEndian</span><span class="op" id="5506417">.</span><span class="ident" id="5506418">PutUint32</span><span class="op" id="5506427">(</span><span class="ident" id="5506428">b</span><span class="op" id="5506429">,</span>&nbsp;<span class="builtintype" id="5506431">uint32</span><span class="op" id="5506437">(</span><span class="ident" id="5506438">appStatus</span><span class="op" id="5506447">)</span><span class="op" id="5506448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506451">b</span><span class="op" id="5506452">[</span><span class="num" id="5506453">4</span><span class="op" id="5506454">]</span>&nbsp;<span class="op" id="5506456">=</span>&nbsp;<span class="ident" id="5506458">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506474">return</span>&nbsp;<span class="ident" id="5506481">c</span><span class="op" id="5506482">.</span><span class="ident" id="5506483">writeRecord</span><span class="op" id="5506494">(</span><span class="ident" id="5506495">typeEndRequest</span><span class="op" id="5506509">,</span>&nbsp;<span class="ident" id="5506511">reqId</span><span class="op" id="5506516">,</span>&nbsp;<span class="ident" id="5506518">b</span><span class="op" id="5506519">)</span><br>
<span class="lineno"></span><span class="op" id="5506521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5506524">func</span>&nbsp;<span class="op" id="5506529">(</span><span class="ident" id="5506530">c</span>&nbsp;<span class="op" id="5506532">*</span><span class="ident" id="5506533">conn</span><span class="op" id="5506537">)</span>&nbsp;<span class="ident" id="5506539">writePairs</span><span class="op" id="5506549">(</span><span class="ident" id="5506550">recType</span>&nbsp;<span class="ident" id="5506558">recType</span><span class="op" id="5506565">,</span>&nbsp;<span class="ident" id="5506567">reqId</span>&nbsp;<span class="builtintype" id="5506573">uint16</span><span class="op" id="5506579">,</span>&nbsp;<span class="ident" id="5506581">pairs</span>&nbsp;<span class="keyword" id="5506587">map</span><span class="op" id="5506590">[</span><span class="builtintype" id="5506591">string</span><span class="op" id="5506597">]</span><span class="builtintype" id="5506598">string</span><span class="op" id="5506604">)</span>&nbsp;<span class="builtintype" id="5506606">error</span>&nbsp;<span class="op" id="5506612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506615">w</span>&nbsp;<span class="op" id="5506617">:=</span>&nbsp;<span class="ident" id="5506620">newWriter</span><span class="op" id="5506629">(</span><span class="ident" id="5506630">c</span><span class="op" id="5506631">,</span>&nbsp;<span class="ident" id="5506633">recType</span><span class="op" id="5506640">,</span>&nbsp;<span class="ident" id="5506642">reqId</span><span class="op" id="5506647">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506650">b</span>&nbsp;<span class="op" id="5506652">:=</span>&nbsp;<span class="builtinfunc" id="5506655">make</span><span class="op" id="5506659">(</span><span class="op" id="5506660">[</span><span class="op" id="5506661">]</span><span class="builtintype" id="5506662">byte</span><span class="op" id="5506666">,</span>&nbsp;<span class="num" id="5506668">8</span><span class="op" id="5506669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506672">for</span>&nbsp;<span class="ident" id="5506676">k</span><span class="op" id="5506677">,</span>&nbsp;<span class="ident" id="5506679">v</span>&nbsp;<span class="op" id="5506681">:=</span>&nbsp;<span class="keyword" id="5506684">range</span>&nbsp;<span class="ident" id="5506690">pairs</span>&nbsp;<span class="op" id="5506696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506700">n</span>&nbsp;<span class="op" id="5506702">:=</span>&nbsp;<span class="ident" id="5506705">encodeSize</span><span class="op" id="5506715">(</span><span class="ident" id="5506716">b</span><span class="op" id="5506717">,</span>&nbsp;<span class="builtintype" id="5506719">uint32</span><span class="op" id="5506725">(</span><span class="builtinfunc" id="5506726">len</span><span class="op" id="5506729">(</span><span class="ident" id="5506730">k</span><span class="op" id="5506731">)</span><span class="op" id="5506732">)</span><span class="op" id="5506733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506737">n</span>&nbsp;<span class="op" id="5506739">+=</span>&nbsp;<span class="ident" id="5506742">encodeSize</span><span class="op" id="5506752">(</span><span class="ident" id="5506753">b</span><span class="op" id="5506754">[</span><span class="ident" id="5506755">n</span><span class="op" id="5506756">:</span><span class="op" id="5506757">]</span><span class="op" id="5506758">,</span>&nbsp;<span class="builtintype" id="5506760">uint32</span><span class="op" id="5506766">(</span><span class="builtinfunc" id="5506767">len</span><span class="op" id="5506770">(</span><span class="ident" id="5506771">v</span><span class="op" id="5506772">)</span><span class="op" id="5506773">)</span><span class="op" id="5506774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506778">if</span>&nbsp;<span class="ident" id="5506781">_</span><span class="op" id="5506782">,</span>&nbsp;<span class="ident" id="5506784">err</span>&nbsp;<span class="op" id="5506788">:=</span>&nbsp;<span class="ident" id="5506791">w</span><span class="op" id="5506792">.</span><span class="ident" id="5506793">Write</span><span class="op" id="5506798">(</span><span class="ident" id="5506799">b</span><span class="op" id="5506800">[</span><span class="op" id="5506801">:</span><span class="ident" id="5506802">n</span><span class="op" id="5506803">]</span><span class="op" id="5506804">)</span><span class="op" id="5506805">;</span>&nbsp;<span class="ident" id="5506807">err</span>&nbsp;<span class="op" id="5506811">!=</span>&nbsp;<span class="ident" id="5506814">nil</span>&nbsp;<span class="op" id="5506818">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506823">return</span>&nbsp;<span class="ident" id="5506830">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506840">if</span>&nbsp;<span class="ident" id="5506843">_</span><span class="op" id="5506844">,</span>&nbsp;<span class="ident" id="5506846">err</span>&nbsp;<span class="op" id="5506850">:=</span>&nbsp;<span class="ident" id="5506853">w</span><span class="op" id="5506854">.</span><span class="ident" id="5506855">WriteString</span><span class="op" id="5506866">(</span><span class="ident" id="5506867">k</span><span class="op" id="5506868">)</span><span class="op" id="5506869">;</span>&nbsp;<span class="ident" id="5506871">err</span>&nbsp;<span class="op" id="5506875">!=</span>&nbsp;<span class="ident" id="5506878">nil</span>&nbsp;<span class="op" id="5506882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506887">return</span>&nbsp;<span class="ident" id="5506894">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506900">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506904">if</span>&nbsp;<span class="ident" id="5506907">_</span><span class="op" id="5506908">,</span>&nbsp;<span class="ident" id="5506910">err</span>&nbsp;<span class="op" id="5506914">:=</span>&nbsp;<span class="ident" id="5506917">w</span><span class="op" id="5506918">.</span><span class="ident" id="5506919">WriteString</span><span class="op" id="5506930">(</span><span class="ident" id="5506931">v</span><span class="op" id="5506932">)</span><span class="op" id="5506933">;</span>&nbsp;<span class="ident" id="5506935">err</span>&nbsp;<span class="op" id="5506939">!=</span>&nbsp;<span class="ident" id="5506942">nil</span>&nbsp;<span class="op" id="5506946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506951">return</span>&nbsp;<span class="ident" id="5506958">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506970">w</span><span class="op" id="5506971">.</span><span class="ident" id="5506972">Close</span><span class="op" id="5506977">(</span><span class="op" id="5506978">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506981">return</span>&nbsp;<span class="ident" id="5506988">nil</span><br>
<span class="lineno"></span><span class="op" id="5506992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5506995">func</span>&nbsp;<span class="ident" id="5507000">readSize</span><span class="op" id="5507008">(</span><span class="ident" id="5507009">s</span>&nbsp;<span class="op" id="5507011">[</span><span class="op" id="5507012">]</span><span class="builtintype" id="5507013">byte</span><span class="op" id="5507017">)</span>&nbsp;<span class="op" id="5507019">(</span><span class="builtintype" id="5507020">uint32</span><span class="op" id="5507026">,</span>&nbsp;<span class="builtintype" id="5507028">int</span><span class="op" id="5507031">)</span>&nbsp;<span class="op" id="5507033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507036">if</span>&nbsp;<span class="builtinfunc" id="5507039">len</span><span class="op" id="5507042">(</span><span class="ident" id="5507043">s</span><span class="op" id="5507044">)</span>&nbsp;<span class="op" id="5507046">==</span>&nbsp;<span class="num" id="5507049">0</span>&nbsp;<span class="op" id="5507051">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507055">return</span>&nbsp;<span class="num" id="5507062">0</span><span class="op" id="5507063">,</span>&nbsp;<span class="num" id="5507065">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507071">size</span><span class="op" id="5507075">,</span>&nbsp;<span class="ident" id="5507077">n</span>&nbsp;<span class="op" id="5507079">:=</span>&nbsp;<span class="builtintype" id="5507082">uint32</span><span class="op" id="5507088">(</span><span class="ident" id="5507089">s</span><span class="op" id="5507090">[</span><span class="num" id="5507091">0</span><span class="op" id="5507092">]</span><span class="op" id="5507093">)</span><span class="op" id="5507094">,</span>&nbsp;<span class="num" id="5507096">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507099">if</span>&nbsp;<span class="ident" id="5507102">size</span><span class="op" id="5507106">&amp;</span><span class="op" id="5507107">(</span><span class="num" id="5507108">1</span><span class="op" id="5507109">&lt;&lt;</span><span class="num" id="5507111">7</span><span class="op" id="5507112">)</span>&nbsp;<span class="op" id="5507114">!=</span>&nbsp;<span class="num" id="5507117">0</span>&nbsp;<span class="op" id="5507119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507123">if</span>&nbsp;<span class="builtinfunc" id="5507126">len</span><span class="op" id="5507129">(</span><span class="ident" id="5507130">s</span><span class="op" id="5507131">)</span>&nbsp;<span class="op" id="5507133">&lt;</span>&nbsp;<span class="num" id="5507135">4</span>&nbsp;<span class="op" id="5507137">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507142">return</span>&nbsp;<span class="num" id="5507149">0</span><span class="op" id="5507150">,</span>&nbsp;<span class="num" id="5507152">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507160">n</span>&nbsp;<span class="op" id="5507162">=</span>&nbsp;<span class="num" id="5507164">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507168">size</span>&nbsp;<span class="op" id="5507173">=</span>&nbsp;<span class="ident" id="5507175">binary</span><span class="op" id="5507181">.</span><span class="ident" id="5507182">BigEndian</span><span class="op" id="5507191">.</span><span class="ident" id="5507192">Uint32</span><span class="op" id="5507198">(</span><span class="ident" id="5507199">s</span><span class="op" id="5507200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507204">size</span>&nbsp;<span class="op" id="5507209">&amp;^=</span>&nbsp;<span class="num" id="5507213">1</span>&nbsp;<span class="op" id="5507215">&lt;&lt;</span>&nbsp;<span class="num" id="5507218">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507225">return</span>&nbsp;<span class="ident" id="5507232">size</span><span class="op" id="5507236">,</span>&nbsp;<span class="ident" id="5507238">n</span><br>
<span class="lineno"></span><span class="op" id="5507240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5507243">func</span>&nbsp;<span class="ident" id="5507248">readString</span><span class="op" id="5507258">(</span><span class="ident" id="5507259">s</span>&nbsp;<span class="op" id="5507261">[</span><span class="op" id="5507262">]</span><span class="builtintype" id="5507263">byte</span><span class="op" id="5507267">,</span>&nbsp;<span class="ident" id="5507269">size</span>&nbsp;<span class="builtintype" id="5507274">uint32</span><span class="op" id="5507280">)</span>&nbsp;<span class="builtintype" id="5507282">string</span>&nbsp;<span class="op" id="5507289">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507292">if</span>&nbsp;<span class="ident" id="5507295">size</span>&nbsp;<span class="op" id="5507300">&gt;</span>&nbsp;<span class="builtintype" id="5507302">uint32</span><span class="op" id="5507308">(</span><span class="builtinfunc" id="5507309">len</span><span class="op" id="5507312">(</span><span class="ident" id="5507313">s</span><span class="op" id="5507314">)</span><span class="op" id="5507315">)</span>&nbsp;<span class="op" id="5507317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507321">return</span>&nbsp;<span class="string" id="5507328">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507335">return</span>&nbsp;<span class="builtintype" id="5507342">string</span><span class="op" id="5507348">(</span><span class="ident" id="5507349">s</span><span class="op" id="5507350">[</span><span class="op" id="5507351">:</span><span class="ident" id="5507352">size</span><span class="op" id="5507356">]</span><span class="op" id="5507357">)</span><br>
<span class="lineno"></span><span class="op" id="5507359">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5507362">func</span>&nbsp;<span class="ident" id="5507367">encodeSize</span><span class="op" id="5507377">(</span><span class="ident" id="5507378">b</span>&nbsp;<span class="op" id="5507380">[</span><span class="op" id="5507381">]</span><span class="builtintype" id="5507382">byte</span><span class="op" id="5507386">,</span>&nbsp;<span class="ident" id="5507388">size</span>&nbsp;<span class="builtintype" id="5507393">uint32</span><span class="op" id="5507399">)</span>&nbsp;<span class="builtintype" id="5507401">int</span>&nbsp;<span class="op" id="5507405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507408">if</span>&nbsp;<span class="ident" id="5507411">size</span>&nbsp;<span class="op" id="5507416">&gt;</span>&nbsp;<span class="num" id="5507418">127</span>&nbsp;<span class="op" id="5507422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507426">size</span>&nbsp;<span class="op" id="5507431">|=</span>&nbsp;<span class="num" id="5507434">1</span>&nbsp;<span class="op" id="5507436">&lt;&lt;</span>&nbsp;<span class="num" id="5507439">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507444">binary</span><span class="op" id="5507450">.</span><span class="ident" id="5507451">BigEndian</span><span class="op" id="5507460">.</span><span class="ident" id="5507461">PutUint32</span><span class="op" id="5507470">(</span><span class="ident" id="5507471">b</span><span class="op" id="5507472">,</span>&nbsp;<span class="ident" id="5507474">size</span><span class="op" id="5507478">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507482">return</span>&nbsp;<span class="num" id="5507489">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507495">b</span><span class="op" id="5507496">[</span><span class="num" id="5507497">0</span><span class="op" id="5507498">]</span>&nbsp;<span class="op" id="5507500">=</span>&nbsp;<span class="builtintype" id="5507502">byte</span><span class="op" id="5507506">(</span><span class="ident" id="5507507">size</span><span class="op" id="5507511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507514">return</span>&nbsp;<span class="num" id="5507521">1</span><br>
<span class="lineno"></span><span class="op" id="5507523">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="5507526">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5507608">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="5507619">type</span>&nbsp;<span class="ident" id="5507624">bufWriter</span>&nbsp;<span class="keyword" id="5507634">struct</span>&nbsp;<span class="op" id="5507641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507644">closer</span>&nbsp;<span class="ident" id="5507651">io</span><span class="op" id="5507653">.</span><span class="ident" id="5507654">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507662">*</span><span class="ident" id="5507663">bufio</span><span class="op" id="5507668">.</span><span class="ident" id="5507669">Writer</span><br>
<span class="lineno"></span><span class="op" id="5507676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5507679">func</span>&nbsp;<span class="op" id="5507684">(</span><span class="ident" id="5507685">w</span>&nbsp;<span class="op" id="5507687">*</span><span class="ident" id="5507688">bufWriter</span><span class="op" id="5507697">)</span>&nbsp;<span class="ident" id="5507699">Close</span><span class="op" id="5507704">(</span><span class="op" id="5507705">)</span>&nbsp;<span class="builtintype" id="5507707">error</span>&nbsp;<span class="op" id="5507713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507716">if</span>&nbsp;<span class="ident" id="5507719">err</span>&nbsp;<span class="op" id="5507723">:=</span>&nbsp;<span class="ident" id="5507726">w</span><span class="op" id="5507727">.</span><span class="ident" id="5507728">Writer</span><span class="op" id="5507734">.</span><span class="ident" id="5507735">Flush</span><span class="op" id="5507740">(</span><span class="op" id="5507741">)</span><span class="op" id="5507742">;</span>&nbsp;<span class="ident" id="5507744">err</span>&nbsp;<span class="op" id="5507748">!=</span>&nbsp;<span class="ident" id="5507751">nil</span>&nbsp;<span class="op" id="5507755">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507759">w</span><span class="op" id="5507760">.</span><span class="ident" id="5507761">closer</span><span class="op" id="5507767">.</span><span class="ident" id="5507768">Close</span><span class="op" id="5507773">(</span><span class="op" id="5507774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507778">return</span>&nbsp;<span class="ident" id="5507785">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507793">return</span>&nbsp;<span class="ident" id="5507800">w</span><span class="op" id="5507801">.</span><span class="ident" id="5507802">closer</span><span class="op" id="5507808">.</span><span class="ident" id="5507809">Close</span><span class="op" id="5507814">(</span><span class="op" id="5507815">)</span><br>
<span class="lineno"></span><span class="op" id="5507817">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="5507820">func</span>&nbsp;<span class="ident" id="5507825">newWriter</span><span class="op" id="5507834">(</span><span class="ident" id="5507835">c</span>&nbsp;<span class="op" id="5507837">*</span><span class="ident" id="5507838">conn</span><span class="op" id="5507842">,</span>&nbsp;<span class="ident" id="5507844">recType</span>&nbsp;<span class="ident" id="5507852">recType</span><span class="op" id="5507859">,</span>&nbsp;<span class="ident" id="5507861">reqId</span>&nbsp;<span class="builtintype" id="5507867">uint16</span><span class="op" id="5507873">)</span>&nbsp;<span class="op" id="5507875">*</span><span class="ident" id="5507876">bufWriter</span>&nbsp;<span class="op" id="5507886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507889">s</span>&nbsp;<span class="op" id="5507891">:=</span>&nbsp;<span class="op" id="5507894">&amp;</span><span class="ident" id="5507895">streamWriter</span><span class="op" id="5507907">{</span><span class="ident" id="5507908">c</span><span class="op" id="5507909">:</span>&nbsp;<span class="ident" id="5507911">c</span><span class="op" id="5507912">,</span>&nbsp;<span class="ident" id="5507914">recType</span><span class="op" id="5507921">:</span>&nbsp;<span class="ident" id="5507923">recType</span><span class="op" id="5507930">,</span>&nbsp;<span class="ident" id="5507932">reqId</span><span class="op" id="5507937">:</span>&nbsp;<span class="ident" id="5507939">reqId</span><span class="op" id="5507944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507947">w</span>&nbsp;<span class="op" id="5507949">:=</span>&nbsp;<span class="ident" id="5507952">bufio</span><span class="op" id="5507957">.</span><span class="ident" id="5507958">NewWriterSize</span><span class="op" id="5507971">(</span><span class="ident" id="5507972">s</span><span class="op" id="5507973">,</span>&nbsp;<span class="ident" id="5507975">maxWrite</span><span class="op" id="5507983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507986">return</span>&nbsp;<span class="op" id="5507993">&amp;</span><span class="ident" id="5507994">bufWriter</span><span class="op" id="5508003">{</span><span class="ident" id="5508004">s</span><span class="op" id="5508005">,</span>&nbsp;<span class="ident" id="5508007">w</span><span class="op" id="5508008">}</span><br>
<span class="lineno">245</span><span class="op" id="5508010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5508013">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="5508093">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="5508137">type</span>&nbsp;<span class="ident" id="5508142">streamWriter</span>&nbsp;<span class="keyword" id="5508155">struct</span>&nbsp;<span class="op" id="5508162">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508165">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508173">*</span><span class="ident" id="5508174">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508180">recType</span>&nbsp;<span class="ident" id="5508188">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508197">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5508205">uint16</span><br>
<span class="lineno"></span><span class="op" id="5508212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="5508215">func</span>&nbsp;<span class="op" id="5508220">(</span><span class="ident" id="5508221">w</span>&nbsp;<span class="op" id="5508223">*</span><span class="ident" id="5508224">streamWriter</span><span class="op" id="5508236">)</span>&nbsp;<span class="ident" id="5508238">Write</span><span class="op" id="5508243">(</span><span class="ident" id="5508244">p</span>&nbsp;<span class="op" id="5508246">[</span><span class="op" id="5508247">]</span><span class="builtintype" id="5508248">byte</span><span class="op" id="5508252">)</span>&nbsp;<span class="op" id="5508254">(</span><span class="builtintype" id="5508255">int</span><span class="op" id="5508258">,</span>&nbsp;<span class="builtintype" id="5508260">error</span><span class="op" id="5508265">)</span>&nbsp;<span class="op" id="5508267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508270">nn</span>&nbsp;<span class="op" id="5508273">:=</span>&nbsp;<span class="num" id="5508276">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508279">for</span>&nbsp;<span class="builtinfunc" id="5508283">len</span><span class="op" id="5508286">(</span><span class="ident" id="5508287">p</span><span class="op" id="5508288">)</span>&nbsp;<span class="op" id="5508290">&gt;</span>&nbsp;<span class="num" id="5508292">0</span>&nbsp;<span class="op" id="5508294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508298">n</span>&nbsp;<span class="op" id="5508300">:=</span>&nbsp;<span class="builtinfunc" id="5508303">len</span><span class="op" id="5508306">(</span><span class="ident" id="5508307">p</span><span class="op" id="5508308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508312">if</span>&nbsp;<span class="ident" id="5508315">n</span>&nbsp;<span class="op" id="5508317">&gt;</span>&nbsp;<span class="ident" id="5508319">maxWrite</span>&nbsp;<span class="op" id="5508328">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508333">n</span>&nbsp;<span class="op" id="5508335">=</span>&nbsp;<span class="ident" id="5508337">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508352">if</span>&nbsp;<span class="ident" id="5508355">err</span>&nbsp;<span class="op" id="5508359">:=</span>&nbsp;<span class="ident" id="5508362">w</span><span class="op" id="5508363">.</span><span class="ident" id="5508364">c</span><span class="op" id="5508365">.</span><span class="ident" id="5508366">writeRecord</span><span class="op" id="5508377">(</span><span class="ident" id="5508378">w</span><span class="op" id="5508379">.</span><span class="ident" id="5508380">recType</span><span class="op" id="5508387">,</span>&nbsp;<span class="ident" id="5508389">w</span><span class="op" id="5508390">.</span><span class="ident" id="5508391">reqId</span><span class="op" id="5508396">,</span>&nbsp;<span class="ident" id="5508398">p</span><span class="op" id="5508399">[</span><span class="op" id="5508400">:</span><span class="ident" id="5508401">n</span><span class="op" id="5508402">]</span><span class="op" id="5508403">)</span><span class="op" id="5508404">;</span>&nbsp;<span class="ident" id="5508406">err</span>&nbsp;<span class="op" id="5508410">!=</span>&nbsp;<span class="ident" id="5508413">nil</span>&nbsp;<span class="op" id="5508417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508422">return</span>&nbsp;<span class="ident" id="5508429">nn</span><span class="op" id="5508431">,</span>&nbsp;<span class="ident" id="5508433">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508439">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508443">nn</span>&nbsp;<span class="op" id="5508446">+=</span>&nbsp;<span class="ident" id="5508449">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508453">p</span>&nbsp;<span class="op" id="5508455">=</span>&nbsp;<span class="ident" id="5508457">p</span><span class="op" id="5508458">[</span><span class="ident" id="5508459">n</span><span class="op" id="5508460">:</span><span class="op" id="5508461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508467">return</span>&nbsp;<span class="ident" id="5508474">nn</span><span class="op" id="5508476">,</span>&nbsp;<span class="ident" id="5508478">nil</span><br>
<span class="lineno"></span><span class="op" id="5508482">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="5508485">func</span>&nbsp;<span class="op" id="5508490">(</span><span class="ident" id="5508491">w</span>&nbsp;<span class="op" id="5508493">*</span><span class="ident" id="5508494">streamWriter</span><span class="op" id="5508506">)</span>&nbsp;<span class="ident" id="5508508">Close</span><span class="op" id="5508513">(</span><span class="op" id="5508514">)</span>&nbsp;<span class="builtintype" id="5508516">error</span>&nbsp;<span class="op" id="5508522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508525">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508567">return</span>&nbsp;<span class="ident" id="5508574">w</span><span class="op" id="5508575">.</span><span class="ident" id="5508576">c</span><span class="op" id="5508577">.</span><span class="ident" id="5508578">writeRecord</span><span class="op" id="5508589">(</span><span class="ident" id="5508590">w</span><span class="op" id="5508591">.</span><span class="ident" id="5508592">recType</span><span class="op" id="5508599">,</span>&nbsp;<span class="ident" id="5508601">w</span><span class="op" id="5508602">.</span><span class="ident" id="5508603">reqId</span><span class="op" id="5508608">,</span>&nbsp;<span class="ident" id="5508610">nil</span><span class="op" id="5508613">)</span><br>
<span class="lineno"></span><span class="op" id="5508615">}</span>
</div>
</body>
</html>
