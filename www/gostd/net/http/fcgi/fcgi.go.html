<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6249153">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6249208">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6249262">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6249313">//&nbsp;Package&nbsp;fcgi&nbsp;implements&nbsp;the&nbsp;FastCGI&nbsp;protocol.</span><br>
<span class="lineno"></span><span class="comment" id="6249362">//&nbsp;Currently&nbsp;only&nbsp;the&nbsp;responder&nbsp;role&nbsp;is&nbsp;supported.</span><br>
<span class="lineno"></span><span class="comment" id="6249413">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://www.fastcgi.com/drupal/node/6?q=node/22</span><br>
<span class="lineno"></span><span class="keyword" id="6249490">package</span>&nbsp;<span class="ident" id="6249498">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6249504">//&nbsp;This&nbsp;file&nbsp;defines&nbsp;the&nbsp;raw&nbsp;protocol&nbsp;and&nbsp;some&nbsp;utilities&nbsp;used&nbsp;by&nbsp;the&nbsp;child&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6249583">//&nbsp;the&nbsp;host.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6249597">import</span>&nbsp;<span class="op" id="6249604">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6249607">&#34;bufio&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6249616">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6249625">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6249644">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6249654">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6249660">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6249667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6249670">//&nbsp;recType&nbsp;is&nbsp;a&nbsp;record&nbsp;type,&nbsp;as&nbsp;defined&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6249713">//&nbsp;http://www.fastcgi.com/devkit/doc/fcgi-spec.html#S8</span><br>
<span class="lineno"></span><span class="keyword" id="6249768">type</span>&nbsp;<span class="ident" id="6249773">recType</span>&nbsp;<span class="builtintype" id="6249781">uint8</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6249788">const</span>&nbsp;<span class="op" id="6249794">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249797">typeBeginRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249817">recType</span>&nbsp;<span class="op" id="6249825">=</span>&nbsp;<span class="num" id="6249827">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249830">typeAbortRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249850">recType</span>&nbsp;<span class="op" id="6249858">=</span>&nbsp;<span class="num" id="6249860">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249863">typeEndRequest</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249883">recType</span>&nbsp;<span class="op" id="6249891">=</span>&nbsp;<span class="num" id="6249893">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249896">typeParams</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249916">recType</span>&nbsp;<span class="op" id="6249924">=</span>&nbsp;<span class="num" id="6249926">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249929">typeStdin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249949">recType</span>&nbsp;<span class="op" id="6249957">=</span>&nbsp;<span class="num" id="6249959">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249962">typeStdout</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6249982">recType</span>&nbsp;<span class="op" id="6249990">=</span>&nbsp;<span class="num" id="6249992">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249995">typeStderr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6250015">recType</span>&nbsp;<span class="op" id="6250023">=</span>&nbsp;<span class="num" id="6250025">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250028">typeData</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6250048">recType</span>&nbsp;<span class="op" id="6250056">=</span>&nbsp;<span class="num" id="6250058">8</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250061">typeGetValues</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6250081">recType</span>&nbsp;<span class="op" id="6250089">=</span>&nbsp;<span class="num" id="6250091">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250094">typeGetValuesResult</span>&nbsp;<span class="ident" id="6250114">recType</span>&nbsp;<span class="op" id="6250122">=</span>&nbsp;<span class="num" id="6250124">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250128">typeUnknownType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6250148">recType</span>&nbsp;<span class="op" id="6250156">=</span>&nbsp;<span class="num" id="6250158">11</span><br>
<span class="lineno"></span><span class="op" id="6250161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="6250164">//&nbsp;keep&nbsp;the&nbsp;connection&nbsp;between&nbsp;web-server&nbsp;and&nbsp;responder&nbsp;open&nbsp;after&nbsp;request</span><br>
<span class="lineno"></span><span class="keyword" id="6250239">const</span>&nbsp;<span class="ident" id="6250245">flagKeepConn</span>&nbsp;<span class="op" id="6250258">=</span>&nbsp;<span class="num" id="6250260">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6250263">const</span>&nbsp;<span class="op" id="6250269">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250272">maxWrite</span>&nbsp;<span class="op" id="6250281">=</span>&nbsp;<span class="num" id="6250283">65535</span>&nbsp;<span class="comment" id="6250289">//&nbsp;maximum&nbsp;record&nbsp;body</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250313">maxPad</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6250322">=</span>&nbsp;<span class="num" id="6250324">255</span><br>
<span class="lineno"></span><span class="op" id="6250328">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6250331">const</span>&nbsp;<span class="op" id="6250337">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250340">roleResponder</span>&nbsp;<span class="op" id="6250354">=</span>&nbsp;<span class="ident" id="6250356">iota</span>&nbsp;<span class="op" id="6250361">+</span>&nbsp;<span class="num" id="6250363">1</span>&nbsp;<span class="comment" id="6250365">//&nbsp;only&nbsp;Responders&nbsp;are&nbsp;implemented.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250402">roleAuthorizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250418">roleFilter</span><br>
<span class="lineno"></span><span class="op" id="6250429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6250432">const</span>&nbsp;<span class="op" id="6250438">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250441">statusRequestComplete</span>&nbsp;<span class="op" id="6250463">=</span>&nbsp;<span class="ident" id="6250465">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250471">statusCantMultiplex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250492">statusOverloaded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250510">statusUnknownRole</span><br>
<span class="lineno"></span><span class="op" id="6250528">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6250531">const</span>&nbsp;<span class="ident" id="6250537">headerLen</span>&nbsp;<span class="op" id="6250547">=</span>&nbsp;<span class="num" id="6250549">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6250552">type</span>&nbsp;<span class="ident" id="6250557">header</span>&nbsp;<span class="keyword" id="6250564">struct</span>&nbsp;<span class="op" id="6250571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250574">Version</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6250588">uint8</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250595">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6250609">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250618">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6250632">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250640">ContentLength</span>&nbsp;<span class="builtintype" id="6250654">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250662">PaddingLength</span>&nbsp;<span class="builtintype" id="6250676">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250683">Reserved</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6250697">uint8</span><br>
<span class="lineno">70</span><span class="op" id="6250703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6250706">type</span>&nbsp;<span class="ident" id="6250711">beginRequest</span>&nbsp;<span class="keyword" id="6250724">struct</span>&nbsp;<span class="op" id="6250731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250734">role</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6250743">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250751">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6250760">uint8</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250767">reserved</span>&nbsp;<span class="op" id="6250776">[</span><span class="num" id="6250777">5</span><span class="op" id="6250778">]</span><span class="builtintype" id="6250779">uint8</span><br>
<span class="lineno"></span><span class="op" id="6250785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6250788">func</span>&nbsp;<span class="op" id="6250793">(</span><span class="ident" id="6250794">br</span>&nbsp;<span class="op" id="6250797">*</span><span class="ident" id="6250798">beginRequest</span><span class="op" id="6250810">)</span>&nbsp;<span class="ident" id="6250812">read</span><span class="op" id="6250816">(</span><span class="ident" id="6250817">content</span>&nbsp;<span class="op" id="6250825">[</span><span class="op" id="6250826">]</span><span class="builtintype" id="6250827">byte</span><span class="op" id="6250831">)</span>&nbsp;<span class="builtintype" id="6250833">error</span>&nbsp;<span class="op" id="6250839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6250842">if</span>&nbsp;<span class="builtinfunc" id="6250845">len</span><span class="op" id="6250848">(</span><span class="ident" id="6250849">content</span><span class="op" id="6250856">)</span>&nbsp;<span class="op" id="6250858">!=</span>&nbsp;<span class="num" id="6250861">8</span>&nbsp;<span class="op" id="6250863">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6250867">return</span>&nbsp;<span class="ident" id="6250874">errors</span><span class="op" id="6250880">.</span><span class="ident" id="6250881">New</span><span class="op" id="6250884">(</span><span class="string" id="6250885">&#34;fcgi:&nbsp;invalid&nbsp;begin&nbsp;request&nbsp;record&#34;</span><span class="op" id="6250921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6250924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250927">br</span><span class="op" id="6250929">.</span><span class="ident" id="6250930">role</span>&nbsp;<span class="op" id="6250935">=</span>&nbsp;<span class="ident" id="6250937">binary</span><span class="op" id="6250943">.</span><span class="ident" id="6250944">BigEndian</span><span class="op" id="6250953">.</span><span class="ident" id="6250954">Uint16</span><span class="op" id="6250960">(</span><span class="ident" id="6250961">content</span><span class="op" id="6250968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6250971">br</span><span class="op" id="6250973">.</span><span class="ident" id="6250974">flags</span>&nbsp;<span class="op" id="6250980">=</span>&nbsp;<span class="ident" id="6250982">content</span><span class="op" id="6250989">[</span><span class="num" id="6250990">2</span><span class="op" id="6250991">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6250994">return</span>&nbsp;<span class="ident" id="6251001">nil</span><br>
<span class="lineno">85</span><span class="op" id="6251005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6251008">//&nbsp;for&nbsp;padding&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;allocate&nbsp;all&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="6251065">//&nbsp;not&nbsp;synchronized&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;care&nbsp;what&nbsp;the&nbsp;contents&nbsp;are</span><br>
<span class="lineno"></span><span class="keyword" id="6251129">var</span>&nbsp;<span class="ident" id="6251133">pad</span>&nbsp;<span class="op" id="6251137">[</span><span class="ident" id="6251138">maxPad</span><span class="op" id="6251144">]</span><span class="builtintype" id="6251145">byte</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="6251151">func</span>&nbsp;<span class="op" id="6251156">(</span><span class="ident" id="6251157">h</span>&nbsp;<span class="op" id="6251159">*</span><span class="ident" id="6251160">header</span><span class="op" id="6251166">)</span>&nbsp;<span class="ident" id="6251168">init</span><span class="op" id="6251172">(</span><span class="ident" id="6251173">recType</span>&nbsp;<span class="ident" id="6251181">recType</span><span class="op" id="6251188">,</span>&nbsp;<span class="ident" id="6251190">reqId</span>&nbsp;<span class="builtintype" id="6251196">uint16</span><span class="op" id="6251202">,</span>&nbsp;<span class="ident" id="6251204">contentLength</span>&nbsp;<span class="builtintype" id="6251218">int</span><span class="op" id="6251221">)</span>&nbsp;<span class="op" id="6251223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251226">h</span><span class="op" id="6251227">.</span><span class="ident" id="6251228">Version</span>&nbsp;<span class="op" id="6251236">=</span>&nbsp;<span class="num" id="6251238">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251241">h</span><span class="op" id="6251242">.</span><span class="ident" id="6251243">Type</span>&nbsp;<span class="op" id="6251248">=</span>&nbsp;<span class="ident" id="6251250">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251259">h</span><span class="op" id="6251260">.</span><span class="ident" id="6251261">Id</span>&nbsp;<span class="op" id="6251264">=</span>&nbsp;<span class="ident" id="6251266">reqId</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251273">h</span><span class="op" id="6251274">.</span><span class="ident" id="6251275">ContentLength</span>&nbsp;<span class="op" id="6251289">=</span>&nbsp;<span class="builtintype" id="6251291">uint16</span><span class="op" id="6251297">(</span><span class="ident" id="6251298">contentLength</span><span class="op" id="6251311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251314">h</span><span class="op" id="6251315">.</span><span class="ident" id="6251316">PaddingLength</span>&nbsp;<span class="op" id="6251330">=</span>&nbsp;<span class="builtintype" id="6251332">uint8</span><span class="op" id="6251337">(</span><span class="op" id="6251338">-</span><span class="ident" id="6251339">contentLength</span>&nbsp;<span class="op" id="6251353">&amp;</span>&nbsp;<span class="num" id="6251355">7</span><span class="op" id="6251356">)</span><br>
<span class="lineno"></span><span class="op" id="6251358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6251361">//&nbsp;conn&nbsp;sends&nbsp;records&nbsp;over&nbsp;rwc</span><br>
<span class="lineno">100</span><span class="keyword" id="6251392">type</span>&nbsp;<span class="ident" id="6251397">conn</span>&nbsp;<span class="keyword" id="6251402">struct</span>&nbsp;<span class="op" id="6251409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251412">mutex</span>&nbsp;<span class="ident" id="6251418">sync</span><span class="op" id="6251422">.</span><span class="ident" id="6251423">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251430">rwc</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6251436">io</span><span class="op" id="6251438">.</span><span class="ident" id="6251439">ReadWriteCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6251457">//&nbsp;to&nbsp;avoid&nbsp;allocations</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251482">buf</span>&nbsp;<span class="ident" id="6251486">bytes</span><span class="op" id="6251491">.</span><span class="ident" id="6251492">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251500">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6251504">header</span><br>
<span class="lineno"></span><span class="op" id="6251511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6251514">func</span>&nbsp;<span class="ident" id="6251519">newConn</span><span class="op" id="6251526">(</span><span class="ident" id="6251527">rwc</span>&nbsp;<span class="ident" id="6251531">io</span><span class="op" id="6251533">.</span><span class="ident" id="6251534">ReadWriteCloser</span><span class="op" id="6251549">)</span>&nbsp;<span class="op" id="6251551">*</span><span class="ident" id="6251552">conn</span>&nbsp;<span class="op" id="6251557">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251560">return</span>&nbsp;<span class="op" id="6251567">&amp;</span><span class="ident" id="6251568">conn</span><span class="op" id="6251572">{</span><span class="ident" id="6251573">rwc</span><span class="op" id="6251576">:</span>&nbsp;<span class="ident" id="6251578">rwc</span><span class="op" id="6251581">}</span><br>
<span class="lineno"></span><span class="op" id="6251583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6251586">func</span>&nbsp;<span class="op" id="6251591">(</span><span class="ident" id="6251592">c</span>&nbsp;<span class="op" id="6251594">*</span><span class="ident" id="6251595">conn</span><span class="op" id="6251599">)</span>&nbsp;<span class="ident" id="6251601">Close</span><span class="op" id="6251606">(</span><span class="op" id="6251607">)</span>&nbsp;<span class="builtintype" id="6251609">error</span>&nbsp;<span class="op" id="6251615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251618">c</span><span class="op" id="6251619">.</span><span class="ident" id="6251620">mutex</span><span class="op" id="6251625">.</span><span class="ident" id="6251626">Lock</span><span class="op" id="6251630">(</span><span class="op" id="6251631">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251634">defer</span>&nbsp;<span class="ident" id="6251640">c</span><span class="op" id="6251641">.</span><span class="ident" id="6251642">mutex</span><span class="op" id="6251647">.</span><span class="ident" id="6251648">Unlock</span><span class="op" id="6251654">(</span><span class="op" id="6251655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251658">return</span>&nbsp;<span class="ident" id="6251665">c</span><span class="op" id="6251666">.</span><span class="ident" id="6251667">rwc</span><span class="op" id="6251670">.</span><span class="ident" id="6251671">Close</span><span class="op" id="6251676">(</span><span class="op" id="6251677">)</span><br>
<span class="lineno"></span><span class="op" id="6251679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6251682">type</span>&nbsp;<span class="ident" id="6251687">record</span>&nbsp;<span class="keyword" id="6251694">struct</span>&nbsp;<span class="op" id="6251701">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251704">h</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6251708">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251716">buf</span>&nbsp;<span class="op" id="6251720">[</span><span class="ident" id="6251721">maxWrite</span>&nbsp;<span class="op" id="6251730">+</span>&nbsp;<span class="ident" id="6251732">maxPad</span><span class="op" id="6251738">]</span><span class="builtintype" id="6251739">byte</span><br>
<span class="lineno"></span><span class="op" id="6251744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6251747">func</span>&nbsp;<span class="op" id="6251752">(</span><span class="ident" id="6251753">rec</span>&nbsp;<span class="op" id="6251757">*</span><span class="ident" id="6251758">record</span><span class="op" id="6251764">)</span>&nbsp;<span class="ident" id="6251766">read</span><span class="op" id="6251770">(</span><span class="ident" id="6251771">r</span>&nbsp;<span class="ident" id="6251773">io</span><span class="op" id="6251775">.</span><span class="ident" id="6251776">Reader</span><span class="op" id="6251782">)</span>&nbsp;<span class="op" id="6251784">(</span><span class="ident" id="6251785">err</span>&nbsp;<span class="builtintype" id="6251789">error</span><span class="op" id="6251794">)</span>&nbsp;<span class="op" id="6251796">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251799">if</span>&nbsp;<span class="ident" id="6251802">err</span>&nbsp;<span class="op" id="6251806">=</span>&nbsp;<span class="ident" id="6251808">binary</span><span class="op" id="6251814">.</span><span class="ident" id="6251815">Read</span><span class="op" id="6251819">(</span><span class="ident" id="6251820">r</span><span class="op" id="6251821">,</span>&nbsp;<span class="ident" id="6251823">binary</span><span class="op" id="6251829">.</span><span class="ident" id="6251830">BigEndian</span><span class="op" id="6251839">,</span>&nbsp;<span class="op" id="6251841">&amp;</span><span class="ident" id="6251842">rec</span><span class="op" id="6251845">.</span><span class="ident" id="6251846">h</span><span class="op" id="6251847">)</span><span class="op" id="6251848">;</span>&nbsp;<span class="ident" id="6251850">err</span>&nbsp;<span class="op" id="6251854">!=</span>&nbsp;<span class="ident" id="6251857">nil</span>&nbsp;<span class="op" id="6251861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251865">return</span>&nbsp;<span class="ident" id="6251872">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6251877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251880">if</span>&nbsp;<span class="ident" id="6251883">rec</span><span class="op" id="6251886">.</span><span class="ident" id="6251887">h</span><span class="op" id="6251888">.</span><span class="ident" id="6251889">Version</span>&nbsp;<span class="op" id="6251897">!=</span>&nbsp;<span class="num" id="6251900">1</span>&nbsp;<span class="op" id="6251902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251906">return</span>&nbsp;<span class="ident" id="6251913">errors</span><span class="op" id="6251919">.</span><span class="ident" id="6251920">New</span><span class="op" id="6251923">(</span><span class="string" id="6251924">&#34;fcgi:&nbsp;invalid&nbsp;header&nbsp;version&#34;</span><span class="op" id="6251954">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6251957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251960">n</span>&nbsp;<span class="op" id="6251962">:=</span>&nbsp;<span class="builtintype" id="6251965">int</span><span class="op" id="6251968">(</span><span class="ident" id="6251969">rec</span><span class="op" id="6251972">.</span><span class="ident" id="6251973">h</span><span class="op" id="6251974">.</span><span class="ident" id="6251975">ContentLength</span><span class="op" id="6251988">)</span>&nbsp;<span class="op" id="6251990">+</span>&nbsp;<span class="builtintype" id="6251992">int</span><span class="op" id="6251995">(</span><span class="ident" id="6251996">rec</span><span class="op" id="6251999">.</span><span class="ident" id="6252000">h</span><span class="op" id="6252001">.</span><span class="ident" id="6252002">PaddingLength</span><span class="op" id="6252015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252018">if</span>&nbsp;<span class="ident" id="6252021">_</span><span class="op" id="6252022">,</span>&nbsp;<span class="ident" id="6252024">err</span>&nbsp;<span class="op" id="6252028">=</span>&nbsp;<span class="ident" id="6252030">io</span><span class="op" id="6252032">.</span><span class="ident" id="6252033">ReadFull</span><span class="op" id="6252041">(</span><span class="ident" id="6252042">r</span><span class="op" id="6252043">,</span>&nbsp;<span class="ident" id="6252045">rec</span><span class="op" id="6252048">.</span><span class="ident" id="6252049">buf</span><span class="op" id="6252052">[</span><span class="op" id="6252053">:</span><span class="ident" id="6252054">n</span><span class="op" id="6252055">]</span><span class="op" id="6252056">)</span><span class="op" id="6252057">;</span>&nbsp;<span class="ident" id="6252059">err</span>&nbsp;<span class="op" id="6252063">!=</span>&nbsp;<span class="ident" id="6252066">nil</span>&nbsp;<span class="op" id="6252070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252074">return</span>&nbsp;<span class="ident" id="6252081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252086">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252089">return</span>&nbsp;<span class="ident" id="6252096">nil</span><br>
<span class="lineno"></span><span class="op" id="6252100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6252103">func</span>&nbsp;<span class="op" id="6252108">(</span><span class="ident" id="6252109">r</span>&nbsp;<span class="op" id="6252111">*</span><span class="ident" id="6252112">record</span><span class="op" id="6252118">)</span>&nbsp;<span class="ident" id="6252120">content</span><span class="op" id="6252127">(</span><span class="op" id="6252128">)</span>&nbsp;<span class="op" id="6252130">[</span><span class="op" id="6252131">]</span><span class="builtintype" id="6252132">byte</span>&nbsp;<span class="op" id="6252137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252140">return</span>&nbsp;<span class="ident" id="6252147">r</span><span class="op" id="6252148">.</span><span class="ident" id="6252149">buf</span><span class="op" id="6252152">[</span><span class="op" id="6252153">:</span><span class="ident" id="6252154">r</span><span class="op" id="6252155">.</span><span class="ident" id="6252156">h</span><span class="op" id="6252157">.</span><span class="ident" id="6252158">ContentLength</span><span class="op" id="6252171">]</span><br>
<span class="lineno">140</span><span class="op" id="6252173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6252176">//&nbsp;writeRecord&nbsp;writes&nbsp;and&nbsp;sends&nbsp;a&nbsp;single&nbsp;record.</span><br>
<span class="lineno"></span><span class="keyword" id="6252225">func</span>&nbsp;<span class="op" id="6252230">(</span><span class="ident" id="6252231">c</span>&nbsp;<span class="op" id="6252233">*</span><span class="ident" id="6252234">conn</span><span class="op" id="6252238">)</span>&nbsp;<span class="ident" id="6252240">writeRecord</span><span class="op" id="6252251">(</span><span class="ident" id="6252252">recType</span>&nbsp;<span class="ident" id="6252260">recType</span><span class="op" id="6252267">,</span>&nbsp;<span class="ident" id="6252269">reqId</span>&nbsp;<span class="builtintype" id="6252275">uint16</span><span class="op" id="6252281">,</span>&nbsp;<span class="ident" id="6252283">b</span>&nbsp;<span class="op" id="6252285">[</span><span class="op" id="6252286">]</span><span class="builtintype" id="6252287">byte</span><span class="op" id="6252291">)</span>&nbsp;<span class="builtintype" id="6252293">error</span>&nbsp;<span class="op" id="6252299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252302">c</span><span class="op" id="6252303">.</span><span class="ident" id="6252304">mutex</span><span class="op" id="6252309">.</span><span class="ident" id="6252310">Lock</span><span class="op" id="6252314">(</span><span class="op" id="6252315">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252318">defer</span>&nbsp;<span class="ident" id="6252324">c</span><span class="op" id="6252325">.</span><span class="ident" id="6252326">mutex</span><span class="op" id="6252331">.</span><span class="ident" id="6252332">Unlock</span><span class="op" id="6252338">(</span><span class="op" id="6252339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252342">c</span><span class="op" id="6252343">.</span><span class="ident" id="6252344">buf</span><span class="op" id="6252347">.</span><span class="ident" id="6252348">Reset</span><span class="op" id="6252353">(</span><span class="op" id="6252354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252357">c</span><span class="op" id="6252358">.</span><span class="ident" id="6252359">h</span><span class="op" id="6252360">.</span><span class="ident" id="6252361">init</span><span class="op" id="6252365">(</span><span class="ident" id="6252366">recType</span><span class="op" id="6252373">,</span>&nbsp;<span class="ident" id="6252375">reqId</span><span class="op" id="6252380">,</span>&nbsp;<span class="builtinfunc" id="6252382">len</span><span class="op" id="6252385">(</span><span class="ident" id="6252386">b</span><span class="op" id="6252387">)</span><span class="op" id="6252388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252391">if</span>&nbsp;<span class="ident" id="6252394">err</span>&nbsp;<span class="op" id="6252398">:=</span>&nbsp;<span class="ident" id="6252401">binary</span><span class="op" id="6252407">.</span><span class="ident" id="6252408">Write</span><span class="op" id="6252413">(</span><span class="op" id="6252414">&amp;</span><span class="ident" id="6252415">c</span><span class="op" id="6252416">.</span><span class="ident" id="6252417">buf</span><span class="op" id="6252420">,</span>&nbsp;<span class="ident" id="6252422">binary</span><span class="op" id="6252428">.</span><span class="ident" id="6252429">BigEndian</span><span class="op" id="6252438">,</span>&nbsp;<span class="ident" id="6252440">c</span><span class="op" id="6252441">.</span><span class="ident" id="6252442">h</span><span class="op" id="6252443">)</span><span class="op" id="6252444">;</span>&nbsp;<span class="ident" id="6252446">err</span>&nbsp;<span class="op" id="6252450">!=</span>&nbsp;<span class="ident" id="6252453">nil</span>&nbsp;<span class="op" id="6252457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252461">return</span>&nbsp;<span class="ident" id="6252468">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252476">if</span>&nbsp;<span class="ident" id="6252479">_</span><span class="op" id="6252480">,</span>&nbsp;<span class="ident" id="6252482">err</span>&nbsp;<span class="op" id="6252486">:=</span>&nbsp;<span class="ident" id="6252489">c</span><span class="op" id="6252490">.</span><span class="ident" id="6252491">buf</span><span class="op" id="6252494">.</span><span class="ident" id="6252495">Write</span><span class="op" id="6252500">(</span><span class="ident" id="6252501">b</span><span class="op" id="6252502">)</span><span class="op" id="6252503">;</span>&nbsp;<span class="ident" id="6252505">err</span>&nbsp;<span class="op" id="6252509">!=</span>&nbsp;<span class="ident" id="6252512">nil</span>&nbsp;<span class="op" id="6252516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252520">return</span>&nbsp;<span class="ident" id="6252527">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252535">if</span>&nbsp;<span class="ident" id="6252538">_</span><span class="op" id="6252539">,</span>&nbsp;<span class="ident" id="6252541">err</span>&nbsp;<span class="op" id="6252545">:=</span>&nbsp;<span class="ident" id="6252548">c</span><span class="op" id="6252549">.</span><span class="ident" id="6252550">buf</span><span class="op" id="6252553">.</span><span class="ident" id="6252554">Write</span><span class="op" id="6252559">(</span><span class="ident" id="6252560">pad</span><span class="op" id="6252563">[</span><span class="op" id="6252564">:</span><span class="ident" id="6252565">c</span><span class="op" id="6252566">.</span><span class="ident" id="6252567">h</span><span class="op" id="6252568">.</span><span class="ident" id="6252569">PaddingLength</span><span class="op" id="6252582">]</span><span class="op" id="6252583">)</span><span class="op" id="6252584">;</span>&nbsp;<span class="ident" id="6252586">err</span>&nbsp;<span class="op" id="6252590">!=</span>&nbsp;<span class="ident" id="6252593">nil</span>&nbsp;<span class="op" id="6252597">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252601">return</span>&nbsp;<span class="ident" id="6252608">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252616">_</span><span class="op" id="6252617">,</span>&nbsp;<span class="ident" id="6252619">err</span>&nbsp;<span class="op" id="6252623">:=</span>&nbsp;<span class="ident" id="6252626">c</span><span class="op" id="6252627">.</span><span class="ident" id="6252628">rwc</span><span class="op" id="6252631">.</span><span class="ident" id="6252632">Write</span><span class="op" id="6252637">(</span><span class="ident" id="6252638">c</span><span class="op" id="6252639">.</span><span class="ident" id="6252640">buf</span><span class="op" id="6252643">.</span><span class="ident" id="6252644">Bytes</span><span class="op" id="6252649">(</span><span class="op" id="6252650">)</span><span class="op" id="6252651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252654">return</span>&nbsp;<span class="ident" id="6252661">err</span><br>
<span class="lineno"></span><span class="op" id="6252665">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="keyword" id="6252668">func</span>&nbsp;<span class="op" id="6252673">(</span><span class="ident" id="6252674">c</span>&nbsp;<span class="op" id="6252676">*</span><span class="ident" id="6252677">conn</span><span class="op" id="6252681">)</span>&nbsp;<span class="ident" id="6252683">writeBeginRequest</span><span class="op" id="6252700">(</span><span class="ident" id="6252701">reqId</span>&nbsp;<span class="builtintype" id="6252707">uint16</span><span class="op" id="6252713">,</span>&nbsp;<span class="ident" id="6252715">role</span>&nbsp;<span class="builtintype" id="6252720">uint16</span><span class="op" id="6252726">,</span>&nbsp;<span class="ident" id="6252728">flags</span>&nbsp;<span class="builtintype" id="6252734">uint8</span><span class="op" id="6252739">)</span>&nbsp;<span class="builtintype" id="6252741">error</span>&nbsp;<span class="op" id="6252747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252750">b</span>&nbsp;<span class="op" id="6252752">:=</span>&nbsp;<span class="op" id="6252755">[</span><span class="num" id="6252756">8</span><span class="op" id="6252757">]</span><span class="builtintype" id="6252758">byte</span><span class="op" id="6252762">{</span><span class="builtintype" id="6252763">byte</span><span class="op" id="6252767">(</span><span class="ident" id="6252768">role</span>&nbsp;<span class="op" id="6252773">&gt;&gt;</span>&nbsp;<span class="num" id="6252776">8</span><span class="op" id="6252777">)</span><span class="op" id="6252778">,</span>&nbsp;<span class="builtintype" id="6252780">byte</span><span class="op" id="6252784">(</span><span class="ident" id="6252785">role</span><span class="op" id="6252789">)</span><span class="op" id="6252790">,</span>&nbsp;<span class="ident" id="6252792">flags</span><span class="op" id="6252797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252800">return</span>&nbsp;<span class="ident" id="6252807">c</span><span class="op" id="6252808">.</span><span class="ident" id="6252809">writeRecord</span><span class="op" id="6252820">(</span><span class="ident" id="6252821">typeBeginRequest</span><span class="op" id="6252837">,</span>&nbsp;<span class="ident" id="6252839">reqId</span><span class="op" id="6252844">,</span>&nbsp;<span class="ident" id="6252846">b</span><span class="op" id="6252847">[</span><span class="op" id="6252848">:</span><span class="op" id="6252849">]</span><span class="op" id="6252850">)</span><br>
<span class="lineno"></span><span class="op" id="6252852">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="6252855">func</span>&nbsp;<span class="op" id="6252860">(</span><span class="ident" id="6252861">c</span>&nbsp;<span class="op" id="6252863">*</span><span class="ident" id="6252864">conn</span><span class="op" id="6252868">)</span>&nbsp;<span class="ident" id="6252870">writeEndRequest</span><span class="op" id="6252885">(</span><span class="ident" id="6252886">reqId</span>&nbsp;<span class="builtintype" id="6252892">uint16</span><span class="op" id="6252898">,</span>&nbsp;<span class="ident" id="6252900">appStatus</span>&nbsp;<span class="builtintype" id="6252910">int</span><span class="op" id="6252913">,</span>&nbsp;<span class="ident" id="6252915">protocolStatus</span>&nbsp;<span class="builtintype" id="6252930">uint8</span><span class="op" id="6252935">)</span>&nbsp;<span class="builtintype" id="6252937">error</span>&nbsp;<span class="op" id="6252943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252946">b</span>&nbsp;<span class="op" id="6252948">:=</span>&nbsp;<span class="builtinfunc" id="6252951">make</span><span class="op" id="6252955">(</span><span class="op" id="6252956">[</span><span class="op" id="6252957">]</span><span class="builtintype" id="6252958">byte</span><span class="op" id="6252962">,</span>&nbsp;<span class="num" id="6252964">8</span><span class="op" id="6252965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252968">binary</span><span class="op" id="6252974">.</span><span class="ident" id="6252975">BigEndian</span><span class="op" id="6252984">.</span><span class="ident" id="6252985">PutUint32</span><span class="op" id="6252994">(</span><span class="ident" id="6252995">b</span><span class="op" id="6252996">,</span>&nbsp;<span class="builtintype" id="6252998">uint32</span><span class="op" id="6253004">(</span><span class="ident" id="6253005">appStatus</span><span class="op" id="6253014">)</span><span class="op" id="6253015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253018">b</span><span class="op" id="6253019">[</span><span class="num" id="6253020">4</span><span class="op" id="6253021">]</span>&nbsp;<span class="op" id="6253023">=</span>&nbsp;<span class="ident" id="6253025">protocolStatus</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253041">return</span>&nbsp;<span class="ident" id="6253048">c</span><span class="op" id="6253049">.</span><span class="ident" id="6253050">writeRecord</span><span class="op" id="6253061">(</span><span class="ident" id="6253062">typeEndRequest</span><span class="op" id="6253076">,</span>&nbsp;<span class="ident" id="6253078">reqId</span><span class="op" id="6253083">,</span>&nbsp;<span class="ident" id="6253085">b</span><span class="op" id="6253086">)</span><br>
<span class="lineno"></span><span class="op" id="6253088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6253091">func</span>&nbsp;<span class="op" id="6253096">(</span><span class="ident" id="6253097">c</span>&nbsp;<span class="op" id="6253099">*</span><span class="ident" id="6253100">conn</span><span class="op" id="6253104">)</span>&nbsp;<span class="ident" id="6253106">writePairs</span><span class="op" id="6253116">(</span><span class="ident" id="6253117">recType</span>&nbsp;<span class="ident" id="6253125">recType</span><span class="op" id="6253132">,</span>&nbsp;<span class="ident" id="6253134">reqId</span>&nbsp;<span class="builtintype" id="6253140">uint16</span><span class="op" id="6253146">,</span>&nbsp;<span class="ident" id="6253148">pairs</span>&nbsp;<span class="keyword" id="6253154">map</span><span class="op" id="6253157">[</span><span class="builtintype" id="6253158">string</span><span class="op" id="6253164">]</span><span class="builtintype" id="6253165">string</span><span class="op" id="6253171">)</span>&nbsp;<span class="builtintype" id="6253173">error</span>&nbsp;<span class="op" id="6253179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253182">w</span>&nbsp;<span class="op" id="6253184">:=</span>&nbsp;<span class="ident" id="6253187">newWriter</span><span class="op" id="6253196">(</span><span class="ident" id="6253197">c</span><span class="op" id="6253198">,</span>&nbsp;<span class="ident" id="6253200">recType</span><span class="op" id="6253207">,</span>&nbsp;<span class="ident" id="6253209">reqId</span><span class="op" id="6253214">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253217">b</span>&nbsp;<span class="op" id="6253219">:=</span>&nbsp;<span class="builtinfunc" id="6253222">make</span><span class="op" id="6253226">(</span><span class="op" id="6253227">[</span><span class="op" id="6253228">]</span><span class="builtintype" id="6253229">byte</span><span class="op" id="6253233">,</span>&nbsp;<span class="num" id="6253235">8</span><span class="op" id="6253236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253239">for</span>&nbsp;<span class="ident" id="6253243">k</span><span class="op" id="6253244">,</span>&nbsp;<span class="ident" id="6253246">v</span>&nbsp;<span class="op" id="6253248">:=</span>&nbsp;<span class="keyword" id="6253251">range</span>&nbsp;<span class="ident" id="6253257">pairs</span>&nbsp;<span class="op" id="6253263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253267">n</span>&nbsp;<span class="op" id="6253269">:=</span>&nbsp;<span class="ident" id="6253272">encodeSize</span><span class="op" id="6253282">(</span><span class="ident" id="6253283">b</span><span class="op" id="6253284">,</span>&nbsp;<span class="builtintype" id="6253286">uint32</span><span class="op" id="6253292">(</span><span class="builtinfunc" id="6253293">len</span><span class="op" id="6253296">(</span><span class="ident" id="6253297">k</span><span class="op" id="6253298">)</span><span class="op" id="6253299">)</span><span class="op" id="6253300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253304">n</span>&nbsp;<span class="op" id="6253306">+=</span>&nbsp;<span class="ident" id="6253309">encodeSize</span><span class="op" id="6253319">(</span><span class="ident" id="6253320">b</span><span class="op" id="6253321">[</span><span class="ident" id="6253322">n</span><span class="op" id="6253323">:</span><span class="op" id="6253324">]</span><span class="op" id="6253325">,</span>&nbsp;<span class="builtintype" id="6253327">uint32</span><span class="op" id="6253333">(</span><span class="builtinfunc" id="6253334">len</span><span class="op" id="6253337">(</span><span class="ident" id="6253338">v</span><span class="op" id="6253339">)</span><span class="op" id="6253340">)</span><span class="op" id="6253341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253345">if</span>&nbsp;<span class="ident" id="6253348">_</span><span class="op" id="6253349">,</span>&nbsp;<span class="ident" id="6253351">err</span>&nbsp;<span class="op" id="6253355">:=</span>&nbsp;<span class="ident" id="6253358">w</span><span class="op" id="6253359">.</span><span class="ident" id="6253360">Write</span><span class="op" id="6253365">(</span><span class="ident" id="6253366">b</span><span class="op" id="6253367">[</span><span class="op" id="6253368">:</span><span class="ident" id="6253369">n</span><span class="op" id="6253370">]</span><span class="op" id="6253371">)</span><span class="op" id="6253372">;</span>&nbsp;<span class="ident" id="6253374">err</span>&nbsp;<span class="op" id="6253378">!=</span>&nbsp;<span class="ident" id="6253381">nil</span>&nbsp;<span class="op" id="6253385">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253390">return</span>&nbsp;<span class="ident" id="6253397">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253407">if</span>&nbsp;<span class="ident" id="6253410">_</span><span class="op" id="6253411">,</span>&nbsp;<span class="ident" id="6253413">err</span>&nbsp;<span class="op" id="6253417">:=</span>&nbsp;<span class="ident" id="6253420">w</span><span class="op" id="6253421">.</span><span class="ident" id="6253422">WriteString</span><span class="op" id="6253433">(</span><span class="ident" id="6253434">k</span><span class="op" id="6253435">)</span><span class="op" id="6253436">;</span>&nbsp;<span class="ident" id="6253438">err</span>&nbsp;<span class="op" id="6253442">!=</span>&nbsp;<span class="ident" id="6253445">nil</span>&nbsp;<span class="op" id="6253449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253454">return</span>&nbsp;<span class="ident" id="6253461">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253467">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253471">if</span>&nbsp;<span class="ident" id="6253474">_</span><span class="op" id="6253475">,</span>&nbsp;<span class="ident" id="6253477">err</span>&nbsp;<span class="op" id="6253481">:=</span>&nbsp;<span class="ident" id="6253484">w</span><span class="op" id="6253485">.</span><span class="ident" id="6253486">WriteString</span><span class="op" id="6253497">(</span><span class="ident" id="6253498">v</span><span class="op" id="6253499">)</span><span class="op" id="6253500">;</span>&nbsp;<span class="ident" id="6253502">err</span>&nbsp;<span class="op" id="6253506">!=</span>&nbsp;<span class="ident" id="6253509">nil</span>&nbsp;<span class="op" id="6253513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253518">return</span>&nbsp;<span class="ident" id="6253525">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253537">w</span><span class="op" id="6253538">.</span><span class="ident" id="6253539">Close</span><span class="op" id="6253544">(</span><span class="op" id="6253545">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253548">return</span>&nbsp;<span class="ident" id="6253555">nil</span><br>
<span class="lineno"></span><span class="op" id="6253559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6253562">func</span>&nbsp;<span class="ident" id="6253567">readSize</span><span class="op" id="6253575">(</span><span class="ident" id="6253576">s</span>&nbsp;<span class="op" id="6253578">[</span><span class="op" id="6253579">]</span><span class="builtintype" id="6253580">byte</span><span class="op" id="6253584">)</span>&nbsp;<span class="op" id="6253586">(</span><span class="builtintype" id="6253587">uint32</span><span class="op" id="6253593">,</span>&nbsp;<span class="builtintype" id="6253595">int</span><span class="op" id="6253598">)</span>&nbsp;<span class="op" id="6253600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253603">if</span>&nbsp;<span class="builtinfunc" id="6253606">len</span><span class="op" id="6253609">(</span><span class="ident" id="6253610">s</span><span class="op" id="6253611">)</span>&nbsp;<span class="op" id="6253613">==</span>&nbsp;<span class="num" id="6253616">0</span>&nbsp;<span class="op" id="6253618">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253622">return</span>&nbsp;<span class="num" id="6253629">0</span><span class="op" id="6253630">,</span>&nbsp;<span class="num" id="6253632">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253638">size</span><span class="op" id="6253642">,</span>&nbsp;<span class="ident" id="6253644">n</span>&nbsp;<span class="op" id="6253646">:=</span>&nbsp;<span class="builtintype" id="6253649">uint32</span><span class="op" id="6253655">(</span><span class="ident" id="6253656">s</span><span class="op" id="6253657">[</span><span class="num" id="6253658">0</span><span class="op" id="6253659">]</span><span class="op" id="6253660">)</span><span class="op" id="6253661">,</span>&nbsp;<span class="num" id="6253663">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253666">if</span>&nbsp;<span class="ident" id="6253669">size</span><span class="op" id="6253673">&amp;</span><span class="op" id="6253674">(</span><span class="num" id="6253675">1</span><span class="op" id="6253676">&lt;&lt;</span><span class="num" id="6253678">7</span><span class="op" id="6253679">)</span>&nbsp;<span class="op" id="6253681">!=</span>&nbsp;<span class="num" id="6253684">0</span>&nbsp;<span class="op" id="6253686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253690">if</span>&nbsp;<span class="builtinfunc" id="6253693">len</span><span class="op" id="6253696">(</span><span class="ident" id="6253697">s</span><span class="op" id="6253698">)</span>&nbsp;<span class="op" id="6253700">&lt;</span>&nbsp;<span class="num" id="6253702">4</span>&nbsp;<span class="op" id="6253704">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253709">return</span>&nbsp;<span class="num" id="6253716">0</span><span class="op" id="6253717">,</span>&nbsp;<span class="num" id="6253719">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253727">n</span>&nbsp;<span class="op" id="6253729">=</span>&nbsp;<span class="num" id="6253731">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253735">size</span>&nbsp;<span class="op" id="6253740">=</span>&nbsp;<span class="ident" id="6253742">binary</span><span class="op" id="6253748">.</span><span class="ident" id="6253749">BigEndian</span><span class="op" id="6253758">.</span><span class="ident" id="6253759">Uint32</span><span class="op" id="6253765">(</span><span class="ident" id="6253766">s</span><span class="op" id="6253767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253771">size</span>&nbsp;<span class="op" id="6253776">&amp;^=</span>&nbsp;<span class="num" id="6253780">1</span>&nbsp;<span class="op" id="6253782">&lt;&lt;</span>&nbsp;<span class="num" id="6253785">31</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253792">return</span>&nbsp;<span class="ident" id="6253799">size</span><span class="op" id="6253803">,</span>&nbsp;<span class="ident" id="6253805">n</span><br>
<span class="lineno"></span><span class="op" id="6253807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6253810">func</span>&nbsp;<span class="ident" id="6253815">readString</span><span class="op" id="6253825">(</span><span class="ident" id="6253826">s</span>&nbsp;<span class="op" id="6253828">[</span><span class="op" id="6253829">]</span><span class="builtintype" id="6253830">byte</span><span class="op" id="6253834">,</span>&nbsp;<span class="ident" id="6253836">size</span>&nbsp;<span class="builtintype" id="6253841">uint32</span><span class="op" id="6253847">)</span>&nbsp;<span class="builtintype" id="6253849">string</span>&nbsp;<span class="op" id="6253856">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253859">if</span>&nbsp;<span class="ident" id="6253862">size</span>&nbsp;<span class="op" id="6253867">&gt;</span>&nbsp;<span class="builtintype" id="6253869">uint32</span><span class="op" id="6253875">(</span><span class="builtinfunc" id="6253876">len</span><span class="op" id="6253879">(</span><span class="ident" id="6253880">s</span><span class="op" id="6253881">)</span><span class="op" id="6253882">)</span>&nbsp;<span class="op" id="6253884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253888">return</span>&nbsp;<span class="string" id="6253895">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253902">return</span>&nbsp;<span class="builtintype" id="6253909">string</span><span class="op" id="6253915">(</span><span class="ident" id="6253916">s</span><span class="op" id="6253917">[</span><span class="op" id="6253918">:</span><span class="ident" id="6253919">size</span><span class="op" id="6253923">]</span><span class="op" id="6253924">)</span><br>
<span class="lineno"></span><span class="op" id="6253926">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6253929">func</span>&nbsp;<span class="ident" id="6253934">encodeSize</span><span class="op" id="6253944">(</span><span class="ident" id="6253945">b</span>&nbsp;<span class="op" id="6253947">[</span><span class="op" id="6253948">]</span><span class="builtintype" id="6253949">byte</span><span class="op" id="6253953">,</span>&nbsp;<span class="ident" id="6253955">size</span>&nbsp;<span class="builtintype" id="6253960">uint32</span><span class="op" id="6253966">)</span>&nbsp;<span class="builtintype" id="6253968">int</span>&nbsp;<span class="op" id="6253972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253975">if</span>&nbsp;<span class="ident" id="6253978">size</span>&nbsp;<span class="op" id="6253983">&gt;</span>&nbsp;<span class="num" id="6253985">127</span>&nbsp;<span class="op" id="6253989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253993">size</span>&nbsp;<span class="op" id="6253998">|=</span>&nbsp;<span class="num" id="6254001">1</span>&nbsp;<span class="op" id="6254003">&lt;&lt;</span>&nbsp;<span class="num" id="6254006">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254011">binary</span><span class="op" id="6254017">.</span><span class="ident" id="6254018">BigEndian</span><span class="op" id="6254027">.</span><span class="ident" id="6254028">PutUint32</span><span class="op" id="6254037">(</span><span class="ident" id="6254038">b</span><span class="op" id="6254039">,</span>&nbsp;<span class="ident" id="6254041">size</span><span class="op" id="6254045">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254049">return</span>&nbsp;<span class="num" id="6254056">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6254059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254062">b</span><span class="op" id="6254063">[</span><span class="num" id="6254064">0</span><span class="op" id="6254065">]</span>&nbsp;<span class="op" id="6254067">=</span>&nbsp;<span class="builtintype" id="6254069">byte</span><span class="op" id="6254073">(</span><span class="ident" id="6254074">size</span><span class="op" id="6254078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254081">return</span>&nbsp;<span class="num" id="6254088">1</span><br>
<span class="lineno"></span><span class="op" id="6254090">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="6254093">//&nbsp;bufWriter&nbsp;encapsulates&nbsp;bufio.Writer&nbsp;but&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;stream&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6254175">//&nbsp;Closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6254186">type</span>&nbsp;<span class="ident" id="6254191">bufWriter</span>&nbsp;<span class="keyword" id="6254201">struct</span>&nbsp;<span class="op" id="6254208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254211">closer</span>&nbsp;<span class="ident" id="6254218">io</span><span class="op" id="6254220">.</span><span class="ident" id="6254221">Closer</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6254229">*</span><span class="ident" id="6254230">bufio</span><span class="op" id="6254235">.</span><span class="ident" id="6254236">Writer</span><br>
<span class="lineno"></span><span class="op" id="6254243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6254246">func</span>&nbsp;<span class="op" id="6254251">(</span><span class="ident" id="6254252">w</span>&nbsp;<span class="op" id="6254254">*</span><span class="ident" id="6254255">bufWriter</span><span class="op" id="6254264">)</span>&nbsp;<span class="ident" id="6254266">Close</span><span class="op" id="6254271">(</span><span class="op" id="6254272">)</span>&nbsp;<span class="builtintype" id="6254274">error</span>&nbsp;<span class="op" id="6254280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254283">if</span>&nbsp;<span class="ident" id="6254286">err</span>&nbsp;<span class="op" id="6254290">:=</span>&nbsp;<span class="ident" id="6254293">w</span><span class="op" id="6254294">.</span><span class="ident" id="6254295">Writer</span><span class="op" id="6254301">.</span><span class="ident" id="6254302">Flush</span><span class="op" id="6254307">(</span><span class="op" id="6254308">)</span><span class="op" id="6254309">;</span>&nbsp;<span class="ident" id="6254311">err</span>&nbsp;<span class="op" id="6254315">!=</span>&nbsp;<span class="ident" id="6254318">nil</span>&nbsp;<span class="op" id="6254322">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254326">w</span><span class="op" id="6254327">.</span><span class="ident" id="6254328">closer</span><span class="op" id="6254334">.</span><span class="ident" id="6254335">Close</span><span class="op" id="6254340">(</span><span class="op" id="6254341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254345">return</span>&nbsp;<span class="ident" id="6254352">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6254357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254360">return</span>&nbsp;<span class="ident" id="6254367">w</span><span class="op" id="6254368">.</span><span class="ident" id="6254369">closer</span><span class="op" id="6254375">.</span><span class="ident" id="6254376">Close</span><span class="op" id="6254381">(</span><span class="op" id="6254382">)</span><br>
<span class="lineno"></span><span class="op" id="6254384">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword" id="6254387">func</span>&nbsp;<span class="ident" id="6254392">newWriter</span><span class="op" id="6254401">(</span><span class="ident" id="6254402">c</span>&nbsp;<span class="op" id="6254404">*</span><span class="ident" id="6254405">conn</span><span class="op" id="6254409">,</span>&nbsp;<span class="ident" id="6254411">recType</span>&nbsp;<span class="ident" id="6254419">recType</span><span class="op" id="6254426">,</span>&nbsp;<span class="ident" id="6254428">reqId</span>&nbsp;<span class="builtintype" id="6254434">uint16</span><span class="op" id="6254440">)</span>&nbsp;<span class="op" id="6254442">*</span><span class="ident" id="6254443">bufWriter</span>&nbsp;<span class="op" id="6254453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254456">s</span>&nbsp;<span class="op" id="6254458">:=</span>&nbsp;<span class="op" id="6254461">&amp;</span><span class="ident" id="6254462">streamWriter</span><span class="op" id="6254474">{</span><span class="ident" id="6254475">c</span><span class="op" id="6254476">:</span>&nbsp;<span class="ident" id="6254478">c</span><span class="op" id="6254479">,</span>&nbsp;<span class="ident" id="6254481">recType</span><span class="op" id="6254488">:</span>&nbsp;<span class="ident" id="6254490">recType</span><span class="op" id="6254497">,</span>&nbsp;<span class="ident" id="6254499">reqId</span><span class="op" id="6254504">:</span>&nbsp;<span class="ident" id="6254506">reqId</span><span class="op" id="6254511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254514">w</span>&nbsp;<span class="op" id="6254516">:=</span>&nbsp;<span class="ident" id="6254519">bufio</span><span class="op" id="6254524">.</span><span class="ident" id="6254525">NewWriterSize</span><span class="op" id="6254538">(</span><span class="ident" id="6254539">s</span><span class="op" id="6254540">,</span>&nbsp;<span class="ident" id="6254542">maxWrite</span><span class="op" id="6254550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254553">return</span>&nbsp;<span class="op" id="6254560">&amp;</span><span class="ident" id="6254561">bufWriter</span><span class="op" id="6254570">{</span><span class="ident" id="6254571">s</span><span class="op" id="6254572">,</span>&nbsp;<span class="ident" id="6254574">w</span><span class="op" id="6254575">}</span><br>
<span class="lineno">245</span><span class="op" id="6254577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6254580">//&nbsp;streamWriter&nbsp;abstracts&nbsp;out&nbsp;the&nbsp;separation&nbsp;of&nbsp;a&nbsp;stream&nbsp;into&nbsp;discrete&nbsp;records.</span><br>
<span class="lineno"></span><span class="comment" id="6254660">//&nbsp;It&nbsp;only&nbsp;writes&nbsp;maxWrite&nbsp;bytes&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="6254704">type</span>&nbsp;<span class="ident" id="6254709">streamWriter</span>&nbsp;<span class="keyword" id="6254722">struct</span>&nbsp;<span class="op" id="6254729">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254732">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6254740">*</span><span class="ident" id="6254741">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254747">recType</span>&nbsp;<span class="ident" id="6254755">recType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254764">reqId</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6254772">uint16</span><br>
<span class="lineno"></span><span class="op" id="6254779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6254782">func</span>&nbsp;<span class="op" id="6254787">(</span><span class="ident" id="6254788">w</span>&nbsp;<span class="op" id="6254790">*</span><span class="ident" id="6254791">streamWriter</span><span class="op" id="6254803">)</span>&nbsp;<span class="ident" id="6254805">Write</span><span class="op" id="6254810">(</span><span class="ident" id="6254811">p</span>&nbsp;<span class="op" id="6254813">[</span><span class="op" id="6254814">]</span><span class="builtintype" id="6254815">byte</span><span class="op" id="6254819">)</span>&nbsp;<span class="op" id="6254821">(</span><span class="builtintype" id="6254822">int</span><span class="op" id="6254825">,</span>&nbsp;<span class="builtintype" id="6254827">error</span><span class="op" id="6254832">)</span>&nbsp;<span class="op" id="6254834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254837">nn</span>&nbsp;<span class="op" id="6254840">:=</span>&nbsp;<span class="num" id="6254843">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254846">for</span>&nbsp;<span class="builtinfunc" id="6254850">len</span><span class="op" id="6254853">(</span><span class="ident" id="6254854">p</span><span class="op" id="6254855">)</span>&nbsp;<span class="op" id="6254857">&gt;</span>&nbsp;<span class="num" id="6254859">0</span>&nbsp;<span class="op" id="6254861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254865">n</span>&nbsp;<span class="op" id="6254867">:=</span>&nbsp;<span class="builtinfunc" id="6254870">len</span><span class="op" id="6254873">(</span><span class="ident" id="6254874">p</span><span class="op" id="6254875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254879">if</span>&nbsp;<span class="ident" id="6254882">n</span>&nbsp;<span class="op" id="6254884">&gt;</span>&nbsp;<span class="ident" id="6254886">maxWrite</span>&nbsp;<span class="op" id="6254895">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254900">n</span>&nbsp;<span class="op" id="6254902">=</span>&nbsp;<span class="ident" id="6254904">maxWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6254915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254919">if</span>&nbsp;<span class="ident" id="6254922">err</span>&nbsp;<span class="op" id="6254926">:=</span>&nbsp;<span class="ident" id="6254929">w</span><span class="op" id="6254930">.</span><span class="ident" id="6254931">c</span><span class="op" id="6254932">.</span><span class="ident" id="6254933">writeRecord</span><span class="op" id="6254944">(</span><span class="ident" id="6254945">w</span><span class="op" id="6254946">.</span><span class="ident" id="6254947">recType</span><span class="op" id="6254954">,</span>&nbsp;<span class="ident" id="6254956">w</span><span class="op" id="6254957">.</span><span class="ident" id="6254958">reqId</span><span class="op" id="6254963">,</span>&nbsp;<span class="ident" id="6254965">p</span><span class="op" id="6254966">[</span><span class="op" id="6254967">:</span><span class="ident" id="6254968">n</span><span class="op" id="6254969">]</span><span class="op" id="6254970">)</span><span class="op" id="6254971">;</span>&nbsp;<span class="ident" id="6254973">err</span>&nbsp;<span class="op" id="6254977">!=</span>&nbsp;<span class="ident" id="6254980">nil</span>&nbsp;<span class="op" id="6254984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254989">return</span>&nbsp;<span class="ident" id="6254996">nn</span><span class="op" id="6254998">,</span>&nbsp;<span class="ident" id="6255000">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6255006">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255010">nn</span>&nbsp;<span class="op" id="6255013">+=</span>&nbsp;<span class="ident" id="6255016">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255020">p</span>&nbsp;<span class="op" id="6255022">=</span>&nbsp;<span class="ident" id="6255024">p</span><span class="op" id="6255025">[</span><span class="ident" id="6255026">n</span><span class="op" id="6255027">:</span><span class="op" id="6255028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6255031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6255034">return</span>&nbsp;<span class="ident" id="6255041">nn</span><span class="op" id="6255043">,</span>&nbsp;<span class="ident" id="6255045">nil</span><br>
<span class="lineno"></span><span class="op" id="6255049">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6255052">func</span>&nbsp;<span class="op" id="6255057">(</span><span class="ident" id="6255058">w</span>&nbsp;<span class="op" id="6255060">*</span><span class="ident" id="6255061">streamWriter</span><span class="op" id="6255073">)</span>&nbsp;<span class="ident" id="6255075">Close</span><span class="op" id="6255080">(</span><span class="op" id="6255081">)</span>&nbsp;<span class="builtintype" id="6255083">error</span>&nbsp;<span class="op" id="6255089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6255092">//&nbsp;send&nbsp;empty&nbsp;record&nbsp;to&nbsp;close&nbsp;the&nbsp;stream</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6255134">return</span>&nbsp;<span class="ident" id="6255141">w</span><span class="op" id="6255142">.</span><span class="ident" id="6255143">c</span><span class="op" id="6255144">.</span><span class="ident" id="6255145">writeRecord</span><span class="op" id="6255156">(</span><span class="ident" id="6255157">w</span><span class="op" id="6255158">.</span><span class="ident" id="6255159">recType</span><span class="op" id="6255166">,</span>&nbsp;<span class="ident" id="6255168">w</span><span class="op" id="6255169">.</span><span class="ident" id="6255170">reqId</span><span class="op" id="6255175">,</span>&nbsp;<span class="ident" id="6255177">nil</span><span class="op" id="6255180">)</span><br>
<span class="lineno"></span><span class="op" id="6255182">}</span>
</div>
</body>
</html>
