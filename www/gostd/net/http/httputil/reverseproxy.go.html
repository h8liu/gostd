<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6142403">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6142458">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6142512">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6142563">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6142594">package</span>&nbsp;<span class="ident" id="6142602">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6142612">import</span>&nbsp;<span class="op" id="6142619">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142622">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142628">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142635">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142642">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142654">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142665">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142676">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6142684">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6142691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6142694">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6142767">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6142793">var</span>&nbsp;<span class="ident" id="6142797">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6142813">func</span><span class="op" id="6142817">(</span><span class="op" id="6142818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6142821">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6142891">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6142956">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6142967">type</span>&nbsp;<span class="ident" id="6142972">ReverseProxy</span>&nbsp;<span class="keyword" id="6142985">struct</span>&nbsp;<span class="op" id="6142992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6142995">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143042">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143088">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143137">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6143181">Director</span>&nbsp;<span class="keyword" id="6143190">func</span><span class="op" id="6143194">(</span><span class="op" id="6143195">*</span><span class="ident" id="6143196">http</span><span class="op" id="6143200">.</span><span class="ident" id="6143201">Request</span><span class="op" id="6143208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143212">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143262">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6143305">Transport</span>&nbsp;<span class="ident" id="6143315">http</span><span class="op" id="6143319">.</span><span class="ident" id="6143320">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143335">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143382">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143427">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143446">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6143489">FlushInterval</span>&nbsp;<span class="ident" id="6143503">time</span><span class="op" id="6143507">.</span><span class="ident" id="6143508">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143519">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143572">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143625">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6143685">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6143706">ErrorLog</span>&nbsp;<span class="op" id="6143715">*</span><span class="ident" id="6143716">log</span><span class="op" id="6143719">.</span><span class="ident" id="6143720">Logger</span><br>
<span class="lineno"></span><span class="op" id="6143727">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6143730">func</span>&nbsp;<span class="ident" id="6143735">singleJoiningSlash</span><span class="op" id="6143753">(</span><span class="ident" id="6143754">a</span><span class="op" id="6143755">,</span>&nbsp;<span class="ident" id="6143757">b</span>&nbsp;<span class="builtintype" id="6143759">string</span><span class="op" id="6143765">)</span>&nbsp;<span class="builtintype" id="6143767">string</span>&nbsp;<span class="op" id="6143774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6143777">aslash</span>&nbsp;<span class="op" id="6143784">:=</span>&nbsp;<span class="ident" id="6143787">strings</span><span class="op" id="6143794">.</span><span class="ident" id="6143795">HasSuffix</span><span class="op" id="6143804">(</span><span class="ident" id="6143805">a</span><span class="op" id="6143806">,</span>&nbsp;<span class="string" id="6143808">&#34;/&#34;</span><span class="op" id="6143811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6143814">bslash</span>&nbsp;<span class="op" id="6143821">:=</span>&nbsp;<span class="ident" id="6143824">strings</span><span class="op" id="6143831">.</span><span class="ident" id="6143832">HasPrefix</span><span class="op" id="6143841">(</span><span class="ident" id="6143842">b</span><span class="op" id="6143843">,</span>&nbsp;<span class="string" id="6143845">&#34;/&#34;</span><span class="op" id="6143848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6143851">switch</span>&nbsp;<span class="op" id="6143858">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6143861">case</span>&nbsp;<span class="ident" id="6143866">aslash</span>&nbsp;<span class="op" id="6143873">&amp;&amp;</span>&nbsp;<span class="ident" id="6143876">bslash</span><span class="op" id="6143882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6143886">return</span>&nbsp;<span class="ident" id="6143893">a</span>&nbsp;<span class="op" id="6143895">+</span>&nbsp;<span class="ident" id="6143897">b</span><span class="op" id="6143898">[</span><span class="num" id="6143899">1</span><span class="op" id="6143900">:</span><span class="op" id="6143901">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6143904">case</span>&nbsp;<span class="op" id="6143909">!</span><span class="ident" id="6143910">aslash</span>&nbsp;<span class="op" id="6143917">&amp;&amp;</span>&nbsp;<span class="op" id="6143920">!</span><span class="ident" id="6143921">bslash</span><span class="op" id="6143927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6143931">return</span>&nbsp;<span class="ident" id="6143938">a</span>&nbsp;<span class="op" id="6143940">+</span>&nbsp;<span class="string" id="6143942">&#34;/&#34;</span>&nbsp;<span class="op" id="6143946">+</span>&nbsp;<span class="ident" id="6143948">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6143951">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6143954">return</span>&nbsp;<span class="ident" id="6143961">a</span>&nbsp;<span class="op" id="6143963">+</span>&nbsp;<span class="ident" id="6143965">b</span><br>
<span class="lineno"></span><span class="op" id="6143967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6143970">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6144040">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6144110">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6144179">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6144224">func</span>&nbsp;<span class="ident" id="6144229">NewSingleHostReverseProxy</span><span class="op" id="6144254">(</span><span class="ident" id="6144255">target</span>&nbsp;<span class="op" id="6144262">*</span><span class="ident" id="6144263">url</span><span class="op" id="6144266">.</span><span class="ident" id="6144267">URL</span><span class="op" id="6144270">)</span>&nbsp;<span class="op" id="6144272">*</span><span class="ident" id="6144273">ReverseProxy</span>&nbsp;<span class="op" id="6144286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144289">targetQuery</span>&nbsp;<span class="op" id="6144301">:=</span>&nbsp;<span class="ident" id="6144304">target</span><span class="op" id="6144310">.</span><span class="ident" id="6144311">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144321">director</span>&nbsp;<span class="op" id="6144330">:=</span>&nbsp;<span class="keyword" id="6144333">func</span><span class="op" id="6144337">(</span><span class="ident" id="6144338">req</span>&nbsp;<span class="op" id="6144342">*</span><span class="ident" id="6144343">http</span><span class="op" id="6144347">.</span><span class="ident" id="6144348">Request</span><span class="op" id="6144355">)</span>&nbsp;<span class="op" id="6144357">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144361">req</span><span class="op" id="6144364">.</span><span class="ident" id="6144365">URL</span><span class="op" id="6144368">.</span><span class="ident" id="6144369">Scheme</span>&nbsp;<span class="op" id="6144376">=</span>&nbsp;<span class="ident" id="6144378">target</span><span class="op" id="6144384">.</span><span class="ident" id="6144385">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144394">req</span><span class="op" id="6144397">.</span><span class="ident" id="6144398">URL</span><span class="op" id="6144401">.</span><span class="ident" id="6144402">Host</span>&nbsp;<span class="op" id="6144407">=</span>&nbsp;<span class="ident" id="6144409">target</span><span class="op" id="6144415">.</span><span class="ident" id="6144416">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144423">req</span><span class="op" id="6144426">.</span><span class="ident" id="6144427">URL</span><span class="op" id="6144430">.</span><span class="ident" id="6144431">Path</span>&nbsp;<span class="op" id="6144436">=</span>&nbsp;<span class="ident" id="6144438">singleJoiningSlash</span><span class="op" id="6144456">(</span><span class="ident" id="6144457">target</span><span class="op" id="6144463">.</span><span class="ident" id="6144464">Path</span><span class="op" id="6144468">,</span>&nbsp;<span class="ident" id="6144470">req</span><span class="op" id="6144473">.</span><span class="ident" id="6144474">URL</span><span class="op" id="6144477">.</span><span class="ident" id="6144478">Path</span><span class="op" id="6144482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144486">if</span>&nbsp;<span class="ident" id="6144489">targetQuery</span>&nbsp;<span class="op" id="6144501">==</span>&nbsp;<span class="string" id="6144504">&#34;&#34;</span>&nbsp;<span class="op" id="6144507">||</span>&nbsp;<span class="ident" id="6144510">req</span><span class="op" id="6144513">.</span><span class="ident" id="6144514">URL</span><span class="op" id="6144517">.</span><span class="ident" id="6144518">RawQuery</span>&nbsp;<span class="op" id="6144527">==</span>&nbsp;<span class="string" id="6144530">&#34;&#34;</span>&nbsp;<span class="op" id="6144533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144538">req</span><span class="op" id="6144541">.</span><span class="ident" id="6144542">URL</span><span class="op" id="6144545">.</span><span class="ident" id="6144546">RawQuery</span>&nbsp;<span class="op" id="6144555">=</span>&nbsp;<span class="ident" id="6144557">targetQuery</span>&nbsp;<span class="op" id="6144569">+</span>&nbsp;<span class="ident" id="6144571">req</span><span class="op" id="6144574">.</span><span class="ident" id="6144575">URL</span><span class="op" id="6144578">.</span><span class="ident" id="6144579">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144590">}</span>&nbsp;<span class="keyword" id="6144592">else</span>&nbsp;<span class="op" id="6144597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144602">req</span><span class="op" id="6144605">.</span><span class="ident" id="6144606">URL</span><span class="op" id="6144609">.</span><span class="ident" id="6144610">RawQuery</span>&nbsp;<span class="op" id="6144619">=</span>&nbsp;<span class="ident" id="6144621">targetQuery</span>&nbsp;<span class="op" id="6144633">+</span>&nbsp;<span class="string" id="6144635">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6144639">+</span>&nbsp;<span class="ident" id="6144641">req</span><span class="op" id="6144644">.</span><span class="ident" id="6144645">URL</span><span class="op" id="6144648">.</span><span class="ident" id="6144649">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144666">return</span>&nbsp;<span class="op" id="6144673">&amp;</span><span class="ident" id="6144674">ReverseProxy</span><span class="op" id="6144686">{</span><span class="ident" id="6144687">Director</span><span class="op" id="6144695">:</span>&nbsp;<span class="ident" id="6144697">director</span><span class="op" id="6144705">}</span><br>
<span class="lineno">80</span><span class="op" id="6144707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6144710">func</span>&nbsp;<span class="ident" id="6144715">copyHeader</span><span class="op" id="6144725">(</span><span class="ident" id="6144726">dst</span><span class="op" id="6144729">,</span>&nbsp;<span class="ident" id="6144731">src</span>&nbsp;<span class="ident" id="6144735">http</span><span class="op" id="6144739">.</span><span class="ident" id="6144740">Header</span><span class="op" id="6144746">)</span>&nbsp;<span class="op" id="6144748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144751">for</span>&nbsp;<span class="ident" id="6144755">k</span><span class="op" id="6144756">,</span>&nbsp;<span class="ident" id="6144758">vv</span>&nbsp;<span class="op" id="6144761">:=</span>&nbsp;<span class="keyword" id="6144764">range</span>&nbsp;<span class="ident" id="6144770">src</span>&nbsp;<span class="op" id="6144774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6144778">for</span>&nbsp;<span class="ident" id="6144782">_</span><span class="op" id="6144783">,</span>&nbsp;<span class="ident" id="6144785">v</span>&nbsp;<span class="op" id="6144787">:=</span>&nbsp;<span class="keyword" id="6144790">range</span>&nbsp;<span class="ident" id="6144796">vv</span>&nbsp;<span class="op" id="6144799">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6144804">dst</span><span class="op" id="6144807">.</span><span class="ident" id="6144808">Add</span><span class="op" id="6144811">(</span><span class="ident" id="6144812">k</span><span class="op" id="6144813">,</span>&nbsp;<span class="ident" id="6144815">v</span><span class="op" id="6144816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6144823">}</span><br>
<span class="lineno"></span><span class="op" id="6144825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6144828">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6144895">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6144953">var</span>&nbsp;<span class="ident" id="6144957">hopHeaders</span>&nbsp;<span class="op" id="6144968">=</span>&nbsp;<span class="op" id="6144970">[</span><span class="op" id="6144971">]</span><span class="builtintype" id="6144972">string</span><span class="op" id="6144978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6144981">&#34;Connection&#34;</span><span class="op" id="6144993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6144996">&#34;Keep-Alive&#34;</span><span class="op" id="6145008">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6145011">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6145031">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6145034">&#34;Proxy-Authorization&#34;</span><span class="op" id="6145055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6145058">&#34;Te&#34;</span><span class="op" id="6145062">,</span>&nbsp;<span class="comment" id="6145064">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6145098">&#34;Trailers&#34;</span><span class="op" id="6145108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6145111">&#34;Transfer-Encoding&#34;</span><span class="op" id="6145130">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6145133">&#34;Upgrade&#34;</span><span class="op" id="6145142">,</span><br>
<span class="lineno"></span><span class="op" id="6145144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6145147">func</span>&nbsp;<span class="op" id="6145152">(</span><span class="ident" id="6145153">p</span>&nbsp;<span class="op" id="6145155">*</span><span class="ident" id="6145156">ReverseProxy</span><span class="op" id="6145168">)</span>&nbsp;<span class="ident" id="6145170">ServeHTTP</span><span class="op" id="6145179">(</span><span class="ident" id="6145180">rw</span>&nbsp;<span class="ident" id="6145183">http</span><span class="op" id="6145187">.</span><span class="ident" id="6145188">ResponseWriter</span><span class="op" id="6145202">,</span>&nbsp;<span class="ident" id="6145204">req</span>&nbsp;<span class="op" id="6145208">*</span><span class="ident" id="6145209">http</span><span class="op" id="6145213">.</span><span class="ident" id="6145214">Request</span><span class="op" id="6145221">)</span>&nbsp;<span class="op" id="6145223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145226">transport</span>&nbsp;<span class="op" id="6145236">:=</span>&nbsp;<span class="ident" id="6145239">p</span><span class="op" id="6145240">.</span><span class="ident" id="6145241">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145252">if</span>&nbsp;<span class="ident" id="6145255">transport</span>&nbsp;<span class="op" id="6145265">==</span>&nbsp;<span class="ident" id="6145268">nil</span>&nbsp;<span class="op" id="6145272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145276">transport</span>&nbsp;<span class="op" id="6145286">=</span>&nbsp;<span class="ident" id="6145288">http</span><span class="op" id="6145292">.</span><span class="ident" id="6145293">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145315">outreq</span>&nbsp;<span class="op" id="6145322">:=</span>&nbsp;<span class="builtinfunc" id="6145325">new</span><span class="op" id="6145328">(</span><span class="ident" id="6145329">http</span><span class="op" id="6145333">.</span><span class="ident" id="6145334">Request</span><span class="op" id="6145341">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6145344">*</span><span class="ident" id="6145345">outreq</span>&nbsp;<span class="op" id="6145352">=</span>&nbsp;<span class="op" id="6145354">*</span><span class="ident" id="6145355">req</span>&nbsp;<span class="comment" id="6145359">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145406">p</span><span class="op" id="6145407">.</span><span class="ident" id="6145408">Director</span><span class="op" id="6145416">(</span><span class="ident" id="6145417">outreq</span><span class="op" id="6145423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145426">outreq</span><span class="op" id="6145432">.</span><span class="ident" id="6145433">Proto</span>&nbsp;<span class="op" id="6145439">=</span>&nbsp;<span class="string" id="6145441">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145453">outreq</span><span class="op" id="6145459">.</span><span class="ident" id="6145460">ProtoMajor</span>&nbsp;<span class="op" id="6145471">=</span>&nbsp;<span class="num" id="6145473">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145476">outreq</span><span class="op" id="6145482">.</span><span class="ident" id="6145483">ProtoMinor</span>&nbsp;<span class="op" id="6145494">=</span>&nbsp;<span class="num" id="6145496">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145499">outreq</span><span class="op" id="6145505">.</span><span class="ident" id="6145506">Close</span>&nbsp;<span class="op" id="6145512">=</span>&nbsp;<span class="builtintype" id="6145514">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145522">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145580">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145639">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145703">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6145762">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145813">copiedHeaders</span>&nbsp;<span class="op" id="6145827">:=</span>&nbsp;<span class="builtintype" id="6145830">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145837">for</span>&nbsp;<span class="ident" id="6145841">_</span><span class="op" id="6145842">,</span>&nbsp;<span class="ident" id="6145844">h</span>&nbsp;<span class="op" id="6145846">:=</span>&nbsp;<span class="keyword" id="6145849">range</span>&nbsp;<span class="ident" id="6145855">hopHeaders</span>&nbsp;<span class="op" id="6145866">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145870">if</span>&nbsp;<span class="ident" id="6145873">outreq</span><span class="op" id="6145879">.</span><span class="ident" id="6145880">Header</span><span class="op" id="6145886">.</span><span class="ident" id="6145887">Get</span><span class="op" id="6145890">(</span><span class="ident" id="6145891">h</span><span class="op" id="6145892">)</span>&nbsp;<span class="op" id="6145894">!=</span>&nbsp;<span class="string" id="6145897">&#34;&#34;</span>&nbsp;<span class="op" id="6145900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6145905">if</span>&nbsp;<span class="op" id="6145908">!</span><span class="ident" id="6145909">copiedHeaders</span>&nbsp;<span class="op" id="6145923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145929">outreq</span><span class="op" id="6145935">.</span><span class="ident" id="6145936">Header</span>&nbsp;<span class="op" id="6145943">=</span>&nbsp;<span class="builtinfunc" id="6145945">make</span><span class="op" id="6145949">(</span><span class="ident" id="6145950">http</span><span class="op" id="6145954">.</span><span class="ident" id="6145955">Header</span><span class="op" id="6145961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6145967">copyHeader</span><span class="op" id="6145977">(</span><span class="ident" id="6145978">outreq</span><span class="op" id="6145984">.</span><span class="ident" id="6145985">Header</span><span class="op" id="6145991">,</span>&nbsp;<span class="ident" id="6145993">req</span><span class="op" id="6145996">.</span><span class="ident" id="6145997">Header</span><span class="op" id="6146003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146009">copiedHeaders</span>&nbsp;<span class="op" id="6146023">=</span>&nbsp;<span class="builtintype" id="6146025">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146038">outreq</span><span class="op" id="6146044">.</span><span class="ident" id="6146045">Header</span><span class="op" id="6146051">.</span><span class="ident" id="6146052">Del</span><span class="op" id="6146055">(</span><span class="ident" id="6146056">h</span><span class="op" id="6146057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146068">if</span>&nbsp;<span class="ident" id="6146071">clientIP</span><span class="op" id="6146079">,</span>&nbsp;<span class="ident" id="6146081">_</span><span class="op" id="6146082">,</span>&nbsp;<span class="ident" id="6146084">err</span>&nbsp;<span class="op" id="6146088">:=</span>&nbsp;<span class="ident" id="6146091">net</span><span class="op" id="6146094">.</span><span class="ident" id="6146095">SplitHostPort</span><span class="op" id="6146108">(</span><span class="ident" id="6146109">req</span><span class="op" id="6146112">.</span><span class="ident" id="6146113">RemoteAddr</span><span class="op" id="6146123">)</span><span class="op" id="6146124">;</span>&nbsp;<span class="ident" id="6146126">err</span>&nbsp;<span class="op" id="6146130">==</span>&nbsp;<span class="ident" id="6146133">nil</span>&nbsp;<span class="op" id="6146137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146141">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146188">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6146238">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146294">if</span>&nbsp;<span class="ident" id="6146297">prior</span><span class="op" id="6146302">,</span>&nbsp;<span class="ident" id="6146304">ok</span>&nbsp;<span class="op" id="6146307">:=</span>&nbsp;<span class="ident" id="6146310">outreq</span><span class="op" id="6146316">.</span><span class="ident" id="6146317">Header</span><span class="op" id="6146323">[</span><span class="string" id="6146324">&#34;X-Forwarded-For&#34;</span><span class="op" id="6146341">]</span><span class="op" id="6146342">;</span>&nbsp;<span class="ident" id="6146344">ok</span>&nbsp;<span class="op" id="6146347">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146352">clientIP</span>&nbsp;<span class="op" id="6146361">=</span>&nbsp;<span class="ident" id="6146363">strings</span><span class="op" id="6146370">.</span><span class="ident" id="6146371">Join</span><span class="op" id="6146375">(</span><span class="ident" id="6146376">prior</span><span class="op" id="6146381">,</span>&nbsp;<span class="string" id="6146383">&#34;,&nbsp;&#34;</span><span class="op" id="6146387">)</span>&nbsp;<span class="op" id="6146389">+</span>&nbsp;<span class="string" id="6146391">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6146396">+</span>&nbsp;<span class="ident" id="6146398">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146413">outreq</span><span class="op" id="6146419">.</span><span class="ident" id="6146420">Header</span><span class="op" id="6146426">.</span><span class="ident" id="6146427">Set</span><span class="op" id="6146430">(</span><span class="string" id="6146431">&#34;X-Forwarded-For&#34;</span><span class="op" id="6146448">,</span>&nbsp;<span class="ident" id="6146450">clientIP</span><span class="op" id="6146458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146465">res</span><span class="op" id="6146468">,</span>&nbsp;<span class="ident" id="6146470">err</span>&nbsp;<span class="op" id="6146474">:=</span>&nbsp;<span class="ident" id="6146477">transport</span><span class="op" id="6146486">.</span><span class="ident" id="6146487">RoundTrip</span><span class="op" id="6146496">(</span><span class="ident" id="6146497">outreq</span><span class="op" id="6146503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146506">if</span>&nbsp;<span class="ident" id="6146509">err</span>&nbsp;<span class="op" id="6146513">!=</span>&nbsp;<span class="ident" id="6146516">nil</span>&nbsp;<span class="op" id="6146520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146524">p</span><span class="op" id="6146525">.</span><span class="ident" id="6146526">logf</span><span class="op" id="6146530">(</span><span class="string" id="6146531">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6146554">,</span>&nbsp;<span class="ident" id="6146556">err</span><span class="op" id="6146559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146563">rw</span><span class="op" id="6146565">.</span><span class="ident" id="6146566">WriteHeader</span><span class="op" id="6146577">(</span><span class="ident" id="6146578">http</span><span class="op" id="6146582">.</span><span class="ident" id="6146583">StatusInternalServerError</span><span class="op" id="6146608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146612">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146623">defer</span>&nbsp;<span class="ident" id="6146629">res</span><span class="op" id="6146632">.</span><span class="ident" id="6146633">Body</span><span class="op" id="6146637">.</span><span class="ident" id="6146638">Close</span><span class="op" id="6146643">(</span><span class="op" id="6146644">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146648">for</span>&nbsp;<span class="ident" id="6146652">_</span><span class="op" id="6146653">,</span>&nbsp;<span class="ident" id="6146655">h</span>&nbsp;<span class="op" id="6146657">:=</span>&nbsp;<span class="keyword" id="6146660">range</span>&nbsp;<span class="ident" id="6146666">hopHeaders</span>&nbsp;<span class="op" id="6146677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146681">res</span><span class="op" id="6146684">.</span><span class="ident" id="6146685">Header</span><span class="op" id="6146691">.</span><span class="ident" id="6146692">Del</span><span class="op" id="6146695">(</span><span class="ident" id="6146696">h</span><span class="op" id="6146697">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6146700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146704">copyHeader</span><span class="op" id="6146714">(</span><span class="ident" id="6146715">rw</span><span class="op" id="6146717">.</span><span class="ident" id="6146718">Header</span><span class="op" id="6146724">(</span><span class="op" id="6146725">)</span><span class="op" id="6146726">,</span>&nbsp;<span class="ident" id="6146728">res</span><span class="op" id="6146731">.</span><span class="ident" id="6146732">Header</span><span class="op" id="6146738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146742">rw</span><span class="op" id="6146744">.</span><span class="ident" id="6146745">WriteHeader</span><span class="op" id="6146756">(</span><span class="ident" id="6146757">res</span><span class="op" id="6146760">.</span><span class="ident" id="6146761">StatusCode</span><span class="op" id="6146771">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146774">p</span><span class="op" id="6146775">.</span><span class="ident" id="6146776">copyResponse</span><span class="op" id="6146788">(</span><span class="ident" id="6146789">rw</span><span class="op" id="6146791">,</span>&nbsp;<span class="ident" id="6146793">res</span><span class="op" id="6146796">.</span><span class="ident" id="6146797">Body</span><span class="op" id="6146801">)</span><br>
<span class="lineno"></span><span class="op" id="6146803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6146806">func</span>&nbsp;<span class="op" id="6146811">(</span><span class="ident" id="6146812">p</span>&nbsp;<span class="op" id="6146814">*</span><span class="ident" id="6146815">ReverseProxy</span><span class="op" id="6146827">)</span>&nbsp;<span class="ident" id="6146829">copyResponse</span><span class="op" id="6146841">(</span><span class="ident" id="6146842">dst</span>&nbsp;<span class="ident" id="6146846">io</span><span class="op" id="6146848">.</span><span class="ident" id="6146849">Writer</span><span class="op" id="6146855">,</span>&nbsp;<span class="ident" id="6146857">src</span>&nbsp;<span class="ident" id="6146861">io</span><span class="op" id="6146863">.</span><span class="ident" id="6146864">Reader</span><span class="op" id="6146870">)</span>&nbsp;<span class="op" id="6146872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146875">if</span>&nbsp;<span class="ident" id="6146878">p</span><span class="op" id="6146879">.</span><span class="ident" id="6146880">FlushInterval</span>&nbsp;<span class="op" id="6146894">!=</span>&nbsp;<span class="num" id="6146897">0</span>&nbsp;<span class="op" id="6146899">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6146903">if</span>&nbsp;<span class="ident" id="6146906">wf</span><span class="op" id="6146908">,</span>&nbsp;<span class="ident" id="6146910">ok</span>&nbsp;<span class="op" id="6146913">:=</span>&nbsp;<span class="ident" id="6146916">dst</span><span class="op" id="6146919">.</span><span class="op" id="6146920">(</span><span class="ident" id="6146921">writeFlusher</span><span class="op" id="6146933">)</span><span class="op" id="6146934">;</span>&nbsp;<span class="ident" id="6146936">ok</span>&nbsp;<span class="op" id="6146939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146944">mlw</span>&nbsp;<span class="op" id="6146948">:=</span>&nbsp;<span class="op" id="6146951">&amp;</span><span class="ident" id="6146952">maxLatencyWriter</span><span class="op" id="6146968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146974">dst</span><span class="op" id="6146977">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6146983">wf</span><span class="op" id="6146985">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6146991">latency</span><span class="op" id="6146998">:</span>&nbsp;<span class="ident" id="6147000">p</span><span class="op" id="6147001">.</span><span class="ident" id="6147002">FlushInterval</span><span class="op" id="6147015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147021">done</span><span class="op" id="6147025">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6147030">make</span><span class="op" id="6147034">(</span><span class="keyword" id="6147035">chan</span>&nbsp;<span class="builtintype" id="6147040">bool</span><span class="op" id="6147044">)</span><span class="op" id="6147045">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147055">go</span>&nbsp;<span class="ident" id="6147058">mlw</span><span class="op" id="6147061">.</span><span class="ident" id="6147062">flushLoop</span><span class="op" id="6147071">(</span><span class="op" id="6147072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147077">defer</span>&nbsp;<span class="ident" id="6147083">mlw</span><span class="op" id="6147086">.</span><span class="ident" id="6147087">stop</span><span class="op" id="6147091">(</span><span class="op" id="6147092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147097">dst</span>&nbsp;<span class="op" id="6147101">=</span>&nbsp;<span class="ident" id="6147103">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147109">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147116">io</span><span class="op" id="6147118">.</span><span class="ident" id="6147119">Copy</span><span class="op" id="6147123">(</span><span class="ident" id="6147124">dst</span><span class="op" id="6147127">,</span>&nbsp;<span class="ident" id="6147129">src</span><span class="op" id="6147132">)</span><br>
<span class="lineno"></span><span class="op" id="6147134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6147137">func</span>&nbsp;<span class="op" id="6147142">(</span><span class="ident" id="6147143">p</span>&nbsp;<span class="op" id="6147145">*</span><span class="ident" id="6147146">ReverseProxy</span><span class="op" id="6147158">)</span>&nbsp;<span class="ident" id="6147160">logf</span><span class="op" id="6147164">(</span><span class="ident" id="6147165">format</span>&nbsp;<span class="builtintype" id="6147172">string</span><span class="op" id="6147178">,</span>&nbsp;<span class="ident" id="6147180">args</span>&nbsp;<span class="op" id="6147185">...</span><span class="keyword" id="6147188">interface</span><span class="op" id="6147197">{</span><span class="op" id="6147198">}</span><span class="op" id="6147199">)</span>&nbsp;<span class="op" id="6147201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147204">if</span>&nbsp;<span class="ident" id="6147207">p</span><span class="op" id="6147208">.</span><span class="ident" id="6147209">ErrorLog</span>&nbsp;<span class="op" id="6147218">!=</span>&nbsp;<span class="ident" id="6147221">nil</span>&nbsp;<span class="op" id="6147225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147229">p</span><span class="op" id="6147230">.</span><span class="ident" id="6147231">ErrorLog</span><span class="op" id="6147239">.</span><span class="ident" id="6147240">Printf</span><span class="op" id="6147246">(</span><span class="ident" id="6147247">format</span><span class="op" id="6147253">,</span>&nbsp;<span class="ident" id="6147255">args</span><span class="op" id="6147259">...</span><span class="op" id="6147262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147265">}</span>&nbsp;<span class="keyword" id="6147267">else</span>&nbsp;<span class="op" id="6147272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147276">log</span><span class="op" id="6147279">.</span><span class="ident" id="6147280">Printf</span><span class="op" id="6147286">(</span><span class="ident" id="6147287">format</span><span class="op" id="6147293">,</span>&nbsp;<span class="ident" id="6147295">args</span><span class="op" id="6147299">...</span><span class="op" id="6147302">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147305">}</span><br>
<span class="lineno"></span><span class="op" id="6147307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6147310">type</span>&nbsp;<span class="ident" id="6147315">writeFlusher</span>&nbsp;<span class="keyword" id="6147328">interface</span>&nbsp;<span class="op" id="6147338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147341">io</span><span class="op" id="6147343">.</span><span class="ident" id="6147344">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147352">http</span><span class="op" id="6147356">.</span><span class="ident" id="6147357">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6147365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6147368">type</span>&nbsp;<span class="ident" id="6147373">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6147390">struct</span>&nbsp;<span class="op" id="6147397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147400">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6147408">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147422">latency</span>&nbsp;<span class="ident" id="6147430">time</span><span class="op" id="6147434">.</span><span class="ident" id="6147435">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147446">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6147451">sync</span><span class="op" id="6147455">.</span><span class="ident" id="6147456">Mutex</span>&nbsp;<span class="comment" id="6147462">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147489">done</span>&nbsp;<span class="keyword" id="6147494">chan</span>&nbsp;<span class="builtintype" id="6147499">bool</span><br>
<span class="lineno"></span><span class="op" id="6147504">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6147507">func</span>&nbsp;<span class="op" id="6147512">(</span><span class="ident" id="6147513">m</span>&nbsp;<span class="op" id="6147515">*</span><span class="ident" id="6147516">maxLatencyWriter</span><span class="op" id="6147532">)</span>&nbsp;<span class="ident" id="6147534">Write</span><span class="op" id="6147539">(</span><span class="ident" id="6147540">p</span>&nbsp;<span class="op" id="6147542">[</span><span class="op" id="6147543">]</span><span class="builtintype" id="6147544">byte</span><span class="op" id="6147548">)</span>&nbsp;<span class="op" id="6147550">(</span><span class="builtintype" id="6147551">int</span><span class="op" id="6147554">,</span>&nbsp;<span class="builtintype" id="6147556">error</span><span class="op" id="6147561">)</span>&nbsp;<span class="op" id="6147563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147566">m</span><span class="op" id="6147567">.</span><span class="ident" id="6147568">lk</span><span class="op" id="6147570">.</span><span class="ident" id="6147571">Lock</span><span class="op" id="6147575">(</span><span class="op" id="6147576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147579">defer</span>&nbsp;<span class="ident" id="6147585">m</span><span class="op" id="6147586">.</span><span class="ident" id="6147587">lk</span><span class="op" id="6147589">.</span><span class="ident" id="6147590">Unlock</span><span class="op" id="6147596">(</span><span class="op" id="6147597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147600">return</span>&nbsp;<span class="ident" id="6147607">m</span><span class="op" id="6147608">.</span><span class="ident" id="6147609">dst</span><span class="op" id="6147612">.</span><span class="ident" id="6147613">Write</span><span class="op" id="6147618">(</span><span class="ident" id="6147619">p</span><span class="op" id="6147620">)</span><br>
<span class="lineno">205</span><span class="op" id="6147622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6147625">func</span>&nbsp;<span class="op" id="6147630">(</span><span class="ident" id="6147631">m</span>&nbsp;<span class="op" id="6147633">*</span><span class="ident" id="6147634">maxLatencyWriter</span><span class="op" id="6147650">)</span>&nbsp;<span class="ident" id="6147652">flushLoop</span><span class="op" id="6147661">(</span><span class="op" id="6147662">)</span>&nbsp;<span class="op" id="6147664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147667">t</span>&nbsp;<span class="op" id="6147669">:=</span>&nbsp;<span class="ident" id="6147672">time</span><span class="op" id="6147676">.</span><span class="ident" id="6147677">NewTicker</span><span class="op" id="6147686">(</span><span class="ident" id="6147687">m</span><span class="op" id="6147688">.</span><span class="ident" id="6147689">latency</span><span class="op" id="6147696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147699">defer</span>&nbsp;<span class="ident" id="6147705">t</span><span class="op" id="6147706">.</span><span class="ident" id="6147707">Stop</span><span class="op" id="6147711">(</span><span class="op" id="6147712">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147715">for</span>&nbsp;<span class="op" id="6147719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147723">select</span>&nbsp;<span class="op" id="6147730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147734">case</span>&nbsp;<span class="op" id="6147739">&lt;-</span><span class="ident" id="6147741">m</span><span class="op" id="6147742">.</span><span class="ident" id="6147743">done</span><span class="op" id="6147747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147752">if</span>&nbsp;<span class="ident" id="6147755">onExitFlushLoop</span>&nbsp;<span class="op" id="6147771">!=</span>&nbsp;<span class="ident" id="6147774">nil</span>&nbsp;<span class="op" id="6147778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147784">onExitFlushLoop</span><span class="op" id="6147799">(</span><span class="op" id="6147800">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6147819">case</span>&nbsp;<span class="op" id="6147824">&lt;-</span><span class="ident" id="6147826">t</span><span class="op" id="6147827">.</span><span class="ident" id="6147828">C</span><span class="op" id="6147829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147834">m</span><span class="op" id="6147835">.</span><span class="ident" id="6147836">lk</span><span class="op" id="6147838">.</span><span class="ident" id="6147839">Lock</span><span class="op" id="6147843">(</span><span class="op" id="6147844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147849">m</span><span class="op" id="6147850">.</span><span class="ident" id="6147851">dst</span><span class="op" id="6147854">.</span><span class="ident" id="6147855">Flush</span><span class="op" id="6147860">(</span><span class="op" id="6147861">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6147866">m</span><span class="op" id="6147867">.</span><span class="ident" id="6147868">lk</span><span class="op" id="6147870">.</span><span class="ident" id="6147871">Unlock</span><span class="op" id="6147877">(</span><span class="op" id="6147878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6147885">}</span><br>
<span class="lineno"></span><span class="op" id="6147887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6147890">func</span>&nbsp;<span class="op" id="6147895">(</span><span class="ident" id="6147896">m</span>&nbsp;<span class="op" id="6147898">*</span><span class="ident" id="6147899">maxLatencyWriter</span><span class="op" id="6147915">)</span>&nbsp;<span class="ident" id="6147917">stop</span><span class="op" id="6147921">(</span><span class="op" id="6147922">)</span>&nbsp;<span class="op" id="6147924">{</span>&nbsp;<span class="ident" id="6147926">m</span><span class="op" id="6147927">.</span><span class="ident" id="6147928">done</span>&nbsp;<span class="op" id="6147933">&lt;-</span>&nbsp;<span class="builtintype" id="6147936">true</span>&nbsp;<span class="op" id="6147941">}</span>
</div>
</body>
</html>
