<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html" class="current">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4466092">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4466147">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4466201">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4466252">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="4466323">package</span>&nbsp;<span class="ident" id="4466331">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4466336">import</span>&nbsp;<span class="op" id="4466343">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466346">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466356">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466372">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466386">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466401">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466417">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466427">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466440">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466447">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4466458">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4466465">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4466468">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4466519">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4466562">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4466620">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="4466649">func</span>&nbsp;<span class="ident" id="4466654">Server</span><span class="op" id="4466660">(</span><span class="ident" id="4466661">conn</span>&nbsp;<span class="ident" id="4466666">net</span><span class="op" id="4466669">.</span><span class="ident" id="4466670">Conn</span><span class="op" id="4466674">,</span>&nbsp;<span class="ident" id="4466676">config</span>&nbsp;<span class="op" id="4466683">*</span><span class="ident" id="4466684">Config</span><span class="op" id="4466690">)</span>&nbsp;<span class="op" id="4466692">*</span><span class="ident" id="4466693">Conn</span>&nbsp;<span class="op" id="4466698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466701">return</span>&nbsp;<span class="op" id="4466708">&amp;</span><span class="ident" id="4466709">Conn</span><span class="op" id="4466713">{</span><span class="ident" id="4466714">conn</span><span class="op" id="4466718">:</span>&nbsp;<span class="ident" id="4466720">conn</span><span class="op" id="4466724">,</span>&nbsp;<span class="ident" id="4466726">config</span><span class="op" id="4466732">:</span>&nbsp;<span class="ident" id="4466734">config</span><span class="op" id="4466740">}</span><br>
<span class="lineno"></span><span class="op" id="4466742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4466745">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="4466796">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4466839">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4466904">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="4466941">func</span>&nbsp;<span class="ident" id="4466946">Client</span><span class="op" id="4466952">(</span><span class="ident" id="4466953">conn</span>&nbsp;<span class="ident" id="4466958">net</span><span class="op" id="4466961">.</span><span class="ident" id="4466962">Conn</span><span class="op" id="4466966">,</span>&nbsp;<span class="ident" id="4466968">config</span>&nbsp;<span class="op" id="4466975">*</span><span class="ident" id="4466976">Config</span><span class="op" id="4466982">)</span>&nbsp;<span class="op" id="4466984">*</span><span class="ident" id="4466985">Conn</span>&nbsp;<span class="op" id="4466990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466993">return</span>&nbsp;<span class="op" id="4467000">&amp;</span><span class="ident" id="4467001">Conn</span><span class="op" id="4467005">{</span><span class="ident" id="4467006">conn</span><span class="op" id="4467010">:</span>&nbsp;<span class="ident" id="4467012">conn</span><span class="op" id="4467016">,</span>&nbsp;<span class="ident" id="4467018">config</span><span class="op" id="4467024">:</span>&nbsp;<span class="ident" id="4467026">config</span><span class="op" id="4467032">,</span>&nbsp;<span class="ident" id="4467034">isClient</span><span class="op" id="4467042">:</span>&nbsp;<span class="builtintype" id="4467044">true</span><span class="op" id="4467048">}</span><br>
<span class="lineno">35</span><span class="op" id="4467050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4467053">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4467133">type</span>&nbsp;<span class="ident" id="4467138">listener</span>&nbsp;<span class="keyword" id="4467147">struct</span>&nbsp;<span class="op" id="4467154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467157">net</span><span class="op" id="4467160">.</span><span class="ident" id="4467161">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467171">config</span>&nbsp;<span class="op" id="4467178">*</span><span class="ident" id="4467179">Config</span><br>
<span class="lineno"></span><span class="op" id="4467186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4467189">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4467255">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="4467300">func</span>&nbsp;<span class="op" id="4467305">(</span><span class="ident" id="4467306">l</span>&nbsp;<span class="op" id="4467308">*</span><span class="ident" id="4467309">listener</span><span class="op" id="4467317">)</span>&nbsp;<span class="ident" id="4467319">Accept</span><span class="op" id="4467325">(</span><span class="op" id="4467326">)</span>&nbsp;<span class="op" id="4467328">(</span><span class="ident" id="4467329">c</span>&nbsp;<span class="ident" id="4467331">net</span><span class="op" id="4467334">.</span><span class="ident" id="4467335">Conn</span><span class="op" id="4467339">,</span>&nbsp;<span class="ident" id="4467341">err</span>&nbsp;<span class="builtintype" id="4467345">error</span><span class="op" id="4467350">)</span>&nbsp;<span class="op" id="4467352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467355">c</span><span class="op" id="4467356">,</span>&nbsp;<span class="ident" id="4467358">err</span>&nbsp;<span class="op" id="4467362">=</span>&nbsp;<span class="ident" id="4467364">l</span><span class="op" id="4467365">.</span><span class="ident" id="4467366">Listener</span><span class="op" id="4467374">.</span><span class="ident" id="4467375">Accept</span><span class="op" id="4467381">(</span><span class="op" id="4467382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467385">if</span>&nbsp;<span class="ident" id="4467388">err</span>&nbsp;<span class="op" id="4467392">!=</span>&nbsp;<span class="builtintype" id="4467395">nil</span>&nbsp;<span class="op" id="4467399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467403">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467411">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467414">c</span>&nbsp;<span class="op" id="4467416">=</span>&nbsp;<span class="ident" id="4467418">Server</span><span class="op" id="4467424">(</span><span class="ident" id="4467425">c</span><span class="op" id="4467426">,</span>&nbsp;<span class="ident" id="4467428">l</span><span class="op" id="4467429">.</span><span class="ident" id="4467430">config</span><span class="op" id="4467436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467439">return</span><br>
<span class="lineno"></span><span class="op" id="4467446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4467449">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="4467523">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4467574">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4467632">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4467661">func</span>&nbsp;<span class="ident" id="4467666">NewListener</span><span class="op" id="4467677">(</span><span class="ident" id="4467678">inner</span>&nbsp;<span class="ident" id="4467684">net</span><span class="op" id="4467687">.</span><span class="ident" id="4467688">Listener</span><span class="op" id="4467696">,</span>&nbsp;<span class="ident" id="4467698">config</span>&nbsp;<span class="op" id="4467705">*</span><span class="ident" id="4467706">Config</span><span class="op" id="4467712">)</span>&nbsp;<span class="ident" id="4467714">net</span><span class="op" id="4467717">.</span><span class="ident" id="4467718">Listener</span>&nbsp;<span class="op" id="4467727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467730">l</span>&nbsp;<span class="op" id="4467732">:=</span>&nbsp;<span class="builtinfunc" id="4467735">new</span><span class="op" id="4467738">(</span><span class="ident" id="4467739">listener</span><span class="op" id="4467747">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467750">l</span><span class="op" id="4467751">.</span><span class="ident" id="4467752">Listener</span>&nbsp;<span class="op" id="4467761">=</span>&nbsp;<span class="ident" id="4467763">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467770">l</span><span class="op" id="4467771">.</span><span class="ident" id="4467772">config</span>&nbsp;<span class="op" id="4467779">=</span>&nbsp;<span class="ident" id="4467781">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467789">return</span>&nbsp;<span class="ident" id="4467796">l</span><br>
<span class="lineno"></span><span class="op" id="4467798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4467801">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4467863">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="4467906">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4467964">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4467993">func</span>&nbsp;<span class="ident" id="4467998">Listen</span><span class="op" id="4468004">(</span><span class="ident" id="4468005">network</span><span class="op" id="4468012">,</span>&nbsp;<span class="ident" id="4468014">laddr</span>&nbsp;<span class="builtintype" id="4468020">string</span><span class="op" id="4468026">,</span>&nbsp;<span class="ident" id="4468028">config</span>&nbsp;<span class="op" id="4468035">*</span><span class="ident" id="4468036">Config</span><span class="op" id="4468042">)</span>&nbsp;<span class="op" id="4468044">(</span><span class="ident" id="4468045">net</span><span class="op" id="4468048">.</span><span class="ident" id="4468049">Listener</span><span class="op" id="4468057">,</span>&nbsp;<span class="builtintype" id="4468059">error</span><span class="op" id="4468064">)</span>&nbsp;<span class="op" id="4468066">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468069">if</span>&nbsp;<span class="ident" id="4468072">config</span>&nbsp;<span class="op" id="4468079">==</span>&nbsp;<span class="builtintype" id="4468082">nil</span>&nbsp;<span class="op" id="4468086">||</span>&nbsp;<span class="builtinfunc" id="4468089">len</span><span class="op" id="4468092">(</span><span class="ident" id="4468093">config</span><span class="op" id="4468099">.</span><span class="ident" id="4468100">Certificates</span><span class="op" id="4468112">)</span>&nbsp;<span class="op" id="4468114">==</span>&nbsp;<span class="num" id="4468117">0</span>&nbsp;<span class="op" id="4468119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468123">return</span>&nbsp;<span class="builtintype" id="4468130">nil</span><span class="op" id="4468133">,</span>&nbsp;<span class="ident" id="4468135">errors</span><span class="op" id="4468141">.</span><span class="ident" id="4468142">New</span><span class="op" id="4468145">(</span><span class="string" id="4468146">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="4468192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4468195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468198">l</span><span class="op" id="4468199">,</span>&nbsp;<span class="ident" id="4468201">err</span>&nbsp;<span class="op" id="4468205">:=</span>&nbsp;<span class="ident" id="4468208">net</span><span class="op" id="4468211">.</span><span class="ident" id="4468212">Listen</span><span class="op" id="4468218">(</span><span class="ident" id="4468219">network</span><span class="op" id="4468226">,</span>&nbsp;<span class="ident" id="4468228">laddr</span><span class="op" id="4468233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468236">if</span>&nbsp;<span class="ident" id="4468239">err</span>&nbsp;<span class="op" id="4468243">!=</span>&nbsp;<span class="builtintype" id="4468246">nil</span>&nbsp;<span class="op" id="4468250">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468254">return</span>&nbsp;<span class="builtintype" id="4468261">nil</span><span class="op" id="4468264">,</span>&nbsp;<span class="ident" id="4468266">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4468271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468274">return</span>&nbsp;<span class="ident" id="4468281">NewListener</span><span class="op" id="4468292">(</span><span class="ident" id="4468293">l</span><span class="op" id="4468294">,</span>&nbsp;<span class="ident" id="4468296">config</span><span class="op" id="4468302">)</span><span class="op" id="4468303">,</span>&nbsp;<span class="builtintype" id="4468305">nil</span><br>
<span class="lineno"></span><span class="op" id="4468309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4468312">type</span>&nbsp;<span class="ident" id="4468317">timeoutError</span>&nbsp;<span class="keyword" id="4468330">struct</span><span class="op" id="4468336">{</span><span class="op" id="4468337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4468340">func</span>&nbsp;<span class="op" id="4468345">(</span><span class="ident" id="4468346">timeoutError</span><span class="op" id="4468358">)</span>&nbsp;<span class="ident" id="4468360">Error</span><span class="op" id="4468365">(</span><span class="op" id="4468366">)</span>&nbsp;<span class="builtintype" id="4468368">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4468377">{</span>&nbsp;<span class="keyword" id="4468379">return</span>&nbsp;<span class="string" id="4468386">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="4468418">}</span><br>
<span class="lineno"></span><span class="keyword" id="4468420">func</span>&nbsp;<span class="op" id="4468425">(</span><span class="ident" id="4468426">timeoutError</span><span class="op" id="4468438">)</span>&nbsp;<span class="ident" id="4468440">Timeout</span><span class="op" id="4468447">(</span><span class="op" id="4468448">)</span>&nbsp;<span class="builtintype" id="4468450">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4468457">{</span>&nbsp;<span class="keyword" id="4468459">return</span>&nbsp;<span class="builtintype" id="4468466">true</span>&nbsp;<span class="op" id="4468471">}</span><br>
<span class="lineno"></span><span class="keyword" id="4468473">func</span>&nbsp;<span class="op" id="4468478">(</span><span class="ident" id="4468479">timeoutError</span><span class="op" id="4468491">)</span>&nbsp;<span class="ident" id="4468493">Temporary</span><span class="op" id="4468502">(</span><span class="op" id="4468503">)</span>&nbsp;<span class="builtintype" id="4468505">bool</span>&nbsp;<span class="op" id="4468510">{</span>&nbsp;<span class="keyword" id="4468512">return</span>&nbsp;<span class="builtintype" id="4468519">true</span>&nbsp;<span class="op" id="4468524">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4468527">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4468605">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4468684">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="4468755">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="4468780">//</span><br>
<span class="lineno"></span><span class="comment" id="4468783">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="4468858">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4468926">func</span>&nbsp;<span class="ident" id="4468931">DialWithDialer</span><span class="op" id="4468945">(</span><span class="ident" id="4468946">dialer</span>&nbsp;<span class="op" id="4468953">*</span><span class="ident" id="4468954">net</span><span class="op" id="4468957">.</span><span class="ident" id="4468958">Dialer</span><span class="op" id="4468964">,</span>&nbsp;<span class="ident" id="4468966">network</span><span class="op" id="4468973">,</span>&nbsp;<span class="ident" id="4468975">addr</span>&nbsp;<span class="builtintype" id="4468980">string</span><span class="op" id="4468986">,</span>&nbsp;<span class="ident" id="4468988">config</span>&nbsp;<span class="op" id="4468995">*</span><span class="ident" id="4468996">Config</span><span class="op" id="4469002">)</span>&nbsp;<span class="op" id="4469004">(</span><span class="op" id="4469005">*</span><span class="ident" id="4469006">Conn</span><span class="op" id="4469010">,</span>&nbsp;<span class="builtintype" id="4469012">error</span><span class="op" id="4469017">)</span>&nbsp;<span class="op" id="4469019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469022">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469091">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469163">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469206">timeout</span>&nbsp;<span class="op" id="4469214">:=</span>&nbsp;<span class="ident" id="4469217">dialer</span><span class="op" id="4469223">.</span><span class="ident" id="4469224">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469234">if</span>&nbsp;<span class="op" id="4469237">!</span><span class="ident" id="4469238">dialer</span><span class="op" id="4469244">.</span><span class="ident" id="4469245">Deadline</span><span class="op" id="4469253">.</span><span class="ident" id="4469254">IsZero</span><span class="op" id="4469260">(</span><span class="op" id="4469261">)</span>&nbsp;<span class="op" id="4469263">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469267">deadlineTimeout</span>&nbsp;<span class="op" id="4469283">:=</span>&nbsp;<span class="ident" id="4469286">dialer</span><span class="op" id="4469292">.</span><span class="ident" id="4469293">Deadline</span><span class="op" id="4469301">.</span><span class="ident" id="4469302">Sub</span><span class="op" id="4469305">(</span><span class="ident" id="4469306">time</span><span class="op" id="4469310">.</span><span class="ident" id="4469311">Now</span><span class="op" id="4469314">(</span><span class="op" id="4469315">)</span><span class="op" id="4469316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469320">if</span>&nbsp;<span class="ident" id="4469323">timeout</span>&nbsp;<span class="op" id="4469331">==</span>&nbsp;<span class="num" id="4469334">0</span>&nbsp;<span class="op" id="4469336">||</span>&nbsp;<span class="ident" id="4469339">deadlineTimeout</span>&nbsp;<span class="op" id="4469355">&lt;</span>&nbsp;<span class="ident" id="4469357">timeout</span>&nbsp;<span class="op" id="4469365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469370">timeout</span>&nbsp;<span class="op" id="4469378">=</span>&nbsp;<span class="ident" id="4469380">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469401">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469405">var</span>&nbsp;<span class="ident" id="4469409">errChannel</span>&nbsp;<span class="keyword" id="4469420">chan</span>&nbsp;<span class="builtintype" id="4469425">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469433">if</span>&nbsp;<span class="ident" id="4469436">timeout</span>&nbsp;<span class="op" id="4469444">!=</span>&nbsp;<span class="num" id="4469447">0</span>&nbsp;<span class="op" id="4469449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469453">errChannel</span>&nbsp;<span class="op" id="4469464">=</span>&nbsp;<span class="builtinfunc" id="4469466">make</span><span class="op" id="4469470">(</span><span class="keyword" id="4469471">chan</span>&nbsp;<span class="builtintype" id="4469476">error</span><span class="op" id="4469481">,</span>&nbsp;<span class="num" id="4469483">2</span><span class="op" id="4469484">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469488">time</span><span class="op" id="4469492">.</span><span class="ident" id="4469493">AfterFunc</span><span class="op" id="4469502">(</span><span class="ident" id="4469503">timeout</span><span class="op" id="4469510">,</span>&nbsp;<span class="keyword" id="4469512">func</span><span class="op" id="4469516">(</span><span class="op" id="4469517">)</span>&nbsp;<span class="op" id="4469519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469524">errChannel</span>&nbsp;<span class="op" id="4469535">&lt;-</span>&nbsp;<span class="ident" id="4469538">timeoutError</span><span class="op" id="4469550">{</span><span class="op" id="4469551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469555">}</span><span class="op" id="4469556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469563">rawConn</span><span class="op" id="4469570">,</span>&nbsp;<span class="ident" id="4469572">err</span>&nbsp;<span class="op" id="4469576">:=</span>&nbsp;<span class="ident" id="4469579">dialer</span><span class="op" id="4469585">.</span><span class="ident" id="4469586">Dial</span><span class="op" id="4469590">(</span><span class="ident" id="4469591">network</span><span class="op" id="4469598">,</span>&nbsp;<span class="ident" id="4469600">addr</span><span class="op" id="4469604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469607">if</span>&nbsp;<span class="ident" id="4469610">err</span>&nbsp;<span class="op" id="4469614">!=</span>&nbsp;<span class="builtintype" id="4469617">nil</span>&nbsp;<span class="op" id="4469621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469625">return</span>&nbsp;<span class="builtintype" id="4469632">nil</span><span class="op" id="4469635">,</span>&nbsp;<span class="ident" id="4469637">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469646">colonPos</span>&nbsp;<span class="op" id="4469655">:=</span>&nbsp;<span class="ident" id="4469658">strings</span><span class="op" id="4469665">.</span><span class="ident" id="4469666">LastIndex</span><span class="op" id="4469675">(</span><span class="ident" id="4469676">addr</span><span class="op" id="4469680">,</span>&nbsp;<span class="string" id="4469682">&#34;:&#34;</span><span class="op" id="4469685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469688">if</span>&nbsp;<span class="ident" id="4469691">colonPos</span>&nbsp;<span class="op" id="4469700">==</span>&nbsp;<span class="op" id="4469703">-</span><span class="num" id="4469704">1</span>&nbsp;<span class="op" id="4469706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469710">colonPos</span>&nbsp;<span class="op" id="4469719">=</span>&nbsp;<span class="builtinfunc" id="4469721">len</span><span class="op" id="4469724">(</span><span class="ident" id="4469725">addr</span><span class="op" id="4469729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469735">hostname</span>&nbsp;<span class="op" id="4469744">:=</span>&nbsp;<span class="ident" id="4469747">addr</span><span class="op" id="4469751">[</span><span class="op" id="4469752">:</span><span class="ident" id="4469753">colonPos</span><span class="op" id="4469761">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469765">if</span>&nbsp;<span class="ident" id="4469768">config</span>&nbsp;<span class="op" id="4469775">==</span>&nbsp;<span class="builtintype" id="4469778">nil</span>&nbsp;<span class="op" id="4469782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469786">config</span>&nbsp;<span class="op" id="4469793">=</span>&nbsp;<span class="ident" id="4469795">defaultConfig</span><span class="op" id="4469808">(</span><span class="op" id="4469809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4469812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469815">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469865">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4469908">if</span>&nbsp;<span class="ident" id="4469911">config</span><span class="op" id="4469917">.</span><span class="ident" id="4469918">ServerName</span>&nbsp;<span class="op" id="4469929">==</span>&nbsp;<span class="string" id="4469932">&#34;&#34;</span>&nbsp;<span class="op" id="4469935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4469939">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4469996">c</span>&nbsp;<span class="op" id="4469998">:=</span>&nbsp;<span class="op" id="4470001">*</span><span class="ident" id="4470002">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470011">c</span><span class="op" id="4470012">.</span><span class="ident" id="4470013">ServerName</span>&nbsp;<span class="op" id="4470024">=</span>&nbsp;<span class="ident" id="4470026">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470037">config</span>&nbsp;<span class="op" id="4470044">=</span>&nbsp;<span class="op" id="4470046">&amp;</span><span class="ident" id="4470047">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470054">conn</span>&nbsp;<span class="op" id="4470059">:=</span>&nbsp;<span class="ident" id="4470062">Client</span><span class="op" id="4470068">(</span><span class="ident" id="4470069">rawConn</span><span class="op" id="4470076">,</span>&nbsp;<span class="ident" id="4470078">config</span><span class="op" id="4470084">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470088">if</span>&nbsp;<span class="ident" id="4470091">timeout</span>&nbsp;<span class="op" id="4470099">==</span>&nbsp;<span class="num" id="4470102">0</span>&nbsp;<span class="op" id="4470104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470108">err</span>&nbsp;<span class="op" id="4470112">=</span>&nbsp;<span class="ident" id="4470114">conn</span><span class="op" id="4470118">.</span><span class="ident" id="4470119">Handshake</span><span class="op" id="4470128">(</span><span class="op" id="4470129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470132">}</span>&nbsp;<span class="keyword" id="4470134">else</span>&nbsp;<span class="op" id="4470139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470143">go</span>&nbsp;<span class="keyword" id="4470146">func</span><span class="op" id="4470150">(</span><span class="op" id="4470151">)</span>&nbsp;<span class="op" id="4470153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470158">errChannel</span>&nbsp;<span class="op" id="4470169">&lt;-</span>&nbsp;<span class="ident" id="4470172">conn</span><span class="op" id="4470176">.</span><span class="ident" id="4470177">Handshake</span><span class="op" id="4470186">(</span><span class="op" id="4470187">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470191">}</span><span class="op" id="4470192">(</span><span class="op" id="4470193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470198">err</span>&nbsp;<span class="op" id="4470202">=</span>&nbsp;<span class="op" id="4470204">&lt;-</span><span class="ident" id="4470206">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470222">if</span>&nbsp;<span class="ident" id="4470225">err</span>&nbsp;<span class="op" id="4470229">!=</span>&nbsp;<span class="builtintype" id="4470232">nil</span>&nbsp;<span class="op" id="4470236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470240">rawConn</span><span class="op" id="4470247">.</span><span class="ident" id="4470248">Close</span><span class="op" id="4470253">(</span><span class="op" id="4470254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470258">return</span>&nbsp;<span class="builtintype" id="4470265">nil</span><span class="op" id="4470268">,</span>&nbsp;<span class="ident" id="4470270">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470279">return</span>&nbsp;<span class="ident" id="4470286">conn</span><span class="op" id="4470290">,</span>&nbsp;<span class="builtintype" id="4470292">nil</span><br>
<span class="lineno"></span><span class="op" id="4470296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4470299">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="4470360">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="4470423">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4470442">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4470498">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="4470557">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4470578">func</span>&nbsp;<span class="ident" id="4470583">Dial</span><span class="op" id="4470587">(</span><span class="ident" id="4470588">network</span><span class="op" id="4470595">,</span>&nbsp;<span class="ident" id="4470597">addr</span>&nbsp;<span class="builtintype" id="4470602">string</span><span class="op" id="4470608">,</span>&nbsp;<span class="ident" id="4470610">config</span>&nbsp;<span class="op" id="4470617">*</span><span class="ident" id="4470618">Config</span><span class="op" id="4470624">)</span>&nbsp;<span class="op" id="4470626">(</span><span class="op" id="4470627">*</span><span class="ident" id="4470628">Conn</span><span class="op" id="4470632">,</span>&nbsp;<span class="builtintype" id="4470634">error</span><span class="op" id="4470639">)</span>&nbsp;<span class="op" id="4470641">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470644">return</span>&nbsp;<span class="ident" id="4470651">DialWithDialer</span><span class="op" id="4470665">(</span><span class="builtinfunc" id="4470666">new</span><span class="op" id="4470669">(</span><span class="ident" id="4470670">net</span><span class="op" id="4470673">.</span><span class="ident" id="4470674">Dialer</span><span class="op" id="4470680">)</span><span class="op" id="4470681">,</span>&nbsp;<span class="ident" id="4470683">network</span><span class="op" id="4470690">,</span>&nbsp;<span class="ident" id="4470692">addr</span><span class="op" id="4470696">,</span>&nbsp;<span class="ident" id="4470698">config</span><span class="op" id="4470704">)</span><br>
<span class="lineno"></span><span class="op" id="4470706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4470709">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4470786">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="4470837">func</span>&nbsp;<span class="ident" id="4470842">LoadX509KeyPair</span><span class="op" id="4470857">(</span><span class="ident" id="4470858">certFile</span><span class="op" id="4470866">,</span>&nbsp;<span class="ident" id="4470868">keyFile</span>&nbsp;<span class="builtintype" id="4470876">string</span><span class="op" id="4470882">)</span>&nbsp;<span class="op" id="4470884">(</span><span class="ident" id="4470885">cert</span>&nbsp;<span class="ident" id="4470890">Certificate</span><span class="op" id="4470901">,</span>&nbsp;<span class="ident" id="4470903">err</span>&nbsp;<span class="builtintype" id="4470907">error</span><span class="op" id="4470912">)</span>&nbsp;<span class="op" id="4470914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470917">certPEMBlock</span><span class="op" id="4470929">,</span>&nbsp;<span class="ident" id="4470931">err</span>&nbsp;<span class="op" id="4470935">:=</span>&nbsp;<span class="ident" id="4470938">ioutil</span><span class="op" id="4470944">.</span><span class="ident" id="4470945">ReadFile</span><span class="op" id="4470953">(</span><span class="ident" id="4470954">certFile</span><span class="op" id="4470962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470965">if</span>&nbsp;<span class="ident" id="4470968">err</span>&nbsp;<span class="op" id="4470972">!=</span>&nbsp;<span class="builtintype" id="4470975">nil</span>&nbsp;<span class="op" id="4470979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4470983">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4470991">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4470994">keyPEMBlock</span><span class="op" id="4471005">,</span>&nbsp;<span class="ident" id="4471007">err</span>&nbsp;<span class="op" id="4471011">:=</span>&nbsp;<span class="ident" id="4471014">ioutil</span><span class="op" id="4471020">.</span><span class="ident" id="4471021">ReadFile</span><span class="op" id="4471029">(</span><span class="ident" id="4471030">keyFile</span><span class="op" id="4471037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471040">if</span>&nbsp;<span class="ident" id="4471043">err</span>&nbsp;<span class="op" id="4471047">!=</span>&nbsp;<span class="builtintype" id="4471050">nil</span>&nbsp;<span class="op" id="4471054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471058">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471069">return</span>&nbsp;<span class="ident" id="4471076">X509KeyPair</span><span class="op" id="4471087">(</span><span class="ident" id="4471088">certPEMBlock</span><span class="op" id="4471100">,</span>&nbsp;<span class="ident" id="4471102">keyPEMBlock</span><span class="op" id="4471113">)</span><br>
<span class="lineno">180</span><span class="op" id="4471115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4471118">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4471181">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4471202">func</span>&nbsp;<span class="ident" id="4471207">X509KeyPair</span><span class="op" id="4471218">(</span><span class="ident" id="4471219">certPEMBlock</span><span class="op" id="4471231">,</span>&nbsp;<span class="ident" id="4471233">keyPEMBlock</span>&nbsp;<span class="op" id="4471245">[</span><span class="op" id="4471246">]</span><span class="builtintype" id="4471247">byte</span><span class="op" id="4471251">)</span>&nbsp;<span class="op" id="4471253">(</span><span class="ident" id="4471254">cert</span>&nbsp;<span class="ident" id="4471259">Certificate</span><span class="op" id="4471270">,</span>&nbsp;<span class="ident" id="4471272">err</span>&nbsp;<span class="builtintype" id="4471276">error</span><span class="op" id="4471281">)</span>&nbsp;<span class="op" id="4471283">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471286">var</span>&nbsp;<span class="ident" id="4471290">certDERBlock</span>&nbsp;<span class="op" id="4471303">*</span><span class="ident" id="4471304">pem</span><span class="op" id="4471307">.</span><span class="ident" id="4471308">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471315">for</span>&nbsp;<span class="op" id="4471319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471323">certDERBlock</span><span class="op" id="4471335">,</span>&nbsp;<span class="ident" id="4471337">certPEMBlock</span>&nbsp;<span class="op" id="4471350">=</span>&nbsp;<span class="ident" id="4471352">pem</span><span class="op" id="4471355">.</span><span class="ident" id="4471356">Decode</span><span class="op" id="4471362">(</span><span class="ident" id="4471363">certPEMBlock</span><span class="op" id="4471375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471379">if</span>&nbsp;<span class="ident" id="4471382">certDERBlock</span>&nbsp;<span class="op" id="4471395">==</span>&nbsp;<span class="builtintype" id="4471398">nil</span>&nbsp;<span class="op" id="4471402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471407">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471419">if</span>&nbsp;<span class="ident" id="4471422">certDERBlock</span><span class="op" id="4471434">.</span><span class="ident" id="4471435">Type</span>&nbsp;<span class="op" id="4471440">==</span>&nbsp;<span class="string" id="4471443">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="4471457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471462">cert</span><span class="op" id="4471466">.</span><span class="ident" id="4471467">Certificate</span>&nbsp;<span class="op" id="4471479">=</span>&nbsp;<span class="builtinfunc" id="4471481">append</span><span class="op" id="4471487">(</span><span class="ident" id="4471488">cert</span><span class="op" id="4471492">.</span><span class="ident" id="4471493">Certificate</span><span class="op" id="4471504">,</span>&nbsp;<span class="ident" id="4471506">certDERBlock</span><span class="op" id="4471518">.</span><span class="ident" id="4471519">Bytes</span><span class="op" id="4471524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471531">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471535">if</span>&nbsp;<span class="builtinfunc" id="4471538">len</span><span class="op" id="4471541">(</span><span class="ident" id="4471542">cert</span><span class="op" id="4471546">.</span><span class="ident" id="4471547">Certificate</span><span class="op" id="4471558">)</span>&nbsp;<span class="op" id="4471560">==</span>&nbsp;<span class="num" id="4471563">0</span>&nbsp;<span class="op" id="4471565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471569">err</span>&nbsp;<span class="op" id="4471573">=</span>&nbsp;<span class="ident" id="4471575">errors</span><span class="op" id="4471581">.</span><span class="ident" id="4471582">New</span><span class="op" id="4471585">(</span><span class="string" id="4471586">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4471636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471640">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471648">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471652">var</span>&nbsp;<span class="ident" id="4471656">keyDERBlock</span>&nbsp;<span class="op" id="4471668">*</span><span class="ident" id="4471669">pem</span><span class="op" id="4471672">.</span><span class="ident" id="4471673">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471680">for</span>&nbsp;<span class="op" id="4471684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471688">keyDERBlock</span><span class="op" id="4471699">,</span>&nbsp;<span class="ident" id="4471701">keyPEMBlock</span>&nbsp;<span class="op" id="4471713">=</span>&nbsp;<span class="ident" id="4471715">pem</span><span class="op" id="4471718">.</span><span class="ident" id="4471719">Decode</span><span class="op" id="4471725">(</span><span class="ident" id="4471726">keyPEMBlock</span><span class="op" id="4471737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471741">if</span>&nbsp;<span class="ident" id="4471744">keyDERBlock</span>&nbsp;<span class="op" id="4471756">==</span>&nbsp;<span class="builtintype" id="4471759">nil</span>&nbsp;<span class="op" id="4471763">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471768">err</span>&nbsp;<span class="op" id="4471772">=</span>&nbsp;<span class="ident" id="4471774">errors</span><span class="op" id="4471780">.</span><span class="ident" id="4471781">New</span><span class="op" id="4471784">(</span><span class="string" id="4471785">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4471827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471832">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471845">if</span>&nbsp;<span class="ident" id="4471848">keyDERBlock</span><span class="op" id="4471859">.</span><span class="ident" id="4471860">Type</span>&nbsp;<span class="op" id="4471865">==</span>&nbsp;<span class="string" id="4471868">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="4471882">||</span>&nbsp;<span class="ident" id="4471885">strings</span><span class="op" id="4471892">.</span><span class="ident" id="4471893">HasSuffix</span><span class="op" id="4471902">(</span><span class="ident" id="4471903">keyDERBlock</span><span class="op" id="4471914">.</span><span class="ident" id="4471915">Type</span><span class="op" id="4471919">,</span>&nbsp;<span class="string" id="4471921">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="4471935">)</span>&nbsp;<span class="op" id="4471937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4471942">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4471953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4471957">cert</span><span class="op" id="4471961">.</span><span class="ident" id="4471962">PrivateKey</span><span class="op" id="4471972">,</span>&nbsp;<span class="ident" id="4471974">err</span>&nbsp;<span class="op" id="4471978">=</span>&nbsp;<span class="ident" id="4471980">parsePrivateKey</span><span class="op" id="4471995">(</span><span class="ident" id="4471996">keyDERBlock</span><span class="op" id="4472007">.</span><span class="ident" id="4472008">Bytes</span><span class="op" id="4472013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472016">if</span>&nbsp;<span class="ident" id="4472019">err</span>&nbsp;<span class="op" id="4472023">!=</span>&nbsp;<span class="builtintype" id="4472026">nil</span>&nbsp;<span class="op" id="4472030">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472034">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4472046">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4472117">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472178">x509Cert</span><span class="op" id="4472186">,</span>&nbsp;<span class="ident" id="4472188">err</span>&nbsp;<span class="op" id="4472192">:=</span>&nbsp;<span class="ident" id="4472195">x509</span><span class="op" id="4472199">.</span><span class="ident" id="4472200">ParseCertificate</span><span class="op" id="4472216">(</span><span class="ident" id="4472217">cert</span><span class="op" id="4472221">.</span><span class="ident" id="4472222">Certificate</span><span class="op" id="4472233">[</span><span class="num" id="4472234">0</span><span class="op" id="4472235">]</span><span class="op" id="4472236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472239">if</span>&nbsp;<span class="ident" id="4472242">err</span>&nbsp;<span class="op" id="4472246">!=</span>&nbsp;<span class="builtintype" id="4472249">nil</span>&nbsp;<span class="op" id="4472253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472257">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472269">switch</span>&nbsp;<span class="ident" id="4472276">pub</span>&nbsp;<span class="op" id="4472280">:=</span>&nbsp;<span class="ident" id="4472283">x509Cert</span><span class="op" id="4472291">.</span><span class="ident" id="4472292">PublicKey</span><span class="op" id="4472301">.</span><span class="op" id="4472302">(</span><span class="keyword" id="4472303">type</span><span class="op" id="4472307">)</span>&nbsp;<span class="op" id="4472309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472312">case</span>&nbsp;<span class="op" id="4472317">*</span><span class="ident" id="4472318">rsa</span><span class="op" id="4472321">.</span><span class="ident" id="4472322">PublicKey</span><span class="op" id="4472331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472335">priv</span><span class="op" id="4472339">,</span>&nbsp;<span class="ident" id="4472341">ok</span>&nbsp;<span class="op" id="4472344">:=</span>&nbsp;<span class="ident" id="4472347">cert</span><span class="op" id="4472351">.</span><span class="ident" id="4472352">PrivateKey</span><span class="op" id="4472362">.</span><span class="op" id="4472363">(</span><span class="op" id="4472364">*</span><span class="ident" id="4472365">rsa</span><span class="op" id="4472368">.</span><span class="ident" id="4472369">PrivateKey</span><span class="op" id="4472379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472383">if</span>&nbsp;<span class="op" id="4472386">!</span><span class="ident" id="4472387">ok</span>&nbsp;<span class="op" id="4472390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472395">err</span>&nbsp;<span class="op" id="4472399">=</span>&nbsp;<span class="ident" id="4472401">errors</span><span class="op" id="4472407">.</span><span class="ident" id="4472408">New</span><span class="op" id="4472411">(</span><span class="string" id="4472412">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4472473">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472478">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472491">if</span>&nbsp;<span class="ident" id="4472494">pub</span><span class="op" id="4472497">.</span><span class="ident" id="4472498">N</span><span class="op" id="4472499">.</span><span class="ident" id="4472500">Cmp</span><span class="op" id="4472503">(</span><span class="ident" id="4472504">priv</span><span class="op" id="4472508">.</span><span class="ident" id="4472509">N</span><span class="op" id="4472510">)</span>&nbsp;<span class="op" id="4472512">!=</span>&nbsp;<span class="num" id="4472515">0</span>&nbsp;<span class="op" id="4472517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472522">err</span>&nbsp;<span class="op" id="4472526">=</span>&nbsp;<span class="ident" id="4472528">errors</span><span class="op" id="4472534">.</span><span class="ident" id="4472535">New</span><span class="op" id="4472538">(</span><span class="string" id="4472539">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4472590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472595">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472607">case</span>&nbsp;<span class="op" id="4472612">*</span><span class="ident" id="4472613">ecdsa</span><span class="op" id="4472618">.</span><span class="ident" id="4472619">PublicKey</span><span class="op" id="4472628">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472632">priv</span><span class="op" id="4472636">,</span>&nbsp;<span class="ident" id="4472638">ok</span>&nbsp;<span class="op" id="4472641">:=</span>&nbsp;<span class="ident" id="4472644">cert</span><span class="op" id="4472648">.</span><span class="ident" id="4472649">PrivateKey</span><span class="op" id="4472659">.</span><span class="op" id="4472660">(</span><span class="op" id="4472661">*</span><span class="ident" id="4472662">ecdsa</span><span class="op" id="4472667">.</span><span class="ident" id="4472668">PrivateKey</span><span class="op" id="4472678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472682">if</span>&nbsp;<span class="op" id="4472685">!</span><span class="ident" id="4472686">ok</span>&nbsp;<span class="op" id="4472689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472694">err</span>&nbsp;<span class="op" id="4472698">=</span>&nbsp;<span class="ident" id="4472700">errors</span><span class="op" id="4472706">.</span><span class="ident" id="4472707">New</span><span class="op" id="4472710">(</span><span class="string" id="4472711">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4472772">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472777">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472791">if</span>&nbsp;<span class="ident" id="4472794">pub</span><span class="op" id="4472797">.</span><span class="ident" id="4472798">X</span><span class="op" id="4472799">.</span><span class="ident" id="4472800">Cmp</span><span class="op" id="4472803">(</span><span class="ident" id="4472804">priv</span><span class="op" id="4472808">.</span><span class="ident" id="4472809">X</span><span class="op" id="4472810">)</span>&nbsp;<span class="op" id="4472812">!=</span>&nbsp;<span class="num" id="4472815">0</span>&nbsp;<span class="op" id="4472817">||</span>&nbsp;<span class="ident" id="4472820">pub</span><span class="op" id="4472823">.</span><span class="ident" id="4472824">Y</span><span class="op" id="4472825">.</span><span class="ident" id="4472826">Cmp</span><span class="op" id="4472829">(</span><span class="ident" id="4472830">priv</span><span class="op" id="4472834">.</span><span class="ident" id="4472835">Y</span><span class="op" id="4472836">)</span>&nbsp;<span class="op" id="4472838">!=</span>&nbsp;<span class="num" id="4472841">0</span>&nbsp;<span class="op" id="4472843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472848">err</span>&nbsp;<span class="op" id="4472852">=</span>&nbsp;<span class="ident" id="4472854">errors</span><span class="op" id="4472860">.</span><span class="ident" id="4472861">New</span><span class="op" id="4472864">(</span><span class="string" id="4472865">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4472916">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472921">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4472930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4472933">default</span><span class="op" id="4472940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4472944">err</span>&nbsp;<span class="op" id="4472948">=</span>&nbsp;<span class="ident" id="4472950">errors</span><span class="op" id="4472956">.</span><span class="ident" id="4472957">New</span><span class="op" id="4472960">(</span><span class="string" id="4472961">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="4473003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473007">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473019">return</span><br>
<span class="lineno"></span><span class="op" id="4473026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="4473029">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="4473106">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4473184">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="4473263">func</span>&nbsp;<span class="ident" id="4473268">parsePrivateKey</span><span class="op" id="4473283">(</span><span class="ident" id="4473284">der</span>&nbsp;<span class="op" id="4473288">[</span><span class="op" id="4473289">]</span><span class="builtintype" id="4473290">byte</span><span class="op" id="4473294">)</span>&nbsp;<span class="op" id="4473296">(</span><span class="ident" id="4473297">crypto</span><span class="op" id="4473303">.</span><span class="ident" id="4473304">PrivateKey</span><span class="op" id="4473314">,</span>&nbsp;<span class="builtintype" id="4473316">error</span><span class="op" id="4473321">)</span>&nbsp;<span class="op" id="4473323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473326">if</span>&nbsp;<span class="ident" id="4473329">key</span><span class="op" id="4473332">,</span>&nbsp;<span class="ident" id="4473334">err</span>&nbsp;<span class="op" id="4473338">:=</span>&nbsp;<span class="ident" id="4473341">x509</span><span class="op" id="4473345">.</span><span class="ident" id="4473346">ParsePKCS1PrivateKey</span><span class="op" id="4473366">(</span><span class="ident" id="4473367">der</span><span class="op" id="4473370">)</span><span class="op" id="4473371">;</span>&nbsp;<span class="ident" id="4473373">err</span>&nbsp;<span class="op" id="4473377">==</span>&nbsp;<span class="builtintype" id="4473380">nil</span>&nbsp;<span class="op" id="4473384">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473388">return</span>&nbsp;<span class="ident" id="4473395">key</span><span class="op" id="4473398">,</span>&nbsp;<span class="builtintype" id="4473400">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473408">if</span>&nbsp;<span class="ident" id="4473411">key</span><span class="op" id="4473414">,</span>&nbsp;<span class="ident" id="4473416">err</span>&nbsp;<span class="op" id="4473420">:=</span>&nbsp;<span class="ident" id="4473423">x509</span><span class="op" id="4473427">.</span><span class="ident" id="4473428">ParsePKCS8PrivateKey</span><span class="op" id="4473448">(</span><span class="ident" id="4473449">der</span><span class="op" id="4473452">)</span><span class="op" id="4473453">;</span>&nbsp;<span class="ident" id="4473455">err</span>&nbsp;<span class="op" id="4473459">==</span>&nbsp;<span class="builtintype" id="4473462">nil</span>&nbsp;<span class="op" id="4473466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473470">switch</span>&nbsp;<span class="ident" id="4473477">key</span>&nbsp;<span class="op" id="4473481">:=</span>&nbsp;<span class="ident" id="4473484">key</span><span class="op" id="4473487">.</span><span class="op" id="4473488">(</span><span class="keyword" id="4473489">type</span><span class="op" id="4473493">)</span>&nbsp;<span class="op" id="4473495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473499">case</span>&nbsp;<span class="op" id="4473504">*</span><span class="ident" id="4473505">rsa</span><span class="op" id="4473508">.</span><span class="ident" id="4473509">PrivateKey</span><span class="op" id="4473519">,</span>&nbsp;<span class="op" id="4473521">*</span><span class="ident" id="4473522">ecdsa</span><span class="op" id="4473527">.</span><span class="ident" id="4473528">PrivateKey</span><span class="op" id="4473538">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473543">return</span>&nbsp;<span class="ident" id="4473550">key</span><span class="op" id="4473553">,</span>&nbsp;<span class="builtintype" id="4473555">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473561">default</span><span class="op" id="4473568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473573">return</span>&nbsp;<span class="builtintype" id="4473580">nil</span><span class="op" id="4473583">,</span>&nbsp;<span class="ident" id="4473585">errors</span><span class="op" id="4473591">.</span><span class="ident" id="4473592">New</span><span class="op" id="4473595">(</span><span class="string" id="4473596">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="4473659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473666">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473669">if</span>&nbsp;<span class="ident" id="4473672">key</span><span class="op" id="4473675">,</span>&nbsp;<span class="ident" id="4473677">err</span>&nbsp;<span class="op" id="4473681">:=</span>&nbsp;<span class="ident" id="4473684">x509</span><span class="op" id="4473688">.</span><span class="ident" id="4473689">ParseECPrivateKey</span><span class="op" id="4473706">(</span><span class="ident" id="4473707">der</span><span class="op" id="4473710">)</span><span class="op" id="4473711">;</span>&nbsp;<span class="ident" id="4473713">err</span>&nbsp;<span class="op" id="4473717">==</span>&nbsp;<span class="builtintype" id="4473720">nil</span>&nbsp;<span class="op" id="4473724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473728">return</span>&nbsp;<span class="ident" id="4473735">key</span><span class="op" id="4473738">,</span>&nbsp;<span class="builtintype" id="4473740">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4473749">return</span>&nbsp;<span class="builtintype" id="4473756">nil</span><span class="op" id="4473759">,</span>&nbsp;<span class="ident" id="4473761">errors</span><span class="op" id="4473767">.</span><span class="ident" id="4473768">New</span><span class="op" id="4473771">(</span><span class="string" id="4473772">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="4473813">)</span><br>
<span class="lineno">275</span><span class="op" id="4473815">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
