<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2364290">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2364345">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2364399">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2364450">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2364467">package</span>&nbsp;<span class="ident" id="2364475">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2364484">import</span>&nbsp;<span class="op" id="2364491">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2364494">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2364503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2364506">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2364596">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2364623">type</span>&nbsp;<span class="ident" id="2364628">SysProcIDMap</span>&nbsp;<span class="keyword" id="2364641">struct</span>&nbsp;<span class="op" id="2364648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364651">ContainerID</span>&nbsp;<span class="builtintype" id="2364663">int</span>&nbsp;<span class="comment" id="2364667">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364685">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364697">int</span>&nbsp;<span class="comment" id="2364701">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364714">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364726">int</span>&nbsp;<span class="comment" id="2364730">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2364739">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2364742">type</span>&nbsp;<span class="ident" id="2364747">SysProcAttr</span>&nbsp;<span class="keyword" id="2364759">struct</span>&nbsp;<span class="op" id="2364766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364769">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364781">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2364796">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364808">Credential</span>&nbsp;&nbsp;<span class="op" id="2364820">*</span><span class="ident" id="2364821">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2364835">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364851">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364863">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2364878">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364898">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364910">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2364925">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2364945">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2364957">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2364972">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365023">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2365035">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2365050">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365125">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2365137">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2365152">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365194">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2365206">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2365221">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365257">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2365269">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2365284">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365355">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2365367">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2365382">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365421">UidMappings</span>&nbsp;<span class="op" id="2365433">[</span><span class="op" id="2365434">]</span><span class="ident" id="2365435">SysProcIDMap</span>&nbsp;<span class="comment" id="2365448">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2365490">GidMappings</span>&nbsp;<span class="op" id="2365502">[</span><span class="op" id="2365503">]</span><span class="ident" id="2365504">SysProcIDMap</span>&nbsp;<span class="comment" id="2365517">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2365559">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2365562">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2365597">func</span>&nbsp;<span class="ident" id="2365602">runtime_BeforeFork</span><span class="op" id="2365620">(</span><span class="op" id="2365621">)</span><br>
<span class="lineno"></span><span class="keyword" id="2365623">func</span>&nbsp;<span class="ident" id="2365628">runtime_AfterFork</span><span class="op" id="2365645">(</span><span class="op" id="2365646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2365649">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2365721">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2365779">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2365846">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2365913">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2365981">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2366045">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2366106">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2366168">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2366209">func</span>&nbsp;<span class="ident" id="2366214">forkAndExecInChild</span><span class="op" id="2366232">(</span><span class="ident" id="2366233">argv0</span>&nbsp;<span class="op" id="2366239">*</span><span class="builtintype" id="2366240">byte</span><span class="op" id="2366244">,</span>&nbsp;<span class="ident" id="2366246">argv</span><span class="op" id="2366250">,</span>&nbsp;<span class="ident" id="2366252">envv</span>&nbsp;<span class="op" id="2366257">[</span><span class="op" id="2366258">]</span><span class="op" id="2366259">*</span><span class="builtintype" id="2366260">byte</span><span class="op" id="2366264">,</span>&nbsp;<span class="ident" id="2366266">chroot</span><span class="op" id="2366272">,</span>&nbsp;<span class="ident" id="2366274">dir</span>&nbsp;<span class="op" id="2366278">*</span><span class="builtintype" id="2366279">byte</span><span class="op" id="2366283">,</span>&nbsp;<span class="ident" id="2366285">attr</span>&nbsp;<span class="op" id="2366290">*</span><span class="ident" id="2366291">ProcAttr</span><span class="op" id="2366299">,</span>&nbsp;<span class="ident" id="2366301">sys</span>&nbsp;<span class="op" id="2366305">*</span><span class="ident" id="2366306">SysProcAttr</span><span class="op" id="2366317">,</span>&nbsp;<span class="ident" id="2366319">pipe</span>&nbsp;<span class="builtintype" id="2366324">int</span><span class="op" id="2366327">)</span>&nbsp;<span class="op" id="2366329">(</span><span class="ident" id="2366330">pid</span>&nbsp;<span class="builtintype" id="2366334">int</span><span class="op" id="2366337">,</span>&nbsp;<span class="ident" id="2366339">err</span>&nbsp;<span class="ident" id="2366343">Errno</span><span class="op" id="2366348">)</span>&nbsp;<span class="op" id="2366350">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366353">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366398">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366453">var</span>&nbsp;<span class="op" id="2366457">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366461">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2366468">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366478">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2366485">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366493">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2366500">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366508">nextfd</span>&nbsp;<span class="builtintype" id="2366515">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366521">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2366528">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366534">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2366541">[</span><span class="num" id="2366542">2</span><span class="op" id="2366543">]</span><span class="builtintype" id="2366544">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366549">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366553">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366608">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366672">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366731">fd</span>&nbsp;<span class="op" id="2366734">:=</span>&nbsp;<span class="builtinfunc" id="2366737">make</span><span class="op" id="2366741">(</span><span class="op" id="2366742">[</span><span class="op" id="2366743">]</span><span class="builtintype" id="2366744">int</span><span class="op" id="2366747">,</span>&nbsp;<span class="builtinfunc" id="2366749">len</span><span class="op" id="2366752">(</span><span class="ident" id="2366753">attr</span><span class="op" id="2366757">.</span><span class="ident" id="2366758">Files</span><span class="op" id="2366763">)</span><span class="op" id="2366764">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366767">nextfd</span>&nbsp;<span class="op" id="2366774">=</span>&nbsp;<span class="builtinfunc" id="2366776">len</span><span class="op" id="2366779">(</span><span class="ident" id="2366780">attr</span><span class="op" id="2366784">.</span><span class="ident" id="2366785">Files</span><span class="op" id="2366790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366793">for</span>&nbsp;<span class="ident" id="2366797">i</span><span class="op" id="2366798">,</span>&nbsp;<span class="ident" id="2366800">ufd</span>&nbsp;<span class="op" id="2366804">:=</span>&nbsp;<span class="keyword" id="2366807">range</span>&nbsp;<span class="ident" id="2366813">attr</span><span class="op" id="2366817">.</span><span class="ident" id="2366818">Files</span>&nbsp;<span class="op" id="2366824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2366828">if</span>&nbsp;<span class="ident" id="2366831">nextfd</span>&nbsp;<span class="op" id="2366838">&lt;</span>&nbsp;<span class="builtintype" id="2366840">int</span><span class="op" id="2366843">(</span><span class="ident" id="2366844">ufd</span><span class="op" id="2366847">)</span>&nbsp;<span class="op" id="2366849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366854">nextfd</span>&nbsp;<span class="op" id="2366861">=</span>&nbsp;<span class="builtintype" id="2366863">int</span><span class="op" id="2366866">(</span><span class="ident" id="2366867">ufd</span><span class="op" id="2366870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366874">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366878">fd</span><span class="op" id="2366880">[</span><span class="ident" id="2366881">i</span><span class="op" id="2366882">]</span>&nbsp;<span class="op" id="2366884">=</span>&nbsp;<span class="builtintype" id="2366886">int</span><span class="op" id="2366889">(</span><span class="ident" id="2366890">ufd</span><span class="op" id="2366893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2366896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2366899">nextfd</span><span class="op" id="2366905">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366910">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2366974">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367030">if</span>&nbsp;<span class="ident" id="2367033">sys</span><span class="op" id="2367036">.</span><span class="ident" id="2367037">UidMappings</span>&nbsp;<span class="op" id="2367049">!=</span>&nbsp;<span class="ident" id="2367052">nil</span>&nbsp;<span class="op" id="2367056">||</span>&nbsp;<span class="ident" id="2367059">sys</span><span class="op" id="2367062">.</span><span class="ident" id="2367063">GidMappings</span>&nbsp;<span class="op" id="2367075">!=</span>&nbsp;<span class="ident" id="2367078">nil</span>&nbsp;<span class="op" id="2367082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367086">if</span>&nbsp;<span class="ident" id="2367089">err</span>&nbsp;<span class="op" id="2367093">:=</span>&nbsp;<span class="ident" id="2367096">forkExecPipe</span><span class="op" id="2367108">(</span><span class="ident" id="2367109">p</span><span class="op" id="2367110">[</span><span class="op" id="2367111">:</span><span class="op" id="2367112">]</span><span class="op" id="2367113">)</span><span class="op" id="2367114">;</span>&nbsp;<span class="ident" id="2367116">err</span>&nbsp;<span class="op" id="2367120">!=</span>&nbsp;<span class="ident" id="2367123">nil</span>&nbsp;<span class="op" id="2367127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367132">return</span>&nbsp;<span class="num" id="2367139">0</span><span class="op" id="2367140">,</span>&nbsp;<span class="ident" id="2367142">err</span><span class="op" id="2367145">.</span><span class="op" id="2367146">(</span><span class="ident" id="2367147">Errno</span><span class="op" id="2367152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367156">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367163">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367187">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367246">runtime_BeforeFork</span><span class="op" id="2367264">(</span><span class="op" id="2367265">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367268">r1</span><span class="op" id="2367270">,</span>&nbsp;<span class="ident" id="2367272">_</span><span class="op" id="2367273">,</span>&nbsp;<span class="ident" id="2367275">err1</span>&nbsp;<span class="op" id="2367280">=</span>&nbsp;<span class="ident" id="2367282">RawSyscall6</span><span class="op" id="2367293">(</span><span class="ident" id="2367294">SYS_CLONE</span><span class="op" id="2367303">,</span>&nbsp;<span class="builtintype" id="2367305">uintptr</span><span class="op" id="2367312">(</span><span class="ident" id="2367313">SIGCHLD</span><span class="op" id="2367320">)</span><span class="op" id="2367321">|</span><span class="ident" id="2367322">sys</span><span class="op" id="2367325">.</span><span class="ident" id="2367326">Cloneflags</span><span class="op" id="2367336">,</span>&nbsp;<span class="num" id="2367338">0</span><span class="op" id="2367339">,</span>&nbsp;<span class="num" id="2367341">0</span><span class="op" id="2367342">,</span>&nbsp;<span class="num" id="2367344">0</span><span class="op" id="2367345">,</span>&nbsp;<span class="num" id="2367347">0</span><span class="op" id="2367348">,</span>&nbsp;<span class="num" id="2367350">0</span><span class="op" id="2367351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367354">if</span>&nbsp;<span class="ident" id="2367357">err1</span>&nbsp;<span class="op" id="2367362">!=</span>&nbsp;<span class="num" id="2367365">0</span>&nbsp;<span class="op" id="2367367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367371">runtime_AfterFork</span><span class="op" id="2367388">(</span><span class="op" id="2367389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367393">return</span>&nbsp;<span class="num" id="2367400">0</span><span class="op" id="2367401">,</span>&nbsp;<span class="ident" id="2367403">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367409">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367413">if</span>&nbsp;<span class="ident" id="2367416">r1</span>&nbsp;<span class="op" id="2367419">!=</span>&nbsp;<span class="num" id="2367422">0</span>&nbsp;<span class="op" id="2367424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367428">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367452">runtime_AfterFork</span><span class="op" id="2367469">(</span><span class="op" id="2367470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367474">pid</span>&nbsp;<span class="op" id="2367478">=</span>&nbsp;<span class="builtintype" id="2367480">int</span><span class="op" id="2367483">(</span><span class="ident" id="2367484">r1</span><span class="op" id="2367486">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367491">if</span>&nbsp;<span class="ident" id="2367494">sys</span><span class="op" id="2367497">.</span><span class="ident" id="2367498">UidMappings</span>&nbsp;<span class="op" id="2367510">!=</span>&nbsp;<span class="ident" id="2367513">nil</span>&nbsp;<span class="op" id="2367517">||</span>&nbsp;<span class="ident" id="2367520">sys</span><span class="op" id="2367523">.</span><span class="ident" id="2367524">GidMappings</span>&nbsp;<span class="op" id="2367536">!=</span>&nbsp;<span class="ident" id="2367539">nil</span>&nbsp;<span class="op" id="2367543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367548">Close</span><span class="op" id="2367553">(</span><span class="ident" id="2367554">p</span><span class="op" id="2367555">[</span><span class="num" id="2367556">0</span><span class="op" id="2367557">]</span><span class="op" id="2367558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367563">err</span>&nbsp;<span class="op" id="2367567">:=</span>&nbsp;<span class="ident" id="2367570">writeUidGidMappings</span><span class="op" id="2367589">(</span><span class="ident" id="2367590">pid</span><span class="op" id="2367593">,</span>&nbsp;<span class="ident" id="2367595">sys</span><span class="op" id="2367598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367603">if</span>&nbsp;<span class="ident" id="2367606">err</span>&nbsp;<span class="op" id="2367610">!=</span>&nbsp;<span class="ident" id="2367613">nil</span>&nbsp;<span class="op" id="2367617">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367623">err2</span>&nbsp;<span class="op" id="2367628">=</span>&nbsp;<span class="ident" id="2367630">err</span><span class="op" id="2367633">.</span><span class="op" id="2367634">(</span><span class="ident" id="2367635">Errno</span><span class="op" id="2367640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367650">RawSyscall</span><span class="op" id="2367660">(</span><span class="ident" id="2367661">SYS_WRITE</span><span class="op" id="2367670">,</span>&nbsp;<span class="builtintype" id="2367672">uintptr</span><span class="op" id="2367679">(</span><span class="ident" id="2367680">p</span><span class="op" id="2367681">[</span><span class="num" id="2367682">1</span><span class="op" id="2367683">]</span><span class="op" id="2367684">)</span><span class="op" id="2367685">,</span>&nbsp;<span class="builtintype" id="2367687">uintptr</span><span class="op" id="2367694">(</span><span class="ident" id="2367695">unsafe</span><span class="op" id="2367701">.</span><span class="ident" id="2367702">Pointer</span><span class="op" id="2367709">(</span><span class="op" id="2367710">&amp;</span><span class="ident" id="2367711">err2</span><span class="op" id="2367715">)</span><span class="op" id="2367716">)</span><span class="op" id="2367717">,</span>&nbsp;<span class="ident" id="2367719">unsafe</span><span class="op" id="2367725">.</span><span class="ident" id="2367726">Sizeof</span><span class="op" id="2367732">(</span><span class="ident" id="2367733">err2</span><span class="op" id="2367737">)</span><span class="op" id="2367738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2367743">Close</span><span class="op" id="2367748">(</span><span class="ident" id="2367749">p</span><span class="op" id="2367750">[</span><span class="num" id="2367751">1</span><span class="op" id="2367752">]</span><span class="op" id="2367753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367757">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367762">return</span>&nbsp;<span class="ident" id="2367769">pid</span><span class="op" id="2367772">,</span>&nbsp;<span class="num" id="2367774">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2367777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367781">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2367816">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367870">if</span>&nbsp;<span class="ident" id="2367873">sys</span><span class="op" id="2367876">.</span><span class="ident" id="2367877">UidMappings</span>&nbsp;<span class="op" id="2367889">!=</span>&nbsp;<span class="ident" id="2367892">nil</span>&nbsp;<span class="op" id="2367896">||</span>&nbsp;<span class="ident" id="2367899">sys</span><span class="op" id="2367902">.</span><span class="ident" id="2367903">GidMappings</span>&nbsp;<span class="op" id="2367915">!=</span>&nbsp;<span class="ident" id="2367918">nil</span>&nbsp;<span class="op" id="2367922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2367926">if</span>&nbsp;<span class="ident" id="2367929">_</span><span class="op" id="2367930">,</span>&nbsp;<span class="ident" id="2367932">_</span><span class="op" id="2367933">,</span>&nbsp;<span class="ident" id="2367935">err1</span>&nbsp;<span class="op" id="2367940">=</span>&nbsp;<span class="ident" id="2367942">RawSyscall</span><span class="op" id="2367952">(</span><span class="ident" id="2367953">SYS_CLOSE</span><span class="op" id="2367962">,</span>&nbsp;<span class="builtintype" id="2367964">uintptr</span><span class="op" id="2367971">(</span><span class="ident" id="2367972">p</span><span class="op" id="2367973">[</span><span class="num" id="2367974">1</span><span class="op" id="2367975">]</span><span class="op" id="2367976">)</span><span class="op" id="2367977">,</span>&nbsp;<span class="num" id="2367979">0</span><span class="op" id="2367980">,</span>&nbsp;<span class="num" id="2367982">0</span><span class="op" id="2367983">)</span><span class="op" id="2367984">;</span>&nbsp;<span class="ident" id="2367986">err1</span>&nbsp;<span class="op" id="2367991">!=</span>&nbsp;<span class="num" id="2367994">0</span>&nbsp;<span class="op" id="2367996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368001">goto</span>&nbsp;<span class="ident" id="2368006">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368023">r1</span><span class="op" id="2368025">,</span>&nbsp;<span class="ident" id="2368027">_</span><span class="op" id="2368028">,</span>&nbsp;<span class="ident" id="2368030">err1</span>&nbsp;<span class="op" id="2368035">=</span>&nbsp;<span class="ident" id="2368037">RawSyscall</span><span class="op" id="2368047">(</span><span class="ident" id="2368048">SYS_READ</span><span class="op" id="2368056">,</span>&nbsp;<span class="builtintype" id="2368058">uintptr</span><span class="op" id="2368065">(</span><span class="ident" id="2368066">p</span><span class="op" id="2368067">[</span><span class="num" id="2368068">0</span><span class="op" id="2368069">]</span><span class="op" id="2368070">)</span><span class="op" id="2368071">,</span>&nbsp;<span class="builtintype" id="2368073">uintptr</span><span class="op" id="2368080">(</span><span class="ident" id="2368081">unsafe</span><span class="op" id="2368087">.</span><span class="ident" id="2368088">Pointer</span><span class="op" id="2368095">(</span><span class="op" id="2368096">&amp;</span><span class="ident" id="2368097">err2</span><span class="op" id="2368101">)</span><span class="op" id="2368102">)</span><span class="op" id="2368103">,</span>&nbsp;<span class="ident" id="2368105">unsafe</span><span class="op" id="2368111">.</span><span class="ident" id="2368112">Sizeof</span><span class="op" id="2368118">(</span><span class="ident" id="2368119">err2</span><span class="op" id="2368123">)</span><span class="op" id="2368124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368128">if</span>&nbsp;<span class="ident" id="2368131">err1</span>&nbsp;<span class="op" id="2368136">!=</span>&nbsp;<span class="num" id="2368139">0</span>&nbsp;<span class="op" id="2368141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368146">goto</span>&nbsp;<span class="ident" id="2368151">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368164">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368168">if</span>&nbsp;<span class="ident" id="2368171">r1</span>&nbsp;<span class="op" id="2368174">!=</span>&nbsp;<span class="ident" id="2368177">unsafe</span><span class="op" id="2368183">.</span><span class="ident" id="2368184">Sizeof</span><span class="op" id="2368190">(</span><span class="ident" id="2368191">err2</span><span class="op" id="2368195">)</span>&nbsp;<span class="op" id="2368197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368202">err1</span>&nbsp;<span class="op" id="2368207">=</span>&nbsp;<span class="ident" id="2368209">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368219">goto</span>&nbsp;<span class="ident" id="2368224">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368241">if</span>&nbsp;<span class="ident" id="2368244">err2</span>&nbsp;<span class="op" id="2368249">!=</span>&nbsp;<span class="num" id="2368252">0</span>&nbsp;<span class="op" id="2368254">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368259">err1</span>&nbsp;<span class="op" id="2368264">=</span>&nbsp;<span class="ident" id="2368266">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368274">goto</span>&nbsp;<span class="ident" id="2368279">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368299">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368323">if</span>&nbsp;<span class="ident" id="2368326">sys</span><span class="op" id="2368329">.</span><span class="ident" id="2368330">Pdeathsig</span>&nbsp;<span class="op" id="2368340">!=</span>&nbsp;<span class="num" id="2368343">0</span>&nbsp;<span class="op" id="2368345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368349">_</span><span class="op" id="2368350">,</span>&nbsp;<span class="ident" id="2368352">_</span><span class="op" id="2368353">,</span>&nbsp;<span class="ident" id="2368355">err1</span>&nbsp;<span class="op" id="2368360">=</span>&nbsp;<span class="ident" id="2368362">RawSyscall6</span><span class="op" id="2368373">(</span><span class="ident" id="2368374">SYS_PRCTL</span><span class="op" id="2368383">,</span>&nbsp;<span class="ident" id="2368385">PR_SET_PDEATHSIG</span><span class="op" id="2368401">,</span>&nbsp;<span class="builtintype" id="2368403">uintptr</span><span class="op" id="2368410">(</span><span class="ident" id="2368411">sys</span><span class="op" id="2368414">.</span><span class="ident" id="2368415">Pdeathsig</span><span class="op" id="2368424">)</span><span class="op" id="2368425">,</span>&nbsp;<span class="num" id="2368427">0</span><span class="op" id="2368428">,</span>&nbsp;<span class="num" id="2368430">0</span><span class="op" id="2368431">,</span>&nbsp;<span class="num" id="2368433">0</span><span class="op" id="2368434">,</span>&nbsp;<span class="num" id="2368436">0</span><span class="op" id="2368437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368441">if</span>&nbsp;<span class="ident" id="2368444">err1</span>&nbsp;<span class="op" id="2368449">!=</span>&nbsp;<span class="num" id="2368452">0</span>&nbsp;<span class="op" id="2368454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368459">goto</span>&nbsp;<span class="ident" id="2368464">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368482">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368545">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368607">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368627">r1</span><span class="op" id="2368629">,</span>&nbsp;<span class="ident" id="2368631">_</span><span class="op" id="2368632">,</span>&nbsp;<span class="ident" id="2368634">_</span>&nbsp;<span class="op" id="2368636">=</span>&nbsp;<span class="ident" id="2368638">RawSyscall</span><span class="op" id="2368648">(</span><span class="ident" id="2368649">SYS_GETPPID</span><span class="op" id="2368660">,</span>&nbsp;<span class="num" id="2368662">0</span><span class="op" id="2368663">,</span>&nbsp;<span class="num" id="2368665">0</span><span class="op" id="2368666">,</span>&nbsp;<span class="num" id="2368668">0</span><span class="op" id="2368669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368673">if</span>&nbsp;<span class="ident" id="2368676">r1</span>&nbsp;<span class="op" id="2368679">==</span>&nbsp;<span class="num" id="2368682">1</span>&nbsp;<span class="op" id="2368684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368689">pid</span><span class="op" id="2368692">,</span>&nbsp;<span class="ident" id="2368694">_</span><span class="op" id="2368695">,</span>&nbsp;<span class="ident" id="2368697">_</span>&nbsp;<span class="op" id="2368699">:=</span>&nbsp;<span class="ident" id="2368702">RawSyscall</span><span class="op" id="2368712">(</span><span class="ident" id="2368713">SYS_GETPID</span><span class="op" id="2368723">,</span>&nbsp;<span class="num" id="2368725">0</span><span class="op" id="2368726">,</span>&nbsp;<span class="num" id="2368728">0</span><span class="op" id="2368729">,</span>&nbsp;<span class="num" id="2368731">0</span><span class="op" id="2368732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368737">_</span><span class="op" id="2368738">,</span>&nbsp;<span class="ident" id="2368740">_</span><span class="op" id="2368741">,</span>&nbsp;<span class="ident" id="2368743">err1</span>&nbsp;<span class="op" id="2368748">:=</span>&nbsp;<span class="ident" id="2368751">RawSyscall</span><span class="op" id="2368761">(</span><span class="ident" id="2368762">SYS_KILL</span><span class="op" id="2368770">,</span>&nbsp;<span class="ident" id="2368772">pid</span><span class="op" id="2368775">,</span>&nbsp;<span class="builtintype" id="2368777">uintptr</span><span class="op" id="2368784">(</span><span class="ident" id="2368785">sys</span><span class="op" id="2368788">.</span><span class="ident" id="2368789">Pdeathsig</span><span class="op" id="2368798">)</span><span class="op" id="2368799">,</span>&nbsp;<span class="num" id="2368801">0</span><span class="op" id="2368802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368807">if</span>&nbsp;<span class="ident" id="2368810">err1</span>&nbsp;<span class="op" id="2368815">!=</span>&nbsp;<span class="num" id="2368818">0</span>&nbsp;<span class="op" id="2368820">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368826">goto</span>&nbsp;<span class="ident" id="2368831">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2368852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2368856">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368889">if</span>&nbsp;<span class="ident" id="2368892">sys</span><span class="op" id="2368895">.</span><span class="ident" id="2368896">Ptrace</span>&nbsp;<span class="op" id="2368903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2368907">_</span><span class="op" id="2368908">,</span>&nbsp;<span class="ident" id="2368910">_</span><span class="op" id="2368911">,</span>&nbsp;<span class="ident" id="2368913">err1</span>&nbsp;<span class="op" id="2368918">=</span>&nbsp;<span class="ident" id="2368920">RawSyscall</span><span class="op" id="2368930">(</span><span class="ident" id="2368931">SYS_PTRACE</span><span class="op" id="2368941">,</span>&nbsp;<span class="builtintype" id="2368943">uintptr</span><span class="op" id="2368950">(</span><span class="ident" id="2368951">PTRACE_TRACEME</span><span class="op" id="2368965">)</span><span class="op" id="2368966">,</span>&nbsp;<span class="num" id="2368968">0</span><span class="op" id="2368969">,</span>&nbsp;<span class="num" id="2368971">0</span><span class="op" id="2368972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368976">if</span>&nbsp;<span class="ident" id="2368979">err1</span>&nbsp;<span class="op" id="2368984">!=</span>&nbsp;<span class="num" id="2368987">0</span>&nbsp;<span class="op" id="2368989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2368994">goto</span>&nbsp;<span class="ident" id="2368999">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369019">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369034">if</span>&nbsp;<span class="ident" id="2369037">sys</span><span class="op" id="2369040">.</span><span class="ident" id="2369041">Setsid</span>&nbsp;<span class="op" id="2369048">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369052">_</span><span class="op" id="2369053">,</span>&nbsp;<span class="ident" id="2369055">_</span><span class="op" id="2369056">,</span>&nbsp;<span class="ident" id="2369058">err1</span>&nbsp;<span class="op" id="2369063">=</span>&nbsp;<span class="ident" id="2369065">RawSyscall</span><span class="op" id="2369075">(</span><span class="ident" id="2369076">SYS_SETSID</span><span class="op" id="2369086">,</span>&nbsp;<span class="num" id="2369088">0</span><span class="op" id="2369089">,</span>&nbsp;<span class="num" id="2369091">0</span><span class="op" id="2369092">,</span>&nbsp;<span class="num" id="2369094">0</span><span class="op" id="2369095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369099">if</span>&nbsp;<span class="ident" id="2369102">err1</span>&nbsp;<span class="op" id="2369107">!=</span>&nbsp;<span class="num" id="2369110">0</span>&nbsp;<span class="op" id="2369112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369117">goto</span>&nbsp;<span class="ident" id="2369122">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369138">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369142">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369164">if</span>&nbsp;<span class="ident" id="2369167">sys</span><span class="op" id="2369170">.</span><span class="ident" id="2369171">Setpgid</span>&nbsp;<span class="op" id="2369179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369183">_</span><span class="op" id="2369184">,</span>&nbsp;<span class="ident" id="2369186">_</span><span class="op" id="2369187">,</span>&nbsp;<span class="ident" id="2369189">err1</span>&nbsp;<span class="op" id="2369194">=</span>&nbsp;<span class="ident" id="2369196">RawSyscall</span><span class="op" id="2369206">(</span><span class="ident" id="2369207">SYS_SETPGID</span><span class="op" id="2369218">,</span>&nbsp;<span class="num" id="2369220">0</span><span class="op" id="2369221">,</span>&nbsp;<span class="num" id="2369223">0</span><span class="op" id="2369224">,</span>&nbsp;<span class="num" id="2369226">0</span><span class="op" id="2369227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369231">if</span>&nbsp;<span class="ident" id="2369234">err1</span>&nbsp;<span class="op" id="2369239">!=</span>&nbsp;<span class="num" id="2369242">0</span>&nbsp;<span class="op" id="2369244">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369249">goto</span>&nbsp;<span class="ident" id="2369254">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369274">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369285">if</span>&nbsp;<span class="ident" id="2369288">chroot</span>&nbsp;<span class="op" id="2369295">!=</span>&nbsp;<span class="ident" id="2369298">nil</span>&nbsp;<span class="op" id="2369302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369306">_</span><span class="op" id="2369307">,</span>&nbsp;<span class="ident" id="2369309">_</span><span class="op" id="2369310">,</span>&nbsp;<span class="ident" id="2369312">err1</span>&nbsp;<span class="op" id="2369317">=</span>&nbsp;<span class="ident" id="2369319">RawSyscall</span><span class="op" id="2369329">(</span><span class="ident" id="2369330">SYS_CHROOT</span><span class="op" id="2369340">,</span>&nbsp;<span class="builtintype" id="2369342">uintptr</span><span class="op" id="2369349">(</span><span class="ident" id="2369350">unsafe</span><span class="op" id="2369356">.</span><span class="ident" id="2369357">Pointer</span><span class="op" id="2369364">(</span><span class="ident" id="2369365">chroot</span><span class="op" id="2369371">)</span><span class="op" id="2369372">)</span><span class="op" id="2369373">,</span>&nbsp;<span class="num" id="2369375">0</span><span class="op" id="2369376">,</span>&nbsp;<span class="num" id="2369378">0</span><span class="op" id="2369379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369383">if</span>&nbsp;<span class="ident" id="2369386">err1</span>&nbsp;<span class="op" id="2369391">!=</span>&nbsp;<span class="num" id="2369394">0</span>&nbsp;<span class="op" id="2369396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369401">goto</span>&nbsp;<span class="ident" id="2369406">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369419">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369426">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369446">if</span>&nbsp;<span class="ident" id="2369449">cred</span>&nbsp;<span class="op" id="2369454">:=</span>&nbsp;<span class="ident" id="2369457">sys</span><span class="op" id="2369460">.</span><span class="ident" id="2369461">Credential</span><span class="op" id="2369471">;</span>&nbsp;<span class="ident" id="2369473">cred</span>&nbsp;<span class="op" id="2369478">!=</span>&nbsp;<span class="ident" id="2369481">nil</span>&nbsp;<span class="op" id="2369485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369489">ngroups</span>&nbsp;<span class="op" id="2369497">:=</span>&nbsp;<span class="builtintype" id="2369500">uintptr</span><span class="op" id="2369507">(</span><span class="builtinfunc" id="2369508">len</span><span class="op" id="2369511">(</span><span class="ident" id="2369512">cred</span><span class="op" id="2369516">.</span><span class="ident" id="2369517">Groups</span><span class="op" id="2369523">)</span><span class="op" id="2369524">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369528">var</span>&nbsp;<span class="ident" id="2369532">groups</span>&nbsp;<span class="ident" id="2369539">unsafe</span><span class="op" id="2369545">.</span><span class="ident" id="2369546">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369556">if</span>&nbsp;<span class="ident" id="2369559">ngroups</span>&nbsp;<span class="op" id="2369567">&gt;</span>&nbsp;<span class="num" id="2369569">0</span>&nbsp;<span class="op" id="2369571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369576">groups</span>&nbsp;<span class="op" id="2369583">=</span>&nbsp;<span class="ident" id="2369585">unsafe</span><span class="op" id="2369591">.</span><span class="ident" id="2369592">Pointer</span><span class="op" id="2369599">(</span><span class="op" id="2369600">&amp;</span><span class="ident" id="2369601">cred</span><span class="op" id="2369605">.</span><span class="ident" id="2369606">Groups</span><span class="op" id="2369612">[</span><span class="num" id="2369613">0</span><span class="op" id="2369614">]</span><span class="op" id="2369615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369623">_</span><span class="op" id="2369624">,</span>&nbsp;<span class="ident" id="2369626">_</span><span class="op" id="2369627">,</span>&nbsp;<span class="ident" id="2369629">err1</span>&nbsp;<span class="op" id="2369634">=</span>&nbsp;<span class="ident" id="2369636">RawSyscall</span><span class="op" id="2369646">(</span><span class="ident" id="2369647">SYS_SETGROUPS</span><span class="op" id="2369660">,</span>&nbsp;<span class="ident" id="2369662">ngroups</span><span class="op" id="2369669">,</span>&nbsp;<span class="builtintype" id="2369671">uintptr</span><span class="op" id="2369678">(</span><span class="ident" id="2369679">groups</span><span class="op" id="2369685">)</span><span class="op" id="2369686">,</span>&nbsp;<span class="num" id="2369688">0</span><span class="op" id="2369689">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369693">if</span>&nbsp;<span class="ident" id="2369696">err1</span>&nbsp;<span class="op" id="2369701">!=</span>&nbsp;<span class="num" id="2369704">0</span>&nbsp;<span class="op" id="2369706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369711">goto</span>&nbsp;<span class="ident" id="2369716">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369733">_</span><span class="op" id="2369734">,</span>&nbsp;<span class="ident" id="2369736">_</span><span class="op" id="2369737">,</span>&nbsp;<span class="ident" id="2369739">err1</span>&nbsp;<span class="op" id="2369744">=</span>&nbsp;<span class="ident" id="2369746">RawSyscall</span><span class="op" id="2369756">(</span><span class="ident" id="2369757">SYS_SETGID</span><span class="op" id="2369767">,</span>&nbsp;<span class="builtintype" id="2369769">uintptr</span><span class="op" id="2369776">(</span><span class="ident" id="2369777">cred</span><span class="op" id="2369781">.</span><span class="ident" id="2369782">Gid</span><span class="op" id="2369785">)</span><span class="op" id="2369786">,</span>&nbsp;<span class="num" id="2369788">0</span><span class="op" id="2369789">,</span>&nbsp;<span class="num" id="2369791">0</span><span class="op" id="2369792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369796">if</span>&nbsp;<span class="ident" id="2369799">err1</span>&nbsp;<span class="op" id="2369804">!=</span>&nbsp;<span class="num" id="2369807">0</span>&nbsp;<span class="op" id="2369809">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369814">goto</span>&nbsp;<span class="ident" id="2369819">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369836">_</span><span class="op" id="2369837">,</span>&nbsp;<span class="ident" id="2369839">_</span><span class="op" id="2369840">,</span>&nbsp;<span class="ident" id="2369842">err1</span>&nbsp;<span class="op" id="2369847">=</span>&nbsp;<span class="ident" id="2369849">RawSyscall</span><span class="op" id="2369859">(</span><span class="ident" id="2369860">SYS_SETUID</span><span class="op" id="2369870">,</span>&nbsp;<span class="builtintype" id="2369872">uintptr</span><span class="op" id="2369879">(</span><span class="ident" id="2369880">cred</span><span class="op" id="2369884">.</span><span class="ident" id="2369885">Uid</span><span class="op" id="2369888">)</span><span class="op" id="2369889">,</span>&nbsp;<span class="num" id="2369891">0</span><span class="op" id="2369892">,</span>&nbsp;<span class="num" id="2369894">0</span><span class="op" id="2369895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369899">if</span>&nbsp;<span class="ident" id="2369902">err1</span>&nbsp;<span class="op" id="2369907">!=</span>&nbsp;<span class="num" id="2369910">0</span>&nbsp;<span class="op" id="2369912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369917">goto</span>&nbsp;<span class="ident" id="2369922">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2369938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2369942">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2369952">if</span>&nbsp;<span class="ident" id="2369955">dir</span>&nbsp;<span class="op" id="2369959">!=</span>&nbsp;<span class="ident" id="2369962">nil</span>&nbsp;<span class="op" id="2369966">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2369970">_</span><span class="op" id="2369971">,</span>&nbsp;<span class="ident" id="2369973">_</span><span class="op" id="2369974">,</span>&nbsp;<span class="ident" id="2369976">err1</span>&nbsp;<span class="op" id="2369981">=</span>&nbsp;<span class="ident" id="2369983">RawSyscall</span><span class="op" id="2369993">(</span><span class="ident" id="2369994">SYS_CHDIR</span><span class="op" id="2370003">,</span>&nbsp;<span class="builtintype" id="2370005">uintptr</span><span class="op" id="2370012">(</span><span class="ident" id="2370013">unsafe</span><span class="op" id="2370019">.</span><span class="ident" id="2370020">Pointer</span><span class="op" id="2370027">(</span><span class="ident" id="2370028">dir</span><span class="op" id="2370031">)</span><span class="op" id="2370032">)</span><span class="op" id="2370033">,</span>&nbsp;<span class="num" id="2370035">0</span><span class="op" id="2370036">,</span>&nbsp;<span class="num" id="2370038">0</span><span class="op" id="2370039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370043">if</span>&nbsp;<span class="ident" id="2370046">err1</span>&nbsp;<span class="op" id="2370051">!=</span>&nbsp;<span class="num" id="2370054">0</span>&nbsp;<span class="op" id="2370056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370061">goto</span>&nbsp;<span class="ident" id="2370066">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370082">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370086">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370149">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370205">if</span>&nbsp;<span class="ident" id="2370208">pipe</span>&nbsp;<span class="op" id="2370213">&lt;</span>&nbsp;<span class="ident" id="2370215">nextfd</span>&nbsp;<span class="op" id="2370222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370226">_</span><span class="op" id="2370227">,</span>&nbsp;<span class="ident" id="2370229">_</span><span class="op" id="2370230">,</span>&nbsp;<span class="ident" id="2370232">err1</span>&nbsp;<span class="op" id="2370237">=</span>&nbsp;<span class="ident" id="2370239">RawSyscall</span><span class="op" id="2370249">(</span><span class="ident" id="2370250">SYS_DUP2</span><span class="op" id="2370258">,</span>&nbsp;<span class="builtintype" id="2370260">uintptr</span><span class="op" id="2370267">(</span><span class="ident" id="2370268">pipe</span><span class="op" id="2370272">)</span><span class="op" id="2370273">,</span>&nbsp;<span class="builtintype" id="2370275">uintptr</span><span class="op" id="2370282">(</span><span class="ident" id="2370283">nextfd</span><span class="op" id="2370289">)</span><span class="op" id="2370290">,</span>&nbsp;<span class="num" id="2370292">0</span><span class="op" id="2370293">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370297">if</span>&nbsp;<span class="ident" id="2370300">err1</span>&nbsp;<span class="op" id="2370305">!=</span>&nbsp;<span class="num" id="2370308">0</span>&nbsp;<span class="op" id="2370310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370315">goto</span>&nbsp;<span class="ident" id="2370320">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370337">RawSyscall</span><span class="op" id="2370347">(</span><span class="ident" id="2370348">SYS_FCNTL</span><span class="op" id="2370357">,</span>&nbsp;<span class="builtintype" id="2370359">uintptr</span><span class="op" id="2370366">(</span><span class="ident" id="2370367">nextfd</span><span class="op" id="2370373">)</span><span class="op" id="2370374">,</span>&nbsp;<span class="ident" id="2370376">F_SETFD</span><span class="op" id="2370383">,</span>&nbsp;<span class="ident" id="2370385">FD_CLOEXEC</span><span class="op" id="2370395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370399">pipe</span>&nbsp;<span class="op" id="2370404">=</span>&nbsp;<span class="ident" id="2370406">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370415">nextfd</span><span class="op" id="2370421">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370428">for</span>&nbsp;<span class="ident" id="2370432">i</span>&nbsp;<span class="op" id="2370434">=</span>&nbsp;<span class="num" id="2370436">0</span><span class="op" id="2370437">;</span>&nbsp;<span class="ident" id="2370439">i</span>&nbsp;<span class="op" id="2370441">&lt;</span>&nbsp;<span class="builtinfunc" id="2370443">len</span><span class="op" id="2370446">(</span><span class="ident" id="2370447">fd</span><span class="op" id="2370449">)</span><span class="op" id="2370450">;</span>&nbsp;<span class="ident" id="2370452">i</span><span class="op" id="2370453">++</span>&nbsp;<span class="op" id="2370456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370460">if</span>&nbsp;<span class="ident" id="2370463">fd</span><span class="op" id="2370465">[</span><span class="ident" id="2370466">i</span><span class="op" id="2370467">]</span>&nbsp;<span class="op" id="2370469">&gt;=</span>&nbsp;<span class="num" id="2370472">0</span>&nbsp;<span class="op" id="2370474">&amp;&amp;</span>&nbsp;<span class="ident" id="2370477">fd</span><span class="op" id="2370479">[</span><span class="ident" id="2370480">i</span><span class="op" id="2370481">]</span>&nbsp;<span class="op" id="2370483">&lt;</span>&nbsp;<span class="builtintype" id="2370485">int</span><span class="op" id="2370488">(</span><span class="ident" id="2370489">i</span><span class="op" id="2370490">)</span>&nbsp;<span class="op" id="2370492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370497">_</span><span class="op" id="2370498">,</span>&nbsp;<span class="ident" id="2370500">_</span><span class="op" id="2370501">,</span>&nbsp;<span class="ident" id="2370503">err1</span>&nbsp;<span class="op" id="2370508">=</span>&nbsp;<span class="ident" id="2370510">RawSyscall</span><span class="op" id="2370520">(</span><span class="ident" id="2370521">SYS_DUP2</span><span class="op" id="2370529">,</span>&nbsp;<span class="builtintype" id="2370531">uintptr</span><span class="op" id="2370538">(</span><span class="ident" id="2370539">fd</span><span class="op" id="2370541">[</span><span class="ident" id="2370542">i</span><span class="op" id="2370543">]</span><span class="op" id="2370544">)</span><span class="op" id="2370545">,</span>&nbsp;<span class="builtintype" id="2370547">uintptr</span><span class="op" id="2370554">(</span><span class="ident" id="2370555">nextfd</span><span class="op" id="2370561">)</span><span class="op" id="2370562">,</span>&nbsp;<span class="num" id="2370564">0</span><span class="op" id="2370565">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370570">if</span>&nbsp;<span class="ident" id="2370573">err1</span>&nbsp;<span class="op" id="2370578">!=</span>&nbsp;<span class="num" id="2370581">0</span>&nbsp;<span class="op" id="2370583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370589">goto</span>&nbsp;<span class="ident" id="2370594">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370613">RawSyscall</span><span class="op" id="2370623">(</span><span class="ident" id="2370624">SYS_FCNTL</span><span class="op" id="2370633">,</span>&nbsp;<span class="builtintype" id="2370635">uintptr</span><span class="op" id="2370642">(</span><span class="ident" id="2370643">nextfd</span><span class="op" id="2370649">)</span><span class="op" id="2370650">,</span>&nbsp;<span class="ident" id="2370652">F_SETFD</span><span class="op" id="2370659">,</span>&nbsp;<span class="ident" id="2370661">FD_CLOEXEC</span><span class="op" id="2370671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370676">fd</span><span class="op" id="2370678">[</span><span class="ident" id="2370679">i</span><span class="op" id="2370680">]</span>&nbsp;<span class="op" id="2370682">=</span>&nbsp;<span class="ident" id="2370684">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370694">nextfd</span><span class="op" id="2370700">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370706">if</span>&nbsp;<span class="ident" id="2370709">nextfd</span>&nbsp;<span class="op" id="2370716">==</span>&nbsp;<span class="ident" id="2370719">pipe</span>&nbsp;<span class="op" id="2370724">{</span>&nbsp;<span class="comment" id="2370726">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370753">nextfd</span><span class="op" id="2370759">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370769">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370776">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370811">for</span>&nbsp;<span class="ident" id="2370815">i</span>&nbsp;<span class="op" id="2370817">=</span>&nbsp;<span class="num" id="2370819">0</span><span class="op" id="2370820">;</span>&nbsp;<span class="ident" id="2370822">i</span>&nbsp;<span class="op" id="2370824">&lt;</span>&nbsp;<span class="builtinfunc" id="2370826">len</span><span class="op" id="2370829">(</span><span class="ident" id="2370830">fd</span><span class="op" id="2370832">)</span><span class="op" id="2370833">;</span>&nbsp;<span class="ident" id="2370835">i</span><span class="op" id="2370836">++</span>&nbsp;<span class="op" id="2370839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370843">if</span>&nbsp;<span class="ident" id="2370846">fd</span><span class="op" id="2370848">[</span><span class="ident" id="2370849">i</span><span class="op" id="2370850">]</span>&nbsp;<span class="op" id="2370852">==</span>&nbsp;<span class="op" id="2370855">-</span><span class="num" id="2370856">1</span>&nbsp;<span class="op" id="2370858">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2370863">RawSyscall</span><span class="op" id="2370873">(</span><span class="ident" id="2370874">SYS_CLOSE</span><span class="op" id="2370883">,</span>&nbsp;<span class="builtintype" id="2370885">uintptr</span><span class="op" id="2370892">(</span><span class="ident" id="2370893">i</span><span class="op" id="2370894">)</span><span class="op" id="2370895">,</span>&nbsp;<span class="num" id="2370897">0</span><span class="op" id="2370898">,</span>&nbsp;<span class="num" id="2370900">0</span><span class="op" id="2370901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370906">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2370917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2370921">if</span>&nbsp;<span class="ident" id="2370924">fd</span><span class="op" id="2370926">[</span><span class="ident" id="2370927">i</span><span class="op" id="2370928">]</span>&nbsp;<span class="op" id="2370930">==</span>&nbsp;<span class="builtintype" id="2370933">int</span><span class="op" id="2370936">(</span><span class="ident" id="2370937">i</span><span class="op" id="2370938">)</span>&nbsp;<span class="op" id="2370940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2370945">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371003">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371040">_</span><span class="op" id="2371041">,</span>&nbsp;<span class="ident" id="2371043">_</span><span class="op" id="2371044">,</span>&nbsp;<span class="ident" id="2371046">err1</span>&nbsp;<span class="op" id="2371051">=</span>&nbsp;<span class="ident" id="2371053">RawSyscall</span><span class="op" id="2371063">(</span><span class="ident" id="2371064">SYS_FCNTL</span><span class="op" id="2371073">,</span>&nbsp;<span class="builtintype" id="2371075">uintptr</span><span class="op" id="2371082">(</span><span class="ident" id="2371083">fd</span><span class="op" id="2371085">[</span><span class="ident" id="2371086">i</span><span class="op" id="2371087">]</span><span class="op" id="2371088">)</span><span class="op" id="2371089">,</span>&nbsp;<span class="ident" id="2371091">F_SETFD</span><span class="op" id="2371098">,</span>&nbsp;<span class="num" id="2371100">0</span><span class="op" id="2371101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371106">if</span>&nbsp;<span class="ident" id="2371109">err1</span>&nbsp;<span class="op" id="2371114">!=</span>&nbsp;<span class="num" id="2371117">0</span>&nbsp;<span class="op" id="2371119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371125">goto</span>&nbsp;<span class="ident" id="2371130">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371144">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371149">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371164">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371210">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371246">_</span><span class="op" id="2371247">,</span>&nbsp;<span class="ident" id="2371249">_</span><span class="op" id="2371250">,</span>&nbsp;<span class="ident" id="2371252">err1</span>&nbsp;<span class="op" id="2371257">=</span>&nbsp;<span class="ident" id="2371259">RawSyscall</span><span class="op" id="2371269">(</span><span class="ident" id="2371270">SYS_DUP2</span><span class="op" id="2371278">,</span>&nbsp;<span class="builtintype" id="2371280">uintptr</span><span class="op" id="2371287">(</span><span class="ident" id="2371288">fd</span><span class="op" id="2371290">[</span><span class="ident" id="2371291">i</span><span class="op" id="2371292">]</span><span class="op" id="2371293">)</span><span class="op" id="2371294">,</span>&nbsp;<span class="builtintype" id="2371296">uintptr</span><span class="op" id="2371303">(</span><span class="ident" id="2371304">i</span><span class="op" id="2371305">)</span><span class="op" id="2371306">,</span>&nbsp;<span class="num" id="2371308">0</span><span class="op" id="2371309">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371313">if</span>&nbsp;<span class="ident" id="2371316">err1</span>&nbsp;<span class="op" id="2371321">!=</span>&nbsp;<span class="num" id="2371324">0</span>&nbsp;<span class="op" id="2371326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371331">goto</span>&nbsp;<span class="ident" id="2371336">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371356">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371413">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371475">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371530">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371561">for</span>&nbsp;<span class="ident" id="2371565">i</span>&nbsp;<span class="op" id="2371567">=</span>&nbsp;<span class="builtinfunc" id="2371569">len</span><span class="op" id="2371572">(</span><span class="ident" id="2371573">fd</span><span class="op" id="2371575">)</span><span class="op" id="2371576">;</span>&nbsp;<span class="ident" id="2371578">i</span>&nbsp;<span class="op" id="2371580">&lt;</span>&nbsp;<span class="num" id="2371582">3</span><span class="op" id="2371583">;</span>&nbsp;<span class="ident" id="2371585">i</span><span class="op" id="2371586">++</span>&nbsp;<span class="op" id="2371589">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371593">RawSyscall</span><span class="op" id="2371603">(</span><span class="ident" id="2371604">SYS_CLOSE</span><span class="op" id="2371613">,</span>&nbsp;<span class="builtintype" id="2371615">uintptr</span><span class="op" id="2371622">(</span><span class="ident" id="2371623">i</span><span class="op" id="2371624">)</span><span class="op" id="2371625">,</span>&nbsp;<span class="num" id="2371627">0</span><span class="op" id="2371628">,</span>&nbsp;<span class="num" id="2371630">0</span><span class="op" id="2371631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371638">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371663">if</span>&nbsp;<span class="ident" id="2371666">sys</span><span class="op" id="2371669">.</span><span class="ident" id="2371670">Noctty</span>&nbsp;<span class="op" id="2371677">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371681">_</span><span class="op" id="2371682">,</span>&nbsp;<span class="ident" id="2371684">_</span><span class="op" id="2371685">,</span>&nbsp;<span class="ident" id="2371687">err1</span>&nbsp;<span class="op" id="2371692">=</span>&nbsp;<span class="ident" id="2371694">RawSyscall</span><span class="op" id="2371704">(</span><span class="ident" id="2371705">SYS_IOCTL</span><span class="op" id="2371714">,</span>&nbsp;<span class="num" id="2371716">0</span><span class="op" id="2371717">,</span>&nbsp;<span class="builtintype" id="2371719">uintptr</span><span class="op" id="2371726">(</span><span class="ident" id="2371727">TIOCNOTTY</span><span class="op" id="2371736">)</span><span class="op" id="2371737">,</span>&nbsp;<span class="num" id="2371739">0</span><span class="op" id="2371740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371744">if</span>&nbsp;<span class="ident" id="2371747">err1</span>&nbsp;<span class="op" id="2371752">!=</span>&nbsp;<span class="num" id="2371755">0</span>&nbsp;<span class="op" id="2371757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371762">goto</span>&nbsp;<span class="ident" id="2371767">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371783">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371787">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371823">if</span>&nbsp;<span class="ident" id="2371826">sys</span><span class="op" id="2371829">.</span><span class="ident" id="2371830">Setctty</span>&nbsp;<span class="op" id="2371838">&amp;&amp;</span>&nbsp;<span class="ident" id="2371841">sys</span><span class="op" id="2371844">.</span><span class="ident" id="2371845">Ctty</span>&nbsp;<span class="op" id="2371850">&gt;=</span>&nbsp;<span class="num" id="2371853">0</span>&nbsp;<span class="op" id="2371855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371859">_</span><span class="op" id="2371860">,</span>&nbsp;<span class="ident" id="2371862">_</span><span class="op" id="2371863">,</span>&nbsp;<span class="ident" id="2371865">err1</span>&nbsp;<span class="op" id="2371870">=</span>&nbsp;<span class="ident" id="2371872">RawSyscall</span><span class="op" id="2371882">(</span><span class="ident" id="2371883">SYS_IOCTL</span><span class="op" id="2371892">,</span>&nbsp;<span class="builtintype" id="2371894">uintptr</span><span class="op" id="2371901">(</span><span class="ident" id="2371902">sys</span><span class="op" id="2371905">.</span><span class="ident" id="2371906">Ctty</span><span class="op" id="2371910">)</span><span class="op" id="2371911">,</span>&nbsp;<span class="builtintype" id="2371913">uintptr</span><span class="op" id="2371920">(</span><span class="ident" id="2371921">TIOCSCTTY</span><span class="op" id="2371930">)</span><span class="op" id="2371931">,</span>&nbsp;<span class="num" id="2371933">0</span><span class="op" id="2371934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371938">if</span>&nbsp;<span class="ident" id="2371941">err1</span>&nbsp;<span class="op" id="2371946">!=</span>&nbsp;<span class="num" id="2371949">0</span>&nbsp;<span class="op" id="2371951">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2371956">goto</span>&nbsp;<span class="ident" id="2371961">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2371977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2371981">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2371999">_</span><span class="op" id="2372000">,</span>&nbsp;<span class="ident" id="2372002">_</span><span class="op" id="2372003">,</span>&nbsp;<span class="ident" id="2372005">err1</span>&nbsp;<span class="op" id="2372010">=</span>&nbsp;<span class="ident" id="2372012">RawSyscall</span><span class="op" id="2372022">(</span><span class="ident" id="2372023">SYS_EXECVE</span><span class="op" id="2372033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2372037">uintptr</span><span class="op" id="2372044">(</span><span class="ident" id="2372045">unsafe</span><span class="op" id="2372051">.</span><span class="ident" id="2372052">Pointer</span><span class="op" id="2372059">(</span><span class="ident" id="2372060">argv0</span><span class="op" id="2372065">)</span><span class="op" id="2372066">)</span><span class="op" id="2372067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2372071">uintptr</span><span class="op" id="2372078">(</span><span class="ident" id="2372079">unsafe</span><span class="op" id="2372085">.</span><span class="ident" id="2372086">Pointer</span><span class="op" id="2372093">(</span><span class="op" id="2372094">&amp;</span><span class="ident" id="2372095">argv</span><span class="op" id="2372099">[</span><span class="num" id="2372100">0</span><span class="op" id="2372101">]</span><span class="op" id="2372102">)</span><span class="op" id="2372103">)</span><span class="op" id="2372104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2372108">uintptr</span><span class="op" id="2372115">(</span><span class="ident" id="2372116">unsafe</span><span class="op" id="2372122">.</span><span class="ident" id="2372123">Pointer</span><span class="op" id="2372130">(</span><span class="op" id="2372131">&amp;</span><span class="ident" id="2372132">envv</span><span class="op" id="2372136">[</span><span class="num" id="2372137">0</span><span class="op" id="2372138">]</span><span class="op" id="2372139">)</span><span class="op" id="2372140">)</span><span class="op" id="2372141">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2372144">childerror</span><span class="op" id="2372154">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372157">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372185">RawSyscall</span><span class="op" id="2372195">(</span><span class="ident" id="2372196">SYS_WRITE</span><span class="op" id="2372205">,</span>&nbsp;<span class="builtintype" id="2372207">uintptr</span><span class="op" id="2372214">(</span><span class="ident" id="2372215">pipe</span><span class="op" id="2372219">)</span><span class="op" id="2372220">,</span>&nbsp;<span class="builtintype" id="2372222">uintptr</span><span class="op" id="2372229">(</span><span class="ident" id="2372230">unsafe</span><span class="op" id="2372236">.</span><span class="ident" id="2372237">Pointer</span><span class="op" id="2372244">(</span><span class="op" id="2372245">&amp;</span><span class="ident" id="2372246">err1</span><span class="op" id="2372250">)</span><span class="op" id="2372251">)</span><span class="op" id="2372252">,</span>&nbsp;<span class="ident" id="2372254">unsafe</span><span class="op" id="2372260">.</span><span class="ident" id="2372261">Sizeof</span><span class="op" id="2372267">(</span><span class="ident" id="2372268">err1</span><span class="op" id="2372272">)</span><span class="op" id="2372273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372276">for</span>&nbsp;<span class="op" id="2372280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372284">RawSyscall</span><span class="op" id="2372294">(</span><span class="ident" id="2372295">SYS_EXIT</span><span class="op" id="2372303">,</span>&nbsp;<span class="num" id="2372305">253</span><span class="op" id="2372308">,</span>&nbsp;<span class="num" id="2372310">0</span><span class="op" id="2372311">,</span>&nbsp;<span class="num" id="2372313">0</span><span class="op" id="2372314">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372317">}</span><br>
<span class="lineno"></span><span class="op" id="2372319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2372322">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2372389">func</span>&nbsp;<span class="ident" id="2372394">forkExecPipe</span><span class="op" id="2372406">(</span><span class="ident" id="2372407">p</span>&nbsp;<span class="op" id="2372409">[</span><span class="op" id="2372410">]</span><span class="builtintype" id="2372411">int</span><span class="op" id="2372414">)</span>&nbsp;<span class="op" id="2372416">(</span><span class="ident" id="2372417">err</span>&nbsp;<span class="builtintype" id="2372421">error</span><span class="op" id="2372426">)</span>&nbsp;<span class="op" id="2372428">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372431">err</span>&nbsp;<span class="op" id="2372435">=</span>&nbsp;<span class="ident" id="2372437">Pipe2</span><span class="op" id="2372442">(</span><span class="ident" id="2372443">p</span><span class="op" id="2372444">,</span>&nbsp;<span class="ident" id="2372446">O_CLOEXEC</span><span class="op" id="2372455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372458">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2372533">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372563">if</span>&nbsp;<span class="ident" id="2372566">err</span>&nbsp;<span class="op" id="2372570">==</span>&nbsp;<span class="ident" id="2372573">ENOSYS</span>&nbsp;<span class="op" id="2372580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372584">if</span>&nbsp;<span class="ident" id="2372587">err</span>&nbsp;<span class="op" id="2372591">=</span>&nbsp;<span class="ident" id="2372593">Pipe</span><span class="op" id="2372597">(</span><span class="ident" id="2372598">p</span><span class="op" id="2372599">)</span><span class="op" id="2372600">;</span>&nbsp;<span class="ident" id="2372602">err</span>&nbsp;<span class="op" id="2372606">!=</span>&nbsp;<span class="ident" id="2372609">nil</span>&nbsp;<span class="op" id="2372613">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372631">if</span>&nbsp;<span class="ident" id="2372634">_</span><span class="op" id="2372635">,</span>&nbsp;<span class="ident" id="2372637">err</span>&nbsp;<span class="op" id="2372641">=</span>&nbsp;<span class="ident" id="2372643">fcntl</span><span class="op" id="2372648">(</span><span class="ident" id="2372649">p</span><span class="op" id="2372650">[</span><span class="num" id="2372651">0</span><span class="op" id="2372652">]</span><span class="op" id="2372653">,</span>&nbsp;<span class="ident" id="2372655">F_SETFD</span><span class="op" id="2372662">,</span>&nbsp;<span class="ident" id="2372664">FD_CLOEXEC</span><span class="op" id="2372674">)</span><span class="op" id="2372675">;</span>&nbsp;<span class="ident" id="2372677">err</span>&nbsp;<span class="op" id="2372681">!=</span>&nbsp;<span class="ident" id="2372684">nil</span>&nbsp;<span class="op" id="2372688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372693">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372702">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372706">_</span><span class="op" id="2372707">,</span>&nbsp;<span class="ident" id="2372709">err</span>&nbsp;<span class="op" id="2372713">=</span>&nbsp;<span class="ident" id="2372715">fcntl</span><span class="op" id="2372720">(</span><span class="ident" id="2372721">p</span><span class="op" id="2372722">[</span><span class="num" id="2372723">1</span><span class="op" id="2372724">]</span><span class="op" id="2372725">,</span>&nbsp;<span class="ident" id="2372727">F_SETFD</span><span class="op" id="2372734">,</span>&nbsp;<span class="ident" id="2372736">FD_CLOEXEC</span><span class="op" id="2372746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372752">return</span><br>
<span class="lineno"></span><span class="op" id="2372759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2372762">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2372859">func</span>&nbsp;<span class="ident" id="2372864">writeIDMappings</span><span class="op" id="2372879">(</span><span class="ident" id="2372880">path</span>&nbsp;<span class="builtintype" id="2372885">string</span><span class="op" id="2372891">,</span>&nbsp;<span class="ident" id="2372893">idMap</span>&nbsp;<span class="op" id="2372899">[</span><span class="op" id="2372900">]</span><span class="ident" id="2372901">SysProcIDMap</span><span class="op" id="2372913">)</span>&nbsp;<span class="builtintype" id="2372915">error</span>&nbsp;<span class="op" id="2372921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372924">fd</span><span class="op" id="2372926">,</span>&nbsp;<span class="ident" id="2372928">err</span>&nbsp;<span class="op" id="2372932">:=</span>&nbsp;<span class="ident" id="2372935">Open</span><span class="op" id="2372939">(</span><span class="ident" id="2372940">path</span><span class="op" id="2372944">,</span>&nbsp;<span class="ident" id="2372946">O_RDWR</span><span class="op" id="2372952">,</span>&nbsp;<span class="num" id="2372954">0</span><span class="op" id="2372955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372958">if</span>&nbsp;<span class="ident" id="2372961">err</span>&nbsp;<span class="op" id="2372965">!=</span>&nbsp;<span class="ident" id="2372968">nil</span>&nbsp;<span class="op" id="2372972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2372976">return</span>&nbsp;<span class="ident" id="2372983">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2372988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2372992">data</span>&nbsp;<span class="op" id="2372997">:=</span>&nbsp;<span class="string" id="2373000">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373004">for</span>&nbsp;<span class="ident" id="2373008">_</span><span class="op" id="2373009">,</span>&nbsp;<span class="ident" id="2373011">im</span>&nbsp;<span class="op" id="2373014">:=</span>&nbsp;<span class="keyword" id="2373017">range</span>&nbsp;<span class="ident" id="2373023">idMap</span>&nbsp;<span class="op" id="2373029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373033">data</span>&nbsp;<span class="op" id="2373038">=</span>&nbsp;<span class="ident" id="2373040">data</span>&nbsp;<span class="op" id="2373045">+</span>&nbsp;<span class="ident" id="2373047">itoa</span><span class="op" id="2373051">(</span><span class="ident" id="2373052">im</span><span class="op" id="2373054">.</span><span class="ident" id="2373055">ContainerID</span><span class="op" id="2373066">)</span>&nbsp;<span class="op" id="2373068">+</span>&nbsp;<span class="string" id="2373070">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2373074">+</span>&nbsp;<span class="ident" id="2373076">itoa</span><span class="op" id="2373080">(</span><span class="ident" id="2373081">im</span><span class="op" id="2373083">.</span><span class="ident" id="2373084">HostID</span><span class="op" id="2373090">)</span>&nbsp;<span class="op" id="2373092">+</span>&nbsp;<span class="string" id="2373094">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2373098">+</span>&nbsp;<span class="ident" id="2373100">itoa</span><span class="op" id="2373104">(</span><span class="ident" id="2373105">im</span><span class="op" id="2373107">.</span><span class="ident" id="2373108">Size</span><span class="op" id="2373112">)</span>&nbsp;<span class="op" id="2373114">+</span>&nbsp;<span class="string" id="2373116">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373126">bytes</span><span class="op" id="2373131">,</span>&nbsp;<span class="ident" id="2373133">err</span>&nbsp;<span class="op" id="2373137">:=</span>&nbsp;<span class="ident" id="2373140">ByteSliceFromString</span><span class="op" id="2373159">(</span><span class="ident" id="2373160">data</span><span class="op" id="2373164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373167">if</span>&nbsp;<span class="ident" id="2373170">err</span>&nbsp;<span class="op" id="2373174">!=</span>&nbsp;<span class="ident" id="2373177">nil</span>&nbsp;<span class="op" id="2373181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373185">Close</span><span class="op" id="2373190">(</span><span class="ident" id="2373191">fd</span><span class="op" id="2373193">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373197">return</span>&nbsp;<span class="ident" id="2373204">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373213">if</span>&nbsp;<span class="ident" id="2373216">_</span><span class="op" id="2373217">,</span>&nbsp;<span class="ident" id="2373219">err</span>&nbsp;<span class="op" id="2373223">:=</span>&nbsp;<span class="ident" id="2373226">Write</span><span class="op" id="2373231">(</span><span class="ident" id="2373232">fd</span><span class="op" id="2373234">,</span>&nbsp;<span class="ident" id="2373236">bytes</span><span class="op" id="2373241">)</span><span class="op" id="2373242">;</span>&nbsp;<span class="ident" id="2373244">err</span>&nbsp;<span class="op" id="2373248">!=</span>&nbsp;<span class="ident" id="2373251">nil</span>&nbsp;<span class="op" id="2373255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373259">Close</span><span class="op" id="2373264">(</span><span class="ident" id="2373265">fd</span><span class="op" id="2373267">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373271">return</span>&nbsp;<span class="ident" id="2373278">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373287">if</span>&nbsp;<span class="ident" id="2373290">err</span>&nbsp;<span class="op" id="2373294">:=</span>&nbsp;<span class="ident" id="2373297">Close</span><span class="op" id="2373302">(</span><span class="ident" id="2373303">fd</span><span class="op" id="2373305">)</span><span class="op" id="2373306">;</span>&nbsp;<span class="ident" id="2373308">err</span>&nbsp;<span class="op" id="2373312">!=</span>&nbsp;<span class="ident" id="2373315">nil</span>&nbsp;<span class="op" id="2373319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373323">return</span>&nbsp;<span class="ident" id="2373330">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373339">return</span>&nbsp;<span class="ident" id="2373346">nil</span><br>
<span class="lineno"></span><span class="op" id="2373350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2373353">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2373433">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2373492">func</span>&nbsp;<span class="ident" id="2373497">writeUidGidMappings</span><span class="op" id="2373516">(</span><span class="ident" id="2373517">pid</span>&nbsp;<span class="builtintype" id="2373521">int</span><span class="op" id="2373524">,</span>&nbsp;<span class="ident" id="2373526">sys</span>&nbsp;<span class="op" id="2373530">*</span><span class="ident" id="2373531">SysProcAttr</span><span class="op" id="2373542">)</span>&nbsp;<span class="builtintype" id="2373544">error</span>&nbsp;<span class="op" id="2373550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373553">if</span>&nbsp;<span class="ident" id="2373556">sys</span><span class="op" id="2373559">.</span><span class="ident" id="2373560">UidMappings</span>&nbsp;<span class="op" id="2373572">!=</span>&nbsp;<span class="ident" id="2373575">nil</span>&nbsp;<span class="op" id="2373579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373583">uidf</span>&nbsp;<span class="op" id="2373588">:=</span>&nbsp;<span class="string" id="2373591">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2373600">+</span>&nbsp;<span class="ident" id="2373602">itoa</span><span class="op" id="2373606">(</span><span class="ident" id="2373607">pid</span><span class="op" id="2373610">)</span>&nbsp;<span class="op" id="2373612">+</span>&nbsp;<span class="string" id="2373614">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373627">if</span>&nbsp;<span class="ident" id="2373630">err</span>&nbsp;<span class="op" id="2373634">:=</span>&nbsp;<span class="ident" id="2373637">writeIDMappings</span><span class="op" id="2373652">(</span><span class="ident" id="2373653">uidf</span><span class="op" id="2373657">,</span>&nbsp;<span class="ident" id="2373659">sys</span><span class="op" id="2373662">.</span><span class="ident" id="2373663">UidMappings</span><span class="op" id="2373674">)</span><span class="op" id="2373675">;</span>&nbsp;<span class="ident" id="2373677">err</span>&nbsp;<span class="op" id="2373681">!=</span>&nbsp;<span class="ident" id="2373684">nil</span>&nbsp;<span class="op" id="2373688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373693">return</span>&nbsp;<span class="ident" id="2373700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373713">if</span>&nbsp;<span class="ident" id="2373716">sys</span><span class="op" id="2373719">.</span><span class="ident" id="2373720">GidMappings</span>&nbsp;<span class="op" id="2373732">!=</span>&nbsp;<span class="ident" id="2373735">nil</span>&nbsp;<span class="op" id="2373739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2373743">gidf</span>&nbsp;<span class="op" id="2373748">:=</span>&nbsp;<span class="string" id="2373751">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2373760">+</span>&nbsp;<span class="ident" id="2373762">itoa</span><span class="op" id="2373766">(</span><span class="ident" id="2373767">pid</span><span class="op" id="2373770">)</span>&nbsp;<span class="op" id="2373772">+</span>&nbsp;<span class="string" id="2373774">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373787">if</span>&nbsp;<span class="ident" id="2373790">err</span>&nbsp;<span class="op" id="2373794">:=</span>&nbsp;<span class="ident" id="2373797">writeIDMappings</span><span class="op" id="2373812">(</span><span class="ident" id="2373813">gidf</span><span class="op" id="2373817">,</span>&nbsp;<span class="ident" id="2373819">sys</span><span class="op" id="2373822">.</span><span class="ident" id="2373823">GidMappings</span><span class="op" id="2373834">)</span><span class="op" id="2373835">;</span>&nbsp;<span class="ident" id="2373837">err</span>&nbsp;<span class="op" id="2373841">!=</span>&nbsp;<span class="ident" id="2373844">nil</span>&nbsp;<span class="op" id="2373848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373853">return</span>&nbsp;<span class="ident" id="2373860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373866">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2373869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2373873">return</span>&nbsp;<span class="ident" id="2373880">nil</span><br>
<span class="lineno"></span><span class="op" id="2373884">}</span>
</div>
</body>
</html>
