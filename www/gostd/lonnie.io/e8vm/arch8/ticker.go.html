<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="5076691">package</span>&nbsp;<span class="ident" id="5076699">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5076706">import</span>&nbsp;<span class="op" id="5076713">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5076716">&#34;math/rand&#34;</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5076729">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5076736">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5076739">//&nbsp;Ticker&nbsp;is&nbsp;a&nbsp;device&nbsp;that&nbsp;generates&nbsp;time&nbsp;interrupts.</span><br>
<span class="lineno"></span><span class="keyword" id="5076793">type</span>&nbsp;<span class="ident" id="5076798">ticker</span>&nbsp;<span class="keyword" id="5076805">struct</span>&nbsp;<span class="op" id="5076812">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076815">intBus</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5076824">intBus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076832">nextTick</span>&nbsp;<span class="builtintype" id="5076841">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076849">Interval</span>&nbsp;<span class="builtintype" id="5076858">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076865">Noise</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5076874">int32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076881">Rand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076890">*</span><span class="ident" id="5076891">rand</span><span class="op" id="5076895">.</span><span class="ident" id="5076896">Rand</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5076902">Code</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5076911">byte</span><br>
<span class="lineno"></span><span class="op" id="5076916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5076919">//&nbsp;NewTicker&nbsp;creates&nbsp;a&nbsp;new&nbsp;time&nbsp;interrupt&nbsp;generator.</span><br>
<span class="lineno">20</span><span class="keyword" id="5076972">func</span>&nbsp;<span class="ident" id="5076977">newTicker</span><span class="op" id="5076986">(</span><span class="ident" id="5076987">bus</span>&nbsp;<span class="ident" id="5076991">intBus</span><span class="op" id="5076997">)</span>&nbsp;<span class="op" id="5076999">*</span><span class="ident" id="5077000">ticker</span>&nbsp;<span class="op" id="5077007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077010">ret</span>&nbsp;<span class="op" id="5077014">:=</span>&nbsp;<span class="builtinfunc" id="5077017">new</span><span class="op" id="5077020">(</span><span class="ident" id="5077021">ticker</span><span class="op" id="5077027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077030">ret</span><span class="op" id="5077033">.</span><span class="ident" id="5077034">intBus</span>&nbsp;<span class="op" id="5077041">=</span>&nbsp;<span class="ident" id="5077043">bus</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077049">ret</span><span class="op" id="5077052">.</span><span class="ident" id="5077053">Interval</span>&nbsp;<span class="op" id="5077062">=</span>&nbsp;<span class="num" id="5077064">1000</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077070">ret</span><span class="op" id="5077073">.</span><span class="ident" id="5077074">Noise</span>&nbsp;<span class="op" id="5077080">=</span>&nbsp;<span class="num" id="5077082">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077086">ret</span><span class="op" id="5077089">.</span><span class="ident" id="5077090">Rand</span>&nbsp;<span class="op" id="5077095">=</span>&nbsp;<span class="ident" id="5077097">rand</span><span class="op" id="5077101">.</span><span class="ident" id="5077102">New</span><span class="op" id="5077105">(</span><span class="ident" id="5077106">rand</span><span class="op" id="5077110">.</span><span class="ident" id="5077111">NewSource</span><span class="op" id="5077120">(</span><span class="ident" id="5077121">time</span><span class="op" id="5077125">.</span><span class="ident" id="5077126">Now</span><span class="op" id="5077129">(</span><span class="op" id="5077130">)</span><span class="op" id="5077131">.</span><span class="ident" id="5077132">UnixNano</span><span class="op" id="5077140">(</span><span class="op" id="5077141">)</span><span class="op" id="5077142">)</span><span class="op" id="5077143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077146">ret</span><span class="op" id="5077149">.</span><span class="ident" id="5077150">Code</span>&nbsp;<span class="op" id="5077155">=</span>&nbsp;<span class="num" id="5077157">2</span>&nbsp;<span class="comment" id="5077159">//&nbsp;time&nbsp;interrupt&nbsp;code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077184">ret</span><span class="op" id="5077187">.</span><span class="ident" id="5077188">reset</span><span class="op" id="5077193">(</span><span class="op" id="5077194">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077198">return</span>&nbsp;<span class="ident" id="5077205">ret</span><br>
<span class="lineno"></span><span class="op" id="5077209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5077212">func</span>&nbsp;<span class="op" id="5077217">(</span><span class="ident" id="5077218">t</span>&nbsp;<span class="op" id="5077220">*</span><span class="ident" id="5077221">ticker</span><span class="op" id="5077227">)</span>&nbsp;<span class="ident" id="5077229">reset</span><span class="op" id="5077234">(</span><span class="op" id="5077235">)</span>&nbsp;<span class="op" id="5077237">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077240">if</span>&nbsp;<span class="ident" id="5077243">t</span><span class="op" id="5077244">.</span><span class="ident" id="5077245">Noise</span>&nbsp;<span class="op" id="5077251">&lt;</span>&nbsp;<span class="num" id="5077253">0</span>&nbsp;<span class="op" id="5077255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5077259">panic</span><span class="op" id="5077264">(</span><span class="string" id="5077265">&#34;negative&nbsp;ticker&nbsp;noise&#34;</span><span class="op" id="5077288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077294">if</span>&nbsp;<span class="ident" id="5077297">t</span><span class="op" id="5077298">.</span><span class="ident" id="5077299">Interval</span>&nbsp;<span class="op" id="5077308">&lt;</span>&nbsp;<span class="num" id="5077310">0</span>&nbsp;<span class="op" id="5077312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5077316">panic</span><span class="op" id="5077321">(</span><span class="string" id="5077322">&#34;negative&nbsp;ticker&nbsp;interval&#34;</span><span class="op" id="5077348">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077355">noise</span>&nbsp;<span class="op" id="5077361">:=</span>&nbsp;<span class="builtintype" id="5077364">int32</span><span class="op" id="5077369">(</span><span class="num" id="5077370">0</span><span class="op" id="5077371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077374">if</span>&nbsp;<span class="ident" id="5077377">t</span><span class="op" id="5077378">.</span><span class="ident" id="5077379">Noise</span>&nbsp;<span class="op" id="5077385">&gt;</span>&nbsp;<span class="num" id="5077387">0</span>&nbsp;<span class="op" id="5077389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077393">noise</span>&nbsp;<span class="op" id="5077399">=</span>&nbsp;<span class="ident" id="5077401">t</span><span class="op" id="5077402">.</span><span class="ident" id="5077403">Rand</span><span class="op" id="5077407">.</span><span class="ident" id="5077408">Int31n</span><span class="op" id="5077414">(</span><span class="ident" id="5077415">t</span><span class="op" id="5077416">.</span><span class="ident" id="5077417">Noise</span><span class="op" id="5077422">)</span>&nbsp;<span class="op" id="5077424">-</span>&nbsp;<span class="ident" id="5077426">t</span><span class="op" id="5077427">.</span><span class="ident" id="5077428">Noise</span><span class="op" id="5077433">/</span><span class="num" id="5077434">2</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077441">next</span>&nbsp;<span class="op" id="5077446">:=</span>&nbsp;<span class="ident" id="5077449">t</span><span class="op" id="5077450">.</span><span class="ident" id="5077451">Interval</span>&nbsp;<span class="op" id="5077460">+</span>&nbsp;<span class="ident" id="5077462">noise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077469">if</span>&nbsp;<span class="ident" id="5077472">next</span>&nbsp;<span class="op" id="5077477">&lt;</span>&nbsp;<span class="num" id="5077479">0</span>&nbsp;<span class="op" id="5077481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077485">next</span>&nbsp;<span class="op" id="5077490">=</span>&nbsp;<span class="num" id="5077492">0</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077499">t</span><span class="op" id="5077500">.</span><span class="ident" id="5077501">nextTick</span>&nbsp;<span class="op" id="5077510">=</span>&nbsp;<span class="ident" id="5077512">next</span><br>
<span class="lineno"></span><span class="op" id="5077517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5077520">//&nbsp;Tick&nbsp;decreases&nbsp;the&nbsp;ticking&nbsp;counter.&nbsp;If&nbsp;the&nbsp;counter&nbsp;reaches&nbsp;0,</span><br>
<span class="lineno"></span><span class="comment" id="5077585">//&nbsp;it&nbsp;will&nbsp;issue&nbsp;interrupts&nbsp;to&nbsp;all&nbsp;cores&nbsp;and&nbsp;reset&nbsp;the&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="5077649">func</span>&nbsp;<span class="op" id="5077654">(</span><span class="ident" id="5077655">t</span>&nbsp;<span class="op" id="5077657">*</span><span class="ident" id="5077658">ticker</span><span class="op" id="5077664">)</span>&nbsp;<span class="ident" id="5077666">Tick</span><span class="op" id="5077670">(</span><span class="op" id="5077671">)</span>&nbsp;<span class="op" id="5077673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077676">if</span>&nbsp;<span class="ident" id="5077679">t</span><span class="op" id="5077680">.</span><span class="ident" id="5077681">nextTick</span>&nbsp;<span class="op" id="5077690">&lt;</span>&nbsp;<span class="num" id="5077692">0</span>&nbsp;<span class="op" id="5077694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5077698">panic</span><span class="op" id="5077703">(</span><span class="string" id="5077704">&#34;bug&#34;</span><span class="op" id="5077709">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5077716">if</span>&nbsp;<span class="ident" id="5077719">t</span><span class="op" id="5077720">.</span><span class="ident" id="5077721">nextTick</span>&nbsp;<span class="op" id="5077730">==</span>&nbsp;<span class="num" id="5077733">0</span>&nbsp;<span class="op" id="5077735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077739">intAllCores</span><span class="op" id="5077750">(</span><span class="ident" id="5077751">t</span><span class="op" id="5077752">.</span><span class="ident" id="5077753">intBus</span><span class="op" id="5077759">,</span>&nbsp;<span class="ident" id="5077761">t</span><span class="op" id="5077762">.</span><span class="ident" id="5077763">Code</span><span class="op" id="5077767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077771">t</span><span class="op" id="5077772">.</span><span class="ident" id="5077773">reset</span><span class="op" id="5077778">(</span><span class="op" id="5077779">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077782">}</span>&nbsp;<span class="keyword" id="5077784">else</span>&nbsp;<span class="op" id="5077789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5077793">t</span><span class="op" id="5077794">.</span><span class="ident" id="5077795">nextTick</span><span class="op" id="5077803">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5077807">}</span><br>
<span class="lineno"></span><span class="op" id="5077809">}</span>
</div>
</body>
</html>
