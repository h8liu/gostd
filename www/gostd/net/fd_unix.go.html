<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3281713">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3281768">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3281822">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3281873">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3281943">package</span>&nbsp;<span class="ident" id="3281951">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3281956">import</span>&nbsp;<span class="op" id="3281963">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3281966">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3281972">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3281978">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3281989">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3282004">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3282015">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3282022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3282025">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3282053">type</span>&nbsp;<span class="ident" id="3282058">netFD</span>&nbsp;<span class="keyword" id="3282064">struct</span>&nbsp;<span class="op" id="3282071">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282074">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282149">fdmu</span>&nbsp;<span class="ident" id="3282154">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282164">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282190">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3282202">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282207">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3282219">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282224">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3282236">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282241">isConnected</span>&nbsp;<span class="builtintype" id="3282253">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282259">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3282271">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282279">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3282291">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282297">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3282309">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282316">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282332">pd</span>&nbsp;<span class="ident" id="3282335">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3282344">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3282347">func</span>&nbsp;<span class="ident" id="3282352">sysInit</span><span class="op" id="3282359">(</span><span class="op" id="3282360">)</span>&nbsp;<span class="op" id="3282362">{</span><br>
<span class="lineno"></span><span class="op" id="3282364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3282367">func</span>&nbsp;<span class="ident" id="3282372">dial</span><span class="op" id="3282376">(</span><span class="ident" id="3282377">network</span>&nbsp;<span class="builtintype" id="3282385">string</span><span class="op" id="3282391">,</span>&nbsp;<span class="ident" id="3282393">ra</span>&nbsp;<span class="ident" id="3282396">Addr</span><span class="op" id="3282400">,</span>&nbsp;<span class="ident" id="3282402">dialer</span>&nbsp;<span class="keyword" id="3282409">func</span><span class="op" id="3282413">(</span><span class="ident" id="3282414">time</span><span class="op" id="3282418">.</span><span class="ident" id="3282419">Time</span><span class="op" id="3282423">)</span>&nbsp;<span class="op" id="3282425">(</span><span class="ident" id="3282426">Conn</span><span class="op" id="3282430">,</span>&nbsp;<span class="builtintype" id="3282432">error</span><span class="op" id="3282437">)</span><span class="op" id="3282438">,</span>&nbsp;<span class="ident" id="3282440">deadline</span>&nbsp;<span class="ident" id="3282449">time</span><span class="op" id="3282453">.</span><span class="ident" id="3282454">Time</span><span class="op" id="3282458">)</span>&nbsp;<span class="op" id="3282460">(</span><span class="ident" id="3282461">Conn</span><span class="op" id="3282465">,</span>&nbsp;<span class="builtintype" id="3282467">error</span><span class="op" id="3282472">)</span>&nbsp;<span class="op" id="3282474">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282477">return</span>&nbsp;<span class="ident" id="3282484">dialer</span><span class="op" id="3282490">(</span><span class="ident" id="3282491">deadline</span><span class="op" id="3282499">)</span><br>
<span class="lineno"></span><span class="op" id="3282501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3282504">func</span>&nbsp;<span class="ident" id="3282509">newFD</span><span class="op" id="3282514">(</span><span class="ident" id="3282515">sysfd</span><span class="op" id="3282520">,</span>&nbsp;<span class="ident" id="3282522">family</span><span class="op" id="3282528">,</span>&nbsp;<span class="ident" id="3282530">sotype</span>&nbsp;<span class="builtintype" id="3282537">int</span><span class="op" id="3282540">,</span>&nbsp;<span class="ident" id="3282542">net</span>&nbsp;<span class="builtintype" id="3282546">string</span><span class="op" id="3282552">)</span>&nbsp;<span class="op" id="3282554">(</span><span class="op" id="3282555">*</span><span class="ident" id="3282556">netFD</span><span class="op" id="3282561">,</span>&nbsp;<span class="builtintype" id="3282563">error</span><span class="op" id="3282568">)</span>&nbsp;<span class="op" id="3282570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282573">return</span>&nbsp;<span class="op" id="3282580">&amp;</span><span class="ident" id="3282581">netFD</span><span class="op" id="3282586">{</span><span class="ident" id="3282587">sysfd</span><span class="op" id="3282592">:</span>&nbsp;<span class="ident" id="3282594">sysfd</span><span class="op" id="3282599">,</span>&nbsp;<span class="ident" id="3282601">family</span><span class="op" id="3282607">:</span>&nbsp;<span class="ident" id="3282609">family</span><span class="op" id="3282615">,</span>&nbsp;<span class="ident" id="3282617">sotype</span><span class="op" id="3282623">:</span>&nbsp;<span class="ident" id="3282625">sotype</span><span class="op" id="3282631">,</span>&nbsp;<span class="ident" id="3282633">net</span><span class="op" id="3282636">:</span>&nbsp;<span class="ident" id="3282638">net</span><span class="op" id="3282641">}</span><span class="op" id="3282642">,</span>&nbsp;<span class="ident" id="3282644">nil</span><br>
<span class="lineno">45</span><span class="op" id="3282648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3282651">func</span>&nbsp;<span class="op" id="3282656">(</span><span class="ident" id="3282657">fd</span>&nbsp;<span class="op" id="3282660">*</span><span class="ident" id="3282661">netFD</span><span class="op" id="3282666">)</span>&nbsp;<span class="ident" id="3282668">init</span><span class="op" id="3282672">(</span><span class="op" id="3282673">)</span>&nbsp;<span class="builtintype" id="3282675">error</span>&nbsp;<span class="op" id="3282681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282684">if</span>&nbsp;<span class="ident" id="3282687">err</span>&nbsp;<span class="op" id="3282691">:=</span>&nbsp;<span class="ident" id="3282694">fd</span><span class="op" id="3282696">.</span><span class="ident" id="3282697">pd</span><span class="op" id="3282699">.</span><span class="ident" id="3282700">Init</span><span class="op" id="3282704">(</span><span class="ident" id="3282705">fd</span><span class="op" id="3282707">)</span><span class="op" id="3282708">;</span>&nbsp;<span class="ident" id="3282710">err</span>&nbsp;<span class="op" id="3282714">!=</span>&nbsp;<span class="ident" id="3282717">nil</span>&nbsp;<span class="op" id="3282721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282725">return</span>&nbsp;<span class="ident" id="3282732">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3282737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282740">return</span>&nbsp;<span class="ident" id="3282747">nil</span><br>
<span class="lineno"></span><span class="op" id="3282751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3282754">func</span>&nbsp;<span class="op" id="3282759">(</span><span class="ident" id="3282760">fd</span>&nbsp;<span class="op" id="3282763">*</span><span class="ident" id="3282764">netFD</span><span class="op" id="3282769">)</span>&nbsp;<span class="ident" id="3282771">setAddr</span><span class="op" id="3282778">(</span><span class="ident" id="3282779">laddr</span><span class="op" id="3282784">,</span>&nbsp;<span class="ident" id="3282786">raddr</span>&nbsp;<span class="ident" id="3282792">Addr</span><span class="op" id="3282796">)</span>&nbsp;<span class="op" id="3282798">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282801">fd</span><span class="op" id="3282803">.</span><span class="ident" id="3282804">laddr</span>&nbsp;<span class="op" id="3282810">=</span>&nbsp;<span class="ident" id="3282812">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282819">fd</span><span class="op" id="3282821">.</span><span class="ident" id="3282822">raddr</span>&nbsp;<span class="op" id="3282828">=</span>&nbsp;<span class="ident" id="3282830">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282837">runtime</span><span class="op" id="3282844">.</span><span class="ident" id="3282845">SetFinalizer</span><span class="op" id="3282857">(</span><span class="ident" id="3282858">fd</span><span class="op" id="3282860">,</span>&nbsp;<span class="op" id="3282862">(</span><span class="op" id="3282863">*</span><span class="ident" id="3282864">netFD</span><span class="op" id="3282869">)</span><span class="op" id="3282870">.</span><span class="ident" id="3282871">Close</span><span class="op" id="3282876">)</span><br>
<span class="lineno"></span><span class="op" id="3282878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3282881">func</span>&nbsp;<span class="op" id="3282886">(</span><span class="ident" id="3282887">fd</span>&nbsp;<span class="op" id="3282890">*</span><span class="ident" id="3282891">netFD</span><span class="op" id="3282896">)</span>&nbsp;<span class="ident" id="3282898">name</span><span class="op" id="3282902">(</span><span class="op" id="3282903">)</span>&nbsp;<span class="builtintype" id="3282905">string</span>&nbsp;<span class="op" id="3282912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282915">var</span>&nbsp;<span class="ident" id="3282919">ls</span><span class="op" id="3282921">,</span>&nbsp;<span class="ident" id="3282923">rs</span>&nbsp;<span class="builtintype" id="3282926">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282934">if</span>&nbsp;<span class="ident" id="3282937">fd</span><span class="op" id="3282939">.</span><span class="ident" id="3282940">laddr</span>&nbsp;<span class="op" id="3282946">!=</span>&nbsp;<span class="ident" id="3282949">nil</span>&nbsp;<span class="op" id="3282953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282957">ls</span>&nbsp;<span class="op" id="3282960">=</span>&nbsp;<span class="ident" id="3282962">fd</span><span class="op" id="3282964">.</span><span class="ident" id="3282965">laddr</span><span class="op" id="3282970">.</span><span class="ident" id="3282971">String</span><span class="op" id="3282977">(</span><span class="op" id="3282978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3282981">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282984">if</span>&nbsp;<span class="ident" id="3282987">fd</span><span class="op" id="3282989">.</span><span class="ident" id="3282990">raddr</span>&nbsp;<span class="op" id="3282996">!=</span>&nbsp;<span class="ident" id="3282999">nil</span>&nbsp;<span class="op" id="3283003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283007">rs</span>&nbsp;<span class="op" id="3283010">=</span>&nbsp;<span class="ident" id="3283012">fd</span><span class="op" id="3283014">.</span><span class="ident" id="3283015">raddr</span><span class="op" id="3283020">.</span><span class="ident" id="3283021">String</span><span class="op" id="3283027">(</span><span class="op" id="3283028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283034">return</span>&nbsp;<span class="ident" id="3283041">fd</span><span class="op" id="3283043">.</span><span class="ident" id="3283044">net</span>&nbsp;<span class="op" id="3283048">+</span>&nbsp;<span class="string" id="3283050">&#34;:&#34;</span>&nbsp;<span class="op" id="3283054">+</span>&nbsp;<span class="ident" id="3283056">ls</span>&nbsp;<span class="op" id="3283059">+</span>&nbsp;<span class="string" id="3283061">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3283066">+</span>&nbsp;<span class="ident" id="3283068">rs</span><br>
<span class="lineno"></span><span class="op" id="3283071">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3283074">func</span>&nbsp;<span class="op" id="3283079">(</span><span class="ident" id="3283080">fd</span>&nbsp;<span class="op" id="3283083">*</span><span class="ident" id="3283084">netFD</span><span class="op" id="3283089">)</span>&nbsp;<span class="ident" id="3283091">connect</span><span class="op" id="3283098">(</span><span class="ident" id="3283099">la</span><span class="op" id="3283101">,</span>&nbsp;<span class="ident" id="3283103">ra</span>&nbsp;<span class="ident" id="3283106">syscall</span><span class="op" id="3283113">.</span><span class="ident" id="3283114">Sockaddr</span><span class="op" id="3283122">,</span>&nbsp;<span class="ident" id="3283124">deadline</span>&nbsp;<span class="ident" id="3283133">time</span><span class="op" id="3283137">.</span><span class="ident" id="3283138">Time</span><span class="op" id="3283142">)</span>&nbsp;<span class="builtintype" id="3283144">error</span>&nbsp;<span class="op" id="3283150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283153">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283196">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283242">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283288">switch</span>&nbsp;<span class="ident" id="3283295">err</span>&nbsp;<span class="op" id="3283299">:=</span>&nbsp;<span class="ident" id="3283302">syscall</span><span class="op" id="3283309">.</span><span class="ident" id="3283310">Connect</span><span class="op" id="3283317">(</span><span class="ident" id="3283318">fd</span><span class="op" id="3283320">.</span><span class="ident" id="3283321">sysfd</span><span class="op" id="3283326">,</span>&nbsp;<span class="ident" id="3283328">ra</span><span class="op" id="3283330">)</span><span class="op" id="3283331">;</span>&nbsp;<span class="ident" id="3283333">err</span>&nbsp;<span class="op" id="3283337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283340">case</span>&nbsp;<span class="ident" id="3283345">syscall</span><span class="op" id="3283352">.</span><span class="ident" id="3283353">EINPROGRESS</span><span class="op" id="3283364">,</span>&nbsp;<span class="ident" id="3283366">syscall</span><span class="op" id="3283373">.</span><span class="ident" id="3283374">EALREADY</span><span class="op" id="3283382">,</span>&nbsp;<span class="ident" id="3283384">syscall</span><span class="op" id="3283391">.</span><span class="ident" id="3283392">EINTR</span><span class="op" id="3283397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283400">case</span>&nbsp;<span class="ident" id="3283405">nil</span><span class="op" id="3283408">,</span>&nbsp;<span class="ident" id="3283410">syscall</span><span class="op" id="3283417">.</span><span class="ident" id="3283418">EISCONN</span><span class="op" id="3283425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283429">if</span>&nbsp;<span class="op" id="3283432">!</span><span class="ident" id="3283433">deadline</span><span class="op" id="3283441">.</span><span class="ident" id="3283442">IsZero</span><span class="op" id="3283448">(</span><span class="op" id="3283449">)</span>&nbsp;<span class="op" id="3283451">&amp;&amp;</span>&nbsp;<span class="ident" id="3283454">deadline</span><span class="op" id="3283462">.</span><span class="ident" id="3283463">Before</span><span class="op" id="3283469">(</span><span class="ident" id="3283470">time</span><span class="op" id="3283474">.</span><span class="ident" id="3283475">Now</span><span class="op" id="3283478">(</span><span class="op" id="3283479">)</span><span class="op" id="3283480">)</span>&nbsp;<span class="op" id="3283482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283487">return</span>&nbsp;<span class="ident" id="3283494">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283511">if</span>&nbsp;<span class="ident" id="3283514">err</span>&nbsp;<span class="op" id="3283518">:=</span>&nbsp;<span class="ident" id="3283521">fd</span><span class="op" id="3283523">.</span><span class="ident" id="3283524">init</span><span class="op" id="3283528">(</span><span class="op" id="3283529">)</span><span class="op" id="3283530">;</span>&nbsp;<span class="ident" id="3283532">err</span>&nbsp;<span class="op" id="3283536">!=</span>&nbsp;<span class="ident" id="3283539">nil</span>&nbsp;<span class="op" id="3283543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283548">return</span>&nbsp;<span class="ident" id="3283555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283565">return</span>&nbsp;<span class="ident" id="3283572">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283577">case</span>&nbsp;<span class="ident" id="3283582">syscall</span><span class="op" id="3283589">.</span><span class="ident" id="3283590">EINVAL</span><span class="op" id="3283596">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283600">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283652">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283705">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283759">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283813">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283862">if</span>&nbsp;<span class="ident" id="3283865">runtime</span><span class="op" id="3283872">.</span><span class="ident" id="3283873">GOOS</span>&nbsp;<span class="op" id="3283878">==</span>&nbsp;<span class="string" id="3283881">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3283891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283896">return</span>&nbsp;<span class="ident" id="3283903">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283913">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283926">default</span><span class="op" id="3283933">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283937">return</span>&nbsp;<span class="ident" id="3283944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283952">if</span>&nbsp;<span class="ident" id="3283955">err</span>&nbsp;<span class="op" id="3283959">:=</span>&nbsp;<span class="ident" id="3283962">fd</span><span class="op" id="3283964">.</span><span class="ident" id="3283965">init</span><span class="op" id="3283969">(</span><span class="op" id="3283970">)</span><span class="op" id="3283971">;</span>&nbsp;<span class="ident" id="3283973">err</span>&nbsp;<span class="op" id="3283977">!=</span>&nbsp;<span class="ident" id="3283980">nil</span>&nbsp;<span class="op" id="3283984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283988">return</span>&nbsp;<span class="ident" id="3283995">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284003">if</span>&nbsp;<span class="op" id="3284006">!</span><span class="ident" id="3284007">deadline</span><span class="op" id="3284015">.</span><span class="ident" id="3284016">IsZero</span><span class="op" id="3284022">(</span><span class="op" id="3284023">)</span>&nbsp;<span class="op" id="3284025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284029">fd</span><span class="op" id="3284031">.</span><span class="ident" id="3284032">setWriteDeadline</span><span class="op" id="3284048">(</span><span class="ident" id="3284049">deadline</span><span class="op" id="3284057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284061">defer</span>&nbsp;<span class="ident" id="3284067">fd</span><span class="op" id="3284069">.</span><span class="ident" id="3284070">setWriteDeadline</span><span class="op" id="3284086">(</span><span class="ident" id="3284087">noDeadline</span><span class="op" id="3284097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284100">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284103">for</span>&nbsp;<span class="op" id="3284107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284111">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284162">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284216">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284264">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284320">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284375">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284428">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284481">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284495">if</span>&nbsp;<span class="ident" id="3284498">err</span>&nbsp;<span class="op" id="3284502">:=</span>&nbsp;<span class="ident" id="3284505">fd</span><span class="op" id="3284507">.</span><span class="ident" id="3284508">pd</span><span class="op" id="3284510">.</span><span class="ident" id="3284511">WaitWrite</span><span class="op" id="3284520">(</span><span class="op" id="3284521">)</span><span class="op" id="3284522">;</span>&nbsp;<span class="ident" id="3284524">err</span>&nbsp;<span class="op" id="3284528">!=</span>&nbsp;<span class="ident" id="3284531">nil</span>&nbsp;<span class="op" id="3284535">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284540">return</span>&nbsp;<span class="ident" id="3284547">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284557">nerr</span><span class="op" id="3284561">,</span>&nbsp;<span class="ident" id="3284563">err</span>&nbsp;<span class="op" id="3284567">:=</span>&nbsp;<span class="ident" id="3284570">syscall</span><span class="op" id="3284577">.</span><span class="ident" id="3284578">GetsockoptInt</span><span class="op" id="3284591">(</span><span class="ident" id="3284592">fd</span><span class="op" id="3284594">.</span><span class="ident" id="3284595">sysfd</span><span class="op" id="3284600">,</span>&nbsp;<span class="ident" id="3284602">syscall</span><span class="op" id="3284609">.</span><span class="ident" id="3284610">SOL_SOCKET</span><span class="op" id="3284620">,</span>&nbsp;<span class="ident" id="3284622">syscall</span><span class="op" id="3284629">.</span><span class="ident" id="3284630">SO_ERROR</span><span class="op" id="3284638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284642">if</span>&nbsp;<span class="ident" id="3284645">err</span>&nbsp;<span class="op" id="3284649">!=</span>&nbsp;<span class="ident" id="3284652">nil</span>&nbsp;<span class="op" id="3284656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284661">return</span>&nbsp;<span class="ident" id="3284668">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284678">switch</span>&nbsp;<span class="ident" id="3284685">err</span>&nbsp;<span class="op" id="3284689">:=</span>&nbsp;<span class="ident" id="3284692">syscall</span><span class="op" id="3284699">.</span><span class="ident" id="3284700">Errno</span><span class="op" id="3284705">(</span><span class="ident" id="3284706">nerr</span><span class="op" id="3284710">)</span><span class="op" id="3284711">;</span>&nbsp;<span class="ident" id="3284713">err</span>&nbsp;<span class="op" id="3284717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284721">case</span>&nbsp;<span class="ident" id="3284726">syscall</span><span class="op" id="3284733">.</span><span class="ident" id="3284734">EINPROGRESS</span><span class="op" id="3284745">,</span>&nbsp;<span class="ident" id="3284747">syscall</span><span class="op" id="3284754">.</span><span class="ident" id="3284755">EALREADY</span><span class="op" id="3284763">,</span>&nbsp;<span class="ident" id="3284765">syscall</span><span class="op" id="3284772">.</span><span class="ident" id="3284773">EINTR</span><span class="op" id="3284778">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284782">case</span>&nbsp;<span class="ident" id="3284787">syscall</span><span class="op" id="3284794">.</span><span class="ident" id="3284795">Errno</span><span class="op" id="3284800">(</span><span class="num" id="3284801">0</span><span class="op" id="3284802">)</span><span class="op" id="3284803">,</span>&nbsp;<span class="ident" id="3284805">syscall</span><span class="op" id="3284812">.</span><span class="ident" id="3284813">EISCONN</span><span class="op" id="3284820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284825">return</span>&nbsp;<span class="ident" id="3284832">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284838">default</span><span class="op" id="3284845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284850">return</span>&nbsp;<span class="ident" id="3284857">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284866">}</span><br>
<span class="lineno"></span><span class="op" id="3284868">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3284871">func</span>&nbsp;<span class="op" id="3284876">(</span><span class="ident" id="3284877">fd</span>&nbsp;<span class="op" id="3284880">*</span><span class="ident" id="3284881">netFD</span><span class="op" id="3284886">)</span>&nbsp;<span class="ident" id="3284888">destroy</span><span class="op" id="3284895">(</span><span class="op" id="3284896">)</span>&nbsp;<span class="op" id="3284898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284901">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284975">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285024">fd</span><span class="op" id="3285026">.</span><span class="ident" id="3285027">pd</span><span class="op" id="3285029">.</span><span class="ident" id="3285030">Close</span><span class="op" id="3285035">(</span><span class="op" id="3285036">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285039">closesocket</span><span class="op" id="3285050">(</span><span class="ident" id="3285051">fd</span><span class="op" id="3285053">.</span><span class="ident" id="3285054">sysfd</span><span class="op" id="3285059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285062">fd</span><span class="op" id="3285064">.</span><span class="ident" id="3285065">sysfd</span>&nbsp;<span class="op" id="3285071">=</span>&nbsp;<span class="op" id="3285073">-</span><span class="num" id="3285074">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285077">runtime</span><span class="op" id="3285084">.</span><span class="ident" id="3285085">SetFinalizer</span><span class="op" id="3285097">(</span><span class="ident" id="3285098">fd</span><span class="op" id="3285100">,</span>&nbsp;<span class="ident" id="3285102">nil</span><span class="op" id="3285105">)</span><br>
<span class="lineno"></span><span class="op" id="3285107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3285110">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3285141">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3285187">func</span>&nbsp;<span class="op" id="3285192">(</span><span class="ident" id="3285193">fd</span>&nbsp;<span class="op" id="3285196">*</span><span class="ident" id="3285197">netFD</span><span class="op" id="3285202">)</span>&nbsp;<span class="ident" id="3285204">incref</span><span class="op" id="3285210">(</span><span class="op" id="3285211">)</span>&nbsp;<span class="builtintype" id="3285213">error</span>&nbsp;<span class="op" id="3285219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285222">if</span>&nbsp;<span class="op" id="3285225">!</span><span class="ident" id="3285226">fd</span><span class="op" id="3285228">.</span><span class="ident" id="3285229">fdmu</span><span class="op" id="3285233">.</span><span class="ident" id="3285234">Incref</span><span class="op" id="3285240">(</span><span class="op" id="3285241">)</span>&nbsp;<span class="op" id="3285243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285247">return</span>&nbsp;<span class="ident" id="3285254">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285269">return</span>&nbsp;<span class="ident" id="3285276">nil</span><br>
<span class="lineno"></span><span class="op" id="3285280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3285283">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3285355">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3285394">func</span>&nbsp;<span class="op" id="3285399">(</span><span class="ident" id="3285400">fd</span>&nbsp;<span class="op" id="3285403">*</span><span class="ident" id="3285404">netFD</span><span class="op" id="3285409">)</span>&nbsp;<span class="ident" id="3285411">decref</span><span class="op" id="3285417">(</span><span class="op" id="3285418">)</span>&nbsp;<span class="op" id="3285420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285423">if</span>&nbsp;<span class="ident" id="3285426">fd</span><span class="op" id="3285428">.</span><span class="ident" id="3285429">fdmu</span><span class="op" id="3285433">.</span><span class="ident" id="3285434">Decref</span><span class="op" id="3285440">(</span><span class="op" id="3285441">)</span>&nbsp;<span class="op" id="3285443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285447">fd</span><span class="op" id="3285449">.</span><span class="ident" id="3285450">destroy</span><span class="op" id="3285457">(</span><span class="op" id="3285458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285461">}</span><br>
<span class="lineno">155</span><span class="op" id="3285463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3285466">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3285518">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3285564">func</span>&nbsp;<span class="op" id="3285569">(</span><span class="ident" id="3285570">fd</span>&nbsp;<span class="op" id="3285573">*</span><span class="ident" id="3285574">netFD</span><span class="op" id="3285579">)</span>&nbsp;<span class="ident" id="3285581">readLock</span><span class="op" id="3285589">(</span><span class="op" id="3285590">)</span>&nbsp;<span class="builtintype" id="3285592">error</span>&nbsp;<span class="op" id="3285598">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285601">if</span>&nbsp;<span class="op" id="3285604">!</span><span class="ident" id="3285605">fd</span><span class="op" id="3285607">.</span><span class="ident" id="3285608">fdmu</span><span class="op" id="3285612">.</span><span class="ident" id="3285613">RWLock</span><span class="op" id="3285619">(</span><span class="builtintype" id="3285620">true</span><span class="op" id="3285624">)</span>&nbsp;<span class="op" id="3285626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285630">return</span>&nbsp;<span class="ident" id="3285637">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285652">return</span>&nbsp;<span class="ident" id="3285659">nil</span><br>
<span class="lineno"></span><span class="op" id="3285663">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3285666">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3285723">func</span>&nbsp;<span class="op" id="3285728">(</span><span class="ident" id="3285729">fd</span>&nbsp;<span class="op" id="3285732">*</span><span class="ident" id="3285733">netFD</span><span class="op" id="3285738">)</span>&nbsp;<span class="ident" id="3285740">readUnlock</span><span class="op" id="3285750">(</span><span class="op" id="3285751">)</span>&nbsp;<span class="op" id="3285753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285756">if</span>&nbsp;<span class="ident" id="3285759">fd</span><span class="op" id="3285761">.</span><span class="ident" id="3285762">fdmu</span><span class="op" id="3285766">.</span><span class="ident" id="3285767">RWUnlock</span><span class="op" id="3285775">(</span><span class="builtintype" id="3285776">true</span><span class="op" id="3285780">)</span>&nbsp;<span class="op" id="3285782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285786">fd</span><span class="op" id="3285788">.</span><span class="ident" id="3285789">destroy</span><span class="op" id="3285796">(</span><span class="op" id="3285797">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285800">}</span><br>
<span class="lineno"></span><span class="op" id="3285802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3285805">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3285857">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3285903">func</span>&nbsp;<span class="op" id="3285908">(</span><span class="ident" id="3285909">fd</span>&nbsp;<span class="op" id="3285912">*</span><span class="ident" id="3285913">netFD</span><span class="op" id="3285918">)</span>&nbsp;<span class="ident" id="3285920">writeLock</span><span class="op" id="3285929">(</span><span class="op" id="3285930">)</span>&nbsp;<span class="builtintype" id="3285932">error</span>&nbsp;<span class="op" id="3285938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285941">if</span>&nbsp;<span class="op" id="3285944">!</span><span class="ident" id="3285945">fd</span><span class="op" id="3285947">.</span><span class="ident" id="3285948">fdmu</span><span class="op" id="3285952">.</span><span class="ident" id="3285953">RWLock</span><span class="op" id="3285959">(</span><span class="builtintype" id="3285960">false</span><span class="op" id="3285965">)</span>&nbsp;<span class="op" id="3285967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285971">return</span>&nbsp;<span class="ident" id="3285978">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285993">return</span>&nbsp;<span class="ident" id="3286000">nil</span><br>
<span class="lineno">180</span><span class="op" id="3286004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3286007">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3286064">func</span>&nbsp;<span class="op" id="3286069">(</span><span class="ident" id="3286070">fd</span>&nbsp;<span class="op" id="3286073">*</span><span class="ident" id="3286074">netFD</span><span class="op" id="3286079">)</span>&nbsp;<span class="ident" id="3286081">writeUnlock</span><span class="op" id="3286092">(</span><span class="op" id="3286093">)</span>&nbsp;<span class="op" id="3286095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286098">if</span>&nbsp;<span class="ident" id="3286101">fd</span><span class="op" id="3286103">.</span><span class="ident" id="3286104">fdmu</span><span class="op" id="3286108">.</span><span class="ident" id="3286109">RWUnlock</span><span class="op" id="3286117">(</span><span class="builtintype" id="3286118">false</span><span class="op" id="3286123">)</span>&nbsp;<span class="op" id="3286125">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286129">fd</span><span class="op" id="3286131">.</span><span class="ident" id="3286132">destroy</span><span class="op" id="3286139">(</span><span class="op" id="3286140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286143">}</span><br>
<span class="lineno"></span><span class="op" id="3286145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3286148">func</span>&nbsp;<span class="op" id="3286153">(</span><span class="ident" id="3286154">fd</span>&nbsp;<span class="op" id="3286157">*</span><span class="ident" id="3286158">netFD</span><span class="op" id="3286163">)</span>&nbsp;<span class="ident" id="3286165">Close</span><span class="op" id="3286170">(</span><span class="op" id="3286171">)</span>&nbsp;<span class="builtintype" id="3286173">error</span>&nbsp;<span class="op" id="3286179">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286182">fd</span><span class="op" id="3286184">.</span><span class="ident" id="3286185">pd</span><span class="op" id="3286187">.</span><span class="ident" id="3286188">Lock</span><span class="op" id="3286192">(</span><span class="op" id="3286193">)</span>&nbsp;<span class="comment" id="3286195">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286250">if</span>&nbsp;<span class="op" id="3286253">!</span><span class="ident" id="3286254">fd</span><span class="op" id="3286256">.</span><span class="ident" id="3286257">fdmu</span><span class="op" id="3286261">.</span><span class="ident" id="3286262">IncrefAndClose</span><span class="op" id="3286276">(</span><span class="op" id="3286277">)</span>&nbsp;<span class="op" id="3286279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286283">fd</span><span class="op" id="3286285">.</span><span class="ident" id="3286286">pd</span><span class="op" id="3286288">.</span><span class="ident" id="3286289">Unlock</span><span class="op" id="3286295">(</span><span class="op" id="3286296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286300">return</span>&nbsp;<span class="ident" id="3286307">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286319">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3286322">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3286378">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3286434">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3286496">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3286559">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286621">doWakeup</span>&nbsp;<span class="op" id="3286630">:=</span>&nbsp;<span class="ident" id="3286633">fd</span><span class="op" id="3286635">.</span><span class="ident" id="3286636">pd</span><span class="op" id="3286638">.</span><span class="ident" id="3286639">Evict</span><span class="op" id="3286644">(</span><span class="op" id="3286645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286648">fd</span><span class="op" id="3286650">.</span><span class="ident" id="3286651">pd</span><span class="op" id="3286653">.</span><span class="ident" id="3286654">Unlock</span><span class="op" id="3286660">(</span><span class="op" id="3286661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286664">fd</span><span class="op" id="3286666">.</span><span class="ident" id="3286667">decref</span><span class="op" id="3286673">(</span><span class="op" id="3286674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286677">if</span>&nbsp;<span class="ident" id="3286680">doWakeup</span>&nbsp;<span class="op" id="3286689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286693">fd</span><span class="op" id="3286695">.</span><span class="ident" id="3286696">pd</span><span class="op" id="3286698">.</span><span class="ident" id="3286699">Wakeup</span><span class="op" id="3286705">(</span><span class="op" id="3286706">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286712">return</span>&nbsp;<span class="ident" id="3286719">nil</span><br>
<span class="lineno"></span><span class="op" id="3286723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3286726">func</span>&nbsp;<span class="op" id="3286731">(</span><span class="ident" id="3286732">fd</span>&nbsp;<span class="op" id="3286735">*</span><span class="ident" id="3286736">netFD</span><span class="op" id="3286741">)</span>&nbsp;<span class="ident" id="3286743">shutdown</span><span class="op" id="3286751">(</span><span class="ident" id="3286752">how</span>&nbsp;<span class="builtintype" id="3286756">int</span><span class="op" id="3286759">)</span>&nbsp;<span class="builtintype" id="3286761">error</span>&nbsp;<span class="op" id="3286767">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286770">if</span>&nbsp;<span class="ident" id="3286773">err</span>&nbsp;<span class="op" id="3286777">:=</span>&nbsp;<span class="ident" id="3286780">fd</span><span class="op" id="3286782">.</span><span class="ident" id="3286783">incref</span><span class="op" id="3286789">(</span><span class="op" id="3286790">)</span><span class="op" id="3286791">;</span>&nbsp;<span class="ident" id="3286793">err</span>&nbsp;<span class="op" id="3286797">!=</span>&nbsp;<span class="ident" id="3286800">nil</span>&nbsp;<span class="op" id="3286804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286808">return</span>&nbsp;<span class="ident" id="3286815">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286823">defer</span>&nbsp;<span class="ident" id="3286829">fd</span><span class="op" id="3286831">.</span><span class="ident" id="3286832">decref</span><span class="op" id="3286838">(</span><span class="op" id="3286839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286842">err</span>&nbsp;<span class="op" id="3286846">:=</span>&nbsp;<span class="ident" id="3286849">syscall</span><span class="op" id="3286856">.</span><span class="ident" id="3286857">Shutdown</span><span class="op" id="3286865">(</span><span class="ident" id="3286866">fd</span><span class="op" id="3286868">.</span><span class="ident" id="3286869">sysfd</span><span class="op" id="3286874">,</span>&nbsp;<span class="ident" id="3286876">how</span><span class="op" id="3286879">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286882">if</span>&nbsp;<span class="ident" id="3286885">err</span>&nbsp;<span class="op" id="3286889">!=</span>&nbsp;<span class="ident" id="3286892">nil</span>&nbsp;<span class="op" id="3286896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286900">return</span>&nbsp;<span class="op" id="3286907">&amp;</span><span class="ident" id="3286908">OpError</span><span class="op" id="3286915">{</span><span class="string" id="3286916">&#34;shutdown&#34;</span><span class="op" id="3286926">,</span>&nbsp;<span class="ident" id="3286928">fd</span><span class="op" id="3286930">.</span><span class="ident" id="3286931">net</span><span class="op" id="3286934">,</span>&nbsp;<span class="ident" id="3286936">fd</span><span class="op" id="3286938">.</span><span class="ident" id="3286939">laddr</span><span class="op" id="3286944">,</span>&nbsp;<span class="ident" id="3286946">err</span><span class="op" id="3286949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286955">return</span>&nbsp;<span class="ident" id="3286962">nil</span><br>
<span class="lineno"></span><span class="op" id="3286966">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3286969">func</span>&nbsp;<span class="op" id="3286974">(</span><span class="ident" id="3286975">fd</span>&nbsp;<span class="op" id="3286978">*</span><span class="ident" id="3286979">netFD</span><span class="op" id="3286984">)</span>&nbsp;<span class="ident" id="3286986">closeRead</span><span class="op" id="3286995">(</span><span class="op" id="3286996">)</span>&nbsp;<span class="builtintype" id="3286998">error</span>&nbsp;<span class="op" id="3287004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287007">return</span>&nbsp;<span class="ident" id="3287014">fd</span><span class="op" id="3287016">.</span><span class="ident" id="3287017">shutdown</span><span class="op" id="3287025">(</span><span class="ident" id="3287026">syscall</span><span class="op" id="3287033">.</span><span class="ident" id="3287034">SHUT_RD</span><span class="op" id="3287041">)</span><br>
<span class="lineno"></span><span class="op" id="3287043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3287046">func</span>&nbsp;<span class="op" id="3287051">(</span><span class="ident" id="3287052">fd</span>&nbsp;<span class="op" id="3287055">*</span><span class="ident" id="3287056">netFD</span><span class="op" id="3287061">)</span>&nbsp;<span class="ident" id="3287063">closeWrite</span><span class="op" id="3287073">(</span><span class="op" id="3287074">)</span>&nbsp;<span class="builtintype" id="3287076">error</span>&nbsp;<span class="op" id="3287082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287085">return</span>&nbsp;<span class="ident" id="3287092">fd</span><span class="op" id="3287094">.</span><span class="ident" id="3287095">shutdown</span><span class="op" id="3287103">(</span><span class="ident" id="3287104">syscall</span><span class="op" id="3287111">.</span><span class="ident" id="3287112">SHUT_WR</span><span class="op" id="3287119">)</span><br>
<span class="lineno"></span><span class="op" id="3287121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3287124">func</span>&nbsp;<span class="op" id="3287129">(</span><span class="ident" id="3287130">fd</span>&nbsp;<span class="op" id="3287133">*</span><span class="ident" id="3287134">netFD</span><span class="op" id="3287139">)</span>&nbsp;<span class="ident" id="3287141">Read</span><span class="op" id="3287145">(</span><span class="ident" id="3287146">p</span>&nbsp;<span class="op" id="3287148">[</span><span class="op" id="3287149">]</span><span class="builtintype" id="3287150">byte</span><span class="op" id="3287154">)</span>&nbsp;<span class="op" id="3287156">(</span><span class="ident" id="3287157">n</span>&nbsp;<span class="builtintype" id="3287159">int</span><span class="op" id="3287162">,</span>&nbsp;<span class="ident" id="3287164">err</span>&nbsp;<span class="builtintype" id="3287168">error</span><span class="op" id="3287173">)</span>&nbsp;<span class="op" id="3287175">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287178">if</span>&nbsp;<span class="ident" id="3287181">err</span>&nbsp;<span class="op" id="3287185">:=</span>&nbsp;<span class="ident" id="3287188">fd</span><span class="op" id="3287190">.</span><span class="ident" id="3287191">readLock</span><span class="op" id="3287199">(</span><span class="op" id="3287200">)</span><span class="op" id="3287201">;</span>&nbsp;<span class="ident" id="3287203">err</span>&nbsp;<span class="op" id="3287207">!=</span>&nbsp;<span class="ident" id="3287210">nil</span>&nbsp;<span class="op" id="3287214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287218">return</span>&nbsp;<span class="num" id="3287225">0</span><span class="op" id="3287226">,</span>&nbsp;<span class="ident" id="3287228">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287236">defer</span>&nbsp;<span class="ident" id="3287242">fd</span><span class="op" id="3287244">.</span><span class="ident" id="3287245">readUnlock</span><span class="op" id="3287255">(</span><span class="op" id="3287256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287259">if</span>&nbsp;<span class="ident" id="3287262">err</span>&nbsp;<span class="op" id="3287266">:=</span>&nbsp;<span class="ident" id="3287269">fd</span><span class="op" id="3287271">.</span><span class="ident" id="3287272">pd</span><span class="op" id="3287274">.</span><span class="ident" id="3287275">PrepareRead</span><span class="op" id="3287286">(</span><span class="op" id="3287287">)</span><span class="op" id="3287288">;</span>&nbsp;<span class="ident" id="3287290">err</span>&nbsp;<span class="op" id="3287294">!=</span>&nbsp;<span class="ident" id="3287297">nil</span>&nbsp;<span class="op" id="3287301">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287305">return</span>&nbsp;<span class="num" id="3287312">0</span><span class="op" id="3287313">,</span>&nbsp;<span class="op" id="3287315">&amp;</span><span class="ident" id="3287316">OpError</span><span class="op" id="3287323">{</span><span class="string" id="3287324">&#34;read&#34;</span><span class="op" id="3287330">,</span>&nbsp;<span class="ident" id="3287332">fd</span><span class="op" id="3287334">.</span><span class="ident" id="3287335">net</span><span class="op" id="3287338">,</span>&nbsp;<span class="ident" id="3287340">fd</span><span class="op" id="3287342">.</span><span class="ident" id="3287343">raddr</span><span class="op" id="3287348">,</span>&nbsp;<span class="ident" id="3287350">err</span><span class="op" id="3287353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287359">for</span>&nbsp;<span class="op" id="3287363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287367">n</span><span class="op" id="3287368">,</span>&nbsp;<span class="ident" id="3287370">err</span>&nbsp;<span class="op" id="3287374">=</span>&nbsp;<span class="ident" id="3287376">syscall</span><span class="op" id="3287383">.</span><span class="ident" id="3287384">Read</span><span class="op" id="3287388">(</span><span class="builtintype" id="3287389">int</span><span class="op" id="3287392">(</span><span class="ident" id="3287393">fd</span><span class="op" id="3287395">.</span><span class="ident" id="3287396">sysfd</span><span class="op" id="3287401">)</span><span class="op" id="3287402">,</span>&nbsp;<span class="ident" id="3287404">p</span><span class="op" id="3287405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287409">if</span>&nbsp;<span class="ident" id="3287412">err</span>&nbsp;<span class="op" id="3287416">!=</span>&nbsp;<span class="ident" id="3287419">nil</span>&nbsp;<span class="op" id="3287423">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287428">n</span>&nbsp;<span class="op" id="3287430">=</span>&nbsp;<span class="num" id="3287432">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287437">if</span>&nbsp;<span class="ident" id="3287440">err</span>&nbsp;<span class="op" id="3287444">==</span>&nbsp;<span class="ident" id="3287447">syscall</span><span class="op" id="3287454">.</span><span class="ident" id="3287455">EAGAIN</span>&nbsp;<span class="op" id="3287462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287468">if</span>&nbsp;<span class="ident" id="3287471">err</span>&nbsp;<span class="op" id="3287475">=</span>&nbsp;<span class="ident" id="3287477">fd</span><span class="op" id="3287479">.</span><span class="ident" id="3287480">pd</span><span class="op" id="3287482">.</span><span class="ident" id="3287483">WaitRead</span><span class="op" id="3287491">(</span><span class="op" id="3287492">)</span><span class="op" id="3287493">;</span>&nbsp;<span class="ident" id="3287495">err</span>&nbsp;<span class="op" id="3287499">==</span>&nbsp;<span class="ident" id="3287502">nil</span>&nbsp;<span class="op" id="3287506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287513">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287526">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287539">err</span>&nbsp;<span class="op" id="3287543">=</span>&nbsp;<span class="ident" id="3287545">chkReadErr</span><span class="op" id="3287555">(</span><span class="ident" id="3287556">n</span><span class="op" id="3287557">,</span>&nbsp;<span class="ident" id="3287559">err</span><span class="op" id="3287562">,</span>&nbsp;<span class="ident" id="3287564">fd</span><span class="op" id="3287566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287570">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287577">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287580">if</span>&nbsp;<span class="ident" id="3287583">err</span>&nbsp;<span class="op" id="3287587">!=</span>&nbsp;<span class="ident" id="3287590">nil</span>&nbsp;<span class="op" id="3287594">&amp;&amp;</span>&nbsp;<span class="ident" id="3287597">err</span>&nbsp;<span class="op" id="3287601">!=</span>&nbsp;<span class="ident" id="3287604">io</span><span class="op" id="3287606">.</span><span class="ident" id="3287607">EOF</span>&nbsp;<span class="op" id="3287611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287615">err</span>&nbsp;<span class="op" id="3287619">=</span>&nbsp;<span class="op" id="3287621">&amp;</span><span class="ident" id="3287622">OpError</span><span class="op" id="3287629">{</span><span class="string" id="3287630">&#34;read&#34;</span><span class="op" id="3287636">,</span>&nbsp;<span class="ident" id="3287638">fd</span><span class="op" id="3287640">.</span><span class="ident" id="3287641">net</span><span class="op" id="3287644">,</span>&nbsp;<span class="ident" id="3287646">fd</span><span class="op" id="3287648">.</span><span class="ident" id="3287649">raddr</span><span class="op" id="3287654">,</span>&nbsp;<span class="ident" id="3287656">err</span><span class="op" id="3287659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287665">return</span><br>
<span class="lineno"></span><span class="op" id="3287672">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3287675">func</span>&nbsp;<span class="op" id="3287680">(</span><span class="ident" id="3287681">fd</span>&nbsp;<span class="op" id="3287684">*</span><span class="ident" id="3287685">netFD</span><span class="op" id="3287690">)</span>&nbsp;<span class="ident" id="3287692">readFrom</span><span class="op" id="3287700">(</span><span class="ident" id="3287701">p</span>&nbsp;<span class="op" id="3287703">[</span><span class="op" id="3287704">]</span><span class="builtintype" id="3287705">byte</span><span class="op" id="3287709">)</span>&nbsp;<span class="op" id="3287711">(</span><span class="ident" id="3287712">n</span>&nbsp;<span class="builtintype" id="3287714">int</span><span class="op" id="3287717">,</span>&nbsp;<span class="ident" id="3287719">sa</span>&nbsp;<span class="ident" id="3287722">syscall</span><span class="op" id="3287729">.</span><span class="ident" id="3287730">Sockaddr</span><span class="op" id="3287738">,</span>&nbsp;<span class="ident" id="3287740">err</span>&nbsp;<span class="builtintype" id="3287744">error</span><span class="op" id="3287749">)</span>&nbsp;<span class="op" id="3287751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287754">if</span>&nbsp;<span class="ident" id="3287757">err</span>&nbsp;<span class="op" id="3287761">:=</span>&nbsp;<span class="ident" id="3287764">fd</span><span class="op" id="3287766">.</span><span class="ident" id="3287767">readLock</span><span class="op" id="3287775">(</span><span class="op" id="3287776">)</span><span class="op" id="3287777">;</span>&nbsp;<span class="ident" id="3287779">err</span>&nbsp;<span class="op" id="3287783">!=</span>&nbsp;<span class="ident" id="3287786">nil</span>&nbsp;<span class="op" id="3287790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287794">return</span>&nbsp;<span class="num" id="3287801">0</span><span class="op" id="3287802">,</span>&nbsp;<span class="ident" id="3287804">nil</span><span class="op" id="3287807">,</span>&nbsp;<span class="ident" id="3287809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287814">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287817">defer</span>&nbsp;<span class="ident" id="3287823">fd</span><span class="op" id="3287825">.</span><span class="ident" id="3287826">readUnlock</span><span class="op" id="3287836">(</span><span class="op" id="3287837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287840">if</span>&nbsp;<span class="ident" id="3287843">err</span>&nbsp;<span class="op" id="3287847">:=</span>&nbsp;<span class="ident" id="3287850">fd</span><span class="op" id="3287852">.</span><span class="ident" id="3287853">pd</span><span class="op" id="3287855">.</span><span class="ident" id="3287856">PrepareRead</span><span class="op" id="3287867">(</span><span class="op" id="3287868">)</span><span class="op" id="3287869">;</span>&nbsp;<span class="ident" id="3287871">err</span>&nbsp;<span class="op" id="3287875">!=</span>&nbsp;<span class="ident" id="3287878">nil</span>&nbsp;<span class="op" id="3287882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287886">return</span>&nbsp;<span class="num" id="3287893">0</span><span class="op" id="3287894">,</span>&nbsp;<span class="ident" id="3287896">nil</span><span class="op" id="3287899">,</span>&nbsp;<span class="op" id="3287901">&amp;</span><span class="ident" id="3287902">OpError</span><span class="op" id="3287909">{</span><span class="string" id="3287910">&#34;read&#34;</span><span class="op" id="3287916">,</span>&nbsp;<span class="ident" id="3287918">fd</span><span class="op" id="3287920">.</span><span class="ident" id="3287921">net</span><span class="op" id="3287924">,</span>&nbsp;<span class="ident" id="3287926">fd</span><span class="op" id="3287928">.</span><span class="ident" id="3287929">laddr</span><span class="op" id="3287934">,</span>&nbsp;<span class="ident" id="3287936">err</span><span class="op" id="3287939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287945">for</span>&nbsp;<span class="op" id="3287949">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287953">n</span><span class="op" id="3287954">,</span>&nbsp;<span class="ident" id="3287956">sa</span><span class="op" id="3287958">,</span>&nbsp;<span class="ident" id="3287960">err</span>&nbsp;<span class="op" id="3287964">=</span>&nbsp;<span class="ident" id="3287966">syscall</span><span class="op" id="3287973">.</span><span class="ident" id="3287974">Recvfrom</span><span class="op" id="3287982">(</span><span class="ident" id="3287983">fd</span><span class="op" id="3287985">.</span><span class="ident" id="3287986">sysfd</span><span class="op" id="3287991">,</span>&nbsp;<span class="ident" id="3287993">p</span><span class="op" id="3287994">,</span>&nbsp;<span class="num" id="3287996">0</span><span class="op" id="3287997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288001">if</span>&nbsp;<span class="ident" id="3288004">err</span>&nbsp;<span class="op" id="3288008">!=</span>&nbsp;<span class="ident" id="3288011">nil</span>&nbsp;<span class="op" id="3288015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288020">n</span>&nbsp;<span class="op" id="3288022">=</span>&nbsp;<span class="num" id="3288024">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288029">if</span>&nbsp;<span class="ident" id="3288032">err</span>&nbsp;<span class="op" id="3288036">==</span>&nbsp;<span class="ident" id="3288039">syscall</span><span class="op" id="3288046">.</span><span class="ident" id="3288047">EAGAIN</span>&nbsp;<span class="op" id="3288054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288060">if</span>&nbsp;<span class="ident" id="3288063">err</span>&nbsp;<span class="op" id="3288067">=</span>&nbsp;<span class="ident" id="3288069">fd</span><span class="op" id="3288071">.</span><span class="ident" id="3288072">pd</span><span class="op" id="3288074">.</span><span class="ident" id="3288075">WaitRead</span><span class="op" id="3288083">(</span><span class="op" id="3288084">)</span><span class="op" id="3288085">;</span>&nbsp;<span class="ident" id="3288087">err</span>&nbsp;<span class="op" id="3288091">==</span>&nbsp;<span class="ident" id="3288094">nil</span>&nbsp;<span class="op" id="3288098">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288105">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288131">err</span>&nbsp;<span class="op" id="3288135">=</span>&nbsp;<span class="ident" id="3288137">chkReadErr</span><span class="op" id="3288147">(</span><span class="ident" id="3288148">n</span><span class="op" id="3288149">,</span>&nbsp;<span class="ident" id="3288151">err</span><span class="op" id="3288154">,</span>&nbsp;<span class="ident" id="3288156">fd</span><span class="op" id="3288158">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288162">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288172">if</span>&nbsp;<span class="ident" id="3288175">err</span>&nbsp;<span class="op" id="3288179">!=</span>&nbsp;<span class="ident" id="3288182">nil</span>&nbsp;<span class="op" id="3288186">&amp;&amp;</span>&nbsp;<span class="ident" id="3288189">err</span>&nbsp;<span class="op" id="3288193">!=</span>&nbsp;<span class="ident" id="3288196">io</span><span class="op" id="3288198">.</span><span class="ident" id="3288199">EOF</span>&nbsp;<span class="op" id="3288203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288207">err</span>&nbsp;<span class="op" id="3288211">=</span>&nbsp;<span class="op" id="3288213">&amp;</span><span class="ident" id="3288214">OpError</span><span class="op" id="3288221">{</span><span class="string" id="3288222">&#34;read&#34;</span><span class="op" id="3288228">,</span>&nbsp;<span class="ident" id="3288230">fd</span><span class="op" id="3288232">.</span><span class="ident" id="3288233">net</span><span class="op" id="3288236">,</span>&nbsp;<span class="ident" id="3288238">fd</span><span class="op" id="3288240">.</span><span class="ident" id="3288241">laddr</span><span class="op" id="3288246">,</span>&nbsp;<span class="ident" id="3288248">err</span><span class="op" id="3288251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288254">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288257">return</span><br>
<span class="lineno"></span><span class="op" id="3288264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3288267">func</span>&nbsp;<span class="op" id="3288272">(</span><span class="ident" id="3288273">fd</span>&nbsp;<span class="op" id="3288276">*</span><span class="ident" id="3288277">netFD</span><span class="op" id="3288282">)</span>&nbsp;<span class="ident" id="3288284">readMsg</span><span class="op" id="3288291">(</span><span class="ident" id="3288292">p</span>&nbsp;<span class="op" id="3288294">[</span><span class="op" id="3288295">]</span><span class="builtintype" id="3288296">byte</span><span class="op" id="3288300">,</span>&nbsp;<span class="ident" id="3288302">oob</span>&nbsp;<span class="op" id="3288306">[</span><span class="op" id="3288307">]</span><span class="builtintype" id="3288308">byte</span><span class="op" id="3288312">)</span>&nbsp;<span class="op" id="3288314">(</span><span class="ident" id="3288315">n</span><span class="op" id="3288316">,</span>&nbsp;<span class="ident" id="3288318">oobn</span><span class="op" id="3288322">,</span>&nbsp;<span class="ident" id="3288324">flags</span>&nbsp;<span class="builtintype" id="3288330">int</span><span class="op" id="3288333">,</span>&nbsp;<span class="ident" id="3288335">sa</span>&nbsp;<span class="ident" id="3288338">syscall</span><span class="op" id="3288345">.</span><span class="ident" id="3288346">Sockaddr</span><span class="op" id="3288354">,</span>&nbsp;<span class="ident" id="3288356">err</span>&nbsp;<span class="builtintype" id="3288360">error</span><span class="op" id="3288365">)</span>&nbsp;<span class="op" id="3288367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288370">if</span>&nbsp;<span class="ident" id="3288373">err</span>&nbsp;<span class="op" id="3288377">:=</span>&nbsp;<span class="ident" id="3288380">fd</span><span class="op" id="3288382">.</span><span class="ident" id="3288383">readLock</span><span class="op" id="3288391">(</span><span class="op" id="3288392">)</span><span class="op" id="3288393">;</span>&nbsp;<span class="ident" id="3288395">err</span>&nbsp;<span class="op" id="3288399">!=</span>&nbsp;<span class="ident" id="3288402">nil</span>&nbsp;<span class="op" id="3288406">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288410">return</span>&nbsp;<span class="num" id="3288417">0</span><span class="op" id="3288418">,</span>&nbsp;<span class="num" id="3288420">0</span><span class="op" id="3288421">,</span>&nbsp;<span class="num" id="3288423">0</span><span class="op" id="3288424">,</span>&nbsp;<span class="ident" id="3288426">nil</span><span class="op" id="3288429">,</span>&nbsp;<span class="ident" id="3288431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288439">defer</span>&nbsp;<span class="ident" id="3288445">fd</span><span class="op" id="3288447">.</span><span class="ident" id="3288448">readUnlock</span><span class="op" id="3288458">(</span><span class="op" id="3288459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288462">if</span>&nbsp;<span class="ident" id="3288465">err</span>&nbsp;<span class="op" id="3288469">:=</span>&nbsp;<span class="ident" id="3288472">fd</span><span class="op" id="3288474">.</span><span class="ident" id="3288475">pd</span><span class="op" id="3288477">.</span><span class="ident" id="3288478">PrepareRead</span><span class="op" id="3288489">(</span><span class="op" id="3288490">)</span><span class="op" id="3288491">;</span>&nbsp;<span class="ident" id="3288493">err</span>&nbsp;<span class="op" id="3288497">!=</span>&nbsp;<span class="ident" id="3288500">nil</span>&nbsp;<span class="op" id="3288504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288508">return</span>&nbsp;<span class="num" id="3288515">0</span><span class="op" id="3288516">,</span>&nbsp;<span class="num" id="3288518">0</span><span class="op" id="3288519">,</span>&nbsp;<span class="num" id="3288521">0</span><span class="op" id="3288522">,</span>&nbsp;<span class="ident" id="3288524">nil</span><span class="op" id="3288527">,</span>&nbsp;<span class="op" id="3288529">&amp;</span><span class="ident" id="3288530">OpError</span><span class="op" id="3288537">{</span><span class="string" id="3288538">&#34;read&#34;</span><span class="op" id="3288544">,</span>&nbsp;<span class="ident" id="3288546">fd</span><span class="op" id="3288548">.</span><span class="ident" id="3288549">net</span><span class="op" id="3288552">,</span>&nbsp;<span class="ident" id="3288554">fd</span><span class="op" id="3288556">.</span><span class="ident" id="3288557">laddr</span><span class="op" id="3288562">,</span>&nbsp;<span class="ident" id="3288564">err</span><span class="op" id="3288567">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288573">for</span>&nbsp;<span class="op" id="3288577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288581">n</span><span class="op" id="3288582">,</span>&nbsp;<span class="ident" id="3288584">oobn</span><span class="op" id="3288588">,</span>&nbsp;<span class="ident" id="3288590">flags</span><span class="op" id="3288595">,</span>&nbsp;<span class="ident" id="3288597">sa</span><span class="op" id="3288599">,</span>&nbsp;<span class="ident" id="3288601">err</span>&nbsp;<span class="op" id="3288605">=</span>&nbsp;<span class="ident" id="3288607">syscall</span><span class="op" id="3288614">.</span><span class="ident" id="3288615">Recvmsg</span><span class="op" id="3288622">(</span><span class="ident" id="3288623">fd</span><span class="op" id="3288625">.</span><span class="ident" id="3288626">sysfd</span><span class="op" id="3288631">,</span>&nbsp;<span class="ident" id="3288633">p</span><span class="op" id="3288634">,</span>&nbsp;<span class="ident" id="3288636">oob</span><span class="op" id="3288639">,</span>&nbsp;<span class="num" id="3288641">0</span><span class="op" id="3288642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288646">if</span>&nbsp;<span class="ident" id="3288649">err</span>&nbsp;<span class="op" id="3288653">!=</span>&nbsp;<span class="ident" id="3288656">nil</span>&nbsp;<span class="op" id="3288660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3288665">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288711">if</span>&nbsp;<span class="ident" id="3288714">err</span>&nbsp;<span class="op" id="3288718">==</span>&nbsp;<span class="ident" id="3288721">syscall</span><span class="op" id="3288728">.</span><span class="ident" id="3288729">EAGAIN</span>&nbsp;<span class="op" id="3288736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288742">if</span>&nbsp;<span class="ident" id="3288745">err</span>&nbsp;<span class="op" id="3288749">=</span>&nbsp;<span class="ident" id="3288751">fd</span><span class="op" id="3288753">.</span><span class="ident" id="3288754">pd</span><span class="op" id="3288756">.</span><span class="ident" id="3288757">WaitRead</span><span class="op" id="3288765">(</span><span class="op" id="3288766">)</span><span class="op" id="3288767">;</span>&nbsp;<span class="ident" id="3288769">err</span>&nbsp;<span class="op" id="3288773">==</span>&nbsp;<span class="ident" id="3288776">nil</span>&nbsp;<span class="op" id="3288780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288787">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288805">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288813">err</span>&nbsp;<span class="op" id="3288817">=</span>&nbsp;<span class="ident" id="3288819">chkReadErr</span><span class="op" id="3288829">(</span><span class="ident" id="3288830">n</span><span class="op" id="3288831">,</span>&nbsp;<span class="ident" id="3288833">err</span><span class="op" id="3288836">,</span>&nbsp;<span class="ident" id="3288838">fd</span><span class="op" id="3288840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288844">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288854">if</span>&nbsp;<span class="ident" id="3288857">err</span>&nbsp;<span class="op" id="3288861">!=</span>&nbsp;<span class="ident" id="3288864">nil</span>&nbsp;<span class="op" id="3288868">&amp;&amp;</span>&nbsp;<span class="ident" id="3288871">err</span>&nbsp;<span class="op" id="3288875">!=</span>&nbsp;<span class="ident" id="3288878">io</span><span class="op" id="3288880">.</span><span class="ident" id="3288881">EOF</span>&nbsp;<span class="op" id="3288885">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288889">err</span>&nbsp;<span class="op" id="3288893">=</span>&nbsp;<span class="op" id="3288895">&amp;</span><span class="ident" id="3288896">OpError</span><span class="op" id="3288903">{</span><span class="string" id="3288904">&#34;read&#34;</span><span class="op" id="3288910">,</span>&nbsp;<span class="ident" id="3288912">fd</span><span class="op" id="3288914">.</span><span class="ident" id="3288915">net</span><span class="op" id="3288918">,</span>&nbsp;<span class="ident" id="3288920">fd</span><span class="op" id="3288922">.</span><span class="ident" id="3288923">laddr</span><span class="op" id="3288928">,</span>&nbsp;<span class="ident" id="3288930">err</span><span class="op" id="3288933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288939">return</span><br>
<span class="lineno"></span><span class="op" id="3288946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3288949">func</span>&nbsp;<span class="ident" id="3288954">chkReadErr</span><span class="op" id="3288964">(</span><span class="ident" id="3288965">n</span>&nbsp;<span class="builtintype" id="3288967">int</span><span class="op" id="3288970">,</span>&nbsp;<span class="ident" id="3288972">err</span>&nbsp;<span class="builtintype" id="3288976">error</span><span class="op" id="3288981">,</span>&nbsp;<span class="ident" id="3288983">fd</span>&nbsp;<span class="op" id="3288986">*</span><span class="ident" id="3288987">netFD</span><span class="op" id="3288992">)</span>&nbsp;<span class="builtintype" id="3288994">error</span>&nbsp;<span class="op" id="3289000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289003">if</span>&nbsp;<span class="ident" id="3289006">n</span>&nbsp;<span class="op" id="3289008">==</span>&nbsp;<span class="num" id="3289011">0</span>&nbsp;<span class="op" id="3289013">&amp;&amp;</span>&nbsp;<span class="ident" id="3289016">err</span>&nbsp;<span class="op" id="3289020">==</span>&nbsp;<span class="ident" id="3289023">nil</span>&nbsp;<span class="op" id="3289027">&amp;&amp;</span>&nbsp;<span class="ident" id="3289030">fd</span><span class="op" id="3289032">.</span><span class="ident" id="3289033">sotype</span>&nbsp;<span class="op" id="3289040">!=</span>&nbsp;<span class="ident" id="3289043">syscall</span><span class="op" id="3289050">.</span><span class="ident" id="3289051">SOCK_DGRAM</span>&nbsp;<span class="op" id="3289062">&amp;&amp;</span>&nbsp;<span class="ident" id="3289065">fd</span><span class="op" id="3289067">.</span><span class="ident" id="3289068">sotype</span>&nbsp;<span class="op" id="3289075">!=</span>&nbsp;<span class="ident" id="3289078">syscall</span><span class="op" id="3289085">.</span><span class="ident" id="3289086">SOCK_RAW</span>&nbsp;<span class="op" id="3289095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289099">return</span>&nbsp;<span class="ident" id="3289106">io</span><span class="op" id="3289108">.</span><span class="ident" id="3289109">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289117">return</span>&nbsp;<span class="ident" id="3289124">err</span><br>
<span class="lineno">315</span><span class="op" id="3289128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3289131">func</span>&nbsp;<span class="op" id="3289136">(</span><span class="ident" id="3289137">fd</span>&nbsp;<span class="op" id="3289140">*</span><span class="ident" id="3289141">netFD</span><span class="op" id="3289146">)</span>&nbsp;<span class="ident" id="3289148">Write</span><span class="op" id="3289153">(</span><span class="ident" id="3289154">p</span>&nbsp;<span class="op" id="3289156">[</span><span class="op" id="3289157">]</span><span class="builtintype" id="3289158">byte</span><span class="op" id="3289162">)</span>&nbsp;<span class="op" id="3289164">(</span><span class="ident" id="3289165">nn</span>&nbsp;<span class="builtintype" id="3289168">int</span><span class="op" id="3289171">,</span>&nbsp;<span class="ident" id="3289173">err</span>&nbsp;<span class="builtintype" id="3289177">error</span><span class="op" id="3289182">)</span>&nbsp;<span class="op" id="3289184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289187">if</span>&nbsp;<span class="ident" id="3289190">err</span>&nbsp;<span class="op" id="3289194">:=</span>&nbsp;<span class="ident" id="3289197">fd</span><span class="op" id="3289199">.</span><span class="ident" id="3289200">writeLock</span><span class="op" id="3289209">(</span><span class="op" id="3289210">)</span><span class="op" id="3289211">;</span>&nbsp;<span class="ident" id="3289213">err</span>&nbsp;<span class="op" id="3289217">!=</span>&nbsp;<span class="ident" id="3289220">nil</span>&nbsp;<span class="op" id="3289224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289228">return</span>&nbsp;<span class="num" id="3289235">0</span><span class="op" id="3289236">,</span>&nbsp;<span class="ident" id="3289238">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289246">defer</span>&nbsp;<span class="ident" id="3289252">fd</span><span class="op" id="3289254">.</span><span class="ident" id="3289255">writeUnlock</span><span class="op" id="3289266">(</span><span class="op" id="3289267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289270">if</span>&nbsp;<span class="ident" id="3289273">err</span>&nbsp;<span class="op" id="3289277">:=</span>&nbsp;<span class="ident" id="3289280">fd</span><span class="op" id="3289282">.</span><span class="ident" id="3289283">pd</span><span class="op" id="3289285">.</span><span class="ident" id="3289286">PrepareWrite</span><span class="op" id="3289298">(</span><span class="op" id="3289299">)</span><span class="op" id="3289300">;</span>&nbsp;<span class="ident" id="3289302">err</span>&nbsp;<span class="op" id="3289306">!=</span>&nbsp;<span class="ident" id="3289309">nil</span>&nbsp;<span class="op" id="3289313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289317">return</span>&nbsp;<span class="num" id="3289324">0</span><span class="op" id="3289325">,</span>&nbsp;<span class="op" id="3289327">&amp;</span><span class="ident" id="3289328">OpError</span><span class="op" id="3289335">{</span><span class="string" id="3289336">&#34;write&#34;</span><span class="op" id="3289343">,</span>&nbsp;<span class="ident" id="3289345">fd</span><span class="op" id="3289347">.</span><span class="ident" id="3289348">net</span><span class="op" id="3289351">,</span>&nbsp;<span class="ident" id="3289353">fd</span><span class="op" id="3289355">.</span><span class="ident" id="3289356">raddr</span><span class="op" id="3289361">,</span>&nbsp;<span class="ident" id="3289363">err</span><span class="op" id="3289366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289369">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289372">for</span>&nbsp;<span class="op" id="3289376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289380">var</span>&nbsp;<span class="ident" id="3289384">n</span>&nbsp;<span class="builtintype" id="3289386">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289392">n</span><span class="op" id="3289393">,</span>&nbsp;<span class="ident" id="3289395">err</span>&nbsp;<span class="op" id="3289399">=</span>&nbsp;<span class="ident" id="3289401">syscall</span><span class="op" id="3289408">.</span><span class="ident" id="3289409">Write</span><span class="op" id="3289414">(</span><span class="builtintype" id="3289415">int</span><span class="op" id="3289418">(</span><span class="ident" id="3289419">fd</span><span class="op" id="3289421">.</span><span class="ident" id="3289422">sysfd</span><span class="op" id="3289427">)</span><span class="op" id="3289428">,</span>&nbsp;<span class="ident" id="3289430">p</span><span class="op" id="3289431">[</span><span class="ident" id="3289432">nn</span><span class="op" id="3289434">:</span><span class="op" id="3289435">]</span><span class="op" id="3289436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289440">if</span>&nbsp;<span class="ident" id="3289443">n</span>&nbsp;<span class="op" id="3289445">&gt;</span>&nbsp;<span class="num" id="3289447">0</span>&nbsp;<span class="op" id="3289449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289454">nn</span>&nbsp;<span class="op" id="3289457">+=</span>&nbsp;<span class="ident" id="3289460">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289468">if</span>&nbsp;<span class="ident" id="3289471">nn</span>&nbsp;<span class="op" id="3289474">==</span>&nbsp;<span class="builtinfunc" id="3289477">len</span><span class="op" id="3289480">(</span><span class="ident" id="3289481">p</span><span class="op" id="3289482">)</span>&nbsp;<span class="op" id="3289484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289489">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289501">if</span>&nbsp;<span class="ident" id="3289504">err</span>&nbsp;<span class="op" id="3289508">==</span>&nbsp;<span class="ident" id="3289511">syscall</span><span class="op" id="3289518">.</span><span class="ident" id="3289519">EAGAIN</span>&nbsp;<span class="op" id="3289526">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289531">if</span>&nbsp;<span class="ident" id="3289534">err</span>&nbsp;<span class="op" id="3289538">=</span>&nbsp;<span class="ident" id="3289540">fd</span><span class="op" id="3289542">.</span><span class="ident" id="3289543">pd</span><span class="op" id="3289545">.</span><span class="ident" id="3289546">WaitWrite</span><span class="op" id="3289555">(</span><span class="op" id="3289556">)</span><span class="op" id="3289557">;</span>&nbsp;<span class="ident" id="3289559">err</span>&nbsp;<span class="op" id="3289563">==</span>&nbsp;<span class="ident" id="3289566">nil</span>&nbsp;<span class="op" id="3289570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289576">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289596">if</span>&nbsp;<span class="ident" id="3289599">err</span>&nbsp;<span class="op" id="3289603">!=</span>&nbsp;<span class="ident" id="3289606">nil</span>&nbsp;<span class="op" id="3289610">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289615">n</span>&nbsp;<span class="op" id="3289617">=</span>&nbsp;<span class="num" id="3289619">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289624">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289636">if</span>&nbsp;<span class="ident" id="3289639">n</span>&nbsp;<span class="op" id="3289641">==</span>&nbsp;<span class="num" id="3289644">0</span>&nbsp;<span class="op" id="3289646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289651">err</span>&nbsp;<span class="op" id="3289655">=</span>&nbsp;<span class="ident" id="3289657">io</span><span class="op" id="3289659">.</span><span class="ident" id="3289660">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289680">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289694">if</span>&nbsp;<span class="ident" id="3289697">err</span>&nbsp;<span class="op" id="3289701">!=</span>&nbsp;<span class="ident" id="3289704">nil</span>&nbsp;<span class="op" id="3289708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289712">err</span>&nbsp;<span class="op" id="3289716">=</span>&nbsp;<span class="op" id="3289718">&amp;</span><span class="ident" id="3289719">OpError</span><span class="op" id="3289726">{</span><span class="string" id="3289727">&#34;write&#34;</span><span class="op" id="3289734">,</span>&nbsp;<span class="ident" id="3289736">fd</span><span class="op" id="3289738">.</span><span class="ident" id="3289739">net</span><span class="op" id="3289742">,</span>&nbsp;<span class="ident" id="3289744">fd</span><span class="op" id="3289746">.</span><span class="ident" id="3289747">raddr</span><span class="op" id="3289752">,</span>&nbsp;<span class="ident" id="3289754">err</span><span class="op" id="3289757">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289763">return</span>&nbsp;<span class="ident" id="3289770">nn</span><span class="op" id="3289772">,</span>&nbsp;<span class="ident" id="3289774">err</span><br>
<span class="lineno"></span><span class="op" id="3289778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3289781">func</span>&nbsp;<span class="op" id="3289786">(</span><span class="ident" id="3289787">fd</span>&nbsp;<span class="op" id="3289790">*</span><span class="ident" id="3289791">netFD</span><span class="op" id="3289796">)</span>&nbsp;<span class="ident" id="3289798">writeTo</span><span class="op" id="3289805">(</span><span class="ident" id="3289806">p</span>&nbsp;<span class="op" id="3289808">[</span><span class="op" id="3289809">]</span><span class="builtintype" id="3289810">byte</span><span class="op" id="3289814">,</span>&nbsp;<span class="ident" id="3289816">sa</span>&nbsp;<span class="ident" id="3289819">syscall</span><span class="op" id="3289826">.</span><span class="ident" id="3289827">Sockaddr</span><span class="op" id="3289835">)</span>&nbsp;<span class="op" id="3289837">(</span><span class="ident" id="3289838">n</span>&nbsp;<span class="builtintype" id="3289840">int</span><span class="op" id="3289843">,</span>&nbsp;<span class="ident" id="3289845">err</span>&nbsp;<span class="builtintype" id="3289849">error</span><span class="op" id="3289854">)</span>&nbsp;<span class="op" id="3289856">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289859">if</span>&nbsp;<span class="ident" id="3289862">err</span>&nbsp;<span class="op" id="3289866">:=</span>&nbsp;<span class="ident" id="3289869">fd</span><span class="op" id="3289871">.</span><span class="ident" id="3289872">writeLock</span><span class="op" id="3289881">(</span><span class="op" id="3289882">)</span><span class="op" id="3289883">;</span>&nbsp;<span class="ident" id="3289885">err</span>&nbsp;<span class="op" id="3289889">!=</span>&nbsp;<span class="ident" id="3289892">nil</span>&nbsp;<span class="op" id="3289896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289900">return</span>&nbsp;<span class="num" id="3289907">0</span><span class="op" id="3289908">,</span>&nbsp;<span class="ident" id="3289910">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289918">defer</span>&nbsp;<span class="ident" id="3289924">fd</span><span class="op" id="3289926">.</span><span class="ident" id="3289927">writeUnlock</span><span class="op" id="3289938">(</span><span class="op" id="3289939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289942">if</span>&nbsp;<span class="ident" id="3289945">err</span>&nbsp;<span class="op" id="3289949">:=</span>&nbsp;<span class="ident" id="3289952">fd</span><span class="op" id="3289954">.</span><span class="ident" id="3289955">pd</span><span class="op" id="3289957">.</span><span class="ident" id="3289958">PrepareWrite</span><span class="op" id="3289970">(</span><span class="op" id="3289971">)</span><span class="op" id="3289972">;</span>&nbsp;<span class="ident" id="3289974">err</span>&nbsp;<span class="op" id="3289978">!=</span>&nbsp;<span class="ident" id="3289981">nil</span>&nbsp;<span class="op" id="3289985">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289989">return</span>&nbsp;<span class="num" id="3289996">0</span><span class="op" id="3289997">,</span>&nbsp;<span class="op" id="3289999">&amp;</span><span class="ident" id="3290000">OpError</span><span class="op" id="3290007">{</span><span class="string" id="3290008">&#34;write&#34;</span><span class="op" id="3290015">,</span>&nbsp;<span class="ident" id="3290017">fd</span><span class="op" id="3290019">.</span><span class="ident" id="3290020">net</span><span class="op" id="3290023">,</span>&nbsp;<span class="ident" id="3290025">fd</span><span class="op" id="3290027">.</span><span class="ident" id="3290028">raddr</span><span class="op" id="3290033">,</span>&nbsp;<span class="ident" id="3290035">err</span><span class="op" id="3290038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290044">for</span>&nbsp;<span class="op" id="3290048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290052">err</span>&nbsp;<span class="op" id="3290056">=</span>&nbsp;<span class="ident" id="3290058">syscall</span><span class="op" id="3290065">.</span><span class="ident" id="3290066">Sendto</span><span class="op" id="3290072">(</span><span class="ident" id="3290073">fd</span><span class="op" id="3290075">.</span><span class="ident" id="3290076">sysfd</span><span class="op" id="3290081">,</span>&nbsp;<span class="ident" id="3290083">p</span><span class="op" id="3290084">,</span>&nbsp;<span class="num" id="3290086">0</span><span class="op" id="3290087">,</span>&nbsp;<span class="ident" id="3290089">sa</span><span class="op" id="3290091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290095">if</span>&nbsp;<span class="ident" id="3290098">err</span>&nbsp;<span class="op" id="3290102">==</span>&nbsp;<span class="ident" id="3290105">syscall</span><span class="op" id="3290112">.</span><span class="ident" id="3290113">EAGAIN</span>&nbsp;<span class="op" id="3290120">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290125">if</span>&nbsp;<span class="ident" id="3290128">err</span>&nbsp;<span class="op" id="3290132">=</span>&nbsp;<span class="ident" id="3290134">fd</span><span class="op" id="3290136">.</span><span class="ident" id="3290137">pd</span><span class="op" id="3290139">.</span><span class="ident" id="3290140">WaitWrite</span><span class="op" id="3290149">(</span><span class="op" id="3290150">)</span><span class="op" id="3290151">;</span>&nbsp;<span class="ident" id="3290153">err</span>&nbsp;<span class="op" id="3290157">==</span>&nbsp;<span class="ident" id="3290160">nil</span>&nbsp;<span class="op" id="3290164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290170">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290190">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290200">if</span>&nbsp;<span class="ident" id="3290203">err</span>&nbsp;<span class="op" id="3290207">==</span>&nbsp;<span class="ident" id="3290210">nil</span>&nbsp;<span class="op" id="3290214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290218">n</span>&nbsp;<span class="op" id="3290220">=</span>&nbsp;<span class="builtinfunc" id="3290222">len</span><span class="op" id="3290225">(</span><span class="ident" id="3290226">p</span><span class="op" id="3290227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290230">}</span>&nbsp;<span class="keyword" id="3290232">else</span>&nbsp;<span class="op" id="3290237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290241">err</span>&nbsp;<span class="op" id="3290245">=</span>&nbsp;<span class="op" id="3290247">&amp;</span><span class="ident" id="3290248">OpError</span><span class="op" id="3290255">{</span><span class="string" id="3290256">&#34;write&#34;</span><span class="op" id="3290263">,</span>&nbsp;<span class="ident" id="3290265">fd</span><span class="op" id="3290267">.</span><span class="ident" id="3290268">net</span><span class="op" id="3290271">,</span>&nbsp;<span class="ident" id="3290273">fd</span><span class="op" id="3290275">.</span><span class="ident" id="3290276">raddr</span><span class="op" id="3290281">,</span>&nbsp;<span class="ident" id="3290283">err</span><span class="op" id="3290286">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290292">return</span><br>
<span class="lineno"></span><span class="op" id="3290299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3290302">func</span>&nbsp;<span class="op" id="3290307">(</span><span class="ident" id="3290308">fd</span>&nbsp;<span class="op" id="3290311">*</span><span class="ident" id="3290312">netFD</span><span class="op" id="3290317">)</span>&nbsp;<span class="ident" id="3290319">writeMsg</span><span class="op" id="3290327">(</span><span class="ident" id="3290328">p</span>&nbsp;<span class="op" id="3290330">[</span><span class="op" id="3290331">]</span><span class="builtintype" id="3290332">byte</span><span class="op" id="3290336">,</span>&nbsp;<span class="ident" id="3290338">oob</span>&nbsp;<span class="op" id="3290342">[</span><span class="op" id="3290343">]</span><span class="builtintype" id="3290344">byte</span><span class="op" id="3290348">,</span>&nbsp;<span class="ident" id="3290350">sa</span>&nbsp;<span class="ident" id="3290353">syscall</span><span class="op" id="3290360">.</span><span class="ident" id="3290361">Sockaddr</span><span class="op" id="3290369">)</span>&nbsp;<span class="op" id="3290371">(</span><span class="ident" id="3290372">n</span>&nbsp;<span class="builtintype" id="3290374">int</span><span class="op" id="3290377">,</span>&nbsp;<span class="ident" id="3290379">oobn</span>&nbsp;<span class="builtintype" id="3290384">int</span><span class="op" id="3290387">,</span>&nbsp;<span class="ident" id="3290389">err</span>&nbsp;<span class="builtintype" id="3290393">error</span><span class="op" id="3290398">)</span>&nbsp;<span class="op" id="3290400">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290403">if</span>&nbsp;<span class="ident" id="3290406">err</span>&nbsp;<span class="op" id="3290410">:=</span>&nbsp;<span class="ident" id="3290413">fd</span><span class="op" id="3290415">.</span><span class="ident" id="3290416">writeLock</span><span class="op" id="3290425">(</span><span class="op" id="3290426">)</span><span class="op" id="3290427">;</span>&nbsp;<span class="ident" id="3290429">err</span>&nbsp;<span class="op" id="3290433">!=</span>&nbsp;<span class="ident" id="3290436">nil</span>&nbsp;<span class="op" id="3290440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290444">return</span>&nbsp;<span class="num" id="3290451">0</span><span class="op" id="3290452">,</span>&nbsp;<span class="num" id="3290454">0</span><span class="op" id="3290455">,</span>&nbsp;<span class="ident" id="3290457">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290465">defer</span>&nbsp;<span class="ident" id="3290471">fd</span><span class="op" id="3290473">.</span><span class="ident" id="3290474">writeUnlock</span><span class="op" id="3290485">(</span><span class="op" id="3290486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290489">if</span>&nbsp;<span class="ident" id="3290492">err</span>&nbsp;<span class="op" id="3290496">:=</span>&nbsp;<span class="ident" id="3290499">fd</span><span class="op" id="3290501">.</span><span class="ident" id="3290502">pd</span><span class="op" id="3290504">.</span><span class="ident" id="3290505">PrepareWrite</span><span class="op" id="3290517">(</span><span class="op" id="3290518">)</span><span class="op" id="3290519">;</span>&nbsp;<span class="ident" id="3290521">err</span>&nbsp;<span class="op" id="3290525">!=</span>&nbsp;<span class="ident" id="3290528">nil</span>&nbsp;<span class="op" id="3290532">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290536">return</span>&nbsp;<span class="num" id="3290543">0</span><span class="op" id="3290544">,</span>&nbsp;<span class="num" id="3290546">0</span><span class="op" id="3290547">,</span>&nbsp;<span class="op" id="3290549">&amp;</span><span class="ident" id="3290550">OpError</span><span class="op" id="3290557">{</span><span class="string" id="3290558">&#34;write&#34;</span><span class="op" id="3290565">,</span>&nbsp;<span class="ident" id="3290567">fd</span><span class="op" id="3290569">.</span><span class="ident" id="3290570">net</span><span class="op" id="3290573">,</span>&nbsp;<span class="ident" id="3290575">fd</span><span class="op" id="3290577">.</span><span class="ident" id="3290578">raddr</span><span class="op" id="3290583">,</span>&nbsp;<span class="ident" id="3290585">err</span><span class="op" id="3290588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290594">for</span>&nbsp;<span class="op" id="3290598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290602">n</span><span class="op" id="3290603">,</span>&nbsp;<span class="ident" id="3290605">err</span>&nbsp;<span class="op" id="3290609">=</span>&nbsp;<span class="ident" id="3290611">syscall</span><span class="op" id="3290618">.</span><span class="ident" id="3290619">SendmsgN</span><span class="op" id="3290627">(</span><span class="ident" id="3290628">fd</span><span class="op" id="3290630">.</span><span class="ident" id="3290631">sysfd</span><span class="op" id="3290636">,</span>&nbsp;<span class="ident" id="3290638">p</span><span class="op" id="3290639">,</span>&nbsp;<span class="ident" id="3290641">oob</span><span class="op" id="3290644">,</span>&nbsp;<span class="ident" id="3290646">sa</span><span class="op" id="3290648">,</span>&nbsp;<span class="num" id="3290650">0</span><span class="op" id="3290651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290655">if</span>&nbsp;<span class="ident" id="3290658">err</span>&nbsp;<span class="op" id="3290662">==</span>&nbsp;<span class="ident" id="3290665">syscall</span><span class="op" id="3290672">.</span><span class="ident" id="3290673">EAGAIN</span>&nbsp;<span class="op" id="3290680">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290685">if</span>&nbsp;<span class="ident" id="3290688">err</span>&nbsp;<span class="op" id="3290692">=</span>&nbsp;<span class="ident" id="3290694">fd</span><span class="op" id="3290696">.</span><span class="ident" id="3290697">pd</span><span class="op" id="3290699">.</span><span class="ident" id="3290700">WaitWrite</span><span class="op" id="3290709">(</span><span class="op" id="3290710">)</span><span class="op" id="3290711">;</span>&nbsp;<span class="ident" id="3290713">err</span>&nbsp;<span class="op" id="3290717">==</span>&nbsp;<span class="ident" id="3290720">nil</span>&nbsp;<span class="op" id="3290724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290730">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290750">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290760">if</span>&nbsp;<span class="ident" id="3290763">err</span>&nbsp;<span class="op" id="3290767">==</span>&nbsp;<span class="ident" id="3290770">nil</span>&nbsp;<span class="op" id="3290774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290778">oobn</span>&nbsp;<span class="op" id="3290783">=</span>&nbsp;<span class="builtinfunc" id="3290785">len</span><span class="op" id="3290788">(</span><span class="ident" id="3290789">oob</span><span class="op" id="3290792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290795">}</span>&nbsp;<span class="keyword" id="3290797">else</span>&nbsp;<span class="op" id="3290802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290806">err</span>&nbsp;<span class="op" id="3290810">=</span>&nbsp;<span class="op" id="3290812">&amp;</span><span class="ident" id="3290813">OpError</span><span class="op" id="3290820">{</span><span class="string" id="3290821">&#34;write&#34;</span><span class="op" id="3290828">,</span>&nbsp;<span class="ident" id="3290830">fd</span><span class="op" id="3290832">.</span><span class="ident" id="3290833">net</span><span class="op" id="3290836">,</span>&nbsp;<span class="ident" id="3290838">fd</span><span class="op" id="3290840">.</span><span class="ident" id="3290841">raddr</span><span class="op" id="3290846">,</span>&nbsp;<span class="ident" id="3290848">err</span><span class="op" id="3290851">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290857">return</span><br>
<span class="lineno"></span><span class="op" id="3290864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3290867">func</span>&nbsp;<span class="op" id="3290872">(</span><span class="ident" id="3290873">fd</span>&nbsp;<span class="op" id="3290876">*</span><span class="ident" id="3290877">netFD</span><span class="op" id="3290882">)</span>&nbsp;<span class="ident" id="3290884">accept</span><span class="op" id="3290890">(</span><span class="op" id="3290891">)</span>&nbsp;<span class="op" id="3290893">(</span><span class="ident" id="3290894">netfd</span>&nbsp;<span class="op" id="3290900">*</span><span class="ident" id="3290901">netFD</span><span class="op" id="3290906">,</span>&nbsp;<span class="ident" id="3290908">err</span>&nbsp;<span class="builtintype" id="3290912">error</span><span class="op" id="3290917">)</span>&nbsp;<span class="op" id="3290919">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290922">if</span>&nbsp;<span class="ident" id="3290925">err</span>&nbsp;<span class="op" id="3290929">:=</span>&nbsp;<span class="ident" id="3290932">fd</span><span class="op" id="3290934">.</span><span class="ident" id="3290935">readLock</span><span class="op" id="3290943">(</span><span class="op" id="3290944">)</span><span class="op" id="3290945">;</span>&nbsp;<span class="ident" id="3290947">err</span>&nbsp;<span class="op" id="3290951">!=</span>&nbsp;<span class="ident" id="3290954">nil</span>&nbsp;<span class="op" id="3290958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290962">return</span>&nbsp;<span class="ident" id="3290969">nil</span><span class="op" id="3290972">,</span>&nbsp;<span class="ident" id="3290974">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290982">defer</span>&nbsp;<span class="ident" id="3290988">fd</span><span class="op" id="3290990">.</span><span class="ident" id="3290991">readUnlock</span><span class="op" id="3291001">(</span><span class="op" id="3291002">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291006">var</span>&nbsp;<span class="ident" id="3291010">s</span>&nbsp;<span class="builtintype" id="3291012">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291017">var</span>&nbsp;<span class="ident" id="3291021">rsa</span>&nbsp;<span class="ident" id="3291025">syscall</span><span class="op" id="3291032">.</span><span class="ident" id="3291033">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291043">if</span>&nbsp;<span class="ident" id="3291046">err</span>&nbsp;<span class="op" id="3291050">=</span>&nbsp;<span class="ident" id="3291052">fd</span><span class="op" id="3291054">.</span><span class="ident" id="3291055">pd</span><span class="op" id="3291057">.</span><span class="ident" id="3291058">PrepareRead</span><span class="op" id="3291069">(</span><span class="op" id="3291070">)</span><span class="op" id="3291071">;</span>&nbsp;<span class="ident" id="3291073">err</span>&nbsp;<span class="op" id="3291077">!=</span>&nbsp;<span class="ident" id="3291080">nil</span>&nbsp;<span class="op" id="3291084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291088">return</span>&nbsp;<span class="ident" id="3291095">nil</span><span class="op" id="3291098">,</span>&nbsp;<span class="op" id="3291100">&amp;</span><span class="ident" id="3291101">OpError</span><span class="op" id="3291108">{</span><span class="string" id="3291109">&#34;accept&#34;</span><span class="op" id="3291117">,</span>&nbsp;<span class="ident" id="3291119">fd</span><span class="op" id="3291121">.</span><span class="ident" id="3291122">net</span><span class="op" id="3291125">,</span>&nbsp;<span class="ident" id="3291127">fd</span><span class="op" id="3291129">.</span><span class="ident" id="3291130">laddr</span><span class="op" id="3291135">,</span>&nbsp;<span class="ident" id="3291137">err</span><span class="op" id="3291140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291143">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291146">for</span>&nbsp;<span class="op" id="3291150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291154">s</span><span class="op" id="3291155">,</span>&nbsp;<span class="ident" id="3291157">rsa</span><span class="op" id="3291160">,</span>&nbsp;<span class="ident" id="3291162">err</span>&nbsp;<span class="op" id="3291166">=</span>&nbsp;<span class="ident" id="3291168">accept</span><span class="op" id="3291174">(</span><span class="ident" id="3291175">fd</span><span class="op" id="3291177">.</span><span class="ident" id="3291178">sysfd</span><span class="op" id="3291183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291187">if</span>&nbsp;<span class="ident" id="3291190">err</span>&nbsp;<span class="op" id="3291194">!=</span>&nbsp;<span class="ident" id="3291197">nil</span>&nbsp;<span class="op" id="3291201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291206">if</span>&nbsp;<span class="ident" id="3291209">err</span>&nbsp;<span class="op" id="3291213">==</span>&nbsp;<span class="ident" id="3291216">syscall</span><span class="op" id="3291223">.</span><span class="ident" id="3291224">EAGAIN</span>&nbsp;<span class="op" id="3291231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291237">if</span>&nbsp;<span class="ident" id="3291240">err</span>&nbsp;<span class="op" id="3291244">=</span>&nbsp;<span class="ident" id="3291246">fd</span><span class="op" id="3291248">.</span><span class="ident" id="3291249">pd</span><span class="op" id="3291251">.</span><span class="ident" id="3291252">WaitRead</span><span class="op" id="3291260">(</span><span class="op" id="3291261">)</span><span class="op" id="3291262">;</span>&nbsp;<span class="ident" id="3291264">err</span>&nbsp;<span class="op" id="3291268">==</span>&nbsp;<span class="ident" id="3291271">nil</span>&nbsp;<span class="op" id="3291275">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291282">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291300">}</span>&nbsp;<span class="keyword" id="3291302">else</span>&nbsp;<span class="keyword" id="3291307">if</span>&nbsp;<span class="ident" id="3291310">err</span>&nbsp;<span class="op" id="3291314">==</span>&nbsp;<span class="ident" id="3291317">syscall</span><span class="op" id="3291324">.</span><span class="ident" id="3291325">ECONNABORTED</span>&nbsp;<span class="op" id="3291338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291344">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291407">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291473">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291490">return</span>&nbsp;<span class="ident" id="3291497">nil</span><span class="op" id="3291500">,</span>&nbsp;<span class="op" id="3291502">&amp;</span><span class="ident" id="3291503">OpError</span><span class="op" id="3291510">{</span><span class="string" id="3291511">&#34;accept&#34;</span><span class="op" id="3291519">,</span>&nbsp;<span class="ident" id="3291521">fd</span><span class="op" id="3291523">.</span><span class="ident" id="3291524">net</span><span class="op" id="3291527">,</span>&nbsp;<span class="ident" id="3291529">fd</span><span class="op" id="3291531">.</span><span class="ident" id="3291532">laddr</span><span class="op" id="3291537">,</span>&nbsp;<span class="ident" id="3291539">err</span><span class="op" id="3291542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291550">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291561">if</span>&nbsp;<span class="ident" id="3291564">netfd</span><span class="op" id="3291569">,</span>&nbsp;<span class="ident" id="3291571">err</span>&nbsp;<span class="op" id="3291575">=</span>&nbsp;<span class="ident" id="3291577">newFD</span><span class="op" id="3291582">(</span><span class="ident" id="3291583">s</span><span class="op" id="3291584">,</span>&nbsp;<span class="ident" id="3291586">fd</span><span class="op" id="3291588">.</span><span class="ident" id="3291589">family</span><span class="op" id="3291595">,</span>&nbsp;<span class="ident" id="3291597">fd</span><span class="op" id="3291599">.</span><span class="ident" id="3291600">sotype</span><span class="op" id="3291606">,</span>&nbsp;<span class="ident" id="3291608">fd</span><span class="op" id="3291610">.</span><span class="ident" id="3291611">net</span><span class="op" id="3291614">)</span><span class="op" id="3291615">;</span>&nbsp;<span class="ident" id="3291617">err</span>&nbsp;<span class="op" id="3291621">!=</span>&nbsp;<span class="ident" id="3291624">nil</span>&nbsp;<span class="op" id="3291628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291632">closesocket</span><span class="op" id="3291643">(</span><span class="ident" id="3291644">s</span><span class="op" id="3291645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291649">return</span>&nbsp;<span class="ident" id="3291656">nil</span><span class="op" id="3291659">,</span>&nbsp;<span class="ident" id="3291661">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291669">if</span>&nbsp;<span class="ident" id="3291672">err</span>&nbsp;<span class="op" id="3291676">=</span>&nbsp;<span class="ident" id="3291678">netfd</span><span class="op" id="3291683">.</span><span class="ident" id="3291684">init</span><span class="op" id="3291688">(</span><span class="op" id="3291689">)</span><span class="op" id="3291690">;</span>&nbsp;<span class="ident" id="3291692">err</span>&nbsp;<span class="op" id="3291696">!=</span>&nbsp;<span class="ident" id="3291699">nil</span>&nbsp;<span class="op" id="3291703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291707">fd</span><span class="op" id="3291709">.</span><span class="ident" id="3291710">Close</span><span class="op" id="3291715">(</span><span class="op" id="3291716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291720">return</span>&nbsp;<span class="ident" id="3291727">nil</span><span class="op" id="3291730">,</span>&nbsp;<span class="ident" id="3291732">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291737">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291740">lsa</span><span class="op" id="3291743">,</span>&nbsp;<span class="ident" id="3291745">_</span>&nbsp;<span class="op" id="3291747">:=</span>&nbsp;<span class="ident" id="3291750">syscall</span><span class="op" id="3291757">.</span><span class="ident" id="3291758">Getsockname</span><span class="op" id="3291769">(</span><span class="ident" id="3291770">netfd</span><span class="op" id="3291775">.</span><span class="ident" id="3291776">sysfd</span><span class="op" id="3291781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291784">netfd</span><span class="op" id="3291789">.</span><span class="ident" id="3291790">setAddr</span><span class="op" id="3291797">(</span><span class="ident" id="3291798">netfd</span><span class="op" id="3291803">.</span><span class="ident" id="3291804">addrFunc</span><span class="op" id="3291812">(</span><span class="op" id="3291813">)</span><span class="op" id="3291814">(</span><span class="ident" id="3291815">lsa</span><span class="op" id="3291818">)</span><span class="op" id="3291819">,</span>&nbsp;<span class="ident" id="3291821">netfd</span><span class="op" id="3291826">.</span><span class="ident" id="3291827">addrFunc</span><span class="op" id="3291835">(</span><span class="op" id="3291836">)</span><span class="op" id="3291837">(</span><span class="ident" id="3291838">rsa</span><span class="op" id="3291841">)</span><span class="op" id="3291842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291845">return</span>&nbsp;<span class="ident" id="3291852">netfd</span><span class="op" id="3291857">,</span>&nbsp;<span class="ident" id="3291859">nil</span><br>
<span class="lineno"></span><span class="op" id="3291863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3291866">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3291933">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3291988">var</span>&nbsp;<span class="ident" id="3291992">tryDupCloexec</span>&nbsp;<span class="op" id="3292006">=</span>&nbsp;<span class="builtintype" id="3292008">int32</span><span class="op" id="3292013">(</span><span class="num" id="3292014">1</span><span class="op" id="3292015">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3292018">func</span>&nbsp;<span class="ident" id="3292023">dupCloseOnExec</span><span class="op" id="3292037">(</span><span class="ident" id="3292038">fd</span>&nbsp;<span class="builtintype" id="3292041">int</span><span class="op" id="3292044">)</span>&nbsp;<span class="op" id="3292046">(</span><span class="ident" id="3292047">newfd</span>&nbsp;<span class="builtintype" id="3292053">int</span><span class="op" id="3292056">,</span>&nbsp;<span class="ident" id="3292058">err</span>&nbsp;<span class="builtintype" id="3292062">error</span><span class="op" id="3292067">)</span>&nbsp;<span class="op" id="3292069">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292072">if</span>&nbsp;<span class="ident" id="3292075">atomic</span><span class="op" id="3292081">.</span><span class="ident" id="3292082">LoadInt32</span><span class="op" id="3292091">(</span><span class="op" id="3292092">&amp;</span><span class="ident" id="3292093">tryDupCloexec</span><span class="op" id="3292106">)</span>&nbsp;<span class="op" id="3292108">==</span>&nbsp;<span class="num" id="3292111">1</span>&nbsp;<span class="op" id="3292113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292117">r0</span><span class="op" id="3292119">,</span>&nbsp;<span class="ident" id="3292121">_</span><span class="op" id="3292122">,</span>&nbsp;<span class="ident" id="3292124">e1</span>&nbsp;<span class="op" id="3292127">:=</span>&nbsp;<span class="ident" id="3292130">syscall</span><span class="op" id="3292137">.</span><span class="ident" id="3292138">Syscall</span><span class="op" id="3292145">(</span><span class="ident" id="3292146">syscall</span><span class="op" id="3292153">.</span><span class="ident" id="3292154">SYS_FCNTL</span><span class="op" id="3292163">,</span>&nbsp;<span class="builtintype" id="3292165">uintptr</span><span class="op" id="3292172">(</span><span class="ident" id="3292173">fd</span><span class="op" id="3292175">)</span><span class="op" id="3292176">,</span>&nbsp;<span class="ident" id="3292178">syscall</span><span class="op" id="3292185">.</span><span class="ident" id="3292186">F_DUPFD_CLOEXEC</span><span class="op" id="3292201">,</span>&nbsp;<span class="num" id="3292203">0</span><span class="op" id="3292204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292208">if</span>&nbsp;<span class="ident" id="3292211">runtime</span><span class="op" id="3292218">.</span><span class="ident" id="3292219">GOOS</span>&nbsp;<span class="op" id="3292224">==</span>&nbsp;<span class="string" id="3292227">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3292236">&amp;&amp;</span>&nbsp;<span class="ident" id="3292239">e1</span>&nbsp;<span class="op" id="3292242">==</span>&nbsp;<span class="ident" id="3292245">syscall</span><span class="op" id="3292252">.</span><span class="ident" id="3292253">EBADF</span>&nbsp;<span class="op" id="3292259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292264">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292314">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292361">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292409">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292458">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292502">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292546">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292591">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292614">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292669">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292684">e1</span>&nbsp;<span class="op" id="3292687">=</span>&nbsp;<span class="ident" id="3292689">syscall</span><span class="op" id="3292696">.</span><span class="ident" id="3292697">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292706">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292710">switch</span>&nbsp;<span class="ident" id="3292717">e1</span>&nbsp;<span class="op" id="3292720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292724">case</span>&nbsp;<span class="num" id="3292729">0</span><span class="op" id="3292730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292735">return</span>&nbsp;<span class="builtintype" id="3292742">int</span><span class="op" id="3292745">(</span><span class="ident" id="3292746">r0</span><span class="op" id="3292748">)</span><span class="op" id="3292749">,</span>&nbsp;<span class="ident" id="3292751">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292757">case</span>&nbsp;<span class="ident" id="3292762">syscall</span><span class="op" id="3292769">.</span><span class="ident" id="3292770">EINVAL</span><span class="op" id="3292776">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292781">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292829">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292848">atomic</span><span class="op" id="3292854">.</span><span class="ident" id="3292855">StoreInt32</span><span class="op" id="3292865">(</span><span class="op" id="3292866">&amp;</span><span class="ident" id="3292867">tryDupCloexec</span><span class="op" id="3292880">,</span>&nbsp;<span class="num" id="3292882">0</span><span class="op" id="3292883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292887">default</span><span class="op" id="3292894">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292899">return</span>&nbsp;<span class="op" id="3292906">-</span><span class="num" id="3292907">1</span><span class="op" id="3292908">,</span>&nbsp;<span class="ident" id="3292910">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292915">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292921">return</span>&nbsp;<span class="ident" id="3292928">dupCloseOnExecOld</span><span class="op" id="3292945">(</span><span class="ident" id="3292946">fd</span><span class="op" id="3292948">)</span><br>
<span class="lineno"></span><span class="op" id="3292950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3292953">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3293018">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3293068">func</span>&nbsp;<span class="ident" id="3293073">dupCloseOnExecOld</span><span class="op" id="3293090">(</span><span class="ident" id="3293091">fd</span>&nbsp;<span class="builtintype" id="3293094">int</span><span class="op" id="3293097">)</span>&nbsp;<span class="op" id="3293099">(</span><span class="ident" id="3293100">newfd</span>&nbsp;<span class="builtintype" id="3293106">int</span><span class="op" id="3293109">,</span>&nbsp;<span class="ident" id="3293111">err</span>&nbsp;<span class="builtintype" id="3293115">error</span><span class="op" id="3293120">)</span>&nbsp;<span class="op" id="3293122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293125">syscall</span><span class="op" id="3293132">.</span><span class="ident" id="3293133">ForkLock</span><span class="op" id="3293141">.</span><span class="ident" id="3293142">RLock</span><span class="op" id="3293147">(</span><span class="op" id="3293148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293151">defer</span>&nbsp;<span class="ident" id="3293157">syscall</span><span class="op" id="3293164">.</span><span class="ident" id="3293165">ForkLock</span><span class="op" id="3293173">.</span><span class="ident" id="3293174">RUnlock</span><span class="op" id="3293181">(</span><span class="op" id="3293182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293185">newfd</span><span class="op" id="3293190">,</span>&nbsp;<span class="ident" id="3293192">err</span>&nbsp;<span class="op" id="3293196">=</span>&nbsp;<span class="ident" id="3293198">syscall</span><span class="op" id="3293205">.</span><span class="ident" id="3293206">Dup</span><span class="op" id="3293209">(</span><span class="ident" id="3293210">fd</span><span class="op" id="3293212">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293215">if</span>&nbsp;<span class="ident" id="3293218">err</span>&nbsp;<span class="op" id="3293222">!=</span>&nbsp;<span class="ident" id="3293225">nil</span>&nbsp;<span class="op" id="3293229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293233">return</span>&nbsp;<span class="op" id="3293240">-</span><span class="num" id="3293241">1</span><span class="op" id="3293242">,</span>&nbsp;<span class="ident" id="3293244">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293252">syscall</span><span class="op" id="3293259">.</span><span class="ident" id="3293260">CloseOnExec</span><span class="op" id="3293271">(</span><span class="ident" id="3293272">newfd</span><span class="op" id="3293277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293280">return</span><br>
<span class="lineno">490</span><span class="op" id="3293287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3293290">func</span>&nbsp;<span class="op" id="3293295">(</span><span class="ident" id="3293296">fd</span>&nbsp;<span class="op" id="3293299">*</span><span class="ident" id="3293300">netFD</span><span class="op" id="3293305">)</span>&nbsp;<span class="ident" id="3293307">dup</span><span class="op" id="3293310">(</span><span class="op" id="3293311">)</span>&nbsp;<span class="op" id="3293313">(</span><span class="ident" id="3293314">f</span>&nbsp;<span class="op" id="3293316">*</span><span class="ident" id="3293317">os</span><span class="op" id="3293319">.</span><span class="ident" id="3293320">File</span><span class="op" id="3293324">,</span>&nbsp;<span class="ident" id="3293326">err</span>&nbsp;<span class="builtintype" id="3293330">error</span><span class="op" id="3293335">)</span>&nbsp;<span class="op" id="3293337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293340">ns</span><span class="op" id="3293342">,</span>&nbsp;<span class="ident" id="3293344">err</span>&nbsp;<span class="op" id="3293348">:=</span>&nbsp;<span class="ident" id="3293351">dupCloseOnExec</span><span class="op" id="3293365">(</span><span class="ident" id="3293366">fd</span><span class="op" id="3293368">.</span><span class="ident" id="3293369">sysfd</span><span class="op" id="3293374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293377">if</span>&nbsp;<span class="ident" id="3293380">err</span>&nbsp;<span class="op" id="3293384">!=</span>&nbsp;<span class="ident" id="3293387">nil</span>&nbsp;<span class="op" id="3293391">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293395">return</span>&nbsp;<span class="ident" id="3293402">nil</span><span class="op" id="3293405">,</span>&nbsp;<span class="op" id="3293407">&amp;</span><span class="ident" id="3293408">OpError</span><span class="op" id="3293415">{</span><span class="string" id="3293416">&#34;dup&#34;</span><span class="op" id="3293421">,</span>&nbsp;<span class="ident" id="3293423">fd</span><span class="op" id="3293425">.</span><span class="ident" id="3293426">net</span><span class="op" id="3293429">,</span>&nbsp;<span class="ident" id="3293431">fd</span><span class="op" id="3293433">.</span><span class="ident" id="3293434">laddr</span><span class="op" id="3293439">,</span>&nbsp;<span class="ident" id="3293441">err</span><span class="op" id="3293444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293451">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293520">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293583">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293657">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293713">if</span>&nbsp;<span class="ident" id="3293716">err</span>&nbsp;<span class="op" id="3293720">=</span>&nbsp;<span class="ident" id="3293722">syscall</span><span class="op" id="3293729">.</span><span class="ident" id="3293730">SetNonblock</span><span class="op" id="3293741">(</span><span class="ident" id="3293742">ns</span><span class="op" id="3293744">,</span>&nbsp;<span class="builtintype" id="3293746">false</span><span class="op" id="3293751">)</span><span class="op" id="3293752">;</span>&nbsp;<span class="ident" id="3293754">err</span>&nbsp;<span class="op" id="3293758">!=</span>&nbsp;<span class="ident" id="3293761">nil</span>&nbsp;<span class="op" id="3293765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293769">return</span>&nbsp;<span class="ident" id="3293776">nil</span><span class="op" id="3293779">,</span>&nbsp;<span class="op" id="3293781">&amp;</span><span class="ident" id="3293782">OpError</span><span class="op" id="3293789">{</span><span class="string" id="3293790">&#34;setnonblock&#34;</span><span class="op" id="3293803">,</span>&nbsp;<span class="ident" id="3293805">fd</span><span class="op" id="3293807">.</span><span class="ident" id="3293808">net</span><span class="op" id="3293811">,</span>&nbsp;<span class="ident" id="3293813">fd</span><span class="op" id="3293815">.</span><span class="ident" id="3293816">laddr</span><span class="op" id="3293821">,</span>&nbsp;<span class="ident" id="3293823">err</span><span class="op" id="3293826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293829">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293833">return</span>&nbsp;<span class="ident" id="3293840">os</span><span class="op" id="3293842">.</span><span class="ident" id="3293843">NewFile</span><span class="op" id="3293850">(</span><span class="builtintype" id="3293851">uintptr</span><span class="op" id="3293858">(</span><span class="ident" id="3293859">ns</span><span class="op" id="3293861">)</span><span class="op" id="3293862">,</span>&nbsp;<span class="ident" id="3293864">fd</span><span class="op" id="3293866">.</span><span class="ident" id="3293867">name</span><span class="op" id="3293871">(</span><span class="op" id="3293872">)</span><span class="op" id="3293873">)</span><span class="op" id="3293874">,</span>&nbsp;<span class="ident" id="3293876">nil</span><br>
<span class="lineno"></span><span class="op" id="3293880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3293883">func</span>&nbsp;<span class="ident" id="3293888">closesocket</span><span class="op" id="3293899">(</span><span class="ident" id="3293900">s</span>&nbsp;<span class="builtintype" id="3293902">int</span><span class="op" id="3293905">)</span>&nbsp;<span class="builtintype" id="3293907">error</span>&nbsp;<span class="op" id="3293913">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293916">return</span>&nbsp;<span class="ident" id="3293923">syscall</span><span class="op" id="3293930">.</span><span class="ident" id="3293931">Close</span><span class="op" id="3293936">(</span><span class="ident" id="3293937">s</span><span class="op" id="3293938">)</span><br>
<span class="lineno"></span><span class="op" id="3293940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3293943">func</span>&nbsp;<span class="ident" id="3293948">skipRawSocketTests</span><span class="op" id="3293966">(</span><span class="op" id="3293967">)</span>&nbsp;<span class="op" id="3293969">(</span><span class="ident" id="3293970">skip</span>&nbsp;<span class="builtintype" id="3293975">bool</span><span class="op" id="3293979">,</span>&nbsp;<span class="ident" id="3293981">skipmsg</span>&nbsp;<span class="builtintype" id="3293989">string</span><span class="op" id="3293995">,</span>&nbsp;<span class="ident" id="3293997">err</span>&nbsp;<span class="builtintype" id="3294001">error</span><span class="op" id="3294006">)</span>&nbsp;<span class="op" id="3294008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294011">if</span>&nbsp;<span class="ident" id="3294014">os</span><span class="op" id="3294016">.</span><span class="ident" id="3294017">Getuid</span><span class="op" id="3294023">(</span><span class="op" id="3294024">)</span>&nbsp;<span class="op" id="3294026">!=</span>&nbsp;<span class="num" id="3294029">0</span>&nbsp;<span class="op" id="3294031">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294035">return</span>&nbsp;<span class="builtintype" id="3294042">true</span><span class="op" id="3294046">,</span>&nbsp;<span class="string" id="3294048">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3294077">,</span>&nbsp;<span class="ident" id="3294079">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294087">return</span>&nbsp;<span class="builtintype" id="3294094">false</span><span class="op" id="3294099">,</span>&nbsp;<span class="string" id="3294101">&#34;&#34;</span><span class="op" id="3294103">,</span>&nbsp;<span class="ident" id="3294105">nil</span><br>
<span class="lineno"></span><span class="op" id="3294109">}</span>
</div>
</body>
</html>
