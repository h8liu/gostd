<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5890481">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5890536">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5890590">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5890641">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="5890702">//</span><br>
<span class="lineno"></span><span class="comment" id="5890705">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="5890784">package</span>&nbsp;<span class="ident" id="5890792">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5890798">import</span>&nbsp;<span class="op" id="5890805">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5890808">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5890817">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5890832">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5890837">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5890840">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5890917">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5890974">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="5891035">type</span>&nbsp;<span class="ident" id="5891040">FormatError</span>&nbsp;<span class="builtintype" id="5891052">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5891060">func</span>&nbsp;<span class="op" id="5891065">(</span><span class="ident" id="5891066">e</span>&nbsp;<span class="ident" id="5891068">FormatError</span><span class="op" id="5891079">)</span>&nbsp;<span class="ident" id="5891081">Error</span><span class="op" id="5891086">(</span><span class="op" id="5891087">)</span>&nbsp;<span class="builtintype" id="5891089">string</span>&nbsp;<span class="op" id="5891096">{</span>&nbsp;<span class="keyword" id="5891098">return</span>&nbsp;<span class="string" id="5891105">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="5891129">+</span>&nbsp;<span class="builtintype" id="5891131">string</span><span class="op" id="5891137">(</span><span class="ident" id="5891138">e</span><span class="op" id="5891139">)</span>&nbsp;<span class="op" id="5891141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5891144">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="5891235">type</span>&nbsp;<span class="ident" id="5891240">UnsupportedError</span>&nbsp;<span class="builtintype" id="5891257">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5891265">func</span>&nbsp;<span class="op" id="5891270">(</span><span class="ident" id="5891271">e</span>&nbsp;<span class="ident" id="5891273">UnsupportedError</span><span class="op" id="5891289">)</span>&nbsp;<span class="ident" id="5891291">Error</span><span class="op" id="5891296">(</span><span class="op" id="5891297">)</span>&nbsp;<span class="builtintype" id="5891299">string</span>&nbsp;<span class="op" id="5891306">{</span>&nbsp;<span class="keyword" id="5891308">return</span>&nbsp;<span class="string" id="5891315">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="5891344">+</span>&nbsp;<span class="builtintype" id="5891346">string</span><span class="op" id="5891352">(</span><span class="ident" id="5891353">e</span><span class="op" id="5891354">)</span>&nbsp;<span class="op" id="5891356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5891359">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="5891415">type</span>&nbsp;<span class="ident" id="5891420">component</span>&nbsp;<span class="keyword" id="5891430">struct</span>&nbsp;<span class="op" id="5891437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891440">h</span>&nbsp;&nbsp;<span class="builtintype" id="5891443">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5891449">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891481">v</span>&nbsp;&nbsp;<span class="builtintype" id="5891484">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5891490">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891520">c</span>&nbsp;&nbsp;<span class="builtintype" id="5891523">uint8</span>&nbsp;<span class="comment" id="5891529">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891555">tq</span>&nbsp;<span class="builtintype" id="5891558">uint8</span>&nbsp;<span class="comment" id="5891564">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="5891608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5891611">const</span>&nbsp;<span class="op" id="5891617">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891620">dcTable</span>&nbsp;<span class="op" id="5891628">=</span>&nbsp;<span class="num" id="5891630">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891633">acTable</span>&nbsp;<span class="op" id="5891641">=</span>&nbsp;<span class="num" id="5891643">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891646">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5891654">=</span>&nbsp;<span class="num" id="5891656">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891659">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5891667">=</span>&nbsp;<span class="num" id="5891669">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891672">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5891680">=</span>&nbsp;<span class="num" id="5891682">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891686">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891737">nGrayComponent</span>&nbsp;<span class="op" id="5891752">=</span>&nbsp;<span class="num" id="5891754">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891757">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891809">nColorComponent</span>&nbsp;<span class="op" id="5891825">=</span>&nbsp;<span class="num" id="5891827">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891831">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891913">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891989">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892026">maxH</span>&nbsp;<span class="op" id="5892031">=</span>&nbsp;<span class="num" id="5892033">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892036">maxV</span>&nbsp;<span class="op" id="5892041">=</span>&nbsp;<span class="num" id="5892043">2</span><br>
<span class="lineno"></span><span class="op" id="5892045">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5892048">const</span>&nbsp;<span class="op" id="5892054">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892057">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892069">=</span>&nbsp;<span class="num" id="5892071">0xd8</span>&nbsp;<span class="comment" id="5892076">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892096">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892108">=</span>&nbsp;<span class="num" id="5892110">0xd9</span>&nbsp;<span class="comment" id="5892115">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892133">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="5892145">=</span>&nbsp;<span class="num" id="5892147">0xc0</span>&nbsp;<span class="comment" id="5892152">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892183">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="5892195">=</span>&nbsp;<span class="num" id="5892197">0xc2</span>&nbsp;<span class="comment" id="5892202">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892236">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892248">=</span>&nbsp;<span class="num" id="5892250">0xc4</span>&nbsp;<span class="comment" id="5892255">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892281">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892293">=</span>&nbsp;<span class="num" id="5892295">0xdb</span>&nbsp;<span class="comment" id="5892300">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892331">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892343">=</span>&nbsp;<span class="num" id="5892345">0xda</span>&nbsp;<span class="comment" id="5892350">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892369">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892381">=</span>&nbsp;<span class="num" id="5892383">0xdd</span>&nbsp;<span class="comment" id="5892388">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892417">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="5892429">=</span>&nbsp;<span class="num" id="5892431">0xd0</span>&nbsp;<span class="comment" id="5892436">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892453">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="5892465">=</span>&nbsp;<span class="num" id="5892467">0xd7</span>&nbsp;<span class="comment" id="5892472">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892489">app0Marker</span>&nbsp;&nbsp;<span class="op" id="5892501">=</span>&nbsp;<span class="num" id="5892503">0xe0</span>&nbsp;<span class="comment" id="5892508">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892538">app15Marker</span>&nbsp;<span class="op" id="5892550">=</span>&nbsp;<span class="num" id="5892552">0xef</span>&nbsp;<span class="comment" id="5892557">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892588">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5892600">=</span>&nbsp;<span class="num" id="5892602">0xfe</span>&nbsp;<span class="comment" id="5892607">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="5892619">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5892622">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="5892700">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="5892778">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="5892858">var</span>&nbsp;<span class="ident" id="5892862">unzig</span>&nbsp;<span class="op" id="5892868">=</span>&nbsp;<span class="op" id="5892870">[</span><span class="ident" id="5892871">blockSize</span><span class="op" id="5892880">]</span><span class="builtintype" id="5892881">int</span><span class="op" id="5892884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5892887">0</span><span class="op" id="5892888">,</span>&nbsp;<span class="num" id="5892890">1</span><span class="op" id="5892891">,</span>&nbsp;<span class="num" id="5892893">8</span><span class="op" id="5892894">,</span>&nbsp;<span class="num" id="5892896">16</span><span class="op" id="5892898">,</span>&nbsp;<span class="num" id="5892900">9</span><span class="op" id="5892901">,</span>&nbsp;<span class="num" id="5892903">2</span><span class="op" id="5892904">,</span>&nbsp;<span class="num" id="5892906">3</span><span class="op" id="5892907">,</span>&nbsp;<span class="num" id="5892909">10</span><span class="op" id="5892911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5892914">17</span><span class="op" id="5892916">,</span>&nbsp;<span class="num" id="5892918">24</span><span class="op" id="5892920">,</span>&nbsp;<span class="num" id="5892922">32</span><span class="op" id="5892924">,</span>&nbsp;<span class="num" id="5892926">25</span><span class="op" id="5892928">,</span>&nbsp;<span class="num" id="5892930">18</span><span class="op" id="5892932">,</span>&nbsp;<span class="num" id="5892934">11</span><span class="op" id="5892936">,</span>&nbsp;<span class="num" id="5892938">4</span><span class="op" id="5892939">,</span>&nbsp;<span class="num" id="5892941">5</span><span class="op" id="5892942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5892945">12</span><span class="op" id="5892947">,</span>&nbsp;<span class="num" id="5892949">19</span><span class="op" id="5892951">,</span>&nbsp;<span class="num" id="5892953">26</span><span class="op" id="5892955">,</span>&nbsp;<span class="num" id="5892957">33</span><span class="op" id="5892959">,</span>&nbsp;<span class="num" id="5892961">40</span><span class="op" id="5892963">,</span>&nbsp;<span class="num" id="5892965">48</span><span class="op" id="5892967">,</span>&nbsp;<span class="num" id="5892969">41</span><span class="op" id="5892971">,</span>&nbsp;<span class="num" id="5892973">34</span><span class="op" id="5892975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5892978">27</span><span class="op" id="5892980">,</span>&nbsp;<span class="num" id="5892982">20</span><span class="op" id="5892984">,</span>&nbsp;<span class="num" id="5892986">13</span><span class="op" id="5892988">,</span>&nbsp;<span class="num" id="5892990">6</span><span class="op" id="5892991">,</span>&nbsp;<span class="num" id="5892993">7</span><span class="op" id="5892994">,</span>&nbsp;<span class="num" id="5892996">14</span><span class="op" id="5892998">,</span>&nbsp;<span class="num" id="5893000">21</span><span class="op" id="5893002">,</span>&nbsp;<span class="num" id="5893004">28</span><span class="op" id="5893006">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5893009">35</span><span class="op" id="5893011">,</span>&nbsp;<span class="num" id="5893013">42</span><span class="op" id="5893015">,</span>&nbsp;<span class="num" id="5893017">49</span><span class="op" id="5893019">,</span>&nbsp;<span class="num" id="5893021">56</span><span class="op" id="5893023">,</span>&nbsp;<span class="num" id="5893025">57</span><span class="op" id="5893027">,</span>&nbsp;<span class="num" id="5893029">50</span><span class="op" id="5893031">,</span>&nbsp;<span class="num" id="5893033">43</span><span class="op" id="5893035">,</span>&nbsp;<span class="num" id="5893037">36</span><span class="op" id="5893039">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5893042">29</span><span class="op" id="5893044">,</span>&nbsp;<span class="num" id="5893046">22</span><span class="op" id="5893048">,</span>&nbsp;<span class="num" id="5893050">15</span><span class="op" id="5893052">,</span>&nbsp;<span class="num" id="5893054">23</span><span class="op" id="5893056">,</span>&nbsp;<span class="num" id="5893058">30</span><span class="op" id="5893060">,</span>&nbsp;<span class="num" id="5893062">37</span><span class="op" id="5893064">,</span>&nbsp;<span class="num" id="5893066">44</span><span class="op" id="5893068">,</span>&nbsp;<span class="num" id="5893070">51</span><span class="op" id="5893072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5893075">58</span><span class="op" id="5893077">,</span>&nbsp;<span class="num" id="5893079">59</span><span class="op" id="5893081">,</span>&nbsp;<span class="num" id="5893083">52</span><span class="op" id="5893085">,</span>&nbsp;<span class="num" id="5893087">45</span><span class="op" id="5893089">,</span>&nbsp;<span class="num" id="5893091">38</span><span class="op" id="5893093">,</span>&nbsp;<span class="num" id="5893095">31</span><span class="op" id="5893097">,</span>&nbsp;<span class="num" id="5893099">39</span><span class="op" id="5893101">,</span>&nbsp;<span class="num" id="5893103">46</span><span class="op" id="5893105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="5893108">53</span><span class="op" id="5893110">,</span>&nbsp;<span class="num" id="5893112">60</span><span class="op" id="5893114">,</span>&nbsp;<span class="num" id="5893116">61</span><span class="op" id="5893118">,</span>&nbsp;<span class="num" id="5893120">54</span><span class="op" id="5893122">,</span>&nbsp;<span class="num" id="5893124">47</span><span class="op" id="5893126">,</span>&nbsp;<span class="num" id="5893128">55</span><span class="op" id="5893130">,</span>&nbsp;<span class="num" id="5893132">62</span><span class="op" id="5893134">,</span>&nbsp;<span class="num" id="5893136">63</span><span class="op" id="5893138">,</span><br>
<span class="lineno"></span><span class="op" id="5893140">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5893143">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="5893168">type</span>&nbsp;<span class="ident" id="5893173">Reader</span>&nbsp;<span class="keyword" id="5893180">interface</span>&nbsp;<span class="op" id="5893190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893193">io</span><span class="op" id="5893195">.</span><span class="ident" id="5893196">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893208">io</span><span class="op" id="5893210">.</span><span class="ident" id="5893211">Reader</span><br>
<span class="lineno">90</span><span class="op" id="5893218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5893221">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="5893299">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5893379">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="5893393">type</span>&nbsp;<span class="ident" id="5893398">bits</span>&nbsp;<span class="keyword" id="5893403">struct</span>&nbsp;<span class="op" id="5893410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893413">a</span>&nbsp;<span class="builtintype" id="5893415">uint32</span>&nbsp;<span class="comment" id="5893422">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893439">m</span>&nbsp;<span class="builtintype" id="5893441">uint32</span>&nbsp;<span class="comment" id="5893448">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893501">n</span>&nbsp;<span class="builtintype" id="5893503">int32</span>&nbsp;&nbsp;<span class="comment" id="5893510">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="5893545">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="5893548">type</span>&nbsp;<span class="ident" id="5893553">decoder</span>&nbsp;<span class="keyword" id="5893561">struct</span>&nbsp;<span class="op" id="5893568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893571">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5893576">io</span><span class="op" id="5893578">.</span><span class="ident" id="5893579">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893587">bits</span>&nbsp;<span class="ident" id="5893592">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893598">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893668">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893737">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893788">bytes</span>&nbsp;<span class="keyword" id="5893794">struct</span>&nbsp;<span class="op" id="5893801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893805">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893867">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893923">buf</span>&nbsp;&nbsp;<span class="op" id="5893928">[</span><span class="num" id="5893929">4096</span><span class="op" id="5893933">]</span><span class="builtintype" id="5893934">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893941">i</span><span class="op" id="5893942">,</span>&nbsp;<span class="ident" id="5893944">j</span>&nbsp;<span class="builtintype" id="5893946">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5893952">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894011">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894051">nUnreadable</span>&nbsp;<span class="builtintype" id="5894063">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894071">width</span><span class="op" id="5894076">,</span>&nbsp;<span class="ident" id="5894078">height</span>&nbsp;<span class="builtintype" id="5894085">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894090">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894104">*</span><span class="ident" id="5894105">image</span><span class="op" id="5894110">.</span><span class="ident" id="5894111">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894117">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894131">*</span><span class="ident" id="5894132">image</span><span class="op" id="5894137">.</span><span class="ident" id="5894138">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894145">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5894159">int</span>&nbsp;<span class="comment" id="5894163">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894185">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5894199">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894204">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5894218">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894224">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5894238">uint16</span>&nbsp;<span class="comment" id="5894245">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894296">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894310">[</span><span class="ident" id="5894311">nColorComponent</span><span class="op" id="5894326">]</span><span class="ident" id="5894327">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894338">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894352">[</span><span class="ident" id="5894353">nColorComponent</span><span class="op" id="5894368">]</span><span class="op" id="5894369">[</span><span class="op" id="5894370">]</span><span class="ident" id="5894371">block</span>&nbsp;<span class="comment" id="5894377">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894425">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894439">[</span><span class="ident" id="5894440">maxTc</span>&nbsp;<span class="op" id="5894446">+</span>&nbsp;<span class="num" id="5894448">1</span><span class="op" id="5894449">]</span><span class="op" id="5894450">[</span><span class="ident" id="5894451">maxTh</span>&nbsp;<span class="op" id="5894457">+</span>&nbsp;<span class="num" id="5894459">1</span><span class="op" id="5894460">]</span><span class="ident" id="5894461">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894470">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894484">[</span><span class="ident" id="5894485">maxTq</span>&nbsp;<span class="op" id="5894491">+</span>&nbsp;<span class="num" id="5894493">1</span><span class="op" id="5894494">]</span><span class="ident" id="5894495">block</span>&nbsp;<span class="comment" id="5894501">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894544">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5894558">[</span><span class="ident" id="5894559">blockSize</span>&nbsp;<span class="op" id="5894569">+</span>&nbsp;<span class="num" id="5894571">1</span><span class="op" id="5894572">]</span><span class="builtintype" id="5894573">byte</span><br>
<span class="lineno"></span><span class="op" id="5894578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5894581">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="5894655">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5894723">func</span>&nbsp;<span class="op" id="5894728">(</span><span class="ident" id="5894729">d</span>&nbsp;<span class="op" id="5894731">*</span><span class="ident" id="5894732">decoder</span><span class="op" id="5894739">)</span>&nbsp;<span class="ident" id="5894741">fill</span><span class="op" id="5894745">(</span><span class="op" id="5894746">)</span>&nbsp;<span class="builtintype" id="5894748">error</span>&nbsp;<span class="op" id="5894754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894757">if</span>&nbsp;<span class="ident" id="5894760">d</span><span class="op" id="5894761">.</span><span class="ident" id="5894762">bytes</span><span class="op" id="5894767">.</span><span class="ident" id="5894768">i</span>&nbsp;<span class="op" id="5894770">!=</span>&nbsp;<span class="ident" id="5894773">d</span><span class="op" id="5894774">.</span><span class="ident" id="5894775">bytes</span><span class="op" id="5894780">.</span><span class="ident" id="5894781">j</span>&nbsp;<span class="op" id="5894783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5894787">panic</span><span class="op" id="5894792">(</span><span class="string" id="5894793">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="5894836">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5894839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894842">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5894912">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5894947">if</span>&nbsp;<span class="ident" id="5894950">d</span><span class="op" id="5894951">.</span><span class="ident" id="5894952">bytes</span><span class="op" id="5894957">.</span><span class="ident" id="5894958">j</span>&nbsp;<span class="op" id="5894960">&gt;</span>&nbsp;<span class="num" id="5894962">2</span>&nbsp;<span class="op" id="5894964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5894968">d</span><span class="op" id="5894969">.</span><span class="ident" id="5894970">bytes</span><span class="op" id="5894975">.</span><span class="ident" id="5894976">buf</span><span class="op" id="5894979">[</span><span class="num" id="5894980">0</span><span class="op" id="5894981">]</span>&nbsp;<span class="op" id="5894983">=</span>&nbsp;<span class="ident" id="5894985">d</span><span class="op" id="5894986">.</span><span class="ident" id="5894987">bytes</span><span class="op" id="5894992">.</span><span class="ident" id="5894993">buf</span><span class="op" id="5894996">[</span><span class="ident" id="5894997">d</span><span class="op" id="5894998">.</span><span class="ident" id="5894999">bytes</span><span class="op" id="5895004">.</span><span class="ident" id="5895005">j</span><span class="op" id="5895006">-</span><span class="num" id="5895007">2</span><span class="op" id="5895008">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895012">d</span><span class="op" id="5895013">.</span><span class="ident" id="5895014">bytes</span><span class="op" id="5895019">.</span><span class="ident" id="5895020">buf</span><span class="op" id="5895023">[</span><span class="num" id="5895024">1</span><span class="op" id="5895025">]</span>&nbsp;<span class="op" id="5895027">=</span>&nbsp;<span class="ident" id="5895029">d</span><span class="op" id="5895030">.</span><span class="ident" id="5895031">bytes</span><span class="op" id="5895036">.</span><span class="ident" id="5895037">buf</span><span class="op" id="5895040">[</span><span class="ident" id="5895041">d</span><span class="op" id="5895042">.</span><span class="ident" id="5895043">bytes</span><span class="op" id="5895048">.</span><span class="ident" id="5895049">j</span><span class="op" id="5895050">-</span><span class="num" id="5895051">1</span><span class="op" id="5895052">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895056">d</span><span class="op" id="5895057">.</span><span class="ident" id="5895058">bytes</span><span class="op" id="5895063">.</span><span class="ident" id="5895064">i</span><span class="op" id="5895065">,</span>&nbsp;<span class="ident" id="5895067">d</span><span class="op" id="5895068">.</span><span class="ident" id="5895069">bytes</span><span class="op" id="5895074">.</span><span class="ident" id="5895075">j</span>&nbsp;<span class="op" id="5895077">=</span>&nbsp;<span class="num" id="5895079">2</span><span class="op" id="5895080">,</span>&nbsp;<span class="num" id="5895082">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5895088">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895124">n</span><span class="op" id="5895125">,</span>&nbsp;<span class="ident" id="5895127">err</span>&nbsp;<span class="op" id="5895131">:=</span>&nbsp;<span class="ident" id="5895134">d</span><span class="op" id="5895135">.</span><span class="ident" id="5895136">r</span><span class="op" id="5895137">.</span><span class="ident" id="5895138">Read</span><span class="op" id="5895142">(</span><span class="ident" id="5895143">d</span><span class="op" id="5895144">.</span><span class="ident" id="5895145">bytes</span><span class="op" id="5895150">.</span><span class="ident" id="5895151">buf</span><span class="op" id="5895154">[</span><span class="ident" id="5895155">d</span><span class="op" id="5895156">.</span><span class="ident" id="5895157">bytes</span><span class="op" id="5895162">.</span><span class="ident" id="5895163">j</span><span class="op" id="5895164">:</span><span class="op" id="5895165">]</span><span class="op" id="5895166">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895169">d</span><span class="op" id="5895170">.</span><span class="ident" id="5895171">bytes</span><span class="op" id="5895176">.</span><span class="ident" id="5895177">j</span>&nbsp;<span class="op" id="5895179">+=</span>&nbsp;<span class="ident" id="5895182">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895185">if</span>&nbsp;<span class="ident" id="5895188">n</span>&nbsp;<span class="op" id="5895190">&gt;</span>&nbsp;<span class="num" id="5895192">0</span>&nbsp;<span class="op" id="5895194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895198">err</span>&nbsp;<span class="op" id="5895202">=</span>&nbsp;<span class="ident" id="5895204">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895212">return</span>&nbsp;<span class="ident" id="5895219">err</span><br>
<span class="lineno">150</span><span class="op" id="5895223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5895226">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="5895300">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="5895380">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="5895459">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="5895537">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="5895605">func</span>&nbsp;<span class="op" id="5895610">(</span><span class="ident" id="5895611">d</span>&nbsp;<span class="op" id="5895613">*</span><span class="ident" id="5895614">decoder</span><span class="op" id="5895621">)</span>&nbsp;<span class="ident" id="5895623">unreadByteStuffedByte</span><span class="op" id="5895644">(</span><span class="op" id="5895645">)</span>&nbsp;<span class="op" id="5895647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895650">if</span>&nbsp;<span class="ident" id="5895653">d</span><span class="op" id="5895654">.</span><span class="ident" id="5895655">bytes</span><span class="op" id="5895660">.</span><span class="ident" id="5895661">nUnreadable</span>&nbsp;<span class="op" id="5895673">==</span>&nbsp;<span class="num" id="5895676">0</span>&nbsp;<span class="op" id="5895678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5895682">panic</span><span class="op" id="5895687">(</span><span class="string" id="5895688">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="5895742">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895748">d</span><span class="op" id="5895749">.</span><span class="ident" id="5895750">bytes</span><span class="op" id="5895755">.</span><span class="ident" id="5895756">i</span>&nbsp;<span class="op" id="5895758">-=</span>&nbsp;<span class="ident" id="5895761">d</span><span class="op" id="5895762">.</span><span class="ident" id="5895763">bytes</span><span class="op" id="5895768">.</span><span class="ident" id="5895769">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895782">d</span><span class="op" id="5895783">.</span><span class="ident" id="5895784">bytes</span><span class="op" id="5895789">.</span><span class="ident" id="5895790">nUnreadable</span>&nbsp;<span class="op" id="5895802">=</span>&nbsp;<span class="num" id="5895804">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5895807">if</span>&nbsp;<span class="ident" id="5895810">d</span><span class="op" id="5895811">.</span><span class="ident" id="5895812">bits</span><span class="op" id="5895816">.</span><span class="ident" id="5895817">n</span>&nbsp;<span class="op" id="5895819">&gt;=</span>&nbsp;<span class="num" id="5895822">8</span>&nbsp;<span class="op" id="5895824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895828">d</span><span class="op" id="5895829">.</span><span class="ident" id="5895830">bits</span><span class="op" id="5895834">.</span><span class="ident" id="5895835">a</span>&nbsp;<span class="op" id="5895837">&gt;&gt;=</span>&nbsp;<span class="num" id="5895841">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895845">d</span><span class="op" id="5895846">.</span><span class="ident" id="5895847">bits</span><span class="op" id="5895851">.</span><span class="ident" id="5895852">n</span>&nbsp;<span class="op" id="5895854">-=</span>&nbsp;<span class="num" id="5895857">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5895861">d</span><span class="op" id="5895862">.</span><span class="ident" id="5895863">bits</span><span class="op" id="5895867">.</span><span class="ident" id="5895868">m</span>&nbsp;<span class="op" id="5895870">&gt;&gt;=</span>&nbsp;<span class="num" id="5895874">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5895877">}</span><br>
<span class="lineno"></span><span class="op" id="5895879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="5895882">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="5895959">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5895992">func</span>&nbsp;<span class="op" id="5895997">(</span><span class="ident" id="5895998">d</span>&nbsp;<span class="op" id="5896000">*</span><span class="ident" id="5896001">decoder</span><span class="op" id="5896008">)</span>&nbsp;<span class="ident" id="5896010">readByte</span><span class="op" id="5896018">(</span><span class="op" id="5896019">)</span>&nbsp;<span class="op" id="5896021">(</span><span class="ident" id="5896022">x</span>&nbsp;<span class="builtintype" id="5896024">byte</span><span class="op" id="5896028">,</span>&nbsp;<span class="ident" id="5896030">err</span>&nbsp;<span class="builtintype" id="5896034">error</span><span class="op" id="5896039">)</span>&nbsp;<span class="op" id="5896041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896044">for</span>&nbsp;<span class="ident" id="5896048">d</span><span class="op" id="5896049">.</span><span class="ident" id="5896050">bytes</span><span class="op" id="5896055">.</span><span class="ident" id="5896056">i</span>&nbsp;<span class="op" id="5896058">==</span>&nbsp;<span class="ident" id="5896061">d</span><span class="op" id="5896062">.</span><span class="ident" id="5896063">bytes</span><span class="op" id="5896068">.</span><span class="ident" id="5896069">j</span>&nbsp;<span class="op" id="5896071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896075">if</span>&nbsp;<span class="ident" id="5896078">err</span>&nbsp;<span class="op" id="5896082">=</span>&nbsp;<span class="ident" id="5896084">d</span><span class="op" id="5896085">.</span><span class="ident" id="5896086">fill</span><span class="op" id="5896090">(</span><span class="op" id="5896091">)</span><span class="op" id="5896092">;</span>&nbsp;<span class="ident" id="5896094">err</span>&nbsp;<span class="op" id="5896098">!=</span>&nbsp;<span class="ident" id="5896101">nil</span>&nbsp;<span class="op" id="5896105">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896110">return</span>&nbsp;<span class="num" id="5896117">0</span><span class="op" id="5896118">,</span>&nbsp;<span class="ident" id="5896120">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896132">x</span>&nbsp;<span class="op" id="5896134">=</span>&nbsp;<span class="ident" id="5896136">d</span><span class="op" id="5896137">.</span><span class="ident" id="5896138">bytes</span><span class="op" id="5896143">.</span><span class="ident" id="5896144">buf</span><span class="op" id="5896147">[</span><span class="ident" id="5896148">d</span><span class="op" id="5896149">.</span><span class="ident" id="5896150">bytes</span><span class="op" id="5896155">.</span><span class="ident" id="5896156">i</span><span class="op" id="5896157">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896160">d</span><span class="op" id="5896161">.</span><span class="ident" id="5896162">bytes</span><span class="op" id="5896167">.</span><span class="ident" id="5896168">i</span><span class="op" id="5896169">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896173">d</span><span class="op" id="5896174">.</span><span class="ident" id="5896175">bytes</span><span class="op" id="5896180">.</span><span class="ident" id="5896181">nUnreadable</span>&nbsp;<span class="op" id="5896193">=</span>&nbsp;<span class="num" id="5896195">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896198">return</span>&nbsp;<span class="ident" id="5896205">x</span><span class="op" id="5896206">,</span>&nbsp;<span class="ident" id="5896208">nil</span><br>
<span class="lineno"></span><span class="op" id="5896212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5896215">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="5896292">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="5896367">var</span>&nbsp;<span class="ident" id="5896371">errMissingFF00</span>&nbsp;<span class="op" id="5896386">=</span>&nbsp;<span class="ident" id="5896388">FormatError</span><span class="op" id="5896399">(</span><span class="string" id="5896400">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="5896425">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5896428">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5896506">func</span>&nbsp;<span class="op" id="5896511">(</span><span class="ident" id="5896512">d</span>&nbsp;<span class="op" id="5896514">*</span><span class="ident" id="5896515">decoder</span><span class="op" id="5896522">)</span>&nbsp;<span class="ident" id="5896524">readByteStuffedByte</span><span class="op" id="5896543">(</span><span class="op" id="5896544">)</span>&nbsp;<span class="op" id="5896546">(</span><span class="ident" id="5896547">x</span>&nbsp;<span class="builtintype" id="5896549">byte</span><span class="op" id="5896553">,</span>&nbsp;<span class="ident" id="5896555">err</span>&nbsp;<span class="builtintype" id="5896559">error</span><span class="op" id="5896564">)</span>&nbsp;<span class="op" id="5896566">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5896569">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896636">if</span>&nbsp;<span class="ident" id="5896639">d</span><span class="op" id="5896640">.</span><span class="ident" id="5896641">bytes</span><span class="op" id="5896646">.</span><span class="ident" id="5896647">i</span><span class="op" id="5896648">+</span><span class="num" id="5896649">2</span>&nbsp;<span class="op" id="5896651">&lt;=</span>&nbsp;<span class="ident" id="5896654">d</span><span class="op" id="5896655">.</span><span class="ident" id="5896656">bytes</span><span class="op" id="5896661">.</span><span class="ident" id="5896662">j</span>&nbsp;<span class="op" id="5896664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896668">x</span>&nbsp;<span class="op" id="5896670">=</span>&nbsp;<span class="ident" id="5896672">d</span><span class="op" id="5896673">.</span><span class="ident" id="5896674">bytes</span><span class="op" id="5896679">.</span><span class="ident" id="5896680">buf</span><span class="op" id="5896683">[</span><span class="ident" id="5896684">d</span><span class="op" id="5896685">.</span><span class="ident" id="5896686">bytes</span><span class="op" id="5896691">.</span><span class="ident" id="5896692">i</span><span class="op" id="5896693">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896697">d</span><span class="op" id="5896698">.</span><span class="ident" id="5896699">bytes</span><span class="op" id="5896704">.</span><span class="ident" id="5896705">i</span><span class="op" id="5896706">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896711">d</span><span class="op" id="5896712">.</span><span class="ident" id="5896713">bytes</span><span class="op" id="5896718">.</span><span class="ident" id="5896719">nUnreadable</span>&nbsp;<span class="op" id="5896731">=</span>&nbsp;<span class="num" id="5896733">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896737">if</span>&nbsp;<span class="ident" id="5896740">x</span>&nbsp;<span class="op" id="5896742">!=</span>&nbsp;<span class="num" id="5896745">0xff</span>&nbsp;<span class="op" id="5896750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896755">return</span>&nbsp;<span class="ident" id="5896762">x</span><span class="op" id="5896763">,</span>&nbsp;<span class="ident" id="5896765">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896775">if</span>&nbsp;<span class="ident" id="5896778">d</span><span class="op" id="5896779">.</span><span class="ident" id="5896780">bytes</span><span class="op" id="5896785">.</span><span class="ident" id="5896786">buf</span><span class="op" id="5896789">[</span><span class="ident" id="5896790">d</span><span class="op" id="5896791">.</span><span class="ident" id="5896792">bytes</span><span class="op" id="5896797">.</span><span class="ident" id="5896798">i</span><span class="op" id="5896799">]</span>&nbsp;<span class="op" id="5896801">!=</span>&nbsp;<span class="num" id="5896804">0x00</span>&nbsp;<span class="op" id="5896809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896814">return</span>&nbsp;<span class="num" id="5896821">0</span><span class="op" id="5896822">,</span>&nbsp;<span class="ident" id="5896824">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896845">d</span><span class="op" id="5896846">.</span><span class="ident" id="5896847">bytes</span><span class="op" id="5896852">.</span><span class="ident" id="5896853">i</span><span class="op" id="5896854">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896859">d</span><span class="op" id="5896860">.</span><span class="ident" id="5896861">bytes</span><span class="op" id="5896866">.</span><span class="ident" id="5896867">nUnreadable</span>&nbsp;<span class="op" id="5896879">=</span>&nbsp;<span class="num" id="5896881">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896885">return</span>&nbsp;<span class="num" id="5896892">0xff</span><span class="op" id="5896896">,</span>&nbsp;<span class="ident" id="5896898">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896903">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896907">x</span><span class="op" id="5896908">,</span>&nbsp;<span class="ident" id="5896910">err</span>&nbsp;<span class="op" id="5896914">=</span>&nbsp;<span class="ident" id="5896916">d</span><span class="op" id="5896917">.</span><span class="ident" id="5896918">readByte</span><span class="op" id="5896926">(</span><span class="op" id="5896927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896930">if</span>&nbsp;<span class="ident" id="5896933">err</span>&nbsp;<span class="op" id="5896937">!=</span>&nbsp;<span class="ident" id="5896940">nil</span>&nbsp;<span class="op" id="5896944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896948">return</span>&nbsp;<span class="num" id="5896955">0</span><span class="op" id="5896956">,</span>&nbsp;<span class="ident" id="5896958">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5896963">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5896966">if</span>&nbsp;<span class="ident" id="5896969">x</span>&nbsp;<span class="op" id="5896971">!=</span>&nbsp;<span class="num" id="5896974">0xff</span>&nbsp;<span class="op" id="5896979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5896983">d</span><span class="op" id="5896984">.</span><span class="ident" id="5896985">bytes</span><span class="op" id="5896990">.</span><span class="ident" id="5896991">nUnreadable</span>&nbsp;<span class="op" id="5897003">=</span>&nbsp;<span class="num" id="5897005">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897009">return</span>&nbsp;<span class="ident" id="5897016">x</span><span class="op" id="5897017">,</span>&nbsp;<span class="ident" id="5897019">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897028">x</span><span class="op" id="5897029">,</span>&nbsp;<span class="ident" id="5897031">err</span>&nbsp;<span class="op" id="5897035">=</span>&nbsp;<span class="ident" id="5897037">d</span><span class="op" id="5897038">.</span><span class="ident" id="5897039">readByte</span><span class="op" id="5897047">(</span><span class="op" id="5897048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897051">if</span>&nbsp;<span class="ident" id="5897054">err</span>&nbsp;<span class="op" id="5897058">!=</span>&nbsp;<span class="ident" id="5897061">nil</span>&nbsp;<span class="op" id="5897065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897069">d</span><span class="op" id="5897070">.</span><span class="ident" id="5897071">bytes</span><span class="op" id="5897076">.</span><span class="ident" id="5897077">nUnreadable</span>&nbsp;<span class="op" id="5897089">=</span>&nbsp;<span class="num" id="5897091">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897095">return</span>&nbsp;<span class="num" id="5897102">0</span><span class="op" id="5897103">,</span>&nbsp;<span class="ident" id="5897105">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897110">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897113">d</span><span class="op" id="5897114">.</span><span class="ident" id="5897115">bytes</span><span class="op" id="5897120">.</span><span class="ident" id="5897121">nUnreadable</span>&nbsp;<span class="op" id="5897133">=</span>&nbsp;<span class="num" id="5897135">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897138">if</span>&nbsp;<span class="ident" id="5897141">x</span>&nbsp;<span class="op" id="5897143">!=</span>&nbsp;<span class="num" id="5897146">0x00</span>&nbsp;<span class="op" id="5897151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897155">return</span>&nbsp;<span class="num" id="5897162">0</span><span class="op" id="5897163">,</span>&nbsp;<span class="ident" id="5897165">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897184">return</span>&nbsp;<span class="num" id="5897191">0xff</span><span class="op" id="5897195">,</span>&nbsp;<span class="ident" id="5897197">nil</span><br>
<span class="lineno">225</span><span class="op" id="5897201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5897204">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5897279">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="5897292">func</span>&nbsp;<span class="op" id="5897297">(</span><span class="ident" id="5897298">d</span>&nbsp;<span class="op" id="5897300">*</span><span class="ident" id="5897301">decoder</span><span class="op" id="5897308">)</span>&nbsp;<span class="ident" id="5897310">readFull</span><span class="op" id="5897318">(</span><span class="ident" id="5897319">p</span>&nbsp;<span class="op" id="5897321">[</span><span class="op" id="5897322">]</span><span class="builtintype" id="5897323">byte</span><span class="op" id="5897327">)</span>&nbsp;<span class="builtintype" id="5897329">error</span>&nbsp;<span class="op" id="5897335">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897338">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897377">if</span>&nbsp;<span class="ident" id="5897380">d</span><span class="op" id="5897381">.</span><span class="ident" id="5897382">bytes</span><span class="op" id="5897387">.</span><span class="ident" id="5897388">nUnreadable</span>&nbsp;<span class="op" id="5897400">!=</span>&nbsp;<span class="num" id="5897403">0</span>&nbsp;<span class="op" id="5897405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897409">if</span>&nbsp;<span class="ident" id="5897412">d</span><span class="op" id="5897413">.</span><span class="ident" id="5897414">bits</span><span class="op" id="5897418">.</span><span class="ident" id="5897419">n</span>&nbsp;<span class="op" id="5897421">&gt;=</span>&nbsp;<span class="num" id="5897424">8</span>&nbsp;<span class="op" id="5897426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897431">d</span><span class="op" id="5897432">.</span><span class="ident" id="5897433">unreadByteStuffedByte</span><span class="op" id="5897454">(</span><span class="op" id="5897455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897459">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897463">d</span><span class="op" id="5897464">.</span><span class="ident" id="5897465">bytes</span><span class="op" id="5897470">.</span><span class="ident" id="5897471">nUnreadable</span>&nbsp;<span class="op" id="5897483">=</span>&nbsp;<span class="num" id="5897485">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897492">for</span>&nbsp;<span class="op" id="5897496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897500">n</span>&nbsp;<span class="op" id="5897502">:=</span>&nbsp;<span class="builtinfunc" id="5897505">copy</span><span class="op" id="5897509">(</span><span class="ident" id="5897510">p</span><span class="op" id="5897511">,</span>&nbsp;<span class="ident" id="5897513">d</span><span class="op" id="5897514">.</span><span class="ident" id="5897515">bytes</span><span class="op" id="5897520">.</span><span class="ident" id="5897521">buf</span><span class="op" id="5897524">[</span><span class="ident" id="5897525">d</span><span class="op" id="5897526">.</span><span class="ident" id="5897527">bytes</span><span class="op" id="5897532">.</span><span class="ident" id="5897533">i</span><span class="op" id="5897534">:</span><span class="ident" id="5897535">d</span><span class="op" id="5897536">.</span><span class="ident" id="5897537">bytes</span><span class="op" id="5897542">.</span><span class="ident" id="5897543">j</span><span class="op" id="5897544">]</span><span class="op" id="5897545">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897549">p</span>&nbsp;<span class="op" id="5897551">=</span>&nbsp;<span class="ident" id="5897553">p</span><span class="op" id="5897554">[</span><span class="ident" id="5897555">n</span><span class="op" id="5897556">:</span><span class="op" id="5897557">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897561">d</span><span class="op" id="5897562">.</span><span class="ident" id="5897563">bytes</span><span class="op" id="5897568">.</span><span class="ident" id="5897569">i</span>&nbsp;<span class="op" id="5897571">+=</span>&nbsp;<span class="ident" id="5897574">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897578">if</span>&nbsp;<span class="builtinfunc" id="5897581">len</span><span class="op" id="5897584">(</span><span class="ident" id="5897585">p</span><span class="op" id="5897586">)</span>&nbsp;<span class="op" id="5897588">==</span>&nbsp;<span class="num" id="5897591">0</span>&nbsp;<span class="op" id="5897593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897598">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897606">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897610">if</span>&nbsp;<span class="ident" id="5897613">err</span>&nbsp;<span class="op" id="5897617">:=</span>&nbsp;<span class="ident" id="5897620">d</span><span class="op" id="5897621">.</span><span class="ident" id="5897622">fill</span><span class="op" id="5897626">(</span><span class="op" id="5897627">)</span><span class="op" id="5897628">;</span>&nbsp;<span class="ident" id="5897630">err</span>&nbsp;<span class="op" id="5897634">!=</span>&nbsp;<span class="ident" id="5897637">nil</span>&nbsp;<span class="op" id="5897641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897646">if</span>&nbsp;<span class="ident" id="5897649">err</span>&nbsp;<span class="op" id="5897653">==</span>&nbsp;<span class="ident" id="5897656">io</span><span class="op" id="5897658">.</span><span class="ident" id="5897659">EOF</span>&nbsp;<span class="op" id="5897663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897669">err</span>&nbsp;<span class="op" id="5897673">=</span>&nbsp;<span class="ident" id="5897675">io</span><span class="op" id="5897677">.</span><span class="ident" id="5897678">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897703">return</span>&nbsp;<span class="ident" id="5897710">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897722">return</span>&nbsp;<span class="ident" id="5897729">nil</span><br>
<span class="lineno"></span><span class="op" id="5897733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5897736">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5897772">func</span>&nbsp;<span class="op" id="5897777">(</span><span class="ident" id="5897778">d</span>&nbsp;<span class="op" id="5897780">*</span><span class="ident" id="5897781">decoder</span><span class="op" id="5897788">)</span>&nbsp;<span class="ident" id="5897790">ignore</span><span class="op" id="5897796">(</span><span class="ident" id="5897797">n</span>&nbsp;<span class="builtintype" id="5897799">int</span><span class="op" id="5897802">)</span>&nbsp;<span class="builtintype" id="5897804">error</span>&nbsp;<span class="op" id="5897810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5897813">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897852">if</span>&nbsp;<span class="ident" id="5897855">d</span><span class="op" id="5897856">.</span><span class="ident" id="5897857">bytes</span><span class="op" id="5897862">.</span><span class="ident" id="5897863">nUnreadable</span>&nbsp;<span class="op" id="5897875">!=</span>&nbsp;<span class="num" id="5897878">0</span>&nbsp;<span class="op" id="5897880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897884">if</span>&nbsp;<span class="ident" id="5897887">d</span><span class="op" id="5897888">.</span><span class="ident" id="5897889">bits</span><span class="op" id="5897893">.</span><span class="ident" id="5897894">n</span>&nbsp;<span class="op" id="5897896">&gt;=</span>&nbsp;<span class="num" id="5897899">8</span>&nbsp;<span class="op" id="5897901">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897906">d</span><span class="op" id="5897907">.</span><span class="ident" id="5897908">unreadByteStuffedByte</span><span class="op" id="5897929">(</span><span class="op" id="5897930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897938">d</span><span class="op" id="5897939">.</span><span class="ident" id="5897940">bytes</span><span class="op" id="5897945">.</span><span class="ident" id="5897946">nUnreadable</span>&nbsp;<span class="op" id="5897958">=</span>&nbsp;<span class="num" id="5897960">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5897963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5897967">for</span>&nbsp;<span class="op" id="5897971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5897975">m</span>&nbsp;<span class="op" id="5897977">:=</span>&nbsp;<span class="ident" id="5897980">d</span><span class="op" id="5897981">.</span><span class="ident" id="5897982">bytes</span><span class="op" id="5897987">.</span><span class="ident" id="5897988">j</span>&nbsp;<span class="op" id="5897990">-</span>&nbsp;<span class="ident" id="5897992">d</span><span class="op" id="5897993">.</span><span class="ident" id="5897994">bytes</span><span class="op" id="5897999">.</span><span class="ident" id="5898000">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898004">if</span>&nbsp;<span class="ident" id="5898007">m</span>&nbsp;<span class="op" id="5898009">&gt;</span>&nbsp;<span class="ident" id="5898011">n</span>&nbsp;<span class="op" id="5898013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898018">m</span>&nbsp;<span class="op" id="5898020">=</span>&nbsp;<span class="ident" id="5898022">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898026">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898030">d</span><span class="op" id="5898031">.</span><span class="ident" id="5898032">bytes</span><span class="op" id="5898037">.</span><span class="ident" id="5898038">i</span>&nbsp;<span class="op" id="5898040">+=</span>&nbsp;<span class="ident" id="5898043">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898047">n</span>&nbsp;<span class="op" id="5898049">-=</span>&nbsp;<span class="ident" id="5898052">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898056">if</span>&nbsp;<span class="ident" id="5898059">n</span>&nbsp;<span class="op" id="5898061">==</span>&nbsp;<span class="num" id="5898064">0</span>&nbsp;<span class="op" id="5898066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898071">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898079">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898083">if</span>&nbsp;<span class="ident" id="5898086">err</span>&nbsp;<span class="op" id="5898090">:=</span>&nbsp;<span class="ident" id="5898093">d</span><span class="op" id="5898094">.</span><span class="ident" id="5898095">fill</span><span class="op" id="5898099">(</span><span class="op" id="5898100">)</span><span class="op" id="5898101">;</span>&nbsp;<span class="ident" id="5898103">err</span>&nbsp;<span class="op" id="5898107">!=</span>&nbsp;<span class="ident" id="5898110">nil</span>&nbsp;<span class="op" id="5898114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898119">if</span>&nbsp;<span class="ident" id="5898122">err</span>&nbsp;<span class="op" id="5898126">==</span>&nbsp;<span class="ident" id="5898129">io</span><span class="op" id="5898131">.</span><span class="ident" id="5898132">EOF</span>&nbsp;<span class="op" id="5898136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898142">err</span>&nbsp;<span class="op" id="5898146">=</span>&nbsp;<span class="ident" id="5898148">io</span><span class="op" id="5898150">.</span><span class="ident" id="5898151">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898176">return</span>&nbsp;<span class="ident" id="5898183">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898195">return</span>&nbsp;<span class="ident" id="5898202">nil</span><br>
<span class="lineno"></span><span class="op" id="5898206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5898209">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5898240">func</span>&nbsp;<span class="op" id="5898245">(</span><span class="ident" id="5898246">d</span>&nbsp;<span class="op" id="5898248">*</span><span class="ident" id="5898249">decoder</span><span class="op" id="5898256">)</span>&nbsp;<span class="ident" id="5898258">processSOF</span><span class="op" id="5898268">(</span><span class="ident" id="5898269">n</span>&nbsp;<span class="builtintype" id="5898271">int</span><span class="op" id="5898274">)</span>&nbsp;<span class="builtintype" id="5898276">error</span>&nbsp;<span class="op" id="5898282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898285">switch</span>&nbsp;<span class="ident" id="5898292">n</span>&nbsp;<span class="op" id="5898294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898297">case</span>&nbsp;<span class="num" id="5898302">6</span>&nbsp;<span class="op" id="5898304">+</span>&nbsp;<span class="num" id="5898306">3</span><span class="op" id="5898307">*</span><span class="ident" id="5898308">nGrayComponent</span><span class="op" id="5898322">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898326">d</span><span class="op" id="5898327">.</span><span class="ident" id="5898328">nComp</span>&nbsp;<span class="op" id="5898334">=</span>&nbsp;<span class="ident" id="5898336">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898352">case</span>&nbsp;<span class="num" id="5898357">6</span>&nbsp;<span class="op" id="5898359">+</span>&nbsp;<span class="num" id="5898361">3</span><span class="op" id="5898362">*</span><span class="ident" id="5898363">nColorComponent</span><span class="op" id="5898378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898382">d</span><span class="op" id="5898383">.</span><span class="ident" id="5898384">nComp</span>&nbsp;<span class="op" id="5898390">=</span>&nbsp;<span class="ident" id="5898392">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898409">default</span><span class="op" id="5898416">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898420">return</span>&nbsp;<span class="ident" id="5898427">UnsupportedError</span><span class="op" id="5898443">(</span><span class="string" id="5898444">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5898466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898469">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898472">if</span>&nbsp;<span class="ident" id="5898475">err</span>&nbsp;<span class="op" id="5898479">:=</span>&nbsp;<span class="ident" id="5898482">d</span><span class="op" id="5898483">.</span><span class="ident" id="5898484">readFull</span><span class="op" id="5898492">(</span><span class="ident" id="5898493">d</span><span class="op" id="5898494">.</span><span class="ident" id="5898495">tmp</span><span class="op" id="5898498">[</span><span class="op" id="5898499">:</span><span class="ident" id="5898500">n</span><span class="op" id="5898501">]</span><span class="op" id="5898502">)</span><span class="op" id="5898503">;</span>&nbsp;<span class="ident" id="5898505">err</span>&nbsp;<span class="op" id="5898509">!=</span>&nbsp;<span class="ident" id="5898512">nil</span>&nbsp;<span class="op" id="5898516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898520">return</span>&nbsp;<span class="ident" id="5898527">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898535">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898572">if</span>&nbsp;<span class="ident" id="5898575">d</span><span class="op" id="5898576">.</span><span class="ident" id="5898577">tmp</span><span class="op" id="5898580">[</span><span class="num" id="5898581">0</span><span class="op" id="5898582">]</span>&nbsp;<span class="op" id="5898584">!=</span>&nbsp;<span class="num" id="5898587">8</span>&nbsp;<span class="op" id="5898589">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898593">return</span>&nbsp;<span class="ident" id="5898600">UnsupportedError</span><span class="op" id="5898616">(</span><span class="string" id="5898617">&#34;precision&#34;</span><span class="op" id="5898628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898634">d</span><span class="op" id="5898635">.</span><span class="ident" id="5898636">height</span>&nbsp;<span class="op" id="5898643">=</span>&nbsp;<span class="builtintype" id="5898645">int</span><span class="op" id="5898648">(</span><span class="ident" id="5898649">d</span><span class="op" id="5898650">.</span><span class="ident" id="5898651">tmp</span><span class="op" id="5898654">[</span><span class="num" id="5898655">1</span><span class="op" id="5898656">]</span><span class="op" id="5898657">)</span><span class="op" id="5898658">&lt;&lt;</span><span class="num" id="5898660">8</span>&nbsp;<span class="op" id="5898662">+</span>&nbsp;<span class="builtintype" id="5898664">int</span><span class="op" id="5898667">(</span><span class="ident" id="5898668">d</span><span class="op" id="5898669">.</span><span class="ident" id="5898670">tmp</span><span class="op" id="5898673">[</span><span class="num" id="5898674">2</span><span class="op" id="5898675">]</span><span class="op" id="5898676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898679">d</span><span class="op" id="5898680">.</span><span class="ident" id="5898681">width</span>&nbsp;<span class="op" id="5898687">=</span>&nbsp;<span class="builtintype" id="5898689">int</span><span class="op" id="5898692">(</span><span class="ident" id="5898693">d</span><span class="op" id="5898694">.</span><span class="ident" id="5898695">tmp</span><span class="op" id="5898698">[</span><span class="num" id="5898699">3</span><span class="op" id="5898700">]</span><span class="op" id="5898701">)</span><span class="op" id="5898702">&lt;&lt;</span><span class="num" id="5898704">8</span>&nbsp;<span class="op" id="5898706">+</span>&nbsp;<span class="builtintype" id="5898708">int</span><span class="op" id="5898711">(</span><span class="ident" id="5898712">d</span><span class="op" id="5898713">.</span><span class="ident" id="5898714">tmp</span><span class="op" id="5898717">[</span><span class="num" id="5898718">4</span><span class="op" id="5898719">]</span><span class="op" id="5898720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898723">if</span>&nbsp;<span class="builtintype" id="5898726">int</span><span class="op" id="5898729">(</span><span class="ident" id="5898730">d</span><span class="op" id="5898731">.</span><span class="ident" id="5898732">tmp</span><span class="op" id="5898735">[</span><span class="num" id="5898736">5</span><span class="op" id="5898737">]</span><span class="op" id="5898738">)</span>&nbsp;<span class="op" id="5898740">!=</span>&nbsp;<span class="ident" id="5898743">d</span><span class="op" id="5898744">.</span><span class="ident" id="5898745">nComp</span>&nbsp;<span class="op" id="5898751">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898755">return</span>&nbsp;<span class="ident" id="5898762">UnsupportedError</span><span class="op" id="5898778">(</span><span class="string" id="5898779">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="5898821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5898824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898827">for</span>&nbsp;<span class="ident" id="5898831">i</span>&nbsp;<span class="op" id="5898833">:=</span>&nbsp;<span class="num" id="5898836">0</span><span class="op" id="5898837">;</span>&nbsp;<span class="ident" id="5898839">i</span>&nbsp;<span class="op" id="5898841">&lt;</span>&nbsp;<span class="ident" id="5898843">d</span><span class="op" id="5898844">.</span><span class="ident" id="5898845">nComp</span><span class="op" id="5898850">;</span>&nbsp;<span class="ident" id="5898852">i</span><span class="op" id="5898853">++</span>&nbsp;<span class="op" id="5898856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898860">d</span><span class="op" id="5898861">.</span><span class="ident" id="5898862">comp</span><span class="op" id="5898866">[</span><span class="ident" id="5898867">i</span><span class="op" id="5898868">]</span><span class="op" id="5898869">.</span><span class="ident" id="5898870">c</span>&nbsp;<span class="op" id="5898872">=</span>&nbsp;<span class="ident" id="5898874">d</span><span class="op" id="5898875">.</span><span class="ident" id="5898876">tmp</span><span class="op" id="5898879">[</span><span class="num" id="5898880">6</span><span class="op" id="5898881">+</span><span class="num" id="5898882">3</span><span class="op" id="5898883">*</span><span class="ident" id="5898884">i</span><span class="op" id="5898885">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5898889">d</span><span class="op" id="5898890">.</span><span class="ident" id="5898891">comp</span><span class="op" id="5898895">[</span><span class="ident" id="5898896">i</span><span class="op" id="5898897">]</span><span class="op" id="5898898">.</span><span class="ident" id="5898899">tq</span>&nbsp;<span class="op" id="5898902">=</span>&nbsp;<span class="ident" id="5898904">d</span><span class="op" id="5898905">.</span><span class="ident" id="5898906">tmp</span><span class="op" id="5898909">[</span><span class="num" id="5898910">8</span><span class="op" id="5898911">+</span><span class="num" id="5898912">3</span><span class="op" id="5898913">*</span><span class="ident" id="5898914">i</span><span class="op" id="5898915">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5898919">if</span>&nbsp;<span class="ident" id="5898922">d</span><span class="op" id="5898923">.</span><span class="ident" id="5898924">nComp</span>&nbsp;<span class="op" id="5898930">==</span>&nbsp;<span class="ident" id="5898933">nGrayComponent</span>&nbsp;<span class="op" id="5898948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5898953">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899027">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899100">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899176">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899253">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899329">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899406">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899482">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899558">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899635">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899708">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899739">d</span><span class="op" id="5899740">.</span><span class="ident" id="5899741">comp</span><span class="op" id="5899745">[</span><span class="ident" id="5899746">i</span><span class="op" id="5899747">]</span><span class="op" id="5899748">.</span><span class="ident" id="5899749">h</span>&nbsp;<span class="op" id="5899751">=</span>&nbsp;<span class="num" id="5899753">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899758">d</span><span class="op" id="5899759">.</span><span class="ident" id="5899760">comp</span><span class="op" id="5899764">[</span><span class="ident" id="5899765">i</span><span class="op" id="5899766">]</span><span class="op" id="5899767">.</span><span class="ident" id="5899768">v</span>&nbsp;<span class="op" id="5899770">=</span>&nbsp;<span class="num" id="5899772">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5899777">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5899788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899792">hv</span>&nbsp;<span class="op" id="5899795">:=</span>&nbsp;<span class="ident" id="5899798">d</span><span class="op" id="5899799">.</span><span class="ident" id="5899800">tmp</span><span class="op" id="5899803">[</span><span class="num" id="5899804">7</span><span class="op" id="5899805">+</span><span class="num" id="5899806">3</span><span class="op" id="5899807">*</span><span class="ident" id="5899808">i</span><span class="op" id="5899809">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899813">d</span><span class="op" id="5899814">.</span><span class="ident" id="5899815">comp</span><span class="op" id="5899819">[</span><span class="ident" id="5899820">i</span><span class="op" id="5899821">]</span><span class="op" id="5899822">.</span><span class="ident" id="5899823">h</span>&nbsp;<span class="op" id="5899825">=</span>&nbsp;<span class="builtintype" id="5899827">int</span><span class="op" id="5899830">(</span><span class="ident" id="5899831">hv</span>&nbsp;<span class="op" id="5899834">&gt;&gt;</span>&nbsp;<span class="num" id="5899837">4</span><span class="op" id="5899838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5899842">d</span><span class="op" id="5899843">.</span><span class="ident" id="5899844">comp</span><span class="op" id="5899848">[</span><span class="ident" id="5899849">i</span><span class="op" id="5899850">]</span><span class="op" id="5899851">.</span><span class="ident" id="5899852">v</span>&nbsp;<span class="op" id="5899854">=</span>&nbsp;<span class="builtintype" id="5899856">int</span><span class="op" id="5899859">(</span><span class="ident" id="5899860">hv</span>&nbsp;<span class="op" id="5899863">&amp;</span>&nbsp;<span class="num" id="5899865">0x0f</span><span class="op" id="5899869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899873">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5899948">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900020">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5900095">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900152">if</span>&nbsp;<span class="ident" id="5900155">i</span>&nbsp;<span class="op" id="5900157">==</span>&nbsp;<span class="num" id="5900160">0</span>&nbsp;<span class="op" id="5900162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900167">if</span>&nbsp;<span class="ident" id="5900170">hv</span>&nbsp;<span class="op" id="5900173">!=</span>&nbsp;<span class="num" id="5900176">0x11</span>&nbsp;<span class="op" id="5900181">&amp;&amp;</span>&nbsp;<span class="ident" id="5900184">hv</span>&nbsp;<span class="op" id="5900187">!=</span>&nbsp;<span class="num" id="5900190">0x21</span>&nbsp;<span class="op" id="5900195">&amp;&amp;</span>&nbsp;<span class="ident" id="5900198">hv</span>&nbsp;<span class="op" id="5900201">!=</span>&nbsp;<span class="num" id="5900204">0x22</span>&nbsp;<span class="op" id="5900209">&amp;&amp;</span>&nbsp;<span class="ident" id="5900212">hv</span>&nbsp;<span class="op" id="5900215">!=</span>&nbsp;<span class="num" id="5900218">0x12</span>&nbsp;<span class="op" id="5900223">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900229">return</span>&nbsp;<span class="ident" id="5900236">UnsupportedError</span><span class="op" id="5900252">(</span><span class="string" id="5900253">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5900283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900292">}</span>&nbsp;<span class="keyword" id="5900294">else</span>&nbsp;<span class="keyword" id="5900299">if</span>&nbsp;<span class="ident" id="5900302">hv</span>&nbsp;<span class="op" id="5900305">!=</span>&nbsp;<span class="num" id="5900308">0x11</span>&nbsp;<span class="op" id="5900313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900318">return</span>&nbsp;<span class="ident" id="5900325">UnsupportedError</span><span class="op" id="5900341">(</span><span class="string" id="5900342">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="5900372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900376">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900382">return</span>&nbsp;<span class="ident" id="5900389">nil</span><br>
<span class="lineno"></span><span class="op" id="5900393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5900396">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="5900429">func</span>&nbsp;<span class="op" id="5900434">(</span><span class="ident" id="5900435">d</span>&nbsp;<span class="op" id="5900437">*</span><span class="ident" id="5900438">decoder</span><span class="op" id="5900445">)</span>&nbsp;<span class="ident" id="5900447">processDQT</span><span class="op" id="5900457">(</span><span class="ident" id="5900458">n</span>&nbsp;<span class="builtintype" id="5900460">int</span><span class="op" id="5900463">)</span>&nbsp;<span class="builtintype" id="5900465">error</span>&nbsp;<span class="op" id="5900471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900474">const</span>&nbsp;<span class="ident" id="5900480">qtLength</span>&nbsp;<span class="op" id="5900489">=</span>&nbsp;<span class="num" id="5900491">1</span>&nbsp;<span class="op" id="5900493">+</span>&nbsp;<span class="ident" id="5900495">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900506">for</span>&nbsp;<span class="op" id="5900510">;</span>&nbsp;<span class="ident" id="5900512">n</span>&nbsp;<span class="op" id="5900514">&gt;=</span>&nbsp;<span class="ident" id="5900517">qtLength</span><span class="op" id="5900525">;</span>&nbsp;<span class="ident" id="5900527">n</span>&nbsp;<span class="op" id="5900529">-=</span>&nbsp;<span class="ident" id="5900532">qtLength</span>&nbsp;<span class="op" id="5900541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900545">if</span>&nbsp;<span class="ident" id="5900548">err</span>&nbsp;<span class="op" id="5900552">:=</span>&nbsp;<span class="ident" id="5900555">d</span><span class="op" id="5900556">.</span><span class="ident" id="5900557">readFull</span><span class="op" id="5900565">(</span><span class="ident" id="5900566">d</span><span class="op" id="5900567">.</span><span class="ident" id="5900568">tmp</span><span class="op" id="5900571">[</span><span class="op" id="5900572">:</span><span class="ident" id="5900573">qtLength</span><span class="op" id="5900581">]</span><span class="op" id="5900582">)</span><span class="op" id="5900583">;</span>&nbsp;<span class="ident" id="5900585">err</span>&nbsp;<span class="op" id="5900589">!=</span>&nbsp;<span class="ident" id="5900592">nil</span>&nbsp;<span class="op" id="5900596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900601">return</span>&nbsp;<span class="ident" id="5900608">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900618">pq</span>&nbsp;<span class="op" id="5900621">:=</span>&nbsp;<span class="ident" id="5900624">d</span><span class="op" id="5900625">.</span><span class="ident" id="5900626">tmp</span><span class="op" id="5900629">[</span><span class="num" id="5900630">0</span><span class="op" id="5900631">]</span>&nbsp;<span class="op" id="5900633">&gt;&gt;</span>&nbsp;<span class="num" id="5900636">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900640">if</span>&nbsp;<span class="ident" id="5900643">pq</span>&nbsp;<span class="op" id="5900646">!=</span>&nbsp;<span class="num" id="5900649">0</span>&nbsp;<span class="op" id="5900651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900656">return</span>&nbsp;<span class="ident" id="5900663">UnsupportedError</span><span class="op" id="5900679">(</span><span class="string" id="5900680">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="5900694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900698">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900702">tq</span>&nbsp;<span class="op" id="5900705">:=</span>&nbsp;<span class="ident" id="5900708">d</span><span class="op" id="5900709">.</span><span class="ident" id="5900710">tmp</span><span class="op" id="5900713">[</span><span class="num" id="5900714">0</span><span class="op" id="5900715">]</span>&nbsp;<span class="op" id="5900717">&amp;</span>&nbsp;<span class="num" id="5900719">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900726">if</span>&nbsp;<span class="ident" id="5900729">tq</span>&nbsp;<span class="op" id="5900732">&gt;</span>&nbsp;<span class="ident" id="5900734">maxTq</span>&nbsp;<span class="op" id="5900740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900745">return</span>&nbsp;<span class="ident" id="5900752">FormatError</span><span class="op" id="5900763">(</span><span class="string" id="5900764">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="5900778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900786">for</span>&nbsp;<span class="ident" id="5900790">i</span>&nbsp;<span class="op" id="5900792">:=</span>&nbsp;<span class="keyword" id="5900795">range</span>&nbsp;<span class="ident" id="5900801">d</span><span class="op" id="5900802">.</span><span class="ident" id="5900803">quant</span><span class="op" id="5900808">[</span><span class="ident" id="5900809">tq</span><span class="op" id="5900811">]</span>&nbsp;<span class="op" id="5900813">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5900818">d</span><span class="op" id="5900819">.</span><span class="ident" id="5900820">quant</span><span class="op" id="5900825">[</span><span class="ident" id="5900826">tq</span><span class="op" id="5900828">]</span><span class="op" id="5900829">[</span><span class="ident" id="5900830">i</span><span class="op" id="5900831">]</span>&nbsp;<span class="op" id="5900833">=</span>&nbsp;<span class="builtintype" id="5900835">int32</span><span class="op" id="5900840">(</span><span class="ident" id="5900841">d</span><span class="op" id="5900842">.</span><span class="ident" id="5900843">tmp</span><span class="op" id="5900846">[</span><span class="ident" id="5900847">i</span><span class="op" id="5900848">+</span><span class="num" id="5900849">1</span><span class="op" id="5900850">]</span><span class="op" id="5900851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900861">if</span>&nbsp;<span class="ident" id="5900864">n</span>&nbsp;<span class="op" id="5900866">!=</span>&nbsp;<span class="num" id="5900869">0</span>&nbsp;<span class="op" id="5900871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900875">return</span>&nbsp;<span class="ident" id="5900882">FormatError</span><span class="op" id="5900893">(</span><span class="string" id="5900894">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5900916">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5900919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5900922">return</span>&nbsp;<span class="ident" id="5900929">nil</span><br>
<span class="lineno"></span><span class="op" id="5900933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5900936">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="5900969">func</span>&nbsp;<span class="op" id="5900974">(</span><span class="ident" id="5900975">d</span>&nbsp;<span class="op" id="5900977">*</span><span class="ident" id="5900978">decoder</span><span class="op" id="5900985">)</span>&nbsp;<span class="ident" id="5900987">processDRI</span><span class="op" id="5900997">(</span><span class="ident" id="5900998">n</span>&nbsp;<span class="builtintype" id="5901000">int</span><span class="op" id="5901003">)</span>&nbsp;<span class="builtintype" id="5901005">error</span>&nbsp;<span class="op" id="5901011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901014">if</span>&nbsp;<span class="ident" id="5901017">n</span>&nbsp;<span class="op" id="5901019">!=</span>&nbsp;<span class="num" id="5901022">2</span>&nbsp;<span class="op" id="5901024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901028">return</span>&nbsp;<span class="ident" id="5901035">FormatError</span><span class="op" id="5901046">(</span><span class="string" id="5901047">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5901069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901075">if</span>&nbsp;<span class="ident" id="5901078">err</span>&nbsp;<span class="op" id="5901082">:=</span>&nbsp;<span class="ident" id="5901085">d</span><span class="op" id="5901086">.</span><span class="ident" id="5901087">readFull</span><span class="op" id="5901095">(</span><span class="ident" id="5901096">d</span><span class="op" id="5901097">.</span><span class="ident" id="5901098">tmp</span><span class="op" id="5901101">[</span><span class="op" id="5901102">:</span><span class="num" id="5901103">2</span><span class="op" id="5901104">]</span><span class="op" id="5901105">)</span><span class="op" id="5901106">;</span>&nbsp;<span class="ident" id="5901108">err</span>&nbsp;<span class="op" id="5901112">!=</span>&nbsp;<span class="ident" id="5901115">nil</span>&nbsp;<span class="op" id="5901119">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901123">return</span>&nbsp;<span class="ident" id="5901130">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901138">d</span><span class="op" id="5901139">.</span><span class="ident" id="5901140">ri</span>&nbsp;<span class="op" id="5901143">=</span>&nbsp;<span class="builtintype" id="5901145">int</span><span class="op" id="5901148">(</span><span class="ident" id="5901149">d</span><span class="op" id="5901150">.</span><span class="ident" id="5901151">tmp</span><span class="op" id="5901154">[</span><span class="num" id="5901155">0</span><span class="op" id="5901156">]</span><span class="op" id="5901157">)</span><span class="op" id="5901158">&lt;&lt;</span><span class="num" id="5901160">8</span>&nbsp;<span class="op" id="5901162">+</span>&nbsp;<span class="builtintype" id="5901164">int</span><span class="op" id="5901167">(</span><span class="ident" id="5901168">d</span><span class="op" id="5901169">.</span><span class="ident" id="5901170">tmp</span><span class="op" id="5901173">[</span><span class="num" id="5901174">1</span><span class="op" id="5901175">]</span><span class="op" id="5901176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901179">return</span>&nbsp;<span class="ident" id="5901186">nil</span><br>
<span class="lineno"></span><span class="op" id="5901190">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="5901193">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5901263">func</span>&nbsp;<span class="op" id="5901268">(</span><span class="ident" id="5901269">d</span>&nbsp;<span class="op" id="5901271">*</span><span class="ident" id="5901272">decoder</span><span class="op" id="5901279">)</span>&nbsp;<span class="ident" id="5901281">decode</span><span class="op" id="5901287">(</span><span class="ident" id="5901288">r</span>&nbsp;<span class="ident" id="5901290">io</span><span class="op" id="5901292">.</span><span class="ident" id="5901293">Reader</span><span class="op" id="5901299">,</span>&nbsp;<span class="ident" id="5901301">configOnly</span>&nbsp;<span class="builtintype" id="5901312">bool</span><span class="op" id="5901316">)</span>&nbsp;<span class="op" id="5901318">(</span><span class="ident" id="5901319">image</span><span class="op" id="5901324">.</span><span class="ident" id="5901325">Image</span><span class="op" id="5901330">,</span>&nbsp;<span class="builtintype" id="5901332">error</span><span class="op" id="5901337">)</span>&nbsp;<span class="op" id="5901339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901342">d</span><span class="op" id="5901343">.</span><span class="ident" id="5901344">r</span>&nbsp;<span class="op" id="5901346">=</span>&nbsp;<span class="ident" id="5901348">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901352">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901393">if</span>&nbsp;<span class="ident" id="5901396">err</span>&nbsp;<span class="op" id="5901400">:=</span>&nbsp;<span class="ident" id="5901403">d</span><span class="op" id="5901404">.</span><span class="ident" id="5901405">readFull</span><span class="op" id="5901413">(</span><span class="ident" id="5901414">d</span><span class="op" id="5901415">.</span><span class="ident" id="5901416">tmp</span><span class="op" id="5901419">[</span><span class="op" id="5901420">:</span><span class="num" id="5901421">2</span><span class="op" id="5901422">]</span><span class="op" id="5901423">)</span><span class="op" id="5901424">;</span>&nbsp;<span class="ident" id="5901426">err</span>&nbsp;<span class="op" id="5901430">!=</span>&nbsp;<span class="ident" id="5901433">nil</span>&nbsp;<span class="op" id="5901437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901441">return</span>&nbsp;<span class="ident" id="5901448">nil</span><span class="op" id="5901451">,</span>&nbsp;<span class="ident" id="5901453">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901461">if</span>&nbsp;<span class="ident" id="5901464">d</span><span class="op" id="5901465">.</span><span class="ident" id="5901466">tmp</span><span class="op" id="5901469">[</span><span class="num" id="5901470">0</span><span class="op" id="5901471">]</span>&nbsp;<span class="op" id="5901473">!=</span>&nbsp;<span class="num" id="5901476">0xff</span>&nbsp;<span class="op" id="5901481">||</span>&nbsp;<span class="ident" id="5901484">d</span><span class="op" id="5901485">.</span><span class="ident" id="5901486">tmp</span><span class="op" id="5901489">[</span><span class="num" id="5901490">1</span><span class="op" id="5901491">]</span>&nbsp;<span class="op" id="5901493">!=</span>&nbsp;<span class="ident" id="5901496">soiMarker</span>&nbsp;<span class="op" id="5901506">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901510">return</span>&nbsp;<span class="ident" id="5901517">nil</span><span class="op" id="5901520">,</span>&nbsp;<span class="ident" id="5901522">FormatError</span><span class="op" id="5901533">(</span><span class="string" id="5901534">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="5901554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901561">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901627">for</span>&nbsp;<span class="op" id="5901631">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5901635">err</span>&nbsp;<span class="op" id="5901639">:=</span>&nbsp;<span class="ident" id="5901642">d</span><span class="op" id="5901643">.</span><span class="ident" id="5901644">readFull</span><span class="op" id="5901652">(</span><span class="ident" id="5901653">d</span><span class="op" id="5901654">.</span><span class="ident" id="5901655">tmp</span><span class="op" id="5901658">[</span><span class="op" id="5901659">:</span><span class="num" id="5901660">2</span><span class="op" id="5901661">]</span><span class="op" id="5901662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901666">if</span>&nbsp;<span class="ident" id="5901669">err</span>&nbsp;<span class="op" id="5901673">!=</span>&nbsp;<span class="ident" id="5901676">nil</span>&nbsp;<span class="op" id="5901680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901685">return</span>&nbsp;<span class="ident" id="5901692">nil</span><span class="op" id="5901695">,</span>&nbsp;<span class="ident" id="5901697">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5901703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5901707">for</span>&nbsp;<span class="ident" id="5901711">d</span><span class="op" id="5901712">.</span><span class="ident" id="5901713">tmp</span><span class="op" id="5901716">[</span><span class="num" id="5901717">0</span><span class="op" id="5901718">]</span>&nbsp;<span class="op" id="5901720">!=</span>&nbsp;<span class="num" id="5901723">0xff</span>&nbsp;<span class="op" id="5901728">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901733">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901802">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901868">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5901937">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902004">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902074">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902140">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902209">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902281">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902348">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902420">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902444">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902450">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902521">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902548">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902554">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902621">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902675">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902681">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902751">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902818">d</span><span class="op" id="5902819">.</span><span class="ident" id="5902820">tmp</span><span class="op" id="5902823">[</span><span class="num" id="5902824">0</span><span class="op" id="5902825">]</span>&nbsp;<span class="op" id="5902827">=</span>&nbsp;<span class="ident" id="5902829">d</span><span class="op" id="5902830">.</span><span class="ident" id="5902831">tmp</span><span class="op" id="5902834">[</span><span class="num" id="5902835">1</span><span class="op" id="5902836">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902841">d</span><span class="op" id="5902842">.</span><span class="ident" id="5902843">tmp</span><span class="op" id="5902846">[</span><span class="num" id="5902847">1</span><span class="op" id="5902848">]</span><span class="op" id="5902849">,</span>&nbsp;<span class="ident" id="5902851">err</span>&nbsp;<span class="op" id="5902855">=</span>&nbsp;<span class="ident" id="5902857">d</span><span class="op" id="5902858">.</span><span class="ident" id="5902859">readByte</span><span class="op" id="5902867">(</span><span class="op" id="5902868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902873">if</span>&nbsp;<span class="ident" id="5902876">err</span>&nbsp;<span class="op" id="5902880">!=</span>&nbsp;<span class="ident" id="5902883">nil</span>&nbsp;<span class="op" id="5902887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902893">return</span>&nbsp;<span class="ident" id="5902900">nil</span><span class="op" id="5902903">,</span>&nbsp;<span class="ident" id="5902905">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902912">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5902916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5902920">marker</span>&nbsp;<span class="op" id="5902927">:=</span>&nbsp;<span class="ident" id="5902930">d</span><span class="op" id="5902931">.</span><span class="ident" id="5902932">tmp</span><span class="op" id="5902935">[</span><span class="num" id="5902936">1</span><span class="op" id="5902937">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5902941">if</span>&nbsp;<span class="ident" id="5902944">marker</span>&nbsp;<span class="op" id="5902951">==</span>&nbsp;<span class="num" id="5902954">0</span>&nbsp;<span class="op" id="5902956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5902961">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903004">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903019">for</span>&nbsp;<span class="ident" id="5903023">marker</span>&nbsp;<span class="op" id="5903030">==</span>&nbsp;<span class="num" id="5903033">0xff</span>&nbsp;<span class="op" id="5903038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903043">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903117">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5903183">marker</span><span class="op" id="5903189">,</span>&nbsp;<span class="ident" id="5903191">err</span>&nbsp;<span class="op" id="5903195">=</span>&nbsp;<span class="ident" id="5903197">d</span><span class="op" id="5903198">.</span><span class="ident" id="5903199">readByte</span><span class="op" id="5903207">(</span><span class="op" id="5903208">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903213">if</span>&nbsp;<span class="ident" id="5903216">err</span>&nbsp;<span class="op" id="5903220">!=</span>&nbsp;<span class="ident" id="5903223">nil</span>&nbsp;<span class="op" id="5903227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903233">return</span>&nbsp;<span class="ident" id="5903240">nil</span><span class="op" id="5903243">,</span>&nbsp;<span class="ident" id="5903245">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903260">if</span>&nbsp;<span class="ident" id="5903263">marker</span>&nbsp;<span class="op" id="5903270">==</span>&nbsp;<span class="ident" id="5903273">eoiMarker</span>&nbsp;<span class="op" id="5903283">{</span>&nbsp;<span class="comment" id="5903285">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903305">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903317">if</span>&nbsp;<span class="ident" id="5903320">rst0Marker</span>&nbsp;<span class="op" id="5903331">&lt;=</span>&nbsp;<span class="ident" id="5903334">marker</span>&nbsp;<span class="op" id="5903341">&amp;&amp;</span>&nbsp;<span class="ident" id="5903344">marker</span>&nbsp;<span class="op" id="5903351">&lt;=</span>&nbsp;<span class="ident" id="5903354">rst7Marker</span>&nbsp;<span class="op" id="5903365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903370">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903454">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903531">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903610">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903695">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903781">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5903857">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5903868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903873">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5903956">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904031">if</span>&nbsp;<span class="ident" id="5904034">err</span>&nbsp;<span class="op" id="5904038">=</span>&nbsp;<span class="ident" id="5904040">d</span><span class="op" id="5904041">.</span><span class="ident" id="5904042">readFull</span><span class="op" id="5904050">(</span><span class="ident" id="5904051">d</span><span class="op" id="5904052">.</span><span class="ident" id="5904053">tmp</span><span class="op" id="5904056">[</span><span class="op" id="5904057">:</span><span class="num" id="5904058">2</span><span class="op" id="5904059">]</span><span class="op" id="5904060">)</span><span class="op" id="5904061">;</span>&nbsp;<span class="ident" id="5904063">err</span>&nbsp;<span class="op" id="5904067">!=</span>&nbsp;<span class="ident" id="5904070">nil</span>&nbsp;<span class="op" id="5904074">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904079">return</span>&nbsp;<span class="ident" id="5904086">nil</span><span class="op" id="5904089">,</span>&nbsp;<span class="ident" id="5904091">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904101">n</span>&nbsp;<span class="op" id="5904103">:=</span>&nbsp;<span class="builtintype" id="5904106">int</span><span class="op" id="5904109">(</span><span class="ident" id="5904110">d</span><span class="op" id="5904111">.</span><span class="ident" id="5904112">tmp</span><span class="op" id="5904115">[</span><span class="num" id="5904116">0</span><span class="op" id="5904117">]</span><span class="op" id="5904118">)</span><span class="op" id="5904119">&lt;&lt;</span><span class="num" id="5904121">8</span>&nbsp;<span class="op" id="5904123">+</span>&nbsp;<span class="builtintype" id="5904125">int</span><span class="op" id="5904128">(</span><span class="ident" id="5904129">d</span><span class="op" id="5904130">.</span><span class="ident" id="5904131">tmp</span><span class="op" id="5904134">[</span><span class="num" id="5904135">1</span><span class="op" id="5904136">]</span><span class="op" id="5904137">)</span>&nbsp;<span class="op" id="5904139">-</span>&nbsp;<span class="num" id="5904141">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904145">if</span>&nbsp;<span class="ident" id="5904148">n</span>&nbsp;<span class="op" id="5904150">&lt;</span>&nbsp;<span class="num" id="5904152">0</span>&nbsp;<span class="op" id="5904154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904159">return</span>&nbsp;<span class="ident" id="5904166">nil</span><span class="op" id="5904169">,</span>&nbsp;<span class="ident" id="5904171">FormatError</span><span class="op" id="5904182">(</span><span class="string" id="5904183">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="5904205">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904214">switch</span>&nbsp;<span class="op" id="5904221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904225">case</span>&nbsp;<span class="ident" id="5904230">marker</span>&nbsp;<span class="op" id="5904237">==</span>&nbsp;<span class="ident" id="5904240">sof0Marker</span>&nbsp;<span class="op" id="5904251">||</span>&nbsp;<span class="ident" id="5904254">marker</span>&nbsp;<span class="op" id="5904261">==</span>&nbsp;<span class="ident" id="5904264">sof2Marker</span><span class="op" id="5904274">:</span>&nbsp;<span class="comment" id="5904276">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904298">d</span><span class="op" id="5904299">.</span><span class="ident" id="5904300">progressive</span>&nbsp;<span class="op" id="5904312">=</span>&nbsp;<span class="ident" id="5904314">marker</span>&nbsp;<span class="op" id="5904321">==</span>&nbsp;<span class="ident" id="5904324">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904338">err</span>&nbsp;<span class="op" id="5904342">=</span>&nbsp;<span class="ident" id="5904344">d</span><span class="op" id="5904345">.</span><span class="ident" id="5904346">processSOF</span><span class="op" id="5904356">(</span><span class="ident" id="5904357">n</span><span class="op" id="5904358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904363">if</span>&nbsp;<span class="ident" id="5904366">configOnly</span>&nbsp;<span class="op" id="5904377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904383">return</span>&nbsp;<span class="ident" id="5904390">nil</span><span class="op" id="5904393">,</span>&nbsp;<span class="ident" id="5904395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904406">case</span>&nbsp;<span class="ident" id="5904411">marker</span>&nbsp;<span class="op" id="5904418">==</span>&nbsp;<span class="ident" id="5904421">dhtMarker</span><span class="op" id="5904430">:</span>&nbsp;<span class="comment" id="5904432">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904460">err</span>&nbsp;<span class="op" id="5904464">=</span>&nbsp;<span class="ident" id="5904466">d</span><span class="op" id="5904467">.</span><span class="ident" id="5904468">processDHT</span><span class="op" id="5904478">(</span><span class="ident" id="5904479">n</span><span class="op" id="5904480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904484">case</span>&nbsp;<span class="ident" id="5904489">marker</span>&nbsp;<span class="op" id="5904496">==</span>&nbsp;<span class="ident" id="5904499">dqtMarker</span><span class="op" id="5904508">:</span>&nbsp;<span class="comment" id="5904510">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904543">err</span>&nbsp;<span class="op" id="5904547">=</span>&nbsp;<span class="ident" id="5904549">d</span><span class="op" id="5904550">.</span><span class="ident" id="5904551">processDQT</span><span class="op" id="5904561">(</span><span class="ident" id="5904562">n</span><span class="op" id="5904563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904567">case</span>&nbsp;<span class="ident" id="5904572">marker</span>&nbsp;<span class="op" id="5904579">==</span>&nbsp;<span class="ident" id="5904582">sosMarker</span><span class="op" id="5904591">:</span>&nbsp;<span class="comment" id="5904593">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904614">err</span>&nbsp;<span class="op" id="5904618">=</span>&nbsp;<span class="ident" id="5904620">d</span><span class="op" id="5904621">.</span><span class="ident" id="5904622">processSOS</span><span class="op" id="5904632">(</span><span class="ident" id="5904633">n</span><span class="op" id="5904634">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904638">case</span>&nbsp;<span class="ident" id="5904643">marker</span>&nbsp;<span class="op" id="5904650">==</span>&nbsp;<span class="ident" id="5904653">driMarker</span><span class="op" id="5904662">:</span>&nbsp;<span class="comment" id="5904664">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904695">err</span>&nbsp;<span class="op" id="5904699">=</span>&nbsp;<span class="ident" id="5904701">d</span><span class="op" id="5904702">.</span><span class="ident" id="5904703">processDRI</span><span class="op" id="5904713">(</span><span class="ident" id="5904714">n</span><span class="op" id="5904715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904719">case</span>&nbsp;<span class="ident" id="5904724">app0Marker</span>&nbsp;<span class="op" id="5904735">&lt;=</span>&nbsp;<span class="ident" id="5904738">marker</span>&nbsp;<span class="op" id="5904745">&amp;&amp;</span>&nbsp;<span class="ident" id="5904748">marker</span>&nbsp;<span class="op" id="5904755">&lt;=</span>&nbsp;<span class="ident" id="5904758">app15Marker</span>&nbsp;<span class="op" id="5904770">||</span>&nbsp;<span class="ident" id="5904773">marker</span>&nbsp;<span class="op" id="5904780">==</span>&nbsp;<span class="ident" id="5904783">comMarker</span><span class="op" id="5904792">:</span>&nbsp;<span class="comment" id="5904794">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904834">err</span>&nbsp;<span class="op" id="5904838">=</span>&nbsp;<span class="ident" id="5904840">d</span><span class="op" id="5904841">.</span><span class="ident" id="5904842">ignore</span><span class="op" id="5904848">(</span><span class="ident" id="5904849">n</span><span class="op" id="5904850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904854">default</span><span class="op" id="5904861">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5904866">err</span>&nbsp;<span class="op" id="5904870">=</span>&nbsp;<span class="ident" id="5904872">UnsupportedError</span><span class="op" id="5904888">(</span><span class="string" id="5904889">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="5904905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904913">if</span>&nbsp;<span class="ident" id="5904916">err</span>&nbsp;<span class="op" id="5904920">!=</span>&nbsp;<span class="ident" id="5904923">nil</span>&nbsp;<span class="op" id="5904927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904932">return</span>&nbsp;<span class="ident" id="5904939">nil</span><span class="op" id="5904942">,</span>&nbsp;<span class="ident" id="5904944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904950">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904956">if</span>&nbsp;<span class="ident" id="5904959">d</span><span class="op" id="5904960">.</span><span class="ident" id="5904961">img1</span>&nbsp;<span class="op" id="5904966">!=</span>&nbsp;<span class="ident" id="5904969">nil</span>&nbsp;<span class="op" id="5904973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5904977">return</span>&nbsp;<span class="ident" id="5904984">d</span><span class="op" id="5904985">.</span><span class="ident" id="5904986">img1</span><span class="op" id="5904990">,</span>&nbsp;<span class="ident" id="5904992">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5904997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905000">if</span>&nbsp;<span class="ident" id="5905003">d</span><span class="op" id="5905004">.</span><span class="ident" id="5905005">img3</span>&nbsp;<span class="op" id="5905010">!=</span>&nbsp;<span class="ident" id="5905013">nil</span>&nbsp;<span class="op" id="5905017">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905021">return</span>&nbsp;<span class="ident" id="5905028">d</span><span class="op" id="5905029">.</span><span class="ident" id="5905030">img3</span><span class="op" id="5905034">,</span>&nbsp;<span class="ident" id="5905036">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905044">return</span>&nbsp;<span class="ident" id="5905051">nil</span><span class="op" id="5905054">,</span>&nbsp;<span class="ident" id="5905056">FormatError</span><span class="op" id="5905067">(</span><span class="string" id="5905068">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="5905088">)</span><br>
<span class="lineno"></span><span class="op" id="5905090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5905093">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="5905163">func</span>&nbsp;<span class="ident" id="5905168">Decode</span><span class="op" id="5905174">(</span><span class="ident" id="5905175">r</span>&nbsp;<span class="ident" id="5905177">io</span><span class="op" id="5905179">.</span><span class="ident" id="5905180">Reader</span><span class="op" id="5905186">)</span>&nbsp;<span class="op" id="5905188">(</span><span class="ident" id="5905189">image</span><span class="op" id="5905194">.</span><span class="ident" id="5905195">Image</span><span class="op" id="5905200">,</span>&nbsp;<span class="builtintype" id="5905202">error</span><span class="op" id="5905207">)</span>&nbsp;<span class="op" id="5905209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905212">var</span>&nbsp;<span class="ident" id="5905216">d</span>&nbsp;<span class="ident" id="5905218">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905227">return</span>&nbsp;<span class="ident" id="5905234">d</span><span class="op" id="5905235">.</span><span class="ident" id="5905236">decode</span><span class="op" id="5905242">(</span><span class="ident" id="5905243">r</span><span class="op" id="5905244">,</span>&nbsp;<span class="builtintype" id="5905246">false</span><span class="op" id="5905251">)</span><br>
<span class="lineno"></span><span class="op" id="5905253">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="5905256">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5905335">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5905365">func</span>&nbsp;<span class="ident" id="5905370">DecodeConfig</span><span class="op" id="5905382">(</span><span class="ident" id="5905383">r</span>&nbsp;<span class="ident" id="5905385">io</span><span class="op" id="5905387">.</span><span class="ident" id="5905388">Reader</span><span class="op" id="5905394">)</span>&nbsp;<span class="op" id="5905396">(</span><span class="ident" id="5905397">image</span><span class="op" id="5905402">.</span><span class="ident" id="5905403">Config</span><span class="op" id="5905409">,</span>&nbsp;<span class="builtintype" id="5905411">error</span><span class="op" id="5905416">)</span>&nbsp;<span class="op" id="5905418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905421">var</span>&nbsp;<span class="ident" id="5905425">d</span>&nbsp;<span class="ident" id="5905427">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905436">if</span>&nbsp;<span class="ident" id="5905439">_</span><span class="op" id="5905440">,</span>&nbsp;<span class="ident" id="5905442">err</span>&nbsp;<span class="op" id="5905446">:=</span>&nbsp;<span class="ident" id="5905449">d</span><span class="op" id="5905450">.</span><span class="ident" id="5905451">decode</span><span class="op" id="5905457">(</span><span class="ident" id="5905458">r</span><span class="op" id="5905459">,</span>&nbsp;<span class="builtintype" id="5905461">true</span><span class="op" id="5905465">)</span><span class="op" id="5905466">;</span>&nbsp;<span class="ident" id="5905468">err</span>&nbsp;<span class="op" id="5905472">!=</span>&nbsp;<span class="ident" id="5905475">nil</span>&nbsp;<span class="op" id="5905479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905483">return</span>&nbsp;<span class="ident" id="5905490">image</span><span class="op" id="5905495">.</span><span class="ident" id="5905496">Config</span><span class="op" id="5905502">{</span><span class="op" id="5905503">}</span><span class="op" id="5905504">,</span>&nbsp;<span class="ident" id="5905506">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905514">switch</span>&nbsp;<span class="ident" id="5905521">d</span><span class="op" id="5905522">.</span><span class="ident" id="5905523">nComp</span>&nbsp;<span class="op" id="5905529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905532">case</span>&nbsp;<span class="ident" id="5905537">nGrayComponent</span><span class="op" id="5905551">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905555">return</span>&nbsp;<span class="ident" id="5905562">image</span><span class="op" id="5905567">.</span><span class="ident" id="5905568">Config</span><span class="op" id="5905574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905579">ColorModel</span><span class="op" id="5905589">:</span>&nbsp;<span class="ident" id="5905591">color</span><span class="op" id="5905596">.</span><span class="ident" id="5905597">GrayModel</span><span class="op" id="5905606">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905611">Width</span><span class="op" id="5905616">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905623">d</span><span class="op" id="5905624">.</span><span class="ident" id="5905625">width</span><span class="op" id="5905630">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905635">Height</span><span class="op" id="5905641">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905647">d</span><span class="op" id="5905648">.</span><span class="ident" id="5905649">height</span><span class="op" id="5905655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905659">}</span><span class="op" id="5905660">,</span>&nbsp;<span class="ident" id="5905662">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905667">case</span>&nbsp;<span class="ident" id="5905672">nColorComponent</span><span class="op" id="5905687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905691">return</span>&nbsp;<span class="ident" id="5905698">image</span><span class="op" id="5905703">.</span><span class="ident" id="5905704">Config</span><span class="op" id="5905710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905715">ColorModel</span><span class="op" id="5905725">:</span>&nbsp;<span class="ident" id="5905727">color</span><span class="op" id="5905732">.</span><span class="ident" id="5905733">YCbCrModel</span><span class="op" id="5905743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905748">Width</span><span class="op" id="5905753">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905760">d</span><span class="op" id="5905761">.</span><span class="ident" id="5905762">width</span><span class="op" id="5905767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905772">Height</span><span class="op" id="5905778">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5905784">d</span><span class="op" id="5905785">.</span><span class="ident" id="5905786">height</span><span class="op" id="5905792">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905796">}</span><span class="op" id="5905797">,</span>&nbsp;<span class="ident" id="5905799">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5905804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5905807">return</span>&nbsp;<span class="ident" id="5905814">image</span><span class="op" id="5905819">.</span><span class="ident" id="5905820">Config</span><span class="op" id="5905826">{</span><span class="op" id="5905827">}</span><span class="op" id="5905828">,</span>&nbsp;<span class="ident" id="5905830">FormatError</span><span class="op" id="5905841">(</span><span class="string" id="5905842">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="5905862">)</span><br>
<span class="lineno"></span><span class="op" id="5905864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="5905867">func</span>&nbsp;<span class="ident" id="5905872">init</span><span class="op" id="5905876">(</span><span class="op" id="5905877">)</span>&nbsp;<span class="op" id="5905879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5905882">image</span><span class="op" id="5905887">.</span><span class="ident" id="5905888">RegisterFormat</span><span class="op" id="5905902">(</span><span class="string" id="5905903">&#34;jpeg&#34;</span><span class="op" id="5905909">,</span>&nbsp;<span class="string" id="5905911">&#34;\xff\xd8&#34;</span><span class="op" id="5905921">,</span>&nbsp;<span class="ident" id="5905923">Decode</span><span class="op" id="5905929">,</span>&nbsp;<span class="ident" id="5905931">DecodeConfig</span><span class="op" id="5905943">)</span><br>
<span class="lineno"></span><span class="op" id="5905945">}</span>
</div>
</body>
</html>
