<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html" class="current">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1530570">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1530625">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1530679">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1530730">package</span>&nbsp;<span class="ident" id="1530738">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1530747">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1530806">//</span><br>
<span class="lineno"></span><span class="comment" id="1530809">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1530862">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1530919">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1530977">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1531033">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1531092">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1531119">//</span><br>
<span class="lineno"></span><span class="comment" id="1531122">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1531175">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1531193">//</span><br>
<span class="lineno"></span><span class="comment" id="1531196">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1531249">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1531304">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1531365">//</span><br>
<span class="lineno"></span><span class="comment" id="1531368">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1531423">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1531481">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1531540">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1531597">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1531652">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1531713">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1531769">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1531828">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1531850">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1531912">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1531972">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1532033">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1532069">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1532136">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1532203">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1532270">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1532337">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1532404">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1532471">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1532538">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1532605">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1532672">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1532739">//</span><br>
<span class="lineno"></span><span class="comment" id="1532742">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1532811">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1532867">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1532936">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1533005">//</span><br>
<span class="lineno"></span><span class="comment" id="1533008">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1533076">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1533150">import</span>&nbsp;<span class="op" id="1533157">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1533160">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1533169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1533172">const</span>&nbsp;<span class="op" id="1533178">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533181">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533238">bucketCntBits</span>&nbsp;<span class="op" id="1533252">=</span>&nbsp;<span class="num" id="1533254">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533257">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1533271">=</span>&nbsp;<span class="num" id="1533273">1</span>&nbsp;<span class="op" id="1533275">&lt;&lt;</span>&nbsp;<span class="ident" id="1533278">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533294">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533353">loadFactor</span>&nbsp;<span class="op" id="1533364">=</span>&nbsp;<span class="num" id="1533366">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533372">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533453">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533478">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533543">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533612">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1533625">=</span>&nbsp;<span class="num" id="1533627">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533632">maxValueSize</span>&nbsp;<span class="op" id="1533645">=</span>&nbsp;<span class="num" id="1533647">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533653">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533724">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533789">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533826">dataOffset</span>&nbsp;<span class="op" id="1533837">=</span>&nbsp;<span class="ident" id="1533839">unsafe</span><span class="op" id="1533845">.</span><span class="ident" id="1533846">Offsetof</span><span class="op" id="1533854">(</span><span class="keyword" id="1533855">struct</span>&nbsp;<span class="op" id="1533862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533866">b</span>&nbsp;<span class="ident" id="1533868">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533875">v</span>&nbsp;<span class="ident" id="1533877">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533884">}</span><span class="op" id="1533885">{</span><span class="op" id="1533886">}</span><span class="op" id="1533887">.</span><span class="ident" id="1533888">v</span><span class="op" id="1533889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533893">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533973">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534066">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534160">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534242">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534257">=</span>&nbsp;<span class="num" id="1534259">0</span>&nbsp;<span class="comment" id="1534261">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534279">evacuatedEmpty</span>&nbsp;<span class="op" id="1534294">=</span>&nbsp;<span class="num" id="1534296">1</span>&nbsp;<span class="comment" id="1534298">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534338">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534353">=</span>&nbsp;<span class="num" id="1534355">2</span>&nbsp;<span class="comment" id="1534357">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534438">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534453">=</span>&nbsp;<span class="num" id="1534455">3</span>&nbsp;<span class="comment" id="1534457">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534522">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534537">=</span>&nbsp;<span class="num" id="1534539">4</span>&nbsp;<span class="comment" id="1534541">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534588">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534598">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1534610">=</span>&nbsp;<span class="num" id="1534612">1</span>&nbsp;<span class="comment" id="1534614">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534657">oldIterator</span>&nbsp;<span class="op" id="1534669">=</span>&nbsp;<span class="num" id="1534671">2</span>&nbsp;<span class="comment" id="1534673">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534720">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534763">noCheck</span>&nbsp;<span class="op" id="1534771">=</span>&nbsp;<span class="num" id="1534773">1</span><span class="op" id="1534774">&lt;&lt;</span><span class="op" id="1534776">(</span><span class="num" id="1534777">8</span><span class="op" id="1534778">*</span><span class="ident" id="1534779">ptrSize</span><span class="op" id="1534786">)</span>&nbsp;<span class="op" id="1534788">-</span>&nbsp;<span class="num" id="1534790">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534794">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534864">checkgc</span>&nbsp;<span class="op" id="1534872">=</span>&nbsp;<span class="builtintype" id="1534874">false</span><br>
<span class="lineno"></span><span class="op" id="1534880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1534883">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1534909">type</span>&nbsp;<span class="ident" id="1534914">hmap</span>&nbsp;<span class="keyword" id="1534919">struct</span>&nbsp;<span class="op" id="1534926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534929">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535003">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535089">count</span>&nbsp;<span class="builtintype" id="1535095">int</span>&nbsp;<span class="comment" id="1535099">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535171">flags</span>&nbsp;<span class="builtintype" id="1535177">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535185">hash0</span>&nbsp;<span class="builtintype" id="1535191">uint32</span>&nbsp;<span class="comment" id="1535198">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535212">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1535218">uint8</span>&nbsp;&nbsp;<span class="comment" id="1535225">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535292">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535303">unsafe</span><span class="op" id="1535309">.</span><span class="ident" id="1535310">Pointer</span>&nbsp;<span class="comment" id="1535318">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535368">oldbuckets</span>&nbsp;<span class="ident" id="1535379">unsafe</span><span class="op" id="1535385">.</span><span class="ident" id="1535386">Pointer</span>&nbsp;<span class="comment" id="1535394">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535464">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1535475">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1535490">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1535570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535573">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1535599">type</span>&nbsp;<span class="ident" id="1535604">bmap</span>&nbsp;<span class="keyword" id="1535609">struct</span>&nbsp;<span class="op" id="1535616">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535619">tophash</span>&nbsp;&nbsp;<span class="op" id="1535628">[</span><span class="ident" id="1535629">bucketCnt</span><span class="op" id="1535638">]</span><span class="builtintype" id="1535639">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535646">overflow</span>&nbsp;<span class="op" id="1535655">*</span><span class="ident" id="1535656">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535662">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535720">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535803">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535890">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1535966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535969">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1536000">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1536065">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1536098">type</span>&nbsp;<span class="ident" id="1536103">hiter</span>&nbsp;<span class="keyword" id="1536109">struct</span>&nbsp;<span class="op" id="1536116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536119">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536131">unsafe</span><span class="op" id="1536137">.</span><span class="ident" id="1536138">Pointer</span>&nbsp;<span class="comment" id="1536146">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536236">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536248">unsafe</span><span class="op" id="1536254">.</span><span class="ident" id="1536255">Pointer</span>&nbsp;<span class="comment" id="1536263">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536316">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536328">*</span><span class="ident" id="1536329">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536338">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536350">*</span><span class="ident" id="1536351">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536357">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536369">unsafe</span><span class="op" id="1536375">.</span><span class="ident" id="1536376">Pointer</span>&nbsp;<span class="comment" id="1536384">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536432">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536444">*</span><span class="ident" id="1536445">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536459">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536478">startBucket</span>&nbsp;<span class="builtintype" id="1536490">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536505">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536537">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1536549">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536564">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536662">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1536674">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536689">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536754">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1536766">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536773">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1536785">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536792">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1536804">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536813">checkBucket</span>&nbsp;<span class="builtintype" id="1536825">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1536833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536836">func</span>&nbsp;<span class="ident" id="1536841">evacuated</span><span class="op" id="1536850">(</span><span class="ident" id="1536851">b</span>&nbsp;<span class="op" id="1536853">*</span><span class="ident" id="1536854">bmap</span><span class="op" id="1536858">)</span>&nbsp;<span class="builtintype" id="1536860">bool</span>&nbsp;<span class="op" id="1536865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536868">h</span>&nbsp;<span class="op" id="1536870">:=</span>&nbsp;<span class="ident" id="1536873">b</span><span class="op" id="1536874">.</span><span class="ident" id="1536875">tophash</span><span class="op" id="1536882">[</span><span class="num" id="1536883">0</span><span class="op" id="1536884">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536887">return</span>&nbsp;<span class="ident" id="1536894">h</span>&nbsp;<span class="op" id="1536896">&gt;</span>&nbsp;<span class="ident" id="1536898">empty</span>&nbsp;<span class="op" id="1536904">&amp;&amp;</span>&nbsp;<span class="ident" id="1536907">h</span>&nbsp;<span class="op" id="1536909">&lt;</span>&nbsp;<span class="ident" id="1536911">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1536922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536925">func</span>&nbsp;<span class="ident" id="1536930">makemap</span><span class="op" id="1536937">(</span><span class="ident" id="1536938">t</span>&nbsp;<span class="op" id="1536940">*</span><span class="ident" id="1536941">maptype</span><span class="op" id="1536948">,</span>&nbsp;<span class="ident" id="1536950">hint</span>&nbsp;<span class="ident" id="1536955">int64</span><span class="op" id="1536960">)</span>&nbsp;<span class="op" id="1536962">*</span><span class="ident" id="1536963">hmap</span>&nbsp;<span class="op" id="1536968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536971">if</span>&nbsp;<span class="ident" id="1536974">sz</span>&nbsp;<span class="op" id="1536977">:=</span>&nbsp;<span class="ident" id="1536980">unsafe</span><span class="op" id="1536986">.</span><span class="ident" id="1536987">Sizeof</span><span class="op" id="1536993">(</span><span class="ident" id="1536994">hmap</span><span class="op" id="1536998">{</span><span class="op" id="1536999">}</span><span class="op" id="1537000">)</span><span class="op" id="1537001">;</span>&nbsp;<span class="ident" id="1537003">sz</span>&nbsp;<span class="op" id="1537006">&gt;</span>&nbsp;<span class="num" id="1537008">48</span>&nbsp;<span class="op" id="1537011">||</span>&nbsp;<span class="ident" id="1537014">sz</span>&nbsp;<span class="op" id="1537017">!=</span>&nbsp;<span class="builtintype" id="1537020">uintptr</span><span class="op" id="1537027">(</span><span class="ident" id="1537028">t</span><span class="op" id="1537029">.</span><span class="ident" id="1537030">hmap</span><span class="op" id="1537034">.</span><span class="ident" id="1537035">size</span><span class="op" id="1537039">)</span>&nbsp;<span class="op" id="1537041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537045">gothrow</span><span class="op" id="1537052">(</span><span class="string" id="1537053">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1537068">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537075">if</span>&nbsp;<span class="ident" id="1537078">hint</span>&nbsp;<span class="op" id="1537083">&lt;</span>&nbsp;<span class="num" id="1537085">0</span>&nbsp;<span class="op" id="1537087">||</span>&nbsp;<span class="ident" id="1537090">int64</span><span class="op" id="1537095">(</span><span class="builtintype" id="1537096">int32</span><span class="op" id="1537101">(</span><span class="ident" id="1537102">hint</span><span class="op" id="1537106">)</span><span class="op" id="1537107">)</span>&nbsp;<span class="op" id="1537109">!=</span>&nbsp;<span class="ident" id="1537112">hint</span>&nbsp;<span class="op" id="1537117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1537121">panic</span><span class="op" id="1537126">(</span><span class="string" id="1537127">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1537155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537159">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537218">if</span>&nbsp;<span class="op" id="1537221">!</span><span class="ident" id="1537222">ismapkey</span><span class="op" id="1537230">(</span><span class="ident" id="1537231">t</span><span class="op" id="1537232">.</span><span class="ident" id="1537233">key</span><span class="op" id="1537236">)</span>&nbsp;<span class="op" id="1537238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537242">gothrow</span><span class="op" id="1537249">(</span><span class="string" id="1537250">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1537293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537296">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537300">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537340">if</span>&nbsp;<span class="ident" id="1537343">t</span><span class="op" id="1537344">.</span><span class="ident" id="1537345">key</span><span class="op" id="1537348">.</span><span class="ident" id="1537349">size</span>&nbsp;<span class="op" id="1537354">&gt;</span>&nbsp;<span class="ident" id="1537356">maxKeySize</span>&nbsp;<span class="op" id="1537367">&amp;&amp;</span>&nbsp;<span class="op" id="1537370">(</span><span class="op" id="1537371">!</span><span class="ident" id="1537372">t</span><span class="op" id="1537373">.</span><span class="ident" id="1537374">indirectkey</span>&nbsp;<span class="op" id="1537386">||</span>&nbsp;<span class="ident" id="1537389">t</span><span class="op" id="1537390">.</span><span class="ident" id="1537391">keysize</span>&nbsp;<span class="op" id="1537399">!=</span>&nbsp;<span class="builtintype" id="1537402">uint8</span><span class="op" id="1537407">(</span><span class="ident" id="1537408">ptrSize</span><span class="op" id="1537415">)</span><span class="op" id="1537416">)</span>&nbsp;<span class="op" id="1537418">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537423">t</span><span class="op" id="1537424">.</span><span class="ident" id="1537425">key</span><span class="op" id="1537428">.</span><span class="ident" id="1537429">size</span>&nbsp;<span class="op" id="1537434">&lt;=</span>&nbsp;<span class="ident" id="1537437">maxKeySize</span>&nbsp;<span class="op" id="1537448">&amp;&amp;</span>&nbsp;<span class="op" id="1537451">(</span><span class="ident" id="1537452">t</span><span class="op" id="1537453">.</span><span class="ident" id="1537454">indirectkey</span>&nbsp;<span class="op" id="1537466">||</span>&nbsp;<span class="ident" id="1537469">t</span><span class="op" id="1537470">.</span><span class="ident" id="1537471">keysize</span>&nbsp;<span class="op" id="1537479">!=</span>&nbsp;<span class="builtintype" id="1537482">uint8</span><span class="op" id="1537487">(</span><span class="ident" id="1537488">t</span><span class="op" id="1537489">.</span><span class="ident" id="1537490">key</span><span class="op" id="1537493">.</span><span class="ident" id="1537494">size</span><span class="op" id="1537498">)</span><span class="op" id="1537499">)</span>&nbsp;<span class="op" id="1537501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537505">gothrow</span><span class="op" id="1537512">(</span><span class="string" id="1537513">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1537529">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537535">if</span>&nbsp;<span class="ident" id="1537538">t</span><span class="op" id="1537539">.</span><span class="ident" id="1537540">elem</span><span class="op" id="1537544">.</span><span class="ident" id="1537545">size</span>&nbsp;<span class="op" id="1537550">&gt;</span>&nbsp;<span class="ident" id="1537552">maxValueSize</span>&nbsp;<span class="op" id="1537565">&amp;&amp;</span>&nbsp;<span class="op" id="1537568">(</span><span class="op" id="1537569">!</span><span class="ident" id="1537570">t</span><span class="op" id="1537571">.</span><span class="ident" id="1537572">indirectvalue</span>&nbsp;<span class="op" id="1537586">||</span>&nbsp;<span class="ident" id="1537589">t</span><span class="op" id="1537590">.</span><span class="ident" id="1537591">valuesize</span>&nbsp;<span class="op" id="1537601">!=</span>&nbsp;<span class="builtintype" id="1537604">uint8</span><span class="op" id="1537609">(</span><span class="ident" id="1537610">ptrSize</span><span class="op" id="1537617">)</span><span class="op" id="1537618">)</span>&nbsp;<span class="op" id="1537620">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537625">t</span><span class="op" id="1537626">.</span><span class="ident" id="1537627">elem</span><span class="op" id="1537631">.</span><span class="ident" id="1537632">size</span>&nbsp;<span class="op" id="1537637">&lt;=</span>&nbsp;<span class="ident" id="1537640">maxValueSize</span>&nbsp;<span class="op" id="1537653">&amp;&amp;</span>&nbsp;<span class="op" id="1537656">(</span><span class="ident" id="1537657">t</span><span class="op" id="1537658">.</span><span class="ident" id="1537659">indirectvalue</span>&nbsp;<span class="op" id="1537673">||</span>&nbsp;<span class="ident" id="1537676">t</span><span class="op" id="1537677">.</span><span class="ident" id="1537678">valuesize</span>&nbsp;<span class="op" id="1537688">!=</span>&nbsp;<span class="builtintype" id="1537691">uint8</span><span class="op" id="1537696">(</span><span class="ident" id="1537697">t</span><span class="op" id="1537698">.</span><span class="ident" id="1537699">elem</span><span class="op" id="1537703">.</span><span class="ident" id="1537704">size</span><span class="op" id="1537708">)</span><span class="op" id="1537709">)</span>&nbsp;<span class="op" id="1537711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537715">gothrow</span><span class="op" id="1537722">(</span><span class="string" id="1537723">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1537741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537744">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537748">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537825">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537870">if</span>&nbsp;<span class="ident" id="1537873">t</span><span class="op" id="1537874">.</span><span class="ident" id="1537875">key</span><span class="op" id="1537878">.</span><span class="ident" id="1537879">align</span>&nbsp;<span class="op" id="1537885">&gt;</span>&nbsp;<span class="ident" id="1537887">bucketCnt</span>&nbsp;<span class="op" id="1537897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537901">gothrow</span><span class="op" id="1537908">(</span><span class="string" id="1537909">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1537928">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537934">if</span>&nbsp;<span class="ident" id="1537937">t</span><span class="op" id="1537938">.</span><span class="ident" id="1537939">elem</span><span class="op" id="1537943">.</span><span class="ident" id="1537944">align</span>&nbsp;<span class="op" id="1537950">&gt;</span>&nbsp;<span class="ident" id="1537952">bucketCnt</span>&nbsp;<span class="op" id="1537962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537966">gothrow</span><span class="op" id="1537973">(</span><span class="string" id="1537974">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1537995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538001">if</span>&nbsp;<span class="builtintype" id="1538004">uintptr</span><span class="op" id="1538011">(</span><span class="ident" id="1538012">t</span><span class="op" id="1538013">.</span><span class="ident" id="1538014">key</span><span class="op" id="1538017">.</span><span class="ident" id="1538018">size</span><span class="op" id="1538022">)</span><span class="op" id="1538023">%</span><span class="builtintype" id="1538024">uintptr</span><span class="op" id="1538031">(</span><span class="ident" id="1538032">t</span><span class="op" id="1538033">.</span><span class="ident" id="1538034">key</span><span class="op" id="1538037">.</span><span class="ident" id="1538038">align</span><span class="op" id="1538043">)</span>&nbsp;<span class="op" id="1538045">!=</span>&nbsp;<span class="num" id="1538048">0</span>&nbsp;<span class="op" id="1538050">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538054">gothrow</span><span class="op" id="1538061">(</span><span class="string" id="1538062">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1538100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538106">if</span>&nbsp;<span class="builtintype" id="1538109">uintptr</span><span class="op" id="1538116">(</span><span class="ident" id="1538117">t</span><span class="op" id="1538118">.</span><span class="ident" id="1538119">elem</span><span class="op" id="1538123">.</span><span class="ident" id="1538124">size</span><span class="op" id="1538128">)</span><span class="op" id="1538129">%</span><span class="builtintype" id="1538130">uintptr</span><span class="op" id="1538137">(</span><span class="ident" id="1538138">t</span><span class="op" id="1538139">.</span><span class="ident" id="1538140">elem</span><span class="op" id="1538144">.</span><span class="ident" id="1538145">align</span><span class="op" id="1538150">)</span>&nbsp;<span class="op" id="1538152">!=</span>&nbsp;<span class="num" id="1538155">0</span>&nbsp;<span class="op" id="1538157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538161">gothrow</span><span class="op" id="1538168">(</span><span class="string" id="1538169">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1538211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538214">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538217">if</span>&nbsp;<span class="ident" id="1538220">bucketCnt</span>&nbsp;<span class="op" id="1538230">&lt;</span>&nbsp;<span class="num" id="1538232">8</span>&nbsp;<span class="op" id="1538234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538238">gothrow</span><span class="op" id="1538245">(</span><span class="string" id="1538246">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1538289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538295">if</span>&nbsp;<span class="ident" id="1538298">dataOffset</span><span class="op" id="1538308">%</span><span class="builtintype" id="1538309">uintptr</span><span class="op" id="1538316">(</span><span class="ident" id="1538317">t</span><span class="op" id="1538318">.</span><span class="ident" id="1538319">key</span><span class="op" id="1538322">.</span><span class="ident" id="1538323">align</span><span class="op" id="1538328">)</span>&nbsp;<span class="op" id="1538330">!=</span>&nbsp;<span class="num" id="1538333">0</span>&nbsp;<span class="op" id="1538335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538339">gothrow</span><span class="op" id="1538346">(</span><span class="string" id="1538347">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1538377">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538383">if</span>&nbsp;<span class="ident" id="1538386">dataOffset</span><span class="op" id="1538396">%</span><span class="builtintype" id="1538397">uintptr</span><span class="op" id="1538404">(</span><span class="ident" id="1538405">t</span><span class="op" id="1538406">.</span><span class="ident" id="1538407">elem</span><span class="op" id="1538411">.</span><span class="ident" id="1538412">align</span><span class="op" id="1538417">)</span>&nbsp;<span class="op" id="1538419">!=</span>&nbsp;<span class="num" id="1538422">0</span>&nbsp;<span class="op" id="1538424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538428">gothrow</span><span class="op" id="1538435">(</span><span class="string" id="1538436">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1538468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538475">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538543">B</span>&nbsp;<span class="op" id="1538545">:=</span>&nbsp;<span class="builtintype" id="1538548">uint8</span><span class="op" id="1538553">(</span><span class="num" id="1538554">0</span><span class="op" id="1538555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538558">for</span>&nbsp;<span class="op" id="1538562">;</span>&nbsp;<span class="ident" id="1538564">hint</span>&nbsp;<span class="op" id="1538569">&gt;</span>&nbsp;<span class="ident" id="1538571">bucketCnt</span>&nbsp;<span class="op" id="1538581">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1538584">float32</span><span class="op" id="1538591">(</span><span class="ident" id="1538592">hint</span><span class="op" id="1538596">)</span>&nbsp;<span class="op" id="1538598">&gt;</span>&nbsp;<span class="ident" id="1538600">loadFactor</span><span class="op" id="1538610">*</span><span class="builtintype" id="1538611">float32</span><span class="op" id="1538618">(</span><span class="builtintype" id="1538619">uintptr</span><span class="op" id="1538626">(</span><span class="num" id="1538627">1</span><span class="op" id="1538628">)</span><span class="op" id="1538629">&lt;&lt;</span><span class="ident" id="1538631">B</span><span class="op" id="1538632">)</span><span class="op" id="1538633">;</span>&nbsp;<span class="ident" id="1538635">B</span><span class="op" id="1538636">++</span>&nbsp;<span class="op" id="1538639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538646">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538678">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538752">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538813">var</span>&nbsp;<span class="ident" id="1538817">buckets</span>&nbsp;<span class="ident" id="1538825">unsafe</span><span class="op" id="1538831">.</span><span class="ident" id="1538832">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538841">if</span>&nbsp;<span class="ident" id="1538844">B</span>&nbsp;<span class="op" id="1538846">!=</span>&nbsp;<span class="num" id="1538849">0</span>&nbsp;<span class="op" id="1538851">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538855">if</span>&nbsp;<span class="ident" id="1538858">checkgc</span>&nbsp;<span class="op" id="1538866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538871">memstats</span><span class="op" id="1538879">.</span><span class="ident" id="1538880">next_gc</span>&nbsp;<span class="op" id="1538888">=</span>&nbsp;<span class="ident" id="1538890">memstats</span><span class="op" id="1538898">.</span><span class="ident" id="1538899">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538916">buckets</span>&nbsp;<span class="op" id="1538924">=</span>&nbsp;<span class="ident" id="1538926">newarray</span><span class="op" id="1538934">(</span><span class="ident" id="1538935">t</span><span class="op" id="1538936">.</span><span class="ident" id="1538937">bucket</span><span class="op" id="1538943">,</span>&nbsp;<span class="builtintype" id="1538945">uintptr</span><span class="op" id="1538952">(</span><span class="num" id="1538953">1</span><span class="op" id="1538954">)</span><span class="op" id="1538955">&lt;&lt;</span><span class="ident" id="1538957">B</span><span class="op" id="1538958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538961">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538965">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538985">if</span>&nbsp;<span class="ident" id="1538988">checkgc</span>&nbsp;<span class="op" id="1538996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539000">memstats</span><span class="op" id="1539008">.</span><span class="ident" id="1539009">next_gc</span>&nbsp;<span class="op" id="1539017">=</span>&nbsp;<span class="ident" id="1539019">memstats</span><span class="op" id="1539027">.</span><span class="ident" id="1539028">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539040">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539043">h</span>&nbsp;<span class="op" id="1539045">:=</span>&nbsp;<span class="op" id="1539048">(</span><span class="op" id="1539049">*</span><span class="ident" id="1539050">hmap</span><span class="op" id="1539054">)</span><span class="op" id="1539055">(</span><span class="ident" id="1539056">newobject</span><span class="op" id="1539065">(</span><span class="ident" id="1539066">t</span><span class="op" id="1539067">.</span><span class="ident" id="1539068">hmap</span><span class="op" id="1539072">)</span><span class="op" id="1539073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539076">h</span><span class="op" id="1539077">.</span><span class="ident" id="1539078">count</span>&nbsp;<span class="op" id="1539084">=</span>&nbsp;<span class="num" id="1539086">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539089">h</span><span class="op" id="1539090">.</span><span class="ident" id="1539091">B</span>&nbsp;<span class="op" id="1539093">=</span>&nbsp;<span class="ident" id="1539095">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539098">h</span><span class="op" id="1539099">.</span><span class="ident" id="1539100">flags</span>&nbsp;<span class="op" id="1539106">=</span>&nbsp;<span class="num" id="1539108">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539111">h</span><span class="op" id="1539112">.</span><span class="ident" id="1539113">hash0</span>&nbsp;<span class="op" id="1539119">=</span>&nbsp;<span class="ident" id="1539121">fastrand1</span><span class="op" id="1539130">(</span><span class="op" id="1539131">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539134">h</span><span class="op" id="1539135">.</span><span class="ident" id="1539136">buckets</span>&nbsp;<span class="op" id="1539144">=</span>&nbsp;<span class="ident" id="1539146">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539155">h</span><span class="op" id="1539156">.</span><span class="ident" id="1539157">oldbuckets</span>&nbsp;<span class="op" id="1539168">=</span>&nbsp;<span class="ident" id="1539170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539175">h</span><span class="op" id="1539176">.</span><span class="ident" id="1539177">nevacuate</span>&nbsp;<span class="op" id="1539187">=</span>&nbsp;<span class="num" id="1539189">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539193">return</span>&nbsp;<span class="ident" id="1539200">h</span><br>
<span class="lineno">230</span><span class="op" id="1539202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1539205">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1539276">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1539347">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1539377">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1539445">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1539476">func</span>&nbsp;<span class="ident" id="1539481">mapaccess1</span><span class="op" id="1539491">(</span><span class="ident" id="1539492">t</span>&nbsp;<span class="op" id="1539494">*</span><span class="ident" id="1539495">maptype</span><span class="op" id="1539502">,</span>&nbsp;<span class="ident" id="1539504">h</span>&nbsp;<span class="op" id="1539506">*</span><span class="ident" id="1539507">hmap</span><span class="op" id="1539511">,</span>&nbsp;<span class="ident" id="1539513">key</span>&nbsp;<span class="ident" id="1539517">unsafe</span><span class="op" id="1539523">.</span><span class="ident" id="1539524">Pointer</span><span class="op" id="1539531">)</span>&nbsp;<span class="ident" id="1539533">unsafe</span><span class="op" id="1539539">.</span><span class="ident" id="1539540">Pointer</span>&nbsp;<span class="op" id="1539548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539551">if</span>&nbsp;<span class="ident" id="1539554">raceenabled</span>&nbsp;<span class="op" id="1539566">&amp;&amp;</span>&nbsp;<span class="ident" id="1539569">h</span>&nbsp;<span class="op" id="1539571">!=</span>&nbsp;<span class="ident" id="1539574">nil</span>&nbsp;<span class="op" id="1539578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539582">callerpc</span>&nbsp;<span class="op" id="1539591">:=</span>&nbsp;<span class="ident" id="1539594">getcallerpc</span><span class="op" id="1539605">(</span><span class="ident" id="1539606">unsafe</span><span class="op" id="1539612">.</span><span class="ident" id="1539613">Pointer</span><span class="op" id="1539620">(</span><span class="op" id="1539621">&amp;</span><span class="ident" id="1539622">t</span><span class="op" id="1539623">)</span><span class="op" id="1539624">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539628">pc</span>&nbsp;<span class="op" id="1539631">:=</span>&nbsp;<span class="ident" id="1539634">funcPC</span><span class="op" id="1539640">(</span><span class="ident" id="1539641">mapaccess1</span><span class="op" id="1539651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539655">racereadpc</span><span class="op" id="1539665">(</span><span class="ident" id="1539666">unsafe</span><span class="op" id="1539672">.</span><span class="ident" id="1539673">Pointer</span><span class="op" id="1539680">(</span><span class="ident" id="1539681">h</span><span class="op" id="1539682">)</span><span class="op" id="1539683">,</span>&nbsp;<span class="ident" id="1539685">callerpc</span><span class="op" id="1539693">,</span>&nbsp;<span class="ident" id="1539695">pc</span><span class="op" id="1539697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539701">raceReadObjectPC</span><span class="op" id="1539717">(</span><span class="ident" id="1539718">t</span><span class="op" id="1539719">.</span><span class="ident" id="1539720">key</span><span class="op" id="1539723">,</span>&nbsp;<span class="ident" id="1539725">key</span><span class="op" id="1539728">,</span>&nbsp;<span class="ident" id="1539730">callerpc</span><span class="op" id="1539738">,</span>&nbsp;<span class="ident" id="1539740">pc</span><span class="op" id="1539742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539748">if</span>&nbsp;<span class="ident" id="1539751">h</span>&nbsp;<span class="op" id="1539753">==</span>&nbsp;<span class="ident" id="1539756">nil</span>&nbsp;<span class="op" id="1539760">||</span>&nbsp;<span class="ident" id="1539763">h</span><span class="op" id="1539764">.</span><span class="ident" id="1539765">count</span>&nbsp;<span class="op" id="1539771">==</span>&nbsp;<span class="num" id="1539774">0</span>&nbsp;<span class="op" id="1539776">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539780">return</span>&nbsp;<span class="ident" id="1539787">unsafe</span><span class="op" id="1539793">.</span><span class="ident" id="1539794">Pointer</span><span class="op" id="1539801">(</span><span class="ident" id="1539802">t</span><span class="op" id="1539803">.</span><span class="ident" id="1539804">elem</span><span class="op" id="1539808">.</span><span class="ident" id="1539809">zero</span><span class="op" id="1539813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539819">alg</span>&nbsp;<span class="op" id="1539823">:=</span>&nbsp;<span class="ident" id="1539826">goalg</span><span class="op" id="1539831">(</span><span class="ident" id="1539832">t</span><span class="op" id="1539833">.</span><span class="ident" id="1539834">key</span><span class="op" id="1539837">.</span><span class="ident" id="1539838">alg</span><span class="op" id="1539841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539844">hash</span>&nbsp;<span class="op" id="1539849">:=</span>&nbsp;<span class="ident" id="1539852">alg</span><span class="op" id="1539855">.</span><span class="ident" id="1539856">hash</span><span class="op" id="1539860">(</span><span class="ident" id="1539861">key</span><span class="op" id="1539864">,</span>&nbsp;<span class="builtintype" id="1539866">uintptr</span><span class="op" id="1539873">(</span><span class="ident" id="1539874">t</span><span class="op" id="1539875">.</span><span class="ident" id="1539876">key</span><span class="op" id="1539879">.</span><span class="ident" id="1539880">size</span><span class="op" id="1539884">)</span><span class="op" id="1539885">,</span>&nbsp;<span class="builtintype" id="1539887">uintptr</span><span class="op" id="1539894">(</span><span class="ident" id="1539895">h</span><span class="op" id="1539896">.</span><span class="ident" id="1539897">hash0</span><span class="op" id="1539902">)</span><span class="op" id="1539903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539906">m</span>&nbsp;<span class="op" id="1539908">:=</span>&nbsp;<span class="builtintype" id="1539911">uintptr</span><span class="op" id="1539918">(</span><span class="num" id="1539919">1</span><span class="op" id="1539920">)</span><span class="op" id="1539921">&lt;&lt;</span><span class="ident" id="1539923">h</span><span class="op" id="1539924">.</span><span class="ident" id="1539925">B</span>&nbsp;<span class="op" id="1539927">-</span>&nbsp;<span class="num" id="1539929">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539932">b</span>&nbsp;<span class="op" id="1539934">:=</span>&nbsp;<span class="op" id="1539937">(</span><span class="op" id="1539938">*</span><span class="ident" id="1539939">bmap</span><span class="op" id="1539943">)</span><span class="op" id="1539944">(</span><span class="ident" id="1539945">add</span><span class="op" id="1539948">(</span><span class="ident" id="1539949">h</span><span class="op" id="1539950">.</span><span class="ident" id="1539951">buckets</span><span class="op" id="1539958">,</span>&nbsp;<span class="op" id="1539960">(</span><span class="ident" id="1539961">hash</span><span class="op" id="1539965">&amp;</span><span class="ident" id="1539966">m</span><span class="op" id="1539967">)</span><span class="op" id="1539968">*</span><span class="builtintype" id="1539969">uintptr</span><span class="op" id="1539976">(</span><span class="ident" id="1539977">t</span><span class="op" id="1539978">.</span><span class="ident" id="1539979">bucketsize</span><span class="op" id="1539989">)</span><span class="op" id="1539990">)</span><span class="op" id="1539991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539994">if</span>&nbsp;<span class="ident" id="1539997">c</span>&nbsp;<span class="op" id="1539999">:=</span>&nbsp;<span class="ident" id="1540002">h</span><span class="op" id="1540003">.</span><span class="ident" id="1540004">oldbuckets</span><span class="op" id="1540014">;</span>&nbsp;<span class="ident" id="1540016">c</span>&nbsp;<span class="op" id="1540018">!=</span>&nbsp;<span class="ident" id="1540021">nil</span>&nbsp;<span class="op" id="1540025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540029">oldb</span>&nbsp;<span class="op" id="1540034">:=</span>&nbsp;<span class="op" id="1540037">(</span><span class="op" id="1540038">*</span><span class="ident" id="1540039">bmap</span><span class="op" id="1540043">)</span><span class="op" id="1540044">(</span><span class="ident" id="1540045">add</span><span class="op" id="1540048">(</span><span class="ident" id="1540049">c</span><span class="op" id="1540050">,</span>&nbsp;<span class="op" id="1540052">(</span><span class="ident" id="1540053">hash</span><span class="op" id="1540057">&amp;</span><span class="op" id="1540058">(</span><span class="ident" id="1540059">m</span><span class="op" id="1540060">&gt;&gt;</span><span class="num" id="1540062">1</span><span class="op" id="1540063">)</span><span class="op" id="1540064">)</span><span class="op" id="1540065">*</span><span class="builtintype" id="1540066">uintptr</span><span class="op" id="1540073">(</span><span class="ident" id="1540074">t</span><span class="op" id="1540075">.</span><span class="ident" id="1540076">bucketsize</span><span class="op" id="1540086">)</span><span class="op" id="1540087">)</span><span class="op" id="1540088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540092">if</span>&nbsp;<span class="op" id="1540095">!</span><span class="ident" id="1540096">evacuated</span><span class="op" id="1540105">(</span><span class="ident" id="1540106">oldb</span><span class="op" id="1540110">)</span>&nbsp;<span class="op" id="1540112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540117">b</span>&nbsp;<span class="op" id="1540119">=</span>&nbsp;<span class="ident" id="1540121">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540134">top</span>&nbsp;<span class="op" id="1540138">:=</span>&nbsp;<span class="builtintype" id="1540141">uint8</span><span class="op" id="1540146">(</span><span class="ident" id="1540147">hash</span>&nbsp;<span class="op" id="1540152">&gt;&gt;</span>&nbsp;<span class="op" id="1540155">(</span><span class="ident" id="1540156">ptrSize</span><span class="op" id="1540163">*</span><span class="num" id="1540164">8</span>&nbsp;<span class="op" id="1540166">-</span>&nbsp;<span class="num" id="1540168">8</span><span class="op" id="1540169">)</span><span class="op" id="1540170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540173">if</span>&nbsp;<span class="ident" id="1540176">top</span>&nbsp;<span class="op" id="1540180">&lt;</span>&nbsp;<span class="ident" id="1540182">minTopHash</span>&nbsp;<span class="op" id="1540193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540197">top</span>&nbsp;<span class="op" id="1540201">+=</span>&nbsp;<span class="ident" id="1540204">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540219">for</span>&nbsp;<span class="op" id="1540223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540227">for</span>&nbsp;<span class="ident" id="1540231">i</span>&nbsp;<span class="op" id="1540233">:=</span>&nbsp;<span class="builtintype" id="1540236">uintptr</span><span class="op" id="1540243">(</span><span class="num" id="1540244">0</span><span class="op" id="1540245">)</span><span class="op" id="1540246">;</span>&nbsp;<span class="ident" id="1540248">i</span>&nbsp;<span class="op" id="1540250">&lt;</span>&nbsp;<span class="ident" id="1540252">bucketCnt</span><span class="op" id="1540261">;</span>&nbsp;<span class="ident" id="1540263">i</span><span class="op" id="1540264">++</span>&nbsp;<span class="op" id="1540267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540272">if</span>&nbsp;<span class="ident" id="1540275">b</span><span class="op" id="1540276">.</span><span class="ident" id="1540277">tophash</span><span class="op" id="1540284">[</span><span class="ident" id="1540285">i</span><span class="op" id="1540286">]</span>&nbsp;<span class="op" id="1540288">!=</span>&nbsp;<span class="ident" id="1540291">top</span>&nbsp;<span class="op" id="1540295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540301">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540318">k</span>&nbsp;<span class="op" id="1540320">:=</span>&nbsp;<span class="ident" id="1540323">add</span><span class="op" id="1540326">(</span><span class="ident" id="1540327">unsafe</span><span class="op" id="1540333">.</span><span class="ident" id="1540334">Pointer</span><span class="op" id="1540341">(</span><span class="ident" id="1540342">b</span><span class="op" id="1540343">)</span><span class="op" id="1540344">,</span>&nbsp;<span class="ident" id="1540346">dataOffset</span><span class="op" id="1540356">+</span><span class="ident" id="1540357">i</span><span class="op" id="1540358">*</span><span class="builtintype" id="1540359">uintptr</span><span class="op" id="1540366">(</span><span class="ident" id="1540367">t</span><span class="op" id="1540368">.</span><span class="ident" id="1540369">keysize</span><span class="op" id="1540376">)</span><span class="op" id="1540377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540382">if</span>&nbsp;<span class="ident" id="1540385">t</span><span class="op" id="1540386">.</span><span class="ident" id="1540387">indirectkey</span>&nbsp;<span class="op" id="1540399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540405">k</span>&nbsp;<span class="op" id="1540407">=</span>&nbsp;<span class="op" id="1540409">*</span><span class="op" id="1540410">(</span><span class="op" id="1540411">(</span><span class="op" id="1540412">*</span><span class="ident" id="1540413">unsafe</span><span class="op" id="1540419">.</span><span class="ident" id="1540420">Pointer</span><span class="op" id="1540427">)</span><span class="op" id="1540428">(</span><span class="ident" id="1540429">k</span><span class="op" id="1540430">)</span><span class="op" id="1540431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540436">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540441">if</span>&nbsp;<span class="ident" id="1540444">alg</span><span class="op" id="1540447">.</span><span class="ident" id="1540448">equal</span><span class="op" id="1540453">(</span><span class="ident" id="1540454">key</span><span class="op" id="1540457">,</span>&nbsp;<span class="ident" id="1540459">k</span><span class="op" id="1540460">,</span>&nbsp;<span class="builtintype" id="1540462">uintptr</span><span class="op" id="1540469">(</span><span class="ident" id="1540470">t</span><span class="op" id="1540471">.</span><span class="ident" id="1540472">key</span><span class="op" id="1540475">.</span><span class="ident" id="1540476">size</span><span class="op" id="1540480">)</span><span class="op" id="1540481">)</span>&nbsp;<span class="op" id="1540483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540489">v</span>&nbsp;<span class="op" id="1540491">:=</span>&nbsp;<span class="ident" id="1540494">add</span><span class="op" id="1540497">(</span><span class="ident" id="1540498">unsafe</span><span class="op" id="1540504">.</span><span class="ident" id="1540505">Pointer</span><span class="op" id="1540512">(</span><span class="ident" id="1540513">b</span><span class="op" id="1540514">)</span><span class="op" id="1540515">,</span>&nbsp;<span class="ident" id="1540517">dataOffset</span><span class="op" id="1540527">+</span><span class="ident" id="1540528">bucketCnt</span><span class="op" id="1540537">*</span><span class="builtintype" id="1540538">uintptr</span><span class="op" id="1540545">(</span><span class="ident" id="1540546">t</span><span class="op" id="1540547">.</span><span class="ident" id="1540548">keysize</span><span class="op" id="1540555">)</span><span class="op" id="1540556">+</span><span class="ident" id="1540557">i</span><span class="op" id="1540558">*</span><span class="builtintype" id="1540559">uintptr</span><span class="op" id="1540566">(</span><span class="ident" id="1540567">t</span><span class="op" id="1540568">.</span><span class="ident" id="1540569">valuesize</span><span class="op" id="1540578">)</span><span class="op" id="1540579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540585">if</span>&nbsp;<span class="ident" id="1540588">t</span><span class="op" id="1540589">.</span><span class="ident" id="1540590">indirectvalue</span>&nbsp;<span class="op" id="1540604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540611">v</span>&nbsp;<span class="op" id="1540613">=</span>&nbsp;<span class="op" id="1540615">*</span><span class="op" id="1540616">(</span><span class="op" id="1540617">(</span><span class="op" id="1540618">*</span><span class="ident" id="1540619">unsafe</span><span class="op" id="1540625">.</span><span class="ident" id="1540626">Pointer</span><span class="op" id="1540633">)</span><span class="op" id="1540634">(</span><span class="ident" id="1540635">v</span><span class="op" id="1540636">)</span><span class="op" id="1540637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540643">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540649">return</span>&nbsp;<span class="ident" id="1540656">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540669">b</span>&nbsp;<span class="op" id="1540671">=</span>&nbsp;<span class="ident" id="1540673">b</span><span class="op" id="1540674">.</span><span class="ident" id="1540675">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540686">if</span>&nbsp;<span class="ident" id="1540689">b</span>&nbsp;<span class="op" id="1540691">==</span>&nbsp;<span class="ident" id="1540694">nil</span>&nbsp;<span class="op" id="1540698">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540703">return</span>&nbsp;<span class="ident" id="1540710">unsafe</span><span class="op" id="1540716">.</span><span class="ident" id="1540717">Pointer</span><span class="op" id="1540724">(</span><span class="ident" id="1540725">t</span><span class="op" id="1540726">.</span><span class="ident" id="1540727">elem</span><span class="op" id="1540731">.</span><span class="ident" id="1540732">zero</span><span class="op" id="1540736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540743">}</span><br>
<span class="lineno"></span><span class="op" id="1540745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1540748">func</span>&nbsp;<span class="ident" id="1540753">mapaccess2</span><span class="op" id="1540763">(</span><span class="ident" id="1540764">t</span>&nbsp;<span class="op" id="1540766">*</span><span class="ident" id="1540767">maptype</span><span class="op" id="1540774">,</span>&nbsp;<span class="ident" id="1540776">h</span>&nbsp;<span class="op" id="1540778">*</span><span class="ident" id="1540779">hmap</span><span class="op" id="1540783">,</span>&nbsp;<span class="ident" id="1540785">key</span>&nbsp;<span class="ident" id="1540789">unsafe</span><span class="op" id="1540795">.</span><span class="ident" id="1540796">Pointer</span><span class="op" id="1540803">)</span>&nbsp;<span class="op" id="1540805">(</span><span class="ident" id="1540806">unsafe</span><span class="op" id="1540812">.</span><span class="ident" id="1540813">Pointer</span><span class="op" id="1540820">,</span>&nbsp;<span class="builtintype" id="1540822">bool</span><span class="op" id="1540826">)</span>&nbsp;<span class="op" id="1540828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540831">if</span>&nbsp;<span class="ident" id="1540834">raceenabled</span>&nbsp;<span class="op" id="1540846">&amp;&amp;</span>&nbsp;<span class="ident" id="1540849">h</span>&nbsp;<span class="op" id="1540851">!=</span>&nbsp;<span class="ident" id="1540854">nil</span>&nbsp;<span class="op" id="1540858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540862">callerpc</span>&nbsp;<span class="op" id="1540871">:=</span>&nbsp;<span class="ident" id="1540874">getcallerpc</span><span class="op" id="1540885">(</span><span class="ident" id="1540886">unsafe</span><span class="op" id="1540892">.</span><span class="ident" id="1540893">Pointer</span><span class="op" id="1540900">(</span><span class="op" id="1540901">&amp;</span><span class="ident" id="1540902">t</span><span class="op" id="1540903">)</span><span class="op" id="1540904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540908">pc</span>&nbsp;<span class="op" id="1540911">:=</span>&nbsp;<span class="ident" id="1540914">funcPC</span><span class="op" id="1540920">(</span><span class="ident" id="1540921">mapaccess2</span><span class="op" id="1540931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540935">racereadpc</span><span class="op" id="1540945">(</span><span class="ident" id="1540946">unsafe</span><span class="op" id="1540952">.</span><span class="ident" id="1540953">Pointer</span><span class="op" id="1540960">(</span><span class="ident" id="1540961">h</span><span class="op" id="1540962">)</span><span class="op" id="1540963">,</span>&nbsp;<span class="ident" id="1540965">callerpc</span><span class="op" id="1540973">,</span>&nbsp;<span class="ident" id="1540975">pc</span><span class="op" id="1540977">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540981">raceReadObjectPC</span><span class="op" id="1540997">(</span><span class="ident" id="1540998">t</span><span class="op" id="1540999">.</span><span class="ident" id="1541000">key</span><span class="op" id="1541003">,</span>&nbsp;<span class="ident" id="1541005">key</span><span class="op" id="1541008">,</span>&nbsp;<span class="ident" id="1541010">callerpc</span><span class="op" id="1541018">,</span>&nbsp;<span class="ident" id="1541020">pc</span><span class="op" id="1541022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541028">if</span>&nbsp;<span class="ident" id="1541031">h</span>&nbsp;<span class="op" id="1541033">==</span>&nbsp;<span class="ident" id="1541036">nil</span>&nbsp;<span class="op" id="1541040">||</span>&nbsp;<span class="ident" id="1541043">h</span><span class="op" id="1541044">.</span><span class="ident" id="1541045">count</span>&nbsp;<span class="op" id="1541051">==</span>&nbsp;<span class="num" id="1541054">0</span>&nbsp;<span class="op" id="1541056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541060">return</span>&nbsp;<span class="ident" id="1541067">unsafe</span><span class="op" id="1541073">.</span><span class="ident" id="1541074">Pointer</span><span class="op" id="1541081">(</span><span class="ident" id="1541082">t</span><span class="op" id="1541083">.</span><span class="ident" id="1541084">elem</span><span class="op" id="1541088">.</span><span class="ident" id="1541089">zero</span><span class="op" id="1541093">)</span><span class="op" id="1541094">,</span>&nbsp;<span class="builtintype" id="1541096">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541103">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541106">alg</span>&nbsp;<span class="op" id="1541110">:=</span>&nbsp;<span class="ident" id="1541113">goalg</span><span class="op" id="1541118">(</span><span class="ident" id="1541119">t</span><span class="op" id="1541120">.</span><span class="ident" id="1541121">key</span><span class="op" id="1541124">.</span><span class="ident" id="1541125">alg</span><span class="op" id="1541128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541131">hash</span>&nbsp;<span class="op" id="1541136">:=</span>&nbsp;<span class="ident" id="1541139">alg</span><span class="op" id="1541142">.</span><span class="ident" id="1541143">hash</span><span class="op" id="1541147">(</span><span class="ident" id="1541148">key</span><span class="op" id="1541151">,</span>&nbsp;<span class="builtintype" id="1541153">uintptr</span><span class="op" id="1541160">(</span><span class="ident" id="1541161">t</span><span class="op" id="1541162">.</span><span class="ident" id="1541163">key</span><span class="op" id="1541166">.</span><span class="ident" id="1541167">size</span><span class="op" id="1541171">)</span><span class="op" id="1541172">,</span>&nbsp;<span class="builtintype" id="1541174">uintptr</span><span class="op" id="1541181">(</span><span class="ident" id="1541182">h</span><span class="op" id="1541183">.</span><span class="ident" id="1541184">hash0</span><span class="op" id="1541189">)</span><span class="op" id="1541190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541193">m</span>&nbsp;<span class="op" id="1541195">:=</span>&nbsp;<span class="builtintype" id="1541198">uintptr</span><span class="op" id="1541205">(</span><span class="num" id="1541206">1</span><span class="op" id="1541207">)</span><span class="op" id="1541208">&lt;&lt;</span><span class="ident" id="1541210">h</span><span class="op" id="1541211">.</span><span class="ident" id="1541212">B</span>&nbsp;<span class="op" id="1541214">-</span>&nbsp;<span class="num" id="1541216">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541219">b</span>&nbsp;<span class="op" id="1541221">:=</span>&nbsp;<span class="op" id="1541224">(</span><span class="op" id="1541225">*</span><span class="ident" id="1541226">bmap</span><span class="op" id="1541230">)</span><span class="op" id="1541231">(</span><span class="ident" id="1541232">unsafe</span><span class="op" id="1541238">.</span><span class="ident" id="1541239">Pointer</span><span class="op" id="1541246">(</span><span class="builtintype" id="1541247">uintptr</span><span class="op" id="1541254">(</span><span class="ident" id="1541255">h</span><span class="op" id="1541256">.</span><span class="ident" id="1541257">buckets</span><span class="op" id="1541264">)</span>&nbsp;<span class="op" id="1541266">+</span>&nbsp;<span class="op" id="1541268">(</span><span class="ident" id="1541269">hash</span><span class="op" id="1541273">&amp;</span><span class="ident" id="1541274">m</span><span class="op" id="1541275">)</span><span class="op" id="1541276">*</span><span class="builtintype" id="1541277">uintptr</span><span class="op" id="1541284">(</span><span class="ident" id="1541285">t</span><span class="op" id="1541286">.</span><span class="ident" id="1541287">bucketsize</span><span class="op" id="1541297">)</span><span class="op" id="1541298">)</span><span class="op" id="1541299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541302">if</span>&nbsp;<span class="ident" id="1541305">c</span>&nbsp;<span class="op" id="1541307">:=</span>&nbsp;<span class="ident" id="1541310">h</span><span class="op" id="1541311">.</span><span class="ident" id="1541312">oldbuckets</span><span class="op" id="1541322">;</span>&nbsp;<span class="ident" id="1541324">c</span>&nbsp;<span class="op" id="1541326">!=</span>&nbsp;<span class="ident" id="1541329">nil</span>&nbsp;<span class="op" id="1541333">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541337">oldb</span>&nbsp;<span class="op" id="1541342">:=</span>&nbsp;<span class="op" id="1541345">(</span><span class="op" id="1541346">*</span><span class="ident" id="1541347">bmap</span><span class="op" id="1541351">)</span><span class="op" id="1541352">(</span><span class="ident" id="1541353">unsafe</span><span class="op" id="1541359">.</span><span class="ident" id="1541360">Pointer</span><span class="op" id="1541367">(</span><span class="builtintype" id="1541368">uintptr</span><span class="op" id="1541375">(</span><span class="ident" id="1541376">c</span><span class="op" id="1541377">)</span>&nbsp;<span class="op" id="1541379">+</span>&nbsp;<span class="op" id="1541381">(</span><span class="ident" id="1541382">hash</span><span class="op" id="1541386">&amp;</span><span class="op" id="1541387">(</span><span class="ident" id="1541388">m</span><span class="op" id="1541389">&gt;&gt;</span><span class="num" id="1541391">1</span><span class="op" id="1541392">)</span><span class="op" id="1541393">)</span><span class="op" id="1541394">*</span><span class="builtintype" id="1541395">uintptr</span><span class="op" id="1541402">(</span><span class="ident" id="1541403">t</span><span class="op" id="1541404">.</span><span class="ident" id="1541405">bucketsize</span><span class="op" id="1541415">)</span><span class="op" id="1541416">)</span><span class="op" id="1541417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541421">if</span>&nbsp;<span class="op" id="1541424">!</span><span class="ident" id="1541425">evacuated</span><span class="op" id="1541434">(</span><span class="ident" id="1541435">oldb</span><span class="op" id="1541439">)</span>&nbsp;<span class="op" id="1541441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541446">b</span>&nbsp;<span class="op" id="1541448">=</span>&nbsp;<span class="ident" id="1541450">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541460">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541463">top</span>&nbsp;<span class="op" id="1541467">:=</span>&nbsp;<span class="builtintype" id="1541470">uint8</span><span class="op" id="1541475">(</span><span class="ident" id="1541476">hash</span>&nbsp;<span class="op" id="1541481">&gt;&gt;</span>&nbsp;<span class="op" id="1541484">(</span><span class="ident" id="1541485">ptrSize</span><span class="op" id="1541492">*</span><span class="num" id="1541493">8</span>&nbsp;<span class="op" id="1541495">-</span>&nbsp;<span class="num" id="1541497">8</span><span class="op" id="1541498">)</span><span class="op" id="1541499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541502">if</span>&nbsp;<span class="ident" id="1541505">top</span>&nbsp;<span class="op" id="1541509">&lt;</span>&nbsp;<span class="ident" id="1541511">minTopHash</span>&nbsp;<span class="op" id="1541522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541526">top</span>&nbsp;<span class="op" id="1541530">+=</span>&nbsp;<span class="ident" id="1541533">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541548">for</span>&nbsp;<span class="op" id="1541552">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541556">for</span>&nbsp;<span class="ident" id="1541560">i</span>&nbsp;<span class="op" id="1541562">:=</span>&nbsp;<span class="builtintype" id="1541565">uintptr</span><span class="op" id="1541572">(</span><span class="num" id="1541573">0</span><span class="op" id="1541574">)</span><span class="op" id="1541575">;</span>&nbsp;<span class="ident" id="1541577">i</span>&nbsp;<span class="op" id="1541579">&lt;</span>&nbsp;<span class="ident" id="1541581">bucketCnt</span><span class="op" id="1541590">;</span>&nbsp;<span class="ident" id="1541592">i</span><span class="op" id="1541593">++</span>&nbsp;<span class="op" id="1541596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541601">if</span>&nbsp;<span class="ident" id="1541604">b</span><span class="op" id="1541605">.</span><span class="ident" id="1541606">tophash</span><span class="op" id="1541613">[</span><span class="ident" id="1541614">i</span><span class="op" id="1541615">]</span>&nbsp;<span class="op" id="1541617">!=</span>&nbsp;<span class="ident" id="1541620">top</span>&nbsp;<span class="op" id="1541624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541630">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541647">k</span>&nbsp;<span class="op" id="1541649">:=</span>&nbsp;<span class="ident" id="1541652">add</span><span class="op" id="1541655">(</span><span class="ident" id="1541656">unsafe</span><span class="op" id="1541662">.</span><span class="ident" id="1541663">Pointer</span><span class="op" id="1541670">(</span><span class="ident" id="1541671">b</span><span class="op" id="1541672">)</span><span class="op" id="1541673">,</span>&nbsp;<span class="ident" id="1541675">dataOffset</span><span class="op" id="1541685">+</span><span class="ident" id="1541686">i</span><span class="op" id="1541687">*</span><span class="builtintype" id="1541688">uintptr</span><span class="op" id="1541695">(</span><span class="ident" id="1541696">t</span><span class="op" id="1541697">.</span><span class="ident" id="1541698">keysize</span><span class="op" id="1541705">)</span><span class="op" id="1541706">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541711">if</span>&nbsp;<span class="ident" id="1541714">t</span><span class="op" id="1541715">.</span><span class="ident" id="1541716">indirectkey</span>&nbsp;<span class="op" id="1541728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541734">k</span>&nbsp;<span class="op" id="1541736">=</span>&nbsp;<span class="op" id="1541738">*</span><span class="op" id="1541739">(</span><span class="op" id="1541740">(</span><span class="op" id="1541741">*</span><span class="ident" id="1541742">unsafe</span><span class="op" id="1541748">.</span><span class="ident" id="1541749">Pointer</span><span class="op" id="1541756">)</span><span class="op" id="1541757">(</span><span class="ident" id="1541758">k</span><span class="op" id="1541759">)</span><span class="op" id="1541760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541770">if</span>&nbsp;<span class="ident" id="1541773">alg</span><span class="op" id="1541776">.</span><span class="ident" id="1541777">equal</span><span class="op" id="1541782">(</span><span class="ident" id="1541783">key</span><span class="op" id="1541786">,</span>&nbsp;<span class="ident" id="1541788">k</span><span class="op" id="1541789">,</span>&nbsp;<span class="builtintype" id="1541791">uintptr</span><span class="op" id="1541798">(</span><span class="ident" id="1541799">t</span><span class="op" id="1541800">.</span><span class="ident" id="1541801">key</span><span class="op" id="1541804">.</span><span class="ident" id="1541805">size</span><span class="op" id="1541809">)</span><span class="op" id="1541810">)</span>&nbsp;<span class="op" id="1541812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541818">v</span>&nbsp;<span class="op" id="1541820">:=</span>&nbsp;<span class="ident" id="1541823">add</span><span class="op" id="1541826">(</span><span class="ident" id="1541827">unsafe</span><span class="op" id="1541833">.</span><span class="ident" id="1541834">Pointer</span><span class="op" id="1541841">(</span><span class="ident" id="1541842">b</span><span class="op" id="1541843">)</span><span class="op" id="1541844">,</span>&nbsp;<span class="ident" id="1541846">dataOffset</span><span class="op" id="1541856">+</span><span class="ident" id="1541857">bucketCnt</span><span class="op" id="1541866">*</span><span class="builtintype" id="1541867">uintptr</span><span class="op" id="1541874">(</span><span class="ident" id="1541875">t</span><span class="op" id="1541876">.</span><span class="ident" id="1541877">keysize</span><span class="op" id="1541884">)</span><span class="op" id="1541885">+</span><span class="ident" id="1541886">i</span><span class="op" id="1541887">*</span><span class="builtintype" id="1541888">uintptr</span><span class="op" id="1541895">(</span><span class="ident" id="1541896">t</span><span class="op" id="1541897">.</span><span class="ident" id="1541898">valuesize</span><span class="op" id="1541907">)</span><span class="op" id="1541908">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541914">if</span>&nbsp;<span class="ident" id="1541917">t</span><span class="op" id="1541918">.</span><span class="ident" id="1541919">indirectvalue</span>&nbsp;<span class="op" id="1541933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541940">v</span>&nbsp;<span class="op" id="1541942">=</span>&nbsp;<span class="op" id="1541944">*</span><span class="op" id="1541945">(</span><span class="op" id="1541946">(</span><span class="op" id="1541947">*</span><span class="ident" id="1541948">unsafe</span><span class="op" id="1541954">.</span><span class="ident" id="1541955">Pointer</span><span class="op" id="1541962">)</span><span class="op" id="1541963">(</span><span class="ident" id="1541964">v</span><span class="op" id="1541965">)</span><span class="op" id="1541966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541978">return</span>&nbsp;<span class="ident" id="1541985">v</span><span class="op" id="1541986">,</span>&nbsp;<span class="builtintype" id="1541988">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541996">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542004">b</span>&nbsp;<span class="op" id="1542006">=</span>&nbsp;<span class="ident" id="1542008">b</span><span class="op" id="1542009">.</span><span class="ident" id="1542010">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542021">if</span>&nbsp;<span class="ident" id="1542024">b</span>&nbsp;<span class="op" id="1542026">==</span>&nbsp;<span class="ident" id="1542029">nil</span>&nbsp;<span class="op" id="1542033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542038">return</span>&nbsp;<span class="ident" id="1542045">unsafe</span><span class="op" id="1542051">.</span><span class="ident" id="1542052">Pointer</span><span class="op" id="1542059">(</span><span class="ident" id="1542060">t</span><span class="op" id="1542061">.</span><span class="ident" id="1542062">elem</span><span class="op" id="1542066">.</span><span class="ident" id="1542067">zero</span><span class="op" id="1542071">)</span><span class="op" id="1542072">,</span>&nbsp;<span class="builtintype" id="1542074">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542082">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542085">}</span><br>
<span class="lineno"></span><span class="op" id="1542087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1542090">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1542143">func</span>&nbsp;<span class="ident" id="1542148">mapaccessK</span><span class="op" id="1542158">(</span><span class="ident" id="1542159">t</span>&nbsp;<span class="op" id="1542161">*</span><span class="ident" id="1542162">maptype</span><span class="op" id="1542169">,</span>&nbsp;<span class="ident" id="1542171">h</span>&nbsp;<span class="op" id="1542173">*</span><span class="ident" id="1542174">hmap</span><span class="op" id="1542178">,</span>&nbsp;<span class="ident" id="1542180">key</span>&nbsp;<span class="ident" id="1542184">unsafe</span><span class="op" id="1542190">.</span><span class="ident" id="1542191">Pointer</span><span class="op" id="1542198">)</span>&nbsp;<span class="op" id="1542200">(</span><span class="ident" id="1542201">unsafe</span><span class="op" id="1542207">.</span><span class="ident" id="1542208">Pointer</span><span class="op" id="1542215">,</span>&nbsp;<span class="ident" id="1542217">unsafe</span><span class="op" id="1542223">.</span><span class="ident" id="1542224">Pointer</span><span class="op" id="1542231">)</span>&nbsp;<span class="op" id="1542233">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542236">if</span>&nbsp;<span class="ident" id="1542239">h</span>&nbsp;<span class="op" id="1542241">==</span>&nbsp;<span class="ident" id="1542244">nil</span>&nbsp;<span class="op" id="1542248">||</span>&nbsp;<span class="ident" id="1542251">h</span><span class="op" id="1542252">.</span><span class="ident" id="1542253">count</span>&nbsp;<span class="op" id="1542259">==</span>&nbsp;<span class="num" id="1542262">0</span>&nbsp;<span class="op" id="1542264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542268">return</span>&nbsp;<span class="ident" id="1542275">nil</span><span class="op" id="1542278">,</span>&nbsp;<span class="ident" id="1542280">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542288">alg</span>&nbsp;<span class="op" id="1542292">:=</span>&nbsp;<span class="ident" id="1542295">goalg</span><span class="op" id="1542300">(</span><span class="ident" id="1542301">t</span><span class="op" id="1542302">.</span><span class="ident" id="1542303">key</span><span class="op" id="1542306">.</span><span class="ident" id="1542307">alg</span><span class="op" id="1542310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542313">hash</span>&nbsp;<span class="op" id="1542318">:=</span>&nbsp;<span class="ident" id="1542321">alg</span><span class="op" id="1542324">.</span><span class="ident" id="1542325">hash</span><span class="op" id="1542329">(</span><span class="ident" id="1542330">key</span><span class="op" id="1542333">,</span>&nbsp;<span class="builtintype" id="1542335">uintptr</span><span class="op" id="1542342">(</span><span class="ident" id="1542343">t</span><span class="op" id="1542344">.</span><span class="ident" id="1542345">key</span><span class="op" id="1542348">.</span><span class="ident" id="1542349">size</span><span class="op" id="1542353">)</span><span class="op" id="1542354">,</span>&nbsp;<span class="builtintype" id="1542356">uintptr</span><span class="op" id="1542363">(</span><span class="ident" id="1542364">h</span><span class="op" id="1542365">.</span><span class="ident" id="1542366">hash0</span><span class="op" id="1542371">)</span><span class="op" id="1542372">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542375">m</span>&nbsp;<span class="op" id="1542377">:=</span>&nbsp;<span class="builtintype" id="1542380">uintptr</span><span class="op" id="1542387">(</span><span class="num" id="1542388">1</span><span class="op" id="1542389">)</span><span class="op" id="1542390">&lt;&lt;</span><span class="ident" id="1542392">h</span><span class="op" id="1542393">.</span><span class="ident" id="1542394">B</span>&nbsp;<span class="op" id="1542396">-</span>&nbsp;<span class="num" id="1542398">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542401">b</span>&nbsp;<span class="op" id="1542403">:=</span>&nbsp;<span class="op" id="1542406">(</span><span class="op" id="1542407">*</span><span class="ident" id="1542408">bmap</span><span class="op" id="1542412">)</span><span class="op" id="1542413">(</span><span class="ident" id="1542414">unsafe</span><span class="op" id="1542420">.</span><span class="ident" id="1542421">Pointer</span><span class="op" id="1542428">(</span><span class="builtintype" id="1542429">uintptr</span><span class="op" id="1542436">(</span><span class="ident" id="1542437">h</span><span class="op" id="1542438">.</span><span class="ident" id="1542439">buckets</span><span class="op" id="1542446">)</span>&nbsp;<span class="op" id="1542448">+</span>&nbsp;<span class="op" id="1542450">(</span><span class="ident" id="1542451">hash</span><span class="op" id="1542455">&amp;</span><span class="ident" id="1542456">m</span><span class="op" id="1542457">)</span><span class="op" id="1542458">*</span><span class="builtintype" id="1542459">uintptr</span><span class="op" id="1542466">(</span><span class="ident" id="1542467">t</span><span class="op" id="1542468">.</span><span class="ident" id="1542469">bucketsize</span><span class="op" id="1542479">)</span><span class="op" id="1542480">)</span><span class="op" id="1542481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542484">if</span>&nbsp;<span class="ident" id="1542487">c</span>&nbsp;<span class="op" id="1542489">:=</span>&nbsp;<span class="ident" id="1542492">h</span><span class="op" id="1542493">.</span><span class="ident" id="1542494">oldbuckets</span><span class="op" id="1542504">;</span>&nbsp;<span class="ident" id="1542506">c</span>&nbsp;<span class="op" id="1542508">!=</span>&nbsp;<span class="ident" id="1542511">nil</span>&nbsp;<span class="op" id="1542515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542519">oldb</span>&nbsp;<span class="op" id="1542524">:=</span>&nbsp;<span class="op" id="1542527">(</span><span class="op" id="1542528">*</span><span class="ident" id="1542529">bmap</span><span class="op" id="1542533">)</span><span class="op" id="1542534">(</span><span class="ident" id="1542535">unsafe</span><span class="op" id="1542541">.</span><span class="ident" id="1542542">Pointer</span><span class="op" id="1542549">(</span><span class="builtintype" id="1542550">uintptr</span><span class="op" id="1542557">(</span><span class="ident" id="1542558">c</span><span class="op" id="1542559">)</span>&nbsp;<span class="op" id="1542561">+</span>&nbsp;<span class="op" id="1542563">(</span><span class="ident" id="1542564">hash</span><span class="op" id="1542568">&amp;</span><span class="op" id="1542569">(</span><span class="ident" id="1542570">m</span><span class="op" id="1542571">&gt;&gt;</span><span class="num" id="1542573">1</span><span class="op" id="1542574">)</span><span class="op" id="1542575">)</span><span class="op" id="1542576">*</span><span class="builtintype" id="1542577">uintptr</span><span class="op" id="1542584">(</span><span class="ident" id="1542585">t</span><span class="op" id="1542586">.</span><span class="ident" id="1542587">bucketsize</span><span class="op" id="1542597">)</span><span class="op" id="1542598">)</span><span class="op" id="1542599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542603">if</span>&nbsp;<span class="op" id="1542606">!</span><span class="ident" id="1542607">evacuated</span><span class="op" id="1542616">(</span><span class="ident" id="1542617">oldb</span><span class="op" id="1542621">)</span>&nbsp;<span class="op" id="1542623">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542628">b</span>&nbsp;<span class="op" id="1542630">=</span>&nbsp;<span class="ident" id="1542632">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542645">top</span>&nbsp;<span class="op" id="1542649">:=</span>&nbsp;<span class="builtintype" id="1542652">uint8</span><span class="op" id="1542657">(</span><span class="ident" id="1542658">hash</span>&nbsp;<span class="op" id="1542663">&gt;&gt;</span>&nbsp;<span class="op" id="1542666">(</span><span class="ident" id="1542667">ptrSize</span><span class="op" id="1542674">*</span><span class="num" id="1542675">8</span>&nbsp;<span class="op" id="1542677">-</span>&nbsp;<span class="num" id="1542679">8</span><span class="op" id="1542680">)</span><span class="op" id="1542681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542684">if</span>&nbsp;<span class="ident" id="1542687">top</span>&nbsp;<span class="op" id="1542691">&lt;</span>&nbsp;<span class="ident" id="1542693">minTopHash</span>&nbsp;<span class="op" id="1542704">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542708">top</span>&nbsp;<span class="op" id="1542712">+=</span>&nbsp;<span class="ident" id="1542715">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542730">for</span>&nbsp;<span class="op" id="1542734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542738">for</span>&nbsp;<span class="ident" id="1542742">i</span>&nbsp;<span class="op" id="1542744">:=</span>&nbsp;<span class="builtintype" id="1542747">uintptr</span><span class="op" id="1542754">(</span><span class="num" id="1542755">0</span><span class="op" id="1542756">)</span><span class="op" id="1542757">;</span>&nbsp;<span class="ident" id="1542759">i</span>&nbsp;<span class="op" id="1542761">&lt;</span>&nbsp;<span class="ident" id="1542763">bucketCnt</span><span class="op" id="1542772">;</span>&nbsp;<span class="ident" id="1542774">i</span><span class="op" id="1542775">++</span>&nbsp;<span class="op" id="1542778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542783">if</span>&nbsp;<span class="ident" id="1542786">b</span><span class="op" id="1542787">.</span><span class="ident" id="1542788">tophash</span><span class="op" id="1542795">[</span><span class="ident" id="1542796">i</span><span class="op" id="1542797">]</span>&nbsp;<span class="op" id="1542799">!=</span>&nbsp;<span class="ident" id="1542802">top</span>&nbsp;<span class="op" id="1542806">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542812">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542829">k</span>&nbsp;<span class="op" id="1542831">:=</span>&nbsp;<span class="ident" id="1542834">add</span><span class="op" id="1542837">(</span><span class="ident" id="1542838">unsafe</span><span class="op" id="1542844">.</span><span class="ident" id="1542845">Pointer</span><span class="op" id="1542852">(</span><span class="ident" id="1542853">b</span><span class="op" id="1542854">)</span><span class="op" id="1542855">,</span>&nbsp;<span class="ident" id="1542857">dataOffset</span><span class="op" id="1542867">+</span><span class="ident" id="1542868">i</span><span class="op" id="1542869">*</span><span class="builtintype" id="1542870">uintptr</span><span class="op" id="1542877">(</span><span class="ident" id="1542878">t</span><span class="op" id="1542879">.</span><span class="ident" id="1542880">keysize</span><span class="op" id="1542887">)</span><span class="op" id="1542888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542893">if</span>&nbsp;<span class="ident" id="1542896">t</span><span class="op" id="1542897">.</span><span class="ident" id="1542898">indirectkey</span>&nbsp;<span class="op" id="1542910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542916">k</span>&nbsp;<span class="op" id="1542918">=</span>&nbsp;<span class="op" id="1542920">*</span><span class="op" id="1542921">(</span><span class="op" id="1542922">(</span><span class="op" id="1542923">*</span><span class="ident" id="1542924">unsafe</span><span class="op" id="1542930">.</span><span class="ident" id="1542931">Pointer</span><span class="op" id="1542938">)</span><span class="op" id="1542939">(</span><span class="ident" id="1542940">k</span><span class="op" id="1542941">)</span><span class="op" id="1542942">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542952">if</span>&nbsp;<span class="ident" id="1542955">alg</span><span class="op" id="1542958">.</span><span class="ident" id="1542959">equal</span><span class="op" id="1542964">(</span><span class="ident" id="1542965">key</span><span class="op" id="1542968">,</span>&nbsp;<span class="ident" id="1542970">k</span><span class="op" id="1542971">,</span>&nbsp;<span class="builtintype" id="1542973">uintptr</span><span class="op" id="1542980">(</span><span class="ident" id="1542981">t</span><span class="op" id="1542982">.</span><span class="ident" id="1542983">key</span><span class="op" id="1542986">.</span><span class="ident" id="1542987">size</span><span class="op" id="1542991">)</span><span class="op" id="1542992">)</span>&nbsp;<span class="op" id="1542994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543000">v</span>&nbsp;<span class="op" id="1543002">:=</span>&nbsp;<span class="ident" id="1543005">add</span><span class="op" id="1543008">(</span><span class="ident" id="1543009">unsafe</span><span class="op" id="1543015">.</span><span class="ident" id="1543016">Pointer</span><span class="op" id="1543023">(</span><span class="ident" id="1543024">b</span><span class="op" id="1543025">)</span><span class="op" id="1543026">,</span>&nbsp;<span class="ident" id="1543028">dataOffset</span><span class="op" id="1543038">+</span><span class="ident" id="1543039">bucketCnt</span><span class="op" id="1543048">*</span><span class="builtintype" id="1543049">uintptr</span><span class="op" id="1543056">(</span><span class="ident" id="1543057">t</span><span class="op" id="1543058">.</span><span class="ident" id="1543059">keysize</span><span class="op" id="1543066">)</span><span class="op" id="1543067">+</span><span class="ident" id="1543068">i</span><span class="op" id="1543069">*</span><span class="builtintype" id="1543070">uintptr</span><span class="op" id="1543077">(</span><span class="ident" id="1543078">t</span><span class="op" id="1543079">.</span><span class="ident" id="1543080">valuesize</span><span class="op" id="1543089">)</span><span class="op" id="1543090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543096">if</span>&nbsp;<span class="ident" id="1543099">t</span><span class="op" id="1543100">.</span><span class="ident" id="1543101">indirectvalue</span>&nbsp;<span class="op" id="1543115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543122">v</span>&nbsp;<span class="op" id="1543124">=</span>&nbsp;<span class="op" id="1543126">*</span><span class="op" id="1543127">(</span><span class="op" id="1543128">(</span><span class="op" id="1543129">*</span><span class="ident" id="1543130">unsafe</span><span class="op" id="1543136">.</span><span class="ident" id="1543137">Pointer</span><span class="op" id="1543144">)</span><span class="op" id="1543145">(</span><span class="ident" id="1543146">v</span><span class="op" id="1543147">)</span><span class="op" id="1543148">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543160">return</span>&nbsp;<span class="ident" id="1543167">k</span><span class="op" id="1543168">,</span>&nbsp;<span class="ident" id="1543170">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543183">b</span>&nbsp;<span class="op" id="1543185">=</span>&nbsp;<span class="ident" id="1543187">b</span><span class="op" id="1543188">.</span><span class="ident" id="1543189">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543200">if</span>&nbsp;<span class="ident" id="1543203">b</span>&nbsp;<span class="op" id="1543205">==</span>&nbsp;<span class="ident" id="1543208">nil</span>&nbsp;<span class="op" id="1543212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543217">return</span>&nbsp;<span class="ident" id="1543224">nil</span><span class="op" id="1543227">,</span>&nbsp;<span class="ident" id="1543229">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543238">}</span><br>
<span class="lineno"></span><span class="op" id="1543240">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1543243">func</span>&nbsp;<span class="ident" id="1543248">mapassign1</span><span class="op" id="1543258">(</span><span class="ident" id="1543259">t</span>&nbsp;<span class="op" id="1543261">*</span><span class="ident" id="1543262">maptype</span><span class="op" id="1543269">,</span>&nbsp;<span class="ident" id="1543271">h</span>&nbsp;<span class="op" id="1543273">*</span><span class="ident" id="1543274">hmap</span><span class="op" id="1543278">,</span>&nbsp;<span class="ident" id="1543280">key</span>&nbsp;<span class="ident" id="1543284">unsafe</span><span class="op" id="1543290">.</span><span class="ident" id="1543291">Pointer</span><span class="op" id="1543298">,</span>&nbsp;<span class="ident" id="1543300">val</span>&nbsp;<span class="ident" id="1543304">unsafe</span><span class="op" id="1543310">.</span><span class="ident" id="1543311">Pointer</span><span class="op" id="1543318">)</span>&nbsp;<span class="op" id="1543320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543323">if</span>&nbsp;<span class="ident" id="1543326">h</span>&nbsp;<span class="op" id="1543328">==</span>&nbsp;<span class="ident" id="1543331">nil</span>&nbsp;<span class="op" id="1543335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1543339">panic</span><span class="op" id="1543344">(</span><span class="string" id="1543345">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1543377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543380">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543383">if</span>&nbsp;<span class="ident" id="1543386">raceenabled</span>&nbsp;<span class="op" id="1543398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543402">callerpc</span>&nbsp;<span class="op" id="1543411">:=</span>&nbsp;<span class="ident" id="1543414">getcallerpc</span><span class="op" id="1543425">(</span><span class="ident" id="1543426">unsafe</span><span class="op" id="1543432">.</span><span class="ident" id="1543433">Pointer</span><span class="op" id="1543440">(</span><span class="op" id="1543441">&amp;</span><span class="ident" id="1543442">t</span><span class="op" id="1543443">)</span><span class="op" id="1543444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543448">pc</span>&nbsp;<span class="op" id="1543451">:=</span>&nbsp;<span class="ident" id="1543454">funcPC</span><span class="op" id="1543460">(</span><span class="ident" id="1543461">mapassign1</span><span class="op" id="1543471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543475">racewritepc</span><span class="op" id="1543486">(</span><span class="ident" id="1543487">unsafe</span><span class="op" id="1543493">.</span><span class="ident" id="1543494">Pointer</span><span class="op" id="1543501">(</span><span class="ident" id="1543502">h</span><span class="op" id="1543503">)</span><span class="op" id="1543504">,</span>&nbsp;<span class="ident" id="1543506">callerpc</span><span class="op" id="1543514">,</span>&nbsp;<span class="ident" id="1543516">pc</span><span class="op" id="1543518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543522">raceReadObjectPC</span><span class="op" id="1543538">(</span><span class="ident" id="1543539">t</span><span class="op" id="1543540">.</span><span class="ident" id="1543541">key</span><span class="op" id="1543544">,</span>&nbsp;<span class="ident" id="1543546">key</span><span class="op" id="1543549">,</span>&nbsp;<span class="ident" id="1543551">callerpc</span><span class="op" id="1543559">,</span>&nbsp;<span class="ident" id="1543561">pc</span><span class="op" id="1543563">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543567">raceReadObjectPC</span><span class="op" id="1543583">(</span><span class="ident" id="1543584">t</span><span class="op" id="1543585">.</span><span class="ident" id="1543586">elem</span><span class="op" id="1543590">,</span>&nbsp;<span class="ident" id="1543592">val</span><span class="op" id="1543595">,</span>&nbsp;<span class="ident" id="1543597">callerpc</span><span class="op" id="1543605">,</span>&nbsp;<span class="ident" id="1543607">pc</span><span class="op" id="1543609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543616">alg</span>&nbsp;<span class="op" id="1543620">:=</span>&nbsp;<span class="ident" id="1543623">goalg</span><span class="op" id="1543628">(</span><span class="ident" id="1543629">t</span><span class="op" id="1543630">.</span><span class="ident" id="1543631">key</span><span class="op" id="1543634">.</span><span class="ident" id="1543635">alg</span><span class="op" id="1543638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543641">hash</span>&nbsp;<span class="op" id="1543646">:=</span>&nbsp;<span class="ident" id="1543649">alg</span><span class="op" id="1543652">.</span><span class="ident" id="1543653">hash</span><span class="op" id="1543657">(</span><span class="ident" id="1543658">key</span><span class="op" id="1543661">,</span>&nbsp;<span class="builtintype" id="1543663">uintptr</span><span class="op" id="1543670">(</span><span class="ident" id="1543671">t</span><span class="op" id="1543672">.</span><span class="ident" id="1543673">key</span><span class="op" id="1543676">.</span><span class="ident" id="1543677">size</span><span class="op" id="1543681">)</span><span class="op" id="1543682">,</span>&nbsp;<span class="builtintype" id="1543684">uintptr</span><span class="op" id="1543691">(</span><span class="ident" id="1543692">h</span><span class="op" id="1543693">.</span><span class="ident" id="1543694">hash0</span><span class="op" id="1543699">)</span><span class="op" id="1543700">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543704">if</span>&nbsp;<span class="ident" id="1543707">h</span><span class="op" id="1543708">.</span><span class="ident" id="1543709">buckets</span>&nbsp;<span class="op" id="1543717">==</span>&nbsp;<span class="ident" id="1543720">nil</span>&nbsp;<span class="op" id="1543724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543728">if</span>&nbsp;<span class="ident" id="1543731">checkgc</span>&nbsp;<span class="op" id="1543739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543744">memstats</span><span class="op" id="1543752">.</span><span class="ident" id="1543753">next_gc</span>&nbsp;<span class="op" id="1543761">=</span>&nbsp;<span class="ident" id="1543763">memstats</span><span class="op" id="1543771">.</span><span class="ident" id="1543772">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543785">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543789">h</span><span class="op" id="1543790">.</span><span class="ident" id="1543791">buckets</span>&nbsp;<span class="op" id="1543799">=</span>&nbsp;<span class="ident" id="1543801">newarray</span><span class="op" id="1543809">(</span><span class="ident" id="1543810">t</span><span class="op" id="1543811">.</span><span class="ident" id="1543812">bucket</span><span class="op" id="1543818">,</span>&nbsp;<span class="num" id="1543820">1</span><span class="op" id="1543821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1543827">again</span><span class="op" id="1543832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543835">bucket</span>&nbsp;<span class="op" id="1543842">:=</span>&nbsp;<span class="ident" id="1543845">hash</span>&nbsp;<span class="op" id="1543850">&amp;</span>&nbsp;<span class="op" id="1543852">(</span><span class="builtintype" id="1543853">uintptr</span><span class="op" id="1543860">(</span><span class="num" id="1543861">1</span><span class="op" id="1543862">)</span><span class="op" id="1543863">&lt;&lt;</span><span class="ident" id="1543865">h</span><span class="op" id="1543866">.</span><span class="ident" id="1543867">B</span>&nbsp;<span class="op" id="1543869">-</span>&nbsp;<span class="num" id="1543871">1</span><span class="op" id="1543872">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543875">if</span>&nbsp;<span class="ident" id="1543878">h</span><span class="op" id="1543879">.</span><span class="ident" id="1543880">oldbuckets</span>&nbsp;<span class="op" id="1543891">!=</span>&nbsp;<span class="ident" id="1543894">nil</span>&nbsp;<span class="op" id="1543898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543902">growWork</span><span class="op" id="1543910">(</span><span class="ident" id="1543911">t</span><span class="op" id="1543912">,</span>&nbsp;<span class="ident" id="1543914">h</span><span class="op" id="1543915">,</span>&nbsp;<span class="ident" id="1543917">bucket</span><span class="op" id="1543923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543929">b</span>&nbsp;<span class="op" id="1543931">:=</span>&nbsp;<span class="op" id="1543934">(</span><span class="op" id="1543935">*</span><span class="ident" id="1543936">bmap</span><span class="op" id="1543940">)</span><span class="op" id="1543941">(</span><span class="ident" id="1543942">unsafe</span><span class="op" id="1543948">.</span><span class="ident" id="1543949">Pointer</span><span class="op" id="1543956">(</span><span class="builtintype" id="1543957">uintptr</span><span class="op" id="1543964">(</span><span class="ident" id="1543965">h</span><span class="op" id="1543966">.</span><span class="ident" id="1543967">buckets</span><span class="op" id="1543974">)</span>&nbsp;<span class="op" id="1543976">+</span>&nbsp;<span class="ident" id="1543978">bucket</span><span class="op" id="1543984">*</span><span class="builtintype" id="1543985">uintptr</span><span class="op" id="1543992">(</span><span class="ident" id="1543993">t</span><span class="op" id="1543994">.</span><span class="ident" id="1543995">bucketsize</span><span class="op" id="1544005">)</span><span class="op" id="1544006">)</span><span class="op" id="1544007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544010">top</span>&nbsp;<span class="op" id="1544014">:=</span>&nbsp;<span class="builtintype" id="1544017">uint8</span><span class="op" id="1544022">(</span><span class="ident" id="1544023">hash</span>&nbsp;<span class="op" id="1544028">&gt;&gt;</span>&nbsp;<span class="op" id="1544031">(</span><span class="ident" id="1544032">ptrSize</span><span class="op" id="1544039">*</span><span class="num" id="1544040">8</span>&nbsp;<span class="op" id="1544042">-</span>&nbsp;<span class="num" id="1544044">8</span><span class="op" id="1544045">)</span><span class="op" id="1544046">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544049">if</span>&nbsp;<span class="ident" id="1544052">top</span>&nbsp;<span class="op" id="1544056">&lt;</span>&nbsp;<span class="ident" id="1544058">minTopHash</span>&nbsp;<span class="op" id="1544069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544073">top</span>&nbsp;<span class="op" id="1544077">+=</span>&nbsp;<span class="ident" id="1544080">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544096">var</span>&nbsp;<span class="ident" id="1544100">inserti</span>&nbsp;<span class="op" id="1544108">*</span><span class="builtintype" id="1544109">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544116">var</span>&nbsp;<span class="ident" id="1544120">insertk</span>&nbsp;<span class="ident" id="1544128">unsafe</span><span class="op" id="1544134">.</span><span class="ident" id="1544135">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544144">var</span>&nbsp;<span class="ident" id="1544148">insertv</span>&nbsp;<span class="ident" id="1544156">unsafe</span><span class="op" id="1544162">.</span><span class="ident" id="1544163">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544172">for</span>&nbsp;<span class="op" id="1544176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544180">for</span>&nbsp;<span class="ident" id="1544184">i</span>&nbsp;<span class="op" id="1544186">:=</span>&nbsp;<span class="builtintype" id="1544189">uintptr</span><span class="op" id="1544196">(</span><span class="num" id="1544197">0</span><span class="op" id="1544198">)</span><span class="op" id="1544199">;</span>&nbsp;<span class="ident" id="1544201">i</span>&nbsp;<span class="op" id="1544203">&lt;</span>&nbsp;<span class="ident" id="1544205">bucketCnt</span><span class="op" id="1544214">;</span>&nbsp;<span class="ident" id="1544216">i</span><span class="op" id="1544217">++</span>&nbsp;<span class="op" id="1544220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544225">if</span>&nbsp;<span class="ident" id="1544228">b</span><span class="op" id="1544229">.</span><span class="ident" id="1544230">tophash</span><span class="op" id="1544237">[</span><span class="ident" id="1544238">i</span><span class="op" id="1544239">]</span>&nbsp;<span class="op" id="1544241">!=</span>&nbsp;<span class="ident" id="1544244">top</span>&nbsp;<span class="op" id="1544248">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544254">if</span>&nbsp;<span class="ident" id="1544257">b</span><span class="op" id="1544258">.</span><span class="ident" id="1544259">tophash</span><span class="op" id="1544266">[</span><span class="ident" id="1544267">i</span><span class="op" id="1544268">]</span>&nbsp;<span class="op" id="1544270">==</span>&nbsp;<span class="ident" id="1544273">empty</span>&nbsp;<span class="op" id="1544279">&amp;&amp;</span>&nbsp;<span class="ident" id="1544282">inserti</span>&nbsp;<span class="op" id="1544290">==</span>&nbsp;<span class="ident" id="1544293">nil</span>&nbsp;<span class="op" id="1544297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544304">inserti</span>&nbsp;<span class="op" id="1544312">=</span>&nbsp;<span class="op" id="1544314">&amp;</span><span class="ident" id="1544315">b</span><span class="op" id="1544316">.</span><span class="ident" id="1544317">tophash</span><span class="op" id="1544324">[</span><span class="ident" id="1544325">i</span><span class="op" id="1544326">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544333">insertk</span>&nbsp;<span class="op" id="1544341">=</span>&nbsp;<span class="ident" id="1544343">add</span><span class="op" id="1544346">(</span><span class="ident" id="1544347">unsafe</span><span class="op" id="1544353">.</span><span class="ident" id="1544354">Pointer</span><span class="op" id="1544361">(</span><span class="ident" id="1544362">b</span><span class="op" id="1544363">)</span><span class="op" id="1544364">,</span>&nbsp;<span class="ident" id="1544366">dataOffset</span><span class="op" id="1544376">+</span><span class="ident" id="1544377">i</span><span class="op" id="1544378">*</span><span class="builtintype" id="1544379">uintptr</span><span class="op" id="1544386">(</span><span class="ident" id="1544387">t</span><span class="op" id="1544388">.</span><span class="ident" id="1544389">keysize</span><span class="op" id="1544396">)</span><span class="op" id="1544397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544404">insertv</span>&nbsp;<span class="op" id="1544412">=</span>&nbsp;<span class="ident" id="1544414">add</span><span class="op" id="1544417">(</span><span class="ident" id="1544418">unsafe</span><span class="op" id="1544424">.</span><span class="ident" id="1544425">Pointer</span><span class="op" id="1544432">(</span><span class="ident" id="1544433">b</span><span class="op" id="1544434">)</span><span class="op" id="1544435">,</span>&nbsp;<span class="ident" id="1544437">dataOffset</span><span class="op" id="1544447">+</span><span class="ident" id="1544448">bucketCnt</span><span class="op" id="1544457">*</span><span class="builtintype" id="1544458">uintptr</span><span class="op" id="1544465">(</span><span class="ident" id="1544466">t</span><span class="op" id="1544467">.</span><span class="ident" id="1544468">keysize</span><span class="op" id="1544475">)</span><span class="op" id="1544476">+</span><span class="ident" id="1544477">i</span><span class="op" id="1544478">*</span><span class="builtintype" id="1544479">uintptr</span><span class="op" id="1544486">(</span><span class="ident" id="1544487">t</span><span class="op" id="1544488">.</span><span class="ident" id="1544489">valuesize</span><span class="op" id="1544498">)</span><span class="op" id="1544499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544505">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544511">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544528">k</span>&nbsp;<span class="op" id="1544530">:=</span>&nbsp;<span class="ident" id="1544533">add</span><span class="op" id="1544536">(</span><span class="ident" id="1544537">unsafe</span><span class="op" id="1544543">.</span><span class="ident" id="1544544">Pointer</span><span class="op" id="1544551">(</span><span class="ident" id="1544552">b</span><span class="op" id="1544553">)</span><span class="op" id="1544554">,</span>&nbsp;<span class="ident" id="1544556">dataOffset</span><span class="op" id="1544566">+</span><span class="ident" id="1544567">i</span><span class="op" id="1544568">*</span><span class="builtintype" id="1544569">uintptr</span><span class="op" id="1544576">(</span><span class="ident" id="1544577">t</span><span class="op" id="1544578">.</span><span class="ident" id="1544579">keysize</span><span class="op" id="1544586">)</span><span class="op" id="1544587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544592">k2</span>&nbsp;<span class="op" id="1544595">:=</span>&nbsp;<span class="ident" id="1544598">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544603">if</span>&nbsp;<span class="ident" id="1544606">t</span><span class="op" id="1544607">.</span><span class="ident" id="1544608">indirectkey</span>&nbsp;<span class="op" id="1544620">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544626">k2</span>&nbsp;<span class="op" id="1544629">=</span>&nbsp;<span class="op" id="1544631">*</span><span class="op" id="1544632">(</span><span class="op" id="1544633">(</span><span class="op" id="1544634">*</span><span class="ident" id="1544635">unsafe</span><span class="op" id="1544641">.</span><span class="ident" id="1544642">Pointer</span><span class="op" id="1544649">)</span><span class="op" id="1544650">(</span><span class="ident" id="1544651">k2</span><span class="op" id="1544653">)</span><span class="op" id="1544654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544664">if</span>&nbsp;<span class="op" id="1544667">!</span><span class="ident" id="1544668">alg</span><span class="op" id="1544671">.</span><span class="ident" id="1544672">equal</span><span class="op" id="1544677">(</span><span class="ident" id="1544678">key</span><span class="op" id="1544681">,</span>&nbsp;<span class="ident" id="1544683">k2</span><span class="op" id="1544685">,</span>&nbsp;<span class="builtintype" id="1544687">uintptr</span><span class="op" id="1544694">(</span><span class="ident" id="1544695">t</span><span class="op" id="1544696">.</span><span class="ident" id="1544697">key</span><span class="op" id="1544700">.</span><span class="ident" id="1544701">size</span><span class="op" id="1544705">)</span><span class="op" id="1544706">)</span>&nbsp;<span class="op" id="1544708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544714">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544726">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544731">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544781">memmove</span><span class="op" id="1544788">(</span><span class="ident" id="1544789">k2</span><span class="op" id="1544791">,</span>&nbsp;<span class="ident" id="1544793">key</span><span class="op" id="1544796">,</span>&nbsp;<span class="builtintype" id="1544798">uintptr</span><span class="op" id="1544805">(</span><span class="ident" id="1544806">t</span><span class="op" id="1544807">.</span><span class="ident" id="1544808">key</span><span class="op" id="1544811">.</span><span class="ident" id="1544812">size</span><span class="op" id="1544816">)</span><span class="op" id="1544817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544822">v</span>&nbsp;<span class="op" id="1544824">:=</span>&nbsp;<span class="ident" id="1544827">add</span><span class="op" id="1544830">(</span><span class="ident" id="1544831">unsafe</span><span class="op" id="1544837">.</span><span class="ident" id="1544838">Pointer</span><span class="op" id="1544845">(</span><span class="ident" id="1544846">b</span><span class="op" id="1544847">)</span><span class="op" id="1544848">,</span>&nbsp;<span class="ident" id="1544850">dataOffset</span><span class="op" id="1544860">+</span><span class="ident" id="1544861">bucketCnt</span><span class="op" id="1544870">*</span><span class="builtintype" id="1544871">uintptr</span><span class="op" id="1544878">(</span><span class="ident" id="1544879">t</span><span class="op" id="1544880">.</span><span class="ident" id="1544881">keysize</span><span class="op" id="1544888">)</span><span class="op" id="1544889">+</span><span class="ident" id="1544890">i</span><span class="op" id="1544891">*</span><span class="builtintype" id="1544892">uintptr</span><span class="op" id="1544899">(</span><span class="ident" id="1544900">t</span><span class="op" id="1544901">.</span><span class="ident" id="1544902">valuesize</span><span class="op" id="1544911">)</span><span class="op" id="1544912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544917">v2</span>&nbsp;<span class="op" id="1544920">:=</span>&nbsp;<span class="ident" id="1544923">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544928">if</span>&nbsp;<span class="ident" id="1544931">t</span><span class="op" id="1544932">.</span><span class="ident" id="1544933">indirectvalue</span>&nbsp;<span class="op" id="1544947">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544953">v2</span>&nbsp;<span class="op" id="1544956">=</span>&nbsp;<span class="op" id="1544958">*</span><span class="op" id="1544959">(</span><span class="op" id="1544960">(</span><span class="op" id="1544961">*</span><span class="ident" id="1544962">unsafe</span><span class="op" id="1544968">.</span><span class="ident" id="1544969">Pointer</span><span class="op" id="1544976">)</span><span class="op" id="1544977">(</span><span class="ident" id="1544978">v2</span><span class="op" id="1544980">)</span><span class="op" id="1544981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544991">memmove</span><span class="op" id="1544998">(</span><span class="ident" id="1544999">v2</span><span class="op" id="1545001">,</span>&nbsp;<span class="ident" id="1545003">val</span><span class="op" id="1545006">,</span>&nbsp;<span class="builtintype" id="1545008">uintptr</span><span class="op" id="1545015">(</span><span class="ident" id="1545016">t</span><span class="op" id="1545017">.</span><span class="ident" id="1545018">elem</span><span class="op" id="1545022">.</span><span class="ident" id="1545023">size</span><span class="op" id="1545027">)</span><span class="op" id="1545028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545033">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545042">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545046">if</span>&nbsp;<span class="ident" id="1545049">b</span><span class="op" id="1545050">.</span><span class="ident" id="1545051">overflow</span>&nbsp;<span class="op" id="1545060">==</span>&nbsp;<span class="ident" id="1545063">nil</span>&nbsp;<span class="op" id="1545067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545072">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545084">b</span>&nbsp;<span class="op" id="1545086">=</span>&nbsp;<span class="ident" id="1545088">b</span><span class="op" id="1545089">.</span><span class="ident" id="1545090">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545100">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545104">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545170">if</span>&nbsp;<span class="builtintype" id="1545173">float32</span><span class="op" id="1545180">(</span><span class="ident" id="1545181">h</span><span class="op" id="1545182">.</span><span class="ident" id="1545183">count</span><span class="op" id="1545188">)</span>&nbsp;<span class="op" id="1545190">&gt;=</span>&nbsp;<span class="ident" id="1545193">loadFactor</span><span class="op" id="1545203">*</span><span class="builtintype" id="1545204">float32</span><span class="op" id="1545211">(</span><span class="op" id="1545212">(</span><span class="builtintype" id="1545213">uintptr</span><span class="op" id="1545220">(</span><span class="num" id="1545221">1</span><span class="op" id="1545222">)</span><span class="op" id="1545223">&lt;&lt;</span><span class="ident" id="1545225">h</span><span class="op" id="1545226">.</span><span class="ident" id="1545227">B</span><span class="op" id="1545228">)</span><span class="op" id="1545229">)</span>&nbsp;<span class="op" id="1545231">&amp;&amp;</span>&nbsp;<span class="ident" id="1545234">h</span><span class="op" id="1545235">.</span><span class="ident" id="1545236">count</span>&nbsp;<span class="op" id="1545242">&gt;=</span>&nbsp;<span class="ident" id="1545245">bucketCnt</span>&nbsp;<span class="op" id="1545255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545259">hashGrow</span><span class="op" id="1545267">(</span><span class="ident" id="1545268">t</span><span class="op" id="1545269">,</span>&nbsp;<span class="ident" id="1545271">h</span><span class="op" id="1545272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545276">goto</span>&nbsp;<span class="ident" id="1545281">again</span>&nbsp;<span class="comment" id="1545287">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545350">if</span>&nbsp;<span class="ident" id="1545353">inserti</span>&nbsp;<span class="op" id="1545361">==</span>&nbsp;<span class="ident" id="1545364">nil</span>&nbsp;<span class="op" id="1545368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545372">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545427">if</span>&nbsp;<span class="ident" id="1545430">checkgc</span>&nbsp;<span class="op" id="1545438">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545443">memstats</span><span class="op" id="1545451">.</span><span class="ident" id="1545452">next_gc</span>&nbsp;<span class="op" id="1545460">=</span>&nbsp;<span class="ident" id="1545462">memstats</span><span class="op" id="1545470">.</span><span class="ident" id="1545471">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545488">newb</span>&nbsp;<span class="op" id="1545493">:=</span>&nbsp;<span class="op" id="1545496">(</span><span class="op" id="1545497">*</span><span class="ident" id="1545498">bmap</span><span class="op" id="1545502">)</span><span class="op" id="1545503">(</span><span class="ident" id="1545504">newobject</span><span class="op" id="1545513">(</span><span class="ident" id="1545514">t</span><span class="op" id="1545515">.</span><span class="ident" id="1545516">bucket</span><span class="op" id="1545522">)</span><span class="op" id="1545523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545527">b</span><span class="op" id="1545528">.</span><span class="ident" id="1545529">overflow</span>&nbsp;<span class="op" id="1545538">=</span>&nbsp;<span class="ident" id="1545540">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545547">inserti</span>&nbsp;<span class="op" id="1545555">=</span>&nbsp;<span class="op" id="1545557">&amp;</span><span class="ident" id="1545558">newb</span><span class="op" id="1545562">.</span><span class="ident" id="1545563">tophash</span><span class="op" id="1545570">[</span><span class="num" id="1545571">0</span><span class="op" id="1545572">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545576">insertk</span>&nbsp;<span class="op" id="1545584">=</span>&nbsp;<span class="ident" id="1545586">add</span><span class="op" id="1545589">(</span><span class="ident" id="1545590">unsafe</span><span class="op" id="1545596">.</span><span class="ident" id="1545597">Pointer</span><span class="op" id="1545604">(</span><span class="ident" id="1545605">newb</span><span class="op" id="1545609">)</span><span class="op" id="1545610">,</span>&nbsp;<span class="ident" id="1545612">dataOffset</span><span class="op" id="1545622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545626">insertv</span>&nbsp;<span class="op" id="1545634">=</span>&nbsp;<span class="ident" id="1545636">add</span><span class="op" id="1545639">(</span><span class="ident" id="1545640">insertk</span><span class="op" id="1545647">,</span>&nbsp;<span class="ident" id="1545649">bucketCnt</span><span class="op" id="1545658">*</span><span class="builtintype" id="1545659">uintptr</span><span class="op" id="1545666">(</span><span class="ident" id="1545667">t</span><span class="op" id="1545668">.</span><span class="ident" id="1545669">keysize</span><span class="op" id="1545676">)</span><span class="op" id="1545677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545684">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545727">if</span>&nbsp;<span class="ident" id="1545730">t</span><span class="op" id="1545731">.</span><span class="ident" id="1545732">indirectkey</span>&nbsp;<span class="op" id="1545744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545748">if</span>&nbsp;<span class="ident" id="1545751">checkgc</span>&nbsp;<span class="op" id="1545759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545764">memstats</span><span class="op" id="1545772">.</span><span class="ident" id="1545773">next_gc</span>&nbsp;<span class="op" id="1545781">=</span>&nbsp;<span class="ident" id="1545783">memstats</span><span class="op" id="1545791">.</span><span class="ident" id="1545792">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545809">kmem</span>&nbsp;<span class="op" id="1545814">:=</span>&nbsp;<span class="ident" id="1545817">newobject</span><span class="op" id="1545826">(</span><span class="ident" id="1545827">t</span><span class="op" id="1545828">.</span><span class="ident" id="1545829">key</span><span class="op" id="1545832">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545836">*</span><span class="op" id="1545837">(</span><span class="op" id="1545838">*</span><span class="ident" id="1545839">unsafe</span><span class="op" id="1545845">.</span><span class="ident" id="1545846">Pointer</span><span class="op" id="1545853">)</span><span class="op" id="1545854">(</span><span class="ident" id="1545855">insertk</span><span class="op" id="1545862">)</span>&nbsp;<span class="op" id="1545864">=</span>&nbsp;<span class="ident" id="1545866">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545873">insertk</span>&nbsp;<span class="op" id="1545881">=</span>&nbsp;<span class="ident" id="1545883">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545892">if</span>&nbsp;<span class="ident" id="1545895">t</span><span class="op" id="1545896">.</span><span class="ident" id="1545897">indirectvalue</span>&nbsp;<span class="op" id="1545911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545915">if</span>&nbsp;<span class="ident" id="1545918">checkgc</span>&nbsp;<span class="op" id="1545926">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545931">memstats</span><span class="op" id="1545939">.</span><span class="ident" id="1545940">next_gc</span>&nbsp;<span class="op" id="1545948">=</span>&nbsp;<span class="ident" id="1545950">memstats</span><span class="op" id="1545958">.</span><span class="ident" id="1545959">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545976">vmem</span>&nbsp;<span class="op" id="1545981">:=</span>&nbsp;<span class="ident" id="1545984">newobject</span><span class="op" id="1545993">(</span><span class="ident" id="1545994">t</span><span class="op" id="1545995">.</span><span class="ident" id="1545996">elem</span><span class="op" id="1546000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546004">*</span><span class="op" id="1546005">(</span><span class="op" id="1546006">*</span><span class="ident" id="1546007">unsafe</span><span class="op" id="1546013">.</span><span class="ident" id="1546014">Pointer</span><span class="op" id="1546021">)</span><span class="op" id="1546022">(</span><span class="ident" id="1546023">insertv</span><span class="op" id="1546030">)</span>&nbsp;<span class="op" id="1546032">=</span>&nbsp;<span class="ident" id="1546034">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546041">insertv</span>&nbsp;<span class="op" id="1546049">=</span>&nbsp;<span class="ident" id="1546051">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546060">memmove</span><span class="op" id="1546067">(</span><span class="ident" id="1546068">insertk</span><span class="op" id="1546075">,</span>&nbsp;<span class="ident" id="1546077">key</span><span class="op" id="1546080">,</span>&nbsp;<span class="builtintype" id="1546082">uintptr</span><span class="op" id="1546089">(</span><span class="ident" id="1546090">t</span><span class="op" id="1546091">.</span><span class="ident" id="1546092">key</span><span class="op" id="1546095">.</span><span class="ident" id="1546096">size</span><span class="op" id="1546100">)</span><span class="op" id="1546101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546104">memmove</span><span class="op" id="1546111">(</span><span class="ident" id="1546112">insertv</span><span class="op" id="1546119">,</span>&nbsp;<span class="ident" id="1546121">val</span><span class="op" id="1546124">,</span>&nbsp;<span class="builtintype" id="1546126">uintptr</span><span class="op" id="1546133">(</span><span class="ident" id="1546134">t</span><span class="op" id="1546135">.</span><span class="ident" id="1546136">elem</span><span class="op" id="1546140">.</span><span class="ident" id="1546141">size</span><span class="op" id="1546145">)</span><span class="op" id="1546146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546149">*</span><span class="ident" id="1546150">inserti</span>&nbsp;<span class="op" id="1546158">=</span>&nbsp;<span class="ident" id="1546160">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546165">h</span><span class="op" id="1546166">.</span><span class="ident" id="1546167">count</span><span class="op" id="1546172">++</span><br>
<span class="lineno">485</span><span class="op" id="1546175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546178">func</span>&nbsp;<span class="ident" id="1546183">mapdelete</span><span class="op" id="1546192">(</span><span class="ident" id="1546193">t</span>&nbsp;<span class="op" id="1546195">*</span><span class="ident" id="1546196">maptype</span><span class="op" id="1546203">,</span>&nbsp;<span class="ident" id="1546205">h</span>&nbsp;<span class="op" id="1546207">*</span><span class="ident" id="1546208">hmap</span><span class="op" id="1546212">,</span>&nbsp;<span class="ident" id="1546214">key</span>&nbsp;<span class="ident" id="1546218">unsafe</span><span class="op" id="1546224">.</span><span class="ident" id="1546225">Pointer</span><span class="op" id="1546232">)</span>&nbsp;<span class="op" id="1546234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546237">if</span>&nbsp;<span class="ident" id="1546240">raceenabled</span>&nbsp;<span class="op" id="1546252">&amp;&amp;</span>&nbsp;<span class="ident" id="1546255">h</span>&nbsp;<span class="op" id="1546257">!=</span>&nbsp;<span class="ident" id="1546260">nil</span>&nbsp;<span class="op" id="1546264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546268">callerpc</span>&nbsp;<span class="op" id="1546277">:=</span>&nbsp;<span class="ident" id="1546280">getcallerpc</span><span class="op" id="1546291">(</span><span class="ident" id="1546292">unsafe</span><span class="op" id="1546298">.</span><span class="ident" id="1546299">Pointer</span><span class="op" id="1546306">(</span><span class="op" id="1546307">&amp;</span><span class="ident" id="1546308">t</span><span class="op" id="1546309">)</span><span class="op" id="1546310">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546314">pc</span>&nbsp;<span class="op" id="1546317">:=</span>&nbsp;<span class="ident" id="1546320">funcPC</span><span class="op" id="1546326">(</span><span class="ident" id="1546327">mapdelete</span><span class="op" id="1546336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546340">racewritepc</span><span class="op" id="1546351">(</span><span class="ident" id="1546352">unsafe</span><span class="op" id="1546358">.</span><span class="ident" id="1546359">Pointer</span><span class="op" id="1546366">(</span><span class="ident" id="1546367">h</span><span class="op" id="1546368">)</span><span class="op" id="1546369">,</span>&nbsp;<span class="ident" id="1546371">callerpc</span><span class="op" id="1546379">,</span>&nbsp;<span class="ident" id="1546381">pc</span><span class="op" id="1546383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546387">raceReadObjectPC</span><span class="op" id="1546403">(</span><span class="ident" id="1546404">t</span><span class="op" id="1546405">.</span><span class="ident" id="1546406">key</span><span class="op" id="1546409">,</span>&nbsp;<span class="ident" id="1546411">key</span><span class="op" id="1546414">,</span>&nbsp;<span class="ident" id="1546416">callerpc</span><span class="op" id="1546424">,</span>&nbsp;<span class="ident" id="1546426">pc</span><span class="op" id="1546428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546434">if</span>&nbsp;<span class="ident" id="1546437">h</span>&nbsp;<span class="op" id="1546439">==</span>&nbsp;<span class="ident" id="1546442">nil</span>&nbsp;<span class="op" id="1546446">||</span>&nbsp;<span class="ident" id="1546449">h</span><span class="op" id="1546450">.</span><span class="ident" id="1546451">count</span>&nbsp;<span class="op" id="1546457">==</span>&nbsp;<span class="num" id="1546460">0</span>&nbsp;<span class="op" id="1546462">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546466">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546477">alg</span>&nbsp;<span class="op" id="1546481">:=</span>&nbsp;<span class="ident" id="1546484">goalg</span><span class="op" id="1546489">(</span><span class="ident" id="1546490">t</span><span class="op" id="1546491">.</span><span class="ident" id="1546492">key</span><span class="op" id="1546495">.</span><span class="ident" id="1546496">alg</span><span class="op" id="1546499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546502">hash</span>&nbsp;<span class="op" id="1546507">:=</span>&nbsp;<span class="ident" id="1546510">alg</span><span class="op" id="1546513">.</span><span class="ident" id="1546514">hash</span><span class="op" id="1546518">(</span><span class="ident" id="1546519">key</span><span class="op" id="1546522">,</span>&nbsp;<span class="builtintype" id="1546524">uintptr</span><span class="op" id="1546531">(</span><span class="ident" id="1546532">t</span><span class="op" id="1546533">.</span><span class="ident" id="1546534">key</span><span class="op" id="1546537">.</span><span class="ident" id="1546538">size</span><span class="op" id="1546542">)</span><span class="op" id="1546543">,</span>&nbsp;<span class="builtintype" id="1546545">uintptr</span><span class="op" id="1546552">(</span><span class="ident" id="1546553">h</span><span class="op" id="1546554">.</span><span class="ident" id="1546555">hash0</span><span class="op" id="1546560">)</span><span class="op" id="1546561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546564">bucket</span>&nbsp;<span class="op" id="1546571">:=</span>&nbsp;<span class="ident" id="1546574">hash</span>&nbsp;<span class="op" id="1546579">&amp;</span>&nbsp;<span class="op" id="1546581">(</span><span class="builtintype" id="1546582">uintptr</span><span class="op" id="1546589">(</span><span class="num" id="1546590">1</span><span class="op" id="1546591">)</span><span class="op" id="1546592">&lt;&lt;</span><span class="ident" id="1546594">h</span><span class="op" id="1546595">.</span><span class="ident" id="1546596">B</span>&nbsp;<span class="op" id="1546598">-</span>&nbsp;<span class="num" id="1546600">1</span><span class="op" id="1546601">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546604">if</span>&nbsp;<span class="ident" id="1546607">h</span><span class="op" id="1546608">.</span><span class="ident" id="1546609">oldbuckets</span>&nbsp;<span class="op" id="1546620">!=</span>&nbsp;<span class="ident" id="1546623">nil</span>&nbsp;<span class="op" id="1546627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546631">growWork</span><span class="op" id="1546639">(</span><span class="ident" id="1546640">t</span><span class="op" id="1546641">,</span>&nbsp;<span class="ident" id="1546643">h</span><span class="op" id="1546644">,</span>&nbsp;<span class="ident" id="1546646">bucket</span><span class="op" id="1546652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546658">b</span>&nbsp;<span class="op" id="1546660">:=</span>&nbsp;<span class="op" id="1546663">(</span><span class="op" id="1546664">*</span><span class="ident" id="1546665">bmap</span><span class="op" id="1546669">)</span><span class="op" id="1546670">(</span><span class="ident" id="1546671">unsafe</span><span class="op" id="1546677">.</span><span class="ident" id="1546678">Pointer</span><span class="op" id="1546685">(</span><span class="builtintype" id="1546686">uintptr</span><span class="op" id="1546693">(</span><span class="ident" id="1546694">h</span><span class="op" id="1546695">.</span><span class="ident" id="1546696">buckets</span><span class="op" id="1546703">)</span>&nbsp;<span class="op" id="1546705">+</span>&nbsp;<span class="ident" id="1546707">bucket</span><span class="op" id="1546713">*</span><span class="builtintype" id="1546714">uintptr</span><span class="op" id="1546721">(</span><span class="ident" id="1546722">t</span><span class="op" id="1546723">.</span><span class="ident" id="1546724">bucketsize</span><span class="op" id="1546734">)</span><span class="op" id="1546735">)</span><span class="op" id="1546736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546739">top</span>&nbsp;<span class="op" id="1546743">:=</span>&nbsp;<span class="builtintype" id="1546746">uint8</span><span class="op" id="1546751">(</span><span class="ident" id="1546752">hash</span>&nbsp;<span class="op" id="1546757">&gt;&gt;</span>&nbsp;<span class="op" id="1546760">(</span><span class="ident" id="1546761">ptrSize</span><span class="op" id="1546768">*</span><span class="num" id="1546769">8</span>&nbsp;<span class="op" id="1546771">-</span>&nbsp;<span class="num" id="1546773">8</span><span class="op" id="1546774">)</span><span class="op" id="1546775">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546778">if</span>&nbsp;<span class="ident" id="1546781">top</span>&nbsp;<span class="op" id="1546785">&lt;</span>&nbsp;<span class="ident" id="1546787">minTopHash</span>&nbsp;<span class="op" id="1546798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546802">top</span>&nbsp;<span class="op" id="1546806">+=</span>&nbsp;<span class="ident" id="1546809">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546824">for</span>&nbsp;<span class="op" id="1546828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546832">for</span>&nbsp;<span class="ident" id="1546836">i</span>&nbsp;<span class="op" id="1546838">:=</span>&nbsp;<span class="builtintype" id="1546841">uintptr</span><span class="op" id="1546848">(</span><span class="num" id="1546849">0</span><span class="op" id="1546850">)</span><span class="op" id="1546851">;</span>&nbsp;<span class="ident" id="1546853">i</span>&nbsp;<span class="op" id="1546855">&lt;</span>&nbsp;<span class="ident" id="1546857">bucketCnt</span><span class="op" id="1546866">;</span>&nbsp;<span class="ident" id="1546868">i</span><span class="op" id="1546869">++</span>&nbsp;<span class="op" id="1546872">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546877">if</span>&nbsp;<span class="ident" id="1546880">b</span><span class="op" id="1546881">.</span><span class="ident" id="1546882">tophash</span><span class="op" id="1546889">[</span><span class="ident" id="1546890">i</span><span class="op" id="1546891">]</span>&nbsp;<span class="op" id="1546893">!=</span>&nbsp;<span class="ident" id="1546896">top</span>&nbsp;<span class="op" id="1546900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546906">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546923">k</span>&nbsp;<span class="op" id="1546925">:=</span>&nbsp;<span class="ident" id="1546928">add</span><span class="op" id="1546931">(</span><span class="ident" id="1546932">unsafe</span><span class="op" id="1546938">.</span><span class="ident" id="1546939">Pointer</span><span class="op" id="1546946">(</span><span class="ident" id="1546947">b</span><span class="op" id="1546948">)</span><span class="op" id="1546949">,</span>&nbsp;<span class="ident" id="1546951">dataOffset</span><span class="op" id="1546961">+</span><span class="ident" id="1546962">i</span><span class="op" id="1546963">*</span><span class="builtintype" id="1546964">uintptr</span><span class="op" id="1546971">(</span><span class="ident" id="1546972">t</span><span class="op" id="1546973">.</span><span class="ident" id="1546974">keysize</span><span class="op" id="1546981">)</span><span class="op" id="1546982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546987">k2</span>&nbsp;<span class="op" id="1546990">:=</span>&nbsp;<span class="ident" id="1546993">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546998">if</span>&nbsp;<span class="ident" id="1547001">t</span><span class="op" id="1547002">.</span><span class="ident" id="1547003">indirectkey</span>&nbsp;<span class="op" id="1547015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547021">k2</span>&nbsp;<span class="op" id="1547024">=</span>&nbsp;<span class="op" id="1547026">*</span><span class="op" id="1547027">(</span><span class="op" id="1547028">(</span><span class="op" id="1547029">*</span><span class="ident" id="1547030">unsafe</span><span class="op" id="1547036">.</span><span class="ident" id="1547037">Pointer</span><span class="op" id="1547044">)</span><span class="op" id="1547045">(</span><span class="ident" id="1547046">k2</span><span class="op" id="1547048">)</span><span class="op" id="1547049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547059">if</span>&nbsp;<span class="op" id="1547062">!</span><span class="ident" id="1547063">alg</span><span class="op" id="1547066">.</span><span class="ident" id="1547067">equal</span><span class="op" id="1547072">(</span><span class="ident" id="1547073">key</span><span class="op" id="1547076">,</span>&nbsp;<span class="ident" id="1547078">k2</span><span class="op" id="1547080">,</span>&nbsp;<span class="builtintype" id="1547082">uintptr</span><span class="op" id="1547089">(</span><span class="ident" id="1547090">t</span><span class="op" id="1547091">.</span><span class="ident" id="1547092">key</span><span class="op" id="1547095">.</span><span class="ident" id="1547096">size</span><span class="op" id="1547100">)</span><span class="op" id="1547101">)</span>&nbsp;<span class="op" id="1547103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547109">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547126">memclr</span><span class="op" id="1547132">(</span><span class="ident" id="1547133">k</span><span class="op" id="1547134">,</span>&nbsp;<span class="builtintype" id="1547136">uintptr</span><span class="op" id="1547143">(</span><span class="ident" id="1547144">t</span><span class="op" id="1547145">.</span><span class="ident" id="1547146">keysize</span><span class="op" id="1547153">)</span><span class="op" id="1547154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547159">v</span>&nbsp;<span class="op" id="1547161">:=</span>&nbsp;<span class="ident" id="1547164">unsafe</span><span class="op" id="1547170">.</span><span class="ident" id="1547171">Pointer</span><span class="op" id="1547178">(</span><span class="builtintype" id="1547179">uintptr</span><span class="op" id="1547186">(</span><span class="ident" id="1547187">unsafe</span><span class="op" id="1547193">.</span><span class="ident" id="1547194">Pointer</span><span class="op" id="1547201">(</span><span class="ident" id="1547202">b</span><span class="op" id="1547203">)</span><span class="op" id="1547204">)</span>&nbsp;<span class="op" id="1547206">+</span>&nbsp;<span class="ident" id="1547208">dataOffset</span>&nbsp;<span class="op" id="1547219">+</span>&nbsp;<span class="ident" id="1547221">bucketCnt</span><span class="op" id="1547230">*</span><span class="builtintype" id="1547231">uintptr</span><span class="op" id="1547238">(</span><span class="ident" id="1547239">t</span><span class="op" id="1547240">.</span><span class="ident" id="1547241">keysize</span><span class="op" id="1547248">)</span>&nbsp;<span class="op" id="1547250">+</span>&nbsp;<span class="ident" id="1547252">i</span><span class="op" id="1547253">*</span><span class="builtintype" id="1547254">uintptr</span><span class="op" id="1547261">(</span><span class="ident" id="1547262">t</span><span class="op" id="1547263">.</span><span class="ident" id="1547264">valuesize</span><span class="op" id="1547273">)</span><span class="op" id="1547274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547279">memclr</span><span class="op" id="1547285">(</span><span class="ident" id="1547286">v</span><span class="op" id="1547287">,</span>&nbsp;<span class="builtintype" id="1547289">uintptr</span><span class="op" id="1547296">(</span><span class="ident" id="1547297">t</span><span class="op" id="1547298">.</span><span class="ident" id="1547299">valuesize</span><span class="op" id="1547308">)</span><span class="op" id="1547309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547314">b</span><span class="op" id="1547315">.</span><span class="ident" id="1547316">tophash</span><span class="op" id="1547323">[</span><span class="ident" id="1547324">i</span><span class="op" id="1547325">]</span>&nbsp;<span class="op" id="1547327">=</span>&nbsp;<span class="ident" id="1547329">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547338">h</span><span class="op" id="1547339">.</span><span class="ident" id="1547340">count</span><span class="op" id="1547345">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547351">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547364">b</span>&nbsp;<span class="op" id="1547366">=</span>&nbsp;<span class="ident" id="1547368">b</span><span class="op" id="1547369">.</span><span class="ident" id="1547370">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547381">if</span>&nbsp;<span class="ident" id="1547384">b</span>&nbsp;<span class="op" id="1547386">==</span>&nbsp;<span class="ident" id="1547389">nil</span>&nbsp;<span class="op" id="1547393">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547398">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547410">}</span><br>
<span class="lineno"></span><span class="op" id="1547412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1547415">func</span>&nbsp;<span class="ident" id="1547420">mapiterinit</span><span class="op" id="1547431">(</span><span class="ident" id="1547432">t</span>&nbsp;<span class="op" id="1547434">*</span><span class="ident" id="1547435">maptype</span><span class="op" id="1547442">,</span>&nbsp;<span class="ident" id="1547444">h</span>&nbsp;<span class="op" id="1547446">*</span><span class="ident" id="1547447">hmap</span><span class="op" id="1547451">,</span>&nbsp;<span class="ident" id="1547453">it</span>&nbsp;<span class="op" id="1547456">*</span><span class="ident" id="1547457">hiter</span><span class="op" id="1547462">)</span>&nbsp;<span class="op" id="1547464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547467">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547532">it</span><span class="op" id="1547534">.</span><span class="ident" id="1547535">key</span>&nbsp;<span class="op" id="1547539">=</span>&nbsp;<span class="ident" id="1547541">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547546">it</span><span class="op" id="1547548">.</span><span class="ident" id="1547549">value</span>&nbsp;<span class="op" id="1547555">=</span>&nbsp;<span class="ident" id="1547557">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547562">it</span><span class="op" id="1547564">.</span><span class="ident" id="1547565">t</span>&nbsp;<span class="op" id="1547567">=</span>&nbsp;<span class="ident" id="1547569">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547574">it</span><span class="op" id="1547576">.</span><span class="ident" id="1547577">h</span>&nbsp;<span class="op" id="1547579">=</span>&nbsp;<span class="ident" id="1547581">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547586">it</span><span class="op" id="1547588">.</span><span class="ident" id="1547589">buckets</span>&nbsp;<span class="op" id="1547597">=</span>&nbsp;<span class="ident" id="1547599">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547604">it</span><span class="op" id="1547606">.</span><span class="ident" id="1547607">bptr</span>&nbsp;<span class="op" id="1547612">=</span>&nbsp;<span class="ident" id="1547614">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547620">if</span>&nbsp;<span class="ident" id="1547623">raceenabled</span>&nbsp;<span class="op" id="1547635">&amp;&amp;</span>&nbsp;<span class="ident" id="1547638">h</span>&nbsp;<span class="op" id="1547640">!=</span>&nbsp;<span class="ident" id="1547643">nil</span>&nbsp;<span class="op" id="1547647">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547651">callerpc</span>&nbsp;<span class="op" id="1547660">:=</span>&nbsp;<span class="ident" id="1547663">getcallerpc</span><span class="op" id="1547674">(</span><span class="ident" id="1547675">unsafe</span><span class="op" id="1547681">.</span><span class="ident" id="1547682">Pointer</span><span class="op" id="1547689">(</span><span class="op" id="1547690">&amp;</span><span class="ident" id="1547691">t</span><span class="op" id="1547692">)</span><span class="op" id="1547693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547697">racereadpc</span><span class="op" id="1547707">(</span><span class="ident" id="1547708">unsafe</span><span class="op" id="1547714">.</span><span class="ident" id="1547715">Pointer</span><span class="op" id="1547722">(</span><span class="ident" id="1547723">h</span><span class="op" id="1547724">)</span><span class="op" id="1547725">,</span>&nbsp;<span class="ident" id="1547727">callerpc</span><span class="op" id="1547735">,</span>&nbsp;<span class="ident" id="1547737">funcPC</span><span class="op" id="1547743">(</span><span class="ident" id="1547744">mapiterinit</span><span class="op" id="1547755">)</span><span class="op" id="1547756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547763">if</span>&nbsp;<span class="ident" id="1547766">h</span>&nbsp;<span class="op" id="1547768">==</span>&nbsp;<span class="ident" id="1547771">nil</span>&nbsp;<span class="op" id="1547775">||</span>&nbsp;<span class="ident" id="1547778">h</span><span class="op" id="1547779">.</span><span class="ident" id="1547780">count</span>&nbsp;<span class="op" id="1547786">==</span>&nbsp;<span class="num" id="1547789">0</span>&nbsp;<span class="op" id="1547791">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547795">it</span><span class="op" id="1547797">.</span><span class="ident" id="1547798">key</span>&nbsp;<span class="op" id="1547802">=</span>&nbsp;<span class="ident" id="1547804">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547810">it</span><span class="op" id="1547812">.</span><span class="ident" id="1547813">value</span>&nbsp;<span class="op" id="1547819">=</span>&nbsp;<span class="ident" id="1547821">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547827">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547839">if</span>&nbsp;<span class="ident" id="1547842">unsafe</span><span class="op" id="1547848">.</span><span class="ident" id="1547849">Sizeof</span><span class="op" id="1547855">(</span><span class="ident" id="1547856">hiter</span><span class="op" id="1547861">{</span><span class="op" id="1547862">}</span><span class="op" id="1547863">)</span><span class="op" id="1547864">/</span><span class="ident" id="1547865">ptrSize</span>&nbsp;<span class="op" id="1547873">!=</span>&nbsp;<span class="num" id="1547876">10</span>&nbsp;<span class="op" id="1547879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547883">gothrow</span><span class="op" id="1547890">(</span><span class="string" id="1547891">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1547917">)</span>&nbsp;<span class="comment" id="1547919">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547953">it</span><span class="op" id="1547955">.</span><span class="ident" id="1547956">t</span>&nbsp;<span class="op" id="1547958">=</span>&nbsp;<span class="ident" id="1547960">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547963">it</span><span class="op" id="1547965">.</span><span class="ident" id="1547966">h</span>&nbsp;<span class="op" id="1547968">=</span>&nbsp;<span class="ident" id="1547970">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547974">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548008">it</span><span class="op" id="1548010">.</span><span class="ident" id="1548011">B</span>&nbsp;<span class="op" id="1548013">=</span>&nbsp;<span class="ident" id="1548015">h</span><span class="op" id="1548016">.</span><span class="ident" id="1548017">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548020">it</span><span class="op" id="1548022">.</span><span class="ident" id="1548023">buckets</span>&nbsp;<span class="op" id="1548031">=</span>&nbsp;<span class="ident" id="1548033">h</span><span class="op" id="1548034">.</span><span class="ident" id="1548035">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548045">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548071">r</span>&nbsp;<span class="op" id="1548073">:=</span>&nbsp;<span class="builtintype" id="1548076">uintptr</span><span class="op" id="1548083">(</span><span class="ident" id="1548084">fastrand1</span><span class="op" id="1548093">(</span><span class="op" id="1548094">)</span><span class="op" id="1548095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548098">if</span>&nbsp;<span class="ident" id="1548101">h</span><span class="op" id="1548102">.</span><span class="ident" id="1548103">B</span>&nbsp;<span class="op" id="1548105">&gt;</span>&nbsp;<span class="num" id="1548107">31</span><span class="op" id="1548109">-</span><span class="ident" id="1548110">bucketCntBits</span>&nbsp;<span class="op" id="1548124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548128">r</span>&nbsp;<span class="op" id="1548130">+=</span>&nbsp;<span class="builtintype" id="1548133">uintptr</span><span class="op" id="1548140">(</span><span class="ident" id="1548141">fastrand1</span><span class="op" id="1548150">(</span><span class="op" id="1548151">)</span><span class="op" id="1548152">)</span>&nbsp;<span class="op" id="1548154">&lt;&lt;</span>&nbsp;<span class="num" id="1548157">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548161">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548164">it</span><span class="op" id="1548166">.</span><span class="ident" id="1548167">startBucket</span>&nbsp;<span class="op" id="1548179">=</span>&nbsp;<span class="ident" id="1548181">r</span>&nbsp;<span class="op" id="1548183">&amp;</span>&nbsp;<span class="op" id="1548185">(</span><span class="builtintype" id="1548186">uintptr</span><span class="op" id="1548193">(</span><span class="num" id="1548194">1</span><span class="op" id="1548195">)</span><span class="op" id="1548196">&lt;&lt;</span><span class="ident" id="1548198">h</span><span class="op" id="1548199">.</span><span class="ident" id="1548200">B</span>&nbsp;<span class="op" id="1548202">-</span>&nbsp;<span class="num" id="1548204">1</span><span class="op" id="1548205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548208">it</span><span class="op" id="1548210">.</span><span class="ident" id="1548211">offset</span>&nbsp;<span class="op" id="1548218">=</span>&nbsp;<span class="builtintype" id="1548220">uint8</span><span class="op" id="1548225">(</span><span class="ident" id="1548226">r</span>&nbsp;<span class="op" id="1548228">&gt;&gt;</span>&nbsp;<span class="ident" id="1548231">h</span><span class="op" id="1548232">.</span><span class="ident" id="1548233">B</span>&nbsp;<span class="op" id="1548235">&amp;</span>&nbsp;<span class="op" id="1548237">(</span><span class="ident" id="1548238">bucketCnt</span>&nbsp;<span class="op" id="1548248">-</span>&nbsp;<span class="num" id="1548250">1</span><span class="op" id="1548251">)</span><span class="op" id="1548252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548256">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548275">it</span><span class="op" id="1548277">.</span><span class="ident" id="1548278">bucket</span>&nbsp;<span class="op" id="1548285">=</span>&nbsp;<span class="ident" id="1548287">it</span><span class="op" id="1548289">.</span><span class="ident" id="1548290">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548303">it</span><span class="op" id="1548305">.</span><span class="ident" id="1548306">wrapped</span>&nbsp;<span class="op" id="1548314">=</span>&nbsp;<span class="builtintype" id="1548316">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548323">it</span><span class="op" id="1548325">.</span><span class="ident" id="1548326">bptr</span>&nbsp;<span class="op" id="1548331">=</span>&nbsp;<span class="ident" id="1548333">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548339">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548373">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548429">for</span>&nbsp;<span class="op" id="1548433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548437">old</span>&nbsp;<span class="op" id="1548441">:=</span>&nbsp;<span class="ident" id="1548444">h</span><span class="op" id="1548445">.</span><span class="ident" id="1548446">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548454">if</span>&nbsp;<span class="ident" id="1548457">old</span>&nbsp;<span class="op" id="1548461">==</span>&nbsp;<span class="ident" id="1548464">old</span><span class="op" id="1548467">|</span><span class="ident" id="1548468">iterator</span><span class="op" id="1548476">|</span><span class="ident" id="1548477">oldIterator</span>&nbsp;<span class="op" id="1548489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548494">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548502">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548506">if</span>&nbsp;<span class="ident" id="1548509">cas</span><span class="op" id="1548512">(</span><span class="op" id="1548513">&amp;</span><span class="ident" id="1548514">h</span><span class="op" id="1548515">.</span><span class="ident" id="1548516">flags</span><span class="op" id="1548521">,</span>&nbsp;<span class="ident" id="1548523">old</span><span class="op" id="1548526">,</span>&nbsp;<span class="ident" id="1548528">old</span><span class="op" id="1548531">|</span><span class="ident" id="1548532">iterator</span><span class="op" id="1548540">|</span><span class="ident" id="1548541">oldIterator</span><span class="op" id="1548552">)</span>&nbsp;<span class="op" id="1548554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548559">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548574">mapiternext</span><span class="op" id="1548585">(</span><span class="ident" id="1548586">it</span><span class="op" id="1548588">)</span><br>
<span class="lineno"></span><span class="op" id="1548590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1548593">func</span>&nbsp;<span class="ident" id="1548598">mapiternext</span><span class="op" id="1548609">(</span><span class="ident" id="1548610">it</span>&nbsp;<span class="op" id="1548613">*</span><span class="ident" id="1548614">hiter</span><span class="op" id="1548619">)</span>&nbsp;<span class="op" id="1548621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548624">h</span>&nbsp;<span class="op" id="1548626">:=</span>&nbsp;<span class="ident" id="1548629">it</span><span class="op" id="1548631">.</span><span class="ident" id="1548632">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548635">if</span>&nbsp;<span class="ident" id="1548638">raceenabled</span>&nbsp;<span class="op" id="1548650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548654">callerpc</span>&nbsp;<span class="op" id="1548663">:=</span>&nbsp;<span class="ident" id="1548666">getcallerpc</span><span class="op" id="1548677">(</span><span class="ident" id="1548678">unsafe</span><span class="op" id="1548684">.</span><span class="ident" id="1548685">Pointer</span><span class="op" id="1548692">(</span><span class="op" id="1548693">&amp;</span><span class="ident" id="1548694">it</span><span class="op" id="1548696">)</span><span class="op" id="1548697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548701">racereadpc</span><span class="op" id="1548711">(</span><span class="ident" id="1548712">unsafe</span><span class="op" id="1548718">.</span><span class="ident" id="1548719">Pointer</span><span class="op" id="1548726">(</span><span class="ident" id="1548727">h</span><span class="op" id="1548728">)</span><span class="op" id="1548729">,</span>&nbsp;<span class="ident" id="1548731">callerpc</span><span class="op" id="1548739">,</span>&nbsp;<span class="ident" id="1548741">funcPC</span><span class="op" id="1548747">(</span><span class="ident" id="1548748">mapiternext</span><span class="op" id="1548759">)</span><span class="op" id="1548760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548766">t</span>&nbsp;<span class="op" id="1548768">:=</span>&nbsp;<span class="ident" id="1548771">it</span><span class="op" id="1548773">.</span><span class="ident" id="1548774">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548777">bucket</span>&nbsp;<span class="op" id="1548784">:=</span>&nbsp;<span class="ident" id="1548787">it</span><span class="op" id="1548789">.</span><span class="ident" id="1548790">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548798">b</span>&nbsp;<span class="op" id="1548800">:=</span>&nbsp;<span class="ident" id="1548803">it</span><span class="op" id="1548805">.</span><span class="ident" id="1548806">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548812">i</span>&nbsp;<span class="op" id="1548814">:=</span>&nbsp;<span class="ident" id="1548817">it</span><span class="op" id="1548819">.</span><span class="ident" id="1548820">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548823">checkBucket</span>&nbsp;<span class="op" id="1548835">:=</span>&nbsp;<span class="ident" id="1548838">it</span><span class="op" id="1548840">.</span><span class="ident" id="1548841">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548854">alg</span>&nbsp;<span class="op" id="1548858">:=</span>&nbsp;<span class="ident" id="1548861">goalg</span><span class="op" id="1548866">(</span><span class="ident" id="1548867">t</span><span class="op" id="1548868">.</span><span class="ident" id="1548869">key</span><span class="op" id="1548872">.</span><span class="ident" id="1548873">alg</span><span class="op" id="1548876">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1548879">next</span><span class="op" id="1548883">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548886">if</span>&nbsp;<span class="ident" id="1548889">b</span>&nbsp;<span class="op" id="1548891">==</span>&nbsp;<span class="ident" id="1548894">nil</span>&nbsp;<span class="op" id="1548898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548902">if</span>&nbsp;<span class="ident" id="1548905">bucket</span>&nbsp;<span class="op" id="1548912">==</span>&nbsp;<span class="ident" id="1548915">it</span><span class="op" id="1548917">.</span><span class="ident" id="1548918">startBucket</span>&nbsp;<span class="op" id="1548930">&amp;&amp;</span>&nbsp;<span class="ident" id="1548933">it</span><span class="op" id="1548935">.</span><span class="ident" id="1548936">wrapped</span>&nbsp;<span class="op" id="1548944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548949">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548972">it</span><span class="op" id="1548974">.</span><span class="ident" id="1548975">key</span>&nbsp;<span class="op" id="1548979">=</span>&nbsp;<span class="ident" id="1548981">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548988">it</span><span class="op" id="1548990">.</span><span class="ident" id="1548991">value</span>&nbsp;<span class="op" id="1548997">=</span>&nbsp;<span class="ident" id="1548999">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549006">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549019">if</span>&nbsp;<span class="ident" id="1549022">h</span><span class="op" id="1549023">.</span><span class="ident" id="1549024">oldbuckets</span>&nbsp;<span class="op" id="1549035">!=</span>&nbsp;<span class="ident" id="1549038">nil</span>&nbsp;<span class="op" id="1549042">&amp;&amp;</span>&nbsp;<span class="ident" id="1549045">it</span><span class="op" id="1549047">.</span><span class="ident" id="1549048">B</span>&nbsp;<span class="op" id="1549050">==</span>&nbsp;<span class="ident" id="1549053">h</span><span class="op" id="1549054">.</span><span class="ident" id="1549055">B</span>&nbsp;<span class="op" id="1549057">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549062">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549143">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549220">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549296">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549372">oldbucket</span>&nbsp;<span class="op" id="1549382">:=</span>&nbsp;<span class="ident" id="1549385">bucket</span>&nbsp;<span class="op" id="1549392">&amp;</span>&nbsp;<span class="op" id="1549394">(</span><span class="builtintype" id="1549395">uintptr</span><span class="op" id="1549402">(</span><span class="num" id="1549403">1</span><span class="op" id="1549404">)</span><span class="op" id="1549405">&lt;&lt;</span><span class="op" id="1549407">(</span><span class="ident" id="1549408">it</span><span class="op" id="1549410">.</span><span class="ident" id="1549411">B</span><span class="op" id="1549412">-</span><span class="num" id="1549413">1</span><span class="op" id="1549414">)</span>&nbsp;<span class="op" id="1549416">-</span>&nbsp;<span class="num" id="1549418">1</span><span class="op" id="1549419">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549424">b</span>&nbsp;<span class="op" id="1549426">=</span>&nbsp;<span class="op" id="1549428">(</span><span class="op" id="1549429">*</span><span class="ident" id="1549430">bmap</span><span class="op" id="1549434">)</span><span class="op" id="1549435">(</span><span class="ident" id="1549436">add</span><span class="op" id="1549439">(</span><span class="ident" id="1549440">h</span><span class="op" id="1549441">.</span><span class="ident" id="1549442">oldbuckets</span><span class="op" id="1549452">,</span>&nbsp;<span class="ident" id="1549454">oldbucket</span><span class="op" id="1549463">*</span><span class="builtintype" id="1549464">uintptr</span><span class="op" id="1549471">(</span><span class="ident" id="1549472">t</span><span class="op" id="1549473">.</span><span class="ident" id="1549474">bucketsize</span><span class="op" id="1549484">)</span><span class="op" id="1549485">)</span><span class="op" id="1549486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549491">if</span>&nbsp;<span class="op" id="1549494">!</span><span class="ident" id="1549495">evacuated</span><span class="op" id="1549504">(</span><span class="ident" id="1549505">b</span><span class="op" id="1549506">)</span>&nbsp;<span class="op" id="1549508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549514">checkBucket</span>&nbsp;<span class="op" id="1549526">=</span>&nbsp;<span class="ident" id="1549528">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549538">}</span>&nbsp;<span class="keyword" id="1549540">else</span>&nbsp;<span class="op" id="1549545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549551">b</span>&nbsp;<span class="op" id="1549553">=</span>&nbsp;<span class="op" id="1549555">(</span><span class="op" id="1549556">*</span><span class="ident" id="1549557">bmap</span><span class="op" id="1549561">)</span><span class="op" id="1549562">(</span><span class="ident" id="1549563">add</span><span class="op" id="1549566">(</span><span class="ident" id="1549567">it</span><span class="op" id="1549569">.</span><span class="ident" id="1549570">buckets</span><span class="op" id="1549577">,</span>&nbsp;<span class="ident" id="1549579">bucket</span><span class="op" id="1549585">*</span><span class="builtintype" id="1549586">uintptr</span><span class="op" id="1549593">(</span><span class="ident" id="1549594">t</span><span class="op" id="1549595">.</span><span class="ident" id="1549596">bucketsize</span><span class="op" id="1549606">)</span><span class="op" id="1549607">)</span><span class="op" id="1549608">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549614">checkBucket</span>&nbsp;<span class="op" id="1549626">=</span>&nbsp;<span class="ident" id="1549628">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549643">}</span>&nbsp;<span class="keyword" id="1549645">else</span>&nbsp;<span class="op" id="1549650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549655">b</span>&nbsp;<span class="op" id="1549657">=</span>&nbsp;<span class="op" id="1549659">(</span><span class="op" id="1549660">*</span><span class="ident" id="1549661">bmap</span><span class="op" id="1549665">)</span><span class="op" id="1549666">(</span><span class="ident" id="1549667">add</span><span class="op" id="1549670">(</span><span class="ident" id="1549671">it</span><span class="op" id="1549673">.</span><span class="ident" id="1549674">buckets</span><span class="op" id="1549681">,</span>&nbsp;<span class="ident" id="1549683">bucket</span><span class="op" id="1549689">*</span><span class="builtintype" id="1549690">uintptr</span><span class="op" id="1549697">(</span><span class="ident" id="1549698">t</span><span class="op" id="1549699">.</span><span class="ident" id="1549700">bucketsize</span><span class="op" id="1549710">)</span><span class="op" id="1549711">)</span><span class="op" id="1549712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549717">checkBucket</span>&nbsp;<span class="op" id="1549729">=</span>&nbsp;<span class="ident" id="1549731">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549745">bucket</span><span class="op" id="1549751">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549756">if</span>&nbsp;<span class="ident" id="1549759">bucket</span>&nbsp;<span class="op" id="1549766">==</span>&nbsp;<span class="builtintype" id="1549769">uintptr</span><span class="op" id="1549776">(</span><span class="num" id="1549777">1</span><span class="op" id="1549778">)</span><span class="op" id="1549779">&lt;&lt;</span><span class="ident" id="1549781">it</span><span class="op" id="1549783">.</span><span class="ident" id="1549784">B</span>&nbsp;<span class="op" id="1549786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549791">bucket</span>&nbsp;<span class="op" id="1549798">=</span>&nbsp;<span class="num" id="1549800">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549805">it</span><span class="op" id="1549807">.</span><span class="ident" id="1549808">wrapped</span>&nbsp;<span class="op" id="1549816">=</span>&nbsp;<span class="builtintype" id="1549818">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549829">i</span>&nbsp;<span class="op" id="1549831">=</span>&nbsp;<span class="num" id="1549833">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549839">for</span>&nbsp;<span class="op" id="1549843">;</span>&nbsp;<span class="ident" id="1549845">i</span>&nbsp;<span class="op" id="1549847">&lt;</span>&nbsp;<span class="ident" id="1549849">bucketCnt</span><span class="op" id="1549858">;</span>&nbsp;<span class="ident" id="1549860">i</span><span class="op" id="1549861">++</span>&nbsp;<span class="op" id="1549864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549868">offi</span>&nbsp;<span class="op" id="1549873">:=</span>&nbsp;<span class="op" id="1549876">(</span><span class="ident" id="1549877">i</span>&nbsp;<span class="op" id="1549879">+</span>&nbsp;<span class="ident" id="1549881">it</span><span class="op" id="1549883">.</span><span class="ident" id="1549884">offset</span><span class="op" id="1549890">)</span>&nbsp;<span class="op" id="1549892">&amp;</span>&nbsp;<span class="op" id="1549894">(</span><span class="ident" id="1549895">bucketCnt</span>&nbsp;<span class="op" id="1549905">-</span>&nbsp;<span class="num" id="1549907">1</span><span class="op" id="1549908">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549912">k</span>&nbsp;<span class="op" id="1549914">:=</span>&nbsp;<span class="ident" id="1549917">add</span><span class="op" id="1549920">(</span><span class="ident" id="1549921">unsafe</span><span class="op" id="1549927">.</span><span class="ident" id="1549928">Pointer</span><span class="op" id="1549935">(</span><span class="ident" id="1549936">b</span><span class="op" id="1549937">)</span><span class="op" id="1549938">,</span>&nbsp;<span class="ident" id="1549940">dataOffset</span><span class="op" id="1549950">+</span><span class="builtintype" id="1549951">uintptr</span><span class="op" id="1549958">(</span><span class="ident" id="1549959">offi</span><span class="op" id="1549963">)</span><span class="op" id="1549964">*</span><span class="builtintype" id="1549965">uintptr</span><span class="op" id="1549972">(</span><span class="ident" id="1549973">t</span><span class="op" id="1549974">.</span><span class="ident" id="1549975">keysize</span><span class="op" id="1549982">)</span><span class="op" id="1549983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549987">v</span>&nbsp;<span class="op" id="1549989">:=</span>&nbsp;<span class="ident" id="1549992">add</span><span class="op" id="1549995">(</span><span class="ident" id="1549996">unsafe</span><span class="op" id="1550002">.</span><span class="ident" id="1550003">Pointer</span><span class="op" id="1550010">(</span><span class="ident" id="1550011">b</span><span class="op" id="1550012">)</span><span class="op" id="1550013">,</span>&nbsp;<span class="ident" id="1550015">dataOffset</span><span class="op" id="1550025">+</span><span class="ident" id="1550026">bucketCnt</span><span class="op" id="1550035">*</span><span class="builtintype" id="1550036">uintptr</span><span class="op" id="1550043">(</span><span class="ident" id="1550044">t</span><span class="op" id="1550045">.</span><span class="ident" id="1550046">keysize</span><span class="op" id="1550053">)</span><span class="op" id="1550054">+</span><span class="builtintype" id="1550055">uintptr</span><span class="op" id="1550062">(</span><span class="ident" id="1550063">offi</span><span class="op" id="1550067">)</span><span class="op" id="1550068">*</span><span class="builtintype" id="1550069">uintptr</span><span class="op" id="1550076">(</span><span class="ident" id="1550077">t</span><span class="op" id="1550078">.</span><span class="ident" id="1550079">valuesize</span><span class="op" id="1550088">)</span><span class="op" id="1550089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550093">if</span>&nbsp;<span class="ident" id="1550096">b</span><span class="op" id="1550097">.</span><span class="ident" id="1550098">tophash</span><span class="op" id="1550105">[</span><span class="ident" id="1550106">offi</span><span class="op" id="1550110">]</span>&nbsp;<span class="op" id="1550112">!=</span>&nbsp;<span class="ident" id="1550115">empty</span>&nbsp;<span class="op" id="1550121">&amp;&amp;</span>&nbsp;<span class="ident" id="1550124">b</span><span class="op" id="1550125">.</span><span class="ident" id="1550126">tophash</span><span class="op" id="1550133">[</span><span class="ident" id="1550134">offi</span><span class="op" id="1550138">]</span>&nbsp;<span class="op" id="1550140">!=</span>&nbsp;<span class="ident" id="1550143">evacuatedEmpty</span>&nbsp;<span class="op" id="1550158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550163">if</span>&nbsp;<span class="ident" id="1550166">checkBucket</span>&nbsp;<span class="op" id="1550178">!=</span>&nbsp;<span class="ident" id="1550181">noCheck</span>&nbsp;<span class="op" id="1550189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550195">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550259">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550321">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550390">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550455">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550516">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550578">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550609">k2</span>&nbsp;<span class="op" id="1550612">:=</span>&nbsp;<span class="ident" id="1550615">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550621">if</span>&nbsp;<span class="ident" id="1550624">t</span><span class="op" id="1550625">.</span><span class="ident" id="1550626">indirectkey</span>&nbsp;<span class="op" id="1550638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550645">k2</span>&nbsp;<span class="op" id="1550648">=</span>&nbsp;<span class="op" id="1550650">*</span><span class="op" id="1550651">(</span><span class="op" id="1550652">(</span><span class="op" id="1550653">*</span><span class="ident" id="1550654">unsafe</span><span class="op" id="1550660">.</span><span class="ident" id="1550661">Pointer</span><span class="op" id="1550668">)</span><span class="op" id="1550669">(</span><span class="ident" id="1550670">k2</span><span class="op" id="1550672">)</span><span class="op" id="1550673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550679">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550685">if</span>&nbsp;<span class="ident" id="1550688">alg</span><span class="op" id="1550691">.</span><span class="ident" id="1550692">equal</span><span class="op" id="1550697">(</span><span class="ident" id="1550698">k2</span><span class="op" id="1550700">,</span>&nbsp;<span class="ident" id="1550702">k2</span><span class="op" id="1550704">,</span>&nbsp;<span class="builtintype" id="1550706">uintptr</span><span class="op" id="1550713">(</span><span class="ident" id="1550714">t</span><span class="op" id="1550715">.</span><span class="ident" id="1550716">key</span><span class="op" id="1550719">.</span><span class="ident" id="1550720">size</span><span class="op" id="1550724">)</span><span class="op" id="1550725">)</span>&nbsp;<span class="op" id="1550727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550734">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550791">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550849">hash</span>&nbsp;<span class="op" id="1550854">:=</span>&nbsp;<span class="ident" id="1550857">alg</span><span class="op" id="1550860">.</span><span class="ident" id="1550861">hash</span><span class="op" id="1550865">(</span><span class="ident" id="1550866">k2</span><span class="op" id="1550868">,</span>&nbsp;<span class="builtintype" id="1550870">uintptr</span><span class="op" id="1550877">(</span><span class="ident" id="1550878">t</span><span class="op" id="1550879">.</span><span class="ident" id="1550880">key</span><span class="op" id="1550883">.</span><span class="ident" id="1550884">size</span><span class="op" id="1550888">)</span><span class="op" id="1550889">,</span>&nbsp;<span class="builtintype" id="1550891">uintptr</span><span class="op" id="1550898">(</span><span class="ident" id="1550899">h</span><span class="op" id="1550900">.</span><span class="ident" id="1550901">hash0</span><span class="op" id="1550906">)</span><span class="op" id="1550907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550914">if</span>&nbsp;<span class="ident" id="1550917">hash</span><span class="op" id="1550921">&amp;</span><span class="op" id="1550922">(</span><span class="builtintype" id="1550923">uintptr</span><span class="op" id="1550930">(</span><span class="num" id="1550931">1</span><span class="op" id="1550932">)</span><span class="op" id="1550933">&lt;&lt;</span><span class="ident" id="1550935">it</span><span class="op" id="1550937">.</span><span class="ident" id="1550938">B</span><span class="op" id="1550939">-</span><span class="num" id="1550940">1</span><span class="op" id="1550941">)</span>&nbsp;<span class="op" id="1550943">!=</span>&nbsp;<span class="ident" id="1550946">checkBucket</span>&nbsp;<span class="op" id="1550958">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550966">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550986">}</span>&nbsp;<span class="keyword" id="1550988">else</span>&nbsp;<span class="op" id="1550993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551000">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551059">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551118">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551177">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551229">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551289">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551347">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551370">if</span>&nbsp;<span class="ident" id="1551373">checkBucket</span><span class="op" id="1551384">&gt;&gt;</span><span class="op" id="1551386">(</span><span class="ident" id="1551387">it</span><span class="op" id="1551389">.</span><span class="ident" id="1551390">B</span><span class="op" id="1551391">-</span><span class="num" id="1551392">1</span><span class="op" id="1551393">)</span>&nbsp;<span class="op" id="1551395">!=</span>&nbsp;<span class="builtintype" id="1551398">uintptr</span><span class="op" id="1551405">(</span><span class="ident" id="1551406">b</span><span class="op" id="1551407">.</span><span class="ident" id="1551408">tophash</span><span class="op" id="1551415">[</span><span class="ident" id="1551416">offi</span><span class="op" id="1551420">]</span><span class="op" id="1551421">&amp;</span><span class="num" id="1551422">1</span><span class="op" id="1551423">)</span>&nbsp;<span class="op" id="1551425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551433">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551458">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551463">if</span>&nbsp;<span class="ident" id="1551466">b</span><span class="op" id="1551467">.</span><span class="ident" id="1551468">tophash</span><span class="op" id="1551475">[</span><span class="ident" id="1551476">offi</span><span class="op" id="1551480">]</span>&nbsp;<span class="op" id="1551482">!=</span>&nbsp;<span class="ident" id="1551485">evacuatedX</span>&nbsp;<span class="op" id="1551496">&amp;&amp;</span>&nbsp;<span class="ident" id="1551499">b</span><span class="op" id="1551500">.</span><span class="ident" id="1551501">tophash</span><span class="op" id="1551508">[</span><span class="ident" id="1551509">offi</span><span class="op" id="1551513">]</span>&nbsp;<span class="op" id="1551515">!=</span>&nbsp;<span class="ident" id="1551518">evacuatedY</span>&nbsp;<span class="op" id="1551529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551535">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551585">if</span>&nbsp;<span class="ident" id="1551588">t</span><span class="op" id="1551589">.</span><span class="ident" id="1551590">indirectkey</span>&nbsp;<span class="op" id="1551602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551609">k</span>&nbsp;<span class="op" id="1551611">=</span>&nbsp;<span class="op" id="1551613">*</span><span class="op" id="1551614">(</span><span class="op" id="1551615">(</span><span class="op" id="1551616">*</span><span class="ident" id="1551617">unsafe</span><span class="op" id="1551623">.</span><span class="ident" id="1551624">Pointer</span><span class="op" id="1551631">)</span><span class="op" id="1551632">(</span><span class="ident" id="1551633">k</span><span class="op" id="1551634">)</span><span class="op" id="1551635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551641">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551647">it</span><span class="op" id="1551649">.</span><span class="ident" id="1551650">key</span>&nbsp;<span class="op" id="1551654">=</span>&nbsp;<span class="ident" id="1551656">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551662">if</span>&nbsp;<span class="ident" id="1551665">t</span><span class="op" id="1551666">.</span><span class="ident" id="1551667">indirectvalue</span>&nbsp;<span class="op" id="1551681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551688">v</span>&nbsp;<span class="op" id="1551690">=</span>&nbsp;<span class="op" id="1551692">*</span><span class="op" id="1551693">(</span><span class="op" id="1551694">(</span><span class="op" id="1551695">*</span><span class="ident" id="1551696">unsafe</span><span class="op" id="1551702">.</span><span class="ident" id="1551703">Pointer</span><span class="op" id="1551710">)</span><span class="op" id="1551711">(</span><span class="ident" id="1551712">v</span><span class="op" id="1551713">)</span><span class="op" id="1551714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551726">it</span><span class="op" id="1551728">.</span><span class="ident" id="1551729">value</span>&nbsp;<span class="op" id="1551735">=</span>&nbsp;<span class="ident" id="1551737">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551742">}</span>&nbsp;<span class="keyword" id="1551744">else</span>&nbsp;<span class="op" id="1551749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551755">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551819">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551878">k2</span>&nbsp;<span class="op" id="1551881">:=</span>&nbsp;<span class="ident" id="1551884">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551890">if</span>&nbsp;<span class="ident" id="1551893">t</span><span class="op" id="1551894">.</span><span class="ident" id="1551895">indirectkey</span>&nbsp;<span class="op" id="1551907">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551914">k2</span>&nbsp;<span class="op" id="1551917">=</span>&nbsp;<span class="op" id="1551919">*</span><span class="op" id="1551920">(</span><span class="op" id="1551921">(</span><span class="op" id="1551922">*</span><span class="ident" id="1551923">unsafe</span><span class="op" id="1551929">.</span><span class="ident" id="1551930">Pointer</span><span class="op" id="1551937">)</span><span class="op" id="1551938">(</span><span class="ident" id="1551939">k2</span><span class="op" id="1551941">)</span><span class="op" id="1551942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551954">if</span>&nbsp;<span class="ident" id="1551957">alg</span><span class="op" id="1551960">.</span><span class="ident" id="1551961">equal</span><span class="op" id="1551966">(</span><span class="ident" id="1551967">k2</span><span class="op" id="1551969">,</span>&nbsp;<span class="ident" id="1551971">k2</span><span class="op" id="1551973">,</span>&nbsp;<span class="builtintype" id="1551975">uintptr</span><span class="op" id="1551982">(</span><span class="ident" id="1551983">t</span><span class="op" id="1551984">.</span><span class="ident" id="1551985">key</span><span class="op" id="1551988">.</span><span class="ident" id="1551989">size</span><span class="op" id="1551993">)</span><span class="op" id="1551994">)</span>&nbsp;<span class="op" id="1551996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552003">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552054">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552103">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552165">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552232">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552305">rk</span><span class="op" id="1552307">,</span>&nbsp;<span class="ident" id="1552309">rv</span>&nbsp;<span class="op" id="1552312">:=</span>&nbsp;<span class="ident" id="1552315">mapaccessK</span><span class="op" id="1552325">(</span><span class="ident" id="1552326">t</span><span class="op" id="1552327">,</span>&nbsp;<span class="ident" id="1552329">h</span><span class="op" id="1552330">,</span>&nbsp;<span class="ident" id="1552332">k2</span><span class="op" id="1552334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552341">if</span>&nbsp;<span class="ident" id="1552344">rk</span>&nbsp;<span class="op" id="1552347">==</span>&nbsp;<span class="ident" id="1552350">nil</span>&nbsp;<span class="op" id="1552354">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552362">continue</span>&nbsp;<span class="comment" id="1552371">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552407">it</span><span class="op" id="1552409">.</span><span class="ident" id="1552410">key</span>&nbsp;<span class="op" id="1552414">=</span>&nbsp;<span class="ident" id="1552416">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552424">it</span><span class="op" id="1552426">.</span><span class="ident" id="1552427">value</span>&nbsp;<span class="op" id="1552433">=</span>&nbsp;<span class="ident" id="1552435">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552442">}</span>&nbsp;<span class="keyword" id="1552444">else</span>&nbsp;<span class="op" id="1552449">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552456">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552511">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552572">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552625">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552668">it</span><span class="op" id="1552670">.</span><span class="ident" id="1552671">key</span>&nbsp;<span class="op" id="1552675">=</span>&nbsp;<span class="ident" id="1552677">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552685">if</span>&nbsp;<span class="ident" id="1552688">t</span><span class="op" id="1552689">.</span><span class="ident" id="1552690">indirectvalue</span>&nbsp;<span class="op" id="1552704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552712">v</span>&nbsp;<span class="op" id="1552714">=</span>&nbsp;<span class="op" id="1552716">*</span><span class="op" id="1552717">(</span><span class="op" id="1552718">(</span><span class="op" id="1552719">*</span><span class="ident" id="1552720">unsafe</span><span class="op" id="1552726">.</span><span class="ident" id="1552727">Pointer</span><span class="op" id="1552734">)</span><span class="op" id="1552735">(</span><span class="ident" id="1552736">v</span><span class="op" id="1552737">)</span><span class="op" id="1552738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552752">it</span><span class="op" id="1552754">.</span><span class="ident" id="1552755">value</span>&nbsp;<span class="op" id="1552761">=</span>&nbsp;<span class="ident" id="1552763">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552769">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552779">it</span><span class="op" id="1552781">.</span><span class="ident" id="1552782">bucket</span>&nbsp;<span class="op" id="1552789">=</span>&nbsp;<span class="ident" id="1552791">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552801">it</span><span class="op" id="1552803">.</span><span class="ident" id="1552804">bptr</span>&nbsp;<span class="op" id="1552809">=</span>&nbsp;<span class="ident" id="1552811">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552816">it</span><span class="op" id="1552818">.</span><span class="ident" id="1552819">i</span>&nbsp;<span class="op" id="1552821">=</span>&nbsp;<span class="ident" id="1552823">i</span>&nbsp;<span class="op" id="1552825">+</span>&nbsp;<span class="num" id="1552827">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552832">it</span><span class="op" id="1552834">.</span><span class="ident" id="1552835">checkBucket</span>&nbsp;<span class="op" id="1552847">=</span>&nbsp;<span class="ident" id="1552849">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552864">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552879">b</span>&nbsp;<span class="op" id="1552881">=</span>&nbsp;<span class="ident" id="1552883">b</span><span class="op" id="1552884">.</span><span class="ident" id="1552885">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552895">i</span>&nbsp;<span class="op" id="1552897">=</span>&nbsp;<span class="num" id="1552899">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552902">goto</span>&nbsp;<span class="ident" id="1552907">next</span><br>
<span class="lineno"></span><span class="op" id="1552912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552915">func</span>&nbsp;<span class="ident" id="1552920">hashGrow</span><span class="op" id="1552928">(</span><span class="ident" id="1552929">t</span>&nbsp;<span class="op" id="1552931">*</span><span class="ident" id="1552932">maptype</span><span class="op" id="1552939">,</span>&nbsp;<span class="ident" id="1552941">h</span>&nbsp;<span class="op" id="1552943">*</span><span class="ident" id="1552944">hmap</span><span class="op" id="1552948">)</span>&nbsp;<span class="op" id="1552950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552953">if</span>&nbsp;<span class="ident" id="1552956">h</span><span class="op" id="1552957">.</span><span class="ident" id="1552958">oldbuckets</span>&nbsp;<span class="op" id="1552969">!=</span>&nbsp;<span class="ident" id="1552972">nil</span>&nbsp;<span class="op" id="1552976">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552980">gothrow</span><span class="op" id="1552987">(</span><span class="string" id="1552988">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1553017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553023">oldbuckets</span>&nbsp;<span class="op" id="1553034">:=</span>&nbsp;<span class="ident" id="1553037">h</span><span class="op" id="1553038">.</span><span class="ident" id="1553039">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553048">if</span>&nbsp;<span class="ident" id="1553051">checkgc</span>&nbsp;<span class="op" id="1553059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553063">memstats</span><span class="op" id="1553071">.</span><span class="ident" id="1553072">next_gc</span>&nbsp;<span class="op" id="1553080">=</span>&nbsp;<span class="ident" id="1553082">memstats</span><span class="op" id="1553090">.</span><span class="ident" id="1553091">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553106">newbuckets</span>&nbsp;<span class="op" id="1553117">:=</span>&nbsp;<span class="ident" id="1553120">newarray</span><span class="op" id="1553128">(</span><span class="ident" id="1553129">t</span><span class="op" id="1553130">.</span><span class="ident" id="1553131">bucket</span><span class="op" id="1553137">,</span>&nbsp;<span class="builtintype" id="1553139">uintptr</span><span class="op" id="1553146">(</span><span class="num" id="1553147">1</span><span class="op" id="1553148">)</span><span class="op" id="1553149">&lt;&lt;</span><span class="op" id="1553151">(</span><span class="ident" id="1553152">h</span><span class="op" id="1553153">.</span><span class="ident" id="1553154">B</span><span class="op" id="1553155">+</span><span class="num" id="1553156">1</span><span class="op" id="1553157">)</span><span class="op" id="1553158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553161">flags</span>&nbsp;<span class="op" id="1553167">:=</span>&nbsp;<span class="ident" id="1553170">h</span><span class="op" id="1553171">.</span><span class="ident" id="1553172">flags</span>&nbsp;<span class="op" id="1553178">&amp;^</span>&nbsp;<span class="op" id="1553181">(</span><span class="ident" id="1553182">iterator</span>&nbsp;<span class="op" id="1553191">|</span>&nbsp;<span class="ident" id="1553193">oldIterator</span><span class="op" id="1553204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553207">if</span>&nbsp;<span class="ident" id="1553210">h</span><span class="op" id="1553211">.</span><span class="ident" id="1553212">flags</span><span class="op" id="1553217">&amp;</span><span class="ident" id="1553218">iterator</span>&nbsp;<span class="op" id="1553227">!=</span>&nbsp;<span class="num" id="1553230">0</span>&nbsp;<span class="op" id="1553232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553236">flags</span>&nbsp;<span class="op" id="1553242">|=</span>&nbsp;<span class="ident" id="1553245">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553261">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553297">h</span><span class="op" id="1553298">.</span><span class="ident" id="1553299">B</span><span class="op" id="1553300">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553304">h</span><span class="op" id="1553305">.</span><span class="ident" id="1553306">flags</span>&nbsp;<span class="op" id="1553312">=</span>&nbsp;<span class="ident" id="1553314">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553321">h</span><span class="op" id="1553322">.</span><span class="ident" id="1553323">oldbuckets</span>&nbsp;<span class="op" id="1553334">=</span>&nbsp;<span class="ident" id="1553336">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553348">h</span><span class="op" id="1553349">.</span><span class="ident" id="1553350">buckets</span>&nbsp;<span class="op" id="1553358">=</span>&nbsp;<span class="ident" id="1553360">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553372">h</span><span class="op" id="1553373">.</span><span class="ident" id="1553374">nevacuate</span>&nbsp;<span class="op" id="1553384">=</span>&nbsp;<span class="num" id="1553386">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553390">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553458">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1553491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1553494">func</span>&nbsp;<span class="ident" id="1553499">growWork</span><span class="op" id="1553507">(</span><span class="ident" id="1553508">t</span>&nbsp;<span class="op" id="1553510">*</span><span class="ident" id="1553511">maptype</span><span class="op" id="1553518">,</span>&nbsp;<span class="ident" id="1553520">h</span>&nbsp;<span class="op" id="1553522">*</span><span class="ident" id="1553523">hmap</span><span class="op" id="1553527">,</span>&nbsp;<span class="ident" id="1553529">bucket</span>&nbsp;<span class="builtintype" id="1553536">uintptr</span><span class="op" id="1553543">)</span>&nbsp;<span class="op" id="1553545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553548">noldbuckets</span>&nbsp;<span class="op" id="1553560">:=</span>&nbsp;<span class="builtintype" id="1553563">uintptr</span><span class="op" id="1553570">(</span><span class="num" id="1553571">1</span><span class="op" id="1553572">)</span>&nbsp;<span class="op" id="1553574">&lt;&lt;</span>&nbsp;<span class="op" id="1553577">(</span><span class="ident" id="1553578">h</span><span class="op" id="1553579">.</span><span class="ident" id="1553580">B</span>&nbsp;<span class="op" id="1553582">-</span>&nbsp;<span class="num" id="1553584">1</span><span class="op" id="1553585">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553589">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553643">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553680">evacuate</span><span class="op" id="1553688">(</span><span class="ident" id="1553689">t</span><span class="op" id="1553690">,</span>&nbsp;<span class="ident" id="1553692">h</span><span class="op" id="1553693">,</span>&nbsp;<span class="ident" id="1553695">bucket</span><span class="op" id="1553701">&amp;</span><span class="op" id="1553702">(</span><span class="ident" id="1553703">noldbuckets</span><span class="op" id="1553714">-</span><span class="num" id="1553715">1</span><span class="op" id="1553716">)</span><span class="op" id="1553717">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553721">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553781">if</span>&nbsp;<span class="ident" id="1553784">h</span><span class="op" id="1553785">.</span><span class="ident" id="1553786">oldbuckets</span>&nbsp;<span class="op" id="1553797">!=</span>&nbsp;<span class="ident" id="1553800">nil</span>&nbsp;<span class="op" id="1553804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553808">evacuate</span><span class="op" id="1553816">(</span><span class="ident" id="1553817">t</span><span class="op" id="1553818">,</span>&nbsp;<span class="ident" id="1553820">h</span><span class="op" id="1553821">,</span>&nbsp;<span class="ident" id="1553823">h</span><span class="op" id="1553824">.</span><span class="ident" id="1553825">nevacuate</span><span class="op" id="1553834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553837">}</span><br>
<span class="lineno"></span><span class="op" id="1553839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1553842">func</span>&nbsp;<span class="ident" id="1553847">evacuate</span><span class="op" id="1553855">(</span><span class="ident" id="1553856">t</span>&nbsp;<span class="op" id="1553858">*</span><span class="ident" id="1553859">maptype</span><span class="op" id="1553866">,</span>&nbsp;<span class="ident" id="1553868">h</span>&nbsp;<span class="op" id="1553870">*</span><span class="ident" id="1553871">hmap</span><span class="op" id="1553875">,</span>&nbsp;<span class="ident" id="1553877">oldbucket</span>&nbsp;<span class="builtintype" id="1553887">uintptr</span><span class="op" id="1553894">)</span>&nbsp;<span class="op" id="1553896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553899">b</span>&nbsp;<span class="op" id="1553901">:=</span>&nbsp;<span class="op" id="1553904">(</span><span class="op" id="1553905">*</span><span class="ident" id="1553906">bmap</span><span class="op" id="1553910">)</span><span class="op" id="1553911">(</span><span class="ident" id="1553912">add</span><span class="op" id="1553915">(</span><span class="ident" id="1553916">h</span><span class="op" id="1553917">.</span><span class="ident" id="1553918">oldbuckets</span><span class="op" id="1553928">,</span>&nbsp;<span class="ident" id="1553930">oldbucket</span><span class="op" id="1553939">*</span><span class="builtintype" id="1553940">uintptr</span><span class="op" id="1553947">(</span><span class="ident" id="1553948">t</span><span class="op" id="1553949">.</span><span class="ident" id="1553950">bucketsize</span><span class="op" id="1553960">)</span><span class="op" id="1553961">)</span><span class="op" id="1553962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553965">newbit</span>&nbsp;<span class="op" id="1553972">:=</span>&nbsp;<span class="builtintype" id="1553975">uintptr</span><span class="op" id="1553982">(</span><span class="num" id="1553983">1</span><span class="op" id="1553984">)</span>&nbsp;<span class="op" id="1553986">&lt;&lt;</span>&nbsp;<span class="op" id="1553989">(</span><span class="ident" id="1553990">h</span><span class="op" id="1553991">.</span><span class="ident" id="1553992">B</span>&nbsp;<span class="op" id="1553994">-</span>&nbsp;<span class="num" id="1553996">1</span><span class="op" id="1553997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554000">alg</span>&nbsp;<span class="op" id="1554004">:=</span>&nbsp;<span class="ident" id="1554007">goalg</span><span class="op" id="1554012">(</span><span class="ident" id="1554013">t</span><span class="op" id="1554014">.</span><span class="ident" id="1554015">key</span><span class="op" id="1554018">.</span><span class="ident" id="1554019">alg</span><span class="op" id="1554022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554025">if</span>&nbsp;<span class="op" id="1554028">!</span><span class="ident" id="1554029">evacuated</span><span class="op" id="1554038">(</span><span class="ident" id="1554039">b</span><span class="op" id="1554040">)</span>&nbsp;<span class="op" id="1554042">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1554046">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1554116">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554180">x</span>&nbsp;<span class="op" id="1554182">:=</span>&nbsp;<span class="op" id="1554185">(</span><span class="op" id="1554186">*</span><span class="ident" id="1554187">bmap</span><span class="op" id="1554191">)</span><span class="op" id="1554192">(</span><span class="ident" id="1554193">add</span><span class="op" id="1554196">(</span><span class="ident" id="1554197">h</span><span class="op" id="1554198">.</span><span class="ident" id="1554199">buckets</span><span class="op" id="1554206">,</span>&nbsp;<span class="ident" id="1554208">oldbucket</span><span class="op" id="1554217">*</span><span class="builtintype" id="1554218">uintptr</span><span class="op" id="1554225">(</span><span class="ident" id="1554226">t</span><span class="op" id="1554227">.</span><span class="ident" id="1554228">bucketsize</span><span class="op" id="1554238">)</span><span class="op" id="1554239">)</span><span class="op" id="1554240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554244">y</span>&nbsp;<span class="op" id="1554246">:=</span>&nbsp;<span class="op" id="1554249">(</span><span class="op" id="1554250">*</span><span class="ident" id="1554251">bmap</span><span class="op" id="1554255">)</span><span class="op" id="1554256">(</span><span class="ident" id="1554257">add</span><span class="op" id="1554260">(</span><span class="ident" id="1554261">h</span><span class="op" id="1554262">.</span><span class="ident" id="1554263">buckets</span><span class="op" id="1554270">,</span>&nbsp;<span class="op" id="1554272">(</span><span class="ident" id="1554273">oldbucket</span><span class="op" id="1554282">+</span><span class="ident" id="1554283">newbit</span><span class="op" id="1554289">)</span><span class="op" id="1554290">*</span><span class="builtintype" id="1554291">uintptr</span><span class="op" id="1554298">(</span><span class="ident" id="1554299">t</span><span class="op" id="1554300">.</span><span class="ident" id="1554301">bucketsize</span><span class="op" id="1554311">)</span><span class="op" id="1554312">)</span><span class="op" id="1554313">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554317">xi</span>&nbsp;<span class="op" id="1554320">:=</span>&nbsp;<span class="num" id="1554323">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554327">yi</span>&nbsp;<span class="op" id="1554330">:=</span>&nbsp;<span class="num" id="1554333">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554337">xk</span>&nbsp;<span class="op" id="1554340">:=</span>&nbsp;<span class="ident" id="1554343">add</span><span class="op" id="1554346">(</span><span class="ident" id="1554347">unsafe</span><span class="op" id="1554353">.</span><span class="ident" id="1554354">Pointer</span><span class="op" id="1554361">(</span><span class="ident" id="1554362">x</span><span class="op" id="1554363">)</span><span class="op" id="1554364">,</span>&nbsp;<span class="ident" id="1554366">dataOffset</span><span class="op" id="1554376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554380">yk</span>&nbsp;<span class="op" id="1554383">:=</span>&nbsp;<span class="ident" id="1554386">add</span><span class="op" id="1554389">(</span><span class="ident" id="1554390">unsafe</span><span class="op" id="1554396">.</span><span class="ident" id="1554397">Pointer</span><span class="op" id="1554404">(</span><span class="ident" id="1554405">y</span><span class="op" id="1554406">)</span><span class="op" id="1554407">,</span>&nbsp;<span class="ident" id="1554409">dataOffset</span><span class="op" id="1554419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554423">xv</span>&nbsp;<span class="op" id="1554426">:=</span>&nbsp;<span class="ident" id="1554429">add</span><span class="op" id="1554432">(</span><span class="ident" id="1554433">xk</span><span class="op" id="1554435">,</span>&nbsp;<span class="ident" id="1554437">bucketCnt</span><span class="op" id="1554446">*</span><span class="builtintype" id="1554447">uintptr</span><span class="op" id="1554454">(</span><span class="ident" id="1554455">t</span><span class="op" id="1554456">.</span><span class="ident" id="1554457">keysize</span><span class="op" id="1554464">)</span><span class="op" id="1554465">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554469">yv</span>&nbsp;<span class="op" id="1554472">:=</span>&nbsp;<span class="ident" id="1554475">add</span><span class="op" id="1554478">(</span><span class="ident" id="1554479">yk</span><span class="op" id="1554481">,</span>&nbsp;<span class="ident" id="1554483">bucketCnt</span><span class="op" id="1554492">*</span><span class="builtintype" id="1554493">uintptr</span><span class="op" id="1554500">(</span><span class="ident" id="1554501">t</span><span class="op" id="1554502">.</span><span class="ident" id="1554503">keysize</span><span class="op" id="1554510">)</span><span class="op" id="1554511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554515">for</span>&nbsp;<span class="op" id="1554519">;</span>&nbsp;<span class="ident" id="1554521">b</span>&nbsp;<span class="op" id="1554523">!=</span>&nbsp;<span class="ident" id="1554526">nil</span><span class="op" id="1554529">;</span>&nbsp;<span class="ident" id="1554531">b</span>&nbsp;<span class="op" id="1554533">=</span>&nbsp;<span class="ident" id="1554535">b</span><span class="op" id="1554536">.</span><span class="ident" id="1554537">overflow</span>&nbsp;<span class="op" id="1554546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554551">k</span>&nbsp;<span class="op" id="1554553">:=</span>&nbsp;<span class="ident" id="1554556">add</span><span class="op" id="1554559">(</span><span class="ident" id="1554560">unsafe</span><span class="op" id="1554566">.</span><span class="ident" id="1554567">Pointer</span><span class="op" id="1554574">(</span><span class="ident" id="1554575">b</span><span class="op" id="1554576">)</span><span class="op" id="1554577">,</span>&nbsp;<span class="ident" id="1554579">dataOffset</span><span class="op" id="1554589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554594">v</span>&nbsp;<span class="op" id="1554596">:=</span>&nbsp;<span class="ident" id="1554599">add</span><span class="op" id="1554602">(</span><span class="ident" id="1554603">k</span><span class="op" id="1554604">,</span>&nbsp;<span class="ident" id="1554606">bucketCnt</span><span class="op" id="1554615">*</span><span class="builtintype" id="1554616">uintptr</span><span class="op" id="1554623">(</span><span class="ident" id="1554624">t</span><span class="op" id="1554625">.</span><span class="ident" id="1554626">keysize</span><span class="op" id="1554633">)</span><span class="op" id="1554634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554639">for</span>&nbsp;<span class="ident" id="1554643">i</span>&nbsp;<span class="op" id="1554645">:=</span>&nbsp;<span class="num" id="1554648">0</span><span class="op" id="1554649">;</span>&nbsp;<span class="ident" id="1554651">i</span>&nbsp;<span class="op" id="1554653">&lt;</span>&nbsp;<span class="ident" id="1554655">bucketCnt</span><span class="op" id="1554664">;</span>&nbsp;<span class="ident" id="1554666">i</span><span class="op" id="1554667">,</span>&nbsp;<span class="ident" id="1554669">k</span><span class="op" id="1554670">,</span>&nbsp;<span class="ident" id="1554672">v</span>&nbsp;<span class="op" id="1554674">=</span>&nbsp;<span class="ident" id="1554676">i</span><span class="op" id="1554677">+</span><span class="num" id="1554678">1</span><span class="op" id="1554679">,</span>&nbsp;<span class="ident" id="1554681">add</span><span class="op" id="1554684">(</span><span class="ident" id="1554685">k</span><span class="op" id="1554686">,</span>&nbsp;<span class="builtintype" id="1554688">uintptr</span><span class="op" id="1554695">(</span><span class="ident" id="1554696">t</span><span class="op" id="1554697">.</span><span class="ident" id="1554698">keysize</span><span class="op" id="1554705">)</span><span class="op" id="1554706">)</span><span class="op" id="1554707">,</span>&nbsp;<span class="ident" id="1554709">add</span><span class="op" id="1554712">(</span><span class="ident" id="1554713">v</span><span class="op" id="1554714">,</span>&nbsp;<span class="builtintype" id="1554716">uintptr</span><span class="op" id="1554723">(</span><span class="ident" id="1554724">t</span><span class="op" id="1554725">.</span><span class="ident" id="1554726">valuesize</span><span class="op" id="1554735">)</span><span class="op" id="1554736">)</span>&nbsp;<span class="op" id="1554738">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554744">top</span>&nbsp;<span class="op" id="1554748">:=</span>&nbsp;<span class="ident" id="1554751">b</span><span class="op" id="1554752">.</span><span class="ident" id="1554753">tophash</span><span class="op" id="1554760">[</span><span class="ident" id="1554761">i</span><span class="op" id="1554762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554768">if</span>&nbsp;<span class="ident" id="1554771">top</span>&nbsp;<span class="op" id="1554775">==</span>&nbsp;<span class="ident" id="1554778">empty</span>&nbsp;<span class="op" id="1554784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554791">b</span><span class="op" id="1554792">.</span><span class="ident" id="1554793">tophash</span><span class="op" id="1554800">[</span><span class="ident" id="1554801">i</span><span class="op" id="1554802">]</span>&nbsp;<span class="op" id="1554804">=</span>&nbsp;<span class="ident" id="1554806">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554826">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554839">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554845">if</span>&nbsp;<span class="ident" id="1554848">top</span>&nbsp;<span class="op" id="1554852">&lt;</span>&nbsp;<span class="ident" id="1554854">minTopHash</span>&nbsp;<span class="op" id="1554865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554872">gothrow</span><span class="op" id="1554879">(</span><span class="string" id="1554880">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1554895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554907">k2</span>&nbsp;<span class="op" id="1554910">:=</span>&nbsp;<span class="ident" id="1554913">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554919">if</span>&nbsp;<span class="ident" id="1554922">t</span><span class="op" id="1554923">.</span><span class="ident" id="1554924">indirectkey</span>&nbsp;<span class="op" id="1554936">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554943">k2</span>&nbsp;<span class="op" id="1554946">=</span>&nbsp;<span class="op" id="1554948">*</span><span class="op" id="1554949">(</span><span class="op" id="1554950">(</span><span class="op" id="1554951">*</span><span class="ident" id="1554952">unsafe</span><span class="op" id="1554958">.</span><span class="ident" id="1554959">Pointer</span><span class="op" id="1554966">)</span><span class="op" id="1554967">(</span><span class="ident" id="1554968">k2</span><span class="op" id="1554970">)</span><span class="op" id="1554971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1554983">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555052">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555108">hash</span>&nbsp;<span class="op" id="1555113">:=</span>&nbsp;<span class="ident" id="1555116">alg</span><span class="op" id="1555119">.</span><span class="ident" id="1555120">hash</span><span class="op" id="1555124">(</span><span class="ident" id="1555125">k2</span><span class="op" id="1555127">,</span>&nbsp;<span class="builtintype" id="1555129">uintptr</span><span class="op" id="1555136">(</span><span class="ident" id="1555137">t</span><span class="op" id="1555138">.</span><span class="ident" id="1555139">key</span><span class="op" id="1555142">.</span><span class="ident" id="1555143">size</span><span class="op" id="1555147">)</span><span class="op" id="1555148">,</span>&nbsp;<span class="builtintype" id="1555150">uintptr</span><span class="op" id="1555157">(</span><span class="ident" id="1555158">h</span><span class="op" id="1555159">.</span><span class="ident" id="1555160">hash0</span><span class="op" id="1555165">)</span><span class="op" id="1555166">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555172">if</span>&nbsp;<span class="ident" id="1555175">h</span><span class="op" id="1555176">.</span><span class="ident" id="1555177">flags</span><span class="op" id="1555182">&amp;</span><span class="ident" id="1555183">iterator</span>&nbsp;<span class="op" id="1555192">!=</span>&nbsp;<span class="num" id="1555195">0</span>&nbsp;<span class="op" id="1555197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555204">if</span>&nbsp;<span class="op" id="1555207">!</span><span class="ident" id="1555208">alg</span><span class="op" id="1555211">.</span><span class="ident" id="1555212">equal</span><span class="op" id="1555217">(</span><span class="ident" id="1555218">k2</span><span class="op" id="1555220">,</span>&nbsp;<span class="ident" id="1555222">k2</span><span class="op" id="1555224">,</span>&nbsp;<span class="builtintype" id="1555226">uintptr</span><span class="op" id="1555233">(</span><span class="ident" id="1555234">t</span><span class="op" id="1555235">.</span><span class="ident" id="1555236">key</span><span class="op" id="1555239">.</span><span class="ident" id="1555240">size</span><span class="op" id="1555244">)</span><span class="op" id="1555245">)</span>&nbsp;<span class="op" id="1555247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555255">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555323">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555390">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555458">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555522">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555574">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555642">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555711">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555781">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555846">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555913">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555944">if</span>&nbsp;<span class="op" id="1555947">(</span><span class="ident" id="1555948">top</span>&nbsp;<span class="op" id="1555952">&amp;</span>&nbsp;<span class="num" id="1555954">1</span><span class="op" id="1555955">)</span>&nbsp;<span class="op" id="1555957">!=</span>&nbsp;<span class="num" id="1555960">0</span>&nbsp;<span class="op" id="1555962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555971">hash</span>&nbsp;<span class="op" id="1555976">|=</span>&nbsp;<span class="ident" id="1555979">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555992">}</span>&nbsp;<span class="keyword" id="1555994">else</span>&nbsp;<span class="op" id="1555999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556008">hash</span>&nbsp;<span class="op" id="1556013">&amp;^=</span>&nbsp;<span class="ident" id="1556017">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556038">top</span>&nbsp;<span class="op" id="1556042">=</span>&nbsp;<span class="builtintype" id="1556044">uint8</span><span class="op" id="1556049">(</span><span class="ident" id="1556050">hash</span>&nbsp;<span class="op" id="1556055">&gt;&gt;</span>&nbsp;<span class="op" id="1556058">(</span><span class="ident" id="1556059">ptrSize</span><span class="op" id="1556066">*</span><span class="num" id="1556067">8</span>&nbsp;<span class="op" id="1556069">-</span>&nbsp;<span class="num" id="1556071">8</span><span class="op" id="1556072">)</span><span class="op" id="1556073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556081">if</span>&nbsp;<span class="ident" id="1556084">top</span>&nbsp;<span class="op" id="1556088">&lt;</span>&nbsp;<span class="ident" id="1556090">minTopHash</span>&nbsp;<span class="op" id="1556101">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556110">top</span>&nbsp;<span class="op" id="1556114">+=</span>&nbsp;<span class="ident" id="1556117">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556153">if</span>&nbsp;<span class="op" id="1556156">(</span><span class="ident" id="1556157">hash</span>&nbsp;<span class="op" id="1556162">&amp;</span>&nbsp;<span class="ident" id="1556164">newbit</span><span class="op" id="1556170">)</span>&nbsp;<span class="op" id="1556172">==</span>&nbsp;<span class="num" id="1556175">0</span>&nbsp;<span class="op" id="1556177">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556184">b</span><span class="op" id="1556185">.</span><span class="ident" id="1556186">tophash</span><span class="op" id="1556193">[</span><span class="ident" id="1556194">i</span><span class="op" id="1556195">]</span>&nbsp;<span class="op" id="1556197">=</span>&nbsp;<span class="ident" id="1556199">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556215">if</span>&nbsp;<span class="ident" id="1556218">xi</span>&nbsp;<span class="op" id="1556221">==</span>&nbsp;<span class="ident" id="1556224">bucketCnt</span>&nbsp;<span class="op" id="1556234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556242">if</span>&nbsp;<span class="ident" id="1556245">checkgc</span>&nbsp;<span class="op" id="1556253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556262">memstats</span><span class="op" id="1556270">.</span><span class="ident" id="1556271">next_gc</span>&nbsp;<span class="op" id="1556279">=</span>&nbsp;<span class="ident" id="1556281">memstats</span><span class="op" id="1556289">.</span><span class="ident" id="1556290">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556307">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556315">newx</span>&nbsp;<span class="op" id="1556320">:=</span>&nbsp;<span class="op" id="1556323">(</span><span class="op" id="1556324">*</span><span class="ident" id="1556325">bmap</span><span class="op" id="1556329">)</span><span class="op" id="1556330">(</span><span class="ident" id="1556331">newobject</span><span class="op" id="1556340">(</span><span class="ident" id="1556341">t</span><span class="op" id="1556342">.</span><span class="ident" id="1556343">bucket</span><span class="op" id="1556349">)</span><span class="op" id="1556350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556358">x</span><span class="op" id="1556359">.</span><span class="ident" id="1556360">overflow</span>&nbsp;<span class="op" id="1556369">=</span>&nbsp;<span class="ident" id="1556371">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556382">x</span>&nbsp;<span class="op" id="1556384">=</span>&nbsp;<span class="ident" id="1556386">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556397">xi</span>&nbsp;<span class="op" id="1556400">=</span>&nbsp;<span class="num" id="1556402">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556410">xk</span>&nbsp;<span class="op" id="1556413">=</span>&nbsp;<span class="ident" id="1556415">add</span><span class="op" id="1556418">(</span><span class="ident" id="1556419">unsafe</span><span class="op" id="1556425">.</span><span class="ident" id="1556426">Pointer</span><span class="op" id="1556433">(</span><span class="ident" id="1556434">x</span><span class="op" id="1556435">)</span><span class="op" id="1556436">,</span>&nbsp;<span class="ident" id="1556438">dataOffset</span><span class="op" id="1556448">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556456">xv</span>&nbsp;<span class="op" id="1556459">=</span>&nbsp;<span class="ident" id="1556461">add</span><span class="op" id="1556464">(</span><span class="ident" id="1556465">xk</span><span class="op" id="1556467">,</span>&nbsp;<span class="ident" id="1556469">bucketCnt</span><span class="op" id="1556478">*</span><span class="builtintype" id="1556479">uintptr</span><span class="op" id="1556486">(</span><span class="ident" id="1556487">t</span><span class="op" id="1556488">.</span><span class="ident" id="1556489">keysize</span><span class="op" id="1556496">)</span><span class="op" id="1556497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556511">x</span><span class="op" id="1556512">.</span><span class="ident" id="1556513">tophash</span><span class="op" id="1556520">[</span><span class="ident" id="1556521">xi</span><span class="op" id="1556523">]</span>&nbsp;<span class="op" id="1556525">=</span>&nbsp;<span class="ident" id="1556527">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556536">if</span>&nbsp;<span class="ident" id="1556539">t</span><span class="op" id="1556540">.</span><span class="ident" id="1556541">indirectkey</span>&nbsp;<span class="op" id="1556553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556561">*</span><span class="op" id="1556562">(</span><span class="op" id="1556563">*</span><span class="ident" id="1556564">unsafe</span><span class="op" id="1556570">.</span><span class="ident" id="1556571">Pointer</span><span class="op" id="1556578">)</span><span class="op" id="1556579">(</span><span class="ident" id="1556580">xk</span><span class="op" id="1556582">)</span>&nbsp;<span class="op" id="1556584">=</span>&nbsp;<span class="ident" id="1556586">k2</span>&nbsp;<span class="comment" id="1556589">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556610">}</span>&nbsp;<span class="keyword" id="1556612">else</span>&nbsp;<span class="op" id="1556617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556625">memmove</span><span class="op" id="1556632">(</span><span class="ident" id="1556633">xk</span><span class="op" id="1556635">,</span>&nbsp;<span class="ident" id="1556637">k</span><span class="op" id="1556638">,</span>&nbsp;<span class="builtintype" id="1556640">uintptr</span><span class="op" id="1556647">(</span><span class="ident" id="1556648">t</span><span class="op" id="1556649">.</span><span class="ident" id="1556650">key</span><span class="op" id="1556653">.</span><span class="ident" id="1556654">size</span><span class="op" id="1556658">)</span><span class="op" id="1556659">)</span>&nbsp;<span class="comment" id="1556661">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556687">if</span>&nbsp;<span class="ident" id="1556690">t</span><span class="op" id="1556691">.</span><span class="ident" id="1556692">indirectvalue</span>&nbsp;<span class="op" id="1556706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556714">*</span><span class="op" id="1556715">(</span><span class="op" id="1556716">*</span><span class="ident" id="1556717">unsafe</span><span class="op" id="1556723">.</span><span class="ident" id="1556724">Pointer</span><span class="op" id="1556731">)</span><span class="op" id="1556732">(</span><span class="ident" id="1556733">xv</span><span class="op" id="1556735">)</span>&nbsp;<span class="op" id="1556737">=</span>&nbsp;<span class="op" id="1556739">*</span><span class="op" id="1556740">(</span><span class="op" id="1556741">*</span><span class="ident" id="1556742">unsafe</span><span class="op" id="1556748">.</span><span class="ident" id="1556749">Pointer</span><span class="op" id="1556756">)</span><span class="op" id="1556757">(</span><span class="ident" id="1556758">v</span><span class="op" id="1556759">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556766">}</span>&nbsp;<span class="keyword" id="1556768">else</span>&nbsp;<span class="op" id="1556773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556781">memmove</span><span class="op" id="1556788">(</span><span class="ident" id="1556789">xv</span><span class="op" id="1556791">,</span>&nbsp;<span class="ident" id="1556793">v</span><span class="op" id="1556794">,</span>&nbsp;<span class="builtintype" id="1556796">uintptr</span><span class="op" id="1556803">(</span><span class="ident" id="1556804">t</span><span class="op" id="1556805">.</span><span class="ident" id="1556806">elem</span><span class="op" id="1556810">.</span><span class="ident" id="1556811">size</span><span class="op" id="1556815">)</span><span class="op" id="1556816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556830">xi</span><span class="op" id="1556832">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556840">xk</span>&nbsp;<span class="op" id="1556843">=</span>&nbsp;<span class="ident" id="1556845">add</span><span class="op" id="1556848">(</span><span class="ident" id="1556849">xk</span><span class="op" id="1556851">,</span>&nbsp;<span class="builtintype" id="1556853">uintptr</span><span class="op" id="1556860">(</span><span class="ident" id="1556861">t</span><span class="op" id="1556862">.</span><span class="ident" id="1556863">keysize</span><span class="op" id="1556870">)</span><span class="op" id="1556871">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556878">xv</span>&nbsp;<span class="op" id="1556881">=</span>&nbsp;<span class="ident" id="1556883">add</span><span class="op" id="1556886">(</span><span class="ident" id="1556887">xv</span><span class="op" id="1556889">,</span>&nbsp;<span class="builtintype" id="1556891">uintptr</span><span class="op" id="1556898">(</span><span class="ident" id="1556899">t</span><span class="op" id="1556900">.</span><span class="ident" id="1556901">valuesize</span><span class="op" id="1556910">)</span><span class="op" id="1556911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556917">}</span>&nbsp;<span class="keyword" id="1556919">else</span>&nbsp;<span class="op" id="1556924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556931">b</span><span class="op" id="1556932">.</span><span class="ident" id="1556933">tophash</span><span class="op" id="1556940">[</span><span class="ident" id="1556941">i</span><span class="op" id="1556942">]</span>&nbsp;<span class="op" id="1556944">=</span>&nbsp;<span class="ident" id="1556946">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556962">if</span>&nbsp;<span class="ident" id="1556965">yi</span>&nbsp;<span class="op" id="1556968">==</span>&nbsp;<span class="ident" id="1556971">bucketCnt</span>&nbsp;<span class="op" id="1556981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556989">if</span>&nbsp;<span class="ident" id="1556992">checkgc</span>&nbsp;<span class="op" id="1557000">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557009">memstats</span><span class="op" id="1557017">.</span><span class="ident" id="1557018">next_gc</span>&nbsp;<span class="op" id="1557026">=</span>&nbsp;<span class="ident" id="1557028">memstats</span><span class="op" id="1557036">.</span><span class="ident" id="1557037">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557062">newy</span>&nbsp;<span class="op" id="1557067">:=</span>&nbsp;<span class="op" id="1557070">(</span><span class="op" id="1557071">*</span><span class="ident" id="1557072">bmap</span><span class="op" id="1557076">)</span><span class="op" id="1557077">(</span><span class="ident" id="1557078">newobject</span><span class="op" id="1557087">(</span><span class="ident" id="1557088">t</span><span class="op" id="1557089">.</span><span class="ident" id="1557090">bucket</span><span class="op" id="1557096">)</span><span class="op" id="1557097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557105">y</span><span class="op" id="1557106">.</span><span class="ident" id="1557107">overflow</span>&nbsp;<span class="op" id="1557116">=</span>&nbsp;<span class="ident" id="1557118">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557129">y</span>&nbsp;<span class="op" id="1557131">=</span>&nbsp;<span class="ident" id="1557133">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557144">yi</span>&nbsp;<span class="op" id="1557147">=</span>&nbsp;<span class="num" id="1557149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557157">yk</span>&nbsp;<span class="op" id="1557160">=</span>&nbsp;<span class="ident" id="1557162">add</span><span class="op" id="1557165">(</span><span class="ident" id="1557166">unsafe</span><span class="op" id="1557172">.</span><span class="ident" id="1557173">Pointer</span><span class="op" id="1557180">(</span><span class="ident" id="1557181">y</span><span class="op" id="1557182">)</span><span class="op" id="1557183">,</span>&nbsp;<span class="ident" id="1557185">dataOffset</span><span class="op" id="1557195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557203">yv</span>&nbsp;<span class="op" id="1557206">=</span>&nbsp;<span class="ident" id="1557208">add</span><span class="op" id="1557211">(</span><span class="ident" id="1557212">yk</span><span class="op" id="1557214">,</span>&nbsp;<span class="ident" id="1557216">bucketCnt</span><span class="op" id="1557225">*</span><span class="builtintype" id="1557226">uintptr</span><span class="op" id="1557233">(</span><span class="ident" id="1557234">t</span><span class="op" id="1557235">.</span><span class="ident" id="1557236">keysize</span><span class="op" id="1557243">)</span><span class="op" id="1557244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557258">y</span><span class="op" id="1557259">.</span><span class="ident" id="1557260">tophash</span><span class="op" id="1557267">[</span><span class="ident" id="1557268">yi</span><span class="op" id="1557270">]</span>&nbsp;<span class="op" id="1557272">=</span>&nbsp;<span class="ident" id="1557274">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557283">if</span>&nbsp;<span class="ident" id="1557286">t</span><span class="op" id="1557287">.</span><span class="ident" id="1557288">indirectkey</span>&nbsp;<span class="op" id="1557300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557308">*</span><span class="op" id="1557309">(</span><span class="op" id="1557310">*</span><span class="ident" id="1557311">unsafe</span><span class="op" id="1557317">.</span><span class="ident" id="1557318">Pointer</span><span class="op" id="1557325">)</span><span class="op" id="1557326">(</span><span class="ident" id="1557327">yk</span><span class="op" id="1557329">)</span>&nbsp;<span class="op" id="1557331">=</span>&nbsp;<span class="ident" id="1557333">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557341">}</span>&nbsp;<span class="keyword" id="1557343">else</span>&nbsp;<span class="op" id="1557348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557356">memmove</span><span class="op" id="1557363">(</span><span class="ident" id="1557364">yk</span><span class="op" id="1557366">,</span>&nbsp;<span class="ident" id="1557368">k</span><span class="op" id="1557369">,</span>&nbsp;<span class="builtintype" id="1557371">uintptr</span><span class="op" id="1557378">(</span><span class="ident" id="1557379">t</span><span class="op" id="1557380">.</span><span class="ident" id="1557381">key</span><span class="op" id="1557384">.</span><span class="ident" id="1557385">size</span><span class="op" id="1557389">)</span><span class="op" id="1557390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557397">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557404">if</span>&nbsp;<span class="ident" id="1557407">t</span><span class="op" id="1557408">.</span><span class="ident" id="1557409">indirectvalue</span>&nbsp;<span class="op" id="1557423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557431">*</span><span class="op" id="1557432">(</span><span class="op" id="1557433">*</span><span class="ident" id="1557434">unsafe</span><span class="op" id="1557440">.</span><span class="ident" id="1557441">Pointer</span><span class="op" id="1557448">)</span><span class="op" id="1557449">(</span><span class="ident" id="1557450">yv</span><span class="op" id="1557452">)</span>&nbsp;<span class="op" id="1557454">=</span>&nbsp;<span class="op" id="1557456">*</span><span class="op" id="1557457">(</span><span class="op" id="1557458">*</span><span class="ident" id="1557459">unsafe</span><span class="op" id="1557465">.</span><span class="ident" id="1557466">Pointer</span><span class="op" id="1557473">)</span><span class="op" id="1557474">(</span><span class="ident" id="1557475">v</span><span class="op" id="1557476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557483">}</span>&nbsp;<span class="keyword" id="1557485">else</span>&nbsp;<span class="op" id="1557490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557498">memmove</span><span class="op" id="1557505">(</span><span class="ident" id="1557506">yv</span><span class="op" id="1557508">,</span>&nbsp;<span class="ident" id="1557510">v</span><span class="op" id="1557511">,</span>&nbsp;<span class="builtintype" id="1557513">uintptr</span><span class="op" id="1557520">(</span><span class="ident" id="1557521">t</span><span class="op" id="1557522">.</span><span class="ident" id="1557523">elem</span><span class="op" id="1557527">.</span><span class="ident" id="1557528">size</span><span class="op" id="1557532">)</span><span class="op" id="1557533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557540">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557547">yi</span><span class="op" id="1557549">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557557">yk</span>&nbsp;<span class="op" id="1557560">=</span>&nbsp;<span class="ident" id="1557562">add</span><span class="op" id="1557565">(</span><span class="ident" id="1557566">yk</span><span class="op" id="1557568">,</span>&nbsp;<span class="builtintype" id="1557570">uintptr</span><span class="op" id="1557577">(</span><span class="ident" id="1557578">t</span><span class="op" id="1557579">.</span><span class="ident" id="1557580">keysize</span><span class="op" id="1557587">)</span><span class="op" id="1557588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557595">yv</span>&nbsp;<span class="op" id="1557598">=</span>&nbsp;<span class="ident" id="1557600">add</span><span class="op" id="1557603">(</span><span class="ident" id="1557604">yv</span><span class="op" id="1557606">,</span>&nbsp;<span class="builtintype" id="1557608">uintptr</span><span class="op" id="1557615">(</span><span class="ident" id="1557616">t</span><span class="op" id="1557617">.</span><span class="ident" id="1557618">valuesize</span><span class="op" id="1557627">)</span><span class="op" id="1557628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557639">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557647">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557710">if</span>&nbsp;<span class="ident" id="1557713">h</span><span class="op" id="1557714">.</span><span class="ident" id="1557715">flags</span><span class="op" id="1557720">&amp;</span><span class="ident" id="1557721">oldIterator</span>&nbsp;<span class="op" id="1557733">==</span>&nbsp;<span class="num" id="1557736">0</span>&nbsp;<span class="op" id="1557738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557743">b</span>&nbsp;<span class="op" id="1557745">=</span>&nbsp;<span class="op" id="1557747">(</span><span class="op" id="1557748">*</span><span class="ident" id="1557749">bmap</span><span class="op" id="1557753">)</span><span class="op" id="1557754">(</span><span class="ident" id="1557755">add</span><span class="op" id="1557758">(</span><span class="ident" id="1557759">h</span><span class="op" id="1557760">.</span><span class="ident" id="1557761">oldbuckets</span><span class="op" id="1557771">,</span>&nbsp;<span class="ident" id="1557773">oldbucket</span><span class="op" id="1557782">*</span><span class="builtintype" id="1557783">uintptr</span><span class="op" id="1557790">(</span><span class="ident" id="1557791">t</span><span class="op" id="1557792">.</span><span class="ident" id="1557793">bucketsize</span><span class="op" id="1557803">)</span><span class="op" id="1557804">)</span><span class="op" id="1557805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557810">b</span><span class="op" id="1557811">.</span><span class="ident" id="1557812">overflow</span>&nbsp;<span class="op" id="1557821">=</span>&nbsp;<span class="ident" id="1557823">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557830">memclr</span><span class="op" id="1557836">(</span><span class="ident" id="1557837">add</span><span class="op" id="1557840">(</span><span class="ident" id="1557841">unsafe</span><span class="op" id="1557847">.</span><span class="ident" id="1557848">Pointer</span><span class="op" id="1557855">(</span><span class="ident" id="1557856">b</span><span class="op" id="1557857">)</span><span class="op" id="1557858">,</span>&nbsp;<span class="ident" id="1557860">dataOffset</span><span class="op" id="1557870">)</span><span class="op" id="1557871">,</span>&nbsp;<span class="builtintype" id="1557873">uintptr</span><span class="op" id="1557880">(</span><span class="ident" id="1557881">t</span><span class="op" id="1557882">.</span><span class="ident" id="1557883">bucketsize</span><span class="op" id="1557893">)</span><span class="op" id="1557894">-</span><span class="ident" id="1557895">dataOffset</span><span class="op" id="1557905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557916">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557944">if</span>&nbsp;<span class="ident" id="1557947">oldbucket</span>&nbsp;<span class="op" id="1557957">==</span>&nbsp;<span class="ident" id="1557960">h</span><span class="op" id="1557961">.</span><span class="ident" id="1557962">nevacuate</span>&nbsp;<span class="op" id="1557972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557976">h</span><span class="op" id="1557977">.</span><span class="ident" id="1557978">nevacuate</span>&nbsp;<span class="op" id="1557988">=</span>&nbsp;<span class="ident" id="1557990">oldbucket</span>&nbsp;<span class="op" id="1558000">+</span>&nbsp;<span class="num" id="1558002">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558006">if</span>&nbsp;<span class="ident" id="1558009">oldbucket</span><span class="op" id="1558018">+</span><span class="num" id="1558019">1</span>&nbsp;<span class="op" id="1558021">==</span>&nbsp;<span class="ident" id="1558024">newbit</span>&nbsp;<span class="op" id="1558031">{</span>&nbsp;<span class="comment" id="1558033">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1558065">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558121">h</span><span class="op" id="1558122">.</span><span class="ident" id="1558123">oldbuckets</span>&nbsp;<span class="op" id="1558134">=</span>&nbsp;<span class="ident" id="1558136">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1558142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1558145">}</span><br>
<span class="lineno"></span><span class="op" id="1558147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558150">func</span>&nbsp;<span class="ident" id="1558155">ismapkey</span><span class="op" id="1558163">(</span><span class="ident" id="1558164">t</span>&nbsp;<span class="op" id="1558166">*</span><span class="ident" id="1558167">_type</span><span class="op" id="1558172">)</span>&nbsp;<span class="builtintype" id="1558174">bool</span>&nbsp;<span class="op" id="1558179">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558182">return</span>&nbsp;<span class="ident" id="1558189">goalg</span><span class="op" id="1558194">(</span><span class="ident" id="1558195">t</span><span class="op" id="1558196">.</span><span class="ident" id="1558197">alg</span><span class="op" id="1558200">)</span><span class="op" id="1558201">.</span><span class="ident" id="1558202">hash</span>&nbsp;<span class="op" id="1558207">!=</span>&nbsp;<span class="ident" id="1558210">nil</span><br>
<span class="lineno"></span><span class="op" id="1558214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1558217">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1558268">func</span>&nbsp;<span class="ident" id="1558273">reflect_makemap</span><span class="op" id="1558288">(</span><span class="ident" id="1558289">t</span>&nbsp;<span class="op" id="1558291">*</span><span class="ident" id="1558292">maptype</span><span class="op" id="1558299">)</span>&nbsp;<span class="op" id="1558301">*</span><span class="ident" id="1558302">hmap</span>&nbsp;<span class="op" id="1558307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558310">return</span>&nbsp;<span class="ident" id="1558317">makemap</span><span class="op" id="1558324">(</span><span class="ident" id="1558325">t</span><span class="op" id="1558326">,</span>&nbsp;<span class="num" id="1558328">0</span><span class="op" id="1558329">)</span><br>
<span class="lineno"></span><span class="op" id="1558331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558334">func</span>&nbsp;<span class="ident" id="1558339">reflect_mapaccess</span><span class="op" id="1558356">(</span><span class="ident" id="1558357">t</span>&nbsp;<span class="op" id="1558359">*</span><span class="ident" id="1558360">maptype</span><span class="op" id="1558367">,</span>&nbsp;<span class="ident" id="1558369">h</span>&nbsp;<span class="op" id="1558371">*</span><span class="ident" id="1558372">hmap</span><span class="op" id="1558376">,</span>&nbsp;<span class="ident" id="1558378">key</span>&nbsp;<span class="ident" id="1558382">unsafe</span><span class="op" id="1558388">.</span><span class="ident" id="1558389">Pointer</span><span class="op" id="1558396">)</span>&nbsp;<span class="ident" id="1558398">unsafe</span><span class="op" id="1558404">.</span><span class="ident" id="1558405">Pointer</span>&nbsp;<span class="op" id="1558413">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558416">val</span><span class="op" id="1558419">,</span>&nbsp;<span class="ident" id="1558421">ok</span>&nbsp;<span class="op" id="1558424">:=</span>&nbsp;<span class="ident" id="1558427">mapaccess2</span><span class="op" id="1558437">(</span><span class="ident" id="1558438">t</span><span class="op" id="1558439">,</span>&nbsp;<span class="ident" id="1558441">h</span><span class="op" id="1558442">,</span>&nbsp;<span class="ident" id="1558444">key</span><span class="op" id="1558447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558450">if</span>&nbsp;<span class="op" id="1558453">!</span><span class="ident" id="1558454">ok</span>&nbsp;<span class="op" id="1558457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1558461">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558506">val</span>&nbsp;<span class="op" id="1558510">=</span>&nbsp;<span class="ident" id="1558512">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1558517">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558520">return</span>&nbsp;<span class="ident" id="1558527">val</span><br>
<span class="lineno"></span><span class="op" id="1558531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558534">func</span>&nbsp;<span class="ident" id="1558539">reflect_mapassign</span><span class="op" id="1558556">(</span><span class="ident" id="1558557">t</span>&nbsp;<span class="op" id="1558559">*</span><span class="ident" id="1558560">maptype</span><span class="op" id="1558567">,</span>&nbsp;<span class="ident" id="1558569">h</span>&nbsp;<span class="op" id="1558571">*</span><span class="ident" id="1558572">hmap</span><span class="op" id="1558576">,</span>&nbsp;<span class="ident" id="1558578">key</span>&nbsp;<span class="ident" id="1558582">unsafe</span><span class="op" id="1558588">.</span><span class="ident" id="1558589">Pointer</span><span class="op" id="1558596">,</span>&nbsp;<span class="ident" id="1558598">val</span>&nbsp;<span class="ident" id="1558602">unsafe</span><span class="op" id="1558608">.</span><span class="ident" id="1558609">Pointer</span><span class="op" id="1558616">)</span>&nbsp;<span class="op" id="1558618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558621">mapassign1</span><span class="op" id="1558631">(</span><span class="ident" id="1558632">t</span><span class="op" id="1558633">,</span>&nbsp;<span class="ident" id="1558635">h</span><span class="op" id="1558636">,</span>&nbsp;<span class="ident" id="1558638">key</span><span class="op" id="1558641">,</span>&nbsp;<span class="ident" id="1558643">val</span><span class="op" id="1558646">)</span><br>
<span class="lineno">920</span><span class="op" id="1558648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558651">func</span>&nbsp;<span class="ident" id="1558656">reflect_mapdelete</span><span class="op" id="1558673">(</span><span class="ident" id="1558674">t</span>&nbsp;<span class="op" id="1558676">*</span><span class="ident" id="1558677">maptype</span><span class="op" id="1558684">,</span>&nbsp;<span class="ident" id="1558686">h</span>&nbsp;<span class="op" id="1558688">*</span><span class="ident" id="1558689">hmap</span><span class="op" id="1558693">,</span>&nbsp;<span class="ident" id="1558695">key</span>&nbsp;<span class="ident" id="1558699">unsafe</span><span class="op" id="1558705">.</span><span class="ident" id="1558706">Pointer</span><span class="op" id="1558713">)</span>&nbsp;<span class="op" id="1558715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558718">mapdelete</span><span class="op" id="1558727">(</span><span class="ident" id="1558728">t</span><span class="op" id="1558729">,</span>&nbsp;<span class="ident" id="1558731">h</span><span class="op" id="1558732">,</span>&nbsp;<span class="ident" id="1558734">key</span><span class="op" id="1558737">)</span><br>
<span class="lineno"></span><span class="op" id="1558739">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1558742">func</span>&nbsp;<span class="ident" id="1558747">reflect_mapiterinit</span><span class="op" id="1558766">(</span><span class="ident" id="1558767">t</span>&nbsp;<span class="op" id="1558769">*</span><span class="ident" id="1558770">maptype</span><span class="op" id="1558777">,</span>&nbsp;<span class="ident" id="1558779">h</span>&nbsp;<span class="op" id="1558781">*</span><span class="ident" id="1558782">hmap</span><span class="op" id="1558786">)</span>&nbsp;<span class="op" id="1558788">*</span><span class="ident" id="1558789">hiter</span>&nbsp;<span class="op" id="1558795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558798">it</span>&nbsp;<span class="op" id="1558801">:=</span>&nbsp;<span class="builtinfunc" id="1558804">new</span><span class="op" id="1558807">(</span><span class="ident" id="1558808">hiter</span><span class="op" id="1558813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558816">mapiterinit</span><span class="op" id="1558827">(</span><span class="ident" id="1558828">t</span><span class="op" id="1558829">,</span>&nbsp;<span class="ident" id="1558831">h</span><span class="op" id="1558832">,</span>&nbsp;<span class="ident" id="1558834">it</span><span class="op" id="1558836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558839">return</span>&nbsp;<span class="ident" id="1558846">it</span><br>
<span class="lineno">930</span><span class="op" id="1558849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558852">func</span>&nbsp;<span class="ident" id="1558857">reflect_mapiternext</span><span class="op" id="1558876">(</span><span class="ident" id="1558877">it</span>&nbsp;<span class="op" id="1558880">*</span><span class="ident" id="1558881">hiter</span><span class="op" id="1558886">)</span>&nbsp;<span class="op" id="1558888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558891">mapiternext</span><span class="op" id="1558902">(</span><span class="ident" id="1558903">it</span><span class="op" id="1558905">)</span><br>
<span class="lineno"></span><span class="op" id="1558907">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1558910">func</span>&nbsp;<span class="ident" id="1558915">reflect_mapiterkey</span><span class="op" id="1558933">(</span><span class="ident" id="1558934">it</span>&nbsp;<span class="op" id="1558937">*</span><span class="ident" id="1558938">hiter</span><span class="op" id="1558943">)</span>&nbsp;<span class="ident" id="1558945">unsafe</span><span class="op" id="1558951">.</span><span class="ident" id="1558952">Pointer</span>&nbsp;<span class="op" id="1558960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558963">return</span>&nbsp;<span class="ident" id="1558970">it</span><span class="op" id="1558972">.</span><span class="ident" id="1558973">key</span><br>
<span class="lineno"></span><span class="op" id="1558977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1558980">func</span>&nbsp;<span class="ident" id="1558985">reflect_maplen</span><span class="op" id="1558999">(</span><span class="ident" id="1559000">h</span>&nbsp;<span class="op" id="1559002">*</span><span class="ident" id="1559003">hmap</span><span class="op" id="1559007">)</span>&nbsp;<span class="builtintype" id="1559009">int</span>&nbsp;<span class="op" id="1559013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1559016">if</span>&nbsp;<span class="ident" id="1559019">h</span>&nbsp;<span class="op" id="1559021">==</span>&nbsp;<span class="ident" id="1559024">nil</span>&nbsp;<span class="op" id="1559028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1559032">return</span>&nbsp;<span class="num" id="1559039">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1559042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1559045">if</span>&nbsp;<span class="ident" id="1559048">raceenabled</span>&nbsp;<span class="op" id="1559060">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1559064">callerpc</span>&nbsp;<span class="op" id="1559073">:=</span>&nbsp;<span class="ident" id="1559076">getcallerpc</span><span class="op" id="1559087">(</span><span class="ident" id="1559088">unsafe</span><span class="op" id="1559094">.</span><span class="ident" id="1559095">Pointer</span><span class="op" id="1559102">(</span><span class="op" id="1559103">&amp;</span><span class="ident" id="1559104">h</span><span class="op" id="1559105">)</span><span class="op" id="1559106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1559110">racereadpc</span><span class="op" id="1559120">(</span><span class="ident" id="1559121">unsafe</span><span class="op" id="1559127">.</span><span class="ident" id="1559128">Pointer</span><span class="op" id="1559135">(</span><span class="ident" id="1559136">h</span><span class="op" id="1559137">)</span><span class="op" id="1559138">,</span>&nbsp;<span class="ident" id="1559140">callerpc</span><span class="op" id="1559148">,</span>&nbsp;<span class="ident" id="1559150">funcPC</span><span class="op" id="1559156">(</span><span class="ident" id="1559157">reflect_maplen</span><span class="op" id="1559171">)</span><span class="op" id="1559172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1559175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1559178">return</span>&nbsp;<span class="ident" id="1559185">h</span><span class="op" id="1559186">.</span><span class="ident" id="1559187">count</span><br>
<span class="lineno"></span><span class="op" id="1559193">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1559196">func</span>&nbsp;<span class="ident" id="1559201">reflect_ismapkey</span><span class="op" id="1559217">(</span><span class="ident" id="1559218">t</span>&nbsp;<span class="op" id="1559220">*</span><span class="ident" id="1559221">_type</span><span class="op" id="1559226">)</span>&nbsp;<span class="builtintype" id="1559228">bool</span>&nbsp;<span class="op" id="1559233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1559236">return</span>&nbsp;<span class="ident" id="1559243">ismapkey</span><span class="op" id="1559251">(</span><span class="ident" id="1559252">t</span><span class="op" id="1559253">)</span><br>
<span class="lineno"></span><span class="op" id="1559255">}</span>
</div>
</body>
</html>
