<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno">10</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;Dialer&nbsp;contains&nbsp;options&nbsp;for&nbsp;connecting&nbsp;to&nbsp;an&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;each&nbsp;field&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;dialing</span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;without&nbsp;that&nbsp;option.&nbsp;Dialing&nbsp;with&nbsp;the&nbsp;zero&nbsp;value&nbsp;of&nbsp;Dialer</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;therefore&nbsp;equivalent&nbsp;to&nbsp;just&nbsp;calling&nbsp;the&nbsp;Dial&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Dialer</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Timeout&nbsp;is&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;a&nbsp;dial&nbsp;will&nbsp;wait&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;a&nbsp;connect&nbsp;to&nbsp;complete.&nbsp;If&nbsp;Deadline&nbsp;is&nbsp;also&nbsp;set,&nbsp;it&nbsp;may&nbsp;fail</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;earlier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;default&nbsp;is&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;With&nbsp;or&nbsp;without&nbsp;a&nbsp;timeout,&nbsp;the&nbsp;operating&nbsp;system&nbsp;may&nbsp;impose</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;its&nbsp;own&nbsp;earlier&nbsp;timeout.&nbsp;For&nbsp;instance,&nbsp;TCP&nbsp;timeouts&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;often&nbsp;around&nbsp;3&nbsp;minutes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Timeout</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Deadline&nbsp;is&nbsp;the&nbsp;absolute&nbsp;point&nbsp;in&nbsp;time&nbsp;after&nbsp;which&nbsp;dials</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;will&nbsp;fail.&nbsp;If&nbsp;Timeout&nbsp;is&nbsp;set,&nbsp;it&nbsp;may&nbsp;fail&nbsp;earlier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Zero&nbsp;means&nbsp;no&nbsp;deadline,&nbsp;or&nbsp;dependent&nbsp;on&nbsp;the&nbsp;operating&nbsp;system</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;as&nbsp;with&nbsp;the&nbsp;Timeout&nbsp;option.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;LocalAddr&nbsp;is&nbsp;the&nbsp;local&nbsp;address&nbsp;to&nbsp;use&nbsp;when&nbsp;dialing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;address.&nbsp;The&nbsp;address&nbsp;must&nbsp;be&nbsp;of&nbsp;a&nbsp;compatible&nbsp;type&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;network&nbsp;being&nbsp;dialed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;nil,&nbsp;a&nbsp;local&nbsp;address&nbsp;is&nbsp;automatically&nbsp;chosen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">LocalAddr</span>&nbsp;<span class="ident">Addr</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;DualStack&nbsp;allows&nbsp;a&nbsp;single&nbsp;dial&nbsp;to&nbsp;attempt&nbsp;to&nbsp;establish</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;multiple&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections&nbsp;and&nbsp;to&nbsp;return&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;established&nbsp;connection&nbsp;when&nbsp;the&nbsp;network&nbsp;is&nbsp;&#34;tcp&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;destination&nbsp;is&nbsp;a&nbsp;host&nbsp;name&nbsp;that&nbsp;has&nbsp;multiple&nbsp;address&nbsp;family</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;DNS&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">DualStack</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;KeepAlive&nbsp;specifies&nbsp;the&nbsp;keep-alive&nbsp;period&nbsp;for&nbsp;an&nbsp;active</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;network&nbsp;connection.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;zero,&nbsp;keep-alives&nbsp;are&nbsp;not&nbsp;enabled.&nbsp;Network&nbsp;protocols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;do&nbsp;not&nbsp;support&nbsp;keep-alives&nbsp;ignore&nbsp;this&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">KeepAlive</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment">//&nbsp;Return&nbsp;either&nbsp;now+Timeout&nbsp;or&nbsp;Deadline,&nbsp;whichever&nbsp;comes&nbsp;first.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Or&nbsp;zero,&nbsp;if&nbsp;neither&nbsp;is&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">Dialer</span><span class="op">)</span>&nbsp;<span class="ident">deadline</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Timeout</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Deadline</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">timeoutDeadline</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">Timeout</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Deadline</span><span class="op">.</span><span class="ident">IsZero</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">timeoutDeadline</span><span class="op">.</span><span class="ident">Before</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">Deadline</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">timeoutDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">parseNetwork</span><span class="op">(</span><span class="ident">net</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">afnet</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">proto</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">last</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="string">&#39;:&#39;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;no&nbsp;colon</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;ip&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">UnknownNetworkError</span><span class="op">(</span><span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">afnet</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">net</span><span class="op">[</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">afnet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;ip&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;ip6&#34;</span><span class="op">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">protostr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">net</span><span class="op">[</span><span class="ident">i</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dtoi</span><span class="op">(</span><span class="ident">protostr</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">protostr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">lookupProtocol</span><span class="op">(</span><span class="ident">protostr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">afnet</span><span class="op">,</span>&nbsp;<span class="ident">proto</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">UnknownNetworkError</span><span class="op">(</span><span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">resolveAddr</span><span class="op">(</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">netaddr</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">afnet</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">parseNetwork</span><span class="op">(</span><span class="ident">net</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;dial&#34;</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errMissingAddress</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">afnet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ResolveUnixAddr</span><span class="op">(</span><span class="ident">afnet</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">resolveInternetAddr</span><span class="op">(</span><span class="ident">afnet</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;address&nbsp;on&nbsp;the&nbsp;named&nbsp;network.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">115</span><span class="comment">//&nbsp;Known&nbsp;networks&nbsp;are&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;&nbsp;(IPv4-only),&nbsp;&#34;tcp6&#34;&nbsp;(IPv6-only),</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#34;udp&#34;,&nbsp;&#34;udp4&#34;&nbsp;(IPv4-only),&nbsp;&#34;udp6&#34;&nbsp;(IPv6-only),&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(IPv4-only),&nbsp;&#34;ip6&#34;&nbsp;(IPv6-only),&nbsp;&#34;unix&#34;,&nbsp;&#34;unixgram&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#34;unixpacket&#34;.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">120</span><span class="comment">//&nbsp;For&nbsp;TCP&nbsp;and&nbsp;UDP&nbsp;networks,&nbsp;addresses&nbsp;have&nbsp;the&nbsp;form&nbsp;host:port.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;host&nbsp;is&nbsp;a&nbsp;literal&nbsp;IPv6&nbsp;address&nbsp;it&nbsp;must&nbsp;be&nbsp;enclosed</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;square&nbsp;brackets&nbsp;as&nbsp;in&nbsp;&#34;[::1]:80&#34;&nbsp;or&nbsp;&#34;[ipv6-host%zone]:80&#34;.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;functions&nbsp;JoinHostPort&nbsp;and&nbsp;SplitHostPort&nbsp;manipulate&nbsp;addresses</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;this&nbsp;form.</span><br>
<span class="lineno">125</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspDial(&#34;tcp&#34;,&nbsp;&#34;12.34.56.78:80&#34;)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspDial(&#34;tcp&#34;,&nbsp;&#34;google.com:http&#34;)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspDial(&#34;tcp&#34;,&nbsp;&#34;[2001:db8::1]:http&#34;)</span><br>
<span class="lineno">130</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspDial(&#34;tcp&#34;,&nbsp;&#34;[fe80::1%lo0]:80&#34;)</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;For&nbsp;IP&nbsp;networks,&nbsp;the&nbsp;network&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;a&nbsp;colon&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name&nbsp;and&nbsp;the&nbsp;addr&nbsp;must&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;literal&nbsp;IP&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspDial(&#34;ip4:1&#34;,&nbsp;&#34;127.0.0.1&#34;)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspDial(&#34;ip6:ospf&#34;,&nbsp;&#34;::1&#34;)</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">140</span><span class="comment">//&nbsp;For&nbsp;Unix&nbsp;networks,&nbsp;the&nbsp;address&nbsp;must&nbsp;be&nbsp;a&nbsp;file&nbsp;system&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">d</span>&nbsp;<span class="ident">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DialTimeout&nbsp;acts&nbsp;like&nbsp;Dial&nbsp;but&nbsp;takes&nbsp;a&nbsp;timeout.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;timeout&nbsp;includes&nbsp;name&nbsp;resolution,&nbsp;if&nbsp;required.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">DialTimeout</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">timeout</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Dialer</span><span class="op">{</span><span class="ident">Timeout</span><span class="op">:</span>&nbsp;<span class="ident">timeout</span><span class="op">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;address&nbsp;on&nbsp;the&nbsp;named&nbsp;network.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">155</span><span class="comment">//&nbsp;See&nbsp;func&nbsp;Dial&nbsp;for&nbsp;a&nbsp;description&nbsp;of&nbsp;the&nbsp;network&nbsp;and&nbsp;address</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">d</span>&nbsp;<span class="op">*</span><span class="ident">Dialer</span><span class="op">)</span>&nbsp;<span class="ident">Dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">resolveAddr</span><span class="op">(</span><span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">deadline</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dialer</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dialSingle</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">LocalAddr</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">.</span><span class="ident">toAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ras</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ra</span><span class="op">.</span><span class="op">(</span><span class="ident">addrList</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">DualStack</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">network</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;tcp&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dialer</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dialMulti</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">address</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">LocalAddr</span><span class="op">,</span>&nbsp;<span class="ident">ras</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dial</span><span class="op">(</span><span class="ident">network</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">.</span><span class="ident">toAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">dialer</span><span class="op">,</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">deadline</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">KeepAlive</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tc</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPConn</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tc</span><span class="op">.</span><span class="ident">SetKeepAlive</span><span class="op">(</span><span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tc</span><span class="op">.</span><span class="ident">SetKeepAlivePeriod</span><span class="op">(</span><span class="ident">d</span><span class="op">.</span><span class="ident">KeepAlive</span><span class="op">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testHookSetKeepAlive</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">testHookSetKeepAlive</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><span class="op">}</span>&nbsp;<span class="comment">//&nbsp;changed&nbsp;by&nbsp;dial_test.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;dialMulti&nbsp;attempts&nbsp;to&nbsp;establish&nbsp;connections&nbsp;to&nbsp;each&nbsp;destination&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;list&nbsp;of&nbsp;addresses.&nbsp;It&nbsp;will&nbsp;return&nbsp;the&nbsp;first&nbsp;established</span><br>
<span class="lineno">185</span><span class="comment">//&nbsp;connection&nbsp;and&nbsp;close&nbsp;the&nbsp;other&nbsp;connections.&nbsp;Otherwise&nbsp;it&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;error&nbsp;on&nbsp;the&nbsp;last&nbsp;attempt.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">dialMulti</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">la</span>&nbsp;<span class="ident">Addr</span><span class="op">,</span>&nbsp;<span class="ident">ras</span>&nbsp;<span class="ident">addrList</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">type</span>&nbsp;<span class="ident">racer</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Conn</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Sig&nbsp;controls&nbsp;the&nbsp;flow&nbsp;of&nbsp;dial&nbsp;results&nbsp;on&nbsp;lane.&nbsp;It&nbsp;passes&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;token&nbsp;to&nbsp;the&nbsp;next&nbsp;racer&nbsp;and&nbsp;also&nbsp;indicates&nbsp;the&nbsp;end&nbsp;of&nbsp;flow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;by&nbsp;using&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sig</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lane</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="ident">racer</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ra</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">ras</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">ra</span>&nbsp;<span class="ident">Addr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">dialSingle</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&lt;-</span><span class="ident">sig</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lane</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">racer</span><span class="op">{</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;to&nbsp;return&nbsp;the&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;belong&nbsp;to&nbsp;the&nbsp;other</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;connections&nbsp;here&nbsp;for&nbsp;avoiding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;unnecessary&nbsp;resource&nbsp;starvation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="ident">ra</span><span class="op">.</span><span class="ident">toAddr</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="builtinfunc">close</span><span class="op">(</span><span class="ident">sig</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lastErr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nracers</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ras</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">nracers</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sig</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">racer</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&lt;-</span><span class="ident">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">racer</span><span class="op">.</span><span class="builtintype">error</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">racer</span><span class="op">.</span><span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lastErr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">racer</span><span class="op">.</span><span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nracers</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">lastErr</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;dialSingle&nbsp;attempts&nbsp;to&nbsp;establish&nbsp;and&nbsp;returns&nbsp;a&nbsp;single&nbsp;connection&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">dialSingle</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">ra</span>&nbsp;<span class="ident">Addr</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">c</span>&nbsp;<span class="ident">Conn</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">la</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="ident">Network</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">ra</span><span class="op">.</span><span class="ident">Network</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;mismatched&nbsp;local&nbsp;address&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="ident">Network</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ra</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ra</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">TCPAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPAddr</span><span class="op">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dialTCP</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">UDPAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPAddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dialUDP</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">IPAddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dialIP</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">UnixAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UnixAddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">dialUnix</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">deadline</span><span class="op">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;dial&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="op">&amp;</span><span class="ident">AddrError</span><span class="op">{</span><span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="string">&#34;unexpected&nbsp;address&nbsp;type&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">addr</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="comment">//&nbsp;c&nbsp;is&nbsp;non-nil&nbsp;interface&nbsp;containing&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Listen&nbsp;announces&nbsp;on&nbsp;the&nbsp;local&nbsp;network&nbsp;address&nbsp;laddr.</span><br>
<span class="lineno">255</span><span class="comment">//&nbsp;The&nbsp;network&nbsp;net&nbsp;must&nbsp;be&nbsp;a&nbsp;stream-oriented&nbsp;network:&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&#34;tcp6&#34;,&nbsp;&#34;unix&#34;&nbsp;or&nbsp;&#34;unixpacket&#34;.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;See&nbsp;Dial&nbsp;for&nbsp;the&nbsp;syntax&nbsp;of&nbsp;laddr.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Listen</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">Listener</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">resolveAddr</span><span class="op">(</span><span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">noDeadline</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="ident">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">la</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="ident">toAddr</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">TCPAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ListenTCP</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">UnixAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ListenUnix</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="op">&amp;</span><span class="ident">AddrError</span><span class="op">{</span><span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="string">&#34;unexpected&nbsp;address&nbsp;type&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">laddr</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="comment">//&nbsp;l&nbsp;is&nbsp;non-nil&nbsp;interface&nbsp;containing&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ListenPacket&nbsp;announces&nbsp;on&nbsp;the&nbsp;local&nbsp;network&nbsp;address&nbsp;laddr.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;network&nbsp;net&nbsp;must&nbsp;be&nbsp;a&nbsp;packet-oriented&nbsp;network:&nbsp;&#34;udp&#34;,&nbsp;&#34;udp4&#34;,</span><br>
<span class="lineno">280</span><span class="comment">//&nbsp;&#34;udp6&#34;,&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;&#34;ip6&#34;&nbsp;or&nbsp;&#34;unixgram&#34;.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;See&nbsp;Dial&nbsp;for&nbsp;the&nbsp;syntax&nbsp;of&nbsp;laddr.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">PacketConn</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">resolveAddr</span><span class="op">(</span><span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">noDeadline</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="ident">err</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="ident">PacketConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">la</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">la</span><span class="op">.</span><span class="ident">toAddr</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">UDPAddr</span><span class="op">:</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ListenUDP</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">IPAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ListenIP</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">UnixAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ListenUnixgram</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">la</span><span class="op">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">OpError</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="string">&#34;listen&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">la</span><span class="op">,</span>&nbsp;<span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="op">&amp;</span><span class="ident">AddrError</span><span class="op">{</span><span class="ident">Err</span><span class="op">:</span>&nbsp;<span class="string">&#34;unexpected&nbsp;address&nbsp;type&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Addr</span><span class="op">:</span>&nbsp;<span class="ident">laddr</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="comment">//&nbsp;l&nbsp;is&nbsp;non-nil&nbsp;interface&nbsp;containing&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
