<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1977196">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1977251">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1977305">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1977356">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1977391">package</span>&nbsp;<span class="ident" id="1977399">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1977408">import</span>&nbsp;<span class="string" id="1977415">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1977425">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1977490">//</span><br>
<span class="lineno"></span><span class="comment" id="1977493">//&nbsp;&nbsp;&nbsp;&nbspruntime·futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1977552">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1977568">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1977596">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1977646">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1977700">//</span><br>
<span class="lineno"></span><span class="comment" id="1977703">//&nbsp;&nbsp;&nbsp;&nbspruntime·futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1977753">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1977814">const</span>&nbsp;<span class="op" id="1977820">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977823">mutex_unlocked</span>&nbsp;<span class="op" id="1977838">=</span>&nbsp;<span class="num" id="1977840">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977843">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1977858">=</span>&nbsp;<span class="num" id="1977860">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977863">mutex_sleeping</span>&nbsp;<span class="op" id="1977878">=</span>&nbsp;<span class="num" id="1977880">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977884">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1977900">=</span>&nbsp;<span class="num" id="1977902">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977905">active_spin_cnt</span>&nbsp;<span class="op" id="1977921">=</span>&nbsp;<span class="num" id="1977923">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1977927">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1977943">=</span>&nbsp;<span class="num" id="1977945">1</span><br>
<span class="lineno">30</span><span class="op" id="1977947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1977950">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1978027">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1978106">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1978181">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1978207">func</span>&nbsp;<span class="ident" id="1978212">futexsleep</span><span class="op" id="1978222">(</span><span class="ident" id="1978223">addr</span>&nbsp;<span class="op" id="1978228">*</span><span class="builtintype" id="1978229">uint32</span><span class="op" id="1978235">,</span>&nbsp;<span class="ident" id="1978237">val</span>&nbsp;<span class="builtintype" id="1978241">uint32</span><span class="op" id="1978247">,</span>&nbsp;<span class="ident" id="1978249">ns</span>&nbsp;<span class="ident" id="1978252">int64</span><span class="op" id="1978257">)</span><br>
<span class="lineno"></span><span class="keyword" id="1978259">func</span>&nbsp;<span class="ident" id="1978264">futexwakeup</span><span class="op" id="1978275">(</span><span class="ident" id="1978276">addr</span>&nbsp;<span class="op" id="1978281">*</span><span class="builtintype" id="1978282">uint32</span><span class="op" id="1978288">,</span>&nbsp;<span class="ident" id="1978290">cnt</span>&nbsp;<span class="builtintype" id="1978294">uint32</span><span class="op" id="1978300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1978303">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1978361">func</span>&nbsp;<span class="ident" id="1978366">key32</span><span class="op" id="1978371">(</span><span class="ident" id="1978372">p</span>&nbsp;<span class="op" id="1978374">*</span><span class="builtintype" id="1978375">uintptr</span><span class="op" id="1978382">)</span>&nbsp;<span class="op" id="1978384">*</span><span class="builtintype" id="1978385">uint32</span>&nbsp;<span class="op" id="1978392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978395">return</span>&nbsp;<span class="op" id="1978402">(</span><span class="op" id="1978403">*</span><span class="builtintype" id="1978404">uint32</span><span class="op" id="1978410">)</span><span class="op" id="1978411">(</span><span class="ident" id="1978412"><a href="/runtime/lock_futex.go.html#1977415">unsafe</a></span><span class="op" id="1978418">.</span><span class="ident" id="1978419">Pointer</span><span class="op" id="1978426">(</span><span class="ident" id="1978427"><a href="/runtime/lock_futex.go.html#1978372">p</a></span><span class="op" id="1978428">)</span><span class="op" id="1978429">)</span><br>
<span class="lineno"></span><span class="op" id="1978431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1978434">func</span>&nbsp;<span class="ident" id="1978439">lock</span><span class="op" id="1978443">(</span><span class="ident" id="1978444">l</span>&nbsp;<span class="op" id="1978446">*</span><span class="ident" id="1978447"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179310">mutex</a></span><span class="op" id="1978452">)</span>&nbsp;<span class="op" id="1978454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978457">gp</span>&nbsp;<span class="op" id="1978460">:=</span>&nbsp;<span class="ident" id="1978463"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1978467">(</span><span class="op" id="1978468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978472">if</span>&nbsp;<span class="ident" id="1978475"><a href="/runtime/lock_futex.go.html#1978457">gp</a></span><span class="op" id="1978477">.</span><span class="ident" id="1978478">m</span><span class="op" id="1978479">.</span><span class="ident" id="1978480">locks</span>&nbsp;<span class="op" id="1978486">&lt;</span>&nbsp;<span class="num" id="1978488">0</span>&nbsp;<span class="op" id="1978490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978494"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1978501">(</span><span class="string" id="1978502">&#34;runtime·lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1978529">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978535"><a href="/runtime/lock_futex.go.html#1978457">gp</a></span><span class="op" id="1978537">.</span><span class="ident" id="1978538">m</span><span class="op" id="1978539">.</span><span class="ident" id="1978540">locks</span><span class="op" id="1978545">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978550">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978581">v</span>&nbsp;<span class="op" id="1978583">:=</span>&nbsp;<span class="ident" id="1978586"><a href="/runtime/atomic.go.html#1874168">xchg</a></span><span class="op" id="1978590">(</span><span class="ident" id="1978591"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1978596">(</span><span class="op" id="1978597">&amp;</span><span class="ident" id="1978598"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1978599">.</span><span class="ident" id="1978600">key</span><span class="op" id="1978603">)</span><span class="op" id="1978604">,</span>&nbsp;<span class="ident" id="1978606"><a href="/runtime/lock_futex.go.html#1977843">mutex_locked</a></span><span class="op" id="1978618">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978621">if</span>&nbsp;<span class="ident" id="1978624"><a href="/runtime/lock_futex.go.html#1978581">v</a></span>&nbsp;<span class="op" id="1978626">==</span>&nbsp;<span class="ident" id="1978629"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span>&nbsp;<span class="op" id="1978644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1978648">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1978656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978660">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978710">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978762">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978812">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978863">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978918">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1978973">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1978994">wait</span>&nbsp;<span class="op" id="1978999">:=</span>&nbsp;<span class="ident" id="1979002"><a href="/runtime/lock_futex.go.html#1978581">v</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979006">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979047">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979102">spin</span>&nbsp;<span class="op" id="1979107">:=</span>&nbsp;<span class="num" id="1979110">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979113">if</span>&nbsp;<span class="ident" id="1979116"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2184452">ncpu</a></span>&nbsp;<span class="op" id="1979121">&gt;</span>&nbsp;<span class="num" id="1979123">1</span>&nbsp;<span class="op" id="1979125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979129"><a href="/runtime/lock_futex.go.html#1979102">spin</a></span>&nbsp;<span class="op" id="1979134">=</span>&nbsp;<span class="ident" id="1979136"><a href="/runtime/lock_futex.go.html#1977884">active_spin</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979152">for</span>&nbsp;<span class="op" id="1979156">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979160">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979189">for</span>&nbsp;<span class="ident" id="1979193">i</span>&nbsp;<span class="op" id="1979195">:=</span>&nbsp;<span class="num" id="1979198">0</span><span class="op" id="1979199">;</span>&nbsp;<span class="ident" id="1979201"><a href="/runtime/lock_futex.go.html#1979193">i</a></span>&nbsp;<span class="op" id="1979203">&lt;</span>&nbsp;<span class="ident" id="1979205"><a href="/runtime/lock_futex.go.html#1979102">spin</a></span><span class="op" id="1979209">;</span>&nbsp;<span class="ident" id="1979211"><a href="/runtime/lock_futex.go.html#1979193">i</a></span><span class="op" id="1979212">++</span>&nbsp;<span class="op" id="1979215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979220">for</span>&nbsp;<span class="ident" id="1979224"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1979225">.</span><span class="ident" id="1979226">key</span>&nbsp;<span class="op" id="1979230">==</span>&nbsp;<span class="ident" id="1979233"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span>&nbsp;<span class="op" id="1979248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979254">if</span>&nbsp;<span class="ident" id="1979257"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="1979260">(</span><span class="ident" id="1979261"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1979266">(</span><span class="op" id="1979267">&amp;</span><span class="ident" id="1979268"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1979269">.</span><span class="ident" id="1979270">key</span><span class="op" id="1979273">)</span><span class="op" id="1979274">,</span>&nbsp;<span class="ident" id="1979276"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span><span class="op" id="1979290">,</span>&nbsp;<span class="ident" id="1979292"><a href="/runtime/lock_futex.go.html#1978994">wait</a></span><span class="op" id="1979296">)</span>&nbsp;<span class="op" id="1979298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979305">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979326"><a href="/runtime/stubs.go.html#2137547">procyield</a></span><span class="op" id="1979335">(</span><span class="ident" id="1979336"><a href="/runtime/lock_futex.go.html#1977905">active_spin_cnt</a></span><span class="op" id="1979351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979360">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979393">for</span>&nbsp;<span class="ident" id="1979397">i</span>&nbsp;<span class="op" id="1979399">:=</span>&nbsp;<span class="num" id="1979402">0</span><span class="op" id="1979403">;</span>&nbsp;<span class="ident" id="1979405"><a href="/runtime/lock_futex.go.html#1979397">i</a></span>&nbsp;<span class="op" id="1979407">&lt;</span>&nbsp;<span class="ident" id="1979409"><a href="/runtime/lock_futex.go.html#1977927">passive_spin</a></span><span class="op" id="1979421">;</span>&nbsp;<span class="ident" id="1979423"><a href="/runtime/lock_futex.go.html#1979397">i</a></span><span class="op" id="1979424">++</span>&nbsp;<span class="op" id="1979427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979432">for</span>&nbsp;<span class="ident" id="1979436"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1979437">.</span><span class="ident" id="1979438">key</span>&nbsp;<span class="op" id="1979442">==</span>&nbsp;<span class="ident" id="1979445"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span>&nbsp;<span class="op" id="1979460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979466">if</span>&nbsp;<span class="ident" id="1979469"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="1979472">(</span><span class="ident" id="1979473"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1979478">(</span><span class="op" id="1979479">&amp;</span><span class="ident" id="1979480"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1979481">.</span><span class="ident" id="1979482">key</span><span class="op" id="1979485">)</span><span class="op" id="1979486">,</span>&nbsp;<span class="ident" id="1979488"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span><span class="op" id="1979502">,</span>&nbsp;<span class="ident" id="1979504"><a href="/runtime/lock_futex.go.html#1978994">wait</a></span><span class="op" id="1979508">)</span>&nbsp;<span class="op" id="1979510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979517">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979538"><a href="/runtime/stubs.go.html#2137532">osyield</a></span><span class="op" id="1979545">(</span><span class="op" id="1979546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1979555">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979567"><a href="/runtime/lock_futex.go.html#1978581">v</a></span>&nbsp;<span class="op" id="1979569">=</span>&nbsp;<span class="ident" id="1979571"><a href="/runtime/atomic.go.html#1874168">xchg</a></span><span class="op" id="1979575">(</span><span class="ident" id="1979576"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1979581">(</span><span class="op" id="1979582">&amp;</span><span class="ident" id="1979583"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1979584">.</span><span class="ident" id="1979585">key</span><span class="op" id="1979588">)</span><span class="op" id="1979589">,</span>&nbsp;<span class="ident" id="1979591"><a href="/runtime/lock_futex.go.html#1977863">mutex_sleeping</a></span><span class="op" id="1979605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979609">if</span>&nbsp;<span class="ident" id="1979612"><a href="/runtime/lock_futex.go.html#1978581">v</a></span>&nbsp;<span class="op" id="1979614">==</span>&nbsp;<span class="ident" id="1979617"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span>&nbsp;<span class="op" id="1979632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979637">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979646">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979650"><a href="/runtime/lock_futex.go.html#1978994">wait</a></span>&nbsp;<span class="op" id="1979655">=</span>&nbsp;<span class="ident" id="1979657"><a href="/runtime/lock_futex.go.html#1977863">mutex_sleeping</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979674"><a href="/runtime/lock_futex.go.html#1978212">futexsleep</a></span><span class="op" id="1979684">(</span><span class="ident" id="1979685"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1979690">(</span><span class="op" id="1979691">&amp;</span><span class="ident" id="1979692"><a href="/runtime/lock_futex.go.html#1978444">l</a></span><span class="op" id="1979693">.</span><span class="ident" id="1979694">key</span><span class="op" id="1979697">)</span><span class="op" id="1979698">,</span>&nbsp;<span class="ident" id="1979700"><a href="/runtime/lock_futex.go.html#1977863">mutex_sleeping</a></span><span class="op" id="1979714">,</span>&nbsp;<span class="op" id="1979716">-</span><span class="num" id="1979717">1</span><span class="op" id="1979718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979721">}</span><br>
<span class="lineno"></span><span class="op" id="1979723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1979726">func</span>&nbsp;<span class="ident" id="1979731">unlock</span><span class="op" id="1979737">(</span><span class="ident" id="1979738">l</span>&nbsp;<span class="op" id="1979740">*</span><span class="ident" id="1979741"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179310">mutex</a></span><span class="op" id="1979746">)</span>&nbsp;<span class="op" id="1979748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979751">v</span>&nbsp;<span class="op" id="1979753">:=</span>&nbsp;<span class="ident" id="1979756"><a href="/runtime/atomic.go.html#1874168">xchg</a></span><span class="op" id="1979760">(</span><span class="ident" id="1979761"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1979766">(</span><span class="op" id="1979767">&amp;</span><span class="ident" id="1979768"><a href="/runtime/lock_futex.go.html#1979738">l</a></span><span class="op" id="1979769">.</span><span class="ident" id="1979770">key</span><span class="op" id="1979773">)</span><span class="op" id="1979774">,</span>&nbsp;<span class="ident" id="1979776"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span><span class="op" id="1979790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979793">if</span>&nbsp;<span class="ident" id="1979796"><a href="/runtime/lock_futex.go.html#1979751">v</a></span>&nbsp;<span class="op" id="1979798">==</span>&nbsp;<span class="ident" id="1979801"><a href="/runtime/lock_futex.go.html#1977823">mutex_unlocked</a></span>&nbsp;<span class="op" id="1979816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979820"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1979827">(</span><span class="string" id="1979828">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1979853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979856">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979859">if</span>&nbsp;<span class="ident" id="1979862"><a href="/runtime/lock_futex.go.html#1979751">v</a></span>&nbsp;<span class="op" id="1979864">==</span>&nbsp;<span class="ident" id="1979867"><a href="/runtime/lock_futex.go.html#1977863">mutex_sleeping</a></span>&nbsp;<span class="op" id="1979882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979886"><a href="/runtime/lock_futex.go.html#1978264">futexwakeup</a></span><span class="op" id="1979897">(</span><span class="ident" id="1979898"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1979903">(</span><span class="op" id="1979904">&amp;</span><span class="ident" id="1979905"><a href="/runtime/lock_futex.go.html#1979738">l</a></span><span class="op" id="1979906">.</span><span class="ident" id="1979907">key</span><span class="op" id="1979910">)</span><span class="op" id="1979911">,</span>&nbsp;<span class="num" id="1979913">1</span><span class="op" id="1979914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1979917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979921">gp</span>&nbsp;<span class="op" id="1979924">:=</span>&nbsp;<span class="ident" id="1979927"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1979931">(</span><span class="op" id="1979932">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979935"><a href="/runtime/lock_futex.go.html#1979921">gp</a></span><span class="op" id="1979937">.</span><span class="ident" id="1979938">m</span><span class="op" id="1979939">.</span><span class="ident" id="1979940">locks</span><span class="op" id="1979945">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1979949">if</span>&nbsp;<span class="ident" id="1979952"><a href="/runtime/lock_futex.go.html#1979921">gp</a></span><span class="op" id="1979954">.</span><span class="ident" id="1979955">m</span><span class="op" id="1979956">.</span><span class="ident" id="1979957">locks</span>&nbsp;<span class="op" id="1979963">&lt;</span>&nbsp;<span class="num" id="1979965">0</span>&nbsp;<span class="op" id="1979967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1979971"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1979978">(</span><span class="string" id="1979979">&#34;runtime·unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1980008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980014">if</span>&nbsp;<span class="ident" id="1980017"><a href="/runtime/lock_futex.go.html#1979921">gp</a></span><span class="op" id="1980019">.</span><span class="ident" id="1980020">m</span><span class="op" id="1980021">.</span><span class="ident" id="1980022">locks</span>&nbsp;<span class="op" id="1980028">==</span>&nbsp;<span class="num" id="1980031">0</span>&nbsp;<span class="op" id="1980033">&amp;&amp;</span>&nbsp;<span class="ident" id="1980036"><a href="/runtime/lock_futex.go.html#1979921">gp</a></span><span class="op" id="1980038">.</span><span class="ident" id="1980039">preempt</span>&nbsp;<span class="op" id="1980047">{</span>&nbsp;<span class="comment" id="1980049">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980122"><a href="/runtime/lock_futex.go.html#1979921">gp</a></span><span class="op" id="1980124">.</span><span class="ident" id="1980125">stackguard0</span>&nbsp;<span class="op" id="1980137">=</span>&nbsp;<span class="ident" id="1980139"><a href="/runtime/stack.go.html#2125026">stackPreempt</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980153">}</span><br>
<span class="lineno"></span><span class="op" id="1980155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1980158">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1980185">func</span>&nbsp;<span class="ident" id="1980190">noteclear</span><span class="op" id="1980199">(</span><span class="ident" id="1980200">n</span>&nbsp;<span class="op" id="1980202">*</span><span class="ident" id="1980203"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span><span class="op" id="1980207">)</span>&nbsp;<span class="op" id="1980209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980212"><a href="/runtime/lock_futex.go.html#1980200">n</a></span><span class="op" id="1980213">.</span><span class="ident" id="1980214">key</span>&nbsp;<span class="op" id="1980218">=</span>&nbsp;<span class="num" id="1980220">0</span><br>
<span class="lineno"></span><span class="op" id="1980222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1980225">func</span>&nbsp;<span class="ident" id="1980230">notewakeup</span><span class="op" id="1980240">(</span><span class="ident" id="1980241">n</span>&nbsp;<span class="op" id="1980243">*</span><span class="ident" id="1980244"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span><span class="op" id="1980248">)</span>&nbsp;<span class="op" id="1980250">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980253">old</span>&nbsp;<span class="op" id="1980257">:=</span>&nbsp;<span class="ident" id="1980260"><a href="/runtime/atomic.go.html#1874168">xchg</a></span><span class="op" id="1980264">(</span><span class="ident" id="1980265"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980270">(</span><span class="op" id="1980271">&amp;</span><span class="ident" id="1980272"><a href="/runtime/lock_futex.go.html#1980241">n</a></span><span class="op" id="1980273">.</span><span class="ident" id="1980274">key</span><span class="op" id="1980277">)</span><span class="op" id="1980278">,</span>&nbsp;<span class="num" id="1980280">1</span><span class="op" id="1980281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980284">if</span>&nbsp;<span class="ident" id="1980287"><a href="/runtime/lock_futex.go.html#1980253">old</a></span>&nbsp;<span class="op" id="1980291">!=</span>&nbsp;<span class="num" id="1980294">0</span>&nbsp;<span class="op" id="1980296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1980300">print</span><span class="op" id="1980305">(</span><span class="string" id="1980306">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1980336">,</span>&nbsp;<span class="ident" id="1980338"><a href="/runtime/lock_futex.go.html#1980253">old</a></span><span class="op" id="1980341">,</span>&nbsp;<span class="string" id="1980343">&#34;)\n&#34;</span><span class="op" id="1980348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980352"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1980359">(</span><span class="string" id="1980360">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1980388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980391">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980394"><a href="/runtime/lock_futex.go.html#1978264">futexwakeup</a></span><span class="op" id="1980405">(</span><span class="ident" id="1980406"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980411">(</span><span class="op" id="1980412">&amp;</span><span class="ident" id="1980413"><a href="/runtime/lock_futex.go.html#1980241">n</a></span><span class="op" id="1980414">.</span><span class="ident" id="1980415">key</span><span class="op" id="1980418">)</span><span class="op" id="1980419">,</span>&nbsp;<span class="num" id="1980421">1</span><span class="op" id="1980422">)</span><br>
<span class="lineno"></span><span class="op" id="1980424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1980427">func</span>&nbsp;<span class="ident" id="1980432">notesleep</span><span class="op" id="1980441">(</span><span class="ident" id="1980442">n</span>&nbsp;<span class="op" id="1980444">*</span><span class="ident" id="1980445"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span><span class="op" id="1980449">)</span>&nbsp;<span class="op" id="1980451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980454">gp</span>&nbsp;<span class="op" id="1980457">:=</span>&nbsp;<span class="ident" id="1980460"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1980464">(</span><span class="op" id="1980465">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980468">if</span>&nbsp;<span class="ident" id="1980471"><a href="/runtime/lock_futex.go.html#1980454">gp</a></span>&nbsp;<span class="op" id="1980474">!=</span>&nbsp;<span class="ident" id="1980477"><a href="/runtime/lock_futex.go.html#1980454">gp</a></span><span class="op" id="1980479">.</span><span class="ident" id="1980480">m</span><span class="op" id="1980481">.</span><span class="ident" id="1980482">g0</span>&nbsp;<span class="op" id="1980485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980489"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1980496">(</span><span class="string" id="1980497">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1980518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980524">for</span>&nbsp;<span class="ident" id="1980528"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="1980538">(</span><span class="ident" id="1980539"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980544">(</span><span class="op" id="1980545">&amp;</span><span class="ident" id="1980546"><a href="/runtime/lock_futex.go.html#1980442">n</a></span><span class="op" id="1980547">.</span><span class="ident" id="1980548">key</span><span class="op" id="1980551">)</span><span class="op" id="1980552">)</span>&nbsp;<span class="op" id="1980554">==</span>&nbsp;<span class="num" id="1980557">0</span>&nbsp;<span class="op" id="1980559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980563"><a href="/runtime/lock_futex.go.html#1980454">gp</a></span><span class="op" id="1980565">.</span><span class="ident" id="1980566">m</span><span class="op" id="1980567">.</span><span class="ident" id="1980568">blocked</span>&nbsp;<span class="op" id="1980576">=</span>&nbsp;<span class="builtintype" id="1980578">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980585"><a href="/runtime/lock_futex.go.html#1978212">futexsleep</a></span><span class="op" id="1980595">(</span><span class="ident" id="1980596"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980601">(</span><span class="op" id="1980602">&amp;</span><span class="ident" id="1980603"><a href="/runtime/lock_futex.go.html#1980442">n</a></span><span class="op" id="1980604">.</span><span class="ident" id="1980605">key</span><span class="op" id="1980608">)</span><span class="op" id="1980609">,</span>&nbsp;<span class="num" id="1980611">0</span><span class="op" id="1980612">,</span>&nbsp;<span class="op" id="1980614">-</span><span class="num" id="1980615">1</span><span class="op" id="1980616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980620"><a href="/runtime/lock_futex.go.html#1980454">gp</a></span><span class="op" id="1980622">.</span><span class="ident" id="1980623">m</span><span class="op" id="1980624">.</span><span class="ident" id="1980625">blocked</span>&nbsp;<span class="op" id="1980633">=</span>&nbsp;<span class="builtintype" id="1980635">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980642">}</span><br>
<span class="lineno"></span><span class="op" id="1980644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1980647">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1980660">func</span>&nbsp;<span class="ident" id="1980665">notetsleep_internal</span><span class="op" id="1980684">(</span><span class="ident" id="1980685">n</span>&nbsp;<span class="op" id="1980687">*</span><span class="ident" id="1980688"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span><span class="op" id="1980692">,</span>&nbsp;<span class="ident" id="1980694">ns</span>&nbsp;<span class="ident" id="1980697">int64</span><span class="op" id="1980702">)</span>&nbsp;<span class="builtintype" id="1980704">bool</span>&nbsp;<span class="op" id="1980709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980712">gp</span>&nbsp;<span class="op" id="1980715">:=</span>&nbsp;<span class="ident" id="1980718"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1980722">(</span><span class="op" id="1980723">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980727">if</span>&nbsp;<span class="ident" id="1980730"><a href="/runtime/lock_futex.go.html#1980694">ns</a></span>&nbsp;<span class="op" id="1980733">&lt;</span>&nbsp;<span class="num" id="1980735">0</span>&nbsp;<span class="op" id="1980737">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980741">for</span>&nbsp;<span class="ident" id="1980745"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="1980755">(</span><span class="ident" id="1980756"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980761">(</span><span class="op" id="1980762">&amp;</span><span class="ident" id="1980763"><a href="/runtime/lock_futex.go.html#1980685">n</a></span><span class="op" id="1980764">.</span><span class="ident" id="1980765">key</span><span class="op" id="1980768">)</span><span class="op" id="1980769">)</span>&nbsp;<span class="op" id="1980771">==</span>&nbsp;<span class="num" id="1980774">0</span>&nbsp;<span class="op" id="1980776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980781"><a href="/runtime/lock_futex.go.html#1980712">gp</a></span><span class="op" id="1980783">.</span><span class="ident" id="1980784">m</span><span class="op" id="1980785">.</span><span class="ident" id="1980786">blocked</span>&nbsp;<span class="op" id="1980794">=</span>&nbsp;<span class="builtintype" id="1980796">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980804"><a href="/runtime/lock_futex.go.html#1978212">futexsleep</a></span><span class="op" id="1980814">(</span><span class="ident" id="1980815"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980820">(</span><span class="op" id="1980821">&amp;</span><span class="ident" id="1980822"><a href="/runtime/lock_futex.go.html#1980685">n</a></span><span class="op" id="1980823">.</span><span class="ident" id="1980824">key</span><span class="op" id="1980827">)</span><span class="op" id="1980828">,</span>&nbsp;<span class="num" id="1980830">0</span><span class="op" id="1980831">,</span>&nbsp;<span class="op" id="1980833">-</span><span class="num" id="1980834">1</span><span class="op" id="1980835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980840"><a href="/runtime/lock_futex.go.html#1980712">gp</a></span><span class="op" id="1980842">.</span><span class="ident" id="1980843">m</span><span class="op" id="1980844">.</span><span class="ident" id="1980845">blocked</span>&nbsp;<span class="op" id="1980853">=</span>&nbsp;<span class="builtintype" id="1980855">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980863">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980867">return</span>&nbsp;<span class="builtintype" id="1980874">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980884">if</span>&nbsp;<span class="ident" id="1980887"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="1980897">(</span><span class="ident" id="1980898"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1980903">(</span><span class="op" id="1980904">&amp;</span><span class="ident" id="1980905"><a href="/runtime/lock_futex.go.html#1980685">n</a></span><span class="op" id="1980906">.</span><span class="ident" id="1980907">key</span><span class="op" id="1980910">)</span><span class="op" id="1980911">)</span>&nbsp;<span class="op" id="1980913">!=</span>&nbsp;<span class="num" id="1980916">0</span>&nbsp;<span class="op" id="1980918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980922">return</span>&nbsp;<span class="builtintype" id="1980929">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1980935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980939">deadline</span>&nbsp;<span class="op" id="1980948">:=</span>&nbsp;<span class="ident" id="1980951"><a href="/runtime/stubs.go.html#2137038">nanotime</a></span><span class="op" id="1980959">(</span><span class="op" id="1980960">)</span>&nbsp;<span class="op" id="1980962">+</span>&nbsp;<span class="ident" id="1980964"><a href="/runtime/lock_futex.go.html#1980694">ns</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1980968">for</span>&nbsp;<span class="op" id="1980972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980976"><a href="/runtime/lock_futex.go.html#1980712">gp</a></span><span class="op" id="1980978">.</span><span class="ident" id="1980979">m</span><span class="op" id="1980980">.</span><span class="ident" id="1980981">blocked</span>&nbsp;<span class="op" id="1980989">=</span>&nbsp;<span class="builtintype" id="1980991">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1980998"><a href="/runtime/lock_futex.go.html#1978212">futexsleep</a></span><span class="op" id="1981008">(</span><span class="ident" id="1981009"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1981014">(</span><span class="op" id="1981015">&amp;</span><span class="ident" id="1981016"><a href="/runtime/lock_futex.go.html#1980685">n</a></span><span class="op" id="1981017">.</span><span class="ident" id="1981018">key</span><span class="op" id="1981021">)</span><span class="op" id="1981022">,</span>&nbsp;<span class="num" id="1981024">0</span><span class="op" id="1981025">,</span>&nbsp;<span class="ident" id="1981027"><a href="/runtime/lock_futex.go.html#1980694">ns</a></span><span class="op" id="1981029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981033"><a href="/runtime/lock_futex.go.html#1980712">gp</a></span><span class="op" id="1981035">.</span><span class="ident" id="1981036">m</span><span class="op" id="1981037">.</span><span class="ident" id="1981038">blocked</span>&nbsp;<span class="op" id="1981046">=</span>&nbsp;<span class="builtintype" id="1981048">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981056">if</span>&nbsp;<span class="ident" id="1981059"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="1981069">(</span><span class="ident" id="1981070"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1981075">(</span><span class="op" id="1981076">&amp;</span><span class="ident" id="1981077"><a href="/runtime/lock_futex.go.html#1980685">n</a></span><span class="op" id="1981078">.</span><span class="ident" id="1981079">key</span><span class="op" id="1981082">)</span><span class="op" id="1981083">)</span>&nbsp;<span class="op" id="1981085">!=</span>&nbsp;<span class="num" id="1981088">0</span>&nbsp;<span class="op" id="1981090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981095">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981103">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981107">now</span>&nbsp;<span class="op" id="1981111">:=</span>&nbsp;<span class="ident" id="1981114"><a href="/runtime/stubs.go.html#2137038">nanotime</a></span><span class="op" id="1981122">(</span><span class="op" id="1981123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981127">if</span>&nbsp;<span class="ident" id="1981130"><a href="/runtime/lock_futex.go.html#1981107">now</a></span>&nbsp;<span class="op" id="1981134">&gt;=</span>&nbsp;<span class="ident" id="1981137"><a href="/runtime/lock_futex.go.html#1980939">deadline</a></span>&nbsp;<span class="op" id="1981146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981151">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981163"><a href="/runtime/lock_futex.go.html#1980694">ns</a></span>&nbsp;<span class="op" id="1981166">=</span>&nbsp;<span class="ident" id="1981168"><a href="/runtime/lock_futex.go.html#1980939">deadline</a></span>&nbsp;<span class="op" id="1981177">-</span>&nbsp;<span class="ident" id="1981179"><a href="/runtime/lock_futex.go.html#1981107">now</a></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981187">return</span>&nbsp;<span class="ident" id="1981194"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="1981204">(</span><span class="ident" id="1981205"><a href="/runtime/lock_futex.go.html#1978366">key32</a></span><span class="op" id="1981210">(</span><span class="op" id="1981211">&amp;</span><span class="ident" id="1981212"><a href="/runtime/lock_futex.go.html#1980685">n</a></span><span class="op" id="1981213">.</span><span class="ident" id="1981214">key</span><span class="op" id="1981217">)</span><span class="op" id="1981218">)</span>&nbsp;<span class="op" id="1981220">!=</span>&nbsp;<span class="num" id="1981223">0</span><br>
<span class="lineno"></span><span class="op" id="1981225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1981228">func</span>&nbsp;<span class="ident" id="1981233">notetsleep</span><span class="op" id="1981243">(</span><span class="ident" id="1981244">n</span>&nbsp;<span class="op" id="1981246">*</span><span class="ident" id="1981247"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span><span class="op" id="1981251">,</span>&nbsp;<span class="ident" id="1981253">ns</span>&nbsp;<span class="ident" id="1981256">int64</span><span class="op" id="1981261">)</span>&nbsp;<span class="builtintype" id="1981263">bool</span>&nbsp;<span class="op" id="1981268">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981271">gp</span>&nbsp;<span class="op" id="1981274">:=</span>&nbsp;<span class="ident" id="1981277"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1981281">(</span><span class="op" id="1981282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981285">if</span>&nbsp;<span class="ident" id="1981288"><a href="/runtime/lock_futex.go.html#1981271">gp</a></span>&nbsp;<span class="op" id="1981291">!=</span>&nbsp;<span class="ident" id="1981294"><a href="/runtime/lock_futex.go.html#1981271">gp</a></span><span class="op" id="1981296">.</span><span class="ident" id="1981297">m</span><span class="op" id="1981298">.</span><span class="ident" id="1981299">g0</span>&nbsp;<span class="op" id="1981302">&amp;&amp;</span>&nbsp;<span class="ident" id="1981305"><a href="/runtime/lock_futex.go.html#1981271">gp</a></span><span class="op" id="1981307">.</span><span class="ident" id="1981308">m</span><span class="op" id="1981309">.</span><span class="ident" id="1981310">gcing</span>&nbsp;<span class="op" id="1981316">==</span>&nbsp;<span class="num" id="1981319">0</span>&nbsp;<span class="op" id="1981321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981325"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1981332">(</span><span class="string" id="1981333">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1981355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981362">return</span>&nbsp;<span class="ident" id="1981369"><a href="/runtime/lock_futex.go.html#1980665">notetsleep_internal</a></span><span class="op" id="1981388">(</span><span class="ident" id="1981389"><a href="/runtime/lock_futex.go.html#1981244">n</a></span><span class="op" id="1981390">,</span>&nbsp;<span class="ident" id="1981392"><a href="/runtime/lock_futex.go.html#1981253">ns</a></span><span class="op" id="1981394">)</span><br>
<span class="lineno"></span><span class="op" id="1981396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1981399">//&nbsp;same&nbsp;as&nbsp;runtime·notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1981461">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1981531">func</span>&nbsp;<span class="ident" id="1981536">notetsleepg</span><span class="op" id="1981547">(</span><span class="ident" id="1981548">n</span>&nbsp;<span class="op" id="1981550">*</span><span class="ident" id="1981551"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179346">note</a></span><span class="op" id="1981555">,</span>&nbsp;<span class="ident" id="1981557">ns</span>&nbsp;<span class="ident" id="1981560">int64</span><span class="op" id="1981565">)</span>&nbsp;<span class="builtintype" id="1981567">bool</span>&nbsp;<span class="op" id="1981572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981575">gp</span>&nbsp;<span class="op" id="1981578">:=</span>&nbsp;<span class="ident" id="1981581"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="1981585">(</span><span class="op" id="1981586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981589">if</span>&nbsp;<span class="ident" id="1981592"><a href="/runtime/lock_futex.go.html#1981575">gp</a></span>&nbsp;<span class="op" id="1981595">==</span>&nbsp;<span class="ident" id="1981598"><a href="/runtime/lock_futex.go.html#1981575">gp</a></span><span class="op" id="1981600">.</span><span class="ident" id="1981601">m</span><span class="op" id="1981602">.</span><span class="ident" id="1981603">g0</span>&nbsp;<span class="op" id="1981606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981610"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="1981617">(</span><span class="string" id="1981618">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1981637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1981640">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981644"><a href="/runtime/stubs.go.html#2136592">entersyscallblock</a></span><span class="op" id="1981661">(</span><span class="op" id="1981662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981665">ok</span>&nbsp;<span class="op" id="1981668">:=</span>&nbsp;<span class="ident" id="1981671"><a href="/runtime/lock_futex.go.html#1980665">notetsleep_internal</a></span><span class="op" id="1981690">(</span><span class="ident" id="1981691"><a href="/runtime/lock_futex.go.html#1981548">n</a></span><span class="op" id="1981692">,</span>&nbsp;<span class="ident" id="1981694"><a href="/runtime/lock_futex.go.html#1981557">ns</a></span><span class="op" id="1981696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1981699"><a href="/runtime/stubs.go.html#2136617">exitsyscall</a></span><span class="op" id="1981710">(</span><span class="op" id="1981711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1981714">return</span>&nbsp;<span class="ident" id="1981721"><a href="/runtime/lock_futex.go.html#1981665">ok</a></span><br>
<span class="lineno">205</span><span class="op" id="1981724">}</span>
</div>
</body>
</html>
