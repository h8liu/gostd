<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html" class="current">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6569716">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6569772">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6569826">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6569877">package</span>&nbsp;<span class="ident" id="6569885">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6569891">import</span>&nbsp;<span class="op" id="6569898">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569901">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569910">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569923">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569930">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569941">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6569952">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="6569962">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6569965">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="6570001">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="6570027">var</span>&nbsp;<span class="ident" id="6570031">streamTest</span>&nbsp;<span class="op" id="6570042">=</span>&nbsp;<span class="op" id="6570044">[</span><span class="op" id="6570045">]</span><span class="keyword" id="6570046">interface</span><span class="op" id="6570055">{</span><span class="op" id="6570056">}</span><span class="op" id="6570057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6570060">0.1</span><span class="op" id="6570063">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6570066">&#34;hello&#34;</span><span class="op" id="6570073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570076">nil</span><span class="op" id="6570079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="6570082">true</span><span class="op" id="6570086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="6570089">false</span><span class="op" id="6570094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570097">[</span><span class="op" id="6570098">]</span><span class="keyword" id="6570099">interface</span><span class="op" id="6570108">{</span><span class="op" id="6570109">}</span><span class="op" id="6570110">{</span><span class="string" id="6570111">&#34;a&#34;</span><span class="op" id="6570114">,</span>&nbsp;<span class="string" id="6570116">&#34;b&#34;</span><span class="op" id="6570119">,</span>&nbsp;<span class="string" id="6570121">&#34;c&#34;</span><span class="op" id="6570124">}</span><span class="op" id="6570125">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570128">map</span><span class="op" id="6570131">[</span><span class="builtintype" id="6570132">string</span><span class="op" id="6570138">]</span><span class="keyword" id="6570139">interface</span><span class="op" id="6570148">{</span><span class="op" id="6570149">}</span><span class="op" id="6570150">{</span><span class="string" id="6570151">&#34;K&#34;</span><span class="op" id="6570156">:</span>&nbsp;<span class="string" id="6570158">&#34;Kelvin&#34;</span><span class="op" id="6570166">,</span>&nbsp;<span class="string" id="6570168">&#34;ß&#34;</span><span class="op" id="6570172">:</span>&nbsp;<span class="string" id="6570174">&#34;long&nbsp;s&#34;</span><span class="op" id="6570182">}</span><span class="op" id="6570183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6570186">3.14</span><span class="op" id="6570190">,</span>&nbsp;<span class="comment" id="6570192">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="6570247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6570250">var</span>&nbsp;<span class="ident" id="6570254">streamEncoded</span>&nbsp;<span class="op" id="6570268">=</span>&nbsp;<span class="string" id="6570270">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6570352">func</span>&nbsp;<span class="ident" id="6570357">TestEncoder</span><span class="op" id="6570368">(</span><span class="ident" id="6570369">t</span>&nbsp;<span class="op" id="6570371">*</span><span class="ident" id="6570372">testing</span><span class="op" id="6570379">.</span><span class="ident" id="6570380">T</span><span class="op" id="6570381">)</span>&nbsp;<span class="op" id="6570383">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570386">for</span>&nbsp;<span class="ident" id="6570390">i</span>&nbsp;<span class="op" id="6570392">:=</span>&nbsp;<span class="num" id="6570395">0</span><span class="op" id="6570396">;</span>&nbsp;<span class="ident" id="6570398">i</span>&nbsp;<span class="op" id="6570400">&lt;=</span>&nbsp;<span class="builtinfunc" id="6570403">len</span><span class="op" id="6570406">(</span><span class="ident" id="6570407">streamTest</span><span class="op" id="6570417">)</span><span class="op" id="6570418">;</span>&nbsp;<span class="ident" id="6570420">i</span><span class="op" id="6570421">++</span>&nbsp;<span class="op" id="6570424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570428">var</span>&nbsp;<span class="ident" id="6570432">buf</span>&nbsp;<span class="ident" id="6570436">bytes</span><span class="op" id="6570441">.</span><span class="ident" id="6570442">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570451">enc</span>&nbsp;<span class="op" id="6570455">:=</span>&nbsp;<span class="ident" id="6570458">NewEncoder</span><span class="op" id="6570468">(</span><span class="op" id="6570469">&amp;</span><span class="ident" id="6570470">buf</span><span class="op" id="6570473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570477">for</span>&nbsp;<span class="ident" id="6570481">j</span><span class="op" id="6570482">,</span>&nbsp;<span class="ident" id="6570484">v</span>&nbsp;<span class="op" id="6570486">:=</span>&nbsp;<span class="keyword" id="6570489">range</span>&nbsp;<span class="ident" id="6570495">streamTest</span><span class="op" id="6570505">[</span><span class="num" id="6570506">0</span><span class="op" id="6570507">:</span><span class="ident" id="6570508">i</span><span class="op" id="6570509">]</span>&nbsp;<span class="op" id="6570511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570516">if</span>&nbsp;<span class="ident" id="6570519">err</span>&nbsp;<span class="op" id="6570523">:=</span>&nbsp;<span class="ident" id="6570526">enc</span><span class="op" id="6570529">.</span><span class="ident" id="6570530">Encode</span><span class="op" id="6570536">(</span><span class="ident" id="6570537">v</span><span class="op" id="6570538">)</span><span class="op" id="6570539">;</span>&nbsp;<span class="ident" id="6570541">err</span>&nbsp;<span class="op" id="6570545">!=</span>&nbsp;<span class="ident" id="6570548">nil</span>&nbsp;<span class="op" id="6570552">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570558">t</span><span class="op" id="6570559">.</span><span class="ident" id="6570560">Fatalf</span><span class="op" id="6570566">(</span><span class="string" id="6570567">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="6570583">,</span>&nbsp;<span class="ident" id="6570585">j</span><span class="op" id="6570586">,</span>&nbsp;<span class="ident" id="6570588">err</span><span class="op" id="6570591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570604">if</span>&nbsp;<span class="ident" id="6570607">have</span><span class="op" id="6570611">,</span>&nbsp;<span class="ident" id="6570613">want</span>&nbsp;<span class="op" id="6570618">:=</span>&nbsp;<span class="ident" id="6570621">buf</span><span class="op" id="6570624">.</span><span class="ident" id="6570625">String</span><span class="op" id="6570631">(</span><span class="op" id="6570632">)</span><span class="op" id="6570633">,</span>&nbsp;<span class="ident" id="6570635">nlines</span><span class="op" id="6570641">(</span><span class="ident" id="6570642">streamEncoded</span><span class="op" id="6570655">,</span>&nbsp;<span class="ident" id="6570657">i</span><span class="op" id="6570658">)</span><span class="op" id="6570659">;</span>&nbsp;<span class="ident" id="6570661">have</span>&nbsp;<span class="op" id="6570666">!=</span>&nbsp;<span class="ident" id="6570669">want</span>&nbsp;<span class="op" id="6570674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570679">t</span><span class="op" id="6570680">.</span><span class="ident" id="6570681">Errorf</span><span class="op" id="6570687">(</span><span class="string" id="6570688">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="6570717">,</span>&nbsp;<span class="ident" id="6570719">i</span><span class="op" id="6570720">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6570725">diff</span><span class="op" id="6570729">(</span><span class="ident" id="6570730">t</span><span class="op" id="6570731">,</span>&nbsp;<span class="op" id="6570733">[</span><span class="op" id="6570734">]</span><span class="builtintype" id="6570735">byte</span><span class="op" id="6570739">(</span><span class="ident" id="6570740">have</span><span class="op" id="6570744">)</span><span class="op" id="6570745">,</span>&nbsp;<span class="op" id="6570747">[</span><span class="op" id="6570748">]</span><span class="builtintype" id="6570749">byte</span><span class="op" id="6570753">(</span><span class="ident" id="6570754">want</span><span class="op" id="6570758">)</span><span class="op" id="6570759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570764">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6570775">}</span><br>
<span class="lineno"></span><span class="op" id="6570777">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6570780">func</span>&nbsp;<span class="ident" id="6570785">TestDecoder</span><span class="op" id="6570796">(</span><span class="ident" id="6570797">t</span>&nbsp;<span class="op" id="6570799">*</span><span class="ident" id="6570800">testing</span><span class="op" id="6570807">.</span><span class="ident" id="6570808">T</span><span class="op" id="6570809">)</span>&nbsp;<span class="op" id="6570811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6570814">for</span>&nbsp;<span class="ident" id="6570818">i</span>&nbsp;<span class="op" id="6570820">:=</span>&nbsp;<span class="num" id="6570823">0</span><span class="op" id="6570824">;</span>&nbsp;<span class="ident" id="6570826">i</span>&nbsp;<span class="op" id="6570828">&lt;=</span>&nbsp;<span class="builtinfunc" id="6570831">len</span><span class="op" id="6570834">(</span><span class="ident" id="6570835">streamTest</span><span class="op" id="6570845">)</span><span class="op" id="6570846">;</span>&nbsp;<span class="ident" id="6570848">i</span><span class="op" id="6570849">++</span>&nbsp;<span class="op" id="6570852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570856">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570899">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6570942">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571001">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6571045">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571082">var</span>&nbsp;<span class="ident" id="6571086">buf</span>&nbsp;<span class="ident" id="6571090">bytes</span><span class="op" id="6571095">.</span><span class="ident" id="6571096">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571105">for</span>&nbsp;<span class="ident" id="6571109">_</span><span class="op" id="6571110">,</span>&nbsp;<span class="ident" id="6571112">c</span>&nbsp;<span class="op" id="6571114">:=</span>&nbsp;<span class="keyword" id="6571117">range</span>&nbsp;<span class="ident" id="6571123">nlines</span><span class="op" id="6571129">(</span><span class="ident" id="6571130">streamEncoded</span><span class="op" id="6571143">,</span>&nbsp;<span class="ident" id="6571145">i</span><span class="op" id="6571146">)</span>&nbsp;<span class="op" id="6571148">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571153">if</span>&nbsp;<span class="ident" id="6571156">c</span>&nbsp;<span class="op" id="6571158">!=</span>&nbsp;<span class="string" id="6571161">&#39;\n&#39;</span>&nbsp;<span class="op" id="6571166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571172">buf</span><span class="op" id="6571175">.</span><span class="ident" id="6571176">WriteRune</span><span class="op" id="6571185">(</span><span class="ident" id="6571186">c</span><span class="op" id="6571187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571200">out</span>&nbsp;<span class="op" id="6571204">:=</span>&nbsp;<span class="builtinfunc" id="6571207">make</span><span class="op" id="6571211">(</span><span class="op" id="6571212">[</span><span class="op" id="6571213">]</span><span class="keyword" id="6571214">interface</span><span class="op" id="6571223">{</span><span class="op" id="6571224">}</span><span class="op" id="6571225">,</span>&nbsp;<span class="ident" id="6571227">i</span><span class="op" id="6571228">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571232">dec</span>&nbsp;<span class="op" id="6571236">:=</span>&nbsp;<span class="ident" id="6571239">NewDecoder</span><span class="op" id="6571249">(</span><span class="op" id="6571250">&amp;</span><span class="ident" id="6571251">buf</span><span class="op" id="6571254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571258">for</span>&nbsp;<span class="ident" id="6571262">j</span>&nbsp;<span class="op" id="6571264">:=</span>&nbsp;<span class="keyword" id="6571267">range</span>&nbsp;<span class="ident" id="6571273">out</span>&nbsp;<span class="op" id="6571277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571282">if</span>&nbsp;<span class="ident" id="6571285">err</span>&nbsp;<span class="op" id="6571289">:=</span>&nbsp;<span class="ident" id="6571292">dec</span><span class="op" id="6571295">.</span><span class="ident" id="6571296">Decode</span><span class="op" id="6571302">(</span><span class="op" id="6571303">&amp;</span><span class="ident" id="6571304">out</span><span class="op" id="6571307">[</span><span class="ident" id="6571308">j</span><span class="op" id="6571309">]</span><span class="op" id="6571310">)</span><span class="op" id="6571311">;</span>&nbsp;<span class="ident" id="6571313">err</span>&nbsp;<span class="op" id="6571317">!=</span>&nbsp;<span class="ident" id="6571320">nil</span>&nbsp;<span class="op" id="6571324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571330">t</span><span class="op" id="6571331">.</span><span class="ident" id="6571332">Fatalf</span><span class="op" id="6571338">(</span><span class="string" id="6571339">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="6571358">,</span>&nbsp;<span class="ident" id="6571360">j</span><span class="op" id="6571361">,</span>&nbsp;<span class="ident" id="6571363">i</span><span class="op" id="6571364">,</span>&nbsp;<span class="ident" id="6571366">err</span><span class="op" id="6571369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571374">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571382">if</span>&nbsp;<span class="op" id="6571385">!</span><span class="ident" id="6571386">reflect</span><span class="op" id="6571393">.</span><span class="ident" id="6571394">DeepEqual</span><span class="op" id="6571403">(</span><span class="ident" id="6571404">out</span><span class="op" id="6571407">,</span>&nbsp;<span class="ident" id="6571409">streamTest</span><span class="op" id="6571419">[</span><span class="num" id="6571420">0</span><span class="op" id="6571421">:</span><span class="ident" id="6571422">i</span><span class="op" id="6571423">]</span><span class="op" id="6571424">)</span>&nbsp;<span class="op" id="6571426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571431">t</span><span class="op" id="6571432">.</span><span class="ident" id="6571433">Errorf</span><span class="op" id="6571439">(</span><span class="string" id="6571440">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="6571469">,</span>&nbsp;<span class="ident" id="6571471">i</span><span class="op" id="6571472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571477">for</span>&nbsp;<span class="ident" id="6571481">j</span>&nbsp;<span class="op" id="6571483">:=</span>&nbsp;<span class="keyword" id="6571486">range</span>&nbsp;<span class="ident" id="6571492">out</span>&nbsp;<span class="op" id="6571496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571502">if</span>&nbsp;<span class="op" id="6571505">!</span><span class="ident" id="6571506">reflect</span><span class="op" id="6571513">.</span><span class="ident" id="6571514">DeepEqual</span><span class="op" id="6571523">(</span><span class="ident" id="6571524">out</span><span class="op" id="6571527">[</span><span class="ident" id="6571528">j</span><span class="op" id="6571529">]</span><span class="op" id="6571530">,</span>&nbsp;<span class="ident" id="6571532">streamTest</span><span class="op" id="6571542">[</span><span class="ident" id="6571543">j</span><span class="op" id="6571544">]</span><span class="op" id="6571545">)</span>&nbsp;<span class="op" id="6571547">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571554">t</span><span class="op" id="6571555">.</span><span class="ident" id="6571556">Errorf</span><span class="op" id="6571562">(</span><span class="string" id="6571563">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6571585">,</span>&nbsp;<span class="ident" id="6571587">j</span><span class="op" id="6571588">,</span>&nbsp;<span class="ident" id="6571590">out</span><span class="op" id="6571593">[</span><span class="ident" id="6571594">j</span><span class="op" id="6571595">]</span><span class="op" id="6571596">,</span>&nbsp;<span class="ident" id="6571598">streamTest</span><span class="op" id="6571608">[</span><span class="ident" id="6571609">j</span><span class="op" id="6571610">]</span><span class="op" id="6571611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571627">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571635">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571638">}</span><br>
<span class="lineno"></span><span class="op" id="6571640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6571643">func</span>&nbsp;<span class="ident" id="6571648">TestDecoderBuffered</span><span class="op" id="6571667">(</span><span class="ident" id="6571668">t</span>&nbsp;<span class="op" id="6571670">*</span><span class="ident" id="6571671">testing</span><span class="op" id="6571678">.</span><span class="ident" id="6571679">T</span><span class="op" id="6571680">)</span>&nbsp;<span class="op" id="6571682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571685">r</span>&nbsp;<span class="op" id="6571687">:=</span>&nbsp;<span class="ident" id="6571690">strings</span><span class="op" id="6571697">.</span><span class="ident" id="6571698">NewReader</span><span class="op" id="6571707">(</span><span class="string" id="6571708">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="6571735">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571738">var</span>&nbsp;<span class="ident" id="6571742">m</span>&nbsp;<span class="keyword" id="6571744">struct</span>&nbsp;<span class="op" id="6571751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571755">Name</span>&nbsp;<span class="builtintype" id="6571760">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571771">d</span>&nbsp;<span class="op" id="6571773">:=</span>&nbsp;<span class="ident" id="6571776">NewDecoder</span><span class="op" id="6571786">(</span><span class="ident" id="6571787">r</span><span class="op" id="6571788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571791">err</span>&nbsp;<span class="op" id="6571795">:=</span>&nbsp;<span class="ident" id="6571798">d</span><span class="op" id="6571799">.</span><span class="ident" id="6571800">Decode</span><span class="op" id="6571806">(</span><span class="op" id="6571807">&amp;</span><span class="ident" id="6571808">m</span><span class="op" id="6571809">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571812">if</span>&nbsp;<span class="ident" id="6571815">err</span>&nbsp;<span class="op" id="6571819">!=</span>&nbsp;<span class="ident" id="6571822">nil</span>&nbsp;<span class="op" id="6571826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571830">t</span><span class="op" id="6571831">.</span><span class="ident" id="6571832">Fatal</span><span class="op" id="6571837">(</span><span class="ident" id="6571838">err</span><span class="op" id="6571841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571847">if</span>&nbsp;<span class="ident" id="6571850">m</span><span class="op" id="6571851">.</span><span class="ident" id="6571852">Name</span>&nbsp;<span class="op" id="6571857">!=</span>&nbsp;<span class="string" id="6571860">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="6571869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571873">t</span><span class="op" id="6571874">.</span><span class="ident" id="6571875">Errorf</span><span class="op" id="6571881">(</span><span class="string" id="6571882">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="6571906">,</span>&nbsp;<span class="ident" id="6571908">m</span><span class="op" id="6571909">.</span><span class="ident" id="6571910">Name</span><span class="op" id="6571914">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571920">rest</span><span class="op" id="6571924">,</span>&nbsp;<span class="ident" id="6571926">err</span>&nbsp;<span class="op" id="6571930">:=</span>&nbsp;<span class="ident" id="6571933">ioutil</span><span class="op" id="6571939">.</span><span class="ident" id="6571940">ReadAll</span><span class="op" id="6571947">(</span><span class="ident" id="6571948">d</span><span class="op" id="6571949">.</span><span class="ident" id="6571950">Buffered</span><span class="op" id="6571958">(</span><span class="op" id="6571959">)</span><span class="op" id="6571960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571963">if</span>&nbsp;<span class="ident" id="6571966">err</span>&nbsp;<span class="op" id="6571970">!=</span>&nbsp;<span class="ident" id="6571973">nil</span>&nbsp;<span class="op" id="6571977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6571981">t</span><span class="op" id="6571982">.</span><span class="ident" id="6571983">Fatal</span><span class="op" id="6571988">(</span><span class="ident" id="6571989">err</span><span class="op" id="6571992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6571995">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6571998">if</span>&nbsp;<span class="ident" id="6572001">g</span><span class="op" id="6572002">,</span>&nbsp;<span class="ident" id="6572004">w</span>&nbsp;<span class="op" id="6572006">:=</span>&nbsp;<span class="builtintype" id="6572009">string</span><span class="op" id="6572015">(</span><span class="ident" id="6572016">rest</span><span class="op" id="6572020">)</span><span class="op" id="6572021">,</span>&nbsp;<span class="string" id="6572023">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="6572032">;</span>&nbsp;<span class="ident" id="6572034">g</span>&nbsp;<span class="op" id="6572036">!=</span>&nbsp;<span class="ident" id="6572039">w</span>&nbsp;<span class="op" id="6572041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572045">t</span><span class="op" id="6572046">.</span><span class="ident" id="6572047">Errorf</span><span class="op" id="6572053">(</span><span class="string" id="6572054">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6572079">,</span>&nbsp;<span class="ident" id="6572081">g</span><span class="op" id="6572082">,</span>&nbsp;<span class="ident" id="6572084">w</span><span class="op" id="6572085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572088">}</span><br>
<span class="lineno"></span><span class="op" id="6572090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6572093">func</span>&nbsp;<span class="ident" id="6572098">nlines</span><span class="op" id="6572104">(</span><span class="ident" id="6572105">s</span>&nbsp;<span class="builtintype" id="6572107">string</span><span class="op" id="6572113">,</span>&nbsp;<span class="ident" id="6572115">n</span>&nbsp;<span class="builtintype" id="6572117">int</span><span class="op" id="6572120">)</span>&nbsp;<span class="builtintype" id="6572122">string</span>&nbsp;<span class="op" id="6572129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572132">if</span>&nbsp;<span class="ident" id="6572135">n</span>&nbsp;<span class="op" id="6572137">&lt;=</span>&nbsp;<span class="num" id="6572140">0</span>&nbsp;<span class="op" id="6572142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572146">return</span>&nbsp;<span class="string" id="6572153">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572160">for</span>&nbsp;<span class="ident" id="6572164">i</span><span class="op" id="6572165">,</span>&nbsp;<span class="ident" id="6572167">c</span>&nbsp;<span class="op" id="6572169">:=</span>&nbsp;<span class="keyword" id="6572172">range</span>&nbsp;<span class="ident" id="6572178">s</span>&nbsp;<span class="op" id="6572180">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572184">if</span>&nbsp;<span class="ident" id="6572187">c</span>&nbsp;<span class="op" id="6572189">==</span>&nbsp;<span class="string" id="6572192">&#39;\n&#39;</span>&nbsp;<span class="op" id="6572197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572202">if</span>&nbsp;<span class="ident" id="6572205">n</span><span class="op" id="6572206">--</span><span class="op" id="6572208">;</span>&nbsp;<span class="ident" id="6572210">n</span>&nbsp;<span class="op" id="6572212">==</span>&nbsp;<span class="num" id="6572215">0</span>&nbsp;<span class="op" id="6572217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572223">return</span>&nbsp;<span class="ident" id="6572230">s</span><span class="op" id="6572231">[</span><span class="num" id="6572232">0</span>&nbsp;<span class="op" id="6572234">:</span>&nbsp;<span class="ident" id="6572236">i</span><span class="op" id="6572237">+</span><span class="num" id="6572238">1</span><span class="op" id="6572239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572248">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572254">return</span>&nbsp;<span class="ident" id="6572261">s</span><br>
<span class="lineno"></span><span class="op" id="6572263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6572266">func</span>&nbsp;<span class="ident" id="6572271">TestRawMessage</span><span class="op" id="6572285">(</span><span class="ident" id="6572286">t</span>&nbsp;<span class="op" id="6572288">*</span><span class="ident" id="6572289">testing</span><span class="op" id="6572296">.</span><span class="ident" id="6572297">T</span><span class="op" id="6572298">)</span>&nbsp;<span class="op" id="6572300">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572303">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572355">var</span>&nbsp;<span class="ident" id="6572359">data</span>&nbsp;<span class="keyword" id="6572364">struct</span>&nbsp;<span class="op" id="6572371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572375">X</span>&nbsp;&nbsp;<span class="builtintype" id="6572378">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572388">Id</span>&nbsp;<span class="op" id="6572391">*</span><span class="ident" id="6572392">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572405">Y</span>&nbsp;&nbsp;<span class="builtintype" id="6572408">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572420">const</span>&nbsp;<span class="ident" id="6572426">raw</span>&nbsp;<span class="op" id="6572430">=</span>&nbsp;<span class="string" id="6572432">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572451">const</span>&nbsp;<span class="ident" id="6572457">msg</span>&nbsp;<span class="op" id="6572461">=</span>&nbsp;<span class="string" id="6572463">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572505">err</span>&nbsp;<span class="op" id="6572509">:=</span>&nbsp;<span class="ident" id="6572512">Unmarshal</span><span class="op" id="6572521">(</span><span class="op" id="6572522">[</span><span class="op" id="6572523">]</span><span class="builtintype" id="6572524">byte</span><span class="op" id="6572528">(</span><span class="ident" id="6572529">msg</span><span class="op" id="6572532">)</span><span class="op" id="6572533">,</span>&nbsp;<span class="op" id="6572535">&amp;</span><span class="ident" id="6572536">data</span><span class="op" id="6572540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572543">if</span>&nbsp;<span class="ident" id="6572546">err</span>&nbsp;<span class="op" id="6572550">!=</span>&nbsp;<span class="ident" id="6572553">nil</span>&nbsp;<span class="op" id="6572557">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572561">t</span><span class="op" id="6572562">.</span><span class="ident" id="6572563">Fatalf</span><span class="op" id="6572569">(</span><span class="string" id="6572570">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="6572585">,</span>&nbsp;<span class="ident" id="6572587">err</span><span class="op" id="6572590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572596">if</span>&nbsp;<span class="builtintype" id="6572599">string</span><span class="op" id="6572605">(</span><span class="op" id="6572606">[</span><span class="op" id="6572607">]</span><span class="builtintype" id="6572608">byte</span><span class="op" id="6572612">(</span><span class="op" id="6572613">*</span><span class="ident" id="6572614">data</span><span class="op" id="6572618">.</span><span class="ident" id="6572619">Id</span><span class="op" id="6572621">)</span><span class="op" id="6572622">)</span>&nbsp;<span class="op" id="6572624">!=</span>&nbsp;<span class="ident" id="6572627">raw</span>&nbsp;<span class="op" id="6572631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572635">t</span><span class="op" id="6572636">.</span><span class="ident" id="6572637">Fatalf</span><span class="op" id="6572643">(</span><span class="string" id="6572644">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6572677">,</span>&nbsp;<span class="op" id="6572679">[</span><span class="op" id="6572680">]</span><span class="builtintype" id="6572681">byte</span><span class="op" id="6572685">(</span><span class="op" id="6572686">*</span><span class="ident" id="6572687">data</span><span class="op" id="6572691">.</span><span class="ident" id="6572692">Id</span><span class="op" id="6572694">)</span><span class="op" id="6572695">,</span>&nbsp;<span class="ident" id="6572697">raw</span><span class="op" id="6572700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572703">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572706">b</span><span class="op" id="6572707">,</span>&nbsp;<span class="ident" id="6572709">err</span>&nbsp;<span class="op" id="6572713">:=</span>&nbsp;<span class="ident" id="6572716">Marshal</span><span class="op" id="6572723">(</span><span class="op" id="6572724">&amp;</span><span class="ident" id="6572725">data</span><span class="op" id="6572729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572732">if</span>&nbsp;<span class="ident" id="6572735">err</span>&nbsp;<span class="op" id="6572739">!=</span>&nbsp;<span class="ident" id="6572742">nil</span>&nbsp;<span class="op" id="6572746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572750">t</span><span class="op" id="6572751">.</span><span class="ident" id="6572752">Fatalf</span><span class="op" id="6572758">(</span><span class="string" id="6572759">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="6572772">,</span>&nbsp;<span class="ident" id="6572774">err</span><span class="op" id="6572777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572783">if</span>&nbsp;<span class="builtintype" id="6572786">string</span><span class="op" id="6572792">(</span><span class="ident" id="6572793">b</span><span class="op" id="6572794">)</span>&nbsp;<span class="op" id="6572796">!=</span>&nbsp;<span class="ident" id="6572799">msg</span>&nbsp;<span class="op" id="6572803">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572807">t</span><span class="op" id="6572808">.</span><span class="ident" id="6572809">Fatalf</span><span class="op" id="6572815">(</span><span class="string" id="6572816">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6572844">,</span>&nbsp;<span class="ident" id="6572846">b</span><span class="op" id="6572847">,</span>&nbsp;<span class="ident" id="6572849">msg</span><span class="op" id="6572852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6572855">}</span><br>
<span class="lineno"></span><span class="op" id="6572857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6572860">func</span>&nbsp;<span class="ident" id="6572865">TestNullRawMessage</span><span class="op" id="6572883">(</span><span class="ident" id="6572884">t</span>&nbsp;<span class="op" id="6572886">*</span><span class="ident" id="6572887">testing</span><span class="op" id="6572894">.</span><span class="ident" id="6572895">T</span><span class="op" id="6572896">)</span>&nbsp;<span class="op" id="6572898">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6572901">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6572953">var</span>&nbsp;<span class="ident" id="6572957">data</span>&nbsp;<span class="keyword" id="6572962">struct</span>&nbsp;<span class="op" id="6572969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572973">X</span>&nbsp;&nbsp;<span class="builtintype" id="6572976">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6572986">Id</span>&nbsp;<span class="op" id="6572989">*</span><span class="ident" id="6572990">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573003">Y</span>&nbsp;&nbsp;<span class="builtintype" id="6573006">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573018">data</span><span class="op" id="6573022">.</span><span class="ident" id="6573023">Id</span>&nbsp;<span class="op" id="6573026">=</span>&nbsp;<span class="builtinfunc" id="6573028">new</span><span class="op" id="6573031">(</span><span class="ident" id="6573032">RawMessage</span><span class="op" id="6573042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573045">const</span>&nbsp;<span class="ident" id="6573051">msg</span>&nbsp;<span class="op" id="6573055">=</span>&nbsp;<span class="string" id="6573057">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573088">err</span>&nbsp;<span class="op" id="6573092">:=</span>&nbsp;<span class="ident" id="6573095">Unmarshal</span><span class="op" id="6573104">(</span><span class="op" id="6573105">[</span><span class="op" id="6573106">]</span><span class="builtintype" id="6573107">byte</span><span class="op" id="6573111">(</span><span class="ident" id="6573112">msg</span><span class="op" id="6573115">)</span><span class="op" id="6573116">,</span>&nbsp;<span class="op" id="6573118">&amp;</span><span class="ident" id="6573119">data</span><span class="op" id="6573123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573126">if</span>&nbsp;<span class="ident" id="6573129">err</span>&nbsp;<span class="op" id="6573133">!=</span>&nbsp;<span class="ident" id="6573136">nil</span>&nbsp;<span class="op" id="6573140">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573144">t</span><span class="op" id="6573145">.</span><span class="ident" id="6573146">Fatalf</span><span class="op" id="6573152">(</span><span class="string" id="6573153">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="6573168">,</span>&nbsp;<span class="ident" id="6573170">err</span><span class="op" id="6573173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573179">if</span>&nbsp;<span class="ident" id="6573182">data</span><span class="op" id="6573186">.</span><span class="ident" id="6573187">Id</span>&nbsp;<span class="op" id="6573190">!=</span>&nbsp;<span class="ident" id="6573193">nil</span>&nbsp;<span class="op" id="6573197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573201">t</span><span class="op" id="6573202">.</span><span class="ident" id="6573203">Fatalf</span><span class="op" id="6573209">(</span><span class="string" id="6573210">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="6573248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573251">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573254">b</span><span class="op" id="6573255">,</span>&nbsp;<span class="ident" id="6573257">err</span>&nbsp;<span class="op" id="6573261">:=</span>&nbsp;<span class="ident" id="6573264">Marshal</span><span class="op" id="6573271">(</span><span class="op" id="6573272">&amp;</span><span class="ident" id="6573273">data</span><span class="op" id="6573277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573280">if</span>&nbsp;<span class="ident" id="6573283">err</span>&nbsp;<span class="op" id="6573287">!=</span>&nbsp;<span class="ident" id="6573290">nil</span>&nbsp;<span class="op" id="6573294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573298">t</span><span class="op" id="6573299">.</span><span class="ident" id="6573300">Fatalf</span><span class="op" id="6573306">(</span><span class="string" id="6573307">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="6573320">,</span>&nbsp;<span class="ident" id="6573322">err</span><span class="op" id="6573325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573331">if</span>&nbsp;<span class="builtintype" id="6573334">string</span><span class="op" id="6573340">(</span><span class="ident" id="6573341">b</span><span class="op" id="6573342">)</span>&nbsp;<span class="op" id="6573344">!=</span>&nbsp;<span class="ident" id="6573347">msg</span>&nbsp;<span class="op" id="6573351">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573355">t</span><span class="op" id="6573356">.</span><span class="ident" id="6573357">Fatalf</span><span class="op" id="6573363">(</span><span class="string" id="6573364">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="6573392">,</span>&nbsp;<span class="ident" id="6573394">b</span><span class="op" id="6573395">,</span>&nbsp;<span class="ident" id="6573397">msg</span><span class="op" id="6573400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573403">}</span><br>
<span class="lineno"></span><span class="op" id="6573405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6573408">var</span>&nbsp;<span class="ident" id="6573412">blockingTests</span>&nbsp;<span class="op" id="6573426">=</span>&nbsp;<span class="op" id="6573428">[</span><span class="op" id="6573429">]</span><span class="builtintype" id="6573430">string</span><span class="op" id="6573436">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573439">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="6573449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6573452">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="6573463">,</span><br>
<span class="lineno"></span><span class="op" id="6573465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6573468">func</span>&nbsp;<span class="ident" id="6573473">TestBlocking</span><span class="op" id="6573485">(</span><span class="ident" id="6573486">t</span>&nbsp;<span class="op" id="6573488">*</span><span class="ident" id="6573489">testing</span><span class="op" id="6573496">.</span><span class="ident" id="6573497">T</span><span class="op" id="6573498">)</span>&nbsp;<span class="op" id="6573500">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573503">for</span>&nbsp;<span class="ident" id="6573507">_</span><span class="op" id="6573508">,</span>&nbsp;<span class="ident" id="6573510">enc</span>&nbsp;<span class="op" id="6573514">:=</span>&nbsp;<span class="keyword" id="6573517">range</span>&nbsp;<span class="ident" id="6573523">blockingTests</span>&nbsp;<span class="op" id="6573537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573541">r</span><span class="op" id="6573542">,</span>&nbsp;<span class="ident" id="6573544">w</span>&nbsp;<span class="op" id="6573546">:=</span>&nbsp;<span class="ident" id="6573549">net</span><span class="op" id="6573552">.</span><span class="ident" id="6573553">Pipe</span><span class="op" id="6573557">(</span><span class="op" id="6573558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573562">go</span>&nbsp;<span class="ident" id="6573565">w</span><span class="op" id="6573566">.</span><span class="ident" id="6573567">Write</span><span class="op" id="6573572">(</span><span class="op" id="6573573">[</span><span class="op" id="6573574">]</span><span class="builtintype" id="6573575">byte</span><span class="op" id="6573579">(</span><span class="ident" id="6573580">enc</span><span class="op" id="6573583">)</span><span class="op" id="6573584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573588">var</span>&nbsp;<span class="ident" id="6573592">val</span>&nbsp;<span class="keyword" id="6573596">interface</span><span class="op" id="6573605">{</span><span class="op" id="6573606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6573611">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6573666">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573714">if</span>&nbsp;<span class="ident" id="6573717">err</span>&nbsp;<span class="op" id="6573721">:=</span>&nbsp;<span class="ident" id="6573724">NewDecoder</span><span class="op" id="6573734">(</span><span class="ident" id="6573735">r</span><span class="op" id="6573736">)</span><span class="op" id="6573737">.</span><span class="ident" id="6573738">Decode</span><span class="op" id="6573744">(</span><span class="op" id="6573745">&amp;</span><span class="ident" id="6573746">val</span><span class="op" id="6573749">)</span><span class="op" id="6573750">;</span>&nbsp;<span class="ident" id="6573752">err</span>&nbsp;<span class="op" id="6573756">!=</span>&nbsp;<span class="ident" id="6573759">nil</span>&nbsp;<span class="op" id="6573763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573768">t</span><span class="op" id="6573769">.</span><span class="ident" id="6573770">Errorf</span><span class="op" id="6573776">(</span><span class="string" id="6573777">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="6573794">,</span>&nbsp;<span class="ident" id="6573796">enc</span><span class="op" id="6573799">,</span>&nbsp;<span class="ident" id="6573801">err</span><span class="op" id="6573804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573808">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573812">r</span><span class="op" id="6573813">.</span><span class="ident" id="6573814">Close</span><span class="op" id="6573819">(</span><span class="op" id="6573820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573824">w</span><span class="op" id="6573825">.</span><span class="ident" id="6573826">Close</span><span class="op" id="6573831">(</span><span class="op" id="6573832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573835">}</span><br>
<span class="lineno"></span><span class="op" id="6573837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="6573840">func</span>&nbsp;<span class="ident" id="6573845">BenchmarkEncoderEncode</span><span class="op" id="6573867">(</span><span class="ident" id="6573868">b</span>&nbsp;<span class="op" id="6573870">*</span><span class="ident" id="6573871">testing</span><span class="op" id="6573878">.</span><span class="ident" id="6573879">B</span><span class="op" id="6573880">)</span>&nbsp;<span class="op" id="6573882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573885">b</span><span class="op" id="6573886">.</span><span class="ident" id="6573887">ReportAllocs</span><span class="op" id="6573899">(</span><span class="op" id="6573900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573903">type</span>&nbsp;<span class="ident" id="6573908">T</span>&nbsp;<span class="keyword" id="6573910">struct</span>&nbsp;<span class="op" id="6573917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573921">X</span><span class="op" id="6573922">,</span>&nbsp;<span class="ident" id="6573924">Y</span>&nbsp;<span class="builtintype" id="6573926">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6573934">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6573937">v</span>&nbsp;<span class="op" id="6573939">:=</span>&nbsp;<span class="op" id="6573942">&amp;</span><span class="ident" id="6573943">T</span><span class="op" id="6573944">{</span><span class="string" id="6573945">&#34;foo&#34;</span><span class="op" id="6573950">,</span>&nbsp;<span class="string" id="6573952">&#34;bar&#34;</span><span class="op" id="6573957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573960">for</span>&nbsp;<span class="ident" id="6573964">i</span>&nbsp;<span class="op" id="6573966">:=</span>&nbsp;<span class="num" id="6573969">0</span><span class="op" id="6573970">;</span>&nbsp;<span class="ident" id="6573972">i</span>&nbsp;<span class="op" id="6573974">&lt;</span>&nbsp;<span class="ident" id="6573976">b</span><span class="op" id="6573977">.</span><span class="ident" id="6573978">N</span><span class="op" id="6573979">;</span>&nbsp;<span class="ident" id="6573981">i</span><span class="op" id="6573982">++</span>&nbsp;<span class="op" id="6573985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6573989">if</span>&nbsp;<span class="ident" id="6573992">err</span>&nbsp;<span class="op" id="6573996">:=</span>&nbsp;<span class="ident" id="6573999">NewEncoder</span><span class="op" id="6574009">(</span><span class="ident" id="6574010">ioutil</span><span class="op" id="6574016">.</span><span class="ident" id="6574017">Discard</span><span class="op" id="6574024">)</span><span class="op" id="6574025">.</span><span class="ident" id="6574026">Encode</span><span class="op" id="6574032">(</span><span class="ident" id="6574033">v</span><span class="op" id="6574034">)</span><span class="op" id="6574035">;</span>&nbsp;<span class="ident" id="6574037">err</span>&nbsp;<span class="op" id="6574041">!=</span>&nbsp;<span class="ident" id="6574044">nil</span>&nbsp;<span class="op" id="6574048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6574053">b</span><span class="op" id="6574054">.</span><span class="ident" id="6574055">Fatal</span><span class="op" id="6574060">(</span><span class="ident" id="6574061">err</span><span class="op" id="6574064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574068">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6574071">}</span><br>
<span class="lineno"></span><span class="op" id="6574073">}</span>
</div>
</body>
</html>
