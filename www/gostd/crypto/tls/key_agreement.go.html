<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4530685">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4530740">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4530794">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4530845">package</span>&nbsp;<span class="ident" id="4530853">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4530858">import</span>&nbsp;<span class="op" id="4530865">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530868">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530878">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530894">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530913">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530927">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530941">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530956">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530973">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4530988">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4531005">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4531015">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4531021">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4531032">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4531035">var</span>&nbsp;<span class="ident" id="4531039">errClientKeyExchange</span>&nbsp;<span class="op" id="4531060">=</span>&nbsp;<span class="ident" id="4531062">errors</span><span class="op" id="4531068">.</span><span class="ident" id="4531069">New</span><span class="op" id="4531072">(</span><span class="string" id="4531073">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="4531113">)</span><br>
<span class="lineno"></span><span class="keyword" id="4531115">var</span>&nbsp;<span class="ident" id="4531119">errServerKeyExchange</span>&nbsp;<span class="op" id="4531140">=</span>&nbsp;<span class="ident" id="4531142">errors</span><span class="op" id="4531148">.</span><span class="ident" id="4531149">New</span><span class="op" id="4531152">(</span><span class="string" id="4531153">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4531193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4531196">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4531274">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4531336">type</span>&nbsp;<span class="ident" id="4531341">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="4531357">struct</span><span class="op" id="4531363">{</span><span class="op" id="4531364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4531367">func</span>&nbsp;<span class="op" id="4531372">(</span><span class="ident" id="4531373">ka</span>&nbsp;<span class="ident" id="4531376">rsaKeyAgreement</span><span class="op" id="4531391">)</span>&nbsp;<span class="ident" id="4531393">generateServerKeyExchange</span><span class="op" id="4531418">(</span><span class="ident" id="4531419">config</span>&nbsp;<span class="op" id="4531426">*</span><span class="ident" id="4531427">Config</span><span class="op" id="4531433">,</span>&nbsp;<span class="ident" id="4531435">cert</span>&nbsp;<span class="op" id="4531440">*</span><span class="ident" id="4531441">Certificate</span><span class="op" id="4531452">,</span>&nbsp;<span class="ident" id="4531454">clientHello</span>&nbsp;<span class="op" id="4531466">*</span><span class="ident" id="4531467">clientHelloMsg</span><span class="op" id="4531481">,</span>&nbsp;<span class="ident" id="4531483">hello</span>&nbsp;<span class="op" id="4531489">*</span><span class="ident" id="4531490">serverHelloMsg</span><span class="op" id="4531504">)</span>&nbsp;<span class="op" id="4531506">(</span><span class="op" id="4531507">*</span><span class="ident" id="4531508">serverKeyExchangeMsg</span><span class="op" id="4531528">,</span>&nbsp;<span class="builtintype" id="4531530">error</span><span class="op" id="4531535">)</span>&nbsp;<span class="op" id="4531537">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531540">return</span>&nbsp;<span class="ident" id="4531547">nil</span><span class="op" id="4531550">,</span>&nbsp;<span class="ident" id="4531552">nil</span><br>
<span class="lineno"></span><span class="op" id="4531556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4531559">func</span>&nbsp;<span class="op" id="4531564">(</span><span class="ident" id="4531565">ka</span>&nbsp;<span class="ident" id="4531568">rsaKeyAgreement</span><span class="op" id="4531583">)</span>&nbsp;<span class="ident" id="4531585">processClientKeyExchange</span><span class="op" id="4531609">(</span><span class="ident" id="4531610">config</span>&nbsp;<span class="op" id="4531617">*</span><span class="ident" id="4531618">Config</span><span class="op" id="4531624">,</span>&nbsp;<span class="ident" id="4531626">cert</span>&nbsp;<span class="op" id="4531631">*</span><span class="ident" id="4531632">Certificate</span><span class="op" id="4531643">,</span>&nbsp;<span class="ident" id="4531645">ckx</span>&nbsp;<span class="op" id="4531649">*</span><span class="ident" id="4531650">clientKeyExchangeMsg</span><span class="op" id="4531670">,</span>&nbsp;<span class="ident" id="4531672">version</span>&nbsp;<span class="builtintype" id="4531680">uint16</span><span class="op" id="4531686">)</span>&nbsp;<span class="op" id="4531688">(</span><span class="op" id="4531689">[</span><span class="op" id="4531690">]</span><span class="builtintype" id="4531691">byte</span><span class="op" id="4531695">,</span>&nbsp;<span class="builtintype" id="4531697">error</span><span class="op" id="4531702">)</span>&nbsp;<span class="op" id="4531704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531707">preMasterSecret</span>&nbsp;<span class="op" id="4531723">:=</span>&nbsp;<span class="builtinfunc" id="4531726">make</span><span class="op" id="4531730">(</span><span class="op" id="4531731">[</span><span class="op" id="4531732">]</span><span class="builtintype" id="4531733">byte</span><span class="op" id="4531737">,</span>&nbsp;<span class="num" id="4531739">48</span><span class="op" id="4531741">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531744">_</span><span class="op" id="4531745">,</span>&nbsp;<span class="ident" id="4531747">err</span>&nbsp;<span class="op" id="4531751">:=</span>&nbsp;<span class="ident" id="4531754">io</span><span class="op" id="4531756">.</span><span class="ident" id="4531757">ReadFull</span><span class="op" id="4531765">(</span><span class="ident" id="4531766">config</span><span class="op" id="4531772">.</span><span class="ident" id="4531773">rand</span><span class="op" id="4531777">(</span><span class="op" id="4531778">)</span><span class="op" id="4531779">,</span>&nbsp;<span class="ident" id="4531781">preMasterSecret</span><span class="op" id="4531796">[</span><span class="num" id="4531797">2</span><span class="op" id="4531798">:</span><span class="op" id="4531799">]</span><span class="op" id="4531800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531803">if</span>&nbsp;<span class="ident" id="4531806">err</span>&nbsp;<span class="op" id="4531810">!=</span>&nbsp;<span class="ident" id="4531813">nil</span>&nbsp;<span class="op" id="4531817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531821">return</span>&nbsp;<span class="ident" id="4531828">nil</span><span class="op" id="4531831">,</span>&nbsp;<span class="ident" id="4531833">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531842">if</span>&nbsp;<span class="builtinfunc" id="4531845">len</span><span class="op" id="4531848">(</span><span class="ident" id="4531849">ckx</span><span class="op" id="4531852">.</span><span class="ident" id="4531853">ciphertext</span><span class="op" id="4531863">)</span>&nbsp;<span class="op" id="4531865">&lt;</span>&nbsp;<span class="num" id="4531867">2</span>&nbsp;<span class="op" id="4531869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531873">return</span>&nbsp;<span class="ident" id="4531880">nil</span><span class="op" id="4531883">,</span>&nbsp;<span class="ident" id="4531885">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4531907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531911">ciphertext</span>&nbsp;<span class="op" id="4531922">:=</span>&nbsp;<span class="ident" id="4531925">ckx</span><span class="op" id="4531928">.</span><span class="ident" id="4531929">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4531941">if</span>&nbsp;<span class="ident" id="4531944">version</span>&nbsp;<span class="op" id="4531952">!=</span>&nbsp;<span class="ident" id="4531955">VersionSSL30</span>&nbsp;<span class="op" id="4531968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4531972">ciphertextLen</span>&nbsp;<span class="op" id="4531986">:=</span>&nbsp;<span class="builtintype" id="4531989">int</span><span class="op" id="4531992">(</span><span class="ident" id="4531993">ckx</span><span class="op" id="4531996">.</span><span class="ident" id="4531997">ciphertext</span><span class="op" id="4532007">[</span><span class="num" id="4532008">0</span><span class="op" id="4532009">]</span><span class="op" id="4532010">)</span><span class="op" id="4532011">&lt;&lt;</span><span class="num" id="4532013">8</span>&nbsp;<span class="op" id="4532015">|</span>&nbsp;<span class="builtintype" id="4532017">int</span><span class="op" id="4532020">(</span><span class="ident" id="4532021">ckx</span><span class="op" id="4532024">.</span><span class="ident" id="4532025">ciphertext</span><span class="op" id="4532035">[</span><span class="num" id="4532036">1</span><span class="op" id="4532037">]</span><span class="op" id="4532038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532042">if</span>&nbsp;<span class="ident" id="4532045">ciphertextLen</span>&nbsp;<span class="op" id="4532059">!=</span>&nbsp;<span class="builtinfunc" id="4532062">len</span><span class="op" id="4532065">(</span><span class="ident" id="4532066">ckx</span><span class="op" id="4532069">.</span><span class="ident" id="4532070">ciphertext</span><span class="op" id="4532080">)</span><span class="op" id="4532081">-</span><span class="num" id="4532082">2</span>&nbsp;<span class="op" id="4532084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532089">return</span>&nbsp;<span class="ident" id="4532096">nil</span><span class="op" id="4532099">,</span>&nbsp;<span class="ident" id="4532101">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532124">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532128">ciphertext</span>&nbsp;<span class="op" id="4532139">=</span>&nbsp;<span class="ident" id="4532141">ckx</span><span class="op" id="4532144">.</span><span class="ident" id="4532145">ciphertext</span><span class="op" id="4532155">[</span><span class="num" id="4532156">2</span><span class="op" id="4532157">:</span><span class="op" id="4532158">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4532165">err</span>&nbsp;<span class="op" id="4532169">=</span>&nbsp;<span class="ident" id="4532171">rsa</span><span class="op" id="4532174">.</span><span class="ident" id="4532175">DecryptPKCS1v15SessionKey</span><span class="op" id="4532200">(</span><span class="ident" id="4532201">config</span><span class="op" id="4532207">.</span><span class="ident" id="4532208">rand</span><span class="op" id="4532212">(</span><span class="op" id="4532213">)</span><span class="op" id="4532214">,</span>&nbsp;<span class="ident" id="4532216">cert</span><span class="op" id="4532220">.</span><span class="ident" id="4532221">PrivateKey</span><span class="op" id="4532231">.</span><span class="op" id="4532232">(</span><span class="op" id="4532233">*</span><span class="ident" id="4532234">rsa</span><span class="op" id="4532237">.</span><span class="ident" id="4532238">PrivateKey</span><span class="op" id="4532248">)</span><span class="op" id="4532249">,</span>&nbsp;<span class="ident" id="4532251">ciphertext</span><span class="op" id="4532261">,</span>&nbsp;<span class="ident" id="4532263">preMasterSecret</span><span class="op" id="4532278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532281">if</span>&nbsp;<span class="ident" id="4532284">err</span>&nbsp;<span class="op" id="4532288">!=</span>&nbsp;<span class="ident" id="4532291">nil</span>&nbsp;<span class="op" id="4532295">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532299">return</span>&nbsp;<span class="ident" id="4532306">nil</span><span class="op" id="4532309">,</span>&nbsp;<span class="ident" id="4532311">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4532316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532319">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532392">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532464">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532532">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532605">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4532672">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532697">return</span>&nbsp;<span class="ident" id="4532704">preMasterSecret</span><span class="op" id="4532719">,</span>&nbsp;<span class="ident" id="4532721">nil</span><br>
<span class="lineno"></span><span class="op" id="4532725">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4532728">func</span>&nbsp;<span class="op" id="4532733">(</span><span class="ident" id="4532734">ka</span>&nbsp;<span class="ident" id="4532737">rsaKeyAgreement</span><span class="op" id="4532752">)</span>&nbsp;<span class="ident" id="4532754">processServerKeyExchange</span><span class="op" id="4532778">(</span><span class="ident" id="4532779">config</span>&nbsp;<span class="op" id="4532786">*</span><span class="ident" id="4532787">Config</span><span class="op" id="4532793">,</span>&nbsp;<span class="ident" id="4532795">clientHello</span>&nbsp;<span class="op" id="4532807">*</span><span class="ident" id="4532808">clientHelloMsg</span><span class="op" id="4532822">,</span>&nbsp;<span class="ident" id="4532824">serverHello</span>&nbsp;<span class="op" id="4532836">*</span><span class="ident" id="4532837">serverHelloMsg</span><span class="op" id="4532851">,</span>&nbsp;<span class="ident" id="4532853">cert</span>&nbsp;<span class="op" id="4532858">*</span><span class="ident" id="4532859">x509</span><span class="op" id="4532863">.</span><span class="ident" id="4532864">Certificate</span><span class="op" id="4532875">,</span>&nbsp;<span class="ident" id="4532877">skx</span>&nbsp;<span class="op" id="4532881">*</span><span class="ident" id="4532882">serverKeyExchangeMsg</span><span class="op" id="4532902">)</span>&nbsp;<span class="builtintype" id="4532904">error</span>&nbsp;<span class="op" id="4532910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4532913">return</span>&nbsp;<span class="ident" id="4532920">errors</span><span class="op" id="4532926">.</span><span class="ident" id="4532927">New</span><span class="op" id="4532930">(</span><span class="string" id="4532931">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4532966">)</span><br>
<span class="lineno"></span><span class="op" id="4532968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4532971">func</span>&nbsp;<span class="op" id="4532976">(</span><span class="ident" id="4532977">ka</span>&nbsp;<span class="ident" id="4532980">rsaKeyAgreement</span><span class="op" id="4532995">)</span>&nbsp;<span class="ident" id="4532997">generateClientKeyExchange</span><span class="op" id="4533022">(</span><span class="ident" id="4533023">config</span>&nbsp;<span class="op" id="4533030">*</span><span class="ident" id="4533031">Config</span><span class="op" id="4533037">,</span>&nbsp;<span class="ident" id="4533039">clientHello</span>&nbsp;<span class="op" id="4533051">*</span><span class="ident" id="4533052">clientHelloMsg</span><span class="op" id="4533066">,</span>&nbsp;<span class="ident" id="4533068">cert</span>&nbsp;<span class="op" id="4533073">*</span><span class="ident" id="4533074">x509</span><span class="op" id="4533078">.</span><span class="ident" id="4533079">Certificate</span><span class="op" id="4533090">)</span>&nbsp;<span class="op" id="4533092">(</span><span class="op" id="4533093">[</span><span class="op" id="4533094">]</span><span class="builtintype" id="4533095">byte</span><span class="op" id="4533099">,</span>&nbsp;<span class="op" id="4533101">*</span><span class="ident" id="4533102">clientKeyExchangeMsg</span><span class="op" id="4533122">,</span>&nbsp;<span class="builtintype" id="4533124">error</span><span class="op" id="4533129">)</span>&nbsp;<span class="op" id="4533131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533134">preMasterSecret</span>&nbsp;<span class="op" id="4533150">:=</span>&nbsp;<span class="builtinfunc" id="4533153">make</span><span class="op" id="4533157">(</span><span class="op" id="4533158">[</span><span class="op" id="4533159">]</span><span class="builtintype" id="4533160">byte</span><span class="op" id="4533164">,</span>&nbsp;<span class="num" id="4533166">48</span><span class="op" id="4533168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533171">preMasterSecret</span><span class="op" id="4533186">[</span><span class="num" id="4533187">0</span><span class="op" id="4533188">]</span>&nbsp;<span class="op" id="4533190">=</span>&nbsp;<span class="builtintype" id="4533192">byte</span><span class="op" id="4533196">(</span><span class="ident" id="4533197">clientHello</span><span class="op" id="4533208">.</span><span class="ident" id="4533209">vers</span>&nbsp;<span class="op" id="4533214">&gt;&gt;</span>&nbsp;<span class="num" id="4533217">8</span><span class="op" id="4533218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533221">preMasterSecret</span><span class="op" id="4533236">[</span><span class="num" id="4533237">1</span><span class="op" id="4533238">]</span>&nbsp;<span class="op" id="4533240">=</span>&nbsp;<span class="builtintype" id="4533242">byte</span><span class="op" id="4533246">(</span><span class="ident" id="4533247">clientHello</span><span class="op" id="4533258">.</span><span class="ident" id="4533259">vers</span><span class="op" id="4533263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533266">_</span><span class="op" id="4533267">,</span>&nbsp;<span class="ident" id="4533269">err</span>&nbsp;<span class="op" id="4533273">:=</span>&nbsp;<span class="ident" id="4533276">io</span><span class="op" id="4533278">.</span><span class="ident" id="4533279">ReadFull</span><span class="op" id="4533287">(</span><span class="ident" id="4533288">config</span><span class="op" id="4533294">.</span><span class="ident" id="4533295">rand</span><span class="op" id="4533299">(</span><span class="op" id="4533300">)</span><span class="op" id="4533301">,</span>&nbsp;<span class="ident" id="4533303">preMasterSecret</span><span class="op" id="4533318">[</span><span class="num" id="4533319">2</span><span class="op" id="4533320">:</span><span class="op" id="4533321">]</span><span class="op" id="4533322">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533325">if</span>&nbsp;<span class="ident" id="4533328">err</span>&nbsp;<span class="op" id="4533332">!=</span>&nbsp;<span class="ident" id="4533335">nil</span>&nbsp;<span class="op" id="4533339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533343">return</span>&nbsp;<span class="ident" id="4533350">nil</span><span class="op" id="4533353">,</span>&nbsp;<span class="ident" id="4533355">nil</span><span class="op" id="4533358">,</span>&nbsp;<span class="ident" id="4533360">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533369">encrypted</span><span class="op" id="4533378">,</span>&nbsp;<span class="ident" id="4533380">err</span>&nbsp;<span class="op" id="4533384">:=</span>&nbsp;<span class="ident" id="4533387">rsa</span><span class="op" id="4533390">.</span><span class="ident" id="4533391">EncryptPKCS1v15</span><span class="op" id="4533406">(</span><span class="ident" id="4533407">config</span><span class="op" id="4533413">.</span><span class="ident" id="4533414">rand</span><span class="op" id="4533418">(</span><span class="op" id="4533419">)</span><span class="op" id="4533420">,</span>&nbsp;<span class="ident" id="4533422">cert</span><span class="op" id="4533426">.</span><span class="ident" id="4533427">PublicKey</span><span class="op" id="4533436">.</span><span class="op" id="4533437">(</span><span class="op" id="4533438">*</span><span class="ident" id="4533439">rsa</span><span class="op" id="4533442">.</span><span class="ident" id="4533443">PublicKey</span><span class="op" id="4533452">)</span><span class="op" id="4533453">,</span>&nbsp;<span class="ident" id="4533455">preMasterSecret</span><span class="op" id="4533470">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533473">if</span>&nbsp;<span class="ident" id="4533476">err</span>&nbsp;<span class="op" id="4533480">!=</span>&nbsp;<span class="ident" id="4533483">nil</span>&nbsp;<span class="op" id="4533487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533491">return</span>&nbsp;<span class="ident" id="4533498">nil</span><span class="op" id="4533501">,</span>&nbsp;<span class="ident" id="4533503">nil</span><span class="op" id="4533506">,</span>&nbsp;<span class="ident" id="4533508">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533516">ckx</span>&nbsp;<span class="op" id="4533520">:=</span>&nbsp;<span class="builtinfunc" id="4533523">new</span><span class="op" id="4533526">(</span><span class="ident" id="4533527">clientKeyExchangeMsg</span><span class="op" id="4533547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533550">ckx</span><span class="op" id="4533553">.</span><span class="ident" id="4533554">ciphertext</span>&nbsp;<span class="op" id="4533565">=</span>&nbsp;<span class="builtinfunc" id="4533567">make</span><span class="op" id="4533571">(</span><span class="op" id="4533572">[</span><span class="op" id="4533573">]</span><span class="builtintype" id="4533574">byte</span><span class="op" id="4533578">,</span>&nbsp;<span class="builtinfunc" id="4533580">len</span><span class="op" id="4533583">(</span><span class="ident" id="4533584">encrypted</span><span class="op" id="4533593">)</span><span class="op" id="4533594">+</span><span class="num" id="4533595">2</span><span class="op" id="4533596">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533599">ckx</span><span class="op" id="4533602">.</span><span class="ident" id="4533603">ciphertext</span><span class="op" id="4533613">[</span><span class="num" id="4533614">0</span><span class="op" id="4533615">]</span>&nbsp;<span class="op" id="4533617">=</span>&nbsp;<span class="builtintype" id="4533619">byte</span><span class="op" id="4533623">(</span><span class="builtinfunc" id="4533624">len</span><span class="op" id="4533627">(</span><span class="ident" id="4533628">encrypted</span><span class="op" id="4533637">)</span>&nbsp;<span class="op" id="4533639">&gt;&gt;</span>&nbsp;<span class="num" id="4533642">8</span><span class="op" id="4533643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533646">ckx</span><span class="op" id="4533649">.</span><span class="ident" id="4533650">ciphertext</span><span class="op" id="4533660">[</span><span class="num" id="4533661">1</span><span class="op" id="4533662">]</span>&nbsp;<span class="op" id="4533664">=</span>&nbsp;<span class="builtintype" id="4533666">byte</span><span class="op" id="4533670">(</span><span class="builtinfunc" id="4533671">len</span><span class="op" id="4533674">(</span><span class="ident" id="4533675">encrypted</span><span class="op" id="4533684">)</span><span class="op" id="4533685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4533688">copy</span><span class="op" id="4533692">(</span><span class="ident" id="4533693">ckx</span><span class="op" id="4533696">.</span><span class="ident" id="4533697">ciphertext</span><span class="op" id="4533707">[</span><span class="num" id="4533708">2</span><span class="op" id="4533709">:</span><span class="op" id="4533710">]</span><span class="op" id="4533711">,</span>&nbsp;<span class="ident" id="4533713">encrypted</span><span class="op" id="4533722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533725">return</span>&nbsp;<span class="ident" id="4533732">preMasterSecret</span><span class="op" id="4533747">,</span>&nbsp;<span class="ident" id="4533749">ckx</span><span class="op" id="4533752">,</span>&nbsp;<span class="ident" id="4533754">nil</span><br>
<span class="lineno"></span><span class="op" id="4533758">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4533761">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4533824">func</span>&nbsp;<span class="ident" id="4533829">sha1Hash</span><span class="op" id="4533837">(</span><span class="ident" id="4533838">slices</span>&nbsp;<span class="op" id="4533845">[</span><span class="op" id="4533846">]</span><span class="op" id="4533847">[</span><span class="op" id="4533848">]</span><span class="builtintype" id="4533849">byte</span><span class="op" id="4533853">)</span>&nbsp;<span class="op" id="4533855">[</span><span class="op" id="4533856">]</span><span class="builtintype" id="4533857">byte</span>&nbsp;<span class="op" id="4533862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533865">hsha1</span>&nbsp;<span class="op" id="4533871">:=</span>&nbsp;<span class="ident" id="4533874">sha1</span><span class="op" id="4533878">.</span><span class="ident" id="4533879">New</span><span class="op" id="4533882">(</span><span class="op" id="4533883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533886">for</span>&nbsp;<span class="ident" id="4533890">_</span><span class="op" id="4533891">,</span>&nbsp;<span class="ident" id="4533893">slice</span>&nbsp;<span class="op" id="4533899">:=</span>&nbsp;<span class="keyword" id="4533902">range</span>&nbsp;<span class="ident" id="4533908">slices</span>&nbsp;<span class="op" id="4533915">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4533919">hsha1</span><span class="op" id="4533924">.</span><span class="ident" id="4533925">Write</span><span class="op" id="4533930">(</span><span class="ident" id="4533931">slice</span><span class="op" id="4533936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4533939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4533942">return</span>&nbsp;<span class="ident" id="4533949">hsha1</span><span class="op" id="4533954">.</span><span class="ident" id="4533955">Sum</span><span class="op" id="4533958">(</span><span class="ident" id="4533959">nil</span><span class="op" id="4533962">)</span><br>
<span class="lineno"></span><span class="op" id="4533964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4533967">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4534046">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4534088">func</span>&nbsp;<span class="ident" id="4534093">md5SHA1Hash</span><span class="op" id="4534104">(</span><span class="ident" id="4534105">slices</span>&nbsp;<span class="op" id="4534112">[</span><span class="op" id="4534113">]</span><span class="op" id="4534114">[</span><span class="op" id="4534115">]</span><span class="builtintype" id="4534116">byte</span><span class="op" id="4534120">)</span>&nbsp;<span class="op" id="4534122">[</span><span class="op" id="4534123">]</span><span class="builtintype" id="4534124">byte</span>&nbsp;<span class="op" id="4534129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534132">md5sha1</span>&nbsp;<span class="op" id="4534140">:=</span>&nbsp;<span class="builtinfunc" id="4534143">make</span><span class="op" id="4534147">(</span><span class="op" id="4534148">[</span><span class="op" id="4534149">]</span><span class="builtintype" id="4534150">byte</span><span class="op" id="4534154">,</span>&nbsp;<span class="ident" id="4534156">md5</span><span class="op" id="4534159">.</span><span class="ident" id="4534160">Size</span><span class="op" id="4534164">+</span><span class="ident" id="4534165">sha1</span><span class="op" id="4534169">.</span><span class="ident" id="4534170">Size</span><span class="op" id="4534174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534177">hmd5</span>&nbsp;<span class="op" id="4534182">:=</span>&nbsp;<span class="ident" id="4534185">md5</span><span class="op" id="4534188">.</span><span class="ident" id="4534189">New</span><span class="op" id="4534192">(</span><span class="op" id="4534193">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534196">for</span>&nbsp;<span class="ident" id="4534200">_</span><span class="op" id="4534201">,</span>&nbsp;<span class="ident" id="4534203">slice</span>&nbsp;<span class="op" id="4534209">:=</span>&nbsp;<span class="keyword" id="4534212">range</span>&nbsp;<span class="ident" id="4534218">slices</span>&nbsp;<span class="op" id="4534225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534229">hmd5</span><span class="op" id="4534233">.</span><span class="ident" id="4534234">Write</span><span class="op" id="4534239">(</span><span class="ident" id="4534240">slice</span><span class="op" id="4534245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4534251">copy</span><span class="op" id="4534255">(</span><span class="ident" id="4534256">md5sha1</span><span class="op" id="4534263">,</span>&nbsp;<span class="ident" id="4534265">hmd5</span><span class="op" id="4534269">.</span><span class="ident" id="4534270">Sum</span><span class="op" id="4534273">(</span><span class="ident" id="4534274">nil</span><span class="op" id="4534277">)</span><span class="op" id="4534278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4534281">copy</span><span class="op" id="4534285">(</span><span class="ident" id="4534286">md5sha1</span><span class="op" id="4534293">[</span><span class="ident" id="4534294">md5</span><span class="op" id="4534297">.</span><span class="ident" id="4534298">Size</span><span class="op" id="4534302">:</span><span class="op" id="4534303">]</span><span class="op" id="4534304">,</span>&nbsp;<span class="ident" id="4534306">sha1Hash</span><span class="op" id="4534314">(</span><span class="ident" id="4534315">slices</span><span class="op" id="4534321">)</span><span class="op" id="4534322">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534325">return</span>&nbsp;<span class="ident" id="4534332">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4534340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4534343">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4534393">func</span>&nbsp;<span class="ident" id="4534398">sha256Hash</span><span class="op" id="4534408">(</span><span class="ident" id="4534409">slices</span>&nbsp;<span class="op" id="4534416">[</span><span class="op" id="4534417">]</span><span class="op" id="4534418">[</span><span class="op" id="4534419">]</span><span class="builtintype" id="4534420">byte</span><span class="op" id="4534424">)</span>&nbsp;<span class="op" id="4534426">[</span><span class="op" id="4534427">]</span><span class="builtintype" id="4534428">byte</span>&nbsp;<span class="op" id="4534433">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534436">h</span>&nbsp;<span class="op" id="4534438">:=</span>&nbsp;<span class="ident" id="4534441">sha256</span><span class="op" id="4534447">.</span><span class="ident" id="4534448">New</span><span class="op" id="4534451">(</span><span class="op" id="4534452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534455">for</span>&nbsp;<span class="ident" id="4534459">_</span><span class="op" id="4534460">,</span>&nbsp;<span class="ident" id="4534462">slice</span>&nbsp;<span class="op" id="4534468">:=</span>&nbsp;<span class="keyword" id="4534471">range</span>&nbsp;<span class="ident" id="4534477">slices</span>&nbsp;<span class="op" id="4534484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4534488">h</span><span class="op" id="4534489">.</span><span class="ident" id="4534490">Write</span><span class="op" id="4534495">(</span><span class="ident" id="4534496">slice</span><span class="op" id="4534501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4534504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534507">return</span>&nbsp;<span class="ident" id="4534514">h</span><span class="op" id="4534515">.</span><span class="ident" id="4534516">Sum</span><span class="op" id="4534519">(</span><span class="ident" id="4534520">nil</span><span class="op" id="4534523">)</span><br>
<span class="lineno">120</span><span class="op" id="4534525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4534528">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4534605">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4534684">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4534758">func</span>&nbsp;<span class="ident" id="4534763">hashForServerKeyExchange</span><span class="op" id="4534787">(</span><span class="ident" id="4534788">sigType</span><span class="op" id="4534795">,</span>&nbsp;<span class="ident" id="4534797">hashFunc</span>&nbsp;<span class="builtintype" id="4534806">uint8</span><span class="op" id="4534811">,</span>&nbsp;<span class="ident" id="4534813">version</span>&nbsp;<span class="builtintype" id="4534821">uint16</span><span class="op" id="4534827">,</span>&nbsp;<span class="ident" id="4534829">slices</span>&nbsp;<span class="op" id="4534836">...</span><span class="op" id="4534839">[</span><span class="op" id="4534840">]</span><span class="builtintype" id="4534841">byte</span><span class="op" id="4534845">)</span>&nbsp;<span class="op" id="4534847">(</span><span class="op" id="4534848">[</span><span class="op" id="4534849">]</span><span class="builtintype" id="4534850">byte</span><span class="op" id="4534854">,</span>&nbsp;<span class="ident" id="4534856">crypto</span><span class="op" id="4534862">.</span><span class="ident" id="4534863">Hash</span><span class="op" id="4534867">,</span>&nbsp;<span class="builtintype" id="4534869">error</span><span class="op" id="4534874">)</span>&nbsp;<span class="op" id="4534876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534879">if</span>&nbsp;<span class="ident" id="4534882">version</span>&nbsp;<span class="op" id="4534890">&gt;=</span>&nbsp;<span class="ident" id="4534893">VersionTLS12</span>&nbsp;<span class="op" id="4534906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534910">switch</span>&nbsp;<span class="ident" id="4534917">hashFunc</span>&nbsp;<span class="op" id="4534926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534930">case</span>&nbsp;<span class="ident" id="4534935">hashSHA256</span><span class="op" id="4534945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534950">return</span>&nbsp;<span class="ident" id="4534957">sha256Hash</span><span class="op" id="4534967">(</span><span class="ident" id="4534968">slices</span><span class="op" id="4534974">)</span><span class="op" id="4534975">,</span>&nbsp;<span class="ident" id="4534977">crypto</span><span class="op" id="4534983">.</span><span class="ident" id="4534984">SHA256</span><span class="op" id="4534990">,</span>&nbsp;<span class="ident" id="4534992">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4534998">case</span>&nbsp;<span class="ident" id="4535003">hashSHA1</span><span class="op" id="4535011">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535016">return</span>&nbsp;<span class="ident" id="4535023">sha1Hash</span><span class="op" id="4535031">(</span><span class="ident" id="4535032">slices</span><span class="op" id="4535038">)</span><span class="op" id="4535039">,</span>&nbsp;<span class="ident" id="4535041">crypto</span><span class="op" id="4535047">.</span><span class="ident" id="4535048">SHA1</span><span class="op" id="4535052">,</span>&nbsp;<span class="ident" id="4535054">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535060">default</span><span class="op" id="4535067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535072">return</span>&nbsp;<span class="ident" id="4535079">nil</span><span class="op" id="4535082">,</span>&nbsp;<span class="ident" id="4535084">crypto</span><span class="op" id="4535090">.</span><span class="ident" id="4535091">Hash</span><span class="op" id="4535095">(</span><span class="num" id="4535096">0</span><span class="op" id="4535097">)</span><span class="op" id="4535098">,</span>&nbsp;<span class="ident" id="4535100">errors</span><span class="op" id="4535106">.</span><span class="ident" id="4535107">New</span><span class="op" id="4535110">(</span><span class="string" id="4535111">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4535152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535156">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535162">if</span>&nbsp;<span class="ident" id="4535165">sigType</span>&nbsp;<span class="op" id="4535173">==</span>&nbsp;<span class="ident" id="4535176">signatureECDSA</span>&nbsp;<span class="op" id="4535191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535195">return</span>&nbsp;<span class="ident" id="4535202">sha1Hash</span><span class="op" id="4535210">(</span><span class="ident" id="4535211">slices</span><span class="op" id="4535217">)</span><span class="op" id="4535218">,</span>&nbsp;<span class="ident" id="4535220">crypto</span><span class="op" id="4535226">.</span><span class="ident" id="4535227">SHA1</span><span class="op" id="4535231">,</span>&nbsp;<span class="ident" id="4535233">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535241">return</span>&nbsp;<span class="ident" id="4535248">md5SHA1Hash</span><span class="op" id="4535259">(</span><span class="ident" id="4535260">slices</span><span class="op" id="4535266">)</span><span class="op" id="4535267">,</span>&nbsp;<span class="ident" id="4535269">crypto</span><span class="op" id="4535275">.</span><span class="ident" id="4535276">MD5SHA1</span><span class="op" id="4535283">,</span>&nbsp;<span class="ident" id="4535285">nil</span><br>
<span class="lineno">140</span><span class="op" id="4535289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4535292">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4535369">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4535443">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4535508">func</span>&nbsp;<span class="ident" id="4535513">pickTLS12HashForSignature</span><span class="op" id="4535538">(</span><span class="ident" id="4535539">sigType</span>&nbsp;<span class="builtintype" id="4535547">uint8</span><span class="op" id="4535552">,</span>&nbsp;<span class="ident" id="4535554">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4535579">[</span><span class="op" id="4535580">]</span><span class="ident" id="4535581">signatureAndHash</span><span class="op" id="4535597">)</span>&nbsp;<span class="op" id="4535599">(</span><span class="builtintype" id="4535600">uint8</span><span class="op" id="4535605">,</span>&nbsp;<span class="builtintype" id="4535607">error</span><span class="op" id="4535612">)</span>&nbsp;<span class="op" id="4535614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535617">if</span>&nbsp;<span class="builtinfunc" id="4535620">len</span><span class="op" id="4535623">(</span><span class="ident" id="4535624">clientSignatureAndHashes</span><span class="op" id="4535648">)</span>&nbsp;<span class="op" id="4535650">==</span>&nbsp;<span class="num" id="4535653">0</span>&nbsp;<span class="op" id="4535655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4535659">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4535718">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4535779">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535837">return</span>&nbsp;<span class="ident" id="4535844">hashSHA1</span><span class="op" id="4535852">,</span>&nbsp;<span class="ident" id="4535854">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535863">for</span>&nbsp;<span class="ident" id="4535867">_</span><span class="op" id="4535868">,</span>&nbsp;<span class="ident" id="4535870">sigAndHash</span>&nbsp;<span class="op" id="4535881">:=</span>&nbsp;<span class="keyword" id="4535884">range</span>&nbsp;<span class="ident" id="4535890">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4535915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535919">if</span>&nbsp;<span class="ident" id="4535922">sigAndHash</span><span class="op" id="4535932">.</span><span class="ident" id="4535933">signature</span>&nbsp;<span class="op" id="4535943">!=</span>&nbsp;<span class="ident" id="4535946">sigType</span>&nbsp;<span class="op" id="4535954">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535959">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4535970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4535974">switch</span>&nbsp;<span class="ident" id="4535981">sigAndHash</span><span class="op" id="4535991">.</span><span class="ident" id="4535992">hash</span>&nbsp;<span class="op" id="4535997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536001">case</span>&nbsp;<span class="ident" id="4536006">hashSHA1</span><span class="op" id="4536014">,</span>&nbsp;<span class="ident" id="4536016">hashSHA256</span><span class="op" id="4536026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536031">return</span>&nbsp;<span class="ident" id="4536038">sigAndHash</span><span class="op" id="4536048">.</span><span class="ident" id="4536049">hash</span><span class="op" id="4536053">,</span>&nbsp;<span class="ident" id="4536055">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536068">return</span>&nbsp;<span class="num" id="4536075">0</span><span class="op" id="4536076">,</span>&nbsp;<span class="ident" id="4536078">errors</span><span class="op" id="4536084">.</span><span class="ident" id="4536085">New</span><span class="op" id="4536088">(</span><span class="string" id="4536089">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4536144">)</span><br>
<span class="lineno"></span><span class="op" id="4536146">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4536149">func</span>&nbsp;<span class="ident" id="4536154">curveForCurveID</span><span class="op" id="4536169">(</span><span class="ident" id="4536170">id</span>&nbsp;<span class="ident" id="4536173">CurveID</span><span class="op" id="4536180">)</span>&nbsp;<span class="op" id="4536182">(</span><span class="ident" id="4536183">elliptic</span><span class="op" id="4536191">.</span><span class="ident" id="4536192">Curve</span><span class="op" id="4536197">,</span>&nbsp;<span class="builtintype" id="4536199">bool</span><span class="op" id="4536203">)</span>&nbsp;<span class="op" id="4536205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536208">switch</span>&nbsp;<span class="ident" id="4536215">id</span>&nbsp;<span class="op" id="4536218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536221">case</span>&nbsp;<span class="ident" id="4536226">CurveP256</span><span class="op" id="4536235">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536239">return</span>&nbsp;<span class="ident" id="4536246">elliptic</span><span class="op" id="4536254">.</span><span class="ident" id="4536255">P256</span><span class="op" id="4536259">(</span><span class="op" id="4536260">)</span><span class="op" id="4536261">,</span>&nbsp;<span class="builtintype" id="4536263">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536269">case</span>&nbsp;<span class="ident" id="4536274">CurveP384</span><span class="op" id="4536283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536287">return</span>&nbsp;<span class="ident" id="4536294">elliptic</span><span class="op" id="4536302">.</span><span class="ident" id="4536303">P384</span><span class="op" id="4536307">(</span><span class="op" id="4536308">)</span><span class="op" id="4536309">,</span>&nbsp;<span class="builtintype" id="4536311">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536317">case</span>&nbsp;<span class="ident" id="4536322">CurveP521</span><span class="op" id="4536331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536335">return</span>&nbsp;<span class="ident" id="4536342">elliptic</span><span class="op" id="4536350">.</span><span class="ident" id="4536351">P521</span><span class="op" id="4536355">(</span><span class="op" id="4536356">)</span><span class="op" id="4536357">,</span>&nbsp;<span class="builtintype" id="4536359">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536365">default</span><span class="op" id="4536372">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536376">return</span>&nbsp;<span class="ident" id="4536383">nil</span><span class="op" id="4536386">,</span>&nbsp;<span class="builtintype" id="4536388">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4536395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4536398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4536401">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4536473">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4536543">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4536613">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4536640">type</span>&nbsp;<span class="ident" id="4536645">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4536663">struct</span>&nbsp;<span class="op" id="4536670">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536673">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4536684">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536692">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4536703">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536710">privateKey</span>&nbsp;<span class="op" id="4536721">[</span><span class="op" id="4536722">]</span><span class="builtintype" id="4536723">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536729">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4536740">elliptic</span><span class="op" id="4536748">.</span><span class="ident" id="4536749">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536756">x</span><span class="op" id="4536757">,</span>&nbsp;<span class="ident" id="4536759">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4536767">*</span><span class="ident" id="4536768">big</span><span class="op" id="4536771">.</span><span class="ident" id="4536772">Int</span><br>
<span class="lineno">190</span><span class="op" id="4536776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4536779">func</span>&nbsp;<span class="op" id="4536784">(</span><span class="ident" id="4536785">ka</span>&nbsp;<span class="op" id="4536788">*</span><span class="ident" id="4536789">ecdheKeyAgreement</span><span class="op" id="4536806">)</span>&nbsp;<span class="ident" id="4536808">generateServerKeyExchange</span><span class="op" id="4536833">(</span><span class="ident" id="4536834">config</span>&nbsp;<span class="op" id="4536841">*</span><span class="ident" id="4536842">Config</span><span class="op" id="4536848">,</span>&nbsp;<span class="ident" id="4536850">cert</span>&nbsp;<span class="op" id="4536855">*</span><span class="ident" id="4536856">Certificate</span><span class="op" id="4536867">,</span>&nbsp;<span class="ident" id="4536869">clientHello</span>&nbsp;<span class="op" id="4536881">*</span><span class="ident" id="4536882">clientHelloMsg</span><span class="op" id="4536896">,</span>&nbsp;<span class="ident" id="4536898">hello</span>&nbsp;<span class="op" id="4536904">*</span><span class="ident" id="4536905">serverHelloMsg</span><span class="op" id="4536919">)</span>&nbsp;<span class="op" id="4536921">(</span><span class="op" id="4536922">*</span><span class="ident" id="4536923">serverKeyExchangeMsg</span><span class="op" id="4536943">,</span>&nbsp;<span class="builtintype" id="4536945">error</span><span class="op" id="4536950">)</span>&nbsp;<span class="op" id="4536952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4536955">var</span>&nbsp;<span class="ident" id="4536959">curveid</span>&nbsp;<span class="ident" id="4536967">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4536976">preferredCurves</span>&nbsp;<span class="op" id="4536992">:=</span>&nbsp;<span class="ident" id="4536995">config</span><span class="op" id="4537001">.</span><span class="ident" id="4537002">curvePreferences</span><span class="op" id="4537018">(</span><span class="op" id="4537019">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4537022">NextCandidate</span><span class="op" id="4537035">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537038">for</span>&nbsp;<span class="ident" id="4537042">_</span><span class="op" id="4537043">,</span>&nbsp;<span class="ident" id="4537045">candidate</span>&nbsp;<span class="op" id="4537055">:=</span>&nbsp;<span class="keyword" id="4537058">range</span>&nbsp;<span class="ident" id="4537064">preferredCurves</span>&nbsp;<span class="op" id="4537080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537084">for</span>&nbsp;<span class="ident" id="4537088">_</span><span class="op" id="4537089">,</span>&nbsp;<span class="ident" id="4537091">c</span>&nbsp;<span class="op" id="4537093">:=</span>&nbsp;<span class="keyword" id="4537096">range</span>&nbsp;<span class="ident" id="4537102">clientHello</span><span class="op" id="4537113">.</span><span class="ident" id="4537114">supportedCurves</span>&nbsp;<span class="op" id="4537130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537135">if</span>&nbsp;<span class="ident" id="4537138">candidate</span>&nbsp;<span class="op" id="4537148">==</span>&nbsp;<span class="ident" id="4537151">c</span>&nbsp;<span class="op" id="4537153">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537159">curveid</span>&nbsp;<span class="op" id="4537167">=</span>&nbsp;<span class="ident" id="4537169">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537175">break</span>&nbsp;<span class="ident" id="4537181">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537205">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537209">if</span>&nbsp;<span class="ident" id="4537212">curveid</span>&nbsp;<span class="op" id="4537220">==</span>&nbsp;<span class="num" id="4537223">0</span>&nbsp;<span class="op" id="4537225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537229">return</span>&nbsp;<span class="ident" id="4537236">nil</span><span class="op" id="4537239">,</span>&nbsp;<span class="ident" id="4537241">errors</span><span class="op" id="4537247">.</span><span class="ident" id="4537248">New</span><span class="op" id="4537251">(</span><span class="string" id="4537252">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4537295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537302">var</span>&nbsp;<span class="ident" id="4537306">ok</span>&nbsp;<span class="builtintype" id="4537309">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537315">if</span>&nbsp;<span class="ident" id="4537318">ka</span><span class="op" id="4537320">.</span><span class="ident" id="4537321">curve</span><span class="op" id="4537326">,</span>&nbsp;<span class="ident" id="4537328">ok</span>&nbsp;<span class="op" id="4537331">=</span>&nbsp;<span class="ident" id="4537333">curveForCurveID</span><span class="op" id="4537348">(</span><span class="ident" id="4537349">curveid</span><span class="op" id="4537356">)</span><span class="op" id="4537357">;</span>&nbsp;<span class="op" id="4537359">!</span><span class="ident" id="4537360">ok</span>&nbsp;<span class="op" id="4537363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537367">return</span>&nbsp;<span class="ident" id="4537374">nil</span><span class="op" id="4537377">,</span>&nbsp;<span class="ident" id="4537379">errors</span><span class="op" id="4537385">.</span><span class="ident" id="4537386">New</span><span class="op" id="4537389">(</span><span class="string" id="4537390">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4537439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537446">var</span>&nbsp;<span class="ident" id="4537450">x</span><span class="op" id="4537451">,</span>&nbsp;<span class="ident" id="4537453">y</span>&nbsp;<span class="op" id="4537455">*</span><span class="ident" id="4537456">big</span><span class="op" id="4537459">.</span><span class="ident" id="4537460">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537465">var</span>&nbsp;<span class="ident" id="4537469">err</span>&nbsp;<span class="builtintype" id="4537473">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537480">ka</span><span class="op" id="4537482">.</span><span class="ident" id="4537483">privateKey</span><span class="op" id="4537493">,</span>&nbsp;<span class="ident" id="4537495">x</span><span class="op" id="4537496">,</span>&nbsp;<span class="ident" id="4537498">y</span><span class="op" id="4537499">,</span>&nbsp;<span class="ident" id="4537501">err</span>&nbsp;<span class="op" id="4537505">=</span>&nbsp;<span class="ident" id="4537507">elliptic</span><span class="op" id="4537515">.</span><span class="ident" id="4537516">GenerateKey</span><span class="op" id="4537527">(</span><span class="ident" id="4537528">ka</span><span class="op" id="4537530">.</span><span class="ident" id="4537531">curve</span><span class="op" id="4537536">,</span>&nbsp;<span class="ident" id="4537538">config</span><span class="op" id="4537544">.</span><span class="ident" id="4537545">rand</span><span class="op" id="4537549">(</span><span class="op" id="4537550">)</span><span class="op" id="4537551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537554">if</span>&nbsp;<span class="ident" id="4537557">err</span>&nbsp;<span class="op" id="4537561">!=</span>&nbsp;<span class="ident" id="4537564">nil</span>&nbsp;<span class="op" id="4537568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537572">return</span>&nbsp;<span class="ident" id="4537579">nil</span><span class="op" id="4537582">,</span>&nbsp;<span class="ident" id="4537584">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4537589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537592">ecdhePublic</span>&nbsp;<span class="op" id="4537604">:=</span>&nbsp;<span class="ident" id="4537607">elliptic</span><span class="op" id="4537615">.</span><span class="ident" id="4537616">Marshal</span><span class="op" id="4537623">(</span><span class="ident" id="4537624">ka</span><span class="op" id="4537626">.</span><span class="ident" id="4537627">curve</span><span class="op" id="4537632">,</span>&nbsp;<span class="ident" id="4537634">x</span><span class="op" id="4537635">,</span>&nbsp;<span class="ident" id="4537637">y</span><span class="op" id="4537638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4537642">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537693">serverECDHParams</span>&nbsp;<span class="op" id="4537710">:=</span>&nbsp;<span class="builtinfunc" id="4537713">make</span><span class="op" id="4537717">(</span><span class="op" id="4537718">[</span><span class="op" id="4537719">]</span><span class="builtintype" id="4537720">byte</span><span class="op" id="4537724">,</span>&nbsp;<span class="num" id="4537726">1</span><span class="op" id="4537727">+</span><span class="num" id="4537728">2</span><span class="op" id="4537729">+</span><span class="num" id="4537730">1</span><span class="op" id="4537731">+</span><span class="builtinfunc" id="4537732">len</span><span class="op" id="4537735">(</span><span class="ident" id="4537736">ecdhePublic</span><span class="op" id="4537747">)</span><span class="op" id="4537748">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537751">serverECDHParams</span><span class="op" id="4537767">[</span><span class="num" id="4537768">0</span><span class="op" id="4537769">]</span>&nbsp;<span class="op" id="4537771">=</span>&nbsp;<span class="num" id="4537773">3</span>&nbsp;<span class="comment" id="4537775">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537791">serverECDHParams</span><span class="op" id="4537807">[</span><span class="num" id="4537808">1</span><span class="op" id="4537809">]</span>&nbsp;<span class="op" id="4537811">=</span>&nbsp;<span class="builtintype" id="4537813">byte</span><span class="op" id="4537817">(</span><span class="ident" id="4537818">curveid</span>&nbsp;<span class="op" id="4537826">&gt;&gt;</span>&nbsp;<span class="num" id="4537829">8</span><span class="op" id="4537830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537833">serverECDHParams</span><span class="op" id="4537849">[</span><span class="num" id="4537850">2</span><span class="op" id="4537851">]</span>&nbsp;<span class="op" id="4537853">=</span>&nbsp;<span class="builtintype" id="4537855">byte</span><span class="op" id="4537859">(</span><span class="ident" id="4537860">curveid</span><span class="op" id="4537867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4537870">serverECDHParams</span><span class="op" id="4537886">[</span><span class="num" id="4537887">3</span><span class="op" id="4537888">]</span>&nbsp;<span class="op" id="4537890">=</span>&nbsp;<span class="builtintype" id="4537892">byte</span><span class="op" id="4537896">(</span><span class="builtinfunc" id="4537897">len</span><span class="op" id="4537900">(</span><span class="ident" id="4537901">ecdhePublic</span><span class="op" id="4537912">)</span><span class="op" id="4537913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4537916">copy</span><span class="op" id="4537920">(</span><span class="ident" id="4537921">serverECDHParams</span><span class="op" id="4537937">[</span><span class="num" id="4537938">4</span><span class="op" id="4537939">:</span><span class="op" id="4537940">]</span><span class="op" id="4537941">,</span>&nbsp;<span class="ident" id="4537943">ecdhePublic</span><span class="op" id="4537954">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537958">var</span>&nbsp;<span class="ident" id="4537962">tls12HashId</span>&nbsp;<span class="builtintype" id="4537974">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4537981">if</span>&nbsp;<span class="ident" id="4537984">ka</span><span class="op" id="4537986">.</span><span class="ident" id="4537987">version</span>&nbsp;<span class="op" id="4537995">&gt;=</span>&nbsp;<span class="ident" id="4537998">VersionTLS12</span>&nbsp;<span class="op" id="4538011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538015">if</span>&nbsp;<span class="ident" id="4538018">tls12HashId</span><span class="op" id="4538029">,</span>&nbsp;<span class="ident" id="4538031">err</span>&nbsp;<span class="op" id="4538035">=</span>&nbsp;<span class="ident" id="4538037">pickTLS12HashForSignature</span><span class="op" id="4538062">(</span><span class="ident" id="4538063">ka</span><span class="op" id="4538065">.</span><span class="ident" id="4538066">sigType</span><span class="op" id="4538073">,</span>&nbsp;<span class="ident" id="4538075">clientHello</span><span class="op" id="4538086">.</span><span class="ident" id="4538087">signatureAndHashes</span><span class="op" id="4538105">)</span><span class="op" id="4538106">;</span>&nbsp;<span class="ident" id="4538108">err</span>&nbsp;<span class="op" id="4538112">!=</span>&nbsp;<span class="ident" id="4538115">nil</span>&nbsp;<span class="op" id="4538119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538124">return</span>&nbsp;<span class="ident" id="4538131">nil</span><span class="op" id="4538134">,</span>&nbsp;<span class="ident" id="4538136">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538149">digest</span><span class="op" id="4538155">,</span>&nbsp;<span class="ident" id="4538157">hashFunc</span><span class="op" id="4538165">,</span>&nbsp;<span class="ident" id="4538167">err</span>&nbsp;<span class="op" id="4538171">:=</span>&nbsp;<span class="ident" id="4538174">hashForServerKeyExchange</span><span class="op" id="4538198">(</span><span class="ident" id="4538199">ka</span><span class="op" id="4538201">.</span><span class="ident" id="4538202">sigType</span><span class="op" id="4538209">,</span>&nbsp;<span class="ident" id="4538211">tls12HashId</span><span class="op" id="4538222">,</span>&nbsp;<span class="ident" id="4538224">ka</span><span class="op" id="4538226">.</span><span class="ident" id="4538227">version</span><span class="op" id="4538234">,</span>&nbsp;<span class="ident" id="4538236">clientHello</span><span class="op" id="4538247">.</span><span class="ident" id="4538248">random</span><span class="op" id="4538254">,</span>&nbsp;<span class="ident" id="4538256">hello</span><span class="op" id="4538261">.</span><span class="ident" id="4538262">random</span><span class="op" id="4538268">,</span>&nbsp;<span class="ident" id="4538270">serverECDHParams</span><span class="op" id="4538286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538289">if</span>&nbsp;<span class="ident" id="4538292">err</span>&nbsp;<span class="op" id="4538296">!=</span>&nbsp;<span class="ident" id="4538299">nil</span>&nbsp;<span class="op" id="4538303">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538307">return</span>&nbsp;<span class="ident" id="4538314">nil</span><span class="op" id="4538317">,</span>&nbsp;<span class="ident" id="4538319">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538327">var</span>&nbsp;<span class="ident" id="4538331">sig</span>&nbsp;<span class="op" id="4538335">[</span><span class="op" id="4538336">]</span><span class="builtintype" id="4538337">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538343">switch</span>&nbsp;<span class="ident" id="4538350">ka</span><span class="op" id="4538352">.</span><span class="ident" id="4538353">sigType</span>&nbsp;<span class="op" id="4538361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538364">case</span>&nbsp;<span class="ident" id="4538369">signatureECDSA</span><span class="op" id="4538383">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538387">privKey</span><span class="op" id="4538394">,</span>&nbsp;<span class="ident" id="4538396">ok</span>&nbsp;<span class="op" id="4538399">:=</span>&nbsp;<span class="ident" id="4538402">cert</span><span class="op" id="4538406">.</span><span class="ident" id="4538407">PrivateKey</span><span class="op" id="4538417">.</span><span class="op" id="4538418">(</span><span class="op" id="4538419">*</span><span class="ident" id="4538420">ecdsa</span><span class="op" id="4538425">.</span><span class="ident" id="4538426">PrivateKey</span><span class="op" id="4538436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538440">if</span>&nbsp;<span class="op" id="4538443">!</span><span class="ident" id="4538444">ok</span>&nbsp;<span class="op" id="4538447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538452">return</span>&nbsp;<span class="ident" id="4538459">nil</span><span class="op" id="4538462">,</span>&nbsp;<span class="ident" id="4538464">errors</span><span class="op" id="4538470">.</span><span class="ident" id="4538471">New</span><span class="op" id="4538474">(</span><span class="string" id="4538475">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4538525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538533">r</span><span class="op" id="4538534">,</span>&nbsp;<span class="ident" id="4538536">s</span><span class="op" id="4538537">,</span>&nbsp;<span class="ident" id="4538539">err</span>&nbsp;<span class="op" id="4538543">:=</span>&nbsp;<span class="ident" id="4538546">ecdsa</span><span class="op" id="4538551">.</span><span class="ident" id="4538552">Sign</span><span class="op" id="4538556">(</span><span class="ident" id="4538557">config</span><span class="op" id="4538563">.</span><span class="ident" id="4538564">rand</span><span class="op" id="4538568">(</span><span class="op" id="4538569">)</span><span class="op" id="4538570">,</span>&nbsp;<span class="ident" id="4538572">privKey</span><span class="op" id="4538579">,</span>&nbsp;<span class="ident" id="4538581">digest</span><span class="op" id="4538587">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538591">if</span>&nbsp;<span class="ident" id="4538594">err</span>&nbsp;<span class="op" id="4538598">!=</span>&nbsp;<span class="ident" id="4538601">nil</span>&nbsp;<span class="op" id="4538605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538610">return</span>&nbsp;<span class="ident" id="4538617">nil</span><span class="op" id="4538620">,</span>&nbsp;<span class="ident" id="4538622">errors</span><span class="op" id="4538628">.</span><span class="ident" id="4538629">New</span><span class="op" id="4538632">(</span><span class="string" id="4538633">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4538669">+</span>&nbsp;<span class="ident" id="4538671">err</span><span class="op" id="4538674">.</span><span class="ident" id="4538675">Error</span><span class="op" id="4538680">(</span><span class="op" id="4538681">)</span><span class="op" id="4538682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538690">sig</span><span class="op" id="4538693">,</span>&nbsp;<span class="ident" id="4538695">err</span>&nbsp;<span class="op" id="4538699">=</span>&nbsp;<span class="ident" id="4538701">asn1</span><span class="op" id="4538705">.</span><span class="ident" id="4538706">Marshal</span><span class="op" id="4538713">(</span><span class="ident" id="4538714">ecdsaSignature</span><span class="op" id="4538728">{</span><span class="ident" id="4538729">r</span><span class="op" id="4538730">,</span>&nbsp;<span class="ident" id="4538732">s</span><span class="op" id="4538733">}</span><span class="op" id="4538734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538737">case</span>&nbsp;<span class="ident" id="4538742">signatureRSA</span><span class="op" id="4538754">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538758">privKey</span><span class="op" id="4538765">,</span>&nbsp;<span class="ident" id="4538767">ok</span>&nbsp;<span class="op" id="4538770">:=</span>&nbsp;<span class="ident" id="4538773">cert</span><span class="op" id="4538777">.</span><span class="ident" id="4538778">PrivateKey</span><span class="op" id="4538788">.</span><span class="op" id="4538789">(</span><span class="op" id="4538790">*</span><span class="ident" id="4538791">rsa</span><span class="op" id="4538794">.</span><span class="ident" id="4538795">PrivateKey</span><span class="op" id="4538805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538809">if</span>&nbsp;<span class="op" id="4538812">!</span><span class="ident" id="4538813">ok</span>&nbsp;<span class="op" id="4538816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538821">return</span>&nbsp;<span class="ident" id="4538828">nil</span><span class="op" id="4538831">,</span>&nbsp;<span class="ident" id="4538833">errors</span><span class="op" id="4538839">.</span><span class="ident" id="4538840">New</span><span class="op" id="4538843">(</span><span class="string" id="4538844">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4538889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4538893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4538897">sig</span><span class="op" id="4538900">,</span>&nbsp;<span class="ident" id="4538902">err</span>&nbsp;<span class="op" id="4538906">=</span>&nbsp;<span class="ident" id="4538908">rsa</span><span class="op" id="4538911">.</span><span class="ident" id="4538912">SignPKCS1v15</span><span class="op" id="4538924">(</span><span class="ident" id="4538925">config</span><span class="op" id="4538931">.</span><span class="ident" id="4538932">rand</span><span class="op" id="4538936">(</span><span class="op" id="4538937">)</span><span class="op" id="4538938">,</span>&nbsp;<span class="ident" id="4538940">privKey</span><span class="op" id="4538947">,</span>&nbsp;<span class="ident" id="4538949">hashFunc</span><span class="op" id="4538957">,</span>&nbsp;<span class="ident" id="4538959">digest</span><span class="op" id="4538965">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538969">if</span>&nbsp;<span class="ident" id="4538972">err</span>&nbsp;<span class="op" id="4538976">!=</span>&nbsp;<span class="ident" id="4538979">nil</span>&nbsp;<span class="op" id="4538983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4538988">return</span>&nbsp;<span class="ident" id="4538995">nil</span><span class="op" id="4538998">,</span>&nbsp;<span class="ident" id="4539000">errors</span><span class="op" id="4539006">.</span><span class="ident" id="4539007">New</span><span class="op" id="4539010">(</span><span class="string" id="4539011">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4539047">+</span>&nbsp;<span class="ident" id="4539049">err</span><span class="op" id="4539052">.</span><span class="ident" id="4539053">Error</span><span class="op" id="4539058">(</span><span class="op" id="4539059">)</span><span class="op" id="4539060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539067">default</span><span class="op" id="4539074">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539078">return</span>&nbsp;<span class="ident" id="4539085">nil</span><span class="op" id="4539088">,</span>&nbsp;<span class="ident" id="4539090">errors</span><span class="op" id="4539096">.</span><span class="ident" id="4539097">New</span><span class="op" id="4539100">(</span><span class="string" id="4539101">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4539136">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539143">skx</span>&nbsp;<span class="op" id="4539147">:=</span>&nbsp;<span class="builtinfunc" id="4539150">new</span><span class="op" id="4539153">(</span><span class="ident" id="4539154">serverKeyExchangeMsg</span><span class="op" id="4539174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539177">sigAndHashLen</span>&nbsp;<span class="op" id="4539191">:=</span>&nbsp;<span class="num" id="4539194">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539197">if</span>&nbsp;<span class="ident" id="4539200">ka</span><span class="op" id="4539202">.</span><span class="ident" id="4539203">version</span>&nbsp;<span class="op" id="4539211">&gt;=</span>&nbsp;<span class="ident" id="4539214">VersionTLS12</span>&nbsp;<span class="op" id="4539227">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539231">sigAndHashLen</span>&nbsp;<span class="op" id="4539245">=</span>&nbsp;<span class="num" id="4539247">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539253">skx</span><span class="op" id="4539256">.</span><span class="ident" id="4539257">key</span>&nbsp;<span class="op" id="4539261">=</span>&nbsp;<span class="builtinfunc" id="4539263">make</span><span class="op" id="4539267">(</span><span class="op" id="4539268">[</span><span class="op" id="4539269">]</span><span class="builtintype" id="4539270">byte</span><span class="op" id="4539274">,</span>&nbsp;<span class="builtinfunc" id="4539276">len</span><span class="op" id="4539279">(</span><span class="ident" id="4539280">serverECDHParams</span><span class="op" id="4539296">)</span><span class="op" id="4539297">+</span><span class="ident" id="4539298">sigAndHashLen</span><span class="op" id="4539311">+</span><span class="num" id="4539312">2</span><span class="op" id="4539313">+</span><span class="builtinfunc" id="4539314">len</span><span class="op" id="4539317">(</span><span class="ident" id="4539318">sig</span><span class="op" id="4539321">)</span><span class="op" id="4539322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4539325">copy</span><span class="op" id="4539329">(</span><span class="ident" id="4539330">skx</span><span class="op" id="4539333">.</span><span class="ident" id="4539334">key</span><span class="op" id="4539337">,</span>&nbsp;<span class="ident" id="4539339">serverECDHParams</span><span class="op" id="4539355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539358">k</span>&nbsp;<span class="op" id="4539360">:=</span>&nbsp;<span class="ident" id="4539363">skx</span><span class="op" id="4539366">.</span><span class="ident" id="4539367">key</span><span class="op" id="4539370">[</span><span class="builtinfunc" id="4539371">len</span><span class="op" id="4539374">(</span><span class="ident" id="4539375">serverECDHParams</span><span class="op" id="4539391">)</span><span class="op" id="4539392">:</span><span class="op" id="4539393">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539396">if</span>&nbsp;<span class="ident" id="4539399">ka</span><span class="op" id="4539401">.</span><span class="ident" id="4539402">version</span>&nbsp;<span class="op" id="4539410">&gt;=</span>&nbsp;<span class="ident" id="4539413">VersionTLS12</span>&nbsp;<span class="op" id="4539426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539430">k</span><span class="op" id="4539431">[</span><span class="num" id="4539432">0</span><span class="op" id="4539433">]</span>&nbsp;<span class="op" id="4539435">=</span>&nbsp;<span class="ident" id="4539437">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539451">k</span><span class="op" id="4539452">[</span><span class="num" id="4539453">1</span><span class="op" id="4539454">]</span>&nbsp;<span class="op" id="4539456">=</span>&nbsp;<span class="ident" id="4539458">ka</span><span class="op" id="4539460">.</span><span class="ident" id="4539461">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539471">k</span>&nbsp;<span class="op" id="4539473">=</span>&nbsp;<span class="ident" id="4539475">k</span><span class="op" id="4539476">[</span><span class="num" id="4539477">2</span><span class="op" id="4539478">:</span><span class="op" id="4539479">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539482">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539485">k</span><span class="op" id="4539486">[</span><span class="num" id="4539487">0</span><span class="op" id="4539488">]</span>&nbsp;<span class="op" id="4539490">=</span>&nbsp;<span class="builtintype" id="4539492">byte</span><span class="op" id="4539496">(</span><span class="builtinfunc" id="4539497">len</span><span class="op" id="4539500">(</span><span class="ident" id="4539501">sig</span><span class="op" id="4539504">)</span>&nbsp;<span class="op" id="4539506">&gt;&gt;</span>&nbsp;<span class="num" id="4539509">8</span><span class="op" id="4539510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539513">k</span><span class="op" id="4539514">[</span><span class="num" id="4539515">1</span><span class="op" id="4539516">]</span>&nbsp;<span class="op" id="4539518">=</span>&nbsp;<span class="builtintype" id="4539520">byte</span><span class="op" id="4539524">(</span><span class="builtinfunc" id="4539525">len</span><span class="op" id="4539528">(</span><span class="ident" id="4539529">sig</span><span class="op" id="4539532">)</span><span class="op" id="4539533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4539536">copy</span><span class="op" id="4539540">(</span><span class="ident" id="4539541">k</span><span class="op" id="4539542">[</span><span class="num" id="4539543">2</span><span class="op" id="4539544">:</span><span class="op" id="4539545">]</span><span class="op" id="4539546">,</span>&nbsp;<span class="ident" id="4539548">sig</span><span class="op" id="4539551">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539555">return</span>&nbsp;<span class="ident" id="4539562">skx</span><span class="op" id="4539565">,</span>&nbsp;<span class="ident" id="4539567">nil</span><br>
<span class="lineno">285</span><span class="op" id="4539571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4539574">func</span>&nbsp;<span class="op" id="4539579">(</span><span class="ident" id="4539580">ka</span>&nbsp;<span class="op" id="4539583">*</span><span class="ident" id="4539584">ecdheKeyAgreement</span><span class="op" id="4539601">)</span>&nbsp;<span class="ident" id="4539603">processClientKeyExchange</span><span class="op" id="4539627">(</span><span class="ident" id="4539628">config</span>&nbsp;<span class="op" id="4539635">*</span><span class="ident" id="4539636">Config</span><span class="op" id="4539642">,</span>&nbsp;<span class="ident" id="4539644">cert</span>&nbsp;<span class="op" id="4539649">*</span><span class="ident" id="4539650">Certificate</span><span class="op" id="4539661">,</span>&nbsp;<span class="ident" id="4539663">ckx</span>&nbsp;<span class="op" id="4539667">*</span><span class="ident" id="4539668">clientKeyExchangeMsg</span><span class="op" id="4539688">,</span>&nbsp;<span class="ident" id="4539690">version</span>&nbsp;<span class="builtintype" id="4539698">uint16</span><span class="op" id="4539704">)</span>&nbsp;<span class="op" id="4539706">(</span><span class="op" id="4539707">[</span><span class="op" id="4539708">]</span><span class="builtintype" id="4539709">byte</span><span class="op" id="4539713">,</span>&nbsp;<span class="builtintype" id="4539715">error</span><span class="op" id="4539720">)</span>&nbsp;<span class="op" id="4539722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539725">if</span>&nbsp;<span class="builtinfunc" id="4539728">len</span><span class="op" id="4539731">(</span><span class="ident" id="4539732">ckx</span><span class="op" id="4539735">.</span><span class="ident" id="4539736">ciphertext</span><span class="op" id="4539746">)</span>&nbsp;<span class="op" id="4539748">==</span>&nbsp;<span class="num" id="4539751">0</span>&nbsp;<span class="op" id="4539753">||</span>&nbsp;<span class="builtintype" id="4539756">int</span><span class="op" id="4539759">(</span><span class="ident" id="4539760">ckx</span><span class="op" id="4539763">.</span><span class="ident" id="4539764">ciphertext</span><span class="op" id="4539774">[</span><span class="num" id="4539775">0</span><span class="op" id="4539776">]</span><span class="op" id="4539777">)</span>&nbsp;<span class="op" id="4539779">!=</span>&nbsp;<span class="builtinfunc" id="4539782">len</span><span class="op" id="4539785">(</span><span class="ident" id="4539786">ckx</span><span class="op" id="4539789">.</span><span class="ident" id="4539790">ciphertext</span><span class="op" id="4539800">)</span><span class="op" id="4539801">-</span><span class="num" id="4539802">1</span>&nbsp;<span class="op" id="4539804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539808">return</span>&nbsp;<span class="ident" id="4539815">nil</span><span class="op" id="4539818">,</span>&nbsp;<span class="ident" id="4539820">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4539845">x</span><span class="op" id="4539846">,</span>&nbsp;<span class="ident" id="4539848">y</span>&nbsp;<span class="op" id="4539850">:=</span>&nbsp;<span class="ident" id="4539853">elliptic</span><span class="op" id="4539861">.</span><span class="ident" id="4539862">Unmarshal</span><span class="op" id="4539871">(</span><span class="ident" id="4539872">ka</span><span class="op" id="4539874">.</span><span class="ident" id="4539875">curve</span><span class="op" id="4539880">,</span>&nbsp;<span class="ident" id="4539882">ckx</span><span class="op" id="4539885">.</span><span class="ident" id="4539886">ciphertext</span><span class="op" id="4539896">[</span><span class="num" id="4539897">1</span><span class="op" id="4539898">:</span><span class="op" id="4539899">]</span><span class="op" id="4539900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539903">if</span>&nbsp;<span class="ident" id="4539906">x</span>&nbsp;<span class="op" id="4539908">==</span>&nbsp;<span class="ident" id="4539911">nil</span>&nbsp;<span class="op" id="4539915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539919">return</span>&nbsp;<span class="ident" id="4539926">nil</span><span class="op" id="4539929">,</span>&nbsp;<span class="ident" id="4539931">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4539953">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539956">if</span>&nbsp;<span class="op" id="4539959">!</span><span class="ident" id="4539960">ka</span><span class="op" id="4539962">.</span><span class="ident" id="4539963">curve</span><span class="op" id="4539968">.</span><span class="ident" id="4539969">IsOnCurve</span><span class="op" id="4539978">(</span><span class="ident" id="4539979">x</span><span class="op" id="4539980">,</span>&nbsp;<span class="ident" id="4539982">y</span><span class="op" id="4539983">)</span>&nbsp;<span class="op" id="4539985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4539989">return</span>&nbsp;<span class="ident" id="4539996">nil</span><span class="op" id="4539999">,</span>&nbsp;<span class="ident" id="4540001">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540026">x</span><span class="op" id="4540027">,</span>&nbsp;<span class="ident" id="4540029">_</span>&nbsp;<span class="op" id="4540031">=</span>&nbsp;<span class="ident" id="4540033">ka</span><span class="op" id="4540035">.</span><span class="ident" id="4540036">curve</span><span class="op" id="4540041">.</span><span class="ident" id="4540042">ScalarMult</span><span class="op" id="4540052">(</span><span class="ident" id="4540053">x</span><span class="op" id="4540054">,</span>&nbsp;<span class="ident" id="4540056">y</span><span class="op" id="4540057">,</span>&nbsp;<span class="ident" id="4540059">ka</span><span class="op" id="4540061">.</span><span class="ident" id="4540062">privateKey</span><span class="op" id="4540072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540075">preMasterSecret</span>&nbsp;<span class="op" id="4540091">:=</span>&nbsp;<span class="builtinfunc" id="4540094">make</span><span class="op" id="4540098">(</span><span class="op" id="4540099">[</span><span class="op" id="4540100">]</span><span class="builtintype" id="4540101">byte</span><span class="op" id="4540105">,</span>&nbsp;<span class="op" id="4540107">(</span><span class="ident" id="4540108">ka</span><span class="op" id="4540110">.</span><span class="ident" id="4540111">curve</span><span class="op" id="4540116">.</span><span class="ident" id="4540117">Params</span><span class="op" id="4540123">(</span><span class="op" id="4540124">)</span><span class="op" id="4540125">.</span><span class="ident" id="4540126">BitSize</span><span class="op" id="4540133">+</span><span class="num" id="4540134">7</span><span class="op" id="4540135">)</span><span class="op" id="4540136">&gt;&gt;</span><span class="num" id="4540138">3</span><span class="op" id="4540139">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540142">xBytes</span>&nbsp;<span class="op" id="4540149">:=</span>&nbsp;<span class="ident" id="4540152">x</span><span class="op" id="4540153">.</span><span class="ident" id="4540154">Bytes</span><span class="op" id="4540159">(</span><span class="op" id="4540160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4540163">copy</span><span class="op" id="4540167">(</span><span class="ident" id="4540168">preMasterSecret</span><span class="op" id="4540183">[</span><span class="builtinfunc" id="4540184">len</span><span class="op" id="4540187">(</span><span class="ident" id="4540188">preMasterSecret</span><span class="op" id="4540203">)</span><span class="op" id="4540204">-</span><span class="builtinfunc" id="4540205">len</span><span class="op" id="4540208">(</span><span class="ident" id="4540209">xBytes</span><span class="op" id="4540215">)</span><span class="op" id="4540216">:</span><span class="op" id="4540217">]</span><span class="op" id="4540218">,</span>&nbsp;<span class="ident" id="4540220">xBytes</span><span class="op" id="4540226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540230">return</span>&nbsp;<span class="ident" id="4540237">preMasterSecret</span><span class="op" id="4540252">,</span>&nbsp;<span class="ident" id="4540254">nil</span><br>
<span class="lineno"></span><span class="op" id="4540258">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4540261">func</span>&nbsp;<span class="op" id="4540266">(</span><span class="ident" id="4540267">ka</span>&nbsp;<span class="op" id="4540270">*</span><span class="ident" id="4540271">ecdheKeyAgreement</span><span class="op" id="4540288">)</span>&nbsp;<span class="ident" id="4540290">processServerKeyExchange</span><span class="op" id="4540314">(</span><span class="ident" id="4540315">config</span>&nbsp;<span class="op" id="4540322">*</span><span class="ident" id="4540323">Config</span><span class="op" id="4540329">,</span>&nbsp;<span class="ident" id="4540331">clientHello</span>&nbsp;<span class="op" id="4540343">*</span><span class="ident" id="4540344">clientHelloMsg</span><span class="op" id="4540358">,</span>&nbsp;<span class="ident" id="4540360">serverHello</span>&nbsp;<span class="op" id="4540372">*</span><span class="ident" id="4540373">serverHelloMsg</span><span class="op" id="4540387">,</span>&nbsp;<span class="ident" id="4540389">cert</span>&nbsp;<span class="op" id="4540394">*</span><span class="ident" id="4540395">x509</span><span class="op" id="4540399">.</span><span class="ident" id="4540400">Certificate</span><span class="op" id="4540411">,</span>&nbsp;<span class="ident" id="4540413">skx</span>&nbsp;<span class="op" id="4540417">*</span><span class="ident" id="4540418">serverKeyExchangeMsg</span><span class="op" id="4540438">)</span>&nbsp;<span class="builtintype" id="4540440">error</span>&nbsp;<span class="op" id="4540446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540449">if</span>&nbsp;<span class="builtinfunc" id="4540452">len</span><span class="op" id="4540455">(</span><span class="ident" id="4540456">skx</span><span class="op" id="4540459">.</span><span class="ident" id="4540460">key</span><span class="op" id="4540463">)</span>&nbsp;<span class="op" id="4540465">&lt;</span>&nbsp;<span class="num" id="4540467">4</span>&nbsp;<span class="op" id="4540469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540473">return</span>&nbsp;<span class="ident" id="4540480">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540502">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540505">if</span>&nbsp;<span class="ident" id="4540508">skx</span><span class="op" id="4540511">.</span><span class="ident" id="4540512">key</span><span class="op" id="4540515">[</span><span class="num" id="4540516">0</span><span class="op" id="4540517">]</span>&nbsp;<span class="op" id="4540519">!=</span>&nbsp;<span class="num" id="4540522">3</span>&nbsp;<span class="op" id="4540524">{</span>&nbsp;<span class="comment" id="4540526">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540543">return</span>&nbsp;<span class="ident" id="4540550">errors</span><span class="op" id="4540556">.</span><span class="ident" id="4540557">New</span><span class="op" id="4540560">(</span><span class="string" id="4540561">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4540601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540607">curveid</span>&nbsp;<span class="op" id="4540615">:=</span>&nbsp;<span class="ident" id="4540618">CurveID</span><span class="op" id="4540625">(</span><span class="ident" id="4540626">skx</span><span class="op" id="4540629">.</span><span class="ident" id="4540630">key</span><span class="op" id="4540633">[</span><span class="num" id="4540634">1</span><span class="op" id="4540635">]</span><span class="op" id="4540636">)</span><span class="op" id="4540637">&lt;&lt;</span><span class="num" id="4540639">8</span>&nbsp;<span class="op" id="4540641">|</span>&nbsp;<span class="ident" id="4540643">CurveID</span><span class="op" id="4540650">(</span><span class="ident" id="4540651">skx</span><span class="op" id="4540654">.</span><span class="ident" id="4540655">key</span><span class="op" id="4540658">[</span><span class="num" id="4540659">2</span><span class="op" id="4540660">]</span><span class="op" id="4540661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540665">var</span>&nbsp;<span class="ident" id="4540669">ok</span>&nbsp;<span class="builtintype" id="4540672">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540678">if</span>&nbsp;<span class="ident" id="4540681">ka</span><span class="op" id="4540683">.</span><span class="ident" id="4540684">curve</span><span class="op" id="4540689">,</span>&nbsp;<span class="ident" id="4540691">ok</span>&nbsp;<span class="op" id="4540694">=</span>&nbsp;<span class="ident" id="4540696">curveForCurveID</span><span class="op" id="4540711">(</span><span class="ident" id="4540712">curveid</span><span class="op" id="4540719">)</span><span class="op" id="4540720">;</span>&nbsp;<span class="op" id="4540722">!</span><span class="ident" id="4540723">ok</span>&nbsp;<span class="op" id="4540726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540730">return</span>&nbsp;<span class="ident" id="4540737">errors</span><span class="op" id="4540743">.</span><span class="ident" id="4540744">New</span><span class="op" id="4540747">(</span><span class="string" id="4540748">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4540788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540795">publicLen</span>&nbsp;<span class="op" id="4540805">:=</span>&nbsp;<span class="builtintype" id="4540808">int</span><span class="op" id="4540811">(</span><span class="ident" id="4540812">skx</span><span class="op" id="4540815">.</span><span class="ident" id="4540816">key</span><span class="op" id="4540819">[</span><span class="num" id="4540820">3</span><span class="op" id="4540821">]</span><span class="op" id="4540822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540825">if</span>&nbsp;<span class="ident" id="4540828">publicLen</span><span class="op" id="4540837">+</span><span class="num" id="4540838">4</span>&nbsp;<span class="op" id="4540840">&gt;</span>&nbsp;<span class="builtinfunc" id="4540842">len</span><span class="op" id="4540845">(</span><span class="ident" id="4540846">skx</span><span class="op" id="4540849">.</span><span class="ident" id="4540850">key</span><span class="op" id="4540853">)</span>&nbsp;<span class="op" id="4540855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540859">return</span>&nbsp;<span class="ident" id="4540866">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4540888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4540891">ka</span><span class="op" id="4540893">.</span><span class="ident" id="4540894">x</span><span class="op" id="4540895">,</span>&nbsp;<span class="ident" id="4540897">ka</span><span class="op" id="4540899">.</span><span class="ident" id="4540900">y</span>&nbsp;<span class="op" id="4540902">=</span>&nbsp;<span class="ident" id="4540904">elliptic</span><span class="op" id="4540912">.</span><span class="ident" id="4540913">Unmarshal</span><span class="op" id="4540922">(</span><span class="ident" id="4540923">ka</span><span class="op" id="4540925">.</span><span class="ident" id="4540926">curve</span><span class="op" id="4540931">,</span>&nbsp;<span class="ident" id="4540933">skx</span><span class="op" id="4540936">.</span><span class="ident" id="4540937">key</span><span class="op" id="4540940">[</span><span class="num" id="4540941">4</span><span class="op" id="4540942">:</span><span class="num" id="4540943">4</span><span class="op" id="4540944">+</span><span class="ident" id="4540945">publicLen</span><span class="op" id="4540954">]</span><span class="op" id="4540955">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540958">if</span>&nbsp;<span class="ident" id="4540961">ka</span><span class="op" id="4540963">.</span><span class="ident" id="4540964">x</span>&nbsp;<span class="op" id="4540966">==</span>&nbsp;<span class="ident" id="4540969">nil</span>&nbsp;<span class="op" id="4540973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4540977">return</span>&nbsp;<span class="ident" id="4540984">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541009">if</span>&nbsp;<span class="op" id="4541012">!</span><span class="ident" id="4541013">ka</span><span class="op" id="4541015">.</span><span class="ident" id="4541016">curve</span><span class="op" id="4541021">.</span><span class="ident" id="4541022">IsOnCurve</span><span class="op" id="4541031">(</span><span class="ident" id="4541032">ka</span><span class="op" id="4541034">.</span><span class="ident" id="4541035">x</span><span class="op" id="4541036">,</span>&nbsp;<span class="ident" id="4541038">ka</span><span class="op" id="4541040">.</span><span class="ident" id="4541041">y</span><span class="op" id="4541042">)</span>&nbsp;<span class="op" id="4541044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541048">return</span>&nbsp;<span class="ident" id="4541055">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541080">serverECDHParams</span>&nbsp;<span class="op" id="4541097">:=</span>&nbsp;<span class="ident" id="4541100">skx</span><span class="op" id="4541103">.</span><span class="ident" id="4541104">key</span><span class="op" id="4541107">[</span><span class="op" id="4541108">:</span><span class="num" id="4541109">4</span><span class="op" id="4541110">+</span><span class="ident" id="4541111">publicLen</span><span class="op" id="4541120">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541124">sig</span>&nbsp;<span class="op" id="4541128">:=</span>&nbsp;<span class="ident" id="4541131">skx</span><span class="op" id="4541134">.</span><span class="ident" id="4541135">key</span><span class="op" id="4541138">[</span><span class="num" id="4541139">4</span><span class="op" id="4541140">+</span><span class="ident" id="4541141">publicLen</span><span class="op" id="4541150">:</span><span class="op" id="4541151">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541154">if</span>&nbsp;<span class="builtinfunc" id="4541157">len</span><span class="op" id="4541160">(</span><span class="ident" id="4541161">sig</span><span class="op" id="4541164">)</span>&nbsp;<span class="op" id="4541166">&lt;</span>&nbsp;<span class="num" id="4541168">2</span>&nbsp;<span class="op" id="4541170">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541174">return</span>&nbsp;<span class="ident" id="4541181">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541207">var</span>&nbsp;<span class="ident" id="4541211">tls12HashId</span>&nbsp;<span class="builtintype" id="4541223">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541230">if</span>&nbsp;<span class="ident" id="4541233">ka</span><span class="op" id="4541235">.</span><span class="ident" id="4541236">version</span>&nbsp;<span class="op" id="4541244">&gt;=</span>&nbsp;<span class="ident" id="4541247">VersionTLS12</span>&nbsp;<span class="op" id="4541260">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4541264">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541302">var</span>&nbsp;<span class="ident" id="4541306">sigAndHash</span>&nbsp;<span class="op" id="4541317">[</span><span class="op" id="4541318">]</span><span class="builtintype" id="4541319">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541327">sigAndHash</span><span class="op" id="4541337">,</span>&nbsp;<span class="ident" id="4541339">sig</span>&nbsp;<span class="op" id="4541343">=</span>&nbsp;<span class="ident" id="4541345">sig</span><span class="op" id="4541348">[</span><span class="op" id="4541349">:</span><span class="num" id="4541350">2</span><span class="op" id="4541351">]</span><span class="op" id="4541352">,</span>&nbsp;<span class="ident" id="4541354">sig</span><span class="op" id="4541357">[</span><span class="num" id="4541358">2</span><span class="op" id="4541359">:</span><span class="op" id="4541360">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541364">if</span>&nbsp;<span class="ident" id="4541367">sigAndHash</span><span class="op" id="4541377">[</span><span class="num" id="4541378">1</span><span class="op" id="4541379">]</span>&nbsp;<span class="op" id="4541381">!=</span>&nbsp;<span class="ident" id="4541384">ka</span><span class="op" id="4541386">.</span><span class="ident" id="4541387">sigType</span>&nbsp;<span class="op" id="4541395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541400">return</span>&nbsp;<span class="ident" id="4541407">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541434">tls12HashId</span>&nbsp;<span class="op" id="4541446">=</span>&nbsp;<span class="ident" id="4541448">sigAndHash</span><span class="op" id="4541458">[</span><span class="num" id="4541459">0</span><span class="op" id="4541460">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541464">if</span>&nbsp;<span class="builtinfunc" id="4541467">len</span><span class="op" id="4541470">(</span><span class="ident" id="4541471">sig</span><span class="op" id="4541474">)</span>&nbsp;<span class="op" id="4541476">&lt;</span>&nbsp;<span class="num" id="4541478">2</span>&nbsp;<span class="op" id="4541480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541485">return</span>&nbsp;<span class="ident" id="4541492">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541515">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541521">sigLen</span>&nbsp;<span class="op" id="4541528">:=</span>&nbsp;<span class="builtintype" id="4541531">int</span><span class="op" id="4541534">(</span><span class="ident" id="4541535">sig</span><span class="op" id="4541538">[</span><span class="num" id="4541539">0</span><span class="op" id="4541540">]</span><span class="op" id="4541541">)</span><span class="op" id="4541542">&lt;&lt;</span><span class="num" id="4541544">8</span>&nbsp;<span class="op" id="4541546">|</span>&nbsp;<span class="builtintype" id="4541548">int</span><span class="op" id="4541551">(</span><span class="ident" id="4541552">sig</span><span class="op" id="4541555">[</span><span class="num" id="4541556">1</span><span class="op" id="4541557">]</span><span class="op" id="4541558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541561">if</span>&nbsp;<span class="ident" id="4541564">sigLen</span><span class="op" id="4541570">+</span><span class="num" id="4541571">2</span>&nbsp;<span class="op" id="4541573">!=</span>&nbsp;<span class="builtinfunc" id="4541576">len</span><span class="op" id="4541579">(</span><span class="ident" id="4541580">sig</span><span class="op" id="4541583">)</span>&nbsp;<span class="op" id="4541585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541589">return</span>&nbsp;<span class="ident" id="4541596">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541618">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541621">sig</span>&nbsp;<span class="op" id="4541625">=</span>&nbsp;<span class="ident" id="4541627">sig</span><span class="op" id="4541630">[</span><span class="num" id="4541631">2</span><span class="op" id="4541632">:</span><span class="op" id="4541633">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541637">digest</span><span class="op" id="4541643">,</span>&nbsp;<span class="ident" id="4541645">hashFunc</span><span class="op" id="4541653">,</span>&nbsp;<span class="ident" id="4541655">err</span>&nbsp;<span class="op" id="4541659">:=</span>&nbsp;<span class="ident" id="4541662">hashForServerKeyExchange</span><span class="op" id="4541686">(</span><span class="ident" id="4541687">ka</span><span class="op" id="4541689">.</span><span class="ident" id="4541690">sigType</span><span class="op" id="4541697">,</span>&nbsp;<span class="ident" id="4541699">tls12HashId</span><span class="op" id="4541710">,</span>&nbsp;<span class="ident" id="4541712">ka</span><span class="op" id="4541714">.</span><span class="ident" id="4541715">version</span><span class="op" id="4541722">,</span>&nbsp;<span class="ident" id="4541724">clientHello</span><span class="op" id="4541735">.</span><span class="ident" id="4541736">random</span><span class="op" id="4541742">,</span>&nbsp;<span class="ident" id="4541744">serverHello</span><span class="op" id="4541755">.</span><span class="ident" id="4541756">random</span><span class="op" id="4541762">,</span>&nbsp;<span class="ident" id="4541764">serverECDHParams</span><span class="op" id="4541780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541783">if</span>&nbsp;<span class="ident" id="4541786">err</span>&nbsp;<span class="op" id="4541790">!=</span>&nbsp;<span class="ident" id="4541793">nil</span>&nbsp;<span class="op" id="4541797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541801">return</span>&nbsp;<span class="ident" id="4541808">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541816">switch</span>&nbsp;<span class="ident" id="4541823">ka</span><span class="op" id="4541825">.</span><span class="ident" id="4541826">sigType</span>&nbsp;<span class="op" id="4541834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541837">case</span>&nbsp;<span class="ident" id="4541842">signatureECDSA</span><span class="op" id="4541856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541860">pubKey</span><span class="op" id="4541866">,</span>&nbsp;<span class="ident" id="4541868">ok</span>&nbsp;<span class="op" id="4541871">:=</span>&nbsp;<span class="ident" id="4541874">cert</span><span class="op" id="4541878">.</span><span class="ident" id="4541879">PublicKey</span><span class="op" id="4541888">.</span><span class="op" id="4541889">(</span><span class="op" id="4541890">*</span><span class="ident" id="4541891">ecdsa</span><span class="op" id="4541896">.</span><span class="ident" id="4541897">PublicKey</span><span class="op" id="4541906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541910">if</span>&nbsp;<span class="op" id="4541913">!</span><span class="ident" id="4541914">ok</span>&nbsp;<span class="op" id="4541917">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4541922">return</span>&nbsp;<span class="ident" id="4541929">errors</span><span class="op" id="4541935">.</span><span class="ident" id="4541936">New</span><span class="op" id="4541939">(</span><span class="string" id="4541940">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4541988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4541992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4541996">ecdsaSig</span>&nbsp;<span class="op" id="4542005">:=</span>&nbsp;<span class="builtinfunc" id="4542008">new</span><span class="op" id="4542011">(</span><span class="ident" id="4542012">ecdsaSignature</span><span class="op" id="4542026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542030">if</span>&nbsp;<span class="ident" id="4542033">_</span><span class="op" id="4542034">,</span>&nbsp;<span class="ident" id="4542036">err</span>&nbsp;<span class="op" id="4542040">:=</span>&nbsp;<span class="ident" id="4542043">asn1</span><span class="op" id="4542047">.</span><span class="ident" id="4542048">Unmarshal</span><span class="op" id="4542057">(</span><span class="ident" id="4542058">sig</span><span class="op" id="4542061">,</span>&nbsp;<span class="ident" id="4542063">ecdsaSig</span><span class="op" id="4542071">)</span><span class="op" id="4542072">;</span>&nbsp;<span class="ident" id="4542074">err</span>&nbsp;<span class="op" id="4542078">!=</span>&nbsp;<span class="ident" id="4542081">nil</span>&nbsp;<span class="op" id="4542085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542090">return</span>&nbsp;<span class="ident" id="4542097">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542107">if</span>&nbsp;<span class="ident" id="4542110">ecdsaSig</span><span class="op" id="4542118">.</span><span class="ident" id="4542119">R</span><span class="op" id="4542120">.</span><span class="ident" id="4542121">Sign</span><span class="op" id="4542125">(</span><span class="op" id="4542126">)</span>&nbsp;<span class="op" id="4542128">&lt;=</span>&nbsp;<span class="num" id="4542131">0</span>&nbsp;<span class="op" id="4542133">||</span>&nbsp;<span class="ident" id="4542136">ecdsaSig</span><span class="op" id="4542144">.</span><span class="ident" id="4542145">S</span><span class="op" id="4542146">.</span><span class="ident" id="4542147">Sign</span><span class="op" id="4542151">(</span><span class="op" id="4542152">)</span>&nbsp;<span class="op" id="4542154">&lt;=</span>&nbsp;<span class="num" id="4542157">0</span>&nbsp;<span class="op" id="4542159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542164">return</span>&nbsp;<span class="ident" id="4542171">errors</span><span class="op" id="4542177">.</span><span class="ident" id="4542178">New</span><span class="op" id="4542181">(</span><span class="string" id="4542182">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4542233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542241">if</span>&nbsp;<span class="op" id="4542244">!</span><span class="ident" id="4542245">ecdsa</span><span class="op" id="4542250">.</span><span class="ident" id="4542251">Verify</span><span class="op" id="4542257">(</span><span class="ident" id="4542258">pubKey</span><span class="op" id="4542264">,</span>&nbsp;<span class="ident" id="4542266">digest</span><span class="op" id="4542272">,</span>&nbsp;<span class="ident" id="4542274">ecdsaSig</span><span class="op" id="4542282">.</span><span class="ident" id="4542283">R</span><span class="op" id="4542284">,</span>&nbsp;<span class="ident" id="4542286">ecdsaSig</span><span class="op" id="4542294">.</span><span class="ident" id="4542295">S</span><span class="op" id="4542296">)</span>&nbsp;<span class="op" id="4542298">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542303">return</span>&nbsp;<span class="ident" id="4542310">errors</span><span class="op" id="4542316">.</span><span class="ident" id="4542317">New</span><span class="op" id="4542320">(</span><span class="string" id="4542321">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4542349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542356">case</span>&nbsp;<span class="ident" id="4542361">signatureRSA</span><span class="op" id="4542373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542377">pubKey</span><span class="op" id="4542383">,</span>&nbsp;<span class="ident" id="4542385">ok</span>&nbsp;<span class="op" id="4542388">:=</span>&nbsp;<span class="ident" id="4542391">cert</span><span class="op" id="4542395">.</span><span class="ident" id="4542396">PublicKey</span><span class="op" id="4542405">.</span><span class="op" id="4542406">(</span><span class="op" id="4542407">*</span><span class="ident" id="4542408">rsa</span><span class="op" id="4542411">.</span><span class="ident" id="4542412">PublicKey</span><span class="op" id="4542421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542425">if</span>&nbsp;<span class="op" id="4542428">!</span><span class="ident" id="4542429">ok</span>&nbsp;<span class="op" id="4542432">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542437">return</span>&nbsp;<span class="ident" id="4542444">errors</span><span class="op" id="4542450">.</span><span class="ident" id="4542451">New</span><span class="op" id="4542454">(</span><span class="string" id="4542455">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4542499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542507">if</span>&nbsp;<span class="ident" id="4542510">err</span>&nbsp;<span class="op" id="4542514">:=</span>&nbsp;<span class="ident" id="4542517">rsa</span><span class="op" id="4542520">.</span><span class="ident" id="4542521">VerifyPKCS1v15</span><span class="op" id="4542535">(</span><span class="ident" id="4542536">pubKey</span><span class="op" id="4542542">,</span>&nbsp;<span class="ident" id="4542544">hashFunc</span><span class="op" id="4542552">,</span>&nbsp;<span class="ident" id="4542554">digest</span><span class="op" id="4542560">,</span>&nbsp;<span class="ident" id="4542562">sig</span><span class="op" id="4542565">)</span><span class="op" id="4542566">;</span>&nbsp;<span class="ident" id="4542568">err</span>&nbsp;<span class="op" id="4542572">!=</span>&nbsp;<span class="ident" id="4542575">nil</span>&nbsp;<span class="op" id="4542579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542584">return</span>&nbsp;<span class="ident" id="4542591">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542597">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542600">default</span><span class="op" id="4542607">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542611">return</span>&nbsp;<span class="ident" id="4542618">errors</span><span class="op" id="4542624">.</span><span class="ident" id="4542625">New</span><span class="op" id="4542628">(</span><span class="string" id="4542629">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4542664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542671">return</span>&nbsp;<span class="ident" id="4542678">nil</span><br>
<span class="lineno">390</span><span class="op" id="4542682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4542685">func</span>&nbsp;<span class="op" id="4542690">(</span><span class="ident" id="4542691">ka</span>&nbsp;<span class="op" id="4542694">*</span><span class="ident" id="4542695">ecdheKeyAgreement</span><span class="op" id="4542712">)</span>&nbsp;<span class="ident" id="4542714">generateClientKeyExchange</span><span class="op" id="4542739">(</span><span class="ident" id="4542740">config</span>&nbsp;<span class="op" id="4542747">*</span><span class="ident" id="4542748">Config</span><span class="op" id="4542754">,</span>&nbsp;<span class="ident" id="4542756">clientHello</span>&nbsp;<span class="op" id="4542768">*</span><span class="ident" id="4542769">clientHelloMsg</span><span class="op" id="4542783">,</span>&nbsp;<span class="ident" id="4542785">cert</span>&nbsp;<span class="op" id="4542790">*</span><span class="ident" id="4542791">x509</span><span class="op" id="4542795">.</span><span class="ident" id="4542796">Certificate</span><span class="op" id="4542807">)</span>&nbsp;<span class="op" id="4542809">(</span><span class="op" id="4542810">[</span><span class="op" id="4542811">]</span><span class="builtintype" id="4542812">byte</span><span class="op" id="4542816">,</span>&nbsp;<span class="op" id="4542818">*</span><span class="ident" id="4542819">clientKeyExchangeMsg</span><span class="op" id="4542839">,</span>&nbsp;<span class="builtintype" id="4542841">error</span><span class="op" id="4542846">)</span>&nbsp;<span class="op" id="4542848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542851">if</span>&nbsp;<span class="ident" id="4542854">ka</span><span class="op" id="4542856">.</span><span class="ident" id="4542857">curve</span>&nbsp;<span class="op" id="4542863">==</span>&nbsp;<span class="ident" id="4542866">nil</span>&nbsp;<span class="op" id="4542870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4542874">return</span>&nbsp;<span class="ident" id="4542881">nil</span><span class="op" id="4542884">,</span>&nbsp;<span class="ident" id="4542886">nil</span><span class="op" id="4542889">,</span>&nbsp;<span class="ident" id="4542891">errors</span><span class="op" id="4542897">.</span><span class="ident" id="4542898">New</span><span class="op" id="4542901">(</span><span class="string" id="4542902">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4542937">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4542940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4542943">priv</span><span class="op" id="4542947">,</span>&nbsp;<span class="ident" id="4542949">mx</span><span class="op" id="4542951">,</span>&nbsp;<span class="ident" id="4542953">my</span><span class="op" id="4542955">,</span>&nbsp;<span class="ident" id="4542957">err</span>&nbsp;<span class="op" id="4542961">:=</span>&nbsp;<span class="ident" id="4542964">elliptic</span><span class="op" id="4542972">.</span><span class="ident" id="4542973">GenerateKey</span><span class="op" id="4542984">(</span><span class="ident" id="4542985">ka</span><span class="op" id="4542987">.</span><span class="ident" id="4542988">curve</span><span class="op" id="4542993">,</span>&nbsp;<span class="ident" id="4542995">config</span><span class="op" id="4543001">.</span><span class="ident" id="4543002">rand</span><span class="op" id="4543006">(</span><span class="op" id="4543007">)</span><span class="op" id="4543008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543011">if</span>&nbsp;<span class="ident" id="4543014">err</span>&nbsp;<span class="op" id="4543018">!=</span>&nbsp;<span class="ident" id="4543021">nil</span>&nbsp;<span class="op" id="4543025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543029">return</span>&nbsp;<span class="ident" id="4543036">nil</span><span class="op" id="4543039">,</span>&nbsp;<span class="ident" id="4543041">nil</span><span class="op" id="4543044">,</span>&nbsp;<span class="ident" id="4543046">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4543051">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543054">x</span><span class="op" id="4543055">,</span>&nbsp;<span class="ident" id="4543057">_</span>&nbsp;<span class="op" id="4543059">:=</span>&nbsp;<span class="ident" id="4543062">ka</span><span class="op" id="4543064">.</span><span class="ident" id="4543065">curve</span><span class="op" id="4543070">.</span><span class="ident" id="4543071">ScalarMult</span><span class="op" id="4543081">(</span><span class="ident" id="4543082">ka</span><span class="op" id="4543084">.</span><span class="ident" id="4543085">x</span><span class="op" id="4543086">,</span>&nbsp;<span class="ident" id="4543088">ka</span><span class="op" id="4543090">.</span><span class="ident" id="4543091">y</span><span class="op" id="4543092">,</span>&nbsp;<span class="ident" id="4543094">priv</span><span class="op" id="4543098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543101">preMasterSecret</span>&nbsp;<span class="op" id="4543117">:=</span>&nbsp;<span class="builtinfunc" id="4543120">make</span><span class="op" id="4543124">(</span><span class="op" id="4543125">[</span><span class="op" id="4543126">]</span><span class="builtintype" id="4543127">byte</span><span class="op" id="4543131">,</span>&nbsp;<span class="op" id="4543133">(</span><span class="ident" id="4543134">ka</span><span class="op" id="4543136">.</span><span class="ident" id="4543137">curve</span><span class="op" id="4543142">.</span><span class="ident" id="4543143">Params</span><span class="op" id="4543149">(</span><span class="op" id="4543150">)</span><span class="op" id="4543151">.</span><span class="ident" id="4543152">BitSize</span><span class="op" id="4543159">+</span><span class="num" id="4543160">7</span><span class="op" id="4543161">)</span><span class="op" id="4543162">&gt;&gt;</span><span class="num" id="4543164">3</span><span class="op" id="4543165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543168">xBytes</span>&nbsp;<span class="op" id="4543175">:=</span>&nbsp;<span class="ident" id="4543178">x</span><span class="op" id="4543179">.</span><span class="ident" id="4543180">Bytes</span><span class="op" id="4543185">(</span><span class="op" id="4543186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4543189">copy</span><span class="op" id="4543193">(</span><span class="ident" id="4543194">preMasterSecret</span><span class="op" id="4543209">[</span><span class="builtinfunc" id="4543210">len</span><span class="op" id="4543213">(</span><span class="ident" id="4543214">preMasterSecret</span><span class="op" id="4543229">)</span><span class="op" id="4543230">-</span><span class="builtinfunc" id="4543231">len</span><span class="op" id="4543234">(</span><span class="ident" id="4543235">xBytes</span><span class="op" id="4543241">)</span><span class="op" id="4543242">:</span><span class="op" id="4543243">]</span><span class="op" id="4543244">,</span>&nbsp;<span class="ident" id="4543246">xBytes</span><span class="op" id="4543252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543256">serialized</span>&nbsp;<span class="op" id="4543267">:=</span>&nbsp;<span class="ident" id="4543270">elliptic</span><span class="op" id="4543278">.</span><span class="ident" id="4543279">Marshal</span><span class="op" id="4543286">(</span><span class="ident" id="4543287">ka</span><span class="op" id="4543289">.</span><span class="ident" id="4543290">curve</span><span class="op" id="4543295">,</span>&nbsp;<span class="ident" id="4543297">mx</span><span class="op" id="4543299">,</span>&nbsp;<span class="ident" id="4543301">my</span><span class="op" id="4543303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543307">ckx</span>&nbsp;<span class="op" id="4543311">:=</span>&nbsp;<span class="builtinfunc" id="4543314">new</span><span class="op" id="4543317">(</span><span class="ident" id="4543318">clientKeyExchangeMsg</span><span class="op" id="4543338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543341">ckx</span><span class="op" id="4543344">.</span><span class="ident" id="4543345">ciphertext</span>&nbsp;<span class="op" id="4543356">=</span>&nbsp;<span class="builtinfunc" id="4543358">make</span><span class="op" id="4543362">(</span><span class="op" id="4543363">[</span><span class="op" id="4543364">]</span><span class="builtintype" id="4543365">byte</span><span class="op" id="4543369">,</span>&nbsp;<span class="num" id="4543371">1</span><span class="op" id="4543372">+</span><span class="builtinfunc" id="4543373">len</span><span class="op" id="4543376">(</span><span class="ident" id="4543377">serialized</span><span class="op" id="4543387">)</span><span class="op" id="4543388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4543391">ckx</span><span class="op" id="4543394">.</span><span class="ident" id="4543395">ciphertext</span><span class="op" id="4543405">[</span><span class="num" id="4543406">0</span><span class="op" id="4543407">]</span>&nbsp;<span class="op" id="4543409">=</span>&nbsp;<span class="builtintype" id="4543411">byte</span><span class="op" id="4543415">(</span><span class="builtinfunc" id="4543416">len</span><span class="op" id="4543419">(</span><span class="ident" id="4543420">serialized</span><span class="op" id="4543430">)</span><span class="op" id="4543431">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4543434">copy</span><span class="op" id="4543438">(</span><span class="ident" id="4543439">ckx</span><span class="op" id="4543442">.</span><span class="ident" id="4543443">ciphertext</span><span class="op" id="4543453">[</span><span class="num" id="4543454">1</span><span class="op" id="4543455">:</span><span class="op" id="4543456">]</span><span class="op" id="4543457">,</span>&nbsp;<span class="ident" id="4543459">serialized</span><span class="op" id="4543469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4543473">return</span>&nbsp;<span class="ident" id="4543480">preMasterSecret</span><span class="op" id="4543495">,</span>&nbsp;<span class="ident" id="4543497">ckx</span><span class="op" id="4543500">,</span>&nbsp;<span class="ident" id="4543502">nil</span><br>
<span class="lineno"></span><span class="op" id="4543506">}</span>
</div>
</body>
</html>
