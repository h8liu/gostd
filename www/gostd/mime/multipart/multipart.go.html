<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html" class="current">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3377780">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3377835">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3377889">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3377939">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3377943">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3378136">package</span>&nbsp;<span class="ident" id="3378144">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3378155">import</span>&nbsp;<span class="op" id="3378162">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378165">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378174">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378183">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378190">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378196">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378209">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3378217">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3378233">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3378236">var</span>&nbsp;<span class="ident" id="3378240">emptyParams</span>&nbsp;<span class="op" id="3378252">=</span>&nbsp;<span class="builtinfunc" id="3378254">make</span><span class="op" id="3378258">(</span><span class="keyword" id="3378259">map</span><span class="op" id="3378262">[</span><span class="builtintype" id="3378263">string</span><span class="op" id="3378269">]</span><span class="builtintype" id="3378270">string</span><span class="op" id="3378276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3378279">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3378335">type</span>&nbsp;<span class="ident" id="3378340">Part</span>&nbsp;<span class="keyword" id="3378345">struct</span>&nbsp;<span class="op" id="3378352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378355">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378420">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378482">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378535">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378539">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378604">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378666">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378729">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378752">Header</span>&nbsp;<span class="ident" id="3378759">textproto</span><span class="op" id="3378768">.</span><span class="ident" id="3378769">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378782">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3378792">*</span><span class="ident" id="3378793">bytes</span><span class="op" id="3378798">.</span><span class="ident" id="3378799">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378807">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3378817">*</span><span class="ident" id="3378818">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378826">bytesRead</span>&nbsp;<span class="builtintype" id="3378836">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378842">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3378860">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378868">dispositionParams</span>&nbsp;<span class="keyword" id="3378886">map</span><span class="op" id="3378889">[</span><span class="builtintype" id="3378890">string</span><span class="op" id="3378896">]</span><span class="builtintype" id="3378897">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378906">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3378967">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379014">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379044">r</span>&nbsp;<span class="ident" id="3379046">io</span><span class="op" id="3379048">.</span><span class="ident" id="3379049">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3379056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3379059">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3379129">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3379193">func</span>&nbsp;<span class="op" id="3379198">(</span><span class="ident" id="3379199">p</span>&nbsp;<span class="op" id="3379201">*</span><span class="ident" id="3379202">Part</span><span class="op" id="3379206">)</span>&nbsp;<span class="ident" id="3379208">FormName</span><span class="op" id="3379216">(</span><span class="op" id="3379217">)</span>&nbsp;<span class="builtintype" id="3379219">string</span>&nbsp;<span class="op" id="3379226">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379229">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379291">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379332">if</span>&nbsp;<span class="ident" id="3379335">p</span><span class="op" id="3379336">.</span><span class="ident" id="3379337">dispositionParams</span>&nbsp;<span class="op" id="3379355">==</span>&nbsp;<span class="ident" id="3379358">nil</span>&nbsp;<span class="op" id="3379362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379366">p</span><span class="op" id="3379367">.</span><span class="ident" id="3379368">parseContentDisposition</span><span class="op" id="3379391">(</span><span class="op" id="3379392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379395">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379398">if</span>&nbsp;<span class="ident" id="3379401">p</span><span class="op" id="3379402">.</span><span class="ident" id="3379403">disposition</span>&nbsp;<span class="op" id="3379415">!=</span>&nbsp;<span class="string" id="3379418">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3379430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379434">return</span>&nbsp;<span class="string" id="3379441">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379448">return</span>&nbsp;<span class="ident" id="3379455">p</span><span class="op" id="3379456">.</span><span class="ident" id="3379457">dispositionParams</span><span class="op" id="3379474">[</span><span class="string" id="3379475">&#34;name&#34;</span><span class="op" id="3379481">]</span><br>
<span class="lineno"></span><span class="op" id="3379483">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3379486">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3379543">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3379574">func</span>&nbsp;<span class="op" id="3379579">(</span><span class="ident" id="3379580">p</span>&nbsp;<span class="op" id="3379582">*</span><span class="ident" id="3379583">Part</span><span class="op" id="3379587">)</span>&nbsp;<span class="ident" id="3379589">FileName</span><span class="op" id="3379597">(</span><span class="op" id="3379598">)</span>&nbsp;<span class="builtintype" id="3379600">string</span>&nbsp;<span class="op" id="3379607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379610">if</span>&nbsp;<span class="ident" id="3379613">p</span><span class="op" id="3379614">.</span><span class="ident" id="3379615">dispositionParams</span>&nbsp;<span class="op" id="3379633">==</span>&nbsp;<span class="ident" id="3379636">nil</span>&nbsp;<span class="op" id="3379640">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379644">p</span><span class="op" id="3379645">.</span><span class="ident" id="3379646">parseContentDisposition</span><span class="op" id="3379669">(</span><span class="op" id="3379670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379676">return</span>&nbsp;<span class="ident" id="3379683">p</span><span class="op" id="3379684">.</span><span class="ident" id="3379685">dispositionParams</span><span class="op" id="3379702">[</span><span class="string" id="3379703">&#34;filename&#34;</span><span class="op" id="3379713">]</span><br>
<span class="lineno"></span><span class="op" id="3379715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3379718">func</span>&nbsp;<span class="op" id="3379723">(</span><span class="ident" id="3379724">p</span>&nbsp;<span class="op" id="3379726">*</span><span class="ident" id="3379727">Part</span><span class="op" id="3379731">)</span>&nbsp;<span class="ident" id="3379733">parseContentDisposition</span><span class="op" id="3379756">(</span><span class="op" id="3379757">)</span>&nbsp;<span class="op" id="3379759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379762">v</span>&nbsp;<span class="op" id="3379764">:=</span>&nbsp;<span class="ident" id="3379767">p</span><span class="op" id="3379768">.</span><span class="ident" id="3379769">Header</span><span class="op" id="3379775">.</span><span class="ident" id="3379776">Get</span><span class="op" id="3379779">(</span><span class="string" id="3379780">&#34;Content-Disposition&#34;</span><span class="op" id="3379801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379804">var</span>&nbsp;<span class="ident" id="3379808">err</span>&nbsp;<span class="builtintype" id="3379812">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379819">p</span><span class="op" id="3379820">.</span><span class="ident" id="3379821">disposition</span><span class="op" id="3379832">,</span>&nbsp;<span class="ident" id="3379834">p</span><span class="op" id="3379835">.</span><span class="ident" id="3379836">dispositionParams</span><span class="op" id="3379853">,</span>&nbsp;<span class="ident" id="3379855">err</span>&nbsp;<span class="op" id="3379859">=</span>&nbsp;<span class="ident" id="3379861">mime</span><span class="op" id="3379865">.</span><span class="ident" id="3379866">ParseMediaType</span><span class="op" id="3379880">(</span><span class="ident" id="3379881">v</span><span class="op" id="3379882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379885">if</span>&nbsp;<span class="ident" id="3379888">err</span>&nbsp;<span class="op" id="3379892">!=</span>&nbsp;<span class="ident" id="3379895">nil</span>&nbsp;<span class="op" id="3379899">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379903">p</span><span class="op" id="3379904">.</span><span class="ident" id="3379905">dispositionParams</span>&nbsp;<span class="op" id="3379923">=</span>&nbsp;<span class="ident" id="3379925">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379938">}</span><br>
<span class="lineno"></span><span class="op" id="3379940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3379943">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3380012">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3380036">//</span><br>
<span class="lineno"></span><span class="comment" id="3380039">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3380108">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3380175">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3380198">func</span>&nbsp;<span class="ident" id="3380203">NewReader</span><span class="op" id="3380212">(</span><span class="ident" id="3380213">r</span>&nbsp;<span class="ident" id="3380215">io</span><span class="op" id="3380217">.</span><span class="ident" id="3380218">Reader</span><span class="op" id="3380224">,</span>&nbsp;<span class="ident" id="3380226">boundary</span>&nbsp;<span class="builtintype" id="3380235">string</span><span class="op" id="3380241">)</span>&nbsp;<span class="op" id="3380243">*</span><span class="ident" id="3380244">Reader</span>&nbsp;<span class="op" id="3380251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380254">b</span>&nbsp;<span class="op" id="3380256">:=</span>&nbsp;<span class="op" id="3380259">[</span><span class="op" id="3380260">]</span><span class="builtintype" id="3380261">byte</span><span class="op" id="3380265">(</span><span class="string" id="3380266">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3380275">+</span>&nbsp;<span class="ident" id="3380277">boundary</span>&nbsp;<span class="op" id="3380286">+</span>&nbsp;<span class="string" id="3380288">&#34;--&#34;</span><span class="op" id="3380292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380295">return</span>&nbsp;<span class="op" id="3380302">&amp;</span><span class="ident" id="3380303">Reader</span><span class="op" id="3380309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380313">bufReader</span><span class="op" id="3380322">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3380331">bufio</span><span class="op" id="3380336">.</span><span class="ident" id="3380337">NewReader</span><span class="op" id="3380346">(</span><span class="ident" id="3380347">r</span><span class="op" id="3380348">)</span><span class="op" id="3380349">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380353">nl</span><span class="op" id="3380355">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3380371">b</span><span class="op" id="3380372">[</span><span class="op" id="3380373">:</span><span class="num" id="3380374">2</span><span class="op" id="3380375">]</span><span class="op" id="3380376">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380380">nlDashBoundary</span><span class="op" id="3380394">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3380398">b</span><span class="op" id="3380399">[</span><span class="op" id="3380400">:</span><span class="builtinfunc" id="3380401">len</span><span class="op" id="3380404">(</span><span class="ident" id="3380405">b</span><span class="op" id="3380406">)</span><span class="op" id="3380407">-</span><span class="num" id="3380408">2</span><span class="op" id="3380409">]</span><span class="op" id="3380410">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380414">dashBoundaryDash</span><span class="op" id="3380430">:</span>&nbsp;<span class="ident" id="3380432">b</span><span class="op" id="3380433">[</span><span class="num" id="3380434">2</span><span class="op" id="3380435">:</span><span class="op" id="3380436">]</span><span class="op" id="3380437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380441">dashBoundary</span><span class="op" id="3380453">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3380459">b</span><span class="op" id="3380460">[</span><span class="num" id="3380461">2</span>&nbsp;<span class="op" id="3380463">:</span>&nbsp;<span class="builtinfunc" id="3380465">len</span><span class="op" id="3380468">(</span><span class="ident" id="3380469">b</span><span class="op" id="3380470">)</span><span class="op" id="3380471">-</span><span class="num" id="3380472">2</span><span class="op" id="3380473">]</span><span class="op" id="3380474">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380477">}</span><br>
<span class="lineno"></span><span class="op" id="3380479">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3380482">func</span>&nbsp;<span class="ident" id="3380487">newPart</span><span class="op" id="3380494">(</span><span class="ident" id="3380495">mr</span>&nbsp;<span class="op" id="3380498">*</span><span class="ident" id="3380499">Reader</span><span class="op" id="3380505">)</span>&nbsp;<span class="op" id="3380507">(</span><span class="op" id="3380508">*</span><span class="ident" id="3380509">Part</span><span class="op" id="3380513">,</span>&nbsp;<span class="builtintype" id="3380515">error</span><span class="op" id="3380520">)</span>&nbsp;<span class="op" id="3380522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380525">bp</span>&nbsp;<span class="op" id="3380528">:=</span>&nbsp;<span class="op" id="3380531">&amp;</span><span class="ident" id="3380532">Part</span><span class="op" id="3380536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380540">Header</span><span class="op" id="3380546">:</span>&nbsp;<span class="builtinfunc" id="3380548">make</span><span class="op" id="3380552">(</span><span class="keyword" id="3380553">map</span><span class="op" id="3380556">[</span><span class="builtintype" id="3380557">string</span><span class="op" id="3380563">]</span><span class="op" id="3380564">[</span><span class="op" id="3380565">]</span><span class="builtintype" id="3380566">string</span><span class="op" id="3380572">)</span><span class="op" id="3380573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380577">mr</span><span class="op" id="3380579">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3380585">mr</span><span class="op" id="3380587">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380591">buffer</span><span class="op" id="3380597">:</span>&nbsp;<span class="builtinfunc" id="3380599">new</span><span class="op" id="3380602">(</span><span class="ident" id="3380603">bytes</span><span class="op" id="3380608">.</span><span class="ident" id="3380609">Buffer</span><span class="op" id="3380615">)</span><span class="op" id="3380616">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380622">if</span>&nbsp;<span class="ident" id="3380625">err</span>&nbsp;<span class="op" id="3380629">:=</span>&nbsp;<span class="ident" id="3380632">bp</span><span class="op" id="3380634">.</span><span class="ident" id="3380635">populateHeaders</span><span class="op" id="3380650">(</span><span class="op" id="3380651">)</span><span class="op" id="3380652">;</span>&nbsp;<span class="ident" id="3380654">err</span>&nbsp;<span class="op" id="3380658">!=</span>&nbsp;<span class="ident" id="3380661">nil</span>&nbsp;<span class="op" id="3380665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380669">return</span>&nbsp;<span class="ident" id="3380676">nil</span><span class="op" id="3380679">,</span>&nbsp;<span class="ident" id="3380681">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380686">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380689">bp</span><span class="op" id="3380691">.</span><span class="ident" id="3380692">r</span>&nbsp;<span class="op" id="3380694">=</span>&nbsp;<span class="ident" id="3380696">partReader</span><span class="op" id="3380706">{</span><span class="ident" id="3380707">bp</span><span class="op" id="3380709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380712">const</span>&nbsp;<span class="ident" id="3380718">cte</span>&nbsp;<span class="op" id="3380722">=</span>&nbsp;<span class="string" id="3380724">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380753">if</span>&nbsp;<span class="ident" id="3380756">bp</span><span class="op" id="3380758">.</span><span class="ident" id="3380759">Header</span><span class="op" id="3380765">.</span><span class="ident" id="3380766">Get</span><span class="op" id="3380769">(</span><span class="ident" id="3380770">cte</span><span class="op" id="3380773">)</span>&nbsp;<span class="op" id="3380775">==</span>&nbsp;<span class="string" id="3380778">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3380797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380801">bp</span><span class="op" id="3380803">.</span><span class="ident" id="3380804">Header</span><span class="op" id="3380810">.</span><span class="ident" id="3380811">Del</span><span class="op" id="3380814">(</span><span class="ident" id="3380815">cte</span><span class="op" id="3380818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380822">bp</span><span class="op" id="3380824">.</span><span class="ident" id="3380825">r</span>&nbsp;<span class="op" id="3380827">=</span>&nbsp;<span class="ident" id="3380829">newQuotedPrintableReader</span><span class="op" id="3380853">(</span><span class="ident" id="3380854">bp</span><span class="op" id="3380856">.</span><span class="ident" id="3380857">r</span><span class="op" id="3380858">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380864">return</span>&nbsp;<span class="ident" id="3380871">bp</span><span class="op" id="3380873">,</span>&nbsp;<span class="ident" id="3380875">nil</span><br>
<span class="lineno"></span><span class="op" id="3380879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3380882">func</span>&nbsp;<span class="op" id="3380887">(</span><span class="ident" id="3380888">bp</span>&nbsp;<span class="op" id="3380891">*</span><span class="ident" id="3380892">Part</span><span class="op" id="3380896">)</span>&nbsp;<span class="ident" id="3380898">populateHeaders</span><span class="op" id="3380913">(</span><span class="op" id="3380914">)</span>&nbsp;<span class="builtintype" id="3380916">error</span>&nbsp;<span class="op" id="3380922">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380925">r</span>&nbsp;<span class="op" id="3380927">:=</span>&nbsp;<span class="ident" id="3380930">textproto</span><span class="op" id="3380939">.</span><span class="ident" id="3380940">NewReader</span><span class="op" id="3380949">(</span><span class="ident" id="3380950">bp</span><span class="op" id="3380952">.</span><span class="ident" id="3380953">mr</span><span class="op" id="3380955">.</span><span class="ident" id="3380956">bufReader</span><span class="op" id="3380965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380968">header</span><span class="op" id="3380974">,</span>&nbsp;<span class="ident" id="3380976">err</span>&nbsp;<span class="op" id="3380980">:=</span>&nbsp;<span class="ident" id="3380983">r</span><span class="op" id="3380984">.</span><span class="ident" id="3380985">ReadMIMEHeader</span><span class="op" id="3380999">(</span><span class="op" id="3381000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381003">if</span>&nbsp;<span class="ident" id="3381006">err</span>&nbsp;<span class="op" id="3381010">==</span>&nbsp;<span class="ident" id="3381013">nil</span>&nbsp;<span class="op" id="3381017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381021">bp</span><span class="op" id="3381023">.</span><span class="ident" id="3381024">Header</span>&nbsp;<span class="op" id="3381031">=</span>&nbsp;<span class="ident" id="3381033">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381041">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381044">return</span>&nbsp;<span class="ident" id="3381051">err</span><br>
<span class="lineno"></span><span class="op" id="3381055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3381058">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3381125">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3381155">func</span>&nbsp;<span class="op" id="3381160">(</span><span class="ident" id="3381161">p</span>&nbsp;<span class="op" id="3381163">*</span><span class="ident" id="3381164">Part</span><span class="op" id="3381168">)</span>&nbsp;<span class="ident" id="3381170">Read</span><span class="op" id="3381174">(</span><span class="ident" id="3381175">d</span>&nbsp;<span class="op" id="3381177">[</span><span class="op" id="3381178">]</span><span class="builtintype" id="3381179">byte</span><span class="op" id="3381183">)</span>&nbsp;<span class="op" id="3381185">(</span><span class="ident" id="3381186">n</span>&nbsp;<span class="builtintype" id="3381188">int</span><span class="op" id="3381191">,</span>&nbsp;<span class="ident" id="3381193">err</span>&nbsp;<span class="builtintype" id="3381197">error</span><span class="op" id="3381202">)</span>&nbsp;<span class="op" id="3381204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381207">return</span>&nbsp;<span class="ident" id="3381214">p</span><span class="op" id="3381215">.</span><span class="ident" id="3381216">r</span><span class="op" id="3381217">.</span><span class="ident" id="3381218">Read</span><span class="op" id="3381222">(</span><span class="ident" id="3381223">d</span><span class="op" id="3381224">)</span><br>
<span class="lineno"></span><span class="op" id="3381226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3381229">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3381303">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3381367">type</span>&nbsp;<span class="ident" id="3381372">partReader</span>&nbsp;<span class="keyword" id="3381383">struct</span>&nbsp;<span class="op" id="3381390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381393">p</span>&nbsp;<span class="op" id="3381395">*</span><span class="ident" id="3381396">Part</span><br>
<span class="lineno"></span><span class="op" id="3381401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3381404">func</span>&nbsp;<span class="op" id="3381409">(</span><span class="ident" id="3381410">pr</span>&nbsp;<span class="ident" id="3381413">partReader</span><span class="op" id="3381423">)</span>&nbsp;<span class="ident" id="3381425">Read</span><span class="op" id="3381429">(</span><span class="ident" id="3381430">d</span>&nbsp;<span class="op" id="3381432">[</span><span class="op" id="3381433">]</span><span class="builtintype" id="3381434">byte</span><span class="op" id="3381438">)</span>&nbsp;<span class="op" id="3381440">(</span><span class="ident" id="3381441">n</span>&nbsp;<span class="builtintype" id="3381443">int</span><span class="op" id="3381446">,</span>&nbsp;<span class="ident" id="3381448">err</span>&nbsp;<span class="builtintype" id="3381452">error</span><span class="op" id="3381457">)</span>&nbsp;<span class="op" id="3381459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381462">p</span>&nbsp;<span class="op" id="3381464">:=</span>&nbsp;<span class="ident" id="3381467">pr</span><span class="op" id="3381469">.</span><span class="ident" id="3381470">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381473">defer</span>&nbsp;<span class="keyword" id="3381479">func</span><span class="op" id="3381483">(</span><span class="op" id="3381484">)</span>&nbsp;<span class="op" id="3381486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381490">p</span><span class="op" id="3381491">.</span><span class="ident" id="3381492">bytesRead</span>&nbsp;<span class="op" id="3381502">+=</span>&nbsp;<span class="ident" id="3381505">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381508">}</span><span class="op" id="3381509">(</span><span class="op" id="3381510">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381513">if</span>&nbsp;<span class="ident" id="3381516">p</span><span class="op" id="3381517">.</span><span class="ident" id="3381518">buffer</span><span class="op" id="3381524">.</span><span class="ident" id="3381525">Len</span><span class="op" id="3381528">(</span><span class="op" id="3381529">)</span>&nbsp;<span class="op" id="3381531">&gt;=</span>&nbsp;<span class="builtinfunc" id="3381534">len</span><span class="op" id="3381537">(</span><span class="ident" id="3381538">d</span><span class="op" id="3381539">)</span>&nbsp;<span class="op" id="3381541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381545">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381605">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381666">return</span>&nbsp;<span class="ident" id="3381673">p</span><span class="op" id="3381674">.</span><span class="ident" id="3381675">buffer</span><span class="op" id="3381681">.</span><span class="ident" id="3381682">Read</span><span class="op" id="3381686">(</span><span class="ident" id="3381687">d</span><span class="op" id="3381688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381691">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381694">peek</span><span class="op" id="3381698">,</span>&nbsp;<span class="ident" id="3381700">err</span>&nbsp;<span class="op" id="3381704">:=</span>&nbsp;<span class="ident" id="3381707">p</span><span class="op" id="3381708">.</span><span class="ident" id="3381709">mr</span><span class="op" id="3381711">.</span><span class="ident" id="3381712">bufReader</span><span class="op" id="3381721">.</span><span class="ident" id="3381722">Peek</span><span class="op" id="3381726">(</span><span class="num" id="3381727">4096</span><span class="op" id="3381731">)</span>&nbsp;<span class="comment" id="3381733">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381779">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381839">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381902">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3381962">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382022">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382047">if</span>&nbsp;<span class="ident" id="3382050">p</span><span class="op" id="3382051">.</span><span class="ident" id="3382052">bytesRead</span>&nbsp;<span class="op" id="3382062">==</span>&nbsp;<span class="num" id="3382065">0</span>&nbsp;<span class="op" id="3382067">&amp;&amp;</span>&nbsp;<span class="ident" id="3382070">p</span><span class="op" id="3382071">.</span><span class="ident" id="3382072">mr</span><span class="op" id="3382074">.</span><span class="ident" id="3382075">peekBufferIsEmptyPart</span><span class="op" id="3382096">(</span><span class="ident" id="3382097">peek</span><span class="op" id="3382101">)</span>&nbsp;<span class="op" id="3382103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382107">return</span>&nbsp;<span class="num" id="3382114">0</span><span class="op" id="3382115">,</span>&nbsp;<span class="ident" id="3382117">io</span><span class="op" id="3382119">.</span><span class="ident" id="3382120">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382125">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382128">unexpectedEOF</span>&nbsp;<span class="op" id="3382142">:=</span>&nbsp;<span class="ident" id="3382145">err</span>&nbsp;<span class="op" id="3382149">==</span>&nbsp;<span class="ident" id="3382152">io</span><span class="op" id="3382154">.</span><span class="ident" id="3382155">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382160">if</span>&nbsp;<span class="ident" id="3382163">err</span>&nbsp;<span class="op" id="3382167">!=</span>&nbsp;<span class="ident" id="3382170">nil</span>&nbsp;<span class="op" id="3382174">&amp;&amp;</span>&nbsp;<span class="op" id="3382177">!</span><span class="ident" id="3382178">unexpectedEOF</span>&nbsp;<span class="op" id="3382192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382196">return</span>&nbsp;<span class="num" id="3382203">0</span><span class="op" id="3382204">,</span>&nbsp;<span class="ident" id="3382206">fmt</span><span class="op" id="3382209">.</span><span class="ident" id="3382210">Errorf</span><span class="op" id="3382216">(</span><span class="string" id="3382217">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3382243">,</span>&nbsp;<span class="ident" id="3382245">err</span><span class="op" id="3382248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382254">if</span>&nbsp;<span class="ident" id="3382257">peek</span>&nbsp;<span class="op" id="3382262">==</span>&nbsp;<span class="ident" id="3382265">nil</span>&nbsp;<span class="op" id="3382269">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3382273">panic</span><span class="op" id="3382278">(</span><span class="string" id="3382279">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3382293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382300">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382359">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382423">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382482">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382494">nCopy</span>&nbsp;<span class="op" id="3382500">:=</span>&nbsp;<span class="num" id="3382503">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382506">foundBoundary</span>&nbsp;<span class="op" id="3382520">:=</span>&nbsp;<span class="builtintype" id="3382523">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382530">if</span>&nbsp;<span class="ident" id="3382533">idx</span>&nbsp;<span class="op" id="3382537">:=</span>&nbsp;<span class="ident" id="3382540">bytes</span><span class="op" id="3382545">.</span><span class="ident" id="3382546">Index</span><span class="op" id="3382551">(</span><span class="ident" id="3382552">peek</span><span class="op" id="3382556">,</span>&nbsp;<span class="ident" id="3382558">p</span><span class="op" id="3382559">.</span><span class="ident" id="3382560">mr</span><span class="op" id="3382562">.</span><span class="ident" id="3382563">nlDashBoundary</span><span class="op" id="3382577">)</span><span class="op" id="3382578">;</span>&nbsp;<span class="ident" id="3382580">idx</span>&nbsp;<span class="op" id="3382584">!=</span>&nbsp;<span class="op" id="3382587">-</span><span class="num" id="3382588">1</span>&nbsp;<span class="op" id="3382590">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382594">nCopy</span>&nbsp;<span class="op" id="3382600">=</span>&nbsp;<span class="ident" id="3382602">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382608">foundBoundary</span>&nbsp;<span class="op" id="3382622">=</span>&nbsp;<span class="builtintype" id="3382624">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382630">}</span>&nbsp;<span class="keyword" id="3382632">else</span>&nbsp;<span class="keyword" id="3382637">if</span>&nbsp;<span class="ident" id="3382640">safeCount</span>&nbsp;<span class="op" id="3382650">:=</span>&nbsp;<span class="builtinfunc" id="3382653">len</span><span class="op" id="3382656">(</span><span class="ident" id="3382657">peek</span><span class="op" id="3382661">)</span>&nbsp;<span class="op" id="3382663">-</span>&nbsp;<span class="builtinfunc" id="3382665">len</span><span class="op" id="3382668">(</span><span class="ident" id="3382669">p</span><span class="op" id="3382670">.</span><span class="ident" id="3382671">mr</span><span class="op" id="3382673">.</span><span class="ident" id="3382674">nlDashBoundary</span><span class="op" id="3382688">)</span><span class="op" id="3382689">;</span>&nbsp;<span class="ident" id="3382691">safeCount</span>&nbsp;<span class="op" id="3382701">&gt;</span>&nbsp;<span class="num" id="3382703">0</span>&nbsp;<span class="op" id="3382705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382709">nCopy</span>&nbsp;<span class="op" id="3382715">=</span>&nbsp;<span class="ident" id="3382717">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382728">}</span>&nbsp;<span class="keyword" id="3382730">else</span>&nbsp;<span class="keyword" id="3382735">if</span>&nbsp;<span class="ident" id="3382738">unexpectedEOF</span>&nbsp;<span class="op" id="3382752">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382756">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382810">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382867">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382910">return</span>&nbsp;<span class="num" id="3382917">0</span><span class="op" id="3382918">,</span>&nbsp;<span class="ident" id="3382920">io</span><span class="op" id="3382922">.</span><span class="ident" id="3382923">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382941">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382944">if</span>&nbsp;<span class="ident" id="3382947">nCopy</span>&nbsp;<span class="op" id="3382953">&gt;</span>&nbsp;<span class="num" id="3382955">0</span>&nbsp;<span class="op" id="3382957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382961">if</span>&nbsp;<span class="ident" id="3382964">_</span><span class="op" id="3382965">,</span>&nbsp;<span class="ident" id="3382967">err</span>&nbsp;<span class="op" id="3382971">:=</span>&nbsp;<span class="ident" id="3382974">io</span><span class="op" id="3382976">.</span><span class="ident" id="3382977">CopyN</span><span class="op" id="3382982">(</span><span class="ident" id="3382983">p</span><span class="op" id="3382984">.</span><span class="ident" id="3382985">buffer</span><span class="op" id="3382991">,</span>&nbsp;<span class="ident" id="3382993">p</span><span class="op" id="3382994">.</span><span class="ident" id="3382995">mr</span><span class="op" id="3382997">.</span><span class="ident" id="3382998">bufReader</span><span class="op" id="3383007">,</span>&nbsp;<span class="ident" id="3383009">int64</span><span class="op" id="3383014">(</span><span class="ident" id="3383015">nCopy</span><span class="op" id="3383020">)</span><span class="op" id="3383021">)</span><span class="op" id="3383022">;</span>&nbsp;<span class="ident" id="3383024">err</span>&nbsp;<span class="op" id="3383028">!=</span>&nbsp;<span class="ident" id="3383031">nil</span>&nbsp;<span class="op" id="3383035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383040">return</span>&nbsp;<span class="num" id="3383047">0</span><span class="op" id="3383048">,</span>&nbsp;<span class="ident" id="3383050">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383059">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383062">n</span><span class="op" id="3383063">,</span>&nbsp;<span class="ident" id="3383065">err</span>&nbsp;<span class="op" id="3383069">=</span>&nbsp;<span class="ident" id="3383071">p</span><span class="op" id="3383072">.</span><span class="ident" id="3383073">buffer</span><span class="op" id="3383079">.</span><span class="ident" id="3383080">Read</span><span class="op" id="3383084">(</span><span class="ident" id="3383085">d</span><span class="op" id="3383086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383089">if</span>&nbsp;<span class="ident" id="3383092">err</span>&nbsp;<span class="op" id="3383096">==</span>&nbsp;<span class="ident" id="3383099">io</span><span class="op" id="3383101">.</span><span class="ident" id="3383102">EOF</span>&nbsp;<span class="op" id="3383106">&amp;&amp;</span>&nbsp;<span class="op" id="3383109">!</span><span class="ident" id="3383110">foundBoundary</span>&nbsp;<span class="op" id="3383124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383128">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383185">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383241">err</span>&nbsp;<span class="op" id="3383245">=</span>&nbsp;<span class="ident" id="3383247">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383255">return</span><br>
<span class="lineno"></span><span class="op" id="3383262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3383265">func</span>&nbsp;<span class="op" id="3383270">(</span><span class="ident" id="3383271">p</span>&nbsp;<span class="op" id="3383273">*</span><span class="ident" id="3383274">Part</span><span class="op" id="3383278">)</span>&nbsp;<span class="ident" id="3383280">Close</span><span class="op" id="3383285">(</span><span class="op" id="3383286">)</span>&nbsp;<span class="builtintype" id="3383288">error</span>&nbsp;<span class="op" id="3383294">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383297">io</span><span class="op" id="3383299">.</span><span class="ident" id="3383300">Copy</span><span class="op" id="3383304">(</span><span class="ident" id="3383305">ioutil</span><span class="op" id="3383311">.</span><span class="ident" id="3383312">Discard</span><span class="op" id="3383319">,</span>&nbsp;<span class="ident" id="3383321">p</span><span class="op" id="3383322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383325">return</span>&nbsp;<span class="ident" id="3383332">nil</span><br>
<span class="lineno"></span><span class="op" id="3383336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3383339">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3383401">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3383470">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3383490">type</span>&nbsp;<span class="ident" id="3383495">Reader</span>&nbsp;<span class="keyword" id="3383502">struct</span>&nbsp;<span class="op" id="3383509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383512">bufReader</span>&nbsp;<span class="op" id="3383522">*</span><span class="ident" id="3383523">bufio</span><span class="op" id="3383528">.</span><span class="ident" id="3383529">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383538">currentPart</span>&nbsp;<span class="op" id="3383550">*</span><span class="ident" id="3383551">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383557">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3383569">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383575">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3383592">[</span><span class="op" id="3383593">]</span><span class="builtintype" id="3383594">byte</span>&nbsp;<span class="comment" id="3383599">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383657">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3383674">[</span><span class="op" id="3383675">]</span><span class="builtintype" id="3383676">byte</span>&nbsp;<span class="comment" id="3383681">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383703">dashBoundaryDash</span>&nbsp;<span class="op" id="3383720">[</span><span class="op" id="3383721">]</span><span class="builtintype" id="3383722">byte</span>&nbsp;<span class="comment" id="3383727">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383746">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3383763">[</span><span class="op" id="3383764">]</span><span class="builtintype" id="3383765">byte</span>&nbsp;<span class="comment" id="3383770">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3383786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3383789">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3383853">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3383916">func</span>&nbsp;<span class="op" id="3383921">(</span><span class="ident" id="3383922">r</span>&nbsp;<span class="op" id="3383924">*</span><span class="ident" id="3383925">Reader</span><span class="op" id="3383931">)</span>&nbsp;<span class="ident" id="3383933">NextPart</span><span class="op" id="3383941">(</span><span class="op" id="3383942">)</span>&nbsp;<span class="op" id="3383944">(</span><span class="op" id="3383945">*</span><span class="ident" id="3383946">Part</span><span class="op" id="3383950">,</span>&nbsp;<span class="builtintype" id="3383952">error</span><span class="op" id="3383957">)</span>&nbsp;<span class="op" id="3383959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383962">if</span>&nbsp;<span class="ident" id="3383965">r</span><span class="op" id="3383966">.</span><span class="ident" id="3383967">currentPart</span>&nbsp;<span class="op" id="3383979">!=</span>&nbsp;<span class="ident" id="3383982">nil</span>&nbsp;<span class="op" id="3383986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383990">r</span><span class="op" id="3383991">.</span><span class="ident" id="3383992">currentPart</span><span class="op" id="3384003">.</span><span class="ident" id="3384004">Close</span><span class="op" id="3384009">(</span><span class="op" id="3384010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384013">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384017">expectNewPart</span>&nbsp;<span class="op" id="3384031">:=</span>&nbsp;<span class="builtintype" id="3384034">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384041">for</span>&nbsp;<span class="op" id="3384045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384049">line</span><span class="op" id="3384053">,</span>&nbsp;<span class="ident" id="3384055">err</span>&nbsp;<span class="op" id="3384059">:=</span>&nbsp;<span class="ident" id="3384062">r</span><span class="op" id="3384063">.</span><span class="ident" id="3384064">bufReader</span><span class="op" id="3384073">.</span><span class="ident" id="3384074">ReadSlice</span><span class="op" id="3384083">(</span><span class="string" id="3384084">&#39;\n&#39;</span><span class="op" id="3384088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384092">if</span>&nbsp;<span class="ident" id="3384095">err</span>&nbsp;<span class="op" id="3384099">==</span>&nbsp;<span class="ident" id="3384102">io</span><span class="op" id="3384104">.</span><span class="ident" id="3384105">EOF</span>&nbsp;<span class="op" id="3384109">&amp;&amp;</span>&nbsp;<span class="ident" id="3384112">r</span><span class="op" id="3384113">.</span><span class="ident" id="3384114">isFinalBoundary</span><span class="op" id="3384129">(</span><span class="ident" id="3384130">line</span><span class="op" id="3384134">)</span>&nbsp;<span class="op" id="3384136">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384141">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384196">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384250">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384307">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384366">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384391">return</span>&nbsp;<span class="ident" id="3384398">nil</span><span class="op" id="3384401">,</span>&nbsp;<span class="ident" id="3384403">io</span><span class="op" id="3384405">.</span><span class="ident" id="3384406">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384416">if</span>&nbsp;<span class="ident" id="3384419">err</span>&nbsp;<span class="op" id="3384423">!=</span>&nbsp;<span class="ident" id="3384426">nil</span>&nbsp;<span class="op" id="3384430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384435">return</span>&nbsp;<span class="ident" id="3384442">nil</span><span class="op" id="3384445">,</span>&nbsp;<span class="ident" id="3384447">fmt</span><span class="op" id="3384450">.</span><span class="ident" id="3384451">Errorf</span><span class="op" id="3384457">(</span><span class="string" id="3384458">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3384483">,</span>&nbsp;<span class="ident" id="3384485">err</span><span class="op" id="3384488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384492">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384497">if</span>&nbsp;<span class="ident" id="3384500">r</span><span class="op" id="3384501">.</span><span class="ident" id="3384502">isBoundaryDelimiterLine</span><span class="op" id="3384525">(</span><span class="ident" id="3384526">line</span><span class="op" id="3384530">)</span>&nbsp;<span class="op" id="3384532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384537">r</span><span class="op" id="3384538">.</span><span class="ident" id="3384539">partsRead</span><span class="op" id="3384548">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384554">bp</span><span class="op" id="3384556">,</span>&nbsp;<span class="ident" id="3384558">err</span>&nbsp;<span class="op" id="3384562">:=</span>&nbsp;<span class="ident" id="3384565">newPart</span><span class="op" id="3384572">(</span><span class="ident" id="3384573">r</span><span class="op" id="3384574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384579">if</span>&nbsp;<span class="ident" id="3384582">err</span>&nbsp;<span class="op" id="3384586">!=</span>&nbsp;<span class="ident" id="3384589">nil</span>&nbsp;<span class="op" id="3384593">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384599">return</span>&nbsp;<span class="ident" id="3384606">nil</span><span class="op" id="3384609">,</span>&nbsp;<span class="ident" id="3384611">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384623">r</span><span class="op" id="3384624">.</span><span class="ident" id="3384625">currentPart</span>&nbsp;<span class="op" id="3384637">=</span>&nbsp;<span class="ident" id="3384639">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384645">return</span>&nbsp;<span class="ident" id="3384652">bp</span><span class="op" id="3384654">,</span>&nbsp;<span class="ident" id="3384656">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384662">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384667">if</span>&nbsp;<span class="ident" id="3384670">r</span><span class="op" id="3384671">.</span><span class="ident" id="3384672">isFinalBoundary</span><span class="op" id="3384687">(</span><span class="ident" id="3384688">line</span><span class="op" id="3384692">)</span>&nbsp;<span class="op" id="3384694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384699">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384718">return</span>&nbsp;<span class="ident" id="3384725">nil</span><span class="op" id="3384728">,</span>&nbsp;<span class="ident" id="3384730">io</span><span class="op" id="3384732">.</span><span class="ident" id="3384733">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384739">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384744">if</span>&nbsp;<span class="ident" id="3384747">expectNewPart</span>&nbsp;<span class="op" id="3384761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384766">return</span>&nbsp;<span class="ident" id="3384773">nil</span><span class="op" id="3384776">,</span>&nbsp;<span class="ident" id="3384778">fmt</span><span class="op" id="3384781">.</span><span class="ident" id="3384782">Errorf</span><span class="op" id="3384788">(</span><span class="string" id="3384789">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3384835">,</span>&nbsp;<span class="builtintype" id="3384837">string</span><span class="op" id="3384843">(</span><span class="ident" id="3384844">line</span><span class="op" id="3384848">)</span><span class="op" id="3384849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384858">if</span>&nbsp;<span class="ident" id="3384861">r</span><span class="op" id="3384862">.</span><span class="ident" id="3384863">partsRead</span>&nbsp;<span class="op" id="3384873">==</span>&nbsp;<span class="num" id="3384876">0</span>&nbsp;<span class="op" id="3384878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384883">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384899">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384915">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384969">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385025">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385080">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385099">if</span>&nbsp;<span class="ident" id="3385102">bytes</span><span class="op" id="3385107">.</span><span class="ident" id="3385108">Equal</span><span class="op" id="3385113">(</span><span class="ident" id="3385114">line</span><span class="op" id="3385118">,</span>&nbsp;<span class="ident" id="3385120">r</span><span class="op" id="3385121">.</span><span class="ident" id="3385122">nl</span><span class="op" id="3385124">)</span>&nbsp;<span class="op" id="3385126">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385131">expectNewPart</span>&nbsp;<span class="op" id="3385145">=</span>&nbsp;<span class="builtintype" id="3385147">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385155">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385171">return</span>&nbsp;<span class="ident" id="3385178">nil</span><span class="op" id="3385181">,</span>&nbsp;<span class="ident" id="3385183">fmt</span><span class="op" id="3385186">.</span><span class="ident" id="3385187">Errorf</span><span class="op" id="3385193">(</span><span class="string" id="3385194">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3385236">,</span>&nbsp;<span class="ident" id="3385238">line</span><span class="op" id="3385242">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385245">}</span><br>
<span class="lineno"></span><span class="op" id="3385247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3385250">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3385317">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3385356">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3385400">func</span>&nbsp;<span class="op" id="3385405">(</span><span class="ident" id="3385406">mr</span>&nbsp;<span class="op" id="3385409">*</span><span class="ident" id="3385410">Reader</span><span class="op" id="3385416">)</span>&nbsp;<span class="ident" id="3385418">isFinalBoundary</span><span class="op" id="3385433">(</span><span class="ident" id="3385434">line</span>&nbsp;<span class="op" id="3385439">[</span><span class="op" id="3385440">]</span><span class="builtintype" id="3385441">byte</span><span class="op" id="3385445">)</span>&nbsp;<span class="builtintype" id="3385447">bool</span>&nbsp;<span class="op" id="3385452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385455">if</span>&nbsp;<span class="op" id="3385458">!</span><span class="ident" id="3385459">bytes</span><span class="op" id="3385464">.</span><span class="ident" id="3385465">HasPrefix</span><span class="op" id="3385474">(</span><span class="ident" id="3385475">line</span><span class="op" id="3385479">,</span>&nbsp;<span class="ident" id="3385481">mr</span><span class="op" id="3385483">.</span><span class="ident" id="3385484">dashBoundaryDash</span><span class="op" id="3385500">)</span>&nbsp;<span class="op" id="3385502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385506">return</span>&nbsp;<span class="builtintype" id="3385513">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385520">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385523">rest</span>&nbsp;<span class="op" id="3385528">:=</span>&nbsp;<span class="ident" id="3385531">line</span><span class="op" id="3385535">[</span><span class="builtinfunc" id="3385536">len</span><span class="op" id="3385539">(</span><span class="ident" id="3385540">mr</span><span class="op" id="3385542">.</span><span class="ident" id="3385543">dashBoundaryDash</span><span class="op" id="3385559">)</span><span class="op" id="3385560">:</span><span class="op" id="3385561">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385564">rest</span>&nbsp;<span class="op" id="3385569">=</span>&nbsp;<span class="ident" id="3385571">skipLWSPChar</span><span class="op" id="3385583">(</span><span class="ident" id="3385584">rest</span><span class="op" id="3385588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385591">return</span>&nbsp;<span class="builtinfunc" id="3385598">len</span><span class="op" id="3385601">(</span><span class="ident" id="3385602">rest</span><span class="op" id="3385606">)</span>&nbsp;<span class="op" id="3385608">==</span>&nbsp;<span class="num" id="3385611">0</span>&nbsp;<span class="op" id="3385613">||</span>&nbsp;<span class="ident" id="3385616">bytes</span><span class="op" id="3385621">.</span><span class="ident" id="3385622">Equal</span><span class="op" id="3385627">(</span><span class="ident" id="3385628">rest</span><span class="op" id="3385632">,</span>&nbsp;<span class="ident" id="3385634">mr</span><span class="op" id="3385636">.</span><span class="ident" id="3385637">nl</span><span class="op" id="3385639">)</span><br>
<span class="lineno"></span><span class="op" id="3385641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3385644">func</span>&nbsp;<span class="op" id="3385649">(</span><span class="ident" id="3385650">mr</span>&nbsp;<span class="op" id="3385653">*</span><span class="ident" id="3385654">Reader</span><span class="op" id="3385660">)</span>&nbsp;<span class="ident" id="3385662">isBoundaryDelimiterLine</span><span class="op" id="3385685">(</span><span class="ident" id="3385686">line</span>&nbsp;<span class="op" id="3385691">[</span><span class="op" id="3385692">]</span><span class="builtintype" id="3385693">byte</span><span class="op" id="3385697">)</span>&nbsp;<span class="op" id="3385699">(</span><span class="ident" id="3385700">ret</span>&nbsp;<span class="builtintype" id="3385704">bool</span><span class="op" id="3385708">)</span>&nbsp;<span class="op" id="3385710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385713">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385764">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385824">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385881">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385940">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386004">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386046">if</span>&nbsp;<span class="op" id="3386049">!</span><span class="ident" id="3386050">bytes</span><span class="op" id="3386055">.</span><span class="ident" id="3386056">HasPrefix</span><span class="op" id="3386065">(</span><span class="ident" id="3386066">line</span><span class="op" id="3386070">,</span>&nbsp;<span class="ident" id="3386072">mr</span><span class="op" id="3386074">.</span><span class="ident" id="3386075">dashBoundary</span><span class="op" id="3386087">)</span>&nbsp;<span class="op" id="3386089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386093">return</span>&nbsp;<span class="builtintype" id="3386100">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386107">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386110">rest</span>&nbsp;<span class="op" id="3386115">:=</span>&nbsp;<span class="ident" id="3386118">line</span><span class="op" id="3386122">[</span><span class="builtinfunc" id="3386123">len</span><span class="op" id="3386126">(</span><span class="ident" id="3386127">mr</span><span class="op" id="3386129">.</span><span class="ident" id="3386130">dashBoundary</span><span class="op" id="3386142">)</span><span class="op" id="3386143">:</span><span class="op" id="3386144">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386147">rest</span>&nbsp;<span class="op" id="3386152">=</span>&nbsp;<span class="ident" id="3386154">skipLWSPChar</span><span class="op" id="3386166">(</span><span class="ident" id="3386167">rest</span><span class="op" id="3386171">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386175">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386245">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386316">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386344">if</span>&nbsp;<span class="ident" id="3386347">mr</span><span class="op" id="3386349">.</span><span class="ident" id="3386350">partsRead</span>&nbsp;<span class="op" id="3386360">==</span>&nbsp;<span class="num" id="3386363">0</span>&nbsp;<span class="op" id="3386365">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3386368">len</span><span class="op" id="3386371">(</span><span class="ident" id="3386372">rest</span><span class="op" id="3386376">)</span>&nbsp;<span class="op" id="3386378">==</span>&nbsp;<span class="num" id="3386381">1</span>&nbsp;<span class="op" id="3386383">&amp;&amp;</span>&nbsp;<span class="ident" id="3386386">rest</span><span class="op" id="3386390">[</span><span class="num" id="3386391">0</span><span class="op" id="3386392">]</span>&nbsp;<span class="op" id="3386394">==</span>&nbsp;<span class="string" id="3386397">&#39;\n&#39;</span>&nbsp;<span class="op" id="3386402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386406">mr</span><span class="op" id="3386408">.</span><span class="ident" id="3386409">nl</span>&nbsp;<span class="op" id="3386412">=</span>&nbsp;<span class="ident" id="3386414">mr</span><span class="op" id="3386416">.</span><span class="ident" id="3386417">nl</span><span class="op" id="3386419">[</span><span class="num" id="3386420">1</span><span class="op" id="3386421">:</span><span class="op" id="3386422">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386426">mr</span><span class="op" id="3386428">.</span><span class="ident" id="3386429">nlDashBoundary</span>&nbsp;<span class="op" id="3386444">=</span>&nbsp;<span class="ident" id="3386446">mr</span><span class="op" id="3386448">.</span><span class="ident" id="3386449">nlDashBoundary</span><span class="op" id="3386463">[</span><span class="num" id="3386464">1</span><span class="op" id="3386465">:</span><span class="op" id="3386466">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386469">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386472">return</span>&nbsp;<span class="ident" id="3386479">bytes</span><span class="op" id="3386484">.</span><span class="ident" id="3386485">Equal</span><span class="op" id="3386490">(</span><span class="ident" id="3386491">rest</span><span class="op" id="3386495">,</span>&nbsp;<span class="ident" id="3386497">mr</span><span class="op" id="3386499">.</span><span class="ident" id="3386500">nl</span><span class="op" id="3386502">)</span><br>
<span class="lineno"></span><span class="op" id="3386504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3386507">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3386572">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3386639">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3386710">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3386775">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3386787">//</span><br>
<span class="lineno"></span><span class="comment" id="3386790">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3386860">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3386928">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3386996">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3387040">func</span>&nbsp;<span class="op" id="3387045">(</span><span class="ident" id="3387046">mr</span>&nbsp;<span class="op" id="3387049">*</span><span class="ident" id="3387050">Reader</span><span class="op" id="3387056">)</span>&nbsp;<span class="ident" id="3387058">peekBufferIsEmptyPart</span><span class="op" id="3387079">(</span><span class="ident" id="3387080">peek</span>&nbsp;<span class="op" id="3387085">[</span><span class="op" id="3387086">]</span><span class="builtintype" id="3387087">byte</span><span class="op" id="3387091">)</span>&nbsp;<span class="builtintype" id="3387093">bool</span>&nbsp;<span class="op" id="3387098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3387101">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3387124">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387186">if</span>&nbsp;<span class="ident" id="3387189">bytes</span><span class="op" id="3387194">.</span><span class="ident" id="3387195">HasPrefix</span><span class="op" id="3387204">(</span><span class="ident" id="3387205">peek</span><span class="op" id="3387209">,</span>&nbsp;<span class="ident" id="3387211">mr</span><span class="op" id="3387213">.</span><span class="ident" id="3387214">dashBoundaryDash</span><span class="op" id="3387230">)</span>&nbsp;<span class="op" id="3387232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387236">rest</span>&nbsp;<span class="op" id="3387241">:=</span>&nbsp;<span class="ident" id="3387244">peek</span><span class="op" id="3387248">[</span><span class="builtinfunc" id="3387249">len</span><span class="op" id="3387252">(</span><span class="ident" id="3387253">mr</span><span class="op" id="3387255">.</span><span class="ident" id="3387256">dashBoundaryDash</span><span class="op" id="3387272">)</span><span class="op" id="3387273">:</span><span class="op" id="3387274">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387278">rest</span>&nbsp;<span class="op" id="3387283">=</span>&nbsp;<span class="ident" id="3387285">skipLWSPChar</span><span class="op" id="3387297">(</span><span class="ident" id="3387298">rest</span><span class="op" id="3387302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387306">return</span>&nbsp;<span class="ident" id="3387313">bytes</span><span class="op" id="3387318">.</span><span class="ident" id="3387319">HasPrefix</span><span class="op" id="3387328">(</span><span class="ident" id="3387329">rest</span><span class="op" id="3387333">,</span>&nbsp;<span class="ident" id="3387335">mr</span><span class="op" id="3387337">.</span><span class="ident" id="3387338">nl</span><span class="op" id="3387340">)</span>&nbsp;<span class="op" id="3387342">||</span>&nbsp;<span class="builtinfunc" id="3387345">len</span><span class="op" id="3387348">(</span><span class="ident" id="3387349">rest</span><span class="op" id="3387353">)</span>&nbsp;<span class="op" id="3387355">==</span>&nbsp;<span class="num" id="3387358">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387364">if</span>&nbsp;<span class="op" id="3387367">!</span><span class="ident" id="3387368">bytes</span><span class="op" id="3387373">.</span><span class="ident" id="3387374">HasPrefix</span><span class="op" id="3387383">(</span><span class="ident" id="3387384">peek</span><span class="op" id="3387388">,</span>&nbsp;<span class="ident" id="3387390">mr</span><span class="op" id="3387392">.</span><span class="ident" id="3387393">dashBoundary</span><span class="op" id="3387405">)</span>&nbsp;<span class="op" id="3387407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387411">return</span>&nbsp;<span class="builtintype" id="3387418">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3387428">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387473">rest</span>&nbsp;<span class="op" id="3387478">:=</span>&nbsp;<span class="ident" id="3387481">peek</span><span class="op" id="3387485">[</span><span class="builtinfunc" id="3387486">len</span><span class="op" id="3387489">(</span><span class="ident" id="3387490">mr</span><span class="op" id="3387492">.</span><span class="ident" id="3387493">dashBoundary</span><span class="op" id="3387505">)</span><span class="op" id="3387506">:</span><span class="op" id="3387507">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387510">rest</span>&nbsp;<span class="op" id="3387515">=</span>&nbsp;<span class="ident" id="3387517">skipLWSPChar</span><span class="op" id="3387529">(</span><span class="ident" id="3387530">rest</span><span class="op" id="3387534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387537">return</span>&nbsp;<span class="ident" id="3387544">bytes</span><span class="op" id="3387549">.</span><span class="ident" id="3387550">HasPrefix</span><span class="op" id="3387559">(</span><span class="ident" id="3387560">rest</span><span class="op" id="3387564">,</span>&nbsp;<span class="ident" id="3387566">mr</span><span class="op" id="3387568">.</span><span class="ident" id="3387569">nl</span><span class="op" id="3387571">)</span><br>
<span class="lineno"></span><span class="op" id="3387573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3387576">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3387640">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3387660">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3387691">func</span>&nbsp;<span class="ident" id="3387696">skipLWSPChar</span><span class="op" id="3387708">(</span><span class="ident" id="3387709">b</span>&nbsp;<span class="op" id="3387711">[</span><span class="op" id="3387712">]</span><span class="builtintype" id="3387713">byte</span><span class="op" id="3387717">)</span>&nbsp;<span class="op" id="3387719">[</span><span class="op" id="3387720">]</span><span class="builtintype" id="3387721">byte</span>&nbsp;<span class="op" id="3387726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387729">for</span>&nbsp;<span class="builtinfunc" id="3387733">len</span><span class="op" id="3387736">(</span><span class="ident" id="3387737">b</span><span class="op" id="3387738">)</span>&nbsp;<span class="op" id="3387740">&gt;</span>&nbsp;<span class="num" id="3387742">0</span>&nbsp;<span class="op" id="3387744">&amp;&amp;</span>&nbsp;<span class="op" id="3387747">(</span><span class="ident" id="3387748">b</span><span class="op" id="3387749">[</span><span class="num" id="3387750">0</span><span class="op" id="3387751">]</span>&nbsp;<span class="op" id="3387753">==</span>&nbsp;<span class="string" id="3387756">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3387760">||</span>&nbsp;<span class="ident" id="3387763">b</span><span class="op" id="3387764">[</span><span class="num" id="3387765">0</span><span class="op" id="3387766">]</span>&nbsp;<span class="op" id="3387768">==</span>&nbsp;<span class="string" id="3387771">&#39;\t&#39;</span><span class="op" id="3387775">)</span>&nbsp;<span class="op" id="3387777">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387781">b</span>&nbsp;<span class="op" id="3387783">=</span>&nbsp;<span class="ident" id="3387785">b</span><span class="op" id="3387786">[</span><span class="num" id="3387787">1</span><span class="op" id="3387788">:</span><span class="op" id="3387789">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387795">return</span>&nbsp;<span class="ident" id="3387802">b</span><br>
<span class="lineno"></span><span class="op" id="3387804">}</span>
</div>
</body>
</html>
