<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5970710">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5970765">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5970819">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5970870">package</span>&nbsp;<span class="ident" id="5970878">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5970883">import</span>&nbsp;<span class="op" id="5970890">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970893">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970902">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970919">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970933">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970942">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970957">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970963">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5970973">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5970976">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5971019">type</span>&nbsp;<span class="ident" id="5971024">Encoder</span>&nbsp;<span class="keyword" id="5971032">struct</span>&nbsp;<span class="op" id="5971039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971042">CompressionLevel</span>&nbsp;<span class="ident" id="5971059">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5971076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971079">type</span>&nbsp;<span class="ident" id="5971084">encoder</span>&nbsp;<span class="keyword" id="5971092">struct</span>&nbsp;<span class="op" id="5971099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971102">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971109">*</span><span class="ident" id="5971110">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971119">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971126">io</span><span class="op" id="5971128">.</span><span class="ident" id="5971129">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971137">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971144">image</span><span class="op" id="5971149">.</span><span class="ident" id="5971150">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971157">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5971164">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971169">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5971176">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971183">header</span>&nbsp;<span class="op" id="5971190">[</span><span class="num" id="5971191">8</span><span class="op" id="5971192">]</span><span class="builtintype" id="5971193">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971199">footer</span>&nbsp;<span class="op" id="5971206">[</span><span class="num" id="5971207">4</span><span class="op" id="5971208">]</span><span class="builtintype" id="5971209">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971215">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971222">[</span><span class="num" id="5971223">4</span>&nbsp;<span class="op" id="5971225">*</span>&nbsp;<span class="num" id="5971227">256</span><span class="op" id="5971230">]</span><span class="builtintype" id="5971231">byte</span><br>
<span class="lineno"></span><span class="op" id="5971236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971239">type</span>&nbsp;<span class="ident" id="5971244">CompressionLevel</span>&nbsp;<span class="builtintype" id="5971261">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5971266">const</span>&nbsp;<span class="op" id="5971272">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971275">DefaultCompression</span>&nbsp;<span class="ident" id="5971294">CompressionLevel</span>&nbsp;<span class="op" id="5971311">=</span>&nbsp;<span class="num" id="5971313">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971316">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971335">CompressionLevel</span>&nbsp;<span class="op" id="5971352">=</span>&nbsp;<span class="op" id="5971354">-</span><span class="num" id="5971355">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971358">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971377">CompressionLevel</span>&nbsp;<span class="op" id="5971394">=</span>&nbsp;<span class="op" id="5971396">-</span><span class="num" id="5971397">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971400">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971419">CompressionLevel</span>&nbsp;<span class="op" id="5971436">=</span>&nbsp;<span class="op" id="5971438">-</span><span class="num" id="5971439">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5971443">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5971516">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5971576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5971579">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5971594">func</span>&nbsp;<span class="ident" id="5971599">writeUint32</span><span class="op" id="5971610">(</span><span class="ident" id="5971611">b</span>&nbsp;<span class="op" id="5971613">[</span><span class="op" id="5971614">]</span><span class="builtintype" id="5971615">uint8</span><span class="op" id="5971620">,</span>&nbsp;<span class="ident" id="5971622">u</span>&nbsp;<span class="builtintype" id="5971624">uint32</span><span class="op" id="5971630">)</span>&nbsp;<span class="op" id="5971632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971635">b</span><span class="op" id="5971636">[</span><span class="num" id="5971637">0</span><span class="op" id="5971638">]</span>&nbsp;<span class="op" id="5971640">=</span>&nbsp;<span class="builtintype" id="5971642">uint8</span><span class="op" id="5971647">(</span><span class="ident" id="5971648">u</span>&nbsp;<span class="op" id="5971650">&gt;&gt;</span>&nbsp;<span class="num" id="5971653">24</span><span class="op" id="5971655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971658">b</span><span class="op" id="5971659">[</span><span class="num" id="5971660">1</span><span class="op" id="5971661">]</span>&nbsp;<span class="op" id="5971663">=</span>&nbsp;<span class="builtintype" id="5971665">uint8</span><span class="op" id="5971670">(</span><span class="ident" id="5971671">u</span>&nbsp;<span class="op" id="5971673">&gt;&gt;</span>&nbsp;<span class="num" id="5971676">16</span><span class="op" id="5971678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971681">b</span><span class="op" id="5971682">[</span><span class="num" id="5971683">2</span><span class="op" id="5971684">]</span>&nbsp;<span class="op" id="5971686">=</span>&nbsp;<span class="builtintype" id="5971688">uint8</span><span class="op" id="5971693">(</span><span class="ident" id="5971694">u</span>&nbsp;<span class="op" id="5971696">&gt;&gt;</span>&nbsp;<span class="num" id="5971699">8</span><span class="op" id="5971700">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971703">b</span><span class="op" id="5971704">[</span><span class="num" id="5971705">3</span><span class="op" id="5971706">]</span>&nbsp;<span class="op" id="5971708">=</span>&nbsp;<span class="builtintype" id="5971710">uint8</span><span class="op" id="5971715">(</span><span class="ident" id="5971716">u</span>&nbsp;<span class="op" id="5971718">&gt;&gt;</span>&nbsp;<span class="num" id="5971721">0</span><span class="op" id="5971722">)</span><br>
<span class="lineno"></span><span class="op" id="5971724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971727">type</span>&nbsp;<span class="ident" id="5971732">opaquer</span>&nbsp;<span class="keyword" id="5971740">interface</span>&nbsp;<span class="op" id="5971750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971753">Opaque</span><span class="op" id="5971759">(</span><span class="op" id="5971760">)</span>&nbsp;<span class="builtintype" id="5971762">bool</span><br>
<span class="lineno">55</span><span class="op" id="5971767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5971770">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5971823">func</span>&nbsp;<span class="ident" id="5971828">opaque</span><span class="op" id="5971834">(</span><span class="ident" id="5971835">m</span>&nbsp;<span class="ident" id="5971837">image</span><span class="op" id="5971842">.</span><span class="ident" id="5971843">Image</span><span class="op" id="5971848">)</span>&nbsp;<span class="builtintype" id="5971850">bool</span>&nbsp;<span class="op" id="5971855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971858">if</span>&nbsp;<span class="ident" id="5971861">o</span><span class="op" id="5971862">,</span>&nbsp;<span class="ident" id="5971864">ok</span>&nbsp;<span class="op" id="5971867">:=</span>&nbsp;<span class="ident" id="5971870">m</span><span class="op" id="5971871">.</span><span class="op" id="5971872">(</span><span class="ident" id="5971873">opaquer</span><span class="op" id="5971880">)</span><span class="op" id="5971881">;</span>&nbsp;<span class="ident" id="5971883">ok</span>&nbsp;<span class="op" id="5971886">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971890">return</span>&nbsp;<span class="ident" id="5971897">o</span><span class="op" id="5971898">.</span><span class="ident" id="5971899">Opaque</span><span class="op" id="5971905">(</span><span class="op" id="5971906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5971909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971912">b</span>&nbsp;<span class="op" id="5971914">:=</span>&nbsp;<span class="ident" id="5971917">m</span><span class="op" id="5971918">.</span><span class="ident" id="5971919">Bounds</span><span class="op" id="5971925">(</span><span class="op" id="5971926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971929">for</span>&nbsp;<span class="ident" id="5971933">y</span>&nbsp;<span class="op" id="5971935">:=</span>&nbsp;<span class="ident" id="5971938">b</span><span class="op" id="5971939">.</span><span class="ident" id="5971940">Min</span><span class="op" id="5971943">.</span><span class="ident" id="5971944">Y</span><span class="op" id="5971945">;</span>&nbsp;<span class="ident" id="5971947">y</span>&nbsp;<span class="op" id="5971949">&lt;</span>&nbsp;<span class="ident" id="5971951">b</span><span class="op" id="5971952">.</span><span class="ident" id="5971953">Max</span><span class="op" id="5971956">.</span><span class="ident" id="5971957">Y</span><span class="op" id="5971958">;</span>&nbsp;<span class="ident" id="5971960">y</span><span class="op" id="5971961">++</span>&nbsp;<span class="op" id="5971964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971968">for</span>&nbsp;<span class="ident" id="5971972">x</span>&nbsp;<span class="op" id="5971974">:=</span>&nbsp;<span class="ident" id="5971977">b</span><span class="op" id="5971978">.</span><span class="ident" id="5971979">Min</span><span class="op" id="5971982">.</span><span class="ident" id="5971983">X</span><span class="op" id="5971984">;</span>&nbsp;<span class="ident" id="5971986">x</span>&nbsp;<span class="op" id="5971988">&lt;</span>&nbsp;<span class="ident" id="5971990">b</span><span class="op" id="5971991">.</span><span class="ident" id="5971992">Max</span><span class="op" id="5971995">.</span><span class="ident" id="5971996">X</span><span class="op" id="5971997">;</span>&nbsp;<span class="ident" id="5971999">x</span><span class="op" id="5972000">++</span>&nbsp;<span class="op" id="5972003">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972008">_</span><span class="op" id="5972009">,</span>&nbsp;<span class="ident" id="5972011">_</span><span class="op" id="5972012">,</span>&nbsp;<span class="ident" id="5972014">_</span><span class="op" id="5972015">,</span>&nbsp;<span class="ident" id="5972017">a</span>&nbsp;<span class="op" id="5972019">:=</span>&nbsp;<span class="ident" id="5972022">m</span><span class="op" id="5972023">.</span><span class="ident" id="5972024">At</span><span class="op" id="5972026">(</span><span class="ident" id="5972027">x</span><span class="op" id="5972028">,</span>&nbsp;<span class="ident" id="5972030">y</span><span class="op" id="5972031">)</span><span class="op" id="5972032">.</span><span class="ident" id="5972033">RGBA</span><span class="op" id="5972037">(</span><span class="op" id="5972038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972043">if</span>&nbsp;<span class="ident" id="5972046">a</span>&nbsp;<span class="op" id="5972048">!=</span>&nbsp;<span class="num" id="5972051">0xffff</span>&nbsp;<span class="op" id="5972058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972064">return</span>&nbsp;<span class="builtintype" id="5972071">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972084">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972090">return</span>&nbsp;<span class="builtintype" id="5972097">true</span><br>
<span class="lineno"></span><span class="op" id="5972102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5972105">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5972167">func</span>&nbsp;<span class="ident" id="5972172">abs8</span><span class="op" id="5972176">(</span><span class="ident" id="5972177">d</span>&nbsp;<span class="builtintype" id="5972179">uint8</span><span class="op" id="5972184">)</span>&nbsp;<span class="builtintype" id="5972186">int</span>&nbsp;<span class="op" id="5972190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972193">if</span>&nbsp;<span class="ident" id="5972196">d</span>&nbsp;<span class="op" id="5972198">&lt;</span>&nbsp;<span class="num" id="5972200">128</span>&nbsp;<span class="op" id="5972204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972208">return</span>&nbsp;<span class="builtintype" id="5972215">int</span><span class="op" id="5972218">(</span><span class="ident" id="5972219">d</span><span class="op" id="5972220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972226">return</span>&nbsp;<span class="num" id="5972233">256</span>&nbsp;<span class="op" id="5972237">-</span>&nbsp;<span class="builtintype" id="5972239">int</span><span class="op" id="5972242">(</span><span class="ident" id="5972243">d</span><span class="op" id="5972244">)</span><br>
<span class="lineno">80</span><span class="op" id="5972246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5972249">func</span>&nbsp;<span class="op" id="5972254">(</span><span class="ident" id="5972255">e</span>&nbsp;<span class="op" id="5972257">*</span><span class="ident" id="5972258">encoder</span><span class="op" id="5972265">)</span>&nbsp;<span class="ident" id="5972267">writeChunk</span><span class="op" id="5972277">(</span><span class="ident" id="5972278">b</span>&nbsp;<span class="op" id="5972280">[</span><span class="op" id="5972281">]</span><span class="builtintype" id="5972282">byte</span><span class="op" id="5972286">,</span>&nbsp;<span class="ident" id="5972288">name</span>&nbsp;<span class="builtintype" id="5972293">string</span><span class="op" id="5972299">)</span>&nbsp;<span class="op" id="5972301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972304">if</span>&nbsp;<span class="ident" id="5972307">e</span><span class="op" id="5972308">.</span><span class="ident" id="5972309">err</span>&nbsp;<span class="op" id="5972313">!=</span>&nbsp;<span class="ident" id="5972316">nil</span>&nbsp;<span class="op" id="5972320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972324">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972335">n</span>&nbsp;<span class="op" id="5972337">:=</span>&nbsp;<span class="builtintype" id="5972340">uint32</span><span class="op" id="5972346">(</span><span class="builtinfunc" id="5972347">len</span><span class="op" id="5972350">(</span><span class="ident" id="5972351">b</span><span class="op" id="5972352">)</span><span class="op" id="5972353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972356">if</span>&nbsp;<span class="builtintype" id="5972359">int</span><span class="op" id="5972362">(</span><span class="ident" id="5972363">n</span><span class="op" id="5972364">)</span>&nbsp;<span class="op" id="5972366">!=</span>&nbsp;<span class="builtinfunc" id="5972369">len</span><span class="op" id="5972372">(</span><span class="ident" id="5972373">b</span><span class="op" id="5972374">)</span>&nbsp;<span class="op" id="5972376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972380">e</span><span class="op" id="5972381">.</span><span class="ident" id="5972382">err</span>&nbsp;<span class="op" id="5972386">=</span>&nbsp;<span class="ident" id="5972388">UnsupportedError</span><span class="op" id="5972404">(</span><span class="ident" id="5972405">name</span>&nbsp;<span class="op" id="5972410">+</span>&nbsp;<span class="string" id="5972412">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5972436">+</span>&nbsp;<span class="ident" id="5972438">strconv</span><span class="op" id="5972445">.</span><span class="ident" id="5972446">Itoa</span><span class="op" id="5972450">(</span><span class="builtinfunc" id="5972451">len</span><span class="op" id="5972454">(</span><span class="ident" id="5972455">b</span><span class="op" id="5972456">)</span><span class="op" id="5972457">)</span><span class="op" id="5972458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972462">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972473">writeUint32</span><span class="op" id="5972484">(</span><span class="ident" id="5972485">e</span><span class="op" id="5972486">.</span><span class="ident" id="5972487">header</span><span class="op" id="5972493">[</span><span class="op" id="5972494">:</span><span class="num" id="5972495">4</span><span class="op" id="5972496">]</span><span class="op" id="5972497">,</span>&nbsp;<span class="ident" id="5972499">n</span><span class="op" id="5972500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972503">e</span><span class="op" id="5972504">.</span><span class="ident" id="5972505">header</span><span class="op" id="5972511">[</span><span class="num" id="5972512">4</span><span class="op" id="5972513">]</span>&nbsp;<span class="op" id="5972515">=</span>&nbsp;<span class="ident" id="5972517">name</span><span class="op" id="5972521">[</span><span class="num" id="5972522">0</span><span class="op" id="5972523">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972526">e</span><span class="op" id="5972527">.</span><span class="ident" id="5972528">header</span><span class="op" id="5972534">[</span><span class="num" id="5972535">5</span><span class="op" id="5972536">]</span>&nbsp;<span class="op" id="5972538">=</span>&nbsp;<span class="ident" id="5972540">name</span><span class="op" id="5972544">[</span><span class="num" id="5972545">1</span><span class="op" id="5972546">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972549">e</span><span class="op" id="5972550">.</span><span class="ident" id="5972551">header</span><span class="op" id="5972557">[</span><span class="num" id="5972558">6</span><span class="op" id="5972559">]</span>&nbsp;<span class="op" id="5972561">=</span>&nbsp;<span class="ident" id="5972563">name</span><span class="op" id="5972567">[</span><span class="num" id="5972568">2</span><span class="op" id="5972569">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972572">e</span><span class="op" id="5972573">.</span><span class="ident" id="5972574">header</span><span class="op" id="5972580">[</span><span class="num" id="5972581">7</span><span class="op" id="5972582">]</span>&nbsp;<span class="op" id="5972584">=</span>&nbsp;<span class="ident" id="5972586">name</span><span class="op" id="5972590">[</span><span class="num" id="5972591">3</span><span class="op" id="5972592">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972595">crc</span>&nbsp;<span class="op" id="5972599">:=</span>&nbsp;<span class="ident" id="5972602">crc32</span><span class="op" id="5972607">.</span><span class="ident" id="5972608">NewIEEE</span><span class="op" id="5972615">(</span><span class="op" id="5972616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972619">crc</span><span class="op" id="5972622">.</span><span class="ident" id="5972623">Write</span><span class="op" id="5972628">(</span><span class="ident" id="5972629">e</span><span class="op" id="5972630">.</span><span class="ident" id="5972631">header</span><span class="op" id="5972637">[</span><span class="num" id="5972638">4</span><span class="op" id="5972639">:</span><span class="num" id="5972640">8</span><span class="op" id="5972641">]</span><span class="op" id="5972642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972645">crc</span><span class="op" id="5972648">.</span><span class="ident" id="5972649">Write</span><span class="op" id="5972654">(</span><span class="ident" id="5972655">b</span><span class="op" id="5972656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972659">writeUint32</span><span class="op" id="5972670">(</span><span class="ident" id="5972671">e</span><span class="op" id="5972672">.</span><span class="ident" id="5972673">footer</span><span class="op" id="5972679">[</span><span class="op" id="5972680">:</span><span class="num" id="5972681">4</span><span class="op" id="5972682">]</span><span class="op" id="5972683">,</span>&nbsp;<span class="ident" id="5972685">crc</span><span class="op" id="5972688">.</span><span class="ident" id="5972689">Sum32</span><span class="op" id="5972694">(</span><span class="op" id="5972695">)</span><span class="op" id="5972696">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972700">_</span><span class="op" id="5972701">,</span>&nbsp;<span class="ident" id="5972703">e</span><span class="op" id="5972704">.</span><span class="ident" id="5972705">err</span>&nbsp;<span class="op" id="5972709">=</span>&nbsp;<span class="ident" id="5972711">e</span><span class="op" id="5972712">.</span><span class="ident" id="5972713">w</span><span class="op" id="5972714">.</span><span class="ident" id="5972715">Write</span><span class="op" id="5972720">(</span><span class="ident" id="5972721">e</span><span class="op" id="5972722">.</span><span class="ident" id="5972723">header</span><span class="op" id="5972729">[</span><span class="op" id="5972730">:</span><span class="num" id="5972731">8</span><span class="op" id="5972732">]</span><span class="op" id="5972733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972736">if</span>&nbsp;<span class="ident" id="5972739">e</span><span class="op" id="5972740">.</span><span class="ident" id="5972741">err</span>&nbsp;<span class="op" id="5972745">!=</span>&nbsp;<span class="ident" id="5972748">nil</span>&nbsp;<span class="op" id="5972752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972756">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972764">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972767">_</span><span class="op" id="5972768">,</span>&nbsp;<span class="ident" id="5972770">e</span><span class="op" id="5972771">.</span><span class="ident" id="5972772">err</span>&nbsp;<span class="op" id="5972776">=</span>&nbsp;<span class="ident" id="5972778">e</span><span class="op" id="5972779">.</span><span class="ident" id="5972780">w</span><span class="op" id="5972781">.</span><span class="ident" id="5972782">Write</span><span class="op" id="5972787">(</span><span class="ident" id="5972788">b</span><span class="op" id="5972789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972792">if</span>&nbsp;<span class="ident" id="5972795">e</span><span class="op" id="5972796">.</span><span class="ident" id="5972797">err</span>&nbsp;<span class="op" id="5972801">!=</span>&nbsp;<span class="ident" id="5972804">nil</span>&nbsp;<span class="op" id="5972808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972812">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972823">_</span><span class="op" id="5972824">,</span>&nbsp;<span class="ident" id="5972826">e</span><span class="op" id="5972827">.</span><span class="ident" id="5972828">err</span>&nbsp;<span class="op" id="5972832">=</span>&nbsp;<span class="ident" id="5972834">e</span><span class="op" id="5972835">.</span><span class="ident" id="5972836">w</span><span class="op" id="5972837">.</span><span class="ident" id="5972838">Write</span><span class="op" id="5972843">(</span><span class="ident" id="5972844">e</span><span class="op" id="5972845">.</span><span class="ident" id="5972846">footer</span><span class="op" id="5972852">[</span><span class="op" id="5972853">:</span><span class="num" id="5972854">4</span><span class="op" id="5972855">]</span><span class="op" id="5972856">)</span><br>
<span class="lineno">110</span><span class="op" id="5972858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5972861">func</span>&nbsp;<span class="op" id="5972866">(</span><span class="ident" id="5972867">e</span>&nbsp;<span class="op" id="5972869">*</span><span class="ident" id="5972870">encoder</span><span class="op" id="5972877">)</span>&nbsp;<span class="ident" id="5972879">writeIHDR</span><span class="op" id="5972888">(</span><span class="op" id="5972889">)</span>&nbsp;<span class="op" id="5972891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972894">b</span>&nbsp;<span class="op" id="5972896">:=</span>&nbsp;<span class="ident" id="5972899">e</span><span class="op" id="5972900">.</span><span class="ident" id="5972901">m</span><span class="op" id="5972902">.</span><span class="ident" id="5972903">Bounds</span><span class="op" id="5972909">(</span><span class="op" id="5972910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972913">writeUint32</span><span class="op" id="5972924">(</span><span class="ident" id="5972925">e</span><span class="op" id="5972926">.</span><span class="ident" id="5972927">tmp</span><span class="op" id="5972930">[</span><span class="num" id="5972931">0</span><span class="op" id="5972932">:</span><span class="num" id="5972933">4</span><span class="op" id="5972934">]</span><span class="op" id="5972935">,</span>&nbsp;<span class="builtintype" id="5972937">uint32</span><span class="op" id="5972943">(</span><span class="ident" id="5972944">b</span><span class="op" id="5972945">.</span><span class="ident" id="5972946">Dx</span><span class="op" id="5972948">(</span><span class="op" id="5972949">)</span><span class="op" id="5972950">)</span><span class="op" id="5972951">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972954">writeUint32</span><span class="op" id="5972965">(</span><span class="ident" id="5972966">e</span><span class="op" id="5972967">.</span><span class="ident" id="5972968">tmp</span><span class="op" id="5972971">[</span><span class="num" id="5972972">4</span><span class="op" id="5972973">:</span><span class="num" id="5972974">8</span><span class="op" id="5972975">]</span><span class="op" id="5972976">,</span>&nbsp;<span class="builtintype" id="5972978">uint32</span><span class="op" id="5972984">(</span><span class="ident" id="5972985">b</span><span class="op" id="5972986">.</span><span class="ident" id="5972987">Dy</span><span class="op" id="5972989">(</span><span class="op" id="5972990">)</span><span class="op" id="5972991">)</span><span class="op" id="5972992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5972995">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973029">switch</span>&nbsp;<span class="ident" id="5973036">e</span><span class="op" id="5973037">.</span><span class="ident" id="5973038">cb</span>&nbsp;<span class="op" id="5973041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973044">case</span>&nbsp;<span class="ident" id="5973049">cbG8</span><span class="op" id="5973053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973057">e</span><span class="op" id="5973058">.</span><span class="ident" id="5973059">tmp</span><span class="op" id="5973062">[</span><span class="num" id="5973063">8</span><span class="op" id="5973064">]</span>&nbsp;<span class="op" id="5973066">=</span>&nbsp;<span class="num" id="5973068">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973072">e</span><span class="op" id="5973073">.</span><span class="ident" id="5973074">tmp</span><span class="op" id="5973077">[</span><span class="num" id="5973078">9</span><span class="op" id="5973079">]</span>&nbsp;<span class="op" id="5973081">=</span>&nbsp;<span class="ident" id="5973083">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973096">case</span>&nbsp;<span class="ident" id="5973101">cbTC8</span><span class="op" id="5973106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973110">e</span><span class="op" id="5973111">.</span><span class="ident" id="5973112">tmp</span><span class="op" id="5973115">[</span><span class="num" id="5973116">8</span><span class="op" id="5973117">]</span>&nbsp;<span class="op" id="5973119">=</span>&nbsp;<span class="num" id="5973121">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973125">e</span><span class="op" id="5973126">.</span><span class="ident" id="5973127">tmp</span><span class="op" id="5973130">[</span><span class="num" id="5973131">9</span><span class="op" id="5973132">]</span>&nbsp;<span class="op" id="5973134">=</span>&nbsp;<span class="ident" id="5973136">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973149">case</span>&nbsp;<span class="ident" id="5973154">cbP8</span><span class="op" id="5973158">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973162">e</span><span class="op" id="5973163">.</span><span class="ident" id="5973164">tmp</span><span class="op" id="5973167">[</span><span class="num" id="5973168">8</span><span class="op" id="5973169">]</span>&nbsp;<span class="op" id="5973171">=</span>&nbsp;<span class="num" id="5973173">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973177">e</span><span class="op" id="5973178">.</span><span class="ident" id="5973179">tmp</span><span class="op" id="5973182">[</span><span class="num" id="5973183">9</span><span class="op" id="5973184">]</span>&nbsp;<span class="op" id="5973186">=</span>&nbsp;<span class="ident" id="5973188">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973200">case</span>&nbsp;<span class="ident" id="5973205">cbTCA8</span><span class="op" id="5973211">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973215">e</span><span class="op" id="5973216">.</span><span class="ident" id="5973217">tmp</span><span class="op" id="5973220">[</span><span class="num" id="5973221">8</span><span class="op" id="5973222">]</span>&nbsp;<span class="op" id="5973224">=</span>&nbsp;<span class="num" id="5973226">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973230">e</span><span class="op" id="5973231">.</span><span class="ident" id="5973232">tmp</span><span class="op" id="5973235">[</span><span class="num" id="5973236">9</span><span class="op" id="5973237">]</span>&nbsp;<span class="op" id="5973239">=</span>&nbsp;<span class="ident" id="5973241">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973259">case</span>&nbsp;<span class="ident" id="5973264">cbG16</span><span class="op" id="5973269">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973273">e</span><span class="op" id="5973274">.</span><span class="ident" id="5973275">tmp</span><span class="op" id="5973278">[</span><span class="num" id="5973279">8</span><span class="op" id="5973280">]</span>&nbsp;<span class="op" id="5973282">=</span>&nbsp;<span class="num" id="5973284">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973289">e</span><span class="op" id="5973290">.</span><span class="ident" id="5973291">tmp</span><span class="op" id="5973294">[</span><span class="num" id="5973295">9</span><span class="op" id="5973296">]</span>&nbsp;<span class="op" id="5973298">=</span>&nbsp;<span class="ident" id="5973300">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973313">case</span>&nbsp;<span class="ident" id="5973318">cbTC16</span><span class="op" id="5973324">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973328">e</span><span class="op" id="5973329">.</span><span class="ident" id="5973330">tmp</span><span class="op" id="5973333">[</span><span class="num" id="5973334">8</span><span class="op" id="5973335">]</span>&nbsp;<span class="op" id="5973337">=</span>&nbsp;<span class="num" id="5973339">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973344">e</span><span class="op" id="5973345">.</span><span class="ident" id="5973346">tmp</span><span class="op" id="5973349">[</span><span class="num" id="5973350">9</span><span class="op" id="5973351">]</span>&nbsp;<span class="op" id="5973353">=</span>&nbsp;<span class="ident" id="5973355">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973368">case</span>&nbsp;<span class="ident" id="5973373">cbTCA16</span><span class="op" id="5973380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973384">e</span><span class="op" id="5973385">.</span><span class="ident" id="5973386">tmp</span><span class="op" id="5973389">[</span><span class="num" id="5973390">8</span><span class="op" id="5973391">]</span>&nbsp;<span class="op" id="5973393">=</span>&nbsp;<span class="num" id="5973395">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973400">e</span><span class="op" id="5973401">.</span><span class="ident" id="5973402">tmp</span><span class="op" id="5973405">[</span><span class="num" id="5973406">9</span><span class="op" id="5973407">]</span>&nbsp;<span class="op" id="5973409">=</span>&nbsp;<span class="ident" id="5973411">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973429">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973432">e</span><span class="op" id="5973433">.</span><span class="ident" id="5973434">tmp</span><span class="op" id="5973437">[</span><span class="num" id="5973438">10</span><span class="op" id="5973440">]</span>&nbsp;<span class="op" id="5973442">=</span>&nbsp;<span class="num" id="5973444">0</span>&nbsp;<span class="comment" id="5973446">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973477">e</span><span class="op" id="5973478">.</span><span class="ident" id="5973479">tmp</span><span class="op" id="5973482">[</span><span class="num" id="5973483">11</span><span class="op" id="5973485">]</span>&nbsp;<span class="op" id="5973487">=</span>&nbsp;<span class="num" id="5973489">0</span>&nbsp;<span class="comment" id="5973491">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973517">e</span><span class="op" id="5973518">.</span><span class="ident" id="5973519">tmp</span><span class="op" id="5973522">[</span><span class="num" id="5973523">12</span><span class="op" id="5973525">]</span>&nbsp;<span class="op" id="5973527">=</span>&nbsp;<span class="num" id="5973529">0</span>&nbsp;<span class="comment" id="5973531">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973550">e</span><span class="op" id="5973551">.</span><span class="ident" id="5973552">writeChunk</span><span class="op" id="5973562">(</span><span class="ident" id="5973563">e</span><span class="op" id="5973564">.</span><span class="ident" id="5973565">tmp</span><span class="op" id="5973568">[</span><span class="op" id="5973569">:</span><span class="num" id="5973570">13</span><span class="op" id="5973572">]</span><span class="op" id="5973573">,</span>&nbsp;<span class="string" id="5973575">&#34;IHDR&#34;</span><span class="op" id="5973581">)</span><br>
<span class="lineno"></span><span class="op" id="5973583">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5973586">func</span>&nbsp;<span class="op" id="5973591">(</span><span class="ident" id="5973592">e</span>&nbsp;<span class="op" id="5973594">*</span><span class="ident" id="5973595">encoder</span><span class="op" id="5973602">)</span>&nbsp;<span class="ident" id="5973604">writePLTEAndTRNS</span><span class="op" id="5973620">(</span><span class="ident" id="5973621">p</span>&nbsp;<span class="ident" id="5973623">color</span><span class="op" id="5973628">.</span><span class="ident" id="5973629">Palette</span><span class="op" id="5973636">)</span>&nbsp;<span class="op" id="5973638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973641">if</span>&nbsp;<span class="builtinfunc" id="5973644">len</span><span class="op" id="5973647">(</span><span class="ident" id="5973648">p</span><span class="op" id="5973649">)</span>&nbsp;<span class="op" id="5973651">&lt;</span>&nbsp;<span class="num" id="5973653">1</span>&nbsp;<span class="op" id="5973655">||</span>&nbsp;<span class="builtinfunc" id="5973658">len</span><span class="op" id="5973661">(</span><span class="ident" id="5973662">p</span><span class="op" id="5973663">)</span>&nbsp;<span class="op" id="5973665">&gt;</span>&nbsp;<span class="num" id="5973667">256</span>&nbsp;<span class="op" id="5973671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973675">e</span><span class="op" id="5973676">.</span><span class="ident" id="5973677">err</span>&nbsp;<span class="op" id="5973681">=</span>&nbsp;<span class="ident" id="5973683">FormatError</span><span class="op" id="5973694">(</span><span class="string" id="5973695">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5973718">+</span>&nbsp;<span class="ident" id="5973720">strconv</span><span class="op" id="5973727">.</span><span class="ident" id="5973728">Itoa</span><span class="op" id="5973732">(</span><span class="builtinfunc" id="5973733">len</span><span class="op" id="5973736">(</span><span class="ident" id="5973737">p</span><span class="op" id="5973738">)</span><span class="op" id="5973739">)</span><span class="op" id="5973740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973744">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973755">last</span>&nbsp;<span class="op" id="5973760">:=</span>&nbsp;<span class="op" id="5973763">-</span><span class="num" id="5973764">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973767">for</span>&nbsp;<span class="ident" id="5973771">i</span><span class="op" id="5973772">,</span>&nbsp;<span class="ident" id="5973774">c</span>&nbsp;<span class="op" id="5973776">:=</span>&nbsp;<span class="keyword" id="5973779">range</span>&nbsp;<span class="ident" id="5973785">p</span>&nbsp;<span class="op" id="5973787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973791">c1</span>&nbsp;<span class="op" id="5973794">:=</span>&nbsp;<span class="ident" id="5973797">color</span><span class="op" id="5973802">.</span><span class="ident" id="5973803">NRGBAModel</span><span class="op" id="5973813">.</span><span class="ident" id="5973814">Convert</span><span class="op" id="5973821">(</span><span class="ident" id="5973822">c</span><span class="op" id="5973823">)</span><span class="op" id="5973824">.</span><span class="op" id="5973825">(</span><span class="ident" id="5973826">color</span><span class="op" id="5973831">.</span><span class="ident" id="5973832">NRGBA</span><span class="op" id="5973837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973841">e</span><span class="op" id="5973842">.</span><span class="ident" id="5973843">tmp</span><span class="op" id="5973846">[</span><span class="num" id="5973847">3</span><span class="op" id="5973848">*</span><span class="ident" id="5973849">i</span><span class="op" id="5973850">+</span><span class="num" id="5973851">0</span><span class="op" id="5973852">]</span>&nbsp;<span class="op" id="5973854">=</span>&nbsp;<span class="ident" id="5973856">c1</span><span class="op" id="5973858">.</span><span class="ident" id="5973859">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973863">e</span><span class="op" id="5973864">.</span><span class="ident" id="5973865">tmp</span><span class="op" id="5973868">[</span><span class="num" id="5973869">3</span><span class="op" id="5973870">*</span><span class="ident" id="5973871">i</span><span class="op" id="5973872">+</span><span class="num" id="5973873">1</span><span class="op" id="5973874">]</span>&nbsp;<span class="op" id="5973876">=</span>&nbsp;<span class="ident" id="5973878">c1</span><span class="op" id="5973880">.</span><span class="ident" id="5973881">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973885">e</span><span class="op" id="5973886">.</span><span class="ident" id="5973887">tmp</span><span class="op" id="5973890">[</span><span class="num" id="5973891">3</span><span class="op" id="5973892">*</span><span class="ident" id="5973893">i</span><span class="op" id="5973894">+</span><span class="num" id="5973895">2</span><span class="op" id="5973896">]</span>&nbsp;<span class="op" id="5973898">=</span>&nbsp;<span class="ident" id="5973900">c1</span><span class="op" id="5973902">.</span><span class="ident" id="5973903">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973907">if</span>&nbsp;<span class="ident" id="5973910">c1</span><span class="op" id="5973912">.</span><span class="ident" id="5973913">A</span>&nbsp;<span class="op" id="5973915">!=</span>&nbsp;<span class="num" id="5973918">0xff</span>&nbsp;<span class="op" id="5973923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973928">last</span>&nbsp;<span class="op" id="5973933">=</span>&nbsp;<span class="ident" id="5973935">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973939">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973943">e</span><span class="op" id="5973944">.</span><span class="ident" id="5973945">tmp</span><span class="op" id="5973948">[</span><span class="num" id="5973949">3</span><span class="op" id="5973950">*</span><span class="num" id="5973951">256</span><span class="op" id="5973954">+</span><span class="ident" id="5973955">i</span><span class="op" id="5973956">]</span>&nbsp;<span class="op" id="5973958">=</span>&nbsp;<span class="ident" id="5973960">c1</span><span class="op" id="5973962">.</span><span class="ident" id="5973963">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973969">e</span><span class="op" id="5973970">.</span><span class="ident" id="5973971">writeChunk</span><span class="op" id="5973981">(</span><span class="ident" id="5973982">e</span><span class="op" id="5973983">.</span><span class="ident" id="5973984">tmp</span><span class="op" id="5973987">[</span><span class="op" id="5973988">:</span><span class="num" id="5973989">3</span><span class="op" id="5973990">*</span><span class="builtinfunc" id="5973991">len</span><span class="op" id="5973994">(</span><span class="ident" id="5973995">p</span><span class="op" id="5973996">)</span><span class="op" id="5973997">]</span><span class="op" id="5973998">,</span>&nbsp;<span class="string" id="5974000">&#34;PLTE&#34;</span><span class="op" id="5974006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974009">if</span>&nbsp;<span class="ident" id="5974012">last</span>&nbsp;<span class="op" id="5974017">!=</span>&nbsp;<span class="op" id="5974020">-</span><span class="num" id="5974021">1</span>&nbsp;<span class="op" id="5974023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974027">e</span><span class="op" id="5974028">.</span><span class="ident" id="5974029">writeChunk</span><span class="op" id="5974039">(</span><span class="ident" id="5974040">e</span><span class="op" id="5974041">.</span><span class="ident" id="5974042">tmp</span><span class="op" id="5974045">[</span><span class="num" id="5974046">3</span><span class="op" id="5974047">*</span><span class="num" id="5974048">256</span><span class="op" id="5974051">:</span><span class="num" id="5974052">3</span><span class="op" id="5974053">*</span><span class="num" id="5974054">256</span><span class="op" id="5974057">+</span><span class="num" id="5974058">1</span><span class="op" id="5974059">+</span><span class="ident" id="5974060">last</span><span class="op" id="5974064">]</span><span class="op" id="5974065">,</span>&nbsp;<span class="string" id="5974067">&#34;tRNS&#34;</span><span class="op" id="5974073">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974076">}</span><br>
<span class="lineno"></span><span class="op" id="5974078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5974081">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5974161">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5974242">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5974316">//</span><br>
<span class="lineno"></span><span class="comment" id="5974319">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5974390">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5974448">func</span>&nbsp;<span class="op" id="5974453">(</span><span class="ident" id="5974454">e</span>&nbsp;<span class="op" id="5974456">*</span><span class="ident" id="5974457">encoder</span><span class="op" id="5974464">)</span>&nbsp;<span class="ident" id="5974466">Write</span><span class="op" id="5974471">(</span><span class="ident" id="5974472">b</span>&nbsp;<span class="op" id="5974474">[</span><span class="op" id="5974475">]</span><span class="builtintype" id="5974476">byte</span><span class="op" id="5974480">)</span>&nbsp;<span class="op" id="5974482">(</span><span class="builtintype" id="5974483">int</span><span class="op" id="5974486">,</span>&nbsp;<span class="builtintype" id="5974488">error</span><span class="op" id="5974493">)</span>&nbsp;<span class="op" id="5974495">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974498">e</span><span class="op" id="5974499">.</span><span class="ident" id="5974500">writeChunk</span><span class="op" id="5974510">(</span><span class="ident" id="5974511">b</span><span class="op" id="5974512">,</span>&nbsp;<span class="string" id="5974514">&#34;IDAT&#34;</span><span class="op" id="5974520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974523">if</span>&nbsp;<span class="ident" id="5974526">e</span><span class="op" id="5974527">.</span><span class="ident" id="5974528">err</span>&nbsp;<span class="op" id="5974532">!=</span>&nbsp;<span class="ident" id="5974535">nil</span>&nbsp;<span class="op" id="5974539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974543">return</span>&nbsp;<span class="num" id="5974550">0</span><span class="op" id="5974551">,</span>&nbsp;<span class="ident" id="5974553">e</span><span class="op" id="5974554">.</span><span class="ident" id="5974555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974563">return</span>&nbsp;<span class="builtinfunc" id="5974570">len</span><span class="op" id="5974573">(</span><span class="ident" id="5974574">b</span><span class="op" id="5974575">)</span><span class="op" id="5974576">,</span>&nbsp;<span class="ident" id="5974578">nil</span><br>
<span class="lineno">180</span><span class="op" id="5974582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5974585">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5974660">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5974758">func</span>&nbsp;<span class="ident" id="5974763">filter</span><span class="op" id="5974769">(</span><span class="ident" id="5974770">cr</span>&nbsp;<span class="op" id="5974773">*</span><span class="op" id="5974774">[</span><span class="ident" id="5974775">nFilter</span><span class="op" id="5974782">]</span><span class="op" id="5974783">[</span><span class="op" id="5974784">]</span><span class="builtintype" id="5974785">byte</span><span class="op" id="5974789">,</span>&nbsp;<span class="ident" id="5974791">pr</span>&nbsp;<span class="op" id="5974794">[</span><span class="op" id="5974795">]</span><span class="builtintype" id="5974796">byte</span><span class="op" id="5974800">,</span>&nbsp;<span class="ident" id="5974802">bpp</span>&nbsp;<span class="builtintype" id="5974806">int</span><span class="op" id="5974809">)</span>&nbsp;<span class="builtintype" id="5974811">int</span>&nbsp;<span class="op" id="5974815">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5974818">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5974917">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5975013">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5975108">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975182">cdat0</span>&nbsp;<span class="op" id="5975188">:=</span>&nbsp;<span class="ident" id="5975191">cr</span><span class="op" id="5975193">[</span><span class="num" id="5975194">0</span><span class="op" id="5975195">]</span><span class="op" id="5975196">[</span><span class="num" id="5975197">1</span><span class="op" id="5975198">:</span><span class="op" id="5975199">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975202">cdat1</span>&nbsp;<span class="op" id="5975208">:=</span>&nbsp;<span class="ident" id="5975211">cr</span><span class="op" id="5975213">[</span><span class="num" id="5975214">1</span><span class="op" id="5975215">]</span><span class="op" id="5975216">[</span><span class="num" id="5975217">1</span><span class="op" id="5975218">:</span><span class="op" id="5975219">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975222">cdat2</span>&nbsp;<span class="op" id="5975228">:=</span>&nbsp;<span class="ident" id="5975231">cr</span><span class="op" id="5975233">[</span><span class="num" id="5975234">2</span><span class="op" id="5975235">]</span><span class="op" id="5975236">[</span><span class="num" id="5975237">1</span><span class="op" id="5975238">:</span><span class="op" id="5975239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975242">cdat3</span>&nbsp;<span class="op" id="5975248">:=</span>&nbsp;<span class="ident" id="5975251">cr</span><span class="op" id="5975253">[</span><span class="num" id="5975254">3</span><span class="op" id="5975255">]</span><span class="op" id="5975256">[</span><span class="num" id="5975257">1</span><span class="op" id="5975258">:</span><span class="op" id="5975259">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975262">cdat4</span>&nbsp;<span class="op" id="5975268">:=</span>&nbsp;<span class="ident" id="5975271">cr</span><span class="op" id="5975273">[</span><span class="num" id="5975274">4</span><span class="op" id="5975275">]</span><span class="op" id="5975276">[</span><span class="num" id="5975277">1</span><span class="op" id="5975278">:</span><span class="op" id="5975279">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975282">pdat</span>&nbsp;<span class="op" id="5975287">:=</span>&nbsp;<span class="ident" id="5975290">pr</span><span class="op" id="5975292">[</span><span class="num" id="5975293">1</span><span class="op" id="5975294">:</span><span class="op" id="5975295">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975298">n</span>&nbsp;<span class="op" id="5975300">:=</span>&nbsp;<span class="builtinfunc" id="5975303">len</span><span class="op" id="5975306">(</span><span class="ident" id="5975307">cdat0</span><span class="op" id="5975312">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5975316">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975335">sum</span>&nbsp;<span class="op" id="5975339">:=</span>&nbsp;<span class="num" id="5975342">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975345">for</span>&nbsp;<span class="ident" id="5975349">i</span>&nbsp;<span class="op" id="5975351">:=</span>&nbsp;<span class="num" id="5975354">0</span><span class="op" id="5975355">;</span>&nbsp;<span class="ident" id="5975357">i</span>&nbsp;<span class="op" id="5975359">&lt;</span>&nbsp;<span class="ident" id="5975361">n</span><span class="op" id="5975362">;</span>&nbsp;<span class="ident" id="5975364">i</span><span class="op" id="5975365">++</span>&nbsp;<span class="op" id="5975368">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975372">cdat2</span><span class="op" id="5975377">[</span><span class="ident" id="5975378">i</span><span class="op" id="5975379">]</span>&nbsp;<span class="op" id="5975381">=</span>&nbsp;<span class="ident" id="5975383">cdat0</span><span class="op" id="5975388">[</span><span class="ident" id="5975389">i</span><span class="op" id="5975390">]</span>&nbsp;<span class="op" id="5975392">-</span>&nbsp;<span class="ident" id="5975394">pdat</span><span class="op" id="5975398">[</span><span class="ident" id="5975399">i</span><span class="op" id="5975400">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975404">sum</span>&nbsp;<span class="op" id="5975408">+=</span>&nbsp;<span class="ident" id="5975411">abs8</span><span class="op" id="5975415">(</span><span class="ident" id="5975416">cdat2</span><span class="op" id="5975421">[</span><span class="ident" id="5975422">i</span><span class="op" id="5975423">]</span><span class="op" id="5975424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975430">best</span>&nbsp;<span class="op" id="5975435">:=</span>&nbsp;<span class="ident" id="5975438">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975443">filter</span>&nbsp;<span class="op" id="5975450">:=</span>&nbsp;<span class="ident" id="5975453">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5975460">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975482">sum</span>&nbsp;<span class="op" id="5975486">=</span>&nbsp;<span class="num" id="5975488">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975491">for</span>&nbsp;<span class="ident" id="5975495">i</span>&nbsp;<span class="op" id="5975497">:=</span>&nbsp;<span class="num" id="5975500">0</span><span class="op" id="5975501">;</span>&nbsp;<span class="ident" id="5975503">i</span>&nbsp;<span class="op" id="5975505">&lt;</span>&nbsp;<span class="ident" id="5975507">bpp</span><span class="op" id="5975510">;</span>&nbsp;<span class="ident" id="5975512">i</span><span class="op" id="5975513">++</span>&nbsp;<span class="op" id="5975516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975520">cdat4</span><span class="op" id="5975525">[</span><span class="ident" id="5975526">i</span><span class="op" id="5975527">]</span>&nbsp;<span class="op" id="5975529">=</span>&nbsp;<span class="ident" id="5975531">cdat0</span><span class="op" id="5975536">[</span><span class="ident" id="5975537">i</span><span class="op" id="5975538">]</span>&nbsp;<span class="op" id="5975540">-</span>&nbsp;<span class="ident" id="5975542">pdat</span><span class="op" id="5975546">[</span><span class="ident" id="5975547">i</span><span class="op" id="5975548">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975552">sum</span>&nbsp;<span class="op" id="5975556">+=</span>&nbsp;<span class="ident" id="5975559">abs8</span><span class="op" id="5975563">(</span><span class="ident" id="5975564">cdat4</span><span class="op" id="5975569">[</span><span class="ident" id="5975570">i</span><span class="op" id="5975571">]</span><span class="op" id="5975572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975578">for</span>&nbsp;<span class="ident" id="5975582">i</span>&nbsp;<span class="op" id="5975584">:=</span>&nbsp;<span class="ident" id="5975587">bpp</span><span class="op" id="5975590">;</span>&nbsp;<span class="ident" id="5975592">i</span>&nbsp;<span class="op" id="5975594">&lt;</span>&nbsp;<span class="ident" id="5975596">n</span><span class="op" id="5975597">;</span>&nbsp;<span class="ident" id="5975599">i</span><span class="op" id="5975600">++</span>&nbsp;<span class="op" id="5975603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975607">cdat4</span><span class="op" id="5975612">[</span><span class="ident" id="5975613">i</span><span class="op" id="5975614">]</span>&nbsp;<span class="op" id="5975616">=</span>&nbsp;<span class="ident" id="5975618">cdat0</span><span class="op" id="5975623">[</span><span class="ident" id="5975624">i</span><span class="op" id="5975625">]</span>&nbsp;<span class="op" id="5975627">-</span>&nbsp;<span class="ident" id="5975629">paeth</span><span class="op" id="5975634">(</span><span class="ident" id="5975635">cdat0</span><span class="op" id="5975640">[</span><span class="ident" id="5975641">i</span><span class="op" id="5975642">-</span><span class="ident" id="5975643">bpp</span><span class="op" id="5975646">]</span><span class="op" id="5975647">,</span>&nbsp;<span class="ident" id="5975649">pdat</span><span class="op" id="5975653">[</span><span class="ident" id="5975654">i</span><span class="op" id="5975655">]</span><span class="op" id="5975656">,</span>&nbsp;<span class="ident" id="5975658">pdat</span><span class="op" id="5975662">[</span><span class="ident" id="5975663">i</span><span class="op" id="5975664">-</span><span class="ident" id="5975665">bpp</span><span class="op" id="5975668">]</span><span class="op" id="5975669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975673">sum</span>&nbsp;<span class="op" id="5975677">+=</span>&nbsp;<span class="ident" id="5975680">abs8</span><span class="op" id="5975684">(</span><span class="ident" id="5975685">cdat4</span><span class="op" id="5975690">[</span><span class="ident" id="5975691">i</span><span class="op" id="5975692">]</span><span class="op" id="5975693">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975697">if</span>&nbsp;<span class="ident" id="5975700">sum</span>&nbsp;<span class="op" id="5975704">&gt;=</span>&nbsp;<span class="ident" id="5975707">best</span>&nbsp;<span class="op" id="5975712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975717">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975731">if</span>&nbsp;<span class="ident" id="5975734">sum</span>&nbsp;<span class="op" id="5975738">&lt;</span>&nbsp;<span class="ident" id="5975740">best</span>&nbsp;<span class="op" id="5975745">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975749">best</span>&nbsp;<span class="op" id="5975754">=</span>&nbsp;<span class="ident" id="5975756">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975762">filter</span>&nbsp;<span class="op" id="5975769">=</span>&nbsp;<span class="ident" id="5975771">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5975784">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975805">sum</span>&nbsp;<span class="op" id="5975809">=</span>&nbsp;<span class="num" id="5975811">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975814">for</span>&nbsp;<span class="ident" id="5975818">i</span>&nbsp;<span class="op" id="5975820">:=</span>&nbsp;<span class="num" id="5975823">0</span><span class="op" id="5975824">;</span>&nbsp;<span class="ident" id="5975826">i</span>&nbsp;<span class="op" id="5975828">&lt;</span>&nbsp;<span class="ident" id="5975830">n</span><span class="op" id="5975831">;</span>&nbsp;<span class="ident" id="5975833">i</span><span class="op" id="5975834">++</span>&nbsp;<span class="op" id="5975837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975841">sum</span>&nbsp;<span class="op" id="5975845">+=</span>&nbsp;<span class="ident" id="5975848">abs8</span><span class="op" id="5975852">(</span><span class="ident" id="5975853">cdat0</span><span class="op" id="5975858">[</span><span class="ident" id="5975859">i</span><span class="op" id="5975860">]</span><span class="op" id="5975861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975865">if</span>&nbsp;<span class="ident" id="5975868">sum</span>&nbsp;<span class="op" id="5975872">&gt;=</span>&nbsp;<span class="ident" id="5975875">best</span>&nbsp;<span class="op" id="5975880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975885">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975899">if</span>&nbsp;<span class="ident" id="5975902">sum</span>&nbsp;<span class="op" id="5975906">&lt;</span>&nbsp;<span class="ident" id="5975908">best</span>&nbsp;<span class="op" id="5975913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975917">best</span>&nbsp;<span class="op" id="5975922">=</span>&nbsp;<span class="ident" id="5975924">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975930">filter</span>&nbsp;<span class="op" id="5975937">=</span>&nbsp;<span class="ident" id="5975939">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5975951">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975971">sum</span>&nbsp;<span class="op" id="5975975">=</span>&nbsp;<span class="num" id="5975977">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975980">for</span>&nbsp;<span class="ident" id="5975984">i</span>&nbsp;<span class="op" id="5975986">:=</span>&nbsp;<span class="num" id="5975989">0</span><span class="op" id="5975990">;</span>&nbsp;<span class="ident" id="5975992">i</span>&nbsp;<span class="op" id="5975994">&lt;</span>&nbsp;<span class="ident" id="5975996">bpp</span><span class="op" id="5975999">;</span>&nbsp;<span class="ident" id="5976001">i</span><span class="op" id="5976002">++</span>&nbsp;<span class="op" id="5976005">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976009">cdat1</span><span class="op" id="5976014">[</span><span class="ident" id="5976015">i</span><span class="op" id="5976016">]</span>&nbsp;<span class="op" id="5976018">=</span>&nbsp;<span class="ident" id="5976020">cdat0</span><span class="op" id="5976025">[</span><span class="ident" id="5976026">i</span><span class="op" id="5976027">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976031">sum</span>&nbsp;<span class="op" id="5976035">+=</span>&nbsp;<span class="ident" id="5976038">abs8</span><span class="op" id="5976042">(</span><span class="ident" id="5976043">cdat1</span><span class="op" id="5976048">[</span><span class="ident" id="5976049">i</span><span class="op" id="5976050">]</span><span class="op" id="5976051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976057">for</span>&nbsp;<span class="ident" id="5976061">i</span>&nbsp;<span class="op" id="5976063">:=</span>&nbsp;<span class="ident" id="5976066">bpp</span><span class="op" id="5976069">;</span>&nbsp;<span class="ident" id="5976071">i</span>&nbsp;<span class="op" id="5976073">&lt;</span>&nbsp;<span class="ident" id="5976075">n</span><span class="op" id="5976076">;</span>&nbsp;<span class="ident" id="5976078">i</span><span class="op" id="5976079">++</span>&nbsp;<span class="op" id="5976082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976086">cdat1</span><span class="op" id="5976091">[</span><span class="ident" id="5976092">i</span><span class="op" id="5976093">]</span>&nbsp;<span class="op" id="5976095">=</span>&nbsp;<span class="ident" id="5976097">cdat0</span><span class="op" id="5976102">[</span><span class="ident" id="5976103">i</span><span class="op" id="5976104">]</span>&nbsp;<span class="op" id="5976106">-</span>&nbsp;<span class="ident" id="5976108">cdat0</span><span class="op" id="5976113">[</span><span class="ident" id="5976114">i</span><span class="op" id="5976115">-</span><span class="ident" id="5976116">bpp</span><span class="op" id="5976119">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976123">sum</span>&nbsp;<span class="op" id="5976127">+=</span>&nbsp;<span class="ident" id="5976130">abs8</span><span class="op" id="5976134">(</span><span class="ident" id="5976135">cdat1</span><span class="op" id="5976140">[</span><span class="ident" id="5976141">i</span><span class="op" id="5976142">]</span><span class="op" id="5976143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976147">if</span>&nbsp;<span class="ident" id="5976150">sum</span>&nbsp;<span class="op" id="5976154">&gt;=</span>&nbsp;<span class="ident" id="5976157">best</span>&nbsp;<span class="op" id="5976162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976167">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976178">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976181">if</span>&nbsp;<span class="ident" id="5976184">sum</span>&nbsp;<span class="op" id="5976188">&lt;</span>&nbsp;<span class="ident" id="5976190">best</span>&nbsp;<span class="op" id="5976195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976199">best</span>&nbsp;<span class="op" id="5976204">=</span>&nbsp;<span class="ident" id="5976206">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976212">filter</span>&nbsp;<span class="op" id="5976219">=</span>&nbsp;<span class="ident" id="5976221">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5976232">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976256">sum</span>&nbsp;<span class="op" id="5976260">=</span>&nbsp;<span class="num" id="5976262">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976265">for</span>&nbsp;<span class="ident" id="5976269">i</span>&nbsp;<span class="op" id="5976271">:=</span>&nbsp;<span class="num" id="5976274">0</span><span class="op" id="5976275">;</span>&nbsp;<span class="ident" id="5976277">i</span>&nbsp;<span class="op" id="5976279">&lt;</span>&nbsp;<span class="ident" id="5976281">bpp</span><span class="op" id="5976284">;</span>&nbsp;<span class="ident" id="5976286">i</span><span class="op" id="5976287">++</span>&nbsp;<span class="op" id="5976290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976294">cdat3</span><span class="op" id="5976299">[</span><span class="ident" id="5976300">i</span><span class="op" id="5976301">]</span>&nbsp;<span class="op" id="5976303">=</span>&nbsp;<span class="ident" id="5976305">cdat0</span><span class="op" id="5976310">[</span><span class="ident" id="5976311">i</span><span class="op" id="5976312">]</span>&nbsp;<span class="op" id="5976314">-</span>&nbsp;<span class="ident" id="5976316">pdat</span><span class="op" id="5976320">[</span><span class="ident" id="5976321">i</span><span class="op" id="5976322">]</span><span class="op" id="5976323">/</span><span class="num" id="5976324">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976328">sum</span>&nbsp;<span class="op" id="5976332">+=</span>&nbsp;<span class="ident" id="5976335">abs8</span><span class="op" id="5976339">(</span><span class="ident" id="5976340">cdat3</span><span class="op" id="5976345">[</span><span class="ident" id="5976346">i</span><span class="op" id="5976347">]</span><span class="op" id="5976348">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976354">for</span>&nbsp;<span class="ident" id="5976358">i</span>&nbsp;<span class="op" id="5976360">:=</span>&nbsp;<span class="ident" id="5976363">bpp</span><span class="op" id="5976366">;</span>&nbsp;<span class="ident" id="5976368">i</span>&nbsp;<span class="op" id="5976370">&lt;</span>&nbsp;<span class="ident" id="5976372">n</span><span class="op" id="5976373">;</span>&nbsp;<span class="ident" id="5976375">i</span><span class="op" id="5976376">++</span>&nbsp;<span class="op" id="5976379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976383">cdat3</span><span class="op" id="5976388">[</span><span class="ident" id="5976389">i</span><span class="op" id="5976390">]</span>&nbsp;<span class="op" id="5976392">=</span>&nbsp;<span class="ident" id="5976394">cdat0</span><span class="op" id="5976399">[</span><span class="ident" id="5976400">i</span><span class="op" id="5976401">]</span>&nbsp;<span class="op" id="5976403">-</span>&nbsp;<span class="builtintype" id="5976405">uint8</span><span class="op" id="5976410">(</span><span class="op" id="5976411">(</span><span class="builtintype" id="5976412">int</span><span class="op" id="5976415">(</span><span class="ident" id="5976416">cdat0</span><span class="op" id="5976421">[</span><span class="ident" id="5976422">i</span><span class="op" id="5976423">-</span><span class="ident" id="5976424">bpp</span><span class="op" id="5976427">]</span><span class="op" id="5976428">)</span><span class="op" id="5976429">+</span><span class="builtintype" id="5976430">int</span><span class="op" id="5976433">(</span><span class="ident" id="5976434">pdat</span><span class="op" id="5976438">[</span><span class="ident" id="5976439">i</span><span class="op" id="5976440">]</span><span class="op" id="5976441">)</span><span class="op" id="5976442">)</span><span class="op" id="5976443">/</span><span class="num" id="5976444">2</span><span class="op" id="5976445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976449">sum</span>&nbsp;<span class="op" id="5976453">+=</span>&nbsp;<span class="ident" id="5976456">abs8</span><span class="op" id="5976460">(</span><span class="ident" id="5976461">cdat3</span><span class="op" id="5976466">[</span><span class="ident" id="5976467">i</span><span class="op" id="5976468">]</span><span class="op" id="5976469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976473">if</span>&nbsp;<span class="ident" id="5976476">sum</span>&nbsp;<span class="op" id="5976480">&gt;=</span>&nbsp;<span class="ident" id="5976483">best</span>&nbsp;<span class="op" id="5976488">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976493">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976507">if</span>&nbsp;<span class="ident" id="5976510">sum</span>&nbsp;<span class="op" id="5976514">&lt;</span>&nbsp;<span class="ident" id="5976516">best</span>&nbsp;<span class="op" id="5976521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976525">best</span>&nbsp;<span class="op" id="5976530">=</span>&nbsp;<span class="ident" id="5976532">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976538">filter</span>&nbsp;<span class="op" id="5976545">=</span>&nbsp;<span class="ident" id="5976547">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976562">return</span>&nbsp;<span class="ident" id="5976569">filter</span><br>
<span class="lineno"></span><span class="op" id="5976576">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5976579">func</span>&nbsp;<span class="ident" id="5976584">writeImage</span><span class="op" id="5976594">(</span><span class="ident" id="5976595">w</span>&nbsp;<span class="ident" id="5976597">io</span><span class="op" id="5976599">.</span><span class="ident" id="5976600">Writer</span><span class="op" id="5976606">,</span>&nbsp;<span class="ident" id="5976608">m</span>&nbsp;<span class="ident" id="5976610">image</span><span class="op" id="5976615">.</span><span class="ident" id="5976616">Image</span><span class="op" id="5976621">,</span>&nbsp;<span class="ident" id="5976623">cb</span>&nbsp;<span class="builtintype" id="5976626">int</span><span class="op" id="5976629">,</span>&nbsp;<span class="ident" id="5976631">level</span>&nbsp;<span class="builtintype" id="5976637">int</span><span class="op" id="5976640">)</span>&nbsp;<span class="builtintype" id="5976642">error</span>&nbsp;<span class="op" id="5976648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976651">zw</span><span class="op" id="5976653">,</span>&nbsp;<span class="ident" id="5976655">err</span>&nbsp;<span class="op" id="5976659">:=</span>&nbsp;<span class="ident" id="5976662">zlib</span><span class="op" id="5976666">.</span><span class="ident" id="5976667">NewWriterLevel</span><span class="op" id="5976681">(</span><span class="ident" id="5976682">w</span><span class="op" id="5976683">,</span>&nbsp;<span class="ident" id="5976685">level</span><span class="op" id="5976690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976693">if</span>&nbsp;<span class="ident" id="5976696">err</span>&nbsp;<span class="op" id="5976700">!=</span>&nbsp;<span class="ident" id="5976703">nil</span>&nbsp;<span class="op" id="5976707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976711">return</span>&nbsp;<span class="ident" id="5976718">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976726">defer</span>&nbsp;<span class="ident" id="5976732">zw</span><span class="op" id="5976734">.</span><span class="ident" id="5976735">Close</span><span class="op" id="5976740">(</span><span class="op" id="5976741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976745">bpp</span>&nbsp;<span class="op" id="5976749">:=</span>&nbsp;<span class="num" id="5976752">0</span>&nbsp;<span class="comment" id="5976754">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976776">switch</span>&nbsp;<span class="ident" id="5976783">cb</span>&nbsp;<span class="op" id="5976786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976789">case</span>&nbsp;<span class="ident" id="5976794">cbG8</span><span class="op" id="5976798">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976802">bpp</span>&nbsp;<span class="op" id="5976806">=</span>&nbsp;<span class="num" id="5976808">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976811">case</span>&nbsp;<span class="ident" id="5976816">cbTC8</span><span class="op" id="5976821">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976825">bpp</span>&nbsp;<span class="op" id="5976829">=</span>&nbsp;<span class="num" id="5976831">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976834">case</span>&nbsp;<span class="ident" id="5976839">cbP8</span><span class="op" id="5976843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976847">bpp</span>&nbsp;<span class="op" id="5976851">=</span>&nbsp;<span class="num" id="5976853">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976856">case</span>&nbsp;<span class="ident" id="5976861">cbTCA8</span><span class="op" id="5976867">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976871">bpp</span>&nbsp;<span class="op" id="5976875">=</span>&nbsp;<span class="num" id="5976877">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976880">case</span>&nbsp;<span class="ident" id="5976885">cbTC16</span><span class="op" id="5976891">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976895">bpp</span>&nbsp;<span class="op" id="5976899">=</span>&nbsp;<span class="num" id="5976901">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976904">case</span>&nbsp;<span class="ident" id="5976909">cbTCA16</span><span class="op" id="5976916">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976920">bpp</span>&nbsp;<span class="op" id="5976924">=</span>&nbsp;<span class="num" id="5976926">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976929">case</span>&nbsp;<span class="ident" id="5976934">cbG16</span><span class="op" id="5976939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976943">bpp</span>&nbsp;<span class="op" id="5976947">=</span>&nbsp;<span class="num" id="5976949">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5976955">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5977020">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5977096">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5977183">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5977270">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977335">b</span>&nbsp;<span class="op" id="5977337">:=</span>&nbsp;<span class="ident" id="5977340">m</span><span class="op" id="5977341">.</span><span class="ident" id="5977342">Bounds</span><span class="op" id="5977348">(</span><span class="op" id="5977349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977352">var</span>&nbsp;<span class="ident" id="5977356">cr</span>&nbsp;<span class="op" id="5977359">[</span><span class="ident" id="5977360">nFilter</span><span class="op" id="5977367">]</span><span class="op" id="5977368">[</span><span class="op" id="5977369">]</span><span class="builtintype" id="5977370">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977377">for</span>&nbsp;<span class="ident" id="5977381">i</span>&nbsp;<span class="op" id="5977383">:=</span>&nbsp;<span class="keyword" id="5977386">range</span>&nbsp;<span class="ident" id="5977392">cr</span>&nbsp;<span class="op" id="5977395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977399">cr</span><span class="op" id="5977401">[</span><span class="ident" id="5977402">i</span><span class="op" id="5977403">]</span>&nbsp;<span class="op" id="5977405">=</span>&nbsp;<span class="builtinfunc" id="5977407">make</span><span class="op" id="5977411">(</span><span class="op" id="5977412">[</span><span class="op" id="5977413">]</span><span class="builtintype" id="5977414">uint8</span><span class="op" id="5977419">,</span>&nbsp;<span class="num" id="5977421">1</span><span class="op" id="5977422">+</span><span class="ident" id="5977423">bpp</span><span class="op" id="5977426">*</span><span class="ident" id="5977427">b</span><span class="op" id="5977428">.</span><span class="ident" id="5977429">Dx</span><span class="op" id="5977431">(</span><span class="op" id="5977432">)</span><span class="op" id="5977433">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977437">cr</span><span class="op" id="5977439">[</span><span class="ident" id="5977440">i</span><span class="op" id="5977441">]</span><span class="op" id="5977442">[</span><span class="num" id="5977443">0</span><span class="op" id="5977444">]</span>&nbsp;<span class="op" id="5977446">=</span>&nbsp;<span class="builtintype" id="5977448">uint8</span><span class="op" id="5977453">(</span><span class="ident" id="5977454">i</span><span class="op" id="5977455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5977458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977461">pr</span>&nbsp;<span class="op" id="5977464">:=</span>&nbsp;<span class="builtinfunc" id="5977467">make</span><span class="op" id="5977471">(</span><span class="op" id="5977472">[</span><span class="op" id="5977473">]</span><span class="builtintype" id="5977474">uint8</span><span class="op" id="5977479">,</span>&nbsp;<span class="num" id="5977481">1</span><span class="op" id="5977482">+</span><span class="ident" id="5977483">bpp</span><span class="op" id="5977486">*</span><span class="ident" id="5977487">b</span><span class="op" id="5977488">.</span><span class="ident" id="5977489">Dx</span><span class="op" id="5977491">(</span><span class="op" id="5977492">)</span><span class="op" id="5977493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977497">gray</span><span class="op" id="5977501">,</span>&nbsp;<span class="ident" id="5977503">_</span>&nbsp;<span class="op" id="5977505">:=</span>&nbsp;<span class="ident" id="5977508">m</span><span class="op" id="5977509">.</span><span class="op" id="5977510">(</span><span class="op" id="5977511">*</span><span class="ident" id="5977512">image</span><span class="op" id="5977517">.</span><span class="ident" id="5977518">Gray</span><span class="op" id="5977522">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977525">rgba</span><span class="op" id="5977529">,</span>&nbsp;<span class="ident" id="5977531">_</span>&nbsp;<span class="op" id="5977533">:=</span>&nbsp;<span class="ident" id="5977536">m</span><span class="op" id="5977537">.</span><span class="op" id="5977538">(</span><span class="op" id="5977539">*</span><span class="ident" id="5977540">image</span><span class="op" id="5977545">.</span><span class="ident" id="5977546">RGBA</span><span class="op" id="5977550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977553">paletted</span><span class="op" id="5977561">,</span>&nbsp;<span class="ident" id="5977563">_</span>&nbsp;<span class="op" id="5977565">:=</span>&nbsp;<span class="ident" id="5977568">m</span><span class="op" id="5977569">.</span><span class="op" id="5977570">(</span><span class="op" id="5977571">*</span><span class="ident" id="5977572">image</span><span class="op" id="5977577">.</span><span class="ident" id="5977578">Paletted</span><span class="op" id="5977586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977589">nrgba</span><span class="op" id="5977594">,</span>&nbsp;<span class="ident" id="5977596">_</span>&nbsp;<span class="op" id="5977598">:=</span>&nbsp;<span class="ident" id="5977601">m</span><span class="op" id="5977602">.</span><span class="op" id="5977603">(</span><span class="op" id="5977604">*</span><span class="ident" id="5977605">image</span><span class="op" id="5977610">.</span><span class="ident" id="5977611">NRGBA</span><span class="op" id="5977616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977620">for</span>&nbsp;<span class="ident" id="5977624">y</span>&nbsp;<span class="op" id="5977626">:=</span>&nbsp;<span class="ident" id="5977629">b</span><span class="op" id="5977630">.</span><span class="ident" id="5977631">Min</span><span class="op" id="5977634">.</span><span class="ident" id="5977635">Y</span><span class="op" id="5977636">;</span>&nbsp;<span class="ident" id="5977638">y</span>&nbsp;<span class="op" id="5977640">&lt;</span>&nbsp;<span class="ident" id="5977642">b</span><span class="op" id="5977643">.</span><span class="ident" id="5977644">Max</span><span class="op" id="5977647">.</span><span class="ident" id="5977648">Y</span><span class="op" id="5977649">;</span>&nbsp;<span class="ident" id="5977651">y</span><span class="op" id="5977652">++</span>&nbsp;<span class="op" id="5977655">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5977659">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977694">i</span>&nbsp;<span class="op" id="5977696">:=</span>&nbsp;<span class="num" id="5977699">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977703">switch</span>&nbsp;<span class="ident" id="5977710">cb</span>&nbsp;<span class="op" id="5977713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977717">case</span>&nbsp;<span class="ident" id="5977722">cbG8</span><span class="op" id="5977726">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977731">if</span>&nbsp;<span class="ident" id="5977734">gray</span>&nbsp;<span class="op" id="5977739">!=</span>&nbsp;<span class="ident" id="5977742">nil</span>&nbsp;<span class="op" id="5977746">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977752">offset</span>&nbsp;<span class="op" id="5977759">:=</span>&nbsp;<span class="op" id="5977762">(</span><span class="ident" id="5977763">y</span>&nbsp;<span class="op" id="5977765">-</span>&nbsp;<span class="ident" id="5977767">b</span><span class="op" id="5977768">.</span><span class="ident" id="5977769">Min</span><span class="op" id="5977772">.</span><span class="ident" id="5977773">Y</span><span class="op" id="5977774">)</span>&nbsp;<span class="op" id="5977776">*</span>&nbsp;<span class="ident" id="5977778">gray</span><span class="op" id="5977782">.</span><span class="ident" id="5977783">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5977794">copy</span><span class="op" id="5977798">(</span><span class="ident" id="5977799">cr</span><span class="op" id="5977801">[</span><span class="num" id="5977802">0</span><span class="op" id="5977803">]</span><span class="op" id="5977804">[</span><span class="num" id="5977805">1</span><span class="op" id="5977806">:</span><span class="op" id="5977807">]</span><span class="op" id="5977808">,</span>&nbsp;<span class="ident" id="5977810">gray</span><span class="op" id="5977814">.</span><span class="ident" id="5977815">Pix</span><span class="op" id="5977818">[</span><span class="ident" id="5977819">offset</span><span class="op" id="5977825">:</span><span class="ident" id="5977826">offset</span><span class="op" id="5977832">+</span><span class="ident" id="5977833">b</span><span class="op" id="5977834">.</span><span class="ident" id="5977835">Dx</span><span class="op" id="5977837">(</span><span class="op" id="5977838">)</span><span class="op" id="5977839">]</span><span class="op" id="5977840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5977845">}</span>&nbsp;<span class="keyword" id="5977847">else</span>&nbsp;<span class="op" id="5977852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977858">for</span>&nbsp;<span class="ident" id="5977862">x</span>&nbsp;<span class="op" id="5977864">:=</span>&nbsp;<span class="ident" id="5977867">b</span><span class="op" id="5977868">.</span><span class="ident" id="5977869">Min</span><span class="op" id="5977872">.</span><span class="ident" id="5977873">X</span><span class="op" id="5977874">;</span>&nbsp;<span class="ident" id="5977876">x</span>&nbsp;<span class="op" id="5977878">&lt;</span>&nbsp;<span class="ident" id="5977880">b</span><span class="op" id="5977881">.</span><span class="ident" id="5977882">Max</span><span class="op" id="5977885">.</span><span class="ident" id="5977886">X</span><span class="op" id="5977887">;</span>&nbsp;<span class="ident" id="5977889">x</span><span class="op" id="5977890">++</span>&nbsp;<span class="op" id="5977893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977900">c</span>&nbsp;<span class="op" id="5977902">:=</span>&nbsp;<span class="ident" id="5977905">color</span><span class="op" id="5977910">.</span><span class="ident" id="5977911">GrayModel</span><span class="op" id="5977920">.</span><span class="ident" id="5977921">Convert</span><span class="op" id="5977928">(</span><span class="ident" id="5977929">m</span><span class="op" id="5977930">.</span><span class="ident" id="5977931">At</span><span class="op" id="5977933">(</span><span class="ident" id="5977934">x</span><span class="op" id="5977935">,</span>&nbsp;<span class="ident" id="5977937">y</span><span class="op" id="5977938">)</span><span class="op" id="5977939">)</span><span class="op" id="5977940">.</span><span class="op" id="5977941">(</span><span class="ident" id="5977942">color</span><span class="op" id="5977947">.</span><span class="ident" id="5977948">Gray</span><span class="op" id="5977952">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977959">cr</span><span class="op" id="5977961">[</span><span class="num" id="5977962">0</span><span class="op" id="5977963">]</span><span class="op" id="5977964">[</span><span class="ident" id="5977965">i</span><span class="op" id="5977966">]</span>&nbsp;<span class="op" id="5977968">=</span>&nbsp;<span class="ident" id="5977970">c</span><span class="op" id="5977971">.</span><span class="ident" id="5977972">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977979">i</span><span class="op" id="5977980">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5977987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5977992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977996">case</span>&nbsp;<span class="ident" id="5978001">cbTC8</span><span class="op" id="5978006">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5978011">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978083">cr0</span>&nbsp;<span class="op" id="5978087">:=</span>&nbsp;<span class="ident" id="5978090">cr</span><span class="op" id="5978092">[</span><span class="num" id="5978093">0</span><span class="op" id="5978094">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978099">stride</span><span class="op" id="5978105">,</span>&nbsp;<span class="ident" id="5978107">pix</span>&nbsp;<span class="op" id="5978111">:=</span>&nbsp;<span class="num" id="5978114">0</span><span class="op" id="5978115">,</span>&nbsp;<span class="op" id="5978117">[</span><span class="op" id="5978118">]</span><span class="builtintype" id="5978119">byte</span><span class="op" id="5978123">(</span><span class="ident" id="5978124">nil</span><span class="op" id="5978127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978132">if</span>&nbsp;<span class="ident" id="5978135">rgba</span>&nbsp;<span class="op" id="5978140">!=</span>&nbsp;<span class="ident" id="5978143">nil</span>&nbsp;<span class="op" id="5978147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978153">stride</span><span class="op" id="5978159">,</span>&nbsp;<span class="ident" id="5978161">pix</span>&nbsp;<span class="op" id="5978165">=</span>&nbsp;<span class="ident" id="5978167">rgba</span><span class="op" id="5978171">.</span><span class="ident" id="5978172">Stride</span><span class="op" id="5978178">,</span>&nbsp;<span class="ident" id="5978180">rgba</span><span class="op" id="5978184">.</span><span class="ident" id="5978185">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978192">}</span>&nbsp;<span class="keyword" id="5978194">else</span>&nbsp;<span class="keyword" id="5978199">if</span>&nbsp;<span class="ident" id="5978202">nrgba</span>&nbsp;<span class="op" id="5978208">!=</span>&nbsp;<span class="ident" id="5978211">nil</span>&nbsp;<span class="op" id="5978215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978221">stride</span><span class="op" id="5978227">,</span>&nbsp;<span class="ident" id="5978229">pix</span>&nbsp;<span class="op" id="5978233">=</span>&nbsp;<span class="ident" id="5978235">nrgba</span><span class="op" id="5978240">.</span><span class="ident" id="5978241">Stride</span><span class="op" id="5978247">,</span>&nbsp;<span class="ident" id="5978249">nrgba</span><span class="op" id="5978254">.</span><span class="ident" id="5978255">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978267">if</span>&nbsp;<span class="ident" id="5978270">stride</span>&nbsp;<span class="op" id="5978277">!=</span>&nbsp;<span class="num" id="5978280">0</span>&nbsp;<span class="op" id="5978282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978288">j0</span>&nbsp;<span class="op" id="5978291">:=</span>&nbsp;<span class="op" id="5978294">(</span><span class="ident" id="5978295">y</span>&nbsp;<span class="op" id="5978297">-</span>&nbsp;<span class="ident" id="5978299">b</span><span class="op" id="5978300">.</span><span class="ident" id="5978301">Min</span><span class="op" id="5978304">.</span><span class="ident" id="5978305">Y</span><span class="op" id="5978306">)</span>&nbsp;<span class="op" id="5978308">*</span>&nbsp;<span class="ident" id="5978310">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978321">j1</span>&nbsp;<span class="op" id="5978324">:=</span>&nbsp;<span class="ident" id="5978327">j0</span>&nbsp;<span class="op" id="5978330">+</span>&nbsp;<span class="ident" id="5978332">b</span><span class="op" id="5978333">.</span><span class="ident" id="5978334">Dx</span><span class="op" id="5978336">(</span><span class="op" id="5978337">)</span><span class="op" id="5978338">*</span><span class="num" id="5978339">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978345">for</span>&nbsp;<span class="ident" id="5978349">j</span>&nbsp;<span class="op" id="5978351">:=</span>&nbsp;<span class="ident" id="5978354">j0</span><span class="op" id="5978356">;</span>&nbsp;<span class="ident" id="5978358">j</span>&nbsp;<span class="op" id="5978360">&lt;</span>&nbsp;<span class="ident" id="5978362">j1</span><span class="op" id="5978364">;</span>&nbsp;<span class="ident" id="5978366">j</span>&nbsp;<span class="op" id="5978368">+=</span>&nbsp;<span class="num" id="5978371">4</span>&nbsp;<span class="op" id="5978373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978380">cr0</span><span class="op" id="5978383">[</span><span class="ident" id="5978384">i</span><span class="op" id="5978385">+</span><span class="num" id="5978386">0</span><span class="op" id="5978387">]</span>&nbsp;<span class="op" id="5978389">=</span>&nbsp;<span class="ident" id="5978391">pix</span><span class="op" id="5978394">[</span><span class="ident" id="5978395">j</span><span class="op" id="5978396">+</span><span class="num" id="5978397">0</span><span class="op" id="5978398">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978405">cr0</span><span class="op" id="5978408">[</span><span class="ident" id="5978409">i</span><span class="op" id="5978410">+</span><span class="num" id="5978411">1</span><span class="op" id="5978412">]</span>&nbsp;<span class="op" id="5978414">=</span>&nbsp;<span class="ident" id="5978416">pix</span><span class="op" id="5978419">[</span><span class="ident" id="5978420">j</span><span class="op" id="5978421">+</span><span class="num" id="5978422">1</span><span class="op" id="5978423">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978430">cr0</span><span class="op" id="5978433">[</span><span class="ident" id="5978434">i</span><span class="op" id="5978435">+</span><span class="num" id="5978436">2</span><span class="op" id="5978437">]</span>&nbsp;<span class="op" id="5978439">=</span>&nbsp;<span class="ident" id="5978441">pix</span><span class="op" id="5978444">[</span><span class="ident" id="5978445">j</span><span class="op" id="5978446">+</span><span class="num" id="5978447">2</span><span class="op" id="5978448">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978455">i</span>&nbsp;<span class="op" id="5978457">+=</span>&nbsp;<span class="num" id="5978460">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978471">}</span>&nbsp;<span class="keyword" id="5978473">else</span>&nbsp;<span class="op" id="5978478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978484">for</span>&nbsp;<span class="ident" id="5978488">x</span>&nbsp;<span class="op" id="5978490">:=</span>&nbsp;<span class="ident" id="5978493">b</span><span class="op" id="5978494">.</span><span class="ident" id="5978495">Min</span><span class="op" id="5978498">.</span><span class="ident" id="5978499">X</span><span class="op" id="5978500">;</span>&nbsp;<span class="ident" id="5978502">x</span>&nbsp;<span class="op" id="5978504">&lt;</span>&nbsp;<span class="ident" id="5978506">b</span><span class="op" id="5978507">.</span><span class="ident" id="5978508">Max</span><span class="op" id="5978511">.</span><span class="ident" id="5978512">X</span><span class="op" id="5978513">;</span>&nbsp;<span class="ident" id="5978515">x</span><span class="op" id="5978516">++</span>&nbsp;<span class="op" id="5978519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978526">r</span><span class="op" id="5978527">,</span>&nbsp;<span class="ident" id="5978529">g</span><span class="op" id="5978530">,</span>&nbsp;<span class="ident" id="5978532">b</span><span class="op" id="5978533">,</span>&nbsp;<span class="ident" id="5978535">_</span>&nbsp;<span class="op" id="5978537">:=</span>&nbsp;<span class="ident" id="5978540">m</span><span class="op" id="5978541">.</span><span class="ident" id="5978542">At</span><span class="op" id="5978544">(</span><span class="ident" id="5978545">x</span><span class="op" id="5978546">,</span>&nbsp;<span class="ident" id="5978548">y</span><span class="op" id="5978549">)</span><span class="op" id="5978550">.</span><span class="ident" id="5978551">RGBA</span><span class="op" id="5978555">(</span><span class="op" id="5978556">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978563">cr0</span><span class="op" id="5978566">[</span><span class="ident" id="5978567">i</span><span class="op" id="5978568">+</span><span class="num" id="5978569">0</span><span class="op" id="5978570">]</span>&nbsp;<span class="op" id="5978572">=</span>&nbsp;<span class="builtintype" id="5978574">uint8</span><span class="op" id="5978579">(</span><span class="ident" id="5978580">r</span>&nbsp;<span class="op" id="5978582">&gt;&gt;</span>&nbsp;<span class="num" id="5978585">8</span><span class="op" id="5978586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978593">cr0</span><span class="op" id="5978596">[</span><span class="ident" id="5978597">i</span><span class="op" id="5978598">+</span><span class="num" id="5978599">1</span><span class="op" id="5978600">]</span>&nbsp;<span class="op" id="5978602">=</span>&nbsp;<span class="builtintype" id="5978604">uint8</span><span class="op" id="5978609">(</span><span class="ident" id="5978610">g</span>&nbsp;<span class="op" id="5978612">&gt;&gt;</span>&nbsp;<span class="num" id="5978615">8</span><span class="op" id="5978616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978623">cr0</span><span class="op" id="5978626">[</span><span class="ident" id="5978627">i</span><span class="op" id="5978628">+</span><span class="num" id="5978629">2</span><span class="op" id="5978630">]</span>&nbsp;<span class="op" id="5978632">=</span>&nbsp;<span class="builtintype" id="5978634">uint8</span><span class="op" id="5978639">(</span><span class="ident" id="5978640">b</span>&nbsp;<span class="op" id="5978642">&gt;&gt;</span>&nbsp;<span class="num" id="5978645">8</span><span class="op" id="5978646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978653">i</span>&nbsp;<span class="op" id="5978655">+=</span>&nbsp;<span class="num" id="5978658">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978664">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978673">case</span>&nbsp;<span class="ident" id="5978678">cbP8</span><span class="op" id="5978682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978687">if</span>&nbsp;<span class="ident" id="5978690">paletted</span>&nbsp;<span class="op" id="5978699">!=</span>&nbsp;<span class="ident" id="5978702">nil</span>&nbsp;<span class="op" id="5978706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978712">offset</span>&nbsp;<span class="op" id="5978719">:=</span>&nbsp;<span class="op" id="5978722">(</span><span class="ident" id="5978723">y</span>&nbsp;<span class="op" id="5978725">-</span>&nbsp;<span class="ident" id="5978727">b</span><span class="op" id="5978728">.</span><span class="ident" id="5978729">Min</span><span class="op" id="5978732">.</span><span class="ident" id="5978733">Y</span><span class="op" id="5978734">)</span>&nbsp;<span class="op" id="5978736">*</span>&nbsp;<span class="ident" id="5978738">paletted</span><span class="op" id="5978746">.</span><span class="ident" id="5978747">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5978758">copy</span><span class="op" id="5978762">(</span><span class="ident" id="5978763">cr</span><span class="op" id="5978765">[</span><span class="num" id="5978766">0</span><span class="op" id="5978767">]</span><span class="op" id="5978768">[</span><span class="num" id="5978769">1</span><span class="op" id="5978770">:</span><span class="op" id="5978771">]</span><span class="op" id="5978772">,</span>&nbsp;<span class="ident" id="5978774">paletted</span><span class="op" id="5978782">.</span><span class="ident" id="5978783">Pix</span><span class="op" id="5978786">[</span><span class="ident" id="5978787">offset</span><span class="op" id="5978793">:</span><span class="ident" id="5978794">offset</span><span class="op" id="5978800">+</span><span class="ident" id="5978801">b</span><span class="op" id="5978802">.</span><span class="ident" id="5978803">Dx</span><span class="op" id="5978805">(</span><span class="op" id="5978806">)</span><span class="op" id="5978807">]</span><span class="op" id="5978808">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978813">}</span>&nbsp;<span class="keyword" id="5978815">else</span>&nbsp;<span class="op" id="5978820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978826">pi</span>&nbsp;<span class="op" id="5978829">:=</span>&nbsp;<span class="ident" id="5978832">m</span><span class="op" id="5978833">.</span><span class="op" id="5978834">(</span><span class="ident" id="5978835">image</span><span class="op" id="5978840">.</span><span class="ident" id="5978841">PalettedImage</span><span class="op" id="5978854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978860">for</span>&nbsp;<span class="ident" id="5978864">x</span>&nbsp;<span class="op" id="5978866">:=</span>&nbsp;<span class="ident" id="5978869">b</span><span class="op" id="5978870">.</span><span class="ident" id="5978871">Min</span><span class="op" id="5978874">.</span><span class="ident" id="5978875">X</span><span class="op" id="5978876">;</span>&nbsp;<span class="ident" id="5978878">x</span>&nbsp;<span class="op" id="5978880">&lt;</span>&nbsp;<span class="ident" id="5978882">b</span><span class="op" id="5978883">.</span><span class="ident" id="5978884">Max</span><span class="op" id="5978887">.</span><span class="ident" id="5978888">X</span><span class="op" id="5978889">;</span>&nbsp;<span class="ident" id="5978891">x</span><span class="op" id="5978892">++</span>&nbsp;<span class="op" id="5978895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978902">cr</span><span class="op" id="5978904">[</span><span class="num" id="5978905">0</span><span class="op" id="5978906">]</span><span class="op" id="5978907">[</span><span class="ident" id="5978908">i</span><span class="op" id="5978909">]</span>&nbsp;<span class="op" id="5978911">=</span>&nbsp;<span class="ident" id="5978913">pi</span><span class="op" id="5978915">.</span><span class="ident" id="5978916">ColorIndexAt</span><span class="op" id="5978928">(</span><span class="ident" id="5978929">x</span><span class="op" id="5978930">,</span>&nbsp;<span class="ident" id="5978932">y</span><span class="op" id="5978933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978940">i</span>&nbsp;<span class="op" id="5978942">+=</span>&nbsp;<span class="num" id="5978945">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978960">case</span>&nbsp;<span class="ident" id="5978965">cbTCA8</span><span class="op" id="5978971">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978976">if</span>&nbsp;<span class="ident" id="5978979">nrgba</span>&nbsp;<span class="op" id="5978985">!=</span>&nbsp;<span class="ident" id="5978988">nil</span>&nbsp;<span class="op" id="5978992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978998">offset</span>&nbsp;<span class="op" id="5979005">:=</span>&nbsp;<span class="op" id="5979008">(</span><span class="ident" id="5979009">y</span>&nbsp;<span class="op" id="5979011">-</span>&nbsp;<span class="ident" id="5979013">b</span><span class="op" id="5979014">.</span><span class="ident" id="5979015">Min</span><span class="op" id="5979018">.</span><span class="ident" id="5979019">Y</span><span class="op" id="5979020">)</span>&nbsp;<span class="op" id="5979022">*</span>&nbsp;<span class="ident" id="5979024">nrgba</span><span class="op" id="5979029">.</span><span class="ident" id="5979030">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5979041">copy</span><span class="op" id="5979045">(</span><span class="ident" id="5979046">cr</span><span class="op" id="5979048">[</span><span class="num" id="5979049">0</span><span class="op" id="5979050">]</span><span class="op" id="5979051">[</span><span class="num" id="5979052">1</span><span class="op" id="5979053">:</span><span class="op" id="5979054">]</span><span class="op" id="5979055">,</span>&nbsp;<span class="ident" id="5979057">nrgba</span><span class="op" id="5979062">.</span><span class="ident" id="5979063">Pix</span><span class="op" id="5979066">[</span><span class="ident" id="5979067">offset</span><span class="op" id="5979073">:</span><span class="ident" id="5979074">offset</span><span class="op" id="5979080">+</span><span class="ident" id="5979081">b</span><span class="op" id="5979082">.</span><span class="ident" id="5979083">Dx</span><span class="op" id="5979085">(</span><span class="op" id="5979086">)</span><span class="op" id="5979087">*</span><span class="num" id="5979088">4</span><span class="op" id="5979089">]</span><span class="op" id="5979090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979095">}</span>&nbsp;<span class="keyword" id="5979097">else</span>&nbsp;<span class="op" id="5979102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5979108">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979205">for</span>&nbsp;<span class="ident" id="5979209">x</span>&nbsp;<span class="op" id="5979211">:=</span>&nbsp;<span class="ident" id="5979214">b</span><span class="op" id="5979215">.</span><span class="ident" id="5979216">Min</span><span class="op" id="5979219">.</span><span class="ident" id="5979220">X</span><span class="op" id="5979221">;</span>&nbsp;<span class="ident" id="5979223">x</span>&nbsp;<span class="op" id="5979225">&lt;</span>&nbsp;<span class="ident" id="5979227">b</span><span class="op" id="5979228">.</span><span class="ident" id="5979229">Max</span><span class="op" id="5979232">.</span><span class="ident" id="5979233">X</span><span class="op" id="5979234">;</span>&nbsp;<span class="ident" id="5979236">x</span><span class="op" id="5979237">++</span>&nbsp;<span class="op" id="5979240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979247">c</span>&nbsp;<span class="op" id="5979249">:=</span>&nbsp;<span class="ident" id="5979252">color</span><span class="op" id="5979257">.</span><span class="ident" id="5979258">NRGBAModel</span><span class="op" id="5979268">.</span><span class="ident" id="5979269">Convert</span><span class="op" id="5979276">(</span><span class="ident" id="5979277">m</span><span class="op" id="5979278">.</span><span class="ident" id="5979279">At</span><span class="op" id="5979281">(</span><span class="ident" id="5979282">x</span><span class="op" id="5979283">,</span>&nbsp;<span class="ident" id="5979285">y</span><span class="op" id="5979286">)</span><span class="op" id="5979287">)</span><span class="op" id="5979288">.</span><span class="op" id="5979289">(</span><span class="ident" id="5979290">color</span><span class="op" id="5979295">.</span><span class="ident" id="5979296">NRGBA</span><span class="op" id="5979301">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979308">cr</span><span class="op" id="5979310">[</span><span class="num" id="5979311">0</span><span class="op" id="5979312">]</span><span class="op" id="5979313">[</span><span class="ident" id="5979314">i</span><span class="op" id="5979315">+</span><span class="num" id="5979316">0</span><span class="op" id="5979317">]</span>&nbsp;<span class="op" id="5979319">=</span>&nbsp;<span class="ident" id="5979321">c</span><span class="op" id="5979322">.</span><span class="ident" id="5979323">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979330">cr</span><span class="op" id="5979332">[</span><span class="num" id="5979333">0</span><span class="op" id="5979334">]</span><span class="op" id="5979335">[</span><span class="ident" id="5979336">i</span><span class="op" id="5979337">+</span><span class="num" id="5979338">1</span><span class="op" id="5979339">]</span>&nbsp;<span class="op" id="5979341">=</span>&nbsp;<span class="ident" id="5979343">c</span><span class="op" id="5979344">.</span><span class="ident" id="5979345">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979352">cr</span><span class="op" id="5979354">[</span><span class="num" id="5979355">0</span><span class="op" id="5979356">]</span><span class="op" id="5979357">[</span><span class="ident" id="5979358">i</span><span class="op" id="5979359">+</span><span class="num" id="5979360">2</span><span class="op" id="5979361">]</span>&nbsp;<span class="op" id="5979363">=</span>&nbsp;<span class="ident" id="5979365">c</span><span class="op" id="5979366">.</span><span class="ident" id="5979367">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979374">cr</span><span class="op" id="5979376">[</span><span class="num" id="5979377">0</span><span class="op" id="5979378">]</span><span class="op" id="5979379">[</span><span class="ident" id="5979380">i</span><span class="op" id="5979381">+</span><span class="num" id="5979382">3</span><span class="op" id="5979383">]</span>&nbsp;<span class="op" id="5979385">=</span>&nbsp;<span class="ident" id="5979387">c</span><span class="op" id="5979388">.</span><span class="ident" id="5979389">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979396">i</span>&nbsp;<span class="op" id="5979398">+=</span>&nbsp;<span class="num" id="5979401">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979416">case</span>&nbsp;<span class="ident" id="5979421">cbG16</span><span class="op" id="5979426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979431">for</span>&nbsp;<span class="ident" id="5979435">x</span>&nbsp;<span class="op" id="5979437">:=</span>&nbsp;<span class="ident" id="5979440">b</span><span class="op" id="5979441">.</span><span class="ident" id="5979442">Min</span><span class="op" id="5979445">.</span><span class="ident" id="5979446">X</span><span class="op" id="5979447">;</span>&nbsp;<span class="ident" id="5979449">x</span>&nbsp;<span class="op" id="5979451">&lt;</span>&nbsp;<span class="ident" id="5979453">b</span><span class="op" id="5979454">.</span><span class="ident" id="5979455">Max</span><span class="op" id="5979458">.</span><span class="ident" id="5979459">X</span><span class="op" id="5979460">;</span>&nbsp;<span class="ident" id="5979462">x</span><span class="op" id="5979463">++</span>&nbsp;<span class="op" id="5979466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979472">c</span>&nbsp;<span class="op" id="5979474">:=</span>&nbsp;<span class="ident" id="5979477">color</span><span class="op" id="5979482">.</span><span class="ident" id="5979483">Gray16Model</span><span class="op" id="5979494">.</span><span class="ident" id="5979495">Convert</span><span class="op" id="5979502">(</span><span class="ident" id="5979503">m</span><span class="op" id="5979504">.</span><span class="ident" id="5979505">At</span><span class="op" id="5979507">(</span><span class="ident" id="5979508">x</span><span class="op" id="5979509">,</span>&nbsp;<span class="ident" id="5979511">y</span><span class="op" id="5979512">)</span><span class="op" id="5979513">)</span><span class="op" id="5979514">.</span><span class="op" id="5979515">(</span><span class="ident" id="5979516">color</span><span class="op" id="5979521">.</span><span class="ident" id="5979522">Gray16</span><span class="op" id="5979528">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979534">cr</span><span class="op" id="5979536">[</span><span class="num" id="5979537">0</span><span class="op" id="5979538">]</span><span class="op" id="5979539">[</span><span class="ident" id="5979540">i</span><span class="op" id="5979541">+</span><span class="num" id="5979542">0</span><span class="op" id="5979543">]</span>&nbsp;<span class="op" id="5979545">=</span>&nbsp;<span class="builtintype" id="5979547">uint8</span><span class="op" id="5979552">(</span><span class="ident" id="5979553">c</span><span class="op" id="5979554">.</span><span class="ident" id="5979555">Y</span>&nbsp;<span class="op" id="5979557">&gt;&gt;</span>&nbsp;<span class="num" id="5979560">8</span><span class="op" id="5979561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979567">cr</span><span class="op" id="5979569">[</span><span class="num" id="5979570">0</span><span class="op" id="5979571">]</span><span class="op" id="5979572">[</span><span class="ident" id="5979573">i</span><span class="op" id="5979574">+</span><span class="num" id="5979575">1</span><span class="op" id="5979576">]</span>&nbsp;<span class="op" id="5979578">=</span>&nbsp;<span class="builtintype" id="5979580">uint8</span><span class="op" id="5979585">(</span><span class="ident" id="5979586">c</span><span class="op" id="5979587">.</span><span class="ident" id="5979588">Y</span><span class="op" id="5979589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979595">i</span>&nbsp;<span class="op" id="5979597">+=</span>&nbsp;<span class="num" id="5979600">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979609">case</span>&nbsp;<span class="ident" id="5979614">cbTC16</span><span class="op" id="5979620">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5979625">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979697">for</span>&nbsp;<span class="ident" id="5979701">x</span>&nbsp;<span class="op" id="5979703">:=</span>&nbsp;<span class="ident" id="5979706">b</span><span class="op" id="5979707">.</span><span class="ident" id="5979708">Min</span><span class="op" id="5979711">.</span><span class="ident" id="5979712">X</span><span class="op" id="5979713">;</span>&nbsp;<span class="ident" id="5979715">x</span>&nbsp;<span class="op" id="5979717">&lt;</span>&nbsp;<span class="ident" id="5979719">b</span><span class="op" id="5979720">.</span><span class="ident" id="5979721">Max</span><span class="op" id="5979724">.</span><span class="ident" id="5979725">X</span><span class="op" id="5979726">;</span>&nbsp;<span class="ident" id="5979728">x</span><span class="op" id="5979729">++</span>&nbsp;<span class="op" id="5979732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979738">r</span><span class="op" id="5979739">,</span>&nbsp;<span class="ident" id="5979741">g</span><span class="op" id="5979742">,</span>&nbsp;<span class="ident" id="5979744">b</span><span class="op" id="5979745">,</span>&nbsp;<span class="ident" id="5979747">_</span>&nbsp;<span class="op" id="5979749">:=</span>&nbsp;<span class="ident" id="5979752">m</span><span class="op" id="5979753">.</span><span class="ident" id="5979754">At</span><span class="op" id="5979756">(</span><span class="ident" id="5979757">x</span><span class="op" id="5979758">,</span>&nbsp;<span class="ident" id="5979760">y</span><span class="op" id="5979761">)</span><span class="op" id="5979762">.</span><span class="ident" id="5979763">RGBA</span><span class="op" id="5979767">(</span><span class="op" id="5979768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979774">cr</span><span class="op" id="5979776">[</span><span class="num" id="5979777">0</span><span class="op" id="5979778">]</span><span class="op" id="5979779">[</span><span class="ident" id="5979780">i</span><span class="op" id="5979781">+</span><span class="num" id="5979782">0</span><span class="op" id="5979783">]</span>&nbsp;<span class="op" id="5979785">=</span>&nbsp;<span class="builtintype" id="5979787">uint8</span><span class="op" id="5979792">(</span><span class="ident" id="5979793">r</span>&nbsp;<span class="op" id="5979795">&gt;&gt;</span>&nbsp;<span class="num" id="5979798">8</span><span class="op" id="5979799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979805">cr</span><span class="op" id="5979807">[</span><span class="num" id="5979808">0</span><span class="op" id="5979809">]</span><span class="op" id="5979810">[</span><span class="ident" id="5979811">i</span><span class="op" id="5979812">+</span><span class="num" id="5979813">1</span><span class="op" id="5979814">]</span>&nbsp;<span class="op" id="5979816">=</span>&nbsp;<span class="builtintype" id="5979818">uint8</span><span class="op" id="5979823">(</span><span class="ident" id="5979824">r</span><span class="op" id="5979825">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979831">cr</span><span class="op" id="5979833">[</span><span class="num" id="5979834">0</span><span class="op" id="5979835">]</span><span class="op" id="5979836">[</span><span class="ident" id="5979837">i</span><span class="op" id="5979838">+</span><span class="num" id="5979839">2</span><span class="op" id="5979840">]</span>&nbsp;<span class="op" id="5979842">=</span>&nbsp;<span class="builtintype" id="5979844">uint8</span><span class="op" id="5979849">(</span><span class="ident" id="5979850">g</span>&nbsp;<span class="op" id="5979852">&gt;&gt;</span>&nbsp;<span class="num" id="5979855">8</span><span class="op" id="5979856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979862">cr</span><span class="op" id="5979864">[</span><span class="num" id="5979865">0</span><span class="op" id="5979866">]</span><span class="op" id="5979867">[</span><span class="ident" id="5979868">i</span><span class="op" id="5979869">+</span><span class="num" id="5979870">3</span><span class="op" id="5979871">]</span>&nbsp;<span class="op" id="5979873">=</span>&nbsp;<span class="builtintype" id="5979875">uint8</span><span class="op" id="5979880">(</span><span class="ident" id="5979881">g</span><span class="op" id="5979882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979888">cr</span><span class="op" id="5979890">[</span><span class="num" id="5979891">0</span><span class="op" id="5979892">]</span><span class="op" id="5979893">[</span><span class="ident" id="5979894">i</span><span class="op" id="5979895">+</span><span class="num" id="5979896">4</span><span class="op" id="5979897">]</span>&nbsp;<span class="op" id="5979899">=</span>&nbsp;<span class="builtintype" id="5979901">uint8</span><span class="op" id="5979906">(</span><span class="ident" id="5979907">b</span>&nbsp;<span class="op" id="5979909">&gt;&gt;</span>&nbsp;<span class="num" id="5979912">8</span><span class="op" id="5979913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979919">cr</span><span class="op" id="5979921">[</span><span class="num" id="5979922">0</span><span class="op" id="5979923">]</span><span class="op" id="5979924">[</span><span class="ident" id="5979925">i</span><span class="op" id="5979926">+</span><span class="num" id="5979927">5</span><span class="op" id="5979928">]</span>&nbsp;<span class="op" id="5979930">=</span>&nbsp;<span class="builtintype" id="5979932">uint8</span><span class="op" id="5979937">(</span><span class="ident" id="5979938">b</span><span class="op" id="5979939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979945">i</span>&nbsp;<span class="op" id="5979947">+=</span>&nbsp;<span class="num" id="5979950">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979959">case</span>&nbsp;<span class="ident" id="5979964">cbTCA16</span><span class="op" id="5979971">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5979976">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980072">for</span>&nbsp;<span class="ident" id="5980076">x</span>&nbsp;<span class="op" id="5980078">:=</span>&nbsp;<span class="ident" id="5980081">b</span><span class="op" id="5980082">.</span><span class="ident" id="5980083">Min</span><span class="op" id="5980086">.</span><span class="ident" id="5980087">X</span><span class="op" id="5980088">;</span>&nbsp;<span class="ident" id="5980090">x</span>&nbsp;<span class="op" id="5980092">&lt;</span>&nbsp;<span class="ident" id="5980094">b</span><span class="op" id="5980095">.</span><span class="ident" id="5980096">Max</span><span class="op" id="5980099">.</span><span class="ident" id="5980100">X</span><span class="op" id="5980101">;</span>&nbsp;<span class="ident" id="5980103">x</span><span class="op" id="5980104">++</span>&nbsp;<span class="op" id="5980107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980113">c</span>&nbsp;<span class="op" id="5980115">:=</span>&nbsp;<span class="ident" id="5980118">color</span><span class="op" id="5980123">.</span><span class="ident" id="5980124">NRGBA64Model</span><span class="op" id="5980136">.</span><span class="ident" id="5980137">Convert</span><span class="op" id="5980144">(</span><span class="ident" id="5980145">m</span><span class="op" id="5980146">.</span><span class="ident" id="5980147">At</span><span class="op" id="5980149">(</span><span class="ident" id="5980150">x</span><span class="op" id="5980151">,</span>&nbsp;<span class="ident" id="5980153">y</span><span class="op" id="5980154">)</span><span class="op" id="5980155">)</span><span class="op" id="5980156">.</span><span class="op" id="5980157">(</span><span class="ident" id="5980158">color</span><span class="op" id="5980163">.</span><span class="ident" id="5980164">NRGBA64</span><span class="op" id="5980171">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980177">cr</span><span class="op" id="5980179">[</span><span class="num" id="5980180">0</span><span class="op" id="5980181">]</span><span class="op" id="5980182">[</span><span class="ident" id="5980183">i</span><span class="op" id="5980184">+</span><span class="num" id="5980185">0</span><span class="op" id="5980186">]</span>&nbsp;<span class="op" id="5980188">=</span>&nbsp;<span class="builtintype" id="5980190">uint8</span><span class="op" id="5980195">(</span><span class="ident" id="5980196">c</span><span class="op" id="5980197">.</span><span class="ident" id="5980198">R</span>&nbsp;<span class="op" id="5980200">&gt;&gt;</span>&nbsp;<span class="num" id="5980203">8</span><span class="op" id="5980204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980210">cr</span><span class="op" id="5980212">[</span><span class="num" id="5980213">0</span><span class="op" id="5980214">]</span><span class="op" id="5980215">[</span><span class="ident" id="5980216">i</span><span class="op" id="5980217">+</span><span class="num" id="5980218">1</span><span class="op" id="5980219">]</span>&nbsp;<span class="op" id="5980221">=</span>&nbsp;<span class="builtintype" id="5980223">uint8</span><span class="op" id="5980228">(</span><span class="ident" id="5980229">c</span><span class="op" id="5980230">.</span><span class="ident" id="5980231">R</span><span class="op" id="5980232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980238">cr</span><span class="op" id="5980240">[</span><span class="num" id="5980241">0</span><span class="op" id="5980242">]</span><span class="op" id="5980243">[</span><span class="ident" id="5980244">i</span><span class="op" id="5980245">+</span><span class="num" id="5980246">2</span><span class="op" id="5980247">]</span>&nbsp;<span class="op" id="5980249">=</span>&nbsp;<span class="builtintype" id="5980251">uint8</span><span class="op" id="5980256">(</span><span class="ident" id="5980257">c</span><span class="op" id="5980258">.</span><span class="ident" id="5980259">G</span>&nbsp;<span class="op" id="5980261">&gt;&gt;</span>&nbsp;<span class="num" id="5980264">8</span><span class="op" id="5980265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980271">cr</span><span class="op" id="5980273">[</span><span class="num" id="5980274">0</span><span class="op" id="5980275">]</span><span class="op" id="5980276">[</span><span class="ident" id="5980277">i</span><span class="op" id="5980278">+</span><span class="num" id="5980279">3</span><span class="op" id="5980280">]</span>&nbsp;<span class="op" id="5980282">=</span>&nbsp;<span class="builtintype" id="5980284">uint8</span><span class="op" id="5980289">(</span><span class="ident" id="5980290">c</span><span class="op" id="5980291">.</span><span class="ident" id="5980292">G</span><span class="op" id="5980293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980299">cr</span><span class="op" id="5980301">[</span><span class="num" id="5980302">0</span><span class="op" id="5980303">]</span><span class="op" id="5980304">[</span><span class="ident" id="5980305">i</span><span class="op" id="5980306">+</span><span class="num" id="5980307">4</span><span class="op" id="5980308">]</span>&nbsp;<span class="op" id="5980310">=</span>&nbsp;<span class="builtintype" id="5980312">uint8</span><span class="op" id="5980317">(</span><span class="ident" id="5980318">c</span><span class="op" id="5980319">.</span><span class="ident" id="5980320">B</span>&nbsp;<span class="op" id="5980322">&gt;&gt;</span>&nbsp;<span class="num" id="5980325">8</span><span class="op" id="5980326">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980332">cr</span><span class="op" id="5980334">[</span><span class="num" id="5980335">0</span><span class="op" id="5980336">]</span><span class="op" id="5980337">[</span><span class="ident" id="5980338">i</span><span class="op" id="5980339">+</span><span class="num" id="5980340">5</span><span class="op" id="5980341">]</span>&nbsp;<span class="op" id="5980343">=</span>&nbsp;<span class="builtintype" id="5980345">uint8</span><span class="op" id="5980350">(</span><span class="ident" id="5980351">c</span><span class="op" id="5980352">.</span><span class="ident" id="5980353">B</span><span class="op" id="5980354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980360">cr</span><span class="op" id="5980362">[</span><span class="num" id="5980363">0</span><span class="op" id="5980364">]</span><span class="op" id="5980365">[</span><span class="ident" id="5980366">i</span><span class="op" id="5980367">+</span><span class="num" id="5980368">6</span><span class="op" id="5980369">]</span>&nbsp;<span class="op" id="5980371">=</span>&nbsp;<span class="builtintype" id="5980373">uint8</span><span class="op" id="5980378">(</span><span class="ident" id="5980379">c</span><span class="op" id="5980380">.</span><span class="ident" id="5980381">A</span>&nbsp;<span class="op" id="5980383">&gt;&gt;</span>&nbsp;<span class="num" id="5980386">8</span><span class="op" id="5980387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980393">cr</span><span class="op" id="5980395">[</span><span class="num" id="5980396">0</span><span class="op" id="5980397">]</span><span class="op" id="5980398">[</span><span class="ident" id="5980399">i</span><span class="op" id="5980400">+</span><span class="num" id="5980401">7</span><span class="op" id="5980402">]</span>&nbsp;<span class="op" id="5980404">=</span>&nbsp;<span class="builtintype" id="5980406">uint8</span><span class="op" id="5980411">(</span><span class="ident" id="5980412">c</span><span class="op" id="5980413">.</span><span class="ident" id="5980414">A</span><span class="op" id="5980415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980421">i</span>&nbsp;<span class="op" id="5980423">+=</span>&nbsp;<span class="num" id="5980426">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980431">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980440">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980463">f</span>&nbsp;<span class="op" id="5980465">:=</span>&nbsp;<span class="ident" id="5980468">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980477">if</span>&nbsp;<span class="ident" id="5980480">level</span>&nbsp;<span class="op" id="5980486">!=</span>&nbsp;<span class="ident" id="5980489">zlib</span><span class="op" id="5980493">.</span><span class="ident" id="5980494">NoCompression</span>&nbsp;<span class="op" id="5980508">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980513">f</span>&nbsp;<span class="op" id="5980515">=</span>&nbsp;<span class="ident" id="5980517">filter</span><span class="op" id="5980523">(</span><span class="op" id="5980524">&amp;</span><span class="ident" id="5980525">cr</span><span class="op" id="5980527">,</span>&nbsp;<span class="ident" id="5980529">pr</span><span class="op" id="5980531">,</span>&nbsp;<span class="ident" id="5980533">bpp</span><span class="op" id="5980536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980545">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980578">if</span>&nbsp;<span class="ident" id="5980581">_</span><span class="op" id="5980582">,</span>&nbsp;<span class="ident" id="5980584">err</span>&nbsp;<span class="op" id="5980588">:=</span>&nbsp;<span class="ident" id="5980591">zw</span><span class="op" id="5980593">.</span><span class="ident" id="5980594">Write</span><span class="op" id="5980599">(</span><span class="ident" id="5980600">cr</span><span class="op" id="5980602">[</span><span class="ident" id="5980603">f</span><span class="op" id="5980604">]</span><span class="op" id="5980605">)</span><span class="op" id="5980606">;</span>&nbsp;<span class="ident" id="5980608">err</span>&nbsp;<span class="op" id="5980612">!=</span>&nbsp;<span class="ident" id="5980615">nil</span>&nbsp;<span class="op" id="5980619">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980624">return</span>&nbsp;<span class="ident" id="5980631">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5980642">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980698">pr</span><span class="op" id="5980700">,</span>&nbsp;<span class="ident" id="5980702">cr</span><span class="op" id="5980704">[</span><span class="num" id="5980705">0</span><span class="op" id="5980706">]</span>&nbsp;<span class="op" id="5980708">=</span>&nbsp;<span class="ident" id="5980710">cr</span><span class="op" id="5980712">[</span><span class="num" id="5980713">0</span><span class="op" id="5980714">]</span><span class="op" id="5980715">,</span>&nbsp;<span class="ident" id="5980717">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980724">return</span>&nbsp;<span class="ident" id="5980731">nil</span><br>
<span class="lineno"></span><span class="op" id="5980735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5980738">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5980797">func</span>&nbsp;<span class="op" id="5980802">(</span><span class="ident" id="5980803">e</span>&nbsp;<span class="op" id="5980805">*</span><span class="ident" id="5980806">encoder</span><span class="op" id="5980813">)</span>&nbsp;<span class="ident" id="5980815">writeIDATs</span><span class="op" id="5980825">(</span><span class="op" id="5980826">)</span>&nbsp;<span class="op" id="5980828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980831">if</span>&nbsp;<span class="ident" id="5980834">e</span><span class="op" id="5980835">.</span><span class="ident" id="5980836">err</span>&nbsp;<span class="op" id="5980840">!=</span>&nbsp;<span class="ident" id="5980843">nil</span>&nbsp;<span class="op" id="5980847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980851">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980862">var</span>&nbsp;<span class="ident" id="5980866">bw</span>&nbsp;<span class="op" id="5980869">*</span><span class="ident" id="5980870">bufio</span><span class="op" id="5980875">.</span><span class="ident" id="5980876">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980884">bw</span>&nbsp;<span class="op" id="5980887">=</span>&nbsp;<span class="ident" id="5980889">bufio</span><span class="op" id="5980894">.</span><span class="ident" id="5980895">NewWriterSize</span><span class="op" id="5980908">(</span><span class="ident" id="5980909">e</span><span class="op" id="5980910">,</span>&nbsp;<span class="num" id="5980912">1</span><span class="op" id="5980913">&lt;&lt;</span><span class="num" id="5980915">15</span><span class="op" id="5980917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980920">e</span><span class="op" id="5980921">.</span><span class="ident" id="5980922">err</span>&nbsp;<span class="op" id="5980926">=</span>&nbsp;<span class="ident" id="5980928">writeImage</span><span class="op" id="5980938">(</span><span class="ident" id="5980939">bw</span><span class="op" id="5980941">,</span>&nbsp;<span class="ident" id="5980943">e</span><span class="op" id="5980944">.</span><span class="ident" id="5980945">m</span><span class="op" id="5980946">,</span>&nbsp;<span class="ident" id="5980948">e</span><span class="op" id="5980949">.</span><span class="ident" id="5980950">cb</span><span class="op" id="5980952">,</span>&nbsp;<span class="ident" id="5980954">levelToZlib</span><span class="op" id="5980965">(</span><span class="ident" id="5980966">e</span><span class="op" id="5980967">.</span><span class="ident" id="5980968">enc</span><span class="op" id="5980971">.</span><span class="ident" id="5980972">CompressionLevel</span><span class="op" id="5980988">)</span><span class="op" id="5980989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980992">if</span>&nbsp;<span class="ident" id="5980995">e</span><span class="op" id="5980996">.</span><span class="ident" id="5980997">err</span>&nbsp;<span class="op" id="5981001">!=</span>&nbsp;<span class="ident" id="5981004">nil</span>&nbsp;<span class="op" id="5981008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981012">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981020">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981023">e</span><span class="op" id="5981024">.</span><span class="ident" id="5981025">err</span>&nbsp;<span class="op" id="5981029">=</span>&nbsp;<span class="ident" id="5981031">bw</span><span class="op" id="5981033">.</span><span class="ident" id="5981034">Flush</span><span class="op" id="5981039">(</span><span class="op" id="5981040">)</span><br>
<span class="lineno"></span><span class="op" id="5981042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5981045">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5981108">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5981171">func</span>&nbsp;<span class="ident" id="5981176">levelToZlib</span><span class="op" id="5981187">(</span><span class="ident" id="5981188">l</span>&nbsp;<span class="ident" id="5981190">CompressionLevel</span><span class="op" id="5981206">)</span>&nbsp;<span class="builtintype" id="5981208">int</span>&nbsp;<span class="op" id="5981212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981215">switch</span>&nbsp;<span class="ident" id="5981222">l</span>&nbsp;<span class="op" id="5981224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981227">case</span>&nbsp;<span class="ident" id="5981232">DefaultCompression</span><span class="op" id="5981250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981254">return</span>&nbsp;<span class="ident" id="5981261">zlib</span><span class="op" id="5981265">.</span><span class="ident" id="5981266">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981286">case</span>&nbsp;<span class="ident" id="5981291">NoCompression</span><span class="op" id="5981304">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981308">return</span>&nbsp;<span class="ident" id="5981315">zlib</span><span class="op" id="5981319">.</span><span class="ident" id="5981320">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981335">case</span>&nbsp;<span class="ident" id="5981340">BestSpeed</span><span class="op" id="5981349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981353">return</span>&nbsp;<span class="ident" id="5981360">zlib</span><span class="op" id="5981364">.</span><span class="ident" id="5981365">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981376">case</span>&nbsp;<span class="ident" id="5981381">BestCompression</span><span class="op" id="5981396">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981400">return</span>&nbsp;<span class="ident" id="5981407">zlib</span><span class="op" id="5981411">.</span><span class="ident" id="5981412">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981429">default</span><span class="op" id="5981436">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981440">return</span>&nbsp;<span class="ident" id="5981447">zlib</span><span class="op" id="5981451">.</span><span class="ident" id="5981452">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981472">}</span><br>
<span class="lineno"></span><span class="op" id="5981474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5981477">func</span>&nbsp;<span class="op" id="5981482">(</span><span class="ident" id="5981483">e</span>&nbsp;<span class="op" id="5981485">*</span><span class="ident" id="5981486">encoder</span><span class="op" id="5981493">)</span>&nbsp;<span class="ident" id="5981495">writeIEND</span><span class="op" id="5981504">(</span><span class="op" id="5981505">)</span>&nbsp;<span class="op" id="5981507">{</span>&nbsp;<span class="ident" id="5981509">e</span><span class="op" id="5981510">.</span><span class="ident" id="5981511">writeChunk</span><span class="op" id="5981521">(</span><span class="ident" id="5981522">nil</span><span class="op" id="5981525">,</span>&nbsp;<span class="string" id="5981527">&#34;IEND&#34;</span><span class="op" id="5981533">)</span>&nbsp;<span class="op" id="5981535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5981538">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5981604">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5981678">func</span>&nbsp;<span class="ident" id="5981683">Encode</span><span class="op" id="5981689">(</span><span class="ident" id="5981690">w</span>&nbsp;<span class="ident" id="5981692">io</span><span class="op" id="5981694">.</span><span class="ident" id="5981695">Writer</span><span class="op" id="5981701">,</span>&nbsp;<span class="ident" id="5981703">m</span>&nbsp;<span class="ident" id="5981705">image</span><span class="op" id="5981710">.</span><span class="ident" id="5981711">Image</span><span class="op" id="5981716">)</span>&nbsp;<span class="builtintype" id="5981718">error</span>&nbsp;<span class="op" id="5981724">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981727">var</span>&nbsp;<span class="ident" id="5981731">e</span>&nbsp;<span class="ident" id="5981733">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981742">return</span>&nbsp;<span class="ident" id="5981749">e</span><span class="op" id="5981750">.</span><span class="ident" id="5981751">Encode</span><span class="op" id="5981757">(</span><span class="ident" id="5981758">w</span><span class="op" id="5981759">,</span>&nbsp;<span class="ident" id="5981761">m</span><span class="op" id="5981762">)</span><br>
<span class="lineno"></span><span class="op" id="5981764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5981767">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5981816">func</span>&nbsp;<span class="op" id="5981821">(</span><span class="ident" id="5981822">enc</span>&nbsp;<span class="op" id="5981826">*</span><span class="ident" id="5981827">Encoder</span><span class="op" id="5981834">)</span>&nbsp;<span class="ident" id="5981836">Encode</span><span class="op" id="5981842">(</span><span class="ident" id="5981843">w</span>&nbsp;<span class="ident" id="5981845">io</span><span class="op" id="5981847">.</span><span class="ident" id="5981848">Writer</span><span class="op" id="5981854">,</span>&nbsp;<span class="ident" id="5981856">m</span>&nbsp;<span class="ident" id="5981858">image</span><span class="op" id="5981863">.</span><span class="ident" id="5981864">Image</span><span class="op" id="5981869">)</span>&nbsp;<span class="builtintype" id="5981871">error</span>&nbsp;<span class="op" id="5981877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981880">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981957">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5982037">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982056">mw</span><span class="op" id="5982058">,</span>&nbsp;<span class="ident" id="5982060">mh</span>&nbsp;<span class="op" id="5982063">:=</span>&nbsp;<span class="ident" id="5982066">int64</span><span class="op" id="5982071">(</span><span class="ident" id="5982072">m</span><span class="op" id="5982073">.</span><span class="ident" id="5982074">Bounds</span><span class="op" id="5982080">(</span><span class="op" id="5982081">)</span><span class="op" id="5982082">.</span><span class="ident" id="5982083">Dx</span><span class="op" id="5982085">(</span><span class="op" id="5982086">)</span><span class="op" id="5982087">)</span><span class="op" id="5982088">,</span>&nbsp;<span class="ident" id="5982090">int64</span><span class="op" id="5982095">(</span><span class="ident" id="5982096">m</span><span class="op" id="5982097">.</span><span class="ident" id="5982098">Bounds</span><span class="op" id="5982104">(</span><span class="op" id="5982105">)</span><span class="op" id="5982106">.</span><span class="ident" id="5982107">Dy</span><span class="op" id="5982109">(</span><span class="op" id="5982110">)</span><span class="op" id="5982111">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982114">if</span>&nbsp;<span class="ident" id="5982117">mw</span>&nbsp;<span class="op" id="5982120">&lt;=</span>&nbsp;<span class="num" id="5982123">0</span>&nbsp;<span class="op" id="5982125">||</span>&nbsp;<span class="ident" id="5982128">mh</span>&nbsp;<span class="op" id="5982131">&lt;=</span>&nbsp;<span class="num" id="5982134">0</span>&nbsp;<span class="op" id="5982136">||</span>&nbsp;<span class="ident" id="5982139">mw</span>&nbsp;<span class="op" id="5982142">&gt;=</span>&nbsp;<span class="num" id="5982145">1</span><span class="op" id="5982146">&lt;&lt;</span><span class="num" id="5982148">32</span>&nbsp;<span class="op" id="5982151">||</span>&nbsp;<span class="ident" id="5982154">mh</span>&nbsp;<span class="op" id="5982157">&gt;=</span>&nbsp;<span class="num" id="5982160">1</span><span class="op" id="5982161">&lt;&lt;</span><span class="num" id="5982163">32</span>&nbsp;<span class="op" id="5982166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982170">return</span>&nbsp;<span class="ident" id="5982177">FormatError</span><span class="op" id="5982188">(</span><span class="string" id="5982189">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5982212">+</span>&nbsp;<span class="ident" id="5982214">strconv</span><span class="op" id="5982221">.</span><span class="ident" id="5982222">FormatInt</span><span class="op" id="5982231">(</span><span class="ident" id="5982232">mw</span><span class="op" id="5982234">,</span>&nbsp;<span class="num" id="5982236">10</span><span class="op" id="5982238">)</span>&nbsp;<span class="op" id="5982240">+</span>&nbsp;<span class="string" id="5982242">&#34;x&#34;</span>&nbsp;<span class="op" id="5982246">+</span>&nbsp;<span class="ident" id="5982248">strconv</span><span class="op" id="5982255">.</span><span class="ident" id="5982256">FormatInt</span><span class="op" id="5982265">(</span><span class="ident" id="5982266">mh</span><span class="op" id="5982268">,</span>&nbsp;<span class="num" id="5982270">10</span><span class="op" id="5982272">)</span><span class="op" id="5982273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982280">var</span>&nbsp;<span class="ident" id="5982284">e</span>&nbsp;<span class="ident" id="5982286">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982295">e</span><span class="op" id="5982296">.</span><span class="ident" id="5982297">enc</span>&nbsp;<span class="op" id="5982301">=</span>&nbsp;<span class="ident" id="5982303">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982308">e</span><span class="op" id="5982309">.</span><span class="ident" id="5982310">w</span>&nbsp;<span class="op" id="5982312">=</span>&nbsp;<span class="ident" id="5982314">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982317">e</span><span class="op" id="5982318">.</span><span class="ident" id="5982319">m</span>&nbsp;<span class="op" id="5982321">=</span>&nbsp;<span class="ident" id="5982323">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982327">var</span>&nbsp;<span class="ident" id="5982331">pal</span>&nbsp;<span class="ident" id="5982335">color</span><span class="op" id="5982340">.</span><span class="ident" id="5982341">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5982350">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982411">if</span>&nbsp;<span class="ident" id="5982414">_</span><span class="op" id="5982415">,</span>&nbsp;<span class="ident" id="5982417">ok</span>&nbsp;<span class="op" id="5982420">:=</span>&nbsp;<span class="ident" id="5982423">m</span><span class="op" id="5982424">.</span><span class="op" id="5982425">(</span><span class="ident" id="5982426">image</span><span class="op" id="5982431">.</span><span class="ident" id="5982432">PalettedImage</span><span class="op" id="5982445">)</span><span class="op" id="5982446">;</span>&nbsp;<span class="ident" id="5982448">ok</span>&nbsp;<span class="op" id="5982451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982455">pal</span><span class="op" id="5982458">,</span>&nbsp;<span class="ident" id="5982460">_</span>&nbsp;<span class="op" id="5982462">=</span>&nbsp;<span class="ident" id="5982464">m</span><span class="op" id="5982465">.</span><span class="ident" id="5982466">ColorModel</span><span class="op" id="5982476">(</span><span class="op" id="5982477">)</span><span class="op" id="5982478">.</span><span class="op" id="5982479">(</span><span class="ident" id="5982480">color</span><span class="op" id="5982485">.</span><span class="ident" id="5982486">Palette</span><span class="op" id="5982493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982499">if</span>&nbsp;<span class="ident" id="5982502">pal</span>&nbsp;<span class="op" id="5982506">!=</span>&nbsp;<span class="ident" id="5982509">nil</span>&nbsp;<span class="op" id="5982513">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982517">e</span><span class="op" id="5982518">.</span><span class="ident" id="5982519">cb</span>&nbsp;<span class="op" id="5982522">=</span>&nbsp;<span class="ident" id="5982524">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982530">}</span>&nbsp;<span class="keyword" id="5982532">else</span>&nbsp;<span class="op" id="5982537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982541">switch</span>&nbsp;<span class="ident" id="5982548">m</span><span class="op" id="5982549">.</span><span class="ident" id="5982550">ColorModel</span><span class="op" id="5982560">(</span><span class="op" id="5982561">)</span>&nbsp;<span class="op" id="5982563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982567">case</span>&nbsp;<span class="ident" id="5982572">color</span><span class="op" id="5982577">.</span><span class="ident" id="5982578">GrayModel</span><span class="op" id="5982587">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982592">e</span><span class="op" id="5982593">.</span><span class="ident" id="5982594">cb</span>&nbsp;<span class="op" id="5982597">=</span>&nbsp;<span class="ident" id="5982599">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982606">case</span>&nbsp;<span class="ident" id="5982611">color</span><span class="op" id="5982616">.</span><span class="ident" id="5982617">Gray16Model</span><span class="op" id="5982628">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982633">e</span><span class="op" id="5982634">.</span><span class="ident" id="5982635">cb</span>&nbsp;<span class="op" id="5982638">=</span>&nbsp;<span class="ident" id="5982640">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982648">case</span>&nbsp;<span class="ident" id="5982653">color</span><span class="op" id="5982658">.</span><span class="ident" id="5982659">RGBAModel</span><span class="op" id="5982668">,</span>&nbsp;<span class="ident" id="5982670">color</span><span class="op" id="5982675">.</span><span class="ident" id="5982676">NRGBAModel</span><span class="op" id="5982686">,</span>&nbsp;<span class="ident" id="5982688">color</span><span class="op" id="5982693">.</span><span class="ident" id="5982694">AlphaModel</span><span class="op" id="5982704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982709">if</span>&nbsp;<span class="ident" id="5982712">opaque</span><span class="op" id="5982718">(</span><span class="ident" id="5982719">m</span><span class="op" id="5982720">)</span>&nbsp;<span class="op" id="5982722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982728">e</span><span class="op" id="5982729">.</span><span class="ident" id="5982730">cb</span>&nbsp;<span class="op" id="5982733">=</span>&nbsp;<span class="ident" id="5982735">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982744">}</span>&nbsp;<span class="keyword" id="5982746">else</span>&nbsp;<span class="op" id="5982751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982757">e</span><span class="op" id="5982758">.</span><span class="ident" id="5982759">cb</span>&nbsp;<span class="op" id="5982762">=</span>&nbsp;<span class="ident" id="5982764">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982778">default</span><span class="op" id="5982785">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982790">if</span>&nbsp;<span class="ident" id="5982793">opaque</span><span class="op" id="5982799">(</span><span class="ident" id="5982800">m</span><span class="op" id="5982801">)</span>&nbsp;<span class="op" id="5982803">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982809">e</span><span class="op" id="5982810">.</span><span class="ident" id="5982811">cb</span>&nbsp;<span class="op" id="5982814">=</span>&nbsp;<span class="ident" id="5982816">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982826">}</span>&nbsp;<span class="keyword" id="5982828">else</span>&nbsp;<span class="op" id="5982833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982839">e</span><span class="op" id="5982840">.</span><span class="ident" id="5982841">cb</span>&nbsp;<span class="op" id="5982844">=</span>&nbsp;<span class="ident" id="5982846">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982861">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982868">_</span><span class="op" id="5982869">,</span>&nbsp;<span class="ident" id="5982871">e</span><span class="op" id="5982872">.</span><span class="ident" id="5982873">err</span>&nbsp;<span class="op" id="5982877">=</span>&nbsp;<span class="ident" id="5982879">io</span><span class="op" id="5982881">.</span><span class="ident" id="5982882">WriteString</span><span class="op" id="5982893">(</span><span class="ident" id="5982894">w</span><span class="op" id="5982895">,</span>&nbsp;<span class="ident" id="5982897">pngHeader</span><span class="op" id="5982906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982909">e</span><span class="op" id="5982910">.</span><span class="ident" id="5982911">writeIHDR</span><span class="op" id="5982920">(</span><span class="op" id="5982921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982924">if</span>&nbsp;<span class="ident" id="5982927">pal</span>&nbsp;<span class="op" id="5982931">!=</span>&nbsp;<span class="ident" id="5982934">nil</span>&nbsp;<span class="op" id="5982938">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982942">e</span><span class="op" id="5982943">.</span><span class="ident" id="5982944">writePLTEAndTRNS</span><span class="op" id="5982960">(</span><span class="ident" id="5982961">pal</span><span class="op" id="5982964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982970">e</span><span class="op" id="5982971">.</span><span class="ident" id="5982972">writeIDATs</span><span class="op" id="5982982">(</span><span class="op" id="5982983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982986">e</span><span class="op" id="5982987">.</span><span class="ident" id="5982988">writeIEND</span><span class="op" id="5982997">(</span><span class="op" id="5982998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983001">return</span>&nbsp;<span class="ident" id="5983008">e</span><span class="op" id="5983009">.</span><span class="ident" id="5983010">err</span><br>
<span class="lineno">530</span><span class="op" id="5983014">}</span>
</div>
</body>
</html>
