<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="452742">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="452797">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="452851">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="452902">package</span>&nbsp;<span class="ident" id="452910">http_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="452921">import</span>&nbsp;<span class="op" id="452928">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="452931">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="452940">&#34;crypto/tls&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="452954">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="452961">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="452967">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="452980">.</span>&nbsp;<span class="string" id="452982">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="452994">&#34;net/http/httptest&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="453015">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="453026">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="453036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="453039">func</span>&nbsp;<span class="ident" id="453044">TestNextProtoUpgrade</span><span class="op" id="453064">(</span><span class="ident" id="453065">t</span>&nbsp;<span class="op" id="453067">*</span><span class="ident" id="453068"><a href="/net/http/npn_test.go.html#453026">testing</a></span><span class="op" id="453075">.</span><span class="ident" id="453076">T</span><span class="op" id="453077">)</span>&nbsp;<span class="op" id="453079">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453082">ts</span>&nbsp;<span class="op" id="453085">:=</span>&nbsp;<span class="ident" id="453088"><a href="/net/http/npn_test.go.html#452994">httptest</a></span><span class="op" id="453096">.</span><span class="ident" id="453097">NewUnstartedServer</span><span class="op" id="453115">(</span><span class="ident" id="453116"><a href="/net/http/server.go.html#3861087">HandlerFunc</a></span><span class="op" id="453127">(</span><span class="keyword" id="453128">func</span><span class="op" id="453132">(</span><span class="ident" id="453133">w</span>&nbsp;<span class="ident" id="453135"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="453149">,</span>&nbsp;<span class="ident" id="453151">r</span>&nbsp;<span class="op" id="453153">*</span><span class="ident" id="453154"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="453161">)</span>&nbsp;<span class="op" id="453163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453167"><a href="/net/http/npn_test.go.html#452954">fmt</a></span><span class="op" id="453170">.</span><span class="ident" id="453171">Fprintf</span><span class="op" id="453178">(</span><span class="ident" id="453179"><a href="/net/http/npn_test.go.html#453133">w</a></span><span class="op" id="453180">,</span>&nbsp;<span class="string" id="453182">&#34;path=%s,proto=&#34;</span><span class="op" id="453198">,</span>&nbsp;<span class="ident" id="453200"><a href="/net/http/npn_test.go.html#453151">r</a></span><span class="op" id="453201">.</span><span class="ident" id="453202">URL</span><span class="op" id="453205">.</span><span class="ident" id="453206">Path</span><span class="op" id="453210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453214">if</span>&nbsp;<span class="ident" id="453217"><a href="/net/http/npn_test.go.html#453151">r</a></span><span class="op" id="453218">.</span><span class="ident" id="453219">TLS</span>&nbsp;<span class="op" id="453223">!=</span>&nbsp;<span class="ident" id="453226">nil</span>&nbsp;<span class="op" id="453230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453235"><a href="/net/http/npn_test.go.html#453133">w</a></span><span class="op" id="453236">.</span><span class="ident" id="453237">Write</span><span class="op" id="453242">(</span><span class="op" id="453243">[</span><span class="op" id="453244">]</span><span class="builtintype" id="453245">byte</span><span class="op" id="453249">(</span><span class="ident" id="453250"><a href="/net/http/npn_test.go.html#453151">r</a></span><span class="op" id="453251">.</span><span class="ident" id="453252">TLS</span><span class="op" id="453255">.</span><span class="ident" id="453256">NegotiatedProtocol</span><span class="op" id="453274">)</span><span class="op" id="453275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453279">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453283">if</span>&nbsp;<span class="ident" id="453286"><a href="/net/http/npn_test.go.html#453151">r</a></span><span class="op" id="453287">.</span><span class="ident" id="453288">RemoteAddr</span>&nbsp;<span class="op" id="453299">==</span>&nbsp;<span class="string" id="453302">&#34;&#34;</span>&nbsp;<span class="op" id="453305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453310"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="453311">.</span><span class="ident" id="453312">Error</span><span class="op" id="453317">(</span><span class="string" id="453318">&#34;request&nbsp;with&nbsp;no&nbsp;RemoteAddr&#34;</span><span class="op" id="453346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453354">if</span>&nbsp;<span class="ident" id="453357"><a href="/net/http/npn_test.go.html#453151">r</a></span><span class="op" id="453358">.</span><span class="ident" id="453359">Body</span>&nbsp;<span class="op" id="453364">==</span>&nbsp;<span class="ident" id="453367">nil</span>&nbsp;<span class="op" id="453371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453376"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="453377">.</span><span class="ident" id="453378">Errorf</span><span class="op" id="453384">(</span><span class="string" id="453385">&#34;request&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="453408">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453415">}</span><span class="op" id="453416">)</span><span class="op" id="453417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453420"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="453422">.</span><span class="ident" id="453423">TLS</span>&nbsp;<span class="op" id="453427">=</span>&nbsp;<span class="op" id="453429">&amp;</span><span class="ident" id="453430"><a href="/net/http/npn_test.go.html#452940">tls</a></span><span class="op" id="453433">.</span><span class="ident" id="453434">Config</span><span class="op" id="453440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453444">NextProtos</span><span class="op" id="453454">:</span>&nbsp;<span class="op" id="453456">[</span><span class="op" id="453457">]</span><span class="builtintype" id="453458">string</span><span class="op" id="453464">{</span><span class="string" id="453465">&#34;unhandled-proto&#34;</span><span class="op" id="453482">,</span>&nbsp;<span class="string" id="453484">&#34;tls-0.9&#34;</span><span class="op" id="453493">}</span><span class="op" id="453494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453497">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453500"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="453502">.</span><span class="ident" id="453503">Config</span><span class="op" id="453509">.</span><span class="ident" id="453510">TLSNextProto</span>&nbsp;<span class="op" id="453523">=</span>&nbsp;<span class="keyword" id="453525">map</span><span class="op" id="453528">[</span><span class="builtintype" id="453529">string</span><span class="op" id="453535">]</span><span class="keyword" id="453536">func</span><span class="op" id="453540">(</span><span class="op" id="453541">*</span><span class="ident" id="453542"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="453548">,</span>&nbsp;<span class="op" id="453550">*</span><span class="ident" id="453551"><a href="/net/http/npn_test.go.html#452940">tls</a></span><span class="op" id="453554">.</span><span class="ident" id="453555">Conn</span><span class="op" id="453559">,</span>&nbsp;<span class="ident" id="453561"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="453568">)</span><span class="op" id="453569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="453573">&#34;tls-0.9&#34;</span><span class="op" id="453582">:</span>&nbsp;<span class="ident" id="453584"><a href="/net/http/npn_test.go.html#454967">handleTLSProtocol09</a></span><span class="op" id="453603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453609"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="453611">.</span><span class="ident" id="453612">StartTLS</span><span class="op" id="453620">(</span><span class="op" id="453621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453624">defer</span>&nbsp;<span class="ident" id="453630"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="453632">.</span><span class="ident" id="453633">Close</span><span class="op" id="453638">(</span><span class="op" id="453639">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453643">tr</span>&nbsp;<span class="op" id="453646">:=</span>&nbsp;<span class="ident" id="453649"><a href="/net/http/client_test.go.html#410749">newTLSTransport</a></span><span class="op" id="453664">(</span><span class="ident" id="453665"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="453666">,</span>&nbsp;<span class="ident" id="453668"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="453670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453673">defer</span>&nbsp;<span class="ident" id="453679"><a href="/net/http/npn_test.go.html#453643">tr</a></span><span class="op" id="453681">.</span><span class="ident" id="453682">CloseIdleConnections</span><span class="op" id="453702">(</span><span class="op" id="453703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453706">c</span>&nbsp;<span class="op" id="453708">:=</span>&nbsp;<span class="op" id="453711">&amp;</span><span class="ident" id="453712"><a href="/net/http/client.go.html#3736246">Client</a></span><span class="op" id="453718">{</span><span class="ident" id="453719">Transport</span><span class="op" id="453728">:</span>&nbsp;<span class="ident" id="453730"><a href="/net/http/npn_test.go.html#453643">tr</a></span><span class="op" id="453732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="453736">//&nbsp;Normal&nbsp;request,&nbsp;without&nbsp;NPN.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453773">res</span><span class="op" id="453776">,</span>&nbsp;<span class="ident" id="453778">err</span>&nbsp;<span class="op" id="453782">:=</span>&nbsp;<span class="ident" id="453785"><a href="/net/http/npn_test.go.html#453706">c</a></span><span class="op" id="453786">.</span><span class="ident" id="453787">Get</span><span class="op" id="453790">(</span><span class="ident" id="453791"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="453793">.</span><span class="ident" id="453794">URL</span><span class="op" id="453797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453801">if</span>&nbsp;<span class="ident" id="453804"><a href="/net/http/npn_test.go.html#453778">err</a></span>&nbsp;<span class="op" id="453808">!=</span>&nbsp;<span class="ident" id="453811">nil</span>&nbsp;<span class="op" id="453815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453820"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="453821">.</span><span class="ident" id="453822">Fatal</span><span class="op" id="453827">(</span><span class="ident" id="453828"><a href="/net/http/npn_test.go.html#453778">err</a></span><span class="op" id="453831">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453839">body</span><span class="op" id="453843">,</span>&nbsp;<span class="ident" id="453845"><a href="/net/http/npn_test.go.html#453778">err</a></span>&nbsp;<span class="op" id="453849">:=</span>&nbsp;<span class="ident" id="453852"><a href="/net/http/npn_test.go.html#452967">ioutil</a></span><span class="op" id="453858">.</span><span class="ident" id="453859">ReadAll</span><span class="op" id="453866">(</span><span class="ident" id="453867"><a href="/net/http/npn_test.go.html#453773">res</a></span><span class="op" id="453870">.</span><span class="ident" id="453871">Body</span><span class="op" id="453875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453879">if</span>&nbsp;<span class="ident" id="453882"><a href="/net/http/npn_test.go.html#453778">err</a></span>&nbsp;<span class="op" id="453886">!=</span>&nbsp;<span class="ident" id="453889">nil</span>&nbsp;<span class="op" id="453893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453898"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="453899">.</span><span class="ident" id="453900">Fatal</span><span class="op" id="453905">(</span><span class="ident" id="453906"><a href="/net/http/npn_test.go.html#453778">err</a></span><span class="op" id="453909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="453913">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="453917">if</span>&nbsp;<span class="ident" id="453920">want</span>&nbsp;<span class="op" id="453925">:=</span>&nbsp;<span class="string" id="453928">&#34;path=/,proto=&#34;</span><span class="op" id="453943">;</span>&nbsp;<span class="builtintype" id="453945">string</span><span class="op" id="453951">(</span><span class="ident" id="453952"><a href="/net/http/npn_test.go.html#453839">body</a></span><span class="op" id="453956">)</span>&nbsp;<span class="op" id="453958">!=</span>&nbsp;<span class="ident" id="453961"><a href="/net/http/npn_test.go.html#453920">want</a></span>&nbsp;<span class="op" id="453966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="453971"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="453972">.</span><span class="ident" id="453973">Errorf</span><span class="op" id="453979">(</span><span class="string" id="453980">&#34;plain&nbsp;request&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="454009">,</span>&nbsp;<span class="ident" id="454011"><a href="/net/http/npn_test.go.html#453839">body</a></span><span class="op" id="454015">,</span>&nbsp;<span class="ident" id="454017"><a href="/net/http/npn_test.go.html#453920">want</a></span><span class="op" id="454021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="454032">//&nbsp;Request&nbsp;to&nbsp;an&nbsp;advertised&nbsp;but&nbsp;unhandled&nbsp;NPN&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="454089">//&nbsp;Server&nbsp;will&nbsp;hang&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454118"><a href="/net/http/npn_test.go.html#453643">tr</a></span><span class="op" id="454120">.</span><span class="ident" id="454121">CloseIdleConnections</span><span class="op" id="454141">(</span><span class="op" id="454142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454146"><a href="/net/http/npn_test.go.html#453643">tr</a></span><span class="op" id="454148">.</span><span class="ident" id="454149">TLSClientConfig</span><span class="op" id="454164">.</span><span class="ident" id="454165">NextProtos</span>&nbsp;<span class="op" id="454176">=</span>&nbsp;<span class="op" id="454178">[</span><span class="op" id="454179">]</span><span class="builtintype" id="454180">string</span><span class="op" id="454186">{</span><span class="string" id="454187">&#34;unhandled-proto&#34;</span><span class="op" id="454204">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454208">_</span><span class="op" id="454209">,</span>&nbsp;<span class="ident" id="454211">err</span>&nbsp;<span class="op" id="454215">:=</span>&nbsp;<span class="ident" id="454218"><a href="/net/http/npn_test.go.html#453706">c</a></span><span class="op" id="454219">.</span><span class="ident" id="454220">Get</span><span class="op" id="454223">(</span><span class="ident" id="454224"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="454226">.</span><span class="ident" id="454227">URL</span><span class="op" id="454230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="454234">if</span>&nbsp;<span class="ident" id="454237"><a href="/net/http/npn_test.go.html#454211">err</a></span>&nbsp;<span class="op" id="454241">==</span>&nbsp;<span class="ident" id="454244">nil</span>&nbsp;<span class="op" id="454248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454253"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="454254">.</span><span class="ident" id="454255">Errorf</span><span class="op" id="454261">(</span><span class="string" id="454262">&#34;expected&nbsp;error&nbsp;on&nbsp;unhandled-proto&nbsp;request&#34;</span><span class="op" id="454305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454312">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="454316">//&nbsp;Request&nbsp;using&nbsp;the&nbsp;&#34;tls-0.9&#34;&nbsp;protocol,&nbsp;which&nbsp;we&nbsp;register&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="454382">//&nbsp;It&nbsp;is&nbsp;HTTP/0.9&nbsp;over&nbsp;TLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454415">tlsConfig</span>&nbsp;<span class="op" id="454425">:=</span>&nbsp;<span class="ident" id="454428"><a href="/net/http/client_test.go.html#410749">newTLSTransport</a></span><span class="op" id="454443">(</span><span class="ident" id="454444"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="454445">,</span>&nbsp;<span class="ident" id="454447"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="454449">)</span><span class="op" id="454450">.</span><span class="ident" id="454451">TLSClientConfig</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454469"><a href="/net/http/npn_test.go.html#454415">tlsConfig</a></span><span class="op" id="454478">.</span><span class="ident" id="454479">NextProtos</span>&nbsp;<span class="op" id="454490">=</span>&nbsp;<span class="op" id="454492">[</span><span class="op" id="454493">]</span><span class="builtintype" id="454494">string</span><span class="op" id="454500">{</span><span class="string" id="454501">&#34;tls-0.9&#34;</span><span class="op" id="454510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454514">conn</span><span class="op" id="454518">,</span>&nbsp;<span class="ident" id="454520">err</span>&nbsp;<span class="op" id="454524">:=</span>&nbsp;<span class="ident" id="454527"><a href="/net/http/npn_test.go.html#452940">tls</a></span><span class="op" id="454530">.</span><span class="ident" id="454531">Dial</span><span class="op" id="454535">(</span><span class="string" id="454536">&#34;tcp&#34;</span><span class="op" id="454541">,</span>&nbsp;<span class="ident" id="454543"><a href="/net/http/npn_test.go.html#453082">ts</a></span><span class="op" id="454545">.</span><span class="ident" id="454546">Listener</span><span class="op" id="454554">.</span><span class="ident" id="454555">Addr</span><span class="op" id="454559">(</span><span class="op" id="454560">)</span><span class="op" id="454561">.</span><span class="ident" id="454562">String</span><span class="op" id="454568">(</span><span class="op" id="454569">)</span><span class="op" id="454570">,</span>&nbsp;<span class="ident" id="454572"><a href="/net/http/npn_test.go.html#454415">tlsConfig</a></span><span class="op" id="454581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="454585">if</span>&nbsp;<span class="ident" id="454588"><a href="/net/http/npn_test.go.html#454520">err</a></span>&nbsp;<span class="op" id="454592">!=</span>&nbsp;<span class="ident" id="454595">nil</span>&nbsp;<span class="op" id="454599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454604"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="454605">.</span><span class="ident" id="454606">Fatal</span><span class="op" id="454611">(</span><span class="ident" id="454612"><a href="/net/http/npn_test.go.html#454520">err</a></span><span class="op" id="454615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454619">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454623"><a href="/net/http/npn_test.go.html#454514">conn</a></span><span class="op" id="454627">.</span><span class="ident" id="454628">Write</span><span class="op" id="454633">(</span><span class="op" id="454634">[</span><span class="op" id="454635">]</span><span class="builtintype" id="454636">byte</span><span class="op" id="454640">(</span><span class="string" id="454641">&#34;GET&nbsp;/foo\n&#34;</span><span class="op" id="454653">)</span><span class="op" id="454654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454658">body</span><span class="op" id="454662">,</span>&nbsp;<span class="ident" id="454664"><a href="/net/http/npn_test.go.html#454520">err</a></span>&nbsp;<span class="op" id="454668">:=</span>&nbsp;<span class="ident" id="454671"><a href="/net/http/npn_test.go.html#452967">ioutil</a></span><span class="op" id="454677">.</span><span class="ident" id="454678">ReadAll</span><span class="op" id="454685">(</span><span class="ident" id="454686"><a href="/net/http/npn_test.go.html#454514">conn</a></span><span class="op" id="454690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="454694">if</span>&nbsp;<span class="ident" id="454697"><a href="/net/http/npn_test.go.html#454520">err</a></span>&nbsp;<span class="op" id="454701">!=</span>&nbsp;<span class="ident" id="454704">nil</span>&nbsp;<span class="op" id="454708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454713"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="454714">.</span><span class="ident" id="454715">Fatal</span><span class="op" id="454720">(</span><span class="ident" id="454721"><a href="/net/http/npn_test.go.html#454520">err</a></span><span class="op" id="454724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454728">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="454732">if</span>&nbsp;<span class="ident" id="454735">want</span>&nbsp;<span class="op" id="454740">:=</span>&nbsp;<span class="string" id="454743">&#34;path=/foo,proto=tls-0.9&#34;</span><span class="op" id="454768">;</span>&nbsp;<span class="builtintype" id="454770">string</span><span class="op" id="454776">(</span><span class="ident" id="454777"><a href="/net/http/npn_test.go.html#454658">body</a></span><span class="op" id="454781">)</span>&nbsp;<span class="op" id="454783">!=</span>&nbsp;<span class="ident" id="454786"><a href="/net/http/npn_test.go.html#454735">want</a></span>&nbsp;<span class="op" id="454791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="454796"><a href="/net/http/npn_test.go.html#453065">t</a></span><span class="op" id="454797">.</span><span class="ident" id="454798">Errorf</span><span class="op" id="454804">(</span><span class="string" id="454805">&#34;plain&nbsp;request&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="454834">,</span>&nbsp;<span class="ident" id="454836"><a href="/net/http/npn_test.go.html#454658">body</a></span><span class="op" id="454840">,</span>&nbsp;<span class="ident" id="454842"><a href="/net/http/npn_test.go.html#454735">want</a></span><span class="op" id="454846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="454853">}</span><br>
<span class="lineno"></span><span class="op" id="454855">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="454858">//&nbsp;handleTLSProtocol09&nbsp;implements&nbsp;the&nbsp;HTTP/0.9&nbsp;protocol&nbsp;over&nbsp;TLS,&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="454932">//&nbsp;TestNextProtoUpgrade&nbsp;test.</span><br>
<span class="lineno"></span><span class="keyword" id="454962">func</span>&nbsp;<span class="ident" id="454967">handleTLSProtocol09</span><span class="op" id="454986">(</span><span class="ident" id="454987">srv</span>&nbsp;<span class="op" id="454991">*</span><span class="ident" id="454992"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="454998">,</span>&nbsp;<span class="ident" id="455000">conn</span>&nbsp;<span class="op" id="455005">*</span><span class="ident" id="455006"><a href="/net/http/npn_test.go.html#452940">tls</a></span><span class="op" id="455009">.</span><span class="ident" id="455010">Conn</span><span class="op" id="455014">,</span>&nbsp;<span class="ident" id="455016">h</span>&nbsp;<span class="ident" id="455018"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="455025">)</span>&nbsp;<span class="op" id="455027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455030">br</span>&nbsp;<span class="op" id="455033">:=</span>&nbsp;<span class="ident" id="455036"><a href="/net/http/npn_test.go.html#452931">bufio</a></span><span class="op" id="455041">.</span><span class="ident" id="455042">NewReader</span><span class="op" id="455051">(</span><span class="ident" id="455052"><a href="/net/http/npn_test.go.html#455000">conn</a></span><span class="op" id="455056">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455059">line</span><span class="op" id="455063">,</span>&nbsp;<span class="ident" id="455065">err</span>&nbsp;<span class="op" id="455069">:=</span>&nbsp;<span class="ident" id="455072"><a href="/net/http/npn_test.go.html#455030">br</a></span><span class="op" id="455074">.</span><span class="ident" id="455075">ReadString</span><span class="op" id="455085">(</span><span class="string" id="455086">&#39;\n&#39;</span><span class="op" id="455090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="455093">if</span>&nbsp;<span class="ident" id="455096"><a href="/net/http/npn_test.go.html#455065">err</a></span>&nbsp;<span class="op" id="455100">!=</span>&nbsp;<span class="ident" id="455103">nil</span>&nbsp;<span class="op" id="455107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="455111">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="455119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455122"><a href="/net/http/npn_test.go.html#455059">line</a></span>&nbsp;<span class="op" id="455127">=</span>&nbsp;<span class="ident" id="455129"><a href="/net/http/npn_test.go.html#453015">strings</a></span><span class="op" id="455136">.</span><span class="ident" id="455137">TrimSpace</span><span class="op" id="455146">(</span><span class="ident" id="455147"><a href="/net/http/npn_test.go.html#455059">line</a></span><span class="op" id="455151">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455154">path</span>&nbsp;<span class="op" id="455159">:=</span>&nbsp;<span class="ident" id="455162"><a href="/net/http/npn_test.go.html#453015">strings</a></span><span class="op" id="455169">.</span><span class="ident" id="455170">TrimPrefix</span><span class="op" id="455180">(</span><span class="ident" id="455181"><a href="/net/http/npn_test.go.html#455059">line</a></span><span class="op" id="455185">,</span>&nbsp;<span class="string" id="455187">&#34;GET&nbsp;&#34;</span><span class="op" id="455193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="455196">if</span>&nbsp;<span class="ident" id="455199"><a href="/net/http/npn_test.go.html#455154">path</a></span>&nbsp;<span class="op" id="455204">==</span>&nbsp;<span class="ident" id="455207"><a href="/net/http/npn_test.go.html#455059">line</a></span>&nbsp;<span class="op" id="455212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="455216">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="455224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455227">req</span><span class="op" id="455230">,</span>&nbsp;<span class="ident" id="455232">_</span>&nbsp;<span class="op" id="455234">:=</span>&nbsp;<span class="ident" id="455237"><a href="/net/http/request.go.html#3804993">NewRequest</a></span><span class="op" id="455247">(</span><span class="string" id="455248">&#34;GET&#34;</span><span class="op" id="455253">,</span>&nbsp;<span class="ident" id="455255"><a href="/net/http/npn_test.go.html#455154">path</a></span><span class="op" id="455259">,</span>&nbsp;<span class="ident" id="455261">nil</span><span class="op" id="455264">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455267"><a href="/net/http/npn_test.go.html#455227">req</a></span><span class="op" id="455270">.</span><span class="ident" id="455271">Proto</span>&nbsp;<span class="op" id="455277">=</span>&nbsp;<span class="string" id="455279">&#34;HTTP/0.9&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455291"><a href="/net/http/npn_test.go.html#455227">req</a></span><span class="op" id="455294">.</span><span class="ident" id="455295">ProtoMajor</span>&nbsp;<span class="op" id="455306">=</span>&nbsp;<span class="num" id="455308">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455311"><a href="/net/http/npn_test.go.html#455227">req</a></span><span class="op" id="455314">.</span><span class="ident" id="455315">ProtoMinor</span>&nbsp;<span class="op" id="455326">=</span>&nbsp;<span class="num" id="455328">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455331">rw</span>&nbsp;<span class="op" id="455334">:=</span>&nbsp;<span class="op" id="455337">&amp;</span><span class="ident" id="455338"><a href="/net/http/npn_test.go.html#455401">http09Writer</a></span><span class="op" id="455350">{</span><span class="ident" id="455351"><a href="/net/http/npn_test.go.html#455000">conn</a></span><span class="op" id="455355">,</span>&nbsp;<span class="builtinfunc" id="455357">make</span><span class="op" id="455361">(</span><span class="ident" id="455362"><a href="/net/http/header.go.html#3781581">Header</a></span><span class="op" id="455368">)</span><span class="op" id="455369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455372"><a href="/net/http/npn_test.go.html#455016">h</a></span><span class="op" id="455373">.</span><span class="ident" id="455374">ServeHTTP</span><span class="op" id="455383">(</span><span class="ident" id="455384"><a href="/net/http/npn_test.go.html#455331">rw</a></span><span class="op" id="455386">,</span>&nbsp;<span class="ident" id="455388"><a href="/net/http/npn_test.go.html#455227">req</a></span><span class="op" id="455391">)</span><br>
<span class="lineno">110</span><span class="op" id="455393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="455396">type</span>&nbsp;<span class="ident" id="455401">http09Writer</span>&nbsp;<span class="keyword" id="455414">struct</span>&nbsp;<span class="op" id="455421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455424"><a href="/net/http/npn_test.go.html#452961">io</a></span><span class="op" id="455426">.</span><span class="ident" id="455427">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="455435">h</span>&nbsp;<span class="ident" id="455437"><a href="/net/http/header.go.html#3781581">Header</a></span><br>
<span class="lineno">115</span><span class="op" id="455444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="455447">func</span>&nbsp;<span class="op" id="455452">(</span><span class="ident" id="455453">w</span>&nbsp;<span class="ident" id="455455"><a href="/net/http/npn_test.go.html#455401">http09Writer</a></span><span class="op" id="455467">)</span>&nbsp;<span class="ident" id="455469">Header</span><span class="op" id="455475">(</span><span class="op" id="455476">)</span>&nbsp;<span class="ident" id="455478"><a href="/net/http/header.go.html#3781581">Header</a></span>&nbsp;&nbsp;<span class="op" id="455486">{</span>&nbsp;<span class="keyword" id="455488">return</span>&nbsp;<span class="ident" id="455495"><a href="/net/http/npn_test.go.html#455453">w</a></span><span class="op" id="455496">.</span><span class="ident" id="455497">h</span>&nbsp;<span class="op" id="455499">}</span><br>
<span class="lineno"></span><span class="keyword" id="455501">func</span>&nbsp;<span class="op" id="455506">(</span><span class="ident" id="455507">w</span>&nbsp;<span class="ident" id="455509"><a href="/net/http/npn_test.go.html#455401">http09Writer</a></span><span class="op" id="455521">)</span>&nbsp;<span class="ident" id="455523">WriteHeader</span><span class="op" id="455534">(</span><span class="builtintype" id="455535">int</span><span class="op" id="455538">)</span>&nbsp;<span class="op" id="455540">{</span><span class="op" id="455541">}</span>&nbsp;<span class="comment" id="455543">//&nbsp;no&nbsp;headers</span>
</div>
</body>
</html>
