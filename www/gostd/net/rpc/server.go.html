<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4985633">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4985688">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4985742">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4985793">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4989622">package</span>&nbsp;<span class="ident" id="4989630">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4989635">import</span>&nbsp;<span class="op" id="4989642">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989645">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989654">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989670">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989680">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989686">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989693">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989700">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989712">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989723">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989734">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989742">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4989753">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4989768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4989771">const</span>&nbsp;<span class="op" id="4989777">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4989780">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989812">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4989829">=</span>&nbsp;<span class="string" id="4989831">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989843">DefaultDebugPath</span>&nbsp;<span class="op" id="4989860">=</span>&nbsp;<span class="string" id="4989862">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="4989875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4989878">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="4989946">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="4990015">var</span>&nbsp;<span class="ident" id="4990019">typeOfError</span>&nbsp;<span class="op" id="4990031">=</span>&nbsp;<span class="ident" id="4990033">reflect</span><span class="op" id="4990040">.</span><span class="ident" id="4990041">TypeOf</span><span class="op" id="4990047">(</span><span class="op" id="4990048">(</span><span class="op" id="4990049">*</span><span class="builtintype" id="4990050">error</span><span class="op" id="4990055">)</span><span class="op" id="4990056">(</span><span class="ident" id="4990057">nil</span><span class="op" id="4990060">)</span><span class="op" id="4990061">)</span><span class="op" id="4990062">.</span><span class="ident" id="4990063">Elem</span><span class="op" id="4990067">(</span><span class="op" id="4990068">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4990071">type</span>&nbsp;<span class="ident" id="4990076">methodType</span>&nbsp;<span class="keyword" id="4990087">struct</span>&nbsp;<span class="op" id="4990094">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990097">sync</span><span class="op" id="4990101">.</span><span class="ident" id="4990102">Mutex</span>&nbsp;<span class="comment" id="4990108">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990130">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990141">reflect</span><span class="op" id="4990148">.</span><span class="ident" id="4990149">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990157">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990168">reflect</span><span class="op" id="4990175">.</span><span class="ident" id="4990176">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990182">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="4990193">reflect</span><span class="op" id="4990200">.</span><span class="ident" id="4990201">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990207">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990218">uint</span><br>
<span class="lineno">155</span><span class="op" id="4990223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4990226">type</span>&nbsp;<span class="ident" id="4990231">service</span>&nbsp;<span class="keyword" id="4990239">struct</span>&nbsp;<span class="op" id="4990246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990249">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990256">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4990279">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990299">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4990306">reflect</span><span class="op" id="4990313">.</span><span class="ident" id="4990314">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4990329">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990369">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990376">reflect</span><span class="op" id="4990383">.</span><span class="ident" id="4990384">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4990399">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990424">method</span>&nbsp;<span class="keyword" id="4990431">map</span><span class="op" id="4990434">[</span><span class="builtintype" id="4990435">string</span><span class="op" id="4990441">]</span><span class="op" id="4990442">*</span><span class="ident" id="4990443">methodType</span>&nbsp;<span class="comment" id="4990454">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="4990476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4990479">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="4990556">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="4990626">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="4990646">type</span>&nbsp;<span class="ident" id="4990651">Request</span>&nbsp;<span class="keyword" id="4990659">struct</span>&nbsp;<span class="op" id="4990666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990669">ServiceMethod</span>&nbsp;<span class="builtintype" id="4990683">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4990692">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990721">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990735">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4990744">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990781">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4990795">*</span><span class="ident" id="4990796">Request</span>&nbsp;<span class="comment" id="4990804">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="4990831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4990834">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="4990914">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="4990984">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="4991004">type</span>&nbsp;<span class="ident" id="4991009">Response</span>&nbsp;<span class="keyword" id="4991018">struct</span>&nbsp;<span class="op" id="4991025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991028">ServiceMethod</span>&nbsp;<span class="builtintype" id="4991042">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4991052">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991083">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991097">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4991107">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991138">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4991152">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4991162">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991181">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991195">*</span><span class="ident" id="4991196">Response</span>&nbsp;<span class="comment" id="4991205">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="4991232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991235">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4991271">type</span>&nbsp;<span class="ident" id="4991276">Server</span>&nbsp;<span class="keyword" id="4991283">struct</span>&nbsp;<span class="op" id="4991290">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991293">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991304">sync</span><span class="op" id="4991308">.</span><span class="ident" id="4991309">RWMutex</span>&nbsp;<span class="comment" id="4991317">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991345">serviceMap</span>&nbsp;<span class="keyword" id="4991356">map</span><span class="op" id="4991359">[</span><span class="builtintype" id="4991360">string</span><span class="op" id="4991366">]</span><span class="op" id="4991367">*</span><span class="ident" id="4991368">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991377">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4991388">sync</span><span class="op" id="4991392">.</span><span class="ident" id="4991393">Mutex</span>&nbsp;<span class="comment" id="4991399">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991420">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4991431">*</span><span class="ident" id="4991432">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991441">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4991452">sync</span><span class="op" id="4991456">.</span><span class="ident" id="4991457">Mutex</span>&nbsp;<span class="comment" id="4991463">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991485">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4991496">*</span><span class="ident" id="4991497">Response</span><br>
<span class="lineno"></span><span class="op" id="4991506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991509">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4991544">func</span>&nbsp;<span class="ident" id="4991549">NewServer</span><span class="op" id="4991558">(</span><span class="op" id="4991559">)</span>&nbsp;<span class="op" id="4991561">*</span><span class="ident" id="4991562">Server</span>&nbsp;<span class="op" id="4991569">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991572">return</span>&nbsp;<span class="op" id="4991579">&amp;</span><span class="ident" id="4991580">Server</span><span class="op" id="4991586">{</span><span class="ident" id="4991587">serviceMap</span><span class="op" id="4991597">:</span>&nbsp;<span class="builtinfunc" id="4991599">make</span><span class="op" id="4991603">(</span><span class="keyword" id="4991604">map</span><span class="op" id="4991607">[</span><span class="builtintype" id="4991608">string</span><span class="op" id="4991614">]</span><span class="op" id="4991615">*</span><span class="ident" id="4991616">service</span><span class="op" id="4991623">)</span><span class="op" id="4991624">}</span><br>
<span class="lineno"></span><span class="op" id="4991626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991629">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4991682">var</span>&nbsp;<span class="ident" id="4991686">DefaultServer</span>&nbsp;<span class="op" id="4991700">=</span>&nbsp;<span class="ident" id="4991702">NewServer</span><span class="op" id="4991711">(</span><span class="op" id="4991712">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4991715">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="4991759">func</span>&nbsp;<span class="ident" id="4991764">isExported</span><span class="op" id="4991774">(</span><span class="ident" id="4991775">name</span>&nbsp;<span class="builtintype" id="4991780">string</span><span class="op" id="4991786">)</span>&nbsp;<span class="builtintype" id="4991788">bool</span>&nbsp;<span class="op" id="4991793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4991796">rune</span><span class="op" id="4991800">,</span>&nbsp;<span class="ident" id="4991802">_</span>&nbsp;<span class="op" id="4991804">:=</span>&nbsp;<span class="ident" id="4991807">utf8</span><span class="op" id="4991811">.</span><span class="ident" id="4991812">DecodeRuneInString</span><span class="op" id="4991830">(</span><span class="ident" id="4991831">name</span><span class="op" id="4991835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991838">return</span>&nbsp;<span class="ident" id="4991845">unicode</span><span class="op" id="4991852">.</span><span class="ident" id="4991853">IsUpper</span><span class="op" id="4991860">(</span><span class="builtintype" id="4991861">rune</span><span class="op" id="4991865">)</span><br>
<span class="lineno">205</span><span class="op" id="4991867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991870">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="4991909">func</span>&nbsp;<span class="ident" id="4991914">isExportedOrBuiltinType</span><span class="op" id="4991937">(</span><span class="ident" id="4991938">t</span>&nbsp;<span class="ident" id="4991940">reflect</span><span class="op" id="4991947">.</span><span class="ident" id="4991948">Type</span><span class="op" id="4991952">)</span>&nbsp;<span class="builtintype" id="4991954">bool</span>&nbsp;<span class="op" id="4991959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991962">for</span>&nbsp;<span class="ident" id="4991966">t</span><span class="op" id="4991967">.</span><span class="ident" id="4991968">Kind</span><span class="op" id="4991972">(</span><span class="op" id="4991973">)</span>&nbsp;<span class="op" id="4991975">==</span>&nbsp;<span class="ident" id="4991978">reflect</span><span class="op" id="4991985">.</span><span class="ident" id="4991986">Ptr</span>&nbsp;<span class="op" id="4991990">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991994">t</span>&nbsp;<span class="op" id="4991996">=</span>&nbsp;<span class="ident" id="4991998">t</span><span class="op" id="4991999">.</span><span class="ident" id="4992000">Elem</span><span class="op" id="4992004">(</span><span class="op" id="4992005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992011">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992068">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992115">return</span>&nbsp;<span class="ident" id="4992122">isExported</span><span class="op" id="4992132">(</span><span class="ident" id="4992133">t</span><span class="op" id="4992134">.</span><span class="ident" id="4992135">Name</span><span class="op" id="4992139">(</span><span class="op" id="4992140">)</span><span class="op" id="4992141">)</span>&nbsp;<span class="op" id="4992143">||</span>&nbsp;<span class="ident" id="4992146">t</span><span class="op" id="4992147">.</span><span class="ident" id="4992148">PkgPath</span><span class="op" id="4992155">(</span><span class="op" id="4992156">)</span>&nbsp;<span class="op" id="4992158">==</span>&nbsp;<span class="string" id="4992161">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="4992164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4992167">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4992229">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="4992286">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="4992307">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4992349">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="4992387">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4992424">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4992494">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="4992560">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="4992637">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4992684">func</span>&nbsp;<span class="op" id="4992689">(</span><span class="ident" id="4992690">server</span>&nbsp;<span class="op" id="4992697">*</span><span class="ident" id="4992698">Server</span><span class="op" id="4992704">)</span>&nbsp;<span class="ident" id="4992706">Register</span><span class="op" id="4992714">(</span><span class="ident" id="4992715">rcvr</span>&nbsp;<span class="keyword" id="4992720">interface</span><span class="op" id="4992729">{</span><span class="op" id="4992730">}</span><span class="op" id="4992731">)</span>&nbsp;<span class="builtintype" id="4992733">error</span>&nbsp;<span class="op" id="4992739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992742">return</span>&nbsp;<span class="ident" id="4992749">server</span><span class="op" id="4992755">.</span><span class="ident" id="4992756">register</span><span class="op" id="4992764">(</span><span class="ident" id="4992765">rcvr</span><span class="op" id="4992769">,</span>&nbsp;<span class="string" id="4992771">&#34;&#34;</span><span class="op" id="4992773">,</span>&nbsp;<span class="builtintype" id="4992775">false</span><span class="op" id="4992780">)</span><br>
<span class="lineno"></span><span class="op" id="4992782">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4992785">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4992858">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4992902">func</span>&nbsp;<span class="op" id="4992907">(</span><span class="ident" id="4992908">server</span>&nbsp;<span class="op" id="4992915">*</span><span class="ident" id="4992916">Server</span><span class="op" id="4992922">)</span>&nbsp;<span class="ident" id="4992924">RegisterName</span><span class="op" id="4992936">(</span><span class="ident" id="4992937">name</span>&nbsp;<span class="builtintype" id="4992942">string</span><span class="op" id="4992948">,</span>&nbsp;<span class="ident" id="4992950">rcvr</span>&nbsp;<span class="keyword" id="4992955">interface</span><span class="op" id="4992964">{</span><span class="op" id="4992965">}</span><span class="op" id="4992966">)</span>&nbsp;<span class="builtintype" id="4992968">error</span>&nbsp;<span class="op" id="4992974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992977">return</span>&nbsp;<span class="ident" id="4992984">server</span><span class="op" id="4992990">.</span><span class="ident" id="4992991">register</span><span class="op" id="4992999">(</span><span class="ident" id="4993000">rcvr</span><span class="op" id="4993004">,</span>&nbsp;<span class="ident" id="4993006">name</span><span class="op" id="4993010">,</span>&nbsp;<span class="builtintype" id="4993012">true</span><span class="op" id="4993016">)</span><br>
<span class="lineno">235</span><span class="op" id="4993018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4993021">func</span>&nbsp;<span class="op" id="4993026">(</span><span class="ident" id="4993027">server</span>&nbsp;<span class="op" id="4993034">*</span><span class="ident" id="4993035">Server</span><span class="op" id="4993041">)</span>&nbsp;<span class="ident" id="4993043">register</span><span class="op" id="4993051">(</span><span class="ident" id="4993052">rcvr</span>&nbsp;<span class="keyword" id="4993057">interface</span><span class="op" id="4993066">{</span><span class="op" id="4993067">}</span><span class="op" id="4993068">,</span>&nbsp;<span class="ident" id="4993070">name</span>&nbsp;<span class="builtintype" id="4993075">string</span><span class="op" id="4993081">,</span>&nbsp;<span class="ident" id="4993083">useName</span>&nbsp;<span class="builtintype" id="4993091">bool</span><span class="op" id="4993095">)</span>&nbsp;<span class="builtintype" id="4993097">error</span>&nbsp;<span class="op" id="4993103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993106">server</span><span class="op" id="4993112">.</span><span class="ident" id="4993113">mu</span><span class="op" id="4993115">.</span><span class="ident" id="4993116">Lock</span><span class="op" id="4993120">(</span><span class="op" id="4993121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993124">defer</span>&nbsp;<span class="ident" id="4993130">server</span><span class="op" id="4993136">.</span><span class="ident" id="4993137">mu</span><span class="op" id="4993139">.</span><span class="ident" id="4993140">Unlock</span><span class="op" id="4993146">(</span><span class="op" id="4993147">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993150">if</span>&nbsp;<span class="ident" id="4993153">server</span><span class="op" id="4993159">.</span><span class="ident" id="4993160">serviceMap</span>&nbsp;<span class="op" id="4993171">==</span>&nbsp;<span class="ident" id="4993174">nil</span>&nbsp;<span class="op" id="4993178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993182">server</span><span class="op" id="4993188">.</span><span class="ident" id="4993189">serviceMap</span>&nbsp;<span class="op" id="4993200">=</span>&nbsp;<span class="builtinfunc" id="4993202">make</span><span class="op" id="4993206">(</span><span class="keyword" id="4993207">map</span><span class="op" id="4993210">[</span><span class="builtintype" id="4993211">string</span><span class="op" id="4993217">]</span><span class="op" id="4993218">*</span><span class="ident" id="4993219">service</span><span class="op" id="4993226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993232">s</span>&nbsp;<span class="op" id="4993234">:=</span>&nbsp;<span class="builtinfunc" id="4993237">new</span><span class="op" id="4993240">(</span><span class="ident" id="4993241">service</span><span class="op" id="4993248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993251">s</span><span class="op" id="4993252">.</span><span class="ident" id="4993253">typ</span>&nbsp;<span class="op" id="4993257">=</span>&nbsp;<span class="ident" id="4993259">reflect</span><span class="op" id="4993266">.</span><span class="ident" id="4993267">TypeOf</span><span class="op" id="4993273">(</span><span class="ident" id="4993274">rcvr</span><span class="op" id="4993278">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993281">s</span><span class="op" id="4993282">.</span><span class="ident" id="4993283">rcvr</span>&nbsp;<span class="op" id="4993288">=</span>&nbsp;<span class="ident" id="4993290">reflect</span><span class="op" id="4993297">.</span><span class="ident" id="4993298">ValueOf</span><span class="op" id="4993305">(</span><span class="ident" id="4993306">rcvr</span><span class="op" id="4993310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993313">sname</span>&nbsp;<span class="op" id="4993319">:=</span>&nbsp;<span class="ident" id="4993322">reflect</span><span class="op" id="4993329">.</span><span class="ident" id="4993330">Indirect</span><span class="op" id="4993338">(</span><span class="ident" id="4993339">s</span><span class="op" id="4993340">.</span><span class="ident" id="4993341">rcvr</span><span class="op" id="4993345">)</span><span class="op" id="4993346">.</span><span class="ident" id="4993347">Type</span><span class="op" id="4993351">(</span><span class="op" id="4993352">)</span><span class="op" id="4993353">.</span><span class="ident" id="4993354">Name</span><span class="op" id="4993358">(</span><span class="op" id="4993359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993362">if</span>&nbsp;<span class="ident" id="4993365">useName</span>&nbsp;<span class="op" id="4993373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993377">sname</span>&nbsp;<span class="op" id="4993383">=</span>&nbsp;<span class="ident" id="4993385">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993391">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993394">if</span>&nbsp;<span class="ident" id="4993397">sname</span>&nbsp;<span class="op" id="4993403">==</span>&nbsp;<span class="string" id="4993406">&#34;&#34;</span>&nbsp;<span class="op" id="4993409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993413">s</span>&nbsp;<span class="op" id="4993415">:=</span>&nbsp;<span class="string" id="4993418">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4993460">+</span>&nbsp;<span class="ident" id="4993462">s</span><span class="op" id="4993463">.</span><span class="ident" id="4993464">typ</span><span class="op" id="4993467">.</span><span class="ident" id="4993468">String</span><span class="op" id="4993474">(</span><span class="op" id="4993475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993479">log</span><span class="op" id="4993482">.</span><span class="ident" id="4993483">Print</span><span class="op" id="4993488">(</span><span class="ident" id="4993489">s</span><span class="op" id="4993490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993494">return</span>&nbsp;<span class="ident" id="4993501">errors</span><span class="op" id="4993507">.</span><span class="ident" id="4993508">New</span><span class="op" id="4993511">(</span><span class="ident" id="4993512">s</span><span class="op" id="4993513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993516">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993519">if</span>&nbsp;<span class="op" id="4993522">!</span><span class="ident" id="4993523">isExported</span><span class="op" id="4993533">(</span><span class="ident" id="4993534">sname</span><span class="op" id="4993539">)</span>&nbsp;<span class="op" id="4993541">&amp;&amp;</span>&nbsp;<span class="op" id="4993544">!</span><span class="ident" id="4993545">useName</span>&nbsp;<span class="op" id="4993553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993557">s</span>&nbsp;<span class="op" id="4993559">:=</span>&nbsp;<span class="string" id="4993562">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4993584">+</span>&nbsp;<span class="ident" id="4993586">sname</span>&nbsp;<span class="op" id="4993592">+</span>&nbsp;<span class="string" id="4993594">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993615">log</span><span class="op" id="4993618">.</span><span class="ident" id="4993619">Print</span><span class="op" id="4993624">(</span><span class="ident" id="4993625">s</span><span class="op" id="4993626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993630">return</span>&nbsp;<span class="ident" id="4993637">errors</span><span class="op" id="4993643">.</span><span class="ident" id="4993644">New</span><span class="op" id="4993647">(</span><span class="ident" id="4993648">s</span><span class="op" id="4993649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993652">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993655">if</span>&nbsp;<span class="ident" id="4993658">_</span><span class="op" id="4993659">,</span>&nbsp;<span class="ident" id="4993661">present</span>&nbsp;<span class="op" id="4993669">:=</span>&nbsp;<span class="ident" id="4993672">server</span><span class="op" id="4993678">.</span><span class="ident" id="4993679">serviceMap</span><span class="op" id="4993689">[</span><span class="ident" id="4993690">sname</span><span class="op" id="4993695">]</span><span class="op" id="4993696">;</span>&nbsp;<span class="ident" id="4993698">present</span>&nbsp;<span class="op" id="4993706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993710">return</span>&nbsp;<span class="ident" id="4993717">errors</span><span class="op" id="4993723">.</span><span class="ident" id="4993724">New</span><span class="op" id="4993727">(</span><span class="string" id="4993728">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="4993761">+</span>&nbsp;<span class="ident" id="4993763">sname</span><span class="op" id="4993768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993774">s</span><span class="op" id="4993775">.</span><span class="ident" id="4993776">name</span>&nbsp;<span class="op" id="4993781">=</span>&nbsp;<span class="ident" id="4993783">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993791">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993815">s</span><span class="op" id="4993816">.</span><span class="ident" id="4993817">method</span>&nbsp;<span class="op" id="4993824">=</span>&nbsp;<span class="ident" id="4993826">suitableMethods</span><span class="op" id="4993841">(</span><span class="ident" id="4993842">s</span><span class="op" id="4993843">.</span><span class="ident" id="4993844">typ</span><span class="op" id="4993847">,</span>&nbsp;<span class="builtintype" id="4993849">true</span><span class="op" id="4993853">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993857">if</span>&nbsp;<span class="builtinfunc" id="4993860">len</span><span class="op" id="4993863">(</span><span class="ident" id="4993864">s</span><span class="op" id="4993865">.</span><span class="ident" id="4993866">method</span><span class="op" id="4993872">)</span>&nbsp;<span class="op" id="4993874">==</span>&nbsp;<span class="num" id="4993877">0</span>&nbsp;<span class="op" id="4993879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993883">str</span>&nbsp;<span class="op" id="4993887">:=</span>&nbsp;<span class="string" id="4993890">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993896">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993957">method</span>&nbsp;<span class="op" id="4993964">:=</span>&nbsp;<span class="ident" id="4993967">suitableMethods</span><span class="op" id="4993982">(</span><span class="ident" id="4993983">reflect</span><span class="op" id="4993990">.</span><span class="ident" id="4993991">PtrTo</span><span class="op" id="4993996">(</span><span class="ident" id="4993997">s</span><span class="op" id="4993998">.</span><span class="ident" id="4993999">typ</span><span class="op" id="4994002">)</span><span class="op" id="4994003">,</span>&nbsp;<span class="builtintype" id="4994005">false</span><span class="op" id="4994010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994014">if</span>&nbsp;<span class="builtinfunc" id="4994017">len</span><span class="op" id="4994020">(</span><span class="ident" id="4994021">method</span><span class="op" id="4994027">)</span>&nbsp;<span class="op" id="4994029">!=</span>&nbsp;<span class="num" id="4994032">0</span>&nbsp;<span class="op" id="4994034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994039">str</span>&nbsp;<span class="op" id="4994043">=</span>&nbsp;<span class="string" id="4994045">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4994067">+</span>&nbsp;<span class="ident" id="4994069">sname</span>&nbsp;<span class="op" id="4994075">+</span>&nbsp;<span class="string" id="4994077">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994168">}</span>&nbsp;<span class="keyword" id="4994170">else</span>&nbsp;<span class="op" id="4994175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994180">str</span>&nbsp;<span class="op" id="4994184">=</span>&nbsp;<span class="string" id="4994186">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4994208">+</span>&nbsp;<span class="ident" id="4994210">sname</span>&nbsp;<span class="op" id="4994216">+</span>&nbsp;<span class="string" id="4994218">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994268">log</span><span class="op" id="4994271">.</span><span class="ident" id="4994272">Print</span><span class="op" id="4994277">(</span><span class="ident" id="4994278">str</span><span class="op" id="4994281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994285">return</span>&nbsp;<span class="ident" id="4994292">errors</span><span class="op" id="4994298">.</span><span class="ident" id="4994299">New</span><span class="op" id="4994302">(</span><span class="ident" id="4994303">str</span><span class="op" id="4994306">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994312">server</span><span class="op" id="4994318">.</span><span class="ident" id="4994319">serviceMap</span><span class="op" id="4994329">[</span><span class="ident" id="4994330">s</span><span class="op" id="4994331">.</span><span class="ident" id="4994332">name</span><span class="op" id="4994336">]</span>&nbsp;<span class="op" id="4994338">=</span>&nbsp;<span class="ident" id="4994340">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994343">return</span>&nbsp;<span class="ident" id="4994350">nil</span><br>
<span class="lineno"></span><span class="op" id="4994354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="4994357">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="4994428">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="4994469">func</span>&nbsp;<span class="ident" id="4994474">suitableMethods</span><span class="op" id="4994489">(</span><span class="ident" id="4994490">typ</span>&nbsp;<span class="ident" id="4994494">reflect</span><span class="op" id="4994501">.</span><span class="ident" id="4994502">Type</span><span class="op" id="4994506">,</span>&nbsp;<span class="ident" id="4994508">reportErr</span>&nbsp;<span class="builtintype" id="4994518">bool</span><span class="op" id="4994522">)</span>&nbsp;<span class="keyword" id="4994524">map</span><span class="op" id="4994527">[</span><span class="builtintype" id="4994528">string</span><span class="op" id="4994534">]</span><span class="op" id="4994535">*</span><span class="ident" id="4994536">methodType</span>&nbsp;<span class="op" id="4994547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994550">methods</span>&nbsp;<span class="op" id="4994558">:=</span>&nbsp;<span class="builtinfunc" id="4994561">make</span><span class="op" id="4994565">(</span><span class="keyword" id="4994566">map</span><span class="op" id="4994569">[</span><span class="builtintype" id="4994570">string</span><span class="op" id="4994576">]</span><span class="op" id="4994577">*</span><span class="ident" id="4994578">methodType</span><span class="op" id="4994588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994591">for</span>&nbsp;<span class="ident" id="4994595">m</span>&nbsp;<span class="op" id="4994597">:=</span>&nbsp;<span class="num" id="4994600">0</span><span class="op" id="4994601">;</span>&nbsp;<span class="ident" id="4994603">m</span>&nbsp;<span class="op" id="4994605">&lt;</span>&nbsp;<span class="ident" id="4994607">typ</span><span class="op" id="4994610">.</span><span class="ident" id="4994611">NumMethod</span><span class="op" id="4994620">(</span><span class="op" id="4994621">)</span><span class="op" id="4994622">;</span>&nbsp;<span class="ident" id="4994624">m</span><span class="op" id="4994625">++</span>&nbsp;<span class="op" id="4994628">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994632">method</span>&nbsp;<span class="op" id="4994639">:=</span>&nbsp;<span class="ident" id="4994642">typ</span><span class="op" id="4994645">.</span><span class="ident" id="4994646">Method</span><span class="op" id="4994652">(</span><span class="ident" id="4994653">m</span><span class="op" id="4994654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994658">mtype</span>&nbsp;<span class="op" id="4994664">:=</span>&nbsp;<span class="ident" id="4994667">method</span><span class="op" id="4994673">.</span><span class="ident" id="4994674">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994681">mname</span>&nbsp;<span class="op" id="4994687">:=</span>&nbsp;<span class="ident" id="4994690">method</span><span class="op" id="4994696">.</span><span class="ident" id="4994697">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994704">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994734">if</span>&nbsp;<span class="ident" id="4994737">method</span><span class="op" id="4994743">.</span><span class="ident" id="4994744">PkgPath</span>&nbsp;<span class="op" id="4994752">!=</span>&nbsp;<span class="string" id="4994755">&#34;&#34;</span>&nbsp;<span class="op" id="4994758">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994763">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994778">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994832">if</span>&nbsp;<span class="ident" id="4994835">mtype</span><span class="op" id="4994840">.</span><span class="ident" id="4994841">NumIn</span><span class="op" id="4994846">(</span><span class="op" id="4994847">)</span>&nbsp;<span class="op" id="4994849">!=</span>&nbsp;<span class="num" id="4994852">3</span>&nbsp;<span class="op" id="4994854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994859">if</span>&nbsp;<span class="ident" id="4994862">reportErr</span>&nbsp;<span class="op" id="4994872">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994878">log</span><span class="op" id="4994881">.</span><span class="ident" id="4994882">Println</span><span class="op" id="4994889">(</span><span class="string" id="4994890">&#34;method&#34;</span><span class="op" id="4994898">,</span>&nbsp;<span class="ident" id="4994900">mname</span><span class="op" id="4994905">,</span>&nbsp;<span class="string" id="4994907">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="4994933">,</span>&nbsp;<span class="ident" id="4994935">mtype</span><span class="op" id="4994940">.</span><span class="ident" id="4994941">NumIn</span><span class="op" id="4994946">(</span><span class="op" id="4994947">)</span><span class="op" id="4994948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994958">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994973">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995011">argType</span>&nbsp;<span class="op" id="4995019">:=</span>&nbsp;<span class="ident" id="4995022">mtype</span><span class="op" id="4995027">.</span><span class="ident" id="4995028">In</span><span class="op" id="4995030">(</span><span class="num" id="4995031">1</span><span class="op" id="4995032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995036">if</span>&nbsp;<span class="op" id="4995039">!</span><span class="ident" id="4995040">isExportedOrBuiltinType</span><span class="op" id="4995063">(</span><span class="ident" id="4995064">argType</span><span class="op" id="4995071">)</span>&nbsp;<span class="op" id="4995073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995078">if</span>&nbsp;<span class="ident" id="4995081">reportErr</span>&nbsp;<span class="op" id="4995091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995097">log</span><span class="op" id="4995100">.</span><span class="ident" id="4995101">Println</span><span class="op" id="4995108">(</span><span class="ident" id="4995109">mname</span><span class="op" id="4995114">,</span>&nbsp;<span class="string" id="4995116">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="4995145">,</span>&nbsp;<span class="ident" id="4995147">argType</span><span class="op" id="4995154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995159">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995164">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995179">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995214">replyType</span>&nbsp;<span class="op" id="4995224">:=</span>&nbsp;<span class="ident" id="4995227">mtype</span><span class="op" id="4995232">.</span><span class="ident" id="4995233">In</span><span class="op" id="4995235">(</span><span class="num" id="4995236">2</span><span class="op" id="4995237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995241">if</span>&nbsp;<span class="ident" id="4995244">replyType</span><span class="op" id="4995253">.</span><span class="ident" id="4995254">Kind</span><span class="op" id="4995258">(</span><span class="op" id="4995259">)</span>&nbsp;<span class="op" id="4995261">!=</span>&nbsp;<span class="ident" id="4995264">reflect</span><span class="op" id="4995271">.</span><span class="ident" id="4995272">Ptr</span>&nbsp;<span class="op" id="4995276">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995281">if</span>&nbsp;<span class="ident" id="4995284">reportErr</span>&nbsp;<span class="op" id="4995294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995300">log</span><span class="op" id="4995303">.</span><span class="ident" id="4995304">Println</span><span class="op" id="4995311">(</span><span class="string" id="4995312">&#34;method&#34;</span><span class="op" id="4995320">,</span>&nbsp;<span class="ident" id="4995322">mname</span><span class="op" id="4995327">,</span>&nbsp;<span class="string" id="4995329">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="4995356">,</span>&nbsp;<span class="ident" id="4995358">replyType</span><span class="op" id="4995367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995377">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995388">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995392">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995426">if</span>&nbsp;<span class="op" id="4995429">!</span><span class="ident" id="4995430">isExportedOrBuiltinType</span><span class="op" id="4995453">(</span><span class="ident" id="4995454">replyType</span><span class="op" id="4995463">)</span>&nbsp;<span class="op" id="4995465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995470">if</span>&nbsp;<span class="ident" id="4995473">reportErr</span>&nbsp;<span class="op" id="4995483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995489">log</span><span class="op" id="4995492">.</span><span class="ident" id="4995493">Println</span><span class="op" id="4995500">(</span><span class="string" id="4995501">&#34;method&#34;</span><span class="op" id="4995509">,</span>&nbsp;<span class="ident" id="4995511">mname</span><span class="op" id="4995516">,</span>&nbsp;<span class="string" id="4995518">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="4995544">,</span>&nbsp;<span class="ident" id="4995546">replyType</span><span class="op" id="4995555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995560">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995565">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995580">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995607">if</span>&nbsp;<span class="ident" id="4995610">mtype</span><span class="op" id="4995615">.</span><span class="ident" id="4995616">NumOut</span><span class="op" id="4995622">(</span><span class="op" id="4995623">)</span>&nbsp;<span class="op" id="4995625">!=</span>&nbsp;<span class="num" id="4995628">1</span>&nbsp;<span class="op" id="4995630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995635">if</span>&nbsp;<span class="ident" id="4995638">reportErr</span>&nbsp;<span class="op" id="4995648">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995654">log</span><span class="op" id="4995657">.</span><span class="ident" id="4995658">Println</span><span class="op" id="4995665">(</span><span class="string" id="4995666">&#34;method&#34;</span><span class="op" id="4995674">,</span>&nbsp;<span class="ident" id="4995676">mname</span><span class="op" id="4995681">,</span>&nbsp;<span class="string" id="4995683">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="4995710">,</span>&nbsp;<span class="ident" id="4995712">mtype</span><span class="op" id="4995717">.</span><span class="ident" id="4995718">NumOut</span><span class="op" id="4995724">(</span><span class="op" id="4995725">)</span><span class="op" id="4995726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995736">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995751">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995801">if</span>&nbsp;<span class="ident" id="4995804">returnType</span>&nbsp;<span class="op" id="4995815">:=</span>&nbsp;<span class="ident" id="4995818">mtype</span><span class="op" id="4995823">.</span><span class="ident" id="4995824">Out</span><span class="op" id="4995827">(</span><span class="num" id="4995828">0</span><span class="op" id="4995829">)</span><span class="op" id="4995830">;</span>&nbsp;<span class="ident" id="4995832">returnType</span>&nbsp;<span class="op" id="4995843">!=</span>&nbsp;<span class="ident" id="4995846">typeOfError</span>&nbsp;<span class="op" id="4995858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995863">if</span>&nbsp;<span class="ident" id="4995866">reportErr</span>&nbsp;<span class="op" id="4995876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995882">log</span><span class="op" id="4995885">.</span><span class="ident" id="4995886">Println</span><span class="op" id="4995893">(</span><span class="string" id="4995894">&#34;method&#34;</span><span class="op" id="4995902">,</span>&nbsp;<span class="ident" id="4995904">mname</span><span class="op" id="4995909">,</span>&nbsp;<span class="string" id="4995911">&#34;returns&#34;</span><span class="op" id="4995920">,</span>&nbsp;<span class="ident" id="4995922">returnType</span><span class="op" id="4995932">.</span><span class="ident" id="4995933">String</span><span class="op" id="4995939">(</span><span class="op" id="4995940">)</span><span class="op" id="4995941">,</span>&nbsp;<span class="string" id="4995943">&#34;not&nbsp;error&#34;</span><span class="op" id="4995954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995964">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995979">methods</span><span class="op" id="4995986">[</span><span class="ident" id="4995987">mname</span><span class="op" id="4995992">]</span>&nbsp;<span class="op" id="4995994">=</span>&nbsp;<span class="op" id="4995996">&amp;</span><span class="ident" id="4995997">methodType</span><span class="op" id="4996007">{</span><span class="ident" id="4996008">method</span><span class="op" id="4996014">:</span>&nbsp;<span class="ident" id="4996016">method</span><span class="op" id="4996022">,</span>&nbsp;<span class="ident" id="4996024">ArgType</span><span class="op" id="4996031">:</span>&nbsp;<span class="ident" id="4996033">argType</span><span class="op" id="4996040">,</span>&nbsp;<span class="ident" id="4996042">ReplyType</span><span class="op" id="4996051">:</span>&nbsp;<span class="ident" id="4996053">replyType</span><span class="op" id="4996062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996068">return</span>&nbsp;<span class="ident" id="4996075">methods</span><br>
<span class="lineno"></span><span class="op" id="4996083">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="4996086">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4996167">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="4996252">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4996290">var</span>&nbsp;<span class="ident" id="4996294">invalidRequest</span>&nbsp;<span class="op" id="4996309">=</span>&nbsp;<span class="keyword" id="4996311">struct</span><span class="op" id="4996317">{</span><span class="op" id="4996318">}</span><span class="op" id="4996319">{</span><span class="op" id="4996320">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="4996323">func</span>&nbsp;<span class="op" id="4996328">(</span><span class="ident" id="4996329">server</span>&nbsp;<span class="op" id="4996336">*</span><span class="ident" id="4996337">Server</span><span class="op" id="4996343">)</span>&nbsp;<span class="ident" id="4996345">sendResponse</span><span class="op" id="4996357">(</span><span class="ident" id="4996358">sending</span>&nbsp;<span class="op" id="4996366">*</span><span class="ident" id="4996367">sync</span><span class="op" id="4996371">.</span><span class="ident" id="4996372">Mutex</span><span class="op" id="4996377">,</span>&nbsp;<span class="ident" id="4996379">req</span>&nbsp;<span class="op" id="4996383">*</span><span class="ident" id="4996384">Request</span><span class="op" id="4996391">,</span>&nbsp;<span class="ident" id="4996393">reply</span>&nbsp;<span class="keyword" id="4996399">interface</span><span class="op" id="4996408">{</span><span class="op" id="4996409">}</span><span class="op" id="4996410">,</span>&nbsp;<span class="ident" id="4996412">codec</span>&nbsp;<span class="ident" id="4996418">ServerCodec</span><span class="op" id="4996429">,</span>&nbsp;<span class="ident" id="4996431">errmsg</span>&nbsp;<span class="builtintype" id="4996438">string</span><span class="op" id="4996444">)</span>&nbsp;<span class="op" id="4996446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996449">resp</span>&nbsp;<span class="op" id="4996454">:=</span>&nbsp;<span class="ident" id="4996457">server</span><span class="op" id="4996463">.</span><span class="ident" id="4996464">getResponse</span><span class="op" id="4996475">(</span><span class="op" id="4996476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996479">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996510">resp</span><span class="op" id="4996514">.</span><span class="ident" id="4996515">ServiceMethod</span>&nbsp;<span class="op" id="4996529">=</span>&nbsp;<span class="ident" id="4996531">req</span><span class="op" id="4996534">.</span><span class="ident" id="4996535">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996550">if</span>&nbsp;<span class="ident" id="4996553">errmsg</span>&nbsp;<span class="op" id="4996560">!=</span>&nbsp;<span class="string" id="4996563">&#34;&#34;</span>&nbsp;<span class="op" id="4996566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996570">resp</span><span class="op" id="4996574">.</span><span class="ident" id="4996575">Error</span>&nbsp;<span class="op" id="4996581">=</span>&nbsp;<span class="ident" id="4996583">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996592">reply</span>&nbsp;<span class="op" id="4996598">=</span>&nbsp;<span class="ident" id="4996600">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996619">resp</span><span class="op" id="4996623">.</span><span class="ident" id="4996624">Seq</span>&nbsp;<span class="op" id="4996628">=</span>&nbsp;<span class="ident" id="4996630">req</span><span class="op" id="4996633">.</span><span class="ident" id="4996634">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996639">sending</span><span class="op" id="4996646">.</span><span class="ident" id="4996647">Lock</span><span class="op" id="4996651">(</span><span class="op" id="4996652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996655">err</span>&nbsp;<span class="op" id="4996659">:=</span>&nbsp;<span class="ident" id="4996662">codec</span><span class="op" id="4996667">.</span><span class="ident" id="4996668">WriteResponse</span><span class="op" id="4996681">(</span><span class="ident" id="4996682">resp</span><span class="op" id="4996686">,</span>&nbsp;<span class="ident" id="4996688">reply</span><span class="op" id="4996693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996696">if</span>&nbsp;<span class="ident" id="4996699">debugLog</span>&nbsp;<span class="op" id="4996708">&amp;&amp;</span>&nbsp;<span class="ident" id="4996711">err</span>&nbsp;<span class="op" id="4996715">!=</span>&nbsp;<span class="ident" id="4996718">nil</span>&nbsp;<span class="op" id="4996722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996726">log</span><span class="op" id="4996729">.</span><span class="ident" id="4996730">Println</span><span class="op" id="4996737">(</span><span class="string" id="4996738">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="4996762">,</span>&nbsp;<span class="ident" id="4996764">err</span><span class="op" id="4996767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996770">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996773">sending</span><span class="op" id="4996780">.</span><span class="ident" id="4996781">Unlock</span><span class="op" id="4996787">(</span><span class="op" id="4996788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996791">server</span><span class="op" id="4996797">.</span><span class="ident" id="4996798">freeResponse</span><span class="op" id="4996810">(</span><span class="ident" id="4996811">resp</span><span class="op" id="4996815">)</span><br>
<span class="lineno"></span><span class="op" id="4996817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996820">func</span>&nbsp;<span class="op" id="4996825">(</span><span class="ident" id="4996826">m</span>&nbsp;<span class="op" id="4996828">*</span><span class="ident" id="4996829">methodType</span><span class="op" id="4996839">)</span>&nbsp;<span class="ident" id="4996841">NumCalls</span><span class="op" id="4996849">(</span><span class="op" id="4996850">)</span>&nbsp;<span class="op" id="4996852">(</span><span class="ident" id="4996853">n</span>&nbsp;<span class="builtintype" id="4996855">uint</span><span class="op" id="4996859">)</span>&nbsp;<span class="op" id="4996861">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996864">m</span><span class="op" id="4996865">.</span><span class="ident" id="4996866">Lock</span><span class="op" id="4996870">(</span><span class="op" id="4996871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996874">n</span>&nbsp;<span class="op" id="4996876">=</span>&nbsp;<span class="ident" id="4996878">m</span><span class="op" id="4996879">.</span><span class="ident" id="4996880">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996890">m</span><span class="op" id="4996891">.</span><span class="ident" id="4996892">Unlock</span><span class="op" id="4996898">(</span><span class="op" id="4996899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996902">return</span>&nbsp;<span class="ident" id="4996909">n</span><br>
<span class="lineno"></span><span class="op" id="4996911">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="4996914">func</span>&nbsp;<span class="op" id="4996919">(</span><span class="ident" id="4996920">s</span>&nbsp;<span class="op" id="4996922">*</span><span class="ident" id="4996923">service</span><span class="op" id="4996930">)</span>&nbsp;<span class="ident" id="4996932">call</span><span class="op" id="4996936">(</span><span class="ident" id="4996937">server</span>&nbsp;<span class="op" id="4996944">*</span><span class="ident" id="4996945">Server</span><span class="op" id="4996951">,</span>&nbsp;<span class="ident" id="4996953">sending</span>&nbsp;<span class="op" id="4996961">*</span><span class="ident" id="4996962">sync</span><span class="op" id="4996966">.</span><span class="ident" id="4996967">Mutex</span><span class="op" id="4996972">,</span>&nbsp;<span class="ident" id="4996974">mtype</span>&nbsp;<span class="op" id="4996980">*</span><span class="ident" id="4996981">methodType</span><span class="op" id="4996991">,</span>&nbsp;<span class="ident" id="4996993">req</span>&nbsp;<span class="op" id="4996997">*</span><span class="ident" id="4996998">Request</span><span class="op" id="4997005">,</span>&nbsp;<span class="ident" id="4997007">argv</span><span class="op" id="4997011">,</span>&nbsp;<span class="ident" id="4997013">replyv</span>&nbsp;<span class="ident" id="4997020">reflect</span><span class="op" id="4997027">.</span><span class="ident" id="4997028">Value</span><span class="op" id="4997033">,</span>&nbsp;<span class="ident" id="4997035">codec</span>&nbsp;<span class="ident" id="4997041">ServerCodec</span><span class="op" id="4997052">)</span>&nbsp;<span class="op" id="4997054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997057">mtype</span><span class="op" id="4997062">.</span><span class="ident" id="4997063">Lock</span><span class="op" id="4997067">(</span><span class="op" id="4997068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997071">mtype</span><span class="op" id="4997076">.</span><span class="ident" id="4997077">numCalls</span><span class="op" id="4997085">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997089">mtype</span><span class="op" id="4997094">.</span><span class="ident" id="4997095">Unlock</span><span class="op" id="4997101">(</span><span class="op" id="4997102">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997105">function</span>&nbsp;<span class="op" id="4997114">:=</span>&nbsp;<span class="ident" id="4997117">mtype</span><span class="op" id="4997122">.</span><span class="ident" id="4997123">method</span><span class="op" id="4997129">.</span><span class="ident" id="4997130">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997136">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997196">returnValues</span>&nbsp;<span class="op" id="4997209">:=</span>&nbsp;<span class="ident" id="4997212">function</span><span class="op" id="4997220">.</span><span class="ident" id="4997221">Call</span><span class="op" id="4997225">(</span><span class="op" id="4997226">[</span><span class="op" id="4997227">]</span><span class="ident" id="4997228">reflect</span><span class="op" id="4997235">.</span><span class="ident" id="4997236">Value</span><span class="op" id="4997241">{</span><span class="ident" id="4997242">s</span><span class="op" id="4997243">.</span><span class="ident" id="4997244">rcvr</span><span class="op" id="4997248">,</span>&nbsp;<span class="ident" id="4997250">argv</span><span class="op" id="4997254">,</span>&nbsp;<span class="ident" id="4997256">replyv</span><span class="op" id="4997262">}</span><span class="op" id="4997263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997266">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997315">errInter</span>&nbsp;<span class="op" id="4997324">:=</span>&nbsp;<span class="ident" id="4997327">returnValues</span><span class="op" id="4997339">[</span><span class="num" id="4997340">0</span><span class="op" id="4997341">]</span><span class="op" id="4997342">.</span><span class="ident" id="4997343">Interface</span><span class="op" id="4997352">(</span><span class="op" id="4997353">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997356">errmsg</span>&nbsp;<span class="op" id="4997363">:=</span>&nbsp;<span class="string" id="4997366">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997370">if</span>&nbsp;<span class="ident" id="4997373">errInter</span>&nbsp;<span class="op" id="4997382">!=</span>&nbsp;<span class="ident" id="4997385">nil</span>&nbsp;<span class="op" id="4997389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997393">errmsg</span>&nbsp;<span class="op" id="4997400">=</span>&nbsp;<span class="ident" id="4997402">errInter</span><span class="op" id="4997410">.</span><span class="op" id="4997411">(</span><span class="builtintype" id="4997412">error</span><span class="op" id="4997417">)</span><span class="op" id="4997418">.</span><span class="ident" id="4997419">Error</span><span class="op" id="4997424">(</span><span class="op" id="4997425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997431">server</span><span class="op" id="4997437">.</span><span class="ident" id="4997438">sendResponse</span><span class="op" id="4997450">(</span><span class="ident" id="4997451">sending</span><span class="op" id="4997458">,</span>&nbsp;<span class="ident" id="4997460">req</span><span class="op" id="4997463">,</span>&nbsp;<span class="ident" id="4997465">replyv</span><span class="op" id="4997471">.</span><span class="ident" id="4997472">Interface</span><span class="op" id="4997481">(</span><span class="op" id="4997482">)</span><span class="op" id="4997483">,</span>&nbsp;<span class="ident" id="4997485">codec</span><span class="op" id="4997490">,</span>&nbsp;<span class="ident" id="4997492">errmsg</span><span class="op" id="4997498">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997501">server</span><span class="op" id="4997507">.</span><span class="ident" id="4997508">freeRequest</span><span class="op" id="4997519">(</span><span class="ident" id="4997520">req</span><span class="op" id="4997523">)</span><br>
<span class="lineno"></span><span class="op" id="4997525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4997528">type</span>&nbsp;<span class="ident" id="4997533">gobServerCodec</span>&nbsp;<span class="keyword" id="4997548">struct</span>&nbsp;<span class="op" id="4997555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997558">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997565">io</span><span class="op" id="4997567">.</span><span class="ident" id="4997568">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997585">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997592">*</span><span class="ident" id="4997593">gob</span><span class="op" id="4997596">.</span><span class="ident" id="4997597">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997606">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997613">*</span><span class="ident" id="4997614">gob</span><span class="op" id="4997617">.</span><span class="ident" id="4997618">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997627">encBuf</span>&nbsp;<span class="op" id="4997634">*</span><span class="ident" id="4997635">bufio</span><span class="op" id="4997640">.</span><span class="ident" id="4997641">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997649">closed</span>&nbsp;<span class="builtintype" id="4997656">bool</span><br>
<span class="lineno"></span><span class="op" id="4997661">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="4997664">func</span>&nbsp;<span class="op" id="4997669">(</span><span class="ident" id="4997670">c</span>&nbsp;<span class="op" id="4997672">*</span><span class="ident" id="4997673">gobServerCodec</span><span class="op" id="4997687">)</span>&nbsp;<span class="ident" id="4997689">ReadRequestHeader</span><span class="op" id="4997706">(</span><span class="ident" id="4997707">r</span>&nbsp;<span class="op" id="4997709">*</span><span class="ident" id="4997710">Request</span><span class="op" id="4997717">)</span>&nbsp;<span class="builtintype" id="4997719">error</span>&nbsp;<span class="op" id="4997725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997728">return</span>&nbsp;<span class="ident" id="4997735">c</span><span class="op" id="4997736">.</span><span class="ident" id="4997737">dec</span><span class="op" id="4997740">.</span><span class="ident" id="4997741">Decode</span><span class="op" id="4997747">(</span><span class="ident" id="4997748">r</span><span class="op" id="4997749">)</span><br>
<span class="lineno"></span><span class="op" id="4997751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="4997754">func</span>&nbsp;<span class="op" id="4997759">(</span><span class="ident" id="4997760">c</span>&nbsp;<span class="op" id="4997762">*</span><span class="ident" id="4997763">gobServerCodec</span><span class="op" id="4997777">)</span>&nbsp;<span class="ident" id="4997779">ReadRequestBody</span><span class="op" id="4997794">(</span><span class="ident" id="4997795">body</span>&nbsp;<span class="keyword" id="4997800">interface</span><span class="op" id="4997809">{</span><span class="op" id="4997810">}</span><span class="op" id="4997811">)</span>&nbsp;<span class="builtintype" id="4997813">error</span>&nbsp;<span class="op" id="4997819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997822">return</span>&nbsp;<span class="ident" id="4997829">c</span><span class="op" id="4997830">.</span><span class="ident" id="4997831">dec</span><span class="op" id="4997834">.</span><span class="ident" id="4997835">Decode</span><span class="op" id="4997841">(</span><span class="ident" id="4997842">body</span><span class="op" id="4997846">)</span><br>
<span class="lineno"></span><span class="op" id="4997848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4997851">func</span>&nbsp;<span class="op" id="4997856">(</span><span class="ident" id="4997857">c</span>&nbsp;<span class="op" id="4997859">*</span><span class="ident" id="4997860">gobServerCodec</span><span class="op" id="4997874">)</span>&nbsp;<span class="ident" id="4997876">WriteResponse</span><span class="op" id="4997889">(</span><span class="ident" id="4997890">r</span>&nbsp;<span class="op" id="4997892">*</span><span class="ident" id="4997893">Response</span><span class="op" id="4997901">,</span>&nbsp;<span class="ident" id="4997903">body</span>&nbsp;<span class="keyword" id="4997908">interface</span><span class="op" id="4997917">{</span><span class="op" id="4997918">}</span><span class="op" id="4997919">)</span>&nbsp;<span class="op" id="4997921">(</span><span class="ident" id="4997922">err</span>&nbsp;<span class="builtintype" id="4997926">error</span><span class="op" id="4997931">)</span>&nbsp;<span class="op" id="4997933">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997936">if</span>&nbsp;<span class="ident" id="4997939">err</span>&nbsp;<span class="op" id="4997943">=</span>&nbsp;<span class="ident" id="4997945">c</span><span class="op" id="4997946">.</span><span class="ident" id="4997947">enc</span><span class="op" id="4997950">.</span><span class="ident" id="4997951">Encode</span><span class="op" id="4997957">(</span><span class="ident" id="4997958">r</span><span class="op" id="4997959">)</span><span class="op" id="4997960">;</span>&nbsp;<span class="ident" id="4997962">err</span>&nbsp;<span class="op" id="4997966">!=</span>&nbsp;<span class="ident" id="4997969">nil</span>&nbsp;<span class="op" id="4997973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997977">if</span>&nbsp;<span class="ident" id="4997980">c</span><span class="op" id="4997981">.</span><span class="ident" id="4997982">encBuf</span><span class="op" id="4997988">.</span><span class="ident" id="4997989">Flush</span><span class="op" id="4997994">(</span><span class="op" id="4997995">)</span>&nbsp;<span class="op" id="4997997">==</span>&nbsp;<span class="ident" id="4998000">nil</span>&nbsp;<span class="op" id="4998004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998009">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998081">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998153">log</span><span class="op" id="4998156">.</span><span class="ident" id="4998157">Println</span><span class="op" id="4998164">(</span><span class="string" id="4998165">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="4998200">,</span>&nbsp;<span class="ident" id="4998202">err</span><span class="op" id="4998205">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998210">c</span><span class="op" id="4998211">.</span><span class="ident" id="4998212">Close</span><span class="op" id="4998217">(</span><span class="op" id="4998218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998226">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998237">if</span>&nbsp;<span class="ident" id="4998240">err</span>&nbsp;<span class="op" id="4998244">=</span>&nbsp;<span class="ident" id="4998246">c</span><span class="op" id="4998247">.</span><span class="ident" id="4998248">enc</span><span class="op" id="4998251">.</span><span class="ident" id="4998252">Encode</span><span class="op" id="4998258">(</span><span class="ident" id="4998259">body</span><span class="op" id="4998263">)</span><span class="op" id="4998264">;</span>&nbsp;<span class="ident" id="4998266">err</span>&nbsp;<span class="op" id="4998270">!=</span>&nbsp;<span class="ident" id="4998273">nil</span>&nbsp;<span class="op" id="4998277">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998281">if</span>&nbsp;<span class="ident" id="4998284">c</span><span class="op" id="4998285">.</span><span class="ident" id="4998286">encBuf</span><span class="op" id="4998292">.</span><span class="ident" id="4998293">Flush</span><span class="op" id="4998298">(</span><span class="op" id="4998299">)</span>&nbsp;<span class="op" id="4998301">==</span>&nbsp;<span class="ident" id="4998304">nil</span>&nbsp;<span class="op" id="4998308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998313">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998388">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998460">log</span><span class="op" id="4998463">.</span><span class="ident" id="4998464">Println</span><span class="op" id="4998471">(</span><span class="string" id="4998472">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="4998503">,</span>&nbsp;<span class="ident" id="4998505">err</span><span class="op" id="4998508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998513">c</span><span class="op" id="4998514">.</span><span class="ident" id="4998515">Close</span><span class="op" id="4998520">(</span><span class="op" id="4998521">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998529">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998540">return</span>&nbsp;<span class="ident" id="4998547">c</span><span class="op" id="4998548">.</span><span class="ident" id="4998549">encBuf</span><span class="op" id="4998555">.</span><span class="ident" id="4998556">Flush</span><span class="op" id="4998561">(</span><span class="op" id="4998562">)</span><br>
<span class="lineno"></span><span class="op" id="4998564">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4998567">func</span>&nbsp;<span class="op" id="4998572">(</span><span class="ident" id="4998573">c</span>&nbsp;<span class="op" id="4998575">*</span><span class="ident" id="4998576">gobServerCodec</span><span class="op" id="4998590">)</span>&nbsp;<span class="ident" id="4998592">Close</span><span class="op" id="4998597">(</span><span class="op" id="4998598">)</span>&nbsp;<span class="builtintype" id="4998600">error</span>&nbsp;<span class="op" id="4998606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998609">if</span>&nbsp;<span class="ident" id="4998612">c</span><span class="op" id="4998613">.</span><span class="ident" id="4998614">closed</span>&nbsp;<span class="op" id="4998621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998625">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998697">return</span>&nbsp;<span class="ident" id="4998704">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998712">c</span><span class="op" id="4998713">.</span><span class="ident" id="4998714">closed</span>&nbsp;<span class="op" id="4998721">=</span>&nbsp;<span class="builtintype" id="4998723">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998729">return</span>&nbsp;<span class="ident" id="4998736">c</span><span class="op" id="4998737">.</span><span class="ident" id="4998738">rwc</span><span class="op" id="4998741">.</span><span class="ident" id="4998742">Close</span><span class="op" id="4998747">(</span><span class="op" id="4998748">)</span><br>
<span class="lineno"></span><span class="op" id="4998750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="4998753">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4998806">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4998877">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="4998938">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4999001">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="4999060">func</span>&nbsp;<span class="op" id="4999065">(</span><span class="ident" id="4999066">server</span>&nbsp;<span class="op" id="4999073">*</span><span class="ident" id="4999074">Server</span><span class="op" id="4999080">)</span>&nbsp;<span class="ident" id="4999082">ServeConn</span><span class="op" id="4999091">(</span><span class="ident" id="4999092">conn</span>&nbsp;<span class="ident" id="4999097">io</span><span class="op" id="4999099">.</span><span class="ident" id="4999100">ReadWriteCloser</span><span class="op" id="4999115">)</span>&nbsp;<span class="op" id="4999117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999120">buf</span>&nbsp;<span class="op" id="4999124">:=</span>&nbsp;<span class="ident" id="4999127">bufio</span><span class="op" id="4999132">.</span><span class="ident" id="4999133">NewWriter</span><span class="op" id="4999142">(</span><span class="ident" id="4999143">conn</span><span class="op" id="4999147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999150">srv</span>&nbsp;<span class="op" id="4999154">:=</span>&nbsp;<span class="op" id="4999157">&amp;</span><span class="ident" id="4999158">gobServerCodec</span><span class="op" id="4999172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999176">rwc</span><span class="op" id="4999179">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999184">conn</span><span class="op" id="4999188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999192">dec</span><span class="op" id="4999195">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999200">gob</span><span class="op" id="4999203">.</span><span class="ident" id="4999204">NewDecoder</span><span class="op" id="4999214">(</span><span class="ident" id="4999215">conn</span><span class="op" id="4999219">)</span><span class="op" id="4999220">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999224">enc</span><span class="op" id="4999227">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999232">gob</span><span class="op" id="4999235">.</span><span class="ident" id="4999236">NewEncoder</span><span class="op" id="4999246">(</span><span class="ident" id="4999247">buf</span><span class="op" id="4999250">)</span><span class="op" id="4999251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999255">encBuf</span><span class="op" id="4999261">:</span>&nbsp;<span class="ident" id="4999263">buf</span><span class="op" id="4999266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999272">server</span><span class="op" id="4999278">.</span><span class="ident" id="4999279">ServeCodec</span><span class="op" id="4999289">(</span><span class="ident" id="4999290">srv</span><span class="op" id="4999293">)</span><br>
<span class="lineno"></span><span class="op" id="4999295">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="4999298">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4999362">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="4999403">func</span>&nbsp;<span class="op" id="4999408">(</span><span class="ident" id="4999409">server</span>&nbsp;<span class="op" id="4999416">*</span><span class="ident" id="4999417">Server</span><span class="op" id="4999423">)</span>&nbsp;<span class="ident" id="4999425">ServeCodec</span><span class="op" id="4999435">(</span><span class="ident" id="4999436">codec</span>&nbsp;<span class="ident" id="4999442">ServerCodec</span><span class="op" id="4999453">)</span>&nbsp;<span class="op" id="4999455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999458">sending</span>&nbsp;<span class="op" id="4999466">:=</span>&nbsp;<span class="builtinfunc" id="4999469">new</span><span class="op" id="4999472">(</span><span class="ident" id="4999473">sync</span><span class="op" id="4999477">.</span><span class="ident" id="4999478">Mutex</span><span class="op" id="4999483">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999486">for</span>&nbsp;<span class="op" id="4999490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999494">service</span><span class="op" id="4999501">,</span>&nbsp;<span class="ident" id="4999503">mtype</span><span class="op" id="4999508">,</span>&nbsp;<span class="ident" id="4999510">req</span><span class="op" id="4999513">,</span>&nbsp;<span class="ident" id="4999515">argv</span><span class="op" id="4999519">,</span>&nbsp;<span class="ident" id="4999521">replyv</span><span class="op" id="4999527">,</span>&nbsp;<span class="ident" id="4999529">keepReading</span><span class="op" id="4999540">,</span>&nbsp;<span class="ident" id="4999542">err</span>&nbsp;<span class="op" id="4999546">:=</span>&nbsp;<span class="ident" id="4999549">server</span><span class="op" id="4999555">.</span><span class="ident" id="4999556">readRequest</span><span class="op" id="4999567">(</span><span class="ident" id="4999568">codec</span><span class="op" id="4999573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999577">if</span>&nbsp;<span class="ident" id="4999580">err</span>&nbsp;<span class="op" id="4999584">!=</span>&nbsp;<span class="ident" id="4999587">nil</span>&nbsp;<span class="op" id="4999591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999596">if</span>&nbsp;<span class="ident" id="4999599">debugLog</span>&nbsp;<span class="op" id="4999608">&amp;&amp;</span>&nbsp;<span class="ident" id="4999611">err</span>&nbsp;<span class="op" id="4999615">!=</span>&nbsp;<span class="ident" id="4999618">io</span><span class="op" id="4999620">.</span><span class="ident" id="4999621">EOF</span>&nbsp;<span class="op" id="4999625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999631">log</span><span class="op" id="4999634">.</span><span class="ident" id="4999635">Println</span><span class="op" id="4999642">(</span><span class="string" id="4999643">&#34;rpc:&#34;</span><span class="op" id="4999649">,</span>&nbsp;<span class="ident" id="4999651">err</span><span class="op" id="4999654">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999664">if</span>&nbsp;<span class="op" id="4999667">!</span><span class="ident" id="4999668">keepReading</span>&nbsp;<span class="op" id="4999680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999686">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999700">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999763">if</span>&nbsp;<span class="ident" id="4999766">req</span>&nbsp;<span class="op" id="4999770">!=</span>&nbsp;<span class="ident" id="4999773">nil</span>&nbsp;<span class="op" id="4999777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999783">server</span><span class="op" id="4999789">.</span><span class="ident" id="4999790">sendResponse</span><span class="op" id="4999802">(</span><span class="ident" id="4999803">sending</span><span class="op" id="4999810">,</span>&nbsp;<span class="ident" id="4999812">req</span><span class="op" id="4999815">,</span>&nbsp;<span class="ident" id="4999817">invalidRequest</span><span class="op" id="4999831">,</span>&nbsp;<span class="ident" id="4999833">codec</span><span class="op" id="4999838">,</span>&nbsp;<span class="ident" id="4999840">err</span><span class="op" id="4999843">.</span><span class="ident" id="4999844">Error</span><span class="op" id="4999849">(</span><span class="op" id="4999850">)</span><span class="op" id="4999851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999857">server</span><span class="op" id="4999863">.</span><span class="ident" id="4999864">freeRequest</span><span class="op" id="4999875">(</span><span class="ident" id="4999876">req</span><span class="op" id="4999879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999889">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999904">go</span>&nbsp;<span class="ident" id="4999907">service</span><span class="op" id="4999914">.</span><span class="ident" id="4999915">call</span><span class="op" id="4999919">(</span><span class="ident" id="4999920">server</span><span class="op" id="4999926">,</span>&nbsp;<span class="ident" id="4999928">sending</span><span class="op" id="4999935">,</span>&nbsp;<span class="ident" id="4999937">mtype</span><span class="op" id="4999942">,</span>&nbsp;<span class="ident" id="4999944">req</span><span class="op" id="4999947">,</span>&nbsp;<span class="ident" id="4999949">argv</span><span class="op" id="4999953">,</span>&nbsp;<span class="ident" id="4999955">replyv</span><span class="op" id="4999961">,</span>&nbsp;<span class="ident" id="4999963">codec</span><span class="op" id="4999968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999974">codec</span><span class="op" id="4999979">.</span><span class="ident" id="4999980">Close</span><span class="op" id="4999985">(</span><span class="op" id="4999986">)</span><br>
<span class="lineno"></span><span class="op" id="4999988">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4999991">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5000069">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5000117">func</span>&nbsp;<span class="op" id="5000122">(</span><span class="ident" id="5000123">server</span>&nbsp;<span class="op" id="5000130">*</span><span class="ident" id="5000131">Server</span><span class="op" id="5000137">)</span>&nbsp;<span class="ident" id="5000139">ServeRequest</span><span class="op" id="5000151">(</span><span class="ident" id="5000152">codec</span>&nbsp;<span class="ident" id="5000158">ServerCodec</span><span class="op" id="5000169">)</span>&nbsp;<span class="builtintype" id="5000171">error</span>&nbsp;<span class="op" id="5000177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000180">sending</span>&nbsp;<span class="op" id="5000188">:=</span>&nbsp;<span class="builtinfunc" id="5000191">new</span><span class="op" id="5000194">(</span><span class="ident" id="5000195">sync</span><span class="op" id="5000199">.</span><span class="ident" id="5000200">Mutex</span><span class="op" id="5000205">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000208">service</span><span class="op" id="5000215">,</span>&nbsp;<span class="ident" id="5000217">mtype</span><span class="op" id="5000222">,</span>&nbsp;<span class="ident" id="5000224">req</span><span class="op" id="5000227">,</span>&nbsp;<span class="ident" id="5000229">argv</span><span class="op" id="5000233">,</span>&nbsp;<span class="ident" id="5000235">replyv</span><span class="op" id="5000241">,</span>&nbsp;<span class="ident" id="5000243">keepReading</span><span class="op" id="5000254">,</span>&nbsp;<span class="ident" id="5000256">err</span>&nbsp;<span class="op" id="5000260">:=</span>&nbsp;<span class="ident" id="5000263">server</span><span class="op" id="5000269">.</span><span class="ident" id="5000270">readRequest</span><span class="op" id="5000281">(</span><span class="ident" id="5000282">codec</span><span class="op" id="5000287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000290">if</span>&nbsp;<span class="ident" id="5000293">err</span>&nbsp;<span class="op" id="5000297">!=</span>&nbsp;<span class="ident" id="5000300">nil</span>&nbsp;<span class="op" id="5000304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000308">if</span>&nbsp;<span class="op" id="5000311">!</span><span class="ident" id="5000312">keepReading</span>&nbsp;<span class="op" id="5000324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000329">return</span>&nbsp;<span class="ident" id="5000336">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000342">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000346">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000408">if</span>&nbsp;<span class="ident" id="5000411">req</span>&nbsp;<span class="op" id="5000415">!=</span>&nbsp;<span class="ident" id="5000418">nil</span>&nbsp;<span class="op" id="5000422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000427">server</span><span class="op" id="5000433">.</span><span class="ident" id="5000434">sendResponse</span><span class="op" id="5000446">(</span><span class="ident" id="5000447">sending</span><span class="op" id="5000454">,</span>&nbsp;<span class="ident" id="5000456">req</span><span class="op" id="5000459">,</span>&nbsp;<span class="ident" id="5000461">invalidRequest</span><span class="op" id="5000475">,</span>&nbsp;<span class="ident" id="5000477">codec</span><span class="op" id="5000482">,</span>&nbsp;<span class="ident" id="5000484">err</span><span class="op" id="5000487">.</span><span class="ident" id="5000488">Error</span><span class="op" id="5000493">(</span><span class="op" id="5000494">)</span><span class="op" id="5000495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000500">server</span><span class="op" id="5000506">.</span><span class="ident" id="5000507">freeRequest</span><span class="op" id="5000518">(</span><span class="ident" id="5000519">req</span><span class="op" id="5000522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000526">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000530">return</span>&nbsp;<span class="ident" id="5000537">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000545">service</span><span class="op" id="5000552">.</span><span class="ident" id="5000553">call</span><span class="op" id="5000557">(</span><span class="ident" id="5000558">server</span><span class="op" id="5000564">,</span>&nbsp;<span class="ident" id="5000566">sending</span><span class="op" id="5000573">,</span>&nbsp;<span class="ident" id="5000575">mtype</span><span class="op" id="5000580">,</span>&nbsp;<span class="ident" id="5000582">req</span><span class="op" id="5000585">,</span>&nbsp;<span class="ident" id="5000587">argv</span><span class="op" id="5000591">,</span>&nbsp;<span class="ident" id="5000593">replyv</span><span class="op" id="5000599">,</span>&nbsp;<span class="ident" id="5000601">codec</span><span class="op" id="5000606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000609">return</span>&nbsp;<span class="ident" id="5000616">nil</span><br>
<span class="lineno"></span><span class="op" id="5000620">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5000623">func</span>&nbsp;<span class="op" id="5000628">(</span><span class="ident" id="5000629">server</span>&nbsp;<span class="op" id="5000636">*</span><span class="ident" id="5000637">Server</span><span class="op" id="5000643">)</span>&nbsp;<span class="ident" id="5000645">getRequest</span><span class="op" id="5000655">(</span><span class="op" id="5000656">)</span>&nbsp;<span class="op" id="5000658">*</span><span class="ident" id="5000659">Request</span>&nbsp;<span class="op" id="5000667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000670">server</span><span class="op" id="5000676">.</span><span class="ident" id="5000677">reqLock</span><span class="op" id="5000684">.</span><span class="ident" id="5000685">Lock</span><span class="op" id="5000689">(</span><span class="op" id="5000690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000693">req</span>&nbsp;<span class="op" id="5000697">:=</span>&nbsp;<span class="ident" id="5000700">server</span><span class="op" id="5000706">.</span><span class="ident" id="5000707">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000716">if</span>&nbsp;<span class="ident" id="5000719">req</span>&nbsp;<span class="op" id="5000723">==</span>&nbsp;<span class="ident" id="5000726">nil</span>&nbsp;<span class="op" id="5000730">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000734">req</span>&nbsp;<span class="op" id="5000738">=</span>&nbsp;<span class="builtinfunc" id="5000740">new</span><span class="op" id="5000743">(</span><span class="ident" id="5000744">Request</span><span class="op" id="5000751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000754">}</span>&nbsp;<span class="keyword" id="5000756">else</span>&nbsp;<span class="op" id="5000761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000765">server</span><span class="op" id="5000771">.</span><span class="ident" id="5000772">freeReq</span>&nbsp;<span class="op" id="5000780">=</span>&nbsp;<span class="ident" id="5000782">req</span><span class="op" id="5000785">.</span><span class="ident" id="5000786">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000793">*</span><span class="ident" id="5000794">req</span>&nbsp;<span class="op" id="5000798">=</span>&nbsp;<span class="ident" id="5000800">Request</span><span class="op" id="5000807">{</span><span class="op" id="5000808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000811">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000814">server</span><span class="op" id="5000820">.</span><span class="ident" id="5000821">reqLock</span><span class="op" id="5000828">.</span><span class="ident" id="5000829">Unlock</span><span class="op" id="5000835">(</span><span class="op" id="5000836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000839">return</span>&nbsp;<span class="ident" id="5000846">req</span><br>
<span class="lineno"></span><span class="op" id="5000850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5000853">func</span>&nbsp;<span class="op" id="5000858">(</span><span class="ident" id="5000859">server</span>&nbsp;<span class="op" id="5000866">*</span><span class="ident" id="5000867">Server</span><span class="op" id="5000873">)</span>&nbsp;<span class="ident" id="5000875">freeRequest</span><span class="op" id="5000886">(</span><span class="ident" id="5000887">req</span>&nbsp;<span class="op" id="5000891">*</span><span class="ident" id="5000892">Request</span><span class="op" id="5000899">)</span>&nbsp;<span class="op" id="5000901">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000904">server</span><span class="op" id="5000910">.</span><span class="ident" id="5000911">reqLock</span><span class="op" id="5000918">.</span><span class="ident" id="5000919">Lock</span><span class="op" id="5000923">(</span><span class="op" id="5000924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000927">req</span><span class="op" id="5000930">.</span><span class="ident" id="5000931">next</span>&nbsp;<span class="op" id="5000936">=</span>&nbsp;<span class="ident" id="5000938">server</span><span class="op" id="5000944">.</span><span class="ident" id="5000945">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000954">server</span><span class="op" id="5000960">.</span><span class="ident" id="5000961">freeReq</span>&nbsp;<span class="op" id="5000969">=</span>&nbsp;<span class="ident" id="5000971">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000976">server</span><span class="op" id="5000982">.</span><span class="ident" id="5000983">reqLock</span><span class="op" id="5000990">.</span><span class="ident" id="5000991">Unlock</span><span class="op" id="5000997">(</span><span class="op" id="5000998">)</span><br>
<span class="lineno"></span><span class="op" id="5001000">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5001003">func</span>&nbsp;<span class="op" id="5001008">(</span><span class="ident" id="5001009">server</span>&nbsp;<span class="op" id="5001016">*</span><span class="ident" id="5001017">Server</span><span class="op" id="5001023">)</span>&nbsp;<span class="ident" id="5001025">getResponse</span><span class="op" id="5001036">(</span><span class="op" id="5001037">)</span>&nbsp;<span class="op" id="5001039">*</span><span class="ident" id="5001040">Response</span>&nbsp;<span class="op" id="5001049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001052">server</span><span class="op" id="5001058">.</span><span class="ident" id="5001059">respLock</span><span class="op" id="5001067">.</span><span class="ident" id="5001068">Lock</span><span class="op" id="5001072">(</span><span class="op" id="5001073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001076">resp</span>&nbsp;<span class="op" id="5001081">:=</span>&nbsp;<span class="ident" id="5001084">server</span><span class="op" id="5001090">.</span><span class="ident" id="5001091">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001101">if</span>&nbsp;<span class="ident" id="5001104">resp</span>&nbsp;<span class="op" id="5001109">==</span>&nbsp;<span class="ident" id="5001112">nil</span>&nbsp;<span class="op" id="5001116">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001120">resp</span>&nbsp;<span class="op" id="5001125">=</span>&nbsp;<span class="builtinfunc" id="5001127">new</span><span class="op" id="5001130">(</span><span class="ident" id="5001131">Response</span><span class="op" id="5001139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001142">}</span>&nbsp;<span class="keyword" id="5001144">else</span>&nbsp;<span class="op" id="5001149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001153">server</span><span class="op" id="5001159">.</span><span class="ident" id="5001160">freeResp</span>&nbsp;<span class="op" id="5001169">=</span>&nbsp;<span class="ident" id="5001171">resp</span><span class="op" id="5001175">.</span><span class="ident" id="5001176">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001183">*</span><span class="ident" id="5001184">resp</span>&nbsp;<span class="op" id="5001189">=</span>&nbsp;<span class="ident" id="5001191">Response</span><span class="op" id="5001199">{</span><span class="op" id="5001200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001203">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001206">server</span><span class="op" id="5001212">.</span><span class="ident" id="5001213">respLock</span><span class="op" id="5001221">.</span><span class="ident" id="5001222">Unlock</span><span class="op" id="5001228">(</span><span class="op" id="5001229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001232">return</span>&nbsp;<span class="ident" id="5001239">resp</span><br>
<span class="lineno"></span><span class="op" id="5001244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5001247">func</span>&nbsp;<span class="op" id="5001252">(</span><span class="ident" id="5001253">server</span>&nbsp;<span class="op" id="5001260">*</span><span class="ident" id="5001261">Server</span><span class="op" id="5001267">)</span>&nbsp;<span class="ident" id="5001269">freeResponse</span><span class="op" id="5001281">(</span><span class="ident" id="5001282">resp</span>&nbsp;<span class="op" id="5001287">*</span><span class="ident" id="5001288">Response</span><span class="op" id="5001296">)</span>&nbsp;<span class="op" id="5001298">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001301">server</span><span class="op" id="5001307">.</span><span class="ident" id="5001308">respLock</span><span class="op" id="5001316">.</span><span class="ident" id="5001317">Lock</span><span class="op" id="5001321">(</span><span class="op" id="5001322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001325">resp</span><span class="op" id="5001329">.</span><span class="ident" id="5001330">next</span>&nbsp;<span class="op" id="5001335">=</span>&nbsp;<span class="ident" id="5001337">server</span><span class="op" id="5001343">.</span><span class="ident" id="5001344">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001354">server</span><span class="op" id="5001360">.</span><span class="ident" id="5001361">freeResp</span>&nbsp;<span class="op" id="5001370">=</span>&nbsp;<span class="ident" id="5001372">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001378">server</span><span class="op" id="5001384">.</span><span class="ident" id="5001385">respLock</span><span class="op" id="5001393">.</span><span class="ident" id="5001394">Unlock</span><span class="op" id="5001400">(</span><span class="op" id="5001401">)</span><br>
<span class="lineno"></span><span class="op" id="5001403">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5001406">func</span>&nbsp;<span class="op" id="5001411">(</span><span class="ident" id="5001412">server</span>&nbsp;<span class="op" id="5001419">*</span><span class="ident" id="5001420">Server</span><span class="op" id="5001426">)</span>&nbsp;<span class="ident" id="5001428">readRequest</span><span class="op" id="5001439">(</span><span class="ident" id="5001440">codec</span>&nbsp;<span class="ident" id="5001446">ServerCodec</span><span class="op" id="5001457">)</span>&nbsp;<span class="op" id="5001459">(</span><span class="ident" id="5001460">service</span>&nbsp;<span class="op" id="5001468">*</span><span class="ident" id="5001469">service</span><span class="op" id="5001476">,</span>&nbsp;<span class="ident" id="5001478">mtype</span>&nbsp;<span class="op" id="5001484">*</span><span class="ident" id="5001485">methodType</span><span class="op" id="5001495">,</span>&nbsp;<span class="ident" id="5001497">req</span>&nbsp;<span class="op" id="5001501">*</span><span class="ident" id="5001502">Request</span><span class="op" id="5001509">,</span>&nbsp;<span class="ident" id="5001511">argv</span><span class="op" id="5001515">,</span>&nbsp;<span class="ident" id="5001517">replyv</span>&nbsp;<span class="ident" id="5001524">reflect</span><span class="op" id="5001531">.</span><span class="ident" id="5001532">Value</span><span class="op" id="5001537">,</span>&nbsp;<span class="ident" id="5001539">keepReading</span>&nbsp;<span class="builtintype" id="5001551">bool</span><span class="op" id="5001555">,</span>&nbsp;<span class="ident" id="5001557">err</span>&nbsp;<span class="builtintype" id="5001561">error</span><span class="op" id="5001566">)</span>&nbsp;<span class="op" id="5001568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001571">service</span><span class="op" id="5001578">,</span>&nbsp;<span class="ident" id="5001580">mtype</span><span class="op" id="5001585">,</span>&nbsp;<span class="ident" id="5001587">req</span><span class="op" id="5001590">,</span>&nbsp;<span class="ident" id="5001592">keepReading</span><span class="op" id="5001603">,</span>&nbsp;<span class="ident" id="5001605">err</span>&nbsp;<span class="op" id="5001609">=</span>&nbsp;<span class="ident" id="5001611">server</span><span class="op" id="5001617">.</span><span class="ident" id="5001618">readRequestHeader</span><span class="op" id="5001635">(</span><span class="ident" id="5001636">codec</span><span class="op" id="5001641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001644">if</span>&nbsp;<span class="ident" id="5001647">err</span>&nbsp;<span class="op" id="5001651">!=</span>&nbsp;<span class="ident" id="5001654">nil</span>&nbsp;<span class="op" id="5001658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001662">if</span>&nbsp;<span class="op" id="5001665">!</span><span class="ident" id="5001666">keepReading</span>&nbsp;<span class="op" id="5001678">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001683">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001696">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001714">codec</span><span class="op" id="5001719">.</span><span class="ident" id="5001720">ReadRequestBody</span><span class="op" id="5001735">(</span><span class="ident" id="5001736">nil</span><span class="op" id="5001739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001743">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001755">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001786">argIsValue</span>&nbsp;<span class="op" id="5001797">:=</span>&nbsp;<span class="builtintype" id="5001800">false</span>&nbsp;<span class="comment" id="5001806">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001852">if</span>&nbsp;<span class="ident" id="5001855">mtype</span><span class="op" id="5001860">.</span><span class="ident" id="5001861">ArgType</span><span class="op" id="5001868">.</span><span class="ident" id="5001869">Kind</span><span class="op" id="5001873">(</span><span class="op" id="5001874">)</span>&nbsp;<span class="op" id="5001876">==</span>&nbsp;<span class="ident" id="5001879">reflect</span><span class="op" id="5001886">.</span><span class="ident" id="5001887">Ptr</span>&nbsp;<span class="op" id="5001891">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001895">argv</span>&nbsp;<span class="op" id="5001900">=</span>&nbsp;<span class="ident" id="5001902">reflect</span><span class="op" id="5001909">.</span><span class="ident" id="5001910">New</span><span class="op" id="5001913">(</span><span class="ident" id="5001914">mtype</span><span class="op" id="5001919">.</span><span class="ident" id="5001920">ArgType</span><span class="op" id="5001927">.</span><span class="ident" id="5001928">Elem</span><span class="op" id="5001932">(</span><span class="op" id="5001933">)</span><span class="op" id="5001934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001937">}</span>&nbsp;<span class="keyword" id="5001939">else</span>&nbsp;<span class="op" id="5001944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001948">argv</span>&nbsp;<span class="op" id="5001953">=</span>&nbsp;<span class="ident" id="5001955">reflect</span><span class="op" id="5001962">.</span><span class="ident" id="5001963">New</span><span class="op" id="5001966">(</span><span class="ident" id="5001967">mtype</span><span class="op" id="5001972">.</span><span class="ident" id="5001973">ArgType</span><span class="op" id="5001980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001984">argIsValue</span>&nbsp;<span class="op" id="5001995">=</span>&nbsp;<span class="builtintype" id="5001997">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002003">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002006">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002047">if</span>&nbsp;<span class="ident" id="5002050">err</span>&nbsp;<span class="op" id="5002054">=</span>&nbsp;<span class="ident" id="5002056">codec</span><span class="op" id="5002061">.</span><span class="ident" id="5002062">ReadRequestBody</span><span class="op" id="5002077">(</span><span class="ident" id="5002078">argv</span><span class="op" id="5002082">.</span><span class="ident" id="5002083">Interface</span><span class="op" id="5002092">(</span><span class="op" id="5002093">)</span><span class="op" id="5002094">)</span><span class="op" id="5002095">;</span>&nbsp;<span class="ident" id="5002097">err</span>&nbsp;<span class="op" id="5002101">!=</span>&nbsp;<span class="ident" id="5002104">nil</span>&nbsp;<span class="op" id="5002108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002112">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002123">if</span>&nbsp;<span class="ident" id="5002126">argIsValue</span>&nbsp;<span class="op" id="5002137">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002141">argv</span>&nbsp;<span class="op" id="5002146">=</span>&nbsp;<span class="ident" id="5002148">argv</span><span class="op" id="5002152">.</span><span class="ident" id="5002153">Elem</span><span class="op" id="5002157">(</span><span class="op" id="5002158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002165">replyv</span>&nbsp;<span class="op" id="5002172">=</span>&nbsp;<span class="ident" id="5002174">reflect</span><span class="op" id="5002181">.</span><span class="ident" id="5002182">New</span><span class="op" id="5002185">(</span><span class="ident" id="5002186">mtype</span><span class="op" id="5002191">.</span><span class="ident" id="5002192">ReplyType</span><span class="op" id="5002201">.</span><span class="ident" id="5002202">Elem</span><span class="op" id="5002206">(</span><span class="op" id="5002207">)</span><span class="op" id="5002208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002211">return</span><br>
<span class="lineno">570</span><span class="op" id="5002218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5002221">func</span>&nbsp;<span class="op" id="5002226">(</span><span class="ident" id="5002227">server</span>&nbsp;<span class="op" id="5002234">*</span><span class="ident" id="5002235">Server</span><span class="op" id="5002241">)</span>&nbsp;<span class="ident" id="5002243">readRequestHeader</span><span class="op" id="5002260">(</span><span class="ident" id="5002261">codec</span>&nbsp;<span class="ident" id="5002267">ServerCodec</span><span class="op" id="5002278">)</span>&nbsp;<span class="op" id="5002280">(</span><span class="ident" id="5002281">service</span>&nbsp;<span class="op" id="5002289">*</span><span class="ident" id="5002290">service</span><span class="op" id="5002297">,</span>&nbsp;<span class="ident" id="5002299">mtype</span>&nbsp;<span class="op" id="5002305">*</span><span class="ident" id="5002306">methodType</span><span class="op" id="5002316">,</span>&nbsp;<span class="ident" id="5002318">req</span>&nbsp;<span class="op" id="5002322">*</span><span class="ident" id="5002323">Request</span><span class="op" id="5002330">,</span>&nbsp;<span class="ident" id="5002332">keepReading</span>&nbsp;<span class="builtintype" id="5002344">bool</span><span class="op" id="5002348">,</span>&nbsp;<span class="ident" id="5002350">err</span>&nbsp;<span class="builtintype" id="5002354">error</span><span class="op" id="5002359">)</span>&nbsp;<span class="op" id="5002361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002364">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002393">req</span>&nbsp;<span class="op" id="5002397">=</span>&nbsp;<span class="ident" id="5002399">server</span><span class="op" id="5002405">.</span><span class="ident" id="5002406">getRequest</span><span class="op" id="5002416">(</span><span class="op" id="5002417">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002420">err</span>&nbsp;<span class="op" id="5002424">=</span>&nbsp;<span class="ident" id="5002426">codec</span><span class="op" id="5002431">.</span><span class="ident" id="5002432">ReadRequestHeader</span><span class="op" id="5002449">(</span><span class="ident" id="5002450">req</span><span class="op" id="5002453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002456">if</span>&nbsp;<span class="ident" id="5002459">err</span>&nbsp;<span class="op" id="5002463">!=</span>&nbsp;<span class="ident" id="5002466">nil</span>&nbsp;<span class="op" id="5002470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002474">req</span>&nbsp;<span class="op" id="5002478">=</span>&nbsp;<span class="ident" id="5002480">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002486">if</span>&nbsp;<span class="ident" id="5002489">err</span>&nbsp;<span class="op" id="5002493">==</span>&nbsp;<span class="ident" id="5002496">io</span><span class="op" id="5002498">.</span><span class="ident" id="5002499">EOF</span>&nbsp;<span class="op" id="5002503">||</span>&nbsp;<span class="ident" id="5002506">err</span>&nbsp;<span class="op" id="5002510">==</span>&nbsp;<span class="ident" id="5002513">io</span><span class="op" id="5002515">.</span><span class="ident" id="5002516">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5002533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002538">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002551">err</span>&nbsp;<span class="op" id="5002555">=</span>&nbsp;<span class="ident" id="5002557">errors</span><span class="op" id="5002563">.</span><span class="ident" id="5002564">New</span><span class="op" id="5002567">(</span><span class="string" id="5002568">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5002606">+</span>&nbsp;<span class="ident" id="5002608">err</span><span class="op" id="5002611">.</span><span class="ident" id="5002612">Error</span><span class="op" id="5002617">(</span><span class="op" id="5002618">)</span><span class="op" id="5002619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002623">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002635">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002697">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002755">keepReading</span>&nbsp;<span class="op" id="5002767">=</span>&nbsp;<span class="builtintype" id="5002769">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002776">dot</span>&nbsp;<span class="op" id="5002780">:=</span>&nbsp;<span class="ident" id="5002783">strings</span><span class="op" id="5002790">.</span><span class="ident" id="5002791">LastIndex</span><span class="op" id="5002800">(</span><span class="ident" id="5002801">req</span><span class="op" id="5002804">.</span><span class="ident" id="5002805">ServiceMethod</span><span class="op" id="5002818">,</span>&nbsp;<span class="string" id="5002820">&#34;.&#34;</span><span class="op" id="5002823">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002826">if</span>&nbsp;<span class="ident" id="5002829">dot</span>&nbsp;<span class="op" id="5002833">&lt;</span>&nbsp;<span class="num" id="5002835">0</span>&nbsp;<span class="op" id="5002837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002841">err</span>&nbsp;<span class="op" id="5002845">=</span>&nbsp;<span class="ident" id="5002847">errors</span><span class="op" id="5002853">.</span><span class="ident" id="5002854">New</span><span class="op" id="5002857">(</span><span class="string" id="5002858">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5002901">+</span>&nbsp;<span class="ident" id="5002903">req</span><span class="op" id="5002906">.</span><span class="ident" id="5002907">ServiceMethod</span><span class="op" id="5002920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002924">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002935">serviceName</span>&nbsp;<span class="op" id="5002947">:=</span>&nbsp;<span class="ident" id="5002950">req</span><span class="op" id="5002953">.</span><span class="ident" id="5002954">ServiceMethod</span><span class="op" id="5002967">[</span><span class="op" id="5002968">:</span><span class="ident" id="5002969">dot</span><span class="op" id="5002972">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002975">methodName</span>&nbsp;<span class="op" id="5002986">:=</span>&nbsp;<span class="ident" id="5002989">req</span><span class="op" id="5002992">.</span><span class="ident" id="5002993">ServiceMethod</span><span class="op" id="5003006">[</span><span class="ident" id="5003007">dot</span><span class="op" id="5003010">+</span><span class="num" id="5003011">1</span><span class="op" id="5003012">:</span><span class="op" id="5003013">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5003017">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003042">server</span><span class="op" id="5003048">.</span><span class="ident" id="5003049">mu</span><span class="op" id="5003051">.</span><span class="ident" id="5003052">RLock</span><span class="op" id="5003057">(</span><span class="op" id="5003058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003061">service</span>&nbsp;<span class="op" id="5003069">=</span>&nbsp;<span class="ident" id="5003071">server</span><span class="op" id="5003077">.</span><span class="ident" id="5003078">serviceMap</span><span class="op" id="5003088">[</span><span class="ident" id="5003089">serviceName</span><span class="op" id="5003100">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003103">server</span><span class="op" id="5003109">.</span><span class="ident" id="5003110">mu</span><span class="op" id="5003112">.</span><span class="ident" id="5003113">RUnlock</span><span class="op" id="5003120">(</span><span class="op" id="5003121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003124">if</span>&nbsp;<span class="ident" id="5003127">service</span>&nbsp;<span class="op" id="5003135">==</span>&nbsp;<span class="ident" id="5003138">nil</span>&nbsp;<span class="op" id="5003142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003146">err</span>&nbsp;<span class="op" id="5003150">=</span>&nbsp;<span class="ident" id="5003152">errors</span><span class="op" id="5003158">.</span><span class="ident" id="5003159">New</span><span class="op" id="5003162">(</span><span class="string" id="5003163">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5003190">+</span>&nbsp;<span class="ident" id="5003192">req</span><span class="op" id="5003195">.</span><span class="ident" id="5003196">ServiceMethod</span><span class="op" id="5003209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003213">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003221">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003224">mtype</span>&nbsp;<span class="op" id="5003230">=</span>&nbsp;<span class="ident" id="5003232">service</span><span class="op" id="5003239">.</span><span class="ident" id="5003240">method</span><span class="op" id="5003246">[</span><span class="ident" id="5003247">methodName</span><span class="op" id="5003257">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003260">if</span>&nbsp;<span class="ident" id="5003263">mtype</span>&nbsp;<span class="op" id="5003269">==</span>&nbsp;<span class="ident" id="5003272">nil</span>&nbsp;<span class="op" id="5003276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003280">err</span>&nbsp;<span class="op" id="5003284">=</span>&nbsp;<span class="ident" id="5003286">errors</span><span class="op" id="5003292">.</span><span class="ident" id="5003293">New</span><span class="op" id="5003296">(</span><span class="string" id="5003297">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5003323">+</span>&nbsp;<span class="ident" id="5003325">req</span><span class="op" id="5003328">.</span><span class="ident" id="5003329">ServiceMethod</span><span class="op" id="5003342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003348">return</span><br>
<span class="lineno">610</span><span class="op" id="5003355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5003358">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5003424">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5003494">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5003527">func</span>&nbsp;<span class="op" id="5003532">(</span><span class="ident" id="5003533">server</span>&nbsp;<span class="op" id="5003540">*</span><span class="ident" id="5003541">Server</span><span class="op" id="5003547">)</span>&nbsp;<span class="ident" id="5003549">Accept</span><span class="op" id="5003555">(</span><span class="ident" id="5003556">lis</span>&nbsp;<span class="ident" id="5003560">net</span><span class="op" id="5003563">.</span><span class="ident" id="5003564">Listener</span><span class="op" id="5003572">)</span>&nbsp;<span class="op" id="5003574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003577">for</span>&nbsp;<span class="op" id="5003581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003585">conn</span><span class="op" id="5003589">,</span>&nbsp;<span class="ident" id="5003591">err</span>&nbsp;<span class="op" id="5003595">:=</span>&nbsp;<span class="ident" id="5003598">lis</span><span class="op" id="5003601">.</span><span class="ident" id="5003602">Accept</span><span class="op" id="5003608">(</span><span class="op" id="5003609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003613">if</span>&nbsp;<span class="ident" id="5003616">err</span>&nbsp;<span class="op" id="5003620">!=</span>&nbsp;<span class="ident" id="5003623">nil</span>&nbsp;<span class="op" id="5003627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003632">log</span><span class="op" id="5003635">.</span><span class="ident" id="5003636">Fatal</span><span class="op" id="5003641">(</span><span class="string" id="5003642">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5003662">,</span>&nbsp;<span class="ident" id="5003664">err</span><span class="op" id="5003667">.</span><span class="ident" id="5003668">Error</span><span class="op" id="5003673">(</span><span class="op" id="5003674">)</span><span class="op" id="5003675">)</span>&nbsp;<span class="comment" id="5003677">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5003701">go</span>&nbsp;<span class="ident" id="5003704">server</span><span class="op" id="5003710">.</span><span class="ident" id="5003711">ServeConn</span><span class="op" id="5003720">(</span><span class="ident" id="5003721">conn</span><span class="op" id="5003725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003728">}</span><br>
<span class="lineno"></span><span class="op" id="5003730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5003733">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5003800">func</span>&nbsp;<span class="ident" id="5003805">Register</span><span class="op" id="5003813">(</span><span class="ident" id="5003814">rcvr</span>&nbsp;<span class="keyword" id="5003819">interface</span><span class="op" id="5003828">{</span><span class="op" id="5003829">}</span><span class="op" id="5003830">)</span>&nbsp;<span class="builtintype" id="5003832">error</span>&nbsp;<span class="op" id="5003838">{</span>&nbsp;<span class="keyword" id="5003840">return</span>&nbsp;<span class="ident" id="5003847">DefaultServer</span><span class="op" id="5003860">.</span><span class="ident" id="5003861">Register</span><span class="op" id="5003869">(</span><span class="ident" id="5003870">rcvr</span><span class="op" id="5003874">)</span>&nbsp;<span class="op" id="5003876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5003879">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5003952">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5003996">func</span>&nbsp;<span class="ident" id="5004001">RegisterName</span><span class="op" id="5004013">(</span><span class="ident" id="5004014">name</span>&nbsp;<span class="builtintype" id="5004019">string</span><span class="op" id="5004025">,</span>&nbsp;<span class="ident" id="5004027">rcvr</span>&nbsp;<span class="keyword" id="5004032">interface</span><span class="op" id="5004041">{</span><span class="op" id="5004042">}</span><span class="op" id="5004043">)</span>&nbsp;<span class="builtintype" id="5004045">error</span>&nbsp;<span class="op" id="5004051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5004054">return</span>&nbsp;<span class="ident" id="5004061">DefaultServer</span><span class="op" id="5004074">.</span><span class="ident" id="5004075">RegisterName</span><span class="op" id="5004087">(</span><span class="ident" id="5004088">name</span><span class="op" id="5004092">,</span>&nbsp;<span class="ident" id="5004094">rcvr</span><span class="op" id="5004098">)</span><br>
<span class="lineno"></span><span class="op" id="5004100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5004103">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5004170">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5004226">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5004293">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5004364">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5004437">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5004493">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5004564">type</span>&nbsp;<span class="ident" id="5004569">ServerCodec</span>&nbsp;<span class="keyword" id="5004581">interface</span>&nbsp;<span class="op" id="5004591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004594">ReadRequestHeader</span><span class="op" id="5004611">(</span><span class="op" id="5004612">*</span><span class="ident" id="5004613">Request</span><span class="op" id="5004620">)</span>&nbsp;<span class="builtintype" id="5004622">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004629">ReadRequestBody</span><span class="op" id="5004644">(</span><span class="keyword" id="5004645">interface</span><span class="op" id="5004654">{</span><span class="op" id="5004655">}</span><span class="op" id="5004656">)</span>&nbsp;<span class="builtintype" id="5004658">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004665">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004739">WriteResponse</span><span class="op" id="5004752">(</span><span class="op" id="5004753">*</span><span class="ident" id="5004754">Response</span><span class="op" id="5004762">,</span>&nbsp;<span class="keyword" id="5004764">interface</span><span class="op" id="5004773">{</span><span class="op" id="5004774">}</span><span class="op" id="5004775">)</span>&nbsp;<span class="builtintype" id="5004777">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004785">Close</span><span class="op" id="5004790">(</span><span class="op" id="5004791">)</span>&nbsp;<span class="builtintype" id="5004793">error</span><br>
<span class="lineno"></span><span class="op" id="5004799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5004802">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5004862">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5004933">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5004994">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5005057">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5005116">func</span>&nbsp;<span class="ident" id="5005121">ServeConn</span><span class="op" id="5005130">(</span><span class="ident" id="5005131">conn</span>&nbsp;<span class="ident" id="5005136">io</span><span class="op" id="5005138">.</span><span class="ident" id="5005139">ReadWriteCloser</span><span class="op" id="5005154">)</span>&nbsp;<span class="op" id="5005156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005159">DefaultServer</span><span class="op" id="5005172">.</span><span class="ident" id="5005173">ServeConn</span><span class="op" id="5005182">(</span><span class="ident" id="5005183">conn</span><span class="op" id="5005187">)</span><br>
<span class="lineno"></span><span class="op" id="5005189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5005192">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5005256">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5005297">func</span>&nbsp;<span class="ident" id="5005302">ServeCodec</span><span class="op" id="5005312">(</span><span class="ident" id="5005313">codec</span>&nbsp;<span class="ident" id="5005319">ServerCodec</span><span class="op" id="5005330">)</span>&nbsp;<span class="op" id="5005332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005335">DefaultServer</span><span class="op" id="5005348">.</span><span class="ident" id="5005349">ServeCodec</span><span class="op" id="5005359">(</span><span class="ident" id="5005360">codec</span><span class="op" id="5005365">)</span><br>
<span class="lineno"></span><span class="op" id="5005367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5005370">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5005448">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5005496">func</span>&nbsp;<span class="ident" id="5005501">ServeRequest</span><span class="op" id="5005513">(</span><span class="ident" id="5005514">codec</span>&nbsp;<span class="ident" id="5005520">ServerCodec</span><span class="op" id="5005531">)</span>&nbsp;<span class="builtintype" id="5005533">error</span>&nbsp;<span class="op" id="5005539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5005542">return</span>&nbsp;<span class="ident" id="5005549">DefaultServer</span><span class="op" id="5005562">.</span><span class="ident" id="5005563">ServeRequest</span><span class="op" id="5005575">(</span><span class="ident" id="5005576">codec</span><span class="op" id="5005581">)</span><br>
<span class="lineno"></span><span class="op" id="5005583">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5005586">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5005652">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5005702">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5005771">func</span>&nbsp;<span class="ident" id="5005776">Accept</span><span class="op" id="5005782">(</span><span class="ident" id="5005783">lis</span>&nbsp;<span class="ident" id="5005787">net</span><span class="op" id="5005790">.</span><span class="ident" id="5005791">Listener</span><span class="op" id="5005799">)</span>&nbsp;<span class="op" id="5005801">{</span>&nbsp;<span class="ident" id="5005803">DefaultServer</span><span class="op" id="5005816">.</span><span class="ident" id="5005817">Accept</span><span class="op" id="5005823">(</span><span class="ident" id="5005824">lis</span><span class="op" id="5005827">)</span>&nbsp;<span class="op" id="5005829">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5005832">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5005893">var</span>&nbsp;<span class="ident" id="5005897">connected</span>&nbsp;<span class="op" id="5005907">=</span>&nbsp;<span class="string" id="5005909">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5005936">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5006003">func</span>&nbsp;<span class="op" id="5006008">(</span><span class="ident" id="5006009">server</span>&nbsp;<span class="op" id="5006016">*</span><span class="ident" id="5006017">Server</span><span class="op" id="5006023">)</span>&nbsp;<span class="ident" id="5006025">ServeHTTP</span><span class="op" id="5006034">(</span><span class="ident" id="5006035">w</span>&nbsp;<span class="ident" id="5006037">http</span><span class="op" id="5006041">.</span><span class="ident" id="5006042">ResponseWriter</span><span class="op" id="5006056">,</span>&nbsp;<span class="ident" id="5006058">req</span>&nbsp;<span class="op" id="5006062">*</span><span class="ident" id="5006063">http</span><span class="op" id="5006067">.</span><span class="ident" id="5006068">Request</span><span class="op" id="5006075">)</span>&nbsp;<span class="op" id="5006077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5006080">if</span>&nbsp;<span class="ident" id="5006083">req</span><span class="op" id="5006086">.</span><span class="ident" id="5006087">Method</span>&nbsp;<span class="op" id="5006094">!=</span>&nbsp;<span class="string" id="5006097">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5006107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006111">w</span><span class="op" id="5006112">.</span><span class="ident" id="5006113">Header</span><span class="op" id="5006119">(</span><span class="op" id="5006120">)</span><span class="op" id="5006121">.</span><span class="ident" id="5006122">Set</span><span class="op" id="5006125">(</span><span class="string" id="5006126">&#34;Content-Type&#34;</span><span class="op" id="5006140">,</span>&nbsp;<span class="string" id="5006142">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5006169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006173">w</span><span class="op" id="5006174">.</span><span class="ident" id="5006175">WriteHeader</span><span class="op" id="5006186">(</span><span class="ident" id="5006187">http</span><span class="op" id="5006191">.</span><span class="ident" id="5006192">StatusMethodNotAllowed</span><span class="op" id="5006214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006218">io</span><span class="op" id="5006220">.</span><span class="ident" id="5006221">WriteString</span><span class="op" id="5006232">(</span><span class="ident" id="5006233">w</span><span class="op" id="5006234">,</span>&nbsp;<span class="string" id="5006236">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5006256">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5006260">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5006268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006271">conn</span><span class="op" id="5006275">,</span>&nbsp;<span class="ident" id="5006277">_</span><span class="op" id="5006278">,</span>&nbsp;<span class="ident" id="5006280">err</span>&nbsp;<span class="op" id="5006284">:=</span>&nbsp;<span class="ident" id="5006287">w</span><span class="op" id="5006288">.</span><span class="op" id="5006289">(</span><span class="ident" id="5006290">http</span><span class="op" id="5006294">.</span><span class="ident" id="5006295">Hijacker</span><span class="op" id="5006303">)</span><span class="op" id="5006304">.</span><span class="ident" id="5006305">Hijack</span><span class="op" id="5006311">(</span><span class="op" id="5006312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5006315">if</span>&nbsp;<span class="ident" id="5006318">err</span>&nbsp;<span class="op" id="5006322">!=</span>&nbsp;<span class="ident" id="5006325">nil</span>&nbsp;<span class="op" id="5006329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006333">log</span><span class="op" id="5006336">.</span><span class="ident" id="5006337">Print</span><span class="op" id="5006342">(</span><span class="string" id="5006343">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5006359">,</span>&nbsp;<span class="ident" id="5006361">req</span><span class="op" id="5006364">.</span><span class="ident" id="5006365">RemoteAddr</span><span class="op" id="5006375">,</span>&nbsp;<span class="string" id="5006377">&#34;:&nbsp;&#34;</span><span class="op" id="5006381">,</span>&nbsp;<span class="ident" id="5006383">err</span><span class="op" id="5006386">.</span><span class="ident" id="5006387">Error</span><span class="op" id="5006392">(</span><span class="op" id="5006393">)</span><span class="op" id="5006394">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5006398">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5006406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006409">io</span><span class="op" id="5006411">.</span><span class="ident" id="5006412">WriteString</span><span class="op" id="5006423">(</span><span class="ident" id="5006424">conn</span><span class="op" id="5006428">,</span>&nbsp;<span class="string" id="5006430">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5006441">+</span><span class="ident" id="5006442">connected</span><span class="op" id="5006451">+</span><span class="string" id="5006452">&#34;\n\n&#34;</span><span class="op" id="5006458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006461">server</span><span class="op" id="5006467">.</span><span class="ident" id="5006468">ServeConn</span><span class="op" id="5006477">(</span><span class="ident" id="5006478">conn</span><span class="op" id="5006482">)</span><br>
<span class="lineno"></span><span class="op" id="5006484">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5006487">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5006556">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5006597">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5006675">func</span>&nbsp;<span class="op" id="5006680">(</span><span class="ident" id="5006681">server</span>&nbsp;<span class="op" id="5006688">*</span><span class="ident" id="5006689">Server</span><span class="op" id="5006695">)</span>&nbsp;<span class="ident" id="5006697">HandleHTTP</span><span class="op" id="5006707">(</span><span class="ident" id="5006708">rpcPath</span><span class="op" id="5006715">,</span>&nbsp;<span class="ident" id="5006717">debugPath</span>&nbsp;<span class="builtintype" id="5006727">string</span><span class="op" id="5006733">)</span>&nbsp;<span class="op" id="5006735">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006738">http</span><span class="op" id="5006742">.</span><span class="ident" id="5006743">Handle</span><span class="op" id="5006749">(</span><span class="ident" id="5006750">rpcPath</span><span class="op" id="5006757">,</span>&nbsp;<span class="ident" id="5006759">server</span><span class="op" id="5006765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006768">http</span><span class="op" id="5006772">.</span><span class="ident" id="5006773">Handle</span><span class="op" id="5006779">(</span><span class="ident" id="5006780">debugPath</span><span class="op" id="5006789">,</span>&nbsp;<span class="ident" id="5006791">debugHTTP</span><span class="op" id="5006800">{</span><span class="ident" id="5006801">server</span><span class="op" id="5006807">}</span><span class="op" id="5006808">)</span><br>
<span class="lineno"></span><span class="op" id="5006810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5006813">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5006887">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5006953">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5007031">func</span>&nbsp;<span class="ident" id="5007036">HandleHTTP</span><span class="op" id="5007046">(</span><span class="op" id="5007047">)</span>&nbsp;<span class="op" id="5007049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5007052">DefaultServer</span><span class="op" id="5007065">.</span><span class="ident" id="5007066">HandleHTTP</span><span class="op" id="5007076">(</span><span class="ident" id="5007077">DefaultRPCPath</span><span class="op" id="5007091">,</span>&nbsp;<span class="ident" id="5007093">DefaultDebugPath</span><span class="op" id="5007109">)</span><br>
<span class="lineno"></span><span class="op" id="5007111">}</span>
</div>
</body>
</html>
