<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5699938">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5699993">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5700047">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5700098">package</span>&nbsp;<span class="ident" id="5700106">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5700111">import</span>&nbsp;<span class="op" id="5700118">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700121">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700130">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700147">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700161">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700170">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700185">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5700191">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5700201">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5700204">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5700247">type</span>&nbsp;<span class="ident" id="5700252">Encoder</span>&nbsp;<span class="keyword" id="5700260">struct</span>&nbsp;<span class="op" id="5700267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700270">CompressionLevel</span>&nbsp;<span class="ident" id="5700287">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5700304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5700307">type</span>&nbsp;<span class="ident" id="5700312">encoder</span>&nbsp;<span class="keyword" id="5700320">struct</span>&nbsp;<span class="op" id="5700327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700330">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5700337">*</span><span class="ident" id="5700338">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700347">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5700354">io</span><span class="op" id="5700356">.</span><span class="ident" id="5700357">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700365">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5700372">image</span><span class="op" id="5700377">.</span><span class="ident" id="5700378">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700385">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5700392">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700397">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5700404">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700411">header</span>&nbsp;<span class="op" id="5700418">[</span><span class="num" id="5700419">8</span><span class="op" id="5700420">]</span><span class="builtintype" id="5700421">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700427">footer</span>&nbsp;<span class="op" id="5700434">[</span><span class="num" id="5700435">4</span><span class="op" id="5700436">]</span><span class="builtintype" id="5700437">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700443">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5700450">[</span><span class="num" id="5700451">4</span>&nbsp;<span class="op" id="5700453">*</span>&nbsp;<span class="num" id="5700455">256</span><span class="op" id="5700458">]</span><span class="builtintype" id="5700459">byte</span><br>
<span class="lineno"></span><span class="op" id="5700464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5700467">type</span>&nbsp;<span class="ident" id="5700472">CompressionLevel</span>&nbsp;<span class="builtintype" id="5700489">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5700494">const</span>&nbsp;<span class="op" id="5700500">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700503">DefaultCompression</span>&nbsp;<span class="ident" id="5700522">CompressionLevel</span>&nbsp;<span class="op" id="5700539">=</span>&nbsp;<span class="num" id="5700541">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700544">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5700563">CompressionLevel</span>&nbsp;<span class="op" id="5700580">=</span>&nbsp;<span class="op" id="5700582">-</span><span class="num" id="5700583">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700586">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5700605">CompressionLevel</span>&nbsp;<span class="op" id="5700622">=</span>&nbsp;<span class="op" id="5700624">-</span><span class="num" id="5700625">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700628">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5700647">CompressionLevel</span>&nbsp;<span class="op" id="5700664">=</span>&nbsp;<span class="op" id="5700666">-</span><span class="num" id="5700667">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700671">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5700744">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5700804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5700807">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5700822">func</span>&nbsp;<span class="ident" id="5700827">writeUint32</span><span class="op" id="5700838">(</span><span class="ident" id="5700839">b</span>&nbsp;<span class="op" id="5700841">[</span><span class="op" id="5700842">]</span><span class="builtintype" id="5700843">uint8</span><span class="op" id="5700848">,</span>&nbsp;<span class="ident" id="5700850">u</span>&nbsp;<span class="builtintype" id="5700852">uint32</span><span class="op" id="5700858">)</span>&nbsp;<span class="op" id="5700860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700863">b</span><span class="op" id="5700864">[</span><span class="num" id="5700865">0</span><span class="op" id="5700866">]</span>&nbsp;<span class="op" id="5700868">=</span>&nbsp;<span class="builtintype" id="5700870">uint8</span><span class="op" id="5700875">(</span><span class="ident" id="5700876">u</span>&nbsp;<span class="op" id="5700878">&gt;&gt;</span>&nbsp;<span class="num" id="5700881">24</span><span class="op" id="5700883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700886">b</span><span class="op" id="5700887">[</span><span class="num" id="5700888">1</span><span class="op" id="5700889">]</span>&nbsp;<span class="op" id="5700891">=</span>&nbsp;<span class="builtintype" id="5700893">uint8</span><span class="op" id="5700898">(</span><span class="ident" id="5700899">u</span>&nbsp;<span class="op" id="5700901">&gt;&gt;</span>&nbsp;<span class="num" id="5700904">16</span><span class="op" id="5700906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700909">b</span><span class="op" id="5700910">[</span><span class="num" id="5700911">2</span><span class="op" id="5700912">]</span>&nbsp;<span class="op" id="5700914">=</span>&nbsp;<span class="builtintype" id="5700916">uint8</span><span class="op" id="5700921">(</span><span class="ident" id="5700922">u</span>&nbsp;<span class="op" id="5700924">&gt;&gt;</span>&nbsp;<span class="num" id="5700927">8</span><span class="op" id="5700928">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700931">b</span><span class="op" id="5700932">[</span><span class="num" id="5700933">3</span><span class="op" id="5700934">]</span>&nbsp;<span class="op" id="5700936">=</span>&nbsp;<span class="builtintype" id="5700938">uint8</span><span class="op" id="5700943">(</span><span class="ident" id="5700944">u</span>&nbsp;<span class="op" id="5700946">&gt;&gt;</span>&nbsp;<span class="num" id="5700949">0</span><span class="op" id="5700950">)</span><br>
<span class="lineno"></span><span class="op" id="5700952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5700955">type</span>&nbsp;<span class="ident" id="5700960">opaquer</span>&nbsp;<span class="keyword" id="5700968">interface</span>&nbsp;<span class="op" id="5700978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5700981">Opaque</span><span class="op" id="5700987">(</span><span class="op" id="5700988">)</span>&nbsp;<span class="builtintype" id="5700990">bool</span><br>
<span class="lineno">55</span><span class="op" id="5700995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5700998">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5701051">func</span>&nbsp;<span class="ident" id="5701056">opaque</span><span class="op" id="5701062">(</span><span class="ident" id="5701063">m</span>&nbsp;<span class="ident" id="5701065">image</span><span class="op" id="5701070">.</span><span class="ident" id="5701071">Image</span><span class="op" id="5701076">)</span>&nbsp;<span class="builtintype" id="5701078">bool</span>&nbsp;<span class="op" id="5701083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701086">if</span>&nbsp;<span class="ident" id="5701089">o</span><span class="op" id="5701090">,</span>&nbsp;<span class="ident" id="5701092">ok</span>&nbsp;<span class="op" id="5701095">:=</span>&nbsp;<span class="ident" id="5701098">m</span><span class="op" id="5701099">.</span><span class="op" id="5701100">(</span><span class="ident" id="5701101">opaquer</span><span class="op" id="5701108">)</span><span class="op" id="5701109">;</span>&nbsp;<span class="ident" id="5701111">ok</span>&nbsp;<span class="op" id="5701114">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701118">return</span>&nbsp;<span class="ident" id="5701125">o</span><span class="op" id="5701126">.</span><span class="ident" id="5701127">Opaque</span><span class="op" id="5701133">(</span><span class="op" id="5701134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701140">b</span>&nbsp;<span class="op" id="5701142">:=</span>&nbsp;<span class="ident" id="5701145">m</span><span class="op" id="5701146">.</span><span class="ident" id="5701147">Bounds</span><span class="op" id="5701153">(</span><span class="op" id="5701154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701157">for</span>&nbsp;<span class="ident" id="5701161">y</span>&nbsp;<span class="op" id="5701163">:=</span>&nbsp;<span class="ident" id="5701166">b</span><span class="op" id="5701167">.</span><span class="ident" id="5701168">Min</span><span class="op" id="5701171">.</span><span class="ident" id="5701172">Y</span><span class="op" id="5701173">;</span>&nbsp;<span class="ident" id="5701175">y</span>&nbsp;<span class="op" id="5701177">&lt;</span>&nbsp;<span class="ident" id="5701179">b</span><span class="op" id="5701180">.</span><span class="ident" id="5701181">Max</span><span class="op" id="5701184">.</span><span class="ident" id="5701185">Y</span><span class="op" id="5701186">;</span>&nbsp;<span class="ident" id="5701188">y</span><span class="op" id="5701189">++</span>&nbsp;<span class="op" id="5701192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701196">for</span>&nbsp;<span class="ident" id="5701200">x</span>&nbsp;<span class="op" id="5701202">:=</span>&nbsp;<span class="ident" id="5701205">b</span><span class="op" id="5701206">.</span><span class="ident" id="5701207">Min</span><span class="op" id="5701210">.</span><span class="ident" id="5701211">X</span><span class="op" id="5701212">;</span>&nbsp;<span class="ident" id="5701214">x</span>&nbsp;<span class="op" id="5701216">&lt;</span>&nbsp;<span class="ident" id="5701218">b</span><span class="op" id="5701219">.</span><span class="ident" id="5701220">Max</span><span class="op" id="5701223">.</span><span class="ident" id="5701224">X</span><span class="op" id="5701225">;</span>&nbsp;<span class="ident" id="5701227">x</span><span class="op" id="5701228">++</span>&nbsp;<span class="op" id="5701231">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701236">_</span><span class="op" id="5701237">,</span>&nbsp;<span class="ident" id="5701239">_</span><span class="op" id="5701240">,</span>&nbsp;<span class="ident" id="5701242">_</span><span class="op" id="5701243">,</span>&nbsp;<span class="ident" id="5701245">a</span>&nbsp;<span class="op" id="5701247">:=</span>&nbsp;<span class="ident" id="5701250">m</span><span class="op" id="5701251">.</span><span class="ident" id="5701252">At</span><span class="op" id="5701254">(</span><span class="ident" id="5701255">x</span><span class="op" id="5701256">,</span>&nbsp;<span class="ident" id="5701258">y</span><span class="op" id="5701259">)</span><span class="op" id="5701260">.</span><span class="ident" id="5701261">RGBA</span><span class="op" id="5701265">(</span><span class="op" id="5701266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701271">if</span>&nbsp;<span class="ident" id="5701274">a</span>&nbsp;<span class="op" id="5701276">!=</span>&nbsp;<span class="num" id="5701279">0xffff</span>&nbsp;<span class="op" id="5701286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701292">return</span>&nbsp;<span class="builtintype" id="5701299">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701312">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701318">return</span>&nbsp;<span class="builtintype" id="5701325">true</span><br>
<span class="lineno"></span><span class="op" id="5701330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5701333">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5701395">func</span>&nbsp;<span class="ident" id="5701400">abs8</span><span class="op" id="5701404">(</span><span class="ident" id="5701405">d</span>&nbsp;<span class="builtintype" id="5701407">uint8</span><span class="op" id="5701412">)</span>&nbsp;<span class="builtintype" id="5701414">int</span>&nbsp;<span class="op" id="5701418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701421">if</span>&nbsp;<span class="ident" id="5701424">d</span>&nbsp;<span class="op" id="5701426">&lt;</span>&nbsp;<span class="num" id="5701428">128</span>&nbsp;<span class="op" id="5701432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701436">return</span>&nbsp;<span class="builtintype" id="5701443">int</span><span class="op" id="5701446">(</span><span class="ident" id="5701447">d</span><span class="op" id="5701448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701454">return</span>&nbsp;<span class="num" id="5701461">256</span>&nbsp;<span class="op" id="5701465">-</span>&nbsp;<span class="builtintype" id="5701467">int</span><span class="op" id="5701470">(</span><span class="ident" id="5701471">d</span><span class="op" id="5701472">)</span><br>
<span class="lineno">80</span><span class="op" id="5701474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5701477">func</span>&nbsp;<span class="op" id="5701482">(</span><span class="ident" id="5701483">e</span>&nbsp;<span class="op" id="5701485">*</span><span class="ident" id="5701486">encoder</span><span class="op" id="5701493">)</span>&nbsp;<span class="ident" id="5701495">writeChunk</span><span class="op" id="5701505">(</span><span class="ident" id="5701506">b</span>&nbsp;<span class="op" id="5701508">[</span><span class="op" id="5701509">]</span><span class="builtintype" id="5701510">byte</span><span class="op" id="5701514">,</span>&nbsp;<span class="ident" id="5701516">name</span>&nbsp;<span class="builtintype" id="5701521">string</span><span class="op" id="5701527">)</span>&nbsp;<span class="op" id="5701529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701532">if</span>&nbsp;<span class="ident" id="5701535">e</span><span class="op" id="5701536">.</span><span class="ident" id="5701537">err</span>&nbsp;<span class="op" id="5701541">!=</span>&nbsp;<span class="ident" id="5701544">nil</span>&nbsp;<span class="op" id="5701548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701552">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701563">n</span>&nbsp;<span class="op" id="5701565">:=</span>&nbsp;<span class="builtintype" id="5701568">uint32</span><span class="op" id="5701574">(</span><span class="builtinfunc" id="5701575">len</span><span class="op" id="5701578">(</span><span class="ident" id="5701579">b</span><span class="op" id="5701580">)</span><span class="op" id="5701581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701584">if</span>&nbsp;<span class="builtintype" id="5701587">int</span><span class="op" id="5701590">(</span><span class="ident" id="5701591">n</span><span class="op" id="5701592">)</span>&nbsp;<span class="op" id="5701594">!=</span>&nbsp;<span class="builtinfunc" id="5701597">len</span><span class="op" id="5701600">(</span><span class="ident" id="5701601">b</span><span class="op" id="5701602">)</span>&nbsp;<span class="op" id="5701604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701608">e</span><span class="op" id="5701609">.</span><span class="ident" id="5701610">err</span>&nbsp;<span class="op" id="5701614">=</span>&nbsp;<span class="ident" id="5701616">UnsupportedError</span><span class="op" id="5701632">(</span><span class="ident" id="5701633">name</span>&nbsp;<span class="op" id="5701638">+</span>&nbsp;<span class="string" id="5701640">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5701664">+</span>&nbsp;<span class="ident" id="5701666">strconv</span><span class="op" id="5701673">.</span><span class="ident" id="5701674">Itoa</span><span class="op" id="5701678">(</span><span class="builtinfunc" id="5701679">len</span><span class="op" id="5701682">(</span><span class="ident" id="5701683">b</span><span class="op" id="5701684">)</span><span class="op" id="5701685">)</span><span class="op" id="5701686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701690">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701701">writeUint32</span><span class="op" id="5701712">(</span><span class="ident" id="5701713">e</span><span class="op" id="5701714">.</span><span class="ident" id="5701715">header</span><span class="op" id="5701721">[</span><span class="op" id="5701722">:</span><span class="num" id="5701723">4</span><span class="op" id="5701724">]</span><span class="op" id="5701725">,</span>&nbsp;<span class="ident" id="5701727">n</span><span class="op" id="5701728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701731">e</span><span class="op" id="5701732">.</span><span class="ident" id="5701733">header</span><span class="op" id="5701739">[</span><span class="num" id="5701740">4</span><span class="op" id="5701741">]</span>&nbsp;<span class="op" id="5701743">=</span>&nbsp;<span class="ident" id="5701745">name</span><span class="op" id="5701749">[</span><span class="num" id="5701750">0</span><span class="op" id="5701751">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701754">e</span><span class="op" id="5701755">.</span><span class="ident" id="5701756">header</span><span class="op" id="5701762">[</span><span class="num" id="5701763">5</span><span class="op" id="5701764">]</span>&nbsp;<span class="op" id="5701766">=</span>&nbsp;<span class="ident" id="5701768">name</span><span class="op" id="5701772">[</span><span class="num" id="5701773">1</span><span class="op" id="5701774">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701777">e</span><span class="op" id="5701778">.</span><span class="ident" id="5701779">header</span><span class="op" id="5701785">[</span><span class="num" id="5701786">6</span><span class="op" id="5701787">]</span>&nbsp;<span class="op" id="5701789">=</span>&nbsp;<span class="ident" id="5701791">name</span><span class="op" id="5701795">[</span><span class="num" id="5701796">2</span><span class="op" id="5701797">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701800">e</span><span class="op" id="5701801">.</span><span class="ident" id="5701802">header</span><span class="op" id="5701808">[</span><span class="num" id="5701809">7</span><span class="op" id="5701810">]</span>&nbsp;<span class="op" id="5701812">=</span>&nbsp;<span class="ident" id="5701814">name</span><span class="op" id="5701818">[</span><span class="num" id="5701819">3</span><span class="op" id="5701820">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701823">crc</span>&nbsp;<span class="op" id="5701827">:=</span>&nbsp;<span class="ident" id="5701830">crc32</span><span class="op" id="5701835">.</span><span class="ident" id="5701836">NewIEEE</span><span class="op" id="5701843">(</span><span class="op" id="5701844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701847">crc</span><span class="op" id="5701850">.</span><span class="ident" id="5701851">Write</span><span class="op" id="5701856">(</span><span class="ident" id="5701857">e</span><span class="op" id="5701858">.</span><span class="ident" id="5701859">header</span><span class="op" id="5701865">[</span><span class="num" id="5701866">4</span><span class="op" id="5701867">:</span><span class="num" id="5701868">8</span><span class="op" id="5701869">]</span><span class="op" id="5701870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701873">crc</span><span class="op" id="5701876">.</span><span class="ident" id="5701877">Write</span><span class="op" id="5701882">(</span><span class="ident" id="5701883">b</span><span class="op" id="5701884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701887">writeUint32</span><span class="op" id="5701898">(</span><span class="ident" id="5701899">e</span><span class="op" id="5701900">.</span><span class="ident" id="5701901">footer</span><span class="op" id="5701907">[</span><span class="op" id="5701908">:</span><span class="num" id="5701909">4</span><span class="op" id="5701910">]</span><span class="op" id="5701911">,</span>&nbsp;<span class="ident" id="5701913">crc</span><span class="op" id="5701916">.</span><span class="ident" id="5701917">Sum32</span><span class="op" id="5701922">(</span><span class="op" id="5701923">)</span><span class="op" id="5701924">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701928">_</span><span class="op" id="5701929">,</span>&nbsp;<span class="ident" id="5701931">e</span><span class="op" id="5701932">.</span><span class="ident" id="5701933">err</span>&nbsp;<span class="op" id="5701937">=</span>&nbsp;<span class="ident" id="5701939">e</span><span class="op" id="5701940">.</span><span class="ident" id="5701941">w</span><span class="op" id="5701942">.</span><span class="ident" id="5701943">Write</span><span class="op" id="5701948">(</span><span class="ident" id="5701949">e</span><span class="op" id="5701950">.</span><span class="ident" id="5701951">header</span><span class="op" id="5701957">[</span><span class="op" id="5701958">:</span><span class="num" id="5701959">8</span><span class="op" id="5701960">]</span><span class="op" id="5701961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701964">if</span>&nbsp;<span class="ident" id="5701967">e</span><span class="op" id="5701968">.</span><span class="ident" id="5701969">err</span>&nbsp;<span class="op" id="5701973">!=</span>&nbsp;<span class="ident" id="5701976">nil</span>&nbsp;<span class="op" id="5701980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5701984">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5701992">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5701995">_</span><span class="op" id="5701996">,</span>&nbsp;<span class="ident" id="5701998">e</span><span class="op" id="5701999">.</span><span class="ident" id="5702000">err</span>&nbsp;<span class="op" id="5702004">=</span>&nbsp;<span class="ident" id="5702006">e</span><span class="op" id="5702007">.</span><span class="ident" id="5702008">w</span><span class="op" id="5702009">.</span><span class="ident" id="5702010">Write</span><span class="op" id="5702015">(</span><span class="ident" id="5702016">b</span><span class="op" id="5702017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702020">if</span>&nbsp;<span class="ident" id="5702023">e</span><span class="op" id="5702024">.</span><span class="ident" id="5702025">err</span>&nbsp;<span class="op" id="5702029">!=</span>&nbsp;<span class="ident" id="5702032">nil</span>&nbsp;<span class="op" id="5702036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702040">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5702048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702051">_</span><span class="op" id="5702052">,</span>&nbsp;<span class="ident" id="5702054">e</span><span class="op" id="5702055">.</span><span class="ident" id="5702056">err</span>&nbsp;<span class="op" id="5702060">=</span>&nbsp;<span class="ident" id="5702062">e</span><span class="op" id="5702063">.</span><span class="ident" id="5702064">w</span><span class="op" id="5702065">.</span><span class="ident" id="5702066">Write</span><span class="op" id="5702071">(</span><span class="ident" id="5702072">e</span><span class="op" id="5702073">.</span><span class="ident" id="5702074">footer</span><span class="op" id="5702080">[</span><span class="op" id="5702081">:</span><span class="num" id="5702082">4</span><span class="op" id="5702083">]</span><span class="op" id="5702084">)</span><br>
<span class="lineno">110</span><span class="op" id="5702086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5702089">func</span>&nbsp;<span class="op" id="5702094">(</span><span class="ident" id="5702095">e</span>&nbsp;<span class="op" id="5702097">*</span><span class="ident" id="5702098">encoder</span><span class="op" id="5702105">)</span>&nbsp;<span class="ident" id="5702107">writeIHDR</span><span class="op" id="5702116">(</span><span class="op" id="5702117">)</span>&nbsp;<span class="op" id="5702119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702122">b</span>&nbsp;<span class="op" id="5702124">:=</span>&nbsp;<span class="ident" id="5702127">e</span><span class="op" id="5702128">.</span><span class="ident" id="5702129">m</span><span class="op" id="5702130">.</span><span class="ident" id="5702131">Bounds</span><span class="op" id="5702137">(</span><span class="op" id="5702138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702141">writeUint32</span><span class="op" id="5702152">(</span><span class="ident" id="5702153">e</span><span class="op" id="5702154">.</span><span class="ident" id="5702155">tmp</span><span class="op" id="5702158">[</span><span class="num" id="5702159">0</span><span class="op" id="5702160">:</span><span class="num" id="5702161">4</span><span class="op" id="5702162">]</span><span class="op" id="5702163">,</span>&nbsp;<span class="builtintype" id="5702165">uint32</span><span class="op" id="5702171">(</span><span class="ident" id="5702172">b</span><span class="op" id="5702173">.</span><span class="ident" id="5702174">Dx</span><span class="op" id="5702176">(</span><span class="op" id="5702177">)</span><span class="op" id="5702178">)</span><span class="op" id="5702179">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702182">writeUint32</span><span class="op" id="5702193">(</span><span class="ident" id="5702194">e</span><span class="op" id="5702195">.</span><span class="ident" id="5702196">tmp</span><span class="op" id="5702199">[</span><span class="num" id="5702200">4</span><span class="op" id="5702201">:</span><span class="num" id="5702202">8</span><span class="op" id="5702203">]</span><span class="op" id="5702204">,</span>&nbsp;<span class="builtintype" id="5702206">uint32</span><span class="op" id="5702212">(</span><span class="ident" id="5702213">b</span><span class="op" id="5702214">.</span><span class="ident" id="5702215">Dy</span><span class="op" id="5702217">(</span><span class="op" id="5702218">)</span><span class="op" id="5702219">)</span><span class="op" id="5702220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5702223">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702257">switch</span>&nbsp;<span class="ident" id="5702264">e</span><span class="op" id="5702265">.</span><span class="ident" id="5702266">cb</span>&nbsp;<span class="op" id="5702269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702272">case</span>&nbsp;<span class="ident" id="5702277">cbG8</span><span class="op" id="5702281">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702285">e</span><span class="op" id="5702286">.</span><span class="ident" id="5702287">tmp</span><span class="op" id="5702290">[</span><span class="num" id="5702291">8</span><span class="op" id="5702292">]</span>&nbsp;<span class="op" id="5702294">=</span>&nbsp;<span class="num" id="5702296">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702300">e</span><span class="op" id="5702301">.</span><span class="ident" id="5702302">tmp</span><span class="op" id="5702305">[</span><span class="num" id="5702306">9</span><span class="op" id="5702307">]</span>&nbsp;<span class="op" id="5702309">=</span>&nbsp;<span class="ident" id="5702311">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702324">case</span>&nbsp;<span class="ident" id="5702329">cbTC8</span><span class="op" id="5702334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702338">e</span><span class="op" id="5702339">.</span><span class="ident" id="5702340">tmp</span><span class="op" id="5702343">[</span><span class="num" id="5702344">8</span><span class="op" id="5702345">]</span>&nbsp;<span class="op" id="5702347">=</span>&nbsp;<span class="num" id="5702349">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702353">e</span><span class="op" id="5702354">.</span><span class="ident" id="5702355">tmp</span><span class="op" id="5702358">[</span><span class="num" id="5702359">9</span><span class="op" id="5702360">]</span>&nbsp;<span class="op" id="5702362">=</span>&nbsp;<span class="ident" id="5702364">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702377">case</span>&nbsp;<span class="ident" id="5702382">cbP8</span><span class="op" id="5702386">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702390">e</span><span class="op" id="5702391">.</span><span class="ident" id="5702392">tmp</span><span class="op" id="5702395">[</span><span class="num" id="5702396">8</span><span class="op" id="5702397">]</span>&nbsp;<span class="op" id="5702399">=</span>&nbsp;<span class="num" id="5702401">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702405">e</span><span class="op" id="5702406">.</span><span class="ident" id="5702407">tmp</span><span class="op" id="5702410">[</span><span class="num" id="5702411">9</span><span class="op" id="5702412">]</span>&nbsp;<span class="op" id="5702414">=</span>&nbsp;<span class="ident" id="5702416">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702428">case</span>&nbsp;<span class="ident" id="5702433">cbTCA8</span><span class="op" id="5702439">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702443">e</span><span class="op" id="5702444">.</span><span class="ident" id="5702445">tmp</span><span class="op" id="5702448">[</span><span class="num" id="5702449">8</span><span class="op" id="5702450">]</span>&nbsp;<span class="op" id="5702452">=</span>&nbsp;<span class="num" id="5702454">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702458">e</span><span class="op" id="5702459">.</span><span class="ident" id="5702460">tmp</span><span class="op" id="5702463">[</span><span class="num" id="5702464">9</span><span class="op" id="5702465">]</span>&nbsp;<span class="op" id="5702467">=</span>&nbsp;<span class="ident" id="5702469">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702487">case</span>&nbsp;<span class="ident" id="5702492">cbG16</span><span class="op" id="5702497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702501">e</span><span class="op" id="5702502">.</span><span class="ident" id="5702503">tmp</span><span class="op" id="5702506">[</span><span class="num" id="5702507">8</span><span class="op" id="5702508">]</span>&nbsp;<span class="op" id="5702510">=</span>&nbsp;<span class="num" id="5702512">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702517">e</span><span class="op" id="5702518">.</span><span class="ident" id="5702519">tmp</span><span class="op" id="5702522">[</span><span class="num" id="5702523">9</span><span class="op" id="5702524">]</span>&nbsp;<span class="op" id="5702526">=</span>&nbsp;<span class="ident" id="5702528">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702541">case</span>&nbsp;<span class="ident" id="5702546">cbTC16</span><span class="op" id="5702552">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702556">e</span><span class="op" id="5702557">.</span><span class="ident" id="5702558">tmp</span><span class="op" id="5702561">[</span><span class="num" id="5702562">8</span><span class="op" id="5702563">]</span>&nbsp;<span class="op" id="5702565">=</span>&nbsp;<span class="num" id="5702567">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702572">e</span><span class="op" id="5702573">.</span><span class="ident" id="5702574">tmp</span><span class="op" id="5702577">[</span><span class="num" id="5702578">9</span><span class="op" id="5702579">]</span>&nbsp;<span class="op" id="5702581">=</span>&nbsp;<span class="ident" id="5702583">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702596">case</span>&nbsp;<span class="ident" id="5702601">cbTCA16</span><span class="op" id="5702608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702612">e</span><span class="op" id="5702613">.</span><span class="ident" id="5702614">tmp</span><span class="op" id="5702617">[</span><span class="num" id="5702618">8</span><span class="op" id="5702619">]</span>&nbsp;<span class="op" id="5702621">=</span>&nbsp;<span class="num" id="5702623">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702628">e</span><span class="op" id="5702629">.</span><span class="ident" id="5702630">tmp</span><span class="op" id="5702633">[</span><span class="num" id="5702634">9</span><span class="op" id="5702635">]</span>&nbsp;<span class="op" id="5702637">=</span>&nbsp;<span class="ident" id="5702639">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5702657">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702660">e</span><span class="op" id="5702661">.</span><span class="ident" id="5702662">tmp</span><span class="op" id="5702665">[</span><span class="num" id="5702666">10</span><span class="op" id="5702668">]</span>&nbsp;<span class="op" id="5702670">=</span>&nbsp;<span class="num" id="5702672">0</span>&nbsp;<span class="comment" id="5702674">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702705">e</span><span class="op" id="5702706">.</span><span class="ident" id="5702707">tmp</span><span class="op" id="5702710">[</span><span class="num" id="5702711">11</span><span class="op" id="5702713">]</span>&nbsp;<span class="op" id="5702715">=</span>&nbsp;<span class="num" id="5702717">0</span>&nbsp;<span class="comment" id="5702719">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702745">e</span><span class="op" id="5702746">.</span><span class="ident" id="5702747">tmp</span><span class="op" id="5702750">[</span><span class="num" id="5702751">12</span><span class="op" id="5702753">]</span>&nbsp;<span class="op" id="5702755">=</span>&nbsp;<span class="num" id="5702757">0</span>&nbsp;<span class="comment" id="5702759">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702778">e</span><span class="op" id="5702779">.</span><span class="ident" id="5702780">writeChunk</span><span class="op" id="5702790">(</span><span class="ident" id="5702791">e</span><span class="op" id="5702792">.</span><span class="ident" id="5702793">tmp</span><span class="op" id="5702796">[</span><span class="op" id="5702797">:</span><span class="num" id="5702798">13</span><span class="op" id="5702800">]</span><span class="op" id="5702801">,</span>&nbsp;<span class="string" id="5702803">&#34;IHDR&#34;</span><span class="op" id="5702809">)</span><br>
<span class="lineno"></span><span class="op" id="5702811">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5702814">func</span>&nbsp;<span class="op" id="5702819">(</span><span class="ident" id="5702820">e</span>&nbsp;<span class="op" id="5702822">*</span><span class="ident" id="5702823">encoder</span><span class="op" id="5702830">)</span>&nbsp;<span class="ident" id="5702832">writePLTEAndTRNS</span><span class="op" id="5702848">(</span><span class="ident" id="5702849">p</span>&nbsp;<span class="ident" id="5702851">color</span><span class="op" id="5702856">.</span><span class="ident" id="5702857">Palette</span><span class="op" id="5702864">)</span>&nbsp;<span class="op" id="5702866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702869">if</span>&nbsp;<span class="builtinfunc" id="5702872">len</span><span class="op" id="5702875">(</span><span class="ident" id="5702876">p</span><span class="op" id="5702877">)</span>&nbsp;<span class="op" id="5702879">&lt;</span>&nbsp;<span class="num" id="5702881">1</span>&nbsp;<span class="op" id="5702883">||</span>&nbsp;<span class="builtinfunc" id="5702886">len</span><span class="op" id="5702889">(</span><span class="ident" id="5702890">p</span><span class="op" id="5702891">)</span>&nbsp;<span class="op" id="5702893">&gt;</span>&nbsp;<span class="num" id="5702895">256</span>&nbsp;<span class="op" id="5702899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702903">e</span><span class="op" id="5702904">.</span><span class="ident" id="5702905">err</span>&nbsp;<span class="op" id="5702909">=</span>&nbsp;<span class="ident" id="5702911">FormatError</span><span class="op" id="5702922">(</span><span class="string" id="5702923">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5702946">+</span>&nbsp;<span class="ident" id="5702948">strconv</span><span class="op" id="5702955">.</span><span class="ident" id="5702956">Itoa</span><span class="op" id="5702960">(</span><span class="builtinfunc" id="5702961">len</span><span class="op" id="5702964">(</span><span class="ident" id="5702965">p</span><span class="op" id="5702966">)</span><span class="op" id="5702967">)</span><span class="op" id="5702968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702972">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5702980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5702983">last</span>&nbsp;<span class="op" id="5702988">:=</span>&nbsp;<span class="op" id="5702991">-</span><span class="num" id="5702992">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5702995">for</span>&nbsp;<span class="ident" id="5702999">i</span><span class="op" id="5703000">,</span>&nbsp;<span class="ident" id="5703002">c</span>&nbsp;<span class="op" id="5703004">:=</span>&nbsp;<span class="keyword" id="5703007">range</span>&nbsp;<span class="ident" id="5703013">p</span>&nbsp;<span class="op" id="5703015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703019">c1</span>&nbsp;<span class="op" id="5703022">:=</span>&nbsp;<span class="ident" id="5703025">color</span><span class="op" id="5703030">.</span><span class="ident" id="5703031">NRGBAModel</span><span class="op" id="5703041">.</span><span class="ident" id="5703042">Convert</span><span class="op" id="5703049">(</span><span class="ident" id="5703050">c</span><span class="op" id="5703051">)</span><span class="op" id="5703052">.</span><span class="op" id="5703053">(</span><span class="ident" id="5703054">color</span><span class="op" id="5703059">.</span><span class="ident" id="5703060">NRGBA</span><span class="op" id="5703065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703069">e</span><span class="op" id="5703070">.</span><span class="ident" id="5703071">tmp</span><span class="op" id="5703074">[</span><span class="num" id="5703075">3</span><span class="op" id="5703076">*</span><span class="ident" id="5703077">i</span><span class="op" id="5703078">+</span><span class="num" id="5703079">0</span><span class="op" id="5703080">]</span>&nbsp;<span class="op" id="5703082">=</span>&nbsp;<span class="ident" id="5703084">c1</span><span class="op" id="5703086">.</span><span class="ident" id="5703087">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703091">e</span><span class="op" id="5703092">.</span><span class="ident" id="5703093">tmp</span><span class="op" id="5703096">[</span><span class="num" id="5703097">3</span><span class="op" id="5703098">*</span><span class="ident" id="5703099">i</span><span class="op" id="5703100">+</span><span class="num" id="5703101">1</span><span class="op" id="5703102">]</span>&nbsp;<span class="op" id="5703104">=</span>&nbsp;<span class="ident" id="5703106">c1</span><span class="op" id="5703108">.</span><span class="ident" id="5703109">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703113">e</span><span class="op" id="5703114">.</span><span class="ident" id="5703115">tmp</span><span class="op" id="5703118">[</span><span class="num" id="5703119">3</span><span class="op" id="5703120">*</span><span class="ident" id="5703121">i</span><span class="op" id="5703122">+</span><span class="num" id="5703123">2</span><span class="op" id="5703124">]</span>&nbsp;<span class="op" id="5703126">=</span>&nbsp;<span class="ident" id="5703128">c1</span><span class="op" id="5703130">.</span><span class="ident" id="5703131">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703135">if</span>&nbsp;<span class="ident" id="5703138">c1</span><span class="op" id="5703140">.</span><span class="ident" id="5703141">A</span>&nbsp;<span class="op" id="5703143">!=</span>&nbsp;<span class="num" id="5703146">0xff</span>&nbsp;<span class="op" id="5703151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703156">last</span>&nbsp;<span class="op" id="5703161">=</span>&nbsp;<span class="ident" id="5703163">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5703167">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703171">e</span><span class="op" id="5703172">.</span><span class="ident" id="5703173">tmp</span><span class="op" id="5703176">[</span><span class="num" id="5703177">3</span><span class="op" id="5703178">*</span><span class="num" id="5703179">256</span><span class="op" id="5703182">+</span><span class="ident" id="5703183">i</span><span class="op" id="5703184">]</span>&nbsp;<span class="op" id="5703186">=</span>&nbsp;<span class="ident" id="5703188">c1</span><span class="op" id="5703190">.</span><span class="ident" id="5703191">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5703194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703197">e</span><span class="op" id="5703198">.</span><span class="ident" id="5703199">writeChunk</span><span class="op" id="5703209">(</span><span class="ident" id="5703210">e</span><span class="op" id="5703211">.</span><span class="ident" id="5703212">tmp</span><span class="op" id="5703215">[</span><span class="op" id="5703216">:</span><span class="num" id="5703217">3</span><span class="op" id="5703218">*</span><span class="builtinfunc" id="5703219">len</span><span class="op" id="5703222">(</span><span class="ident" id="5703223">p</span><span class="op" id="5703224">)</span><span class="op" id="5703225">]</span><span class="op" id="5703226">,</span>&nbsp;<span class="string" id="5703228">&#34;PLTE&#34;</span><span class="op" id="5703234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703237">if</span>&nbsp;<span class="ident" id="5703240">last</span>&nbsp;<span class="op" id="5703245">!=</span>&nbsp;<span class="op" id="5703248">-</span><span class="num" id="5703249">1</span>&nbsp;<span class="op" id="5703251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703255">e</span><span class="op" id="5703256">.</span><span class="ident" id="5703257">writeChunk</span><span class="op" id="5703267">(</span><span class="ident" id="5703268">e</span><span class="op" id="5703269">.</span><span class="ident" id="5703270">tmp</span><span class="op" id="5703273">[</span><span class="num" id="5703274">3</span><span class="op" id="5703275">*</span><span class="num" id="5703276">256</span><span class="op" id="5703279">:</span><span class="num" id="5703280">3</span><span class="op" id="5703281">*</span><span class="num" id="5703282">256</span><span class="op" id="5703285">+</span><span class="num" id="5703286">1</span><span class="op" id="5703287">+</span><span class="ident" id="5703288">last</span><span class="op" id="5703292">]</span><span class="op" id="5703293">,</span>&nbsp;<span class="string" id="5703295">&#34;tRNS&#34;</span><span class="op" id="5703301">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5703304">}</span><br>
<span class="lineno"></span><span class="op" id="5703306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5703309">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5703389">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5703470">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5703544">//</span><br>
<span class="lineno"></span><span class="comment" id="5703547">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5703618">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5703676">func</span>&nbsp;<span class="op" id="5703681">(</span><span class="ident" id="5703682">e</span>&nbsp;<span class="op" id="5703684">*</span><span class="ident" id="5703685">encoder</span><span class="op" id="5703692">)</span>&nbsp;<span class="ident" id="5703694">Write</span><span class="op" id="5703699">(</span><span class="ident" id="5703700">b</span>&nbsp;<span class="op" id="5703702">[</span><span class="op" id="5703703">]</span><span class="builtintype" id="5703704">byte</span><span class="op" id="5703708">)</span>&nbsp;<span class="op" id="5703710">(</span><span class="builtintype" id="5703711">int</span><span class="op" id="5703714">,</span>&nbsp;<span class="builtintype" id="5703716">error</span><span class="op" id="5703721">)</span>&nbsp;<span class="op" id="5703723">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5703726">e</span><span class="op" id="5703727">.</span><span class="ident" id="5703728">writeChunk</span><span class="op" id="5703738">(</span><span class="ident" id="5703739">b</span><span class="op" id="5703740">,</span>&nbsp;<span class="string" id="5703742">&#34;IDAT&#34;</span><span class="op" id="5703748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703751">if</span>&nbsp;<span class="ident" id="5703754">e</span><span class="op" id="5703755">.</span><span class="ident" id="5703756">err</span>&nbsp;<span class="op" id="5703760">!=</span>&nbsp;<span class="ident" id="5703763">nil</span>&nbsp;<span class="op" id="5703767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703771">return</span>&nbsp;<span class="num" id="5703778">0</span><span class="op" id="5703779">,</span>&nbsp;<span class="ident" id="5703781">e</span><span class="op" id="5703782">.</span><span class="ident" id="5703783">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5703788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5703791">return</span>&nbsp;<span class="builtinfunc" id="5703798">len</span><span class="op" id="5703801">(</span><span class="ident" id="5703802">b</span><span class="op" id="5703803">)</span><span class="op" id="5703804">,</span>&nbsp;<span class="ident" id="5703806">nil</span><br>
<span class="lineno">180</span><span class="op" id="5703810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5703813">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5703888">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5703986">func</span>&nbsp;<span class="ident" id="5703991">filter</span><span class="op" id="5703997">(</span><span class="ident" id="5703998">cr</span>&nbsp;<span class="op" id="5704001">*</span><span class="op" id="5704002">[</span><span class="ident" id="5704003">nFilter</span><span class="op" id="5704010">]</span><span class="op" id="5704011">[</span><span class="op" id="5704012">]</span><span class="builtintype" id="5704013">byte</span><span class="op" id="5704017">,</span>&nbsp;<span class="ident" id="5704019">pr</span>&nbsp;<span class="op" id="5704022">[</span><span class="op" id="5704023">]</span><span class="builtintype" id="5704024">byte</span><span class="op" id="5704028">,</span>&nbsp;<span class="ident" id="5704030">bpp</span>&nbsp;<span class="builtintype" id="5704034">int</span><span class="op" id="5704037">)</span>&nbsp;<span class="builtintype" id="5704039">int</span>&nbsp;<span class="op" id="5704043">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704046">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704145">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704241">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704336">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704410">cdat0</span>&nbsp;<span class="op" id="5704416">:=</span>&nbsp;<span class="ident" id="5704419">cr</span><span class="op" id="5704421">[</span><span class="num" id="5704422">0</span><span class="op" id="5704423">]</span><span class="op" id="5704424">[</span><span class="num" id="5704425">1</span><span class="op" id="5704426">:</span><span class="op" id="5704427">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704430">cdat1</span>&nbsp;<span class="op" id="5704436">:=</span>&nbsp;<span class="ident" id="5704439">cr</span><span class="op" id="5704441">[</span><span class="num" id="5704442">1</span><span class="op" id="5704443">]</span><span class="op" id="5704444">[</span><span class="num" id="5704445">1</span><span class="op" id="5704446">:</span><span class="op" id="5704447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704450">cdat2</span>&nbsp;<span class="op" id="5704456">:=</span>&nbsp;<span class="ident" id="5704459">cr</span><span class="op" id="5704461">[</span><span class="num" id="5704462">2</span><span class="op" id="5704463">]</span><span class="op" id="5704464">[</span><span class="num" id="5704465">1</span><span class="op" id="5704466">:</span><span class="op" id="5704467">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704470">cdat3</span>&nbsp;<span class="op" id="5704476">:=</span>&nbsp;<span class="ident" id="5704479">cr</span><span class="op" id="5704481">[</span><span class="num" id="5704482">3</span><span class="op" id="5704483">]</span><span class="op" id="5704484">[</span><span class="num" id="5704485">1</span><span class="op" id="5704486">:</span><span class="op" id="5704487">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704490">cdat4</span>&nbsp;<span class="op" id="5704496">:=</span>&nbsp;<span class="ident" id="5704499">cr</span><span class="op" id="5704501">[</span><span class="num" id="5704502">4</span><span class="op" id="5704503">]</span><span class="op" id="5704504">[</span><span class="num" id="5704505">1</span><span class="op" id="5704506">:</span><span class="op" id="5704507">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704510">pdat</span>&nbsp;<span class="op" id="5704515">:=</span>&nbsp;<span class="ident" id="5704518">pr</span><span class="op" id="5704520">[</span><span class="num" id="5704521">1</span><span class="op" id="5704522">:</span><span class="op" id="5704523">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704526">n</span>&nbsp;<span class="op" id="5704528">:=</span>&nbsp;<span class="builtinfunc" id="5704531">len</span><span class="op" id="5704534">(</span><span class="ident" id="5704535">cdat0</span><span class="op" id="5704540">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704544">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704563">sum</span>&nbsp;<span class="op" id="5704567">:=</span>&nbsp;<span class="num" id="5704570">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704573">for</span>&nbsp;<span class="ident" id="5704577">i</span>&nbsp;<span class="op" id="5704579">:=</span>&nbsp;<span class="num" id="5704582">0</span><span class="op" id="5704583">;</span>&nbsp;<span class="ident" id="5704585">i</span>&nbsp;<span class="op" id="5704587">&lt;</span>&nbsp;<span class="ident" id="5704589">n</span><span class="op" id="5704590">;</span>&nbsp;<span class="ident" id="5704592">i</span><span class="op" id="5704593">++</span>&nbsp;<span class="op" id="5704596">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704600">cdat2</span><span class="op" id="5704605">[</span><span class="ident" id="5704606">i</span><span class="op" id="5704607">]</span>&nbsp;<span class="op" id="5704609">=</span>&nbsp;<span class="ident" id="5704611">cdat0</span><span class="op" id="5704616">[</span><span class="ident" id="5704617">i</span><span class="op" id="5704618">]</span>&nbsp;<span class="op" id="5704620">-</span>&nbsp;<span class="ident" id="5704622">pdat</span><span class="op" id="5704626">[</span><span class="ident" id="5704627">i</span><span class="op" id="5704628">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704632">sum</span>&nbsp;<span class="op" id="5704636">+=</span>&nbsp;<span class="ident" id="5704639">abs8</span><span class="op" id="5704643">(</span><span class="ident" id="5704644">cdat2</span><span class="op" id="5704649">[</span><span class="ident" id="5704650">i</span><span class="op" id="5704651">]</span><span class="op" id="5704652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5704655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704658">best</span>&nbsp;<span class="op" id="5704663">:=</span>&nbsp;<span class="ident" id="5704666">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704671">filter</span>&nbsp;<span class="op" id="5704678">:=</span>&nbsp;<span class="ident" id="5704681">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5704688">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704710">sum</span>&nbsp;<span class="op" id="5704714">=</span>&nbsp;<span class="num" id="5704716">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704719">for</span>&nbsp;<span class="ident" id="5704723">i</span>&nbsp;<span class="op" id="5704725">:=</span>&nbsp;<span class="num" id="5704728">0</span><span class="op" id="5704729">;</span>&nbsp;<span class="ident" id="5704731">i</span>&nbsp;<span class="op" id="5704733">&lt;</span>&nbsp;<span class="ident" id="5704735">bpp</span><span class="op" id="5704738">;</span>&nbsp;<span class="ident" id="5704740">i</span><span class="op" id="5704741">++</span>&nbsp;<span class="op" id="5704744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704748">cdat4</span><span class="op" id="5704753">[</span><span class="ident" id="5704754">i</span><span class="op" id="5704755">]</span>&nbsp;<span class="op" id="5704757">=</span>&nbsp;<span class="ident" id="5704759">cdat0</span><span class="op" id="5704764">[</span><span class="ident" id="5704765">i</span><span class="op" id="5704766">]</span>&nbsp;<span class="op" id="5704768">-</span>&nbsp;<span class="ident" id="5704770">pdat</span><span class="op" id="5704774">[</span><span class="ident" id="5704775">i</span><span class="op" id="5704776">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704780">sum</span>&nbsp;<span class="op" id="5704784">+=</span>&nbsp;<span class="ident" id="5704787">abs8</span><span class="op" id="5704791">(</span><span class="ident" id="5704792">cdat4</span><span class="op" id="5704797">[</span><span class="ident" id="5704798">i</span><span class="op" id="5704799">]</span><span class="op" id="5704800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5704803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704806">for</span>&nbsp;<span class="ident" id="5704810">i</span>&nbsp;<span class="op" id="5704812">:=</span>&nbsp;<span class="ident" id="5704815">bpp</span><span class="op" id="5704818">;</span>&nbsp;<span class="ident" id="5704820">i</span>&nbsp;<span class="op" id="5704822">&lt;</span>&nbsp;<span class="ident" id="5704824">n</span><span class="op" id="5704825">;</span>&nbsp;<span class="ident" id="5704827">i</span><span class="op" id="5704828">++</span>&nbsp;<span class="op" id="5704831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704835">cdat4</span><span class="op" id="5704840">[</span><span class="ident" id="5704841">i</span><span class="op" id="5704842">]</span>&nbsp;<span class="op" id="5704844">=</span>&nbsp;<span class="ident" id="5704846">cdat0</span><span class="op" id="5704851">[</span><span class="ident" id="5704852">i</span><span class="op" id="5704853">]</span>&nbsp;<span class="op" id="5704855">-</span>&nbsp;<span class="ident" id="5704857">paeth</span><span class="op" id="5704862">(</span><span class="ident" id="5704863">cdat0</span><span class="op" id="5704868">[</span><span class="ident" id="5704869">i</span><span class="op" id="5704870">-</span><span class="ident" id="5704871">bpp</span><span class="op" id="5704874">]</span><span class="op" id="5704875">,</span>&nbsp;<span class="ident" id="5704877">pdat</span><span class="op" id="5704881">[</span><span class="ident" id="5704882">i</span><span class="op" id="5704883">]</span><span class="op" id="5704884">,</span>&nbsp;<span class="ident" id="5704886">pdat</span><span class="op" id="5704890">[</span><span class="ident" id="5704891">i</span><span class="op" id="5704892">-</span><span class="ident" id="5704893">bpp</span><span class="op" id="5704896">]</span><span class="op" id="5704897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704901">sum</span>&nbsp;<span class="op" id="5704905">+=</span>&nbsp;<span class="ident" id="5704908">abs8</span><span class="op" id="5704912">(</span><span class="ident" id="5704913">cdat4</span><span class="op" id="5704918">[</span><span class="ident" id="5704919">i</span><span class="op" id="5704920">]</span><span class="op" id="5704921">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704925">if</span>&nbsp;<span class="ident" id="5704928">sum</span>&nbsp;<span class="op" id="5704932">&gt;=</span>&nbsp;<span class="ident" id="5704935">best</span>&nbsp;<span class="op" id="5704940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704945">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5704953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5704956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5704959">if</span>&nbsp;<span class="ident" id="5704962">sum</span>&nbsp;<span class="op" id="5704966">&lt;</span>&nbsp;<span class="ident" id="5704968">best</span>&nbsp;<span class="op" id="5704973">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704977">best</span>&nbsp;<span class="op" id="5704982">=</span>&nbsp;<span class="ident" id="5704984">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5704990">filter</span>&nbsp;<span class="op" id="5704997">=</span>&nbsp;<span class="ident" id="5704999">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705012">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705033">sum</span>&nbsp;<span class="op" id="5705037">=</span>&nbsp;<span class="num" id="5705039">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705042">for</span>&nbsp;<span class="ident" id="5705046">i</span>&nbsp;<span class="op" id="5705048">:=</span>&nbsp;<span class="num" id="5705051">0</span><span class="op" id="5705052">;</span>&nbsp;<span class="ident" id="5705054">i</span>&nbsp;<span class="op" id="5705056">&lt;</span>&nbsp;<span class="ident" id="5705058">n</span><span class="op" id="5705059">;</span>&nbsp;<span class="ident" id="5705061">i</span><span class="op" id="5705062">++</span>&nbsp;<span class="op" id="5705065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705069">sum</span>&nbsp;<span class="op" id="5705073">+=</span>&nbsp;<span class="ident" id="5705076">abs8</span><span class="op" id="5705080">(</span><span class="ident" id="5705081">cdat0</span><span class="op" id="5705086">[</span><span class="ident" id="5705087">i</span><span class="op" id="5705088">]</span><span class="op" id="5705089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705093">if</span>&nbsp;<span class="ident" id="5705096">sum</span>&nbsp;<span class="op" id="5705100">&gt;=</span>&nbsp;<span class="ident" id="5705103">best</span>&nbsp;<span class="op" id="5705108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705113">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705127">if</span>&nbsp;<span class="ident" id="5705130">sum</span>&nbsp;<span class="op" id="5705134">&lt;</span>&nbsp;<span class="ident" id="5705136">best</span>&nbsp;<span class="op" id="5705141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705145">best</span>&nbsp;<span class="op" id="5705150">=</span>&nbsp;<span class="ident" id="5705152">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705158">filter</span>&nbsp;<span class="op" id="5705165">=</span>&nbsp;<span class="ident" id="5705167">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705179">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705199">sum</span>&nbsp;<span class="op" id="5705203">=</span>&nbsp;<span class="num" id="5705205">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705208">for</span>&nbsp;<span class="ident" id="5705212">i</span>&nbsp;<span class="op" id="5705214">:=</span>&nbsp;<span class="num" id="5705217">0</span><span class="op" id="5705218">;</span>&nbsp;<span class="ident" id="5705220">i</span>&nbsp;<span class="op" id="5705222">&lt;</span>&nbsp;<span class="ident" id="5705224">bpp</span><span class="op" id="5705227">;</span>&nbsp;<span class="ident" id="5705229">i</span><span class="op" id="5705230">++</span>&nbsp;<span class="op" id="5705233">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705237">cdat1</span><span class="op" id="5705242">[</span><span class="ident" id="5705243">i</span><span class="op" id="5705244">]</span>&nbsp;<span class="op" id="5705246">=</span>&nbsp;<span class="ident" id="5705248">cdat0</span><span class="op" id="5705253">[</span><span class="ident" id="5705254">i</span><span class="op" id="5705255">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705259">sum</span>&nbsp;<span class="op" id="5705263">+=</span>&nbsp;<span class="ident" id="5705266">abs8</span><span class="op" id="5705270">(</span><span class="ident" id="5705271">cdat1</span><span class="op" id="5705276">[</span><span class="ident" id="5705277">i</span><span class="op" id="5705278">]</span><span class="op" id="5705279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705285">for</span>&nbsp;<span class="ident" id="5705289">i</span>&nbsp;<span class="op" id="5705291">:=</span>&nbsp;<span class="ident" id="5705294">bpp</span><span class="op" id="5705297">;</span>&nbsp;<span class="ident" id="5705299">i</span>&nbsp;<span class="op" id="5705301">&lt;</span>&nbsp;<span class="ident" id="5705303">n</span><span class="op" id="5705304">;</span>&nbsp;<span class="ident" id="5705306">i</span><span class="op" id="5705307">++</span>&nbsp;<span class="op" id="5705310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705314">cdat1</span><span class="op" id="5705319">[</span><span class="ident" id="5705320">i</span><span class="op" id="5705321">]</span>&nbsp;<span class="op" id="5705323">=</span>&nbsp;<span class="ident" id="5705325">cdat0</span><span class="op" id="5705330">[</span><span class="ident" id="5705331">i</span><span class="op" id="5705332">]</span>&nbsp;<span class="op" id="5705334">-</span>&nbsp;<span class="ident" id="5705336">cdat0</span><span class="op" id="5705341">[</span><span class="ident" id="5705342">i</span><span class="op" id="5705343">-</span><span class="ident" id="5705344">bpp</span><span class="op" id="5705347">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705351">sum</span>&nbsp;<span class="op" id="5705355">+=</span>&nbsp;<span class="ident" id="5705358">abs8</span><span class="op" id="5705362">(</span><span class="ident" id="5705363">cdat1</span><span class="op" id="5705368">[</span><span class="ident" id="5705369">i</span><span class="op" id="5705370">]</span><span class="op" id="5705371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705375">if</span>&nbsp;<span class="ident" id="5705378">sum</span>&nbsp;<span class="op" id="5705382">&gt;=</span>&nbsp;<span class="ident" id="5705385">best</span>&nbsp;<span class="op" id="5705390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705395">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705406">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705409">if</span>&nbsp;<span class="ident" id="5705412">sum</span>&nbsp;<span class="op" id="5705416">&lt;</span>&nbsp;<span class="ident" id="5705418">best</span>&nbsp;<span class="op" id="5705423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705427">best</span>&nbsp;<span class="op" id="5705432">=</span>&nbsp;<span class="ident" id="5705434">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705440">filter</span>&nbsp;<span class="op" id="5705447">=</span>&nbsp;<span class="ident" id="5705449">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5705460">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705484">sum</span>&nbsp;<span class="op" id="5705488">=</span>&nbsp;<span class="num" id="5705490">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705493">for</span>&nbsp;<span class="ident" id="5705497">i</span>&nbsp;<span class="op" id="5705499">:=</span>&nbsp;<span class="num" id="5705502">0</span><span class="op" id="5705503">;</span>&nbsp;<span class="ident" id="5705505">i</span>&nbsp;<span class="op" id="5705507">&lt;</span>&nbsp;<span class="ident" id="5705509">bpp</span><span class="op" id="5705512">;</span>&nbsp;<span class="ident" id="5705514">i</span><span class="op" id="5705515">++</span>&nbsp;<span class="op" id="5705518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705522">cdat3</span><span class="op" id="5705527">[</span><span class="ident" id="5705528">i</span><span class="op" id="5705529">]</span>&nbsp;<span class="op" id="5705531">=</span>&nbsp;<span class="ident" id="5705533">cdat0</span><span class="op" id="5705538">[</span><span class="ident" id="5705539">i</span><span class="op" id="5705540">]</span>&nbsp;<span class="op" id="5705542">-</span>&nbsp;<span class="ident" id="5705544">pdat</span><span class="op" id="5705548">[</span><span class="ident" id="5705549">i</span><span class="op" id="5705550">]</span><span class="op" id="5705551">/</span><span class="num" id="5705552">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705556">sum</span>&nbsp;<span class="op" id="5705560">+=</span>&nbsp;<span class="ident" id="5705563">abs8</span><span class="op" id="5705567">(</span><span class="ident" id="5705568">cdat3</span><span class="op" id="5705573">[</span><span class="ident" id="5705574">i</span><span class="op" id="5705575">]</span><span class="op" id="5705576">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705582">for</span>&nbsp;<span class="ident" id="5705586">i</span>&nbsp;<span class="op" id="5705588">:=</span>&nbsp;<span class="ident" id="5705591">bpp</span><span class="op" id="5705594">;</span>&nbsp;<span class="ident" id="5705596">i</span>&nbsp;<span class="op" id="5705598">&lt;</span>&nbsp;<span class="ident" id="5705600">n</span><span class="op" id="5705601">;</span>&nbsp;<span class="ident" id="5705603">i</span><span class="op" id="5705604">++</span>&nbsp;<span class="op" id="5705607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705611">cdat3</span><span class="op" id="5705616">[</span><span class="ident" id="5705617">i</span><span class="op" id="5705618">]</span>&nbsp;<span class="op" id="5705620">=</span>&nbsp;<span class="ident" id="5705622">cdat0</span><span class="op" id="5705627">[</span><span class="ident" id="5705628">i</span><span class="op" id="5705629">]</span>&nbsp;<span class="op" id="5705631">-</span>&nbsp;<span class="builtintype" id="5705633">uint8</span><span class="op" id="5705638">(</span><span class="op" id="5705639">(</span><span class="builtintype" id="5705640">int</span><span class="op" id="5705643">(</span><span class="ident" id="5705644">cdat0</span><span class="op" id="5705649">[</span><span class="ident" id="5705650">i</span><span class="op" id="5705651">-</span><span class="ident" id="5705652">bpp</span><span class="op" id="5705655">]</span><span class="op" id="5705656">)</span><span class="op" id="5705657">+</span><span class="builtintype" id="5705658">int</span><span class="op" id="5705661">(</span><span class="ident" id="5705662">pdat</span><span class="op" id="5705666">[</span><span class="ident" id="5705667">i</span><span class="op" id="5705668">]</span><span class="op" id="5705669">)</span><span class="op" id="5705670">)</span><span class="op" id="5705671">/</span><span class="num" id="5705672">2</span><span class="op" id="5705673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705677">sum</span>&nbsp;<span class="op" id="5705681">+=</span>&nbsp;<span class="ident" id="5705684">abs8</span><span class="op" id="5705688">(</span><span class="ident" id="5705689">cdat3</span><span class="op" id="5705694">[</span><span class="ident" id="5705695">i</span><span class="op" id="5705696">]</span><span class="op" id="5705697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705701">if</span>&nbsp;<span class="ident" id="5705704">sum</span>&nbsp;<span class="op" id="5705708">&gt;=</span>&nbsp;<span class="ident" id="5705711">best</span>&nbsp;<span class="op" id="5705716">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705721">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705735">if</span>&nbsp;<span class="ident" id="5705738">sum</span>&nbsp;<span class="op" id="5705742">&lt;</span>&nbsp;<span class="ident" id="5705744">best</span>&nbsp;<span class="op" id="5705749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705753">best</span>&nbsp;<span class="op" id="5705758">=</span>&nbsp;<span class="ident" id="5705760">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705766">filter</span>&nbsp;<span class="op" id="5705773">=</span>&nbsp;<span class="ident" id="5705775">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705790">return</span>&nbsp;<span class="ident" id="5705797">filter</span><br>
<span class="lineno"></span><span class="op" id="5705804">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5705807">func</span>&nbsp;<span class="ident" id="5705812">writeImage</span><span class="op" id="5705822">(</span><span class="ident" id="5705823">w</span>&nbsp;<span class="ident" id="5705825">io</span><span class="op" id="5705827">.</span><span class="ident" id="5705828">Writer</span><span class="op" id="5705834">,</span>&nbsp;<span class="ident" id="5705836">m</span>&nbsp;<span class="ident" id="5705838">image</span><span class="op" id="5705843">.</span><span class="ident" id="5705844">Image</span><span class="op" id="5705849">,</span>&nbsp;<span class="ident" id="5705851">cb</span>&nbsp;<span class="builtintype" id="5705854">int</span><span class="op" id="5705857">,</span>&nbsp;<span class="ident" id="5705859">level</span>&nbsp;<span class="builtintype" id="5705865">int</span><span class="op" id="5705868">)</span>&nbsp;<span class="builtintype" id="5705870">error</span>&nbsp;<span class="op" id="5705876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705879">zw</span><span class="op" id="5705881">,</span>&nbsp;<span class="ident" id="5705883">err</span>&nbsp;<span class="op" id="5705887">:=</span>&nbsp;<span class="ident" id="5705890">zlib</span><span class="op" id="5705894">.</span><span class="ident" id="5705895">NewWriterLevel</span><span class="op" id="5705909">(</span><span class="ident" id="5705910">w</span><span class="op" id="5705911">,</span>&nbsp;<span class="ident" id="5705913">level</span><span class="op" id="5705918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705921">if</span>&nbsp;<span class="ident" id="5705924">err</span>&nbsp;<span class="op" id="5705928">!=</span>&nbsp;<span class="ident" id="5705931">nil</span>&nbsp;<span class="op" id="5705935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705939">return</span>&nbsp;<span class="ident" id="5705946">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5705951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5705954">defer</span>&nbsp;<span class="ident" id="5705960">zw</span><span class="op" id="5705962">.</span><span class="ident" id="5705963">Close</span><span class="op" id="5705968">(</span><span class="op" id="5705969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5705973">bpp</span>&nbsp;<span class="op" id="5705977">:=</span>&nbsp;<span class="num" id="5705980">0</span>&nbsp;<span class="comment" id="5705982">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706004">switch</span>&nbsp;<span class="ident" id="5706011">cb</span>&nbsp;<span class="op" id="5706014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706017">case</span>&nbsp;<span class="ident" id="5706022">cbG8</span><span class="op" id="5706026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706030">bpp</span>&nbsp;<span class="op" id="5706034">=</span>&nbsp;<span class="num" id="5706036">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706039">case</span>&nbsp;<span class="ident" id="5706044">cbTC8</span><span class="op" id="5706049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706053">bpp</span>&nbsp;<span class="op" id="5706057">=</span>&nbsp;<span class="num" id="5706059">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706062">case</span>&nbsp;<span class="ident" id="5706067">cbP8</span><span class="op" id="5706071">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706075">bpp</span>&nbsp;<span class="op" id="5706079">=</span>&nbsp;<span class="num" id="5706081">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706084">case</span>&nbsp;<span class="ident" id="5706089">cbTCA8</span><span class="op" id="5706095">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706099">bpp</span>&nbsp;<span class="op" id="5706103">=</span>&nbsp;<span class="num" id="5706105">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706108">case</span>&nbsp;<span class="ident" id="5706113">cbTC16</span><span class="op" id="5706119">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706123">bpp</span>&nbsp;<span class="op" id="5706127">=</span>&nbsp;<span class="num" id="5706129">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706132">case</span>&nbsp;<span class="ident" id="5706137">cbTCA16</span><span class="op" id="5706144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706148">bpp</span>&nbsp;<span class="op" id="5706152">=</span>&nbsp;<span class="num" id="5706154">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706157">case</span>&nbsp;<span class="ident" id="5706162">cbG16</span><span class="op" id="5706167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706171">bpp</span>&nbsp;<span class="op" id="5706175">=</span>&nbsp;<span class="num" id="5706177">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5706180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5706183">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5706248">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5706324">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5706411">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5706498">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706563">b</span>&nbsp;<span class="op" id="5706565">:=</span>&nbsp;<span class="ident" id="5706568">m</span><span class="op" id="5706569">.</span><span class="ident" id="5706570">Bounds</span><span class="op" id="5706576">(</span><span class="op" id="5706577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706580">var</span>&nbsp;<span class="ident" id="5706584">cr</span>&nbsp;<span class="op" id="5706587">[</span><span class="ident" id="5706588">nFilter</span><span class="op" id="5706595">]</span><span class="op" id="5706596">[</span><span class="op" id="5706597">]</span><span class="builtintype" id="5706598">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706605">for</span>&nbsp;<span class="ident" id="5706609">i</span>&nbsp;<span class="op" id="5706611">:=</span>&nbsp;<span class="keyword" id="5706614">range</span>&nbsp;<span class="ident" id="5706620">cr</span>&nbsp;<span class="op" id="5706623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706627">cr</span><span class="op" id="5706629">[</span><span class="ident" id="5706630">i</span><span class="op" id="5706631">]</span>&nbsp;<span class="op" id="5706633">=</span>&nbsp;<span class="builtinfunc" id="5706635">make</span><span class="op" id="5706639">(</span><span class="op" id="5706640">[</span><span class="op" id="5706641">]</span><span class="builtintype" id="5706642">uint8</span><span class="op" id="5706647">,</span>&nbsp;<span class="num" id="5706649">1</span><span class="op" id="5706650">+</span><span class="ident" id="5706651">bpp</span><span class="op" id="5706654">*</span><span class="ident" id="5706655">b</span><span class="op" id="5706656">.</span><span class="ident" id="5706657">Dx</span><span class="op" id="5706659">(</span><span class="op" id="5706660">)</span><span class="op" id="5706661">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706665">cr</span><span class="op" id="5706667">[</span><span class="ident" id="5706668">i</span><span class="op" id="5706669">]</span><span class="op" id="5706670">[</span><span class="num" id="5706671">0</span><span class="op" id="5706672">]</span>&nbsp;<span class="op" id="5706674">=</span>&nbsp;<span class="builtintype" id="5706676">uint8</span><span class="op" id="5706681">(</span><span class="ident" id="5706682">i</span><span class="op" id="5706683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5706686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706689">pr</span>&nbsp;<span class="op" id="5706692">:=</span>&nbsp;<span class="builtinfunc" id="5706695">make</span><span class="op" id="5706699">(</span><span class="op" id="5706700">[</span><span class="op" id="5706701">]</span><span class="builtintype" id="5706702">uint8</span><span class="op" id="5706707">,</span>&nbsp;<span class="num" id="5706709">1</span><span class="op" id="5706710">+</span><span class="ident" id="5706711">bpp</span><span class="op" id="5706714">*</span><span class="ident" id="5706715">b</span><span class="op" id="5706716">.</span><span class="ident" id="5706717">Dx</span><span class="op" id="5706719">(</span><span class="op" id="5706720">)</span><span class="op" id="5706721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706725">gray</span><span class="op" id="5706729">,</span>&nbsp;<span class="ident" id="5706731">_</span>&nbsp;<span class="op" id="5706733">:=</span>&nbsp;<span class="ident" id="5706736">m</span><span class="op" id="5706737">.</span><span class="op" id="5706738">(</span><span class="op" id="5706739">*</span><span class="ident" id="5706740">image</span><span class="op" id="5706745">.</span><span class="ident" id="5706746">Gray</span><span class="op" id="5706750">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706753">rgba</span><span class="op" id="5706757">,</span>&nbsp;<span class="ident" id="5706759">_</span>&nbsp;<span class="op" id="5706761">:=</span>&nbsp;<span class="ident" id="5706764">m</span><span class="op" id="5706765">.</span><span class="op" id="5706766">(</span><span class="op" id="5706767">*</span><span class="ident" id="5706768">image</span><span class="op" id="5706773">.</span><span class="ident" id="5706774">RGBA</span><span class="op" id="5706778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706781">paletted</span><span class="op" id="5706789">,</span>&nbsp;<span class="ident" id="5706791">_</span>&nbsp;<span class="op" id="5706793">:=</span>&nbsp;<span class="ident" id="5706796">m</span><span class="op" id="5706797">.</span><span class="op" id="5706798">(</span><span class="op" id="5706799">*</span><span class="ident" id="5706800">image</span><span class="op" id="5706805">.</span><span class="ident" id="5706806">Paletted</span><span class="op" id="5706814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706817">nrgba</span><span class="op" id="5706822">,</span>&nbsp;<span class="ident" id="5706824">_</span>&nbsp;<span class="op" id="5706826">:=</span>&nbsp;<span class="ident" id="5706829">m</span><span class="op" id="5706830">.</span><span class="op" id="5706831">(</span><span class="op" id="5706832">*</span><span class="ident" id="5706833">image</span><span class="op" id="5706838">.</span><span class="ident" id="5706839">NRGBA</span><span class="op" id="5706844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706848">for</span>&nbsp;<span class="ident" id="5706852">y</span>&nbsp;<span class="op" id="5706854">:=</span>&nbsp;<span class="ident" id="5706857">b</span><span class="op" id="5706858">.</span><span class="ident" id="5706859">Min</span><span class="op" id="5706862">.</span><span class="ident" id="5706863">Y</span><span class="op" id="5706864">;</span>&nbsp;<span class="ident" id="5706866">y</span>&nbsp;<span class="op" id="5706868">&lt;</span>&nbsp;<span class="ident" id="5706870">b</span><span class="op" id="5706871">.</span><span class="ident" id="5706872">Max</span><span class="op" id="5706875">.</span><span class="ident" id="5706876">Y</span><span class="op" id="5706877">;</span>&nbsp;<span class="ident" id="5706879">y</span><span class="op" id="5706880">++</span>&nbsp;<span class="op" id="5706883">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5706887">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706922">i</span>&nbsp;<span class="op" id="5706924">:=</span>&nbsp;<span class="num" id="5706927">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706931">switch</span>&nbsp;<span class="ident" id="5706938">cb</span>&nbsp;<span class="op" id="5706941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706945">case</span>&nbsp;<span class="ident" id="5706950">cbG8</span><span class="op" id="5706954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5706959">if</span>&nbsp;<span class="ident" id="5706962">gray</span>&nbsp;<span class="op" id="5706967">!=</span>&nbsp;<span class="ident" id="5706970">nil</span>&nbsp;<span class="op" id="5706974">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5706980">offset</span>&nbsp;<span class="op" id="5706987">:=</span>&nbsp;<span class="op" id="5706990">(</span><span class="ident" id="5706991">y</span>&nbsp;<span class="op" id="5706993">-</span>&nbsp;<span class="ident" id="5706995">b</span><span class="op" id="5706996">.</span><span class="ident" id="5706997">Min</span><span class="op" id="5707000">.</span><span class="ident" id="5707001">Y</span><span class="op" id="5707002">)</span>&nbsp;<span class="op" id="5707004">*</span>&nbsp;<span class="ident" id="5707006">gray</span><span class="op" id="5707010">.</span><span class="ident" id="5707011">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5707022">copy</span><span class="op" id="5707026">(</span><span class="ident" id="5707027">cr</span><span class="op" id="5707029">[</span><span class="num" id="5707030">0</span><span class="op" id="5707031">]</span><span class="op" id="5707032">[</span><span class="num" id="5707033">1</span><span class="op" id="5707034">:</span><span class="op" id="5707035">]</span><span class="op" id="5707036">,</span>&nbsp;<span class="ident" id="5707038">gray</span><span class="op" id="5707042">.</span><span class="ident" id="5707043">Pix</span><span class="op" id="5707046">[</span><span class="ident" id="5707047">offset</span><span class="op" id="5707053">:</span><span class="ident" id="5707054">offset</span><span class="op" id="5707060">+</span><span class="ident" id="5707061">b</span><span class="op" id="5707062">.</span><span class="ident" id="5707063">Dx</span><span class="op" id="5707065">(</span><span class="op" id="5707066">)</span><span class="op" id="5707067">]</span><span class="op" id="5707068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707073">}</span>&nbsp;<span class="keyword" id="5707075">else</span>&nbsp;<span class="op" id="5707080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707086">for</span>&nbsp;<span class="ident" id="5707090">x</span>&nbsp;<span class="op" id="5707092">:=</span>&nbsp;<span class="ident" id="5707095">b</span><span class="op" id="5707096">.</span><span class="ident" id="5707097">Min</span><span class="op" id="5707100">.</span><span class="ident" id="5707101">X</span><span class="op" id="5707102">;</span>&nbsp;<span class="ident" id="5707104">x</span>&nbsp;<span class="op" id="5707106">&lt;</span>&nbsp;<span class="ident" id="5707108">b</span><span class="op" id="5707109">.</span><span class="ident" id="5707110">Max</span><span class="op" id="5707113">.</span><span class="ident" id="5707114">X</span><span class="op" id="5707115">;</span>&nbsp;<span class="ident" id="5707117">x</span><span class="op" id="5707118">++</span>&nbsp;<span class="op" id="5707121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707128">c</span>&nbsp;<span class="op" id="5707130">:=</span>&nbsp;<span class="ident" id="5707133">color</span><span class="op" id="5707138">.</span><span class="ident" id="5707139">GrayModel</span><span class="op" id="5707148">.</span><span class="ident" id="5707149">Convert</span><span class="op" id="5707156">(</span><span class="ident" id="5707157">m</span><span class="op" id="5707158">.</span><span class="ident" id="5707159">At</span><span class="op" id="5707161">(</span><span class="ident" id="5707162">x</span><span class="op" id="5707163">,</span>&nbsp;<span class="ident" id="5707165">y</span><span class="op" id="5707166">)</span><span class="op" id="5707167">)</span><span class="op" id="5707168">.</span><span class="op" id="5707169">(</span><span class="ident" id="5707170">color</span><span class="op" id="5707175">.</span><span class="ident" id="5707176">Gray</span><span class="op" id="5707180">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707187">cr</span><span class="op" id="5707189">[</span><span class="num" id="5707190">0</span><span class="op" id="5707191">]</span><span class="op" id="5707192">[</span><span class="ident" id="5707193">i</span><span class="op" id="5707194">]</span>&nbsp;<span class="op" id="5707196">=</span>&nbsp;<span class="ident" id="5707198">c</span><span class="op" id="5707199">.</span><span class="ident" id="5707200">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707207">i</span><span class="op" id="5707208">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707224">case</span>&nbsp;<span class="ident" id="5707229">cbTC8</span><span class="op" id="5707234">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5707239">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707311">cr0</span>&nbsp;<span class="op" id="5707315">:=</span>&nbsp;<span class="ident" id="5707318">cr</span><span class="op" id="5707320">[</span><span class="num" id="5707321">0</span><span class="op" id="5707322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707327">stride</span><span class="op" id="5707333">,</span>&nbsp;<span class="ident" id="5707335">pix</span>&nbsp;<span class="op" id="5707339">:=</span>&nbsp;<span class="num" id="5707342">0</span><span class="op" id="5707343">,</span>&nbsp;<span class="op" id="5707345">[</span><span class="op" id="5707346">]</span><span class="builtintype" id="5707347">byte</span><span class="op" id="5707351">(</span><span class="ident" id="5707352">nil</span><span class="op" id="5707355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707360">if</span>&nbsp;<span class="ident" id="5707363">rgba</span>&nbsp;<span class="op" id="5707368">!=</span>&nbsp;<span class="ident" id="5707371">nil</span>&nbsp;<span class="op" id="5707375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707381">stride</span><span class="op" id="5707387">,</span>&nbsp;<span class="ident" id="5707389">pix</span>&nbsp;<span class="op" id="5707393">=</span>&nbsp;<span class="ident" id="5707395">rgba</span><span class="op" id="5707399">.</span><span class="ident" id="5707400">Stride</span><span class="op" id="5707406">,</span>&nbsp;<span class="ident" id="5707408">rgba</span><span class="op" id="5707412">.</span><span class="ident" id="5707413">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707420">}</span>&nbsp;<span class="keyword" id="5707422">else</span>&nbsp;<span class="keyword" id="5707427">if</span>&nbsp;<span class="ident" id="5707430">nrgba</span>&nbsp;<span class="op" id="5707436">!=</span>&nbsp;<span class="ident" id="5707439">nil</span>&nbsp;<span class="op" id="5707443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707449">stride</span><span class="op" id="5707455">,</span>&nbsp;<span class="ident" id="5707457">pix</span>&nbsp;<span class="op" id="5707461">=</span>&nbsp;<span class="ident" id="5707463">nrgba</span><span class="op" id="5707468">.</span><span class="ident" id="5707469">Stride</span><span class="op" id="5707475">,</span>&nbsp;<span class="ident" id="5707477">nrgba</span><span class="op" id="5707482">.</span><span class="ident" id="5707483">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707495">if</span>&nbsp;<span class="ident" id="5707498">stride</span>&nbsp;<span class="op" id="5707505">!=</span>&nbsp;<span class="num" id="5707508">0</span>&nbsp;<span class="op" id="5707510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707516">j0</span>&nbsp;<span class="op" id="5707519">:=</span>&nbsp;<span class="op" id="5707522">(</span><span class="ident" id="5707523">y</span>&nbsp;<span class="op" id="5707525">-</span>&nbsp;<span class="ident" id="5707527">b</span><span class="op" id="5707528">.</span><span class="ident" id="5707529">Min</span><span class="op" id="5707532">.</span><span class="ident" id="5707533">Y</span><span class="op" id="5707534">)</span>&nbsp;<span class="op" id="5707536">*</span>&nbsp;<span class="ident" id="5707538">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707549">j1</span>&nbsp;<span class="op" id="5707552">:=</span>&nbsp;<span class="ident" id="5707555">j0</span>&nbsp;<span class="op" id="5707558">+</span>&nbsp;<span class="ident" id="5707560">b</span><span class="op" id="5707561">.</span><span class="ident" id="5707562">Dx</span><span class="op" id="5707564">(</span><span class="op" id="5707565">)</span><span class="op" id="5707566">*</span><span class="num" id="5707567">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707573">for</span>&nbsp;<span class="ident" id="5707577">j</span>&nbsp;<span class="op" id="5707579">:=</span>&nbsp;<span class="ident" id="5707582">j0</span><span class="op" id="5707584">;</span>&nbsp;<span class="ident" id="5707586">j</span>&nbsp;<span class="op" id="5707588">&lt;</span>&nbsp;<span class="ident" id="5707590">j1</span><span class="op" id="5707592">;</span>&nbsp;<span class="ident" id="5707594">j</span>&nbsp;<span class="op" id="5707596">+=</span>&nbsp;<span class="num" id="5707599">4</span>&nbsp;<span class="op" id="5707601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707608">cr0</span><span class="op" id="5707611">[</span><span class="ident" id="5707612">i</span><span class="op" id="5707613">+</span><span class="num" id="5707614">0</span><span class="op" id="5707615">]</span>&nbsp;<span class="op" id="5707617">=</span>&nbsp;<span class="ident" id="5707619">pix</span><span class="op" id="5707622">[</span><span class="ident" id="5707623">j</span><span class="op" id="5707624">+</span><span class="num" id="5707625">0</span><span class="op" id="5707626">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707633">cr0</span><span class="op" id="5707636">[</span><span class="ident" id="5707637">i</span><span class="op" id="5707638">+</span><span class="num" id="5707639">1</span><span class="op" id="5707640">]</span>&nbsp;<span class="op" id="5707642">=</span>&nbsp;<span class="ident" id="5707644">pix</span><span class="op" id="5707647">[</span><span class="ident" id="5707648">j</span><span class="op" id="5707649">+</span><span class="num" id="5707650">1</span><span class="op" id="5707651">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707658">cr0</span><span class="op" id="5707661">[</span><span class="ident" id="5707662">i</span><span class="op" id="5707663">+</span><span class="num" id="5707664">2</span><span class="op" id="5707665">]</span>&nbsp;<span class="op" id="5707667">=</span>&nbsp;<span class="ident" id="5707669">pix</span><span class="op" id="5707672">[</span><span class="ident" id="5707673">j</span><span class="op" id="5707674">+</span><span class="num" id="5707675">2</span><span class="op" id="5707676">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707683">i</span>&nbsp;<span class="op" id="5707685">+=</span>&nbsp;<span class="num" id="5707688">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707699">}</span>&nbsp;<span class="keyword" id="5707701">else</span>&nbsp;<span class="op" id="5707706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707712">for</span>&nbsp;<span class="ident" id="5707716">x</span>&nbsp;<span class="op" id="5707718">:=</span>&nbsp;<span class="ident" id="5707721">b</span><span class="op" id="5707722">.</span><span class="ident" id="5707723">Min</span><span class="op" id="5707726">.</span><span class="ident" id="5707727">X</span><span class="op" id="5707728">;</span>&nbsp;<span class="ident" id="5707730">x</span>&nbsp;<span class="op" id="5707732">&lt;</span>&nbsp;<span class="ident" id="5707734">b</span><span class="op" id="5707735">.</span><span class="ident" id="5707736">Max</span><span class="op" id="5707739">.</span><span class="ident" id="5707740">X</span><span class="op" id="5707741">;</span>&nbsp;<span class="ident" id="5707743">x</span><span class="op" id="5707744">++</span>&nbsp;<span class="op" id="5707747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707754">r</span><span class="op" id="5707755">,</span>&nbsp;<span class="ident" id="5707757">g</span><span class="op" id="5707758">,</span>&nbsp;<span class="ident" id="5707760">b</span><span class="op" id="5707761">,</span>&nbsp;<span class="ident" id="5707763">_</span>&nbsp;<span class="op" id="5707765">:=</span>&nbsp;<span class="ident" id="5707768">m</span><span class="op" id="5707769">.</span><span class="ident" id="5707770">At</span><span class="op" id="5707772">(</span><span class="ident" id="5707773">x</span><span class="op" id="5707774">,</span>&nbsp;<span class="ident" id="5707776">y</span><span class="op" id="5707777">)</span><span class="op" id="5707778">.</span><span class="ident" id="5707779">RGBA</span><span class="op" id="5707783">(</span><span class="op" id="5707784">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707791">cr0</span><span class="op" id="5707794">[</span><span class="ident" id="5707795">i</span><span class="op" id="5707796">+</span><span class="num" id="5707797">0</span><span class="op" id="5707798">]</span>&nbsp;<span class="op" id="5707800">=</span>&nbsp;<span class="builtintype" id="5707802">uint8</span><span class="op" id="5707807">(</span><span class="ident" id="5707808">r</span>&nbsp;<span class="op" id="5707810">&gt;&gt;</span>&nbsp;<span class="num" id="5707813">8</span><span class="op" id="5707814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707821">cr0</span><span class="op" id="5707824">[</span><span class="ident" id="5707825">i</span><span class="op" id="5707826">+</span><span class="num" id="5707827">1</span><span class="op" id="5707828">]</span>&nbsp;<span class="op" id="5707830">=</span>&nbsp;<span class="builtintype" id="5707832">uint8</span><span class="op" id="5707837">(</span><span class="ident" id="5707838">g</span>&nbsp;<span class="op" id="5707840">&gt;&gt;</span>&nbsp;<span class="num" id="5707843">8</span><span class="op" id="5707844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707851">cr0</span><span class="op" id="5707854">[</span><span class="ident" id="5707855">i</span><span class="op" id="5707856">+</span><span class="num" id="5707857">2</span><span class="op" id="5707858">]</span>&nbsp;<span class="op" id="5707860">=</span>&nbsp;<span class="builtintype" id="5707862">uint8</span><span class="op" id="5707867">(</span><span class="ident" id="5707868">b</span>&nbsp;<span class="op" id="5707870">&gt;&gt;</span>&nbsp;<span class="num" id="5707873">8</span><span class="op" id="5707874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707881">i</span>&nbsp;<span class="op" id="5707883">+=</span>&nbsp;<span class="num" id="5707886">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707892">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5707897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707901">case</span>&nbsp;<span class="ident" id="5707906">cbP8</span><span class="op" id="5707910">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5707915">if</span>&nbsp;<span class="ident" id="5707918">paletted</span>&nbsp;<span class="op" id="5707927">!=</span>&nbsp;<span class="ident" id="5707930">nil</span>&nbsp;<span class="op" id="5707934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5707940">offset</span>&nbsp;<span class="op" id="5707947">:=</span>&nbsp;<span class="op" id="5707950">(</span><span class="ident" id="5707951">y</span>&nbsp;<span class="op" id="5707953">-</span>&nbsp;<span class="ident" id="5707955">b</span><span class="op" id="5707956">.</span><span class="ident" id="5707957">Min</span><span class="op" id="5707960">.</span><span class="ident" id="5707961">Y</span><span class="op" id="5707962">)</span>&nbsp;<span class="op" id="5707964">*</span>&nbsp;<span class="ident" id="5707966">paletted</span><span class="op" id="5707974">.</span><span class="ident" id="5707975">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5707986">copy</span><span class="op" id="5707990">(</span><span class="ident" id="5707991">cr</span><span class="op" id="5707993">[</span><span class="num" id="5707994">0</span><span class="op" id="5707995">]</span><span class="op" id="5707996">[</span><span class="num" id="5707997">1</span><span class="op" id="5707998">:</span><span class="op" id="5707999">]</span><span class="op" id="5708000">,</span>&nbsp;<span class="ident" id="5708002">paletted</span><span class="op" id="5708010">.</span><span class="ident" id="5708011">Pix</span><span class="op" id="5708014">[</span><span class="ident" id="5708015">offset</span><span class="op" id="5708021">:</span><span class="ident" id="5708022">offset</span><span class="op" id="5708028">+</span><span class="ident" id="5708029">b</span><span class="op" id="5708030">.</span><span class="ident" id="5708031">Dx</span><span class="op" id="5708033">(</span><span class="op" id="5708034">)</span><span class="op" id="5708035">]</span><span class="op" id="5708036">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708041">}</span>&nbsp;<span class="keyword" id="5708043">else</span>&nbsp;<span class="op" id="5708048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708054">pi</span>&nbsp;<span class="op" id="5708057">:=</span>&nbsp;<span class="ident" id="5708060">m</span><span class="op" id="5708061">.</span><span class="op" id="5708062">(</span><span class="ident" id="5708063">image</span><span class="op" id="5708068">.</span><span class="ident" id="5708069">PalettedImage</span><span class="op" id="5708082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708088">for</span>&nbsp;<span class="ident" id="5708092">x</span>&nbsp;<span class="op" id="5708094">:=</span>&nbsp;<span class="ident" id="5708097">b</span><span class="op" id="5708098">.</span><span class="ident" id="5708099">Min</span><span class="op" id="5708102">.</span><span class="ident" id="5708103">X</span><span class="op" id="5708104">;</span>&nbsp;<span class="ident" id="5708106">x</span>&nbsp;<span class="op" id="5708108">&lt;</span>&nbsp;<span class="ident" id="5708110">b</span><span class="op" id="5708111">.</span><span class="ident" id="5708112">Max</span><span class="op" id="5708115">.</span><span class="ident" id="5708116">X</span><span class="op" id="5708117">;</span>&nbsp;<span class="ident" id="5708119">x</span><span class="op" id="5708120">++</span>&nbsp;<span class="op" id="5708123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708130">cr</span><span class="op" id="5708132">[</span><span class="num" id="5708133">0</span><span class="op" id="5708134">]</span><span class="op" id="5708135">[</span><span class="ident" id="5708136">i</span><span class="op" id="5708137">]</span>&nbsp;<span class="op" id="5708139">=</span>&nbsp;<span class="ident" id="5708141">pi</span><span class="op" id="5708143">.</span><span class="ident" id="5708144">ColorIndexAt</span><span class="op" id="5708156">(</span><span class="ident" id="5708157">x</span><span class="op" id="5708158">,</span>&nbsp;<span class="ident" id="5708160">y</span><span class="op" id="5708161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708168">i</span>&nbsp;<span class="op" id="5708170">+=</span>&nbsp;<span class="num" id="5708173">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708188">case</span>&nbsp;<span class="ident" id="5708193">cbTCA8</span><span class="op" id="5708199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708204">if</span>&nbsp;<span class="ident" id="5708207">nrgba</span>&nbsp;<span class="op" id="5708213">!=</span>&nbsp;<span class="ident" id="5708216">nil</span>&nbsp;<span class="op" id="5708220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708226">offset</span>&nbsp;<span class="op" id="5708233">:=</span>&nbsp;<span class="op" id="5708236">(</span><span class="ident" id="5708237">y</span>&nbsp;<span class="op" id="5708239">-</span>&nbsp;<span class="ident" id="5708241">b</span><span class="op" id="5708242">.</span><span class="ident" id="5708243">Min</span><span class="op" id="5708246">.</span><span class="ident" id="5708247">Y</span><span class="op" id="5708248">)</span>&nbsp;<span class="op" id="5708250">*</span>&nbsp;<span class="ident" id="5708252">nrgba</span><span class="op" id="5708257">.</span><span class="ident" id="5708258">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5708269">copy</span><span class="op" id="5708273">(</span><span class="ident" id="5708274">cr</span><span class="op" id="5708276">[</span><span class="num" id="5708277">0</span><span class="op" id="5708278">]</span><span class="op" id="5708279">[</span><span class="num" id="5708280">1</span><span class="op" id="5708281">:</span><span class="op" id="5708282">]</span><span class="op" id="5708283">,</span>&nbsp;<span class="ident" id="5708285">nrgba</span><span class="op" id="5708290">.</span><span class="ident" id="5708291">Pix</span><span class="op" id="5708294">[</span><span class="ident" id="5708295">offset</span><span class="op" id="5708301">:</span><span class="ident" id="5708302">offset</span><span class="op" id="5708308">+</span><span class="ident" id="5708309">b</span><span class="op" id="5708310">.</span><span class="ident" id="5708311">Dx</span><span class="op" id="5708313">(</span><span class="op" id="5708314">)</span><span class="op" id="5708315">*</span><span class="num" id="5708316">4</span><span class="op" id="5708317">]</span><span class="op" id="5708318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708323">}</span>&nbsp;<span class="keyword" id="5708325">else</span>&nbsp;<span class="op" id="5708330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5708336">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708433">for</span>&nbsp;<span class="ident" id="5708437">x</span>&nbsp;<span class="op" id="5708439">:=</span>&nbsp;<span class="ident" id="5708442">b</span><span class="op" id="5708443">.</span><span class="ident" id="5708444">Min</span><span class="op" id="5708447">.</span><span class="ident" id="5708448">X</span><span class="op" id="5708449">;</span>&nbsp;<span class="ident" id="5708451">x</span>&nbsp;<span class="op" id="5708453">&lt;</span>&nbsp;<span class="ident" id="5708455">b</span><span class="op" id="5708456">.</span><span class="ident" id="5708457">Max</span><span class="op" id="5708460">.</span><span class="ident" id="5708461">X</span><span class="op" id="5708462">;</span>&nbsp;<span class="ident" id="5708464">x</span><span class="op" id="5708465">++</span>&nbsp;<span class="op" id="5708468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708475">c</span>&nbsp;<span class="op" id="5708477">:=</span>&nbsp;<span class="ident" id="5708480">color</span><span class="op" id="5708485">.</span><span class="ident" id="5708486">NRGBAModel</span><span class="op" id="5708496">.</span><span class="ident" id="5708497">Convert</span><span class="op" id="5708504">(</span><span class="ident" id="5708505">m</span><span class="op" id="5708506">.</span><span class="ident" id="5708507">At</span><span class="op" id="5708509">(</span><span class="ident" id="5708510">x</span><span class="op" id="5708511">,</span>&nbsp;<span class="ident" id="5708513">y</span><span class="op" id="5708514">)</span><span class="op" id="5708515">)</span><span class="op" id="5708516">.</span><span class="op" id="5708517">(</span><span class="ident" id="5708518">color</span><span class="op" id="5708523">.</span><span class="ident" id="5708524">NRGBA</span><span class="op" id="5708529">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708536">cr</span><span class="op" id="5708538">[</span><span class="num" id="5708539">0</span><span class="op" id="5708540">]</span><span class="op" id="5708541">[</span><span class="ident" id="5708542">i</span><span class="op" id="5708543">+</span><span class="num" id="5708544">0</span><span class="op" id="5708545">]</span>&nbsp;<span class="op" id="5708547">=</span>&nbsp;<span class="ident" id="5708549">c</span><span class="op" id="5708550">.</span><span class="ident" id="5708551">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708558">cr</span><span class="op" id="5708560">[</span><span class="num" id="5708561">0</span><span class="op" id="5708562">]</span><span class="op" id="5708563">[</span><span class="ident" id="5708564">i</span><span class="op" id="5708565">+</span><span class="num" id="5708566">1</span><span class="op" id="5708567">]</span>&nbsp;<span class="op" id="5708569">=</span>&nbsp;<span class="ident" id="5708571">c</span><span class="op" id="5708572">.</span><span class="ident" id="5708573">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708580">cr</span><span class="op" id="5708582">[</span><span class="num" id="5708583">0</span><span class="op" id="5708584">]</span><span class="op" id="5708585">[</span><span class="ident" id="5708586">i</span><span class="op" id="5708587">+</span><span class="num" id="5708588">2</span><span class="op" id="5708589">]</span>&nbsp;<span class="op" id="5708591">=</span>&nbsp;<span class="ident" id="5708593">c</span><span class="op" id="5708594">.</span><span class="ident" id="5708595">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708602">cr</span><span class="op" id="5708604">[</span><span class="num" id="5708605">0</span><span class="op" id="5708606">]</span><span class="op" id="5708607">[</span><span class="ident" id="5708608">i</span><span class="op" id="5708609">+</span><span class="num" id="5708610">3</span><span class="op" id="5708611">]</span>&nbsp;<span class="op" id="5708613">=</span>&nbsp;<span class="ident" id="5708615">c</span><span class="op" id="5708616">.</span><span class="ident" id="5708617">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708624">i</span>&nbsp;<span class="op" id="5708626">+=</span>&nbsp;<span class="num" id="5708629">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708644">case</span>&nbsp;<span class="ident" id="5708649">cbG16</span><span class="op" id="5708654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708659">for</span>&nbsp;<span class="ident" id="5708663">x</span>&nbsp;<span class="op" id="5708665">:=</span>&nbsp;<span class="ident" id="5708668">b</span><span class="op" id="5708669">.</span><span class="ident" id="5708670">Min</span><span class="op" id="5708673">.</span><span class="ident" id="5708674">X</span><span class="op" id="5708675">;</span>&nbsp;<span class="ident" id="5708677">x</span>&nbsp;<span class="op" id="5708679">&lt;</span>&nbsp;<span class="ident" id="5708681">b</span><span class="op" id="5708682">.</span><span class="ident" id="5708683">Max</span><span class="op" id="5708686">.</span><span class="ident" id="5708687">X</span><span class="op" id="5708688">;</span>&nbsp;<span class="ident" id="5708690">x</span><span class="op" id="5708691">++</span>&nbsp;<span class="op" id="5708694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708700">c</span>&nbsp;<span class="op" id="5708702">:=</span>&nbsp;<span class="ident" id="5708705">color</span><span class="op" id="5708710">.</span><span class="ident" id="5708711">Gray16Model</span><span class="op" id="5708722">.</span><span class="ident" id="5708723">Convert</span><span class="op" id="5708730">(</span><span class="ident" id="5708731">m</span><span class="op" id="5708732">.</span><span class="ident" id="5708733">At</span><span class="op" id="5708735">(</span><span class="ident" id="5708736">x</span><span class="op" id="5708737">,</span>&nbsp;<span class="ident" id="5708739">y</span><span class="op" id="5708740">)</span><span class="op" id="5708741">)</span><span class="op" id="5708742">.</span><span class="op" id="5708743">(</span><span class="ident" id="5708744">color</span><span class="op" id="5708749">.</span><span class="ident" id="5708750">Gray16</span><span class="op" id="5708756">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708762">cr</span><span class="op" id="5708764">[</span><span class="num" id="5708765">0</span><span class="op" id="5708766">]</span><span class="op" id="5708767">[</span><span class="ident" id="5708768">i</span><span class="op" id="5708769">+</span><span class="num" id="5708770">0</span><span class="op" id="5708771">]</span>&nbsp;<span class="op" id="5708773">=</span>&nbsp;<span class="builtintype" id="5708775">uint8</span><span class="op" id="5708780">(</span><span class="ident" id="5708781">c</span><span class="op" id="5708782">.</span><span class="ident" id="5708783">Y</span>&nbsp;<span class="op" id="5708785">&gt;&gt;</span>&nbsp;<span class="num" id="5708788">8</span><span class="op" id="5708789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708795">cr</span><span class="op" id="5708797">[</span><span class="num" id="5708798">0</span><span class="op" id="5708799">]</span><span class="op" id="5708800">[</span><span class="ident" id="5708801">i</span><span class="op" id="5708802">+</span><span class="num" id="5708803">1</span><span class="op" id="5708804">]</span>&nbsp;<span class="op" id="5708806">=</span>&nbsp;<span class="builtintype" id="5708808">uint8</span><span class="op" id="5708813">(</span><span class="ident" id="5708814">c</span><span class="op" id="5708815">.</span><span class="ident" id="5708816">Y</span><span class="op" id="5708817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708823">i</span>&nbsp;<span class="op" id="5708825">+=</span>&nbsp;<span class="num" id="5708828">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5708833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708837">case</span>&nbsp;<span class="ident" id="5708842">cbTC16</span><span class="op" id="5708848">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5708853">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5708925">for</span>&nbsp;<span class="ident" id="5708929">x</span>&nbsp;<span class="op" id="5708931">:=</span>&nbsp;<span class="ident" id="5708934">b</span><span class="op" id="5708935">.</span><span class="ident" id="5708936">Min</span><span class="op" id="5708939">.</span><span class="ident" id="5708940">X</span><span class="op" id="5708941">;</span>&nbsp;<span class="ident" id="5708943">x</span>&nbsp;<span class="op" id="5708945">&lt;</span>&nbsp;<span class="ident" id="5708947">b</span><span class="op" id="5708948">.</span><span class="ident" id="5708949">Max</span><span class="op" id="5708952">.</span><span class="ident" id="5708953">X</span><span class="op" id="5708954">;</span>&nbsp;<span class="ident" id="5708956">x</span><span class="op" id="5708957">++</span>&nbsp;<span class="op" id="5708960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5708966">r</span><span class="op" id="5708967">,</span>&nbsp;<span class="ident" id="5708969">g</span><span class="op" id="5708970">,</span>&nbsp;<span class="ident" id="5708972">b</span><span class="op" id="5708973">,</span>&nbsp;<span class="ident" id="5708975">_</span>&nbsp;<span class="op" id="5708977">:=</span>&nbsp;<span class="ident" id="5708980">m</span><span class="op" id="5708981">.</span><span class="ident" id="5708982">At</span><span class="op" id="5708984">(</span><span class="ident" id="5708985">x</span><span class="op" id="5708986">,</span>&nbsp;<span class="ident" id="5708988">y</span><span class="op" id="5708989">)</span><span class="op" id="5708990">.</span><span class="ident" id="5708991">RGBA</span><span class="op" id="5708995">(</span><span class="op" id="5708996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709002">cr</span><span class="op" id="5709004">[</span><span class="num" id="5709005">0</span><span class="op" id="5709006">]</span><span class="op" id="5709007">[</span><span class="ident" id="5709008">i</span><span class="op" id="5709009">+</span><span class="num" id="5709010">0</span><span class="op" id="5709011">]</span>&nbsp;<span class="op" id="5709013">=</span>&nbsp;<span class="builtintype" id="5709015">uint8</span><span class="op" id="5709020">(</span><span class="ident" id="5709021">r</span>&nbsp;<span class="op" id="5709023">&gt;&gt;</span>&nbsp;<span class="num" id="5709026">8</span><span class="op" id="5709027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709033">cr</span><span class="op" id="5709035">[</span><span class="num" id="5709036">0</span><span class="op" id="5709037">]</span><span class="op" id="5709038">[</span><span class="ident" id="5709039">i</span><span class="op" id="5709040">+</span><span class="num" id="5709041">1</span><span class="op" id="5709042">]</span>&nbsp;<span class="op" id="5709044">=</span>&nbsp;<span class="builtintype" id="5709046">uint8</span><span class="op" id="5709051">(</span><span class="ident" id="5709052">r</span><span class="op" id="5709053">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709059">cr</span><span class="op" id="5709061">[</span><span class="num" id="5709062">0</span><span class="op" id="5709063">]</span><span class="op" id="5709064">[</span><span class="ident" id="5709065">i</span><span class="op" id="5709066">+</span><span class="num" id="5709067">2</span><span class="op" id="5709068">]</span>&nbsp;<span class="op" id="5709070">=</span>&nbsp;<span class="builtintype" id="5709072">uint8</span><span class="op" id="5709077">(</span><span class="ident" id="5709078">g</span>&nbsp;<span class="op" id="5709080">&gt;&gt;</span>&nbsp;<span class="num" id="5709083">8</span><span class="op" id="5709084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709090">cr</span><span class="op" id="5709092">[</span><span class="num" id="5709093">0</span><span class="op" id="5709094">]</span><span class="op" id="5709095">[</span><span class="ident" id="5709096">i</span><span class="op" id="5709097">+</span><span class="num" id="5709098">3</span><span class="op" id="5709099">]</span>&nbsp;<span class="op" id="5709101">=</span>&nbsp;<span class="builtintype" id="5709103">uint8</span><span class="op" id="5709108">(</span><span class="ident" id="5709109">g</span><span class="op" id="5709110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709116">cr</span><span class="op" id="5709118">[</span><span class="num" id="5709119">0</span><span class="op" id="5709120">]</span><span class="op" id="5709121">[</span><span class="ident" id="5709122">i</span><span class="op" id="5709123">+</span><span class="num" id="5709124">4</span><span class="op" id="5709125">]</span>&nbsp;<span class="op" id="5709127">=</span>&nbsp;<span class="builtintype" id="5709129">uint8</span><span class="op" id="5709134">(</span><span class="ident" id="5709135">b</span>&nbsp;<span class="op" id="5709137">&gt;&gt;</span>&nbsp;<span class="num" id="5709140">8</span><span class="op" id="5709141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709147">cr</span><span class="op" id="5709149">[</span><span class="num" id="5709150">0</span><span class="op" id="5709151">]</span><span class="op" id="5709152">[</span><span class="ident" id="5709153">i</span><span class="op" id="5709154">+</span><span class="num" id="5709155">5</span><span class="op" id="5709156">]</span>&nbsp;<span class="op" id="5709158">=</span>&nbsp;<span class="builtintype" id="5709160">uint8</span><span class="op" id="5709165">(</span><span class="ident" id="5709166">b</span><span class="op" id="5709167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709173">i</span>&nbsp;<span class="op" id="5709175">+=</span>&nbsp;<span class="num" id="5709178">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709187">case</span>&nbsp;<span class="ident" id="5709192">cbTCA16</span><span class="op" id="5709199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5709204">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709300">for</span>&nbsp;<span class="ident" id="5709304">x</span>&nbsp;<span class="op" id="5709306">:=</span>&nbsp;<span class="ident" id="5709309">b</span><span class="op" id="5709310">.</span><span class="ident" id="5709311">Min</span><span class="op" id="5709314">.</span><span class="ident" id="5709315">X</span><span class="op" id="5709316">;</span>&nbsp;<span class="ident" id="5709318">x</span>&nbsp;<span class="op" id="5709320">&lt;</span>&nbsp;<span class="ident" id="5709322">b</span><span class="op" id="5709323">.</span><span class="ident" id="5709324">Max</span><span class="op" id="5709327">.</span><span class="ident" id="5709328">X</span><span class="op" id="5709329">;</span>&nbsp;<span class="ident" id="5709331">x</span><span class="op" id="5709332">++</span>&nbsp;<span class="op" id="5709335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709341">c</span>&nbsp;<span class="op" id="5709343">:=</span>&nbsp;<span class="ident" id="5709346">color</span><span class="op" id="5709351">.</span><span class="ident" id="5709352">NRGBA64Model</span><span class="op" id="5709364">.</span><span class="ident" id="5709365">Convert</span><span class="op" id="5709372">(</span><span class="ident" id="5709373">m</span><span class="op" id="5709374">.</span><span class="ident" id="5709375">At</span><span class="op" id="5709377">(</span><span class="ident" id="5709378">x</span><span class="op" id="5709379">,</span>&nbsp;<span class="ident" id="5709381">y</span><span class="op" id="5709382">)</span><span class="op" id="5709383">)</span><span class="op" id="5709384">.</span><span class="op" id="5709385">(</span><span class="ident" id="5709386">color</span><span class="op" id="5709391">.</span><span class="ident" id="5709392">NRGBA64</span><span class="op" id="5709399">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709405">cr</span><span class="op" id="5709407">[</span><span class="num" id="5709408">0</span><span class="op" id="5709409">]</span><span class="op" id="5709410">[</span><span class="ident" id="5709411">i</span><span class="op" id="5709412">+</span><span class="num" id="5709413">0</span><span class="op" id="5709414">]</span>&nbsp;<span class="op" id="5709416">=</span>&nbsp;<span class="builtintype" id="5709418">uint8</span><span class="op" id="5709423">(</span><span class="ident" id="5709424">c</span><span class="op" id="5709425">.</span><span class="ident" id="5709426">R</span>&nbsp;<span class="op" id="5709428">&gt;&gt;</span>&nbsp;<span class="num" id="5709431">8</span><span class="op" id="5709432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709438">cr</span><span class="op" id="5709440">[</span><span class="num" id="5709441">0</span><span class="op" id="5709442">]</span><span class="op" id="5709443">[</span><span class="ident" id="5709444">i</span><span class="op" id="5709445">+</span><span class="num" id="5709446">1</span><span class="op" id="5709447">]</span>&nbsp;<span class="op" id="5709449">=</span>&nbsp;<span class="builtintype" id="5709451">uint8</span><span class="op" id="5709456">(</span><span class="ident" id="5709457">c</span><span class="op" id="5709458">.</span><span class="ident" id="5709459">R</span><span class="op" id="5709460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709466">cr</span><span class="op" id="5709468">[</span><span class="num" id="5709469">0</span><span class="op" id="5709470">]</span><span class="op" id="5709471">[</span><span class="ident" id="5709472">i</span><span class="op" id="5709473">+</span><span class="num" id="5709474">2</span><span class="op" id="5709475">]</span>&nbsp;<span class="op" id="5709477">=</span>&nbsp;<span class="builtintype" id="5709479">uint8</span><span class="op" id="5709484">(</span><span class="ident" id="5709485">c</span><span class="op" id="5709486">.</span><span class="ident" id="5709487">G</span>&nbsp;<span class="op" id="5709489">&gt;&gt;</span>&nbsp;<span class="num" id="5709492">8</span><span class="op" id="5709493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709499">cr</span><span class="op" id="5709501">[</span><span class="num" id="5709502">0</span><span class="op" id="5709503">]</span><span class="op" id="5709504">[</span><span class="ident" id="5709505">i</span><span class="op" id="5709506">+</span><span class="num" id="5709507">3</span><span class="op" id="5709508">]</span>&nbsp;<span class="op" id="5709510">=</span>&nbsp;<span class="builtintype" id="5709512">uint8</span><span class="op" id="5709517">(</span><span class="ident" id="5709518">c</span><span class="op" id="5709519">.</span><span class="ident" id="5709520">G</span><span class="op" id="5709521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709527">cr</span><span class="op" id="5709529">[</span><span class="num" id="5709530">0</span><span class="op" id="5709531">]</span><span class="op" id="5709532">[</span><span class="ident" id="5709533">i</span><span class="op" id="5709534">+</span><span class="num" id="5709535">4</span><span class="op" id="5709536">]</span>&nbsp;<span class="op" id="5709538">=</span>&nbsp;<span class="builtintype" id="5709540">uint8</span><span class="op" id="5709545">(</span><span class="ident" id="5709546">c</span><span class="op" id="5709547">.</span><span class="ident" id="5709548">B</span>&nbsp;<span class="op" id="5709550">&gt;&gt;</span>&nbsp;<span class="num" id="5709553">8</span><span class="op" id="5709554">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709560">cr</span><span class="op" id="5709562">[</span><span class="num" id="5709563">0</span><span class="op" id="5709564">]</span><span class="op" id="5709565">[</span><span class="ident" id="5709566">i</span><span class="op" id="5709567">+</span><span class="num" id="5709568">5</span><span class="op" id="5709569">]</span>&nbsp;<span class="op" id="5709571">=</span>&nbsp;<span class="builtintype" id="5709573">uint8</span><span class="op" id="5709578">(</span><span class="ident" id="5709579">c</span><span class="op" id="5709580">.</span><span class="ident" id="5709581">B</span><span class="op" id="5709582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709588">cr</span><span class="op" id="5709590">[</span><span class="num" id="5709591">0</span><span class="op" id="5709592">]</span><span class="op" id="5709593">[</span><span class="ident" id="5709594">i</span><span class="op" id="5709595">+</span><span class="num" id="5709596">6</span><span class="op" id="5709597">]</span>&nbsp;<span class="op" id="5709599">=</span>&nbsp;<span class="builtintype" id="5709601">uint8</span><span class="op" id="5709606">(</span><span class="ident" id="5709607">c</span><span class="op" id="5709608">.</span><span class="ident" id="5709609">A</span>&nbsp;<span class="op" id="5709611">&gt;&gt;</span>&nbsp;<span class="num" id="5709614">8</span><span class="op" id="5709615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709621">cr</span><span class="op" id="5709623">[</span><span class="num" id="5709624">0</span><span class="op" id="5709625">]</span><span class="op" id="5709626">[</span><span class="ident" id="5709627">i</span><span class="op" id="5709628">+</span><span class="num" id="5709629">7</span><span class="op" id="5709630">]</span>&nbsp;<span class="op" id="5709632">=</span>&nbsp;<span class="builtintype" id="5709634">uint8</span><span class="op" id="5709639">(</span><span class="ident" id="5709640">c</span><span class="op" id="5709641">.</span><span class="ident" id="5709642">A</span><span class="op" id="5709643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709649">i</span>&nbsp;<span class="op" id="5709651">+=</span>&nbsp;<span class="num" id="5709654">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709659">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5709668">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709691">f</span>&nbsp;<span class="op" id="5709693">:=</span>&nbsp;<span class="ident" id="5709696">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709705">if</span>&nbsp;<span class="ident" id="5709708">level</span>&nbsp;<span class="op" id="5709714">!=</span>&nbsp;<span class="ident" id="5709717">zlib</span><span class="op" id="5709721">.</span><span class="ident" id="5709722">NoCompression</span>&nbsp;<span class="op" id="5709736">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709741">f</span>&nbsp;<span class="op" id="5709743">=</span>&nbsp;<span class="ident" id="5709745">filter</span><span class="op" id="5709751">(</span><span class="op" id="5709752">&amp;</span><span class="ident" id="5709753">cr</span><span class="op" id="5709755">,</span>&nbsp;<span class="ident" id="5709757">pr</span><span class="op" id="5709759">,</span>&nbsp;<span class="ident" id="5709761">bpp</span><span class="op" id="5709764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5709773">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709806">if</span>&nbsp;<span class="ident" id="5709809">_</span><span class="op" id="5709810">,</span>&nbsp;<span class="ident" id="5709812">err</span>&nbsp;<span class="op" id="5709816">:=</span>&nbsp;<span class="ident" id="5709819">zw</span><span class="op" id="5709821">.</span><span class="ident" id="5709822">Write</span><span class="op" id="5709827">(</span><span class="ident" id="5709828">cr</span><span class="op" id="5709830">[</span><span class="ident" id="5709831">f</span><span class="op" id="5709832">]</span><span class="op" id="5709833">)</span><span class="op" id="5709834">;</span>&nbsp;<span class="ident" id="5709836">err</span>&nbsp;<span class="op" id="5709840">!=</span>&nbsp;<span class="ident" id="5709843">nil</span>&nbsp;<span class="op" id="5709847">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709852">return</span>&nbsp;<span class="ident" id="5709859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5709870">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5709926">pr</span><span class="op" id="5709928">,</span>&nbsp;<span class="ident" id="5709930">cr</span><span class="op" id="5709932">[</span><span class="num" id="5709933">0</span><span class="op" id="5709934">]</span>&nbsp;<span class="op" id="5709936">=</span>&nbsp;<span class="ident" id="5709938">cr</span><span class="op" id="5709940">[</span><span class="num" id="5709941">0</span><span class="op" id="5709942">]</span><span class="op" id="5709943">,</span>&nbsp;<span class="ident" id="5709945">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5709949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5709952">return</span>&nbsp;<span class="ident" id="5709959">nil</span><br>
<span class="lineno"></span><span class="op" id="5709963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5709966">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5710025">func</span>&nbsp;<span class="op" id="5710030">(</span><span class="ident" id="5710031">e</span>&nbsp;<span class="op" id="5710033">*</span><span class="ident" id="5710034">encoder</span><span class="op" id="5710041">)</span>&nbsp;<span class="ident" id="5710043">writeIDATs</span><span class="op" id="5710053">(</span><span class="op" id="5710054">)</span>&nbsp;<span class="op" id="5710056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710059">if</span>&nbsp;<span class="ident" id="5710062">e</span><span class="op" id="5710063">.</span><span class="ident" id="5710064">err</span>&nbsp;<span class="op" id="5710068">!=</span>&nbsp;<span class="ident" id="5710071">nil</span>&nbsp;<span class="op" id="5710075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710079">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710090">var</span>&nbsp;<span class="ident" id="5710094">bw</span>&nbsp;<span class="op" id="5710097">*</span><span class="ident" id="5710098">bufio</span><span class="op" id="5710103">.</span><span class="ident" id="5710104">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710112">bw</span>&nbsp;<span class="op" id="5710115">=</span>&nbsp;<span class="ident" id="5710117">bufio</span><span class="op" id="5710122">.</span><span class="ident" id="5710123">NewWriterSize</span><span class="op" id="5710136">(</span><span class="ident" id="5710137">e</span><span class="op" id="5710138">,</span>&nbsp;<span class="num" id="5710140">1</span><span class="op" id="5710141">&lt;&lt;</span><span class="num" id="5710143">15</span><span class="op" id="5710145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710148">e</span><span class="op" id="5710149">.</span><span class="ident" id="5710150">err</span>&nbsp;<span class="op" id="5710154">=</span>&nbsp;<span class="ident" id="5710156">writeImage</span><span class="op" id="5710166">(</span><span class="ident" id="5710167">bw</span><span class="op" id="5710169">,</span>&nbsp;<span class="ident" id="5710171">e</span><span class="op" id="5710172">.</span><span class="ident" id="5710173">m</span><span class="op" id="5710174">,</span>&nbsp;<span class="ident" id="5710176">e</span><span class="op" id="5710177">.</span><span class="ident" id="5710178">cb</span><span class="op" id="5710180">,</span>&nbsp;<span class="ident" id="5710182">levelToZlib</span><span class="op" id="5710193">(</span><span class="ident" id="5710194">e</span><span class="op" id="5710195">.</span><span class="ident" id="5710196">enc</span><span class="op" id="5710199">.</span><span class="ident" id="5710200">CompressionLevel</span><span class="op" id="5710216">)</span><span class="op" id="5710217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710220">if</span>&nbsp;<span class="ident" id="5710223">e</span><span class="op" id="5710224">.</span><span class="ident" id="5710225">err</span>&nbsp;<span class="op" id="5710229">!=</span>&nbsp;<span class="ident" id="5710232">nil</span>&nbsp;<span class="op" id="5710236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710240">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710248">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5710251">e</span><span class="op" id="5710252">.</span><span class="ident" id="5710253">err</span>&nbsp;<span class="op" id="5710257">=</span>&nbsp;<span class="ident" id="5710259">bw</span><span class="op" id="5710261">.</span><span class="ident" id="5710262">Flush</span><span class="op" id="5710267">(</span><span class="op" id="5710268">)</span><br>
<span class="lineno"></span><span class="op" id="5710270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710273">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5710336">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5710399">func</span>&nbsp;<span class="ident" id="5710404">levelToZlib</span><span class="op" id="5710415">(</span><span class="ident" id="5710416">l</span>&nbsp;<span class="ident" id="5710418">CompressionLevel</span><span class="op" id="5710434">)</span>&nbsp;<span class="builtintype" id="5710436">int</span>&nbsp;<span class="op" id="5710440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710443">switch</span>&nbsp;<span class="ident" id="5710450">l</span>&nbsp;<span class="op" id="5710452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710455">case</span>&nbsp;<span class="ident" id="5710460">DefaultCompression</span><span class="op" id="5710478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710482">return</span>&nbsp;<span class="ident" id="5710489">zlib</span><span class="op" id="5710493">.</span><span class="ident" id="5710494">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710514">case</span>&nbsp;<span class="ident" id="5710519">NoCompression</span><span class="op" id="5710532">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710536">return</span>&nbsp;<span class="ident" id="5710543">zlib</span><span class="op" id="5710547">.</span><span class="ident" id="5710548">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710563">case</span>&nbsp;<span class="ident" id="5710568">BestSpeed</span><span class="op" id="5710577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710581">return</span>&nbsp;<span class="ident" id="5710588">zlib</span><span class="op" id="5710592">.</span><span class="ident" id="5710593">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710604">case</span>&nbsp;<span class="ident" id="5710609">BestCompression</span><span class="op" id="5710624">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710628">return</span>&nbsp;<span class="ident" id="5710635">zlib</span><span class="op" id="5710639">.</span><span class="ident" id="5710640">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710657">default</span><span class="op" id="5710664">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710668">return</span>&nbsp;<span class="ident" id="5710675">zlib</span><span class="op" id="5710679">.</span><span class="ident" id="5710680">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5710700">}</span><br>
<span class="lineno"></span><span class="op" id="5710702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5710705">func</span>&nbsp;<span class="op" id="5710710">(</span><span class="ident" id="5710711">e</span>&nbsp;<span class="op" id="5710713">*</span><span class="ident" id="5710714">encoder</span><span class="op" id="5710721">)</span>&nbsp;<span class="ident" id="5710723">writeIEND</span><span class="op" id="5710732">(</span><span class="op" id="5710733">)</span>&nbsp;<span class="op" id="5710735">{</span>&nbsp;<span class="ident" id="5710737">e</span><span class="op" id="5710738">.</span><span class="ident" id="5710739">writeChunk</span><span class="op" id="5710749">(</span><span class="ident" id="5710750">nil</span><span class="op" id="5710753">,</span>&nbsp;<span class="string" id="5710755">&#34;IEND&#34;</span><span class="op" id="5710761">)</span>&nbsp;<span class="op" id="5710763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710766">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5710832">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5710906">func</span>&nbsp;<span class="ident" id="5710911">Encode</span><span class="op" id="5710917">(</span><span class="ident" id="5710918">w</span>&nbsp;<span class="ident" id="5710920">io</span><span class="op" id="5710922">.</span><span class="ident" id="5710923">Writer</span><span class="op" id="5710929">,</span>&nbsp;<span class="ident" id="5710931">m</span>&nbsp;<span class="ident" id="5710933">image</span><span class="op" id="5710938">.</span><span class="ident" id="5710939">Image</span><span class="op" id="5710944">)</span>&nbsp;<span class="builtintype" id="5710946">error</span>&nbsp;<span class="op" id="5710952">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710955">var</span>&nbsp;<span class="ident" id="5710959">e</span>&nbsp;<span class="ident" id="5710961">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5710970">return</span>&nbsp;<span class="ident" id="5710977">e</span><span class="op" id="5710978">.</span><span class="ident" id="5710979">Encode</span><span class="op" id="5710985">(</span><span class="ident" id="5710986">w</span><span class="op" id="5710987">,</span>&nbsp;<span class="ident" id="5710989">m</span><span class="op" id="5710990">)</span><br>
<span class="lineno"></span><span class="op" id="5710992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710995">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5711044">func</span>&nbsp;<span class="op" id="5711049">(</span><span class="ident" id="5711050">enc</span>&nbsp;<span class="op" id="5711054">*</span><span class="ident" id="5711055">Encoder</span><span class="op" id="5711062">)</span>&nbsp;<span class="ident" id="5711064">Encode</span><span class="op" id="5711070">(</span><span class="ident" id="5711071">w</span>&nbsp;<span class="ident" id="5711073">io</span><span class="op" id="5711075">.</span><span class="ident" id="5711076">Writer</span><span class="op" id="5711082">,</span>&nbsp;<span class="ident" id="5711084">m</span>&nbsp;<span class="ident" id="5711086">image</span><span class="op" id="5711091">.</span><span class="ident" id="5711092">Image</span><span class="op" id="5711097">)</span>&nbsp;<span class="builtintype" id="5711099">error</span>&nbsp;<span class="op" id="5711105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711108">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711185">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711265">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711284">mw</span><span class="op" id="5711286">,</span>&nbsp;<span class="ident" id="5711288">mh</span>&nbsp;<span class="op" id="5711291">:=</span>&nbsp;<span class="ident" id="5711294">int64</span><span class="op" id="5711299">(</span><span class="ident" id="5711300">m</span><span class="op" id="5711301">.</span><span class="ident" id="5711302">Bounds</span><span class="op" id="5711308">(</span><span class="op" id="5711309">)</span><span class="op" id="5711310">.</span><span class="ident" id="5711311">Dx</span><span class="op" id="5711313">(</span><span class="op" id="5711314">)</span><span class="op" id="5711315">)</span><span class="op" id="5711316">,</span>&nbsp;<span class="ident" id="5711318">int64</span><span class="op" id="5711323">(</span><span class="ident" id="5711324">m</span><span class="op" id="5711325">.</span><span class="ident" id="5711326">Bounds</span><span class="op" id="5711332">(</span><span class="op" id="5711333">)</span><span class="op" id="5711334">.</span><span class="ident" id="5711335">Dy</span><span class="op" id="5711337">(</span><span class="op" id="5711338">)</span><span class="op" id="5711339">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711342">if</span>&nbsp;<span class="ident" id="5711345">mw</span>&nbsp;<span class="op" id="5711348">&lt;=</span>&nbsp;<span class="num" id="5711351">0</span>&nbsp;<span class="op" id="5711353">||</span>&nbsp;<span class="ident" id="5711356">mh</span>&nbsp;<span class="op" id="5711359">&lt;=</span>&nbsp;<span class="num" id="5711362">0</span>&nbsp;<span class="op" id="5711364">||</span>&nbsp;<span class="ident" id="5711367">mw</span>&nbsp;<span class="op" id="5711370">&gt;=</span>&nbsp;<span class="num" id="5711373">1</span><span class="op" id="5711374">&lt;&lt;</span><span class="num" id="5711376">32</span>&nbsp;<span class="op" id="5711379">||</span>&nbsp;<span class="ident" id="5711382">mh</span>&nbsp;<span class="op" id="5711385">&gt;=</span>&nbsp;<span class="num" id="5711388">1</span><span class="op" id="5711389">&lt;&lt;</span><span class="num" id="5711391">32</span>&nbsp;<span class="op" id="5711394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711398">return</span>&nbsp;<span class="ident" id="5711405">FormatError</span><span class="op" id="5711416">(</span><span class="string" id="5711417">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5711440">+</span>&nbsp;<span class="ident" id="5711442">strconv</span><span class="op" id="5711449">.</span><span class="ident" id="5711450">FormatInt</span><span class="op" id="5711459">(</span><span class="ident" id="5711460">mw</span><span class="op" id="5711462">,</span>&nbsp;<span class="num" id="5711464">10</span><span class="op" id="5711466">)</span>&nbsp;<span class="op" id="5711468">+</span>&nbsp;<span class="string" id="5711470">&#34;x&#34;</span>&nbsp;<span class="op" id="5711474">+</span>&nbsp;<span class="ident" id="5711476">strconv</span><span class="op" id="5711483">.</span><span class="ident" id="5711484">FormatInt</span><span class="op" id="5711493">(</span><span class="ident" id="5711494">mh</span><span class="op" id="5711496">,</span>&nbsp;<span class="num" id="5711498">10</span><span class="op" id="5711500">)</span><span class="op" id="5711501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711508">var</span>&nbsp;<span class="ident" id="5711512">e</span>&nbsp;<span class="ident" id="5711514">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711523">e</span><span class="op" id="5711524">.</span><span class="ident" id="5711525">enc</span>&nbsp;<span class="op" id="5711529">=</span>&nbsp;<span class="ident" id="5711531">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711536">e</span><span class="op" id="5711537">.</span><span class="ident" id="5711538">w</span>&nbsp;<span class="op" id="5711540">=</span>&nbsp;<span class="ident" id="5711542">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711545">e</span><span class="op" id="5711546">.</span><span class="ident" id="5711547">m</span>&nbsp;<span class="op" id="5711549">=</span>&nbsp;<span class="ident" id="5711551">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711555">var</span>&nbsp;<span class="ident" id="5711559">pal</span>&nbsp;<span class="ident" id="5711563">color</span><span class="op" id="5711568">.</span><span class="ident" id="5711569">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5711578">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711639">if</span>&nbsp;<span class="ident" id="5711642">_</span><span class="op" id="5711643">,</span>&nbsp;<span class="ident" id="5711645">ok</span>&nbsp;<span class="op" id="5711648">:=</span>&nbsp;<span class="ident" id="5711651">m</span><span class="op" id="5711652">.</span><span class="op" id="5711653">(</span><span class="ident" id="5711654">image</span><span class="op" id="5711659">.</span><span class="ident" id="5711660">PalettedImage</span><span class="op" id="5711673">)</span><span class="op" id="5711674">;</span>&nbsp;<span class="ident" id="5711676">ok</span>&nbsp;<span class="op" id="5711679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711683">pal</span><span class="op" id="5711686">,</span>&nbsp;<span class="ident" id="5711688">_</span>&nbsp;<span class="op" id="5711690">=</span>&nbsp;<span class="ident" id="5711692">m</span><span class="op" id="5711693">.</span><span class="ident" id="5711694">ColorModel</span><span class="op" id="5711704">(</span><span class="op" id="5711705">)</span><span class="op" id="5711706">.</span><span class="op" id="5711707">(</span><span class="ident" id="5711708">color</span><span class="op" id="5711713">.</span><span class="ident" id="5711714">Palette</span><span class="op" id="5711721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711727">if</span>&nbsp;<span class="ident" id="5711730">pal</span>&nbsp;<span class="op" id="5711734">!=</span>&nbsp;<span class="ident" id="5711737">nil</span>&nbsp;<span class="op" id="5711741">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711745">e</span><span class="op" id="5711746">.</span><span class="ident" id="5711747">cb</span>&nbsp;<span class="op" id="5711750">=</span>&nbsp;<span class="ident" id="5711752">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711758">}</span>&nbsp;<span class="keyword" id="5711760">else</span>&nbsp;<span class="op" id="5711765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711769">switch</span>&nbsp;<span class="ident" id="5711776">m</span><span class="op" id="5711777">.</span><span class="ident" id="5711778">ColorModel</span><span class="op" id="5711788">(</span><span class="op" id="5711789">)</span>&nbsp;<span class="op" id="5711791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711795">case</span>&nbsp;<span class="ident" id="5711800">color</span><span class="op" id="5711805">.</span><span class="ident" id="5711806">GrayModel</span><span class="op" id="5711815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711820">e</span><span class="op" id="5711821">.</span><span class="ident" id="5711822">cb</span>&nbsp;<span class="op" id="5711825">=</span>&nbsp;<span class="ident" id="5711827">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711834">case</span>&nbsp;<span class="ident" id="5711839">color</span><span class="op" id="5711844">.</span><span class="ident" id="5711845">Gray16Model</span><span class="op" id="5711856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711861">e</span><span class="op" id="5711862">.</span><span class="ident" id="5711863">cb</span>&nbsp;<span class="op" id="5711866">=</span>&nbsp;<span class="ident" id="5711868">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711876">case</span>&nbsp;<span class="ident" id="5711881">color</span><span class="op" id="5711886">.</span><span class="ident" id="5711887">RGBAModel</span><span class="op" id="5711896">,</span>&nbsp;<span class="ident" id="5711898">color</span><span class="op" id="5711903">.</span><span class="ident" id="5711904">NRGBAModel</span><span class="op" id="5711914">,</span>&nbsp;<span class="ident" id="5711916">color</span><span class="op" id="5711921">.</span><span class="ident" id="5711922">AlphaModel</span><span class="op" id="5711932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5711937">if</span>&nbsp;<span class="ident" id="5711940">opaque</span><span class="op" id="5711946">(</span><span class="ident" id="5711947">m</span><span class="op" id="5711948">)</span>&nbsp;<span class="op" id="5711950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711956">e</span><span class="op" id="5711957">.</span><span class="ident" id="5711958">cb</span>&nbsp;<span class="op" id="5711961">=</span>&nbsp;<span class="ident" id="5711963">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5711972">}</span>&nbsp;<span class="keyword" id="5711974">else</span>&nbsp;<span class="op" id="5711979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5711985">e</span><span class="op" id="5711986">.</span><span class="ident" id="5711987">cb</span>&nbsp;<span class="op" id="5711990">=</span>&nbsp;<span class="ident" id="5711992">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712006">default</span><span class="op" id="5712013">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712018">if</span>&nbsp;<span class="ident" id="5712021">opaque</span><span class="op" id="5712027">(</span><span class="ident" id="5712028">m</span><span class="op" id="5712029">)</span>&nbsp;<span class="op" id="5712031">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712037">e</span><span class="op" id="5712038">.</span><span class="ident" id="5712039">cb</span>&nbsp;<span class="op" id="5712042">=</span>&nbsp;<span class="ident" id="5712044">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712054">}</span>&nbsp;<span class="keyword" id="5712056">else</span>&nbsp;<span class="op" id="5712061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712067">e</span><span class="op" id="5712068">.</span><span class="ident" id="5712069">cb</span>&nbsp;<span class="op" id="5712072">=</span>&nbsp;<span class="ident" id="5712074">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712089">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712096">_</span><span class="op" id="5712097">,</span>&nbsp;<span class="ident" id="5712099">e</span><span class="op" id="5712100">.</span><span class="ident" id="5712101">err</span>&nbsp;<span class="op" id="5712105">=</span>&nbsp;<span class="ident" id="5712107">io</span><span class="op" id="5712109">.</span><span class="ident" id="5712110">WriteString</span><span class="op" id="5712121">(</span><span class="ident" id="5712122">w</span><span class="op" id="5712123">,</span>&nbsp;<span class="ident" id="5712125">pngHeader</span><span class="op" id="5712134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712137">e</span><span class="op" id="5712138">.</span><span class="ident" id="5712139">writeIHDR</span><span class="op" id="5712148">(</span><span class="op" id="5712149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712152">if</span>&nbsp;<span class="ident" id="5712155">pal</span>&nbsp;<span class="op" id="5712159">!=</span>&nbsp;<span class="ident" id="5712162">nil</span>&nbsp;<span class="op" id="5712166">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712170">e</span><span class="op" id="5712171">.</span><span class="ident" id="5712172">writePLTEAndTRNS</span><span class="op" id="5712188">(</span><span class="ident" id="5712189">pal</span><span class="op" id="5712192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5712195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712198">e</span><span class="op" id="5712199">.</span><span class="ident" id="5712200">writeIDATs</span><span class="op" id="5712210">(</span><span class="op" id="5712211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5712214">e</span><span class="op" id="5712215">.</span><span class="ident" id="5712216">writeIEND</span><span class="op" id="5712225">(</span><span class="op" id="5712226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5712229">return</span>&nbsp;<span class="ident" id="5712236">e</span><span class="op" id="5712237">.</span><span class="ident" id="5712238">err</span><br>
<span class="lineno">530</span><span class="op" id="5712242">}</span>
</div>
</body>
</html>
