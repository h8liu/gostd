<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1921423">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1921478">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1921532">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1921583">package</span>&nbsp;<span class="ident" id="1921591">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1921600">import</span>&nbsp;<span class="op" id="1921607">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1921610">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1921619">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1921622">const</span>&nbsp;<span class="op" id="1921628">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921631">debugMalloc</span>&nbsp;<span class="op" id="1921643">=</span>&nbsp;<span class="builtintype" id="1921645">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921653">flagNoScan</span>&nbsp;<span class="op" id="1921664">=</span>&nbsp;<span class="ident" id="1921666">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921679">flagNoZero</span>&nbsp;<span class="op" id="1921690">=</span>&nbsp;<span class="ident" id="1921692">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921706">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1921720">=</span>&nbsp;<span class="ident" id="1921722">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921733">tinySizeClass</span>&nbsp;<span class="op" id="1921747">=</span>&nbsp;<span class="ident" id="1921749">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921765">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1921779">=</span>&nbsp;<span class="ident" id="1921781">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921797">pageShift</span>&nbsp;<span class="op" id="1921807">=</span>&nbsp;<span class="ident" id="1921809">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921821">pageSize</span>&nbsp;&nbsp;<span class="op" id="1921831">=</span>&nbsp;<span class="ident" id="1921833">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921844">pageMask</span>&nbsp;&nbsp;<span class="op" id="1921854">=</span>&nbsp;<span class="ident" id="1921856">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921868">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1921884">=</span>&nbsp;<span class="ident" id="1921886">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921903">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1921919">=</span>&nbsp;<span class="ident" id="1921921">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921932">pointersPerByte</span>&nbsp;<span class="op" id="1921948">=</span>&nbsp;<span class="ident" id="1921950">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921968">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1921984">=</span>&nbsp;<span class="ident" id="1921986">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921998">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1922014">=</span>&nbsp;<span class="ident" id="1922016">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1922027">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1922043">=</span>&nbsp;<span class="ident" id="1922045">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1922060">mSpanInUse</span>&nbsp;<span class="op" id="1922071">=</span>&nbsp;<span class="ident" id="1922073">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1922087">concurrentSweep</span>&nbsp;<span class="op" id="1922103">=</span>&nbsp;<span class="ident" id="1922105">_ConcurrentSweep</span>&nbsp;<span class="op" id="1922122">!=</span>&nbsp;<span class="num" id="1922125">0</span><br>
<span class="lineno">35</span><span class="op" id="1922127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1922130">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1922166">type</span>&nbsp;<span class="ident" id="1922171">pageID</span>&nbsp;<span class="builtintype" id="1922178">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1922187">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1922230">var</span>&nbsp;<span class="ident" id="1922234">zerobase</span>&nbsp;<span class="builtintype" id="1922243">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1922252">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1922289">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1922355">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1922420">func</span>&nbsp;<span class="ident" id="1922425">mallocgc</span><span class="op" id="1922433">(</span><span class="ident" id="1922434">size</span>&nbsp;<span class="builtintype" id="1922439">uintptr</span><span class="op" id="1922446">,</span>&nbsp;<span class="ident" id="1922448">typ</span>&nbsp;<span class="op" id="1922452">*</span><span class="ident" id="1922453">_type</span><span class="op" id="1922458">,</span>&nbsp;<span class="ident" id="1922460">flags</span>&nbsp;<span class="builtintype" id="1922466">uint32</span><span class="op" id="1922472">)</span>&nbsp;<span class="ident" id="1922474">unsafe</span><span class="op" id="1922480">.</span><span class="ident" id="1922481">Pointer</span>&nbsp;<span class="op" id="1922489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1922492">if</span>&nbsp;<span class="ident" id="1922495">size</span>&nbsp;<span class="op" id="1922500">==</span>&nbsp;<span class="num" id="1922503">0</span>&nbsp;<span class="op" id="1922505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1922509">return</span>&nbsp;<span class="ident" id="1922516">unsafe</span><span class="op" id="1922522">.</span><span class="ident" id="1922523">Pointer</span><span class="op" id="1922530">(</span><span class="op" id="1922531">&amp;</span><span class="ident" id="1922532">zerobase</span><span class="op" id="1922540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1922543">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1922546">size0</span>&nbsp;<span class="op" id="1922552">:=</span>&nbsp;<span class="ident" id="1922555">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1922562">if</span>&nbsp;<span class="ident" id="1922565">flags</span><span class="op" id="1922570">&amp;</span><span class="ident" id="1922571">flagNoScan</span>&nbsp;<span class="op" id="1922582">==</span>&nbsp;<span class="num" id="1922585">0</span>&nbsp;<span class="op" id="1922587">&amp;&amp;</span>&nbsp;<span class="ident" id="1922590">typ</span>&nbsp;<span class="op" id="1922594">==</span>&nbsp;<span class="ident" id="1922597">nil</span>&nbsp;<span class="op" id="1922601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1922605">gothrow</span><span class="op" id="1922612">(</span><span class="string" id="1922613">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1922634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1922637">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1922641">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1922710">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1922784">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1922840">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1922916">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1922980">if</span>&nbsp;<span class="ident" id="1922983">debugMalloc</span>&nbsp;<span class="op" id="1922995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1922999">mp</span>&nbsp;<span class="op" id="1923002">:=</span>&nbsp;<span class="ident" id="1923005">acquirem</span><span class="op" id="1923013">(</span><span class="op" id="1923014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1923018">if</span>&nbsp;<span class="ident" id="1923021">mp</span><span class="op" id="1923023">.</span><span class="ident" id="1923024">mallocing</span>&nbsp;<span class="op" id="1923034">!=</span>&nbsp;<span class="num" id="1923037">0</span>&nbsp;<span class="op" id="1923039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1923044">gothrow</span><span class="op" id="1923051">(</span><span class="string" id="1923052">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1923069">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1923073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1923077">mp</span><span class="op" id="1923079">.</span><span class="ident" id="1923080">mallocing</span>&nbsp;<span class="op" id="1923090">=</span>&nbsp;<span class="num" id="1923092">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1923096">if</span>&nbsp;<span class="ident" id="1923099">mp</span><span class="op" id="1923101">.</span><span class="ident" id="1923102">curg</span>&nbsp;<span class="op" id="1923107">!=</span>&nbsp;<span class="ident" id="1923110">nil</span>&nbsp;<span class="op" id="1923114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1923119">mp</span><span class="op" id="1923121">.</span><span class="ident" id="1923122">curg</span><span class="op" id="1923126">.</span><span class="ident" id="1923127">stackguard0</span>&nbsp;<span class="op" id="1923139">=</span>&nbsp;<span class="op" id="1923141">^</span><span class="builtintype" id="1923142">uintptr</span><span class="op" id="1923149">(</span><span class="num" id="1923150">0xfff</span><span class="op" id="1923155">)</span>&nbsp;<span class="op" id="1923157">|</span>&nbsp;<span class="num" id="1923159">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1923167">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1923170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1923174">c</span>&nbsp;<span class="op" id="1923176">:=</span>&nbsp;<span class="ident" id="1923179">gomcache</span><span class="op" id="1923187">(</span><span class="op" id="1923188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1923191">var</span>&nbsp;<span class="ident" id="1923195">s</span>&nbsp;<span class="op" id="1923197">*</span><span class="ident" id="1923198">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1923205">var</span>&nbsp;<span class="ident" id="1923209">x</span>&nbsp;<span class="ident" id="1923211">unsafe</span><span class="op" id="1923217">.</span><span class="ident" id="1923218">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1923227">if</span>&nbsp;<span class="ident" id="1923230">size</span>&nbsp;<span class="op" id="1923235">&lt;=</span>&nbsp;<span class="ident" id="1923238">maxSmallSize</span>&nbsp;<span class="op" id="1923251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1923255">if</span>&nbsp;<span class="ident" id="1923258">flags</span><span class="op" id="1923263">&amp;</span><span class="ident" id="1923264">flagNoScan</span>&nbsp;<span class="op" id="1923275">!=</span>&nbsp;<span class="num" id="1923278">0</span>&nbsp;<span class="op" id="1923280">&amp;&amp;</span>&nbsp;<span class="ident" id="1923283">size</span>&nbsp;<span class="op" id="1923288">&lt;</span>&nbsp;<span class="ident" id="1923290">maxTinySize</span>&nbsp;<span class="op" id="1923302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923307">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923329">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923335">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923398">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923459">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923526">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923592">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923650">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923656">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923732">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923805">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923866">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923933">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1923968">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924026">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924071">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924131">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924137">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924210">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924275">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924306">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924312">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924381">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924449">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924492">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924498">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924561">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924618">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924680">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1924713">tinysize</span>&nbsp;<span class="op" id="1924722">:=</span>&nbsp;<span class="builtintype" id="1924725">uintptr</span><span class="op" id="1924732">(</span><span class="ident" id="1924733">c</span><span class="op" id="1924734">.</span><span class="ident" id="1924735">tinysize</span><span class="op" id="1924743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1924748">if</span>&nbsp;<span class="ident" id="1924751">size</span>&nbsp;<span class="op" id="1924756">&lt;=</span>&nbsp;<span class="ident" id="1924759">tinysize</span>&nbsp;<span class="op" id="1924768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1924774">tiny</span>&nbsp;<span class="op" id="1924779">:=</span>&nbsp;<span class="ident" id="1924782">unsafe</span><span class="op" id="1924788">.</span><span class="ident" id="1924789">Pointer</span><span class="op" id="1924796">(</span><span class="ident" id="1924797">c</span><span class="op" id="1924798">.</span><span class="ident" id="1924799">tiny</span><span class="op" id="1924803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1924809">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1924874">if</span>&nbsp;<span class="ident" id="1924877">size</span><span class="op" id="1924881">&amp;</span><span class="num" id="1924882">7</span>&nbsp;<span class="op" id="1924884">==</span>&nbsp;<span class="num" id="1924887">0</span>&nbsp;<span class="op" id="1924889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1924896">tiny</span>&nbsp;<span class="op" id="1924901">=</span>&nbsp;<span class="ident" id="1924903">roundup</span><span class="op" id="1924910">(</span><span class="ident" id="1924911">tiny</span><span class="op" id="1924915">,</span>&nbsp;<span class="num" id="1924917">8</span><span class="op" id="1924918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1924924">}</span>&nbsp;<span class="keyword" id="1924926">else</span>&nbsp;<span class="keyword" id="1924931">if</span>&nbsp;<span class="ident" id="1924934">size</span><span class="op" id="1924938">&amp;</span><span class="num" id="1924939">3</span>&nbsp;<span class="op" id="1924941">==</span>&nbsp;<span class="num" id="1924944">0</span>&nbsp;<span class="op" id="1924946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1924953">tiny</span>&nbsp;<span class="op" id="1924958">=</span>&nbsp;<span class="ident" id="1924960">roundup</span><span class="op" id="1924967">(</span><span class="ident" id="1924968">tiny</span><span class="op" id="1924972">,</span>&nbsp;<span class="num" id="1924974">4</span><span class="op" id="1924975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1924981">}</span>&nbsp;<span class="keyword" id="1924983">else</span>&nbsp;<span class="keyword" id="1924988">if</span>&nbsp;<span class="ident" id="1924991">size</span><span class="op" id="1924995">&amp;</span><span class="num" id="1924996">1</span>&nbsp;<span class="op" id="1924998">==</span>&nbsp;<span class="num" id="1925001">0</span>&nbsp;<span class="op" id="1925003">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925010">tiny</span>&nbsp;<span class="op" id="1925015">=</span>&nbsp;<span class="ident" id="1925017">roundup</span><span class="op" id="1925024">(</span><span class="ident" id="1925025">tiny</span><span class="op" id="1925029">,</span>&nbsp;<span class="num" id="1925031">2</span><span class="op" id="1925032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925044">size1</span>&nbsp;<span class="op" id="1925050">:=</span>&nbsp;<span class="ident" id="1925053">size</span>&nbsp;<span class="op" id="1925058">+</span>&nbsp;<span class="op" id="1925060">(</span><span class="builtintype" id="1925061">uintptr</span><span class="op" id="1925068">(</span><span class="ident" id="1925069">tiny</span><span class="op" id="1925073">)</span>&nbsp;<span class="op" id="1925075">-</span>&nbsp;<span class="builtintype" id="1925077">uintptr</span><span class="op" id="1925084">(</span><span class="ident" id="1925085">unsafe</span><span class="op" id="1925091">.</span><span class="ident" id="1925092">Pointer</span><span class="op" id="1925099">(</span><span class="ident" id="1925100">c</span><span class="op" id="1925101">.</span><span class="ident" id="1925102">tiny</span><span class="op" id="1925106">)</span><span class="op" id="1925107">)</span><span class="op" id="1925108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1925114">if</span>&nbsp;<span class="ident" id="1925117">size1</span>&nbsp;<span class="op" id="1925123">&lt;=</span>&nbsp;<span class="ident" id="1925126">tinysize</span>&nbsp;<span class="op" id="1925135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1925142">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925192">x</span>&nbsp;<span class="op" id="1925194">=</span>&nbsp;<span class="ident" id="1925196">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925206">c</span><span class="op" id="1925207">.</span><span class="ident" id="1925208">tiny</span>&nbsp;<span class="op" id="1925213">=</span>&nbsp;<span class="op" id="1925215">(</span><span class="op" id="1925216">*</span><span class="builtintype" id="1925217">byte</span><span class="op" id="1925221">)</span><span class="op" id="1925222">(</span><span class="ident" id="1925223">add</span><span class="op" id="1925226">(</span><span class="ident" id="1925227">x</span><span class="op" id="1925228">,</span>&nbsp;<span class="ident" id="1925230">size</span><span class="op" id="1925234">)</span><span class="op" id="1925235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925242">c</span><span class="op" id="1925243">.</span><span class="ident" id="1925244">tinysize</span>&nbsp;<span class="op" id="1925253">-=</span>&nbsp;<span class="builtintype" id="1925256">uintptr</span><span class="op" id="1925263">(</span><span class="ident" id="1925264">size1</span><span class="op" id="1925269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925276">c</span><span class="op" id="1925277">.</span><span class="ident" id="1925278">local_tinyallocs</span><span class="op" id="1925294">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1925302">if</span>&nbsp;<span class="ident" id="1925305">debugMalloc</span>&nbsp;<span class="op" id="1925317">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925325">mp</span>&nbsp;<span class="op" id="1925328">:=</span>&nbsp;<span class="ident" id="1925331">acquirem</span><span class="op" id="1925339">(</span><span class="op" id="1925340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1925348">if</span>&nbsp;<span class="ident" id="1925351">mp</span><span class="op" id="1925353">.</span><span class="ident" id="1925354">mallocing</span>&nbsp;<span class="op" id="1925364">==</span>&nbsp;<span class="num" id="1925367">0</span>&nbsp;<span class="op" id="1925369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925378">gothrow</span><span class="op" id="1925385">(</span><span class="string" id="1925386">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1925398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925414">mp</span><span class="op" id="1925416">.</span><span class="ident" id="1925417">mallocing</span>&nbsp;<span class="op" id="1925427">=</span>&nbsp;<span class="num" id="1925429">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1925437">if</span>&nbsp;<span class="ident" id="1925440">mp</span><span class="op" id="1925442">.</span><span class="ident" id="1925443">curg</span>&nbsp;<span class="op" id="1925448">!=</span>&nbsp;<span class="ident" id="1925451">nil</span>&nbsp;<span class="op" id="1925455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925464">mp</span><span class="op" id="1925466">.</span><span class="ident" id="1925467">curg</span><span class="op" id="1925471">.</span><span class="ident" id="1925472">stackguard0</span>&nbsp;<span class="op" id="1925484">=</span>&nbsp;<span class="ident" id="1925486">mp</span><span class="op" id="1925488">.</span><span class="ident" id="1925489">curg</span><span class="op" id="1925493">.</span><span class="ident" id="1925494">stack</span><span class="op" id="1925499">.</span><span class="ident" id="1925500">lo</span>&nbsp;<span class="op" id="1925503">+</span>&nbsp;<span class="ident" id="1925505">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1925531">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1925588">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925644">releasem</span><span class="op" id="1925652">(</span><span class="ident" id="1925653">mp</span><span class="op" id="1925655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925663">releasem</span><span class="op" id="1925671">(</span><span class="ident" id="1925672">mp</span><span class="op" id="1925674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1925688">return</span>&nbsp;<span class="ident" id="1925695">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925701">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1925711">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925751">s</span>&nbsp;<span class="op" id="1925753">=</span>&nbsp;<span class="ident" id="1925755">c</span><span class="op" id="1925756">.</span><span class="ident" id="1925757">alloc</span><span class="op" id="1925762">[</span><span class="ident" id="1925763">tinySizeClass</span><span class="op" id="1925776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925781">v</span>&nbsp;<span class="op" id="1925783">:=</span>&nbsp;<span class="ident" id="1925786">s</span><span class="op" id="1925787">.</span><span class="ident" id="1925788">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1925800">if</span>&nbsp;<span class="ident" id="1925803">v</span>&nbsp;<span class="op" id="1925805">==</span>&nbsp;<span class="ident" id="1925808">nil</span>&nbsp;<span class="op" id="1925812">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925818">mp</span>&nbsp;<span class="op" id="1925821">:=</span>&nbsp;<span class="ident" id="1925824">acquirem</span><span class="op" id="1925832">(</span><span class="op" id="1925833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925839">mp</span><span class="op" id="1925841">.</span><span class="ident" id="1925842">scalararg</span><span class="op" id="1925851">[</span><span class="num" id="1925852">0</span><span class="op" id="1925853">]</span>&nbsp;<span class="op" id="1925855">=</span>&nbsp;<span class="ident" id="1925857">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925875">onM</span><span class="op" id="1925878">(</span><span class="ident" id="1925879">mcacheRefill_m</span><span class="op" id="1925893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925899">releasem</span><span class="op" id="1925907">(</span><span class="ident" id="1925908">mp</span><span class="op" id="1925910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925916">s</span>&nbsp;<span class="op" id="1925918">=</span>&nbsp;<span class="ident" id="1925920">c</span><span class="op" id="1925921">.</span><span class="ident" id="1925922">alloc</span><span class="op" id="1925927">[</span><span class="ident" id="1925928">tinySizeClass</span><span class="op" id="1925941">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925947">v</span>&nbsp;<span class="op" id="1925949">=</span>&nbsp;<span class="ident" id="1925951">s</span><span class="op" id="1925952">.</span><span class="ident" id="1925953">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1925965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925970">s</span><span class="op" id="1925971">.</span><span class="ident" id="1925972">freelist</span>&nbsp;<span class="op" id="1925981">=</span>&nbsp;<span class="ident" id="1925983">v</span><span class="op" id="1925984">.</span><span class="ident" id="1925985">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1925993">s</span><span class="op" id="1925994">.</span><span class="ident" id="1925995">ref</span><span class="op" id="1925998">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1926004">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926031">x</span>&nbsp;<span class="op" id="1926033">=</span>&nbsp;<span class="ident" id="1926035">unsafe</span><span class="op" id="1926041">.</span><span class="ident" id="1926042">Pointer</span><span class="op" id="1926049">(</span><span class="ident" id="1926050">v</span><span class="op" id="1926051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926056">(</span><span class="op" id="1926057">*</span><span class="op" id="1926058">[</span><span class="num" id="1926059">2</span><span class="op" id="1926060">]</span><span class="ident" id="1926061">uint64</span><span class="op" id="1926067">)</span><span class="op" id="1926068">(</span><span class="ident" id="1926069">x</span><span class="op" id="1926070">)</span><span class="op" id="1926071">[</span><span class="num" id="1926072">0</span><span class="op" id="1926073">]</span>&nbsp;<span class="op" id="1926075">=</span>&nbsp;<span class="num" id="1926077">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926082">(</span><span class="op" id="1926083">*</span><span class="op" id="1926084">[</span><span class="num" id="1926085">2</span><span class="op" id="1926086">]</span><span class="ident" id="1926087">uint64</span><span class="op" id="1926093">)</span><span class="op" id="1926094">(</span><span class="ident" id="1926095">x</span><span class="op" id="1926096">)</span><span class="op" id="1926097">[</span><span class="num" id="1926098">1</span><span class="op" id="1926099">]</span>&nbsp;<span class="op" id="1926101">=</span>&nbsp;<span class="num" id="1926103">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1926108">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1926181">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1926228">if</span>&nbsp;<span class="ident" id="1926231">maxTinySize</span><span class="op" id="1926242">-</span><span class="ident" id="1926243">size</span>&nbsp;<span class="op" id="1926248">&gt;</span>&nbsp;<span class="ident" id="1926250">tinysize</span>&nbsp;<span class="op" id="1926259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926265">c</span><span class="op" id="1926266">.</span><span class="ident" id="1926267">tiny</span>&nbsp;<span class="op" id="1926272">=</span>&nbsp;<span class="op" id="1926274">(</span><span class="op" id="1926275">*</span><span class="builtintype" id="1926276">byte</span><span class="op" id="1926280">)</span><span class="op" id="1926281">(</span><span class="ident" id="1926282">add</span><span class="op" id="1926285">(</span><span class="ident" id="1926286">x</span><span class="op" id="1926287">,</span>&nbsp;<span class="ident" id="1926289">size</span><span class="op" id="1926293">)</span><span class="op" id="1926294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926300">c</span><span class="op" id="1926301">.</span><span class="ident" id="1926302">tinysize</span>&nbsp;<span class="op" id="1926311">=</span>&nbsp;<span class="builtintype" id="1926313">uintptr</span><span class="op" id="1926320">(</span><span class="ident" id="1926321">maxTinySize</span>&nbsp;<span class="op" id="1926333">-</span>&nbsp;<span class="ident" id="1926335">size</span><span class="op" id="1926339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926349">size</span>&nbsp;<span class="op" id="1926354">=</span>&nbsp;<span class="ident" id="1926356">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926370">}</span>&nbsp;<span class="keyword" id="1926372">else</span>&nbsp;<span class="op" id="1926377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1926382">var</span>&nbsp;<span class="ident" id="1926386">sizeclass</span>&nbsp;<span class="builtintype" id="1926396">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1926404">if</span>&nbsp;<span class="ident" id="1926407">size</span>&nbsp;<span class="op" id="1926412">&lt;=</span>&nbsp;<span class="num" id="1926415">1024</span><span class="op" id="1926419">-</span><span class="num" id="1926420">8</span>&nbsp;<span class="op" id="1926422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926428">sizeclass</span>&nbsp;<span class="op" id="1926438">=</span>&nbsp;<span class="ident" id="1926440">size_to_class8</span><span class="op" id="1926454">[</span><span class="op" id="1926455">(</span><span class="ident" id="1926456">size</span><span class="op" id="1926460">+</span><span class="num" id="1926461">7</span><span class="op" id="1926462">)</span><span class="op" id="1926463">&gt;&gt;</span><span class="num" id="1926465">3</span><span class="op" id="1926466">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926471">}</span>&nbsp;<span class="keyword" id="1926473">else</span>&nbsp;<span class="op" id="1926478">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926484">sizeclass</span>&nbsp;<span class="op" id="1926494">=</span>&nbsp;<span class="ident" id="1926496">size_to_class128</span><span class="op" id="1926512">[</span><span class="op" id="1926513">(</span><span class="ident" id="1926514">size</span><span class="op" id="1926518">-</span><span class="num" id="1926519">1024</span><span class="op" id="1926523">+</span><span class="num" id="1926524">127</span><span class="op" id="1926527">)</span><span class="op" id="1926528">&gt;&gt;</span><span class="num" id="1926530">7</span><span class="op" id="1926531">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926541">size</span>&nbsp;<span class="op" id="1926546">=</span>&nbsp;<span class="builtintype" id="1926548">uintptr</span><span class="op" id="1926555">(</span><span class="ident" id="1926556">class_to_size</span><span class="op" id="1926569">[</span><span class="ident" id="1926570">sizeclass</span><span class="op" id="1926579">]</span><span class="op" id="1926580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926585">s</span>&nbsp;<span class="op" id="1926587">=</span>&nbsp;<span class="ident" id="1926589">c</span><span class="op" id="1926590">.</span><span class="ident" id="1926591">alloc</span><span class="op" id="1926596">[</span><span class="ident" id="1926597">sizeclass</span><span class="op" id="1926606">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926611">v</span>&nbsp;<span class="op" id="1926613">:=</span>&nbsp;<span class="ident" id="1926616">s</span><span class="op" id="1926617">.</span><span class="ident" id="1926618">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1926630">if</span>&nbsp;<span class="ident" id="1926633">v</span>&nbsp;<span class="op" id="1926635">==</span>&nbsp;<span class="ident" id="1926638">nil</span>&nbsp;<span class="op" id="1926642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926648">mp</span>&nbsp;<span class="op" id="1926651">:=</span>&nbsp;<span class="ident" id="1926654">acquirem</span><span class="op" id="1926662">(</span><span class="op" id="1926663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926669">mp</span><span class="op" id="1926671">.</span><span class="ident" id="1926672">scalararg</span><span class="op" id="1926681">[</span><span class="num" id="1926682">0</span><span class="op" id="1926683">]</span>&nbsp;<span class="op" id="1926685">=</span>&nbsp;<span class="builtintype" id="1926687">uintptr</span><span class="op" id="1926694">(</span><span class="ident" id="1926695">sizeclass</span><span class="op" id="1926704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926710">onM</span><span class="op" id="1926713">(</span><span class="ident" id="1926714">mcacheRefill_m</span><span class="op" id="1926728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926734">releasem</span><span class="op" id="1926742">(</span><span class="ident" id="1926743">mp</span><span class="op" id="1926745">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926751">s</span>&nbsp;<span class="op" id="1926753">=</span>&nbsp;<span class="ident" id="1926755">c</span><span class="op" id="1926756">.</span><span class="ident" id="1926757">alloc</span><span class="op" id="1926762">[</span><span class="ident" id="1926763">sizeclass</span><span class="op" id="1926772">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926778">v</span>&nbsp;<span class="op" id="1926780">=</span>&nbsp;<span class="ident" id="1926782">s</span><span class="op" id="1926783">.</span><span class="ident" id="1926784">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1926796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926801">s</span><span class="op" id="1926802">.</span><span class="ident" id="1926803">freelist</span>&nbsp;<span class="op" id="1926812">=</span>&nbsp;<span class="ident" id="1926814">v</span><span class="op" id="1926815">.</span><span class="ident" id="1926816">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926824">s</span><span class="op" id="1926825">.</span><span class="ident" id="1926826">ref</span><span class="op" id="1926829">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1926835">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926855">x</span>&nbsp;<span class="op" id="1926857">=</span>&nbsp;<span class="ident" id="1926859">unsafe</span><span class="op" id="1926865">.</span><span class="ident" id="1926866">Pointer</span><span class="op" id="1926873">(</span><span class="ident" id="1926874">v</span><span class="op" id="1926875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1926880">if</span>&nbsp;<span class="ident" id="1926883">flags</span><span class="op" id="1926888">&amp;</span><span class="ident" id="1926889">flagNoZero</span>&nbsp;<span class="op" id="1926900">==</span>&nbsp;<span class="num" id="1926903">0</span>&nbsp;<span class="op" id="1926905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926911">v</span><span class="op" id="1926912">.</span><span class="ident" id="1926913">next</span>&nbsp;<span class="op" id="1926918">=</span>&nbsp;<span class="ident" id="1926920">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1926928">if</span>&nbsp;<span class="ident" id="1926931">size</span>&nbsp;<span class="op" id="1926936">&gt;</span>&nbsp;<span class="num" id="1926938">2</span><span class="op" id="1926939">*</span><span class="ident" id="1926940">ptrSize</span>&nbsp;<span class="op" id="1926948">&amp;&amp;</span>&nbsp;<span class="op" id="1926951">(</span><span class="op" id="1926952">(</span><span class="op" id="1926953">*</span><span class="op" id="1926954">[</span><span class="num" id="1926955">2</span><span class="op" id="1926956">]</span><span class="builtintype" id="1926957">uintptr</span><span class="op" id="1926964">)</span><span class="op" id="1926965">(</span><span class="ident" id="1926966">x</span><span class="op" id="1926967">)</span><span class="op" id="1926968">)</span><span class="op" id="1926969">[</span><span class="num" id="1926970">1</span><span class="op" id="1926971">]</span>&nbsp;<span class="op" id="1926973">!=</span>&nbsp;<span class="num" id="1926976">0</span>&nbsp;<span class="op" id="1926978">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1926985">memclr</span><span class="op" id="1926991">(</span><span class="ident" id="1926992">unsafe</span><span class="op" id="1926998">.</span><span class="ident" id="1926999">Pointer</span><span class="op" id="1927006">(</span><span class="ident" id="1927007">v</span><span class="op" id="1927008">)</span><span class="op" id="1927009">,</span>&nbsp;<span class="ident" id="1927011">size</span><span class="op" id="1927015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927034">c</span><span class="op" id="1927035">.</span><span class="ident" id="1927036">local_cachealloc</span>&nbsp;<span class="op" id="1927053">+=</span>&nbsp;<span class="ident" id="1927056">intptr</span><span class="op" id="1927062">(</span><span class="ident" id="1927063">size</span><span class="op" id="1927067">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927070">}</span>&nbsp;<span class="keyword" id="1927072">else</span>&nbsp;<span class="op" id="1927077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927081">mp</span>&nbsp;<span class="op" id="1927084">:=</span>&nbsp;<span class="ident" id="1927087">acquirem</span><span class="op" id="1927095">(</span><span class="op" id="1927096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927100">mp</span><span class="op" id="1927102">.</span><span class="ident" id="1927103">scalararg</span><span class="op" id="1927112">[</span><span class="num" id="1927113">0</span><span class="op" id="1927114">]</span>&nbsp;<span class="op" id="1927116">=</span>&nbsp;<span class="builtintype" id="1927118">uintptr</span><span class="op" id="1927125">(</span><span class="ident" id="1927126">size</span><span class="op" id="1927130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927134">mp</span><span class="op" id="1927136">.</span><span class="ident" id="1927137">scalararg</span><span class="op" id="1927146">[</span><span class="num" id="1927147">1</span><span class="op" id="1927148">]</span>&nbsp;<span class="op" id="1927150">=</span>&nbsp;<span class="builtintype" id="1927152">uintptr</span><span class="op" id="1927159">(</span><span class="ident" id="1927160">flags</span><span class="op" id="1927165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927169">onM</span><span class="op" id="1927172">(</span><span class="ident" id="1927173">largeAlloc_m</span><span class="op" id="1927185">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927189">s</span>&nbsp;<span class="op" id="1927191">=</span>&nbsp;<span class="op" id="1927193">(</span><span class="op" id="1927194">*</span><span class="ident" id="1927195">mspan</span><span class="op" id="1927200">)</span><span class="op" id="1927201">(</span><span class="ident" id="1927202">mp</span><span class="op" id="1927204">.</span><span class="ident" id="1927205">ptrarg</span><span class="op" id="1927211">[</span><span class="num" id="1927212">0</span><span class="op" id="1927213">]</span><span class="op" id="1927214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927218">mp</span><span class="op" id="1927220">.</span><span class="ident" id="1927221">ptrarg</span><span class="op" id="1927227">[</span><span class="num" id="1927228">0</span><span class="op" id="1927229">]</span>&nbsp;<span class="op" id="1927231">=</span>&nbsp;<span class="ident" id="1927233">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927239">releasem</span><span class="op" id="1927247">(</span><span class="ident" id="1927248">mp</span><span class="op" id="1927250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927254">x</span>&nbsp;<span class="op" id="1927256">=</span>&nbsp;<span class="ident" id="1927258">unsafe</span><span class="op" id="1927264">.</span><span class="ident" id="1927265">Pointer</span><span class="op" id="1927272">(</span><span class="builtintype" id="1927273">uintptr</span><span class="op" id="1927280">(</span><span class="ident" id="1927281">s</span><span class="op" id="1927282">.</span><span class="ident" id="1927283">start</span>&nbsp;<span class="op" id="1927289">&lt;&lt;</span>&nbsp;<span class="ident" id="1927292">pageShift</span><span class="op" id="1927301">)</span><span class="op" id="1927302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927306">size</span>&nbsp;<span class="op" id="1927311">=</span>&nbsp;<span class="builtintype" id="1927313">uintptr</span><span class="op" id="1927320">(</span><span class="ident" id="1927321">s</span><span class="op" id="1927322">.</span><span class="ident" id="1927323">elemsize</span><span class="op" id="1927331">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1927338">if</span>&nbsp;<span class="ident" id="1927341">flags</span><span class="op" id="1927346">&amp;</span><span class="ident" id="1927347">flagNoScan</span>&nbsp;<span class="op" id="1927358">!=</span>&nbsp;<span class="num" id="1927361">0</span>&nbsp;<span class="op" id="1927363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927367">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1927410">goto</span>&nbsp;<span class="ident" id="1927415">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927427">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927500">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927570">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927645">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927720">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927765">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1927823">if</span>&nbsp;<span class="ident" id="1927826">typ</span>&nbsp;<span class="op" id="1927830">==</span>&nbsp;<span class="ident" id="1927833">deferType</span>&nbsp;<span class="op" id="1927843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927847">size0</span>&nbsp;<span class="op" id="1927853">=</span>&nbsp;<span class="ident" id="1927855">unsafe</span><span class="op" id="1927861">.</span><span class="ident" id="1927862">Sizeof</span><span class="op" id="1927868">(</span><span class="ident" id="1927869">_defer</span><span class="op" id="1927875">{</span><span class="op" id="1927876">}</span><span class="op" id="1927877">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927884">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1927948">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1927992">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1927996">arena_start</span>&nbsp;<span class="op" id="1928008">:=</span>&nbsp;<span class="builtintype" id="1928011">uintptr</span><span class="op" id="1928018">(</span><span class="ident" id="1928019">unsafe</span><span class="op" id="1928025">.</span><span class="ident" id="1928026">Pointer</span><span class="op" id="1928033">(</span><span class="ident" id="1928034">mheap_</span><span class="op" id="1928040">.</span><span class="ident" id="1928041">arena_start</span><span class="op" id="1928052">)</span><span class="op" id="1928053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928057">off</span>&nbsp;<span class="op" id="1928061">:=</span>&nbsp;<span class="op" id="1928064">(</span><span class="builtintype" id="1928065">uintptr</span><span class="op" id="1928072">(</span><span class="ident" id="1928073">x</span><span class="op" id="1928074">)</span>&nbsp;<span class="op" id="1928076">-</span>&nbsp;<span class="ident" id="1928078">arena_start</span><span class="op" id="1928089">)</span>&nbsp;<span class="op" id="1928091">/</span>&nbsp;<span class="ident" id="1928093">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928103">xbits</span>&nbsp;<span class="op" id="1928109">:=</span>&nbsp;<span class="op" id="1928112">(</span><span class="op" id="1928113">*</span><span class="builtintype" id="1928114">uint8</span><span class="op" id="1928119">)</span><span class="op" id="1928120">(</span><span class="ident" id="1928121">unsafe</span><span class="op" id="1928127">.</span><span class="ident" id="1928128">Pointer</span><span class="op" id="1928135">(</span><span class="ident" id="1928136">arena_start</span>&nbsp;<span class="op" id="1928148">-</span>&nbsp;<span class="ident" id="1928150">off</span><span class="op" id="1928153">/</span><span class="ident" id="1928154">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1928173">-</span>&nbsp;<span class="num" id="1928175">1</span><span class="op" id="1928176">)</span><span class="op" id="1928177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928181">shift</span>&nbsp;<span class="op" id="1928187">:=</span>&nbsp;<span class="op" id="1928190">(</span><span class="ident" id="1928191">off</span>&nbsp;<span class="op" id="1928195">%</span>&nbsp;<span class="ident" id="1928197">wordsPerBitmapByte</span><span class="op" id="1928215">)</span>&nbsp;<span class="op" id="1928217">*</span>&nbsp;<span class="ident" id="1928219">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928228">if</span>&nbsp;<span class="ident" id="1928231">debugMalloc</span>&nbsp;<span class="op" id="1928243">&amp;&amp;</span>&nbsp;<span class="op" id="1928246">(</span><span class="op" id="1928247">(</span><span class="op" id="1928248">*</span><span class="ident" id="1928249">xbits</span><span class="op" id="1928254">&gt;&gt;</span><span class="ident" id="1928256">shift</span><span class="op" id="1928261">)</span><span class="op" id="1928262">&amp;</span><span class="op" id="1928263">(</span><span class="ident" id="1928264">bitMask</span><span class="op" id="1928271">|</span><span class="ident" id="1928272">bitPtrMask</span><span class="op" id="1928282">)</span><span class="op" id="1928283">)</span>&nbsp;<span class="op" id="1928285">!=</span>&nbsp;<span class="ident" id="1928288">bitBoundary</span>&nbsp;<span class="op" id="1928300">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1928305">println</span><span class="op" id="1928312">(</span><span class="string" id="1928313">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1928330">,</span>&nbsp;<span class="op" id="1928332">(</span><span class="op" id="1928333">*</span><span class="ident" id="1928334">xbits</span><span class="op" id="1928339">&gt;&gt;</span><span class="ident" id="1928341">shift</span><span class="op" id="1928346">)</span><span class="op" id="1928347">&amp;</span><span class="op" id="1928348">(</span><span class="ident" id="1928349">bitMask</span><span class="op" id="1928356">|</span><span class="ident" id="1928357">bitPtrMask</span><span class="op" id="1928367">)</span><span class="op" id="1928368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928373">gothrow</span><span class="op" id="1928380">(</span><span class="string" id="1928381">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1928408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1928412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928417">var</span>&nbsp;<span class="ident" id="1928421">ti</span><span class="op" id="1928423">,</span>&nbsp;<span class="ident" id="1928425">te</span>&nbsp;<span class="builtintype" id="1928428">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928438">var</span>&nbsp;<span class="ident" id="1928442">ptrmask</span>&nbsp;<span class="op" id="1928450">*</span><span class="builtintype" id="1928451">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928459">if</span>&nbsp;<span class="ident" id="1928462">size</span>&nbsp;<span class="op" id="1928467">==</span>&nbsp;<span class="ident" id="1928470">ptrSize</span>&nbsp;<span class="op" id="1928478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1928483">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1928546">*</span><span class="ident" id="1928547">xbits</span>&nbsp;<span class="op" id="1928553">|=</span>&nbsp;<span class="op" id="1928556">(</span><span class="ident" id="1928557">bitsPointer</span>&nbsp;<span class="op" id="1928569">&lt;&lt;</span>&nbsp;<span class="num" id="1928572">2</span><span class="op" id="1928573">)</span>&nbsp;<span class="op" id="1928575">&lt;&lt;</span>&nbsp;<span class="ident" id="1928578">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928587">goto</span>&nbsp;<span class="ident" id="1928592">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1928601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928605">if</span>&nbsp;<span class="ident" id="1928608">typ</span><span class="op" id="1928611">.</span><span class="ident" id="1928612">kind</span><span class="op" id="1928616">&amp;</span><span class="ident" id="1928617">kindGCProg</span>&nbsp;<span class="op" id="1928628">!=</span>&nbsp;<span class="num" id="1928631">0</span>&nbsp;<span class="op" id="1928633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928638">nptr</span>&nbsp;<span class="op" id="1928643">:=</span>&nbsp;<span class="op" id="1928646">(</span><span class="builtintype" id="1928647">uintptr</span><span class="op" id="1928654">(</span><span class="ident" id="1928655">typ</span><span class="op" id="1928658">.</span><span class="ident" id="1928659">size</span><span class="op" id="1928663">)</span>&nbsp;<span class="op" id="1928665">+</span>&nbsp;<span class="ident" id="1928667">ptrSize</span>&nbsp;<span class="op" id="1928675">-</span>&nbsp;<span class="num" id="1928677">1</span><span class="op" id="1928678">)</span>&nbsp;<span class="op" id="1928680">/</span>&nbsp;<span class="ident" id="1928682">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928693">masksize</span>&nbsp;<span class="op" id="1928702">:=</span>&nbsp;<span class="ident" id="1928705">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928713">if</span>&nbsp;<span class="ident" id="1928716">masksize</span><span class="op" id="1928724">%</span><span class="num" id="1928725">2</span>&nbsp;<span class="op" id="1928727">!=</span>&nbsp;<span class="num" id="1928730">0</span>&nbsp;<span class="op" id="1928732">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928738">masksize</span>&nbsp;<span class="op" id="1928747">*=</span>&nbsp;<span class="num" id="1928750">2</span>&nbsp;<span class="comment" id="1928752">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1928767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928772">masksize</span>&nbsp;<span class="op" id="1928781">=</span>&nbsp;<span class="ident" id="1928783">masksize</span>&nbsp;<span class="op" id="1928792">*</span>&nbsp;<span class="ident" id="1928794">pointersPerByte</span>&nbsp;<span class="op" id="1928810">/</span>&nbsp;<span class="num" id="1928812">8</span>&nbsp;<span class="comment" id="1928814">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1928836">masksize</span><span class="op" id="1928844">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1928878">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1928913">if</span>&nbsp;<span class="ident" id="1928916">masksize</span>&nbsp;<span class="op" id="1928925">&gt;</span>&nbsp;<span class="ident" id="1928927">maxGCMask</span>&nbsp;<span class="op" id="1928937">&amp;&amp;</span>&nbsp;<span class="ident" id="1928940">typ</span><span class="op" id="1928943">.</span><span class="ident" id="1928944">gc</span><span class="op" id="1928946">[</span><span class="num" id="1928947">1</span><span class="op" id="1928948">]</span>&nbsp;<span class="op" id="1928950">!=</span>&nbsp;<span class="num" id="1928953">0</span>&nbsp;<span class="op" id="1928955">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1928961">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1929022">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1929082">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1929145">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929173">mp</span>&nbsp;<span class="op" id="1929176">:=</span>&nbsp;<span class="ident" id="1929179">acquirem</span><span class="op" id="1929187">(</span><span class="op" id="1929188">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929194">mp</span><span class="op" id="1929196">.</span><span class="ident" id="1929197">ptrarg</span><span class="op" id="1929203">[</span><span class="num" id="1929204">0</span><span class="op" id="1929205">]</span>&nbsp;<span class="op" id="1929207">=</span>&nbsp;<span class="ident" id="1929209">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929215">mp</span><span class="op" id="1929217">.</span><span class="ident" id="1929218">ptrarg</span><span class="op" id="1929224">[</span><span class="num" id="1929225">1</span><span class="op" id="1929226">]</span>&nbsp;<span class="op" id="1929228">=</span>&nbsp;<span class="ident" id="1929230">unsafe</span><span class="op" id="1929236">.</span><span class="ident" id="1929237">Pointer</span><span class="op" id="1929244">(</span><span class="ident" id="1929245">typ</span><span class="op" id="1929248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929254">mp</span><span class="op" id="1929256">.</span><span class="ident" id="1929257">scalararg</span><span class="op" id="1929266">[</span><span class="num" id="1929267">0</span><span class="op" id="1929268">]</span>&nbsp;<span class="op" id="1929270">=</span>&nbsp;<span class="builtintype" id="1929272">uintptr</span><span class="op" id="1929279">(</span><span class="ident" id="1929280">size</span><span class="op" id="1929284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929290">mp</span><span class="op" id="1929292">.</span><span class="ident" id="1929293">scalararg</span><span class="op" id="1929302">[</span><span class="num" id="1929303">1</span><span class="op" id="1929304">]</span>&nbsp;<span class="op" id="1929306">=</span>&nbsp;<span class="builtintype" id="1929308">uintptr</span><span class="op" id="1929315">(</span><span class="ident" id="1929316">size0</span><span class="op" id="1929321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929327">onM</span><span class="op" id="1929330">(</span><span class="ident" id="1929331">unrollgcproginplace_m</span><span class="op" id="1929352">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929358">releasem</span><span class="op" id="1929366">(</span><span class="ident" id="1929367">mp</span><span class="op" id="1929369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1929375">goto</span>&nbsp;<span class="ident" id="1929380">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1929390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929395">ptrmask</span>&nbsp;<span class="op" id="1929403">=</span>&nbsp;<span class="op" id="1929405">(</span><span class="op" id="1929406">*</span><span class="builtintype" id="1929407">uint8</span><span class="op" id="1929412">)</span><span class="op" id="1929413">(</span><span class="ident" id="1929414">unsafe</span><span class="op" id="1929420">.</span><span class="ident" id="1929421">Pointer</span><span class="op" id="1929428">(</span><span class="builtintype" id="1929429">uintptr</span><span class="op" id="1929436">(</span><span class="ident" id="1929437">typ</span><span class="op" id="1929440">.</span><span class="ident" id="1929441">gc</span><span class="op" id="1929443">[</span><span class="num" id="1929444">0</span><span class="op" id="1929445">]</span><span class="op" id="1929446">)</span><span class="op" id="1929447">)</span><span class="op" id="1929448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1929453">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1929506">if</span>&nbsp;<span class="builtintype" id="1929509">uintptr</span><span class="op" id="1929516">(</span><span class="ident" id="1929517">atomicloadp</span><span class="op" id="1929528">(</span><span class="ident" id="1929529">unsafe</span><span class="op" id="1929535">.</span><span class="ident" id="1929536">Pointer</span><span class="op" id="1929543">(</span><span class="ident" id="1929544">ptrmask</span><span class="op" id="1929551">)</span><span class="op" id="1929552">)</span><span class="op" id="1929553">)</span><span class="op" id="1929554">&amp;</span><span class="num" id="1929555">0xff</span>&nbsp;<span class="op" id="1929560">==</span>&nbsp;<span class="num" id="1929563">0</span>&nbsp;<span class="op" id="1929565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929571">mp</span>&nbsp;<span class="op" id="1929574">:=</span>&nbsp;<span class="ident" id="1929577">acquirem</span><span class="op" id="1929585">(</span><span class="op" id="1929586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929592">mp</span><span class="op" id="1929594">.</span><span class="ident" id="1929595">ptrarg</span><span class="op" id="1929601">[</span><span class="num" id="1929602">0</span><span class="op" id="1929603">]</span>&nbsp;<span class="op" id="1929605">=</span>&nbsp;<span class="ident" id="1929607">unsafe</span><span class="op" id="1929613">.</span><span class="ident" id="1929614">Pointer</span><span class="op" id="1929621">(</span><span class="ident" id="1929622">typ</span><span class="op" id="1929625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929631">onM</span><span class="op" id="1929634">(</span><span class="ident" id="1929635">unrollgcprog_m</span><span class="op" id="1929649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929655">releasem</span><span class="op" id="1929663">(</span><span class="ident" id="1929664">mp</span><span class="op" id="1929666">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1929671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929676">ptrmask</span>&nbsp;<span class="op" id="1929684">=</span>&nbsp;<span class="op" id="1929686">(</span><span class="op" id="1929687">*</span><span class="builtintype" id="1929688">uint8</span><span class="op" id="1929693">)</span><span class="op" id="1929694">(</span><span class="ident" id="1929695">add</span><span class="op" id="1929698">(</span><span class="ident" id="1929699">unsafe</span><span class="op" id="1929705">.</span><span class="ident" id="1929706">Pointer</span><span class="op" id="1929713">(</span><span class="ident" id="1929714">ptrmask</span><span class="op" id="1929721">)</span><span class="op" id="1929722">,</span>&nbsp;<span class="num" id="1929724">1</span><span class="op" id="1929725">)</span><span class="op" id="1929726">)</span>&nbsp;<span class="comment" id="1929728">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1929759">}</span>&nbsp;<span class="keyword" id="1929761">else</span>&nbsp;<span class="op" id="1929766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929771">ptrmask</span>&nbsp;<span class="op" id="1929779">=</span>&nbsp;<span class="op" id="1929781">(</span><span class="op" id="1929782">*</span><span class="builtintype" id="1929783">uint8</span><span class="op" id="1929788">)</span><span class="op" id="1929789">(</span><span class="ident" id="1929790">unsafe</span><span class="op" id="1929796">.</span><span class="ident" id="1929797">Pointer</span><span class="op" id="1929804">(</span><span class="ident" id="1929805">typ</span><span class="op" id="1929808">.</span><span class="ident" id="1929809">gc</span><span class="op" id="1929811">[</span><span class="num" id="1929812">0</span><span class="op" id="1929813">]</span><span class="op" id="1929814">)</span><span class="op" id="1929815">)</span>&nbsp;<span class="comment" id="1929817">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1929847">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1929851">if</span>&nbsp;<span class="ident" id="1929854">size</span>&nbsp;<span class="op" id="1929859">==</span>&nbsp;<span class="num" id="1929862">2</span><span class="op" id="1929863">*</span><span class="ident" id="1929864">ptrSize</span>&nbsp;<span class="op" id="1929872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1929877">*</span><span class="ident" id="1929878">xbits</span>&nbsp;<span class="op" id="1929884">=</span>&nbsp;<span class="op" id="1929886">*</span><span class="ident" id="1929887">ptrmask</span>&nbsp;<span class="op" id="1929895">|</span>&nbsp;<span class="ident" id="1929897">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1929912">goto</span>&nbsp;<span class="ident" id="1929917">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1929926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1929930">te</span>&nbsp;<span class="op" id="1929933">=</span>&nbsp;<span class="builtintype" id="1929935">uintptr</span><span class="op" id="1929942">(</span><span class="ident" id="1929943">typ</span><span class="op" id="1929946">.</span><span class="ident" id="1929947">size</span><span class="op" id="1929951">)</span>&nbsp;<span class="op" id="1929953">/</span>&nbsp;<span class="ident" id="1929955">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1929965">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930034">if</span>&nbsp;<span class="ident" id="1930037">te</span><span class="op" id="1930039">%</span><span class="num" id="1930040">2</span>&nbsp;<span class="op" id="1930042">==</span>&nbsp;<span class="num" id="1930045">0</span>&nbsp;<span class="op" id="1930047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930052">te</span>&nbsp;<span class="op" id="1930055">/=</span>&nbsp;<span class="num" id="1930058">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1930066">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930109">for</span>&nbsp;<span class="ident" id="1930113">i</span>&nbsp;<span class="op" id="1930115">:=</span>&nbsp;<span class="builtintype" id="1930118">uintptr</span><span class="op" id="1930125">(</span><span class="num" id="1930126">0</span><span class="op" id="1930127">)</span><span class="op" id="1930128">;</span>&nbsp;<span class="ident" id="1930130">i</span>&nbsp;<span class="op" id="1930132">&lt;</span>&nbsp;<span class="ident" id="1930134">size0</span><span class="op" id="1930139">;</span>&nbsp;<span class="ident" id="1930141">i</span>&nbsp;<span class="op" id="1930143">+=</span>&nbsp;<span class="num" id="1930146">2</span>&nbsp;<span class="op" id="1930148">*</span>&nbsp;<span class="ident" id="1930150">ptrSize</span>&nbsp;<span class="op" id="1930158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930163">v</span>&nbsp;<span class="op" id="1930165">:=</span>&nbsp;<span class="op" id="1930168">*</span><span class="op" id="1930169">(</span><span class="op" id="1930170">*</span><span class="builtintype" id="1930171">uint8</span><span class="op" id="1930176">)</span><span class="op" id="1930177">(</span><span class="ident" id="1930178">add</span><span class="op" id="1930181">(</span><span class="ident" id="1930182">unsafe</span><span class="op" id="1930188">.</span><span class="ident" id="1930189">Pointer</span><span class="op" id="1930196">(</span><span class="ident" id="1930197">ptrmask</span><span class="op" id="1930204">)</span><span class="op" id="1930205">,</span>&nbsp;<span class="ident" id="1930207">ti</span><span class="op" id="1930209">)</span><span class="op" id="1930210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930215">ti</span><span class="op" id="1930217">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930223">if</span>&nbsp;<span class="ident" id="1930226">ti</span>&nbsp;<span class="op" id="1930229">==</span>&nbsp;<span class="ident" id="1930232">te</span>&nbsp;<span class="op" id="1930235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930241">ti</span>&nbsp;<span class="op" id="1930244">=</span>&nbsp;<span class="num" id="1930246">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930256">if</span>&nbsp;<span class="ident" id="1930259">i</span>&nbsp;<span class="op" id="1930261">==</span>&nbsp;<span class="num" id="1930264">0</span>&nbsp;<span class="op" id="1930266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930272">v</span>&nbsp;<span class="op" id="1930274">|=</span>&nbsp;<span class="ident" id="1930277">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930297">if</span>&nbsp;<span class="ident" id="1930300">i</span><span class="op" id="1930301">+</span><span class="ident" id="1930302">ptrSize</span>&nbsp;<span class="op" id="1930310">==</span>&nbsp;<span class="ident" id="1930313">size0</span>&nbsp;<span class="op" id="1930319">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930325">v</span>&nbsp;<span class="op" id="1930327">&amp;^=</span>&nbsp;<span class="builtintype" id="1930331">uint8</span><span class="op" id="1930336">(</span><span class="ident" id="1930337">bitPtrMask</span>&nbsp;<span class="op" id="1930348">&lt;&lt;</span>&nbsp;<span class="num" id="1930351">4</span><span class="op" id="1930352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930363">*</span><span class="ident" id="1930364">xbits</span>&nbsp;<span class="op" id="1930370">=</span>&nbsp;<span class="ident" id="1930372">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930377">xbits</span>&nbsp;<span class="op" id="1930383">=</span>&nbsp;<span class="op" id="1930385">(</span><span class="op" id="1930386">*</span><span class="builtintype" id="1930387">byte</span><span class="op" id="1930391">)</span><span class="op" id="1930392">(</span><span class="ident" id="1930393">add</span><span class="op" id="1930396">(</span><span class="ident" id="1930397">unsafe</span><span class="op" id="1930403">.</span><span class="ident" id="1930404">Pointer</span><span class="op" id="1930411">(</span><span class="ident" id="1930412">xbits</span><span class="op" id="1930417">)</span><span class="op" id="1930418">,</span>&nbsp;<span class="op" id="1930420">^</span><span class="builtintype" id="1930421">uintptr</span><span class="op" id="1930428">(</span><span class="num" id="1930429">0</span><span class="op" id="1930430">)</span><span class="op" id="1930431">)</span><span class="op" id="1930432">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930440">if</span>&nbsp;<span class="ident" id="1930443">size0</span><span class="op" id="1930448">%</span><span class="op" id="1930449">(</span><span class="num" id="1930450">2</span><span class="op" id="1930451">*</span><span class="ident" id="1930452">ptrSize</span><span class="op" id="1930459">)</span>&nbsp;<span class="op" id="1930461">==</span>&nbsp;<span class="num" id="1930464">0</span>&nbsp;<span class="op" id="1930466">&amp;&amp;</span>&nbsp;<span class="ident" id="1930469">size0</span>&nbsp;<span class="op" id="1930475">&lt;</span>&nbsp;<span class="ident" id="1930477">size</span>&nbsp;<span class="op" id="1930482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1930487">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930545">*</span><span class="ident" id="1930546">xbits</span>&nbsp;<span class="op" id="1930552">=</span>&nbsp;<span class="ident" id="1930554">bitsDead</span>&nbsp;<span class="op" id="1930563">&lt;&lt;</span>&nbsp;<span class="num" id="1930566">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930570">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930573">}</span><br>
<span class="lineno"></span><span class="ident" id="1930575">marked</span><span class="op" id="1930581">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930584">if</span>&nbsp;<span class="ident" id="1930587">raceenabled</span>&nbsp;<span class="op" id="1930599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930603">racemalloc</span><span class="op" id="1930613">(</span><span class="ident" id="1930614">x</span><span class="op" id="1930615">,</span>&nbsp;<span class="ident" id="1930617">size</span><span class="op" id="1930621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930624">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930628">if</span>&nbsp;<span class="ident" id="1930631">debugMalloc</span>&nbsp;<span class="op" id="1930643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930647">mp</span>&nbsp;<span class="op" id="1930650">:=</span>&nbsp;<span class="ident" id="1930653">acquirem</span><span class="op" id="1930661">(</span><span class="op" id="1930662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930666">if</span>&nbsp;<span class="ident" id="1930669">mp</span><span class="op" id="1930671">.</span><span class="ident" id="1930672">mallocing</span>&nbsp;<span class="op" id="1930682">==</span>&nbsp;<span class="num" id="1930685">0</span>&nbsp;<span class="op" id="1930687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930692">gothrow</span><span class="op" id="1930699">(</span><span class="string" id="1930700">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1930712">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930720">mp</span><span class="op" id="1930722">.</span><span class="ident" id="1930723">mallocing</span>&nbsp;<span class="op" id="1930733">=</span>&nbsp;<span class="num" id="1930735">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930739">if</span>&nbsp;<span class="ident" id="1930742">mp</span><span class="op" id="1930744">.</span><span class="ident" id="1930745">curg</span>&nbsp;<span class="op" id="1930750">!=</span>&nbsp;<span class="ident" id="1930753">nil</span>&nbsp;<span class="op" id="1930757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930762">mp</span><span class="op" id="1930764">.</span><span class="ident" id="1930765">curg</span><span class="op" id="1930769">.</span><span class="ident" id="1930770">stackguard0</span>&nbsp;<span class="op" id="1930782">=</span>&nbsp;<span class="ident" id="1930784">mp</span><span class="op" id="1930786">.</span><span class="ident" id="1930787">curg</span><span class="op" id="1930791">.</span><span class="ident" id="1930792">stack</span><span class="op" id="1930797">.</span><span class="ident" id="1930798">lo</span>&nbsp;<span class="op" id="1930801">+</span>&nbsp;<span class="ident" id="1930803">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930817">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1930821">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1930874">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930926">releasem</span><span class="op" id="1930934">(</span><span class="ident" id="1930935">mp</span><span class="op" id="1930937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930941">releasem</span><span class="op" id="1930949">(</span><span class="ident" id="1930950">mp</span><span class="op" id="1930952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1930955">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1930959">if</span>&nbsp;<span class="ident" id="1930962">debug</span><span class="op" id="1930967">.</span><span class="ident" id="1930968">allocfreetrace</span>&nbsp;<span class="op" id="1930983">!=</span>&nbsp;<span class="num" id="1930986">0</span>&nbsp;<span class="op" id="1930988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1930992">tracealloc</span><span class="op" id="1931002">(</span><span class="ident" id="1931003">x</span><span class="op" id="1931004">,</span>&nbsp;<span class="ident" id="1931006">size</span><span class="op" id="1931010">,</span>&nbsp;<span class="ident" id="1931012">typ</span><span class="op" id="1931015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931022">if</span>&nbsp;<span class="ident" id="1931025">rate</span>&nbsp;<span class="op" id="1931030">:=</span>&nbsp;<span class="ident" id="1931033">MemProfileRate</span><span class="op" id="1931047">;</span>&nbsp;<span class="ident" id="1931049">rate</span>&nbsp;<span class="op" id="1931054">&gt;</span>&nbsp;<span class="num" id="1931056">0</span>&nbsp;<span class="op" id="1931058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931062">if</span>&nbsp;<span class="ident" id="1931065">size</span>&nbsp;<span class="op" id="1931070">&lt;</span>&nbsp;<span class="builtintype" id="1931072">uintptr</span><span class="op" id="1931079">(</span><span class="ident" id="1931080">rate</span><span class="op" id="1931084">)</span>&nbsp;<span class="op" id="1931086">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1931089">int32</span><span class="op" id="1931094">(</span><span class="ident" id="1931095">size</span><span class="op" id="1931099">)</span>&nbsp;<span class="op" id="1931101">&lt;</span>&nbsp;<span class="ident" id="1931103">c</span><span class="op" id="1931104">.</span><span class="ident" id="1931105">next_sample</span>&nbsp;<span class="op" id="1931117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931122">c</span><span class="op" id="1931123">.</span><span class="ident" id="1931124">next_sample</span>&nbsp;<span class="op" id="1931136">-=</span>&nbsp;<span class="builtintype" id="1931139">int32</span><span class="op" id="1931144">(</span><span class="ident" id="1931145">size</span><span class="op" id="1931149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931153">}</span>&nbsp;<span class="keyword" id="1931155">else</span>&nbsp;<span class="op" id="1931160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931165">mp</span>&nbsp;<span class="op" id="1931168">:=</span>&nbsp;<span class="ident" id="1931171">acquirem</span><span class="op" id="1931179">(</span><span class="op" id="1931180">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931185">profilealloc</span><span class="op" id="1931197">(</span><span class="ident" id="1931198">mp</span><span class="op" id="1931200">,</span>&nbsp;<span class="ident" id="1931202">x</span><span class="op" id="1931203">,</span>&nbsp;<span class="ident" id="1931205">size</span><span class="op" id="1931209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931214">releasem</span><span class="op" id="1931222">(</span><span class="ident" id="1931223">mp</span><span class="op" id="1931225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931236">if</span>&nbsp;<span class="ident" id="1931239">memstats</span><span class="op" id="1931247">.</span><span class="ident" id="1931248">heap_alloc</span>&nbsp;<span class="op" id="1931259">&gt;=</span>&nbsp;<span class="ident" id="1931262">memstats</span><span class="op" id="1931270">.</span><span class="ident" id="1931271">next_gc</span>&nbsp;<span class="op" id="1931279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931283">gogc</span><span class="op" id="1931287">(</span><span class="num" id="1931288">0</span><span class="op" id="1931289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931296">return</span>&nbsp;<span class="ident" id="1931303">x</span><br>
<span class="lineno">345</span><span class="op" id="1931305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1931308">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1931341">func</span>&nbsp;<span class="ident" id="1931346">newobject</span><span class="op" id="1931355">(</span><span class="ident" id="1931356">typ</span>&nbsp;<span class="op" id="1931360">*</span><span class="ident" id="1931361">_type</span><span class="op" id="1931366">)</span>&nbsp;<span class="ident" id="1931368">unsafe</span><span class="op" id="1931374">.</span><span class="ident" id="1931375">Pointer</span>&nbsp;<span class="op" id="1931383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931386">flags</span>&nbsp;<span class="op" id="1931392">:=</span>&nbsp;<span class="builtintype" id="1931395">uint32</span><span class="op" id="1931401">(</span><span class="num" id="1931402">0</span><span class="op" id="1931403">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931406">if</span>&nbsp;<span class="ident" id="1931409">typ</span><span class="op" id="1931412">.</span><span class="ident" id="1931413">kind</span><span class="op" id="1931417">&amp;</span><span class="ident" id="1931418">kindNoPointers</span>&nbsp;<span class="op" id="1931433">!=</span>&nbsp;<span class="num" id="1931436">0</span>&nbsp;<span class="op" id="1931438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931442">flags</span>&nbsp;<span class="op" id="1931448">|=</span>&nbsp;<span class="ident" id="1931451">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931466">return</span>&nbsp;<span class="ident" id="1931473">mallocgc</span><span class="op" id="1931481">(</span><span class="builtintype" id="1931482">uintptr</span><span class="op" id="1931489">(</span><span class="ident" id="1931490">typ</span><span class="op" id="1931493">.</span><span class="ident" id="1931494">size</span><span class="op" id="1931498">)</span><span class="op" id="1931499">,</span>&nbsp;<span class="ident" id="1931501">typ</span><span class="op" id="1931504">,</span>&nbsp;<span class="ident" id="1931506">flags</span><span class="op" id="1931511">)</span><br>
<span class="lineno"></span><span class="op" id="1931513">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1931516">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1931561">func</span>&nbsp;<span class="ident" id="1931566">newarray</span><span class="op" id="1931574">(</span><span class="ident" id="1931575">typ</span>&nbsp;<span class="op" id="1931579">*</span><span class="ident" id="1931580">_type</span><span class="op" id="1931585">,</span>&nbsp;<span class="ident" id="1931587">n</span>&nbsp;<span class="builtintype" id="1931589">uintptr</span><span class="op" id="1931596">)</span>&nbsp;<span class="ident" id="1931598">unsafe</span><span class="op" id="1931604">.</span><span class="ident" id="1931605">Pointer</span>&nbsp;<span class="op" id="1931613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931616">flags</span>&nbsp;<span class="op" id="1931622">:=</span>&nbsp;<span class="builtintype" id="1931625">uint32</span><span class="op" id="1931631">(</span><span class="num" id="1931632">0</span><span class="op" id="1931633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931636">if</span>&nbsp;<span class="ident" id="1931639">typ</span><span class="op" id="1931642">.</span><span class="ident" id="1931643">kind</span><span class="op" id="1931647">&amp;</span><span class="ident" id="1931648">kindNoPointers</span>&nbsp;<span class="op" id="1931663">!=</span>&nbsp;<span class="num" id="1931666">0</span>&nbsp;<span class="op" id="1931668">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1931672">flags</span>&nbsp;<span class="op" id="1931678">|=</span>&nbsp;<span class="ident" id="1931681">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931696">if</span>&nbsp;<span class="builtintype" id="1931699">int</span><span class="op" id="1931702">(</span><span class="ident" id="1931703">n</span><span class="op" id="1931704">)</span>&nbsp;<span class="op" id="1931706">&lt;</span>&nbsp;<span class="num" id="1931708">0</span>&nbsp;<span class="op" id="1931710">||</span>&nbsp;<span class="op" id="1931713">(</span><span class="ident" id="1931714">typ</span><span class="op" id="1931717">.</span><span class="ident" id="1931718">size</span>&nbsp;<span class="op" id="1931723">&gt;</span>&nbsp;<span class="num" id="1931725">0</span>&nbsp;<span class="op" id="1931727">&amp;&amp;</span>&nbsp;<span class="ident" id="1931730">n</span>&nbsp;<span class="op" id="1931732">&gt;</span>&nbsp;<span class="ident" id="1931734">maxmem</span><span class="op" id="1931740">/</span><span class="builtintype" id="1931741">uintptr</span><span class="op" id="1931748">(</span><span class="ident" id="1931749">typ</span><span class="op" id="1931752">.</span><span class="ident" id="1931753">size</span><span class="op" id="1931757">)</span><span class="op" id="1931758">)</span>&nbsp;<span class="op" id="1931760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1931764">panic</span><span class="op" id="1931769">(</span><span class="string" id="1931770">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1931809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1931812">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931815">return</span>&nbsp;<span class="ident" id="1931822">mallocgc</span><span class="op" id="1931830">(</span><span class="builtintype" id="1931831">uintptr</span><span class="op" id="1931838">(</span><span class="ident" id="1931839">typ</span><span class="op" id="1931842">.</span><span class="ident" id="1931843">size</span><span class="op" id="1931847">)</span><span class="op" id="1931848">*</span><span class="ident" id="1931849">n</span><span class="op" id="1931850">,</span>&nbsp;<span class="ident" id="1931852">typ</span><span class="op" id="1931855">,</span>&nbsp;<span class="ident" id="1931857">flags</span><span class="op" id="1931862">)</span><br>
<span class="lineno"></span><span class="op" id="1931864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1931867">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1931923">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1931938">func</span>&nbsp;<span class="ident" id="1931943">rawmem</span><span class="op" id="1931949">(</span><span class="ident" id="1931950">size</span>&nbsp;<span class="builtintype" id="1931955">uintptr</span><span class="op" id="1931962">)</span>&nbsp;<span class="ident" id="1931964">unsafe</span><span class="op" id="1931970">.</span><span class="ident" id="1931971">Pointer</span>&nbsp;<span class="op" id="1931979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1931982">return</span>&nbsp;<span class="ident" id="1931989">mallocgc</span><span class="op" id="1931997">(</span><span class="ident" id="1931998">size</span><span class="op" id="1932002">,</span>&nbsp;<span class="ident" id="1932004">nil</span><span class="op" id="1932007">,</span>&nbsp;<span class="ident" id="1932009">flagNoScan</span><span class="op" id="1932019">|</span><span class="ident" id="1932020">flagNoZero</span><span class="op" id="1932030">)</span><br>
<span class="lineno"></span><span class="op" id="1932032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1932035">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1932071">func</span>&nbsp;<span class="ident" id="1932076">goroundupsize</span><span class="op" id="1932089">(</span><span class="ident" id="1932090">size</span>&nbsp;<span class="builtintype" id="1932095">uintptr</span><span class="op" id="1932102">)</span>&nbsp;<span class="builtintype" id="1932104">uintptr</span>&nbsp;<span class="op" id="1932112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932115">if</span>&nbsp;<span class="ident" id="1932118">size</span>&nbsp;<span class="op" id="1932123">&lt;</span>&nbsp;<span class="ident" id="1932125">maxSmallSize</span>&nbsp;<span class="op" id="1932138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932142">if</span>&nbsp;<span class="ident" id="1932145">size</span>&nbsp;<span class="op" id="1932150">&lt;=</span>&nbsp;<span class="num" id="1932153">1024</span><span class="op" id="1932157">-</span><span class="num" id="1932158">8</span>&nbsp;<span class="op" id="1932160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932165">return</span>&nbsp;<span class="builtintype" id="1932172">uintptr</span><span class="op" id="1932179">(</span><span class="ident" id="1932180">class_to_size</span><span class="op" id="1932193">[</span><span class="ident" id="1932194">size_to_class8</span><span class="op" id="1932208">[</span><span class="op" id="1932209">(</span><span class="ident" id="1932210">size</span><span class="op" id="1932214">+</span><span class="num" id="1932215">7</span><span class="op" id="1932216">)</span><span class="op" id="1932217">&gt;&gt;</span><span class="num" id="1932219">3</span><span class="op" id="1932220">]</span><span class="op" id="1932221">]</span><span class="op" id="1932222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1932226">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932230">return</span>&nbsp;<span class="builtintype" id="1932237">uintptr</span><span class="op" id="1932244">(</span><span class="ident" id="1932245">class_to_size</span><span class="op" id="1932258">[</span><span class="ident" id="1932259">size_to_class128</span><span class="op" id="1932275">[</span><span class="op" id="1932276">(</span><span class="ident" id="1932277">size</span><span class="op" id="1932281">-</span><span class="num" id="1932282">1024</span><span class="op" id="1932286">+</span><span class="num" id="1932287">127</span><span class="op" id="1932290">)</span><span class="op" id="1932291">&gt;&gt;</span><span class="num" id="1932293">7</span><span class="op" id="1932294">]</span><span class="op" id="1932295">]</span><span class="op" id="1932296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1932299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932302">if</span>&nbsp;<span class="ident" id="1932305">size</span><span class="op" id="1932309">+</span><span class="ident" id="1932310">pageSize</span>&nbsp;<span class="op" id="1932319">&lt;</span>&nbsp;<span class="ident" id="1932321">size</span>&nbsp;<span class="op" id="1932326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932330">return</span>&nbsp;<span class="ident" id="1932337">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1932343">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932346">return</span>&nbsp;<span class="op" id="1932353">(</span><span class="ident" id="1932354">size</span>&nbsp;<span class="op" id="1932359">+</span>&nbsp;<span class="ident" id="1932361">pageSize</span>&nbsp;<span class="op" id="1932370">-</span>&nbsp;<span class="num" id="1932372">1</span><span class="op" id="1932373">)</span>&nbsp;<span class="op" id="1932375">&amp;^</span>&nbsp;<span class="ident" id="1932378">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1932387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1932390">func</span>&nbsp;<span class="ident" id="1932395">profilealloc</span><span class="op" id="1932407">(</span><span class="ident" id="1932408">mp</span>&nbsp;<span class="op" id="1932411">*</span><span class="ident" id="1932412">m</span><span class="op" id="1932413">,</span>&nbsp;<span class="ident" id="1932415">x</span>&nbsp;<span class="ident" id="1932417">unsafe</span><span class="op" id="1932423">.</span><span class="ident" id="1932424">Pointer</span><span class="op" id="1932431">,</span>&nbsp;<span class="ident" id="1932433">size</span>&nbsp;<span class="builtintype" id="1932438">uintptr</span><span class="op" id="1932445">)</span>&nbsp;<span class="op" id="1932447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932450">c</span>&nbsp;<span class="op" id="1932452">:=</span>&nbsp;<span class="ident" id="1932455">mp</span><span class="op" id="1932457">.</span><span class="ident" id="1932458">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932466">rate</span>&nbsp;<span class="op" id="1932471">:=</span>&nbsp;<span class="ident" id="1932474">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932490">if</span>&nbsp;<span class="ident" id="1932493">size</span>&nbsp;<span class="op" id="1932498">&lt;</span>&nbsp;<span class="builtintype" id="1932500">uintptr</span><span class="op" id="1932507">(</span><span class="ident" id="1932508">rate</span><span class="op" id="1932512">)</span>&nbsp;<span class="op" id="1932514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1932518">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1932546">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932596">if</span>&nbsp;<span class="ident" id="1932599">rate</span>&nbsp;<span class="op" id="1932604">&gt;</span>&nbsp;<span class="num" id="1932606">0x3fffffff</span>&nbsp;<span class="op" id="1932617">{</span>&nbsp;<span class="comment" id="1932619">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932650">rate</span>&nbsp;<span class="op" id="1932655">=</span>&nbsp;<span class="num" id="1932657">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1932670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932674">next</span>&nbsp;<span class="op" id="1932679">:=</span>&nbsp;<span class="builtintype" id="1932682">int32</span><span class="op" id="1932687">(</span><span class="ident" id="1932688">fastrand1</span><span class="op" id="1932697">(</span><span class="op" id="1932698">)</span><span class="op" id="1932699">)</span>&nbsp;<span class="op" id="1932701">%</span>&nbsp;<span class="op" id="1932703">(</span><span class="num" id="1932704">2</span>&nbsp;<span class="op" id="1932706">*</span>&nbsp;<span class="builtintype" id="1932708">int32</span><span class="op" id="1932713">(</span><span class="ident" id="1932714">rate</span><span class="op" id="1932718">)</span><span class="op" id="1932719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1932723">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1932780">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1932843">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932919">next</span>&nbsp;<span class="op" id="1932924">-=</span>&nbsp;<span class="op" id="1932927">(</span><span class="builtintype" id="1932928">int32</span><span class="op" id="1932933">(</span><span class="ident" id="1932934">size</span><span class="op" id="1932938">)</span>&nbsp;<span class="op" id="1932940">-</span>&nbsp;<span class="ident" id="1932942">c</span><span class="op" id="1932943">.</span><span class="ident" id="1932944">next_sample</span><span class="op" id="1932955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932959">if</span>&nbsp;<span class="ident" id="1932962">next</span>&nbsp;<span class="op" id="1932967">&lt;</span>&nbsp;<span class="num" id="1932969">0</span>&nbsp;<span class="op" id="1932971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932976">next</span>&nbsp;<span class="op" id="1932981">=</span>&nbsp;<span class="num" id="1932983">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1932987">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932991">c</span><span class="op" id="1932992">.</span><span class="ident" id="1932993">next_sample</span>&nbsp;<span class="op" id="1933005">=</span>&nbsp;<span class="ident" id="1933007">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933017">mProf_Malloc</span><span class="op" id="1933029">(</span><span class="ident" id="1933030">x</span><span class="op" id="1933031">,</span>&nbsp;<span class="ident" id="1933033">size</span><span class="op" id="1933037">)</span><br>
<span class="lineno"></span><span class="op" id="1933039">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1933042">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1933096">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1933133">func</span>&nbsp;<span class="ident" id="1933138">gogc</span><span class="op" id="1933142">(</span><span class="ident" id="1933143">force</span>&nbsp;<span class="builtintype" id="1933149">int32</span><span class="op" id="1933154">)</span>&nbsp;<span class="op" id="1933156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933159">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933234">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933314">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933386">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933462">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933490">mp</span>&nbsp;<span class="op" id="1933493">:=</span>&nbsp;<span class="ident" id="1933496">acquirem</span><span class="op" id="1933504">(</span><span class="op" id="1933505">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933508">if</span>&nbsp;<span class="ident" id="1933511">gp</span>&nbsp;<span class="op" id="1933514">:=</span>&nbsp;<span class="ident" id="1933517">getg</span><span class="op" id="1933521">(</span><span class="op" id="1933522">)</span><span class="op" id="1933523">;</span>&nbsp;<span class="ident" id="1933525">gp</span>&nbsp;<span class="op" id="1933528">==</span>&nbsp;<span class="ident" id="1933531">mp</span><span class="op" id="1933533">.</span><span class="ident" id="1933534">g0</span>&nbsp;<span class="op" id="1933537">||</span>&nbsp;<span class="ident" id="1933540">mp</span><span class="op" id="1933542">.</span><span class="ident" id="1933543">locks</span>&nbsp;<span class="op" id="1933549">&gt;</span>&nbsp;<span class="num" id="1933551">1</span>&nbsp;<span class="op" id="1933553">||</span>&nbsp;<span class="op" id="1933556">!</span><span class="ident" id="1933557">memstats</span><span class="op" id="1933565">.</span><span class="ident" id="1933566">enablegc</span>&nbsp;<span class="op" id="1933575">||</span>&nbsp;<span class="ident" id="1933578">panicking</span>&nbsp;<span class="op" id="1933588">!=</span>&nbsp;<span class="num" id="1933591">0</span>&nbsp;<span class="op" id="1933593">||</span>&nbsp;<span class="ident" id="1933596">gcpercent</span>&nbsp;<span class="op" id="1933606">&lt;</span>&nbsp;<span class="num" id="1933608">0</span>&nbsp;<span class="op" id="1933610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933614">releasem</span><span class="op" id="1933622">(</span><span class="ident" id="1933623">mp</span><span class="op" id="1933625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933629">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933640">releasem</span><span class="op" id="1933648">(</span><span class="ident" id="1933649">mp</span><span class="op" id="1933651">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933654">mp</span>&nbsp;<span class="op" id="1933657">=</span>&nbsp;<span class="ident" id="1933659">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933665">semacquire</span><span class="op" id="1933675">(</span><span class="op" id="1933676">&amp;</span><span class="ident" id="1933677">worldsema</span><span class="op" id="1933686">,</span>&nbsp;<span class="builtintype" id="1933688">false</span><span class="op" id="1933693">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933697">if</span>&nbsp;<span class="ident" id="1933700">force</span>&nbsp;<span class="op" id="1933706">==</span>&nbsp;<span class="num" id="1933709">0</span>&nbsp;<span class="op" id="1933711">&amp;&amp;</span>&nbsp;<span class="ident" id="1933714">memstats</span><span class="op" id="1933722">.</span><span class="ident" id="1933723">heap_alloc</span>&nbsp;<span class="op" id="1933734">&lt;</span>&nbsp;<span class="ident" id="1933736">memstats</span><span class="op" id="1933744">.</span><span class="ident" id="1933745">next_gc</span>&nbsp;<span class="op" id="1933753">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933757">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933808">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933850">semrelease</span><span class="op" id="1933860">(</span><span class="op" id="1933861">&amp;</span><span class="ident" id="1933862">worldsema</span><span class="op" id="1933871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933875">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933883">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933887">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933932">startTime</span>&nbsp;<span class="op" id="1933942">:=</span>&nbsp;<span class="ident" id="1933945">nanotime</span><span class="op" id="1933953">(</span><span class="op" id="1933954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933957">mp</span>&nbsp;<span class="op" id="1933960">=</span>&nbsp;<span class="ident" id="1933962">acquirem</span><span class="op" id="1933970">(</span><span class="op" id="1933971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933974">mp</span><span class="op" id="1933976">.</span><span class="ident" id="1933977">gcing</span>&nbsp;<span class="op" id="1933983">=</span>&nbsp;<span class="num" id="1933985">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933988">releasem</span><span class="op" id="1933996">(</span><span class="ident" id="1933997">mp</span><span class="op" id="1933999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934002">onM</span><span class="op" id="1934005">(</span><span class="ident" id="1934006">stoptheworld</span><span class="op" id="1934018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934021">if</span>&nbsp;<span class="ident" id="1934024">mp</span>&nbsp;<span class="op" id="1934027">!=</span>&nbsp;<span class="ident" id="1934030">acquirem</span><span class="op" id="1934038">(</span><span class="op" id="1934039">)</span>&nbsp;<span class="op" id="1934041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934045">gothrow</span><span class="op" id="1934052">(</span><span class="string" id="1934053">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1934072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934075">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934079">clearpools</span><span class="op" id="1934089">(</span><span class="op" id="1934090">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934094">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934154">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934214">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934274">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934331">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934384">n</span>&nbsp;<span class="op" id="1934386">:=</span>&nbsp;<span class="num" id="1934389">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934392">if</span>&nbsp;<span class="ident" id="1934395">debug</span><span class="op" id="1934400">.</span><span class="ident" id="1934401">gctrace</span>&nbsp;<span class="op" id="1934409">&gt;</span>&nbsp;<span class="num" id="1934411">1</span>&nbsp;<span class="op" id="1934413">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934417">n</span>&nbsp;<span class="op" id="1934419">=</span>&nbsp;<span class="num" id="1934421">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934427">for</span>&nbsp;<span class="ident" id="1934431">i</span>&nbsp;<span class="op" id="1934433">:=</span>&nbsp;<span class="num" id="1934436">0</span><span class="op" id="1934437">;</span>&nbsp;<span class="ident" id="1934439">i</span>&nbsp;<span class="op" id="1934441">&lt;</span>&nbsp;<span class="ident" id="1934443">n</span><span class="op" id="1934444">;</span>&nbsp;<span class="ident" id="1934446">i</span><span class="op" id="1934447">++</span>&nbsp;<span class="op" id="1934450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934454">if</span>&nbsp;<span class="ident" id="1934457">i</span>&nbsp;<span class="op" id="1934459">&gt;</span>&nbsp;<span class="num" id="1934461">0</span>&nbsp;<span class="op" id="1934463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934468">startTime</span>&nbsp;<span class="op" id="1934478">=</span>&nbsp;<span class="ident" id="1934480">nanotime</span><span class="op" id="1934488">(</span><span class="op" id="1934489">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934497">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934542">mp</span><span class="op" id="1934544">.</span><span class="ident" id="1934545">scalararg</span><span class="op" id="1934554">[</span><span class="num" id="1934555">0</span><span class="op" id="1934556">]</span>&nbsp;<span class="op" id="1934558">=</span>&nbsp;<span class="builtintype" id="1934560">uintptr</span><span class="op" id="1934567">(</span><span class="builtintype" id="1934568">uint32</span><span class="op" id="1934574">(</span><span class="ident" id="1934575">startTime</span><span class="op" id="1934584">)</span><span class="op" id="1934585">)</span>&nbsp;<span class="comment" id="1934587">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934604">mp</span><span class="op" id="1934606">.</span><span class="ident" id="1934607">scalararg</span><span class="op" id="1934616">[</span><span class="num" id="1934617">1</span><span class="op" id="1934618">]</span>&nbsp;<span class="op" id="1934620">=</span>&nbsp;<span class="builtintype" id="1934622">uintptr</span><span class="op" id="1934629">(</span><span class="ident" id="1934630">startTime</span>&nbsp;<span class="op" id="1934640">&gt;&gt;</span>&nbsp;<span class="num" id="1934643">32</span><span class="op" id="1934645">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1934649">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934667">if</span>&nbsp;<span class="ident" id="1934670">force</span>&nbsp;<span class="op" id="1934676">&gt;=</span>&nbsp;<span class="num" id="1934679">2</span>&nbsp;<span class="op" id="1934681">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934686">mp</span><span class="op" id="1934688">.</span><span class="ident" id="1934689">scalararg</span><span class="op" id="1934698">[</span><span class="num" id="1934699">2</span><span class="op" id="1934700">]</span>&nbsp;<span class="op" id="1934702">=</span>&nbsp;<span class="num" id="1934704">1</span>&nbsp;<span class="comment" id="1934706">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934722">}</span>&nbsp;<span class="keyword" id="1934724">else</span>&nbsp;<span class="op" id="1934729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934734">mp</span><span class="op" id="1934736">.</span><span class="ident" id="1934737">scalararg</span><span class="op" id="1934746">[</span><span class="num" id="1934747">2</span><span class="op" id="1934748">]</span>&nbsp;<span class="op" id="1934750">=</span>&nbsp;<span class="num" id="1934752">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934760">onM</span><span class="op" id="1934763">(</span><span class="ident" id="1934764">gc_m</span><span class="op" id="1934768">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934775">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934788">mp</span><span class="op" id="1934790">.</span><span class="ident" id="1934791">gcing</span>&nbsp;<span class="op" id="1934797">=</span>&nbsp;<span class="num" id="1934799">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934802">semrelease</span><span class="op" id="1934812">(</span><span class="op" id="1934813">&amp;</span><span class="ident" id="1934814">worldsema</span><span class="op" id="1934823">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934826">onM</span><span class="op" id="1934829">(</span><span class="ident" id="1934830">starttheworld</span><span class="op" id="1934843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934846">releasem</span><span class="op" id="1934854">(</span><span class="ident" id="1934855">mp</span><span class="op" id="1934857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934860">mp</span>&nbsp;<span class="op" id="1934863">=</span>&nbsp;<span class="ident" id="1934865">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934871">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934932">if</span>&nbsp;<span class="op" id="1934935">!</span><span class="ident" id="1934936">concurrentSweep</span>&nbsp;<span class="op" id="1934952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934956">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935013">Gosched</span><span class="op" id="1935020">(</span><span class="op" id="1935021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935024">}</span><br>
<span class="lineno"></span><span class="op" id="1935026">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1935029">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1935062">func</span>&nbsp;<span class="ident" id="1935067">GC</span><span class="op" id="1935069">(</span><span class="op" id="1935070">)</span>&nbsp;<span class="op" id="1935072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935075">gogc</span><span class="op" id="1935079">(</span><span class="num" id="1935080">2</span><span class="op" id="1935081">)</span><br>
<span class="lineno"></span><span class="op" id="1935083">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1935086">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1935105">var</span>&nbsp;<span class="ident" id="1935109">noptrdata</span>&nbsp;<span class="keyword" id="1935119">struct</span><span class="op" id="1935125">{</span><span class="op" id="1935126">}</span><br>
<span class="lineno"></span><span class="keyword" id="1935128">var</span>&nbsp;<span class="ident" id="1935132">enoptrdata</span>&nbsp;<span class="keyword" id="1935143">struct</span><span class="op" id="1935149">{</span><span class="op" id="1935150">}</span><br>
<span class="lineno"></span><span class="keyword" id="1935152">var</span>&nbsp;<span class="ident" id="1935156">noptrbss</span>&nbsp;<span class="keyword" id="1935165">struct</span><span class="op" id="1935171">{</span><span class="op" id="1935172">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1935174">var</span>&nbsp;<span class="ident" id="1935178">enoptrbss</span>&nbsp;<span class="keyword" id="1935188">struct</span><span class="op" id="1935194">{</span><span class="op" id="1935195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1935198">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1935257">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1935314">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1935382">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1935450">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1935518">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1935583">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1935625">//</span><br>
<span class="lineno">505</span><span class="comment" id="1935628">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1935692">//</span><br>
<span class="lineno"></span><span class="comment" id="1935695">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1935757">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1935821">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1935887">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1935963">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1936030">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1936042">//</span><br>
<span class="lineno"></span><span class="comment" id="1936045">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1936116">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1936186">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1936247">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1936312">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1936381">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1936444">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1936474">//</span><br>
<span class="lineno"></span><span class="comment" id="1936477">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1936549">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1936575">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1936649">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1936721">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1936781">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1936850">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1936921">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1936984">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1937055">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1937129">//</span><br>
<span class="lineno"></span><span class="comment" id="1937132">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1937203">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1937218">//</span><br>
<span class="lineno"></span><span class="comment" id="1937221">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1937293">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1937361">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1937402">//</span><br>
<span class="lineno">540</span><span class="comment" id="1937405">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1937476">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1937548">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1937568">func</span>&nbsp;<span class="ident" id="1937573">SetFinalizer</span><span class="op" id="1937585">(</span><span class="ident" id="1937586">obj</span>&nbsp;<span class="keyword" id="1937590">interface</span><span class="op" id="1937599">{</span><span class="op" id="1937600">}</span><span class="op" id="1937601">,</span>&nbsp;<span class="ident" id="1937603">finalizer</span>&nbsp;<span class="keyword" id="1937613">interface</span><span class="op" id="1937622">{</span><span class="op" id="1937623">}</span><span class="op" id="1937624">)</span>&nbsp;<span class="op" id="1937626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937629">e</span>&nbsp;<span class="op" id="1937631">:=</span>&nbsp;<span class="op" id="1937634">(</span><span class="op" id="1937635">*</span><span class="ident" id="1937636">eface</span><span class="op" id="1937641">)</span><span class="op" id="1937642">(</span><span class="ident" id="1937643">unsafe</span><span class="op" id="1937649">.</span><span class="ident" id="1937650">Pointer</span><span class="op" id="1937657">(</span><span class="op" id="1937658">&amp;</span><span class="ident" id="1937659">obj</span><span class="op" id="1937662">)</span><span class="op" id="1937663">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937666">etyp</span>&nbsp;<span class="op" id="1937671">:=</span>&nbsp;<span class="ident" id="1937674">e</span><span class="op" id="1937675">.</span><span class="ident" id="1937676">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1937683">if</span>&nbsp;<span class="ident" id="1937686">etyp</span>&nbsp;<span class="op" id="1937691">==</span>&nbsp;<span class="ident" id="1937694">nil</span>&nbsp;<span class="op" id="1937698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937702">gothrow</span><span class="op" id="1937709">(</span><span class="string" id="1937710">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1937755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1937758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1937761">if</span>&nbsp;<span class="ident" id="1937764">etyp</span><span class="op" id="1937768">.</span><span class="ident" id="1937769">kind</span><span class="op" id="1937773">&amp;</span><span class="ident" id="1937774">kindMask</span>&nbsp;<span class="op" id="1937783">!=</span>&nbsp;<span class="ident" id="1937786">kindPtr</span>&nbsp;<span class="op" id="1937794">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937798">gothrow</span><span class="op" id="1937805">(</span><span class="string" id="1937806">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1937849">+</span>&nbsp;<span class="op" id="1937851">*</span><span class="ident" id="1937852">etyp</span><span class="op" id="1937856">.</span><span class="ident" id="1937857">_string</span>&nbsp;<span class="op" id="1937865">+</span>&nbsp;<span class="string" id="1937867">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1937882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1937885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937888">ot</span>&nbsp;<span class="op" id="1937891">:=</span>&nbsp;<span class="op" id="1937894">(</span><span class="op" id="1937895">*</span><span class="ident" id="1937896">ptrtype</span><span class="op" id="1937903">)</span><span class="op" id="1937904">(</span><span class="ident" id="1937905">unsafe</span><span class="op" id="1937911">.</span><span class="ident" id="1937912">Pointer</span><span class="op" id="1937919">(</span><span class="ident" id="1937920">etyp</span><span class="op" id="1937924">)</span><span class="op" id="1937925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1937928">if</span>&nbsp;<span class="ident" id="1937931">ot</span><span class="op" id="1937933">.</span><span class="ident" id="1937934">elem</span>&nbsp;<span class="op" id="1937939">==</span>&nbsp;<span class="ident" id="1937942">nil</span>&nbsp;<span class="op" id="1937946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937950">gothrow</span><span class="op" id="1937957">(</span><span class="string" id="1937958">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1937974">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1937977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1937981">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1938012">_</span><span class="op" id="1938013">,</span>&nbsp;<span class="ident" id="1938015">base</span><span class="op" id="1938019">,</span>&nbsp;<span class="ident" id="1938021">_</span>&nbsp;<span class="op" id="1938023">:=</span>&nbsp;<span class="ident" id="1938026">findObject</span><span class="op" id="1938036">(</span><span class="ident" id="1938037">e</span><span class="op" id="1938038">.</span><span class="ident" id="1938039">data</span><span class="op" id="1938043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1938047">if</span>&nbsp;<span class="ident" id="1938050">base</span>&nbsp;<span class="op" id="1938055">==</span>&nbsp;<span class="ident" id="1938058">nil</span>&nbsp;<span class="op" id="1938062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938066">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1938098">if</span>&nbsp;<span class="ident" id="1938101">e</span><span class="op" id="1938102">.</span><span class="ident" id="1938103">data</span>&nbsp;<span class="op" id="1938108">==</span>&nbsp;<span class="ident" id="1938111">unsafe</span><span class="op" id="1938117">.</span><span class="ident" id="1938118">Pointer</span><span class="op" id="1938125">(</span><span class="op" id="1938126">&amp;</span><span class="ident" id="1938127">zerobase</span><span class="op" id="1938135">)</span>&nbsp;<span class="op" id="1938137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1938142">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1938151">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938156">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938208">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938233">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938252">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938289">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938296">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938360">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1938424">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1938454">if</span>&nbsp;<span class="builtintype" id="1938457">uintptr</span><span class="op" id="1938464">(</span><span class="ident" id="1938465">unsafe</span><span class="op" id="1938471">.</span><span class="ident" id="1938472">Pointer</span><span class="op" id="1938479">(</span><span class="op" id="1938480">&amp;</span><span class="ident" id="1938481">noptrdata</span><span class="op" id="1938490">)</span><span class="op" id="1938491">)</span>&nbsp;<span class="op" id="1938493">&lt;=</span>&nbsp;<span class="builtintype" id="1938496">uintptr</span><span class="op" id="1938503">(</span><span class="ident" id="1938504">e</span><span class="op" id="1938505">.</span><span class="ident" id="1938506">data</span><span class="op" id="1938510">)</span>&nbsp;<span class="op" id="1938512">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1938515">uintptr</span><span class="op" id="1938522">(</span><span class="ident" id="1938523">e</span><span class="op" id="1938524">.</span><span class="ident" id="1938525">data</span><span class="op" id="1938529">)</span>&nbsp;<span class="op" id="1938531">&lt;</span>&nbsp;<span class="builtintype" id="1938533">uintptr</span><span class="op" id="1938540">(</span><span class="ident" id="1938541">unsafe</span><span class="op" id="1938547">.</span><span class="ident" id="1938548">Pointer</span><span class="op" id="1938555">(</span><span class="op" id="1938556">&amp;</span><span class="ident" id="1938557">enoptrdata</span><span class="op" id="1938567">)</span><span class="op" id="1938568">)</span>&nbsp;<span class="op" id="1938570">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1938576">uintptr</span><span class="op" id="1938583">(</span><span class="ident" id="1938584">unsafe</span><span class="op" id="1938590">.</span><span class="ident" id="1938591">Pointer</span><span class="op" id="1938598">(</span><span class="op" id="1938599">&amp;</span><span class="ident" id="1938600">data</span><span class="op" id="1938604">)</span><span class="op" id="1938605">)</span>&nbsp;<span class="op" id="1938607">&lt;=</span>&nbsp;<span class="builtintype" id="1938610">uintptr</span><span class="op" id="1938617">(</span><span class="ident" id="1938618">e</span><span class="op" id="1938619">.</span><span class="ident" id="1938620">data</span><span class="op" id="1938624">)</span>&nbsp;<span class="op" id="1938626">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1938629">uintptr</span><span class="op" id="1938636">(</span><span class="ident" id="1938637">e</span><span class="op" id="1938638">.</span><span class="ident" id="1938639">data</span><span class="op" id="1938643">)</span>&nbsp;<span class="op" id="1938645">&lt;</span>&nbsp;<span class="builtintype" id="1938647">uintptr</span><span class="op" id="1938654">(</span><span class="ident" id="1938655">unsafe</span><span class="op" id="1938661">.</span><span class="ident" id="1938662">Pointer</span><span class="op" id="1938669">(</span><span class="op" id="1938670">&amp;</span><span class="ident" id="1938671">edata</span><span class="op" id="1938676">)</span><span class="op" id="1938677">)</span>&nbsp;<span class="op" id="1938679">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1938685">uintptr</span><span class="op" id="1938692">(</span><span class="ident" id="1938693">unsafe</span><span class="op" id="1938699">.</span><span class="ident" id="1938700">Pointer</span><span class="op" id="1938707">(</span><span class="op" id="1938708">&amp;</span><span class="ident" id="1938709">bss</span><span class="op" id="1938712">)</span><span class="op" id="1938713">)</span>&nbsp;<span class="op" id="1938715">&lt;=</span>&nbsp;<span class="builtintype" id="1938718">uintptr</span><span class="op" id="1938725">(</span><span class="ident" id="1938726">e</span><span class="op" id="1938727">.</span><span class="ident" id="1938728">data</span><span class="op" id="1938732">)</span>&nbsp;<span class="op" id="1938734">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1938737">uintptr</span><span class="op" id="1938744">(</span><span class="ident" id="1938745">e</span><span class="op" id="1938746">.</span><span class="ident" id="1938747">data</span><span class="op" id="1938751">)</span>&nbsp;<span class="op" id="1938753">&lt;</span>&nbsp;<span class="builtintype" id="1938755">uintptr</span><span class="op" id="1938762">(</span><span class="ident" id="1938763">unsafe</span><span class="op" id="1938769">.</span><span class="ident" id="1938770">Pointer</span><span class="op" id="1938777">(</span><span class="op" id="1938778">&amp;</span><span class="ident" id="1938779">ebss</span><span class="op" id="1938783">)</span><span class="op" id="1938784">)</span>&nbsp;<span class="op" id="1938786">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1938792">uintptr</span><span class="op" id="1938799">(</span><span class="ident" id="1938800">unsafe</span><span class="op" id="1938806">.</span><span class="ident" id="1938807">Pointer</span><span class="op" id="1938814">(</span><span class="op" id="1938815">&amp;</span><span class="ident" id="1938816">noptrbss</span><span class="op" id="1938824">)</span><span class="op" id="1938825">)</span>&nbsp;<span class="op" id="1938827">&lt;=</span>&nbsp;<span class="builtintype" id="1938830">uintptr</span><span class="op" id="1938837">(</span><span class="ident" id="1938838">e</span><span class="op" id="1938839">.</span><span class="ident" id="1938840">data</span><span class="op" id="1938844">)</span>&nbsp;<span class="op" id="1938846">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1938849">uintptr</span><span class="op" id="1938856">(</span><span class="ident" id="1938857">e</span><span class="op" id="1938858">.</span><span class="ident" id="1938859">data</span><span class="op" id="1938863">)</span>&nbsp;<span class="op" id="1938865">&lt;</span>&nbsp;<span class="builtintype" id="1938867">uintptr</span><span class="op" id="1938874">(</span><span class="ident" id="1938875">unsafe</span><span class="op" id="1938881">.</span><span class="ident" id="1938882">Pointer</span><span class="op" id="1938889">(</span><span class="op" id="1938890">&amp;</span><span class="ident" id="1938891">enoptrbss</span><span class="op" id="1938900">)</span><span class="op" id="1938901">)</span>&nbsp;<span class="op" id="1938903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1938908">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1938917">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1938921">gothrow</span><span class="op" id="1938928">(</span><span class="string" id="1938929">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1938983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1938986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1938990">if</span>&nbsp;<span class="ident" id="1938993">e</span><span class="op" id="1938994">.</span><span class="ident" id="1938995">data</span>&nbsp;<span class="op" id="1939000">!=</span>&nbsp;<span class="ident" id="1939003">base</span>&nbsp;<span class="op" id="1939008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1939012">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1939090">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939169">if</span>&nbsp;<span class="ident" id="1939172">ot</span><span class="op" id="1939174">.</span><span class="ident" id="1939175">elem</span>&nbsp;<span class="op" id="1939180">==</span>&nbsp;<span class="ident" id="1939183">nil</span>&nbsp;<span class="op" id="1939187">||</span>&nbsp;<span class="ident" id="1939190">ot</span><span class="op" id="1939192">.</span><span class="ident" id="1939193">elem</span><span class="op" id="1939197">.</span><span class="ident" id="1939198">kind</span><span class="op" id="1939202">&amp;</span><span class="ident" id="1939203">kindNoPointers</span>&nbsp;<span class="op" id="1939218">==</span>&nbsp;<span class="num" id="1939221">0</span>&nbsp;<span class="op" id="1939223">||</span>&nbsp;<span class="ident" id="1939226">ot</span><span class="op" id="1939228">.</span><span class="ident" id="1939229">elem</span><span class="op" id="1939233">.</span><span class="ident" id="1939234">size</span>&nbsp;<span class="op" id="1939239">&gt;=</span>&nbsp;<span class="ident" id="1939242">maxTinySize</span>&nbsp;<span class="op" id="1939254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939259">gothrow</span><span class="op" id="1939266">(</span><span class="string" id="1939267">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1939334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1939338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1939341">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939345">f</span>&nbsp;<span class="op" id="1939347">:=</span>&nbsp;<span class="op" id="1939350">(</span><span class="op" id="1939351">*</span><span class="ident" id="1939352">eface</span><span class="op" id="1939357">)</span><span class="op" id="1939358">(</span><span class="ident" id="1939359">unsafe</span><span class="op" id="1939365">.</span><span class="ident" id="1939366">Pointer</span><span class="op" id="1939373">(</span><span class="op" id="1939374">&amp;</span><span class="ident" id="1939375">finalizer</span><span class="op" id="1939384">)</span><span class="op" id="1939385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939388">ftyp</span>&nbsp;<span class="op" id="1939393">:=</span>&nbsp;<span class="ident" id="1939396">f</span><span class="op" id="1939397">.</span><span class="ident" id="1939398">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939405">if</span>&nbsp;<span class="ident" id="1939408">ftyp</span>&nbsp;<span class="op" id="1939413">==</span>&nbsp;<span class="ident" id="1939416">nil</span>&nbsp;<span class="op" id="1939420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1939424">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939468">mp</span>&nbsp;<span class="op" id="1939471">:=</span>&nbsp;<span class="ident" id="1939474">acquirem</span><span class="op" id="1939482">(</span><span class="op" id="1939483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939487">mp</span><span class="op" id="1939489">.</span><span class="ident" id="1939490">ptrarg</span><span class="op" id="1939496">[</span><span class="num" id="1939497">0</span><span class="op" id="1939498">]</span>&nbsp;<span class="op" id="1939500">=</span>&nbsp;<span class="ident" id="1939502">e</span><span class="op" id="1939503">.</span><span class="ident" id="1939504">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939511">onM</span><span class="op" id="1939514">(</span><span class="ident" id="1939515">removeFinalizer_m</span><span class="op" id="1939532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939536">releasem</span><span class="op" id="1939544">(</span><span class="ident" id="1939545">mp</span><span class="op" id="1939547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939551">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1939559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939563">if</span>&nbsp;<span class="ident" id="1939566">ftyp</span><span class="op" id="1939570">.</span><span class="ident" id="1939571">kind</span><span class="op" id="1939575">&amp;</span><span class="ident" id="1939576">kindMask</span>&nbsp;<span class="op" id="1939585">!=</span>&nbsp;<span class="ident" id="1939588">kindFunc</span>&nbsp;<span class="op" id="1939597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939601">gothrow</span><span class="op" id="1939608">(</span><span class="string" id="1939609">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1939653">+</span>&nbsp;<span class="op" id="1939655">*</span><span class="ident" id="1939656">ftyp</span><span class="op" id="1939660">.</span><span class="ident" id="1939661">_string</span>&nbsp;<span class="op" id="1939669">+</span>&nbsp;<span class="string" id="1939671">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1939689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1939692">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939695">ft</span>&nbsp;<span class="op" id="1939698">:=</span>&nbsp;<span class="op" id="1939701">(</span><span class="op" id="1939702">*</span><span class="ident" id="1939703">functype</span><span class="op" id="1939711">)</span><span class="op" id="1939712">(</span><span class="ident" id="1939713">unsafe</span><span class="op" id="1939719">.</span><span class="ident" id="1939720">Pointer</span><span class="op" id="1939727">(</span><span class="ident" id="1939728">ftyp</span><span class="op" id="1939732">)</span><span class="op" id="1939733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939736">ins</span>&nbsp;<span class="op" id="1939740">:=</span>&nbsp;<span class="op" id="1939743">*</span><span class="op" id="1939744">(</span><span class="op" id="1939745">*</span><span class="op" id="1939746">[</span><span class="op" id="1939747">]</span><span class="op" id="1939748">*</span><span class="ident" id="1939749">_type</span><span class="op" id="1939754">)</span><span class="op" id="1939755">(</span><span class="ident" id="1939756">unsafe</span><span class="op" id="1939762">.</span><span class="ident" id="1939763">Pointer</span><span class="op" id="1939770">(</span><span class="op" id="1939771">&amp;</span><span class="ident" id="1939772">ft</span><span class="op" id="1939774">.</span><span class="ident" id="1939775">in</span><span class="op" id="1939777">)</span><span class="op" id="1939778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939781">if</span>&nbsp;<span class="ident" id="1939784">ft</span><span class="op" id="1939786">.</span><span class="ident" id="1939787">dotdotdot</span>&nbsp;<span class="op" id="1939797">||</span>&nbsp;<span class="builtinfunc" id="1939800">len</span><span class="op" id="1939803">(</span><span class="ident" id="1939804">ins</span><span class="op" id="1939807">)</span>&nbsp;<span class="op" id="1939809">!=</span>&nbsp;<span class="num" id="1939812">1</span>&nbsp;<span class="op" id="1939814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939818">gothrow</span><span class="op" id="1939825">(</span><span class="string" id="1939826">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1939863">+</span>&nbsp;<span class="op" id="1939865">*</span><span class="ident" id="1939866">etyp</span><span class="op" id="1939870">.</span><span class="ident" id="1939871">_string</span>&nbsp;<span class="op" id="1939879">+</span>&nbsp;<span class="string" id="1939881">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1939898">+</span>&nbsp;<span class="op" id="1939900">*</span><span class="ident" id="1939901">ftyp</span><span class="op" id="1939905">.</span><span class="ident" id="1939906">_string</span><span class="op" id="1939913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1939916">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1939919">fint</span>&nbsp;<span class="op" id="1939924">:=</span>&nbsp;<span class="ident" id="1939927">ins</span><span class="op" id="1939930">[</span><span class="num" id="1939931">0</span><span class="op" id="1939932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939935">switch</span>&nbsp;<span class="op" id="1939942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939945">case</span>&nbsp;<span class="ident" id="1939950">fint</span>&nbsp;<span class="op" id="1939955">==</span>&nbsp;<span class="ident" id="1939958">etyp</span><span class="op" id="1939962">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1939966">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939986">goto</span>&nbsp;<span class="ident" id="1939991">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1939998">case</span>&nbsp;<span class="ident" id="1940003">fint</span><span class="op" id="1940007">.</span><span class="ident" id="1940008">kind</span><span class="op" id="1940012">&amp;</span><span class="ident" id="1940013">kindMask</span>&nbsp;<span class="op" id="1940022">==</span>&nbsp;<span class="ident" id="1940025">kindPtr</span><span class="op" id="1940032">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940036">if</span>&nbsp;<span class="op" id="1940039">(</span><span class="ident" id="1940040">fint</span><span class="op" id="1940044">.</span><span class="ident" id="1940045">x</span>&nbsp;<span class="op" id="1940047">==</span>&nbsp;<span class="ident" id="1940050">nil</span>&nbsp;<span class="op" id="1940054">||</span>&nbsp;<span class="ident" id="1940057">fint</span><span class="op" id="1940061">.</span><span class="ident" id="1940062">x</span><span class="op" id="1940063">.</span><span class="ident" id="1940064">name</span>&nbsp;<span class="op" id="1940069">==</span>&nbsp;<span class="ident" id="1940072">nil</span>&nbsp;<span class="op" id="1940076">||</span>&nbsp;<span class="ident" id="1940079">etyp</span><span class="op" id="1940083">.</span><span class="ident" id="1940084">x</span>&nbsp;<span class="op" id="1940086">==</span>&nbsp;<span class="ident" id="1940089">nil</span>&nbsp;<span class="op" id="1940093">||</span>&nbsp;<span class="ident" id="1940096">etyp</span><span class="op" id="1940100">.</span><span class="ident" id="1940101">x</span><span class="op" id="1940102">.</span><span class="ident" id="1940103">name</span>&nbsp;<span class="op" id="1940108">==</span>&nbsp;<span class="ident" id="1940111">nil</span><span class="op" id="1940114">)</span>&nbsp;<span class="op" id="1940116">&amp;&amp;</span>&nbsp;<span class="op" id="1940119">(</span><span class="op" id="1940120">*</span><span class="ident" id="1940121">ptrtype</span><span class="op" id="1940128">)</span><span class="op" id="1940129">(</span><span class="ident" id="1940130">unsafe</span><span class="op" id="1940136">.</span><span class="ident" id="1940137">Pointer</span><span class="op" id="1940144">(</span><span class="ident" id="1940145">fint</span><span class="op" id="1940149">)</span><span class="op" id="1940150">)</span><span class="op" id="1940151">.</span><span class="ident" id="1940152">elem</span>&nbsp;<span class="op" id="1940157">==</span>&nbsp;<span class="ident" id="1940160">ot</span><span class="op" id="1940162">.</span><span class="ident" id="1940163">elem</span>&nbsp;<span class="op" id="1940168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1940173">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1940218">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940291">goto</span>&nbsp;<span class="ident" id="1940296">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1940304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940307">case</span>&nbsp;<span class="ident" id="1940312">fint</span><span class="op" id="1940316">.</span><span class="ident" id="1940317">kind</span><span class="op" id="1940321">&amp;</span><span class="ident" id="1940322">kindMask</span>&nbsp;<span class="op" id="1940331">==</span>&nbsp;<span class="ident" id="1940334">kindInterface</span><span class="op" id="1940347">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940351">ityp</span>&nbsp;<span class="op" id="1940356">:=</span>&nbsp;<span class="op" id="1940359">(</span><span class="op" id="1940360">*</span><span class="ident" id="1940361">interfacetype</span><span class="op" id="1940374">)</span><span class="op" id="1940375">(</span><span class="ident" id="1940376">unsafe</span><span class="op" id="1940382">.</span><span class="ident" id="1940383">Pointer</span><span class="op" id="1940390">(</span><span class="ident" id="1940391">fint</span><span class="op" id="1940395">)</span><span class="op" id="1940396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940400">if</span>&nbsp;<span class="builtinfunc" id="1940403">len</span><span class="op" id="1940406">(</span><span class="ident" id="1940407">ityp</span><span class="op" id="1940411">.</span><span class="ident" id="1940412">mhdr</span><span class="op" id="1940416">)</span>&nbsp;<span class="op" id="1940418">==</span>&nbsp;<span class="num" id="1940421">0</span>&nbsp;<span class="op" id="1940423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1940428">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940465">goto</span>&nbsp;<span class="ident" id="1940470">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1940478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940482">if</span>&nbsp;<span class="ident" id="1940485">_</span><span class="op" id="1940486">,</span>&nbsp;<span class="ident" id="1940488">ok</span>&nbsp;<span class="op" id="1940491">:=</span>&nbsp;<span class="ident" id="1940494">assertE2I2</span><span class="op" id="1940504">(</span><span class="ident" id="1940505">ityp</span><span class="op" id="1940509">,</span>&nbsp;<span class="ident" id="1940511">obj</span><span class="op" id="1940514">)</span><span class="op" id="1940515">;</span>&nbsp;<span class="ident" id="1940517">ok</span>&nbsp;<span class="op" id="1940520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940525">goto</span>&nbsp;<span class="ident" id="1940530">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1940538">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1940541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940544">gothrow</span><span class="op" id="1940551">(</span><span class="string" id="1940552">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1940589">+</span>&nbsp;<span class="op" id="1940591">*</span><span class="ident" id="1940592">etyp</span><span class="op" id="1940596">.</span><span class="ident" id="1940597">_string</span>&nbsp;<span class="op" id="1940605">+</span>&nbsp;<span class="string" id="1940607">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1940624">+</span>&nbsp;<span class="op" id="1940626">*</span><span class="ident" id="1940627">ftyp</span><span class="op" id="1940631">.</span><span class="ident" id="1940632">_string</span><span class="op" id="1940639">)</span><br>
<span class="lineno"></span><span class="ident" id="1940641">okarg</span><span class="op" id="1940646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1940649">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940695">nret</span>&nbsp;<span class="op" id="1940700">:=</span>&nbsp;<span class="builtintype" id="1940703">uintptr</span><span class="op" id="1940710">(</span><span class="num" id="1940711">0</span><span class="op" id="1940712">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1940715">for</span>&nbsp;<span class="ident" id="1940719">_</span><span class="op" id="1940720">,</span>&nbsp;<span class="ident" id="1940722">t</span>&nbsp;<span class="op" id="1940724">:=</span>&nbsp;<span class="keyword" id="1940727">range</span>&nbsp;<span class="op" id="1940733">*</span><span class="op" id="1940734">(</span><span class="op" id="1940735">*</span><span class="op" id="1940736">[</span><span class="op" id="1940737">]</span><span class="op" id="1940738">*</span><span class="ident" id="1940739">_type</span><span class="op" id="1940744">)</span><span class="op" id="1940745">(</span><span class="ident" id="1940746">unsafe</span><span class="op" id="1940752">.</span><span class="ident" id="1940753">Pointer</span><span class="op" id="1940760">(</span><span class="op" id="1940761">&amp;</span><span class="ident" id="1940762">ft</span><span class="op" id="1940764">.</span><span class="ident" id="1940765">out</span><span class="op" id="1940768">)</span><span class="op" id="1940769">)</span>&nbsp;<span class="op" id="1940771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940775">nret</span>&nbsp;<span class="op" id="1940780">=</span>&nbsp;<span class="ident" id="1940782">round</span><span class="op" id="1940787">(</span><span class="ident" id="1940788">nret</span><span class="op" id="1940792">,</span>&nbsp;<span class="builtintype" id="1940794">uintptr</span><span class="op" id="1940801">(</span><span class="ident" id="1940802">t</span><span class="op" id="1940803">.</span><span class="ident" id="1940804">align</span><span class="op" id="1940809">)</span><span class="op" id="1940810">)</span>&nbsp;<span class="op" id="1940812">+</span>&nbsp;<span class="builtintype" id="1940814">uintptr</span><span class="op" id="1940821">(</span><span class="ident" id="1940822">t</span><span class="op" id="1940823">.</span><span class="ident" id="1940824">size</span><span class="op" id="1940828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1940831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940834">nret</span>&nbsp;<span class="op" id="1940839">=</span>&nbsp;<span class="ident" id="1940841">round</span><span class="op" id="1940846">(</span><span class="ident" id="1940847">nret</span><span class="op" id="1940851">,</span>&nbsp;<span class="ident" id="1940853">ptrSize</span><span class="op" id="1940860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1940864">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940908">createfing</span><span class="op" id="1940918">(</span><span class="op" id="1940919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1940923">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940969">mp</span>&nbsp;<span class="op" id="1940972">:=</span>&nbsp;<span class="ident" id="1940975">acquirem</span><span class="op" id="1940983">(</span><span class="op" id="1940984">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1940987">mp</span><span class="op" id="1940989">.</span><span class="ident" id="1940990">ptrarg</span><span class="op" id="1940996">[</span><span class="num" id="1940997">0</span><span class="op" id="1940998">]</span>&nbsp;<span class="op" id="1941000">=</span>&nbsp;<span class="ident" id="1941002">f</span><span class="op" id="1941003">.</span><span class="ident" id="1941004">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941010">mp</span><span class="op" id="1941012">.</span><span class="ident" id="1941013">ptrarg</span><span class="op" id="1941019">[</span><span class="num" id="1941020">1</span><span class="op" id="1941021">]</span>&nbsp;<span class="op" id="1941023">=</span>&nbsp;<span class="ident" id="1941025">e</span><span class="op" id="1941026">.</span><span class="ident" id="1941027">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941033">mp</span><span class="op" id="1941035">.</span><span class="ident" id="1941036">scalararg</span><span class="op" id="1941045">[</span><span class="num" id="1941046">0</span><span class="op" id="1941047">]</span>&nbsp;<span class="op" id="1941049">=</span>&nbsp;<span class="ident" id="1941051">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941057">mp</span><span class="op" id="1941059">.</span><span class="ident" id="1941060">ptrarg</span><span class="op" id="1941066">[</span><span class="num" id="1941067">2</span><span class="op" id="1941068">]</span>&nbsp;<span class="op" id="1941070">=</span>&nbsp;<span class="ident" id="1941072">unsafe</span><span class="op" id="1941078">.</span><span class="ident" id="1941079">Pointer</span><span class="op" id="1941086">(</span><span class="ident" id="1941087">fint</span><span class="op" id="1941091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941094">mp</span><span class="op" id="1941096">.</span><span class="ident" id="1941097">ptrarg</span><span class="op" id="1941103">[</span><span class="num" id="1941104">3</span><span class="op" id="1941105">]</span>&nbsp;<span class="op" id="1941107">=</span>&nbsp;<span class="ident" id="1941109">unsafe</span><span class="op" id="1941115">.</span><span class="ident" id="1941116">Pointer</span><span class="op" id="1941123">(</span><span class="ident" id="1941124">ot</span><span class="op" id="1941126">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941129">onM</span><span class="op" id="1941132">(</span><span class="ident" id="1941133">setFinalizer_m</span><span class="op" id="1941147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1941150">if</span>&nbsp;<span class="ident" id="1941153">mp</span><span class="op" id="1941155">.</span><span class="ident" id="1941156">scalararg</span><span class="op" id="1941165">[</span><span class="num" id="1941166">0</span><span class="op" id="1941167">]</span>&nbsp;<span class="op" id="1941169">!=</span>&nbsp;<span class="num" id="1941172">1</span>&nbsp;<span class="op" id="1941174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941178">gothrow</span><span class="op" id="1941185">(</span><span class="string" id="1941186">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1941231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1941234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941237">releasem</span><span class="op" id="1941245">(</span><span class="ident" id="1941246">mp</span><span class="op" id="1941248">)</span><br>
<span class="lineno">655</span><span class="op" id="1941250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1941253">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1941312">func</span>&nbsp;<span class="ident" id="1941317">round</span><span class="op" id="1941322">(</span><span class="ident" id="1941323">n</span><span class="op" id="1941324">,</span>&nbsp;<span class="ident" id="1941326">a</span>&nbsp;<span class="builtintype" id="1941328">uintptr</span><span class="op" id="1941335">)</span>&nbsp;<span class="builtintype" id="1941337">uintptr</span>&nbsp;<span class="op" id="1941345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1941348">return</span>&nbsp;<span class="op" id="1941355">(</span><span class="ident" id="1941356">n</span>&nbsp;<span class="op" id="1941358">+</span>&nbsp;<span class="ident" id="1941360">a</span>&nbsp;<span class="op" id="1941362">-</span>&nbsp;<span class="num" id="1941364">1</span><span class="op" id="1941365">)</span>&nbsp;<span class="op" id="1941367">&amp;^</span>&nbsp;<span class="op" id="1941370">(</span><span class="ident" id="1941371">a</span>&nbsp;<span class="op" id="1941373">-</span>&nbsp;<span class="num" id="1941375">1</span><span class="op" id="1941376">)</span><br>
<span class="lineno">660</span><span class="op" id="1941378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1941381">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1941451">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1941522">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1941561">func</span>&nbsp;<span class="ident" id="1941566">findObject</span><span class="op" id="1941576">(</span><span class="ident" id="1941577">v</span>&nbsp;<span class="ident" id="1941579">unsafe</span><span class="op" id="1941585">.</span><span class="ident" id="1941586">Pointer</span><span class="op" id="1941593">)</span>&nbsp;<span class="op" id="1941595">(</span><span class="ident" id="1941596">s</span>&nbsp;<span class="op" id="1941598">*</span><span class="ident" id="1941599">mspan</span><span class="op" id="1941604">,</span>&nbsp;<span class="ident" id="1941606">x</span>&nbsp;<span class="ident" id="1941608">unsafe</span><span class="op" id="1941614">.</span><span class="ident" id="1941615">Pointer</span><span class="op" id="1941622">,</span>&nbsp;<span class="ident" id="1941624">n</span>&nbsp;<span class="builtintype" id="1941626">uintptr</span><span class="op" id="1941633">)</span>&nbsp;<span class="op" id="1941635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941638">c</span>&nbsp;<span class="op" id="1941640">:=</span>&nbsp;<span class="ident" id="1941643">gomcache</span><span class="op" id="1941651">(</span><span class="op" id="1941652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941655">c</span><span class="op" id="1941656">.</span><span class="ident" id="1941657">local_nlookup</span><span class="op" id="1941670">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1941674">if</span>&nbsp;<span class="ident" id="1941677">ptrSize</span>&nbsp;<span class="op" id="1941685">==</span>&nbsp;<span class="num" id="1941688">4</span>&nbsp;<span class="op" id="1941690">&amp;&amp;</span>&nbsp;<span class="ident" id="1941693">c</span><span class="op" id="1941694">.</span><span class="ident" id="1941695">local_nlookup</span>&nbsp;<span class="op" id="1941709">&gt;=</span>&nbsp;<span class="num" id="1941712">1</span><span class="op" id="1941713">&lt;&lt;</span><span class="num" id="1941715">30</span>&nbsp;<span class="op" id="1941718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1941722">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941765">lock</span><span class="op" id="1941769">(</span><span class="op" id="1941770">&amp;</span><span class="ident" id="1941771">mheap_</span><span class="op" id="1941777">.</span><span class="ident" id="1941778">lock</span><span class="op" id="1941782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941786">purgecachedstats</span><span class="op" id="1941802">(</span><span class="ident" id="1941803">c</span><span class="op" id="1941804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941808">unlock</span><span class="op" id="1941814">(</span><span class="op" id="1941815">&amp;</span><span class="ident" id="1941816">mheap_</span><span class="op" id="1941822">.</span><span class="ident" id="1941823">lock</span><span class="op" id="1941827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1941830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1941834">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941848">arena_start</span>&nbsp;<span class="op" id="1941860">:=</span>&nbsp;<span class="builtintype" id="1941863">uintptr</span><span class="op" id="1941870">(</span><span class="ident" id="1941871">unsafe</span><span class="op" id="1941877">.</span><span class="ident" id="1941878">Pointer</span><span class="op" id="1941885">(</span><span class="ident" id="1941886">mheap_</span><span class="op" id="1941892">.</span><span class="ident" id="1941893">arena_start</span><span class="op" id="1941904">)</span><span class="op" id="1941905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1941908">arena_used</span>&nbsp;<span class="op" id="1941919">:=</span>&nbsp;<span class="builtintype" id="1941922">uintptr</span><span class="op" id="1941929">(</span><span class="ident" id="1941930">unsafe</span><span class="op" id="1941936">.</span><span class="ident" id="1941937">Pointer</span><span class="op" id="1941944">(</span><span class="ident" id="1941945">mheap_</span><span class="op" id="1941951">.</span><span class="ident" id="1941952">arena_used</span><span class="op" id="1941962">)</span><span class="op" id="1941963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1941966">if</span>&nbsp;<span class="builtintype" id="1941969">uintptr</span><span class="op" id="1941976">(</span><span class="ident" id="1941977">v</span><span class="op" id="1941978">)</span>&nbsp;<span class="op" id="1941980">&lt;</span>&nbsp;<span class="ident" id="1941982">arena_start</span>&nbsp;<span class="op" id="1941994">||</span>&nbsp;<span class="builtintype" id="1941997">uintptr</span><span class="op" id="1942004">(</span><span class="ident" id="1942005">v</span><span class="op" id="1942006">)</span>&nbsp;<span class="op" id="1942008">&gt;=</span>&nbsp;<span class="ident" id="1942011">arena_used</span>&nbsp;<span class="op" id="1942022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942026">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942037">p</span>&nbsp;<span class="op" id="1942039">:=</span>&nbsp;<span class="builtintype" id="1942042">uintptr</span><span class="op" id="1942049">(</span><span class="ident" id="1942050">v</span><span class="op" id="1942051">)</span>&nbsp;<span class="op" id="1942053">&gt;&gt;</span>&nbsp;<span class="ident" id="1942056">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942067">q</span>&nbsp;<span class="op" id="1942069">:=</span>&nbsp;<span class="ident" id="1942072">p</span>&nbsp;<span class="op" id="1942074">-</span>&nbsp;<span class="ident" id="1942076">arena_start</span><span class="op" id="1942087">&gt;&gt;</span><span class="ident" id="1942089">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942100">s</span>&nbsp;<span class="op" id="1942102">=</span>&nbsp;<span class="op" id="1942104">*</span><span class="op" id="1942105">(</span><span class="op" id="1942106">*</span><span class="op" id="1942107">*</span><span class="ident" id="1942108">mspan</span><span class="op" id="1942113">)</span><span class="op" id="1942114">(</span><span class="ident" id="1942115">add</span><span class="op" id="1942118">(</span><span class="ident" id="1942119">unsafe</span><span class="op" id="1942125">.</span><span class="ident" id="1942126">Pointer</span><span class="op" id="1942133">(</span><span class="ident" id="1942134">mheap_</span><span class="op" id="1942140">.</span><span class="ident" id="1942141">spans</span><span class="op" id="1942146">)</span><span class="op" id="1942147">,</span>&nbsp;<span class="ident" id="1942149">q</span><span class="op" id="1942150">*</span><span class="ident" id="1942151">ptrSize</span><span class="op" id="1942158">)</span><span class="op" id="1942159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942162">if</span>&nbsp;<span class="ident" id="1942165">s</span>&nbsp;<span class="op" id="1942167">==</span>&nbsp;<span class="ident" id="1942170">nil</span>&nbsp;<span class="op" id="1942174">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942178">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942189">x</span>&nbsp;<span class="op" id="1942191">=</span>&nbsp;<span class="ident" id="1942193">unsafe</span><span class="op" id="1942199">.</span><span class="ident" id="1942200">Pointer</span><span class="op" id="1942207">(</span><span class="builtintype" id="1942208">uintptr</span><span class="op" id="1942215">(</span><span class="ident" id="1942216">s</span><span class="op" id="1942217">.</span><span class="ident" id="1942218">start</span><span class="op" id="1942223">)</span>&nbsp;<span class="op" id="1942225">&lt;&lt;</span>&nbsp;<span class="ident" id="1942228">pageShift</span><span class="op" id="1942237">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942241">if</span>&nbsp;<span class="builtintype" id="1942244">uintptr</span><span class="op" id="1942251">(</span><span class="ident" id="1942252">v</span><span class="op" id="1942253">)</span>&nbsp;<span class="op" id="1942255">&lt;</span>&nbsp;<span class="builtintype" id="1942257">uintptr</span><span class="op" id="1942264">(</span><span class="ident" id="1942265">x</span><span class="op" id="1942266">)</span>&nbsp;<span class="op" id="1942268">||</span>&nbsp;<span class="builtintype" id="1942271">uintptr</span><span class="op" id="1942278">(</span><span class="ident" id="1942279">v</span><span class="op" id="1942280">)</span>&nbsp;<span class="op" id="1942282">&gt;=</span>&nbsp;<span class="builtintype" id="1942285">uintptr</span><span class="op" id="1942292">(</span><span class="ident" id="1942293">unsafe</span><span class="op" id="1942299">.</span><span class="ident" id="1942300">Pointer</span><span class="op" id="1942307">(</span><span class="ident" id="1942308">s</span><span class="op" id="1942309">.</span><span class="ident" id="1942310">limit</span><span class="op" id="1942315">)</span><span class="op" id="1942316">)</span>&nbsp;<span class="op" id="1942318">||</span>&nbsp;<span class="ident" id="1942321">s</span><span class="op" id="1942322">.</span><span class="ident" id="1942323">state</span>&nbsp;<span class="op" id="1942329">!=</span>&nbsp;<span class="ident" id="1942332">mSpanInUse</span>&nbsp;<span class="op" id="1942343">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942347">s</span>&nbsp;<span class="op" id="1942349">=</span>&nbsp;<span class="ident" id="1942351">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942357">x</span>&nbsp;<span class="op" id="1942359">=</span>&nbsp;<span class="ident" id="1942361">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942367">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942379">n</span>&nbsp;<span class="op" id="1942381">=</span>&nbsp;<span class="builtintype" id="1942383">uintptr</span><span class="op" id="1942390">(</span><span class="ident" id="1942391">s</span><span class="op" id="1942392">.</span><span class="ident" id="1942393">elemsize</span><span class="op" id="1942401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942404">if</span>&nbsp;<span class="ident" id="1942407">s</span><span class="op" id="1942408">.</span><span class="ident" id="1942409">sizeclass</span>&nbsp;<span class="op" id="1942419">!=</span>&nbsp;<span class="num" id="1942422">0</span>&nbsp;<span class="op" id="1942424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942428">x</span>&nbsp;<span class="op" id="1942430">=</span>&nbsp;<span class="ident" id="1942432">add</span><span class="op" id="1942435">(</span><span class="ident" id="1942436">x</span><span class="op" id="1942437">,</span>&nbsp;<span class="op" id="1942439">(</span><span class="builtintype" id="1942440">uintptr</span><span class="op" id="1942447">(</span><span class="ident" id="1942448">v</span><span class="op" id="1942449">)</span><span class="op" id="1942450">-</span><span class="builtintype" id="1942451">uintptr</span><span class="op" id="1942458">(</span><span class="ident" id="1942459">x</span><span class="op" id="1942460">)</span><span class="op" id="1942461">)</span><span class="op" id="1942462">/</span><span class="ident" id="1942463">n</span><span class="op" id="1942464">*</span><span class="ident" id="1942465">n</span><span class="op" id="1942466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942472">return</span><br>
<span class="lineno">700</span><span class="op" id="1942479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1942482">var</span>&nbsp;<span class="ident" id="1942486">fingCreate</span>&nbsp;<span class="builtintype" id="1942497">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1942505">func</span>&nbsp;<span class="ident" id="1942510">createfing</span><span class="op" id="1942520">(</span><span class="op" id="1942521">)</span>&nbsp;<span class="op" id="1942523">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1942526">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942573">if</span>&nbsp;<span class="ident" id="1942576">fingCreate</span>&nbsp;<span class="op" id="1942587">==</span>&nbsp;<span class="num" id="1942590">0</span>&nbsp;<span class="op" id="1942592">&amp;&amp;</span>&nbsp;<span class="ident" id="1942595">cas</span><span class="op" id="1942598">(</span><span class="op" id="1942599">&amp;</span><span class="ident" id="1942600">fingCreate</span><span class="op" id="1942610">,</span>&nbsp;<span class="num" id="1942612">0</span><span class="op" id="1942613">,</span>&nbsp;<span class="num" id="1942615">1</span><span class="op" id="1942616">)</span>&nbsp;<span class="op" id="1942618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942622">go</span>&nbsp;<span class="ident" id="1942625">runfinq</span><span class="op" id="1942632">(</span><span class="op" id="1942633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942636">}</span><br>
<span class="lineno"></span><span class="op" id="1942638">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1942641">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1942698">func</span>&nbsp;<span class="ident" id="1942703">runfinq</span><span class="op" id="1942710">(</span><span class="op" id="1942711">)</span>&nbsp;<span class="op" id="1942713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942716">var</span>&nbsp;<span class="op" id="1942720">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942724">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1942733">unsafe</span><span class="op" id="1942739">.</span><span class="ident" id="1942740">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942750">framecap</span>&nbsp;<span class="builtintype" id="1942759">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942772">for</span>&nbsp;<span class="op" id="1942776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942780">lock</span><span class="op" id="1942784">(</span><span class="op" id="1942785">&amp;</span><span class="ident" id="1942786">finlock</span><span class="op" id="1942793">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942797">fb</span>&nbsp;<span class="op" id="1942800">:=</span>&nbsp;<span class="ident" id="1942803">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942810">finq</span>&nbsp;<span class="op" id="1942815">=</span>&nbsp;<span class="ident" id="1942817">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942823">if</span>&nbsp;<span class="ident" id="1942826">fb</span>&nbsp;<span class="op" id="1942829">==</span>&nbsp;<span class="ident" id="1942832">nil</span>&nbsp;<span class="op" id="1942836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942841">gp</span>&nbsp;<span class="op" id="1942844">:=</span>&nbsp;<span class="ident" id="1942847">getg</span><span class="op" id="1942851">(</span><span class="op" id="1942852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942857">fing</span>&nbsp;<span class="op" id="1942862">=</span>&nbsp;<span class="ident" id="1942864">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942870">fingwait</span>&nbsp;<span class="op" id="1942879">=</span>&nbsp;<span class="builtintype" id="1942881">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942889">gp</span><span class="op" id="1942891">.</span><span class="ident" id="1942892">issystem</span>&nbsp;<span class="op" id="1942901">=</span>&nbsp;<span class="builtintype" id="1942903">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942911">goparkunlock</span><span class="op" id="1942923">(</span><span class="op" id="1942924">&amp;</span><span class="ident" id="1942925">finlock</span><span class="op" id="1942932">,</span>&nbsp;<span class="string" id="1942934">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1942950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942955">gp</span><span class="op" id="1942957">.</span><span class="ident" id="1942958">issystem</span>&nbsp;<span class="op" id="1942967">=</span>&nbsp;<span class="builtintype" id="1942969">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1942978">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1942989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1942993">unlock</span><span class="op" id="1942999">(</span><span class="op" id="1943000">&amp;</span><span class="ident" id="1943001">finlock</span><span class="op" id="1943008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943012">if</span>&nbsp;<span class="ident" id="1943015">raceenabled</span>&nbsp;<span class="op" id="1943027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943032">racefingo</span><span class="op" id="1943041">(</span><span class="op" id="1943042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1943046">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943050">for</span>&nbsp;<span class="ident" id="1943054">fb</span>&nbsp;<span class="op" id="1943057">!=</span>&nbsp;<span class="ident" id="1943060">nil</span>&nbsp;<span class="op" id="1943064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943069">for</span>&nbsp;<span class="ident" id="1943073">i</span>&nbsp;<span class="op" id="1943075">:=</span>&nbsp;<span class="builtintype" id="1943078">int32</span><span class="op" id="1943083">(</span><span class="num" id="1943084">0</span><span class="op" id="1943085">)</span><span class="op" id="1943086">;</span>&nbsp;<span class="ident" id="1943088">i</span>&nbsp;<span class="op" id="1943090">&lt;</span>&nbsp;<span class="ident" id="1943092">fb</span><span class="op" id="1943094">.</span><span class="ident" id="1943095">cnt</span><span class="op" id="1943098">;</span>&nbsp;<span class="ident" id="1943100">i</span><span class="op" id="1943101">++</span>&nbsp;<span class="op" id="1943104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943110">f</span>&nbsp;<span class="op" id="1943112">:=</span>&nbsp;<span class="op" id="1943115">(</span><span class="op" id="1943116">*</span><span class="ident" id="1943117">finalizer</span><span class="op" id="1943126">)</span><span class="op" id="1943127">(</span><span class="ident" id="1943128">add</span><span class="op" id="1943131">(</span><span class="ident" id="1943132">unsafe</span><span class="op" id="1943138">.</span><span class="ident" id="1943139">Pointer</span><span class="op" id="1943146">(</span><span class="op" id="1943147">&amp;</span><span class="ident" id="1943148">fb</span><span class="op" id="1943150">.</span><span class="ident" id="1943151">fin</span><span class="op" id="1943154">)</span><span class="op" id="1943155">,</span>&nbsp;<span class="builtintype" id="1943157">uintptr</span><span class="op" id="1943164">(</span><span class="ident" id="1943165">i</span><span class="op" id="1943166">)</span><span class="op" id="1943167">*</span><span class="ident" id="1943168">unsafe</span><span class="op" id="1943174">.</span><span class="ident" id="1943175">Sizeof</span><span class="op" id="1943181">(</span><span class="ident" id="1943182">finalizer</span><span class="op" id="1943191">{</span><span class="op" id="1943192">}</span><span class="op" id="1943193">)</span><span class="op" id="1943194">)</span><span class="op" id="1943195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943202">framesz</span>&nbsp;<span class="op" id="1943210">:=</span>&nbsp;<span class="ident" id="1943213">unsafe</span><span class="op" id="1943219">.</span><span class="ident" id="1943220">Sizeof</span><span class="op" id="1943226">(</span><span class="op" id="1943227">(</span><span class="keyword" id="1943228">interface</span><span class="op" id="1943237">{</span><span class="op" id="1943238">}</span><span class="op" id="1943239">)</span><span class="op" id="1943240">(</span><span class="ident" id="1943241">nil</span><span class="op" id="1943244">)</span><span class="op" id="1943245">)</span>&nbsp;<span class="op" id="1943247">+</span>&nbsp;<span class="builtintype" id="1943249">uintptr</span><span class="op" id="1943256">(</span><span class="ident" id="1943257">f</span><span class="op" id="1943258">.</span><span class="ident" id="1943259">nret</span><span class="op" id="1943263">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943269">if</span>&nbsp;<span class="ident" id="1943272">framecap</span>&nbsp;<span class="op" id="1943281">&lt;</span>&nbsp;<span class="ident" id="1943283">framesz</span>&nbsp;<span class="op" id="1943291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1943298">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1943362">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1943420">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1943464">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943516">frame</span>&nbsp;<span class="op" id="1943522">=</span>&nbsp;<span class="ident" id="1943524">mallocgc</span><span class="op" id="1943532">(</span><span class="ident" id="1943533">framesz</span><span class="op" id="1943540">,</span>&nbsp;<span class="ident" id="1943542">nil</span><span class="op" id="1943545">,</span>&nbsp;<span class="ident" id="1943547">flagNoScan</span><span class="op" id="1943557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943564">framecap</span>&nbsp;<span class="op" id="1943573">=</span>&nbsp;<span class="ident" id="1943575">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1943587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943594">if</span>&nbsp;<span class="ident" id="1943597">f</span><span class="op" id="1943598">.</span><span class="ident" id="1943599">fint</span>&nbsp;<span class="op" id="1943604">==</span>&nbsp;<span class="ident" id="1943607">nil</span>&nbsp;<span class="op" id="1943611">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943618">gothrow</span><span class="op" id="1943625">(</span><span class="string" id="1943626">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1943651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1943657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943663">switch</span>&nbsp;<span class="ident" id="1943670">f</span><span class="op" id="1943671">.</span><span class="ident" id="1943672">fint</span><span class="op" id="1943676">.</span><span class="ident" id="1943677">kind</span>&nbsp;<span class="op" id="1943682">&amp;</span>&nbsp;<span class="ident" id="1943684">kindMask</span>&nbsp;<span class="op" id="1943693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943699">case</span>&nbsp;<span class="ident" id="1943704">kindPtr</span><span class="op" id="1943711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1943718">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1943748">*</span><span class="op" id="1943749">(</span><span class="op" id="1943750">*</span><span class="ident" id="1943751">unsafe</span><span class="op" id="1943757">.</span><span class="ident" id="1943758">Pointer</span><span class="op" id="1943765">)</span><span class="op" id="1943766">(</span><span class="ident" id="1943767">frame</span><span class="op" id="1943772">)</span>&nbsp;<span class="op" id="1943774">=</span>&nbsp;<span class="ident" id="1943776">f</span><span class="op" id="1943777">.</span><span class="ident" id="1943778">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943786">case</span>&nbsp;<span class="ident" id="1943791">kindInterface</span><span class="op" id="1943804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1943811">ityp</span>&nbsp;<span class="op" id="1943816">:=</span>&nbsp;<span class="op" id="1943819">(</span><span class="op" id="1943820">*</span><span class="ident" id="1943821">interfacetype</span><span class="op" id="1943834">)</span><span class="op" id="1943835">(</span><span class="ident" id="1943836">unsafe</span><span class="op" id="1943842">.</span><span class="ident" id="1943843">Pointer</span><span class="op" id="1943850">(</span><span class="ident" id="1943851">f</span><span class="op" id="1943852">.</span><span class="ident" id="1943853">fint</span><span class="op" id="1943857">)</span><span class="op" id="1943858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1943865">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1943901">(</span><span class="op" id="1943902">*</span><span class="ident" id="1943903">eface</span><span class="op" id="1943908">)</span><span class="op" id="1943909">(</span><span class="ident" id="1943910">frame</span><span class="op" id="1943915">)</span><span class="op" id="1943916">.</span><span class="ident" id="1943917">_type</span>&nbsp;<span class="op" id="1943923">=</span>&nbsp;<span class="op" id="1943925">&amp;</span><span class="ident" id="1943926">f</span><span class="op" id="1943927">.</span><span class="ident" id="1943928">ot</span><span class="op" id="1943930">.</span><span class="ident" id="1943931">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1943940">(</span><span class="op" id="1943941">*</span><span class="ident" id="1943942">eface</span><span class="op" id="1943947">)</span><span class="op" id="1943948">(</span><span class="ident" id="1943949">frame</span><span class="op" id="1943954">)</span><span class="op" id="1943955">.</span><span class="ident" id="1943956">data</span>&nbsp;<span class="op" id="1943961">=</span>&nbsp;<span class="ident" id="1943963">f</span><span class="op" id="1943964">.</span><span class="ident" id="1943965">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1943974">if</span>&nbsp;<span class="builtinfunc" id="1943977">len</span><span class="op" id="1943980">(</span><span class="ident" id="1943981">ityp</span><span class="op" id="1943985">.</span><span class="ident" id="1943986">mhdr</span><span class="op" id="1943990">)</span>&nbsp;<span class="op" id="1943992">!=</span>&nbsp;<span class="num" id="1943995">0</span>&nbsp;<span class="op" id="1943997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1944005">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1944048">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1944127">*</span><span class="op" id="1944128">(</span><span class="op" id="1944129">*</span><span class="ident" id="1944130">fInterface</span><span class="op" id="1944140">)</span><span class="op" id="1944141">(</span><span class="ident" id="1944142">frame</span><span class="op" id="1944147">)</span>&nbsp;<span class="op" id="1944149">=</span>&nbsp;<span class="ident" id="1944151">assertE2I</span><span class="op" id="1944160">(</span><span class="ident" id="1944161">ityp</span><span class="op" id="1944165">,</span>&nbsp;<span class="op" id="1944167">*</span><span class="op" id="1944168">(</span><span class="op" id="1944169">*</span><span class="keyword" id="1944170">interface</span><span class="op" id="1944179">{</span><span class="op" id="1944180">}</span><span class="op" id="1944181">)</span><span class="op" id="1944182">(</span><span class="ident" id="1944183">frame</span><span class="op" id="1944188">)</span><span class="op" id="1944189">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1944196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1944202">default</span><span class="op" id="1944209">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944216">gothrow</span><span class="op" id="1944223">(</span><span class="string" id="1944224">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1944245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1944251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944257">reflectcall</span><span class="op" id="1944268">(</span><span class="ident" id="1944269">unsafe</span><span class="op" id="1944275">.</span><span class="ident" id="1944276">Pointer</span><span class="op" id="1944283">(</span><span class="ident" id="1944284">f</span><span class="op" id="1944285">.</span><span class="ident" id="1944286">fn</span><span class="op" id="1944288">)</span><span class="op" id="1944289">,</span>&nbsp;<span class="ident" id="1944291">frame</span><span class="op" id="1944296">,</span>&nbsp;<span class="builtintype" id="1944298">uint32</span><span class="op" id="1944304">(</span><span class="ident" id="1944305">framesz</span><span class="op" id="1944312">)</span><span class="op" id="1944313">,</span>&nbsp;<span class="builtintype" id="1944315">uint32</span><span class="op" id="1944321">(</span><span class="ident" id="1944322">framesz</span><span class="op" id="1944329">)</span><span class="op" id="1944330">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1944337">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944396">f</span><span class="op" id="1944397">.</span><span class="ident" id="1944398">fn</span>&nbsp;<span class="op" id="1944401">=</span>&nbsp;<span class="ident" id="1944403">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944411">f</span><span class="op" id="1944412">.</span><span class="ident" id="1944413">arg</span>&nbsp;<span class="op" id="1944417">=</span>&nbsp;<span class="ident" id="1944419">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944427">f</span><span class="op" id="1944428">.</span><span class="ident" id="1944429">ot</span>&nbsp;<span class="op" id="1944432">=</span>&nbsp;<span class="ident" id="1944434">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1944441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944446">fb</span><span class="op" id="1944448">.</span><span class="ident" id="1944449">cnt</span>&nbsp;<span class="op" id="1944453">=</span>&nbsp;<span class="num" id="1944455">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944460">next</span>&nbsp;<span class="op" id="1944465">:=</span>&nbsp;<span class="ident" id="1944468">fb</span><span class="op" id="1944470">.</span><span class="ident" id="1944471">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944479">lock</span><span class="op" id="1944483">(</span><span class="op" id="1944484">&amp;</span><span class="ident" id="1944485">finlock</span><span class="op" id="1944492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944497">fb</span><span class="op" id="1944499">.</span><span class="ident" id="1944500">next</span>&nbsp;<span class="op" id="1944505">=</span>&nbsp;<span class="ident" id="1944507">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944515">finc</span>&nbsp;<span class="op" id="1944520">=</span>&nbsp;<span class="ident" id="1944522">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944528">unlock</span><span class="op" id="1944534">(</span><span class="op" id="1944535">&amp;</span><span class="ident" id="1944536">finlock</span><span class="op" id="1944543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944548">fb</span>&nbsp;<span class="op" id="1944551">=</span>&nbsp;<span class="ident" id="1944553">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1944560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1944563">}</span><br>
<span class="lineno">785</span><span class="op" id="1944565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1944568">var</span>&nbsp;<span class="ident" id="1944572">persistent</span>&nbsp;<span class="keyword" id="1944583">struct</span>&nbsp;<span class="op" id="1944590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944593">lock</span>&nbsp;<span class="ident" id="1944598">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944605">pos</span>&nbsp;&nbsp;<span class="ident" id="1944610">unsafe</span><span class="op" id="1944616">.</span><span class="ident" id="1944617">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944626">end</span>&nbsp;&nbsp;<span class="ident" id="1944631">unsafe</span><span class="op" id="1944637">.</span><span class="ident" id="1944638">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1944646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1944649">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1944708">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1944750">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1944823">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1944875">func</span>&nbsp;<span class="ident" id="1944880">persistentalloc</span><span class="op" id="1944895">(</span><span class="ident" id="1944896">size</span><span class="op" id="1944900">,</span>&nbsp;<span class="ident" id="1944902">align</span>&nbsp;<span class="builtintype" id="1944908">uintptr</span><span class="op" id="1944915">,</span>&nbsp;<span class="ident" id="1944917">stat</span>&nbsp;<span class="op" id="1944922">*</span><span class="ident" id="1944923">uint64</span><span class="op" id="1944929">)</span>&nbsp;<span class="ident" id="1944931">unsafe</span><span class="op" id="1944937">.</span><span class="ident" id="1944938">Pointer</span>&nbsp;<span class="op" id="1944946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1944949">const</span>&nbsp;<span class="op" id="1944955">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944959">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1944968">=</span>&nbsp;<span class="num" id="1944970">256</span>&nbsp;<span class="op" id="1944974">&lt;&lt;</span>&nbsp;<span class="num" id="1944977">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1944982">maxBlock</span>&nbsp;<span class="op" id="1944991">=</span>&nbsp;<span class="num" id="1944993">64</span>&nbsp;<span class="op" id="1944996">&lt;&lt;</span>&nbsp;<span class="num" id="1944999">10</span>&nbsp;<span class="comment" id="1945002">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945055">if</span>&nbsp;<span class="ident" id="1945058">align</span>&nbsp;<span class="op" id="1945064">!=</span>&nbsp;<span class="num" id="1945067">0</span>&nbsp;<span class="op" id="1945069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945073">if</span>&nbsp;<span class="ident" id="1945076">align</span><span class="op" id="1945081">&amp;</span><span class="op" id="1945082">(</span><span class="ident" id="1945083">align</span><span class="op" id="1945088">-</span><span class="num" id="1945089">1</span><span class="op" id="1945090">)</span>&nbsp;<span class="op" id="1945092">!=</span>&nbsp;<span class="num" id="1945095">0</span>&nbsp;<span class="op" id="1945097">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945102">gothrow</span><span class="op" id="1945109">(</span><span class="string" id="1945110">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1945154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945162">if</span>&nbsp;<span class="ident" id="1945165">align</span>&nbsp;<span class="op" id="1945171">&gt;</span>&nbsp;<span class="ident" id="1945173">_PageSize</span>&nbsp;<span class="op" id="1945183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945188">gothrow</span><span class="op" id="1945195">(</span><span class="string" id="1945196">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1945233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945237">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945240">}</span>&nbsp;<span class="keyword" id="1945242">else</span>&nbsp;<span class="op" id="1945247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945251">align</span>&nbsp;<span class="op" id="1945257">=</span>&nbsp;<span class="num" id="1945259">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945266">if</span>&nbsp;<span class="ident" id="1945269">size</span>&nbsp;<span class="op" id="1945274">&gt;=</span>&nbsp;<span class="ident" id="1945277">maxBlock</span>&nbsp;<span class="op" id="1945286">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945290">return</span>&nbsp;<span class="ident" id="1945297">sysAlloc</span><span class="op" id="1945305">(</span><span class="ident" id="1945306">size</span><span class="op" id="1945310">,</span>&nbsp;<span class="ident" id="1945312">stat</span><span class="op" id="1945316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945323">lock</span><span class="op" id="1945327">(</span><span class="op" id="1945328">&amp;</span><span class="ident" id="1945329">persistent</span><span class="op" id="1945339">.</span><span class="ident" id="1945340">lock</span><span class="op" id="1945344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945347">persistent</span><span class="op" id="1945357">.</span><span class="ident" id="1945358">pos</span>&nbsp;<span class="op" id="1945362">=</span>&nbsp;<span class="ident" id="1945364">roundup</span><span class="op" id="1945371">(</span><span class="ident" id="1945372">persistent</span><span class="op" id="1945382">.</span><span class="ident" id="1945383">pos</span><span class="op" id="1945386">,</span>&nbsp;<span class="ident" id="1945388">align</span><span class="op" id="1945393">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945396">if</span>&nbsp;<span class="builtintype" id="1945399">uintptr</span><span class="op" id="1945406">(</span><span class="ident" id="1945407">persistent</span><span class="op" id="1945417">.</span><span class="ident" id="1945418">pos</span><span class="op" id="1945421">)</span><span class="op" id="1945422">+</span><span class="ident" id="1945423">size</span>&nbsp;<span class="op" id="1945428">&gt;</span>&nbsp;<span class="builtintype" id="1945430">uintptr</span><span class="op" id="1945437">(</span><span class="ident" id="1945438">persistent</span><span class="op" id="1945448">.</span><span class="ident" id="1945449">end</span><span class="op" id="1945452">)</span>&nbsp;<span class="op" id="1945454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945458">persistent</span><span class="op" id="1945468">.</span><span class="ident" id="1945469">pos</span>&nbsp;<span class="op" id="1945473">=</span>&nbsp;<span class="ident" id="1945475">sysAlloc</span><span class="op" id="1945483">(</span><span class="ident" id="1945484">chunk</span><span class="op" id="1945489">,</span>&nbsp;<span class="op" id="1945491">&amp;</span><span class="ident" id="1945492">memstats</span><span class="op" id="1945500">.</span><span class="ident" id="1945501">other_sys</span><span class="op" id="1945510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945514">if</span>&nbsp;<span class="ident" id="1945517">persistent</span><span class="op" id="1945527">.</span><span class="ident" id="1945528">pos</span>&nbsp;<span class="op" id="1945532">==</span>&nbsp;<span class="ident" id="1945535">nil</span>&nbsp;<span class="op" id="1945539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945544">unlock</span><span class="op" id="1945550">(</span><span class="op" id="1945551">&amp;</span><span class="ident" id="1945552">persistent</span><span class="op" id="1945562">.</span><span class="ident" id="1945563">lock</span><span class="op" id="1945567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945572">gothrow</span><span class="op" id="1945579">(</span><span class="string" id="1945580">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1945613">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945621">persistent</span><span class="op" id="1945631">.</span><span class="ident" id="1945632">end</span>&nbsp;<span class="op" id="1945636">=</span>&nbsp;<span class="ident" id="1945638">add</span><span class="op" id="1945641">(</span><span class="ident" id="1945642">persistent</span><span class="op" id="1945652">.</span><span class="ident" id="1945653">pos</span><span class="op" id="1945656">,</span>&nbsp;<span class="ident" id="1945658">chunk</span><span class="op" id="1945663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945669">p</span>&nbsp;<span class="op" id="1945671">:=</span>&nbsp;<span class="ident" id="1945674">persistent</span><span class="op" id="1945684">.</span><span class="ident" id="1945685">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945690">persistent</span><span class="op" id="1945700">.</span><span class="ident" id="1945701">pos</span>&nbsp;<span class="op" id="1945705">=</span>&nbsp;<span class="ident" id="1945707">add</span><span class="op" id="1945710">(</span><span class="ident" id="1945711">persistent</span><span class="op" id="1945721">.</span><span class="ident" id="1945722">pos</span><span class="op" id="1945725">,</span>&nbsp;<span class="ident" id="1945727">size</span><span class="op" id="1945731">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945734">unlock</span><span class="op" id="1945740">(</span><span class="op" id="1945741">&amp;</span><span class="ident" id="1945742">persistent</span><span class="op" id="1945752">.</span><span class="ident" id="1945753">lock</span><span class="op" id="1945757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945761">if</span>&nbsp;<span class="ident" id="1945764">stat</span>&nbsp;<span class="op" id="1945769">!=</span>&nbsp;<span class="op" id="1945772">&amp;</span><span class="ident" id="1945773">memstats</span><span class="op" id="1945781">.</span><span class="ident" id="1945782">other_sys</span>&nbsp;<span class="op" id="1945792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945796">xadd64</span><span class="op" id="1945802">(</span><span class="ident" id="1945803">stat</span><span class="op" id="1945807">,</span>&nbsp;<span class="ident" id="1945809">int64</span><span class="op" id="1945814">(</span><span class="ident" id="1945815">size</span><span class="op" id="1945819">)</span><span class="op" id="1945820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1945824">xadd64</span><span class="op" id="1945830">(</span><span class="op" id="1945831">&amp;</span><span class="ident" id="1945832">memstats</span><span class="op" id="1945840">.</span><span class="ident" id="1945841">other_sys</span><span class="op" id="1945850">,</span>&nbsp;<span class="op" id="1945852">-</span><span class="ident" id="1945853">int64</span><span class="op" id="1945858">(</span><span class="ident" id="1945859">size</span><span class="op" id="1945863">)</span><span class="op" id="1945864">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1945867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1945870">return</span>&nbsp;<span class="ident" id="1945877">p</span><br>
<span class="lineno"></span><span class="op" id="1945879">}</span>
</div>
</body>
</html>
