<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html" class="current">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3509988">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3510043">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3510097">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3510148">package</span>&nbsp;<span class="ident" id="3510156">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3510166">import</span>&nbsp;<span class="op" id="3510173">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3510176">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3510185">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3510192">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3510200">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3510206">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3510223">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="3510245">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3510248">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3510309">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="3510380">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="3510470">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="3510538">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="3510551">func</span>&nbsp;<span class="ident" id="3510556">escapeTemplate</span><span class="op" id="3510570">(</span><span class="ident" id="3510571">tmpl</span>&nbsp;<span class="op" id="3510576">*</span><span class="ident" id="3510577">Template</span><span class="op" id="3510585">,</span>&nbsp;<span class="ident" id="3510587">node</span>&nbsp;<span class="ident" id="3510592">parse</span><span class="op" id="3510597">.</span><span class="ident" id="3510598">Node</span><span class="op" id="3510602">,</span>&nbsp;<span class="ident" id="3510604">name</span>&nbsp;<span class="builtintype" id="3510609">string</span><span class="op" id="3510615">)</span>&nbsp;<span class="builtintype" id="3510617">error</span>&nbsp;<span class="op" id="3510623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510626">e</span>&nbsp;<span class="op" id="3510628">:=</span>&nbsp;<span class="ident" id="3510631">newEscaper</span><span class="op" id="3510641">(</span><span class="ident" id="3510642">tmpl</span><span class="op" id="3510646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510649">c</span><span class="op" id="3510650">,</span>&nbsp;<span class="ident" id="3510652">_</span>&nbsp;<span class="op" id="3510654">:=</span>&nbsp;<span class="ident" id="3510657">e</span><span class="op" id="3510658">.</span><span class="ident" id="3510659">escapeTree</span><span class="op" id="3510669">(</span><span class="ident" id="3510670">context</span><span class="op" id="3510677">{</span><span class="op" id="3510678">}</span><span class="op" id="3510679">,</span>&nbsp;<span class="ident" id="3510681">node</span><span class="op" id="3510685">,</span>&nbsp;<span class="ident" id="3510687">name</span><span class="op" id="3510691">,</span>&nbsp;<span class="num" id="3510693">0</span><span class="op" id="3510694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510697">var</span>&nbsp;<span class="ident" id="3510701">err</span>&nbsp;<span class="builtintype" id="3510705">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510712">if</span>&nbsp;<span class="ident" id="3510715">c</span><span class="op" id="3510716">.</span><span class="ident" id="3510717">err</span>&nbsp;<span class="op" id="3510721">!=</span>&nbsp;<span class="ident" id="3510724">nil</span>&nbsp;<span class="op" id="3510728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510732">err</span><span class="op" id="3510735">,</span>&nbsp;<span class="ident" id="3510737">c</span><span class="op" id="3510738">.</span><span class="ident" id="3510739">err</span><span class="op" id="3510742">.</span><span class="ident" id="3510743">Name</span>&nbsp;<span class="op" id="3510748">=</span>&nbsp;<span class="ident" id="3510750">c</span><span class="op" id="3510751">.</span><span class="ident" id="3510752">err</span><span class="op" id="3510755">,</span>&nbsp;<span class="ident" id="3510757">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510763">}</span>&nbsp;<span class="keyword" id="3510765">else</span>&nbsp;<span class="keyword" id="3510770">if</span>&nbsp;<span class="ident" id="3510773">c</span><span class="op" id="3510774">.</span><span class="ident" id="3510775">state</span>&nbsp;<span class="op" id="3510781">!=</span>&nbsp;<span class="ident" id="3510784">stateText</span>&nbsp;<span class="op" id="3510794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510798">err</span>&nbsp;<span class="op" id="3510802">=</span>&nbsp;<span class="op" id="3510804">&amp;</span><span class="ident" id="3510805">Error</span><span class="op" id="3510810">{</span><span class="ident" id="3510811">ErrEndContext</span><span class="op" id="3510824">,</span>&nbsp;<span class="ident" id="3510826">nil</span><span class="op" id="3510829">,</span>&nbsp;<span class="ident" id="3510831">name</span><span class="op" id="3510835">,</span>&nbsp;<span class="num" id="3510837">0</span><span class="op" id="3510838">,</span>&nbsp;<span class="ident" id="3510840">fmt</span><span class="op" id="3510843">.</span><span class="ident" id="3510844">Sprintf</span><span class="op" id="3510851">(</span><span class="string" id="3510852">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="3510884">,</span>&nbsp;<span class="ident" id="3510886">c</span><span class="op" id="3510887">)</span><span class="op" id="3510888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510891">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510894">if</span>&nbsp;<span class="ident" id="3510897">err</span>&nbsp;<span class="op" id="3510901">!=</span>&nbsp;<span class="ident" id="3510904">nil</span>&nbsp;<span class="op" id="3510908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3510912">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510956">if</span>&nbsp;<span class="ident" id="3510959">t</span>&nbsp;<span class="op" id="3510961">:=</span>&nbsp;<span class="ident" id="3510964">tmpl</span><span class="op" id="3510968">.</span><span class="ident" id="3510969">set</span><span class="op" id="3510972">[</span><span class="ident" id="3510973">name</span><span class="op" id="3510977">]</span><span class="op" id="3510978">;</span>&nbsp;<span class="ident" id="3510980">t</span>&nbsp;<span class="op" id="3510982">!=</span>&nbsp;<span class="ident" id="3510985">nil</span>&nbsp;<span class="op" id="3510989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510994">t</span><span class="op" id="3510995">.</span><span class="ident" id="3510996">escapeErr</span>&nbsp;<span class="op" id="3511006">=</span>&nbsp;<span class="ident" id="3511008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511015">t</span><span class="op" id="3511016">.</span><span class="ident" id="3511017">text</span><span class="op" id="3511021">.</span><span class="ident" id="3511022">Tree</span>&nbsp;<span class="op" id="3511027">=</span>&nbsp;<span class="ident" id="3511029">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511036">t</span><span class="op" id="3511037">.</span><span class="ident" id="3511038">Tree</span>&nbsp;<span class="op" id="3511043">=</span>&nbsp;<span class="ident" id="3511045">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511055">return</span>&nbsp;<span class="ident" id="3511062">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511070">e</span><span class="op" id="3511071">.</span><span class="ident" id="3511072">commit</span><span class="op" id="3511078">(</span><span class="op" id="3511079">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511082">if</span>&nbsp;<span class="ident" id="3511085">t</span>&nbsp;<span class="op" id="3511087">:=</span>&nbsp;<span class="ident" id="3511090">tmpl</span><span class="op" id="3511094">.</span><span class="ident" id="3511095">set</span><span class="op" id="3511098">[</span><span class="ident" id="3511099">name</span><span class="op" id="3511103">]</span><span class="op" id="3511104">;</span>&nbsp;<span class="ident" id="3511106">t</span>&nbsp;<span class="op" id="3511108">!=</span>&nbsp;<span class="ident" id="3511111">nil</span>&nbsp;<span class="op" id="3511115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511119">t</span><span class="op" id="3511120">.</span><span class="ident" id="3511121">escapeErr</span>&nbsp;<span class="op" id="3511131">=</span>&nbsp;<span class="ident" id="3511133">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511144">t</span><span class="op" id="3511145">.</span><span class="ident" id="3511146">Tree</span>&nbsp;<span class="op" id="3511151">=</span>&nbsp;<span class="ident" id="3511153">t</span><span class="op" id="3511154">.</span><span class="ident" id="3511155">text</span><span class="op" id="3511159">.</span><span class="ident" id="3511160">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511169">return</span>&nbsp;<span class="ident" id="3511176">nil</span><br>
<span class="lineno">45</span><span class="op" id="3511180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3511183">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="3511257">var</span>&nbsp;<span class="ident" id="3511261">funcMap</span>&nbsp;<span class="op" id="3511269">=</span>&nbsp;<span class="ident" id="3511271">template</span><span class="op" id="3511279">.</span><span class="ident" id="3511280">FuncMap</span><span class="op" id="3511287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511290">&#34;html_template_attrescaper&#34;</span><span class="op" id="3511317">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511323">attrEscaper</span><span class="op" id="3511334">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511337">&#34;html_template_commentescaper&#34;</span><span class="op" id="3511367">:</span>&nbsp;&nbsp;<span class="ident" id="3511370">commentEscaper</span><span class="op" id="3511384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511387">&#34;html_template_cssescaper&#34;</span><span class="op" id="3511413">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511420">cssEscaper</span><span class="op" id="3511430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511433">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="3511463">:</span>&nbsp;&nbsp;<span class="ident" id="3511466">cssValueFilter</span><span class="op" id="3511480">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511483">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="3511513">:</span>&nbsp;&nbsp;<span class="ident" id="3511516">htmlNameFilter</span><span class="op" id="3511530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511533">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3511560">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511566">htmlEscaper</span><span class="op" id="3511577">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511580">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="3511611">:</span>&nbsp;<span class="ident" id="3511613">jsRegexpEscaper</span><span class="op" id="3511628">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511631">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="3511659">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511664">jsStrEscaper</span><span class="op" id="3511676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511679">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="3511707">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511712">jsValEscaper</span><span class="op" id="3511724">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511727">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3511757">:</span>&nbsp;&nbsp;<span class="ident" id="3511760">htmlNospaceEscaper</span><span class="op" id="3511778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511781">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="3511810">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3511814">rcdataEscaper</span><span class="op" id="3511827">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511830">&#34;html_template_urlescaper&#34;</span><span class="op" id="3511856">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511863">urlEscaper</span><span class="op" id="3511873">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511876">&#34;html_template_urlfilter&#34;</span><span class="op" id="3511901">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511909">urlFilter</span><span class="op" id="3511918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3511921">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3511950">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3511954">urlNormalizer</span><span class="op" id="3511967">,</span><br>
<span class="lineno"></span><span class="op" id="3511969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3511972">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="3512050">var</span>&nbsp;<span class="ident" id="3512054">equivEscapers</span>&nbsp;<span class="op" id="3512068">=</span>&nbsp;<span class="keyword" id="3512070">map</span><span class="op" id="3512073">[</span><span class="builtintype" id="3512074">string</span><span class="op" id="3512080">]</span><span class="builtintype" id="3512081">string</span><span class="op" id="3512087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512090">&#34;html_template_attrescaper&#34;</span><span class="op" id="3512117">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3512122">&#34;html&#34;</span><span class="op" id="3512128">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512131">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3512158">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3512163">&#34;html&#34;</span><span class="op" id="3512169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512172">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3512202">:</span>&nbsp;<span class="string" id="3512204">&#34;html&#34;</span><span class="op" id="3512210">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512213">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="3512242">:</span>&nbsp;&nbsp;<span class="string" id="3512245">&#34;html&#34;</span><span class="op" id="3512251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512254">&#34;html_template_urlescaper&#34;</span><span class="op" id="3512280">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3512286">&#34;urlquery&#34;</span><span class="op" id="3512296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512299">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3512328">:</span>&nbsp;&nbsp;<span class="string" id="3512331">&#34;urlquery&#34;</span><span class="op" id="3512341">,</span><br>
<span class="lineno"></span><span class="op" id="3512343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3512346">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="3512425">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="3512454">type</span>&nbsp;<span class="ident" id="3512459">escaper</span>&nbsp;<span class="keyword" id="3512467">struct</span>&nbsp;<span class="op" id="3512474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512477">tmpl</span>&nbsp;<span class="op" id="3512482">*</span><span class="ident" id="3512483">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512493">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512564">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512615">output</span>&nbsp;<span class="keyword" id="3512622">map</span><span class="op" id="3512625">[</span><span class="builtintype" id="3512626">string</span><span class="op" id="3512632">]</span><span class="ident" id="3512633">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512642">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512715">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512768">derived</span>&nbsp;<span class="keyword" id="3512776">map</span><span class="op" id="3512779">[</span><span class="builtintype" id="3512780">string</span><span class="op" id="3512786">]</span><span class="op" id="3512787">*</span><span class="ident" id="3512788">template</span><span class="op" id="3512796">.</span><span class="ident" id="3512797">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512807">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512875">called</span>&nbsp;<span class="keyword" id="3512882">map</span><span class="op" id="3512885">[</span><span class="builtintype" id="3512886">string</span><span class="op" id="3512892">]</span><span class="builtintype" id="3512893">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512899">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512966">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3513032">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513094">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3513112">map</span><span class="op" id="3513115">[</span><span class="op" id="3513116">*</span><span class="ident" id="3513117">parse</span><span class="op" id="3513122">.</span><span class="ident" id="3513123">ActionNode</span><span class="op" id="3513133">]</span><span class="op" id="3513134">[</span><span class="op" id="3513135">]</span><span class="builtintype" id="3513136">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513144">templateNodeEdits</span>&nbsp;<span class="keyword" id="3513162">map</span><span class="op" id="3513165">[</span><span class="op" id="3513166">*</span><span class="ident" id="3513167">parse</span><span class="op" id="3513172">.</span><span class="ident" id="3513173">TemplateNode</span><span class="op" id="3513185">]</span><span class="builtintype" id="3513186">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513194">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3513212">map</span><span class="op" id="3513215">[</span><span class="op" id="3513216">*</span><span class="ident" id="3513217">parse</span><span class="op" id="3513222">.</span><span class="ident" id="3513223">TextNode</span><span class="op" id="3513231">]</span><span class="op" id="3513232">[</span><span class="op" id="3513233">]</span><span class="builtintype" id="3513234">byte</span><br>
<span class="lineno"></span><span class="op" id="3513239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3513242">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="3513299">func</span>&nbsp;<span class="ident" id="3513304">newEscaper</span><span class="op" id="3513314">(</span><span class="ident" id="3513315">t</span>&nbsp;<span class="op" id="3513317">*</span><span class="ident" id="3513318">Template</span><span class="op" id="3513326">)</span>&nbsp;<span class="op" id="3513328">*</span><span class="ident" id="3513329">escaper</span>&nbsp;<span class="op" id="3513337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513340">return</span>&nbsp;<span class="op" id="3513347">&amp;</span><span class="ident" id="3513348">escaper</span><span class="op" id="3513355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513359">t</span><span class="op" id="3513360">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513364">map</span><span class="op" id="3513367">[</span><span class="builtintype" id="3513368">string</span><span class="op" id="3513374">]</span><span class="ident" id="3513375">context</span><span class="op" id="3513382">{</span><span class="op" id="3513383">}</span><span class="op" id="3513384">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513388">map</span><span class="op" id="3513391">[</span><span class="builtintype" id="3513392">string</span><span class="op" id="3513398">]</span><span class="op" id="3513399">*</span><span class="ident" id="3513400">template</span><span class="op" id="3513408">.</span><span class="ident" id="3513409">Template</span><span class="op" id="3513417">{</span><span class="op" id="3513418">}</span><span class="op" id="3513419">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513423">map</span><span class="op" id="3513426">[</span><span class="builtintype" id="3513427">string</span><span class="op" id="3513433">]</span><span class="builtintype" id="3513434">bool</span><span class="op" id="3513438">{</span><span class="op" id="3513439">}</span><span class="op" id="3513440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513444">map</span><span class="op" id="3513447">[</span><span class="op" id="3513448">*</span><span class="ident" id="3513449">parse</span><span class="op" id="3513454">.</span><span class="ident" id="3513455">ActionNode</span><span class="op" id="3513465">]</span><span class="op" id="3513466">[</span><span class="op" id="3513467">]</span><span class="builtintype" id="3513468">string</span><span class="op" id="3513474">{</span><span class="op" id="3513475">}</span><span class="op" id="3513476">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513480">map</span><span class="op" id="3513483">[</span><span class="op" id="3513484">*</span><span class="ident" id="3513485">parse</span><span class="op" id="3513490">.</span><span class="ident" id="3513491">TemplateNode</span><span class="op" id="3513503">]</span><span class="builtintype" id="3513504">string</span><span class="op" id="3513510">{</span><span class="op" id="3513511">}</span><span class="op" id="3513512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513516">map</span><span class="op" id="3513519">[</span><span class="op" id="3513520">*</span><span class="ident" id="3513521">parse</span><span class="op" id="3513526">.</span><span class="ident" id="3513527">TextNode</span><span class="op" id="3513535">]</span><span class="op" id="3513536">[</span><span class="op" id="3513537">]</span><span class="builtintype" id="3513538">byte</span><span class="op" id="3513542">{</span><span class="op" id="3513543">}</span><span class="op" id="3513544">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513547">}</span><br>
<span class="lineno"></span><span class="op" id="3513549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3513552">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="3513633">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="3513709">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="3513788">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="3513865">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="3513889">const</span>&nbsp;<span class="ident" id="3513895">filterFailsafe</span>&nbsp;<span class="op" id="3513910">=</span>&nbsp;<span class="string" id="3513912">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="3513924">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3513959">func</span>&nbsp;<span class="op" id="3513964">(</span><span class="ident" id="3513965">e</span>&nbsp;<span class="op" id="3513967">*</span><span class="ident" id="3513968">escaper</span><span class="op" id="3513975">)</span>&nbsp;<span class="ident" id="3513977">escape</span><span class="op" id="3513983">(</span><span class="ident" id="3513984">c</span>&nbsp;<span class="ident" id="3513986">context</span><span class="op" id="3513993">,</span>&nbsp;<span class="ident" id="3513995">n</span>&nbsp;<span class="ident" id="3513997">parse</span><span class="op" id="3514002">.</span><span class="ident" id="3514003">Node</span><span class="op" id="3514007">)</span>&nbsp;<span class="ident" id="3514009">context</span>&nbsp;<span class="op" id="3514017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514020">switch</span>&nbsp;<span class="ident" id="3514027">n</span>&nbsp;<span class="op" id="3514029">:=</span>&nbsp;<span class="ident" id="3514032">n</span><span class="op" id="3514033">.</span><span class="op" id="3514034">(</span><span class="keyword" id="3514035">type</span><span class="op" id="3514039">)</span>&nbsp;<span class="op" id="3514041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514044">case</span>&nbsp;<span class="op" id="3514049">*</span><span class="ident" id="3514050">parse</span><span class="op" id="3514055">.</span><span class="ident" id="3514056">ActionNode</span><span class="op" id="3514066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514070">return</span>&nbsp;<span class="ident" id="3514077">e</span><span class="op" id="3514078">.</span><span class="ident" id="3514079">escapeAction</span><span class="op" id="3514091">(</span><span class="ident" id="3514092">c</span><span class="op" id="3514093">,</span>&nbsp;<span class="ident" id="3514095">n</span><span class="op" id="3514096">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514099">case</span>&nbsp;<span class="op" id="3514104">*</span><span class="ident" id="3514105">parse</span><span class="op" id="3514110">.</span><span class="ident" id="3514111">IfNode</span><span class="op" id="3514117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514121">return</span>&nbsp;<span class="ident" id="3514128">e</span><span class="op" id="3514129">.</span><span class="ident" id="3514130">escapeBranch</span><span class="op" id="3514142">(</span><span class="ident" id="3514143">c</span><span class="op" id="3514144">,</span>&nbsp;<span class="op" id="3514146">&amp;</span><span class="ident" id="3514147">n</span><span class="op" id="3514148">.</span><span class="ident" id="3514149">BranchNode</span><span class="op" id="3514159">,</span>&nbsp;<span class="string" id="3514161">&#34;if&#34;</span><span class="op" id="3514165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514168">case</span>&nbsp;<span class="op" id="3514173">*</span><span class="ident" id="3514174">parse</span><span class="op" id="3514179">.</span><span class="ident" id="3514180">ListNode</span><span class="op" id="3514188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514192">return</span>&nbsp;<span class="ident" id="3514199">e</span><span class="op" id="3514200">.</span><span class="ident" id="3514201">escapeList</span><span class="op" id="3514211">(</span><span class="ident" id="3514212">c</span><span class="op" id="3514213">,</span>&nbsp;<span class="ident" id="3514215">n</span><span class="op" id="3514216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514219">case</span>&nbsp;<span class="op" id="3514224">*</span><span class="ident" id="3514225">parse</span><span class="op" id="3514230">.</span><span class="ident" id="3514231">RangeNode</span><span class="op" id="3514240">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514244">return</span>&nbsp;<span class="ident" id="3514251">e</span><span class="op" id="3514252">.</span><span class="ident" id="3514253">escapeBranch</span><span class="op" id="3514265">(</span><span class="ident" id="3514266">c</span><span class="op" id="3514267">,</span>&nbsp;<span class="op" id="3514269">&amp;</span><span class="ident" id="3514270">n</span><span class="op" id="3514271">.</span><span class="ident" id="3514272">BranchNode</span><span class="op" id="3514282">,</span>&nbsp;<span class="string" id="3514284">&#34;range&#34;</span><span class="op" id="3514291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514294">case</span>&nbsp;<span class="op" id="3514299">*</span><span class="ident" id="3514300">parse</span><span class="op" id="3514305">.</span><span class="ident" id="3514306">TemplateNode</span><span class="op" id="3514318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514322">return</span>&nbsp;<span class="ident" id="3514329">e</span><span class="op" id="3514330">.</span><span class="ident" id="3514331">escapeTemplate</span><span class="op" id="3514345">(</span><span class="ident" id="3514346">c</span><span class="op" id="3514347">,</span>&nbsp;<span class="ident" id="3514349">n</span><span class="op" id="3514350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514353">case</span>&nbsp;<span class="op" id="3514358">*</span><span class="ident" id="3514359">parse</span><span class="op" id="3514364">.</span><span class="ident" id="3514365">TextNode</span><span class="op" id="3514373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514377">return</span>&nbsp;<span class="ident" id="3514384">e</span><span class="op" id="3514385">.</span><span class="ident" id="3514386">escapeText</span><span class="op" id="3514396">(</span><span class="ident" id="3514397">c</span><span class="op" id="3514398">,</span>&nbsp;<span class="ident" id="3514400">n</span><span class="op" id="3514401">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514404">case</span>&nbsp;<span class="op" id="3514409">*</span><span class="ident" id="3514410">parse</span><span class="op" id="3514415">.</span><span class="ident" id="3514416">WithNode</span><span class="op" id="3514424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514428">return</span>&nbsp;<span class="ident" id="3514435">e</span><span class="op" id="3514436">.</span><span class="ident" id="3514437">escapeBranch</span><span class="op" id="3514449">(</span><span class="ident" id="3514450">c</span><span class="op" id="3514451">,</span>&nbsp;<span class="op" id="3514453">&amp;</span><span class="ident" id="3514454">n</span><span class="op" id="3514455">.</span><span class="ident" id="3514456">BranchNode</span><span class="op" id="3514466">,</span>&nbsp;<span class="string" id="3514468">&#34;with&#34;</span><span class="op" id="3514474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3514480">panic</span><span class="op" id="3514485">(</span><span class="string" id="3514486">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="3514498">+</span>&nbsp;<span class="ident" id="3514500">n</span><span class="op" id="3514501">.</span><span class="ident" id="3514502">String</span><span class="op" id="3514508">(</span><span class="op" id="3514509">)</span>&nbsp;<span class="op" id="3514511">+</span>&nbsp;<span class="string" id="3514513">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="3514532">)</span><br>
<span class="lineno"></span><span class="op" id="3514534">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="3514537">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3514586">func</span>&nbsp;<span class="op" id="3514591">(</span><span class="ident" id="3514592">e</span>&nbsp;<span class="op" id="3514594">*</span><span class="ident" id="3514595">escaper</span><span class="op" id="3514602">)</span>&nbsp;<span class="ident" id="3514604">escapeAction</span><span class="op" id="3514616">(</span><span class="ident" id="3514617">c</span>&nbsp;<span class="ident" id="3514619">context</span><span class="op" id="3514626">,</span>&nbsp;<span class="ident" id="3514628">n</span>&nbsp;<span class="op" id="3514630">*</span><span class="ident" id="3514631">parse</span><span class="op" id="3514636">.</span><span class="ident" id="3514637">ActionNode</span><span class="op" id="3514647">)</span>&nbsp;<span class="ident" id="3514649">context</span>&nbsp;<span class="op" id="3514657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514660">if</span>&nbsp;<span class="builtinfunc" id="3514663">len</span><span class="op" id="3514666">(</span><span class="ident" id="3514667">n</span><span class="op" id="3514668">.</span><span class="ident" id="3514669">Pipe</span><span class="op" id="3514673">.</span><span class="ident" id="3514674">Decl</span><span class="op" id="3514678">)</span>&nbsp;<span class="op" id="3514680">!=</span>&nbsp;<span class="num" id="3514683">0</span>&nbsp;<span class="op" id="3514685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514689">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514745">return</span>&nbsp;<span class="ident" id="3514752">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514758">c</span>&nbsp;<span class="op" id="3514760">=</span>&nbsp;<span class="ident" id="3514762">nudge</span><span class="op" id="3514767">(</span><span class="ident" id="3514768">c</span><span class="op" id="3514769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514772">s</span>&nbsp;<span class="op" id="3514774">:=</span>&nbsp;<span class="builtinfunc" id="3514777">make</span><span class="op" id="3514781">(</span><span class="op" id="3514782">[</span><span class="op" id="3514783">]</span><span class="builtintype" id="3514784">string</span><span class="op" id="3514790">,</span>&nbsp;<span class="num" id="3514792">0</span><span class="op" id="3514793">,</span>&nbsp;<span class="num" id="3514795">3</span><span class="op" id="3514796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514799">switch</span>&nbsp;<span class="ident" id="3514806">c</span><span class="op" id="3514807">.</span><span class="ident" id="3514808">state</span>&nbsp;<span class="op" id="3514814">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514817">case</span>&nbsp;<span class="ident" id="3514822">stateError</span><span class="op" id="3514832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514836">return</span>&nbsp;<span class="ident" id="3514843">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514846">case</span>&nbsp;<span class="ident" id="3514851">stateURL</span><span class="op" id="3514859">,</span>&nbsp;<span class="ident" id="3514861">stateCSSDqStr</span><span class="op" id="3514874">,</span>&nbsp;<span class="ident" id="3514876">stateCSSSqStr</span><span class="op" id="3514889">,</span>&nbsp;<span class="ident" id="3514891">stateCSSDqURL</span><span class="op" id="3514904">,</span>&nbsp;<span class="ident" id="3514906">stateCSSSqURL</span><span class="op" id="3514919">,</span>&nbsp;<span class="ident" id="3514921">stateCSSURL</span><span class="op" id="3514932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514936">switch</span>&nbsp;<span class="ident" id="3514943">c</span><span class="op" id="3514944">.</span><span class="ident" id="3514945">urlPart</span>&nbsp;<span class="op" id="3514953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514957">case</span>&nbsp;<span class="ident" id="3514962">urlPartNone</span><span class="op" id="3514973">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514978">s</span>&nbsp;<span class="op" id="3514980">=</span>&nbsp;<span class="builtinfunc" id="3514982">append</span><span class="op" id="3514988">(</span><span class="ident" id="3514989">s</span><span class="op" id="3514990">,</span>&nbsp;<span class="string" id="3514992">&#34;html_template_urlfilter&#34;</span><span class="op" id="3515017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515022">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515036">case</span>&nbsp;<span class="ident" id="3515041">urlPartPreQuery</span><span class="op" id="3515056">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515061">switch</span>&nbsp;<span class="ident" id="3515068">c</span><span class="op" id="3515069">.</span><span class="ident" id="3515070">state</span>&nbsp;<span class="op" id="3515076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515081">case</span>&nbsp;<span class="ident" id="3515086">stateCSSDqStr</span><span class="op" id="3515099">,</span>&nbsp;<span class="ident" id="3515101">stateCSSSqStr</span><span class="op" id="3515114">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515120">s</span>&nbsp;<span class="op" id="3515122">=</span>&nbsp;<span class="builtinfunc" id="3515124">append</span><span class="op" id="3515130">(</span><span class="ident" id="3515131">s</span><span class="op" id="3515132">,</span>&nbsp;<span class="string" id="3515134">&#34;html_template_cssescaper&#34;</span><span class="op" id="3515160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515165">default</span><span class="op" id="3515172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515178">s</span>&nbsp;<span class="op" id="3515180">=</span>&nbsp;<span class="builtinfunc" id="3515182">append</span><span class="op" id="3515188">(</span><span class="ident" id="3515189">s</span><span class="op" id="3515190">,</span>&nbsp;<span class="string" id="3515192">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3515221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515230">case</span>&nbsp;<span class="ident" id="3515235">urlPartQueryOrFrag</span><span class="op" id="3515253">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515258">s</span>&nbsp;<span class="op" id="3515260">=</span>&nbsp;<span class="builtinfunc" id="3515262">append</span><span class="op" id="3515268">(</span><span class="ident" id="3515269">s</span><span class="op" id="3515270">,</span>&nbsp;<span class="string" id="3515272">&#34;html_template_urlescaper&#34;</span><span class="op" id="3515298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515302">case</span>&nbsp;<span class="ident" id="3515307">urlPartUnknown</span><span class="op" id="3515321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515326">return</span>&nbsp;<span class="ident" id="3515333">context</span><span class="op" id="3515340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515346">state</span><span class="op" id="3515351">:</span>&nbsp;<span class="ident" id="3515353">stateError</span><span class="op" id="3515363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515369">err</span><span class="op" id="3515372">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3515376">errorf</span><span class="op" id="3515382">(</span><span class="ident" id="3515383">ErrAmbigContext</span><span class="op" id="3515398">,</span>&nbsp;<span class="ident" id="3515400">n</span><span class="op" id="3515401">,</span>&nbsp;<span class="ident" id="3515403">n</span><span class="op" id="3515404">.</span><span class="ident" id="3515405">Line</span><span class="op" id="3515409">,</span>&nbsp;<span class="string" id="3515411">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="3515451">,</span>&nbsp;<span class="ident" id="3515453">n</span><span class="op" id="3515454">)</span><span class="op" id="3515455">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515464">default</span><span class="op" id="3515471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3515476">panic</span><span class="op" id="3515481">(</span><span class="ident" id="3515482">c</span><span class="op" id="3515483">.</span><span class="ident" id="3515484">urlPart</span><span class="op" id="3515491">.</span><span class="ident" id="3515492">String</span><span class="op" id="3515498">(</span><span class="op" id="3515499">)</span><span class="op" id="3515500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515507">case</span>&nbsp;<span class="ident" id="3515512">stateJS</span><span class="op" id="3515519">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515523">s</span>&nbsp;<span class="op" id="3515525">=</span>&nbsp;<span class="builtinfunc" id="3515527">append</span><span class="op" id="3515533">(</span><span class="ident" id="3515534">s</span><span class="op" id="3515535">,</span>&nbsp;<span class="string" id="3515537">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="3515565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3515569">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515619">c</span><span class="op" id="3515620">.</span><span class="ident" id="3515621">jsCtx</span>&nbsp;<span class="op" id="3515627">=</span>&nbsp;<span class="ident" id="3515629">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515641">case</span>&nbsp;<span class="ident" id="3515646">stateJSDqStr</span><span class="op" id="3515658">,</span>&nbsp;<span class="ident" id="3515660">stateJSSqStr</span><span class="op" id="3515672">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515676">s</span>&nbsp;<span class="op" id="3515678">=</span>&nbsp;<span class="builtinfunc" id="3515680">append</span><span class="op" id="3515686">(</span><span class="ident" id="3515687">s</span><span class="op" id="3515688">,</span>&nbsp;<span class="string" id="3515690">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="3515718">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515721">case</span>&nbsp;<span class="ident" id="3515726">stateJSRegexp</span><span class="op" id="3515739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515743">s</span>&nbsp;<span class="op" id="3515745">=</span>&nbsp;<span class="builtinfunc" id="3515747">append</span><span class="op" id="3515753">(</span><span class="ident" id="3515754">s</span><span class="op" id="3515755">,</span>&nbsp;<span class="string" id="3515757">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="3515788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515791">case</span>&nbsp;<span class="ident" id="3515796">stateCSS</span><span class="op" id="3515804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515808">s</span>&nbsp;<span class="op" id="3515810">=</span>&nbsp;<span class="builtinfunc" id="3515812">append</span><span class="op" id="3515818">(</span><span class="ident" id="3515819">s</span><span class="op" id="3515820">,</span>&nbsp;<span class="string" id="3515822">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="3515852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515855">case</span>&nbsp;<span class="ident" id="3515860">stateText</span><span class="op" id="3515869">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515873">s</span>&nbsp;<span class="op" id="3515875">=</span>&nbsp;<span class="builtinfunc" id="3515877">append</span><span class="op" id="3515883">(</span><span class="ident" id="3515884">s</span><span class="op" id="3515885">,</span>&nbsp;<span class="string" id="3515887">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3515914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515917">case</span>&nbsp;<span class="ident" id="3515922">stateRCDATA</span><span class="op" id="3515933">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515937">s</span>&nbsp;<span class="op" id="3515939">=</span>&nbsp;<span class="builtinfunc" id="3515941">append</span><span class="op" id="3515947">(</span><span class="ident" id="3515948">s</span><span class="op" id="3515949">,</span>&nbsp;<span class="string" id="3515951">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="3515980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515983">case</span>&nbsp;<span class="ident" id="3515988">stateAttr</span><span class="op" id="3515997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516001">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516035">case</span>&nbsp;<span class="ident" id="3516040">stateAttrName</span><span class="op" id="3516053">,</span>&nbsp;<span class="ident" id="3516055">stateTag</span><span class="op" id="3516063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516067">c</span><span class="op" id="3516068">.</span><span class="ident" id="3516069">state</span>&nbsp;<span class="op" id="3516075">=</span>&nbsp;<span class="ident" id="3516077">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516093">s</span>&nbsp;<span class="op" id="3516095">=</span>&nbsp;<span class="builtinfunc" id="3516097">append</span><span class="op" id="3516103">(</span><span class="ident" id="3516104">s</span><span class="op" id="3516105">,</span>&nbsp;<span class="string" id="3516107">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="3516137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516140">default</span><span class="op" id="3516147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516151">if</span>&nbsp;<span class="ident" id="3516154">isComment</span><span class="op" id="3516163">(</span><span class="ident" id="3516164">c</span><span class="op" id="3516165">.</span><span class="ident" id="3516166">state</span><span class="op" id="3516171">)</span>&nbsp;<span class="op" id="3516173">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516178">s</span>&nbsp;<span class="op" id="3516180">=</span>&nbsp;<span class="builtinfunc" id="3516182">append</span><span class="op" id="3516188">(</span><span class="ident" id="3516189">s</span><span class="op" id="3516190">,</span>&nbsp;<span class="string" id="3516192">&#34;html_template_commentescaper&#34;</span><span class="op" id="3516222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516226">}</span>&nbsp;<span class="keyword" id="3516228">else</span>&nbsp;<span class="op" id="3516233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3516238">panic</span><span class="op" id="3516243">(</span><span class="string" id="3516244">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="3516264">+</span>&nbsp;<span class="ident" id="3516266">c</span><span class="op" id="3516267">.</span><span class="ident" id="3516268">state</span><span class="op" id="3516273">.</span><span class="ident" id="3516274">String</span><span class="op" id="3516280">(</span><span class="op" id="3516281">)</span><span class="op" id="3516282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516289">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516292">switch</span>&nbsp;<span class="ident" id="3516299">c</span><span class="op" id="3516300">.</span><span class="ident" id="3516301">delim</span>&nbsp;<span class="op" id="3516307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516310">case</span>&nbsp;<span class="ident" id="3516315">delimNone</span><span class="op" id="3516324">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516328">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516379">case</span>&nbsp;<span class="ident" id="3516384">delimSpaceOrTagEnd</span><span class="op" id="3516402">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516406">s</span>&nbsp;<span class="op" id="3516408">=</span>&nbsp;<span class="builtinfunc" id="3516410">append</span><span class="op" id="3516416">(</span><span class="ident" id="3516417">s</span><span class="op" id="3516418">,</span>&nbsp;<span class="string" id="3516420">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3516450">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516453">default</span><span class="op" id="3516460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516464">s</span>&nbsp;<span class="op" id="3516466">=</span>&nbsp;<span class="builtinfunc" id="3516468">append</span><span class="op" id="3516474">(</span><span class="ident" id="3516475">s</span><span class="op" id="3516476">,</span>&nbsp;<span class="string" id="3516478">&#34;html_template_attrescaper&#34;</span><span class="op" id="3516505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516511">e</span><span class="op" id="3516512">.</span><span class="ident" id="3516513">editActionNode</span><span class="op" id="3516527">(</span><span class="ident" id="3516528">n</span><span class="op" id="3516529">,</span>&nbsp;<span class="ident" id="3516531">s</span><span class="op" id="3516532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516535">return</span>&nbsp;<span class="ident" id="3516542">c</span><br>
<span class="lineno">205</span><span class="op" id="3516544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3516547">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="3516632">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="3516695">func</span>&nbsp;<span class="ident" id="3516700">allIdents</span><span class="op" id="3516709">(</span><span class="ident" id="3516710">node</span>&nbsp;<span class="ident" id="3516715">parse</span><span class="op" id="3516720">.</span><span class="ident" id="3516721">Node</span><span class="op" id="3516725">)</span>&nbsp;<span class="op" id="3516727">[</span><span class="op" id="3516728">]</span><span class="builtintype" id="3516729">string</span>&nbsp;<span class="op" id="3516736">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516739">switch</span>&nbsp;<span class="ident" id="3516746">node</span>&nbsp;<span class="op" id="3516751">:=</span>&nbsp;<span class="ident" id="3516754">node</span><span class="op" id="3516758">.</span><span class="op" id="3516759">(</span><span class="keyword" id="3516760">type</span><span class="op" id="3516764">)</span>&nbsp;<span class="op" id="3516766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516769">case</span>&nbsp;<span class="op" id="3516774">*</span><span class="ident" id="3516775">parse</span><span class="op" id="3516780">.</span><span class="ident" id="3516781">IdentifierNode</span><span class="op" id="3516795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516799">return</span>&nbsp;<span class="op" id="3516806">[</span><span class="op" id="3516807">]</span><span class="builtintype" id="3516808">string</span><span class="op" id="3516814">{</span><span class="ident" id="3516815">node</span><span class="op" id="3516819">.</span><span class="ident" id="3516820">Ident</span><span class="op" id="3516825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516828">case</span>&nbsp;<span class="op" id="3516833">*</span><span class="ident" id="3516834">parse</span><span class="op" id="3516839">.</span><span class="ident" id="3516840">FieldNode</span><span class="op" id="3516849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516853">return</span>&nbsp;<span class="ident" id="3516860">node</span><span class="op" id="3516864">.</span><span class="ident" id="3516865">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3516875">panic</span><span class="op" id="3516880">(</span><span class="string" id="3516881">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="3516918">)</span><br>
<span class="lineno"></span><span class="op" id="3516920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3516923">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="3516993">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="3517027">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="3517100">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3517177">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="3517251">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="3517281">func</span>&nbsp;<span class="ident" id="3517286">ensurePipelineContains</span><span class="op" id="3517308">(</span><span class="ident" id="3517309">p</span>&nbsp;<span class="op" id="3517311">*</span><span class="ident" id="3517312">parse</span><span class="op" id="3517317">.</span><span class="ident" id="3517318">PipeNode</span><span class="op" id="3517326">,</span>&nbsp;<span class="ident" id="3517328">s</span>&nbsp;<span class="op" id="3517330">[</span><span class="op" id="3517331">]</span><span class="builtintype" id="3517332">string</span><span class="op" id="3517338">)</span>&nbsp;<span class="op" id="3517340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517343">if</span>&nbsp;<span class="builtinfunc" id="3517346">len</span><span class="op" id="3517349">(</span><span class="ident" id="3517350">s</span><span class="op" id="3517351">)</span>&nbsp;<span class="op" id="3517353">==</span>&nbsp;<span class="num" id="3517356">0</span>&nbsp;<span class="op" id="3517358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517373">n</span>&nbsp;<span class="op" id="3517375">:=</span>&nbsp;<span class="builtinfunc" id="3517378">len</span><span class="op" id="3517381">(</span><span class="ident" id="3517382">p</span><span class="op" id="3517383">.</span><span class="ident" id="3517384">Cmds</span><span class="op" id="3517388">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517391">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517449">idents</span>&nbsp;<span class="op" id="3517456">:=</span>&nbsp;<span class="ident" id="3517459">p</span><span class="op" id="3517460">.</span><span class="ident" id="3517461">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517467">for</span>&nbsp;<span class="ident" id="3517471">i</span>&nbsp;<span class="op" id="3517473">:=</span>&nbsp;<span class="ident" id="3517476">n</span>&nbsp;<span class="op" id="3517478">-</span>&nbsp;<span class="num" id="3517480">1</span><span class="op" id="3517481">;</span>&nbsp;<span class="ident" id="3517483">i</span>&nbsp;<span class="op" id="3517485">&gt;=</span>&nbsp;<span class="num" id="3517488">0</span><span class="op" id="3517489">;</span>&nbsp;<span class="ident" id="3517491">i</span><span class="op" id="3517492">--</span>&nbsp;<span class="op" id="3517495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517499">if</span>&nbsp;<span class="ident" id="3517502">cmd</span>&nbsp;<span class="op" id="3517506">:=</span>&nbsp;<span class="ident" id="3517509">p</span><span class="op" id="3517510">.</span><span class="ident" id="3517511">Cmds</span><span class="op" id="3517515">[</span><span class="ident" id="3517516">i</span><span class="op" id="3517517">]</span><span class="op" id="3517518">;</span>&nbsp;<span class="builtinfunc" id="3517520">len</span><span class="op" id="3517523">(</span><span class="ident" id="3517524">cmd</span><span class="op" id="3517527">.</span><span class="ident" id="3517528">Args</span><span class="op" id="3517532">)</span>&nbsp;<span class="op" id="3517534">!=</span>&nbsp;<span class="num" id="3517537">0</span>&nbsp;<span class="op" id="3517539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517544">if</span>&nbsp;<span class="ident" id="3517547">_</span><span class="op" id="3517548">,</span>&nbsp;<span class="ident" id="3517550">ok</span>&nbsp;<span class="op" id="3517553">:=</span>&nbsp;<span class="ident" id="3517556">cmd</span><span class="op" id="3517559">.</span><span class="ident" id="3517560">Args</span><span class="op" id="3517564">[</span><span class="num" id="3517565">0</span><span class="op" id="3517566">]</span><span class="op" id="3517567">.</span><span class="op" id="3517568">(</span><span class="op" id="3517569">*</span><span class="ident" id="3517570">parse</span><span class="op" id="3517575">.</span><span class="ident" id="3517576">IdentifierNode</span><span class="op" id="3517590">)</span><span class="op" id="3517591">;</span>&nbsp;<span class="ident" id="3517593">ok</span>&nbsp;<span class="op" id="3517596">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517602">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517622">idents</span>&nbsp;<span class="op" id="3517629">=</span>&nbsp;<span class="ident" id="3517631">p</span><span class="op" id="3517632">.</span><span class="ident" id="3517633">Cmds</span><span class="op" id="3517637">[</span><span class="ident" id="3517638">i</span><span class="op" id="3517639">+</span><span class="num" id="3517640">1</span><span class="op" id="3517641">:</span><span class="op" id="3517642">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517645">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517648">dups</span>&nbsp;<span class="op" id="3517653">:=</span>&nbsp;<span class="num" id="3517656">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517659">for</span>&nbsp;<span class="ident" id="3517663">_</span><span class="op" id="3517664">,</span>&nbsp;<span class="ident" id="3517666">idNode</span>&nbsp;<span class="op" id="3517673">:=</span>&nbsp;<span class="keyword" id="3517676">range</span>&nbsp;<span class="ident" id="3517682">idents</span>&nbsp;<span class="op" id="3517689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517693">for</span>&nbsp;<span class="ident" id="3517697">_</span><span class="op" id="3517698">,</span>&nbsp;<span class="ident" id="3517700">ident</span>&nbsp;<span class="op" id="3517706">:=</span>&nbsp;<span class="keyword" id="3517709">range</span>&nbsp;<span class="ident" id="3517715">allIdents</span><span class="op" id="3517724">(</span><span class="ident" id="3517725">idNode</span><span class="op" id="3517731">.</span><span class="ident" id="3517732">Args</span><span class="op" id="3517736">[</span><span class="num" id="3517737">0</span><span class="op" id="3517738">]</span><span class="op" id="3517739">)</span>&nbsp;<span class="op" id="3517741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517746">if</span>&nbsp;<span class="ident" id="3517749">escFnsEq</span><span class="op" id="3517757">(</span><span class="ident" id="3517758">s</span><span class="op" id="3517759">[</span><span class="ident" id="3517760">dups</span><span class="op" id="3517764">]</span><span class="op" id="3517765">,</span>&nbsp;<span class="ident" id="3517767">ident</span><span class="op" id="3517772">)</span>&nbsp;<span class="op" id="3517774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517780">dups</span><span class="op" id="3517784">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517791">if</span>&nbsp;<span class="ident" id="3517794">dups</span>&nbsp;<span class="op" id="3517799">==</span>&nbsp;<span class="builtinfunc" id="3517802">len</span><span class="op" id="3517805">(</span><span class="ident" id="3517806">s</span><span class="op" id="3517807">)</span>&nbsp;<span class="op" id="3517809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517816">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517836">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517842">newCmds</span>&nbsp;<span class="op" id="3517850">:=</span>&nbsp;<span class="builtinfunc" id="3517853">make</span><span class="op" id="3517857">(</span><span class="op" id="3517858">[</span><span class="op" id="3517859">]</span><span class="op" id="3517860">*</span><span class="ident" id="3517861">parse</span><span class="op" id="3517866">.</span><span class="ident" id="3517867">CommandNode</span><span class="op" id="3517878">,</span>&nbsp;<span class="ident" id="3517880">n</span><span class="op" id="3517881">-</span><span class="builtinfunc" id="3517882">len</span><span class="op" id="3517885">(</span><span class="ident" id="3517886">idents</span><span class="op" id="3517892">)</span><span class="op" id="3517893">,</span>&nbsp;<span class="ident" id="3517895">n</span><span class="op" id="3517896">+</span><span class="builtinfunc" id="3517897">len</span><span class="op" id="3517900">(</span><span class="ident" id="3517901">s</span><span class="op" id="3517902">)</span><span class="op" id="3517903">-</span><span class="ident" id="3517904">dups</span><span class="op" id="3517908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3517911">copy</span><span class="op" id="3517915">(</span><span class="ident" id="3517916">newCmds</span><span class="op" id="3517923">,</span>&nbsp;<span class="ident" id="3517925">p</span><span class="op" id="3517926">.</span><span class="ident" id="3517927">Cmds</span><span class="op" id="3517931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517934">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518001">for</span>&nbsp;<span class="ident" id="3518005">_</span><span class="op" id="3518006">,</span>&nbsp;<span class="ident" id="3518008">idNode</span>&nbsp;<span class="op" id="3518015">:=</span>&nbsp;<span class="keyword" id="3518018">range</span>&nbsp;<span class="ident" id="3518024">idents</span>&nbsp;<span class="op" id="3518031">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518035">pos</span>&nbsp;<span class="op" id="3518039">:=</span>&nbsp;<span class="ident" id="3518042">idNode</span><span class="op" id="3518048">.</span><span class="ident" id="3518049">Args</span><span class="op" id="3518053">[</span><span class="num" id="3518054">0</span><span class="op" id="3518055">]</span><span class="op" id="3518056">.</span><span class="ident" id="3518057">Position</span><span class="op" id="3518065">(</span><span class="op" id="3518066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518070">for</span>&nbsp;<span class="ident" id="3518074">_</span><span class="op" id="3518075">,</span>&nbsp;<span class="ident" id="3518077">ident</span>&nbsp;<span class="op" id="3518083">:=</span>&nbsp;<span class="keyword" id="3518086">range</span>&nbsp;<span class="ident" id="3518092">allIdents</span><span class="op" id="3518101">(</span><span class="ident" id="3518102">idNode</span><span class="op" id="3518108">.</span><span class="ident" id="3518109">Args</span><span class="op" id="3518113">[</span><span class="num" id="3518114">0</span><span class="op" id="3518115">]</span><span class="op" id="3518116">)</span>&nbsp;<span class="op" id="3518118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518123">i</span>&nbsp;<span class="op" id="3518125">:=</span>&nbsp;<span class="ident" id="3518128">indexOfStr</span><span class="op" id="3518138">(</span><span class="ident" id="3518139">ident</span><span class="op" id="3518144">,</span>&nbsp;<span class="ident" id="3518146">s</span><span class="op" id="3518147">,</span>&nbsp;<span class="ident" id="3518149">escFnsEq</span><span class="op" id="3518157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518162">if</span>&nbsp;<span class="ident" id="3518165">i</span>&nbsp;<span class="op" id="3518167">!=</span>&nbsp;<span class="op" id="3518170">-</span><span class="num" id="3518171">1</span>&nbsp;<span class="op" id="3518173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518179">for</span>&nbsp;<span class="ident" id="3518183">_</span><span class="op" id="3518184">,</span>&nbsp;<span class="ident" id="3518186">name</span>&nbsp;<span class="op" id="3518191">:=</span>&nbsp;<span class="keyword" id="3518194">range</span>&nbsp;<span class="ident" id="3518200">s</span><span class="op" id="3518201">[</span><span class="op" id="3518202">:</span><span class="ident" id="3518203">i</span><span class="op" id="3518204">]</span>&nbsp;<span class="op" id="3518206">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518213">newCmds</span>&nbsp;<span class="op" id="3518221">=</span>&nbsp;<span class="ident" id="3518223">appendCmd</span><span class="op" id="3518232">(</span><span class="ident" id="3518233">newCmds</span><span class="op" id="3518240">,</span>&nbsp;<span class="ident" id="3518242">newIdentCmd</span><span class="op" id="3518253">(</span><span class="ident" id="3518254">name</span><span class="op" id="3518258">,</span>&nbsp;<span class="ident" id="3518260">pos</span><span class="op" id="3518263">)</span><span class="op" id="3518264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518276">s</span>&nbsp;<span class="op" id="3518278">=</span>&nbsp;<span class="ident" id="3518280">s</span><span class="op" id="3518281">[</span><span class="ident" id="3518282">i</span><span class="op" id="3518283">+</span><span class="num" id="3518284">1</span><span class="op" id="3518285">:</span><span class="op" id="3518286">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518295">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518299">newCmds</span>&nbsp;<span class="op" id="3518307">=</span>&nbsp;<span class="ident" id="3518309">appendCmd</span><span class="op" id="3518318">(</span><span class="ident" id="3518319">newCmds</span><span class="op" id="3518326">,</span>&nbsp;<span class="ident" id="3518328">idNode</span><span class="op" id="3518334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518340">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518377">for</span>&nbsp;<span class="ident" id="3518381">_</span><span class="op" id="3518382">,</span>&nbsp;<span class="ident" id="3518384">name</span>&nbsp;<span class="op" id="3518389">:=</span>&nbsp;<span class="keyword" id="3518392">range</span>&nbsp;<span class="ident" id="3518398">s</span>&nbsp;<span class="op" id="3518400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518404">newCmds</span>&nbsp;<span class="op" id="3518412">=</span>&nbsp;<span class="ident" id="3518414">appendCmd</span><span class="op" id="3518423">(</span><span class="ident" id="3518424">newCmds</span><span class="op" id="3518431">,</span>&nbsp;<span class="ident" id="3518433">newIdentCmd</span><span class="op" id="3518444">(</span><span class="ident" id="3518445">name</span><span class="op" id="3518449">,</span>&nbsp;<span class="ident" id="3518451">p</span><span class="op" id="3518452">.</span><span class="ident" id="3518453">Position</span><span class="op" id="3518461">(</span><span class="op" id="3518462">)</span><span class="op" id="3518463">)</span><span class="op" id="3518464">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518470">p</span><span class="op" id="3518471">.</span><span class="ident" id="3518472">Cmds</span>&nbsp;<span class="op" id="3518477">=</span>&nbsp;<span class="ident" id="3518479">newCmds</span><br>
<span class="lineno"></span><span class="op" id="3518487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3518490">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="3518570">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="3518584">var</span>&nbsp;<span class="ident" id="3518588">redundantFuncs</span>&nbsp;<span class="op" id="3518603">=</span>&nbsp;<span class="keyword" id="3518605">map</span><span class="op" id="3518608">[</span><span class="builtintype" id="3518609">string</span><span class="op" id="3518615">]</span><span class="keyword" id="3518616">map</span><span class="op" id="3518619">[</span><span class="builtintype" id="3518620">string</span><span class="op" id="3518626">]</span><span class="builtintype" id="3518627">bool</span><span class="op" id="3518631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518634">&#34;html_template_commentescaper&#34;</span><span class="op" id="3518664">:</span>&nbsp;<span class="op" id="3518666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518670">&#34;html_template_attrescaper&#34;</span><span class="op" id="3518697">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3518702">true</span><span class="op" id="3518706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518710">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="3518740">:</span>&nbsp;<span class="builtintype" id="3518742">true</span><span class="op" id="3518746">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518750">&#34;html_template_htmlescaper&#34;</span><span class="op" id="3518777">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3518782">true</span><span class="op" id="3518786">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518789">}</span><span class="op" id="3518790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518793">&#34;html_template_cssescaper&#34;</span><span class="op" id="3518819">:</span>&nbsp;<span class="op" id="3518821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518825">&#34;html_template_attrescaper&#34;</span><span class="op" id="3518852">:</span>&nbsp;<span class="builtintype" id="3518854">true</span><span class="op" id="3518858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518861">}</span><span class="op" id="3518862">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518865">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="3518896">:</span>&nbsp;<span class="op" id="3518898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518902">&#34;html_template_attrescaper&#34;</span><span class="op" id="3518929">:</span>&nbsp;<span class="builtintype" id="3518931">true</span><span class="op" id="3518935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518938">}</span><span class="op" id="3518939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518942">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="3518970">:</span>&nbsp;<span class="op" id="3518972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3518976">&#34;html_template_attrescaper&#34;</span><span class="op" id="3519003">:</span>&nbsp;<span class="builtintype" id="3519005">true</span><span class="op" id="3519009">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519012">}</span><span class="op" id="3519013">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519016">&#34;html_template_urlescaper&#34;</span><span class="op" id="3519042">:</span>&nbsp;<span class="op" id="3519044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3519048">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="3519077">:</span>&nbsp;<span class="builtintype" id="3519079">true</span><span class="op" id="3519083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519086">}</span><span class="op" id="3519087">,</span><br>
<span class="lineno"></span><span class="op" id="3519089">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="3519092">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="3519166">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="3519215">func</span>&nbsp;<span class="ident" id="3519220">appendCmd</span><span class="op" id="3519229">(</span><span class="ident" id="3519230">cmds</span>&nbsp;<span class="op" id="3519235">[</span><span class="op" id="3519236">]</span><span class="op" id="3519237">*</span><span class="ident" id="3519238">parse</span><span class="op" id="3519243">.</span><span class="ident" id="3519244">CommandNode</span><span class="op" id="3519255">,</span>&nbsp;<span class="ident" id="3519257">cmd</span>&nbsp;<span class="op" id="3519261">*</span><span class="ident" id="3519262">parse</span><span class="op" id="3519267">.</span><span class="ident" id="3519268">CommandNode</span><span class="op" id="3519279">)</span>&nbsp;<span class="op" id="3519281">[</span><span class="op" id="3519282">]</span><span class="op" id="3519283">*</span><span class="ident" id="3519284">parse</span><span class="op" id="3519289">.</span><span class="ident" id="3519290">CommandNode</span>&nbsp;<span class="op" id="3519302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519305">if</span>&nbsp;<span class="ident" id="3519308">n</span>&nbsp;<span class="op" id="3519310">:=</span>&nbsp;<span class="builtinfunc" id="3519313">len</span><span class="op" id="3519316">(</span><span class="ident" id="3519317">cmds</span><span class="op" id="3519321">)</span><span class="op" id="3519322">;</span>&nbsp;<span class="ident" id="3519324">n</span>&nbsp;<span class="op" id="3519326">!=</span>&nbsp;<span class="num" id="3519329">0</span>&nbsp;<span class="op" id="3519331">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519335">last</span><span class="op" id="3519339">,</span>&nbsp;<span class="ident" id="3519341">ok</span>&nbsp;<span class="op" id="3519344">:=</span>&nbsp;<span class="ident" id="3519347">cmds</span><span class="op" id="3519351">[</span><span class="ident" id="3519352">n</span><span class="op" id="3519353">-</span><span class="num" id="3519354">1</span><span class="op" id="3519355">]</span><span class="op" id="3519356">.</span><span class="ident" id="3519357">Args</span><span class="op" id="3519361">[</span><span class="num" id="3519362">0</span><span class="op" id="3519363">]</span><span class="op" id="3519364">.</span><span class="op" id="3519365">(</span><span class="op" id="3519366">*</span><span class="ident" id="3519367">parse</span><span class="op" id="3519372">.</span><span class="ident" id="3519373">IdentifierNode</span><span class="op" id="3519387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519391">next</span><span class="op" id="3519395">,</span>&nbsp;<span class="ident" id="3519397">_</span>&nbsp;<span class="op" id="3519399">:=</span>&nbsp;<span class="ident" id="3519402">cmd</span><span class="op" id="3519405">.</span><span class="ident" id="3519406">Args</span><span class="op" id="3519410">[</span><span class="num" id="3519411">0</span><span class="op" id="3519412">]</span><span class="op" id="3519413">.</span><span class="op" id="3519414">(</span><span class="op" id="3519415">*</span><span class="ident" id="3519416">parse</span><span class="op" id="3519421">.</span><span class="ident" id="3519422">IdentifierNode</span><span class="op" id="3519436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519440">if</span>&nbsp;<span class="ident" id="3519443">ok</span>&nbsp;<span class="op" id="3519446">&amp;&amp;</span>&nbsp;<span class="ident" id="3519449">redundantFuncs</span><span class="op" id="3519463">[</span><span class="ident" id="3519464">last</span><span class="op" id="3519468">.</span><span class="ident" id="3519469">Ident</span><span class="op" id="3519474">]</span><span class="op" id="3519475">[</span><span class="ident" id="3519476">next</span><span class="op" id="3519480">.</span><span class="ident" id="3519481">Ident</span><span class="op" id="3519486">]</span>&nbsp;<span class="op" id="3519488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519493">return</span>&nbsp;<span class="ident" id="3519500">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519507">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519513">return</span>&nbsp;<span class="builtinfunc" id="3519520">append</span><span class="op" id="3519526">(</span><span class="ident" id="3519527">cmds</span><span class="op" id="3519531">,</span>&nbsp;<span class="ident" id="3519533">cmd</span><span class="op" id="3519536">)</span><br>
<span class="lineno"></span><span class="op" id="3519538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3519541">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="3519621">func</span>&nbsp;<span class="ident" id="3519626">indexOfStr</span><span class="op" id="3519636">(</span><span class="ident" id="3519637">s</span>&nbsp;<span class="builtintype" id="3519639">string</span><span class="op" id="3519645">,</span>&nbsp;<span class="ident" id="3519647">strs</span>&nbsp;<span class="op" id="3519652">[</span><span class="op" id="3519653">]</span><span class="builtintype" id="3519654">string</span><span class="op" id="3519660">,</span>&nbsp;<span class="ident" id="3519662">eq</span>&nbsp;<span class="keyword" id="3519665">func</span><span class="op" id="3519669">(</span><span class="ident" id="3519670">a</span><span class="op" id="3519671">,</span>&nbsp;<span class="ident" id="3519673">b</span>&nbsp;<span class="builtintype" id="3519675">string</span><span class="op" id="3519681">)</span>&nbsp;<span class="builtintype" id="3519683">bool</span><span class="op" id="3519687">)</span>&nbsp;<span class="builtintype" id="3519689">int</span>&nbsp;<span class="op" id="3519693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519696">for</span>&nbsp;<span class="ident" id="3519700">i</span><span class="op" id="3519701">,</span>&nbsp;<span class="ident" id="3519703">t</span>&nbsp;<span class="op" id="3519705">:=</span>&nbsp;<span class="keyword" id="3519708">range</span>&nbsp;<span class="ident" id="3519714">strs</span>&nbsp;<span class="op" id="3519719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519723">if</span>&nbsp;<span class="ident" id="3519726">eq</span><span class="op" id="3519728">(</span><span class="ident" id="3519729">s</span><span class="op" id="3519730">,</span>&nbsp;<span class="ident" id="3519732">t</span><span class="op" id="3519733">)</span>&nbsp;<span class="op" id="3519735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519740">return</span>&nbsp;<span class="ident" id="3519747">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519751">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519757">return</span>&nbsp;<span class="op" id="3519764">-</span><span class="num" id="3519765">1</span><br>
<span class="lineno"></span><span class="op" id="3519767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3519770">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="3519841">func</span>&nbsp;<span class="ident" id="3519846">escFnsEq</span><span class="op" id="3519854">(</span><span class="ident" id="3519855">a</span><span class="op" id="3519856">,</span>&nbsp;<span class="ident" id="3519858">b</span>&nbsp;<span class="builtintype" id="3519860">string</span><span class="op" id="3519866">)</span>&nbsp;<span class="builtintype" id="3519868">bool</span>&nbsp;<span class="op" id="3519873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519876">if</span>&nbsp;<span class="ident" id="3519879">e</span>&nbsp;<span class="op" id="3519881">:=</span>&nbsp;<span class="ident" id="3519884">equivEscapers</span><span class="op" id="3519897">[</span><span class="ident" id="3519898">a</span><span class="op" id="3519899">]</span><span class="op" id="3519900">;</span>&nbsp;<span class="ident" id="3519902">e</span>&nbsp;<span class="op" id="3519904">!=</span>&nbsp;<span class="string" id="3519907">&#34;&#34;</span>&nbsp;<span class="op" id="3519910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519914">a</span>&nbsp;<span class="op" id="3519916">=</span>&nbsp;<span class="ident" id="3519918">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519924">if</span>&nbsp;<span class="ident" id="3519927">e</span>&nbsp;<span class="op" id="3519929">:=</span>&nbsp;<span class="ident" id="3519932">equivEscapers</span><span class="op" id="3519945">[</span><span class="ident" id="3519946">b</span><span class="op" id="3519947">]</span><span class="op" id="3519948">;</span>&nbsp;<span class="ident" id="3519950">e</span>&nbsp;<span class="op" id="3519952">!=</span>&nbsp;<span class="string" id="3519955">&#34;&#34;</span>&nbsp;<span class="op" id="3519958">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519962">b</span>&nbsp;<span class="op" id="3519964">=</span>&nbsp;<span class="ident" id="3519966">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519972">return</span>&nbsp;<span class="ident" id="3519979">a</span>&nbsp;<span class="op" id="3519981">==</span>&nbsp;<span class="ident" id="3519984">b</span><br>
<span class="lineno"></span><span class="op" id="3519986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="3519989">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3520060">func</span>&nbsp;<span class="ident" id="3520065">newIdentCmd</span><span class="op" id="3520076">(</span><span class="ident" id="3520077">identifier</span>&nbsp;<span class="builtintype" id="3520088">string</span><span class="op" id="3520094">,</span>&nbsp;<span class="ident" id="3520096">pos</span>&nbsp;<span class="ident" id="3520100">parse</span><span class="op" id="3520105">.</span><span class="ident" id="3520106">Pos</span><span class="op" id="3520109">)</span>&nbsp;<span class="op" id="3520111">*</span><span class="ident" id="3520112">parse</span><span class="op" id="3520117">.</span><span class="ident" id="3520118">CommandNode</span>&nbsp;<span class="op" id="3520130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520133">return</span>&nbsp;<span class="op" id="3520140">&amp;</span><span class="ident" id="3520141">parse</span><span class="op" id="3520146">.</span><span class="ident" id="3520147">CommandNode</span><span class="op" id="3520158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520162">NodeType</span><span class="op" id="3520170">:</span>&nbsp;<span class="ident" id="3520172">parse</span><span class="op" id="3520177">.</span><span class="ident" id="3520178">NodeCommand</span><span class="op" id="3520189">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520193">Args</span><span class="op" id="3520197">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3520203">[</span><span class="op" id="3520204">]</span><span class="ident" id="3520205">parse</span><span class="op" id="3520210">.</span><span class="ident" id="3520211">Node</span><span class="op" id="3520215">{</span><span class="ident" id="3520216">parse</span><span class="op" id="3520221">.</span><span class="ident" id="3520222">NewIdentifier</span><span class="op" id="3520235">(</span><span class="ident" id="3520236">identifier</span><span class="op" id="3520246">)</span><span class="op" id="3520247">.</span><span class="ident" id="3520248">SetTree</span><span class="op" id="3520255">(</span><span class="ident" id="3520256">nil</span><span class="op" id="3520259">)</span><span class="op" id="3520260">.</span><span class="ident" id="3520261">SetPos</span><span class="op" id="3520267">(</span><span class="ident" id="3520268">pos</span><span class="op" id="3520271">)</span><span class="op" id="3520272">}</span><span class="op" id="3520273">,</span>&nbsp;<span class="comment" id="3520275">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520294">}</span><br>
<span class="lineno"></span><span class="op" id="3520296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3520299">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3520374">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="3520413">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="3520438">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="3520456">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="3520535">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="3520554">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="3520613">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="3520676">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="3520754">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3520786">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3520852">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="3520917">func</span>&nbsp;<span class="ident" id="3520922">nudge</span><span class="op" id="3520927">(</span><span class="ident" id="3520928">c</span>&nbsp;<span class="ident" id="3520930">context</span><span class="op" id="3520937">)</span>&nbsp;<span class="ident" id="3520939">context</span>&nbsp;<span class="op" id="3520947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520950">switch</span>&nbsp;<span class="ident" id="3520957">c</span><span class="op" id="3520958">.</span><span class="ident" id="3520959">state</span>&nbsp;<span class="op" id="3520965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520968">case</span>&nbsp;<span class="ident" id="3520973">stateTag</span><span class="op" id="3520981">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520985">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521044">c</span><span class="op" id="3521045">.</span><span class="ident" id="3521046">state</span>&nbsp;<span class="op" id="3521052">=</span>&nbsp;<span class="ident" id="3521054">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521069">case</span>&nbsp;<span class="ident" id="3521074">stateBeforeValue</span><span class="op" id="3521090">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521094">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521156">c</span><span class="op" id="3521157">.</span><span class="ident" id="3521158">state</span><span class="op" id="3521163">,</span>&nbsp;<span class="ident" id="3521165">c</span><span class="op" id="3521166">.</span><span class="ident" id="3521167">delim</span><span class="op" id="3521172">,</span>&nbsp;<span class="ident" id="3521174">c</span><span class="op" id="3521175">.</span><span class="ident" id="3521176">attr</span>&nbsp;<span class="op" id="3521181">=</span>&nbsp;<span class="ident" id="3521183">attrStartStates</span><span class="op" id="3521198">[</span><span class="ident" id="3521199">c</span><span class="op" id="3521200">.</span><span class="ident" id="3521201">attr</span><span class="op" id="3521205">]</span><span class="op" id="3521206">,</span>&nbsp;<span class="ident" id="3521208">delimSpaceOrTagEnd</span><span class="op" id="3521226">,</span>&nbsp;<span class="ident" id="3521228">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521238">case</span>&nbsp;<span class="ident" id="3521243">stateAfterName</span><span class="op" id="3521257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521261">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521320">c</span><span class="op" id="3521321">.</span><span class="ident" id="3521322">state</span><span class="op" id="3521327">,</span>&nbsp;<span class="ident" id="3521329">c</span><span class="op" id="3521330">.</span><span class="ident" id="3521331">attr</span>&nbsp;<span class="op" id="3521336">=</span>&nbsp;<span class="ident" id="3521338">stateAttrName</span><span class="op" id="3521351">,</span>&nbsp;<span class="ident" id="3521353">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521366">return</span>&nbsp;<span class="ident" id="3521373">c</span><br>
<span class="lineno"></span><span class="op" id="3521375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="3521378">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3521453">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3521532">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="3521562">func</span>&nbsp;<span class="ident" id="3521567">join</span><span class="op" id="3521571">(</span><span class="ident" id="3521572">a</span><span class="op" id="3521573">,</span>&nbsp;<span class="ident" id="3521575">b</span>&nbsp;<span class="ident" id="3521577">context</span><span class="op" id="3521584">,</span>&nbsp;<span class="ident" id="3521586">node</span>&nbsp;<span class="ident" id="3521591">parse</span><span class="op" id="3521596">.</span><span class="ident" id="3521597">Node</span><span class="op" id="3521601">,</span>&nbsp;<span class="ident" id="3521603">nodeName</span>&nbsp;<span class="builtintype" id="3521612">string</span><span class="op" id="3521618">)</span>&nbsp;<span class="ident" id="3521620">context</span>&nbsp;<span class="op" id="3521628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521631">if</span>&nbsp;<span class="ident" id="3521634">a</span><span class="op" id="3521635">.</span><span class="ident" id="3521636">state</span>&nbsp;<span class="op" id="3521642">==</span>&nbsp;<span class="ident" id="3521645">stateError</span>&nbsp;<span class="op" id="3521656">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521660">return</span>&nbsp;<span class="ident" id="3521667">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521673">if</span>&nbsp;<span class="ident" id="3521676">b</span><span class="op" id="3521677">.</span><span class="ident" id="3521678">state</span>&nbsp;<span class="op" id="3521684">==</span>&nbsp;<span class="ident" id="3521687">stateError</span>&nbsp;<span class="op" id="3521698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521702">return</span>&nbsp;<span class="ident" id="3521709">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521712">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521715">if</span>&nbsp;<span class="ident" id="3521718">a</span><span class="op" id="3521719">.</span><span class="ident" id="3521720">eq</span><span class="op" id="3521722">(</span><span class="ident" id="3521723">b</span><span class="op" id="3521724">)</span>&nbsp;<span class="op" id="3521726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521730">return</span>&nbsp;<span class="ident" id="3521737">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521744">c</span>&nbsp;<span class="op" id="3521746">:=</span>&nbsp;<span class="ident" id="3521749">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521752">c</span><span class="op" id="3521753">.</span><span class="ident" id="3521754">urlPart</span>&nbsp;<span class="op" id="3521762">=</span>&nbsp;<span class="ident" id="3521764">b</span><span class="op" id="3521765">.</span><span class="ident" id="3521766">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521775">if</span>&nbsp;<span class="ident" id="3521778">c</span><span class="op" id="3521779">.</span><span class="ident" id="3521780">eq</span><span class="op" id="3521782">(</span><span class="ident" id="3521783">b</span><span class="op" id="3521784">)</span>&nbsp;<span class="op" id="3521786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521790">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521832">c</span><span class="op" id="3521833">.</span><span class="ident" id="3521834">urlPart</span>&nbsp;<span class="op" id="3521842">=</span>&nbsp;<span class="ident" id="3521844">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521861">return</span>&nbsp;<span class="ident" id="3521868">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521875">c</span>&nbsp;<span class="op" id="3521877">=</span>&nbsp;<span class="ident" id="3521879">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521882">c</span><span class="op" id="3521883">.</span><span class="ident" id="3521884">jsCtx</span>&nbsp;<span class="op" id="3521890">=</span>&nbsp;<span class="ident" id="3521892">b</span><span class="op" id="3521893">.</span><span class="ident" id="3521894">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521901">if</span>&nbsp;<span class="ident" id="3521904">c</span><span class="op" id="3521905">.</span><span class="ident" id="3521906">eq</span><span class="op" id="3521908">(</span><span class="ident" id="3521909">b</span><span class="op" id="3521910">)</span>&nbsp;<span class="op" id="3521912">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521916">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521956">c</span><span class="op" id="3521957">.</span><span class="ident" id="3521958">jsCtx</span>&nbsp;<span class="op" id="3521964">=</span>&nbsp;<span class="ident" id="3521966">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521981">return</span>&nbsp;<span class="ident" id="3521988">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521995">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522052">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522072">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522109">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522173">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522203">if</span>&nbsp;<span class="ident" id="3522206">c</span><span class="op" id="3522207">,</span>&nbsp;<span class="ident" id="3522209">d</span>&nbsp;<span class="op" id="3522211">:=</span>&nbsp;<span class="ident" id="3522214">nudge</span><span class="op" id="3522219">(</span><span class="ident" id="3522220">a</span><span class="op" id="3522221">)</span><span class="op" id="3522222">,</span>&nbsp;<span class="ident" id="3522224">nudge</span><span class="op" id="3522229">(</span><span class="ident" id="3522230">b</span><span class="op" id="3522231">)</span><span class="op" id="3522232">;</span>&nbsp;<span class="op" id="3522234">!</span><span class="op" id="3522235">(</span><span class="ident" id="3522236">c</span><span class="op" id="3522237">.</span><span class="ident" id="3522238">eq</span><span class="op" id="3522240">(</span><span class="ident" id="3522241">a</span><span class="op" id="3522242">)</span>&nbsp;<span class="op" id="3522244">&amp;&amp;</span>&nbsp;<span class="ident" id="3522247">d</span><span class="op" id="3522248">.</span><span class="ident" id="3522249">eq</span><span class="op" id="3522251">(</span><span class="ident" id="3522252">b</span><span class="op" id="3522253">)</span><span class="op" id="3522254">)</span>&nbsp;<span class="op" id="3522256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522260">if</span>&nbsp;<span class="ident" id="3522263">e</span>&nbsp;<span class="op" id="3522265">:=</span>&nbsp;<span class="ident" id="3522268">join</span><span class="op" id="3522272">(</span><span class="ident" id="3522273">c</span><span class="op" id="3522274">,</span>&nbsp;<span class="ident" id="3522276">d</span><span class="op" id="3522277">,</span>&nbsp;<span class="ident" id="3522279">node</span><span class="op" id="3522283">,</span>&nbsp;<span class="ident" id="3522285">nodeName</span><span class="op" id="3522293">)</span><span class="op" id="3522294">;</span>&nbsp;<span class="ident" id="3522296">e</span><span class="op" id="3522297">.</span><span class="ident" id="3522298">state</span>&nbsp;<span class="op" id="3522304">!=</span>&nbsp;<span class="ident" id="3522307">stateError</span>&nbsp;<span class="op" id="3522318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522323">return</span>&nbsp;<span class="ident" id="3522330">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522337">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522341">return</span>&nbsp;<span class="ident" id="3522348">context</span><span class="op" id="3522355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522359">state</span><span class="op" id="3522364">:</span>&nbsp;<span class="ident" id="3522366">stateError</span><span class="op" id="3522376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522380">err</span><span class="op" id="3522383">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3522387">errorf</span><span class="op" id="3522393">(</span><span class="ident" id="3522394">ErrBranchEnd</span><span class="op" id="3522406">,</span>&nbsp;<span class="ident" id="3522408">node</span><span class="op" id="3522412">,</span>&nbsp;<span class="num" id="3522414">0</span><span class="op" id="3522415">,</span>&nbsp;<span class="string" id="3522417">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="3522468">,</span>&nbsp;<span class="ident" id="3522470">nodeName</span><span class="op" id="3522478">,</span>&nbsp;<span class="ident" id="3522480">a</span><span class="op" id="3522481">,</span>&nbsp;<span class="ident" id="3522483">b</span><span class="op" id="3522484">)</span><span class="op" id="3522485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522488">}</span><br>
<span class="lineno">410</span><span class="op" id="3522490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3522493">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3522567">func</span>&nbsp;<span class="op" id="3522572">(</span><span class="ident" id="3522573">e</span>&nbsp;<span class="op" id="3522575">*</span><span class="ident" id="3522576">escaper</span><span class="op" id="3522583">)</span>&nbsp;<span class="ident" id="3522585">escapeBranch</span><span class="op" id="3522597">(</span><span class="ident" id="3522598">c</span>&nbsp;<span class="ident" id="3522600">context</span><span class="op" id="3522607">,</span>&nbsp;<span class="ident" id="3522609">n</span>&nbsp;<span class="op" id="3522611">*</span><span class="ident" id="3522612">parse</span><span class="op" id="3522617">.</span><span class="ident" id="3522618">BranchNode</span><span class="op" id="3522628">,</span>&nbsp;<span class="ident" id="3522630">nodeName</span>&nbsp;<span class="builtintype" id="3522639">string</span><span class="op" id="3522645">)</span>&nbsp;<span class="ident" id="3522647">context</span>&nbsp;<span class="op" id="3522655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522658">c0</span>&nbsp;<span class="op" id="3522661">:=</span>&nbsp;<span class="ident" id="3522664">e</span><span class="op" id="3522665">.</span><span class="ident" id="3522666">escapeList</span><span class="op" id="3522676">(</span><span class="ident" id="3522677">c</span><span class="op" id="3522678">,</span>&nbsp;<span class="ident" id="3522680">n</span><span class="op" id="3522681">.</span><span class="ident" id="3522682">List</span><span class="op" id="3522686">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522689">if</span>&nbsp;<span class="ident" id="3522692">nodeName</span>&nbsp;<span class="op" id="3522701">==</span>&nbsp;<span class="string" id="3522704">&#34;range&#34;</span>&nbsp;<span class="op" id="3522712">&amp;&amp;</span>&nbsp;<span class="ident" id="3522715">c0</span><span class="op" id="3522717">.</span><span class="ident" id="3522718">state</span>&nbsp;<span class="op" id="3522724">!=</span>&nbsp;<span class="ident" id="3522727">stateError</span>&nbsp;<span class="op" id="3522738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522742">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522811">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522880">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522912">c1</span><span class="op" id="3522914">,</span>&nbsp;<span class="ident" id="3522916">_</span>&nbsp;<span class="op" id="3522918">:=</span>&nbsp;<span class="ident" id="3522921">e</span><span class="op" id="3522922">.</span><span class="ident" id="3522923">escapeListConditionally</span><span class="op" id="3522946">(</span><span class="ident" id="3522947">c0</span><span class="op" id="3522949">,</span>&nbsp;<span class="ident" id="3522951">n</span><span class="op" id="3522952">.</span><span class="ident" id="3522953">List</span><span class="op" id="3522957">,</span>&nbsp;<span class="ident" id="3522959">nil</span><span class="op" id="3522962">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522966">c0</span>&nbsp;<span class="op" id="3522969">=</span>&nbsp;<span class="ident" id="3522971">join</span><span class="op" id="3522975">(</span><span class="ident" id="3522976">c0</span><span class="op" id="3522978">,</span>&nbsp;<span class="ident" id="3522980">c1</span><span class="op" id="3522982">,</span>&nbsp;<span class="ident" id="3522984">n</span><span class="op" id="3522985">,</span>&nbsp;<span class="ident" id="3522987">nodeName</span><span class="op" id="3522995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522999">if</span>&nbsp;<span class="ident" id="3523002">c0</span><span class="op" id="3523004">.</span><span class="ident" id="3523005">state</span>&nbsp;<span class="op" id="3523011">==</span>&nbsp;<span class="ident" id="3523014">stateError</span>&nbsp;<span class="op" id="3523025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523030">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523087">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523144">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523171">c0</span><span class="op" id="3523173">.</span><span class="ident" id="3523174">err</span><span class="op" id="3523177">.</span><span class="ident" id="3523178">Line</span>&nbsp;<span class="op" id="3523183">=</span>&nbsp;<span class="ident" id="3523185">n</span><span class="op" id="3523186">.</span><span class="ident" id="3523187">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523195">c0</span><span class="op" id="3523197">.</span><span class="ident" id="3523198">err</span><span class="op" id="3523201">.</span><span class="ident" id="3523202">Description</span>&nbsp;<span class="op" id="3523214">=</span>&nbsp;<span class="string" id="3523216">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="3523243">+</span>&nbsp;<span class="ident" id="3523245">c0</span><span class="op" id="3523247">.</span><span class="ident" id="3523248">err</span><span class="op" id="3523251">.</span><span class="ident" id="3523252">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523267">return</span>&nbsp;<span class="ident" id="3523274">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523282">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523285">c1</span>&nbsp;<span class="op" id="3523288">:=</span>&nbsp;<span class="ident" id="3523291">e</span><span class="op" id="3523292">.</span><span class="ident" id="3523293">escapeList</span><span class="op" id="3523303">(</span><span class="ident" id="3523304">c</span><span class="op" id="3523305">,</span>&nbsp;<span class="ident" id="3523307">n</span><span class="op" id="3523308">.</span><span class="ident" id="3523309">ElseList</span><span class="op" id="3523317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523320">return</span>&nbsp;<span class="ident" id="3523327">join</span><span class="op" id="3523331">(</span><span class="ident" id="3523332">c0</span><span class="op" id="3523334">,</span>&nbsp;<span class="ident" id="3523336">c1</span><span class="op" id="3523338">,</span>&nbsp;<span class="ident" id="3523340">n</span><span class="op" id="3523341">,</span>&nbsp;<span class="ident" id="3523343">nodeName</span><span class="op" id="3523351">)</span><br>
<span class="lineno"></span><span class="op" id="3523353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3523356">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="3523400">func</span>&nbsp;<span class="op" id="3523405">(</span><span class="ident" id="3523406">e</span>&nbsp;<span class="op" id="3523408">*</span><span class="ident" id="3523409">escaper</span><span class="op" id="3523416">)</span>&nbsp;<span class="ident" id="3523418">escapeList</span><span class="op" id="3523428">(</span><span class="ident" id="3523429">c</span>&nbsp;<span class="ident" id="3523431">context</span><span class="op" id="3523438">,</span>&nbsp;<span class="ident" id="3523440">n</span>&nbsp;<span class="op" id="3523442">*</span><span class="ident" id="3523443">parse</span><span class="op" id="3523448">.</span><span class="ident" id="3523449">ListNode</span><span class="op" id="3523457">)</span>&nbsp;<span class="ident" id="3523459">context</span>&nbsp;<span class="op" id="3523467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523470">if</span>&nbsp;<span class="ident" id="3523473">n</span>&nbsp;<span class="op" id="3523475">==</span>&nbsp;<span class="ident" id="3523478">nil</span>&nbsp;<span class="op" id="3523482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523486">return</span>&nbsp;<span class="ident" id="3523493">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523499">for</span>&nbsp;<span class="ident" id="3523503">_</span><span class="op" id="3523504">,</span>&nbsp;<span class="ident" id="3523506">m</span>&nbsp;<span class="op" id="3523508">:=</span>&nbsp;<span class="keyword" id="3523511">range</span>&nbsp;<span class="ident" id="3523517">n</span><span class="op" id="3523518">.</span><span class="ident" id="3523519">Nodes</span>&nbsp;<span class="op" id="3523525">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523529">c</span>&nbsp;<span class="op" id="3523531">=</span>&nbsp;<span class="ident" id="3523533">e</span><span class="op" id="3523534">.</span><span class="ident" id="3523535">escape</span><span class="op" id="3523541">(</span><span class="ident" id="3523542">c</span><span class="op" id="3523543">,</span>&nbsp;<span class="ident" id="3523545">m</span><span class="op" id="3523546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523552">return</span>&nbsp;<span class="ident" id="3523559">c</span><br>
<span class="lineno"></span><span class="op" id="3523561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3523564">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3523640">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="3523712">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="3523792">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="3523839">func</span>&nbsp;<span class="op" id="3523844">(</span><span class="ident" id="3523845">e</span>&nbsp;<span class="op" id="3523847">*</span><span class="ident" id="3523848">escaper</span><span class="op" id="3523855">)</span>&nbsp;<span class="ident" id="3523857">escapeListConditionally</span><span class="op" id="3523880">(</span><span class="ident" id="3523881">c</span>&nbsp;<span class="ident" id="3523883">context</span><span class="op" id="3523890">,</span>&nbsp;<span class="ident" id="3523892">n</span>&nbsp;<span class="op" id="3523894">*</span><span class="ident" id="3523895">parse</span><span class="op" id="3523900">.</span><span class="ident" id="3523901">ListNode</span><span class="op" id="3523909">,</span>&nbsp;<span class="ident" id="3523911">filter</span>&nbsp;<span class="keyword" id="3523918">func</span><span class="op" id="3523922">(</span><span class="op" id="3523923">*</span><span class="ident" id="3523924">escaper</span><span class="op" id="3523931">,</span>&nbsp;<span class="ident" id="3523933">context</span><span class="op" id="3523940">)</span>&nbsp;<span class="builtintype" id="3523942">bool</span><span class="op" id="3523946">)</span>&nbsp;<span class="op" id="3523948">(</span><span class="ident" id="3523949">context</span><span class="op" id="3523956">,</span>&nbsp;<span class="builtintype" id="3523958">bool</span><span class="op" id="3523962">)</span>&nbsp;<span class="op" id="3523964">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523967">e1</span>&nbsp;<span class="op" id="3523970">:=</span>&nbsp;<span class="ident" id="3523973">newEscaper</span><span class="op" id="3523983">(</span><span class="ident" id="3523984">e</span><span class="op" id="3523985">.</span><span class="ident" id="3523986">tmpl</span><span class="op" id="3523990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523993">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524034">for</span>&nbsp;<span class="ident" id="3524038">k</span><span class="op" id="3524039">,</span>&nbsp;<span class="ident" id="3524041">v</span>&nbsp;<span class="op" id="3524043">:=</span>&nbsp;<span class="keyword" id="3524046">range</span>&nbsp;<span class="ident" id="3524052">e</span><span class="op" id="3524053">.</span><span class="ident" id="3524054">output</span>&nbsp;<span class="op" id="3524061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524065">e1</span><span class="op" id="3524067">.</span><span class="ident" id="3524068">output</span><span class="op" id="3524074">[</span><span class="ident" id="3524075">k</span><span class="op" id="3524076">]</span>&nbsp;<span class="op" id="3524078">=</span>&nbsp;<span class="ident" id="3524080">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524083">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524086">c</span>&nbsp;<span class="op" id="3524088">=</span>&nbsp;<span class="ident" id="3524090">e1</span><span class="op" id="3524092">.</span><span class="ident" id="3524093">escapeList</span><span class="op" id="3524103">(</span><span class="ident" id="3524104">c</span><span class="op" id="3524105">,</span>&nbsp;<span class="ident" id="3524107">n</span><span class="op" id="3524108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524111">ok</span>&nbsp;<span class="op" id="3524114">:=</span>&nbsp;<span class="ident" id="3524117">filter</span>&nbsp;<span class="op" id="3524124">!=</span>&nbsp;<span class="ident" id="3524127">nil</span>&nbsp;<span class="op" id="3524131">&amp;&amp;</span>&nbsp;<span class="ident" id="3524134">filter</span><span class="op" id="3524140">(</span><span class="ident" id="3524141">e1</span><span class="op" id="3524143">,</span>&nbsp;<span class="ident" id="3524145">c</span><span class="op" id="3524146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524149">if</span>&nbsp;<span class="ident" id="3524152">ok</span>&nbsp;<span class="op" id="3524155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524159">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524211">for</span>&nbsp;<span class="ident" id="3524215">k</span><span class="op" id="3524216">,</span>&nbsp;<span class="ident" id="3524218">v</span>&nbsp;<span class="op" id="3524220">:=</span>&nbsp;<span class="keyword" id="3524223">range</span>&nbsp;<span class="ident" id="3524229">e1</span><span class="op" id="3524231">.</span><span class="ident" id="3524232">output</span>&nbsp;<span class="op" id="3524239">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524244">e</span><span class="op" id="3524245">.</span><span class="ident" id="3524246">output</span><span class="op" id="3524252">[</span><span class="ident" id="3524253">k</span><span class="op" id="3524254">]</span>&nbsp;<span class="op" id="3524256">=</span>&nbsp;<span class="ident" id="3524258">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524266">for</span>&nbsp;<span class="ident" id="3524270">k</span><span class="op" id="3524271">,</span>&nbsp;<span class="ident" id="3524273">v</span>&nbsp;<span class="op" id="3524275">:=</span>&nbsp;<span class="keyword" id="3524278">range</span>&nbsp;<span class="ident" id="3524284">e1</span><span class="op" id="3524286">.</span><span class="ident" id="3524287">derived</span>&nbsp;<span class="op" id="3524295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524300">e</span><span class="op" id="3524301">.</span><span class="ident" id="3524302">derived</span><span class="op" id="3524309">[</span><span class="ident" id="3524310">k</span><span class="op" id="3524311">]</span>&nbsp;<span class="op" id="3524313">=</span>&nbsp;<span class="ident" id="3524315">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524319">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524323">for</span>&nbsp;<span class="ident" id="3524327">k</span><span class="op" id="3524328">,</span>&nbsp;<span class="ident" id="3524330">v</span>&nbsp;<span class="op" id="3524332">:=</span>&nbsp;<span class="keyword" id="3524335">range</span>&nbsp;<span class="ident" id="3524341">e1</span><span class="op" id="3524343">.</span><span class="ident" id="3524344">called</span>&nbsp;<span class="op" id="3524351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524356">e</span><span class="op" id="3524357">.</span><span class="ident" id="3524358">called</span><span class="op" id="3524364">[</span><span class="ident" id="3524365">k</span><span class="op" id="3524366">]</span>&nbsp;<span class="op" id="3524368">=</span>&nbsp;<span class="ident" id="3524370">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524378">for</span>&nbsp;<span class="ident" id="3524382">k</span><span class="op" id="3524383">,</span>&nbsp;<span class="ident" id="3524385">v</span>&nbsp;<span class="op" id="3524387">:=</span>&nbsp;<span class="keyword" id="3524390">range</span>&nbsp;<span class="ident" id="3524396">e1</span><span class="op" id="3524398">.</span><span class="ident" id="3524399">actionNodeEdits</span>&nbsp;<span class="op" id="3524415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524420">e</span><span class="op" id="3524421">.</span><span class="ident" id="3524422">editActionNode</span><span class="op" id="3524436">(</span><span class="ident" id="3524437">k</span><span class="op" id="3524438">,</span>&nbsp;<span class="ident" id="3524440">v</span><span class="op" id="3524441">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524449">for</span>&nbsp;<span class="ident" id="3524453">k</span><span class="op" id="3524454">,</span>&nbsp;<span class="ident" id="3524456">v</span>&nbsp;<span class="op" id="3524458">:=</span>&nbsp;<span class="keyword" id="3524461">range</span>&nbsp;<span class="ident" id="3524467">e1</span><span class="op" id="3524469">.</span><span class="ident" id="3524470">templateNodeEdits</span>&nbsp;<span class="op" id="3524488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524493">e</span><span class="op" id="3524494">.</span><span class="ident" id="3524495">editTemplateNode</span><span class="op" id="3524511">(</span><span class="ident" id="3524512">k</span><span class="op" id="3524513">,</span>&nbsp;<span class="ident" id="3524515">v</span><span class="op" id="3524516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524524">for</span>&nbsp;<span class="ident" id="3524528">k</span><span class="op" id="3524529">,</span>&nbsp;<span class="ident" id="3524531">v</span>&nbsp;<span class="op" id="3524533">:=</span>&nbsp;<span class="keyword" id="3524536">range</span>&nbsp;<span class="ident" id="3524542">e1</span><span class="op" id="3524544">.</span><span class="ident" id="3524545">textNodeEdits</span>&nbsp;<span class="op" id="3524559">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524564">e</span><span class="op" id="3524565">.</span><span class="ident" id="3524566">editTextNode</span><span class="op" id="3524578">(</span><span class="ident" id="3524579">k</span><span class="op" id="3524580">,</span>&nbsp;<span class="ident" id="3524582">v</span><span class="op" id="3524583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524593">return</span>&nbsp;<span class="ident" id="3524600">c</span><span class="op" id="3524601">,</span>&nbsp;<span class="ident" id="3524603">ok</span><br>
<span class="lineno"></span><span class="op" id="3524606">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3524609">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3524661">func</span>&nbsp;<span class="op" id="3524666">(</span><span class="ident" id="3524667">e</span>&nbsp;<span class="op" id="3524669">*</span><span class="ident" id="3524670">escaper</span><span class="op" id="3524677">)</span>&nbsp;<span class="ident" id="3524679">escapeTemplate</span><span class="op" id="3524693">(</span><span class="ident" id="3524694">c</span>&nbsp;<span class="ident" id="3524696">context</span><span class="op" id="3524703">,</span>&nbsp;<span class="ident" id="3524705">n</span>&nbsp;<span class="op" id="3524707">*</span><span class="ident" id="3524708">parse</span><span class="op" id="3524713">.</span><span class="ident" id="3524714">TemplateNode</span><span class="op" id="3524726">)</span>&nbsp;<span class="ident" id="3524728">context</span>&nbsp;<span class="op" id="3524736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524739">c</span><span class="op" id="3524740">,</span>&nbsp;<span class="ident" id="3524742">name</span>&nbsp;<span class="op" id="3524747">:=</span>&nbsp;<span class="ident" id="3524750">e</span><span class="op" id="3524751">.</span><span class="ident" id="3524752">escapeTree</span><span class="op" id="3524762">(</span><span class="ident" id="3524763">c</span><span class="op" id="3524764">,</span>&nbsp;<span class="ident" id="3524766">n</span><span class="op" id="3524767">,</span>&nbsp;<span class="ident" id="3524769">n</span><span class="op" id="3524770">.</span><span class="ident" id="3524771">Name</span><span class="op" id="3524775">,</span>&nbsp;<span class="ident" id="3524777">n</span><span class="op" id="3524778">.</span><span class="ident" id="3524779">Line</span><span class="op" id="3524783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524786">if</span>&nbsp;<span class="ident" id="3524789">name</span>&nbsp;<span class="op" id="3524794">!=</span>&nbsp;<span class="ident" id="3524797">n</span><span class="op" id="3524798">.</span><span class="ident" id="3524799">Name</span>&nbsp;<span class="op" id="3524804">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524808">e</span><span class="op" id="3524809">.</span><span class="ident" id="3524810">editTemplateNode</span><span class="op" id="3524826">(</span><span class="ident" id="3524827">n</span><span class="op" id="3524828">,</span>&nbsp;<span class="ident" id="3524830">name</span><span class="op" id="3524834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524840">return</span>&nbsp;<span class="ident" id="3524847">c</span><br>
<span class="lineno"></span><span class="op" id="3524849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="3524852">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3524926">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="3524971">func</span>&nbsp;<span class="op" id="3524976">(</span><span class="ident" id="3524977">e</span>&nbsp;<span class="op" id="3524979">*</span><span class="ident" id="3524980">escaper</span><span class="op" id="3524987">)</span>&nbsp;<span class="ident" id="3524989">escapeTree</span><span class="op" id="3524999">(</span><span class="ident" id="3525000">c</span>&nbsp;<span class="ident" id="3525002">context</span><span class="op" id="3525009">,</span>&nbsp;<span class="ident" id="3525011">node</span>&nbsp;<span class="ident" id="3525016">parse</span><span class="op" id="3525021">.</span><span class="ident" id="3525022">Node</span><span class="op" id="3525026">,</span>&nbsp;<span class="ident" id="3525028">name</span>&nbsp;<span class="builtintype" id="3525033">string</span><span class="op" id="3525039">,</span>&nbsp;<span class="ident" id="3525041">line</span>&nbsp;<span class="builtintype" id="3525046">int</span><span class="op" id="3525049">)</span>&nbsp;<span class="op" id="3525051">(</span><span class="ident" id="3525052">context</span><span class="op" id="3525059">,</span>&nbsp;<span class="builtintype" id="3525061">string</span><span class="op" id="3525067">)</span>&nbsp;<span class="op" id="3525069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525072">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525146">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525162">dname</span>&nbsp;<span class="op" id="3525168">:=</span>&nbsp;<span class="ident" id="3525171">c</span><span class="op" id="3525172">.</span><span class="ident" id="3525173">mangle</span><span class="op" id="3525179">(</span><span class="ident" id="3525180">name</span><span class="op" id="3525184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525187">e</span><span class="op" id="3525188">.</span><span class="ident" id="3525189">called</span><span class="op" id="3525195">[</span><span class="ident" id="3525196">dname</span><span class="op" id="3525201">]</span>&nbsp;<span class="op" id="3525203">=</span>&nbsp;<span class="builtintype" id="3525205">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525211">if</span>&nbsp;<span class="ident" id="3525214">out</span><span class="op" id="3525217">,</span>&nbsp;<span class="ident" id="3525219">ok</span>&nbsp;<span class="op" id="3525222">:=</span>&nbsp;<span class="ident" id="3525225">e</span><span class="op" id="3525226">.</span><span class="ident" id="3525227">output</span><span class="op" id="3525233">[</span><span class="ident" id="3525234">dname</span><span class="op" id="3525239">]</span><span class="op" id="3525240">;</span>&nbsp;<span class="ident" id="3525242">ok</span>&nbsp;<span class="op" id="3525245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525249">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525271">return</span>&nbsp;<span class="ident" id="3525278">out</span><span class="op" id="3525281">,</span>&nbsp;<span class="ident" id="3525283">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525293">t</span>&nbsp;<span class="op" id="3525295">:=</span>&nbsp;<span class="ident" id="3525298">e</span><span class="op" id="3525299">.</span><span class="ident" id="3525300">template</span><span class="op" id="3525308">(</span><span class="ident" id="3525309">name</span><span class="op" id="3525313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525316">if</span>&nbsp;<span class="ident" id="3525319">t</span>&nbsp;<span class="op" id="3525321">==</span>&nbsp;<span class="ident" id="3525324">nil</span>&nbsp;<span class="op" id="3525328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525332">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525413">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525468">if</span>&nbsp;<span class="ident" id="3525471">e</span><span class="op" id="3525472">.</span><span class="ident" id="3525473">tmpl</span><span class="op" id="3525477">.</span><span class="ident" id="3525478">set</span><span class="op" id="3525481">[</span><span class="ident" id="3525482">name</span><span class="op" id="3525486">]</span>&nbsp;<span class="op" id="3525488">!=</span>&nbsp;<span class="ident" id="3525491">nil</span>&nbsp;<span class="op" id="3525495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525500">return</span>&nbsp;<span class="ident" id="3525507">context</span><span class="op" id="3525514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525520">state</span><span class="op" id="3525525">:</span>&nbsp;<span class="ident" id="3525527">stateError</span><span class="op" id="3525537">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525543">err</span><span class="op" id="3525546">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3525550">errorf</span><span class="op" id="3525556">(</span><span class="ident" id="3525557">ErrNoSuchTemplate</span><span class="op" id="3525574">,</span>&nbsp;<span class="ident" id="3525576">node</span><span class="op" id="3525580">,</span>&nbsp;<span class="ident" id="3525582">line</span><span class="op" id="3525586">,</span>&nbsp;<span class="string" id="3525588">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="3525627">,</span>&nbsp;<span class="ident" id="3525629">name</span><span class="op" id="3525633">)</span><span class="op" id="3525634">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525639">}</span><span class="op" id="3525640">,</span>&nbsp;<span class="ident" id="3525642">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525654">return</span>&nbsp;<span class="ident" id="3525661">context</span><span class="op" id="3525668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525673">state</span><span class="op" id="3525678">:</span>&nbsp;<span class="ident" id="3525680">stateError</span><span class="op" id="3525690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525695">err</span><span class="op" id="3525698">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3525702">errorf</span><span class="op" id="3525708">(</span><span class="ident" id="3525709">ErrNoSuchTemplate</span><span class="op" id="3525726">,</span>&nbsp;<span class="ident" id="3525728">node</span><span class="op" id="3525732">,</span>&nbsp;<span class="ident" id="3525734">line</span><span class="op" id="3525738">,</span>&nbsp;<span class="string" id="3525740">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3525761">,</span>&nbsp;<span class="ident" id="3525763">name</span><span class="op" id="3525767">)</span><span class="op" id="3525768">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525772">}</span><span class="op" id="3525773">,</span>&nbsp;<span class="ident" id="3525775">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525785">if</span>&nbsp;<span class="ident" id="3525788">dname</span>&nbsp;<span class="op" id="3525794">!=</span>&nbsp;<span class="ident" id="3525797">name</span>&nbsp;<span class="op" id="3525802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525806">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3525877">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525941">dt</span>&nbsp;<span class="op" id="3525944">:=</span>&nbsp;<span class="ident" id="3525947">e</span><span class="op" id="3525948">.</span><span class="ident" id="3525949">template</span><span class="op" id="3525957">(</span><span class="ident" id="3525958">dname</span><span class="op" id="3525963">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525967">if</span>&nbsp;<span class="ident" id="3525970">dt</span>&nbsp;<span class="op" id="3525973">==</span>&nbsp;<span class="ident" id="3525976">nil</span>&nbsp;<span class="op" id="3525980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525985">dt</span>&nbsp;<span class="op" id="3525988">=</span>&nbsp;<span class="ident" id="3525990">template</span><span class="op" id="3525998">.</span><span class="ident" id="3525999">New</span><span class="op" id="3526002">(</span><span class="ident" id="3526003">dname</span><span class="op" id="3526008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526013">dt</span><span class="op" id="3526015">.</span><span class="ident" id="3526016">Tree</span>&nbsp;<span class="op" id="3526021">=</span>&nbsp;<span class="op" id="3526023">&amp;</span><span class="ident" id="3526024">parse</span><span class="op" id="3526029">.</span><span class="ident" id="3526030">Tree</span><span class="op" id="3526034">{</span><span class="ident" id="3526035">Name</span><span class="op" id="3526039">:</span>&nbsp;<span class="ident" id="3526041">dname</span><span class="op" id="3526046">,</span>&nbsp;<span class="ident" id="3526048">Root</span><span class="op" id="3526052">:</span>&nbsp;<span class="ident" id="3526054">t</span><span class="op" id="3526055">.</span><span class="ident" id="3526056">Root</span><span class="op" id="3526060">.</span><span class="ident" id="3526061">CopyList</span><span class="op" id="3526069">(</span><span class="op" id="3526070">)</span><span class="op" id="3526071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526076">e</span><span class="op" id="3526077">.</span><span class="ident" id="3526078">derived</span><span class="op" id="3526085">[</span><span class="ident" id="3526086">dname</span><span class="op" id="3526091">]</span>&nbsp;<span class="op" id="3526093">=</span>&nbsp;<span class="ident" id="3526095">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526100">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526104">t</span>&nbsp;<span class="op" id="3526106">=</span>&nbsp;<span class="ident" id="3526108">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526115">return</span>&nbsp;<span class="ident" id="3526122">e</span><span class="op" id="3526123">.</span><span class="ident" id="3526124">computeOutCtx</span><span class="op" id="3526137">(</span><span class="ident" id="3526138">c</span><span class="op" id="3526139">,</span>&nbsp;<span class="ident" id="3526141">t</span><span class="op" id="3526142">)</span><span class="op" id="3526143">,</span>&nbsp;<span class="ident" id="3526145">dname</span><br>
<span class="lineno"></span><span class="op" id="3526151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="3526154">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="3526234">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="3526280">func</span>&nbsp;<span class="op" id="3526285">(</span><span class="ident" id="3526286">e</span>&nbsp;<span class="op" id="3526288">*</span><span class="ident" id="3526289">escaper</span><span class="op" id="3526296">)</span>&nbsp;<span class="ident" id="3526298">computeOutCtx</span><span class="op" id="3526311">(</span><span class="ident" id="3526312">c</span>&nbsp;<span class="ident" id="3526314">context</span><span class="op" id="3526321">,</span>&nbsp;<span class="ident" id="3526323">t</span>&nbsp;<span class="op" id="3526325">*</span><span class="ident" id="3526326">template</span><span class="op" id="3526334">.</span><span class="ident" id="3526335">Template</span><span class="op" id="3526343">)</span>&nbsp;<span class="ident" id="3526345">context</span>&nbsp;<span class="op" id="3526353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526356">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526393">c1</span><span class="op" id="3526395">,</span>&nbsp;<span class="ident" id="3526397">ok</span>&nbsp;<span class="op" id="3526400">:=</span>&nbsp;<span class="ident" id="3526403">e</span><span class="op" id="3526404">.</span><span class="ident" id="3526405">escapeTemplateBody</span><span class="op" id="3526423">(</span><span class="ident" id="3526424">c</span><span class="op" id="3526425">,</span>&nbsp;<span class="ident" id="3526427">t</span><span class="op" id="3526428">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526431">if</span>&nbsp;<span class="op" id="3526434">!</span><span class="ident" id="3526435">ok</span>&nbsp;<span class="op" id="3526438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526442">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526508">if</span>&nbsp;<span class="ident" id="3526511">c2</span><span class="op" id="3526513">,</span>&nbsp;<span class="ident" id="3526515">ok2</span>&nbsp;<span class="op" id="3526519">:=</span>&nbsp;<span class="ident" id="3526522">e</span><span class="op" id="3526523">.</span><span class="ident" id="3526524">escapeTemplateBody</span><span class="op" id="3526542">(</span><span class="ident" id="3526543">c1</span><span class="op" id="3526545">,</span>&nbsp;<span class="ident" id="3526547">t</span><span class="op" id="3526548">)</span><span class="op" id="3526549">;</span>&nbsp;<span class="ident" id="3526551">ok2</span>&nbsp;<span class="op" id="3526555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526560">c1</span><span class="op" id="3526562">,</span>&nbsp;<span class="ident" id="3526564">ok</span>&nbsp;<span class="op" id="3526567">=</span>&nbsp;<span class="ident" id="3526569">c2</span><span class="op" id="3526571">,</span>&nbsp;<span class="builtintype" id="3526573">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526580">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526584">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526649">if</span>&nbsp;<span class="op" id="3526652">!</span><span class="ident" id="3526653">ok</span>&nbsp;<span class="op" id="3526656">&amp;&amp;</span>&nbsp;<span class="ident" id="3526659">c1</span><span class="op" id="3526661">.</span><span class="ident" id="3526662">state</span>&nbsp;<span class="op" id="3526668">!=</span>&nbsp;<span class="ident" id="3526671">stateError</span>&nbsp;<span class="op" id="3526682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526686">return</span>&nbsp;<span class="ident" id="3526693">context</span><span class="op" id="3526700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526705">state</span><span class="op" id="3526710">:</span>&nbsp;<span class="ident" id="3526712">stateError</span><span class="op" id="3526722">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526727">err</span><span class="op" id="3526730">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3526734">errorf</span><span class="op" id="3526740">(</span><span class="ident" id="3526741">ErrOutputContext</span><span class="op" id="3526757">,</span>&nbsp;<span class="ident" id="3526759">t</span><span class="op" id="3526760">.</span><span class="ident" id="3526761">Tree</span><span class="op" id="3526765">.</span><span class="ident" id="3526766">Root</span><span class="op" id="3526770">,</span>&nbsp;<span class="num" id="3526772">0</span><span class="op" id="3526773">,</span>&nbsp;<span class="string" id="3526775">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="3526822">,</span>&nbsp;<span class="ident" id="3526824">t</span><span class="op" id="3526825">.</span><span class="ident" id="3526826">Name</span><span class="op" id="3526830">(</span><span class="op" id="3526831">)</span><span class="op" id="3526832">)</span><span class="op" id="3526833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526843">return</span>&nbsp;<span class="ident" id="3526850">c1</span><br>
<span class="lineno"></span><span class="op" id="3526853">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="3526856">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="3526931">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3527008">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="3527035">func</span>&nbsp;<span class="op" id="3527040">(</span><span class="ident" id="3527041">e</span>&nbsp;<span class="op" id="3527043">*</span><span class="ident" id="3527044">escaper</span><span class="op" id="3527051">)</span>&nbsp;<span class="ident" id="3527053">escapeTemplateBody</span><span class="op" id="3527071">(</span><span class="ident" id="3527072">c</span>&nbsp;<span class="ident" id="3527074">context</span><span class="op" id="3527081">,</span>&nbsp;<span class="ident" id="3527083">t</span>&nbsp;<span class="op" id="3527085">*</span><span class="ident" id="3527086">template</span><span class="op" id="3527094">.</span><span class="ident" id="3527095">Template</span><span class="op" id="3527103">)</span>&nbsp;<span class="op" id="3527105">(</span><span class="ident" id="3527106">context</span><span class="op" id="3527113">,</span>&nbsp;<span class="builtintype" id="3527115">bool</span><span class="op" id="3527119">)</span>&nbsp;<span class="op" id="3527121">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527124">filter</span>&nbsp;<span class="op" id="3527131">:=</span>&nbsp;<span class="keyword" id="3527134">func</span><span class="op" id="3527138">(</span><span class="ident" id="3527139">e1</span>&nbsp;<span class="op" id="3527142">*</span><span class="ident" id="3527143">escaper</span><span class="op" id="3527150">,</span>&nbsp;<span class="ident" id="3527152">c1</span>&nbsp;<span class="ident" id="3527155">context</span><span class="op" id="3527162">)</span>&nbsp;<span class="builtintype" id="3527164">bool</span>&nbsp;<span class="op" id="3527169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527173">if</span>&nbsp;<span class="ident" id="3527176">c1</span><span class="op" id="3527178">.</span><span class="ident" id="3527179">state</span>&nbsp;<span class="op" id="3527185">==</span>&nbsp;<span class="ident" id="3527188">stateError</span>&nbsp;<span class="op" id="3527199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527204">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527246">return</span>&nbsp;<span class="builtintype" id="3527253">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527261">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527265">if</span>&nbsp;<span class="op" id="3527268">!</span><span class="ident" id="3527269">e1</span><span class="op" id="3527271">.</span><span class="ident" id="3527272">called</span><span class="op" id="3527278">[</span><span class="ident" id="3527279">t</span><span class="op" id="3527280">.</span><span class="ident" id="3527281">Name</span><span class="op" id="3527285">(</span><span class="op" id="3527286">)</span><span class="op" id="3527287">]</span>&nbsp;<span class="op" id="3527289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527294">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527346">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527377">return</span>&nbsp;<span class="builtintype" id="3527384">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527391">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527395">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527457">return</span>&nbsp;<span class="ident" id="3527464">c</span><span class="op" id="3527465">.</span><span class="ident" id="3527466">eq</span><span class="op" id="3527468">(</span><span class="ident" id="3527469">c1</span><span class="op" id="3527471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527477">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527550">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527624">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527694">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527722">e</span><span class="op" id="3527723">.</span><span class="ident" id="3527724">output</span><span class="op" id="3527730">[</span><span class="ident" id="3527731">t</span><span class="op" id="3527732">.</span><span class="ident" id="3527733">Name</span><span class="op" id="3527737">(</span><span class="op" id="3527738">)</span><span class="op" id="3527739">]</span>&nbsp;<span class="op" id="3527741">=</span>&nbsp;<span class="ident" id="3527743">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527746">return</span>&nbsp;<span class="ident" id="3527753">e</span><span class="op" id="3527754">.</span><span class="ident" id="3527755">escapeListConditionally</span><span class="op" id="3527778">(</span><span class="ident" id="3527779">c</span><span class="op" id="3527780">,</span>&nbsp;<span class="ident" id="3527782">t</span><span class="op" id="3527783">.</span><span class="ident" id="3527784">Tree</span><span class="op" id="3527788">.</span><span class="ident" id="3527789">Root</span><span class="op" id="3527793">,</span>&nbsp;<span class="ident" id="3527795">filter</span><span class="op" id="3527801">)</span><br>
<span class="lineno"></span><span class="op" id="3527803">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="3527806">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3527880">var</span>&nbsp;<span class="ident" id="3527884">delimEnds</span>&nbsp;<span class="op" id="3527894">=</span>&nbsp;<span class="op" id="3527896">[</span><span class="op" id="3527897">...</span><span class="op" id="3527900">]</span><span class="builtintype" id="3527901">string</span><span class="op" id="3527907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527910">delimDoubleQuote</span><span class="op" id="3527926">:</span>&nbsp;<span class="string" id="3527928">`&#34;`</span><span class="op" id="3527931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527934">delimSingleQuote</span><span class="op" id="3527950">:</span>&nbsp;<span class="string" id="3527952">&#34;&#39;&#34;</span><span class="op" id="3527955">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527958">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528027">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528072">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528112">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528186">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528258">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528308">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528314">delimSpaceOrTagEnd</span><span class="op" id="3528332">:</span>&nbsp;<span class="string" id="3528334">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="3528346">,</span><br>
<span class="lineno"></span><span class="op" id="3528348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="3528351">var</span>&nbsp;<span class="ident" id="3528355">doctypeBytes</span>&nbsp;<span class="op" id="3528368">=</span>&nbsp;<span class="op" id="3528370">[</span><span class="op" id="3528371">]</span><span class="builtintype" id="3528372">byte</span><span class="op" id="3528376">(</span><span class="string" id="3528377">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="3528388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3528391">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="3528435">func</span>&nbsp;<span class="op" id="3528440">(</span><span class="ident" id="3528441">e</span>&nbsp;<span class="op" id="3528443">*</span><span class="ident" id="3528444">escaper</span><span class="op" id="3528451">)</span>&nbsp;<span class="ident" id="3528453">escapeText</span><span class="op" id="3528463">(</span><span class="ident" id="3528464">c</span>&nbsp;<span class="ident" id="3528466">context</span><span class="op" id="3528473">,</span>&nbsp;<span class="ident" id="3528475">n</span>&nbsp;<span class="op" id="3528477">*</span><span class="ident" id="3528478">parse</span><span class="op" id="3528483">.</span><span class="ident" id="3528484">TextNode</span><span class="op" id="3528492">)</span>&nbsp;<span class="ident" id="3528494">context</span>&nbsp;<span class="op" id="3528502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528505">s</span><span class="op" id="3528506">,</span>&nbsp;<span class="ident" id="3528508">written</span><span class="op" id="3528515">,</span>&nbsp;<span class="ident" id="3528517">i</span><span class="op" id="3528518">,</span>&nbsp;<span class="ident" id="3528520">b</span>&nbsp;<span class="op" id="3528522">:=</span>&nbsp;<span class="ident" id="3528525">n</span><span class="op" id="3528526">.</span><span class="ident" id="3528527">Text</span><span class="op" id="3528531">,</span>&nbsp;<span class="num" id="3528533">0</span><span class="op" id="3528534">,</span>&nbsp;<span class="num" id="3528536">0</span><span class="op" id="3528537">,</span>&nbsp;<span class="builtinfunc" id="3528539">new</span><span class="op" id="3528542">(</span><span class="ident" id="3528543">bytes</span><span class="op" id="3528548">.</span><span class="ident" id="3528549">Buffer</span><span class="op" id="3528555">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528558">for</span>&nbsp;<span class="ident" id="3528562">i</span>&nbsp;<span class="op" id="3528564">!=</span>&nbsp;<span class="builtinfunc" id="3528567">len</span><span class="op" id="3528570">(</span><span class="ident" id="3528571">s</span><span class="op" id="3528572">)</span>&nbsp;<span class="op" id="3528574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528578">c1</span><span class="op" id="3528580">,</span>&nbsp;<span class="ident" id="3528582">nread</span>&nbsp;<span class="op" id="3528588">:=</span>&nbsp;<span class="ident" id="3528591">contextAfterText</span><span class="op" id="3528607">(</span><span class="ident" id="3528608">c</span><span class="op" id="3528609">,</span>&nbsp;<span class="ident" id="3528611">s</span><span class="op" id="3528612">[</span><span class="ident" id="3528613">i</span><span class="op" id="3528614">:</span><span class="op" id="3528615">]</span><span class="op" id="3528616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528620">i1</span>&nbsp;<span class="op" id="3528623">:=</span>&nbsp;<span class="ident" id="3528626">i</span>&nbsp;<span class="op" id="3528628">+</span>&nbsp;<span class="ident" id="3528630">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528638">if</span>&nbsp;<span class="ident" id="3528641">c</span><span class="op" id="3528642">.</span><span class="ident" id="3528643">state</span>&nbsp;<span class="op" id="3528649">==</span>&nbsp;<span class="ident" id="3528652">stateText</span>&nbsp;<span class="op" id="3528662">||</span>&nbsp;<span class="ident" id="3528665">c</span><span class="op" id="3528666">.</span><span class="ident" id="3528667">state</span>&nbsp;<span class="op" id="3528673">==</span>&nbsp;<span class="ident" id="3528676">stateRCDATA</span>&nbsp;<span class="op" id="3528688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528693">end</span>&nbsp;<span class="op" id="3528697">:=</span>&nbsp;<span class="ident" id="3528700">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528706">if</span>&nbsp;<span class="ident" id="3528709">c1</span><span class="op" id="3528711">.</span><span class="ident" id="3528712">state</span>&nbsp;<span class="op" id="3528718">!=</span>&nbsp;<span class="ident" id="3528721">c</span><span class="op" id="3528722">.</span><span class="ident" id="3528723">state</span>&nbsp;<span class="op" id="3528729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528735">for</span>&nbsp;<span class="ident" id="3528739">j</span>&nbsp;<span class="op" id="3528741">:=</span>&nbsp;<span class="ident" id="3528744">end</span>&nbsp;<span class="op" id="3528748">-</span>&nbsp;<span class="num" id="3528750">1</span><span class="op" id="3528751">;</span>&nbsp;<span class="ident" id="3528753">j</span>&nbsp;<span class="op" id="3528755">&gt;=</span>&nbsp;<span class="ident" id="3528758">i</span><span class="op" id="3528759">;</span>&nbsp;<span class="ident" id="3528761">j</span><span class="op" id="3528762">--</span>&nbsp;<span class="op" id="3528765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528772">if</span>&nbsp;<span class="ident" id="3528775">s</span><span class="op" id="3528776">[</span><span class="ident" id="3528777">j</span><span class="op" id="3528778">]</span>&nbsp;<span class="op" id="3528780">==</span>&nbsp;<span class="string" id="3528783">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3528787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528795">end</span>&nbsp;<span class="op" id="3528799">=</span>&nbsp;<span class="ident" id="3528801">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528809">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528836">for</span>&nbsp;<span class="ident" id="3528840">j</span>&nbsp;<span class="op" id="3528842">:=</span>&nbsp;<span class="ident" id="3528845">i</span><span class="op" id="3528846">;</span>&nbsp;<span class="ident" id="3528848">j</span>&nbsp;<span class="op" id="3528850">&lt;</span>&nbsp;<span class="ident" id="3528852">end</span><span class="op" id="3528855">;</span>&nbsp;<span class="ident" id="3528857">j</span><span class="op" id="3528858">++</span>&nbsp;<span class="op" id="3528861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528867">if</span>&nbsp;<span class="ident" id="3528870">s</span><span class="op" id="3528871">[</span><span class="ident" id="3528872">j</span><span class="op" id="3528873">]</span>&nbsp;<span class="op" id="3528875">==</span>&nbsp;<span class="string" id="3528878">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3528882">&amp;&amp;</span>&nbsp;<span class="op" id="3528885">!</span><span class="ident" id="3528886">bytes</span><span class="op" id="3528891">.</span><span class="ident" id="3528892">HasPrefix</span><span class="op" id="3528901">(</span><span class="ident" id="3528902">bytes</span><span class="op" id="3528907">.</span><span class="ident" id="3528908">ToUpper</span><span class="op" id="3528915">(</span><span class="ident" id="3528916">s</span><span class="op" id="3528917">[</span><span class="ident" id="3528918">j</span><span class="op" id="3528919">:</span><span class="op" id="3528920">]</span><span class="op" id="3528921">)</span><span class="op" id="3528922">,</span>&nbsp;<span class="ident" id="3528924">doctypeBytes</span><span class="op" id="3528936">)</span>&nbsp;<span class="op" id="3528938">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528945">b</span><span class="op" id="3528946">.</span><span class="ident" id="3528947">Write</span><span class="op" id="3528952">(</span><span class="ident" id="3528953">s</span><span class="op" id="3528954">[</span><span class="ident" id="3528955">written</span><span class="op" id="3528962">:</span><span class="ident" id="3528963">j</span><span class="op" id="3528964">]</span><span class="op" id="3528965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528972">b</span><span class="op" id="3528973">.</span><span class="ident" id="3528974">WriteString</span><span class="op" id="3528985">(</span><span class="string" id="3528986">&#34;&amp;lt;&#34;</span><span class="op" id="3528992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528999">written</span>&nbsp;<span class="op" id="3529007">=</span>&nbsp;<span class="ident" id="3529009">j</span>&nbsp;<span class="op" id="3529011">+</span>&nbsp;<span class="num" id="3529013">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529024">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529028">}</span>&nbsp;<span class="keyword" id="3529030">else</span>&nbsp;<span class="keyword" id="3529035">if</span>&nbsp;<span class="ident" id="3529038">isComment</span><span class="op" id="3529047">(</span><span class="ident" id="3529048">c</span><span class="op" id="3529049">.</span><span class="ident" id="3529050">state</span><span class="op" id="3529055">)</span>&nbsp;<span class="op" id="3529057">&amp;&amp;</span>&nbsp;<span class="ident" id="3529060">c</span><span class="op" id="3529061">.</span><span class="ident" id="3529062">delim</span>&nbsp;<span class="op" id="3529068">==</span>&nbsp;<span class="ident" id="3529071">delimNone</span>&nbsp;<span class="op" id="3529081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529086">switch</span>&nbsp;<span class="ident" id="3529093">c</span><span class="op" id="3529094">.</span><span class="ident" id="3529095">state</span>&nbsp;<span class="op" id="3529101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529106">case</span>&nbsp;<span class="ident" id="3529111">stateJSBlockCmt</span><span class="op" id="3529126">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529132">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529168">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529217">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529269">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529319">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529367">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529416">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529447">if</span>&nbsp;<span class="ident" id="3529450">bytes</span><span class="op" id="3529455">.</span><span class="ident" id="3529456">IndexAny</span><span class="op" id="3529464">(</span><span class="ident" id="3529465">s</span><span class="op" id="3529466">[</span><span class="ident" id="3529467">written</span><span class="op" id="3529474">:</span><span class="ident" id="3529475">i1</span><span class="op" id="3529477">]</span><span class="op" id="3529478">,</span>&nbsp;<span class="string" id="3529480">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="3529498">)</span>&nbsp;<span class="op" id="3529500">!=</span>&nbsp;<span class="op" id="3529503">-</span><span class="num" id="3529504">1</span>&nbsp;<span class="op" id="3529506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529513">b</span><span class="op" id="3529514">.</span><span class="ident" id="3529515">WriteByte</span><span class="op" id="3529524">(</span><span class="string" id="3529525">&#39;\n&#39;</span><span class="op" id="3529529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529535">}</span>&nbsp;<span class="keyword" id="3529537">else</span>&nbsp;<span class="op" id="3529542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529549">b</span><span class="op" id="3529550">.</span><span class="ident" id="3529551">WriteByte</span><span class="op" id="3529560">(</span><span class="string" id="3529561">&#39;&nbsp;&#39;</span><span class="op" id="3529564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529570">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529575">case</span>&nbsp;<span class="ident" id="3529580">stateCSSBlockCmt</span><span class="op" id="3529596">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529602">b</span><span class="op" id="3529603">.</span><span class="ident" id="3529604">WriteByte</span><span class="op" id="3529613">(</span><span class="string" id="3529614">&#39;&nbsp;&#39;</span><span class="op" id="3529617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529627">written</span>&nbsp;<span class="op" id="3529635">=</span>&nbsp;<span class="ident" id="3529637">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529642">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529646">if</span>&nbsp;<span class="ident" id="3529649">c</span><span class="op" id="3529650">.</span><span class="ident" id="3529651">state</span>&nbsp;<span class="op" id="3529657">!=</span>&nbsp;<span class="ident" id="3529660">c1</span><span class="op" id="3529662">.</span><span class="ident" id="3529663">state</span>&nbsp;<span class="op" id="3529669">&amp;&amp;</span>&nbsp;<span class="ident" id="3529672">isComment</span><span class="op" id="3529681">(</span><span class="ident" id="3529682">c1</span><span class="op" id="3529684">.</span><span class="ident" id="3529685">state</span><span class="op" id="3529690">)</span>&nbsp;<span class="op" id="3529692">&amp;&amp;</span>&nbsp;<span class="ident" id="3529695">c1</span><span class="op" id="3529697">.</span><span class="ident" id="3529698">delim</span>&nbsp;<span class="op" id="3529704">==</span>&nbsp;<span class="ident" id="3529707">delimNone</span>&nbsp;<span class="op" id="3529717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529722">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529788">cs</span>&nbsp;<span class="op" id="3529791">:=</span>&nbsp;<span class="ident" id="3529794">i1</span>&nbsp;<span class="op" id="3529797">-</span>&nbsp;<span class="num" id="3529799">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529804">if</span>&nbsp;<span class="ident" id="3529807">c1</span><span class="op" id="3529809">.</span><span class="ident" id="3529810">state</span>&nbsp;<span class="op" id="3529816">==</span>&nbsp;<span class="ident" id="3529819">stateHTMLCmt</span>&nbsp;<span class="op" id="3529832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529838">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529876">cs</span>&nbsp;<span class="op" id="3529879">-=</span>&nbsp;<span class="num" id="3529882">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529892">b</span><span class="op" id="3529893">.</span><span class="ident" id="3529894">Write</span><span class="op" id="3529899">(</span><span class="ident" id="3529900">s</span><span class="op" id="3529901">[</span><span class="ident" id="3529902">written</span><span class="op" id="3529909">:</span><span class="ident" id="3529910">cs</span><span class="op" id="3529912">]</span><span class="op" id="3529913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529918">written</span>&nbsp;<span class="op" id="3529926">=</span>&nbsp;<span class="ident" id="3529928">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529933">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529937">if</span>&nbsp;<span class="ident" id="3529940">i</span>&nbsp;<span class="op" id="3529942">==</span>&nbsp;<span class="ident" id="3529945">i1</span>&nbsp;<span class="op" id="3529948">&amp;&amp;</span>&nbsp;<span class="ident" id="3529951">c</span><span class="op" id="3529952">.</span><span class="ident" id="3529953">state</span>&nbsp;<span class="op" id="3529959">==</span>&nbsp;<span class="ident" id="3529962">c1</span><span class="op" id="3529964">.</span><span class="ident" id="3529965">state</span>&nbsp;<span class="op" id="3529971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3529976">panic</span><span class="op" id="3529981">(</span><span class="ident" id="3529982">fmt</span><span class="op" id="3529985">.</span><span class="ident" id="3529986">Sprintf</span><span class="op" id="3529993">(</span><span class="string" id="3529994">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="3530033">,</span>&nbsp;<span class="ident" id="3530035">c</span><span class="op" id="3530036">,</span>&nbsp;<span class="ident" id="3530038">c1</span><span class="op" id="3530040">,</span>&nbsp;<span class="ident" id="3530042">s</span><span class="op" id="3530043">[</span><span class="op" id="3530044">:</span><span class="ident" id="3530045">i</span><span class="op" id="3530046">]</span><span class="op" id="3530047">,</span>&nbsp;<span class="ident" id="3530049">s</span><span class="op" id="3530050">[</span><span class="ident" id="3530051">i</span><span class="op" id="3530052">:</span><span class="op" id="3530053">]</span><span class="op" id="3530054">)</span><span class="op" id="3530055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530063">c</span><span class="op" id="3530064">,</span>&nbsp;<span class="ident" id="3530066">i</span>&nbsp;<span class="op" id="3530068">=</span>&nbsp;<span class="ident" id="3530070">c1</span><span class="op" id="3530072">,</span>&nbsp;<span class="ident" id="3530074">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530078">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530082">if</span>&nbsp;<span class="ident" id="3530085">written</span>&nbsp;<span class="op" id="3530093">!=</span>&nbsp;<span class="num" id="3530096">0</span>&nbsp;<span class="op" id="3530098">&amp;&amp;</span>&nbsp;<span class="ident" id="3530101">c</span><span class="op" id="3530102">.</span><span class="ident" id="3530103">state</span>&nbsp;<span class="op" id="3530109">!=</span>&nbsp;<span class="ident" id="3530112">stateError</span>&nbsp;<span class="op" id="3530123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530127">if</span>&nbsp;<span class="op" id="3530130">!</span><span class="ident" id="3530131">isComment</span><span class="op" id="3530140">(</span><span class="ident" id="3530141">c</span><span class="op" id="3530142">.</span><span class="ident" id="3530143">state</span><span class="op" id="3530148">)</span>&nbsp;<span class="op" id="3530150">||</span>&nbsp;<span class="ident" id="3530153">c</span><span class="op" id="3530154">.</span><span class="ident" id="3530155">delim</span>&nbsp;<span class="op" id="3530161">!=</span>&nbsp;<span class="ident" id="3530164">delimNone</span>&nbsp;<span class="op" id="3530174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530179">b</span><span class="op" id="3530180">.</span><span class="ident" id="3530181">Write</span><span class="op" id="3530186">(</span><span class="ident" id="3530187">n</span><span class="op" id="3530188">.</span><span class="ident" id="3530189">Text</span><span class="op" id="3530193">[</span><span class="ident" id="3530194">written</span><span class="op" id="3530201">:</span><span class="op" id="3530202">]</span><span class="op" id="3530203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530207">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530211">e</span><span class="op" id="3530212">.</span><span class="ident" id="3530213">editTextNode</span><span class="op" id="3530225">(</span><span class="ident" id="3530226">n</span><span class="op" id="3530227">,</span>&nbsp;<span class="ident" id="3530229">b</span><span class="op" id="3530230">.</span><span class="ident" id="3530231">Bytes</span><span class="op" id="3530236">(</span><span class="op" id="3530237">)</span><span class="op" id="3530238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530244">return</span>&nbsp;<span class="ident" id="3530251">c</span><br>
<span class="lineno"></span><span class="op" id="3530253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="3530256">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3530336">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="3530414">func</span>&nbsp;<span class="ident" id="3530419">contextAfterText</span><span class="op" id="3530435">(</span><span class="ident" id="3530436">c</span>&nbsp;<span class="ident" id="3530438">context</span><span class="op" id="3530445">,</span>&nbsp;<span class="ident" id="3530447">s</span>&nbsp;<span class="op" id="3530449">[</span><span class="op" id="3530450">]</span><span class="builtintype" id="3530451">byte</span><span class="op" id="3530455">)</span>&nbsp;<span class="op" id="3530457">(</span><span class="ident" id="3530458">context</span><span class="op" id="3530465">,</span>&nbsp;<span class="builtintype" id="3530467">int</span><span class="op" id="3530470">)</span>&nbsp;<span class="op" id="3530472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530475">if</span>&nbsp;<span class="ident" id="3530478">c</span><span class="op" id="3530479">.</span><span class="ident" id="3530480">delim</span>&nbsp;<span class="op" id="3530486">==</span>&nbsp;<span class="ident" id="3530489">delimNone</span>&nbsp;<span class="op" id="3530499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530503">c1</span><span class="op" id="3530505">,</span>&nbsp;<span class="ident" id="3530507">i</span>&nbsp;<span class="op" id="3530509">:=</span>&nbsp;<span class="ident" id="3530512">tSpecialTagEnd</span><span class="op" id="3530526">(</span><span class="ident" id="3530527">c</span><span class="op" id="3530528">,</span>&nbsp;<span class="ident" id="3530530">s</span><span class="op" id="3530531">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530535">if</span>&nbsp;<span class="ident" id="3530538">i</span>&nbsp;<span class="op" id="3530540">==</span>&nbsp;<span class="num" id="3530543">0</span>&nbsp;<span class="op" id="3530545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530550">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530606">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530656">return</span>&nbsp;<span class="ident" id="3530663">c1</span><span class="op" id="3530665">,</span>&nbsp;<span class="num" id="3530667">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530671">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530675">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530720">return</span>&nbsp;<span class="ident" id="3530727">transitionFunc</span><span class="op" id="3530741">[</span><span class="ident" id="3530742">c</span><span class="op" id="3530743">.</span><span class="ident" id="3530744">state</span><span class="op" id="3530749">]</span><span class="op" id="3530750">(</span><span class="ident" id="3530751">c</span><span class="op" id="3530752">,</span>&nbsp;<span class="ident" id="3530754">s</span><span class="op" id="3530755">[</span><span class="op" id="3530756">:</span><span class="ident" id="3530757">i</span><span class="op" id="3530758">]</span><span class="op" id="3530759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530766">i</span>&nbsp;<span class="op" id="3530768">:=</span>&nbsp;<span class="ident" id="3530771">bytes</span><span class="op" id="3530776">.</span><span class="ident" id="3530777">IndexAny</span><span class="op" id="3530785">(</span><span class="ident" id="3530786">s</span><span class="op" id="3530787">,</span>&nbsp;<span class="ident" id="3530789">delimEnds</span><span class="op" id="3530798">[</span><span class="ident" id="3530799">c</span><span class="op" id="3530800">.</span><span class="ident" id="3530801">delim</span><span class="op" id="3530806">]</span><span class="op" id="3530807">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530810">if</span>&nbsp;<span class="ident" id="3530813">i</span>&nbsp;<span class="op" id="3530815">==</span>&nbsp;<span class="op" id="3530818">-</span><span class="num" id="3530819">1</span>&nbsp;<span class="op" id="3530821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530825">i</span>&nbsp;<span class="op" id="3530827">=</span>&nbsp;<span class="builtinfunc" id="3530829">len</span><span class="op" id="3530832">(</span><span class="ident" id="3530833">s</span><span class="op" id="3530834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530840">if</span>&nbsp;<span class="ident" id="3530843">c</span><span class="op" id="3530844">.</span><span class="ident" id="3530845">delim</span>&nbsp;<span class="op" id="3530851">==</span>&nbsp;<span class="ident" id="3530854">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="3530873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530877">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3530954">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531002">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531060">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531126">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531176">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531229">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531274">if</span>&nbsp;<span class="ident" id="3531277">j</span>&nbsp;<span class="op" id="3531279">:=</span>&nbsp;<span class="ident" id="3531282">bytes</span><span class="op" id="3531287">.</span><span class="ident" id="3531288">IndexAny</span><span class="op" id="3531296">(</span><span class="ident" id="3531297">s</span><span class="op" id="3531298">[</span><span class="op" id="3531299">:</span><span class="ident" id="3531300">i</span><span class="op" id="3531301">]</span><span class="op" id="3531302">,</span>&nbsp;<span class="string" id="3531304">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="3531312">)</span><span class="op" id="3531313">;</span>&nbsp;<span class="ident" id="3531315">j</span>&nbsp;<span class="op" id="3531317">&gt;=</span>&nbsp;<span class="num" id="3531320">0</span>&nbsp;<span class="op" id="3531322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531327">return</span>&nbsp;<span class="ident" id="3531334">context</span><span class="op" id="3531341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531347">state</span><span class="op" id="3531352">:</span>&nbsp;<span class="ident" id="3531354">stateError</span><span class="op" id="3531364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531370">err</span><span class="op" id="3531373">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3531377">errorf</span><span class="op" id="3531383">(</span><span class="ident" id="3531384">ErrBadHTML</span><span class="op" id="3531394">,</span>&nbsp;<span class="ident" id="3531396">nil</span><span class="op" id="3531399">,</span>&nbsp;<span class="num" id="3531401">0</span><span class="op" id="3531402">,</span>&nbsp;<span class="string" id="3531404">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="3531429">,</span>&nbsp;<span class="ident" id="3531431">s</span><span class="op" id="3531432">[</span><span class="ident" id="3531433">j</span><span class="op" id="3531434">:</span><span class="ident" id="3531435">j</span><span class="op" id="3531436">+</span><span class="num" id="3531437">1</span><span class="op" id="3531438">]</span><span class="op" id="3531439">,</span>&nbsp;<span class="ident" id="3531441">s</span><span class="op" id="3531442">[</span><span class="op" id="3531443">:</span><span class="ident" id="3531444">i</span><span class="op" id="3531445">]</span><span class="op" id="3531446">)</span><span class="op" id="3531447">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531452">}</span><span class="op" id="3531453">,</span>&nbsp;<span class="builtinfunc" id="3531455">len</span><span class="op" id="3531458">(</span><span class="ident" id="3531459">s</span><span class="op" id="3531460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531470">if</span>&nbsp;<span class="ident" id="3531473">i</span>&nbsp;<span class="op" id="3531475">==</span>&nbsp;<span class="builtinfunc" id="3531478">len</span><span class="op" id="3531481">(</span><span class="ident" id="3531482">s</span><span class="op" id="3531483">)</span>&nbsp;<span class="op" id="3531485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531489">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531523">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531581">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531632">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531687">for</span>&nbsp;<span class="ident" id="3531691">u</span>&nbsp;<span class="op" id="3531693">:=</span>&nbsp;<span class="op" id="3531696">[</span><span class="op" id="3531697">]</span><span class="builtintype" id="3531698">byte</span><span class="op" id="3531702">(</span><span class="ident" id="3531703">html</span><span class="op" id="3531707">.</span><span class="ident" id="3531708">UnescapeString</span><span class="op" id="3531722">(</span><span class="builtintype" id="3531723">string</span><span class="op" id="3531729">(</span><span class="ident" id="3531730">s</span><span class="op" id="3531731">)</span><span class="op" id="3531732">)</span><span class="op" id="3531733">)</span><span class="op" id="3531734">;</span>&nbsp;<span class="builtinfunc" id="3531736">len</span><span class="op" id="3531739">(</span><span class="ident" id="3531740">u</span><span class="op" id="3531741">)</span>&nbsp;<span class="op" id="3531743">!=</span>&nbsp;<span class="num" id="3531746">0</span><span class="op" id="3531747">;</span>&nbsp;<span class="op" id="3531749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531754">c1</span><span class="op" id="3531756">,</span>&nbsp;<span class="ident" id="3531758">i1</span>&nbsp;<span class="op" id="3531761">:=</span>&nbsp;<span class="ident" id="3531764">transitionFunc</span><span class="op" id="3531778">[</span><span class="ident" id="3531779">c</span><span class="op" id="3531780">.</span><span class="ident" id="3531781">state</span><span class="op" id="3531786">]</span><span class="op" id="3531787">(</span><span class="ident" id="3531788">c</span><span class="op" id="3531789">,</span>&nbsp;<span class="ident" id="3531791">u</span><span class="op" id="3531792">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531797">c</span><span class="op" id="3531798">,</span>&nbsp;<span class="ident" id="3531800">u</span>&nbsp;<span class="op" id="3531802">=</span>&nbsp;<span class="ident" id="3531804">c1</span><span class="op" id="3531806">,</span>&nbsp;<span class="ident" id="3531808">u</span><span class="op" id="3531809">[</span><span class="ident" id="3531810">i1</span><span class="op" id="3531812">:</span><span class="op" id="3531813">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531821">return</span>&nbsp;<span class="ident" id="3531828">c</span><span class="op" id="3531829">,</span>&nbsp;<span class="builtinfunc" id="3531831">len</span><span class="op" id="3531834">(</span><span class="ident" id="3531835">s</span><span class="op" id="3531836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531842">if</span>&nbsp;<span class="ident" id="3531845">c</span><span class="op" id="3531846">.</span><span class="ident" id="3531847">delim</span>&nbsp;<span class="op" id="3531853">!=</span>&nbsp;<span class="ident" id="3531856">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="3531875">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531879">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531903">i</span><span class="op" id="3531904">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531911">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531973">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532007">return</span>&nbsp;<span class="ident" id="3532014">context</span><span class="op" id="3532021">{</span><span class="ident" id="3532022">state</span><span class="op" id="3532027">:</span>&nbsp;<span class="ident" id="3532029">stateTag</span><span class="op" id="3532037">,</span>&nbsp;<span class="ident" id="3532039">element</span><span class="op" id="3532046">:</span>&nbsp;<span class="ident" id="3532048">c</span><span class="op" id="3532049">.</span><span class="ident" id="3532050">element</span><span class="op" id="3532057">}</span><span class="op" id="3532058">,</span>&nbsp;<span class="ident" id="3532060">i</span><br>
<span class="lineno"></span><span class="op" id="3532062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532065">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="3532140">func</span>&nbsp;<span class="op" id="3532145">(</span><span class="ident" id="3532146">e</span>&nbsp;<span class="op" id="3532148">*</span><span class="ident" id="3532149">escaper</span><span class="op" id="3532156">)</span>&nbsp;<span class="ident" id="3532158">editActionNode</span><span class="op" id="3532172">(</span><span class="ident" id="3532173">n</span>&nbsp;<span class="op" id="3532175">*</span><span class="ident" id="3532176">parse</span><span class="op" id="3532181">.</span><span class="ident" id="3532182">ActionNode</span><span class="op" id="3532192">,</span>&nbsp;<span class="ident" id="3532194">cmds</span>&nbsp;<span class="op" id="3532199">[</span><span class="op" id="3532200">]</span><span class="builtintype" id="3532201">string</span><span class="op" id="3532207">)</span>&nbsp;<span class="op" id="3532209">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532212">if</span>&nbsp;<span class="ident" id="3532215">_</span><span class="op" id="3532216">,</span>&nbsp;<span class="ident" id="3532218">ok</span>&nbsp;<span class="op" id="3532221">:=</span>&nbsp;<span class="ident" id="3532224">e</span><span class="op" id="3532225">.</span><span class="ident" id="3532226">actionNodeEdits</span><span class="op" id="3532241">[</span><span class="ident" id="3532242">n</span><span class="op" id="3532243">]</span><span class="op" id="3532244">;</span>&nbsp;<span class="ident" id="3532246">ok</span>&nbsp;<span class="op" id="3532249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3532253">panic</span><span class="op" id="3532258">(</span><span class="ident" id="3532259">fmt</span><span class="op" id="3532262">.</span><span class="ident" id="3532263">Sprintf</span><span class="op" id="3532270">(</span><span class="string" id="3532271">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="3532305">,</span>&nbsp;<span class="ident" id="3532307">n</span><span class="op" id="3532308">)</span><span class="op" id="3532309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532315">e</span><span class="op" id="3532316">.</span><span class="ident" id="3532317">actionNodeEdits</span><span class="op" id="3532332">[</span><span class="ident" id="3532333">n</span><span class="op" id="3532334">]</span>&nbsp;<span class="op" id="3532336">=</span>&nbsp;<span class="ident" id="3532338">cmds</span><br>
<span class="lineno"></span><span class="op" id="3532343">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="3532346">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="3532426">func</span>&nbsp;<span class="op" id="3532431">(</span><span class="ident" id="3532432">e</span>&nbsp;<span class="op" id="3532434">*</span><span class="ident" id="3532435">escaper</span><span class="op" id="3532442">)</span>&nbsp;<span class="ident" id="3532444">editTemplateNode</span><span class="op" id="3532460">(</span><span class="ident" id="3532461">n</span>&nbsp;<span class="op" id="3532463">*</span><span class="ident" id="3532464">parse</span><span class="op" id="3532469">.</span><span class="ident" id="3532470">TemplateNode</span><span class="op" id="3532482">,</span>&nbsp;<span class="ident" id="3532484">callee</span>&nbsp;<span class="builtintype" id="3532491">string</span><span class="op" id="3532497">)</span>&nbsp;<span class="op" id="3532499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532502">if</span>&nbsp;<span class="ident" id="3532505">_</span><span class="op" id="3532506">,</span>&nbsp;<span class="ident" id="3532508">ok</span>&nbsp;<span class="op" id="3532511">:=</span>&nbsp;<span class="ident" id="3532514">e</span><span class="op" id="3532515">.</span><span class="ident" id="3532516">templateNodeEdits</span><span class="op" id="3532533">[</span><span class="ident" id="3532534">n</span><span class="op" id="3532535">]</span><span class="op" id="3532536">;</span>&nbsp;<span class="ident" id="3532538">ok</span>&nbsp;<span class="op" id="3532541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3532545">panic</span><span class="op" id="3532550">(</span><span class="ident" id="3532551">fmt</span><span class="op" id="3532554">.</span><span class="ident" id="3532555">Sprintf</span><span class="op" id="3532562">(</span><span class="string" id="3532563">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="3532597">,</span>&nbsp;<span class="ident" id="3532599">n</span><span class="op" id="3532600">)</span><span class="op" id="3532601">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532607">e</span><span class="op" id="3532608">.</span><span class="ident" id="3532609">templateNodeEdits</span><span class="op" id="3532626">[</span><span class="ident" id="3532627">n</span><span class="op" id="3532628">]</span>&nbsp;<span class="op" id="3532630">=</span>&nbsp;<span class="ident" id="3532632">callee</span><br>
<span class="lineno"></span><span class="op" id="3532639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532642">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="3532708">func</span>&nbsp;<span class="op" id="3532713">(</span><span class="ident" id="3532714">e</span>&nbsp;<span class="op" id="3532716">*</span><span class="ident" id="3532717">escaper</span><span class="op" id="3532724">)</span>&nbsp;<span class="ident" id="3532726">editTextNode</span><span class="op" id="3532738">(</span><span class="ident" id="3532739">n</span>&nbsp;<span class="op" id="3532741">*</span><span class="ident" id="3532742">parse</span><span class="op" id="3532747">.</span><span class="ident" id="3532748">TextNode</span><span class="op" id="3532756">,</span>&nbsp;<span class="ident" id="3532758">text</span>&nbsp;<span class="op" id="3532763">[</span><span class="op" id="3532764">]</span><span class="builtintype" id="3532765">byte</span><span class="op" id="3532769">)</span>&nbsp;<span class="op" id="3532771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532774">if</span>&nbsp;<span class="ident" id="3532777">_</span><span class="op" id="3532778">,</span>&nbsp;<span class="ident" id="3532780">ok</span>&nbsp;<span class="op" id="3532783">:=</span>&nbsp;<span class="ident" id="3532786">e</span><span class="op" id="3532787">.</span><span class="ident" id="3532788">textNodeEdits</span><span class="op" id="3532801">[</span><span class="ident" id="3532802">n</span><span class="op" id="3532803">]</span><span class="op" id="3532804">;</span>&nbsp;<span class="ident" id="3532806">ok</span>&nbsp;<span class="op" id="3532809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3532813">panic</span><span class="op" id="3532818">(</span><span class="ident" id="3532819">fmt</span><span class="op" id="3532822">.</span><span class="ident" id="3532823">Sprintf</span><span class="op" id="3532830">(</span><span class="string" id="3532831">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="3532865">,</span>&nbsp;<span class="ident" id="3532867">n</span><span class="op" id="3532868">)</span><span class="op" id="3532869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532875">e</span><span class="op" id="3532876">.</span><span class="ident" id="3532877">textNodeEdits</span><span class="op" id="3532890">[</span><span class="ident" id="3532891">n</span><span class="op" id="3532892">]</span>&nbsp;<span class="op" id="3532894">=</span>&nbsp;<span class="ident" id="3532896">text</span><br>
<span class="lineno">735</span><span class="op" id="3532901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532904">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="3532983">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="3533048">func</span>&nbsp;<span class="op" id="3533053">(</span><span class="ident" id="3533054">e</span>&nbsp;<span class="op" id="3533056">*</span><span class="ident" id="3533057">escaper</span><span class="op" id="3533064">)</span>&nbsp;<span class="ident" id="3533066">commit</span><span class="op" id="3533072">(</span><span class="op" id="3533073">)</span>&nbsp;<span class="op" id="3533075">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533078">for</span>&nbsp;<span class="ident" id="3533082">name</span>&nbsp;<span class="op" id="3533087">:=</span>&nbsp;<span class="keyword" id="3533090">range</span>&nbsp;<span class="ident" id="3533096">e</span><span class="op" id="3533097">.</span><span class="ident" id="3533098">output</span>&nbsp;<span class="op" id="3533105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533109">e</span><span class="op" id="3533110">.</span><span class="ident" id="3533111">template</span><span class="op" id="3533119">(</span><span class="ident" id="3533120">name</span><span class="op" id="3533124">)</span><span class="op" id="3533125">.</span><span class="ident" id="3533126">Funcs</span><span class="op" id="3533131">(</span><span class="ident" id="3533132">funcMap</span><span class="op" id="3533139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533145">for</span>&nbsp;<span class="ident" id="3533149">_</span><span class="op" id="3533150">,</span>&nbsp;<span class="ident" id="3533152">t</span>&nbsp;<span class="op" id="3533154">:=</span>&nbsp;<span class="keyword" id="3533157">range</span>&nbsp;<span class="ident" id="3533163">e</span><span class="op" id="3533164">.</span><span class="ident" id="3533165">derived</span>&nbsp;<span class="op" id="3533173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533177">if</span>&nbsp;<span class="ident" id="3533180">_</span><span class="op" id="3533181">,</span>&nbsp;<span class="ident" id="3533183">err</span>&nbsp;<span class="op" id="3533187">:=</span>&nbsp;<span class="ident" id="3533190">e</span><span class="op" id="3533191">.</span><span class="ident" id="3533192">tmpl</span><span class="op" id="3533196">.</span><span class="ident" id="3533197">text</span><span class="op" id="3533201">.</span><span class="ident" id="3533202">AddParseTree</span><span class="op" id="3533214">(</span><span class="ident" id="3533215">t</span><span class="op" id="3533216">.</span><span class="ident" id="3533217">Name</span><span class="op" id="3533221">(</span><span class="op" id="3533222">)</span><span class="op" id="3533223">,</span>&nbsp;<span class="ident" id="3533225">t</span><span class="op" id="3533226">.</span><span class="ident" id="3533227">Tree</span><span class="op" id="3533231">)</span><span class="op" id="3533232">;</span>&nbsp;<span class="ident" id="3533234">err</span>&nbsp;<span class="op" id="3533238">!=</span>&nbsp;<span class="ident" id="3533241">nil</span>&nbsp;<span class="op" id="3533245">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3533250">panic</span><span class="op" id="3533255">(</span><span class="string" id="3533256">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="3533287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533297">for</span>&nbsp;<span class="ident" id="3533301">n</span><span class="op" id="3533302">,</span>&nbsp;<span class="ident" id="3533304">s</span>&nbsp;<span class="op" id="3533306">:=</span>&nbsp;<span class="keyword" id="3533309">range</span>&nbsp;<span class="ident" id="3533315">e</span><span class="op" id="3533316">.</span><span class="ident" id="3533317">actionNodeEdits</span>&nbsp;<span class="op" id="3533333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533337">ensurePipelineContains</span><span class="op" id="3533359">(</span><span class="ident" id="3533360">n</span><span class="op" id="3533361">.</span><span class="ident" id="3533362">Pipe</span><span class="op" id="3533366">,</span>&nbsp;<span class="ident" id="3533368">s</span><span class="op" id="3533369">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533375">for</span>&nbsp;<span class="ident" id="3533379">n</span><span class="op" id="3533380">,</span>&nbsp;<span class="ident" id="3533382">name</span>&nbsp;<span class="op" id="3533387">:=</span>&nbsp;<span class="keyword" id="3533390">range</span>&nbsp;<span class="ident" id="3533396">e</span><span class="op" id="3533397">.</span><span class="ident" id="3533398">templateNodeEdits</span>&nbsp;<span class="op" id="3533416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533420">n</span><span class="op" id="3533421">.</span><span class="ident" id="3533422">Name</span>&nbsp;<span class="op" id="3533427">=</span>&nbsp;<span class="ident" id="3533429">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533438">for</span>&nbsp;<span class="ident" id="3533442">n</span><span class="op" id="3533443">,</span>&nbsp;<span class="ident" id="3533445">s</span>&nbsp;<span class="op" id="3533447">:=</span>&nbsp;<span class="keyword" id="3533450">range</span>&nbsp;<span class="ident" id="3533456">e</span><span class="op" id="3533457">.</span><span class="ident" id="3533458">textNodeEdits</span>&nbsp;<span class="op" id="3533472">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533476">n</span><span class="op" id="3533477">.</span><span class="ident" id="3533478">Text</span>&nbsp;<span class="op" id="3533483">=</span>&nbsp;<span class="ident" id="3533485">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533488">}</span><br>
<span class="lineno"></span><span class="op" id="3533490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533493">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="3533563">func</span>&nbsp;<span class="op" id="3533568">(</span><span class="ident" id="3533569">e</span>&nbsp;<span class="op" id="3533571">*</span><span class="ident" id="3533572">escaper</span><span class="op" id="3533579">)</span>&nbsp;<span class="ident" id="3533581">template</span><span class="op" id="3533589">(</span><span class="ident" id="3533590">name</span>&nbsp;<span class="builtintype" id="3533595">string</span><span class="op" id="3533601">)</span>&nbsp;<span class="op" id="3533603">*</span><span class="ident" id="3533604">template</span><span class="op" id="3533612">.</span><span class="ident" id="3533613">Template</span>&nbsp;<span class="op" id="3533622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533625">t</span>&nbsp;<span class="op" id="3533627">:=</span>&nbsp;<span class="ident" id="3533630">e</span><span class="op" id="3533631">.</span><span class="ident" id="3533632">tmpl</span><span class="op" id="3533636">.</span><span class="ident" id="3533637">text</span><span class="op" id="3533641">.</span><span class="ident" id="3533642">Lookup</span><span class="op" id="3533648">(</span><span class="ident" id="3533649">name</span><span class="op" id="3533653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533656">if</span>&nbsp;<span class="ident" id="3533659">t</span>&nbsp;<span class="op" id="3533661">==</span>&nbsp;<span class="ident" id="3533664">nil</span>&nbsp;<span class="op" id="3533668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533672">t</span>&nbsp;<span class="op" id="3533674">=</span>&nbsp;<span class="ident" id="3533676">e</span><span class="op" id="3533677">.</span><span class="ident" id="3533678">derived</span><span class="op" id="3533685">[</span><span class="ident" id="3533686">name</span><span class="op" id="3533690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533693">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533696">return</span>&nbsp;<span class="ident" id="3533703">t</span><br>
<span class="lineno"></span><span class="op" id="3533705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533708">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="3533778">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3533840">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="3533920">func</span>&nbsp;<span class="ident" id="3533925">HTMLEscape</span><span class="op" id="3533935">(</span><span class="ident" id="3533936">w</span>&nbsp;<span class="ident" id="3533938">io</span><span class="op" id="3533940">.</span><span class="ident" id="3533941">Writer</span><span class="op" id="3533947">,</span>&nbsp;<span class="ident" id="3533949">b</span>&nbsp;<span class="op" id="3533951">[</span><span class="op" id="3533952">]</span><span class="builtintype" id="3533953">byte</span><span class="op" id="3533957">)</span>&nbsp;<span class="op" id="3533959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533962">template</span><span class="op" id="3533970">.</span><span class="ident" id="3533971">HTMLEscape</span><span class="op" id="3533981">(</span><span class="ident" id="3533982">w</span><span class="op" id="3533983">,</span>&nbsp;<span class="ident" id="3533985">b</span><span class="op" id="3533986">)</span><br>
<span class="lineno"></span><span class="op" id="3533988">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="3533991">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="3534073">func</span>&nbsp;<span class="ident" id="3534078">HTMLEscapeString</span><span class="op" id="3534094">(</span><span class="ident" id="3534095">s</span>&nbsp;<span class="builtintype" id="3534097">string</span><span class="op" id="3534103">)</span>&nbsp;<span class="builtintype" id="3534105">string</span>&nbsp;<span class="op" id="3534112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534115">return</span>&nbsp;<span class="ident" id="3534122">template</span><span class="op" id="3534130">.</span><span class="ident" id="3534131">HTMLEscapeString</span><span class="op" id="3534147">(</span><span class="ident" id="3534148">s</span><span class="op" id="3534149">)</span><br>
<span class="lineno"></span><span class="op" id="3534151">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="3534154">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="3534220">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="3534256">func</span>&nbsp;<span class="ident" id="3534261">HTMLEscaper</span><span class="op" id="3534272">(</span><span class="ident" id="3534273">args</span>&nbsp;<span class="op" id="3534278">...</span><span class="keyword" id="3534281">interface</span><span class="op" id="3534290">{</span><span class="op" id="3534291">}</span><span class="op" id="3534292">)</span>&nbsp;<span class="builtintype" id="3534294">string</span>&nbsp;<span class="op" id="3534301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534304">return</span>&nbsp;<span class="ident" id="3534311">template</span><span class="op" id="3534319">.</span><span class="ident" id="3534320">HTMLEscaper</span><span class="op" id="3534331">(</span><span class="ident" id="3534332">args</span><span class="op" id="3534336">...</span><span class="op" id="3534339">)</span><br>
<span class="lineno">785</span><span class="op" id="3534341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3534344">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="3534428">func</span>&nbsp;<span class="ident" id="3534433">JSEscape</span><span class="op" id="3534441">(</span><span class="ident" id="3534442">w</span>&nbsp;<span class="ident" id="3534444">io</span><span class="op" id="3534446">.</span><span class="ident" id="3534447">Writer</span><span class="op" id="3534453">,</span>&nbsp;<span class="ident" id="3534455">b</span>&nbsp;<span class="op" id="3534457">[</span><span class="op" id="3534458">]</span><span class="builtintype" id="3534459">byte</span><span class="op" id="3534463">)</span>&nbsp;<span class="op" id="3534465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534468">template</span><span class="op" id="3534476">.</span><span class="ident" id="3534477">JSEscape</span><span class="op" id="3534485">(</span><span class="ident" id="3534486">w</span><span class="op" id="3534487">,</span>&nbsp;<span class="ident" id="3534489">b</span><span class="op" id="3534490">)</span><br>
<span class="lineno">790</span><span class="op" id="3534492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3534495">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="3534581">func</span>&nbsp;<span class="ident" id="3534586">JSEscapeString</span><span class="op" id="3534600">(</span><span class="ident" id="3534601">s</span>&nbsp;<span class="builtintype" id="3534603">string</span><span class="op" id="3534609">)</span>&nbsp;<span class="builtintype" id="3534611">string</span>&nbsp;<span class="op" id="3534618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534621">return</span>&nbsp;<span class="ident" id="3534628">template</span><span class="op" id="3534636">.</span><span class="ident" id="3534637">JSEscapeString</span><span class="op" id="3534651">(</span><span class="ident" id="3534652">s</span><span class="op" id="3534653">)</span><br>
<span class="lineno">795</span><span class="op" id="3534655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3534658">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="3534728">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="3534764">func</span>&nbsp;<span class="ident" id="3534769">JSEscaper</span><span class="op" id="3534778">(</span><span class="ident" id="3534779">args</span>&nbsp;<span class="op" id="3534784">...</span><span class="keyword" id="3534787">interface</span><span class="op" id="3534796">{</span><span class="op" id="3534797">}</span><span class="op" id="3534798">)</span>&nbsp;<span class="builtintype" id="3534800">string</span>&nbsp;<span class="op" id="3534807">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534810">return</span>&nbsp;<span class="ident" id="3534817">template</span><span class="op" id="3534825">.</span><span class="ident" id="3534826">JSEscaper</span><span class="op" id="3534835">(</span><span class="ident" id="3534836">args</span><span class="op" id="3534840">...</span><span class="op" id="3534843">)</span><br>
<span class="lineno"></span><span class="op" id="3534845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3534848">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3534926">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="3534992">func</span>&nbsp;<span class="ident" id="3534997">URLQueryEscaper</span><span class="op" id="3535012">(</span><span class="ident" id="3535013">args</span>&nbsp;<span class="op" id="3535018">...</span><span class="keyword" id="3535021">interface</span><span class="op" id="3535030">{</span><span class="op" id="3535031">}</span><span class="op" id="3535032">)</span>&nbsp;<span class="builtintype" id="3535034">string</span>&nbsp;<span class="op" id="3535041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535044">return</span>&nbsp;<span class="ident" id="3535051">template</span><span class="op" id="3535059">.</span><span class="ident" id="3535060">URLQueryEscaper</span><span class="op" id="3535075">(</span><span class="ident" id="3535076">args</span><span class="op" id="3535080">...</span><span class="op" id="3535083">)</span><br>
<span class="lineno"></span><span class="op" id="3535085">}</span>
</div>
</body>
</html>
