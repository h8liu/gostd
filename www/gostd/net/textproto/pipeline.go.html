<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4547670">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4547726">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4547780">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4547831">package</span>&nbsp;<span class="ident" id="4547839">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4547850">import</span>&nbsp;<span class="op" id="4547857">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4547860">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4547867">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="4547870">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="4547940">//</span><br>
<span class="lineno"></span><span class="comment" id="4547943">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="4548010">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="4548037">//</span><br>
<span class="lineno"></span><span class="comment" id="4548040">//&nbsp;&nbsp;&nbsp;&nbspid&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="4548075">//</span><br>
<span class="lineno"></span><span class="comment" id="4548078">//&nbsp;&nbsp;&nbsp;&nbspp.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="4548133">//&nbsp;&nbsp;&nbsp;&nbsp«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="4548153">//&nbsp;&nbsp;&nbsp;&nbspp.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="4548213">//</span><br>
<span class="lineno"></span><span class="comment" id="4548216">//&nbsp;&nbsp;&nbsp;&nbspp.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="4548273">//&nbsp;&nbsp;&nbsp;&nbsp«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="4548294">//&nbsp;&nbsp;&nbsp;&nbspp.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="4548356">//</span><br>
<span class="lineno"></span><span class="comment" id="4548359">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4548419">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="4548487">type</span>&nbsp;<span class="ident" id="4548492">Pipeline</span>&nbsp;<span class="keyword" id="4548501">struct</span>&nbsp;<span class="op" id="4548508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548511">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4548520">sync</span><span class="op" id="4548524">.</span><span class="ident" id="4548525">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548532">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4548541">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548547">request</span>&nbsp;&nbsp;<span class="ident" id="4548556">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548567">response</span>&nbsp;<span class="ident" id="4548576">sequencer</span><br>
<span class="lineno"></span><span class="op" id="4548586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4548589">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="4548646">func</span>&nbsp;<span class="op" id="4548651">(</span><span class="ident" id="4548652">p</span>&nbsp;<span class="op" id="4548654">*</span><span class="ident" id="4548655">Pipeline</span><span class="op" id="4548663">)</span>&nbsp;<span class="ident" id="4548665">Next</span><span class="op" id="4548669">(</span><span class="op" id="4548670">)</span>&nbsp;<span class="builtintype" id="4548672">uint</span>&nbsp;<span class="op" id="4548677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548680">p</span><span class="op" id="4548681">.</span><span class="ident" id="4548682">mu</span><span class="op" id="4548684">.</span><span class="ident" id="4548685">Lock</span><span class="op" id="4548689">(</span><span class="op" id="4548690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548693">id</span>&nbsp;<span class="op" id="4548696">:=</span>&nbsp;<span class="ident" id="4548699">p</span><span class="op" id="4548700">.</span><span class="ident" id="4548701">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548705">p</span><span class="op" id="4548706">.</span><span class="ident" id="4548707">id</span><span class="op" id="4548709">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548713">p</span><span class="op" id="4548714">.</span><span class="ident" id="4548715">mu</span><span class="op" id="4548717">.</span><span class="ident" id="4548718">Unlock</span><span class="op" id="4548724">(</span><span class="op" id="4548725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4548728">return</span>&nbsp;<span class="ident" id="4548735">id</span><br>
<span class="lineno"></span><span class="op" id="4548738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4548741">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="4548824">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="4548858">func</span>&nbsp;<span class="op" id="4548863">(</span><span class="ident" id="4548864">p</span>&nbsp;<span class="op" id="4548866">*</span><span class="ident" id="4548867">Pipeline</span><span class="op" id="4548875">)</span>&nbsp;<span class="ident" id="4548877">StartRequest</span><span class="op" id="4548889">(</span><span class="ident" id="4548890">id</span>&nbsp;<span class="builtintype" id="4548893">uint</span><span class="op" id="4548897">)</span>&nbsp;<span class="op" id="4548899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4548902">p</span><span class="op" id="4548903">.</span><span class="ident" id="4548904">request</span><span class="op" id="4548911">.</span><span class="ident" id="4548912">Start</span><span class="op" id="4548917">(</span><span class="ident" id="4548918">id</span><span class="op" id="4548920">)</span><br>
<span class="lineno"></span><span class="op" id="4548922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4548925">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="4548999">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="4549039">func</span>&nbsp;<span class="op" id="4549044">(</span><span class="ident" id="4549045">p</span>&nbsp;<span class="op" id="4549047">*</span><span class="ident" id="4549048">Pipeline</span><span class="op" id="4549056">)</span>&nbsp;<span class="ident" id="4549058">EndRequest</span><span class="op" id="4549068">(</span><span class="ident" id="4549069">id</span>&nbsp;<span class="builtintype" id="4549072">uint</span><span class="op" id="4549076">)</span>&nbsp;<span class="op" id="4549078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549081">p</span><span class="op" id="4549082">.</span><span class="ident" id="4549083">request</span><span class="op" id="4549090">.</span><span class="ident" id="4549091">End</span><span class="op" id="4549094">(</span><span class="ident" id="4549095">id</span><span class="op" id="4549097">)</span><br>
<span class="lineno"></span><span class="op" id="4549099">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="4549102">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="4549186">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="4549220">func</span>&nbsp;<span class="op" id="4549225">(</span><span class="ident" id="4549226">p</span>&nbsp;<span class="op" id="4549228">*</span><span class="ident" id="4549229">Pipeline</span><span class="op" id="4549237">)</span>&nbsp;<span class="ident" id="4549239">StartResponse</span><span class="op" id="4549252">(</span><span class="ident" id="4549253">id</span>&nbsp;<span class="builtintype" id="4549256">uint</span><span class="op" id="4549260">)</span>&nbsp;<span class="op" id="4549262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549265">p</span><span class="op" id="4549266">.</span><span class="ident" id="4549267">response</span><span class="op" id="4549275">.</span><span class="ident" id="4549276">Start</span><span class="op" id="4549281">(</span><span class="ident" id="4549282">id</span><span class="op" id="4549284">)</span><br>
<span class="lineno">60</span><span class="op" id="4549286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4549289">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="4549369">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="4549405">func</span>&nbsp;<span class="op" id="4549410">(</span><span class="ident" id="4549411">p</span>&nbsp;<span class="op" id="4549413">*</span><span class="ident" id="4549414">Pipeline</span><span class="op" id="4549422">)</span>&nbsp;<span class="ident" id="4549424">EndResponse</span><span class="op" id="4549435">(</span><span class="ident" id="4549436">id</span>&nbsp;<span class="builtintype" id="4549439">uint</span><span class="op" id="4549443">)</span>&nbsp;<span class="op" id="4549445">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549448">p</span><span class="op" id="4549449">.</span><span class="ident" id="4549450">response</span><span class="op" id="4549458">.</span><span class="ident" id="4549459">End</span><span class="op" id="4549462">(</span><span class="ident" id="4549463">id</span><span class="op" id="4549465">)</span><br>
<span class="lineno"></span><span class="op" id="4549467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4549470">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="4549535">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="4549608">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="4549679">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="4549748">type</span>&nbsp;<span class="ident" id="4549753">sequencer</span>&nbsp;<span class="keyword" id="4549763">struct</span>&nbsp;<span class="op" id="4549770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549773">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4549778">sync</span><span class="op" id="4549782">.</span><span class="ident" id="4549783">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549790">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4549795">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4549801">wait</span>&nbsp;<span class="keyword" id="4549806">map</span><span class="op" id="4549809">[</span><span class="builtintype" id="4549810">uint</span><span class="op" id="4549814">]</span><span class="keyword" id="4549815">chan</span>&nbsp;<span class="builtintype" id="4549820">uint</span><br>
<span class="lineno"></span><span class="op" id="4549825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4549828">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="4549896">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="4549965">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="4549981">func</span>&nbsp;<span class="op" id="4549986">(</span><span class="ident" id="4549987">s</span>&nbsp;<span class="op" id="4549989">*</span><span class="ident" id="4549990">sequencer</span><span class="op" id="4549999">)</span>&nbsp;<span class="ident" id="4550001">Start</span><span class="op" id="4550006">(</span><span class="ident" id="4550007">id</span>&nbsp;<span class="builtintype" id="4550010">uint</span><span class="op" id="4550014">)</span>&nbsp;<span class="op" id="4550016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550019">s</span><span class="op" id="4550020">.</span><span class="ident" id="4550021">mu</span><span class="op" id="4550023">.</span><span class="ident" id="4550024">Lock</span><span class="op" id="4550028">(</span><span class="op" id="4550029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550032">if</span>&nbsp;<span class="ident" id="4550035">s</span><span class="op" id="4550036">.</span><span class="ident" id="4550037">id</span>&nbsp;<span class="op" id="4550040">==</span>&nbsp;<span class="ident" id="4550043">id</span>&nbsp;<span class="op" id="4550046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550050">s</span><span class="op" id="4550051">.</span><span class="ident" id="4550052">mu</span><span class="op" id="4550054">.</span><span class="ident" id="4550055">Unlock</span><span class="op" id="4550061">(</span><span class="op" id="4550062">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550066">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550077">c</span>&nbsp;<span class="op" id="4550079">:=</span>&nbsp;<span class="builtinfunc" id="4550082">make</span><span class="op" id="4550086">(</span><span class="keyword" id="4550087">chan</span>&nbsp;<span class="builtintype" id="4550092">uint</span><span class="op" id="4550096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550099">if</span>&nbsp;<span class="ident" id="4550102">s</span><span class="op" id="4550103">.</span><span class="ident" id="4550104">wait</span>&nbsp;<span class="op" id="4550109">==</span>&nbsp;<span class="ident" id="4550112">nil</span>&nbsp;<span class="op" id="4550116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550120">s</span><span class="op" id="4550121">.</span><span class="ident" id="4550122">wait</span>&nbsp;<span class="op" id="4550127">=</span>&nbsp;<span class="builtinfunc" id="4550129">make</span><span class="op" id="4550133">(</span><span class="keyword" id="4550134">map</span><span class="op" id="4550137">[</span><span class="builtintype" id="4550138">uint</span><span class="op" id="4550142">]</span><span class="keyword" id="4550143">chan</span>&nbsp;<span class="builtintype" id="4550148">uint</span><span class="op" id="4550152">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550158">s</span><span class="op" id="4550159">.</span><span class="ident" id="4550160">wait</span><span class="op" id="4550164">[</span><span class="ident" id="4550165">id</span><span class="op" id="4550167">]</span>&nbsp;<span class="op" id="4550169">=</span>&nbsp;<span class="ident" id="4550171">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550174">s</span><span class="op" id="4550175">.</span><span class="ident" id="4550176">mu</span><span class="op" id="4550178">.</span><span class="ident" id="4550179">Unlock</span><span class="op" id="4550185">(</span><span class="op" id="4550186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550189">&lt;-</span><span class="ident" id="4550191">c</span><br>
<span class="lineno"></span><span class="op" id="4550193">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="4550196">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="4550268">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4550344">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="4550414">func</span>&nbsp;<span class="op" id="4550419">(</span><span class="ident" id="4550420">s</span>&nbsp;<span class="op" id="4550422">*</span><span class="ident" id="4550423">sequencer</span><span class="op" id="4550432">)</span>&nbsp;<span class="ident" id="4550434">End</span><span class="op" id="4550437">(</span><span class="ident" id="4550438">id</span>&nbsp;<span class="builtintype" id="4550441">uint</span><span class="op" id="4550445">)</span>&nbsp;<span class="op" id="4550447">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550450">s</span><span class="op" id="4550451">.</span><span class="ident" id="4550452">mu</span><span class="op" id="4550454">.</span><span class="ident" id="4550455">Lock</span><span class="op" id="4550459">(</span><span class="op" id="4550460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550463">if</span>&nbsp;<span class="ident" id="4550466">s</span><span class="op" id="4550467">.</span><span class="ident" id="4550468">id</span>&nbsp;<span class="op" id="4550471">!=</span>&nbsp;<span class="ident" id="4550474">id</span>&nbsp;<span class="op" id="4550477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4550481">panic</span><span class="op" id="4550486">(</span><span class="string" id="4550487">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="4550500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550506">id</span><span class="op" id="4550508">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550512">s</span><span class="op" id="4550513">.</span><span class="ident" id="4550514">id</span>&nbsp;<span class="op" id="4550517">=</span>&nbsp;<span class="ident" id="4550519">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550523">if</span>&nbsp;<span class="ident" id="4550526">s</span><span class="op" id="4550527">.</span><span class="ident" id="4550528">wait</span>&nbsp;<span class="op" id="4550533">==</span>&nbsp;<span class="ident" id="4550536">nil</span>&nbsp;<span class="op" id="4550540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550544">s</span><span class="op" id="4550545">.</span><span class="ident" id="4550546">wait</span>&nbsp;<span class="op" id="4550551">=</span>&nbsp;<span class="builtinfunc" id="4550553">make</span><span class="op" id="4550557">(</span><span class="keyword" id="4550558">map</span><span class="op" id="4550561">[</span><span class="builtintype" id="4550562">uint</span><span class="op" id="4550566">]</span><span class="keyword" id="4550567">chan</span>&nbsp;<span class="builtintype" id="4550572">uint</span><span class="op" id="4550576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550582">c</span><span class="op" id="4550583">,</span>&nbsp;<span class="ident" id="4550585">ok</span>&nbsp;<span class="op" id="4550588">:=</span>&nbsp;<span class="ident" id="4550591">s</span><span class="op" id="4550592">.</span><span class="ident" id="4550593">wait</span><span class="op" id="4550597">[</span><span class="ident" id="4550598">id</span><span class="op" id="4550600">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550603">if</span>&nbsp;<span class="ident" id="4550606">ok</span>&nbsp;<span class="op" id="4550609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4550613">delete</span><span class="op" id="4550619">(</span><span class="ident" id="4550620">s</span><span class="op" id="4550621">.</span><span class="ident" id="4550622">wait</span><span class="op" id="4550626">,</span>&nbsp;<span class="ident" id="4550628">id</span><span class="op" id="4550630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550636">s</span><span class="op" id="4550637">.</span><span class="ident" id="4550638">mu</span><span class="op" id="4550640">.</span><span class="ident" id="4550641">Unlock</span><span class="op" id="4550647">(</span><span class="op" id="4550648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4550651">if</span>&nbsp;<span class="ident" id="4550654">ok</span>&nbsp;<span class="op" id="4550657">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4550661">c</span>&nbsp;<span class="op" id="4550663">&lt;-</span>&nbsp;<span class="num" id="4550666">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4550669">}</span><br>
<span class="lineno"></span><span class="op" id="4550671">}</span>
</div>
</body>
</html>
