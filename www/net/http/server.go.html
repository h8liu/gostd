<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3399596">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3399651">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3399705">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3399756">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3399788">package</span>&nbsp;<span class="ident" id="3399796">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3399802">import</span>&nbsp;<span class="op" id="3399809">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399812">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399821">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399835">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399845">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399852">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399858">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399871">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399878">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399885">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399896">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399902">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399910">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399921">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399932">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399943">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399951">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399966">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3399973">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3399976">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3400017">var</span>&nbsp;<span class="op" id="3400021">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400024">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3400043">=</span>&nbsp;<span class="ident" id="3400045"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3400051">.</span><span class="ident" id="3400052">New</span><span class="op" id="3400055">(</span><span class="string" id="3400056">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3400087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400090">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3400109">=</span>&nbsp;<span class="ident" id="3400111"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3400117">.</span><span class="ident" id="3400118">New</span><span class="op" id="3400121">(</span><span class="string" id="3400122">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3400188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400191">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3400210">=</span>&nbsp;<span class="ident" id="3400212"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3400218">.</span><span class="ident" id="3400219">New</span><span class="op" id="3400222">(</span><span class="string" id="3400223">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3400247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400250">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3400269">=</span>&nbsp;<span class="ident" id="3400271"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3400277">.</span><span class="ident" id="3400278">New</span><span class="op" id="3400281">(</span><span class="string" id="3400282">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3400338">)</span><br>
<span class="lineno">35</span><span class="op" id="3400340">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3400343">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3400396">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3400448">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3400471">//</span><br>
<span class="lineno"></span><span class="comment" id="3400474">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3400545">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3400613">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3400676">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3400695">//</span><br>
<span class="lineno"></span><span class="comment" id="3400698">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3400767">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3400835">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3400905">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3400937">//</span><br>
<span class="lineno"></span><span class="keyword" id="3400940">type</span>&nbsp;<span class="ident" id="3400945">Handler</span>&nbsp;<span class="keyword" id="3400953">interface</span>&nbsp;<span class="op" id="3400963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400966">ServeHTTP</span><span class="op" id="3400975">(</span><span class="ident" id="3400976"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3400990">,</span>&nbsp;<span class="op" id="3400992">*</span><span class="ident" id="3400993"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3401000">)</span><br>
<span class="lineno"></span><span class="op" id="3401002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3401005">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3401065">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3401096">type</span>&nbsp;<span class="ident" id="3401101">ResponseWriter</span>&nbsp;<span class="keyword" id="3401116">interface</span>&nbsp;<span class="op" id="3401126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401129">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401197">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401264">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3401279">Header</span><span class="op" id="3401285">(</span><span class="op" id="3401286">)</span>&nbsp;<span class="ident" id="3401288"><a href="/net/http/header.go.html#3356649">Header</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401297">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401367">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401450">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401513">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401591">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3401655">Write</span><span class="op" id="3401660">(</span><span class="op" id="3401661">[</span><span class="op" id="3401662">]</span><span class="builtintype" id="3401663">byte</span><span class="op" id="3401667">)</span>&nbsp;<span class="op" id="3401669">(</span><span class="builtintype" id="3401670">int</span><span class="op" id="3401673">,</span>&nbsp;<span class="builtintype" id="3401675">error</span><span class="op" id="3401680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401684">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401748">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401817">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401874">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3401932">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3401954">WriteHeader</span><span class="op" id="3401965">(</span><span class="builtintype" id="3401966">int</span><span class="op" id="3401969">)</span><br>
<span class="lineno"></span><span class="op" id="3401971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3401974">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3402044">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3402101">//</span><br>
<span class="lineno"></span><span class="comment" id="3402104">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3402162">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3402215">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3402280">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3402294">type</span>&nbsp;<span class="ident" id="3402299">Flusher</span>&nbsp;<span class="keyword" id="3402307">interface</span>&nbsp;<span class="op" id="3402317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3402320">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3402369">Flush</span><span class="op" id="3402374">(</span><span class="op" id="3402375">)</span><br>
<span class="lineno"></span><span class="op" id="3402377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3402380">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3402451">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3402499">type</span>&nbsp;<span class="ident" id="3402504">Hijacker</span>&nbsp;<span class="keyword" id="3402513">interface</span>&nbsp;<span class="op" id="3402523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3402526">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3402579">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3402633">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3402684">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3402737">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3402767">Hijack</span><span class="op" id="3402773">(</span><span class="op" id="3402774">)</span>&nbsp;<span class="op" id="3402776">(</span><span class="ident" id="3402777"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3402780">.</span><span class="ident" id="3402781">Conn</span><span class="op" id="3402785">,</span>&nbsp;<span class="op" id="3402787">*</span><span class="ident" id="3402788"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3402793">.</span><span class="ident" id="3402794">ReadWriter</span><span class="op" id="3402804">,</span>&nbsp;<span class="builtintype" id="3402806">error</span><span class="op" id="3402811">)</span><br>
<span class="lineno"></span><span class="op" id="3402813">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3402816">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3402887">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3402952">//</span><br>
<span class="lineno"></span><span class="comment" id="3402955">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3403025">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3403089">type</span>&nbsp;<span class="ident" id="3403094">CloseNotifier</span>&nbsp;<span class="keyword" id="3403108">interface</span>&nbsp;<span class="op" id="3403118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403121">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403184">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403230">CloseNotify</span><span class="op" id="3403241">(</span><span class="op" id="3403242">)</span>&nbsp;<span class="op" id="3403244">&lt;-</span><span class="keyword" id="3403246">chan</span>&nbsp;<span class="builtintype" id="3403251">bool</span><br>
<span class="lineno">110</span><span class="op" id="3403256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3403259">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3403319">type</span>&nbsp;<span class="ident" id="3403324">conn</span>&nbsp;<span class="keyword" id="3403329">struct</span>&nbsp;<span class="op" id="3403336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403339">remoteAddr</span>&nbsp;<span class="builtintype" id="3403350">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403371">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403406">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3403417">*</span><span class="ident" id="3403418"><a href="/net/http/server.go.html#3447093">Server</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403438">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403485">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403496"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3403499">.</span><span class="ident" id="3403500">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403517">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403536">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403547"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3403549">.</span><span class="ident" id="3403550">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403568">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403629">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3403640">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403661">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403689">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403700"><a href="/net/http/server.go.html#3405825">liveSwitchReader</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403721">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403775">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3403786">*</span><span class="ident" id="3403787"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3403789">.</span><span class="ident" id="3403790">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403807">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403830">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3403841">*</span><span class="ident" id="3403842"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3403847">.</span><span class="ident" id="3403848">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403862">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403925">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3403936">*</span><span class="ident" id="3403937"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3403940">.</span><span class="ident" id="3403941">ConnectionState</span>&nbsp;<span class="comment" id="3403957">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403988">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3404001"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3404005">.</span><span class="ident" id="3404006">Mutex</span>&nbsp;<span class="comment" id="3404012">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404037">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3404050">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3404061">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404104">closeNotifyc</span>&nbsp;<span class="keyword" id="3404117">chan</span>&nbsp;<span class="builtintype" id="3404122">bool</span>&nbsp;&nbsp;<span class="comment" id="3404128">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404144">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3404157">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3404168">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3404211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3404214">func</span>&nbsp;<span class="op" id="3404219">(</span><span class="ident" id="3404220">c</span>&nbsp;<span class="op" id="3404222">*</span><span class="ident" id="3404223"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3404227">)</span>&nbsp;<span class="ident" id="3404229">hijacked</span><span class="op" id="3404237">(</span><span class="op" id="3404238">)</span>&nbsp;<span class="builtintype" id="3404240">bool</span>&nbsp;<span class="op" id="3404245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404248"><a href="/net/http/server.go.html#3404220">c</a></span><span class="op" id="3404249">.</span><span class="ident" id="3404250">mu</span><span class="op" id="3404252">.</span><span class="ident" id="3404253">Lock</span><span class="op" id="3404257">(</span><span class="op" id="3404258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404261">defer</span>&nbsp;<span class="ident" id="3404267"><a href="/net/http/server.go.html#3404220">c</a></span><span class="op" id="3404268">.</span><span class="ident" id="3404269">mu</span><span class="op" id="3404271">.</span><span class="ident" id="3404272">Unlock</span><span class="op" id="3404278">(</span><span class="op" id="3404279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404282">return</span>&nbsp;<span class="ident" id="3404289"><a href="/net/http/server.go.html#3404220">c</a></span><span class="op" id="3404290">.</span><span class="ident" id="3404291">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3404301">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3404304">func</span>&nbsp;<span class="op" id="3404309">(</span><span class="ident" id="3404310">c</span>&nbsp;<span class="op" id="3404312">*</span><span class="ident" id="3404313"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3404317">)</span>&nbsp;<span class="ident" id="3404319">hijack</span><span class="op" id="3404325">(</span><span class="op" id="3404326">)</span>&nbsp;<span class="op" id="3404328">(</span><span class="ident" id="3404329">rwc</span>&nbsp;<span class="ident" id="3404333"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3404336">.</span><span class="ident" id="3404337">Conn</span><span class="op" id="3404341">,</span>&nbsp;<span class="ident" id="3404343">buf</span>&nbsp;<span class="op" id="3404347">*</span><span class="ident" id="3404348"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3404353">.</span><span class="ident" id="3404354">ReadWriter</span><span class="op" id="3404364">,</span>&nbsp;<span class="ident" id="3404366">err</span>&nbsp;<span class="builtintype" id="3404370">error</span><span class="op" id="3404375">)</span>&nbsp;<span class="op" id="3404377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404380"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404381">.</span><span class="ident" id="3404382">mu</span><span class="op" id="3404384">.</span><span class="ident" id="3404385">Lock</span><span class="op" id="3404389">(</span><span class="op" id="3404390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404393">defer</span>&nbsp;<span class="ident" id="3404399"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404400">.</span><span class="ident" id="3404401">mu</span><span class="op" id="3404403">.</span><span class="ident" id="3404404">Unlock</span><span class="op" id="3404410">(</span><span class="op" id="3404411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404414">if</span>&nbsp;<span class="ident" id="3404417"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404418">.</span><span class="ident" id="3404419">hijackedv</span>&nbsp;<span class="op" id="3404429">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404433">return</span>&nbsp;<span class="ident" id="3404440">nil</span><span class="op" id="3404443">,</span>&nbsp;<span class="ident" id="3404445">nil</span><span class="op" id="3404448">,</span>&nbsp;<span class="ident" id="3404450"><a href="/net/http/server.go.html#3400191">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3404463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404466">if</span>&nbsp;<span class="ident" id="3404469"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404470">.</span><span class="ident" id="3404471">closeNotifyc</span>&nbsp;<span class="op" id="3404484">!=</span>&nbsp;<span class="ident" id="3404487">nil</span>&nbsp;<span class="op" id="3404491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404495">return</span>&nbsp;<span class="ident" id="3404502">nil</span><span class="op" id="3404505">,</span>&nbsp;<span class="ident" id="3404507">nil</span><span class="op" id="3404510">,</span>&nbsp;<span class="ident" id="3404512"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3404518">.</span><span class="ident" id="3404519">New</span><span class="op" id="3404522">(</span><span class="string" id="3404523">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3404579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3404582">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404585"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404586">.</span><span class="ident" id="3404587">hijackedv</span>&nbsp;<span class="op" id="3404597">=</span>&nbsp;<span class="builtintype" id="3404599">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404605"><a href="/net/http/server.go.html#3404329">rwc</a></span>&nbsp;<span class="op" id="3404609">=</span>&nbsp;<span class="ident" id="3404611"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404612">.</span><span class="ident" id="3404613">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404618"><a href="/net/http/server.go.html#3404343">buf</a></span>&nbsp;<span class="op" id="3404622">=</span>&nbsp;<span class="ident" id="3404624"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404625">.</span><span class="ident" id="3404626">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404631"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404632">.</span><span class="ident" id="3404633">rwc</span>&nbsp;<span class="op" id="3404637">=</span>&nbsp;<span class="ident" id="3404639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404644"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404645">.</span><span class="ident" id="3404646">buf</span>&nbsp;<span class="op" id="3404650">=</span>&nbsp;<span class="ident" id="3404652">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404657"><a href="/net/http/server.go.html#3404310">c</a></span><span class="op" id="3404658">.</span><span class="ident" id="3404659">setState</span><span class="op" id="3404667">(</span><span class="ident" id="3404668"><a href="/net/http/server.go.html#3404329">rwc</a></span><span class="op" id="3404671">,</span>&nbsp;<span class="ident" id="3404673"><a href="/net/http/server.go.html#3449673">StateHijacked</a></span><span class="op" id="3404686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404689">return</span><br>
<span class="lineno"></span><span class="op" id="3404696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3404699">func</span>&nbsp;<span class="op" id="3404704">(</span><span class="ident" id="3404705">c</span>&nbsp;<span class="op" id="3404707">*</span><span class="ident" id="3404708"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3404712">)</span>&nbsp;<span class="ident" id="3404714">closeNotify</span><span class="op" id="3404725">(</span><span class="op" id="3404726">)</span>&nbsp;<span class="op" id="3404728">&lt;-</span><span class="keyword" id="3404730">chan</span>&nbsp;<span class="builtintype" id="3404735">bool</span>&nbsp;<span class="op" id="3404740">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404743"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3404744">.</span><span class="ident" id="3404745">mu</span><span class="op" id="3404747">.</span><span class="ident" id="3404748">Lock</span><span class="op" id="3404752">(</span><span class="op" id="3404753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404756">defer</span>&nbsp;<span class="ident" id="3404762"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3404763">.</span><span class="ident" id="3404764">mu</span><span class="op" id="3404766">.</span><span class="ident" id="3404767">Unlock</span><span class="op" id="3404773">(</span><span class="op" id="3404774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404777">if</span>&nbsp;<span class="ident" id="3404780"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3404781">.</span><span class="ident" id="3404782">closeNotifyc</span>&nbsp;<span class="op" id="3404795">==</span>&nbsp;<span class="ident" id="3404798">nil</span>&nbsp;<span class="op" id="3404802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404806"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3404807">.</span><span class="ident" id="3404808">closeNotifyc</span>&nbsp;<span class="op" id="3404821">=</span>&nbsp;<span class="builtinfunc" id="3404823">make</span><span class="op" id="3404827">(</span><span class="keyword" id="3404828">chan</span>&nbsp;<span class="builtintype" id="3404833">bool</span><span class="op" id="3404837">,</span>&nbsp;<span class="num" id="3404839">1</span><span class="op" id="3404840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404844">if</span>&nbsp;<span class="ident" id="3404847"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3404848">.</span><span class="ident" id="3404849">hijackedv</span>&nbsp;<span class="op" id="3404859">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404864">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404914">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3404949">return</span>&nbsp;<span class="ident" id="3404956"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3404957">.</span><span class="ident" id="3404958">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3404973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3404977">pr</span><span class="op" id="3404979">,</span>&nbsp;<span class="ident" id="3404981">pw</span>&nbsp;<span class="op" id="3404984">:=</span>&nbsp;<span class="ident" id="3404987"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3404989">.</span><span class="ident" id="3404990">Pipe</span><span class="op" id="3404994">(</span><span class="op" id="3404995">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405000">readSource</span>&nbsp;<span class="op" id="3405011">:=</span>&nbsp;<span class="ident" id="3405014"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3405015">.</span><span class="ident" id="3405016">sr</span><span class="op" id="3405018">.</span><span class="ident" id="3405019">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405023"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3405024">.</span><span class="ident" id="3405025">sr</span><span class="op" id="3405027">.</span><span class="ident" id="3405028">Lock</span><span class="op" id="3405032">(</span><span class="op" id="3405033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405037"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3405038">.</span><span class="ident" id="3405039">sr</span><span class="op" id="3405041">.</span><span class="ident" id="3405042">r</span>&nbsp;<span class="op" id="3405044">=</span>&nbsp;<span class="ident" id="3405046"><a href="/net/http/server.go.html#3404977">pr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405051"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3405052">.</span><span class="ident" id="3405053">sr</span><span class="op" id="3405055">.</span><span class="ident" id="3405056">Unlock</span><span class="op" id="3405062">(</span><span class="op" id="3405063">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405067">go</span>&nbsp;<span class="keyword" id="3405070">func</span><span class="op" id="3405074">(</span><span class="op" id="3405075">)</span>&nbsp;<span class="op" id="3405077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405082">_</span><span class="op" id="3405083">,</span>&nbsp;<span class="ident" id="3405085">err</span>&nbsp;<span class="op" id="3405089">:=</span>&nbsp;<span class="ident" id="3405092"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3405094">.</span><span class="ident" id="3405095">Copy</span><span class="op" id="3405099">(</span><span class="ident" id="3405100"><a href="/net/http/server.go.html#3404981">pw</a></span><span class="op" id="3405102">,</span>&nbsp;<span class="ident" id="3405104"><a href="/net/http/server.go.html#3405000">readSource</a></span><span class="op" id="3405114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405119">if</span>&nbsp;<span class="ident" id="3405122"><a href="/net/http/server.go.html#3405085">err</a></span>&nbsp;<span class="op" id="3405126">==</span>&nbsp;<span class="ident" id="3405129">nil</span>&nbsp;<span class="op" id="3405133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405139"><a href="/net/http/server.go.html#3405085">err</a></span>&nbsp;<span class="op" id="3405143">=</span>&nbsp;<span class="ident" id="3405145"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3405147">.</span><span class="ident" id="3405148">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405155">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405160"><a href="/net/http/server.go.html#3404981">pw</a></span><span class="op" id="3405162">.</span><span class="ident" id="3405163">CloseWithError</span><span class="op" id="3405177">(</span><span class="ident" id="3405178"><a href="/net/http/server.go.html#3405085">err</a></span><span class="op" id="3405181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405186"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3405187">.</span><span class="ident" id="3405188">noteClientGone</span><span class="op" id="3405202">(</span><span class="op" id="3405203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405207">}</span><span class="op" id="3405208">(</span><span class="op" id="3405209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405215">return</span>&nbsp;<span class="ident" id="3405222"><a href="/net/http/server.go.html#3404705">c</a></span><span class="op" id="3405223">.</span><span class="ident" id="3405224">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3405237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3405240">func</span>&nbsp;<span class="op" id="3405245">(</span><span class="ident" id="3405246">c</span>&nbsp;<span class="op" id="3405248">*</span><span class="ident" id="3405249"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3405253">)</span>&nbsp;<span class="ident" id="3405255">noteClientGone</span><span class="op" id="3405269">(</span><span class="op" id="3405270">)</span>&nbsp;<span class="op" id="3405272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405275"><a href="/net/http/server.go.html#3405246">c</a></span><span class="op" id="3405276">.</span><span class="ident" id="3405277">mu</span><span class="op" id="3405279">.</span><span class="ident" id="3405280">Lock</span><span class="op" id="3405284">(</span><span class="op" id="3405285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405288">defer</span>&nbsp;<span class="ident" id="3405294"><a href="/net/http/server.go.html#3405246">c</a></span><span class="op" id="3405295">.</span><span class="ident" id="3405296">mu</span><span class="op" id="3405298">.</span><span class="ident" id="3405299">Unlock</span><span class="op" id="3405305">(</span><span class="op" id="3405306">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405309">if</span>&nbsp;<span class="ident" id="3405312"><a href="/net/http/server.go.html#3405246">c</a></span><span class="op" id="3405313">.</span><span class="ident" id="3405314">closeNotifyc</span>&nbsp;<span class="op" id="3405327">!=</span>&nbsp;<span class="ident" id="3405330">nil</span>&nbsp;<span class="op" id="3405334">&amp;&amp;</span>&nbsp;<span class="op" id="3405337">!</span><span class="ident" id="3405338"><a href="/net/http/server.go.html#3405246">c</a></span><span class="op" id="3405339">.</span><span class="ident" id="3405340">clientGone</span>&nbsp;<span class="op" id="3405351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405355"><a href="/net/http/server.go.html#3405246">c</a></span><span class="op" id="3405356">.</span><span class="ident" id="3405357">closeNotifyc</span>&nbsp;<span class="op" id="3405370">&lt;-</span>&nbsp;<span class="builtintype" id="3405373">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405382"><a href="/net/http/server.go.html#3405246">c</a></span><span class="op" id="3405383">.</span><span class="ident" id="3405384">clientGone</span>&nbsp;<span class="op" id="3405395">=</span>&nbsp;<span class="builtintype" id="3405397">true</span><br>
<span class="lineno"></span><span class="op" id="3405402">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3405405">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3405463">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3405515">type</span>&nbsp;<span class="ident" id="3405520">switchReader</span>&nbsp;<span class="keyword" id="3405533">struct</span>&nbsp;<span class="op" id="3405540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405543"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3405545">.</span><span class="ident" id="3405546">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3405553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3405556">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3405614">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3405667">type</span>&nbsp;<span class="ident" id="3405672">switchWriter</span>&nbsp;<span class="keyword" id="3405685">struct</span>&nbsp;<span class="op" id="3405692">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405695"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3405697">.</span><span class="ident" id="3405698">Writer</span><br>
<span class="lineno"></span><span class="op" id="3405705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3405708">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3405775">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3405820">type</span>&nbsp;<span class="ident" id="3405825">liveSwitchReader</span>&nbsp;<span class="keyword" id="3405842">struct</span>&nbsp;<span class="op" id="3405849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405852"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3405856">.</span><span class="ident" id="3405857">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405864">r</span>&nbsp;<span class="ident" id="3405866"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3405868">.</span><span class="ident" id="3405869">Reader</span><br>
<span class="lineno"></span><span class="op" id="3405876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3405879">func</span>&nbsp;<span class="op" id="3405884">(</span><span class="ident" id="3405885">sr</span>&nbsp;<span class="op" id="3405888">*</span><span class="ident" id="3405889"><a href="/net/http/server.go.html#3405825">liveSwitchReader</a></span><span class="op" id="3405905">)</span>&nbsp;<span class="ident" id="3405907">Read</span><span class="op" id="3405911">(</span><span class="ident" id="3405912">p</span>&nbsp;<span class="op" id="3405914">[</span><span class="op" id="3405915">]</span><span class="builtintype" id="3405916">byte</span><span class="op" id="3405920">)</span>&nbsp;<span class="op" id="3405922">(</span><span class="ident" id="3405923">n</span>&nbsp;<span class="builtintype" id="3405925">int</span><span class="op" id="3405928">,</span>&nbsp;<span class="ident" id="3405930">err</span>&nbsp;<span class="builtintype" id="3405934">error</span><span class="op" id="3405939">)</span>&nbsp;<span class="op" id="3405941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405944"><a href="/net/http/server.go.html#3405885">sr</a></span><span class="op" id="3405946">.</span><span class="ident" id="3405947">Lock</span><span class="op" id="3405951">(</span><span class="op" id="3405952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405955">r</span>&nbsp;<span class="op" id="3405957">:=</span>&nbsp;<span class="ident" id="3405960"><a href="/net/http/server.go.html#3405885">sr</a></span><span class="op" id="3405962">.</span><span class="ident" id="3405963">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405966"><a href="/net/http/server.go.html#3405885">sr</a></span><span class="op" id="3405968">.</span><span class="ident" id="3405969">Unlock</span><span class="op" id="3405975">(</span><span class="op" id="3405976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405979">return</span>&nbsp;<span class="ident" id="3405986"><a href="/net/http/server.go.html#3405955">r</a></span><span class="op" id="3405987">.</span><span class="ident" id="3405988">Read</span><span class="op" id="3405992">(</span><span class="ident" id="3405993"><a href="/net/http/server.go.html#3405912">p</a></span><span class="op" id="3405994">)</span><br>
<span class="lineno">215</span><span class="op" id="3405996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3405999">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3406053">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3406095">const</span>&nbsp;<span class="ident" id="3406101">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3406126">=</span>&nbsp;<span class="num" id="3406128">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3406134">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3406203">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3406252">//</span><br>
<span class="lineno"></span><span class="comment" id="3406255">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3406327">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3406398">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3406470">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3406544">//</span><br>
<span class="lineno"></span><span class="comment" id="3406547">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3406617">type</span>&nbsp;<span class="ident" id="3406622">chunkWriter</span>&nbsp;<span class="keyword" id="3406634">struct</span>&nbsp;<span class="op" id="3406641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406644">res</span>&nbsp;<span class="op" id="3406648">*</span><span class="ident" id="3406649"><a href="/net/http/server.go.html#3408205">response</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406660">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406722">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406780">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406838">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406878">header</span>&nbsp;<span class="ident" id="3406885"><a href="/net/http/header.go.html#3356649">Header</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406894">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406958">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3407008">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3407069">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407092">wroteHeader</span>&nbsp;<span class="builtintype" id="3407104">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3407111">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407146">chunking</span>&nbsp;<span class="builtintype" id="3407155">bool</span>&nbsp;<span class="comment" id="3407160">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3407210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3407213">var</span>&nbsp;<span class="op" id="3407217">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407220">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407231">=</span>&nbsp;<span class="op" id="3407233">[</span><span class="op" id="3407234">]</span><span class="builtintype" id="3407235">byte</span><span class="op" id="3407239">(</span><span class="string" id="3407240">&#34;\r\n&#34;</span><span class="op" id="3407246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407249">colonSpace</span>&nbsp;<span class="op" id="3407260">=</span>&nbsp;<span class="op" id="3407262">[</span><span class="op" id="3407263">]</span><span class="builtintype" id="3407264">byte</span><span class="op" id="3407268">(</span><span class="string" id="3407269">&#34;:&nbsp;&#34;</span><span class="op" id="3407273">)</span><br>
<span class="lineno"></span><span class="op" id="3407275">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3407278">func</span>&nbsp;<span class="op" id="3407283">(</span><span class="ident" id="3407284">cw</span>&nbsp;<span class="op" id="3407287">*</span><span class="ident" id="3407288"><a href="/net/http/server.go.html#3406622">chunkWriter</a></span><span class="op" id="3407299">)</span>&nbsp;<span class="ident" id="3407301">Write</span><span class="op" id="3407306">(</span><span class="ident" id="3407307">p</span>&nbsp;<span class="op" id="3407309">[</span><span class="op" id="3407310">]</span><span class="builtintype" id="3407311">byte</span><span class="op" id="3407315">)</span>&nbsp;<span class="op" id="3407317">(</span><span class="ident" id="3407318">n</span>&nbsp;<span class="builtintype" id="3407320">int</span><span class="op" id="3407323">,</span>&nbsp;<span class="ident" id="3407325">err</span>&nbsp;<span class="builtintype" id="3407329">error</span><span class="op" id="3407334">)</span>&nbsp;<span class="op" id="3407336">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407339">if</span>&nbsp;<span class="op" id="3407342">!</span><span class="ident" id="3407343"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407345">.</span><span class="ident" id="3407346">wroteHeader</span>&nbsp;<span class="op" id="3407358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407362"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407364">.</span><span class="ident" id="3407365">writeHeader</span><span class="op" id="3407376">(</span><span class="ident" id="3407377"><a href="/net/http/server.go.html#3407307">p</a></span><span class="op" id="3407378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407384">if</span>&nbsp;<span class="ident" id="3407387"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407389">.</span><span class="ident" id="3407390">res</span><span class="op" id="3407393">.</span><span class="ident" id="3407394">req</span><span class="op" id="3407397">.</span><span class="ident" id="3407398">Method</span>&nbsp;<span class="op" id="3407405">==</span>&nbsp;<span class="string" id="3407408">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3407415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3407419">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407436">return</span>&nbsp;<span class="builtinfunc" id="3407443">len</span><span class="op" id="3407446">(</span><span class="ident" id="3407447"><a href="/net/http/server.go.html#3407307">p</a></span><span class="op" id="3407448">)</span><span class="op" id="3407449">,</span>&nbsp;<span class="ident" id="3407451">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407459">if</span>&nbsp;<span class="ident" id="3407462"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407464">.</span><span class="ident" id="3407465">chunking</span>&nbsp;<span class="op" id="3407474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407478">_</span><span class="op" id="3407479">,</span>&nbsp;<span class="ident" id="3407481"><a href="/net/http/server.go.html#3407325">err</a></span>&nbsp;<span class="op" id="3407485">=</span>&nbsp;<span class="ident" id="3407487"><a href="/net/http/server.go.html#3399845">fmt</a></span><span class="op" id="3407490">.</span><span class="ident" id="3407491">Fprintf</span><span class="op" id="3407498">(</span><span class="ident" id="3407499"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407501">.</span><span class="ident" id="3407502">res</span><span class="op" id="3407505">.</span><span class="ident" id="3407506">conn</span><span class="op" id="3407510">.</span><span class="ident" id="3407511">buf</span><span class="op" id="3407514">,</span>&nbsp;<span class="string" id="3407516">&#34;%x\r\n&#34;</span><span class="op" id="3407524">,</span>&nbsp;<span class="builtinfunc" id="3407526">len</span><span class="op" id="3407529">(</span><span class="ident" id="3407530"><a href="/net/http/server.go.html#3407307">p</a></span><span class="op" id="3407531">)</span><span class="op" id="3407532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407536">if</span>&nbsp;<span class="ident" id="3407539"><a href="/net/http/server.go.html#3407325">err</a></span>&nbsp;<span class="op" id="3407543">!=</span>&nbsp;<span class="ident" id="3407546">nil</span>&nbsp;<span class="op" id="3407550">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407555"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407557">.</span><span class="ident" id="3407558">res</span><span class="op" id="3407561">.</span><span class="ident" id="3407562">conn</span><span class="op" id="3407566">.</span><span class="ident" id="3407567">rwc</span><span class="op" id="3407570">.</span><span class="ident" id="3407571">Close</span><span class="op" id="3407576">(</span><span class="op" id="3407577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407597"><a href="/net/http/server.go.html#3407318">n</a></span><span class="op" id="3407598">,</span>&nbsp;<span class="ident" id="3407600"><a href="/net/http/server.go.html#3407325">err</a></span>&nbsp;<span class="op" id="3407604">=</span>&nbsp;<span class="ident" id="3407606"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407608">.</span><span class="ident" id="3407609">res</span><span class="op" id="3407612">.</span><span class="ident" id="3407613">conn</span><span class="op" id="3407617">.</span><span class="ident" id="3407618">buf</span><span class="op" id="3407621">.</span><span class="ident" id="3407622">Write</span><span class="op" id="3407627">(</span><span class="ident" id="3407628"><a href="/net/http/server.go.html#3407307">p</a></span><span class="op" id="3407629">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407632">if</span>&nbsp;<span class="ident" id="3407635"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407637">.</span><span class="ident" id="3407638">chunking</span>&nbsp;<span class="op" id="3407647">&amp;&amp;</span>&nbsp;<span class="ident" id="3407650"><a href="/net/http/server.go.html#3407325">err</a></span>&nbsp;<span class="op" id="3407654">==</span>&nbsp;<span class="ident" id="3407657">nil</span>&nbsp;<span class="op" id="3407661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407665">_</span><span class="op" id="3407666">,</span>&nbsp;<span class="ident" id="3407668"><a href="/net/http/server.go.html#3407325">err</a></span>&nbsp;<span class="op" id="3407672">=</span>&nbsp;<span class="ident" id="3407674"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407676">.</span><span class="ident" id="3407677">res</span><span class="op" id="3407680">.</span><span class="ident" id="3407681">conn</span><span class="op" id="3407685">.</span><span class="ident" id="3407686">buf</span><span class="op" id="3407689">.</span><span class="ident" id="3407690">Write</span><span class="op" id="3407695">(</span><span class="ident" id="3407696"><a href="/net/http/server.go.html#3407220">crlf</a></span><span class="op" id="3407700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407706">if</span>&nbsp;<span class="ident" id="3407709"><a href="/net/http/server.go.html#3407325">err</a></span>&nbsp;<span class="op" id="3407713">!=</span>&nbsp;<span class="ident" id="3407716">nil</span>&nbsp;<span class="op" id="3407720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407724"><a href="/net/http/server.go.html#3407284">cw</a></span><span class="op" id="3407726">.</span><span class="ident" id="3407727">res</span><span class="op" id="3407730">.</span><span class="ident" id="3407731">conn</span><span class="op" id="3407735">.</span><span class="ident" id="3407736">rwc</span><span class="op" id="3407739">.</span><span class="ident" id="3407740">Close</span><span class="op" id="3407745">(</span><span class="op" id="3407746">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407752">return</span><br>
<span class="lineno"></span><span class="op" id="3407759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3407762">func</span>&nbsp;<span class="op" id="3407767">(</span><span class="ident" id="3407768">cw</span>&nbsp;<span class="op" id="3407771">*</span><span class="ident" id="3407772"><a href="/net/http/server.go.html#3406622">chunkWriter</a></span><span class="op" id="3407783">)</span>&nbsp;<span class="ident" id="3407785">flush</span><span class="op" id="3407790">(</span><span class="op" id="3407791">)</span>&nbsp;<span class="op" id="3407793">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407796">if</span>&nbsp;<span class="op" id="3407799">!</span><span class="ident" id="3407800"><a href="/net/http/server.go.html#3407768">cw</a></span><span class="op" id="3407802">.</span><span class="ident" id="3407803">wroteHeader</span>&nbsp;<span class="op" id="3407815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407819"><a href="/net/http/server.go.html#3407768">cw</a></span><span class="op" id="3407821">.</span><span class="ident" id="3407822">writeHeader</span><span class="op" id="3407833">(</span><span class="ident" id="3407834">nil</span><span class="op" id="3407837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407843"><a href="/net/http/server.go.html#3407768">cw</a></span><span class="op" id="3407845">.</span><span class="ident" id="3407846">res</span><span class="op" id="3407849">.</span><span class="ident" id="3407850">conn</span><span class="op" id="3407854">.</span><span class="ident" id="3407855">buf</span><span class="op" id="3407858">.</span><span class="ident" id="3407859">Flush</span><span class="op" id="3407864">(</span><span class="op" id="3407865">)</span><br>
<span class="lineno"></span><span class="op" id="3407867">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3407870">func</span>&nbsp;<span class="op" id="3407875">(</span><span class="ident" id="3407876">cw</span>&nbsp;<span class="op" id="3407879">*</span><span class="ident" id="3407880"><a href="/net/http/server.go.html#3406622">chunkWriter</a></span><span class="op" id="3407891">)</span>&nbsp;<span class="builtinfunc" id="3407893">close</span><span class="op" id="3407898">(</span><span class="op" id="3407899">)</span>&nbsp;<span class="op" id="3407901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407904">if</span>&nbsp;<span class="op" id="3407907">!</span><span class="ident" id="3407908"><a href="/net/http/server.go.html#3407876">cw</a></span><span class="op" id="3407910">.</span><span class="ident" id="3407911">wroteHeader</span>&nbsp;<span class="op" id="3407923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407927"><a href="/net/http/server.go.html#3407876">cw</a></span><span class="op" id="3407929">.</span><span class="ident" id="3407930">writeHeader</span><span class="op" id="3407941">(</span><span class="ident" id="3407942">nil</span><span class="op" id="3407945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407948">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407951">if</span>&nbsp;<span class="ident" id="3407954"><a href="/net/http/server.go.html#3407876">cw</a></span><span class="op" id="3407956">.</span><span class="ident" id="3407957">chunking</span>&nbsp;<span class="op" id="3407966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3407970">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3408026">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3408080">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408091"><a href="/net/http/server.go.html#3407876">cw</a></span><span class="op" id="3408093">.</span><span class="ident" id="3408094">res</span><span class="op" id="3408097">.</span><span class="ident" id="3408098">conn</span><span class="op" id="3408102">.</span><span class="ident" id="3408103">buf</span><span class="op" id="3408106">.</span><span class="ident" id="3408107">WriteString</span><span class="op" id="3408118">(</span><span class="string" id="3408119">&#34;0\r\n\r\n&#34;</span><span class="op" id="3408130">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3408133">}</span><br>
<span class="lineno"></span><span class="op" id="3408135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3408138">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3408200">type</span>&nbsp;<span class="ident" id="3408205">response</span>&nbsp;<span class="keyword" id="3408214">struct</span>&nbsp;<span class="op" id="3408221">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408224">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3408238">*</span><span class="ident" id="3408239"><a href="/net/http/server.go.html#3403324">conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408245">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3408259">*</span><span class="ident" id="3408260"><a href="/net/http/request.go.html#3366486">Request</a></span>&nbsp;<span class="comment" id="3408268">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408298">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3408312">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408321">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408367">wroteContinue</span>&nbsp;<span class="builtintype" id="3408381">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408390">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408429">w</span>&nbsp;&nbsp;<span class="op" id="3408432">*</span><span class="ident" id="3408433"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3408438">.</span><span class="ident" id="3408439">Writer</span>&nbsp;<span class="comment" id="3408446">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408490">cw</span>&nbsp;<span class="ident" id="3408493"><a href="/net/http/server.go.html#3406622">chunkWriter</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408506">sw</span>&nbsp;<span class="op" id="3408509">*</span><span class="ident" id="3408510"><a href="/net/http/server.go.html#3405672">switchWriter</a></span>&nbsp;<span class="comment" id="3408523">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3408578">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3408639">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3408701">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3408759">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408803">handlerHeader</span>&nbsp;<span class="ident" id="3408817"><a href="/net/http/header.go.html#3356649">Header</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408825">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3408839">bool</span>&nbsp;<span class="comment" id="3408844">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408891">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408905">int64</span>&nbsp;<span class="comment" id="3408911">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408947">contentLength</span>&nbsp;<span class="ident" id="3408961">int64</span>&nbsp;<span class="comment" id="3408967">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409013">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3409027">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3409033">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409072">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409131">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409184">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409235">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409255">closeAfterReply</span>&nbsp;<span class="builtintype" id="3409271">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409278">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409333">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409388">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409439">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409501">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409557">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409617">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409636">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3409656">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409663">handlerDone</span>&nbsp;<span class="builtintype" id="3409675">bool</span>&nbsp;<span class="comment" id="3409680">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3409717">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409757">dateBuf</span>&nbsp;<span class="op" id="3409765">[</span><span class="builtinfunc" id="3409766">len</span><span class="op" id="3409769">(</span><span class="ident" id="3409770"><a href="/net/http/server.go.html#3414785">TimeFormat</a></span><span class="op" id="3409780">)</span><span class="op" id="3409781">]</span><span class="builtintype" id="3409782">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409788">clenBuf</span>&nbsp;<span class="op" id="3409796">[</span><span class="num" id="3409797">10</span><span class="op" id="3409799">]</span><span class="builtintype" id="3409800">byte</span><br>
<span class="lineno">340</span><span class="op" id="3409805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3409808">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3409879">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3409909">func</span>&nbsp;<span class="op" id="3409914">(</span><span class="ident" id="3409915">w</span>&nbsp;<span class="op" id="3409917">*</span><span class="ident" id="3409918"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3409926">)</span>&nbsp;<span class="ident" id="3409928">requestTooLarge</span><span class="op" id="3409943">(</span><span class="op" id="3409944">)</span>&nbsp;<span class="op" id="3409946">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409949"><a href="/net/http/server.go.html#3409915">w</a></span><span class="op" id="3409950">.</span><span class="ident" id="3409951">closeAfterReply</span>&nbsp;<span class="op" id="3409967">=</span>&nbsp;<span class="builtintype" id="3409969">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3409975"><a href="/net/http/server.go.html#3409915">w</a></span><span class="op" id="3409976">.</span><span class="ident" id="3409977">requestBodyLimitHit</span>&nbsp;<span class="op" id="3409997">=</span>&nbsp;<span class="builtintype" id="3409999">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410005">if</span>&nbsp;<span class="op" id="3410008">!</span><span class="ident" id="3410009"><a href="/net/http/server.go.html#3409915">w</a></span><span class="op" id="3410010">.</span><span class="ident" id="3410011">wroteHeader</span>&nbsp;<span class="op" id="3410023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3410027"><a href="/net/http/server.go.html#3409915">w</a></span><span class="op" id="3410028">.</span><span class="ident" id="3410029">Header</span><span class="op" id="3410035">(</span><span class="op" id="3410036">)</span><span class="op" id="3410037">.</span><span class="ident" id="3410038">Set</span><span class="op" id="3410041">(</span><span class="string" id="3410042">&#34;Connection&#34;</span><span class="op" id="3410054">,</span>&nbsp;<span class="string" id="3410056">&#34;close&#34;</span><span class="op" id="3410063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3410066">}</span><br>
<span class="lineno">350</span><span class="op" id="3410068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410071">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3410143">func</span>&nbsp;<span class="op" id="3410148">(</span><span class="ident" id="3410149">w</span>&nbsp;<span class="op" id="3410151">*</span><span class="ident" id="3410152"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3410160">)</span>&nbsp;<span class="ident" id="3410162">needsSniff</span><span class="op" id="3410172">(</span><span class="op" id="3410173">)</span>&nbsp;<span class="builtintype" id="3410175">bool</span>&nbsp;<span class="op" id="3410180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3410183">_</span><span class="op" id="3410184">,</span>&nbsp;<span class="ident" id="3410186">haveType</span>&nbsp;<span class="op" id="3410195">:=</span>&nbsp;<span class="ident" id="3410198"><a href="/net/http/server.go.html#3410149">w</a></span><span class="op" id="3410199">.</span><span class="ident" id="3410200">handlerHeader</span><span class="op" id="3410213">[</span><span class="string" id="3410214">&#34;Content-Type&#34;</span><span class="op" id="3410228">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410231">return</span>&nbsp;<span class="op" id="3410238">!</span><span class="ident" id="3410239"><a href="/net/http/server.go.html#3410149">w</a></span><span class="op" id="3410240">.</span><span class="ident" id="3410241">cw</span><span class="op" id="3410243">.</span><span class="ident" id="3410244">wroteHeader</span>&nbsp;<span class="op" id="3410256">&amp;&amp;</span>&nbsp;<span class="op" id="3410259">!</span><span class="ident" id="3410260"><a href="/net/http/server.go.html#3410186">haveType</a></span>&nbsp;<span class="op" id="3410269">&amp;&amp;</span>&nbsp;<span class="ident" id="3410272"><a href="/net/http/server.go.html#3410149">w</a></span><span class="op" id="3410273">.</span><span class="ident" id="3410274">written</span>&nbsp;<span class="op" id="3410282">&lt;</span>&nbsp;<span class="ident" id="3410284"><a href="/net/http/sniff.go.html#3461444">sniffLen</a></span><br>
<span class="lineno"></span><span class="op" id="3410293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410296">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3410362">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3410379">type</span>&nbsp;<span class="ident" id="3410384">writerOnly</span>&nbsp;<span class="keyword" id="3410395">struct</span>&nbsp;<span class="op" id="3410402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3410405"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3410407">.</span><span class="ident" id="3410408">Writer</span><br>
<span class="lineno"></span><span class="op" id="3410415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3410418">func</span>&nbsp;<span class="ident" id="3410423">srcIsRegularFile</span><span class="op" id="3410439">(</span><span class="ident" id="3410440">src</span>&nbsp;<span class="ident" id="3410444"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3410446">.</span><span class="ident" id="3410447">Reader</span><span class="op" id="3410453">)</span>&nbsp;<span class="op" id="3410455">(</span><span class="ident" id="3410456">isRegular</span>&nbsp;<span class="builtintype" id="3410466">bool</span><span class="op" id="3410470">,</span>&nbsp;<span class="ident" id="3410472">err</span>&nbsp;<span class="builtintype" id="3410476">error</span><span class="op" id="3410481">)</span>&nbsp;<span class="op" id="3410483">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410486">switch</span>&nbsp;<span class="ident" id="3410493">v</span>&nbsp;<span class="op" id="3410495">:=</span>&nbsp;<span class="ident" id="3410498"><a href="/net/http/server.go.html#3410440">src</a></span><span class="op" id="3410501">.</span><span class="op" id="3410502">(</span><span class="keyword" id="3410503">type</span><span class="op" id="3410507">)</span>&nbsp;<span class="op" id="3410509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410512">case</span>&nbsp;<span class="op" id="3410517">*</span><span class="ident" id="3410518"><a href="/net/http/server.go.html#3399896">os</a></span><span class="op" id="3410520">.</span><span class="ident" id="3410521">File</span><span class="op" id="3410525">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3410529">fi</span><span class="op" id="3410531">,</span>&nbsp;<span class="ident" id="3410533">err</span>&nbsp;<span class="op" id="3410537">:=</span>&nbsp;<span class="ident" id="3410540"><a href="/net/http/server.go.html#3410493">v</a></span><span class="op" id="3410541">.</span><span class="ident" id="3410542">Stat</span><span class="op" id="3410546">(</span><span class="op" id="3410547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410551">if</span>&nbsp;<span class="ident" id="3410554"><a href="/net/http/server.go.html#3410533">err</a></span>&nbsp;<span class="op" id="3410558">!=</span>&nbsp;<span class="ident" id="3410561">nil</span>&nbsp;<span class="op" id="3410565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410570">return</span>&nbsp;<span class="builtintype" id="3410577">false</span><span class="op" id="3410582">,</span>&nbsp;<span class="ident" id="3410584"><a href="/net/http/server.go.html#3410533">err</a></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3410590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410594">return</span>&nbsp;<span class="ident" id="3410601"><a href="/net/http/server.go.html#3410529">fi</a></span><span class="op" id="3410603">.</span><span class="ident" id="3410604">Mode</span><span class="op" id="3410608">(</span><span class="op" id="3410609">)</span><span class="op" id="3410610">.</span><span class="ident" id="3410611">IsRegular</span><span class="op" id="3410620">(</span><span class="op" id="3410621">)</span><span class="op" id="3410622">,</span>&nbsp;<span class="ident" id="3410624">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410629">case</span>&nbsp;<span class="op" id="3410634">*</span><span class="ident" id="3410635"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3410637">.</span><span class="ident" id="3410638">LimitedReader</span><span class="op" id="3410651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410655">return</span>&nbsp;<span class="ident" id="3410662"><a href="/net/http/server.go.html#3410423">srcIsRegularFile</a></span><span class="op" id="3410678">(</span><span class="ident" id="3410679"><a href="/net/http/server.go.html#3410493">v</a></span><span class="op" id="3410680">.</span><span class="ident" id="3410681">R</span><span class="op" id="3410682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410685">default</span><span class="op" id="3410692">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3410696">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3410704">}</span><br>
<span class="lineno"></span><span class="op" id="3410706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410709">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3410779">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3410815">func</span>&nbsp;<span class="op" id="3410820">(</span><span class="ident" id="3410821">w</span>&nbsp;<span class="op" id="3410823">*</span><span class="ident" id="3410824"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3410832">)</span>&nbsp;<span class="ident" id="3410834">ReadFrom</span><span class="op" id="3410842">(</span><span class="ident" id="3410843">src</span>&nbsp;<span class="ident" id="3410847"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3410849">.</span><span class="ident" id="3410850">Reader</span><span class="op" id="3410856">)</span>&nbsp;<span class="op" id="3410858">(</span><span class="ident" id="3410859">n</span>&nbsp;<span class="ident" id="3410861">int64</span><span class="op" id="3410866">,</span>&nbsp;<span class="ident" id="3410868">err</span>&nbsp;<span class="builtintype" id="3410872">error</span><span class="op" id="3410877">)</span>&nbsp;<span class="op" id="3410879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3410882">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3410944">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3411008">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411060">rf</span><span class="op" id="3411062">,</span>&nbsp;<span class="ident" id="3411064">ok</span>&nbsp;<span class="op" id="3411067">:=</span>&nbsp;<span class="ident" id="3411070"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411071">.</span><span class="ident" id="3411072">conn</span><span class="op" id="3411076">.</span><span class="ident" id="3411077">rwc</span><span class="op" id="3411080">.</span><span class="op" id="3411081">(</span><span class="ident" id="3411082"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3411084">.</span><span class="ident" id="3411085">ReaderFrom</span><span class="op" id="3411095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411098">regFile</span><span class="op" id="3411105">,</span>&nbsp;<span class="ident" id="3411107"><a href="/net/http/server.go.html#3410868">err</a></span>&nbsp;<span class="op" id="3411111">:=</span>&nbsp;<span class="ident" id="3411114"><a href="/net/http/server.go.html#3410423">srcIsRegularFile</a></span><span class="op" id="3411130">(</span><span class="ident" id="3411131"><a href="/net/http/server.go.html#3410843">src</a></span><span class="op" id="3411134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411137">if</span>&nbsp;<span class="ident" id="3411140"><a href="/net/http/server.go.html#3410868">err</a></span>&nbsp;<span class="op" id="3411144">!=</span>&nbsp;<span class="ident" id="3411147">nil</span>&nbsp;<span class="op" id="3411151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411155">return</span>&nbsp;<span class="num" id="3411162">0</span><span class="op" id="3411163">,</span>&nbsp;<span class="ident" id="3411165"><a href="/net/http/server.go.html#3410868">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3411170">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411173">if</span>&nbsp;<span class="op" id="3411176">!</span><span class="ident" id="3411177"><a href="/net/http/server.go.html#3411064">ok</a></span>&nbsp;<span class="op" id="3411180">||</span>&nbsp;<span class="op" id="3411183">!</span><span class="ident" id="3411184"><a href="/net/http/server.go.html#3411098">regFile</a></span>&nbsp;<span class="op" id="3411192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411196">return</span>&nbsp;<span class="ident" id="3411203"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3411205">.</span><span class="ident" id="3411206">Copy</span><span class="op" id="3411210">(</span><span class="ident" id="3411211"><a href="/net/http/server.go.html#3410384">writerOnly</a></span><span class="op" id="3411221">{</span><span class="ident" id="3411222"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411223">}</span><span class="op" id="3411224">,</span>&nbsp;<span class="ident" id="3411226"><a href="/net/http/server.go.html#3410843">src</a></span><span class="op" id="3411229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3411232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3411236">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411256">if</span>&nbsp;<span class="op" id="3411259">!</span><span class="ident" id="3411260"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411261">.</span><span class="ident" id="3411262">wroteHeader</span>&nbsp;<span class="op" id="3411274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411278"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411279">.</span><span class="ident" id="3411280">WriteHeader</span><span class="op" id="3411291">(</span><span class="ident" id="3411292"><a href="/net/http/status.go.html#3466742">StatusOK</a></span><span class="op" id="3411300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3411303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411307">if</span>&nbsp;<span class="ident" id="3411310"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411311">.</span><span class="ident" id="3411312">needsSniff</span><span class="op" id="3411322">(</span><span class="op" id="3411323">)</span>&nbsp;<span class="op" id="3411325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411329">n0</span><span class="op" id="3411331">,</span>&nbsp;<span class="ident" id="3411333">err</span>&nbsp;<span class="op" id="3411337">:=</span>&nbsp;<span class="ident" id="3411340"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3411342">.</span><span class="ident" id="3411343">Copy</span><span class="op" id="3411347">(</span><span class="ident" id="3411348"><a href="/net/http/server.go.html#3410384">writerOnly</a></span><span class="op" id="3411358">{</span><span class="ident" id="3411359"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411360">}</span><span class="op" id="3411361">,</span>&nbsp;<span class="ident" id="3411363"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3411365">.</span><span class="ident" id="3411366">LimitReader</span><span class="op" id="3411377">(</span><span class="ident" id="3411378"><a href="/net/http/server.go.html#3410843">src</a></span><span class="op" id="3411381">,</span>&nbsp;<span class="ident" id="3411383"><a href="/net/http/sniff.go.html#3461444">sniffLen</a></span><span class="op" id="3411391">)</span><span class="op" id="3411392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411396"><a href="/net/http/server.go.html#3410859">n</a></span>&nbsp;<span class="op" id="3411398">+=</span>&nbsp;<span class="ident" id="3411401"><a href="/net/http/server.go.html#3411329">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411406">if</span>&nbsp;<span class="ident" id="3411409"><a href="/net/http/server.go.html#3411333">err</a></span>&nbsp;<span class="op" id="3411413">!=</span>&nbsp;<span class="ident" id="3411416">nil</span>&nbsp;<span class="op" id="3411420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411425">return</span>&nbsp;<span class="ident" id="3411432"><a href="/net/http/server.go.html#3410859">n</a></span><span class="op" id="3411433">,</span>&nbsp;<span class="ident" id="3411435"><a href="/net/http/server.go.html#3411333">err</a></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3411441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3411444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411448"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411449">.</span><span class="ident" id="3411450">w</span><span class="op" id="3411451">.</span><span class="ident" id="3411452">Flush</span><span class="op" id="3411457">(</span><span class="op" id="3411458">)</span>&nbsp;&nbsp;<span class="comment" id="3411461">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411496"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411497">.</span><span class="ident" id="3411498">cw</span><span class="op" id="3411500">.</span><span class="ident" id="3411501">flush</span><span class="op" id="3411506">(</span><span class="op" id="3411507">)</span>&nbsp;<span class="comment" id="3411509">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3411561">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411641">if</span>&nbsp;<span class="op" id="3411644">!</span><span class="ident" id="3411645"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411646">.</span><span class="ident" id="3411647">cw</span><span class="op" id="3411649">.</span><span class="ident" id="3411650">chunking</span>&nbsp;<span class="op" id="3411659">&amp;&amp;</span>&nbsp;<span class="ident" id="3411662"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411663">.</span><span class="ident" id="3411664">bodyAllowed</span><span class="op" id="3411675">(</span><span class="op" id="3411676">)</span>&nbsp;<span class="op" id="3411678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411682">n0</span><span class="op" id="3411684">,</span>&nbsp;<span class="ident" id="3411686">err</span>&nbsp;<span class="op" id="3411690">:=</span>&nbsp;<span class="ident" id="3411693"><a href="/net/http/server.go.html#3411060">rf</a></span><span class="op" id="3411695">.</span><span class="ident" id="3411696">ReadFrom</span><span class="op" id="3411704">(</span><span class="ident" id="3411705"><a href="/net/http/server.go.html#3410843">src</a></span><span class="op" id="3411708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411712"><a href="/net/http/server.go.html#3410859">n</a></span>&nbsp;<span class="op" id="3411714">+=</span>&nbsp;<span class="ident" id="3411717"><a href="/net/http/server.go.html#3411682">n0</a></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411722"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411723">.</span><span class="ident" id="3411724">written</span>&nbsp;<span class="op" id="3411732">+=</span>&nbsp;<span class="ident" id="3411735"><a href="/net/http/server.go.html#3411682">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411740">return</span>&nbsp;<span class="ident" id="3411747"><a href="/net/http/server.go.html#3410859">n</a></span><span class="op" id="3411748">,</span>&nbsp;<span class="ident" id="3411750"><a href="/net/http/server.go.html#3411686">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3411755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411759">n0</span><span class="op" id="3411761">,</span>&nbsp;<span class="ident" id="3411763"><a href="/net/http/server.go.html#3410868">err</a></span>&nbsp;<span class="op" id="3411767">:=</span>&nbsp;<span class="ident" id="3411770"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3411772">.</span><span class="ident" id="3411773">Copy</span><span class="op" id="3411777">(</span><span class="ident" id="3411778"><a href="/net/http/server.go.html#3410384">writerOnly</a></span><span class="op" id="3411788">{</span><span class="ident" id="3411789"><a href="/net/http/server.go.html#3410821">w</a></span><span class="op" id="3411790">}</span><span class="op" id="3411791">,</span>&nbsp;<span class="ident" id="3411793"><a href="/net/http/server.go.html#3410843">src</a></span><span class="op" id="3411796">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3411799"><a href="/net/http/server.go.html#3410859">n</a></span>&nbsp;<span class="op" id="3411801">+=</span>&nbsp;<span class="ident" id="3411804"><a href="/net/http/server.go.html#3411759">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3411808">return</span>&nbsp;<span class="ident" id="3411815"><a href="/net/http/server.go.html#3410859">n</a></span><span class="op" id="3411816">,</span>&nbsp;<span class="ident" id="3411818"><a href="/net/http/server.go.html#3410868">err</a></span><br>
<span class="lineno"></span><span class="op" id="3411822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3411825">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3411894">const</span>&nbsp;<span class="ident" id="3411900">noLimit</span>&nbsp;<span class="ident" id="3411908">int64</span>&nbsp;<span class="op" id="3411914">=</span>&nbsp;<span class="op" id="3411916">(</span><span class="num" id="3411917">1</span>&nbsp;<span class="op" id="3411919">&lt;&lt;</span>&nbsp;<span class="num" id="3411922">63</span><span class="op" id="3411924">)</span>&nbsp;<span class="op" id="3411926">-</span>&nbsp;<span class="num" id="3411928">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3411931">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3412009">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3412044">const</span>&nbsp;<span class="ident" id="3412050">debugServerConnections</span>&nbsp;<span class="op" id="3412073">=</span>&nbsp;<span class="builtintype" id="3412075">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3412082">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3412117">func</span>&nbsp;<span class="op" id="3412122">(</span><span class="ident" id="3412123">srv</span>&nbsp;<span class="op" id="3412127">*</span><span class="ident" id="3412128"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3412134">)</span>&nbsp;<span class="ident" id="3412136">newConn</span><span class="op" id="3412143">(</span><span class="ident" id="3412144">rwc</span>&nbsp;<span class="ident" id="3412148"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3412151">.</span><span class="ident" id="3412152">Conn</span><span class="op" id="3412156">)</span>&nbsp;<span class="op" id="3412158">(</span><span class="ident" id="3412159">c</span>&nbsp;<span class="op" id="3412161">*</span><span class="ident" id="3412162"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3412166">,</span>&nbsp;<span class="ident" id="3412168">err</span>&nbsp;<span class="builtintype" id="3412172">error</span><span class="op" id="3412177">)</span>&nbsp;<span class="op" id="3412179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412182"><a href="/net/http/server.go.html#3412159">c</a></span>&nbsp;<span class="op" id="3412184">=</span>&nbsp;<span class="builtinfunc" id="3412186">new</span><span class="op" id="3412189">(</span><span class="ident" id="3412190"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3412194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412197"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412198">.</span><span class="ident" id="3412199">remoteAddr</span>&nbsp;<span class="op" id="3412210">=</span>&nbsp;<span class="ident" id="3412212"><a href="/net/http/server.go.html#3412144">rwc</a></span><span class="op" id="3412215">.</span><span class="ident" id="3412216">RemoteAddr</span><span class="op" id="3412226">(</span><span class="op" id="3412227">)</span><span class="op" id="3412228">.</span><span class="ident" id="3412229">String</span><span class="op" id="3412235">(</span><span class="op" id="3412236">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412239"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412240">.</span><span class="ident" id="3412241">server</span>&nbsp;<span class="op" id="3412248">=</span>&nbsp;<span class="ident" id="3412250"><a href="/net/http/server.go.html#3412123">srv</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412255"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412256">.</span><span class="ident" id="3412257">rwc</span>&nbsp;<span class="op" id="3412261">=</span>&nbsp;<span class="ident" id="3412263"><a href="/net/http/server.go.html#3412144">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412268"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412269">.</span><span class="ident" id="3412270">w</span>&nbsp;<span class="op" id="3412272">=</span>&nbsp;<span class="ident" id="3412274"><a href="/net/http/server.go.html#3412144">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412279">if</span>&nbsp;<span class="ident" id="3412282"><a href="/net/http/server.go.html#3412050">debugServerConnections</a></span>&nbsp;<span class="op" id="3412305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412309"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412310">.</span><span class="ident" id="3412311">rwc</span>&nbsp;<span class="op" id="3412315">=</span>&nbsp;<span class="ident" id="3412317"><a href="/net/http/server.go.html#3459884">newLoggingConn</a></span><span class="op" id="3412331">(</span><span class="string" id="3412332">&#34;server&#34;</span><span class="op" id="3412340">,</span>&nbsp;<span class="ident" id="3412342"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412343">.</span><span class="ident" id="3412344">rwc</span><span class="op" id="3412347">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3412350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412353"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412354">.</span><span class="ident" id="3412355">sr</span>&nbsp;<span class="op" id="3412358">=</span>&nbsp;<span class="ident" id="3412360"><a href="/net/http/server.go.html#3405825">liveSwitchReader</a></span><span class="op" id="3412376">{</span><span class="ident" id="3412377">r</span><span class="op" id="3412378">:</span>&nbsp;<span class="ident" id="3412380"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412381">.</span><span class="ident" id="3412382">rwc</span><span class="op" id="3412385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412388"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412389">.</span><span class="ident" id="3412390">lr</span>&nbsp;<span class="op" id="3412393">=</span>&nbsp;<span class="ident" id="3412395"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3412397">.</span><span class="ident" id="3412398">LimitReader</span><span class="op" id="3412409">(</span><span class="op" id="3412410">&amp;</span><span class="ident" id="3412411"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412412">.</span><span class="ident" id="3412413">sr</span><span class="op" id="3412415">,</span>&nbsp;<span class="ident" id="3412417"><a href="/net/http/server.go.html#3411900">noLimit</a></span><span class="op" id="3412424">)</span><span class="op" id="3412425">.</span><span class="op" id="3412426">(</span><span class="op" id="3412427">*</span><span class="ident" id="3412428"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3412430">.</span><span class="ident" id="3412431">LimitedReader</span><span class="op" id="3412444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412447">br</span>&nbsp;<span class="op" id="3412450">:=</span>&nbsp;<span class="ident" id="3412453"><a href="/net/http/server.go.html#3412851">newBufioReader</a></span><span class="op" id="3412467">(</span><span class="ident" id="3412468"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412469">.</span><span class="ident" id="3412470">lr</span><span class="op" id="3412472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412475">bw</span>&nbsp;<span class="op" id="3412478">:=</span>&nbsp;<span class="ident" id="3412481"><a href="/net/http/server.go.html#3413111">newBufioWriterSize</a></span><span class="op" id="3412499">(</span><span class="ident" id="3412500"><a href="/net/http/server.go.html#3460898">checkConnErrorWriter</a></span><span class="op" id="3412520">{</span><span class="ident" id="3412521"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412522">}</span><span class="op" id="3412523">,</span>&nbsp;<span class="num" id="3412525">4</span><span class="op" id="3412526">&lt;&lt;</span><span class="num" id="3412528">10</span><span class="op" id="3412530">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412533"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412534">.</span><span class="ident" id="3412535">buf</span>&nbsp;<span class="op" id="3412539">=</span>&nbsp;<span class="ident" id="3412541"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3412546">.</span><span class="ident" id="3412547">NewReadWriter</span><span class="op" id="3412560">(</span><span class="ident" id="3412561"><a href="/net/http/server.go.html#3412447">br</a></span><span class="op" id="3412563">,</span>&nbsp;<span class="ident" id="3412565"><a href="/net/http/server.go.html#3412475">bw</a></span><span class="op" id="3412567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412570">return</span>&nbsp;<span class="ident" id="3412577"><a href="/net/http/server.go.html#3412159">c</a></span><span class="op" id="3412578">,</span>&nbsp;<span class="ident" id="3412580">nil</span><br>
<span class="lineno"></span><span class="op" id="3412584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3412587">var</span>&nbsp;<span class="op" id="3412591">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412594">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3412612"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3412616">.</span><span class="ident" id="3412617">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412623">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3412641"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3412645">.</span><span class="ident" id="3412646">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412652">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3412670"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3412674">.</span><span class="ident" id="3412675">Pool</span><br>
<span class="lineno"></span><span class="op" id="3412680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3412683">func</span>&nbsp;<span class="ident" id="3412688">bufioWriterPool</span><span class="op" id="3412703">(</span><span class="ident" id="3412704">size</span>&nbsp;<span class="builtintype" id="3412709">int</span><span class="op" id="3412712">)</span>&nbsp;<span class="op" id="3412714">*</span><span class="ident" id="3412715"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3412719">.</span><span class="ident" id="3412720">Pool</span>&nbsp;<span class="op" id="3412725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412728">switch</span>&nbsp;<span class="ident" id="3412735"><a href="/net/http/server.go.html#3412704">size</a></span>&nbsp;<span class="op" id="3412740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412743">case</span>&nbsp;<span class="num" id="3412748">2</span>&nbsp;<span class="op" id="3412750">&lt;&lt;</span>&nbsp;<span class="num" id="3412753">10</span><span class="op" id="3412755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412759">return</span>&nbsp;<span class="op" id="3412766">&amp;</span><span class="ident" id="3412767"><a href="/net/http/server.go.html#3412623">bufioWriter2kPool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412786">case</span>&nbsp;<span class="num" id="3412791">4</span>&nbsp;<span class="op" id="3412793">&lt;&lt;</span>&nbsp;<span class="num" id="3412796">10</span><span class="op" id="3412798">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412802">return</span>&nbsp;<span class="op" id="3412809">&amp;</span><span class="ident" id="3412810"><a href="/net/http/server.go.html#3412652">bufioWriter4kPool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3412829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412832">return</span>&nbsp;<span class="ident" id="3412839">nil</span><br>
<span class="lineno"></span><span class="op" id="3412843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3412846">func</span>&nbsp;<span class="ident" id="3412851">newBufioReader</span><span class="op" id="3412865">(</span><span class="ident" id="3412866">r</span>&nbsp;<span class="ident" id="3412868"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3412870">.</span><span class="ident" id="3412871">Reader</span><span class="op" id="3412877">)</span>&nbsp;<span class="op" id="3412879">*</span><span class="ident" id="3412880"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3412885">.</span><span class="ident" id="3412886">Reader</span>&nbsp;<span class="op" id="3412893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412896">if</span>&nbsp;<span class="ident" id="3412899">v</span>&nbsp;<span class="op" id="3412901">:=</span>&nbsp;<span class="ident" id="3412904"><a href="/net/http/server.go.html#3412594">bufioReaderPool</a></span><span class="op" id="3412919">.</span><span class="ident" id="3412920">Get</span><span class="op" id="3412923">(</span><span class="op" id="3412924">)</span><span class="op" id="3412925">;</span>&nbsp;<span class="ident" id="3412927"><a href="/net/http/server.go.html#3412899">v</a></span>&nbsp;<span class="op" id="3412929">!=</span>&nbsp;<span class="ident" id="3412932">nil</span>&nbsp;<span class="op" id="3412936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412940">br</span>&nbsp;<span class="op" id="3412943">:=</span>&nbsp;<span class="ident" id="3412946"><a href="/net/http/server.go.html#3412899">v</a></span><span class="op" id="3412947">.</span><span class="op" id="3412948">(</span><span class="op" id="3412949">*</span><span class="ident" id="3412950"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3412955">.</span><span class="ident" id="3412956">Reader</span><span class="op" id="3412962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3412966"><a href="/net/http/server.go.html#3412940">br</a></span><span class="op" id="3412968">.</span><span class="ident" id="3412969">Reset</span><span class="op" id="3412974">(</span><span class="ident" id="3412975"><a href="/net/http/server.go.html#3412866">r</a></span><span class="op" id="3412976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412980">return</span>&nbsp;<span class="ident" id="3412987"><a href="/net/http/server.go.html#3412940">br</a></span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3412991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3412994">return</span>&nbsp;<span class="ident" id="3413001"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3413006">.</span><span class="ident" id="3413007">NewReader</span><span class="op" id="3413016">(</span><span class="ident" id="3413017"><a href="/net/http/server.go.html#3412866">r</a></span><span class="op" id="3413018">)</span><br>
<span class="lineno"></span><span class="op" id="3413020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3413023">func</span>&nbsp;<span class="ident" id="3413028">putBufioReader</span><span class="op" id="3413042">(</span><span class="ident" id="3413043">br</span>&nbsp;<span class="op" id="3413046">*</span><span class="ident" id="3413047"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3413052">.</span><span class="ident" id="3413053">Reader</span><span class="op" id="3413059">)</span>&nbsp;<span class="op" id="3413061">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413064"><a href="/net/http/server.go.html#3413043">br</a></span><span class="op" id="3413066">.</span><span class="ident" id="3413067">Reset</span><span class="op" id="3413072">(</span><span class="ident" id="3413073">nil</span><span class="op" id="3413076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413079"><a href="/net/http/server.go.html#3412594">bufioReaderPool</a></span><span class="op" id="3413094">.</span><span class="ident" id="3413095">Put</span><span class="op" id="3413098">(</span><span class="ident" id="3413099"><a href="/net/http/server.go.html#3413043">br</a></span><span class="op" id="3413101">)</span><br>
<span class="lineno"></span><span class="op" id="3413103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3413106">func</span>&nbsp;<span class="ident" id="3413111">newBufioWriterSize</span><span class="op" id="3413129">(</span><span class="ident" id="3413130">w</span>&nbsp;<span class="ident" id="3413132"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3413134">.</span><span class="ident" id="3413135">Writer</span><span class="op" id="3413141">,</span>&nbsp;<span class="ident" id="3413143">size</span>&nbsp;<span class="builtintype" id="3413148">int</span><span class="op" id="3413151">)</span>&nbsp;<span class="op" id="3413153">*</span><span class="ident" id="3413154"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3413159">.</span><span class="ident" id="3413160">Writer</span>&nbsp;<span class="op" id="3413167">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413170">pool</span>&nbsp;<span class="op" id="3413175">:=</span>&nbsp;<span class="ident" id="3413178"><a href="/net/http/server.go.html#3412688">bufioWriterPool</a></span><span class="op" id="3413193">(</span><span class="ident" id="3413194"><a href="/net/http/server.go.html#3413143">size</a></span><span class="op" id="3413198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413201">if</span>&nbsp;<span class="ident" id="3413204"><a href="/net/http/server.go.html#3413170">pool</a></span>&nbsp;<span class="op" id="3413209">!=</span>&nbsp;<span class="ident" id="3413212">nil</span>&nbsp;<span class="op" id="3413216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413220">if</span>&nbsp;<span class="ident" id="3413223">v</span>&nbsp;<span class="op" id="3413225">:=</span>&nbsp;<span class="ident" id="3413228"><a href="/net/http/server.go.html#3413170">pool</a></span><span class="op" id="3413232">.</span><span class="ident" id="3413233">Get</span><span class="op" id="3413236">(</span><span class="op" id="3413237">)</span><span class="op" id="3413238">;</span>&nbsp;<span class="ident" id="3413240"><a href="/net/http/server.go.html#3413223">v</a></span>&nbsp;<span class="op" id="3413242">!=</span>&nbsp;<span class="ident" id="3413245">nil</span>&nbsp;<span class="op" id="3413249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413254">bw</span>&nbsp;<span class="op" id="3413257">:=</span>&nbsp;<span class="ident" id="3413260"><a href="/net/http/server.go.html#3413223">v</a></span><span class="op" id="3413261">.</span><span class="op" id="3413262">(</span><span class="op" id="3413263">*</span><span class="ident" id="3413264"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3413269">.</span><span class="ident" id="3413270">Writer</span><span class="op" id="3413276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413281"><a href="/net/http/server.go.html#3413254">bw</a></span><span class="op" id="3413283">.</span><span class="ident" id="3413284">Reset</span><span class="op" id="3413289">(</span><span class="ident" id="3413290"><a href="/net/http/server.go.html#3413130">w</a></span><span class="op" id="3413291">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413296">return</span>&nbsp;<span class="ident" id="3413303"><a href="/net/http/server.go.html#3413254">bw</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3413308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3413311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413314">return</span>&nbsp;<span class="ident" id="3413321"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3413326">.</span><span class="ident" id="3413327">NewWriterSize</span><span class="op" id="3413340">(</span><span class="ident" id="3413341"><a href="/net/http/server.go.html#3413130">w</a></span><span class="op" id="3413342">,</span>&nbsp;<span class="ident" id="3413344"><a href="/net/http/server.go.html#3413143">size</a></span><span class="op" id="3413348">)</span><br>
<span class="lineno"></span><span class="op" id="3413350">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3413353">func</span>&nbsp;<span class="ident" id="3413358">putBufioWriter</span><span class="op" id="3413372">(</span><span class="ident" id="3413373">bw</span>&nbsp;<span class="op" id="3413376">*</span><span class="ident" id="3413377"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3413382">.</span><span class="ident" id="3413383">Writer</span><span class="op" id="3413389">)</span>&nbsp;<span class="op" id="3413391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413394"><a href="/net/http/server.go.html#3413373">bw</a></span><span class="op" id="3413396">.</span><span class="ident" id="3413397">Reset</span><span class="op" id="3413402">(</span><span class="ident" id="3413403">nil</span><span class="op" id="3413406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413409">if</span>&nbsp;<span class="ident" id="3413412">pool</span>&nbsp;<span class="op" id="3413417">:=</span>&nbsp;<span class="ident" id="3413420"><a href="/net/http/server.go.html#3412688">bufioWriterPool</a></span><span class="op" id="3413435">(</span><span class="ident" id="3413436"><a href="/net/http/server.go.html#3413373">bw</a></span><span class="op" id="3413438">.</span><span class="ident" id="3413439">Available</span><span class="op" id="3413448">(</span><span class="op" id="3413449">)</span><span class="op" id="3413450">)</span><span class="op" id="3413451">;</span>&nbsp;<span class="ident" id="3413453"><a href="/net/http/server.go.html#3413412">pool</a></span>&nbsp;<span class="op" id="3413458">!=</span>&nbsp;<span class="ident" id="3413461">nil</span>&nbsp;<span class="op" id="3413465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3413469"><a href="/net/http/server.go.html#3413412">pool</a></span><span class="op" id="3413473">.</span><span class="ident" id="3413474">Put</span><span class="op" id="3413477">(</span><span class="ident" id="3413478"><a href="/net/http/server.go.html#3413373">bw</a></span><span class="op" id="3413480">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3413483">}</span><br>
<span class="lineno"></span><span class="op" id="3413485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3413488">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3413558">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3413581">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3413641">const</span>&nbsp;<span class="ident" id="3413647">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3413669">=</span>&nbsp;<span class="num" id="3413671">1</span>&nbsp;<span class="op" id="3413673">&lt;&lt;</span>&nbsp;<span class="num" id="3413676">20</span>&nbsp;<span class="comment" id="3413679">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3413688">func</span>&nbsp;<span class="op" id="3413693">(</span><span class="ident" id="3413694">srv</span>&nbsp;<span class="op" id="3413698">*</span><span class="ident" id="3413699"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3413705">)</span>&nbsp;<span class="ident" id="3413707">maxHeaderBytes</span><span class="op" id="3413721">(</span><span class="op" id="3413722">)</span>&nbsp;<span class="builtintype" id="3413724">int</span>&nbsp;<span class="op" id="3413728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413731">if</span>&nbsp;<span class="ident" id="3413734"><a href="/net/http/server.go.html#3413694">srv</a></span><span class="op" id="3413737">.</span><span class="ident" id="3413738">MaxHeaderBytes</span>&nbsp;<span class="op" id="3413753">&gt;</span>&nbsp;<span class="num" id="3413755">0</span>&nbsp;<span class="op" id="3413757">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413761">return</span>&nbsp;<span class="ident" id="3413768"><a href="/net/http/server.go.html#3413694">srv</a></span><span class="op" id="3413771">.</span><span class="ident" id="3413772">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3413788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413791">return</span>&nbsp;<span class="ident" id="3413798"><a href="/net/http/server.go.html#3413647">DefaultMaxHeaderBytes</a></span><br>
<span class="lineno"></span><span class="op" id="3413820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3413823">func</span>&nbsp;<span class="op" id="3413828">(</span><span class="ident" id="3413829">srv</span>&nbsp;<span class="op" id="3413833">*</span><span class="ident" id="3413834"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3413840">)</span>&nbsp;<span class="ident" id="3413842">initialLimitedReaderSize</span><span class="op" id="3413866">(</span><span class="op" id="3413867">)</span>&nbsp;<span class="ident" id="3413869">int64</span>&nbsp;<span class="op" id="3413875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3413878">return</span>&nbsp;<span class="ident" id="3413885">int64</span><span class="op" id="3413890">(</span><span class="ident" id="3413891"><a href="/net/http/server.go.html#3413829">srv</a></span><span class="op" id="3413894">.</span><span class="ident" id="3413895">maxHeaderBytes</span><span class="op" id="3413909">(</span><span class="op" id="3413910">)</span><span class="op" id="3413911">)</span>&nbsp;<span class="op" id="3413913">+</span>&nbsp;<span class="num" id="3413915">4096</span>&nbsp;<span class="comment" id="3413920">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3413934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3413937">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3414001">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3414033">type</span>&nbsp;<span class="ident" id="3414038">expectContinueReader</span>&nbsp;<span class="keyword" id="3414059">struct</span>&nbsp;<span class="op" id="3414066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414069">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414080">*</span><span class="ident" id="3414081"><a href="/net/http/server.go.html#3408205">response</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414091">readCloser</span>&nbsp;<span class="ident" id="3414102"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3414104">.</span><span class="ident" id="3414105">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414117">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3414128">bool</span><br>
<span class="lineno">520</span><span class="op" id="3414133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3414136">func</span>&nbsp;<span class="op" id="3414141">(</span><span class="ident" id="3414142">ecr</span>&nbsp;<span class="op" id="3414146">*</span><span class="ident" id="3414147"><a href="/net/http/server.go.html#3414038">expectContinueReader</a></span><span class="op" id="3414167">)</span>&nbsp;<span class="ident" id="3414169">Read</span><span class="op" id="3414173">(</span><span class="ident" id="3414174">p</span>&nbsp;<span class="op" id="3414176">[</span><span class="op" id="3414177">]</span><span class="builtintype" id="3414178">byte</span><span class="op" id="3414182">)</span>&nbsp;<span class="op" id="3414184">(</span><span class="ident" id="3414185">n</span>&nbsp;<span class="builtintype" id="3414187">int</span><span class="op" id="3414190">,</span>&nbsp;<span class="ident" id="3414192">err</span>&nbsp;<span class="builtintype" id="3414196">error</span><span class="op" id="3414201">)</span>&nbsp;<span class="op" id="3414203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414206">if</span>&nbsp;<span class="ident" id="3414209"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414212">.</span><span class="ident" id="3414213">closed</span>&nbsp;<span class="op" id="3414220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414224">return</span>&nbsp;<span class="num" id="3414231">0</span><span class="op" id="3414232">,</span>&nbsp;<span class="ident" id="3414234"><a href="/net/http/transfer.go.html#3485954">ErrBodyReadAfterClose</a></span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3414257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414260">if</span>&nbsp;<span class="op" id="3414263">!</span><span class="ident" id="3414264"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414267">.</span><span class="ident" id="3414268">resp</span><span class="op" id="3414272">.</span><span class="ident" id="3414273">wroteContinue</span>&nbsp;<span class="op" id="3414287">&amp;&amp;</span>&nbsp;<span class="op" id="3414290">!</span><span class="ident" id="3414291"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414294">.</span><span class="ident" id="3414295">resp</span><span class="op" id="3414299">.</span><span class="ident" id="3414300">conn</span><span class="op" id="3414304">.</span><span class="ident" id="3414305">hijacked</span><span class="op" id="3414313">(</span><span class="op" id="3414314">)</span>&nbsp;<span class="op" id="3414316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414320"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414323">.</span><span class="ident" id="3414324">resp</span><span class="op" id="3414328">.</span><span class="ident" id="3414329">wroteContinue</span>&nbsp;<span class="op" id="3414343">=</span>&nbsp;<span class="builtintype" id="3414345">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414352"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414355">.</span><span class="ident" id="3414356">resp</span><span class="op" id="3414360">.</span><span class="ident" id="3414361">conn</span><span class="op" id="3414365">.</span><span class="ident" id="3414366">buf</span><span class="op" id="3414369">.</span><span class="ident" id="3414370">WriteString</span><span class="op" id="3414381">(</span><span class="string" id="3414382">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3414413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414417"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414420">.</span><span class="ident" id="3414421">resp</span><span class="op" id="3414425">.</span><span class="ident" id="3414426">conn</span><span class="op" id="3414430">.</span><span class="ident" id="3414431">buf</span><span class="op" id="3414434">.</span><span class="ident" id="3414435">Flush</span><span class="op" id="3414440">(</span><span class="op" id="3414441">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3414444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414447">return</span>&nbsp;<span class="ident" id="3414454"><a href="/net/http/server.go.html#3414142">ecr</a></span><span class="op" id="3414457">.</span><span class="ident" id="3414458">readCloser</span><span class="op" id="3414468">.</span><span class="ident" id="3414469">Read</span><span class="op" id="3414473">(</span><span class="ident" id="3414474"><a href="/net/http/server.go.html#3414174">p</a></span><span class="op" id="3414475">)</span><br>
<span class="lineno"></span><span class="op" id="3414477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3414480">func</span>&nbsp;<span class="op" id="3414485">(</span><span class="ident" id="3414486">ecr</span>&nbsp;<span class="op" id="3414490">*</span><span class="ident" id="3414491"><a href="/net/http/server.go.html#3414038">expectContinueReader</a></span><span class="op" id="3414511">)</span>&nbsp;<span class="ident" id="3414513">Close</span><span class="op" id="3414518">(</span><span class="op" id="3414519">)</span>&nbsp;<span class="builtintype" id="3414521">error</span>&nbsp;<span class="op" id="3414527">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3414530"><a href="/net/http/server.go.html#3414486">ecr</a></span><span class="op" id="3414533">.</span><span class="ident" id="3414534">closed</span>&nbsp;<span class="op" id="3414541">=</span>&nbsp;<span class="builtintype" id="3414543">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414549">return</span>&nbsp;<span class="ident" id="3414556"><a href="/net/http/server.go.html#3414486">ecr</a></span><span class="op" id="3414559">.</span><span class="ident" id="3414560">readCloser</span><span class="op" id="3414570">.</span><span class="ident" id="3414571">Close</span><span class="op" id="3414576">(</span><span class="op" id="3414577">)</span><br>
<span class="lineno"></span><span class="op" id="3414579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3414582">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3414627">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3414675">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3414715">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3414779">const</span>&nbsp;<span class="ident" id="3414785">TimeFormat</span>&nbsp;<span class="op" id="3414796">=</span>&nbsp;<span class="string" id="3414798">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3414831">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3414911">func</span>&nbsp;<span class="ident" id="3414916">appendTime</span><span class="op" id="3414926">(</span><span class="ident" id="3414927">b</span>&nbsp;<span class="op" id="3414929">[</span><span class="op" id="3414930">]</span><span class="builtintype" id="3414931">byte</span><span class="op" id="3414935">,</span>&nbsp;<span class="ident" id="3414937">t</span>&nbsp;<span class="ident" id="3414939"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3414943">.</span><span class="ident" id="3414944">Time</span><span class="op" id="3414948">)</span>&nbsp;<span class="op" id="3414950">[</span><span class="op" id="3414951">]</span><span class="builtintype" id="3414952">byte</span>&nbsp;<span class="op" id="3414957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414960">const</span>&nbsp;<span class="ident" id="3414966">days</span>&nbsp;<span class="op" id="3414971">=</span>&nbsp;<span class="string" id="3414973">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3414998">const</span>&nbsp;<span class="ident" id="3415004">months</span>&nbsp;<span class="op" id="3415011">=</span>&nbsp;<span class="string" id="3415013">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415054"><a href="/net/http/server.go.html#3414937">t</a></span>&nbsp;<span class="op" id="3415056">=</span>&nbsp;<span class="ident" id="3415058"><a href="/net/http/server.go.html#3414937">t</a></span><span class="op" id="3415059">.</span><span class="ident" id="3415060">UTC</span><span class="op" id="3415063">(</span><span class="op" id="3415064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415067">yy</span><span class="op" id="3415069">,</span>&nbsp;<span class="ident" id="3415071">mm</span><span class="op" id="3415073">,</span>&nbsp;<span class="ident" id="3415075">dd</span>&nbsp;<span class="op" id="3415078">:=</span>&nbsp;<span class="ident" id="3415081"><a href="/net/http/server.go.html#3414937">t</a></span><span class="op" id="3415082">.</span><span class="ident" id="3415083">Date</span><span class="op" id="3415087">(</span><span class="op" id="3415088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415091">hh</span><span class="op" id="3415093">,</span>&nbsp;<span class="ident" id="3415095">mn</span><span class="op" id="3415097">,</span>&nbsp;<span class="ident" id="3415099">ss</span>&nbsp;<span class="op" id="3415102">:=</span>&nbsp;<span class="ident" id="3415105"><a href="/net/http/server.go.html#3414937">t</a></span><span class="op" id="3415106">.</span><span class="ident" id="3415107">Clock</span><span class="op" id="3415112">(</span><span class="op" id="3415113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415116">day</span>&nbsp;<span class="op" id="3415120">:=</span>&nbsp;<span class="ident" id="3415123"><a href="/net/http/server.go.html#3414966">days</a></span><span class="op" id="3415127">[</span><span class="num" id="3415128">3</span><span class="op" id="3415129">*</span><span class="ident" id="3415130"><a href="/net/http/server.go.html#3414937">t</a></span><span class="op" id="3415131">.</span><span class="ident" id="3415132">Weekday</span><span class="op" id="3415139">(</span><span class="op" id="3415140">)</span><span class="op" id="3415141">:</span><span class="op" id="3415142">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415145">mon</span>&nbsp;<span class="op" id="3415149">:=</span>&nbsp;<span class="ident" id="3415152"><a href="/net/http/server.go.html#3415004">months</a></span><span class="op" id="3415158">[</span><span class="num" id="3415159">3</span><span class="op" id="3415160">*</span><span class="op" id="3415161">(</span><span class="ident" id="3415162"><a href="/net/http/server.go.html#3415071">mm</a></span><span class="op" id="3415164">-</span><span class="num" id="3415165">1</span><span class="op" id="3415166">)</span><span class="op" id="3415167">:</span><span class="op" id="3415168">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415172">return</span>&nbsp;<span class="builtinfunc" id="3415179">append</span><span class="op" id="3415185">(</span><span class="ident" id="3415186"><a href="/net/http/server.go.html#3414927">b</a></span><span class="op" id="3415187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415191"><a href="/net/http/server.go.html#3415116">day</a></span><span class="op" id="3415194">[</span><span class="num" id="3415195">0</span><span class="op" id="3415196">]</span><span class="op" id="3415197">,</span>&nbsp;<span class="ident" id="3415199"><a href="/net/http/server.go.html#3415116">day</a></span><span class="op" id="3415202">[</span><span class="num" id="3415203">1</span><span class="op" id="3415204">]</span><span class="op" id="3415205">,</span>&nbsp;<span class="ident" id="3415207"><a href="/net/http/server.go.html#3415116">day</a></span><span class="op" id="3415210">[</span><span class="num" id="3415211">2</span><span class="op" id="3415212">]</span><span class="op" id="3415213">,</span>&nbsp;<span class="string" id="3415215">&#39;,&#39;</span><span class="op" id="3415218">,</span>&nbsp;<span class="string" id="3415220">&#39;&nbsp;&#39;</span><span class="op" id="3415223">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3415227">byte</span><span class="op" id="3415231">(</span><span class="string" id="3415232">&#39;0&#39;</span><span class="op" id="3415235">+</span><span class="ident" id="3415236"><a href="/net/http/server.go.html#3415075">dd</a></span><span class="op" id="3415238">/</span><span class="num" id="3415239">10</span><span class="op" id="3415241">)</span><span class="op" id="3415242">,</span>&nbsp;<span class="builtintype" id="3415244">byte</span><span class="op" id="3415248">(</span><span class="string" id="3415249">&#39;0&#39;</span><span class="op" id="3415252">+</span><span class="ident" id="3415253"><a href="/net/http/server.go.html#3415075">dd</a></span><span class="op" id="3415255">%</span><span class="num" id="3415256">10</span><span class="op" id="3415258">)</span><span class="op" id="3415259">,</span>&nbsp;<span class="string" id="3415261">&#39;&nbsp;&#39;</span><span class="op" id="3415264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415268"><a href="/net/http/server.go.html#3415145">mon</a></span><span class="op" id="3415271">[</span><span class="num" id="3415272">0</span><span class="op" id="3415273">]</span><span class="op" id="3415274">,</span>&nbsp;<span class="ident" id="3415276"><a href="/net/http/server.go.html#3415145">mon</a></span><span class="op" id="3415279">[</span><span class="num" id="3415280">1</span><span class="op" id="3415281">]</span><span class="op" id="3415282">,</span>&nbsp;<span class="ident" id="3415284"><a href="/net/http/server.go.html#3415145">mon</a></span><span class="op" id="3415287">[</span><span class="num" id="3415288">2</span><span class="op" id="3415289">]</span><span class="op" id="3415290">,</span>&nbsp;<span class="string" id="3415292">&#39;&nbsp;&#39;</span><span class="op" id="3415295">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3415299">byte</span><span class="op" id="3415303">(</span><span class="string" id="3415304">&#39;0&#39;</span><span class="op" id="3415307">+</span><span class="ident" id="3415308"><a href="/net/http/server.go.html#3415067">yy</a></span><span class="op" id="3415310">/</span><span class="num" id="3415311">1000</span><span class="op" id="3415315">)</span><span class="op" id="3415316">,</span>&nbsp;<span class="builtintype" id="3415318">byte</span><span class="op" id="3415322">(</span><span class="string" id="3415323">&#39;0&#39;</span><span class="op" id="3415326">+</span><span class="op" id="3415327">(</span><span class="ident" id="3415328"><a href="/net/http/server.go.html#3415067">yy</a></span><span class="op" id="3415330">/</span><span class="num" id="3415331">100</span><span class="op" id="3415334">)</span><span class="op" id="3415335">%</span><span class="num" id="3415336">10</span><span class="op" id="3415338">)</span><span class="op" id="3415339">,</span>&nbsp;<span class="builtintype" id="3415341">byte</span><span class="op" id="3415345">(</span><span class="string" id="3415346">&#39;0&#39;</span><span class="op" id="3415349">+</span><span class="op" id="3415350">(</span><span class="ident" id="3415351"><a href="/net/http/server.go.html#3415067">yy</a></span><span class="op" id="3415353">/</span><span class="num" id="3415354">10</span><span class="op" id="3415356">)</span><span class="op" id="3415357">%</span><span class="num" id="3415358">10</span><span class="op" id="3415360">)</span><span class="op" id="3415361">,</span>&nbsp;<span class="builtintype" id="3415363">byte</span><span class="op" id="3415367">(</span><span class="string" id="3415368">&#39;0&#39;</span><span class="op" id="3415371">+</span><span class="ident" id="3415372"><a href="/net/http/server.go.html#3415067">yy</a></span><span class="op" id="3415374">%</span><span class="num" id="3415375">10</span><span class="op" id="3415377">)</span><span class="op" id="3415378">,</span>&nbsp;<span class="string" id="3415380">&#39;&nbsp;&#39;</span><span class="op" id="3415383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3415387">byte</span><span class="op" id="3415391">(</span><span class="string" id="3415392">&#39;0&#39;</span><span class="op" id="3415395">+</span><span class="ident" id="3415396"><a href="/net/http/server.go.html#3415091">hh</a></span><span class="op" id="3415398">/</span><span class="num" id="3415399">10</span><span class="op" id="3415401">)</span><span class="op" id="3415402">,</span>&nbsp;<span class="builtintype" id="3415404">byte</span><span class="op" id="3415408">(</span><span class="string" id="3415409">&#39;0&#39;</span><span class="op" id="3415412">+</span><span class="ident" id="3415413"><a href="/net/http/server.go.html#3415091">hh</a></span><span class="op" id="3415415">%</span><span class="num" id="3415416">10</span><span class="op" id="3415418">)</span><span class="op" id="3415419">,</span>&nbsp;<span class="string" id="3415421">&#39;:&#39;</span><span class="op" id="3415424">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3415428">byte</span><span class="op" id="3415432">(</span><span class="string" id="3415433">&#39;0&#39;</span><span class="op" id="3415436">+</span><span class="ident" id="3415437"><a href="/net/http/server.go.html#3415095">mn</a></span><span class="op" id="3415439">/</span><span class="num" id="3415440">10</span><span class="op" id="3415442">)</span><span class="op" id="3415443">,</span>&nbsp;<span class="builtintype" id="3415445">byte</span><span class="op" id="3415449">(</span><span class="string" id="3415450">&#39;0&#39;</span><span class="op" id="3415453">+</span><span class="ident" id="3415454"><a href="/net/http/server.go.html#3415095">mn</a></span><span class="op" id="3415456">%</span><span class="num" id="3415457">10</span><span class="op" id="3415459">)</span><span class="op" id="3415460">,</span>&nbsp;<span class="string" id="3415462">&#39;:&#39;</span><span class="op" id="3415465">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3415469">byte</span><span class="op" id="3415473">(</span><span class="string" id="3415474">&#39;0&#39;</span><span class="op" id="3415477">+</span><span class="ident" id="3415478"><a href="/net/http/server.go.html#3415099">ss</a></span><span class="op" id="3415480">/</span><span class="num" id="3415481">10</span><span class="op" id="3415483">)</span><span class="op" id="3415484">,</span>&nbsp;<span class="builtintype" id="3415486">byte</span><span class="op" id="3415490">(</span><span class="string" id="3415491">&#39;0&#39;</span><span class="op" id="3415494">+</span><span class="ident" id="3415495"><a href="/net/http/server.go.html#3415099">ss</a></span><span class="op" id="3415497">%</span><span class="num" id="3415498">10</span><span class="op" id="3415500">)</span><span class="op" id="3415501">,</span>&nbsp;<span class="string" id="3415503">&#39;&nbsp;&#39;</span><span class="op" id="3415506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3415510">&#39;G&#39;</span><span class="op" id="3415513">,</span>&nbsp;<span class="string" id="3415515">&#39;M&#39;</span><span class="op" id="3415518">,</span>&nbsp;<span class="string" id="3415520">&#39;T&#39;</span><span class="op" id="3415523">)</span><br>
<span class="lineno">565</span><span class="op" id="3415525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3415528">var</span>&nbsp;<span class="ident" id="3415532">errTooLarge</span>&nbsp;<span class="op" id="3415544">=</span>&nbsp;<span class="ident" id="3415546"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3415552">.</span><span class="ident" id="3415553">New</span><span class="op" id="3415556">(</span><span class="string" id="3415557">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3415582">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3415585">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3415623">func</span>&nbsp;<span class="op" id="3415628">(</span><span class="ident" id="3415629">c</span>&nbsp;<span class="op" id="3415631">*</span><span class="ident" id="3415632"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3415636">)</span>&nbsp;<span class="ident" id="3415638">readRequest</span><span class="op" id="3415649">(</span><span class="op" id="3415650">)</span>&nbsp;<span class="op" id="3415652">(</span><span class="ident" id="3415653">w</span>&nbsp;<span class="op" id="3415655">*</span><span class="ident" id="3415656"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3415664">,</span>&nbsp;<span class="ident" id="3415666">err</span>&nbsp;<span class="builtintype" id="3415670">error</span><span class="op" id="3415675">)</span>&nbsp;<span class="op" id="3415677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415680">if</span>&nbsp;<span class="ident" id="3415683"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415684">.</span><span class="ident" id="3415685">hijacked</span><span class="op" id="3415693">(</span><span class="op" id="3415694">)</span>&nbsp;<span class="op" id="3415696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415700">return</span>&nbsp;<span class="ident" id="3415707">nil</span><span class="op" id="3415710">,</span>&nbsp;<span class="ident" id="3415712"><a href="/net/http/server.go.html#3400191">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3415725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415729">if</span>&nbsp;<span class="ident" id="3415732">d</span>&nbsp;<span class="op" id="3415734">:=</span>&nbsp;<span class="ident" id="3415737"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415738">.</span><span class="ident" id="3415739">server</span><span class="op" id="3415745">.</span><span class="ident" id="3415746">ReadTimeout</span><span class="op" id="3415757">;</span>&nbsp;<span class="ident" id="3415759"><a href="/net/http/server.go.html#3415732">d</a></span>&nbsp;<span class="op" id="3415761">!=</span>&nbsp;<span class="num" id="3415764">0</span>&nbsp;<span class="op" id="3415766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415770"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415771">.</span><span class="ident" id="3415772">rwc</span><span class="op" id="3415775">.</span><span class="ident" id="3415776">SetReadDeadline</span><span class="op" id="3415791">(</span><span class="ident" id="3415792"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3415796">.</span><span class="ident" id="3415797">Now</span><span class="op" id="3415800">(</span><span class="op" id="3415801">)</span><span class="op" id="3415802">.</span><span class="ident" id="3415803">Add</span><span class="op" id="3415806">(</span><span class="ident" id="3415807"><a href="/net/http/server.go.html#3415732">d</a></span><span class="op" id="3415808">)</span><span class="op" id="3415809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3415812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415815">if</span>&nbsp;<span class="ident" id="3415818">d</span>&nbsp;<span class="op" id="3415820">:=</span>&nbsp;<span class="ident" id="3415823"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415824">.</span><span class="ident" id="3415825">server</span><span class="op" id="3415831">.</span><span class="ident" id="3415832">WriteTimeout</span><span class="op" id="3415844">;</span>&nbsp;<span class="ident" id="3415846"><a href="/net/http/server.go.html#3415818">d</a></span>&nbsp;<span class="op" id="3415848">!=</span>&nbsp;<span class="num" id="3415851">0</span>&nbsp;<span class="op" id="3415853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415857">defer</span>&nbsp;<span class="keyword" id="3415863">func</span><span class="op" id="3415867">(</span><span class="op" id="3415868">)</span>&nbsp;<span class="op" id="3415870">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415875"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415876">.</span><span class="ident" id="3415877">rwc</span><span class="op" id="3415880">.</span><span class="ident" id="3415881">SetWriteDeadline</span><span class="op" id="3415897">(</span><span class="ident" id="3415898"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3415902">.</span><span class="ident" id="3415903">Now</span><span class="op" id="3415906">(</span><span class="op" id="3415907">)</span><span class="op" id="3415908">.</span><span class="ident" id="3415909">Add</span><span class="op" id="3415912">(</span><span class="ident" id="3415913"><a href="/net/http/server.go.html#3415818">d</a></span><span class="op" id="3415914">)</span><span class="op" id="3415915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3415919">}</span><span class="op" id="3415920">(</span><span class="op" id="3415921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3415924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3415928"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415929">.</span><span class="ident" id="3415930">lr</span><span class="op" id="3415932">.</span><span class="ident" id="3415933">N</span>&nbsp;<span class="op" id="3415935">=</span>&nbsp;<span class="ident" id="3415937"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3415938">.</span><span class="ident" id="3415939">server</span><span class="op" id="3415945">.</span><span class="ident" id="3415946">initialLimitedReaderSize</span><span class="op" id="3415970">(</span><span class="op" id="3415971">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415974">var</span>&nbsp;<span class="ident" id="3415978">req</span>&nbsp;<span class="op" id="3415982">*</span><span class="ident" id="3415983"><a href="/net/http/request.go.html#3366486">Request</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3415992">if</span>&nbsp;<span class="ident" id="3415995"><a href="/net/http/server.go.html#3415978">req</a></span><span class="op" id="3415998">,</span>&nbsp;<span class="ident" id="3416000"><a href="/net/http/server.go.html#3415666">err</a></span>&nbsp;<span class="op" id="3416004">=</span>&nbsp;<span class="ident" id="3416006"><a href="/net/http/request.go.html#3382627">ReadRequest</a></span><span class="op" id="3416017">(</span><span class="ident" id="3416018"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3416019">.</span><span class="ident" id="3416020">buf</span><span class="op" id="3416023">.</span><span class="ident" id="3416024">Reader</span><span class="op" id="3416030">)</span><span class="op" id="3416031">;</span>&nbsp;<span class="ident" id="3416033"><a href="/net/http/server.go.html#3415666">err</a></span>&nbsp;<span class="op" id="3416037">!=</span>&nbsp;<span class="ident" id="3416040">nil</span>&nbsp;<span class="op" id="3416044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3416048">if</span>&nbsp;<span class="ident" id="3416051"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3416052">.</span><span class="ident" id="3416053">lr</span><span class="op" id="3416055">.</span><span class="ident" id="3416056">N</span>&nbsp;<span class="op" id="3416058">==</span>&nbsp;<span class="num" id="3416061">0</span>&nbsp;<span class="op" id="3416063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3416068">return</span>&nbsp;<span class="ident" id="3416075">nil</span><span class="op" id="3416078">,</span>&nbsp;<span class="ident" id="3416080"><a href="/net/http/server.go.html#3415532">errTooLarge</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3416094">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3416098">return</span>&nbsp;<span class="ident" id="3416105">nil</span><span class="op" id="3416108">,</span>&nbsp;<span class="ident" id="3416110"><a href="/net/http/server.go.html#3415666">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3416115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416118"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3416119">.</span><span class="ident" id="3416120">lr</span><span class="op" id="3416122">.</span><span class="ident" id="3416123">N</span>&nbsp;<span class="op" id="3416125">=</span>&nbsp;<span class="ident" id="3416127"><a href="/net/http/server.go.html#3411900">noLimit</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416137"><a href="/net/http/server.go.html#3415978">req</a></span><span class="op" id="3416140">.</span><span class="ident" id="3416141">RemoteAddr</span>&nbsp;<span class="op" id="3416152">=</span>&nbsp;<span class="ident" id="3416154"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3416155">.</span><span class="ident" id="3416156">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416168"><a href="/net/http/server.go.html#3415978">req</a></span><span class="op" id="3416171">.</span><span class="ident" id="3416172">TLS</span>&nbsp;<span class="op" id="3416176">=</span>&nbsp;<span class="ident" id="3416178"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3416179">.</span><span class="ident" id="3416180">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416191"><a href="/net/http/server.go.html#3415653">w</a></span>&nbsp;<span class="op" id="3416193">=</span>&nbsp;<span class="op" id="3416195">&amp;</span><span class="ident" id="3416196"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3416204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416208">conn</span><span class="op" id="3416212">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416223"><a href="/net/http/server.go.html#3415629">c</a></span><span class="op" id="3416224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416228">req</span><span class="op" id="3416231">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416243"><a href="/net/http/server.go.html#3415978">req</a></span><span class="op" id="3416246">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416250">handlerHeader</span><span class="op" id="3416263">:</span>&nbsp;<span class="builtinfunc" id="3416265">make</span><span class="op" id="3416269">(</span><span class="ident" id="3416270"><a href="/net/http/header.go.html#3356649">Header</a></span><span class="op" id="3416276">)</span><span class="op" id="3416277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416281">contentLength</span><span class="op" id="3416294">:</span>&nbsp;<span class="op" id="3416296">-</span><span class="num" id="3416297">1</span><span class="op" id="3416298">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3416301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416304"><a href="/net/http/server.go.html#3415653">w</a></span><span class="op" id="3416305">.</span><span class="ident" id="3416306">cw</span><span class="op" id="3416308">.</span><span class="ident" id="3416309">res</span>&nbsp;<span class="op" id="3416313">=</span>&nbsp;<span class="ident" id="3416315"><a href="/net/http/server.go.html#3415653">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416318"><a href="/net/http/server.go.html#3415653">w</a></span><span class="op" id="3416319">.</span><span class="ident" id="3416320">w</span>&nbsp;<span class="op" id="3416322">=</span>&nbsp;<span class="ident" id="3416324"><a href="/net/http/server.go.html#3413111">newBufioWriterSize</a></span><span class="op" id="3416342">(</span><span class="op" id="3416343">&amp;</span><span class="ident" id="3416344"><a href="/net/http/server.go.html#3415653">w</a></span><span class="op" id="3416345">.</span><span class="ident" id="3416346">cw</span><span class="op" id="3416348">,</span>&nbsp;<span class="ident" id="3416350"><a href="/net/http/server.go.html#3406101">bufferBeforeChunkingSize</a></span><span class="op" id="3416374">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3416377">return</span>&nbsp;<span class="ident" id="3416384"><a href="/net/http/server.go.html#3415653">w</a></span><span class="op" id="3416385">,</span>&nbsp;<span class="ident" id="3416387">nil</span><br>
<span class="lineno"></span><span class="op" id="3416391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3416394">func</span>&nbsp;<span class="op" id="3416399">(</span><span class="ident" id="3416400">w</span>&nbsp;<span class="op" id="3416402">*</span><span class="ident" id="3416403"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3416411">)</span>&nbsp;<span class="ident" id="3416413">Header</span><span class="op" id="3416419">(</span><span class="op" id="3416420">)</span>&nbsp;<span class="ident" id="3416422"><a href="/net/http/header.go.html#3356649">Header</a></span>&nbsp;<span class="op" id="3416429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3416432">if</span>&nbsp;<span class="ident" id="3416435"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416436">.</span><span class="ident" id="3416437">cw</span><span class="op" id="3416439">.</span><span class="ident" id="3416440">header</span>&nbsp;<span class="op" id="3416447">==</span>&nbsp;<span class="ident" id="3416450">nil</span>&nbsp;<span class="op" id="3416454">&amp;&amp;</span>&nbsp;<span class="ident" id="3416457"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416458">.</span><span class="ident" id="3416459">wroteHeader</span>&nbsp;<span class="op" id="3416471">&amp;&amp;</span>&nbsp;<span class="op" id="3416474">!</span><span class="ident" id="3416475"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416476">.</span><span class="ident" id="3416477">cw</span><span class="op" id="3416479">.</span><span class="ident" id="3416480">wroteHeader</span>&nbsp;<span class="op" id="3416492">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3416496">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3416551">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3416608">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416662"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416663">.</span><span class="ident" id="3416664">cw</span><span class="op" id="3416666">.</span><span class="ident" id="3416667">header</span>&nbsp;<span class="op" id="3416674">=</span>&nbsp;<span class="ident" id="3416676"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416677">.</span><span class="ident" id="3416678">handlerHeader</span><span class="op" id="3416691">.</span><span class="ident" id="3416692">clone</span><span class="op" id="3416697">(</span><span class="op" id="3416698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3416701">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3416704"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416705">.</span><span class="ident" id="3416706">calledHeader</span>&nbsp;<span class="op" id="3416719">=</span>&nbsp;<span class="builtintype" id="3416721">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3416727">return</span>&nbsp;<span class="ident" id="3416734"><a href="/net/http/server.go.html#3416400">w</a></span><span class="op" id="3416735">.</span><span class="ident" id="3416736">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3416750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3416753">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3416824">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3416891">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3416961">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3417029">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3417049">//</span><br>
<span class="lineno">625</span><span class="comment" id="3417052">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3417120">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3417190">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3417209">const</span>&nbsp;<span class="ident" id="3417215">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3417239">=</span>&nbsp;<span class="num" id="3417241">256</span>&nbsp;<span class="op" id="3417245">&lt;&lt;</span>&nbsp;<span class="num" id="3417248">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3417252">func</span>&nbsp;<span class="op" id="3417257">(</span><span class="ident" id="3417258">w</span>&nbsp;<span class="op" id="3417260">*</span><span class="ident" id="3417261"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3417269">)</span>&nbsp;<span class="ident" id="3417271">WriteHeader</span><span class="op" id="3417282">(</span><span class="ident" id="3417283">code</span>&nbsp;<span class="builtintype" id="3417288">int</span><span class="op" id="3417291">)</span>&nbsp;<span class="op" id="3417293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417296">if</span>&nbsp;<span class="ident" id="3417299"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417300">.</span><span class="ident" id="3417301">conn</span><span class="op" id="3417305">.</span><span class="ident" id="3417306">hijacked</span><span class="op" id="3417314">(</span><span class="op" id="3417315">)</span>&nbsp;<span class="op" id="3417317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417321"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417322">.</span><span class="ident" id="3417323">conn</span><span class="op" id="3417327">.</span><span class="ident" id="3417328">server</span><span class="op" id="3417334">.</span><span class="ident" id="3417335">logf</span><span class="op" id="3417339">(</span><span class="string" id="3417340">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3417391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417395">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3417403">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417406">if</span>&nbsp;<span class="ident" id="3417409"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417410">.</span><span class="ident" id="3417411">wroteHeader</span>&nbsp;<span class="op" id="3417423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417427"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417428">.</span><span class="ident" id="3417429">conn</span><span class="op" id="3417433">.</span><span class="ident" id="3417434">server</span><span class="op" id="3417440">.</span><span class="ident" id="3417441">logf</span><span class="op" id="3417445">(</span><span class="string" id="3417446">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3417489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417493">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3417501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417504"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417505">.</span><span class="ident" id="3417506">wroteHeader</span>&nbsp;<span class="op" id="3417518">=</span>&nbsp;<span class="builtintype" id="3417520">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417526"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417527">.</span><span class="ident" id="3417528">status</span>&nbsp;<span class="op" id="3417535">=</span>&nbsp;<span class="ident" id="3417537"><a href="/net/http/server.go.html#3417283">code</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417544">if</span>&nbsp;<span class="ident" id="3417547"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417548">.</span><span class="ident" id="3417549">calledHeader</span>&nbsp;<span class="op" id="3417562">&amp;&amp;</span>&nbsp;<span class="ident" id="3417565"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417566">.</span><span class="ident" id="3417567">cw</span><span class="op" id="3417569">.</span><span class="ident" id="3417570">header</span>&nbsp;<span class="op" id="3417577">==</span>&nbsp;<span class="ident" id="3417580">nil</span>&nbsp;<span class="op" id="3417584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417588"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417589">.</span><span class="ident" id="3417590">cw</span><span class="op" id="3417592">.</span><span class="ident" id="3417593">header</span>&nbsp;<span class="op" id="3417600">=</span>&nbsp;<span class="ident" id="3417602"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417603">.</span><span class="ident" id="3417604">handlerHeader</span><span class="op" id="3417617">.</span><span class="ident" id="3417618">clone</span><span class="op" id="3417623">(</span><span class="op" id="3417624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3417627">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417631">if</span>&nbsp;<span class="ident" id="3417634">cl</span>&nbsp;<span class="op" id="3417637">:=</span>&nbsp;<span class="ident" id="3417640"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417641">.</span><span class="ident" id="3417642">handlerHeader</span><span class="op" id="3417655">.</span><span class="ident" id="3417656">get</span><span class="op" id="3417659">(</span><span class="string" id="3417660">&#34;Content-Length&#34;</span><span class="op" id="3417676">)</span><span class="op" id="3417677">;</span>&nbsp;<span class="ident" id="3417679"><a href="/net/http/server.go.html#3417634">cl</a></span>&nbsp;<span class="op" id="3417682">!=</span>&nbsp;<span class="string" id="3417685">&#34;&#34;</span>&nbsp;<span class="op" id="3417688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417692">v</span><span class="op" id="3417693">,</span>&nbsp;<span class="ident" id="3417695">err</span>&nbsp;<span class="op" id="3417699">:=</span>&nbsp;<span class="ident" id="3417702"><a href="/net/http/server.go.html#3399921">strconv</a></span><span class="op" id="3417709">.</span><span class="ident" id="3417710">ParseInt</span><span class="op" id="3417718">(</span><span class="ident" id="3417719"><a href="/net/http/server.go.html#3417634">cl</a></span><span class="op" id="3417721">,</span>&nbsp;<span class="num" id="3417723">10</span><span class="op" id="3417725">,</span>&nbsp;<span class="num" id="3417727">64</span><span class="op" id="3417729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3417733">if</span>&nbsp;<span class="ident" id="3417736"><a href="/net/http/server.go.html#3417695">err</a></span>&nbsp;<span class="op" id="3417740">==</span>&nbsp;<span class="ident" id="3417743">nil</span>&nbsp;<span class="op" id="3417747">&amp;&amp;</span>&nbsp;<span class="ident" id="3417750"><a href="/net/http/server.go.html#3417692">v</a></span>&nbsp;<span class="op" id="3417752">&gt;=</span>&nbsp;<span class="num" id="3417755">0</span>&nbsp;<span class="op" id="3417757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417762"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417763">.</span><span class="ident" id="3417764">contentLength</span>&nbsp;<span class="op" id="3417778">=</span>&nbsp;<span class="ident" id="3417780"><a href="/net/http/server.go.html#3417692">v</a></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3417784">}</span>&nbsp;<span class="keyword" id="3417786">else</span>&nbsp;<span class="op" id="3417791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417796"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417797">.</span><span class="ident" id="3417798">conn</span><span class="op" id="3417802">.</span><span class="ident" id="3417803">server</span><span class="op" id="3417809">.</span><span class="ident" id="3417810">logf</span><span class="op" id="3417814">(</span><span class="string" id="3417815">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3417851">,</span>&nbsp;<span class="ident" id="3417853"><a href="/net/http/server.go.html#3417634">cl</a></span><span class="op" id="3417855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3417860"><a href="/net/http/server.go.html#3417258">w</a></span><span class="op" id="3417861">.</span><span class="ident" id="3417862">handlerHeader</span><span class="op" id="3417875">.</span><span class="ident" id="3417876">Del</span><span class="op" id="3417879">(</span><span class="string" id="3417880">&#34;Content-Length&#34;</span><span class="op" id="3417896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3417900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3417903">}</span><br>
<span class="lineno">655</span><span class="op" id="3417905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3417908">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3417989">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3418068">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3418125">type</span>&nbsp;<span class="ident" id="3418130">extraHeader</span>&nbsp;<span class="keyword" id="3418142">struct</span>&nbsp;<span class="op" id="3418149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418152">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3418169">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418177">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3418194">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418202">transferEncoding</span>&nbsp;<span class="builtintype" id="3418219">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418227">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418244">[</span><span class="op" id="3418245">]</span><span class="builtintype" id="3418246">byte</span>&nbsp;<span class="comment" id="3418251">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418274">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418291">[</span><span class="op" id="3418292">]</span><span class="builtintype" id="3418293">byte</span>&nbsp;<span class="comment" id="3418298">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3418320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3418323">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3418371">var</span>&nbsp;<span class="ident" id="3418375">extraHeaderKeys</span>&nbsp;<span class="op" id="3418391">=</span>&nbsp;<span class="op" id="3418393">[</span><span class="op" id="3418394">]</span><span class="op" id="3418395">[</span><span class="op" id="3418396">]</span><span class="builtintype" id="3418397">byte</span><span class="op" id="3418401">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3418404">[</span><span class="op" id="3418405">]</span><span class="builtintype" id="3418406">byte</span><span class="op" id="3418410">(</span><span class="string" id="3418411">&#34;Content-Type&#34;</span><span class="op" id="3418425">)</span><span class="op" id="3418426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3418429">[</span><span class="op" id="3418430">]</span><span class="builtintype" id="3418431">byte</span><span class="op" id="3418435">(</span><span class="string" id="3418436">&#34;Connection&#34;</span><span class="op" id="3418448">)</span><span class="op" id="3418449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3418452">[</span><span class="op" id="3418453">]</span><span class="builtintype" id="3418454">byte</span><span class="op" id="3418458">(</span><span class="string" id="3418459">&#34;Transfer-Encoding&#34;</span><span class="op" id="3418478">)</span><span class="op" id="3418479">,</span><br>
<span class="lineno"></span><span class="op" id="3418481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3418484">var</span>&nbsp;<span class="op" id="3418488">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418491">headerContentLength</span>&nbsp;<span class="op" id="3418511">=</span>&nbsp;<span class="op" id="3418513">[</span><span class="op" id="3418514">]</span><span class="builtintype" id="3418515">byte</span><span class="op" id="3418519">(</span><span class="string" id="3418520">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3418538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418541">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418561">=</span>&nbsp;<span class="op" id="3418563">[</span><span class="op" id="3418564">]</span><span class="builtintype" id="3418565">byte</span><span class="op" id="3418569">(</span><span class="string" id="3418570">&#34;Date:&nbsp;&#34;</span><span class="op" id="3418578">)</span><br>
<span class="lineno"></span><span class="op" id="3418580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3418583">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3418632">//</span><br>
<span class="lineno"></span><span class="comment" id="3418635">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3418704">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3418774">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3418833">func</span>&nbsp;<span class="op" id="3418838">(</span><span class="ident" id="3418839">h</span>&nbsp;<span class="ident" id="3418841"><a href="/net/http/server.go.html#3418130">extraHeader</a></span><span class="op" id="3418852">)</span>&nbsp;<span class="ident" id="3418854">Write</span><span class="op" id="3418859">(</span><span class="ident" id="3418860">w</span>&nbsp;<span class="op" id="3418862">*</span><span class="ident" id="3418863"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3418868">.</span><span class="ident" id="3418869">Writer</span><span class="op" id="3418875">)</span>&nbsp;<span class="op" id="3418877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3418880">if</span>&nbsp;<span class="ident" id="3418883"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3418884">.</span><span class="ident" id="3418885">date</span>&nbsp;<span class="op" id="3418890">!=</span>&nbsp;<span class="ident" id="3418893">nil</span>&nbsp;<span class="op" id="3418897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418901"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3418902">.</span><span class="ident" id="3418903">Write</span><span class="op" id="3418908">(</span><span class="ident" id="3418909"><a href="/net/http/server.go.html#3418541">headerDate</a></span><span class="op" id="3418919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418923"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3418924">.</span><span class="ident" id="3418925">Write</span><span class="op" id="3418930">(</span><span class="ident" id="3418931"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3418932">.</span><span class="ident" id="3418933">date</span><span class="op" id="3418937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418941"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3418942">.</span><span class="ident" id="3418943">Write</span><span class="op" id="3418948">(</span><span class="ident" id="3418949"><a href="/net/http/server.go.html#3407220">crlf</a></span><span class="op" id="3418953">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3418956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3418959">if</span>&nbsp;<span class="ident" id="3418962"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3418963">.</span><span class="ident" id="3418964">contentLength</span>&nbsp;<span class="op" id="3418978">!=</span>&nbsp;<span class="ident" id="3418981">nil</span>&nbsp;<span class="op" id="3418985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3418989"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3418990">.</span><span class="ident" id="3418991">Write</span><span class="op" id="3418996">(</span><span class="ident" id="3418997"><a href="/net/http/server.go.html#3418491">headerContentLength</a></span><span class="op" id="3419016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419020"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3419021">.</span><span class="ident" id="3419022">Write</span><span class="op" id="3419027">(</span><span class="ident" id="3419028"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3419029">.</span><span class="ident" id="3419030">contentLength</span><span class="op" id="3419043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419047"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3419048">.</span><span class="ident" id="3419049">Write</span><span class="op" id="3419054">(</span><span class="ident" id="3419055"><a href="/net/http/server.go.html#3407220">crlf</a></span><span class="op" id="3419059">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3419062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3419065">for</span>&nbsp;<span class="ident" id="3419069">i</span><span class="op" id="3419070">,</span>&nbsp;<span class="ident" id="3419072">v</span>&nbsp;<span class="op" id="3419074">:=</span>&nbsp;<span class="keyword" id="3419077">range</span>&nbsp;<span class="op" id="3419083">[</span><span class="op" id="3419084">]</span><span class="builtintype" id="3419085">string</span><span class="op" id="3419091">{</span><span class="ident" id="3419092"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3419093">.</span><span class="ident" id="3419094">contentType</span><span class="op" id="3419105">,</span>&nbsp;<span class="ident" id="3419107"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3419108">.</span><span class="ident" id="3419109">connection</span><span class="op" id="3419119">,</span>&nbsp;<span class="ident" id="3419121"><a href="/net/http/server.go.html#3418839">h</a></span><span class="op" id="3419122">.</span><span class="ident" id="3419123">transferEncoding</span><span class="op" id="3419139">}</span>&nbsp;<span class="op" id="3419141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3419145">if</span>&nbsp;<span class="ident" id="3419148"><a href="/net/http/server.go.html#3419072">v</a></span>&nbsp;<span class="op" id="3419150">!=</span>&nbsp;<span class="string" id="3419153">&#34;&#34;</span>&nbsp;<span class="op" id="3419156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419161"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3419162">.</span><span class="ident" id="3419163">Write</span><span class="op" id="3419168">(</span><span class="ident" id="3419169"><a href="/net/http/server.go.html#3418375">extraHeaderKeys</a></span><span class="op" id="3419184">[</span><span class="ident" id="3419185"><a href="/net/http/server.go.html#3419069">i</a></span><span class="op" id="3419186">]</span><span class="op" id="3419187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419192"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3419193">.</span><span class="ident" id="3419194">Write</span><span class="op" id="3419199">(</span><span class="ident" id="3419200"><a href="/net/http/server.go.html#3407249">colonSpace</a></span><span class="op" id="3419210">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419215"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3419216">.</span><span class="ident" id="3419217">WriteString</span><span class="op" id="3419228">(</span><span class="ident" id="3419229"><a href="/net/http/server.go.html#3419072">v</a></span><span class="op" id="3419230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419235"><a href="/net/http/server.go.html#3418860">w</a></span><span class="op" id="3419236">.</span><span class="ident" id="3419237">Write</span><span class="op" id="3419242">(</span><span class="ident" id="3419243"><a href="/net/http/server.go.html#3407220">crlf</a></span><span class="op" id="3419247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3419251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3419254">}</span><br>
<span class="lineno"></span><span class="op" id="3419256">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3419259">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3419328">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3419351">//</span><br>
<span class="lineno"></span><span class="comment" id="3419354">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3419425">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3419495">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3419564">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3419630">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3419642">func</span>&nbsp;<span class="op" id="3419647">(</span><span class="ident" id="3419648">cw</span>&nbsp;<span class="op" id="3419651">*</span><span class="ident" id="3419652"><a href="/net/http/server.go.html#3406622">chunkWriter</a></span><span class="op" id="3419663">)</span>&nbsp;<span class="ident" id="3419665">writeHeader</span><span class="op" id="3419676">(</span><span class="ident" id="3419677">p</span>&nbsp;<span class="op" id="3419679">[</span><span class="op" id="3419680">]</span><span class="builtintype" id="3419681">byte</span><span class="op" id="3419685">)</span>&nbsp;<span class="op" id="3419687">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3419690">if</span>&nbsp;<span class="ident" id="3419693"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3419695">.</span><span class="ident" id="3419696">wroteHeader</span>&nbsp;<span class="op" id="3419708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3419712">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3419720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419723"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3419725">.</span><span class="ident" id="3419726">wroteHeader</span>&nbsp;<span class="op" id="3419738">=</span>&nbsp;<span class="builtintype" id="3419740">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419747">w</span>&nbsp;<span class="op" id="3419749">:=</span>&nbsp;<span class="ident" id="3419752"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3419754">.</span><span class="ident" id="3419755">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419760">keepAlivesEnabled</span>&nbsp;<span class="op" id="3419778">:=</span>&nbsp;<span class="ident" id="3419781"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3419782">.</span><span class="ident" id="3419783">conn</span><span class="op" id="3419787">.</span><span class="ident" id="3419788">server</span><span class="op" id="3419794">.</span><span class="ident" id="3419795">doKeepAlives</span><span class="op" id="3419807">(</span><span class="op" id="3419808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3419811">isHEAD</span>&nbsp;<span class="op" id="3419818">:=</span>&nbsp;<span class="ident" id="3419821"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3419822">.</span><span class="ident" id="3419823">req</span><span class="op" id="3419826">.</span><span class="ident" id="3419827">Method</span>&nbsp;<span class="op" id="3419834">==</span>&nbsp;<span class="string" id="3419837">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3419846">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3419910">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3419972">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420028">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420090">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420118">header</span>&nbsp;<span class="op" id="3420125">:=</span>&nbsp;<span class="ident" id="3420128"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3420130">.</span><span class="ident" id="3420131">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420139">owned</span>&nbsp;<span class="op" id="3420145">:=</span>&nbsp;<span class="ident" id="3420148"><a href="/net/http/server.go.html#3420118">header</a></span>&nbsp;<span class="op" id="3420155">!=</span>&nbsp;<span class="ident" id="3420158">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420163">if</span>&nbsp;<span class="op" id="3420166">!</span><span class="ident" id="3420167"><a href="/net/http/server.go.html#3420139">owned</a></span>&nbsp;<span class="op" id="3420173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420177"><a href="/net/http/server.go.html#3420118">header</a></span>&nbsp;<span class="op" id="3420184">=</span>&nbsp;<span class="ident" id="3420186"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3420187">.</span><span class="ident" id="3420188">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3420203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420206">var</span>&nbsp;<span class="ident" id="3420210">excludeHeader</span>&nbsp;<span class="keyword" id="3420224">map</span><span class="op" id="3420227">[</span><span class="builtintype" id="3420228">string</span><span class="op" id="3420234">]</span><span class="builtintype" id="3420235">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420241">delHeader</span>&nbsp;<span class="op" id="3420251">:=</span>&nbsp;<span class="keyword" id="3420254">func</span><span class="op" id="3420258">(</span><span class="ident" id="3420259">key</span>&nbsp;<span class="builtintype" id="3420263">string</span><span class="op" id="3420269">)</span>&nbsp;<span class="op" id="3420271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420275">if</span>&nbsp;<span class="ident" id="3420278"><a href="/net/http/server.go.html#3420139">owned</a></span>&nbsp;<span class="op" id="3420284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420289"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3420295">.</span><span class="ident" id="3420296">Del</span><span class="op" id="3420299">(</span><span class="ident" id="3420300"><a href="/net/http/server.go.html#3420259">key</a></span><span class="op" id="3420303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420308">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3420317">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420321">if</span>&nbsp;<span class="ident" id="3420324">_</span><span class="op" id="3420325">,</span>&nbsp;<span class="ident" id="3420327">ok</span>&nbsp;<span class="op" id="3420330">:=</span>&nbsp;<span class="ident" id="3420333"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3420339">[</span><span class="ident" id="3420340"><a href="/net/http/server.go.html#3420259">key</a></span><span class="op" id="3420343">]</span><span class="op" id="3420344">;</span>&nbsp;<span class="op" id="3420346">!</span><span class="ident" id="3420347"><a href="/net/http/server.go.html#3420327">ok</a></span>&nbsp;<span class="op" id="3420350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420355">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3420364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420368">if</span>&nbsp;<span class="ident" id="3420371"><a href="/net/http/server.go.html#3420210">excludeHeader</a></span>&nbsp;<span class="op" id="3420385">==</span>&nbsp;<span class="ident" id="3420388">nil</span>&nbsp;<span class="op" id="3420392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420397"><a href="/net/http/server.go.html#3420210">excludeHeader</a></span>&nbsp;<span class="op" id="3420411">=</span>&nbsp;<span class="builtinfunc" id="3420413">make</span><span class="op" id="3420417">(</span><span class="keyword" id="3420418">map</span><span class="op" id="3420421">[</span><span class="builtintype" id="3420422">string</span><span class="op" id="3420428">]</span><span class="builtintype" id="3420429">bool</span><span class="op" id="3420433">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3420437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3420441"><a href="/net/http/server.go.html#3420210">excludeHeader</a></span><span class="op" id="3420454">[</span><span class="ident" id="3420455"><a href="/net/http/server.go.html#3420259">key</a></span><span class="op" id="3420458">]</span>&nbsp;<span class="op" id="3420460">=</span>&nbsp;<span class="builtintype" id="3420462">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3420468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3420471">var</span>&nbsp;<span class="ident" id="3420475">setHeader</span>&nbsp;<span class="ident" id="3420485"><a href="/net/http/server.go.html#3418130">extraHeader</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420499">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420558">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420622">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420683">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420719">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420790">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420854">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420916">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3420980">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3421044">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3421104">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3421166">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3421200">if</span>&nbsp;<span class="ident" id="3421203"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421204">.</span><span class="ident" id="3421205">handlerDone</span>&nbsp;<span class="op" id="3421217">&amp;&amp;</span>&nbsp;<span class="ident" id="3421220"><a href="/net/http/transfer.go.html#3477643">bodyAllowedForStatus</a></span><span class="op" id="3421240">(</span><span class="ident" id="3421241"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421242">.</span><span class="ident" id="3421243">status</span><span class="op" id="3421249">)</span>&nbsp;<span class="op" id="3421251">&amp;&amp;</span>&nbsp;<span class="ident" id="3421254"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3421260">.</span><span class="ident" id="3421261">get</span><span class="op" id="3421264">(</span><span class="string" id="3421265">&#34;Content-Length&#34;</span><span class="op" id="3421281">)</span>&nbsp;<span class="op" id="3421283">==</span>&nbsp;<span class="string" id="3421286">&#34;&#34;</span>&nbsp;<span class="op" id="3421289">&amp;&amp;</span>&nbsp;<span class="op" id="3421292">(</span><span class="op" id="3421293">!</span><span class="ident" id="3421294"><a href="/net/http/server.go.html#3419811">isHEAD</a></span>&nbsp;<span class="op" id="3421301">||</span>&nbsp;<span class="builtinfunc" id="3421304">len</span><span class="op" id="3421307">(</span><span class="ident" id="3421308"><a href="/net/http/server.go.html#3419677">p</a></span><span class="op" id="3421309">)</span>&nbsp;<span class="op" id="3421311">&gt;</span>&nbsp;<span class="num" id="3421313">0</span><span class="op" id="3421314">)</span>&nbsp;<span class="op" id="3421316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3421320"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421321">.</span><span class="ident" id="3421322">contentLength</span>&nbsp;<span class="op" id="3421336">=</span>&nbsp;<span class="ident" id="3421338">int64</span><span class="op" id="3421343">(</span><span class="builtinfunc" id="3421344">len</span><span class="op" id="3421347">(</span><span class="ident" id="3421348"><a href="/net/http/server.go.html#3419677">p</a></span><span class="op" id="3421349">)</span><span class="op" id="3421350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3421354"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3421363">.</span><span class="ident" id="3421364">contentLength</span>&nbsp;<span class="op" id="3421378">=</span>&nbsp;<span class="ident" id="3421380"><a href="/net/http/server.go.html#3399921">strconv</a></span><span class="op" id="3421387">.</span><span class="ident" id="3421388">AppendInt</span><span class="op" id="3421397">(</span><span class="ident" id="3421398"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3421400">.</span><span class="ident" id="3421401">res</span><span class="op" id="3421404">.</span><span class="ident" id="3421405">clenBuf</span><span class="op" id="3421412">[</span><span class="op" id="3421413">:</span><span class="num" id="3421414">0</span><span class="op" id="3421415">]</span><span class="op" id="3421416">,</span>&nbsp;<span class="ident" id="3421418">int64</span><span class="op" id="3421423">(</span><span class="builtinfunc" id="3421424">len</span><span class="op" id="3421427">(</span><span class="ident" id="3421428"><a href="/net/http/server.go.html#3419677">p</a></span><span class="op" id="3421429">)</span><span class="op" id="3421430">)</span><span class="op" id="3421431">,</span>&nbsp;<span class="num" id="3421433">10</span><span class="op" id="3421435">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3421438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3421442">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3421508">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3421576">if</span>&nbsp;<span class="ident" id="3421579"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421580">.</span><span class="ident" id="3421581">req</span><span class="op" id="3421584">.</span><span class="ident" id="3421585">wantsHttp10KeepAlive</span><span class="op" id="3421605">(</span><span class="op" id="3421606">)</span>&nbsp;<span class="op" id="3421608">&amp;&amp;</span>&nbsp;<span class="ident" id="3421611"><a href="/net/http/server.go.html#3419760">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="3421629">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3421633">sentLength</span>&nbsp;<span class="op" id="3421644">:=</span>&nbsp;<span class="ident" id="3421647"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3421653">.</span><span class="ident" id="3421654">get</span><span class="op" id="3421657">(</span><span class="string" id="3421658">&#34;Content-Length&#34;</span><span class="op" id="3421674">)</span>&nbsp;<span class="op" id="3421676">!=</span>&nbsp;<span class="string" id="3421679">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3421684">if</span>&nbsp;<span class="ident" id="3421687"><a href="/net/http/server.go.html#3421633">sentLength</a></span>&nbsp;<span class="op" id="3421698">&amp;&amp;</span>&nbsp;<span class="ident" id="3421701"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3421707">.</span><span class="ident" id="3421708">get</span><span class="op" id="3421711">(</span><span class="string" id="3421712">&#34;Connection&#34;</span><span class="op" id="3421724">)</span>&nbsp;<span class="op" id="3421726">==</span>&nbsp;<span class="string" id="3421729">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3421742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3421747"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421748">.</span><span class="ident" id="3421749">closeAfterReply</span>&nbsp;<span class="op" id="3421765">=</span>&nbsp;<span class="builtintype" id="3421767">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3421775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3421778">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3421782">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3421842">hasCL</span>&nbsp;<span class="op" id="3421848">:=</span>&nbsp;<span class="ident" id="3421851"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421852">.</span><span class="ident" id="3421853">contentLength</span>&nbsp;<span class="op" id="3421867">!=</span>&nbsp;<span class="op" id="3421870">-</span><span class="num" id="3421871">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3421875">if</span>&nbsp;<span class="ident" id="3421878"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3421879">.</span><span class="ident" id="3421880">req</span><span class="op" id="3421883">.</span><span class="ident" id="3421884">wantsHttp10KeepAlive</span><span class="op" id="3421904">(</span><span class="op" id="3421905">)</span>&nbsp;<span class="op" id="3421907">&amp;&amp;</span>&nbsp;<span class="op" id="3421910">(</span><span class="ident" id="3421911"><a href="/net/http/server.go.html#3419811">isHEAD</a></span>&nbsp;<span class="op" id="3421918">||</span>&nbsp;<span class="ident" id="3421921"><a href="/net/http/server.go.html#3421842">hasCL</a></span><span class="op" id="3421926">)</span>&nbsp;<span class="op" id="3421928">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3421932">_</span><span class="op" id="3421933">,</span>&nbsp;<span class="ident" id="3421935">connectionHeaderSet</span>&nbsp;<span class="op" id="3421955">:=</span>&nbsp;<span class="ident" id="3421958"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3421964">[</span><span class="string" id="3421965">&#34;Connection&#34;</span><span class="op" id="3421977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3421981">if</span>&nbsp;<span class="op" id="3421984">!</span><span class="ident" id="3421985"><a href="/net/http/server.go.html#3421935">connectionHeaderSet</a></span>&nbsp;<span class="op" id="3422005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422010"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3422019">.</span><span class="ident" id="3422020">connection</span>&nbsp;<span class="op" id="3422031">=</span>&nbsp;<span class="string" id="3422033">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422051">}</span>&nbsp;<span class="keyword" id="3422053">else</span>&nbsp;<span class="keyword" id="3422058">if</span>&nbsp;<span class="op" id="3422061">!</span><span class="ident" id="3422062"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422063">.</span><span class="ident" id="3422064">req</span><span class="op" id="3422067">.</span><span class="ident" id="3422068">ProtoAtLeast</span><span class="op" id="3422080">(</span><span class="num" id="3422081">1</span><span class="op" id="3422082">,</span>&nbsp;<span class="num" id="3422084">1</span><span class="op" id="3422085">)</span>&nbsp;<span class="op" id="3422087">||</span>&nbsp;<span class="ident" id="3422090"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422091">.</span><span class="ident" id="3422092">req</span><span class="op" id="3422095">.</span><span class="ident" id="3422096">wantsClose</span><span class="op" id="3422106">(</span><span class="op" id="3422107">)</span>&nbsp;<span class="op" id="3422109">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422113"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422114">.</span><span class="ident" id="3422115">closeAfterReply</span>&nbsp;<span class="op" id="3422131">=</span>&nbsp;<span class="builtintype" id="3422133">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3422143">if</span>&nbsp;<span class="ident" id="3422146"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3422152">.</span><span class="ident" id="3422153">get</span><span class="op" id="3422156">(</span><span class="string" id="3422157">&#34;Connection&#34;</span><span class="op" id="3422169">)</span>&nbsp;<span class="op" id="3422171">==</span>&nbsp;<span class="string" id="3422174">&#34;close&#34;</span>&nbsp;<span class="op" id="3422182">||</span>&nbsp;<span class="op" id="3422185">!</span><span class="ident" id="3422186"><a href="/net/http/server.go.html#3419760">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="3422204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422208"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422209">.</span><span class="ident" id="3422210">closeAfterReply</span>&nbsp;<span class="op" id="3422226">=</span>&nbsp;<span class="builtintype" id="3422228">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3422238">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3422298">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3422359">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3422420">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3422471">if</span>&nbsp;<span class="ident" id="3422474"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422475">.</span><span class="ident" id="3422476">req</span><span class="op" id="3422479">.</span><span class="ident" id="3422480">ContentLength</span>&nbsp;<span class="op" id="3422494">!=</span>&nbsp;<span class="num" id="3422497">0</span>&nbsp;<span class="op" id="3422499">&amp;&amp;</span>&nbsp;<span class="op" id="3422502">!</span><span class="ident" id="3422503"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422504">.</span><span class="ident" id="3422505">closeAfterReply</span>&nbsp;<span class="op" id="3422521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422525">ecr</span><span class="op" id="3422528">,</span>&nbsp;<span class="ident" id="3422530">isExpecter</span>&nbsp;<span class="op" id="3422541">:=</span>&nbsp;<span class="ident" id="3422544"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422545">.</span><span class="ident" id="3422546">req</span><span class="op" id="3422549">.</span><span class="ident" id="3422550">Body</span><span class="op" id="3422554">.</span><span class="op" id="3422555">(</span><span class="op" id="3422556">*</span><span class="ident" id="3422557"><a href="/net/http/server.go.html#3414038">expectContinueReader</a></span><span class="op" id="3422577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3422581">if</span>&nbsp;<span class="op" id="3422584">!</span><span class="ident" id="3422585"><a href="/net/http/server.go.html#3422530">isExpecter</a></span>&nbsp;<span class="op" id="3422596">||</span>&nbsp;<span class="ident" id="3422599"><a href="/net/http/server.go.html#3422525">ecr</a></span><span class="op" id="3422602">.</span><span class="ident" id="3422603">resp</span><span class="op" id="3422607">.</span><span class="ident" id="3422608">wroteContinue</span>&nbsp;<span class="op" id="3422622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422627">n</span><span class="op" id="3422628">,</span>&nbsp;<span class="ident" id="3422630">_</span>&nbsp;<span class="op" id="3422632">:=</span>&nbsp;<span class="ident" id="3422635"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3422637">.</span><span class="ident" id="3422638">CopyN</span><span class="op" id="3422643">(</span><span class="ident" id="3422644"><a href="/net/http/server.go.html#3399858">ioutil</a></span><span class="op" id="3422650">.</span><span class="ident" id="3422651">Discard</span><span class="op" id="3422658">,</span>&nbsp;<span class="ident" id="3422660"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422661">.</span><span class="ident" id="3422662">req</span><span class="op" id="3422665">.</span><span class="ident" id="3422666">Body</span><span class="op" id="3422670">,</span>&nbsp;<span class="ident" id="3422672"><a href="/net/http/server.go.html#3417215">maxPostHandlerReadBytes</a></span><span class="op" id="3422695">+</span><span class="num" id="3422696">1</span><span class="op" id="3422697">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3422702">if</span>&nbsp;<span class="ident" id="3422705"><a href="/net/http/server.go.html#3422627">n</a></span>&nbsp;<span class="op" id="3422707">&gt;=</span>&nbsp;<span class="ident" id="3422710"><a href="/net/http/server.go.html#3417215">maxPostHandlerReadBytes</a></span>&nbsp;<span class="op" id="3422734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422740"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422741">.</span><span class="ident" id="3422742">requestTooLarge</span><span class="op" id="3422757">(</span><span class="op" id="3422758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422764"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3422773">(</span><span class="string" id="3422774">&#34;Connection&#34;</span><span class="op" id="3422786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422792"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3422801">.</span><span class="ident" id="3422802">connection</span>&nbsp;<span class="op" id="3422813">=</span>&nbsp;<span class="string" id="3422815">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422826">}</span>&nbsp;<span class="keyword" id="3422828">else</span>&nbsp;<span class="op" id="3422833">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422839"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422840">.</span><span class="ident" id="3422841">req</span><span class="op" id="3422844">.</span><span class="ident" id="3422845">Body</span><span class="op" id="3422849">.</span><span class="ident" id="3422850">Close</span><span class="op" id="3422855">(</span><span class="op" id="3422856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3422868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422872">code</span>&nbsp;<span class="op" id="3422877">:=</span>&nbsp;<span class="ident" id="3422880"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3422881">.</span><span class="ident" id="3422882">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3422890">if</span>&nbsp;<span class="ident" id="3422893"><a href="/net/http/transfer.go.html#3477643">bodyAllowedForStatus</a></span><span class="op" id="3422913">(</span><span class="ident" id="3422914"><a href="/net/http/server.go.html#3422872">code</a></span><span class="op" id="3422918">)</span>&nbsp;<span class="op" id="3422920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3422924">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3422983">_</span><span class="op" id="3422984">,</span>&nbsp;<span class="ident" id="3422986">haveType</span>&nbsp;<span class="op" id="3422995">:=</span>&nbsp;<span class="ident" id="3422998"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3423004">[</span><span class="string" id="3423005">&#34;Content-Type&#34;</span><span class="op" id="3423019">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3423023">if</span>&nbsp;<span class="op" id="3423026">!</span><span class="ident" id="3423027"><a href="/net/http/server.go.html#3422986">haveType</a></span>&nbsp;<span class="op" id="3423036">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423041"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3423050">.</span><span class="ident" id="3423051">contentType</span>&nbsp;<span class="op" id="3423063">=</span>&nbsp;<span class="ident" id="3423065"><a href="/net/http/sniff.go.html#3461809">DetectContentType</a></span><span class="op" id="3423082">(</span><span class="ident" id="3423083"><a href="/net/http/server.go.html#3419677">p</a></span><span class="op" id="3423084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423091">}</span>&nbsp;<span class="keyword" id="3423093">else</span>&nbsp;<span class="op" id="3423098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3423102">for</span>&nbsp;<span class="ident" id="3423106">_</span><span class="op" id="3423107">,</span>&nbsp;<span class="ident" id="3423109">k</span>&nbsp;<span class="op" id="3423111">:=</span>&nbsp;<span class="keyword" id="3423114">range</span>&nbsp;<span class="ident" id="3423120"><a href="/net/http/transfer.go.html#3478017">suppressedHeaders</a></span><span class="op" id="3423137">(</span><span class="ident" id="3423138"><a href="/net/http/server.go.html#3422872">code</a></span><span class="op" id="3423142">)</span>&nbsp;<span class="op" id="3423144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423149"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3423158">(</span><span class="ident" id="3423159"><a href="/net/http/server.go.html#3423109">k</a></span><span class="op" id="3423160">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3423171">if</span>&nbsp;<span class="ident" id="3423174">_</span><span class="op" id="3423175">,</span>&nbsp;<span class="ident" id="3423177">ok</span>&nbsp;<span class="op" id="3423180">:=</span>&nbsp;<span class="ident" id="3423183"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3423189">[</span><span class="string" id="3423190">&#34;Date&#34;</span><span class="op" id="3423196">]</span><span class="op" id="3423197">;</span>&nbsp;<span class="op" id="3423199">!</span><span class="ident" id="3423200"><a href="/net/http/server.go.html#3423177">ok</a></span>&nbsp;<span class="op" id="3423203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423207"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3423216">.</span><span class="ident" id="3423217">date</span>&nbsp;<span class="op" id="3423222">=</span>&nbsp;<span class="ident" id="3423224"><a href="/net/http/server.go.html#3414916">appendTime</a></span><span class="op" id="3423234">(</span><span class="ident" id="3423235"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3423237">.</span><span class="ident" id="3423238">res</span><span class="op" id="3423241">.</span><span class="ident" id="3423242">dateBuf</span><span class="op" id="3423249">[</span><span class="op" id="3423250">:</span><span class="num" id="3423251">0</span><span class="op" id="3423252">]</span><span class="op" id="3423253">,</span>&nbsp;<span class="ident" id="3423255"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3423259">.</span><span class="ident" id="3423260">Now</span><span class="op" id="3423263">(</span><span class="op" id="3423264">)</span><span class="op" id="3423265">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423272">te</span>&nbsp;<span class="op" id="3423275">:=</span>&nbsp;<span class="ident" id="3423278"><a href="/net/http/server.go.html#3420118">header</a></span><span class="op" id="3423284">.</span><span class="ident" id="3423285">get</span><span class="op" id="3423288">(</span><span class="string" id="3423289">&#34;Transfer-Encoding&#34;</span><span class="op" id="3423308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423311">hasTE</span>&nbsp;<span class="op" id="3423317">:=</span>&nbsp;<span class="ident" id="3423320"><a href="/net/http/server.go.html#3423272">te</a></span>&nbsp;<span class="op" id="3423323">!=</span>&nbsp;<span class="string" id="3423326">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3423330">if</span>&nbsp;<span class="ident" id="3423333"><a href="/net/http/server.go.html#3421842">hasCL</a></span>&nbsp;<span class="op" id="3423339">&amp;&amp;</span>&nbsp;<span class="ident" id="3423342"><a href="/net/http/server.go.html#3423311">hasTE</a></span>&nbsp;<span class="op" id="3423348">&amp;&amp;</span>&nbsp;<span class="ident" id="3423351"><a href="/net/http/server.go.html#3423272">te</a></span>&nbsp;<span class="op" id="3423354">!=</span>&nbsp;<span class="string" id="3423357">&#34;identity&#34;</span>&nbsp;<span class="op" id="3423368">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3423372">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3423438">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423483"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3423484">.</span><span class="ident" id="3423485">conn</span><span class="op" id="3423489">.</span><span class="ident" id="3423490">server</span><span class="op" id="3423496">.</span><span class="ident" id="3423497">logf</span><span class="op" id="3423501">(</span><span class="string" id="3423502">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3423589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423594"><a href="/net/http/server.go.html#3423272">te</a></span><span class="op" id="3423596">,</span>&nbsp;<span class="ident" id="3423598"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3423599">.</span><span class="ident" id="3423600">contentLength</span><span class="op" id="3423613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423617"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3423626">(</span><span class="string" id="3423627">&#34;Content-Length&#34;</span><span class="op" id="3423643">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423647"><a href="/net/http/server.go.html#3421842">hasCL</a></span>&nbsp;<span class="op" id="3423653">=</span>&nbsp;<span class="builtintype" id="3423655">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3423666">if</span>&nbsp;<span class="ident" id="3423669"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3423670">.</span><span class="ident" id="3423671">req</span><span class="op" id="3423674">.</span><span class="ident" id="3423675">Method</span>&nbsp;<span class="op" id="3423682">==</span>&nbsp;<span class="string" id="3423685">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3423692">||</span>&nbsp;<span class="op" id="3423695">!</span><span class="ident" id="3423696"><a href="/net/http/transfer.go.html#3477643">bodyAllowedForStatus</a></span><span class="op" id="3423716">(</span><span class="ident" id="3423717"><a href="/net/http/server.go.html#3422872">code</a></span><span class="op" id="3423721">)</span>&nbsp;<span class="op" id="3423723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3423727">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423742">}</span>&nbsp;<span class="keyword" id="3423744">else</span>&nbsp;<span class="keyword" id="3423749">if</span>&nbsp;<span class="ident" id="3423752"><a href="/net/http/server.go.html#3422872">code</a></span>&nbsp;<span class="op" id="3423757">==</span>&nbsp;<span class="ident" id="3423760"><a href="/net/http/status.go.html#3466878">StatusNoContent</a></span>&nbsp;<span class="op" id="3423776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423780"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3423789">(</span><span class="string" id="3423790">&#34;Transfer-Encoding&#34;</span><span class="op" id="3423809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423812">}</span>&nbsp;<span class="keyword" id="3423814">else</span>&nbsp;<span class="keyword" id="3423819">if</span>&nbsp;<span class="ident" id="3423822"><a href="/net/http/server.go.html#3421842">hasCL</a></span>&nbsp;<span class="op" id="3423828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3423832"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3423841">(</span><span class="string" id="3423842">&#34;Transfer-Encoding&#34;</span><span class="op" id="3423861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3423864">}</span>&nbsp;<span class="keyword" id="3423866">else</span>&nbsp;<span class="keyword" id="3423871">if</span>&nbsp;<span class="ident" id="3423874"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3423875">.</span><span class="ident" id="3423876">req</span><span class="op" id="3423879">.</span><span class="ident" id="3423880">ProtoAtLeast</span><span class="op" id="3423892">(</span><span class="num" id="3423893">1</span><span class="op" id="3423894">,</span>&nbsp;<span class="num" id="3423896">1</span><span class="op" id="3423897">)</span>&nbsp;<span class="op" id="3423899">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3423903">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3423981">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424060">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424132">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424204">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3424220">if</span>&nbsp;<span class="ident" id="3424223"><a href="/net/http/server.go.html#3423311">hasTE</a></span>&nbsp;<span class="op" id="3424229">&amp;&amp;</span>&nbsp;<span class="ident" id="3424232"><a href="/net/http/server.go.html#3423272">te</a></span>&nbsp;<span class="op" id="3424235">==</span>&nbsp;<span class="string" id="3424238">&#34;identity&#34;</span>&nbsp;<span class="op" id="3424249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424254"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3424256">.</span><span class="ident" id="3424257">chunking</span>&nbsp;<span class="op" id="3424266">=</span>&nbsp;<span class="builtintype" id="3424268">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424277"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3424278">.</span><span class="ident" id="3424279">closeAfterReply</span>&nbsp;<span class="op" id="3424295">=</span>&nbsp;<span class="builtintype" id="3424297">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3424304">}</span>&nbsp;<span class="keyword" id="3424306">else</span>&nbsp;<span class="op" id="3424311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424316">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424373">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424419"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3424421">.</span><span class="ident" id="3424422">chunking</span>&nbsp;<span class="op" id="3424431">=</span>&nbsp;<span class="builtintype" id="3424433">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424441"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3424450">.</span><span class="ident" id="3424451">transferEncoding</span>&nbsp;<span class="op" id="3424468">=</span>&nbsp;<span class="string" id="3424470">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3424482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3424485">}</span>&nbsp;<span class="keyword" id="3424487">else</span>&nbsp;<span class="op" id="3424492">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424496">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424548">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424602">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424641"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3424642">.</span><span class="ident" id="3424643">closeAfterReply</span>&nbsp;<span class="op" id="3424659">=</span>&nbsp;<span class="builtintype" id="3424661">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424668"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3424677">(</span><span class="string" id="3424678">&#34;Transfer-Encoding&#34;</span><span class="op" id="3424697">)</span>&nbsp;<span class="comment" id="3424699">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3424723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3424727">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3424794">if</span>&nbsp;<span class="ident" id="3424797"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3424799">.</span><span class="ident" id="3424800">chunking</span>&nbsp;<span class="op" id="3424809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424813"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3424822">(</span><span class="string" id="3424823">&#34;Content-Length&#34;</span><span class="op" id="3424839">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3424842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3424845">if</span>&nbsp;<span class="op" id="3424848">!</span><span class="ident" id="3424849"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3424850">.</span><span class="ident" id="3424851">req</span><span class="op" id="3424854">.</span><span class="ident" id="3424855">ProtoAtLeast</span><span class="op" id="3424867">(</span><span class="num" id="3424868">1</span><span class="op" id="3424869">,</span>&nbsp;<span class="num" id="3424871">0</span><span class="op" id="3424872">)</span>&nbsp;<span class="op" id="3424874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3424878">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3424886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3424890">if</span>&nbsp;<span class="ident" id="3424893"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3424894">.</span><span class="ident" id="3424895">closeAfterReply</span>&nbsp;<span class="op" id="3424911">&amp;&amp;</span>&nbsp;<span class="op" id="3424914">(</span><span class="op" id="3424915">!</span><span class="ident" id="3424916"><a href="/net/http/server.go.html#3419760">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="3424934">||</span>&nbsp;<span class="op" id="3424937">!</span><span class="ident" id="3424938"><a href="/net/http/header.go.html#3361024">hasToken</a></span><span class="op" id="3424946">(</span><span class="ident" id="3424947"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3424949">.</span><span class="ident" id="3424950">header</span><span class="op" id="3424956">.</span><span class="ident" id="3424957">get</span><span class="op" id="3424960">(</span><span class="string" id="3424961">&#34;Connection&#34;</span><span class="op" id="3424973">)</span><span class="op" id="3424974">,</span>&nbsp;<span class="string" id="3424976">&#34;close&#34;</span><span class="op" id="3424983">)</span><span class="op" id="3424984">)</span>&nbsp;<span class="op" id="3424986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3424990"><a href="/net/http/server.go.html#3420241">delHeader</a></span><span class="op" id="3424999">(</span><span class="string" id="3425000">&#34;Connection&#34;</span><span class="op" id="3425012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3425016">if</span>&nbsp;<span class="ident" id="3425019"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3425020">.</span><span class="ident" id="3425021">req</span><span class="op" id="3425024">.</span><span class="ident" id="3425025">ProtoAtLeast</span><span class="op" id="3425037">(</span><span class="num" id="3425038">1</span><span class="op" id="3425039">,</span>&nbsp;<span class="num" id="3425041">1</span><span class="op" id="3425042">)</span>&nbsp;<span class="op" id="3425044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425049"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3425058">.</span><span class="ident" id="3425059">connection</span>&nbsp;<span class="op" id="3425070">=</span>&nbsp;<span class="string" id="3425072">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3425082">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3425085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425089"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3425090">.</span><span class="ident" id="3425091">conn</span><span class="op" id="3425095">.</span><span class="ident" id="3425096">buf</span><span class="op" id="3425099">.</span><span class="ident" id="3425100">WriteString</span><span class="op" id="3425111">(</span><span class="ident" id="3425112"><a href="/net/http/server.go.html#3425757">statusLine</a></span><span class="op" id="3425122">(</span><span class="ident" id="3425123"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3425124">.</span><span class="ident" id="3425125">req</span><span class="op" id="3425128">,</span>&nbsp;<span class="ident" id="3425130"><a href="/net/http/server.go.html#3422872">code</a></span><span class="op" id="3425134">)</span><span class="op" id="3425135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425138"><a href="/net/http/server.go.html#3419648">cw</a></span><span class="op" id="3425140">.</span><span class="ident" id="3425141">header</span><span class="op" id="3425147">.</span><span class="ident" id="3425148">WriteSubset</span><span class="op" id="3425159">(</span><span class="ident" id="3425160"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3425161">.</span><span class="ident" id="3425162">conn</span><span class="op" id="3425166">.</span><span class="ident" id="3425167">buf</span><span class="op" id="3425170">,</span>&nbsp;<span class="ident" id="3425172"><a href="/net/http/server.go.html#3420210">excludeHeader</a></span><span class="op" id="3425185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425188"><a href="/net/http/server.go.html#3420475">setHeader</a></span><span class="op" id="3425197">.</span><span class="ident" id="3425198">Write</span><span class="op" id="3425203">(</span><span class="ident" id="3425204"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3425205">.</span><span class="ident" id="3425206">conn</span><span class="op" id="3425210">.</span><span class="ident" id="3425211">buf</span><span class="op" id="3425214">.</span><span class="ident" id="3425215">Writer</span><span class="op" id="3425221">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425224"><a href="/net/http/server.go.html#3419747">w</a></span><span class="op" id="3425225">.</span><span class="ident" id="3425226">conn</span><span class="op" id="3425230">.</span><span class="ident" id="3425231">buf</span><span class="op" id="3425234">.</span><span class="ident" id="3425235">Write</span><span class="op" id="3425240">(</span><span class="ident" id="3425241"><a href="/net/http/server.go.html#3407220">crlf</a></span><span class="op" id="3425245">)</span><br>
<span class="lineno"></span><span class="op" id="3425247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3425250">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3425319">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3425387">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3425456">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3425524">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3425562">var</span>&nbsp;<span class="op" id="3425566">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425569">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3425581"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3425585">.</span><span class="ident" id="3425586">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425595">statusLines</span>&nbsp;<span class="op" id="3425607">=</span>&nbsp;<span class="builtinfunc" id="3425609">make</span><span class="op" id="3425613">(</span><span class="keyword" id="3425614">map</span><span class="op" id="3425617">[</span><span class="builtintype" id="3425618">int</span><span class="op" id="3425621">]</span><span class="builtintype" id="3425622">string</span><span class="op" id="3425628">)</span><br>
<span class="lineno"></span><span class="op" id="3425630">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3425633">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3425701">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3425752">func</span>&nbsp;<span class="ident" id="3425757">statusLine</span><span class="op" id="3425767">(</span><span class="ident" id="3425768">req</span>&nbsp;<span class="op" id="3425772">*</span><span class="ident" id="3425773"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3425780">,</span>&nbsp;<span class="ident" id="3425782">code</span>&nbsp;<span class="builtintype" id="3425787">int</span><span class="op" id="3425790">)</span>&nbsp;<span class="builtintype" id="3425792">string</span>&nbsp;<span class="op" id="3425799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3425802">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425817">key</span>&nbsp;<span class="op" id="3425821">:=</span>&nbsp;<span class="ident" id="3425824"><a href="/net/http/server.go.html#3425782">code</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425830">proto11</span>&nbsp;<span class="op" id="3425838">:=</span>&nbsp;<span class="ident" id="3425841"><a href="/net/http/server.go.html#3425768">req</a></span><span class="op" id="3425844">.</span><span class="ident" id="3425845">ProtoAtLeast</span><span class="op" id="3425857">(</span><span class="num" id="3425858">1</span><span class="op" id="3425859">,</span>&nbsp;<span class="num" id="3425861">1</span><span class="op" id="3425862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3425865">if</span>&nbsp;<span class="op" id="3425868">!</span><span class="ident" id="3425869"><a href="/net/http/server.go.html#3425830">proto11</a></span>&nbsp;<span class="op" id="3425877">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425881"><a href="/net/http/server.go.html#3425817">key</a></span>&nbsp;<span class="op" id="3425885">=</span>&nbsp;<span class="op" id="3425887">-</span><span class="ident" id="3425888"><a href="/net/http/server.go.html#3425817">key</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3425893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425896"><a href="/net/http/server.go.html#3425569">statusMu</a></span><span class="op" id="3425904">.</span><span class="ident" id="3425905">RLock</span><span class="op" id="3425910">(</span><span class="op" id="3425911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425914">line</span><span class="op" id="3425918">,</span>&nbsp;<span class="ident" id="3425920">ok</span>&nbsp;<span class="op" id="3425923">:=</span>&nbsp;<span class="ident" id="3425926"><a href="/net/http/server.go.html#3425595">statusLines</a></span><span class="op" id="3425937">[</span><span class="ident" id="3425938"><a href="/net/http/server.go.html#3425817">key</a></span><span class="op" id="3425941">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3425944"><a href="/net/http/server.go.html#3425569">statusMu</a></span><span class="op" id="3425952">.</span><span class="ident" id="3425953">RUnlock</span><span class="op" id="3425960">(</span><span class="op" id="3425961">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3425964">if</span>&nbsp;<span class="ident" id="3425967"><a href="/net/http/server.go.html#3425920">ok</a></span>&nbsp;<span class="op" id="3425970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3425974">return</span>&nbsp;<span class="ident" id="3425981"><a href="/net/http/server.go.html#3425914">line</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3425987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3425991">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426006">proto</span>&nbsp;<span class="op" id="3426012">:=</span>&nbsp;<span class="string" id="3426015">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426027">if</span>&nbsp;<span class="ident" id="3426030"><a href="/net/http/server.go.html#3425830">proto11</a></span>&nbsp;<span class="op" id="3426038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426042"><a href="/net/http/server.go.html#3426006">proto</a></span>&nbsp;<span class="op" id="3426048">=</span>&nbsp;<span class="string" id="3426050">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3426062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426065">codestring</span>&nbsp;<span class="op" id="3426076">:=</span>&nbsp;<span class="ident" id="3426079"><a href="/net/http/server.go.html#3399921">strconv</a></span><span class="op" id="3426086">.</span><span class="ident" id="3426087">Itoa</span><span class="op" id="3426091">(</span><span class="ident" id="3426092"><a href="/net/http/server.go.html#3425782">code</a></span><span class="op" id="3426096">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426099">text</span><span class="op" id="3426103">,</span>&nbsp;<span class="ident" id="3426105"><a href="/net/http/server.go.html#3425920">ok</a></span>&nbsp;<span class="op" id="3426108">:=</span>&nbsp;<span class="ident" id="3426111"><a href="/net/http/status.go.html#3468530">statusText</a></span><span class="op" id="3426121">[</span><span class="ident" id="3426122"><a href="/net/http/server.go.html#3425782">code</a></span><span class="op" id="3426126">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426129">if</span>&nbsp;<span class="op" id="3426132">!</span><span class="ident" id="3426133"><a href="/net/http/server.go.html#3425920">ok</a></span>&nbsp;<span class="op" id="3426136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426140"><a href="/net/http/server.go.html#3426099">text</a></span>&nbsp;<span class="op" id="3426145">=</span>&nbsp;<span class="string" id="3426147">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3426162">+</span>&nbsp;<span class="ident" id="3426164"><a href="/net/http/server.go.html#3426065">codestring</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3426176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426179"><a href="/net/http/server.go.html#3425914">line</a></span>&nbsp;<span class="op" id="3426184">=</span>&nbsp;<span class="ident" id="3426186"><a href="/net/http/server.go.html#3426006">proto</a></span>&nbsp;<span class="op" id="3426192">+</span>&nbsp;<span class="string" id="3426194">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3426198">+</span>&nbsp;<span class="ident" id="3426200"><a href="/net/http/server.go.html#3426065">codestring</a></span>&nbsp;<span class="op" id="3426211">+</span>&nbsp;<span class="string" id="3426213">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3426217">+</span>&nbsp;<span class="ident" id="3426219"><a href="/net/http/server.go.html#3426099">text</a></span>&nbsp;<span class="op" id="3426224">+</span>&nbsp;<span class="string" id="3426226">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426234">if</span>&nbsp;<span class="ident" id="3426237"><a href="/net/http/server.go.html#3425920">ok</a></span>&nbsp;<span class="op" id="3426240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426244"><a href="/net/http/server.go.html#3425569">statusMu</a></span><span class="op" id="3426252">.</span><span class="ident" id="3426253">Lock</span><span class="op" id="3426257">(</span><span class="op" id="3426258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426262">defer</span>&nbsp;<span class="ident" id="3426268"><a href="/net/http/server.go.html#3425569">statusMu</a></span><span class="op" id="3426276">.</span><span class="ident" id="3426277">Unlock</span><span class="op" id="3426283">(</span><span class="op" id="3426284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426288"><a href="/net/http/server.go.html#3425595">statusLines</a></span><span class="op" id="3426299">[</span><span class="ident" id="3426300"><a href="/net/http/server.go.html#3425817">key</a></span><span class="op" id="3426303">]</span>&nbsp;<span class="op" id="3426305">=</span>&nbsp;<span class="ident" id="3426307"><a href="/net/http/server.go.html#3425914">line</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3426313">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426316">return</span>&nbsp;<span class="ident" id="3426323"><a href="/net/http/server.go.html#3425914">line</a></span><br>
<span class="lineno"></span><span class="op" id="3426328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3426331">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3426405">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3426470">func</span>&nbsp;<span class="op" id="3426475">(</span><span class="ident" id="3426476">w</span>&nbsp;<span class="op" id="3426478">*</span><span class="ident" id="3426479"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3426487">)</span>&nbsp;<span class="ident" id="3426489">bodyAllowed</span><span class="op" id="3426500">(</span><span class="op" id="3426501">)</span>&nbsp;<span class="builtintype" id="3426503">bool</span>&nbsp;<span class="op" id="3426508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426511">if</span>&nbsp;<span class="op" id="3426514">!</span><span class="ident" id="3426515"><a href="/net/http/server.go.html#3426476">w</a></span><span class="op" id="3426516">.</span><span class="ident" id="3426517">wroteHeader</span>&nbsp;<span class="op" id="3426529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3426533">panic</span><span class="op" id="3426538">(</span><span class="string" id="3426539">&#34;&#34;</span><span class="op" id="3426541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3426544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3426547">return</span>&nbsp;<span class="ident" id="3426554"><a href="/net/http/transfer.go.html#3477643">bodyAllowedForStatus</a></span><span class="op" id="3426574">(</span><span class="ident" id="3426575"><a href="/net/http/server.go.html#3426476">w</a></span><span class="op" id="3426576">.</span><span class="ident" id="3426577">status</span><span class="op" id="3426583">)</span><br>
<span class="lineno">940</span><span class="op" id="3426585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3426588">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3426625">//</span><br>
<span class="lineno"></span><span class="comment" id="3426628">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3426695">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3426770">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3426814">//</span><br>
<span class="lineno"></span><span class="comment" id="3426817">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3426887">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3426955">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3427026">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3427052">//</span><br>
<span class="lineno"></span><span class="comment" id="3427055">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3427124">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3427161">//</span><br>
<span class="lineno"></span><span class="comment" id="3427164">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3427204">//</span><br>
<span class="lineno"></span><span class="comment" id="3427207">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3427247">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3427318">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3427393">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3427446">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3427515">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3427585">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3427652">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3427681">//</span><br>
<span class="lineno"></span><span class="comment" id="3427684">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3427748">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3427815">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3427883">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3427948">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3428018">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3428087">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3428158">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3428229">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3428251">func</span>&nbsp;<span class="op" id="3428256">(</span><span class="ident" id="3428257">w</span>&nbsp;<span class="op" id="3428259">*</span><span class="ident" id="3428260"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3428268">)</span>&nbsp;<span class="ident" id="3428270">Write</span><span class="op" id="3428275">(</span><span class="ident" id="3428276">data</span>&nbsp;<span class="op" id="3428281">[</span><span class="op" id="3428282">]</span><span class="builtintype" id="3428283">byte</span><span class="op" id="3428287">)</span>&nbsp;<span class="op" id="3428289">(</span><span class="ident" id="3428290">n</span>&nbsp;<span class="builtintype" id="3428292">int</span><span class="op" id="3428295">,</span>&nbsp;<span class="ident" id="3428297">err</span>&nbsp;<span class="builtintype" id="3428301">error</span><span class="op" id="3428306">)</span>&nbsp;<span class="op" id="3428308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428311">return</span>&nbsp;<span class="ident" id="3428318"><a href="/net/http/server.go.html#3428257">w</a></span><span class="op" id="3428319">.</span><span class="ident" id="3428320">write</span><span class="op" id="3428325">(</span><span class="builtinfunc" id="3428326">len</span><span class="op" id="3428329">(</span><span class="ident" id="3428330"><a href="/net/http/server.go.html#3428276">data</a></span><span class="op" id="3428334">)</span><span class="op" id="3428335">,</span>&nbsp;<span class="ident" id="3428337"><a href="/net/http/server.go.html#3428276">data</a></span><span class="op" id="3428341">,</span>&nbsp;<span class="string" id="3428343">&#34;&#34;</span><span class="op" id="3428345">)</span><br>
<span class="lineno"></span><span class="op" id="3428347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3428350">func</span>&nbsp;<span class="op" id="3428355">(</span><span class="ident" id="3428356">w</span>&nbsp;<span class="op" id="3428358">*</span><span class="ident" id="3428359"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3428367">)</span>&nbsp;<span class="ident" id="3428369">WriteString</span><span class="op" id="3428380">(</span><span class="ident" id="3428381">data</span>&nbsp;<span class="builtintype" id="3428386">string</span><span class="op" id="3428392">)</span>&nbsp;<span class="op" id="3428394">(</span><span class="ident" id="3428395">n</span>&nbsp;<span class="builtintype" id="3428397">int</span><span class="op" id="3428400">,</span>&nbsp;<span class="ident" id="3428402">err</span>&nbsp;<span class="builtintype" id="3428406">error</span><span class="op" id="3428411">)</span>&nbsp;<span class="op" id="3428413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428416">return</span>&nbsp;<span class="ident" id="3428423"><a href="/net/http/server.go.html#3428356">w</a></span><span class="op" id="3428424">.</span><span class="ident" id="3428425">write</span><span class="op" id="3428430">(</span><span class="builtinfunc" id="3428431">len</span><span class="op" id="3428434">(</span><span class="ident" id="3428435"><a href="/net/http/server.go.html#3428381">data</a></span><span class="op" id="3428439">)</span><span class="op" id="3428440">,</span>&nbsp;<span class="ident" id="3428442">nil</span><span class="op" id="3428445">,</span>&nbsp;<span class="ident" id="3428447"><a href="/net/http/server.go.html#3428381">data</a></span><span class="op" id="3428451">)</span><br>
<span class="lineno"></span><span class="op" id="3428453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3428456">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3428494">func</span>&nbsp;<span class="op" id="3428499">(</span><span class="ident" id="3428500">w</span>&nbsp;<span class="op" id="3428502">*</span><span class="ident" id="3428503"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3428511">)</span>&nbsp;<span class="ident" id="3428513">write</span><span class="op" id="3428518">(</span><span class="ident" id="3428519">lenData</span>&nbsp;<span class="builtintype" id="3428527">int</span><span class="op" id="3428530">,</span>&nbsp;<span class="ident" id="3428532">dataB</span>&nbsp;<span class="op" id="3428538">[</span><span class="op" id="3428539">]</span><span class="builtintype" id="3428540">byte</span><span class="op" id="3428544">,</span>&nbsp;<span class="ident" id="3428546">dataS</span>&nbsp;<span class="builtintype" id="3428552">string</span><span class="op" id="3428558">)</span>&nbsp;<span class="op" id="3428560">(</span><span class="ident" id="3428561">n</span>&nbsp;<span class="builtintype" id="3428563">int</span><span class="op" id="3428566">,</span>&nbsp;<span class="ident" id="3428568">err</span>&nbsp;<span class="builtintype" id="3428572">error</span><span class="op" id="3428577">)</span>&nbsp;<span class="op" id="3428579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428582">if</span>&nbsp;<span class="ident" id="3428585"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428586">.</span><span class="ident" id="3428587">conn</span><span class="op" id="3428591">.</span><span class="ident" id="3428592">hijacked</span><span class="op" id="3428600">(</span><span class="op" id="3428601">)</span>&nbsp;<span class="op" id="3428603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428607"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428608">.</span><span class="ident" id="3428609">conn</span><span class="op" id="3428613">.</span><span class="ident" id="3428614">server</span><span class="op" id="3428620">.</span><span class="ident" id="3428621">logf</span><span class="op" id="3428625">(</span><span class="string" id="3428626">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3428671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428675">return</span>&nbsp;<span class="num" id="3428682">0</span><span class="op" id="3428683">,</span>&nbsp;<span class="ident" id="3428685"><a href="/net/http/server.go.html#3400191">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428698">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428701">if</span>&nbsp;<span class="op" id="3428704">!</span><span class="ident" id="3428705"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428706">.</span><span class="ident" id="3428707">wroteHeader</span>&nbsp;<span class="op" id="3428719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428723"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428724">.</span><span class="ident" id="3428725">WriteHeader</span><span class="op" id="3428736">(</span><span class="ident" id="3428737"><a href="/net/http/status.go.html#3466742">StatusOK</a></span><span class="op" id="3428745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428751">if</span>&nbsp;<span class="ident" id="3428754"><a href="/net/http/server.go.html#3428519">lenData</a></span>&nbsp;<span class="op" id="3428762">==</span>&nbsp;<span class="num" id="3428765">0</span>&nbsp;<span class="op" id="3428767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428771">return</span>&nbsp;<span class="num" id="3428778">0</span><span class="op" id="3428779">,</span>&nbsp;<span class="ident" id="3428781">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428789">if</span>&nbsp;<span class="op" id="3428792">!</span><span class="ident" id="3428793"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428794">.</span><span class="ident" id="3428795">bodyAllowed</span><span class="op" id="3428806">(</span><span class="op" id="3428807">)</span>&nbsp;<span class="op" id="3428809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428813">return</span>&nbsp;<span class="num" id="3428820">0</span><span class="op" id="3428821">,</span>&nbsp;<span class="ident" id="3428823"><a href="/net/http/server.go.html#3400090">ErrBodyNotAllowed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428846"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428847">.</span><span class="ident" id="3428848">written</span>&nbsp;<span class="op" id="3428856">+=</span>&nbsp;<span class="ident" id="3428859">int64</span><span class="op" id="3428864">(</span><span class="ident" id="3428865"><a href="/net/http/server.go.html#3428519">lenData</a></span><span class="op" id="3428872">)</span>&nbsp;<span class="comment" id="3428874">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428911">if</span>&nbsp;<span class="ident" id="3428914"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428915">.</span><span class="ident" id="3428916">contentLength</span>&nbsp;<span class="op" id="3428930">!=</span>&nbsp;<span class="op" id="3428933">-</span><span class="num" id="3428934">1</span>&nbsp;<span class="op" id="3428936">&amp;&amp;</span>&nbsp;<span class="ident" id="3428939"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428940">.</span><span class="ident" id="3428941">written</span>&nbsp;<span class="op" id="3428949">&gt;</span>&nbsp;<span class="ident" id="3428951"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3428952">.</span><span class="ident" id="3428953">contentLength</span>&nbsp;<span class="op" id="3428967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428971">return</span>&nbsp;<span class="num" id="3428978">0</span><span class="op" id="3428979">,</span>&nbsp;<span class="ident" id="3428981"><a href="/net/http/server.go.html#3400250">ErrContentLength</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429002">if</span>&nbsp;<span class="ident" id="3429005"><a href="/net/http/server.go.html#3428532">dataB</a></span>&nbsp;<span class="op" id="3429011">!=</span>&nbsp;<span class="ident" id="3429014">nil</span>&nbsp;<span class="op" id="3429018">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429022">return</span>&nbsp;<span class="ident" id="3429029"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3429030">.</span><span class="ident" id="3429031">w</span><span class="op" id="3429032">.</span><span class="ident" id="3429033">Write</span><span class="op" id="3429038">(</span><span class="ident" id="3429039"><a href="/net/http/server.go.html#3428532">dataB</a></span><span class="op" id="3429044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429047">}</span>&nbsp;<span class="keyword" id="3429049">else</span>&nbsp;<span class="op" id="3429054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429058">return</span>&nbsp;<span class="ident" id="3429065"><a href="/net/http/server.go.html#3428500">w</a></span><span class="op" id="3429066">.</span><span class="ident" id="3429067">w</span><span class="op" id="3429068">.</span><span class="ident" id="3429069">WriteString</span><span class="op" id="3429080">(</span><span class="ident" id="3429081"><a href="/net/http/server.go.html#3428546">dataS</a></span><span class="op" id="3429086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429089">}</span><br>
<span class="lineno"></span><span class="op" id="3429091">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3429094">func</span>&nbsp;<span class="op" id="3429099">(</span><span class="ident" id="3429100">w</span>&nbsp;<span class="op" id="3429102">*</span><span class="ident" id="3429103"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3429111">)</span>&nbsp;<span class="ident" id="3429113">finishRequest</span><span class="op" id="3429126">(</span><span class="op" id="3429127">)</span>&nbsp;<span class="op" id="3429129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429132"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429133">.</span><span class="ident" id="3429134">handlerDone</span>&nbsp;<span class="op" id="3429146">=</span>&nbsp;<span class="builtintype" id="3429148">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429155">if</span>&nbsp;<span class="op" id="3429158">!</span><span class="ident" id="3429159"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429160">.</span><span class="ident" id="3429161">wroteHeader</span>&nbsp;<span class="op" id="3429173">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429177"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429178">.</span><span class="ident" id="3429179">WriteHeader</span><span class="op" id="3429190">(</span><span class="ident" id="3429191"><a href="/net/http/status.go.html#3466742">StatusOK</a></span><span class="op" id="3429199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429206"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429207">.</span><span class="ident" id="3429208">w</span><span class="op" id="3429209">.</span><span class="ident" id="3429210">Flush</span><span class="op" id="3429215">(</span><span class="op" id="3429216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429219"><a href="/net/http/server.go.html#3413358">putBufioWriter</a></span><span class="op" id="3429233">(</span><span class="ident" id="3429234"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429235">.</span><span class="ident" id="3429236">w</span><span class="op" id="3429237">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429240"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429241">.</span><span class="ident" id="3429242">cw</span><span class="op" id="3429244">.</span><span class="builtinfunc" id="3429245">close</span><span class="op" id="3429250">(</span><span class="op" id="3429251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429254"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429255">.</span><span class="ident" id="3429256">conn</span><span class="op" id="3429260">.</span><span class="ident" id="3429261">buf</span><span class="op" id="3429264">.</span><span class="ident" id="3429265">Flush</span><span class="op" id="3429270">(</span><span class="op" id="3429271">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429275">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429338">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429380"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429381">.</span><span class="ident" id="3429382">req</span><span class="op" id="3429385">.</span><span class="ident" id="3429386">Body</span><span class="op" id="3429390">.</span><span class="ident" id="3429391">Close</span><span class="op" id="3429396">(</span><span class="op" id="3429397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429401">if</span>&nbsp;<span class="ident" id="3429404"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429405">.</span><span class="ident" id="3429406">req</span><span class="op" id="3429409">.</span><span class="ident" id="3429410">MultipartForm</span>&nbsp;<span class="op" id="3429424">!=</span>&nbsp;<span class="ident" id="3429427">nil</span>&nbsp;<span class="op" id="3429431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429435"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429436">.</span><span class="ident" id="3429437">req</span><span class="op" id="3429440">.</span><span class="ident" id="3429441">MultipartForm</span><span class="op" id="3429454">.</span><span class="ident" id="3429455">RemoveAll</span><span class="op" id="3429464">(</span><span class="op" id="3429465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429468">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429472">if</span>&nbsp;<span class="ident" id="3429475"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429476">.</span><span class="ident" id="3429477">req</span><span class="op" id="3429480">.</span><span class="ident" id="3429481">Method</span>&nbsp;<span class="op" id="3429488">!=</span>&nbsp;<span class="string" id="3429491">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3429498">&amp;&amp;</span>&nbsp;<span class="ident" id="3429501"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429502">.</span><span class="ident" id="3429503">contentLength</span>&nbsp;<span class="op" id="3429517">!=</span>&nbsp;<span class="op" id="3429520">-</span><span class="num" id="3429521">1</span>&nbsp;<span class="op" id="3429523">&amp;&amp;</span>&nbsp;<span class="ident" id="3429526"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429527">.</span><span class="ident" id="3429528">bodyAllowed</span><span class="op" id="3429539">(</span><span class="op" id="3429540">)</span>&nbsp;<span class="op" id="3429542">&amp;&amp;</span>&nbsp;<span class="ident" id="3429545"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429546">.</span><span class="ident" id="3429547">contentLength</span>&nbsp;<span class="op" id="3429561">!=</span>&nbsp;<span class="ident" id="3429564"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429565">.</span><span class="ident" id="3429566">written</span>&nbsp;<span class="op" id="3429574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429578">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429632"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429633">.</span><span class="ident" id="3429634">closeAfterReply</span>&nbsp;<span class="op" id="3429650">=</span>&nbsp;<span class="builtintype" id="3429652">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429658">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429662">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429724">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429775">if</span>&nbsp;<span class="ident" id="3429778"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429779">.</span><span class="ident" id="3429780">conn</span><span class="op" id="3429784">.</span><span class="ident" id="3429785">werr</span>&nbsp;<span class="op" id="3429790">!=</span>&nbsp;<span class="ident" id="3429793">nil</span>&nbsp;<span class="op" id="3429797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429801"><a href="/net/http/server.go.html#3429100">w</a></span><span class="op" id="3429802">.</span><span class="ident" id="3429803">closeAfterReply</span>&nbsp;<span class="op" id="3429819">=</span>&nbsp;<span class="builtintype" id="3429821">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429827">}</span><br>
<span class="lineno"></span><span class="op" id="3429829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3429832">func</span>&nbsp;<span class="op" id="3429837">(</span><span class="ident" id="3429838">w</span>&nbsp;<span class="op" id="3429840">*</span><span class="ident" id="3429841"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3429849">)</span>&nbsp;<span class="ident" id="3429851">Flush</span><span class="op" id="3429856">(</span><span class="op" id="3429857">)</span>&nbsp;<span class="op" id="3429859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429862">if</span>&nbsp;<span class="op" id="3429865">!</span><span class="ident" id="3429866"><a href="/net/http/server.go.html#3429838">w</a></span><span class="op" id="3429867">.</span><span class="ident" id="3429868">wroteHeader</span>&nbsp;<span class="op" id="3429880">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429884"><a href="/net/http/server.go.html#3429838">w</a></span><span class="op" id="3429885">.</span><span class="ident" id="3429886">WriteHeader</span><span class="op" id="3429897">(</span><span class="ident" id="3429898"><a href="/net/http/status.go.html#3466742">StatusOK</a></span><span class="op" id="3429906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429912"><a href="/net/http/server.go.html#3429838">w</a></span><span class="op" id="3429913">.</span><span class="ident" id="3429914">w</span><span class="op" id="3429915">.</span><span class="ident" id="3429916">Flush</span><span class="op" id="3429921">(</span><span class="op" id="3429922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429925"><a href="/net/http/server.go.html#3429838">w</a></span><span class="op" id="3429926">.</span><span class="ident" id="3429927">cw</span><span class="op" id="3429929">.</span><span class="ident" id="3429930">flush</span><span class="op" id="3429935">(</span><span class="op" id="3429936">)</span><br>
<span class="lineno"></span><span class="op" id="3429938">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3429941">func</span>&nbsp;<span class="op" id="3429946">(</span><span class="ident" id="3429947">c</span>&nbsp;<span class="op" id="3429949">*</span><span class="ident" id="3429950"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3429954">)</span>&nbsp;<span class="ident" id="3429956">finalFlush</span><span class="op" id="3429966">(</span><span class="op" id="3429967">)</span>&nbsp;<span class="op" id="3429969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429972">if</span>&nbsp;<span class="ident" id="3429975"><a href="/net/http/server.go.html#3429947">c</a></span><span class="op" id="3429976">.</span><span class="ident" id="3429977">buf</span>&nbsp;<span class="op" id="3429981">!=</span>&nbsp;<span class="ident" id="3429984">nil</span>&nbsp;<span class="op" id="3429988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429992"><a href="/net/http/server.go.html#3429947">c</a></span><span class="op" id="3429993">.</span><span class="ident" id="3429994">buf</span><span class="op" id="3429997">.</span><span class="ident" id="3429998">Flush</span><span class="op" id="3430003">(</span><span class="op" id="3430004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430009">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430079">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430116"><a href="/net/http/server.go.html#3413028">putBufioReader</a></span><span class="op" id="3430130">(</span><span class="ident" id="3430131"><a href="/net/http/server.go.html#3429947">c</a></span><span class="op" id="3430132">.</span><span class="ident" id="3430133">buf</span><span class="op" id="3430136">.</span><span class="ident" id="3430137">Reader</span><span class="op" id="3430143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430148">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430218">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430255"><a href="/net/http/server.go.html#3413358">putBufioWriter</a></span><span class="op" id="3430269">(</span><span class="ident" id="3430270"><a href="/net/http/server.go.html#3429947">c</a></span><span class="op" id="3430271">.</span><span class="ident" id="3430272">buf</span><span class="op" id="3430275">.</span><span class="ident" id="3430276">Writer</span><span class="op" id="3430282">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430287"><a href="/net/http/server.go.html#3429947">c</a></span><span class="op" id="3430288">.</span><span class="ident" id="3430289">buf</span>&nbsp;<span class="op" id="3430293">=</span>&nbsp;<span class="ident" id="3430295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430300">}</span><br>
<span class="lineno">1065</span><span class="op" id="3430302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3430305">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3430330">func</span>&nbsp;<span class="op" id="3430335">(</span><span class="ident" id="3430336">c</span>&nbsp;<span class="op" id="3430338">*</span><span class="ident" id="3430339"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3430343">)</span>&nbsp;<span class="builtinfunc" id="3430345">close</span><span class="op" id="3430350">(</span><span class="op" id="3430351">)</span>&nbsp;<span class="op" id="3430353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430356"><a href="/net/http/server.go.html#3430336">c</a></span><span class="op" id="3430357">.</span><span class="ident" id="3430358">finalFlush</span><span class="op" id="3430368">(</span><span class="op" id="3430369">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430372">if</span>&nbsp;<span class="ident" id="3430375"><a href="/net/http/server.go.html#3430336">c</a></span><span class="op" id="3430376">.</span><span class="ident" id="3430377">rwc</span>&nbsp;<span class="op" id="3430381">!=</span>&nbsp;<span class="ident" id="3430384">nil</span>&nbsp;<span class="op" id="3430388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430392"><a href="/net/http/server.go.html#3430336">c</a></span><span class="op" id="3430393">.</span><span class="ident" id="3430394">rwc</span><span class="op" id="3430397">.</span><span class="ident" id="3430398">Close</span><span class="op" id="3430403">(</span><span class="op" id="3430404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430408"><a href="/net/http/server.go.html#3430336">c</a></span><span class="op" id="3430409">.</span><span class="ident" id="3430410">rwc</span>&nbsp;<span class="op" id="3430414">=</span>&nbsp;<span class="ident" id="3430416">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430421">}</span><br>
<span class="lineno"></span><span class="op" id="3430423">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3430426">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3430496">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3430564">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3430633">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3430704">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3430757">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3430822">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3430890">const</span>&nbsp;<span class="ident" id="3430896">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3430914">=</span>&nbsp;<span class="num" id="3430916">500</span>&nbsp;<span class="op" id="3430920">*</span>&nbsp;<span class="ident" id="3430922"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3430926">.</span><span class="ident" id="3430927">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3430940">type</span>&nbsp;<span class="ident" id="3430945">closeWriter</span>&nbsp;<span class="keyword" id="3430957">interface</span>&nbsp;<span class="op" id="3430967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430970">CloseWrite</span><span class="op" id="3430980">(</span><span class="op" id="3430981">)</span>&nbsp;<span class="builtintype" id="3430983">error</span><br>
<span class="lineno"></span><span class="op" id="3430989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3430992">var</span>&nbsp;<span class="ident" id="3430996">_</span>&nbsp;<span class="ident" id="3430998"><a href="/net/http/server.go.html#3430945">closeWriter</a></span>&nbsp;<span class="op" id="3431010">=</span>&nbsp;<span class="op" id="3431012">(</span><span class="op" id="3431013">*</span><span class="ident" id="3431014"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3431017">.</span><span class="ident" id="3431018">TCPConn</span><span class="op" id="3431025">)</span><span class="op" id="3431026">(</span><span class="ident" id="3431027">nil</span><span class="op" id="3431030">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3431033">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3431103">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3431173">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3431235">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3431254">//</span><br>
<span class="lineno"></span><span class="comment" id="3431257">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3431293">func</span>&nbsp;<span class="op" id="3431298">(</span><span class="ident" id="3431299">c</span>&nbsp;<span class="op" id="3431301">*</span><span class="ident" id="3431302"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3431306">)</span>&nbsp;<span class="ident" id="3431308">closeWriteAndWait</span><span class="op" id="3431325">(</span><span class="op" id="3431326">)</span>&nbsp;<span class="op" id="3431328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431331"><a href="/net/http/server.go.html#3431299">c</a></span><span class="op" id="3431332">.</span><span class="ident" id="3431333">finalFlush</span><span class="op" id="3431343">(</span><span class="op" id="3431344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431347">if</span>&nbsp;<span class="ident" id="3431350">tcp</span><span class="op" id="3431353">,</span>&nbsp;<span class="ident" id="3431355">ok</span>&nbsp;<span class="op" id="3431358">:=</span>&nbsp;<span class="ident" id="3431361"><a href="/net/http/server.go.html#3431299">c</a></span><span class="op" id="3431362">.</span><span class="ident" id="3431363">rwc</span><span class="op" id="3431366">.</span><span class="op" id="3431367">(</span><span class="ident" id="3431368"><a href="/net/http/server.go.html#3430945">closeWriter</a></span><span class="op" id="3431379">)</span><span class="op" id="3431380">;</span>&nbsp;<span class="ident" id="3431382"><a href="/net/http/server.go.html#3431355">ok</a></span>&nbsp;<span class="op" id="3431385">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431389"><a href="/net/http/server.go.html#3431350">tcp</a></span><span class="op" id="3431392">.</span><span class="ident" id="3431393">CloseWrite</span><span class="op" id="3431403">(</span><span class="op" id="3431404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431410"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3431414">.</span><span class="ident" id="3431415">Sleep</span><span class="op" id="3431420">(</span><span class="ident" id="3431421"><a href="/net/http/server.go.html#3430896">rstAvoidanceDelay</a></span><span class="op" id="3431438">)</span><br>
<span class="lineno"></span><span class="op" id="3431440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3431443">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3431507">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3431576">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3431634">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3431654">func</span>&nbsp;<span class="ident" id="3431659">validNPN</span><span class="op" id="3431667">(</span><span class="ident" id="3431668">proto</span>&nbsp;<span class="builtintype" id="3431674">string</span><span class="op" id="3431680">)</span>&nbsp;<span class="builtintype" id="3431682">bool</span>&nbsp;<span class="op" id="3431687">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431690">switch</span>&nbsp;<span class="ident" id="3431697"><a href="/net/http/server.go.html#3431668">proto</a></span>&nbsp;<span class="op" id="3431703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431706">case</span>&nbsp;<span class="string" id="3431711">&#34;&#34;</span><span class="op" id="3431713">,</span>&nbsp;<span class="string" id="3431715">&#34;http/1.1&#34;</span><span class="op" id="3431725">,</span>&nbsp;<span class="string" id="3431727">&#34;http/1.0&#34;</span><span class="op" id="3431737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431741">return</span>&nbsp;<span class="builtintype" id="3431748">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431758">return</span>&nbsp;<span class="builtintype" id="3431765">true</span><br>
<span class="lineno">1115</span><span class="op" id="3431770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3431773">func</span>&nbsp;<span class="op" id="3431778">(</span><span class="ident" id="3431779">c</span>&nbsp;<span class="op" id="3431781">*</span><span class="ident" id="3431782"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3431786">)</span>&nbsp;<span class="ident" id="3431788">setState</span><span class="op" id="3431796">(</span><span class="ident" id="3431797">nc</span>&nbsp;<span class="ident" id="3431800"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3431803">.</span><span class="ident" id="3431804">Conn</span><span class="op" id="3431808">,</span>&nbsp;<span class="ident" id="3431810">state</span>&nbsp;<span class="ident" id="3431816"><a href="/net/http/server.go.html#3448712">ConnState</a></span><span class="op" id="3431825">)</span>&nbsp;<span class="op" id="3431827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431830">if</span>&nbsp;<span class="ident" id="3431833">hook</span>&nbsp;<span class="op" id="3431838">:=</span>&nbsp;<span class="ident" id="3431841"><a href="/net/http/server.go.html#3431779">c</a></span><span class="op" id="3431842">.</span><span class="ident" id="3431843">server</span><span class="op" id="3431849">.</span><span class="ident" id="3431850">ConnState</span><span class="op" id="3431859">;</span>&nbsp;<span class="ident" id="3431861"><a href="/net/http/server.go.html#3431833">hook</a></span>&nbsp;<span class="op" id="3431866">!=</span>&nbsp;<span class="ident" id="3431869">nil</span>&nbsp;<span class="op" id="3431873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431877"><a href="/net/http/server.go.html#3431833">hook</a></span><span class="op" id="3431881">(</span><span class="ident" id="3431882"><a href="/net/http/server.go.html#3431797">nc</a></span><span class="op" id="3431884">,</span>&nbsp;<span class="ident" id="3431886"><a href="/net/http/server.go.html#3431810">state</a></span><span class="op" id="3431891">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431894">}</span><br>
<span class="lineno"></span><span class="op" id="3431896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3431899">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3431926">func</span>&nbsp;<span class="op" id="3431931">(</span><span class="ident" id="3431932">c</span>&nbsp;<span class="op" id="3431934">*</span><span class="ident" id="3431935"><a href="/net/http/server.go.html#3403324">conn</a></span><span class="op" id="3431939">)</span>&nbsp;<span class="ident" id="3431941">serve</span><span class="op" id="3431946">(</span><span class="op" id="3431947">)</span>&nbsp;<span class="op" id="3431949">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431952">origConn</span>&nbsp;<span class="op" id="3431961">:=</span>&nbsp;<span class="ident" id="3431964"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3431965">.</span><span class="ident" id="3431966">rwc</span>&nbsp;<span class="comment" id="3431970">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432021">defer</span>&nbsp;<span class="keyword" id="3432027">func</span><span class="op" id="3432031">(</span><span class="op" id="3432032">)</span>&nbsp;<span class="op" id="3432034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432038">if</span>&nbsp;<span class="ident" id="3432041">err</span>&nbsp;<span class="op" id="3432045">:=</span>&nbsp;<span class="builtinfunc" id="3432048">recover</span><span class="op" id="3432055">(</span><span class="op" id="3432056">)</span><span class="op" id="3432057">;</span>&nbsp;<span class="ident" id="3432059"><a href="/net/http/server.go.html#3432041">err</a></span>&nbsp;<span class="op" id="3432063">!=</span>&nbsp;<span class="ident" id="3432066">nil</span>&nbsp;<span class="op" id="3432070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432075">const</span>&nbsp;<span class="ident" id="3432081">size</span>&nbsp;<span class="op" id="3432086">=</span>&nbsp;<span class="num" id="3432088">64</span>&nbsp;<span class="op" id="3432091">&lt;&lt;</span>&nbsp;<span class="num" id="3432094">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432100">buf</span>&nbsp;<span class="op" id="3432104">:=</span>&nbsp;<span class="builtinfunc" id="3432107">make</span><span class="op" id="3432111">(</span><span class="op" id="3432112">[</span><span class="op" id="3432113">]</span><span class="builtintype" id="3432114">byte</span><span class="op" id="3432118">,</span>&nbsp;<span class="ident" id="3432120"><a href="/net/http/server.go.html#3432081">size</a></span><span class="op" id="3432124">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432129"><a href="/net/http/server.go.html#3432100">buf</a></span>&nbsp;<span class="op" id="3432133">=</span>&nbsp;<span class="ident" id="3432135"><a href="/net/http/server.go.html#3432100">buf</a></span><span class="op" id="3432138">[</span><span class="op" id="3432139">:</span><span class="ident" id="3432140"><a href="/net/http/server.go.html#3399910">runtime</a></span><span class="op" id="3432147">.</span><span class="ident" id="3432148">Stack</span><span class="op" id="3432153">(</span><span class="ident" id="3432154"><a href="/net/http/server.go.html#3432100">buf</a></span><span class="op" id="3432157">,</span>&nbsp;<span class="builtintype" id="3432159">false</span><span class="op" id="3432164">)</span><span class="op" id="3432165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432170"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432171">.</span><span class="ident" id="3432172">server</span><span class="op" id="3432178">.</span><span class="ident" id="3432179">logf</span><span class="op" id="3432183">(</span><span class="string" id="3432184">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3432216">,</span>&nbsp;<span class="ident" id="3432218"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432219">.</span><span class="ident" id="3432220">remoteAddr</span><span class="op" id="3432230">,</span>&nbsp;<span class="ident" id="3432232"><a href="/net/http/server.go.html#3432041">err</a></span><span class="op" id="3432235">,</span>&nbsp;<span class="ident" id="3432237"><a href="/net/http/server.go.html#3432100">buf</a></span><span class="op" id="3432240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432248">if</span>&nbsp;<span class="op" id="3432251">!</span><span class="ident" id="3432252"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432253">.</span><span class="ident" id="3432254">hijacked</span><span class="op" id="3432262">(</span><span class="op" id="3432263">)</span>&nbsp;<span class="op" id="3432265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432270"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432271">.</span><span class="builtinfunc" id="3432272">close</span><span class="op" id="3432277">(</span><span class="op" id="3432278">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432283"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432284">.</span><span class="ident" id="3432285">setState</span><span class="op" id="3432293">(</span><span class="ident" id="3432294"><a href="/net/http/server.go.html#3431952">origConn</a></span><span class="op" id="3432302">,</span>&nbsp;<span class="ident" id="3432304"><a href="/net/http/server.go.html#3449826">StateClosed</a></span><span class="op" id="3432315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432322">}</span><span class="op" id="3432323">(</span><span class="op" id="3432324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432328">if</span>&nbsp;<span class="ident" id="3432331">tlsConn</span><span class="op" id="3432338">,</span>&nbsp;<span class="ident" id="3432340">ok</span>&nbsp;<span class="op" id="3432343">:=</span>&nbsp;<span class="ident" id="3432346"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432347">.</span><span class="ident" id="3432348">rwc</span><span class="op" id="3432351">.</span><span class="op" id="3432352">(</span><span class="op" id="3432353">*</span><span class="ident" id="3432354"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3432357">.</span><span class="ident" id="3432358">Conn</span><span class="op" id="3432362">)</span><span class="op" id="3432363">;</span>&nbsp;<span class="ident" id="3432365"><a href="/net/http/server.go.html#3432340">ok</a></span>&nbsp;<span class="op" id="3432368">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432372">if</span>&nbsp;<span class="ident" id="3432375">d</span>&nbsp;<span class="op" id="3432377">:=</span>&nbsp;<span class="ident" id="3432380"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432381">.</span><span class="ident" id="3432382">server</span><span class="op" id="3432388">.</span><span class="ident" id="3432389">ReadTimeout</span><span class="op" id="3432400">;</span>&nbsp;<span class="ident" id="3432402"><a href="/net/http/server.go.html#3432375">d</a></span>&nbsp;<span class="op" id="3432404">!=</span>&nbsp;<span class="num" id="3432407">0</span>&nbsp;<span class="op" id="3432409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432414"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432415">.</span><span class="ident" id="3432416">rwc</span><span class="op" id="3432419">.</span><span class="ident" id="3432420">SetReadDeadline</span><span class="op" id="3432435">(</span><span class="ident" id="3432436"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3432440">.</span><span class="ident" id="3432441">Now</span><span class="op" id="3432444">(</span><span class="op" id="3432445">)</span><span class="op" id="3432446">.</span><span class="ident" id="3432447">Add</span><span class="op" id="3432450">(</span><span class="ident" id="3432451"><a href="/net/http/server.go.html#3432375">d</a></span><span class="op" id="3432452">)</span><span class="op" id="3432453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432461">if</span>&nbsp;<span class="ident" id="3432464">d</span>&nbsp;<span class="op" id="3432466">:=</span>&nbsp;<span class="ident" id="3432469"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432470">.</span><span class="ident" id="3432471">server</span><span class="op" id="3432477">.</span><span class="ident" id="3432478">WriteTimeout</span><span class="op" id="3432490">;</span>&nbsp;<span class="ident" id="3432492"><a href="/net/http/server.go.html#3432464">d</a></span>&nbsp;<span class="op" id="3432494">!=</span>&nbsp;<span class="num" id="3432497">0</span>&nbsp;<span class="op" id="3432499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432504"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432505">.</span><span class="ident" id="3432506">rwc</span><span class="op" id="3432509">.</span><span class="ident" id="3432510">SetWriteDeadline</span><span class="op" id="3432526">(</span><span class="ident" id="3432527"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3432531">.</span><span class="ident" id="3432532">Now</span><span class="op" id="3432535">(</span><span class="op" id="3432536">)</span><span class="op" id="3432537">.</span><span class="ident" id="3432538">Add</span><span class="op" id="3432541">(</span><span class="ident" id="3432542"><a href="/net/http/server.go.html#3432464">d</a></span><span class="op" id="3432543">)</span><span class="op" id="3432544">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432552">if</span>&nbsp;<span class="ident" id="3432555">err</span>&nbsp;<span class="op" id="3432559">:=</span>&nbsp;<span class="ident" id="3432562"><a href="/net/http/server.go.html#3432331">tlsConn</a></span><span class="op" id="3432569">.</span><span class="ident" id="3432570">Handshake</span><span class="op" id="3432579">(</span><span class="op" id="3432580">)</span><span class="op" id="3432581">;</span>&nbsp;<span class="ident" id="3432583"><a href="/net/http/server.go.html#3432555">err</a></span>&nbsp;<span class="op" id="3432587">!=</span>&nbsp;<span class="ident" id="3432590">nil</span>&nbsp;<span class="op" id="3432594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432599"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432600">.</span><span class="ident" id="3432601">server</span><span class="op" id="3432607">.</span><span class="ident" id="3432608">logf</span><span class="op" id="3432612">(</span><span class="string" id="3432613">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3432652">,</span>&nbsp;<span class="ident" id="3432654"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432655">.</span><span class="ident" id="3432656">rwc</span><span class="op" id="3432659">.</span><span class="ident" id="3432660">RemoteAddr</span><span class="op" id="3432670">(</span><span class="op" id="3432671">)</span><span class="op" id="3432672">,</span>&nbsp;<span class="ident" id="3432674"><a href="/net/http/server.go.html#3432555">err</a></span><span class="op" id="3432677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432682">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432691">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432695"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432696">.</span><span class="ident" id="3432697">tlsState</span>&nbsp;<span class="op" id="3432706">=</span>&nbsp;<span class="builtinfunc" id="3432708">new</span><span class="op" id="3432711">(</span><span class="ident" id="3432712"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3432715">.</span><span class="ident" id="3432716">ConnectionState</span><span class="op" id="3432731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432735">*</span><span class="ident" id="3432736"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432737">.</span><span class="ident" id="3432738">tlsState</span>&nbsp;<span class="op" id="3432747">=</span>&nbsp;<span class="ident" id="3432749"><a href="/net/http/server.go.html#3432331">tlsConn</a></span><span class="op" id="3432756">.</span><span class="ident" id="3432757">ConnectionState</span><span class="op" id="3432772">(</span><span class="op" id="3432773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432777">if</span>&nbsp;<span class="ident" id="3432780">proto</span>&nbsp;<span class="op" id="3432786">:=</span>&nbsp;<span class="ident" id="3432789"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432790">.</span><span class="ident" id="3432791">tlsState</span><span class="op" id="3432799">.</span><span class="ident" id="3432800">NegotiatedProtocol</span><span class="op" id="3432818">;</span>&nbsp;<span class="ident" id="3432820"><a href="/net/http/server.go.html#3431659">validNPN</a></span><span class="op" id="3432828">(</span><span class="ident" id="3432829"><a href="/net/http/server.go.html#3432780">proto</a></span><span class="op" id="3432834">)</span>&nbsp;<span class="op" id="3432836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432841">if</span>&nbsp;<span class="ident" id="3432844">fn</span>&nbsp;<span class="op" id="3432847">:=</span>&nbsp;<span class="ident" id="3432850"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432851">.</span><span class="ident" id="3432852">server</span><span class="op" id="3432858">.</span><span class="ident" id="3432859">TLSNextProto</span><span class="op" id="3432871">[</span><span class="ident" id="3432872"><a href="/net/http/server.go.html#3432780">proto</a></span><span class="op" id="3432877">]</span><span class="op" id="3432878">;</span>&nbsp;<span class="ident" id="3432880"><a href="/net/http/server.go.html#3432844">fn</a></span>&nbsp;<span class="op" id="3432883">!=</span>&nbsp;<span class="ident" id="3432886">nil</span>&nbsp;<span class="op" id="3432890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432896">h</span>&nbsp;<span class="op" id="3432898">:=</span>&nbsp;<span class="ident" id="3432901"><a href="/net/http/server.go.html#3459348">initNPNRequest</a></span><span class="op" id="3432915">{</span><span class="ident" id="3432916"><a href="/net/http/server.go.html#3432331">tlsConn</a></span><span class="op" id="3432923">,</span>&nbsp;<span class="ident" id="3432925"><a href="/net/http/server.go.html#3450194">serverHandler</a></span><span class="op" id="3432938">{</span><span class="ident" id="3432939"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432940">.</span><span class="ident" id="3432941">server</span><span class="op" id="3432947">}</span><span class="op" id="3432948">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432954"><a href="/net/http/server.go.html#3432844">fn</a></span><span class="op" id="3432956">(</span><span class="ident" id="3432957"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3432958">.</span><span class="ident" id="3432959">server</span><span class="op" id="3432965">,</span>&nbsp;<span class="ident" id="3432967"><a href="/net/http/server.go.html#3432331">tlsConn</a></span><span class="op" id="3432974">,</span>&nbsp;<span class="ident" id="3432976"><a href="/net/http/server.go.html#3432896">h</a></span><span class="op" id="3432977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432987">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432999">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433003">for</span>&nbsp;<span class="op" id="3433007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433011">w</span><span class="op" id="3433012">,</span>&nbsp;<span class="ident" id="3433014">err</span>&nbsp;<span class="op" id="3433018">:=</span>&nbsp;<span class="ident" id="3433021"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433022">.</span><span class="ident" id="3433023">readRequest</span><span class="op" id="3433034">(</span><span class="op" id="3433035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433039">if</span>&nbsp;<span class="ident" id="3433042"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433043">.</span><span class="ident" id="3433044">lr</span><span class="op" id="3433046">.</span><span class="ident" id="3433047">N</span>&nbsp;<span class="op" id="3433049">!=</span>&nbsp;<span class="ident" id="3433052"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433053">.</span><span class="ident" id="3433054">server</span><span class="op" id="3433060">.</span><span class="ident" id="3433061">initialLimitedReaderSize</span><span class="op" id="3433085">(</span><span class="op" id="3433086">)</span>&nbsp;<span class="op" id="3433088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433093">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433148"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433149">.</span><span class="ident" id="3433150">setState</span><span class="op" id="3433158">(</span><span class="ident" id="3433159"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433160">.</span><span class="ident" id="3433161">rwc</span><span class="op" id="3433164">,</span>&nbsp;<span class="ident" id="3433166"><a href="/net/http/server.go.html#3449304">StateActive</a></span><span class="op" id="3433177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433185">if</span>&nbsp;<span class="ident" id="3433188"><a href="/net/http/server.go.html#3433014">err</a></span>&nbsp;<span class="op" id="3433192">!=</span>&nbsp;<span class="ident" id="3433195">nil</span>&nbsp;<span class="op" id="3433199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433204">if</span>&nbsp;<span class="ident" id="3433207"><a href="/net/http/server.go.html#3433014">err</a></span>&nbsp;<span class="op" id="3433211">==</span>&nbsp;<span class="ident" id="3433214"><a href="/net/http/server.go.html#3415532">errTooLarge</a></span>&nbsp;<span class="op" id="3433226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433232">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433275">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433309">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433350">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433391">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433428"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3433430">.</span><span class="ident" id="3433431">WriteString</span><span class="op" id="3433442">(</span><span class="ident" id="3433443"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433444">.</span><span class="ident" id="3433445">rwc</span><span class="op" id="3433448">,</span>&nbsp;<span class="string" id="3433450">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3433497">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433503"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433504">.</span><span class="ident" id="3433505">closeWriteAndWait</span><span class="op" id="3433522">(</span><span class="op" id="3433523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433529">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433538">}</span>&nbsp;<span class="keyword" id="3433540">else</span>&nbsp;<span class="keyword" id="3433545">if</span>&nbsp;<span class="ident" id="3433548"><a href="/net/http/server.go.html#3433014">err</a></span>&nbsp;<span class="op" id="3433552">==</span>&nbsp;<span class="ident" id="3433555"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3433557">.</span><span class="ident" id="3433558">EOF</span>&nbsp;<span class="op" id="3433562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433568">break</span>&nbsp;<span class="comment" id="3433574">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433592">}</span>&nbsp;<span class="keyword" id="3433594">else</span>&nbsp;<span class="keyword" id="3433599">if</span>&nbsp;<span class="ident" id="3433602">neterr</span><span class="op" id="3433608">,</span>&nbsp;<span class="ident" id="3433610">ok</span>&nbsp;<span class="op" id="3433613">:=</span>&nbsp;<span class="ident" id="3433616"><a href="/net/http/server.go.html#3433014">err</a></span><span class="op" id="3433619">.</span><span class="op" id="3433620">(</span><span class="ident" id="3433621"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3433624">.</span><span class="ident" id="3433625">Error</span><span class="op" id="3433630">)</span><span class="op" id="3433631">;</span>&nbsp;<span class="ident" id="3433633"><a href="/net/http/server.go.html#3433610">ok</a></span>&nbsp;<span class="op" id="3433636">&amp;&amp;</span>&nbsp;<span class="ident" id="3433639"><a href="/net/http/server.go.html#3433602">neterr</a></span><span class="op" id="3433645">.</span><span class="ident" id="3433646">Timeout</span><span class="op" id="3433653">(</span><span class="op" id="3433654">)</span>&nbsp;<span class="op" id="3433656">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433662">break</span>&nbsp;<span class="comment" id="3433668">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433691"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3433693">.</span><span class="ident" id="3433694">WriteString</span><span class="op" id="3433705">(</span><span class="ident" id="3433706"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3433707">.</span><span class="ident" id="3433708">rwc</span><span class="op" id="3433711">,</span>&nbsp;<span class="string" id="3433713">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3433747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433752">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433760">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433765">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433798">req</span>&nbsp;<span class="op" id="3433802">:=</span>&nbsp;<span class="ident" id="3433805"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3433806">.</span><span class="ident" id="3433807">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433813">if</span>&nbsp;<span class="ident" id="3433816"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3433819">.</span><span class="ident" id="3433820">expectsContinue</span><span class="op" id="3433835">(</span><span class="op" id="3433836">)</span>&nbsp;<span class="op" id="3433838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433843">if</span>&nbsp;<span class="ident" id="3433846"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3433849">.</span><span class="ident" id="3433850">ProtoAtLeast</span><span class="op" id="3433862">(</span><span class="num" id="3433863">1</span><span class="op" id="3433864">,</span>&nbsp;<span class="num" id="3433866">1</span><span class="op" id="3433867">)</span>&nbsp;<span class="op" id="3433869">&amp;&amp;</span>&nbsp;<span class="ident" id="3433872"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3433875">.</span><span class="ident" id="3433876">ContentLength</span>&nbsp;<span class="op" id="3433890">!=</span>&nbsp;<span class="num" id="3433893">0</span>&nbsp;<span class="op" id="3433895">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433901">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433969"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3433972">.</span><span class="ident" id="3433973">Body</span>&nbsp;<span class="op" id="3433978">=</span>&nbsp;<span class="op" id="3433980">&amp;</span><span class="ident" id="3433981"><a href="/net/http/server.go.html#3414038">expectContinueReader</a></span><span class="op" id="3434001">{</span><span class="ident" id="3434002">readCloser</span><span class="op" id="3434012">:</span>&nbsp;<span class="ident" id="3434014"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3434017">.</span><span class="ident" id="3434018">Body</span><span class="op" id="3434022">,</span>&nbsp;<span class="ident" id="3434024">resp</span><span class="op" id="3434028">:</span>&nbsp;<span class="ident" id="3434030"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434041"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3434044">.</span><span class="ident" id="3434045">Header</span><span class="op" id="3434051">.</span><span class="ident" id="3434052">Del</span><span class="op" id="3434055">(</span><span class="string" id="3434056">&#34;Expect&#34;</span><span class="op" id="3434064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434068">}</span>&nbsp;<span class="keyword" id="3434070">else</span>&nbsp;<span class="keyword" id="3434075">if</span>&nbsp;<span class="ident" id="3434078"><a href="/net/http/server.go.html#3433798">req</a></span><span class="op" id="3434081">.</span><span class="ident" id="3434082">Header</span><span class="op" id="3434088">.</span><span class="ident" id="3434089">get</span><span class="op" id="3434092">(</span><span class="string" id="3434093">&#34;Expect&#34;</span><span class="op" id="3434101">)</span>&nbsp;<span class="op" id="3434103">!=</span>&nbsp;<span class="string" id="3434106">&#34;&#34;</span>&nbsp;<span class="op" id="3434109">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434114"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434115">.</span><span class="ident" id="3434116">sendExpectationFailed</span><span class="op" id="3434137">(</span><span class="op" id="3434138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434143">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434156">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434220">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434290">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434350">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434426">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434490"><a href="/net/http/server.go.html#3450194">serverHandler</a></span><span class="op" id="3434503">{</span><span class="ident" id="3434504"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3434505">.</span><span class="ident" id="3434506">server</span><span class="op" id="3434512">}</span><span class="op" id="3434513">.</span><span class="ident" id="3434514">ServeHTTP</span><span class="op" id="3434523">(</span><span class="ident" id="3434524"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434525">,</span>&nbsp;<span class="ident" id="3434527"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434528">.</span><span class="ident" id="3434529">req</span><span class="op" id="3434532">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434536">if</span>&nbsp;<span class="ident" id="3434539"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3434540">.</span><span class="ident" id="3434541">hijacked</span><span class="op" id="3434549">(</span><span class="op" id="3434550">)</span>&nbsp;<span class="op" id="3434552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434557">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434570"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434571">.</span><span class="ident" id="3434572">finishRequest</span><span class="op" id="3434585">(</span><span class="op" id="3434586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434590">if</span>&nbsp;<span class="ident" id="3434593"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434594">.</span><span class="ident" id="3434595">closeAfterReply</span>&nbsp;<span class="op" id="3434611">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434616">if</span>&nbsp;<span class="ident" id="3434619"><a href="/net/http/server.go.html#3433011">w</a></span><span class="op" id="3434620">.</span><span class="ident" id="3434621">requestBodyLimitHit</span>&nbsp;<span class="op" id="3434641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434647"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3434648">.</span><span class="ident" id="3434649">closeWriteAndWait</span><span class="op" id="3434666">(</span><span class="op" id="3434667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434677">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434685">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434689"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3434690">.</span><span class="ident" id="3434691">setState</span><span class="op" id="3434699">(</span><span class="ident" id="3434700"><a href="/net/http/server.go.html#3431932">c</a></span><span class="op" id="3434701">.</span><span class="ident" id="3434702">rwc</span><span class="op" id="3434705">,</span>&nbsp;<span class="ident" id="3434707"><a href="/net/http/server.go.html#3449540">StateIdle</a></span><span class="op" id="3434716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434719">}</span><br>
<span class="lineno"></span><span class="op" id="3434721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3434724">func</span>&nbsp;<span class="op" id="3434729">(</span><span class="ident" id="3434730">w</span>&nbsp;<span class="op" id="3434732">*</span><span class="ident" id="3434733"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3434741">)</span>&nbsp;<span class="ident" id="3434743">sendExpectationFailed</span><span class="op" id="3434764">(</span><span class="op" id="3434765">)</span>&nbsp;<span class="op" id="3434767">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434770">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434820">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434873">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434923">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434973">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435013">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435057">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435061">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435115">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435165">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435212">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435260">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435313"><a href="/net/http/server.go.html#3434730">w</a></span><span class="op" id="3435314">.</span><span class="ident" id="3435315">Header</span><span class="op" id="3435321">(</span><span class="op" id="3435322">)</span><span class="op" id="3435323">.</span><span class="ident" id="3435324">Set</span><span class="op" id="3435327">(</span><span class="string" id="3435328">&#34;Connection&#34;</span><span class="op" id="3435340">,</span>&nbsp;<span class="string" id="3435342">&#34;close&#34;</span><span class="op" id="3435349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435352"><a href="/net/http/server.go.html#3434730">w</a></span><span class="op" id="3435353">.</span><span class="ident" id="3435354">WriteHeader</span><span class="op" id="3435365">(</span><span class="ident" id="3435366"><a href="/net/http/status.go.html#3467913">StatusExpectationFailed</a></span><span class="op" id="3435389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435392"><a href="/net/http/server.go.html#3434730">w</a></span><span class="op" id="3435393">.</span><span class="ident" id="3435394">finishRequest</span><span class="op" id="3435407">(</span><span class="op" id="3435408">)</span><br>
<span class="lineno">1235</span><span class="op" id="3435410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3435413">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3435500">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3435519">func</span>&nbsp;<span class="op" id="3435524">(</span><span class="ident" id="3435525">w</span>&nbsp;<span class="op" id="3435527">*</span><span class="ident" id="3435528"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3435536">)</span>&nbsp;<span class="ident" id="3435538">Hijack</span><span class="op" id="3435544">(</span><span class="op" id="3435545">)</span>&nbsp;<span class="op" id="3435547">(</span><span class="ident" id="3435548">rwc</span>&nbsp;<span class="ident" id="3435552"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3435555">.</span><span class="ident" id="3435556">Conn</span><span class="op" id="3435560">,</span>&nbsp;<span class="ident" id="3435562">buf</span>&nbsp;<span class="op" id="3435566">*</span><span class="ident" id="3435567"><a href="/net/http/server.go.html#3399812">bufio</a></span><span class="op" id="3435572">.</span><span class="ident" id="3435573">ReadWriter</span><span class="op" id="3435583">,</span>&nbsp;<span class="ident" id="3435585">err</span>&nbsp;<span class="builtintype" id="3435589">error</span><span class="op" id="3435594">)</span>&nbsp;<span class="op" id="3435596">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435599">if</span>&nbsp;<span class="ident" id="3435602"><a href="/net/http/server.go.html#3435525">w</a></span><span class="op" id="3435603">.</span><span class="ident" id="3435604">wroteHeader</span>&nbsp;<span class="op" id="3435616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435620"><a href="/net/http/server.go.html#3435525">w</a></span><span class="op" id="3435621">.</span><span class="ident" id="3435622">cw</span><span class="op" id="3435624">.</span><span class="ident" id="3435625">flush</span><span class="op" id="3435630">(</span><span class="op" id="3435631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435637">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435708">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435755"><a href="/net/http/server.go.html#3435548">rwc</a></span><span class="op" id="3435758">,</span>&nbsp;<span class="ident" id="3435760"><a href="/net/http/server.go.html#3435562">buf</a></span><span class="op" id="3435763">,</span>&nbsp;<span class="ident" id="3435765"><a href="/net/http/server.go.html#3435585">err</a></span>&nbsp;<span class="op" id="3435769">=</span>&nbsp;<span class="ident" id="3435771"><a href="/net/http/server.go.html#3435525">w</a></span><span class="op" id="3435772">.</span><span class="ident" id="3435773">conn</span><span class="op" id="3435777">.</span><span class="ident" id="3435778">hijack</span><span class="op" id="3435784">(</span><span class="op" id="3435785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435788">if</span>&nbsp;<span class="ident" id="3435791"><a href="/net/http/server.go.html#3435585">err</a></span>&nbsp;<span class="op" id="3435795">==</span>&nbsp;<span class="ident" id="3435798">nil</span>&nbsp;<span class="op" id="3435802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435806"><a href="/net/http/server.go.html#3413358">putBufioWriter</a></span><span class="op" id="3435820">(</span><span class="ident" id="3435821"><a href="/net/http/server.go.html#3435525">w</a></span><span class="op" id="3435822">.</span><span class="ident" id="3435823">w</span><span class="op" id="3435824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435828"><a href="/net/http/server.go.html#3435525">w</a></span><span class="op" id="3435829">.</span><span class="ident" id="3435830">w</span>&nbsp;<span class="op" id="3435832">=</span>&nbsp;<span class="ident" id="3435834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435839">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435842">return</span>&nbsp;<span class="ident" id="3435849"><a href="/net/http/server.go.html#3435548">rwc</a></span><span class="op" id="3435852">,</span>&nbsp;<span class="ident" id="3435854"><a href="/net/http/server.go.html#3435562">buf</a></span><span class="op" id="3435857">,</span>&nbsp;<span class="ident" id="3435859"><a href="/net/http/server.go.html#3435585">err</a></span><br>
<span class="lineno"></span><span class="op" id="3435863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3435866">func</span>&nbsp;<span class="op" id="3435871">(</span><span class="ident" id="3435872">w</span>&nbsp;<span class="op" id="3435874">*</span><span class="ident" id="3435875"><a href="/net/http/server.go.html#3408205">response</a></span><span class="op" id="3435883">)</span>&nbsp;<span class="ident" id="3435885">CloseNotify</span><span class="op" id="3435896">(</span><span class="op" id="3435897">)</span>&nbsp;<span class="op" id="3435899">&lt;-</span><span class="keyword" id="3435901">chan</span>&nbsp;<span class="builtintype" id="3435906">bool</span>&nbsp;<span class="op" id="3435911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435914">return</span>&nbsp;<span class="ident" id="3435921"><a href="/net/http/server.go.html#3435872">w</a></span><span class="op" id="3435922">.</span><span class="ident" id="3435923">conn</span><span class="op" id="3435927">.</span><span class="ident" id="3435928">closeNotify</span><span class="op" id="3435939">(</span><span class="op" id="3435940">)</span><br>
<span class="lineno">1255</span><span class="op" id="3435942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3435945">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3436003">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3436063">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3436118">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3436150">type</span>&nbsp;<span class="ident" id="3436155">HandlerFunc</span>&nbsp;<span class="keyword" id="3436167">func</span><span class="op" id="3436171">(</span><span class="ident" id="3436172"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3436186">,</span>&nbsp;<span class="op" id="3436188">*</span><span class="ident" id="3436189"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3436196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3436199">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3436227">func</span>&nbsp;<span class="op" id="3436232">(</span><span class="ident" id="3436233">f</span>&nbsp;<span class="ident" id="3436235"><a href="/net/http/server.go.html#3436155">HandlerFunc</a></span><span class="op" id="3436246">)</span>&nbsp;<span class="ident" id="3436248">ServeHTTP</span><span class="op" id="3436257">(</span><span class="ident" id="3436258">w</span>&nbsp;<span class="ident" id="3436260"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3436274">,</span>&nbsp;<span class="ident" id="3436276">r</span>&nbsp;<span class="op" id="3436278">*</span><span class="ident" id="3436279"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3436286">)</span>&nbsp;<span class="op" id="3436288">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436291"><a href="/net/http/server.go.html#3436233">f</a></span><span class="op" id="3436292">(</span><span class="ident" id="3436293"><a href="/net/http/server.go.html#3436258">w</a></span><span class="op" id="3436294">,</span>&nbsp;<span class="ident" id="3436296"><a href="/net/http/server.go.html#3436276">r</a></span><span class="op" id="3436297">)</span><br>
<span class="lineno"></span><span class="op" id="3436299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3436302">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3436322">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3436402">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3436445">func</span>&nbsp;<span class="ident" id="3436450">Error</span><span class="op" id="3436455">(</span><span class="ident" id="3436456">w</span>&nbsp;<span class="ident" id="3436458"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3436472">,</span>&nbsp;<span class="builtintype" id="3436474">error</span>&nbsp;<span class="builtintype" id="3436480">string</span><span class="op" id="3436486">,</span>&nbsp;<span class="ident" id="3436488">code</span>&nbsp;<span class="builtintype" id="3436493">int</span><span class="op" id="3436496">)</span>&nbsp;<span class="op" id="3436498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436501"><a href="/net/http/server.go.html#3436456">w</a></span><span class="op" id="3436502">.</span><span class="ident" id="3436503">Header</span><span class="op" id="3436509">(</span><span class="op" id="3436510">)</span><span class="op" id="3436511">.</span><span class="ident" id="3436512">Set</span><span class="op" id="3436515">(</span><span class="string" id="3436516">&#34;Content-Type&#34;</span><span class="op" id="3436530">,</span>&nbsp;<span class="string" id="3436532">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3436559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436562"><a href="/net/http/server.go.html#3436456">w</a></span><span class="op" id="3436563">.</span><span class="ident" id="3436564">WriteHeader</span><span class="op" id="3436575">(</span><span class="ident" id="3436576"><a href="/net/http/server.go.html#3436488">code</a></span><span class="op" id="3436580">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436583"><a href="/net/http/server.go.html#3399845">fmt</a></span><span class="op" id="3436586">.</span><span class="ident" id="3436587">Fprintln</span><span class="op" id="3436595">(</span><span class="ident" id="3436596"><a href="/net/http/server.go.html#3436456">w</a></span><span class="op" id="3436597">,</span>&nbsp;<span class="builtintype" id="3436599"><a href="/net/http/server.go.html#3436474">error</a></span><span class="op" id="3436604">)</span><br>
<span class="lineno"></span><span class="op" id="3436606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3436609">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3436678">func</span>&nbsp;<span class="ident" id="3436683">NotFound</span><span class="op" id="3436691">(</span><span class="ident" id="3436692">w</span>&nbsp;<span class="ident" id="3436694"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3436708">,</span>&nbsp;<span class="ident" id="3436710">r</span>&nbsp;<span class="op" id="3436712">*</span><span class="ident" id="3436713"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3436720">)</span>&nbsp;<span class="op" id="3436722">{</span>&nbsp;<span class="ident" id="3436724"><a href="/net/http/server.go.html#3436450">Error</a></span><span class="op" id="3436729">(</span><span class="ident" id="3436730"><a href="/net/http/server.go.html#3436692">w</a></span><span class="op" id="3436731">,</span>&nbsp;<span class="string" id="3436733">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3436753">,</span>&nbsp;<span class="ident" id="3436755"><a href="/net/http/status.go.html#3467367">StatusNotFound</a></span><span class="op" id="3436769">)</span>&nbsp;<span class="op" id="3436771">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3436774">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3436826">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3436895">func</span>&nbsp;<span class="ident" id="3436900">NotFoundHandler</span><span class="op" id="3436915">(</span><span class="op" id="3436916">)</span>&nbsp;<span class="ident" id="3436918"><a href="/net/http/server.go.html#3400945">Handler</a></span>&nbsp;<span class="op" id="3436926">{</span>&nbsp;<span class="keyword" id="3436928">return</span>&nbsp;<span class="ident" id="3436935"><a href="/net/http/server.go.html#3436155">HandlerFunc</a></span><span class="op" id="3436946">(</span><span class="ident" id="3436947"><a href="/net/http/server.go.html#3436683">NotFound</a></span><span class="op" id="3436955">)</span>&nbsp;<span class="op" id="3436957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3436960">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3437019">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3437079">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3437132">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3437188">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3437234">func</span>&nbsp;<span class="ident" id="3437239">StripPrefix</span><span class="op" id="3437250">(</span><span class="ident" id="3437251">prefix</span>&nbsp;<span class="builtintype" id="3437258">string</span><span class="op" id="3437264">,</span>&nbsp;<span class="ident" id="3437266">h</span>&nbsp;<span class="ident" id="3437268"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3437275">)</span>&nbsp;<span class="ident" id="3437277"><a href="/net/http/server.go.html#3400945">Handler</a></span>&nbsp;<span class="op" id="3437285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437288">if</span>&nbsp;<span class="ident" id="3437291"><a href="/net/http/server.go.html#3437251">prefix</a></span>&nbsp;<span class="op" id="3437298">==</span>&nbsp;<span class="string" id="3437301">&#34;&#34;</span>&nbsp;<span class="op" id="3437304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437308">return</span>&nbsp;<span class="ident" id="3437315"><a href="/net/http/server.go.html#3437266">h</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437321">return</span>&nbsp;<span class="ident" id="3437328"><a href="/net/http/server.go.html#3436155">HandlerFunc</a></span><span class="op" id="3437339">(</span><span class="keyword" id="3437340">func</span><span class="op" id="3437344">(</span><span class="ident" id="3437345">w</span>&nbsp;<span class="ident" id="3437347"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3437361">,</span>&nbsp;<span class="ident" id="3437363">r</span>&nbsp;<span class="op" id="3437365">*</span><span class="ident" id="3437366"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3437373">)</span>&nbsp;<span class="op" id="3437375">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437379">if</span>&nbsp;<span class="ident" id="3437382">p</span>&nbsp;<span class="op" id="3437384">:=</span>&nbsp;<span class="ident" id="3437387"><a href="/net/http/server.go.html#3399932">strings</a></span><span class="op" id="3437394">.</span><span class="ident" id="3437395">TrimPrefix</span><span class="op" id="3437405">(</span><span class="ident" id="3437406"><a href="/net/http/server.go.html#3437363">r</a></span><span class="op" id="3437407">.</span><span class="ident" id="3437408">URL</span><span class="op" id="3437411">.</span><span class="ident" id="3437412">Path</span><span class="op" id="3437416">,</span>&nbsp;<span class="ident" id="3437418"><a href="/net/http/server.go.html#3437251">prefix</a></span><span class="op" id="3437424">)</span><span class="op" id="3437425">;</span>&nbsp;<span class="builtinfunc" id="3437427">len</span><span class="op" id="3437430">(</span><span class="ident" id="3437431"><a href="/net/http/server.go.html#3437382">p</a></span><span class="op" id="3437432">)</span>&nbsp;<span class="op" id="3437434">&lt;</span>&nbsp;<span class="builtinfunc" id="3437436">len</span><span class="op" id="3437439">(</span><span class="ident" id="3437440"><a href="/net/http/server.go.html#3437363">r</a></span><span class="op" id="3437441">.</span><span class="ident" id="3437442">URL</span><span class="op" id="3437445">.</span><span class="ident" id="3437446">Path</span><span class="op" id="3437450">)</span>&nbsp;<span class="op" id="3437452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437457"><a href="/net/http/server.go.html#3437363">r</a></span><span class="op" id="3437458">.</span><span class="ident" id="3437459">URL</span><span class="op" id="3437462">.</span><span class="ident" id="3437463">Path</span>&nbsp;<span class="op" id="3437468">=</span>&nbsp;<span class="ident" id="3437470"><a href="/net/http/server.go.html#3437382">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437475"><a href="/net/http/server.go.html#3437266">h</a></span><span class="op" id="3437476">.</span><span class="ident" id="3437477">ServeHTTP</span><span class="op" id="3437486">(</span><span class="ident" id="3437487"><a href="/net/http/server.go.html#3437345">w</a></span><span class="op" id="3437488">,</span>&nbsp;<span class="ident" id="3437490"><a href="/net/http/server.go.html#3437363">r</a></span><span class="op" id="3437491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437495">}</span>&nbsp;<span class="keyword" id="3437497">else</span>&nbsp;<span class="op" id="3437502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437507"><a href="/net/http/server.go.html#3436683">NotFound</a></span><span class="op" id="3437515">(</span><span class="ident" id="3437516"><a href="/net/http/server.go.html#3437345">w</a></span><span class="op" id="3437517">,</span>&nbsp;<span class="ident" id="3437519"><a href="/net/http/server.go.html#3437363">r</a></span><span class="op" id="3437520">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437527">}</span><span class="op" id="3437528">)</span><br>
<span class="lineno"></span><span class="op" id="3437530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3437533">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3437592">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3437645">func</span>&nbsp;<span class="ident" id="3437650">Redirect</span><span class="op" id="3437658">(</span><span class="ident" id="3437659">w</span>&nbsp;<span class="ident" id="3437661"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3437675">,</span>&nbsp;<span class="ident" id="3437677">r</span>&nbsp;<span class="op" id="3437679">*</span><span class="ident" id="3437680"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3437687">,</span>&nbsp;<span class="ident" id="3437689">urlStr</span>&nbsp;<span class="builtintype" id="3437696">string</span><span class="op" id="3437702">,</span>&nbsp;<span class="ident" id="3437704">code</span>&nbsp;<span class="builtintype" id="3437709">int</span><span class="op" id="3437712">)</span>&nbsp;<span class="op" id="3437714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437717">if</span>&nbsp;<span class="ident" id="3437720">u</span><span class="op" id="3437721">,</span>&nbsp;<span class="ident" id="3437723">err</span>&nbsp;<span class="op" id="3437727">:=</span>&nbsp;<span class="ident" id="3437730"><a href="/net/http/server.go.html#3399885">url</a></span><span class="op" id="3437733">.</span><span class="ident" id="3437734">Parse</span><span class="op" id="3437739">(</span><span class="ident" id="3437740"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3437746">)</span><span class="op" id="3437747">;</span>&nbsp;<span class="ident" id="3437749"><a href="/net/http/server.go.html#3437723">err</a></span>&nbsp;<span class="op" id="3437753">==</span>&nbsp;<span class="ident" id="3437756">nil</span>&nbsp;<span class="op" id="3437760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437764">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437807">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437841">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437889">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437936">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437984">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438024">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438064">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438099">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438141">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438186">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438234">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438281">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438333">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438386">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438401">oldpath</span>&nbsp;<span class="op" id="3438409">:=</span>&nbsp;<span class="ident" id="3438412"><a href="/net/http/server.go.html#3437677">r</a></span><span class="op" id="3438413">.</span><span class="ident" id="3438414">URL</span><span class="op" id="3438417">.</span><span class="ident" id="3438418">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438425">if</span>&nbsp;<span class="ident" id="3438428"><a href="/net/http/server.go.html#3438401">oldpath</a></span>&nbsp;<span class="op" id="3438436">==</span>&nbsp;<span class="string" id="3438439">&#34;&#34;</span>&nbsp;<span class="op" id="3438442">{</span>&nbsp;<span class="comment" id="3438444">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438498"><a href="/net/http/server.go.html#3438401">oldpath</a></span>&nbsp;<span class="op" id="3438506">=</span>&nbsp;<span class="string" id="3438508">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438518">if</span>&nbsp;<span class="ident" id="3438521"><a href="/net/http/server.go.html#3437720">u</a></span><span class="op" id="3438522">.</span><span class="ident" id="3438523">Scheme</span>&nbsp;<span class="op" id="3438530">==</span>&nbsp;<span class="string" id="3438533">&#34;&#34;</span>&nbsp;<span class="op" id="3438536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438541">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438572">if</span>&nbsp;<span class="ident" id="3438575"><a href="/net/http/server.go.html#3437689">urlStr</a></span>&nbsp;<span class="op" id="3438582">==</span>&nbsp;<span class="string" id="3438585">&#34;&#34;</span>&nbsp;<span class="op" id="3438588">||</span>&nbsp;<span class="ident" id="3438591"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438597">[</span><span class="num" id="3438598">0</span><span class="op" id="3438599">]</span>&nbsp;<span class="op" id="3438601">!=</span>&nbsp;<span class="string" id="3438604">&#39;/&#39;</span>&nbsp;<span class="op" id="3438608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438614">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438649">olddir</span><span class="op" id="3438655">,</span>&nbsp;<span class="ident" id="3438657">_</span>&nbsp;<span class="op" id="3438659">:=</span>&nbsp;<span class="ident" id="3438662"><a href="/net/http/server.go.html#3399902">path</a></span><span class="op" id="3438666">.</span><span class="ident" id="3438667">Split</span><span class="op" id="3438672">(</span><span class="ident" id="3438673"><a href="/net/http/server.go.html#3438401">oldpath</a></span><span class="op" id="3438680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438686"><a href="/net/http/server.go.html#3437689">urlStr</a></span>&nbsp;<span class="op" id="3438693">=</span>&nbsp;<span class="ident" id="3438695"><a href="/net/http/server.go.html#3438649">olddir</a></span>&nbsp;<span class="op" id="3438702">+</span>&nbsp;<span class="ident" id="3438704"><a href="/net/http/server.go.html#3437689">urlStr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438714">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438720">var</span>&nbsp;<span class="ident" id="3438724">query</span>&nbsp;<span class="builtintype" id="3438730">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438740">if</span>&nbsp;<span class="ident" id="3438743">i</span>&nbsp;<span class="op" id="3438745">:=</span>&nbsp;<span class="ident" id="3438748"><a href="/net/http/server.go.html#3399932">strings</a></span><span class="op" id="3438755">.</span><span class="ident" id="3438756">Index</span><span class="op" id="3438761">(</span><span class="ident" id="3438762"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438768">,</span>&nbsp;<span class="string" id="3438770">&#34;?&#34;</span><span class="op" id="3438773">)</span><span class="op" id="3438774">;</span>&nbsp;<span class="ident" id="3438776"><a href="/net/http/server.go.html#3438743">i</a></span>&nbsp;<span class="op" id="3438778">!=</span>&nbsp;<span class="op" id="3438781">-</span><span class="num" id="3438782">1</span>&nbsp;<span class="op" id="3438784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438790"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438796">,</span>&nbsp;<span class="ident" id="3438798"><a href="/net/http/server.go.html#3438724">query</a></span>&nbsp;<span class="op" id="3438804">=</span>&nbsp;<span class="ident" id="3438806"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438812">[</span><span class="op" id="3438813">:</span><span class="ident" id="3438814"><a href="/net/http/server.go.html#3438743">i</a></span><span class="op" id="3438815">]</span><span class="op" id="3438816">,</span>&nbsp;<span class="ident" id="3438818"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438824">[</span><span class="ident" id="3438825"><a href="/net/http/server.go.html#3438743">i</a></span><span class="op" id="3438826">:</span><span class="op" id="3438827">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438832">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3438838">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438881">trailing</span>&nbsp;<span class="op" id="3438890">:=</span>&nbsp;<span class="ident" id="3438893"><a href="/net/http/server.go.html#3399932">strings</a></span><span class="op" id="3438900">.</span><span class="ident" id="3438901">HasSuffix</span><span class="op" id="3438910">(</span><span class="ident" id="3438911"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438917">,</span>&nbsp;<span class="string" id="3438919">&#34;/&#34;</span><span class="op" id="3438922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438927"><a href="/net/http/server.go.html#3437689">urlStr</a></span>&nbsp;<span class="op" id="3438934">=</span>&nbsp;<span class="ident" id="3438936"><a href="/net/http/server.go.html#3399902">path</a></span><span class="op" id="3438940">.</span><span class="ident" id="3438941">Clean</span><span class="op" id="3438946">(</span><span class="ident" id="3438947"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438958">if</span>&nbsp;<span class="ident" id="3438961"><a href="/net/http/server.go.html#3438881">trailing</a></span>&nbsp;<span class="op" id="3438970">&amp;&amp;</span>&nbsp;<span class="op" id="3438973">!</span><span class="ident" id="3438974"><a href="/net/http/server.go.html#3399932">strings</a></span><span class="op" id="3438981">.</span><span class="ident" id="3438982">HasSuffix</span><span class="op" id="3438991">(</span><span class="ident" id="3438992"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3438998">,</span>&nbsp;<span class="string" id="3439000">&#34;/&#34;</span><span class="op" id="3439003">)</span>&nbsp;<span class="op" id="3439005">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439011"><a href="/net/http/server.go.html#3437689">urlStr</a></span>&nbsp;<span class="op" id="3439018">+=</span>&nbsp;<span class="string" id="3439021">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439033"><a href="/net/http/server.go.html#3437689">urlStr</a></span>&nbsp;<span class="op" id="3439040">+=</span>&nbsp;<span class="ident" id="3439043"><a href="/net/http/server.go.html#3438724">query</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439054">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439058"><a href="/net/http/server.go.html#3437659">w</a></span><span class="op" id="3439059">.</span><span class="ident" id="3439060">Header</span><span class="op" id="3439066">(</span><span class="op" id="3439067">)</span><span class="op" id="3439068">.</span><span class="ident" id="3439069">Set</span><span class="op" id="3439072">(</span><span class="string" id="3439073">&#34;Location&#34;</span><span class="op" id="3439083">,</span>&nbsp;<span class="ident" id="3439085"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3439091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439094"><a href="/net/http/server.go.html#3437659">w</a></span><span class="op" id="3439095">.</span><span class="ident" id="3439096">WriteHeader</span><span class="op" id="3439107">(</span><span class="ident" id="3439108"><a href="/net/http/server.go.html#3437704">code</a></span><span class="op" id="3439112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439116">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439185">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439252">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439319">if</span>&nbsp;<span class="ident" id="3439322"><a href="/net/http/server.go.html#3437677">r</a></span><span class="op" id="3439323">.</span><span class="ident" id="3439324">Method</span>&nbsp;<span class="op" id="3439331">==</span>&nbsp;<span class="string" id="3439334">&#34;GET&#34;</span>&nbsp;<span class="op" id="3439340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439344">note</span>&nbsp;<span class="op" id="3439349">:=</span>&nbsp;<span class="string" id="3439352">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3439365">+</span>&nbsp;<span class="ident" id="3439367"><a href="/net/http/server.go.html#3439689">htmlEscape</a></span><span class="op" id="3439377">(</span><span class="ident" id="3439378"><a href="/net/http/server.go.html#3437689">urlStr</a></span><span class="op" id="3439384">)</span>&nbsp;<span class="op" id="3439386">+</span>&nbsp;<span class="string" id="3439388">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3439394">+</span>&nbsp;<span class="ident" id="3439396"><a href="/net/http/status.go.html#3468530">statusText</a></span><span class="op" id="3439406">[</span><span class="ident" id="3439407"><a href="/net/http/server.go.html#3437704">code</a></span><span class="op" id="3439411">]</span>&nbsp;<span class="op" id="3439413">+</span>&nbsp;<span class="string" id="3439415">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439427"><a href="/net/http/server.go.html#3399845">fmt</a></span><span class="op" id="3439430">.</span><span class="ident" id="3439431">Fprintln</span><span class="op" id="3439439">(</span><span class="ident" id="3439440"><a href="/net/http/server.go.html#3437659">w</a></span><span class="op" id="3439441">,</span>&nbsp;<span class="ident" id="3439443"><a href="/net/http/server.go.html#3439344">note</a></span><span class="op" id="3439447">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439450">}</span><br>
<span class="lineno"></span><span class="op" id="3439452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3439455">var</span>&nbsp;<span class="ident" id="3439459">htmlReplacer</span>&nbsp;<span class="op" id="3439472">=</span>&nbsp;<span class="ident" id="3439474"><a href="/net/http/server.go.html#3399932">strings</a></span><span class="op" id="3439481">.</span><span class="ident" id="3439482">NewReplacer</span><span class="op" id="3439493">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3439496">&#34;&amp;&#34;</span><span class="op" id="3439499">,</span>&nbsp;<span class="string" id="3439501">&#34;&amp;amp;&#34;</span><span class="op" id="3439508">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3439511">&#34;&lt;&#34;</span><span class="op" id="3439514">,</span>&nbsp;<span class="string" id="3439516">&#34;&amp;lt;&#34;</span><span class="op" id="3439522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3439525">&#34;&gt;&#34;</span><span class="op" id="3439528">,</span>&nbsp;<span class="string" id="3439530">&#34;&amp;gt;&#34;</span><span class="op" id="3439536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439539">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3439577">`&#34;`</span><span class="op" id="3439580">,</span>&nbsp;<span class="string" id="3439582">&#34;&amp;#34;&#34;</span><span class="op" id="3439589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439592">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3439667">&#34;&#39;&#34;</span><span class="op" id="3439670">,</span>&nbsp;<span class="string" id="3439672">&#34;&amp;#39;&#34;</span><span class="op" id="3439679">,</span><br>
<span class="lineno"></span><span class="op" id="3439681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3439684">func</span>&nbsp;<span class="ident" id="3439689">htmlEscape</span><span class="op" id="3439699">(</span><span class="ident" id="3439700">s</span>&nbsp;<span class="builtintype" id="3439702">string</span><span class="op" id="3439708">)</span>&nbsp;<span class="builtintype" id="3439710">string</span>&nbsp;<span class="op" id="3439717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439720">return</span>&nbsp;<span class="ident" id="3439727"><a href="/net/http/server.go.html#3439459">htmlReplacer</a></span><span class="op" id="3439739">.</span><span class="ident" id="3439740">Replace</span><span class="op" id="3439747">(</span><span class="ident" id="3439748"><a href="/net/http/server.go.html#3439700">s</a></span><span class="op" id="3439749">)</span><br>
<span class="lineno">1375</span><span class="op" id="3439751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3439754">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3439781">type</span>&nbsp;<span class="ident" id="3439786">redirectHandler</span>&nbsp;<span class="keyword" id="3439802">struct</span>&nbsp;<span class="op" id="3439809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439812">url</span>&nbsp;&nbsp;<span class="builtintype" id="3439817">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439825">code</span>&nbsp;<span class="builtintype" id="3439830">int</span><br>
<span class="lineno"></span><span class="op" id="3439834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3439837">func</span>&nbsp;<span class="op" id="3439842">(</span><span class="ident" id="3439843">rh</span>&nbsp;<span class="op" id="3439846">*</span><span class="ident" id="3439847"><a href="/net/http/server.go.html#3439786">redirectHandler</a></span><span class="op" id="3439862">)</span>&nbsp;<span class="ident" id="3439864">ServeHTTP</span><span class="op" id="3439873">(</span><span class="ident" id="3439874">w</span>&nbsp;<span class="ident" id="3439876"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3439890">,</span>&nbsp;<span class="ident" id="3439892">r</span>&nbsp;<span class="op" id="3439894">*</span><span class="ident" id="3439895"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3439902">)</span>&nbsp;<span class="op" id="3439904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439907"><a href="/net/http/server.go.html#3437650">Redirect</a></span><span class="op" id="3439915">(</span><span class="ident" id="3439916"><a href="/net/http/server.go.html#3439874">w</a></span><span class="op" id="3439917">,</span>&nbsp;<span class="ident" id="3439919"><a href="/net/http/server.go.html#3439892">r</a></span><span class="op" id="3439920">,</span>&nbsp;<span class="ident" id="3439922"><a href="/net/http/server.go.html#3439843">rh</a></span><span class="op" id="3439924">.</span><span class="ident" id="3439925">url</span><span class="op" id="3439928">,</span>&nbsp;<span class="ident" id="3439930"><a href="/net/http/server.go.html#3439843">rh</a></span><span class="op" id="3439932">.</span><span class="ident" id="3439933">code</span><span class="op" id="3439937">)</span><br>
<span class="lineno">1385</span><span class="op" id="3439939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3439942">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3440002">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3440063">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3440079">func</span>&nbsp;<span class="ident" id="3440084">RedirectHandler</span><span class="op" id="3440099">(</span><span class="ident" id="3440100">url</span>&nbsp;<span class="builtintype" id="3440104">string</span><span class="op" id="3440110">,</span>&nbsp;<span class="ident" id="3440112">code</span>&nbsp;<span class="builtintype" id="3440117">int</span><span class="op" id="3440120">)</span>&nbsp;<span class="ident" id="3440122"><a href="/net/http/server.go.html#3400945">Handler</a></span>&nbsp;<span class="op" id="3440130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440133">return</span>&nbsp;<span class="op" id="3440140">&amp;</span><span class="ident" id="3440141"><a href="/net/http/server.go.html#3439786">redirectHandler</a></span><span class="op" id="3440156">{</span><span class="ident" id="3440157"><a href="/net/http/server.go.html#3440100">url</a></span><span class="op" id="3440160">,</span>&nbsp;<span class="ident" id="3440162"><a href="/net/http/server.go.html#3440112">code</a></span><span class="op" id="3440166">}</span><br>
<span class="lineno"></span><span class="op" id="3440168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3440171">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3440215">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3440291">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3440346">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3440379">//</span><br>
<span class="lineno"></span><span class="comment" id="3440382">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3440441">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3440507">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3440569">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3440625">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3440682">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3440742">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3440801">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3440824">//</span><br>
<span class="lineno"></span><span class="comment" id="3440827">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3440898">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3440967">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3441015">//</span><br>
<span class="lineno"></span><span class="comment" id="3441018">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3441092">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3441164">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3441239">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3441310">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3441352">//</span><br>
<span class="lineno"></span><span class="comment" id="3441355">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3441419">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3441480">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3441514">type</span>&nbsp;<span class="ident" id="3441519">ServeMux</span>&nbsp;<span class="keyword" id="3441528">struct</span>&nbsp;<span class="op" id="3441535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441538">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3441544"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3441548">.</span><span class="ident" id="3441549">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441558">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3441564">map</span><span class="op" id="3441567">[</span><span class="builtintype" id="3441568">string</span><span class="op" id="3441574">]</span><span class="ident" id="3441575"><a href="/net/http/server.go.html#3441646">muxEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441585">hosts</span>&nbsp;<span class="builtintype" id="3441591">bool</span>&nbsp;<span class="comment" id="3441596">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3441638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3441641">type</span>&nbsp;<span class="ident" id="3441646">muxEntry</span>&nbsp;<span class="keyword" id="3441655">struct</span>&nbsp;<span class="op" id="3441662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441665">explicit</span>&nbsp;<span class="builtintype" id="3441674">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441680">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3441689"><a href="/net/http/server.go.html#3400945">Handler</a></span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441698">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3441707">string</span><br>
<span class="lineno"></span><span class="op" id="3441714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3441717">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3441770">func</span>&nbsp;<span class="ident" id="3441775">NewServeMux</span><span class="op" id="3441786">(</span><span class="op" id="3441787">)</span>&nbsp;<span class="op" id="3441789">*</span><span class="ident" id="3441790"><a href="/net/http/server.go.html#3441519">ServeMux</a></span>&nbsp;<span class="op" id="3441799">{</span>&nbsp;<span class="keyword" id="3441801">return</span>&nbsp;<span class="op" id="3441808">&amp;</span><span class="ident" id="3441809"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3441817">{</span><span class="ident" id="3441818">m</span><span class="op" id="3441819">:</span>&nbsp;<span class="builtinfunc" id="3441821">make</span><span class="op" id="3441825">(</span><span class="keyword" id="3441826">map</span><span class="op" id="3441829">[</span><span class="builtintype" id="3441830">string</span><span class="op" id="3441836">]</span><span class="ident" id="3441837"><a href="/net/http/server.go.html#3441646">muxEntry</a></span><span class="op" id="3441845">)</span><span class="op" id="3441846">}</span>&nbsp;<span class="op" id="3441848">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3441851">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3441909">var</span>&nbsp;<span class="ident" id="3441913">DefaultServeMux</span>&nbsp;<span class="op" id="3441929">=</span>&nbsp;<span class="ident" id="3441931"><a href="/net/http/server.go.html#3441775">NewServeMux</a></span><span class="op" id="3441942">(</span><span class="op" id="3441943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3441946">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3441974">func</span>&nbsp;<span class="ident" id="3441979">pathMatch</span><span class="op" id="3441988">(</span><span class="ident" id="3441989">pattern</span><span class="op" id="3441996">,</span>&nbsp;<span class="ident" id="3441998">path</span>&nbsp;<span class="builtintype" id="3442003">string</span><span class="op" id="3442009">)</span>&nbsp;<span class="builtintype" id="3442011">bool</span>&nbsp;<span class="op" id="3442016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442019">if</span>&nbsp;<span class="builtinfunc" id="3442022">len</span><span class="op" id="3442025">(</span><span class="ident" id="3442026"><a href="/net/http/server.go.html#3441989">pattern</a></span><span class="op" id="3442033">)</span>&nbsp;<span class="op" id="3442035">==</span>&nbsp;<span class="num" id="3442038">0</span>&nbsp;<span class="op" id="3442040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442044">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442067">return</span>&nbsp;<span class="builtintype" id="3442074">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442081">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442084">n</span>&nbsp;<span class="op" id="3442086">:=</span>&nbsp;<span class="builtinfunc" id="3442089">len</span><span class="op" id="3442092">(</span><span class="ident" id="3442093"><a href="/net/http/server.go.html#3441989">pattern</a></span><span class="op" id="3442100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442103">if</span>&nbsp;<span class="ident" id="3442106"><a href="/net/http/server.go.html#3441989">pattern</a></span><span class="op" id="3442113">[</span><span class="ident" id="3442114"><a href="/net/http/server.go.html#3442084">n</a></span><span class="op" id="3442115">-</span><span class="num" id="3442116">1</span><span class="op" id="3442117">]</span>&nbsp;<span class="op" id="3442119">!=</span>&nbsp;<span class="string" id="3442122">&#39;/&#39;</span>&nbsp;<span class="op" id="3442126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442130">return</span>&nbsp;<span class="ident" id="3442137"><a href="/net/http/server.go.html#3441989">pattern</a></span>&nbsp;<span class="op" id="3442145">==</span>&nbsp;<span class="ident" id="3442148"><a href="/net/http/server.go.html#3441998">path</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442157">return</span>&nbsp;<span class="builtinfunc" id="3442164">len</span><span class="op" id="3442167">(</span><span class="ident" id="3442168"><a href="/net/http/server.go.html#3441998">path</a></span><span class="op" id="3442172">)</span>&nbsp;<span class="op" id="3442174">&gt;=</span>&nbsp;<span class="ident" id="3442177"><a href="/net/http/server.go.html#3442084">n</a></span>&nbsp;<span class="op" id="3442179">&amp;&amp;</span>&nbsp;<span class="ident" id="3442182"><a href="/net/http/server.go.html#3441998">path</a></span><span class="op" id="3442186">[</span><span class="num" id="3442187">0</span><span class="op" id="3442188">:</span><span class="ident" id="3442189"><a href="/net/http/server.go.html#3442084">n</a></span><span class="op" id="3442190">]</span>&nbsp;<span class="op" id="3442192">==</span>&nbsp;<span class="ident" id="3442195"><a href="/net/http/server.go.html#3441989">pattern</a></span><br>
<span class="lineno">1450</span><span class="op" id="3442203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3442206">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3442273">func</span>&nbsp;<span class="ident" id="3442278">cleanPath</span><span class="op" id="3442287">(</span><span class="ident" id="3442288">p</span>&nbsp;<span class="builtintype" id="3442290">string</span><span class="op" id="3442296">)</span>&nbsp;<span class="builtintype" id="3442298">string</span>&nbsp;<span class="op" id="3442305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442308">if</span>&nbsp;<span class="ident" id="3442311"><a href="/net/http/server.go.html#3442288">p</a></span>&nbsp;<span class="op" id="3442313">==</span>&nbsp;<span class="string" id="3442316">&#34;&#34;</span>&nbsp;<span class="op" id="3442319">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442323">return</span>&nbsp;<span class="string" id="3442330">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442338">if</span>&nbsp;<span class="ident" id="3442341"><a href="/net/http/server.go.html#3442288">p</a></span><span class="op" id="3442342">[</span><span class="num" id="3442343">0</span><span class="op" id="3442344">]</span>&nbsp;<span class="op" id="3442346">!=</span>&nbsp;<span class="string" id="3442349">&#39;/&#39;</span>&nbsp;<span class="op" id="3442353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442357"><a href="/net/http/server.go.html#3442288">p</a></span>&nbsp;<span class="op" id="3442359">=</span>&nbsp;<span class="string" id="3442361">&#34;/&#34;</span>&nbsp;<span class="op" id="3442365">+</span>&nbsp;<span class="ident" id="3442367"><a href="/net/http/server.go.html#3442288">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442370">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442373">np</span>&nbsp;<span class="op" id="3442376">:=</span>&nbsp;<span class="ident" id="3442379"><a href="/net/http/server.go.html#3399902">path</a></span><span class="op" id="3442383">.</span><span class="ident" id="3442384">Clean</span><span class="op" id="3442389">(</span><span class="ident" id="3442390"><a href="/net/http/server.go.html#3442288">p</a></span><span class="op" id="3442391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442394">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442449">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442495">if</span>&nbsp;<span class="ident" id="3442498"><a href="/net/http/server.go.html#3442288">p</a></span><span class="op" id="3442499">[</span><span class="builtinfunc" id="3442500">len</span><span class="op" id="3442503">(</span><span class="ident" id="3442504"><a href="/net/http/server.go.html#3442288">p</a></span><span class="op" id="3442505">)</span><span class="op" id="3442506">-</span><span class="num" id="3442507">1</span><span class="op" id="3442508">]</span>&nbsp;<span class="op" id="3442510">==</span>&nbsp;<span class="string" id="3442513">&#39;/&#39;</span>&nbsp;<span class="op" id="3442517">&amp;&amp;</span>&nbsp;<span class="ident" id="3442520"><a href="/net/http/server.go.html#3442373">np</a></span>&nbsp;<span class="op" id="3442523">!=</span>&nbsp;<span class="string" id="3442526">&#34;/&#34;</span>&nbsp;<span class="op" id="3442530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442534"><a href="/net/http/server.go.html#3442373">np</a></span>&nbsp;<span class="op" id="3442537">+=</span>&nbsp;<span class="string" id="3442540">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442548">return</span>&nbsp;<span class="ident" id="3442555"><a href="/net/http/server.go.html#3442373">np</a></span><br>
<span class="lineno"></span><span class="op" id="3442558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3442561">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3442616">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3442656">func</span>&nbsp;<span class="op" id="3442661">(</span><span class="ident" id="3442662">mux</span>&nbsp;<span class="op" id="3442666">*</span><span class="ident" id="3442667"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3442675">)</span>&nbsp;<span class="ident" id="3442677">match</span><span class="op" id="3442682">(</span><span class="ident" id="3442683">path</span>&nbsp;<span class="builtintype" id="3442688">string</span><span class="op" id="3442694">)</span>&nbsp;<span class="op" id="3442696">(</span><span class="ident" id="3442697">h</span>&nbsp;<span class="ident" id="3442699"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3442706">,</span>&nbsp;<span class="ident" id="3442708">pattern</span>&nbsp;<span class="builtintype" id="3442716">string</span><span class="op" id="3442722">)</span>&nbsp;<span class="op" id="3442724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442727">var</span>&nbsp;<span class="ident" id="3442731">n</span>&nbsp;<span class="op" id="3442733">=</span>&nbsp;<span class="num" id="3442735">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442738">for</span>&nbsp;<span class="ident" id="3442742">k</span><span class="op" id="3442743">,</span>&nbsp;<span class="ident" id="3442745">v</span>&nbsp;<span class="op" id="3442747">:=</span>&nbsp;<span class="keyword" id="3442750">range</span>&nbsp;<span class="ident" id="3442756"><a href="/net/http/server.go.html#3442662">mux</a></span><span class="op" id="3442759">.</span><span class="ident" id="3442760">m</span>&nbsp;<span class="op" id="3442762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442766">if</span>&nbsp;<span class="op" id="3442769">!</span><span class="ident" id="3442770"><a href="/net/http/server.go.html#3441979">pathMatch</a></span><span class="op" id="3442779">(</span><span class="ident" id="3442780"><a href="/net/http/server.go.html#3442742">k</a></span><span class="op" id="3442781">,</span>&nbsp;<span class="ident" id="3442783"><a href="/net/http/server.go.html#3442683">path</a></span><span class="op" id="3442787">)</span>&nbsp;<span class="op" id="3442789">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442794">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442809">if</span>&nbsp;<span class="ident" id="3442812"><a href="/net/http/server.go.html#3442697">h</a></span>&nbsp;<span class="op" id="3442814">==</span>&nbsp;<span class="ident" id="3442817">nil</span>&nbsp;<span class="op" id="3442821">||</span>&nbsp;<span class="builtinfunc" id="3442824">len</span><span class="op" id="3442827">(</span><span class="ident" id="3442828"><a href="/net/http/server.go.html#3442742">k</a></span><span class="op" id="3442829">)</span>&nbsp;<span class="op" id="3442831">&gt;</span>&nbsp;<span class="ident" id="3442833"><a href="/net/http/server.go.html#3442731">n</a></span>&nbsp;<span class="op" id="3442835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442840"><a href="/net/http/server.go.html#3442731">n</a></span>&nbsp;<span class="op" id="3442842">=</span>&nbsp;<span class="builtinfunc" id="3442844">len</span><span class="op" id="3442847">(</span><span class="ident" id="3442848"><a href="/net/http/server.go.html#3442742">k</a></span><span class="op" id="3442849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442854"><a href="/net/http/server.go.html#3442697">h</a></span>&nbsp;<span class="op" id="3442856">=</span>&nbsp;<span class="ident" id="3442858"><a href="/net/http/server.go.html#3442745">v</a></span><span class="op" id="3442859">.</span><span class="ident" id="3442860">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442865"><a href="/net/http/server.go.html#3442708">pattern</a></span>&nbsp;<span class="op" id="3442873">=</span>&nbsp;<span class="ident" id="3442875"><a href="/net/http/server.go.html#3442745">v</a></span><span class="op" id="3442876">.</span><span class="ident" id="3442877">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442893">return</span><br>
<span class="lineno"></span><span class="op" id="3442900">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3442903">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3442964">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3443030">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3443098">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3443164">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3443190">//</span><br>
<span class="lineno"></span><span class="comment" id="3443193">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3443257">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3443319">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3443380">//</span><br>
<span class="lineno"></span><span class="comment" id="3443383">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3443449">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3443519">func</span>&nbsp;<span class="op" id="3443524">(</span><span class="ident" id="3443525">mux</span>&nbsp;<span class="op" id="3443529">*</span><span class="ident" id="3443530"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3443538">)</span>&nbsp;<span class="ident" id="3443540">Handler</span><span class="op" id="3443547">(</span><span class="ident" id="3443548">r</span>&nbsp;<span class="op" id="3443550">*</span><span class="ident" id="3443551"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3443558">)</span>&nbsp;<span class="op" id="3443560">(</span><span class="ident" id="3443561">h</span>&nbsp;<span class="ident" id="3443563"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3443570">,</span>&nbsp;<span class="ident" id="3443572">pattern</span>&nbsp;<span class="builtintype" id="3443580">string</span><span class="op" id="3443586">)</span>&nbsp;<span class="op" id="3443588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443591">if</span>&nbsp;<span class="ident" id="3443594"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443595">.</span><span class="ident" id="3443596">Method</span>&nbsp;<span class="op" id="3443603">!=</span>&nbsp;<span class="string" id="3443606">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3443616">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443620">if</span>&nbsp;<span class="ident" id="3443623">p</span>&nbsp;<span class="op" id="3443625">:=</span>&nbsp;<span class="ident" id="3443628"><a href="/net/http/server.go.html#3442278">cleanPath</a></span><span class="op" id="3443637">(</span><span class="ident" id="3443638"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443639">.</span><span class="ident" id="3443640">URL</span><span class="op" id="3443643">.</span><span class="ident" id="3443644">Path</span><span class="op" id="3443648">)</span><span class="op" id="3443649">;</span>&nbsp;<span class="ident" id="3443651"><a href="/net/http/server.go.html#3443623">p</a></span>&nbsp;<span class="op" id="3443653">!=</span>&nbsp;<span class="ident" id="3443656"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443657">.</span><span class="ident" id="3443658">URL</span><span class="op" id="3443661">.</span><span class="ident" id="3443662">Path</span>&nbsp;<span class="op" id="3443667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443672">_</span><span class="op" id="3443673">,</span>&nbsp;<span class="ident" id="3443675"><a href="/net/http/server.go.html#3443572">pattern</a></span>&nbsp;<span class="op" id="3443683">=</span>&nbsp;<span class="ident" id="3443685"><a href="/net/http/server.go.html#3443525">mux</a></span><span class="op" id="3443688">.</span><span class="ident" id="3443689">handler</span><span class="op" id="3443696">(</span><span class="ident" id="3443697"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443698">.</span><span class="ident" id="3443699">Host</span><span class="op" id="3443703">,</span>&nbsp;<span class="ident" id="3443705"><a href="/net/http/server.go.html#3443623">p</a></span><span class="op" id="3443706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443711">url</span>&nbsp;<span class="op" id="3443715">:=</span>&nbsp;<span class="op" id="3443718">*</span><span class="ident" id="3443719"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443720">.</span><span class="ident" id="3443721">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443728"><a href="/net/http/server.go.html#3443711">url</a></span><span class="op" id="3443731">.</span><span class="ident" id="3443732">Path</span>&nbsp;<span class="op" id="3443737">=</span>&nbsp;<span class="ident" id="3443739"><a href="/net/http/server.go.html#3443623">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443744">return</span>&nbsp;<span class="ident" id="3443751"><a href="/net/http/server.go.html#3440084">RedirectHandler</a></span><span class="op" id="3443766">(</span><span class="ident" id="3443767"><a href="/net/http/server.go.html#3443711">url</a></span><span class="op" id="3443770">.</span><span class="ident" id="3443771">String</span><span class="op" id="3443777">(</span><span class="op" id="3443778">)</span><span class="op" id="3443779">,</span>&nbsp;<span class="ident" id="3443781"><a href="/net/http/status.go.html#3467012">StatusMovedPermanently</a></span><span class="op" id="3443803">)</span><span class="op" id="3443804">,</span>&nbsp;<span class="ident" id="3443806"><a href="/net/http/server.go.html#3443572">pattern</a></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443823">return</span>&nbsp;<span class="ident" id="3443830"><a href="/net/http/server.go.html#3443525">mux</a></span><span class="op" id="3443833">.</span><span class="ident" id="3443834">handler</span><span class="op" id="3443841">(</span><span class="ident" id="3443842"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443843">.</span><span class="ident" id="3443844">Host</span><span class="op" id="3443848">,</span>&nbsp;<span class="ident" id="3443850"><a href="/net/http/server.go.html#3443548">r</a></span><span class="op" id="3443851">.</span><span class="ident" id="3443852">URL</span><span class="op" id="3443855">.</span><span class="ident" id="3443856">Path</span><span class="op" id="3443860">)</span><br>
<span class="lineno"></span><span class="op" id="3443862">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3443865">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3443915">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3443989">func</span>&nbsp;<span class="op" id="3443994">(</span><span class="ident" id="3443995">mux</span>&nbsp;<span class="op" id="3443999">*</span><span class="ident" id="3444000"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3444008">)</span>&nbsp;<span class="ident" id="3444010">handler</span><span class="op" id="3444017">(</span><span class="ident" id="3444018">host</span><span class="op" id="3444022">,</span>&nbsp;<span class="ident" id="3444024">path</span>&nbsp;<span class="builtintype" id="3444029">string</span><span class="op" id="3444035">)</span>&nbsp;<span class="op" id="3444037">(</span><span class="ident" id="3444038">h</span>&nbsp;<span class="ident" id="3444040"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3444047">,</span>&nbsp;<span class="ident" id="3444049">pattern</span>&nbsp;<span class="builtintype" id="3444057">string</span><span class="op" id="3444063">)</span>&nbsp;<span class="op" id="3444065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444068"><a href="/net/http/server.go.html#3443995">mux</a></span><span class="op" id="3444071">.</span><span class="ident" id="3444072">mu</span><span class="op" id="3444074">.</span><span class="ident" id="3444075">RLock</span><span class="op" id="3444080">(</span><span class="op" id="3444081">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444084">defer</span>&nbsp;<span class="ident" id="3444090"><a href="/net/http/server.go.html#3443995">mux</a></span><span class="op" id="3444093">.</span><span class="ident" id="3444094">mu</span><span class="op" id="3444096">.</span><span class="ident" id="3444097">RUnlock</span><span class="op" id="3444104">(</span><span class="op" id="3444105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3444109">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444170">if</span>&nbsp;<span class="ident" id="3444173"><a href="/net/http/server.go.html#3443995">mux</a></span><span class="op" id="3444176">.</span><span class="ident" id="3444177">hosts</span>&nbsp;<span class="op" id="3444183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444187"><a href="/net/http/server.go.html#3444038">h</a></span><span class="op" id="3444188">,</span>&nbsp;<span class="ident" id="3444190"><a href="/net/http/server.go.html#3444049">pattern</a></span>&nbsp;<span class="op" id="3444198">=</span>&nbsp;<span class="ident" id="3444200"><a href="/net/http/server.go.html#3443995">mux</a></span><span class="op" id="3444203">.</span><span class="ident" id="3444204">match</span><span class="op" id="3444209">(</span><span class="ident" id="3444210"><a href="/net/http/server.go.html#3444018">host</a></span>&nbsp;<span class="op" id="3444215">+</span>&nbsp;<span class="ident" id="3444217"><a href="/net/http/server.go.html#3444024">path</a></span><span class="op" id="3444221">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444227">if</span>&nbsp;<span class="ident" id="3444230"><a href="/net/http/server.go.html#3444038">h</a></span>&nbsp;<span class="op" id="3444232">==</span>&nbsp;<span class="ident" id="3444235">nil</span>&nbsp;<span class="op" id="3444239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444243"><a href="/net/http/server.go.html#3444038">h</a></span><span class="op" id="3444244">,</span>&nbsp;<span class="ident" id="3444246"><a href="/net/http/server.go.html#3444049">pattern</a></span>&nbsp;<span class="op" id="3444254">=</span>&nbsp;<span class="ident" id="3444256"><a href="/net/http/server.go.html#3443995">mux</a></span><span class="op" id="3444259">.</span><span class="ident" id="3444260">match</span><span class="op" id="3444265">(</span><span class="ident" id="3444266"><a href="/net/http/server.go.html#3444024">path</a></span><span class="op" id="3444270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444276">if</span>&nbsp;<span class="ident" id="3444279"><a href="/net/http/server.go.html#3444038">h</a></span>&nbsp;<span class="op" id="3444281">==</span>&nbsp;<span class="ident" id="3444284">nil</span>&nbsp;<span class="op" id="3444288">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444292"><a href="/net/http/server.go.html#3444038">h</a></span><span class="op" id="3444293">,</span>&nbsp;<span class="ident" id="3444295"><a href="/net/http/server.go.html#3444049">pattern</a></span>&nbsp;<span class="op" id="3444303">=</span>&nbsp;<span class="ident" id="3444305"><a href="/net/http/server.go.html#3436900">NotFoundHandler</a></span><span class="op" id="3444320">(</span><span class="op" id="3444321">)</span><span class="op" id="3444322">,</span>&nbsp;<span class="string" id="3444324">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444331">return</span><br>
<span class="lineno"></span><span class="op" id="3444338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3444341">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3444398">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3444447">func</span>&nbsp;<span class="op" id="3444452">(</span><span class="ident" id="3444453">mux</span>&nbsp;<span class="op" id="3444457">*</span><span class="ident" id="3444458"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3444466">)</span>&nbsp;<span class="ident" id="3444468">ServeHTTP</span><span class="op" id="3444477">(</span><span class="ident" id="3444478">w</span>&nbsp;<span class="ident" id="3444480"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3444494">,</span>&nbsp;<span class="ident" id="3444496">r</span>&nbsp;<span class="op" id="3444498">*</span><span class="ident" id="3444499"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3444506">)</span>&nbsp;<span class="op" id="3444508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444511">if</span>&nbsp;<span class="ident" id="3444514"><a href="/net/http/server.go.html#3444496">r</a></span><span class="op" id="3444515">.</span><span class="ident" id="3444516">RequestURI</span>&nbsp;<span class="op" id="3444527">==</span>&nbsp;<span class="string" id="3444530">&#34;*&#34;</span>&nbsp;<span class="op" id="3444534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444538">if</span>&nbsp;<span class="ident" id="3444541"><a href="/net/http/server.go.html#3444496">r</a></span><span class="op" id="3444542">.</span><span class="ident" id="3444543">ProtoAtLeast</span><span class="op" id="3444555">(</span><span class="num" id="3444556">1</span><span class="op" id="3444557">,</span>&nbsp;<span class="num" id="3444559">1</span><span class="op" id="3444560">)</span>&nbsp;<span class="op" id="3444562">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444567"><a href="/net/http/server.go.html#3444478">w</a></span><span class="op" id="3444568">.</span><span class="ident" id="3444569">Header</span><span class="op" id="3444575">(</span><span class="op" id="3444576">)</span><span class="op" id="3444577">.</span><span class="ident" id="3444578">Set</span><span class="op" id="3444581">(</span><span class="string" id="3444582">&#34;Connection&#34;</span><span class="op" id="3444594">,</span>&nbsp;<span class="string" id="3444596">&#34;close&#34;</span><span class="op" id="3444603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444611"><a href="/net/http/server.go.html#3444478">w</a></span><span class="op" id="3444612">.</span><span class="ident" id="3444613">WriteHeader</span><span class="op" id="3444624">(</span><span class="ident" id="3444625"><a href="/net/http/status.go.html#3467199">StatusBadRequest</a></span><span class="op" id="3444641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444645">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444653">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444656">h</span><span class="op" id="3444657">,</span>&nbsp;<span class="ident" id="3444659">_</span>&nbsp;<span class="op" id="3444661">:=</span>&nbsp;<span class="ident" id="3444664"><a href="/net/http/server.go.html#3444453">mux</a></span><span class="op" id="3444667">.</span><span class="ident" id="3444668">Handler</span><span class="op" id="3444675">(</span><span class="ident" id="3444676"><a href="/net/http/server.go.html#3444496">r</a></span><span class="op" id="3444677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444680"><a href="/net/http/server.go.html#3444656">h</a></span><span class="op" id="3444681">.</span><span class="ident" id="3444682">ServeHTTP</span><span class="op" id="3444691">(</span><span class="ident" id="3444692"><a href="/net/http/server.go.html#3444478">w</a></span><span class="op" id="3444693">,</span>&nbsp;<span class="ident" id="3444695"><a href="/net/http/server.go.html#3444496">r</a></span><span class="op" id="3444696">)</span><br>
<span class="lineno"></span><span class="op" id="3444698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3444701">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3444756">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3444815">func</span>&nbsp;<span class="op" id="3444820">(</span><span class="ident" id="3444821">mux</span>&nbsp;<span class="op" id="3444825">*</span><span class="ident" id="3444826"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3444834">)</span>&nbsp;<span class="ident" id="3444836">Handle</span><span class="op" id="3444842">(</span><span class="ident" id="3444843">pattern</span>&nbsp;<span class="builtintype" id="3444851">string</span><span class="op" id="3444857">,</span>&nbsp;<span class="ident" id="3444859">handler</span>&nbsp;<span class="ident" id="3444867"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3444874">)</span>&nbsp;<span class="op" id="3444876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444879"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3444882">.</span><span class="ident" id="3444883">mu</span><span class="op" id="3444885">.</span><span class="ident" id="3444886">Lock</span><span class="op" id="3444890">(</span><span class="op" id="3444891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444894">defer</span>&nbsp;<span class="ident" id="3444900"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3444903">.</span><span class="ident" id="3444904">mu</span><span class="op" id="3444906">.</span><span class="ident" id="3444907">Unlock</span><span class="op" id="3444913">(</span><span class="op" id="3444914">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444918">if</span>&nbsp;<span class="ident" id="3444921"><a href="/net/http/server.go.html#3444843">pattern</a></span>&nbsp;<span class="op" id="3444929">==</span>&nbsp;<span class="string" id="3444932">&#34;&#34;</span>&nbsp;<span class="op" id="3444935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3444939">panic</span><span class="op" id="3444944">(</span><span class="string" id="3444945">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3444970">+</span>&nbsp;<span class="ident" id="3444972"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3444979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444985">if</span>&nbsp;<span class="ident" id="3444988"><a href="/net/http/server.go.html#3444859">handler</a></span>&nbsp;<span class="op" id="3444996">==</span>&nbsp;<span class="ident" id="3444999">nil</span>&nbsp;<span class="op" id="3445003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3445007">panic</span><span class="op" id="3445012">(</span><span class="string" id="3445013">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3445032">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445038">if</span>&nbsp;<span class="ident" id="3445041"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3445044">.</span><span class="ident" id="3445045">m</span><span class="op" id="3445046">[</span><span class="ident" id="3445047"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445054">]</span><span class="op" id="3445055">.</span><span class="ident" id="3445056">explicit</span>&nbsp;<span class="op" id="3445065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3445069">panic</span><span class="op" id="3445074">(</span><span class="string" id="3445075">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3445111">+</span>&nbsp;<span class="ident" id="3445113"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445127"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3445130">.</span><span class="ident" id="3445131">m</span><span class="op" id="3445132">[</span><span class="ident" id="3445133"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445140">]</span>&nbsp;<span class="op" id="3445142">=</span>&nbsp;<span class="ident" id="3445144"><a href="/net/http/server.go.html#3441646">muxEntry</a></span><span class="op" id="3445152">{</span><span class="ident" id="3445153">explicit</span><span class="op" id="3445161">:</span>&nbsp;<span class="builtintype" id="3445163">true</span><span class="op" id="3445167">,</span>&nbsp;<span class="ident" id="3445169">h</span><span class="op" id="3445170">:</span>&nbsp;<span class="ident" id="3445172"><a href="/net/http/server.go.html#3444859">handler</a></span><span class="op" id="3445179">,</span>&nbsp;<span class="ident" id="3445181">pattern</span><span class="op" id="3445188">:</span>&nbsp;<span class="ident" id="3445190"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445201">if</span>&nbsp;<span class="ident" id="3445204"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445211">[</span><span class="num" id="3445212">0</span><span class="op" id="3445213">]</span>&nbsp;<span class="op" id="3445215">!=</span>&nbsp;<span class="string" id="3445218">&#39;/&#39;</span>&nbsp;<span class="op" id="3445222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445226"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3445229">.</span><span class="ident" id="3445230">hosts</span>&nbsp;<span class="op" id="3445236">=</span>&nbsp;<span class="builtintype" id="3445238">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445244">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445248">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445270">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445345">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445399">n</span>&nbsp;<span class="op" id="3445401">:=</span>&nbsp;<span class="builtinfunc" id="3445404">len</span><span class="op" id="3445407">(</span><span class="ident" id="3445408"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445415">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445418">if</span>&nbsp;<span class="ident" id="3445421"><a href="/net/http/server.go.html#3445399">n</a></span>&nbsp;<span class="op" id="3445423">&gt;</span>&nbsp;<span class="num" id="3445425">0</span>&nbsp;<span class="op" id="3445427">&amp;&amp;</span>&nbsp;<span class="ident" id="3445430"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445437">[</span><span class="ident" id="3445438"><a href="/net/http/server.go.html#3445399">n</a></span><span class="op" id="3445439">-</span><span class="num" id="3445440">1</span><span class="op" id="3445441">]</span>&nbsp;<span class="op" id="3445443">==</span>&nbsp;<span class="string" id="3445446">&#39;/&#39;</span>&nbsp;<span class="op" id="3445450">&amp;&amp;</span>&nbsp;<span class="op" id="3445453">!</span><span class="ident" id="3445454"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3445457">.</span><span class="ident" id="3445458">m</span><span class="op" id="3445459">[</span><span class="ident" id="3445460"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445467">[</span><span class="num" id="3445468">0</span><span class="op" id="3445469">:</span><span class="ident" id="3445470"><a href="/net/http/server.go.html#3445399">n</a></span><span class="op" id="3445471">-</span><span class="num" id="3445472">1</span><span class="op" id="3445473">]</span><span class="op" id="3445474">]</span><span class="op" id="3445475">.</span><span class="ident" id="3445476">explicit</span>&nbsp;<span class="op" id="3445485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445489">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445554">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445578">path</span>&nbsp;<span class="op" id="3445583">:=</span>&nbsp;<span class="ident" id="3445586"><a href="/net/http/server.go.html#3444843">pattern</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445596">if</span>&nbsp;<span class="ident" id="3445599"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445606">[</span><span class="num" id="3445607">0</span><span class="op" id="3445608">]</span>&nbsp;<span class="op" id="3445610">!=</span>&nbsp;<span class="string" id="3445613">&#39;/&#39;</span>&nbsp;<span class="op" id="3445617">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445622">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445681">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445714"><a href="/net/http/server.go.html#3445578">path</a></span>&nbsp;<span class="op" id="3445719">=</span>&nbsp;<span class="ident" id="3445721"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445728">[</span><span class="ident" id="3445729"><a href="/net/http/server.go.html#3399932">strings</a></span><span class="op" id="3445736">.</span><span class="ident" id="3445737">Index</span><span class="op" id="3445742">(</span><span class="ident" id="3445743"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445750">,</span>&nbsp;<span class="string" id="3445752">&#34;/&#34;</span><span class="op" id="3445755">)</span><span class="op" id="3445756">:</span><span class="op" id="3445757">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445765"><a href="/net/http/server.go.html#3444821">mux</a></span><span class="op" id="3445768">.</span><span class="ident" id="3445769">m</span><span class="op" id="3445770">[</span><span class="ident" id="3445771"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445778">[</span><span class="num" id="3445779">0</span><span class="op" id="3445780">:</span><span class="ident" id="3445781"><a href="/net/http/server.go.html#3445399">n</a></span><span class="op" id="3445782">-</span><span class="num" id="3445783">1</span><span class="op" id="3445784">]</span><span class="op" id="3445785">]</span>&nbsp;<span class="op" id="3445787">=</span>&nbsp;<span class="ident" id="3445789"><a href="/net/http/server.go.html#3441646">muxEntry</a></span><span class="op" id="3445797">{</span><span class="ident" id="3445798">h</span><span class="op" id="3445799">:</span>&nbsp;<span class="ident" id="3445801"><a href="/net/http/server.go.html#3440084">RedirectHandler</a></span><span class="op" id="3445816">(</span><span class="ident" id="3445817"><a href="/net/http/server.go.html#3445578">path</a></span><span class="op" id="3445821">,</span>&nbsp;<span class="ident" id="3445823"><a href="/net/http/status.go.html#3467012">StatusMovedPermanently</a></span><span class="op" id="3445845">)</span><span class="op" id="3445846">,</span>&nbsp;<span class="ident" id="3445848">pattern</span><span class="op" id="3445855">:</span>&nbsp;<span class="ident" id="3445857"><a href="/net/http/server.go.html#3444843">pattern</a></span><span class="op" id="3445864">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445867">}</span><br>
<span class="lineno"></span><span class="op" id="3445869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3445872">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3445940">func</span>&nbsp;<span class="op" id="3445945">(</span><span class="ident" id="3445946">mux</span>&nbsp;<span class="op" id="3445950">*</span><span class="ident" id="3445951"><a href="/net/http/server.go.html#3441519">ServeMux</a></span><span class="op" id="3445959">)</span>&nbsp;<span class="ident" id="3445961">HandleFunc</span><span class="op" id="3445971">(</span><span class="ident" id="3445972">pattern</span>&nbsp;<span class="builtintype" id="3445980">string</span><span class="op" id="3445986">,</span>&nbsp;<span class="ident" id="3445988">handler</span>&nbsp;<span class="keyword" id="3445996">func</span><span class="op" id="3446000">(</span><span class="ident" id="3446001"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3446015">,</span>&nbsp;<span class="op" id="3446017">*</span><span class="ident" id="3446018"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3446025">)</span><span class="op" id="3446026">)</span>&nbsp;<span class="op" id="3446028">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446031"><a href="/net/http/server.go.html#3445946">mux</a></span><span class="op" id="3446034">.</span><span class="ident" id="3446035">Handle</span><span class="op" id="3446041">(</span><span class="ident" id="3446042"><a href="/net/http/server.go.html#3445972">pattern</a></span><span class="op" id="3446049">,</span>&nbsp;<span class="ident" id="3446051"><a href="/net/http/server.go.html#3436155">HandlerFunc</a></span><span class="op" id="3446062">(</span><span class="ident" id="3446063"><a href="/net/http/server.go.html#3445988">handler</a></span><span class="op" id="3446070">)</span><span class="op" id="3446071">)</span><br>
<span class="lineno"></span><span class="op" id="3446073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446076">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3446130">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3446157">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3446226">func</span>&nbsp;<span class="ident" id="3446231">Handle</span><span class="op" id="3446237">(</span><span class="ident" id="3446238">pattern</span>&nbsp;<span class="builtintype" id="3446246">string</span><span class="op" id="3446252">,</span>&nbsp;<span class="ident" id="3446254">handler</span>&nbsp;<span class="ident" id="3446262"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3446269">)</span>&nbsp;<span class="op" id="3446271">{</span>&nbsp;<span class="ident" id="3446273"><a href="/net/http/server.go.html#3441913">DefaultServeMux</a></span><span class="op" id="3446288">.</span><span class="ident" id="3446289">Handle</span><span class="op" id="3446295">(</span><span class="ident" id="3446296"><a href="/net/http/server.go.html#3446238">pattern</a></span><span class="op" id="3446303">,</span>&nbsp;<span class="ident" id="3446305"><a href="/net/http/server.go.html#3446254">handler</a></span><span class="op" id="3446312">)</span>&nbsp;<span class="op" id="3446314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446317">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3446384">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3446411">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3446480">func</span>&nbsp;<span class="ident" id="3446485">HandleFunc</span><span class="op" id="3446495">(</span><span class="ident" id="3446496">pattern</span>&nbsp;<span class="builtintype" id="3446504">string</span><span class="op" id="3446510">,</span>&nbsp;<span class="ident" id="3446512">handler</span>&nbsp;<span class="keyword" id="3446520">func</span><span class="op" id="3446524">(</span><span class="ident" id="3446525"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3446539">,</span>&nbsp;<span class="op" id="3446541">*</span><span class="ident" id="3446542"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3446549">)</span><span class="op" id="3446550">)</span>&nbsp;<span class="op" id="3446552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446555"><a href="/net/http/server.go.html#3441913">DefaultServeMux</a></span><span class="op" id="3446570">.</span><span class="ident" id="3446571">HandleFunc</span><span class="op" id="3446581">(</span><span class="ident" id="3446582"><a href="/net/http/server.go.html#3446496">pattern</a></span><span class="op" id="3446589">,</span>&nbsp;<span class="ident" id="3446591"><a href="/net/http/server.go.html#3446512">handler</a></span><span class="op" id="3446598">)</span><br>
<span class="lineno"></span><span class="op" id="3446600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3446603">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3446665">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3446735">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3446792">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3446864">func</span>&nbsp;<span class="ident" id="3446869">Serve</span><span class="op" id="3446874">(</span><span class="ident" id="3446875">l</span>&nbsp;<span class="ident" id="3446877"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3446880">.</span><span class="ident" id="3446881">Listener</span><span class="op" id="3446889">,</span>&nbsp;<span class="ident" id="3446891">handler</span>&nbsp;<span class="ident" id="3446899"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3446906">)</span>&nbsp;<span class="builtintype" id="3446908">error</span>&nbsp;<span class="op" id="3446914">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446917">srv</span>&nbsp;<span class="op" id="3446921">:=</span>&nbsp;<span class="op" id="3446924">&amp;</span><span class="ident" id="3446925"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3446931">{</span><span class="ident" id="3446932">Handler</span><span class="op" id="3446939">:</span>&nbsp;<span class="ident" id="3446941"><a href="/net/http/server.go.html#3446891">handler</a></span><span class="op" id="3446948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446951">return</span>&nbsp;<span class="ident" id="3446958"><a href="/net/http/server.go.html#3446917">srv</a></span><span class="op" id="3446961">.</span><span class="ident" id="3446962">Serve</span><span class="op" id="3446967">(</span><span class="ident" id="3446968"><a href="/net/http/server.go.html#3446875">l</a></span><span class="op" id="3446969">)</span><br>
<span class="lineno"></span><span class="op" id="3446971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446974">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3447033">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3447088">type</span>&nbsp;<span class="ident" id="3447093">Server</span>&nbsp;<span class="keyword" id="3447100">struct</span>&nbsp;<span class="op" id="3447107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447110">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3447125">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3447139">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447186">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447201"><a href="/net/http/server.go.html#3400945">Handler</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3447215">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447266">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447281"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3447285">.</span><span class="ident" id="3447286">Duration</span>&nbsp;<span class="comment" id="3447295">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447354">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3447369"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3447373">.</span><span class="ident" id="3447374">Duration</span>&nbsp;<span class="comment" id="3447383">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447444">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3447459">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3447473">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447537">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3447552">*</span><span class="ident" id="3447553"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3447556">.</span><span class="ident" id="3447557">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3447566">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447618">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447680">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447737">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447801">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447861">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447924">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3447982">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448034">TLSNextProto</span>&nbsp;<span class="keyword" id="3448047">map</span><span class="op" id="3448050">[</span><span class="builtintype" id="3448051">string</span><span class="op" id="3448057">]</span><span class="keyword" id="3448058">func</span><span class="op" id="3448062">(</span><span class="op" id="3448063">*</span><span class="ident" id="3448064"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3448070">,</span>&nbsp;<span class="op" id="3448072">*</span><span class="ident" id="3448073"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3448076">.</span><span class="ident" id="3448077">Conn</span><span class="op" id="3448081">,</span>&nbsp;<span class="ident" id="3448083"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3448090">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448094">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448156">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448215">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448272">ConnState</span>&nbsp;<span class="keyword" id="3448282">func</span><span class="op" id="3448286">(</span><span class="ident" id="3448287"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3448290">.</span><span class="ident" id="3448291">Conn</span><span class="op" id="3448295">,</span>&nbsp;<span class="ident" id="3448297"><a href="/net/http/server.go.html#3448712">ConnState</a></span><span class="op" id="3448306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448310">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448373">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448428">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448488">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448509">ErrorLog</span>&nbsp;<span class="op" id="3448518">*</span><span class="ident" id="3448519"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3448522">.</span><span class="ident" id="3448523">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448532">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3448550">int32</span>&nbsp;<span class="comment" id="3448556">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3448580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3448583">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3448655">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3448707">type</span>&nbsp;<span class="ident" id="3448712">ConnState</span>&nbsp;<span class="builtintype" id="3448722">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3448727">const</span>&nbsp;<span class="op" id="3448733">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448736">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448797">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448855">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448910">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448927">StateNew</span>&nbsp;<span class="ident" id="3448936"><a href="/net/http/server.go.html#3448712">ConnState</a></span>&nbsp;<span class="op" id="3448946">=</span>&nbsp;<span class="ident" id="3448948">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448955">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449019">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449073">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449136">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449190">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449243">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449304">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449318">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449374">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449437">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449498">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449540">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449552">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449604">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449673">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449689">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449737">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3449795">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449826">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3449838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3449841">var</span>&nbsp;<span class="ident" id="3449845">stateName</span>&nbsp;<span class="op" id="3449855">=</span>&nbsp;<span class="keyword" id="3449857">map</span><span class="op" id="3449860">[</span><span class="ident" id="3449861"><a href="/net/http/server.go.html#3448712">ConnState</a></span><span class="op" id="3449870">]</span><span class="builtintype" id="3449871">string</span><span class="op" id="3449877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449880"><a href="/net/http/server.go.html#3448927">StateNew</a></span><span class="op" id="3449888">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3449895">&#34;new&#34;</span><span class="op" id="3449900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449903"><a href="/net/http/server.go.html#3449304">StateActive</a></span><span class="op" id="3449914">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3449918">&#34;active&#34;</span><span class="op" id="3449926">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449929"><a href="/net/http/server.go.html#3449540">StateIdle</a></span><span class="op" id="3449938">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3449944">&#34;idle&#34;</span><span class="op" id="3449950">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449953"><a href="/net/http/server.go.html#3449673">StateHijacked</a></span><span class="op" id="3449966">:</span>&nbsp;<span class="string" id="3449968">&#34;hijacked&#34;</span><span class="op" id="3449978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449981"><a href="/net/http/server.go.html#3449826">StateClosed</a></span><span class="op" id="3449992">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3449996">&#34;closed&#34;</span><span class="op" id="3450004">,</span><br>
<span class="lineno"></span><span class="op" id="3450006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3450009">func</span>&nbsp;<span class="op" id="3450014">(</span><span class="ident" id="3450015">c</span>&nbsp;<span class="ident" id="3450017"><a href="/net/http/server.go.html#3448712">ConnState</a></span><span class="op" id="3450026">)</span>&nbsp;<span class="ident" id="3450028">String</span><span class="op" id="3450034">(</span><span class="op" id="3450035">)</span>&nbsp;<span class="builtintype" id="3450037">string</span>&nbsp;<span class="op" id="3450044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450047">return</span>&nbsp;<span class="ident" id="3450054"><a href="/net/http/server.go.html#3449845">stateName</a></span><span class="op" id="3450063">[</span><span class="ident" id="3450064"><a href="/net/http/server.go.html#3450015">c</a></span><span class="op" id="3450065">]</span><br>
<span class="lineno"></span><span class="op" id="3450067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3450070">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3450131">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3450189">type</span>&nbsp;<span class="ident" id="3450194">serverHandler</span>&nbsp;<span class="keyword" id="3450208">struct</span>&nbsp;<span class="op" id="3450215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450218">srv</span>&nbsp;<span class="op" id="3450222">*</span><span class="ident" id="3450223"><a href="/net/http/server.go.html#3447093">Server</a></span><br>
<span class="lineno"></span><span class="op" id="3450230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3450233">func</span>&nbsp;<span class="op" id="3450238">(</span><span class="ident" id="3450239">sh</span>&nbsp;<span class="ident" id="3450242"><a href="/net/http/server.go.html#3450194">serverHandler</a></span><span class="op" id="3450255">)</span>&nbsp;<span class="ident" id="3450257">ServeHTTP</span><span class="op" id="3450266">(</span><span class="ident" id="3450267">rw</span>&nbsp;<span class="ident" id="3450270"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3450284">,</span>&nbsp;<span class="ident" id="3450286">req</span>&nbsp;<span class="op" id="3450290">*</span><span class="ident" id="3450291"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3450298">)</span>&nbsp;<span class="op" id="3450300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450303">handler</span>&nbsp;<span class="op" id="3450311">:=</span>&nbsp;<span class="ident" id="3450314"><a href="/net/http/server.go.html#3450239">sh</a></span><span class="op" id="3450316">.</span><span class="ident" id="3450317">srv</span><span class="op" id="3450320">.</span><span class="ident" id="3450321">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450330">if</span>&nbsp;<span class="ident" id="3450333"><a href="/net/http/server.go.html#3450303">handler</a></span>&nbsp;<span class="op" id="3450341">==</span>&nbsp;<span class="ident" id="3450344">nil</span>&nbsp;<span class="op" id="3450348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450352"><a href="/net/http/server.go.html#3450303">handler</a></span>&nbsp;<span class="op" id="3450360">=</span>&nbsp;<span class="ident" id="3450362"><a href="/net/http/server.go.html#3441913">DefaultServeMux</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450379">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450382">if</span>&nbsp;<span class="ident" id="3450385"><a href="/net/http/server.go.html#3450286">req</a></span><span class="op" id="3450388">.</span><span class="ident" id="3450389">RequestURI</span>&nbsp;<span class="op" id="3450400">==</span>&nbsp;<span class="string" id="3450403">&#34;*&#34;</span>&nbsp;<span class="op" id="3450407">&amp;&amp;</span>&nbsp;<span class="ident" id="3450410"><a href="/net/http/server.go.html#3450286">req</a></span><span class="op" id="3450413">.</span><span class="ident" id="3450414">Method</span>&nbsp;<span class="op" id="3450421">==</span>&nbsp;<span class="string" id="3450424">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3450434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450438"><a href="/net/http/server.go.html#3450303">handler</a></span>&nbsp;<span class="op" id="3450446">=</span>&nbsp;<span class="ident" id="3450448"><a href="/net/http/server.go.html#3458108">globalOptionsHandler</a></span><span class="op" id="3450468">{</span><span class="op" id="3450469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450475"><a href="/net/http/server.go.html#3450303">handler</a></span><span class="op" id="3450482">.</span><span class="ident" id="3450483">ServeHTTP</span><span class="op" id="3450492">(</span><span class="ident" id="3450493"><a href="/net/http/server.go.html#3450267">rw</a></span><span class="op" id="3450495">,</span>&nbsp;<span class="ident" id="3450497"><a href="/net/http/server.go.html#3450286">req</a></span><span class="op" id="3450500">)</span><br>
<span class="lineno"></span><span class="op" id="3450502">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3450505">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3450576">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3450639">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3450678">func</span>&nbsp;<span class="op" id="3450683">(</span><span class="ident" id="3450684">srv</span>&nbsp;<span class="op" id="3450688">*</span><span class="ident" id="3450689"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3450695">)</span>&nbsp;<span class="ident" id="3450697">ListenAndServe</span><span class="op" id="3450711">(</span><span class="op" id="3450712">)</span>&nbsp;<span class="builtintype" id="3450714">error</span>&nbsp;<span class="op" id="3450720">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450723">addr</span>&nbsp;<span class="op" id="3450728">:=</span>&nbsp;<span class="ident" id="3450731"><a href="/net/http/server.go.html#3450684">srv</a></span><span class="op" id="3450734">.</span><span class="ident" id="3450735">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450741">if</span>&nbsp;<span class="ident" id="3450744"><a href="/net/http/server.go.html#3450723">addr</a></span>&nbsp;<span class="op" id="3450749">==</span>&nbsp;<span class="string" id="3450752">&#34;&#34;</span>&nbsp;<span class="op" id="3450755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450759"><a href="/net/http/server.go.html#3450723">addr</a></span>&nbsp;<span class="op" id="3450764">=</span>&nbsp;<span class="string" id="3450766">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450778">ln</span><span class="op" id="3450780">,</span>&nbsp;<span class="ident" id="3450782">err</span>&nbsp;<span class="op" id="3450786">:=</span>&nbsp;<span class="ident" id="3450789"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3450792">.</span><span class="ident" id="3450793">Listen</span><span class="op" id="3450799">(</span><span class="string" id="3450800">&#34;tcp&#34;</span><span class="op" id="3450805">,</span>&nbsp;<span class="ident" id="3450807"><a href="/net/http/server.go.html#3450723">addr</a></span><span class="op" id="3450811">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450814">if</span>&nbsp;<span class="ident" id="3450817"><a href="/net/http/server.go.html#3450782">err</a></span>&nbsp;<span class="op" id="3450821">!=</span>&nbsp;<span class="ident" id="3450824">nil</span>&nbsp;<span class="op" id="3450828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450832">return</span>&nbsp;<span class="ident" id="3450839"><a href="/net/http/server.go.html#3450782">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450847">return</span>&nbsp;<span class="ident" id="3450854"><a href="/net/http/server.go.html#3450684">srv</a></span><span class="op" id="3450857">.</span><span class="ident" id="3450858">Serve</span><span class="op" id="3450863">(</span><span class="ident" id="3450864"><a href="/net/http/server.go.html#3457790">tcpKeepAliveListener</a></span><span class="op" id="3450884">{</span><span class="ident" id="3450885"><a href="/net/http/server.go.html#3450778">ln</a></span><span class="op" id="3450887">.</span><span class="op" id="3450888">(</span><span class="op" id="3450889">*</span><span class="ident" id="3450890"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3450893">.</span><span class="ident" id="3450894">TCPListener</span><span class="op" id="3450905">)</span><span class="op" id="3450906">}</span><span class="op" id="3450907">)</span><br>
<span class="lineno"></span><span class="op" id="3450909">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3450912">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3450980">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3451057">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3451100">func</span>&nbsp;<span class="op" id="3451105">(</span><span class="ident" id="3451106">srv</span>&nbsp;<span class="op" id="3451110">*</span><span class="ident" id="3451111"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3451117">)</span>&nbsp;<span class="ident" id="3451119">Serve</span><span class="op" id="3451124">(</span><span class="ident" id="3451125">l</span>&nbsp;<span class="ident" id="3451127"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3451130">.</span><span class="ident" id="3451131">Listener</span><span class="op" id="3451139">)</span>&nbsp;<span class="builtintype" id="3451141">error</span>&nbsp;<span class="op" id="3451147">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451150">defer</span>&nbsp;<span class="ident" id="3451156"><a href="/net/http/server.go.html#3451125">l</a></span><span class="op" id="3451157">.</span><span class="ident" id="3451158">Close</span><span class="op" id="3451163">(</span><span class="op" id="3451164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451167">var</span>&nbsp;<span class="ident" id="3451171">tempDelay</span>&nbsp;<span class="ident" id="3451181"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3451185">.</span><span class="ident" id="3451186">Duration</span>&nbsp;<span class="comment" id="3451195">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451235">for</span>&nbsp;<span class="op" id="3451239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451243">rw</span><span class="op" id="3451245">,</span>&nbsp;<span class="ident" id="3451247">e</span>&nbsp;<span class="op" id="3451249">:=</span>&nbsp;<span class="ident" id="3451252"><a href="/net/http/server.go.html#3451125">l</a></span><span class="op" id="3451253">.</span><span class="ident" id="3451254">Accept</span><span class="op" id="3451260">(</span><span class="op" id="3451261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451265">if</span>&nbsp;<span class="ident" id="3451268"><a href="/net/http/server.go.html#3451247">e</a></span>&nbsp;<span class="op" id="3451270">!=</span>&nbsp;<span class="ident" id="3451273">nil</span>&nbsp;<span class="op" id="3451277">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451282">if</span>&nbsp;<span class="ident" id="3451285">ne</span><span class="op" id="3451287">,</span>&nbsp;<span class="ident" id="3451289">ok</span>&nbsp;<span class="op" id="3451292">:=</span>&nbsp;<span class="ident" id="3451295"><a href="/net/http/server.go.html#3451247">e</a></span><span class="op" id="3451296">.</span><span class="op" id="3451297">(</span><span class="ident" id="3451298"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3451301">.</span><span class="ident" id="3451302">Error</span><span class="op" id="3451307">)</span><span class="op" id="3451308">;</span>&nbsp;<span class="ident" id="3451310"><a href="/net/http/server.go.html#3451289">ok</a></span>&nbsp;<span class="op" id="3451313">&amp;&amp;</span>&nbsp;<span class="ident" id="3451316"><a href="/net/http/server.go.html#3451285">ne</a></span><span class="op" id="3451318">.</span><span class="ident" id="3451319">Temporary</span><span class="op" id="3451328">(</span><span class="op" id="3451329">)</span>&nbsp;<span class="op" id="3451331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451337">if</span>&nbsp;<span class="ident" id="3451340"><a href="/net/http/server.go.html#3451171">tempDelay</a></span>&nbsp;<span class="op" id="3451350">==</span>&nbsp;<span class="num" id="3451353">0</span>&nbsp;<span class="op" id="3451355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451362"><a href="/net/http/server.go.html#3451171">tempDelay</a></span>&nbsp;<span class="op" id="3451372">=</span>&nbsp;<span class="num" id="3451374">5</span>&nbsp;<span class="op" id="3451376">*</span>&nbsp;<span class="ident" id="3451378"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3451382">.</span><span class="ident" id="3451383">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451399">}</span>&nbsp;<span class="keyword" id="3451401">else</span>&nbsp;<span class="op" id="3451406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451413"><a href="/net/http/server.go.html#3451171">tempDelay</a></span>&nbsp;<span class="op" id="3451423">*=</span>&nbsp;<span class="num" id="3451426">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451438">if</span>&nbsp;<span class="ident" id="3451441">max</span>&nbsp;<span class="op" id="3451445">:=</span>&nbsp;<span class="num" id="3451448">1</span>&nbsp;<span class="op" id="3451450">*</span>&nbsp;<span class="ident" id="3451452"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3451456">.</span><span class="ident" id="3451457">Second</span><span class="op" id="3451463">;</span>&nbsp;<span class="ident" id="3451465"><a href="/net/http/server.go.html#3451171">tempDelay</a></span>&nbsp;<span class="op" id="3451475">&gt;</span>&nbsp;<span class="ident" id="3451477"><a href="/net/http/server.go.html#3451441">max</a></span>&nbsp;<span class="op" id="3451481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451488"><a href="/net/http/server.go.html#3451171">tempDelay</a></span>&nbsp;<span class="op" id="3451498">=</span>&nbsp;<span class="ident" id="3451500"><a href="/net/http/server.go.html#3451441">max</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451514"><a href="/net/http/server.go.html#3451106">srv</a></span><span class="op" id="3451517">.</span><span class="ident" id="3451518">logf</span><span class="op" id="3451522">(</span><span class="string" id="3451523">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3451563">,</span>&nbsp;<span class="ident" id="3451565"><a href="/net/http/server.go.html#3451247">e</a></span><span class="op" id="3451566">,</span>&nbsp;<span class="ident" id="3451568"><a href="/net/http/server.go.html#3451171">tempDelay</a></span><span class="op" id="3451577">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451583"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3451587">.</span><span class="ident" id="3451588">Sleep</span><span class="op" id="3451593">(</span><span class="ident" id="3451594"><a href="/net/http/server.go.html#3451171">tempDelay</a></span><span class="op" id="3451603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451609">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451626">return</span>&nbsp;<span class="ident" id="3451633"><a href="/net/http/server.go.html#3451247">e</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451637">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451641"><a href="/net/http/server.go.html#3451171">tempDelay</a></span>&nbsp;<span class="op" id="3451651">=</span>&nbsp;<span class="num" id="3451653">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451657">c</span><span class="op" id="3451658">,</span>&nbsp;<span class="ident" id="3451660">err</span>&nbsp;<span class="op" id="3451664">:=</span>&nbsp;<span class="ident" id="3451667"><a href="/net/http/server.go.html#3451106">srv</a></span><span class="op" id="3451670">.</span><span class="ident" id="3451671">newConn</span><span class="op" id="3451678">(</span><span class="ident" id="3451679"><a href="/net/http/server.go.html#3451243">rw</a></span><span class="op" id="3451681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451685">if</span>&nbsp;<span class="ident" id="3451688"><a href="/net/http/server.go.html#3451660">err</a></span>&nbsp;<span class="op" id="3451692">!=</span>&nbsp;<span class="ident" id="3451695">nil</span>&nbsp;<span class="op" id="3451699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451704">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451715">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451719"><a href="/net/http/server.go.html#3451657">c</a></span><span class="op" id="3451720">.</span><span class="ident" id="3451721">setState</span><span class="op" id="3451729">(</span><span class="ident" id="3451730"><a href="/net/http/server.go.html#3451657">c</a></span><span class="op" id="3451731">.</span><span class="ident" id="3451732">rwc</span><span class="op" id="3451735">,</span>&nbsp;<span class="ident" id="3451737"><a href="/net/http/server.go.html#3448927">StateNew</a></span><span class="op" id="3451745">)</span>&nbsp;<span class="comment" id="3451747">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451776">go</span>&nbsp;<span class="ident" id="3451779"><a href="/net/http/server.go.html#3451657">c</a></span><span class="op" id="3451780">.</span><span class="ident" id="3451781">serve</span><span class="op" id="3451786">(</span><span class="op" id="3451787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451790">}</span><br>
<span class="lineno"></span><span class="op" id="3451792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3451795">func</span>&nbsp;<span class="op" id="3451800">(</span><span class="ident" id="3451801">s</span>&nbsp;<span class="op" id="3451803">*</span><span class="ident" id="3451804"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3451810">)</span>&nbsp;<span class="ident" id="3451812">doKeepAlives</span><span class="op" id="3451824">(</span><span class="op" id="3451825">)</span>&nbsp;<span class="builtintype" id="3451827">bool</span>&nbsp;<span class="op" id="3451832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451835">return</span>&nbsp;<span class="ident" id="3451842"><a href="/net/http/server.go.html#3399951">atomic</a></span><span class="op" id="3451848">.</span><span class="ident" id="3451849">LoadInt32</span><span class="op" id="3451858">(</span><span class="op" id="3451859">&amp;</span><span class="ident" id="3451860"><a href="/net/http/server.go.html#3451801">s</a></span><span class="op" id="3451861">.</span><span class="ident" id="3451862">disableKeepAlives</span><span class="op" id="3451879">)</span>&nbsp;<span class="op" id="3451881">==</span>&nbsp;<span class="num" id="3451884">0</span><br>
<span class="lineno"></span><span class="op" id="3451886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3451889">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3451960">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3452017">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3452083">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3452121">func</span>&nbsp;<span class="op" id="3452126">(</span><span class="ident" id="3452127">s</span>&nbsp;<span class="op" id="3452129">*</span><span class="ident" id="3452130"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3452136">)</span>&nbsp;<span class="ident" id="3452138">SetKeepAlivesEnabled</span><span class="op" id="3452158">(</span><span class="ident" id="3452159">v</span>&nbsp;<span class="builtintype" id="3452161">bool</span><span class="op" id="3452165">)</span>&nbsp;<span class="op" id="3452167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452170">if</span>&nbsp;<span class="ident" id="3452173"><a href="/net/http/server.go.html#3452159">v</a></span>&nbsp;<span class="op" id="3452175">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452179"><a href="/net/http/server.go.html#3399951">atomic</a></span><span class="op" id="3452185">.</span><span class="ident" id="3452186">StoreInt32</span><span class="op" id="3452196">(</span><span class="op" id="3452197">&amp;</span><span class="ident" id="3452198"><a href="/net/http/server.go.html#3452127">s</a></span><span class="op" id="3452199">.</span><span class="ident" id="3452200">disableKeepAlives</span><span class="op" id="3452217">,</span>&nbsp;<span class="num" id="3452219">0</span><span class="op" id="3452220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452223">}</span>&nbsp;<span class="keyword" id="3452225">else</span>&nbsp;<span class="op" id="3452230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452234"><a href="/net/http/server.go.html#3399951">atomic</a></span><span class="op" id="3452240">.</span><span class="ident" id="3452241">StoreInt32</span><span class="op" id="3452251">(</span><span class="op" id="3452252">&amp;</span><span class="ident" id="3452253"><a href="/net/http/server.go.html#3452127">s</a></span><span class="op" id="3452254">.</span><span class="ident" id="3452255">disableKeepAlives</span><span class="op" id="3452272">,</span>&nbsp;<span class="num" id="3452274">1</span><span class="op" id="3452275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452278">}</span><br>
<span class="lineno"></span><span class="op" id="3452280">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3452283">func</span>&nbsp;<span class="op" id="3452288">(</span><span class="ident" id="3452289">s</span>&nbsp;<span class="op" id="3452291">*</span><span class="ident" id="3452292"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3452298">)</span>&nbsp;<span class="ident" id="3452300">logf</span><span class="op" id="3452304">(</span><span class="ident" id="3452305">format</span>&nbsp;<span class="builtintype" id="3452312">string</span><span class="op" id="3452318">,</span>&nbsp;<span class="ident" id="3452320">args</span>&nbsp;<span class="op" id="3452325">...</span><span class="keyword" id="3452328">interface</span><span class="op" id="3452337">{</span><span class="op" id="3452338">}</span><span class="op" id="3452339">)</span>&nbsp;<span class="op" id="3452341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452344">if</span>&nbsp;<span class="ident" id="3452347"><a href="/net/http/server.go.html#3452289">s</a></span><span class="op" id="3452348">.</span><span class="ident" id="3452349">ErrorLog</span>&nbsp;<span class="op" id="3452358">!=</span>&nbsp;<span class="ident" id="3452361">nil</span>&nbsp;<span class="op" id="3452365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452369"><a href="/net/http/server.go.html#3452289">s</a></span><span class="op" id="3452370">.</span><span class="ident" id="3452371">ErrorLog</span><span class="op" id="3452379">.</span><span class="ident" id="3452380">Printf</span><span class="op" id="3452386">(</span><span class="ident" id="3452387"><a href="/net/http/server.go.html#3452305">format</a></span><span class="op" id="3452393">,</span>&nbsp;<span class="ident" id="3452395"><a href="/net/http/server.go.html#3452320">args</a></span><span class="op" id="3452399">...</span><span class="op" id="3452402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452405">}</span>&nbsp;<span class="keyword" id="3452407">else</span>&nbsp;<span class="op" id="3452412">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452416"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3452419">.</span><span class="ident" id="3452420">Printf</span><span class="op" id="3452426">(</span><span class="ident" id="3452427"><a href="/net/http/server.go.html#3452305">format</a></span><span class="op" id="3452433">,</span>&nbsp;<span class="ident" id="3452435"><a href="/net/http/server.go.html#3452320">args</a></span><span class="op" id="3452439">...</span><span class="op" id="3452442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452445">}</span><br>
<span class="lineno"></span><span class="op" id="3452447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452450">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3452508">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3452564">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3452619">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3452665">//</span><br>
<span class="lineno"></span><span class="comment" id="3452668">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3452700">//</span><br>
<span class="lineno"></span><span class="comment" id="3452703">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3452719">//</span><br>
<span class="lineno"></span><span class="comment" id="3452722">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3452734">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3452743">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3452758">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3452768">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3452773">//</span><br>
<span class="lineno"></span><span class="comment" id="3452776">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3452810">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3452874">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3452915">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3452920">//</span><br>
<span class="lineno"></span><span class="comment" id="3452923">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3452940">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3452983">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3453029">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3453049">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3453089">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="3453095">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="3453100">func</span>&nbsp;<span class="ident" id="3453105">ListenAndServe</span><span class="op" id="3453119">(</span><span class="ident" id="3453120">addr</span>&nbsp;<span class="builtintype" id="3453125">string</span><span class="op" id="3453131">,</span>&nbsp;<span class="ident" id="3453133">handler</span>&nbsp;<span class="ident" id="3453141"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3453148">)</span>&nbsp;<span class="builtintype" id="3453150">error</span>&nbsp;<span class="op" id="3453156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453159">server</span>&nbsp;<span class="op" id="3453166">:=</span>&nbsp;<span class="op" id="3453169">&amp;</span><span class="ident" id="3453170"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3453176">{</span><span class="ident" id="3453177">Addr</span><span class="op" id="3453181">:</span>&nbsp;<span class="ident" id="3453183"><a href="/net/http/server.go.html#3453120">addr</a></span><span class="op" id="3453187">,</span>&nbsp;<span class="ident" id="3453189">Handler</span><span class="op" id="3453196">:</span>&nbsp;<span class="ident" id="3453198"><a href="/net/http/server.go.html#3453133">handler</a></span><span class="op" id="3453205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453208">return</span>&nbsp;<span class="ident" id="3453215"><a href="/net/http/server.go.html#3453159">server</a></span><span class="op" id="3453221">.</span><span class="ident" id="3453222">ListenAndServe</span><span class="op" id="3453236">(</span><span class="op" id="3453237">)</span><br>
<span class="lineno"></span><span class="op" id="3453239">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3453242">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3453314">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3453393">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3453469">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3453551">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3453616">//</span><br>
<span class="lineno"></span><span class="comment" id="3453619">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3453651">//</span><br>
<span class="lineno"></span><span class="comment" id="3453654">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3453666">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3453676">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3453691">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3453696">//</span><br>
<span class="lineno"></span><span class="comment" id="3453699">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3453759">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3453808">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3453860">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3453865">//</span><br>
<span class="lineno"></span><span class="comment" id="3453868">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3453885">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3453919">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3453994">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3454066">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3454086">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3454106">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3454112">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3454117">//</span><br>
<span class="lineno"></span><span class="comment" id="3454120">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3454200">func</span>&nbsp;<span class="ident" id="3454205">ListenAndServeTLS</span><span class="op" id="3454222">(</span><span class="ident" id="3454223">addr</span>&nbsp;<span class="builtintype" id="3454228">string</span><span class="op" id="3454234">,</span>&nbsp;<span class="ident" id="3454236">certFile</span>&nbsp;<span class="builtintype" id="3454245">string</span><span class="op" id="3454251">,</span>&nbsp;<span class="ident" id="3454253">keyFile</span>&nbsp;<span class="builtintype" id="3454261">string</span><span class="op" id="3454267">,</span>&nbsp;<span class="ident" id="3454269">handler</span>&nbsp;<span class="ident" id="3454277"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3454284">)</span>&nbsp;<span class="builtintype" id="3454286">error</span>&nbsp;<span class="op" id="3454292">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454295">server</span>&nbsp;<span class="op" id="3454302">:=</span>&nbsp;<span class="op" id="3454305">&amp;</span><span class="ident" id="3454306"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3454312">{</span><span class="ident" id="3454313">Addr</span><span class="op" id="3454317">:</span>&nbsp;<span class="ident" id="3454319"><a href="/net/http/server.go.html#3454223">addr</a></span><span class="op" id="3454323">,</span>&nbsp;<span class="ident" id="3454325">Handler</span><span class="op" id="3454332">:</span>&nbsp;<span class="ident" id="3454334"><a href="/net/http/server.go.html#3454269">handler</a></span><span class="op" id="3454341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454344">return</span>&nbsp;<span class="ident" id="3454351"><a href="/net/http/server.go.html#3454295">server</a></span><span class="op" id="3454357">.</span><span class="ident" id="3454358">ListenAndServeTLS</span><span class="op" id="3454375">(</span><span class="ident" id="3454376"><a href="/net/http/server.go.html#3454236">certFile</a></span><span class="op" id="3454384">,</span>&nbsp;<span class="ident" id="3454386"><a href="/net/http/server.go.html#3454253">keyFile</a></span><span class="op" id="3454393">)</span><br>
<span class="lineno"></span><span class="op" id="3454395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3454398">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3454467">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3454535">//</span><br>
<span class="lineno"></span><span class="comment" id="3454538">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3454605">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3454671">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3454738">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3454803">//</span><br>
<span class="lineno"></span><span class="comment" id="3454806">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3454849">func</span>&nbsp;<span class="op" id="3454854">(</span><span class="ident" id="3454855">srv</span>&nbsp;<span class="op" id="3454859">*</span><span class="ident" id="3454860"><a href="/net/http/server.go.html#3447093">Server</a></span><span class="op" id="3454866">)</span>&nbsp;<span class="ident" id="3454868">ListenAndServeTLS</span><span class="op" id="3454885">(</span><span class="ident" id="3454886">certFile</span><span class="op" id="3454894">,</span>&nbsp;<span class="ident" id="3454896">keyFile</span>&nbsp;<span class="builtintype" id="3454904">string</span><span class="op" id="3454910">)</span>&nbsp;<span class="builtintype" id="3454912">error</span>&nbsp;<span class="op" id="3454918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454921">addr</span>&nbsp;<span class="op" id="3454926">:=</span>&nbsp;<span class="ident" id="3454929"><a href="/net/http/server.go.html#3454855">srv</a></span><span class="op" id="3454932">.</span><span class="ident" id="3454933">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454939">if</span>&nbsp;<span class="ident" id="3454942"><a href="/net/http/server.go.html#3454921">addr</a></span>&nbsp;<span class="op" id="3454947">==</span>&nbsp;<span class="string" id="3454950">&#34;&#34;</span>&nbsp;<span class="op" id="3454953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454957"><a href="/net/http/server.go.html#3454921">addr</a></span>&nbsp;<span class="op" id="3454962">=</span>&nbsp;<span class="string" id="3454964">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454977">config</span>&nbsp;<span class="op" id="3454984">:=</span>&nbsp;<span class="op" id="3454987">&amp;</span><span class="ident" id="3454988"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3454991">.</span><span class="ident" id="3454992">Config</span><span class="op" id="3454998">{</span><span class="op" id="3454999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455002">if</span>&nbsp;<span class="ident" id="3455005"><a href="/net/http/server.go.html#3454855">srv</a></span><span class="op" id="3455008">.</span><span class="ident" id="3455009">TLSConfig</span>&nbsp;<span class="op" id="3455019">!=</span>&nbsp;<span class="ident" id="3455022">nil</span>&nbsp;<span class="op" id="3455026">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455030">*</span><span class="ident" id="3455031"><a href="/net/http/server.go.html#3454977">config</a></span>&nbsp;<span class="op" id="3455038">=</span>&nbsp;<span class="op" id="3455040">*</span><span class="ident" id="3455041"><a href="/net/http/server.go.html#3454855">srv</a></span><span class="op" id="3455044">.</span><span class="ident" id="3455045">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455059">if</span>&nbsp;<span class="ident" id="3455062"><a href="/net/http/server.go.html#3454977">config</a></span><span class="op" id="3455068">.</span><span class="ident" id="3455069">NextProtos</span>&nbsp;<span class="op" id="3455080">==</span>&nbsp;<span class="ident" id="3455083">nil</span>&nbsp;<span class="op" id="3455087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455091"><a href="/net/http/server.go.html#3454977">config</a></span><span class="op" id="3455097">.</span><span class="ident" id="3455098">NextProtos</span>&nbsp;<span class="op" id="3455109">=</span>&nbsp;<span class="op" id="3455111">[</span><span class="op" id="3455112">]</span><span class="builtintype" id="3455113">string</span><span class="op" id="3455119">{</span><span class="string" id="3455120">&#34;http/1.1&#34;</span><span class="op" id="3455130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455133">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455137">var</span>&nbsp;<span class="ident" id="3455141">err</span>&nbsp;<span class="builtintype" id="3455145">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455152"><a href="/net/http/server.go.html#3454977">config</a></span><span class="op" id="3455158">.</span><span class="ident" id="3455159">Certificates</span>&nbsp;<span class="op" id="3455172">=</span>&nbsp;<span class="builtinfunc" id="3455174">make</span><span class="op" id="3455178">(</span><span class="op" id="3455179">[</span><span class="op" id="3455180">]</span><span class="ident" id="3455181"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3455184">.</span><span class="ident" id="3455185">Certificate</span><span class="op" id="3455196">,</span>&nbsp;<span class="num" id="3455198">1</span><span class="op" id="3455199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455202"><a href="/net/http/server.go.html#3454977">config</a></span><span class="op" id="3455208">.</span><span class="ident" id="3455209">Certificates</span><span class="op" id="3455221">[</span><span class="num" id="3455222">0</span><span class="op" id="3455223">]</span><span class="op" id="3455224">,</span>&nbsp;<span class="ident" id="3455226"><a href="/net/http/server.go.html#3455141">err</a></span>&nbsp;<span class="op" id="3455230">=</span>&nbsp;<span class="ident" id="3455232"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3455235">.</span><span class="ident" id="3455236">LoadX509KeyPair</span><span class="op" id="3455251">(</span><span class="ident" id="3455252"><a href="/net/http/server.go.html#3454886">certFile</a></span><span class="op" id="3455260">,</span>&nbsp;<span class="ident" id="3455262"><a href="/net/http/server.go.html#3454896">keyFile</a></span><span class="op" id="3455269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455272">if</span>&nbsp;<span class="ident" id="3455275"><a href="/net/http/server.go.html#3455141">err</a></span>&nbsp;<span class="op" id="3455279">!=</span>&nbsp;<span class="ident" id="3455282">nil</span>&nbsp;<span class="op" id="3455286">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455290">return</span>&nbsp;<span class="ident" id="3455297"><a href="/net/http/server.go.html#3455141">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455306">ln</span><span class="op" id="3455308">,</span>&nbsp;<span class="ident" id="3455310"><a href="/net/http/server.go.html#3455141">err</a></span>&nbsp;<span class="op" id="3455314">:=</span>&nbsp;<span class="ident" id="3455317"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3455320">.</span><span class="ident" id="3455321">Listen</span><span class="op" id="3455327">(</span><span class="string" id="3455328">&#34;tcp&#34;</span><span class="op" id="3455333">,</span>&nbsp;<span class="ident" id="3455335"><a href="/net/http/server.go.html#3454921">addr</a></span><span class="op" id="3455339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455342">if</span>&nbsp;<span class="ident" id="3455345"><a href="/net/http/server.go.html#3455141">err</a></span>&nbsp;<span class="op" id="3455349">!=</span>&nbsp;<span class="ident" id="3455352">nil</span>&nbsp;<span class="op" id="3455356">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455360">return</span>&nbsp;<span class="ident" id="3455367"><a href="/net/http/server.go.html#3455141">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455376">tlsListener</span>&nbsp;<span class="op" id="3455388">:=</span>&nbsp;<span class="ident" id="3455391"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3455394">.</span><span class="ident" id="3455395">NewListener</span><span class="op" id="3455406">(</span><span class="ident" id="3455407"><a href="/net/http/server.go.html#3457790">tcpKeepAliveListener</a></span><span class="op" id="3455427">{</span><span class="ident" id="3455428"><a href="/net/http/server.go.html#3455306">ln</a></span><span class="op" id="3455430">.</span><span class="op" id="3455431">(</span><span class="op" id="3455432">*</span><span class="ident" id="3455433"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3455436">.</span><span class="ident" id="3455437">TCPListener</span><span class="op" id="3455448">)</span><span class="op" id="3455449">}</span><span class="op" id="3455450">,</span>&nbsp;<span class="ident" id="3455452"><a href="/net/http/server.go.html#3454977">config</a></span><span class="op" id="3455458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455461">return</span>&nbsp;<span class="ident" id="3455468"><a href="/net/http/server.go.html#3454855">srv</a></span><span class="op" id="3455471">.</span><span class="ident" id="3455472">Serve</span><span class="op" id="3455477">(</span><span class="ident" id="3455478"><a href="/net/http/server.go.html#3455376">tlsListener</a></span><span class="op" id="3455489">)</span><br>
<span class="lineno">1880</span><span class="op" id="3455491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3455494">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3455569">//</span><br>
<span class="lineno"></span><span class="comment" id="3455572">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3455642">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3455713">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3455783">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3455846">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3455917">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3455939">func</span>&nbsp;<span class="ident" id="3455944">TimeoutHandler</span><span class="op" id="3455958">(</span><span class="ident" id="3455959">h</span>&nbsp;<span class="ident" id="3455961"><a href="/net/http/server.go.html#3400945">Handler</a></span><span class="op" id="3455968">,</span>&nbsp;<span class="ident" id="3455970">dt</span>&nbsp;<span class="ident" id="3455973"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3455977">.</span><span class="ident" id="3455978">Duration</span><span class="op" id="3455986">,</span>&nbsp;<span class="ident" id="3455988">msg</span>&nbsp;<span class="builtintype" id="3455992">string</span><span class="op" id="3455998">)</span>&nbsp;<span class="ident" id="3456000"><a href="/net/http/server.go.html#3400945">Handler</a></span>&nbsp;<span class="op" id="3456008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456011">f</span>&nbsp;<span class="op" id="3456013">:=</span>&nbsp;<span class="keyword" id="3456016">func</span><span class="op" id="3456020">(</span><span class="op" id="3456021">)</span>&nbsp;<span class="op" id="3456023">&lt;-</span><span class="keyword" id="3456025">chan</span>&nbsp;<span class="ident" id="3456030"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3456034">.</span><span class="ident" id="3456035">Time</span>&nbsp;<span class="op" id="3456040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456044">return</span>&nbsp;<span class="ident" id="3456051"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3456055">.</span><span class="ident" id="3456056">After</span><span class="op" id="3456061">(</span><span class="ident" id="3456062"><a href="/net/http/server.go.html#3455970">dt</a></span><span class="op" id="3456064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456070">return</span>&nbsp;<span class="op" id="3456077">&amp;</span><span class="ident" id="3456078"><a href="/net/http/server.go.html#3456273">timeoutHandler</a></span><span class="op" id="3456092">{</span><span class="ident" id="3456093"><a href="/net/http/server.go.html#3455959">h</a></span><span class="op" id="3456094">,</span>&nbsp;<span class="ident" id="3456096"><a href="/net/http/server.go.html#3456011">f</a></span><span class="op" id="3456097">,</span>&nbsp;<span class="ident" id="3456099"><a href="/net/http/server.go.html#3455988">msg</a></span><span class="op" id="3456102">}</span><br>
<span class="lineno">1895</span><span class="op" id="3456104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3456107">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3456170">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3456207">var</span>&nbsp;<span class="ident" id="3456211">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3456229">=</span>&nbsp;<span class="ident" id="3456231"><a href="/net/http/server.go.html#3399835">errors</a></span><span class="op" id="3456237">.</span><span class="ident" id="3456238">New</span><span class="op" id="3456241">(</span><span class="string" id="3456242">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3456265">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3456268">type</span>&nbsp;<span class="ident" id="3456273">timeoutHandler</span>&nbsp;<span class="keyword" id="3456288">struct</span>&nbsp;<span class="op" id="3456295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456298">handler</span>&nbsp;<span class="ident" id="3456306"><a href="/net/http/server.go.html#3400945">Handler</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456315">timeout</span>&nbsp;<span class="keyword" id="3456323">func</span><span class="op" id="3456327">(</span><span class="op" id="3456328">)</span>&nbsp;<span class="op" id="3456330">&lt;-</span><span class="keyword" id="3456332">chan</span>&nbsp;<span class="ident" id="3456337"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3456341">.</span><span class="ident" id="3456342">Time</span>&nbsp;<span class="comment" id="3456347">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456387">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3456395">string</span><br>
<span class="lineno">1905</span><span class="op" id="3456402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3456405">func</span>&nbsp;<span class="op" id="3456410">(</span><span class="ident" id="3456411">h</span>&nbsp;<span class="op" id="3456413">*</span><span class="ident" id="3456414"><a href="/net/http/server.go.html#3456273">timeoutHandler</a></span><span class="op" id="3456428">)</span>&nbsp;<span class="ident" id="3456430">errorBody</span><span class="op" id="3456439">(</span><span class="op" id="3456440">)</span>&nbsp;<span class="builtintype" id="3456442">string</span>&nbsp;<span class="op" id="3456449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456452">if</span>&nbsp;<span class="ident" id="3456455"><a href="/net/http/server.go.html#3456411">h</a></span><span class="op" id="3456456">.</span><span class="ident" id="3456457">body</span>&nbsp;<span class="op" id="3456462">!=</span>&nbsp;<span class="string" id="3456465">&#34;&#34;</span>&nbsp;<span class="op" id="3456468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456472">return</span>&nbsp;<span class="ident" id="3456479"><a href="/net/http/server.go.html#3456411">h</a></span><span class="op" id="3456480">.</span><span class="ident" id="3456481">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456490">return</span>&nbsp;<span class="string" id="3456497">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3456577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3456580">func</span>&nbsp;<span class="op" id="3456585">(</span><span class="ident" id="3456586">h</span>&nbsp;<span class="op" id="3456588">*</span><span class="ident" id="3456589"><a href="/net/http/server.go.html#3456273">timeoutHandler</a></span><span class="op" id="3456603">)</span>&nbsp;<span class="ident" id="3456605">ServeHTTP</span><span class="op" id="3456614">(</span><span class="ident" id="3456615">w</span>&nbsp;<span class="ident" id="3456617"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3456631">,</span>&nbsp;<span class="ident" id="3456633">r</span>&nbsp;<span class="op" id="3456635">*</span><span class="ident" id="3456636"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3456643">)</span>&nbsp;<span class="op" id="3456645">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456648">done</span>&nbsp;<span class="op" id="3456653">:=</span>&nbsp;<span class="builtinfunc" id="3456656">make</span><span class="op" id="3456660">(</span><span class="keyword" id="3456661">chan</span>&nbsp;<span class="builtintype" id="3456666">bool</span><span class="op" id="3456670">,</span>&nbsp;<span class="num" id="3456672">1</span><span class="op" id="3456673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456676">tw</span>&nbsp;<span class="op" id="3456679">:=</span>&nbsp;<span class="op" id="3456682">&amp;</span><span class="ident" id="3456683"><a href="/net/http/server.go.html#3456999">timeoutWriter</a></span><span class="op" id="3456696">{</span><span class="ident" id="3456697">w</span><span class="op" id="3456698">:</span>&nbsp;<span class="ident" id="3456700"><a href="/net/http/server.go.html#3456615">w</a></span><span class="op" id="3456701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456704">go</span>&nbsp;<span class="keyword" id="3456707">func</span><span class="op" id="3456711">(</span><span class="op" id="3456712">)</span>&nbsp;<span class="op" id="3456714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456718"><a href="/net/http/server.go.html#3456586">h</a></span><span class="op" id="3456719">.</span><span class="ident" id="3456720">handler</span><span class="op" id="3456727">.</span><span class="ident" id="3456728">ServeHTTP</span><span class="op" id="3456737">(</span><span class="ident" id="3456738"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456740">,</span>&nbsp;<span class="ident" id="3456742"><a href="/net/http/server.go.html#3456633">r</a></span><span class="op" id="3456743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456747"><a href="/net/http/server.go.html#3456648">done</a></span>&nbsp;<span class="op" id="3456752">&lt;-</span>&nbsp;<span class="builtintype" id="3456755">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456761">}</span><span class="op" id="3456762">(</span><span class="op" id="3456763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456766">select</span>&nbsp;<span class="op" id="3456773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456776">case</span>&nbsp;<span class="op" id="3456781">&lt;-</span><span class="ident" id="3456783"><a href="/net/http/server.go.html#3456648">done</a></span><span class="op" id="3456787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456791">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456799">case</span>&nbsp;<span class="op" id="3456804">&lt;-</span><span class="ident" id="3456806"><a href="/net/http/server.go.html#3456586">h</a></span><span class="op" id="3456807">.</span><span class="ident" id="3456808">timeout</span><span class="op" id="3456815">(</span><span class="op" id="3456816">)</span><span class="op" id="3456817">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456821"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456823">.</span><span class="ident" id="3456824">mu</span><span class="op" id="3456826">.</span><span class="ident" id="3456827">Lock</span><span class="op" id="3456831">(</span><span class="op" id="3456832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456836">defer</span>&nbsp;<span class="ident" id="3456842"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456844">.</span><span class="ident" id="3456845">mu</span><span class="op" id="3456847">.</span><span class="ident" id="3456848">Unlock</span><span class="op" id="3456854">(</span><span class="op" id="3456855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456859">if</span>&nbsp;<span class="op" id="3456862">!</span><span class="ident" id="3456863"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456865">.</span><span class="ident" id="3456866">wroteHeader</span>&nbsp;<span class="op" id="3456878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456883"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456885">.</span><span class="ident" id="3456886">w</span><span class="op" id="3456887">.</span><span class="ident" id="3456888">WriteHeader</span><span class="op" id="3456899">(</span><span class="ident" id="3456900"><a href="/net/http/status.go.html#3468109">StatusServiceUnavailable</a></span><span class="op" id="3456924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456929"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456931">.</span><span class="ident" id="3456932">w</span><span class="op" id="3456933">.</span><span class="ident" id="3456934">Write</span><span class="op" id="3456939">(</span><span class="op" id="3456940">[</span><span class="op" id="3456941">]</span><span class="builtintype" id="3456942">byte</span><span class="op" id="3456946">(</span><span class="ident" id="3456947"><a href="/net/http/server.go.html#3456586">h</a></span><span class="op" id="3456948">.</span><span class="ident" id="3456949">errorBody</span><span class="op" id="3456958">(</span><span class="op" id="3456959">)</span><span class="op" id="3456960">)</span><span class="op" id="3456961">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456969"><a href="/net/http/server.go.html#3456676">tw</a></span><span class="op" id="3456971">.</span><span class="ident" id="3456972">timedOut</span>&nbsp;<span class="op" id="3456981">=</span>&nbsp;<span class="builtintype" id="3456983">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456989">}</span><br>
<span class="lineno"></span><span class="op" id="3456991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3456994">type</span>&nbsp;<span class="ident" id="3456999">timeoutWriter</span>&nbsp;<span class="keyword" id="3457013">struct</span>&nbsp;<span class="op" id="3457020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457023">w</span>&nbsp;<span class="ident" id="3457025"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457042">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3457054"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3457058">.</span><span class="ident" id="3457059">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457066">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3457078">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457084">wroteHeader</span>&nbsp;<span class="builtintype" id="3457096">bool</span><br>
<span class="lineno"></span><span class="op" id="3457101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3457104">func</span>&nbsp;<span class="op" id="3457109">(</span><span class="ident" id="3457110">tw</span>&nbsp;<span class="op" id="3457113">*</span><span class="ident" id="3457114"><a href="/net/http/server.go.html#3456999">timeoutWriter</a></span><span class="op" id="3457127">)</span>&nbsp;<span class="ident" id="3457129">Header</span><span class="op" id="3457135">(</span><span class="op" id="3457136">)</span>&nbsp;<span class="ident" id="3457138"><a href="/net/http/header.go.html#3356649">Header</a></span>&nbsp;<span class="op" id="3457145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457148">return</span>&nbsp;<span class="ident" id="3457155"><a href="/net/http/server.go.html#3457110">tw</a></span><span class="op" id="3457157">.</span><span class="ident" id="3457158">w</span><span class="op" id="3457159">.</span><span class="ident" id="3457160">Header</span><span class="op" id="3457166">(</span><span class="op" id="3457167">)</span><br>
<span class="lineno">1945</span><span class="op" id="3457169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3457172">func</span>&nbsp;<span class="op" id="3457177">(</span><span class="ident" id="3457178">tw</span>&nbsp;<span class="op" id="3457181">*</span><span class="ident" id="3457182"><a href="/net/http/server.go.html#3456999">timeoutWriter</a></span><span class="op" id="3457195">)</span>&nbsp;<span class="ident" id="3457197">Write</span><span class="op" id="3457202">(</span><span class="ident" id="3457203">p</span>&nbsp;<span class="op" id="3457205">[</span><span class="op" id="3457206">]</span><span class="builtintype" id="3457207">byte</span><span class="op" id="3457211">)</span>&nbsp;<span class="op" id="3457213">(</span><span class="builtintype" id="3457214">int</span><span class="op" id="3457217">,</span>&nbsp;<span class="builtintype" id="3457219">error</span><span class="op" id="3457224">)</span>&nbsp;<span class="op" id="3457226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457229"><a href="/net/http/server.go.html#3457178">tw</a></span><span class="op" id="3457231">.</span><span class="ident" id="3457232">mu</span><span class="op" id="3457234">.</span><span class="ident" id="3457235">Lock</span><span class="op" id="3457239">(</span><span class="op" id="3457240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457243">defer</span>&nbsp;<span class="ident" id="3457249"><a href="/net/http/server.go.html#3457178">tw</a></span><span class="op" id="3457251">.</span><span class="ident" id="3457252">mu</span><span class="op" id="3457254">.</span><span class="ident" id="3457255">Unlock</span><span class="op" id="3457261">(</span><span class="op" id="3457262">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457265"><a href="/net/http/server.go.html#3457178">tw</a></span><span class="op" id="3457267">.</span><span class="ident" id="3457268">wroteHeader</span>&nbsp;<span class="op" id="3457280">=</span>&nbsp;<span class="builtintype" id="3457282">true</span>&nbsp;<span class="comment" id="3457287">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457311">if</span>&nbsp;<span class="ident" id="3457314"><a href="/net/http/server.go.html#3457178">tw</a></span><span class="op" id="3457316">.</span><span class="ident" id="3457317">timedOut</span>&nbsp;<span class="op" id="3457326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457330">return</span>&nbsp;<span class="num" id="3457337">0</span><span class="op" id="3457338">,</span>&nbsp;<span class="ident" id="3457340"><a href="/net/http/server.go.html#3456211">ErrHandlerTimeout</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457362">return</span>&nbsp;<span class="ident" id="3457369"><a href="/net/http/server.go.html#3457178">tw</a></span><span class="op" id="3457371">.</span><span class="ident" id="3457372">w</span><span class="op" id="3457373">.</span><span class="ident" id="3457374">Write</span><span class="op" id="3457379">(</span><span class="ident" id="3457380"><a href="/net/http/server.go.html#3457203">p</a></span><span class="op" id="3457381">)</span><br>
<span class="lineno">1955</span><span class="op" id="3457383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3457386">func</span>&nbsp;<span class="op" id="3457391">(</span><span class="ident" id="3457392">tw</span>&nbsp;<span class="op" id="3457395">*</span><span class="ident" id="3457396"><a href="/net/http/server.go.html#3456999">timeoutWriter</a></span><span class="op" id="3457409">)</span>&nbsp;<span class="ident" id="3457411">WriteHeader</span><span class="op" id="3457422">(</span><span class="ident" id="3457423">code</span>&nbsp;<span class="builtintype" id="3457428">int</span><span class="op" id="3457431">)</span>&nbsp;<span class="op" id="3457433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457436"><a href="/net/http/server.go.html#3457392">tw</a></span><span class="op" id="3457438">.</span><span class="ident" id="3457439">mu</span><span class="op" id="3457441">.</span><span class="ident" id="3457442">Lock</span><span class="op" id="3457446">(</span><span class="op" id="3457447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457450">defer</span>&nbsp;<span class="ident" id="3457456"><a href="/net/http/server.go.html#3457392">tw</a></span><span class="op" id="3457458">.</span><span class="ident" id="3457459">mu</span><span class="op" id="3457461">.</span><span class="ident" id="3457462">Unlock</span><span class="op" id="3457468">(</span><span class="op" id="3457469">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457472">if</span>&nbsp;<span class="ident" id="3457475"><a href="/net/http/server.go.html#3457392">tw</a></span><span class="op" id="3457477">.</span><span class="ident" id="3457478">timedOut</span>&nbsp;<span class="op" id="3457487">||</span>&nbsp;<span class="ident" id="3457490"><a href="/net/http/server.go.html#3457392">tw</a></span><span class="op" id="3457492">.</span><span class="ident" id="3457493">wroteHeader</span>&nbsp;<span class="op" id="3457505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457509">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457520"><a href="/net/http/server.go.html#3457392">tw</a></span><span class="op" id="3457522">.</span><span class="ident" id="3457523">wroteHeader</span>&nbsp;<span class="op" id="3457535">=</span>&nbsp;<span class="builtintype" id="3457537">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457543"><a href="/net/http/server.go.html#3457392">tw</a></span><span class="op" id="3457545">.</span><span class="ident" id="3457546">w</span><span class="op" id="3457547">.</span><span class="ident" id="3457548">WriteHeader</span><span class="op" id="3457559">(</span><span class="ident" id="3457560"><a href="/net/http/server.go.html#3457423">code</a></span><span class="op" id="3457564">)</span><br>
<span class="lineno">1965</span><span class="op" id="3457566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3457569">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3457634">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3457703">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3457773">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3457785">type</span>&nbsp;<span class="ident" id="3457790">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3457811">struct</span>&nbsp;<span class="op" id="3457818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457821">*</span><span class="ident" id="3457822"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3457825">.</span><span class="ident" id="3457826">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3457838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3457841">func</span>&nbsp;<span class="op" id="3457846">(</span><span class="ident" id="3457847">ln</span>&nbsp;<span class="ident" id="3457850"><a href="/net/http/server.go.html#3457790">tcpKeepAliveListener</a></span><span class="op" id="3457870">)</span>&nbsp;<span class="ident" id="3457872">Accept</span><span class="op" id="3457878">(</span><span class="op" id="3457879">)</span>&nbsp;<span class="op" id="3457881">(</span><span class="ident" id="3457882">c</span>&nbsp;<span class="ident" id="3457884"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3457887">.</span><span class="ident" id="3457888">Conn</span><span class="op" id="3457892">,</span>&nbsp;<span class="ident" id="3457894">err</span>&nbsp;<span class="builtintype" id="3457898">error</span><span class="op" id="3457903">)</span>&nbsp;<span class="op" id="3457905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457908">tc</span><span class="op" id="3457910">,</span>&nbsp;<span class="ident" id="3457912"><a href="/net/http/server.go.html#3457894">err</a></span>&nbsp;<span class="op" id="3457916">:=</span>&nbsp;<span class="ident" id="3457919"><a href="/net/http/server.go.html#3457847">ln</a></span><span class="op" id="3457921">.</span><span class="ident" id="3457922">AcceptTCP</span><span class="op" id="3457931">(</span><span class="op" id="3457932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457935">if</span>&nbsp;<span class="ident" id="3457938"><a href="/net/http/server.go.html#3457894">err</a></span>&nbsp;<span class="op" id="3457942">!=</span>&nbsp;<span class="ident" id="3457945">nil</span>&nbsp;<span class="op" id="3457949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457953">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457961">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457964"><a href="/net/http/server.go.html#3457908">tc</a></span><span class="op" id="3457966">.</span><span class="ident" id="3457967">SetKeepAlive</span><span class="op" id="3457979">(</span><span class="builtintype" id="3457980">true</span><span class="op" id="3457984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457987"><a href="/net/http/server.go.html#3457908">tc</a></span><span class="op" id="3457989">.</span><span class="ident" id="3457990">SetKeepAlivePeriod</span><span class="op" id="3458008">(</span><span class="num" id="3458009">3</span>&nbsp;<span class="op" id="3458011">*</span>&nbsp;<span class="ident" id="3458013"><a href="/net/http/server.go.html#3399966">time</a></span><span class="op" id="3458017">.</span><span class="ident" id="3458018">Minute</span><span class="op" id="3458024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458027">return</span>&nbsp;<span class="ident" id="3458034"><a href="/net/http/server.go.html#3457908">tc</a></span><span class="op" id="3458036">,</span>&nbsp;<span class="ident" id="3458038">nil</span><br>
<span class="lineno"></span><span class="op" id="3458042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3458045">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3458103">type</span>&nbsp;<span class="ident" id="3458108">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3458129">struct</span><span class="op" id="3458135">{</span><span class="op" id="3458136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3458139">func</span>&nbsp;<span class="op" id="3458144">(</span><span class="ident" id="3458145"><a href="/net/http/server.go.html#3458108">globalOptionsHandler</a></span><span class="op" id="3458165">)</span>&nbsp;<span class="ident" id="3458167">ServeHTTP</span><span class="op" id="3458176">(</span><span class="ident" id="3458177">w</span>&nbsp;<span class="ident" id="3458179"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3458193">,</span>&nbsp;<span class="ident" id="3458195">r</span>&nbsp;<span class="op" id="3458197">*</span><span class="ident" id="3458198"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3458205">)</span>&nbsp;<span class="op" id="3458207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458210"><a href="/net/http/server.go.html#3458177">w</a></span><span class="op" id="3458211">.</span><span class="ident" id="3458212">Header</span><span class="op" id="3458218">(</span><span class="op" id="3458219">)</span><span class="op" id="3458220">.</span><span class="ident" id="3458221">Set</span><span class="op" id="3458224">(</span><span class="string" id="3458225">&#34;Content-Length&#34;</span><span class="op" id="3458241">,</span>&nbsp;<span class="string" id="3458243">&#34;0&#34;</span><span class="op" id="3458246">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458249">if</span>&nbsp;<span class="ident" id="3458252"><a href="/net/http/server.go.html#3458195">r</a></span><span class="op" id="3458253">.</span><span class="ident" id="3458254">ContentLength</span>&nbsp;<span class="op" id="3458268">!=</span>&nbsp;<span class="num" id="3458271">0</span>&nbsp;<span class="op" id="3458273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458277">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458334">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458392">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458449">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458508">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458556">mb</span>&nbsp;<span class="op" id="3458559">:=</span>&nbsp;<span class="ident" id="3458562"><a href="/net/http/request.go.html#3385264">MaxBytesReader</a></span><span class="op" id="3458576">(</span><span class="ident" id="3458577"><a href="/net/http/server.go.html#3458177">w</a></span><span class="op" id="3458578">,</span>&nbsp;<span class="ident" id="3458580"><a href="/net/http/server.go.html#3458195">r</a></span><span class="op" id="3458581">.</span><span class="ident" id="3458582">Body</span><span class="op" id="3458586">,</span>&nbsp;<span class="num" id="3458588">4</span><span class="op" id="3458589">&lt;&lt;</span><span class="num" id="3458591">10</span><span class="op" id="3458593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458597"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3458599">.</span><span class="ident" id="3458600">Copy</span><span class="op" id="3458604">(</span><span class="ident" id="3458605"><a href="/net/http/server.go.html#3399858">ioutil</a></span><span class="op" id="3458611">.</span><span class="ident" id="3458612">Discard</span><span class="op" id="3458619">,</span>&nbsp;<span class="ident" id="3458621"><a href="/net/http/server.go.html#3458556">mb</a></span><span class="op" id="3458623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458626">}</span><br>
<span class="lineno"></span><span class="op" id="3458628">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3458631">type</span>&nbsp;<span class="ident" id="3458636">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3458657">struct</span><span class="op" id="3458663">{</span><span class="op" id="3458664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3458667">func</span>&nbsp;<span class="op" id="3458672">(</span><span class="ident" id="3458673"><a href="/net/http/server.go.html#3458636">eofReaderWithWriteTo</a></span><span class="op" id="3458693">)</span>&nbsp;<span class="ident" id="3458695">WriteTo</span><span class="op" id="3458702">(</span><span class="ident" id="3458703"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3458705">.</span><span class="ident" id="3458706">Writer</span><span class="op" id="3458712">)</span>&nbsp;<span class="op" id="3458714">(</span><span class="ident" id="3458715">int64</span><span class="op" id="3458720">,</span>&nbsp;<span class="builtintype" id="3458722">error</span><span class="op" id="3458727">)</span>&nbsp;<span class="op" id="3458729">{</span>&nbsp;<span class="keyword" id="3458731">return</span>&nbsp;<span class="num" id="3458738">0</span><span class="op" id="3458739">,</span>&nbsp;<span class="ident" id="3458741">nil</span>&nbsp;<span class="op" id="3458745">}</span><br>
<span class="lineno"></span><span class="keyword" id="3458747">func</span>&nbsp;<span class="op" id="3458752">(</span><span class="ident" id="3458753"><a href="/net/http/server.go.html#3458636">eofReaderWithWriteTo</a></span><span class="op" id="3458773">)</span>&nbsp;<span class="ident" id="3458775">Read</span><span class="op" id="3458779">(</span><span class="op" id="3458780">[</span><span class="op" id="3458781">]</span><span class="builtintype" id="3458782">byte</span><span class="op" id="3458786">)</span>&nbsp;<span class="op" id="3458788">(</span><span class="builtintype" id="3458789">int</span><span class="op" id="3458792">,</span>&nbsp;<span class="builtintype" id="3458794">error</span><span class="op" id="3458799">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3458809">{</span>&nbsp;<span class="keyword" id="3458811">return</span>&nbsp;<span class="num" id="3458818">0</span><span class="op" id="3458819">,</span>&nbsp;<span class="ident" id="3458821"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3458823">.</span><span class="ident" id="3458824">EOF</span>&nbsp;<span class="op" id="3458828">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3458831">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3458896">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3458955">var</span>&nbsp;<span class="ident" id="3458959">eofReader</span>&nbsp;<span class="op" id="3458969">=</span>&nbsp;<span class="op" id="3458971">&amp;</span><span class="keyword" id="3458972">struct</span>&nbsp;<span class="op" id="3458979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458982"><a href="/net/http/server.go.html#3458636">eofReaderWithWriteTo</a></span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459004"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3459006">.</span><span class="ident" id="3459007">Closer</span><br>
<span class="lineno"></span><span class="op" id="3459014">}</span><span class="op" id="3459015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459018"><a href="/net/http/server.go.html#3458636">eofReaderWithWriteTo</a></span><span class="op" id="3459038">{</span><span class="op" id="3459039">}</span><span class="op" id="3459040">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459043"><a href="/net/http/server.go.html#3399858">ioutil</a></span><span class="op" id="3459049">.</span><span class="ident" id="3459050">NopCloser</span><span class="op" id="3459059">(</span><span class="ident" id="3459060">nil</span><span class="op" id="3459063">)</span><span class="op" id="3459064">,</span><br>
<span class="lineno"></span><span class="op" id="3459066">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3459069">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3459137">var</span>&nbsp;<span class="ident" id="3459141">_</span>&nbsp;<span class="ident" id="3459143"><a href="/net/http/server.go.html#3399852">io</a></span><span class="op" id="3459145">.</span><span class="ident" id="3459146">WriterTo</span>&nbsp;<span class="op" id="3459155">=</span>&nbsp;<span class="ident" id="3459157"><a href="/net/http/server.go.html#3458959">eofReader</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3459168">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3459230">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3459298">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3459343">type</span>&nbsp;<span class="ident" id="3459348">initNPNRequest</span>&nbsp;<span class="keyword" id="3459363">struct</span>&nbsp;<span class="op" id="3459370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459373">c</span>&nbsp;<span class="op" id="3459375">*</span><span class="ident" id="3459376"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3459379">.</span><span class="ident" id="3459380">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459386">h</span>&nbsp;<span class="ident" id="3459388"><a href="/net/http/server.go.html#3450194">serverHandler</a></span><br>
<span class="lineno">2025</span><span class="op" id="3459402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3459405">func</span>&nbsp;<span class="op" id="3459410">(</span><span class="ident" id="3459411">h</span>&nbsp;<span class="ident" id="3459413"><a href="/net/http/server.go.html#3459348">initNPNRequest</a></span><span class="op" id="3459427">)</span>&nbsp;<span class="ident" id="3459429">ServeHTTP</span><span class="op" id="3459438">(</span><span class="ident" id="3459439">rw</span>&nbsp;<span class="ident" id="3459442"><a href="/net/http/server.go.html#3401101">ResponseWriter</a></span><span class="op" id="3459456">,</span>&nbsp;<span class="ident" id="3459458">req</span>&nbsp;<span class="op" id="3459462">*</span><span class="ident" id="3459463"><a href="/net/http/request.go.html#3366486">Request</a></span><span class="op" id="3459470">)</span>&nbsp;<span class="op" id="3459472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459475">if</span>&nbsp;<span class="ident" id="3459478"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459481">.</span><span class="ident" id="3459482">TLS</span>&nbsp;<span class="op" id="3459486">==</span>&nbsp;<span class="ident" id="3459489">nil</span>&nbsp;<span class="op" id="3459493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459497"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459500">.</span><span class="ident" id="3459501">TLS</span>&nbsp;<span class="op" id="3459505">=</span>&nbsp;<span class="op" id="3459507">&amp;</span><span class="ident" id="3459508"><a href="/net/http/server.go.html#3399821">tls</a></span><span class="op" id="3459511">.</span><span class="ident" id="3459512">ConnectionState</span><span class="op" id="3459527">{</span><span class="op" id="3459528">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459532">*</span><span class="ident" id="3459533"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459536">.</span><span class="ident" id="3459537">TLS</span>&nbsp;<span class="op" id="3459541">=</span>&nbsp;<span class="ident" id="3459543"><a href="/net/http/server.go.html#3459411">h</a></span><span class="op" id="3459544">.</span><span class="ident" id="3459545">c</span><span class="op" id="3459546">.</span><span class="ident" id="3459547">ConnectionState</span><span class="op" id="3459562">(</span><span class="op" id="3459563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459569">if</span>&nbsp;<span class="ident" id="3459572"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459575">.</span><span class="ident" id="3459576">Body</span>&nbsp;<span class="op" id="3459581">==</span>&nbsp;<span class="ident" id="3459584">nil</span>&nbsp;<span class="op" id="3459588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459592"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459595">.</span><span class="ident" id="3459596">Body</span>&nbsp;<span class="op" id="3459601">=</span>&nbsp;<span class="ident" id="3459603"><a href="/net/http/server.go.html#3458959">eofReader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459614">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459617">if</span>&nbsp;<span class="ident" id="3459620"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459623">.</span><span class="ident" id="3459624">RemoteAddr</span>&nbsp;<span class="op" id="3459635">==</span>&nbsp;<span class="string" id="3459638">&#34;&#34;</span>&nbsp;<span class="op" id="3459641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459645"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459648">.</span><span class="ident" id="3459649">RemoteAddr</span>&nbsp;<span class="op" id="3459660">=</span>&nbsp;<span class="ident" id="3459662"><a href="/net/http/server.go.html#3459411">h</a></span><span class="op" id="3459663">.</span><span class="ident" id="3459664">c</span><span class="op" id="3459665">.</span><span class="ident" id="3459666">RemoteAddr</span><span class="op" id="3459676">(</span><span class="op" id="3459677">)</span><span class="op" id="3459678">.</span><span class="ident" id="3459679">String</span><span class="op" id="3459685">(</span><span class="op" id="3459686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459692"><a href="/net/http/server.go.html#3459411">h</a></span><span class="op" id="3459693">.</span><span class="ident" id="3459694">h</span><span class="op" id="3459695">.</span><span class="ident" id="3459696">ServeHTTP</span><span class="op" id="3459705">(</span><span class="ident" id="3459706"><a href="/net/http/server.go.html#3459439">rw</a></span><span class="op" id="3459708">,</span>&nbsp;<span class="ident" id="3459710"><a href="/net/http/server.go.html#3459458">req</a></span><span class="op" id="3459713">)</span><br>
<span class="lineno"></span><span class="op" id="3459715">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3459718">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3459756">type</span>&nbsp;<span class="ident" id="3459761">loggingConn</span>&nbsp;<span class="keyword" id="3459773">struct</span>&nbsp;<span class="op" id="3459780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459783">name</span>&nbsp;<span class="builtintype" id="3459788">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459796"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3459799">.</span><span class="ident" id="3459800">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3459805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3459808">var</span>&nbsp;<span class="op" id="3459812">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459815">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3459828"><a href="/net/http/server.go.html#3399943">sync</a></span><span class="op" id="3459832">.</span><span class="ident" id="3459833">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459840">uniqNameNext</span>&nbsp;<span class="op" id="3459853">=</span>&nbsp;<span class="builtinfunc" id="3459855">make</span><span class="op" id="3459859">(</span><span class="keyword" id="3459860">map</span><span class="op" id="3459863">[</span><span class="builtintype" id="3459864">string</span><span class="op" id="3459870">]</span><span class="builtintype" id="3459871">int</span><span class="op" id="3459874">)</span><br>
<span class="lineno">2050</span><span class="op" id="3459876">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3459879">func</span>&nbsp;<span class="ident" id="3459884">newLoggingConn</span><span class="op" id="3459898">(</span><span class="ident" id="3459899">baseName</span>&nbsp;<span class="builtintype" id="3459908">string</span><span class="op" id="3459914">,</span>&nbsp;<span class="ident" id="3459916">c</span>&nbsp;<span class="ident" id="3459918"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3459921">.</span><span class="ident" id="3459922">Conn</span><span class="op" id="3459926">)</span>&nbsp;<span class="ident" id="3459928"><a href="/net/http/server.go.html#3399878">net</a></span><span class="op" id="3459931">.</span><span class="ident" id="3459932">Conn</span>&nbsp;<span class="op" id="3459937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459940"><a href="/net/http/server.go.html#3459815">uniqNameMu</a></span><span class="op" id="3459950">.</span><span class="ident" id="3459951">Lock</span><span class="op" id="3459955">(</span><span class="op" id="3459956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459959">defer</span>&nbsp;<span class="ident" id="3459965"><a href="/net/http/server.go.html#3459815">uniqNameMu</a></span><span class="op" id="3459975">.</span><span class="ident" id="3459976">Unlock</span><span class="op" id="3459982">(</span><span class="op" id="3459983">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459986"><a href="/net/http/server.go.html#3459840">uniqNameNext</a></span><span class="op" id="3459998">[</span><span class="ident" id="3459999"><a href="/net/http/server.go.html#3459899">baseName</a></span><span class="op" id="3460007">]</span><span class="op" id="3460008">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460012">return</span>&nbsp;<span class="op" id="3460019">&amp;</span><span class="ident" id="3460020"><a href="/net/http/server.go.html#3459761">loggingConn</a></span><span class="op" id="3460031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460035">name</span><span class="op" id="3460039">:</span>&nbsp;<span class="ident" id="3460041"><a href="/net/http/server.go.html#3399845">fmt</a></span><span class="op" id="3460044">.</span><span class="ident" id="3460045">Sprintf</span><span class="op" id="3460052">(</span><span class="string" id="3460053">&#34;%s-%d&#34;</span><span class="op" id="3460060">,</span>&nbsp;<span class="ident" id="3460062"><a href="/net/http/server.go.html#3459899">baseName</a></span><span class="op" id="3460070">,</span>&nbsp;<span class="ident" id="3460072"><a href="/net/http/server.go.html#3459840">uniqNameNext</a></span><span class="op" id="3460084">[</span><span class="ident" id="3460085"><a href="/net/http/server.go.html#3459899">baseName</a></span><span class="op" id="3460093">]</span><span class="op" id="3460094">)</span><span class="op" id="3460095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460099">Conn</span><span class="op" id="3460103">:</span>&nbsp;<span class="ident" id="3460105"><a href="/net/http/server.go.html#3459916">c</a></span><span class="op" id="3460106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460109">}</span><br>
<span class="lineno">2060</span><span class="op" id="3460111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3460114">func</span>&nbsp;<span class="op" id="3460119">(</span><span class="ident" id="3460120">c</span>&nbsp;<span class="op" id="3460122">*</span><span class="ident" id="3460123"><a href="/net/http/server.go.html#3459761">loggingConn</a></span><span class="op" id="3460134">)</span>&nbsp;<span class="ident" id="3460136">Write</span><span class="op" id="3460141">(</span><span class="ident" id="3460142">p</span>&nbsp;<span class="op" id="3460144">[</span><span class="op" id="3460145">]</span><span class="builtintype" id="3460146">byte</span><span class="op" id="3460150">)</span>&nbsp;<span class="op" id="3460152">(</span><span class="ident" id="3460153">n</span>&nbsp;<span class="builtintype" id="3460155">int</span><span class="op" id="3460158">,</span>&nbsp;<span class="ident" id="3460160">err</span>&nbsp;<span class="builtintype" id="3460164">error</span><span class="op" id="3460169">)</span>&nbsp;<span class="op" id="3460171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460174"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3460177">.</span><span class="ident" id="3460178">Printf</span><span class="op" id="3460184">(</span><span class="string" id="3460185">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3460206">,</span>&nbsp;<span class="ident" id="3460208"><a href="/net/http/server.go.html#3460120">c</a></span><span class="op" id="3460209">.</span><span class="ident" id="3460210">name</span><span class="op" id="3460214">,</span>&nbsp;<span class="builtinfunc" id="3460216">len</span><span class="op" id="3460219">(</span><span class="ident" id="3460220"><a href="/net/http/server.go.html#3460142">p</a></span><span class="op" id="3460221">)</span><span class="op" id="3460222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460225"><a href="/net/http/server.go.html#3460153">n</a></span><span class="op" id="3460226">,</span>&nbsp;<span class="ident" id="3460228"><a href="/net/http/server.go.html#3460160">err</a></span>&nbsp;<span class="op" id="3460232">=</span>&nbsp;<span class="ident" id="3460234"><a href="/net/http/server.go.html#3460120">c</a></span><span class="op" id="3460235">.</span><span class="ident" id="3460236">Conn</span><span class="op" id="3460240">.</span><span class="ident" id="3460241">Write</span><span class="op" id="3460246">(</span><span class="ident" id="3460247"><a href="/net/http/server.go.html#3460142">p</a></span><span class="op" id="3460248">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460251"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3460254">.</span><span class="ident" id="3460255">Printf</span><span class="op" id="3460261">(</span><span class="string" id="3460262">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3460285">,</span>&nbsp;<span class="ident" id="3460287"><a href="/net/http/server.go.html#3460120">c</a></span><span class="op" id="3460288">.</span><span class="ident" id="3460289">name</span><span class="op" id="3460293">,</span>&nbsp;<span class="builtinfunc" id="3460295">len</span><span class="op" id="3460298">(</span><span class="ident" id="3460299"><a href="/net/http/server.go.html#3460142">p</a></span><span class="op" id="3460300">)</span><span class="op" id="3460301">,</span>&nbsp;<span class="ident" id="3460303"><a href="/net/http/server.go.html#3460153">n</a></span><span class="op" id="3460304">,</span>&nbsp;<span class="ident" id="3460306"><a href="/net/http/server.go.html#3460160">err</a></span><span class="op" id="3460309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460312">return</span><br>
<span class="lineno"></span><span class="op" id="3460319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3460322">func</span>&nbsp;<span class="op" id="3460327">(</span><span class="ident" id="3460328">c</span>&nbsp;<span class="op" id="3460330">*</span><span class="ident" id="3460331"><a href="/net/http/server.go.html#3459761">loggingConn</a></span><span class="op" id="3460342">)</span>&nbsp;<span class="ident" id="3460344">Read</span><span class="op" id="3460348">(</span><span class="ident" id="3460349">p</span>&nbsp;<span class="op" id="3460351">[</span><span class="op" id="3460352">]</span><span class="builtintype" id="3460353">byte</span><span class="op" id="3460357">)</span>&nbsp;<span class="op" id="3460359">(</span><span class="ident" id="3460360">n</span>&nbsp;<span class="builtintype" id="3460362">int</span><span class="op" id="3460365">,</span>&nbsp;<span class="ident" id="3460367">err</span>&nbsp;<span class="builtintype" id="3460371">error</span><span class="op" id="3460376">)</span>&nbsp;<span class="op" id="3460378">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460381"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3460384">.</span><span class="ident" id="3460385">Printf</span><span class="op" id="3460391">(</span><span class="string" id="3460392">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3460412">,</span>&nbsp;<span class="ident" id="3460414"><a href="/net/http/server.go.html#3460328">c</a></span><span class="op" id="3460415">.</span><span class="ident" id="3460416">name</span><span class="op" id="3460420">,</span>&nbsp;<span class="builtinfunc" id="3460422">len</span><span class="op" id="3460425">(</span><span class="ident" id="3460426"><a href="/net/http/server.go.html#3460349">p</a></span><span class="op" id="3460427">)</span><span class="op" id="3460428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460431"><a href="/net/http/server.go.html#3460360">n</a></span><span class="op" id="3460432">,</span>&nbsp;<span class="ident" id="3460434"><a href="/net/http/server.go.html#3460367">err</a></span>&nbsp;<span class="op" id="3460438">=</span>&nbsp;<span class="ident" id="3460440"><a href="/net/http/server.go.html#3460328">c</a></span><span class="op" id="3460441">.</span><span class="ident" id="3460442">Conn</span><span class="op" id="3460446">.</span><span class="ident" id="3460447">Read</span><span class="op" id="3460451">(</span><span class="ident" id="3460452"><a href="/net/http/server.go.html#3460349">p</a></span><span class="op" id="3460453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460456"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3460459">.</span><span class="ident" id="3460460">Printf</span><span class="op" id="3460466">(</span><span class="string" id="3460467">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3460489">,</span>&nbsp;<span class="ident" id="3460491"><a href="/net/http/server.go.html#3460328">c</a></span><span class="op" id="3460492">.</span><span class="ident" id="3460493">name</span><span class="op" id="3460497">,</span>&nbsp;<span class="builtinfunc" id="3460499">len</span><span class="op" id="3460502">(</span><span class="ident" id="3460503"><a href="/net/http/server.go.html#3460349">p</a></span><span class="op" id="3460504">)</span><span class="op" id="3460505">,</span>&nbsp;<span class="ident" id="3460507"><a href="/net/http/server.go.html#3460360">n</a></span><span class="op" id="3460508">,</span>&nbsp;<span class="ident" id="3460510"><a href="/net/http/server.go.html#3460367">err</a></span><span class="op" id="3460513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460516">return</span><br>
<span class="lineno"></span><span class="op" id="3460523">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3460526">func</span>&nbsp;<span class="op" id="3460531">(</span><span class="ident" id="3460532">c</span>&nbsp;<span class="op" id="3460534">*</span><span class="ident" id="3460535"><a href="/net/http/server.go.html#3459761">loggingConn</a></span><span class="op" id="3460546">)</span>&nbsp;<span class="ident" id="3460548">Close</span><span class="op" id="3460553">(</span><span class="op" id="3460554">)</span>&nbsp;<span class="op" id="3460556">(</span><span class="ident" id="3460557">err</span>&nbsp;<span class="builtintype" id="3460561">error</span><span class="op" id="3460566">)</span>&nbsp;<span class="op" id="3460568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460571"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3460574">.</span><span class="ident" id="3460575">Printf</span><span class="op" id="3460581">(</span><span class="string" id="3460582">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3460600">,</span>&nbsp;<span class="ident" id="3460602"><a href="/net/http/server.go.html#3460532">c</a></span><span class="op" id="3460603">.</span><span class="ident" id="3460604">name</span><span class="op" id="3460608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460611"><a href="/net/http/server.go.html#3460557">err</a></span>&nbsp;<span class="op" id="3460615">=</span>&nbsp;<span class="ident" id="3460617"><a href="/net/http/server.go.html#3460532">c</a></span><span class="op" id="3460618">.</span><span class="ident" id="3460619">Conn</span><span class="op" id="3460623">.</span><span class="ident" id="3460624">Close</span><span class="op" id="3460629">(</span><span class="op" id="3460630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460633"><a href="/net/http/server.go.html#3399871">log</a></span><span class="op" id="3460636">.</span><span class="ident" id="3460637">Printf</span><span class="op" id="3460643">(</span><span class="string" id="3460644">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3460661">,</span>&nbsp;<span class="ident" id="3460663"><a href="/net/http/server.go.html#3460532">c</a></span><span class="op" id="3460664">.</span><span class="ident" id="3460665">name</span><span class="op" id="3460669">,</span>&nbsp;<span class="ident" id="3460671"><a href="/net/http/server.go.html#3460557">err</a></span><span class="op" id="3460674">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460677">return</span><br>
<span class="lineno"></span><span class="op" id="3460684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3460687">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3460767">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3460834">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3460893">type</span>&nbsp;<span class="ident" id="3460898">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3460919">struct</span>&nbsp;<span class="op" id="3460926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460929">c</span>&nbsp;<span class="op" id="3460931">*</span><span class="ident" id="3460932"><a href="/net/http/server.go.html#3403324">conn</a></span><br>
<span class="lineno"></span><span class="op" id="3460937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3460940">func</span>&nbsp;<span class="op" id="3460945">(</span><span class="ident" id="3460946">w</span>&nbsp;<span class="ident" id="3460948"><a href="/net/http/server.go.html#3460898">checkConnErrorWriter</a></span><span class="op" id="3460968">)</span>&nbsp;<span class="ident" id="3460970">Write</span><span class="op" id="3460975">(</span><span class="ident" id="3460976">p</span>&nbsp;<span class="op" id="3460978">[</span><span class="op" id="3460979">]</span><span class="builtintype" id="3460980">byte</span><span class="op" id="3460984">)</span>&nbsp;<span class="op" id="3460986">(</span><span class="ident" id="3460987">n</span>&nbsp;<span class="builtintype" id="3460989">int</span><span class="op" id="3460992">,</span>&nbsp;<span class="ident" id="3460994">err</span>&nbsp;<span class="builtintype" id="3460998">error</span><span class="op" id="3461003">)</span>&nbsp;<span class="op" id="3461005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461008"><a href="/net/http/server.go.html#3460987">n</a></span><span class="op" id="3461009">,</span>&nbsp;<span class="ident" id="3461011"><a href="/net/http/server.go.html#3460994">err</a></span>&nbsp;<span class="op" id="3461015">=</span>&nbsp;<span class="ident" id="3461017"><a href="/net/http/server.go.html#3460946">w</a></span><span class="op" id="3461018">.</span><span class="ident" id="3461019">c</span><span class="op" id="3461020">.</span><span class="ident" id="3461021">w</span><span class="op" id="3461022">.</span><span class="ident" id="3461023">Write</span><span class="op" id="3461028">(</span><span class="ident" id="3461029"><a href="/net/http/server.go.html#3460976">p</a></span><span class="op" id="3461030">)</span>&nbsp;<span class="comment" id="3461032">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461090">if</span>&nbsp;<span class="ident" id="3461093"><a href="/net/http/server.go.html#3460994">err</a></span>&nbsp;<span class="op" id="3461097">!=</span>&nbsp;<span class="ident" id="3461100">nil</span>&nbsp;<span class="op" id="3461104">&amp;&amp;</span>&nbsp;<span class="ident" id="3461107"><a href="/net/http/server.go.html#3460946">w</a></span><span class="op" id="3461108">.</span><span class="ident" id="3461109">c</span><span class="op" id="3461110">.</span><span class="ident" id="3461111">werr</span>&nbsp;<span class="op" id="3461116">==</span>&nbsp;<span class="ident" id="3461119">nil</span>&nbsp;<span class="op" id="3461123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3461127"><a href="/net/http/server.go.html#3460946">w</a></span><span class="op" id="3461128">.</span><span class="ident" id="3461129">c</span><span class="op" id="3461130">.</span><span class="ident" id="3461131">werr</span>&nbsp;<span class="op" id="3461136">=</span>&nbsp;<span class="ident" id="3461138"><a href="/net/http/server.go.html#3460994">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3461143">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3461146">return</span><br>
<span class="lineno"></span><span class="op" id="3461153">}</span>
</div>
</body>
</html>
