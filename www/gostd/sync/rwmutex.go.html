<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html" class="current">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1414992">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1415047">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1415101">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1415152">package</span>&nbsp;<span class="ident" id="1415160">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1415166">import</span>&nbsp;<span class="op" id="1415173">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1415176">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1415191">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1415200">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1415203">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1415259">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1415317">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1415340">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1415385">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1415432">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1415454">type</span>&nbsp;<span class="ident" id="1415459">RWMutex</span>&nbsp;<span class="keyword" id="1415467">struct</span>&nbsp;<span class="op" id="1415474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415477">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415489">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1415496">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415534">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1415546">uint32</span>&nbsp;<span class="comment" id="1415553">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415610">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1415622">uint32</span>&nbsp;<span class="comment" id="1415629">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415686">readerCount</span>&nbsp;<span class="builtintype" id="1415698">int32</span>&nbsp;&nbsp;<span class="comment" id="1415705">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415735">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1415747">int32</span>&nbsp;&nbsp;<span class="comment" id="1415754">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1415785">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1415788">const</span>&nbsp;<span class="ident" id="1415794">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1415812">=</span>&nbsp;<span class="num" id="1415814">1</span>&nbsp;<span class="op" id="1415816">&lt;&lt;</span>&nbsp;<span class="num" id="1415819">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1415823">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1415854">func</span>&nbsp;<span class="op" id="1415859">(</span><span class="ident" id="1415860">rw</span>&nbsp;<span class="op" id="1415863">*</span><span class="ident" id="1415864">RWMutex</span><span class="op" id="1415871">)</span>&nbsp;<span class="ident" id="1415873">RLock</span><span class="op" id="1415878">(</span><span class="op" id="1415879">)</span>&nbsp;<span class="op" id="1415881">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415884">if</span>&nbsp;<span class="ident" id="1415887">raceenabled</span>&nbsp;<span class="op" id="1415899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415903">_</span>&nbsp;<span class="op" id="1415905">=</span>&nbsp;<span class="ident" id="1415907">rw</span><span class="op" id="1415909">.</span><span class="ident" id="1415910">w</span><span class="op" id="1415911">.</span><span class="ident" id="1415912">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415920">raceDisable</span><span class="op" id="1415931">(</span><span class="op" id="1415932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415938">if</span>&nbsp;<span class="ident" id="1415941">atomic</span><span class="op" id="1415947">.</span><span class="ident" id="1415948">AddInt32</span><span class="op" id="1415956">(</span><span class="op" id="1415957">&amp;</span><span class="ident" id="1415958">rw</span><span class="op" id="1415960">.</span><span class="ident" id="1415961">readerCount</span><span class="op" id="1415972">,</span>&nbsp;<span class="num" id="1415974">1</span><span class="op" id="1415975">)</span>&nbsp;<span class="op" id="1415977">&lt;</span>&nbsp;<span class="num" id="1415979">0</span>&nbsp;<span class="op" id="1415981">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1415985">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416024">runtime_Semacquire</span><span class="op" id="1416042">(</span><span class="op" id="1416043">&amp;</span><span class="ident" id="1416044">rw</span><span class="op" id="1416046">.</span><span class="ident" id="1416047">readerSem</span><span class="op" id="1416056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416062">if</span>&nbsp;<span class="ident" id="1416065">raceenabled</span>&nbsp;<span class="op" id="1416077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416081">raceEnable</span><span class="op" id="1416091">(</span><span class="op" id="1416092">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416096">raceAcquire</span><span class="op" id="1416107">(</span><span class="ident" id="1416108">unsafe</span><span class="op" id="1416114">.</span><span class="ident" id="1416115">Pointer</span><span class="op" id="1416122">(</span><span class="op" id="1416123">&amp;</span><span class="ident" id="1416124">rw</span><span class="op" id="1416126">.</span><span class="ident" id="1416127">readerSem</span><span class="op" id="1416136">)</span><span class="op" id="1416137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416140">}</span><br>
<span class="lineno"></span><span class="op" id="1416142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1416145">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1416184">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1416234">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1416292">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1416316">func</span>&nbsp;<span class="op" id="1416321">(</span><span class="ident" id="1416322">rw</span>&nbsp;<span class="op" id="1416325">*</span><span class="ident" id="1416326">RWMutex</span><span class="op" id="1416333">)</span>&nbsp;<span class="ident" id="1416335">RUnlock</span><span class="op" id="1416342">(</span><span class="op" id="1416343">)</span>&nbsp;<span class="op" id="1416345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416348">if</span>&nbsp;<span class="ident" id="1416351">raceenabled</span>&nbsp;<span class="op" id="1416363">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416367">_</span>&nbsp;<span class="op" id="1416369">=</span>&nbsp;<span class="ident" id="1416371">rw</span><span class="op" id="1416373">.</span><span class="ident" id="1416374">w</span><span class="op" id="1416375">.</span><span class="ident" id="1416376">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416384">raceReleaseMerge</span><span class="op" id="1416400">(</span><span class="ident" id="1416401">unsafe</span><span class="op" id="1416407">.</span><span class="ident" id="1416408">Pointer</span><span class="op" id="1416415">(</span><span class="op" id="1416416">&amp;</span><span class="ident" id="1416417">rw</span><span class="op" id="1416419">.</span><span class="ident" id="1416420">writerSem</span><span class="op" id="1416429">)</span><span class="op" id="1416430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416434">raceDisable</span><span class="op" id="1416445">(</span><span class="op" id="1416446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416452">if</span>&nbsp;<span class="ident" id="1416455">r</span>&nbsp;<span class="op" id="1416457">:=</span>&nbsp;<span class="ident" id="1416460">atomic</span><span class="op" id="1416466">.</span><span class="ident" id="1416467">AddInt32</span><span class="op" id="1416475">(</span><span class="op" id="1416476">&amp;</span><span class="ident" id="1416477">rw</span><span class="op" id="1416479">.</span><span class="ident" id="1416480">readerCount</span><span class="op" id="1416491">,</span>&nbsp;<span class="op" id="1416493">-</span><span class="num" id="1416494">1</span><span class="op" id="1416495">)</span><span class="op" id="1416496">;</span>&nbsp;<span class="ident" id="1416498">r</span>&nbsp;<span class="op" id="1416500">&lt;</span>&nbsp;<span class="num" id="1416502">0</span>&nbsp;<span class="op" id="1416504">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416508">if</span>&nbsp;<span class="ident" id="1416511">r</span><span class="op" id="1416512">+</span><span class="num" id="1416513">1</span>&nbsp;<span class="op" id="1416515">==</span>&nbsp;<span class="num" id="1416518">0</span>&nbsp;<span class="op" id="1416520">||</span>&nbsp;<span class="ident" id="1416523">r</span><span class="op" id="1416524">+</span><span class="num" id="1416525">1</span>&nbsp;<span class="op" id="1416527">==</span>&nbsp;<span class="op" id="1416530">-</span><span class="ident" id="1416531">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1416549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416554">raceEnable</span><span class="op" id="1416564">(</span><span class="op" id="1416565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1416570">panic</span><span class="op" id="1416575">(</span><span class="string" id="1416576">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1416611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416619">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416645">if</span>&nbsp;<span class="ident" id="1416648">atomic</span><span class="op" id="1416654">.</span><span class="ident" id="1416655">AddInt32</span><span class="op" id="1416663">(</span><span class="op" id="1416664">&amp;</span><span class="ident" id="1416665">rw</span><span class="op" id="1416667">.</span><span class="ident" id="1416668">readerWait</span><span class="op" id="1416678">,</span>&nbsp;<span class="op" id="1416680">-</span><span class="num" id="1416681">1</span><span class="op" id="1416682">)</span>&nbsp;<span class="op" id="1416684">==</span>&nbsp;<span class="num" id="1416687">0</span>&nbsp;<span class="op" id="1416689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416694">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416737">runtime_Semrelease</span><span class="op" id="1416755">(</span><span class="op" id="1416756">&amp;</span><span class="ident" id="1416757">rw</span><span class="op" id="1416759">.</span><span class="ident" id="1416760">writerSem</span><span class="op" id="1416769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416776">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416779">if</span>&nbsp;<span class="ident" id="1416782">raceenabled</span>&nbsp;<span class="op" id="1416794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416798">raceEnable</span><span class="op" id="1416808">(</span><span class="op" id="1416809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416812">}</span><br>
<span class="lineno"></span><span class="op" id="1416814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1416817">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1416847">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1416904">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1416948">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1417005">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1417064">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1417077">func</span>&nbsp;<span class="op" id="1417082">(</span><span class="ident" id="1417083">rw</span>&nbsp;<span class="op" id="1417086">*</span><span class="ident" id="1417087">RWMutex</span><span class="op" id="1417094">)</span>&nbsp;<span class="ident" id="1417096">Lock</span><span class="op" id="1417100">(</span><span class="op" id="1417101">)</span>&nbsp;<span class="op" id="1417103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417106">if</span>&nbsp;<span class="ident" id="1417109">raceenabled</span>&nbsp;<span class="op" id="1417121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417125">_</span>&nbsp;<span class="op" id="1417127">=</span>&nbsp;<span class="ident" id="1417129">rw</span><span class="op" id="1417131">.</span><span class="ident" id="1417132">w</span><span class="op" id="1417133">.</span><span class="ident" id="1417134">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417142">raceDisable</span><span class="op" id="1417153">(</span><span class="op" id="1417154">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1417157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417160">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417211">rw</span><span class="op" id="1417213">.</span><span class="ident" id="1417214">w</span><span class="op" id="1417215">.</span><span class="ident" id="1417216">Lock</span><span class="op" id="1417220">(</span><span class="op" id="1417221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417224">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417275">r</span>&nbsp;<span class="op" id="1417277">:=</span>&nbsp;<span class="ident" id="1417280">atomic</span><span class="op" id="1417286">.</span><span class="ident" id="1417287">AddInt32</span><span class="op" id="1417295">(</span><span class="op" id="1417296">&amp;</span><span class="ident" id="1417297">rw</span><span class="op" id="1417299">.</span><span class="ident" id="1417300">readerCount</span><span class="op" id="1417311">,</span>&nbsp;<span class="op" id="1417313">-</span><span class="ident" id="1417314">rwmutexMaxReaders</span><span class="op" id="1417331">)</span>&nbsp;<span class="op" id="1417333">+</span>&nbsp;<span class="ident" id="1417335">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417354">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417383">if</span>&nbsp;<span class="ident" id="1417386">r</span>&nbsp;<span class="op" id="1417388">!=</span>&nbsp;<span class="num" id="1417391">0</span>&nbsp;<span class="op" id="1417393">&amp;&amp;</span>&nbsp;<span class="ident" id="1417396">atomic</span><span class="op" id="1417402">.</span><span class="ident" id="1417403">AddInt32</span><span class="op" id="1417411">(</span><span class="op" id="1417412">&amp;</span><span class="ident" id="1417413">rw</span><span class="op" id="1417415">.</span><span class="ident" id="1417416">readerWait</span><span class="op" id="1417426">,</span>&nbsp;<span class="ident" id="1417428">r</span><span class="op" id="1417429">)</span>&nbsp;<span class="op" id="1417431">!=</span>&nbsp;<span class="num" id="1417434">0</span>&nbsp;<span class="op" id="1417436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417440">runtime_Semacquire</span><span class="op" id="1417458">(</span><span class="op" id="1417459">&amp;</span><span class="ident" id="1417460">rw</span><span class="op" id="1417462">.</span><span class="ident" id="1417463">writerSem</span><span class="op" id="1417472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1417475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417478">if</span>&nbsp;<span class="ident" id="1417481">raceenabled</span>&nbsp;<span class="op" id="1417493">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417497">raceEnable</span><span class="op" id="1417507">(</span><span class="op" id="1417508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417512">raceAcquire</span><span class="op" id="1417523">(</span><span class="ident" id="1417524">unsafe</span><span class="op" id="1417530">.</span><span class="ident" id="1417531">Pointer</span><span class="op" id="1417538">(</span><span class="op" id="1417539">&amp;</span><span class="ident" id="1417540">rw</span><span class="op" id="1417542">.</span><span class="ident" id="1417543">readerSem</span><span class="op" id="1417552">)</span><span class="op" id="1417553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417557">raceAcquire</span><span class="op" id="1417568">(</span><span class="ident" id="1417569">unsafe</span><span class="op" id="1417575">.</span><span class="ident" id="1417576">Pointer</span><span class="op" id="1417583">(</span><span class="op" id="1417584">&amp;</span><span class="ident" id="1417585">rw</span><span class="op" id="1417587">.</span><span class="ident" id="1417588">writerSem</span><span class="op" id="1417597">)</span><span class="op" id="1417598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1417601">}</span><br>
<span class="lineno"></span><span class="op" id="1417603">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1417606">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1417673">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1417719">//</span><br>
<span class="lineno"></span><span class="comment" id="1417722">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1417795">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1417861">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1417918">func</span>&nbsp;<span class="op" id="1417923">(</span><span class="ident" id="1417924">rw</span>&nbsp;<span class="op" id="1417927">*</span><span class="ident" id="1417928">RWMutex</span><span class="op" id="1417935">)</span>&nbsp;<span class="ident" id="1417937">Unlock</span><span class="op" id="1417943">(</span><span class="op" id="1417944">)</span>&nbsp;<span class="op" id="1417946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417949">if</span>&nbsp;<span class="ident" id="1417952">raceenabled</span>&nbsp;<span class="op" id="1417964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417968">_</span>&nbsp;<span class="op" id="1417970">=</span>&nbsp;<span class="ident" id="1417972">rw</span><span class="op" id="1417974">.</span><span class="ident" id="1417975">w</span><span class="op" id="1417976">.</span><span class="ident" id="1417977">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417985">raceRelease</span><span class="op" id="1417996">(</span><span class="ident" id="1417997">unsafe</span><span class="op" id="1418003">.</span><span class="ident" id="1418004">Pointer</span><span class="op" id="1418011">(</span><span class="op" id="1418012">&amp;</span><span class="ident" id="1418013">rw</span><span class="op" id="1418015">.</span><span class="ident" id="1418016">readerSem</span><span class="op" id="1418025">)</span><span class="op" id="1418026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418030">raceRelease</span><span class="op" id="1418041">(</span><span class="ident" id="1418042">unsafe</span><span class="op" id="1418048">.</span><span class="ident" id="1418049">Pointer</span><span class="op" id="1418056">(</span><span class="op" id="1418057">&amp;</span><span class="ident" id="1418058">rw</span><span class="op" id="1418060">.</span><span class="ident" id="1418061">writerSem</span><span class="op" id="1418070">)</span><span class="op" id="1418071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418075">raceDisable</span><span class="op" id="1418086">(</span><span class="op" id="1418087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418094">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418145">r</span>&nbsp;<span class="op" id="1418147">:=</span>&nbsp;<span class="ident" id="1418150">atomic</span><span class="op" id="1418156">.</span><span class="ident" id="1418157">AddInt32</span><span class="op" id="1418165">(</span><span class="op" id="1418166">&amp;</span><span class="ident" id="1418167">rw</span><span class="op" id="1418169">.</span><span class="ident" id="1418170">readerCount</span><span class="op" id="1418181">,</span>&nbsp;<span class="ident" id="1418183">rwmutexMaxReaders</span><span class="op" id="1418200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418203">if</span>&nbsp;<span class="ident" id="1418206">r</span>&nbsp;<span class="op" id="1418208">&gt;=</span>&nbsp;<span class="ident" id="1418211">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1418229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418233">raceEnable</span><span class="op" id="1418243">(</span><span class="op" id="1418244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1418248">panic</span><span class="op" id="1418253">(</span><span class="string" id="1418254">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1418288">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418294">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418331">for</span>&nbsp;<span class="ident" id="1418335">i</span>&nbsp;<span class="op" id="1418337">:=</span>&nbsp;<span class="num" id="1418340">0</span><span class="op" id="1418341">;</span>&nbsp;<span class="ident" id="1418343">i</span>&nbsp;<span class="op" id="1418345">&lt;</span>&nbsp;<span class="builtintype" id="1418347">int</span><span class="op" id="1418350">(</span><span class="ident" id="1418351">r</span><span class="op" id="1418352">)</span><span class="op" id="1418353">;</span>&nbsp;<span class="ident" id="1418355">i</span><span class="op" id="1418356">++</span>&nbsp;<span class="op" id="1418359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418363">runtime_Semrelease</span><span class="op" id="1418381">(</span><span class="op" id="1418382">&amp;</span><span class="ident" id="1418383">rw</span><span class="op" id="1418385">.</span><span class="ident" id="1418386">readerSem</span><span class="op" id="1418395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418398">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418401">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418437">rw</span><span class="op" id="1418439">.</span><span class="ident" id="1418440">w</span><span class="op" id="1418441">.</span><span class="ident" id="1418442">Unlock</span><span class="op" id="1418448">(</span><span class="op" id="1418449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418452">if</span>&nbsp;<span class="ident" id="1418455">raceenabled</span>&nbsp;<span class="op" id="1418467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418471">raceEnable</span><span class="op" id="1418481">(</span><span class="op" id="1418482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418485">}</span><br>
<span class="lineno">125</span><span class="op" id="1418487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1418490">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1418544">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1418611">func</span>&nbsp;<span class="op" id="1418616">(</span><span class="ident" id="1418617">rw</span>&nbsp;<span class="op" id="1418620">*</span><span class="ident" id="1418621">RWMutex</span><span class="op" id="1418628">)</span>&nbsp;<span class="ident" id="1418630">RLocker</span><span class="op" id="1418637">(</span><span class="op" id="1418638">)</span>&nbsp;<span class="ident" id="1418640">Locker</span>&nbsp;<span class="op" id="1418647">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418650">return</span>&nbsp;<span class="op" id="1418657">(</span><span class="op" id="1418658">*</span><span class="ident" id="1418659">rlocker</span><span class="op" id="1418666">)</span><span class="op" id="1418667">(</span><span class="ident" id="1418668">rw</span><span class="op" id="1418670">)</span><br>
<span class="lineno"></span><span class="op" id="1418672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418675">type</span>&nbsp;<span class="ident" id="1418680">rlocker</span>&nbsp;<span class="ident" id="1418688">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1418697">func</span>&nbsp;<span class="op" id="1418702">(</span><span class="ident" id="1418703">r</span>&nbsp;<span class="op" id="1418705">*</span><span class="ident" id="1418706">rlocker</span><span class="op" id="1418713">)</span>&nbsp;<span class="ident" id="1418715">Lock</span><span class="op" id="1418719">(</span><span class="op" id="1418720">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1418724">{</span>&nbsp;<span class="op" id="1418726">(</span><span class="op" id="1418727">*</span><span class="ident" id="1418728">RWMutex</span><span class="op" id="1418735">)</span><span class="op" id="1418736">(</span><span class="ident" id="1418737">r</span><span class="op" id="1418738">)</span><span class="op" id="1418739">.</span><span class="ident" id="1418740">RLock</span><span class="op" id="1418745">(</span><span class="op" id="1418746">)</span>&nbsp;<span class="op" id="1418748">}</span><br>
<span class="lineno"></span><span class="keyword" id="1418750">func</span>&nbsp;<span class="op" id="1418755">(</span><span class="ident" id="1418756">r</span>&nbsp;<span class="op" id="1418758">*</span><span class="ident" id="1418759">rlocker</span><span class="op" id="1418766">)</span>&nbsp;<span class="ident" id="1418768">Unlock</span><span class="op" id="1418774">(</span><span class="op" id="1418775">)</span>&nbsp;<span class="op" id="1418777">{</span>&nbsp;<span class="op" id="1418779">(</span><span class="op" id="1418780">*</span><span class="ident" id="1418781">RWMutex</span><span class="op" id="1418788">)</span><span class="op" id="1418789">(</span><span class="ident" id="1418790">r</span><span class="op" id="1418791">)</span><span class="op" id="1418792">.</span><span class="ident" id="1418793">RUnlock</span><span class="op" id="1418800">(</span><span class="op" id="1418801">)</span>&nbsp;<span class="op" id="1418803">}</span>
</div>
</body>
</html>
