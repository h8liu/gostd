<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1523633">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1523688">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1523742">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1523793">package</span>&nbsp;<span class="ident" id="1523801">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1523810">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1523869">//</span><br>
<span class="lineno"></span><span class="comment" id="1523872">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1523925">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1523982">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1524040">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1524096">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1524155">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1524182">//</span><br>
<span class="lineno"></span><span class="comment" id="1524185">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1524238">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1524256">//</span><br>
<span class="lineno"></span><span class="comment" id="1524259">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1524312">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1524367">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1524428">//</span><br>
<span class="lineno"></span><span class="comment" id="1524431">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1524486">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1524544">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1524603">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1524660">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1524715">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1524776">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1524832">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1524891">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1524913">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1524975">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1525035">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1525096">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1525132">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1525199">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1525266">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1525333">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1525400">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1525467">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1525534">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1525601">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1525668">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1525735">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1525802">//</span><br>
<span class="lineno"></span><span class="comment" id="1525805">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1525874">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1525930">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1525999">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1526068">//</span><br>
<span class="lineno"></span><span class="comment" id="1526071">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1526139">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1526213">import</span>&nbsp;<span class="op" id="1526220">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1526223">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1526232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1526235">const</span>&nbsp;<span class="op" id="1526241">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526244">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526301">bucketCntBits</span>&nbsp;<span class="op" id="1526315">=</span>&nbsp;<span class="num" id="1526317">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526320">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1526334">=</span>&nbsp;<span class="num" id="1526336">1</span>&nbsp;<span class="op" id="1526338">&lt;&lt;</span>&nbsp;<span class="ident" id="1526341">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526357">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526416">loadFactor</span>&nbsp;<span class="op" id="1526427">=</span>&nbsp;<span class="num" id="1526429">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526435">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526516">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526541">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526606">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526675">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1526688">=</span>&nbsp;<span class="num" id="1526690">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526695">maxValueSize</span>&nbsp;<span class="op" id="1526708">=</span>&nbsp;<span class="num" id="1526710">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526716">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526787">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526852">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526889">dataOffset</span>&nbsp;<span class="op" id="1526900">=</span>&nbsp;<span class="ident" id="1526902">unsafe</span><span class="op" id="1526908">.</span><span class="ident" id="1526909">Offsetof</span><span class="op" id="1526917">(</span><span class="keyword" id="1526918">struct</span>&nbsp;<span class="op" id="1526925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526929">b</span>&nbsp;<span class="ident" id="1526931">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526938">v</span>&nbsp;<span class="ident" id="1526940">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526947">}</span><span class="op" id="1526948">{</span><span class="op" id="1526949">}</span><span class="op" id="1526950">.</span><span class="ident" id="1526951">v</span><span class="op" id="1526952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1526956">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527036">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527129">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527223">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527305">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527320">=</span>&nbsp;<span class="num" id="1527322">0</span>&nbsp;<span class="comment" id="1527324">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527342">evacuatedEmpty</span>&nbsp;<span class="op" id="1527357">=</span>&nbsp;<span class="num" id="1527359">1</span>&nbsp;<span class="comment" id="1527361">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527401">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527416">=</span>&nbsp;<span class="num" id="1527418">2</span>&nbsp;<span class="comment" id="1527420">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527501">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527516">=</span>&nbsp;<span class="num" id="1527518">3</span>&nbsp;<span class="comment" id="1527520">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527585">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527600">=</span>&nbsp;<span class="num" id="1527602">4</span>&nbsp;<span class="comment" id="1527604">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527651">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527661">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1527673">=</span>&nbsp;<span class="num" id="1527675">1</span>&nbsp;<span class="comment" id="1527677">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527720">oldIterator</span>&nbsp;<span class="op" id="1527732">=</span>&nbsp;<span class="num" id="1527734">2</span>&nbsp;<span class="comment" id="1527736">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527783">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527826">noCheck</span>&nbsp;<span class="op" id="1527834">=</span>&nbsp;<span class="num" id="1527836">1</span><span class="op" id="1527837">&lt;&lt;</span><span class="op" id="1527839">(</span><span class="num" id="1527840">8</span><span class="op" id="1527841">*</span><span class="ident" id="1527842">ptrSize</span><span class="op" id="1527849">)</span>&nbsp;<span class="op" id="1527851">-</span>&nbsp;<span class="num" id="1527853">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527857">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527927">checkgc</span>&nbsp;<span class="op" id="1527935">=</span>&nbsp;<span class="builtintype" id="1527937">false</span><br>
<span class="lineno"></span><span class="op" id="1527943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1527946">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1527972">type</span>&nbsp;<span class="ident" id="1527977">hmap</span>&nbsp;<span class="keyword" id="1527982">struct</span>&nbsp;<span class="op" id="1527989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527992">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528066">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528152">count</span>&nbsp;<span class="builtintype" id="1528158">int</span>&nbsp;<span class="comment" id="1528162">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528234">flags</span>&nbsp;<span class="builtintype" id="1528240">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528248">hash0</span>&nbsp;<span class="builtintype" id="1528254">uint32</span>&nbsp;<span class="comment" id="1528261">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528275">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1528281">uint8</span>&nbsp;&nbsp;<span class="comment" id="1528288">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528355">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1528366">unsafe</span><span class="op" id="1528372">.</span><span class="ident" id="1528373">Pointer</span>&nbsp;<span class="comment" id="1528381">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528431">oldbuckets</span>&nbsp;<span class="ident" id="1528442">unsafe</span><span class="op" id="1528448">.</span><span class="ident" id="1528449">Pointer</span>&nbsp;<span class="comment" id="1528457">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528527">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1528538">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1528553">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1528633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1528636">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1528662">type</span>&nbsp;<span class="ident" id="1528667">bmap</span>&nbsp;<span class="keyword" id="1528672">struct</span>&nbsp;<span class="op" id="1528679">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528682">tophash</span>&nbsp;&nbsp;<span class="op" id="1528691">[</span><span class="ident" id="1528692">bucketCnt</span><span class="op" id="1528701">]</span><span class="builtintype" id="1528702">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528709">overflow</span>&nbsp;<span class="op" id="1528718">*</span><span class="ident" id="1528719">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528725">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528783">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528866">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528953">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1529029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1529032">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1529063">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1529128">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1529161">type</span>&nbsp;<span class="ident" id="1529166">hiter</span>&nbsp;<span class="keyword" id="1529172">struct</span>&nbsp;<span class="op" id="1529179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529182">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1529194">unsafe</span><span class="op" id="1529200">.</span><span class="ident" id="1529201">Pointer</span>&nbsp;<span class="comment" id="1529209">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529299">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1529311">unsafe</span><span class="op" id="1529317">.</span><span class="ident" id="1529318">Pointer</span>&nbsp;<span class="comment" id="1529326">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529379">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1529391">*</span><span class="ident" id="1529392">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529401">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1529413">*</span><span class="ident" id="1529414">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529420">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1529432">unsafe</span><span class="op" id="1529438">.</span><span class="ident" id="1529439">Pointer</span>&nbsp;<span class="comment" id="1529447">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529495">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1529507">*</span><span class="ident" id="1529508">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1529522">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529541">startBucket</span>&nbsp;<span class="builtintype" id="1529553">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1529568">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529600">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1529612">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1529627">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529725">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1529737">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1529752">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529817">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1529829">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529836">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1529848">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529855">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1529867">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529876">checkBucket</span>&nbsp;<span class="builtintype" id="1529888">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1529896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1529899">func</span>&nbsp;<span class="ident" id="1529904">evacuated</span><span class="op" id="1529913">(</span><span class="ident" id="1529914">b</span>&nbsp;<span class="op" id="1529916">*</span><span class="ident" id="1529917">bmap</span><span class="op" id="1529921">)</span>&nbsp;<span class="builtintype" id="1529923">bool</span>&nbsp;<span class="op" id="1529928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529931">h</span>&nbsp;<span class="op" id="1529933">:=</span>&nbsp;<span class="ident" id="1529936">b</span><span class="op" id="1529937">.</span><span class="ident" id="1529938">tophash</span><span class="op" id="1529945">[</span><span class="num" id="1529946">0</span><span class="op" id="1529947">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529950">return</span>&nbsp;<span class="ident" id="1529957">h</span>&nbsp;<span class="op" id="1529959">&gt;</span>&nbsp;<span class="ident" id="1529961">empty</span>&nbsp;<span class="op" id="1529967">&amp;&amp;</span>&nbsp;<span class="ident" id="1529970">h</span>&nbsp;<span class="op" id="1529972">&lt;</span>&nbsp;<span class="ident" id="1529974">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1529985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1529988">func</span>&nbsp;<span class="ident" id="1529993">makemap</span><span class="op" id="1530000">(</span><span class="ident" id="1530001">t</span>&nbsp;<span class="op" id="1530003">*</span><span class="ident" id="1530004">maptype</span><span class="op" id="1530011">,</span>&nbsp;<span class="ident" id="1530013">hint</span>&nbsp;<span class="ident" id="1530018">int64</span><span class="op" id="1530023">)</span>&nbsp;<span class="op" id="1530025">*</span><span class="ident" id="1530026">hmap</span>&nbsp;<span class="op" id="1530031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530034">if</span>&nbsp;<span class="ident" id="1530037">sz</span>&nbsp;<span class="op" id="1530040">:=</span>&nbsp;<span class="ident" id="1530043">unsafe</span><span class="op" id="1530049">.</span><span class="ident" id="1530050">Sizeof</span><span class="op" id="1530056">(</span><span class="ident" id="1530057">hmap</span><span class="op" id="1530061">{</span><span class="op" id="1530062">}</span><span class="op" id="1530063">)</span><span class="op" id="1530064">;</span>&nbsp;<span class="ident" id="1530066">sz</span>&nbsp;<span class="op" id="1530069">&gt;</span>&nbsp;<span class="num" id="1530071">48</span>&nbsp;<span class="op" id="1530074">||</span>&nbsp;<span class="ident" id="1530077">sz</span>&nbsp;<span class="op" id="1530080">!=</span>&nbsp;<span class="builtintype" id="1530083">uintptr</span><span class="op" id="1530090">(</span><span class="ident" id="1530091">t</span><span class="op" id="1530092">.</span><span class="ident" id="1530093">hmap</span><span class="op" id="1530097">.</span><span class="ident" id="1530098">size</span><span class="op" id="1530102">)</span>&nbsp;<span class="op" id="1530104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530108">gothrow</span><span class="op" id="1530115">(</span><span class="string" id="1530116">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1530131">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530138">if</span>&nbsp;<span class="ident" id="1530141">hint</span>&nbsp;<span class="op" id="1530146">&lt;</span>&nbsp;<span class="num" id="1530148">0</span>&nbsp;<span class="op" id="1530150">||</span>&nbsp;<span class="ident" id="1530153">int64</span><span class="op" id="1530158">(</span><span class="builtintype" id="1530159">int32</span><span class="op" id="1530164">(</span><span class="ident" id="1530165">hint</span><span class="op" id="1530169">)</span><span class="op" id="1530170">)</span>&nbsp;<span class="op" id="1530172">!=</span>&nbsp;<span class="ident" id="1530175">hint</span>&nbsp;<span class="op" id="1530180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1530184">panic</span><span class="op" id="1530189">(</span><span class="string" id="1530190">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1530218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530222">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530281">if</span>&nbsp;<span class="op" id="1530284">!</span><span class="ident" id="1530285">ismapkey</span><span class="op" id="1530293">(</span><span class="ident" id="1530294">t</span><span class="op" id="1530295">.</span><span class="ident" id="1530296">key</span><span class="op" id="1530299">)</span>&nbsp;<span class="op" id="1530301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530305">gothrow</span><span class="op" id="1530312">(</span><span class="string" id="1530313">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1530356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530359">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530363">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530403">if</span>&nbsp;<span class="ident" id="1530406">t</span><span class="op" id="1530407">.</span><span class="ident" id="1530408">key</span><span class="op" id="1530411">.</span><span class="ident" id="1530412">size</span>&nbsp;<span class="op" id="1530417">&gt;</span>&nbsp;<span class="ident" id="1530419">maxKeySize</span>&nbsp;<span class="op" id="1530430">&amp;&amp;</span>&nbsp;<span class="op" id="1530433">(</span><span class="op" id="1530434">!</span><span class="ident" id="1530435">t</span><span class="op" id="1530436">.</span><span class="ident" id="1530437">indirectkey</span>&nbsp;<span class="op" id="1530449">||</span>&nbsp;<span class="ident" id="1530452">t</span><span class="op" id="1530453">.</span><span class="ident" id="1530454">keysize</span>&nbsp;<span class="op" id="1530462">!=</span>&nbsp;<span class="builtintype" id="1530465">uint8</span><span class="op" id="1530470">(</span><span class="ident" id="1530471">ptrSize</span><span class="op" id="1530478">)</span><span class="op" id="1530479">)</span>&nbsp;<span class="op" id="1530481">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530486">t</span><span class="op" id="1530487">.</span><span class="ident" id="1530488">key</span><span class="op" id="1530491">.</span><span class="ident" id="1530492">size</span>&nbsp;<span class="op" id="1530497">&lt;=</span>&nbsp;<span class="ident" id="1530500">maxKeySize</span>&nbsp;<span class="op" id="1530511">&amp;&amp;</span>&nbsp;<span class="op" id="1530514">(</span><span class="ident" id="1530515">t</span><span class="op" id="1530516">.</span><span class="ident" id="1530517">indirectkey</span>&nbsp;<span class="op" id="1530529">||</span>&nbsp;<span class="ident" id="1530532">t</span><span class="op" id="1530533">.</span><span class="ident" id="1530534">keysize</span>&nbsp;<span class="op" id="1530542">!=</span>&nbsp;<span class="builtintype" id="1530545">uint8</span><span class="op" id="1530550">(</span><span class="ident" id="1530551">t</span><span class="op" id="1530552">.</span><span class="ident" id="1530553">key</span><span class="op" id="1530556">.</span><span class="ident" id="1530557">size</span><span class="op" id="1530561">)</span><span class="op" id="1530562">)</span>&nbsp;<span class="op" id="1530564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530568">gothrow</span><span class="op" id="1530575">(</span><span class="string" id="1530576">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1530592">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530598">if</span>&nbsp;<span class="ident" id="1530601">t</span><span class="op" id="1530602">.</span><span class="ident" id="1530603">elem</span><span class="op" id="1530607">.</span><span class="ident" id="1530608">size</span>&nbsp;<span class="op" id="1530613">&gt;</span>&nbsp;<span class="ident" id="1530615">maxValueSize</span>&nbsp;<span class="op" id="1530628">&amp;&amp;</span>&nbsp;<span class="op" id="1530631">(</span><span class="op" id="1530632">!</span><span class="ident" id="1530633">t</span><span class="op" id="1530634">.</span><span class="ident" id="1530635">indirectvalue</span>&nbsp;<span class="op" id="1530649">||</span>&nbsp;<span class="ident" id="1530652">t</span><span class="op" id="1530653">.</span><span class="ident" id="1530654">valuesize</span>&nbsp;<span class="op" id="1530664">!=</span>&nbsp;<span class="builtintype" id="1530667">uint8</span><span class="op" id="1530672">(</span><span class="ident" id="1530673">ptrSize</span><span class="op" id="1530680">)</span><span class="op" id="1530681">)</span>&nbsp;<span class="op" id="1530683">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530688">t</span><span class="op" id="1530689">.</span><span class="ident" id="1530690">elem</span><span class="op" id="1530694">.</span><span class="ident" id="1530695">size</span>&nbsp;<span class="op" id="1530700">&lt;=</span>&nbsp;<span class="ident" id="1530703">maxValueSize</span>&nbsp;<span class="op" id="1530716">&amp;&amp;</span>&nbsp;<span class="op" id="1530719">(</span><span class="ident" id="1530720">t</span><span class="op" id="1530721">.</span><span class="ident" id="1530722">indirectvalue</span>&nbsp;<span class="op" id="1530736">||</span>&nbsp;<span class="ident" id="1530739">t</span><span class="op" id="1530740">.</span><span class="ident" id="1530741">valuesize</span>&nbsp;<span class="op" id="1530751">!=</span>&nbsp;<span class="builtintype" id="1530754">uint8</span><span class="op" id="1530759">(</span><span class="ident" id="1530760">t</span><span class="op" id="1530761">.</span><span class="ident" id="1530762">elem</span><span class="op" id="1530766">.</span><span class="ident" id="1530767">size</span><span class="op" id="1530771">)</span><span class="op" id="1530772">)</span>&nbsp;<span class="op" id="1530774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530778">gothrow</span><span class="op" id="1530785">(</span><span class="string" id="1530786">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1530804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530807">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530811">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530888">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530933">if</span>&nbsp;<span class="ident" id="1530936">t</span><span class="op" id="1530937">.</span><span class="ident" id="1530938">key</span><span class="op" id="1530941">.</span><span class="ident" id="1530942">align</span>&nbsp;<span class="op" id="1530948">&gt;</span>&nbsp;<span class="ident" id="1530950">bucketCnt</span>&nbsp;<span class="op" id="1530960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530964">gothrow</span><span class="op" id="1530971">(</span><span class="string" id="1530972">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1530991">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1530994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530997">if</span>&nbsp;<span class="ident" id="1531000">t</span><span class="op" id="1531001">.</span><span class="ident" id="1531002">elem</span><span class="op" id="1531006">.</span><span class="ident" id="1531007">align</span>&nbsp;<span class="op" id="1531013">&gt;</span>&nbsp;<span class="ident" id="1531015">bucketCnt</span>&nbsp;<span class="op" id="1531025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531029">gothrow</span><span class="op" id="1531036">(</span><span class="string" id="1531037">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1531058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531064">if</span>&nbsp;<span class="builtintype" id="1531067">uintptr</span><span class="op" id="1531074">(</span><span class="ident" id="1531075">t</span><span class="op" id="1531076">.</span><span class="ident" id="1531077">key</span><span class="op" id="1531080">.</span><span class="ident" id="1531081">size</span><span class="op" id="1531085">)</span><span class="op" id="1531086">%</span><span class="builtintype" id="1531087">uintptr</span><span class="op" id="1531094">(</span><span class="ident" id="1531095">t</span><span class="op" id="1531096">.</span><span class="ident" id="1531097">key</span><span class="op" id="1531100">.</span><span class="ident" id="1531101">align</span><span class="op" id="1531106">)</span>&nbsp;<span class="op" id="1531108">!=</span>&nbsp;<span class="num" id="1531111">0</span>&nbsp;<span class="op" id="1531113">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531117">gothrow</span><span class="op" id="1531124">(</span><span class="string" id="1531125">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1531163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531169">if</span>&nbsp;<span class="builtintype" id="1531172">uintptr</span><span class="op" id="1531179">(</span><span class="ident" id="1531180">t</span><span class="op" id="1531181">.</span><span class="ident" id="1531182">elem</span><span class="op" id="1531186">.</span><span class="ident" id="1531187">size</span><span class="op" id="1531191">)</span><span class="op" id="1531192">%</span><span class="builtintype" id="1531193">uintptr</span><span class="op" id="1531200">(</span><span class="ident" id="1531201">t</span><span class="op" id="1531202">.</span><span class="ident" id="1531203">elem</span><span class="op" id="1531207">.</span><span class="ident" id="1531208">align</span><span class="op" id="1531213">)</span>&nbsp;<span class="op" id="1531215">!=</span>&nbsp;<span class="num" id="1531218">0</span>&nbsp;<span class="op" id="1531220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531224">gothrow</span><span class="op" id="1531231">(</span><span class="string" id="1531232">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1531274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531277">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531280">if</span>&nbsp;<span class="ident" id="1531283">bucketCnt</span>&nbsp;<span class="op" id="1531293">&lt;</span>&nbsp;<span class="num" id="1531295">8</span>&nbsp;<span class="op" id="1531297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531301">gothrow</span><span class="op" id="1531308">(</span><span class="string" id="1531309">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1531352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531358">if</span>&nbsp;<span class="ident" id="1531361">dataOffset</span><span class="op" id="1531371">%</span><span class="builtintype" id="1531372">uintptr</span><span class="op" id="1531379">(</span><span class="ident" id="1531380">t</span><span class="op" id="1531381">.</span><span class="ident" id="1531382">key</span><span class="op" id="1531385">.</span><span class="ident" id="1531386">align</span><span class="op" id="1531391">)</span>&nbsp;<span class="op" id="1531393">!=</span>&nbsp;<span class="num" id="1531396">0</span>&nbsp;<span class="op" id="1531398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531402">gothrow</span><span class="op" id="1531409">(</span><span class="string" id="1531410">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1531440">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531446">if</span>&nbsp;<span class="ident" id="1531449">dataOffset</span><span class="op" id="1531459">%</span><span class="builtintype" id="1531460">uintptr</span><span class="op" id="1531467">(</span><span class="ident" id="1531468">t</span><span class="op" id="1531469">.</span><span class="ident" id="1531470">elem</span><span class="op" id="1531474">.</span><span class="ident" id="1531475">align</span><span class="op" id="1531480">)</span>&nbsp;<span class="op" id="1531482">!=</span>&nbsp;<span class="num" id="1531485">0</span>&nbsp;<span class="op" id="1531487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531491">gothrow</span><span class="op" id="1531498">(</span><span class="string" id="1531499">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1531531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531538">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531606">B</span>&nbsp;<span class="op" id="1531608">:=</span>&nbsp;<span class="builtintype" id="1531611">uint8</span><span class="op" id="1531616">(</span><span class="num" id="1531617">0</span><span class="op" id="1531618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531621">for</span>&nbsp;<span class="op" id="1531625">;</span>&nbsp;<span class="ident" id="1531627">hint</span>&nbsp;<span class="op" id="1531632">&gt;</span>&nbsp;<span class="ident" id="1531634">bucketCnt</span>&nbsp;<span class="op" id="1531644">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1531647">float32</span><span class="op" id="1531654">(</span><span class="ident" id="1531655">hint</span><span class="op" id="1531659">)</span>&nbsp;<span class="op" id="1531661">&gt;</span>&nbsp;<span class="ident" id="1531663">loadFactor</span><span class="op" id="1531673">*</span><span class="builtintype" id="1531674">float32</span><span class="op" id="1531681">(</span><span class="builtintype" id="1531682">uintptr</span><span class="op" id="1531689">(</span><span class="num" id="1531690">1</span><span class="op" id="1531691">)</span><span class="op" id="1531692">&lt;&lt;</span><span class="ident" id="1531694">B</span><span class="op" id="1531695">)</span><span class="op" id="1531696">;</span>&nbsp;<span class="ident" id="1531698">B</span><span class="op" id="1531699">++</span>&nbsp;<span class="op" id="1531702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531709">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531741">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531815">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531876">var</span>&nbsp;<span class="ident" id="1531880">buckets</span>&nbsp;<span class="ident" id="1531888">unsafe</span><span class="op" id="1531894">.</span><span class="ident" id="1531895">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531904">if</span>&nbsp;<span class="ident" id="1531907">B</span>&nbsp;<span class="op" id="1531909">!=</span>&nbsp;<span class="num" id="1531912">0</span>&nbsp;<span class="op" id="1531914">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531918">if</span>&nbsp;<span class="ident" id="1531921">checkgc</span>&nbsp;<span class="op" id="1531929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531934">memstats</span><span class="op" id="1531942">.</span><span class="ident" id="1531943">next_gc</span>&nbsp;<span class="op" id="1531951">=</span>&nbsp;<span class="ident" id="1531953">memstats</span><span class="op" id="1531961">.</span><span class="ident" id="1531962">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531979">buckets</span>&nbsp;<span class="op" id="1531987">=</span>&nbsp;<span class="ident" id="1531989">newarray</span><span class="op" id="1531997">(</span><span class="ident" id="1531998">t</span><span class="op" id="1531999">.</span><span class="ident" id="1532000">bucket</span><span class="op" id="1532006">,</span>&nbsp;<span class="builtintype" id="1532008">uintptr</span><span class="op" id="1532015">(</span><span class="num" id="1532016">1</span><span class="op" id="1532017">)</span><span class="op" id="1532018">&lt;&lt;</span><span class="ident" id="1532020">B</span><span class="op" id="1532021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532024">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532028">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532048">if</span>&nbsp;<span class="ident" id="1532051">checkgc</span>&nbsp;<span class="op" id="1532059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532063">memstats</span><span class="op" id="1532071">.</span><span class="ident" id="1532072">next_gc</span>&nbsp;<span class="op" id="1532080">=</span>&nbsp;<span class="ident" id="1532082">memstats</span><span class="op" id="1532090">.</span><span class="ident" id="1532091">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532103">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532106">h</span>&nbsp;<span class="op" id="1532108">:=</span>&nbsp;<span class="op" id="1532111">(</span><span class="op" id="1532112">*</span><span class="ident" id="1532113">hmap</span><span class="op" id="1532117">)</span><span class="op" id="1532118">(</span><span class="ident" id="1532119">newobject</span><span class="op" id="1532128">(</span><span class="ident" id="1532129">t</span><span class="op" id="1532130">.</span><span class="ident" id="1532131">hmap</span><span class="op" id="1532135">)</span><span class="op" id="1532136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532139">h</span><span class="op" id="1532140">.</span><span class="ident" id="1532141">count</span>&nbsp;<span class="op" id="1532147">=</span>&nbsp;<span class="num" id="1532149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532152">h</span><span class="op" id="1532153">.</span><span class="ident" id="1532154">B</span>&nbsp;<span class="op" id="1532156">=</span>&nbsp;<span class="ident" id="1532158">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532161">h</span><span class="op" id="1532162">.</span><span class="ident" id="1532163">flags</span>&nbsp;<span class="op" id="1532169">=</span>&nbsp;<span class="num" id="1532171">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532174">h</span><span class="op" id="1532175">.</span><span class="ident" id="1532176">hash0</span>&nbsp;<span class="op" id="1532182">=</span>&nbsp;<span class="ident" id="1532184">fastrand1</span><span class="op" id="1532193">(</span><span class="op" id="1532194">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532197">h</span><span class="op" id="1532198">.</span><span class="ident" id="1532199">buckets</span>&nbsp;<span class="op" id="1532207">=</span>&nbsp;<span class="ident" id="1532209">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532218">h</span><span class="op" id="1532219">.</span><span class="ident" id="1532220">oldbuckets</span>&nbsp;<span class="op" id="1532231">=</span>&nbsp;<span class="ident" id="1532233">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532238">h</span><span class="op" id="1532239">.</span><span class="ident" id="1532240">nevacuate</span>&nbsp;<span class="op" id="1532250">=</span>&nbsp;<span class="num" id="1532252">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532256">return</span>&nbsp;<span class="ident" id="1532263">h</span><br>
<span class="lineno">230</span><span class="op" id="1532265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1532268">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1532339">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1532410">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1532440">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1532508">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1532539">func</span>&nbsp;<span class="ident" id="1532544">mapaccess1</span><span class="op" id="1532554">(</span><span class="ident" id="1532555">t</span>&nbsp;<span class="op" id="1532557">*</span><span class="ident" id="1532558">maptype</span><span class="op" id="1532565">,</span>&nbsp;<span class="ident" id="1532567">h</span>&nbsp;<span class="op" id="1532569">*</span><span class="ident" id="1532570">hmap</span><span class="op" id="1532574">,</span>&nbsp;<span class="ident" id="1532576">key</span>&nbsp;<span class="ident" id="1532580">unsafe</span><span class="op" id="1532586">.</span><span class="ident" id="1532587">Pointer</span><span class="op" id="1532594">)</span>&nbsp;<span class="ident" id="1532596">unsafe</span><span class="op" id="1532602">.</span><span class="ident" id="1532603">Pointer</span>&nbsp;<span class="op" id="1532611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532614">if</span>&nbsp;<span class="ident" id="1532617">raceenabled</span>&nbsp;<span class="op" id="1532629">&amp;&amp;</span>&nbsp;<span class="ident" id="1532632">h</span>&nbsp;<span class="op" id="1532634">!=</span>&nbsp;<span class="ident" id="1532637">nil</span>&nbsp;<span class="op" id="1532641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532645">callerpc</span>&nbsp;<span class="op" id="1532654">:=</span>&nbsp;<span class="ident" id="1532657">getcallerpc</span><span class="op" id="1532668">(</span><span class="ident" id="1532669">unsafe</span><span class="op" id="1532675">.</span><span class="ident" id="1532676">Pointer</span><span class="op" id="1532683">(</span><span class="op" id="1532684">&amp;</span><span class="ident" id="1532685">t</span><span class="op" id="1532686">)</span><span class="op" id="1532687">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532691">pc</span>&nbsp;<span class="op" id="1532694">:=</span>&nbsp;<span class="ident" id="1532697">funcPC</span><span class="op" id="1532703">(</span><span class="ident" id="1532704">mapaccess1</span><span class="op" id="1532714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532718">racereadpc</span><span class="op" id="1532728">(</span><span class="ident" id="1532729">unsafe</span><span class="op" id="1532735">.</span><span class="ident" id="1532736">Pointer</span><span class="op" id="1532743">(</span><span class="ident" id="1532744">h</span><span class="op" id="1532745">)</span><span class="op" id="1532746">,</span>&nbsp;<span class="ident" id="1532748">callerpc</span><span class="op" id="1532756">,</span>&nbsp;<span class="ident" id="1532758">pc</span><span class="op" id="1532760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532764">raceReadObjectPC</span><span class="op" id="1532780">(</span><span class="ident" id="1532781">t</span><span class="op" id="1532782">.</span><span class="ident" id="1532783">key</span><span class="op" id="1532786">,</span>&nbsp;<span class="ident" id="1532788">key</span><span class="op" id="1532791">,</span>&nbsp;<span class="ident" id="1532793">callerpc</span><span class="op" id="1532801">,</span>&nbsp;<span class="ident" id="1532803">pc</span><span class="op" id="1532805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532811">if</span>&nbsp;<span class="ident" id="1532814">h</span>&nbsp;<span class="op" id="1532816">==</span>&nbsp;<span class="ident" id="1532819">nil</span>&nbsp;<span class="op" id="1532823">||</span>&nbsp;<span class="ident" id="1532826">h</span><span class="op" id="1532827">.</span><span class="ident" id="1532828">count</span>&nbsp;<span class="op" id="1532834">==</span>&nbsp;<span class="num" id="1532837">0</span>&nbsp;<span class="op" id="1532839">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532843">return</span>&nbsp;<span class="ident" id="1532850">unsafe</span><span class="op" id="1532856">.</span><span class="ident" id="1532857">Pointer</span><span class="op" id="1532864">(</span><span class="ident" id="1532865">t</span><span class="op" id="1532866">.</span><span class="ident" id="1532867">elem</span><span class="op" id="1532871">.</span><span class="ident" id="1532872">zero</span><span class="op" id="1532876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532882">alg</span>&nbsp;<span class="op" id="1532886">:=</span>&nbsp;<span class="ident" id="1532889">goalg</span><span class="op" id="1532894">(</span><span class="ident" id="1532895">t</span><span class="op" id="1532896">.</span><span class="ident" id="1532897">key</span><span class="op" id="1532900">.</span><span class="ident" id="1532901">alg</span><span class="op" id="1532904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532907">hash</span>&nbsp;<span class="op" id="1532912">:=</span>&nbsp;<span class="ident" id="1532915">alg</span><span class="op" id="1532918">.</span><span class="ident" id="1532919">hash</span><span class="op" id="1532923">(</span><span class="ident" id="1532924">key</span><span class="op" id="1532927">,</span>&nbsp;<span class="builtintype" id="1532929">uintptr</span><span class="op" id="1532936">(</span><span class="ident" id="1532937">t</span><span class="op" id="1532938">.</span><span class="ident" id="1532939">key</span><span class="op" id="1532942">.</span><span class="ident" id="1532943">size</span><span class="op" id="1532947">)</span><span class="op" id="1532948">,</span>&nbsp;<span class="builtintype" id="1532950">uintptr</span><span class="op" id="1532957">(</span><span class="ident" id="1532958">h</span><span class="op" id="1532959">.</span><span class="ident" id="1532960">hash0</span><span class="op" id="1532965">)</span><span class="op" id="1532966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532969">m</span>&nbsp;<span class="op" id="1532971">:=</span>&nbsp;<span class="builtintype" id="1532974">uintptr</span><span class="op" id="1532981">(</span><span class="num" id="1532982">1</span><span class="op" id="1532983">)</span><span class="op" id="1532984">&lt;&lt;</span><span class="ident" id="1532986">h</span><span class="op" id="1532987">.</span><span class="ident" id="1532988">B</span>&nbsp;<span class="op" id="1532990">-</span>&nbsp;<span class="num" id="1532992">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532995">b</span>&nbsp;<span class="op" id="1532997">:=</span>&nbsp;<span class="op" id="1533000">(</span><span class="op" id="1533001">*</span><span class="ident" id="1533002">bmap</span><span class="op" id="1533006">)</span><span class="op" id="1533007">(</span><span class="ident" id="1533008">add</span><span class="op" id="1533011">(</span><span class="ident" id="1533012">h</span><span class="op" id="1533013">.</span><span class="ident" id="1533014">buckets</span><span class="op" id="1533021">,</span>&nbsp;<span class="op" id="1533023">(</span><span class="ident" id="1533024">hash</span><span class="op" id="1533028">&amp;</span><span class="ident" id="1533029">m</span><span class="op" id="1533030">)</span><span class="op" id="1533031">*</span><span class="builtintype" id="1533032">uintptr</span><span class="op" id="1533039">(</span><span class="ident" id="1533040">t</span><span class="op" id="1533041">.</span><span class="ident" id="1533042">bucketsize</span><span class="op" id="1533052">)</span><span class="op" id="1533053">)</span><span class="op" id="1533054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533057">if</span>&nbsp;<span class="ident" id="1533060">c</span>&nbsp;<span class="op" id="1533062">:=</span>&nbsp;<span class="ident" id="1533065">h</span><span class="op" id="1533066">.</span><span class="ident" id="1533067">oldbuckets</span><span class="op" id="1533077">;</span>&nbsp;<span class="ident" id="1533079">c</span>&nbsp;<span class="op" id="1533081">!=</span>&nbsp;<span class="ident" id="1533084">nil</span>&nbsp;<span class="op" id="1533088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533092">oldb</span>&nbsp;<span class="op" id="1533097">:=</span>&nbsp;<span class="op" id="1533100">(</span><span class="op" id="1533101">*</span><span class="ident" id="1533102">bmap</span><span class="op" id="1533106">)</span><span class="op" id="1533107">(</span><span class="ident" id="1533108">add</span><span class="op" id="1533111">(</span><span class="ident" id="1533112">c</span><span class="op" id="1533113">,</span>&nbsp;<span class="op" id="1533115">(</span><span class="ident" id="1533116">hash</span><span class="op" id="1533120">&amp;</span><span class="op" id="1533121">(</span><span class="ident" id="1533122">m</span><span class="op" id="1533123">&gt;&gt;</span><span class="num" id="1533125">1</span><span class="op" id="1533126">)</span><span class="op" id="1533127">)</span><span class="op" id="1533128">*</span><span class="builtintype" id="1533129">uintptr</span><span class="op" id="1533136">(</span><span class="ident" id="1533137">t</span><span class="op" id="1533138">.</span><span class="ident" id="1533139">bucketsize</span><span class="op" id="1533149">)</span><span class="op" id="1533150">)</span><span class="op" id="1533151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533155">if</span>&nbsp;<span class="op" id="1533158">!</span><span class="ident" id="1533159">evacuated</span><span class="op" id="1533168">(</span><span class="ident" id="1533169">oldb</span><span class="op" id="1533173">)</span>&nbsp;<span class="op" id="1533175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533180">b</span>&nbsp;<span class="op" id="1533182">=</span>&nbsp;<span class="ident" id="1533184">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533197">top</span>&nbsp;<span class="op" id="1533201">:=</span>&nbsp;<span class="builtintype" id="1533204">uint8</span><span class="op" id="1533209">(</span><span class="ident" id="1533210">hash</span>&nbsp;<span class="op" id="1533215">&gt;&gt;</span>&nbsp;<span class="op" id="1533218">(</span><span class="ident" id="1533219">ptrSize</span><span class="op" id="1533226">*</span><span class="num" id="1533227">8</span>&nbsp;<span class="op" id="1533229">-</span>&nbsp;<span class="num" id="1533231">8</span><span class="op" id="1533232">)</span><span class="op" id="1533233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533236">if</span>&nbsp;<span class="ident" id="1533239">top</span>&nbsp;<span class="op" id="1533243">&lt;</span>&nbsp;<span class="ident" id="1533245">minTopHash</span>&nbsp;<span class="op" id="1533256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533260">top</span>&nbsp;<span class="op" id="1533264">+=</span>&nbsp;<span class="ident" id="1533267">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533282">for</span>&nbsp;<span class="op" id="1533286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533290">for</span>&nbsp;<span class="ident" id="1533294">i</span>&nbsp;<span class="op" id="1533296">:=</span>&nbsp;<span class="builtintype" id="1533299">uintptr</span><span class="op" id="1533306">(</span><span class="num" id="1533307">0</span><span class="op" id="1533308">)</span><span class="op" id="1533309">;</span>&nbsp;<span class="ident" id="1533311">i</span>&nbsp;<span class="op" id="1533313">&lt;</span>&nbsp;<span class="ident" id="1533315">bucketCnt</span><span class="op" id="1533324">;</span>&nbsp;<span class="ident" id="1533326">i</span><span class="op" id="1533327">++</span>&nbsp;<span class="op" id="1533330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533335">if</span>&nbsp;<span class="ident" id="1533338">b</span><span class="op" id="1533339">.</span><span class="ident" id="1533340">tophash</span><span class="op" id="1533347">[</span><span class="ident" id="1533348">i</span><span class="op" id="1533349">]</span>&nbsp;<span class="op" id="1533351">!=</span>&nbsp;<span class="ident" id="1533354">top</span>&nbsp;<span class="op" id="1533358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533364">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533381">k</span>&nbsp;<span class="op" id="1533383">:=</span>&nbsp;<span class="ident" id="1533386">add</span><span class="op" id="1533389">(</span><span class="ident" id="1533390">unsafe</span><span class="op" id="1533396">.</span><span class="ident" id="1533397">Pointer</span><span class="op" id="1533404">(</span><span class="ident" id="1533405">b</span><span class="op" id="1533406">)</span><span class="op" id="1533407">,</span>&nbsp;<span class="ident" id="1533409">dataOffset</span><span class="op" id="1533419">+</span><span class="ident" id="1533420">i</span><span class="op" id="1533421">*</span><span class="builtintype" id="1533422">uintptr</span><span class="op" id="1533429">(</span><span class="ident" id="1533430">t</span><span class="op" id="1533431">.</span><span class="ident" id="1533432">keysize</span><span class="op" id="1533439">)</span><span class="op" id="1533440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533445">if</span>&nbsp;<span class="ident" id="1533448">t</span><span class="op" id="1533449">.</span><span class="ident" id="1533450">indirectkey</span>&nbsp;<span class="op" id="1533462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533468">k</span>&nbsp;<span class="op" id="1533470">=</span>&nbsp;<span class="op" id="1533472">*</span><span class="op" id="1533473">(</span><span class="op" id="1533474">(</span><span class="op" id="1533475">*</span><span class="ident" id="1533476">unsafe</span><span class="op" id="1533482">.</span><span class="ident" id="1533483">Pointer</span><span class="op" id="1533490">)</span><span class="op" id="1533491">(</span><span class="ident" id="1533492">k</span><span class="op" id="1533493">)</span><span class="op" id="1533494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533499">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533504">if</span>&nbsp;<span class="ident" id="1533507">alg</span><span class="op" id="1533510">.</span><span class="ident" id="1533511">equal</span><span class="op" id="1533516">(</span><span class="ident" id="1533517">key</span><span class="op" id="1533520">,</span>&nbsp;<span class="ident" id="1533522">k</span><span class="op" id="1533523">,</span>&nbsp;<span class="builtintype" id="1533525">uintptr</span><span class="op" id="1533532">(</span><span class="ident" id="1533533">t</span><span class="op" id="1533534">.</span><span class="ident" id="1533535">key</span><span class="op" id="1533538">.</span><span class="ident" id="1533539">size</span><span class="op" id="1533543">)</span><span class="op" id="1533544">)</span>&nbsp;<span class="op" id="1533546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533552">v</span>&nbsp;<span class="op" id="1533554">:=</span>&nbsp;<span class="ident" id="1533557">add</span><span class="op" id="1533560">(</span><span class="ident" id="1533561">unsafe</span><span class="op" id="1533567">.</span><span class="ident" id="1533568">Pointer</span><span class="op" id="1533575">(</span><span class="ident" id="1533576">b</span><span class="op" id="1533577">)</span><span class="op" id="1533578">,</span>&nbsp;<span class="ident" id="1533580">dataOffset</span><span class="op" id="1533590">+</span><span class="ident" id="1533591">bucketCnt</span><span class="op" id="1533600">*</span><span class="builtintype" id="1533601">uintptr</span><span class="op" id="1533608">(</span><span class="ident" id="1533609">t</span><span class="op" id="1533610">.</span><span class="ident" id="1533611">keysize</span><span class="op" id="1533618">)</span><span class="op" id="1533619">+</span><span class="ident" id="1533620">i</span><span class="op" id="1533621">*</span><span class="builtintype" id="1533622">uintptr</span><span class="op" id="1533629">(</span><span class="ident" id="1533630">t</span><span class="op" id="1533631">.</span><span class="ident" id="1533632">valuesize</span><span class="op" id="1533641">)</span><span class="op" id="1533642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533648">if</span>&nbsp;<span class="ident" id="1533651">t</span><span class="op" id="1533652">.</span><span class="ident" id="1533653">indirectvalue</span>&nbsp;<span class="op" id="1533667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533674">v</span>&nbsp;<span class="op" id="1533676">=</span>&nbsp;<span class="op" id="1533678">*</span><span class="op" id="1533679">(</span><span class="op" id="1533680">(</span><span class="op" id="1533681">*</span><span class="ident" id="1533682">unsafe</span><span class="op" id="1533688">.</span><span class="ident" id="1533689">Pointer</span><span class="op" id="1533696">)</span><span class="op" id="1533697">(</span><span class="ident" id="1533698">v</span><span class="op" id="1533699">)</span><span class="op" id="1533700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533706">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533712">return</span>&nbsp;<span class="ident" id="1533719">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533732">b</span>&nbsp;<span class="op" id="1533734">=</span>&nbsp;<span class="ident" id="1533736">b</span><span class="op" id="1533737">.</span><span class="ident" id="1533738">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533749">if</span>&nbsp;<span class="ident" id="1533752">b</span>&nbsp;<span class="op" id="1533754">==</span>&nbsp;<span class="ident" id="1533757">nil</span>&nbsp;<span class="op" id="1533761">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533766">return</span>&nbsp;<span class="ident" id="1533773">unsafe</span><span class="op" id="1533779">.</span><span class="ident" id="1533780">Pointer</span><span class="op" id="1533787">(</span><span class="ident" id="1533788">t</span><span class="op" id="1533789">.</span><span class="ident" id="1533790">elem</span><span class="op" id="1533794">.</span><span class="ident" id="1533795">zero</span><span class="op" id="1533799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533806">}</span><br>
<span class="lineno"></span><span class="op" id="1533808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1533811">func</span>&nbsp;<span class="ident" id="1533816">mapaccess2</span><span class="op" id="1533826">(</span><span class="ident" id="1533827">t</span>&nbsp;<span class="op" id="1533829">*</span><span class="ident" id="1533830">maptype</span><span class="op" id="1533837">,</span>&nbsp;<span class="ident" id="1533839">h</span>&nbsp;<span class="op" id="1533841">*</span><span class="ident" id="1533842">hmap</span><span class="op" id="1533846">,</span>&nbsp;<span class="ident" id="1533848">key</span>&nbsp;<span class="ident" id="1533852">unsafe</span><span class="op" id="1533858">.</span><span class="ident" id="1533859">Pointer</span><span class="op" id="1533866">)</span>&nbsp;<span class="op" id="1533868">(</span><span class="ident" id="1533869">unsafe</span><span class="op" id="1533875">.</span><span class="ident" id="1533876">Pointer</span><span class="op" id="1533883">,</span>&nbsp;<span class="builtintype" id="1533885">bool</span><span class="op" id="1533889">)</span>&nbsp;<span class="op" id="1533891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533894">if</span>&nbsp;<span class="ident" id="1533897">raceenabled</span>&nbsp;<span class="op" id="1533909">&amp;&amp;</span>&nbsp;<span class="ident" id="1533912">h</span>&nbsp;<span class="op" id="1533914">!=</span>&nbsp;<span class="ident" id="1533917">nil</span>&nbsp;<span class="op" id="1533921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533925">callerpc</span>&nbsp;<span class="op" id="1533934">:=</span>&nbsp;<span class="ident" id="1533937">getcallerpc</span><span class="op" id="1533948">(</span><span class="ident" id="1533949">unsafe</span><span class="op" id="1533955">.</span><span class="ident" id="1533956">Pointer</span><span class="op" id="1533963">(</span><span class="op" id="1533964">&amp;</span><span class="ident" id="1533965">t</span><span class="op" id="1533966">)</span><span class="op" id="1533967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533971">pc</span>&nbsp;<span class="op" id="1533974">:=</span>&nbsp;<span class="ident" id="1533977">funcPC</span><span class="op" id="1533983">(</span><span class="ident" id="1533984">mapaccess2</span><span class="op" id="1533994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533998">racereadpc</span><span class="op" id="1534008">(</span><span class="ident" id="1534009">unsafe</span><span class="op" id="1534015">.</span><span class="ident" id="1534016">Pointer</span><span class="op" id="1534023">(</span><span class="ident" id="1534024">h</span><span class="op" id="1534025">)</span><span class="op" id="1534026">,</span>&nbsp;<span class="ident" id="1534028">callerpc</span><span class="op" id="1534036">,</span>&nbsp;<span class="ident" id="1534038">pc</span><span class="op" id="1534040">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534044">raceReadObjectPC</span><span class="op" id="1534060">(</span><span class="ident" id="1534061">t</span><span class="op" id="1534062">.</span><span class="ident" id="1534063">key</span><span class="op" id="1534066">,</span>&nbsp;<span class="ident" id="1534068">key</span><span class="op" id="1534071">,</span>&nbsp;<span class="ident" id="1534073">callerpc</span><span class="op" id="1534081">,</span>&nbsp;<span class="ident" id="1534083">pc</span><span class="op" id="1534085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534091">if</span>&nbsp;<span class="ident" id="1534094">h</span>&nbsp;<span class="op" id="1534096">==</span>&nbsp;<span class="ident" id="1534099">nil</span>&nbsp;<span class="op" id="1534103">||</span>&nbsp;<span class="ident" id="1534106">h</span><span class="op" id="1534107">.</span><span class="ident" id="1534108">count</span>&nbsp;<span class="op" id="1534114">==</span>&nbsp;<span class="num" id="1534117">0</span>&nbsp;<span class="op" id="1534119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534123">return</span>&nbsp;<span class="ident" id="1534130">unsafe</span><span class="op" id="1534136">.</span><span class="ident" id="1534137">Pointer</span><span class="op" id="1534144">(</span><span class="ident" id="1534145">t</span><span class="op" id="1534146">.</span><span class="ident" id="1534147">elem</span><span class="op" id="1534151">.</span><span class="ident" id="1534152">zero</span><span class="op" id="1534156">)</span><span class="op" id="1534157">,</span>&nbsp;<span class="builtintype" id="1534159">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534166">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534169">alg</span>&nbsp;<span class="op" id="1534173">:=</span>&nbsp;<span class="ident" id="1534176">goalg</span><span class="op" id="1534181">(</span><span class="ident" id="1534182">t</span><span class="op" id="1534183">.</span><span class="ident" id="1534184">key</span><span class="op" id="1534187">.</span><span class="ident" id="1534188">alg</span><span class="op" id="1534191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534194">hash</span>&nbsp;<span class="op" id="1534199">:=</span>&nbsp;<span class="ident" id="1534202">alg</span><span class="op" id="1534205">.</span><span class="ident" id="1534206">hash</span><span class="op" id="1534210">(</span><span class="ident" id="1534211">key</span><span class="op" id="1534214">,</span>&nbsp;<span class="builtintype" id="1534216">uintptr</span><span class="op" id="1534223">(</span><span class="ident" id="1534224">t</span><span class="op" id="1534225">.</span><span class="ident" id="1534226">key</span><span class="op" id="1534229">.</span><span class="ident" id="1534230">size</span><span class="op" id="1534234">)</span><span class="op" id="1534235">,</span>&nbsp;<span class="builtintype" id="1534237">uintptr</span><span class="op" id="1534244">(</span><span class="ident" id="1534245">h</span><span class="op" id="1534246">.</span><span class="ident" id="1534247">hash0</span><span class="op" id="1534252">)</span><span class="op" id="1534253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534256">m</span>&nbsp;<span class="op" id="1534258">:=</span>&nbsp;<span class="builtintype" id="1534261">uintptr</span><span class="op" id="1534268">(</span><span class="num" id="1534269">1</span><span class="op" id="1534270">)</span><span class="op" id="1534271">&lt;&lt;</span><span class="ident" id="1534273">h</span><span class="op" id="1534274">.</span><span class="ident" id="1534275">B</span>&nbsp;<span class="op" id="1534277">-</span>&nbsp;<span class="num" id="1534279">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534282">b</span>&nbsp;<span class="op" id="1534284">:=</span>&nbsp;<span class="op" id="1534287">(</span><span class="op" id="1534288">*</span><span class="ident" id="1534289">bmap</span><span class="op" id="1534293">)</span><span class="op" id="1534294">(</span><span class="ident" id="1534295">unsafe</span><span class="op" id="1534301">.</span><span class="ident" id="1534302">Pointer</span><span class="op" id="1534309">(</span><span class="builtintype" id="1534310">uintptr</span><span class="op" id="1534317">(</span><span class="ident" id="1534318">h</span><span class="op" id="1534319">.</span><span class="ident" id="1534320">buckets</span><span class="op" id="1534327">)</span>&nbsp;<span class="op" id="1534329">+</span>&nbsp;<span class="op" id="1534331">(</span><span class="ident" id="1534332">hash</span><span class="op" id="1534336">&amp;</span><span class="ident" id="1534337">m</span><span class="op" id="1534338">)</span><span class="op" id="1534339">*</span><span class="builtintype" id="1534340">uintptr</span><span class="op" id="1534347">(</span><span class="ident" id="1534348">t</span><span class="op" id="1534349">.</span><span class="ident" id="1534350">bucketsize</span><span class="op" id="1534360">)</span><span class="op" id="1534361">)</span><span class="op" id="1534362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534365">if</span>&nbsp;<span class="ident" id="1534368">c</span>&nbsp;<span class="op" id="1534370">:=</span>&nbsp;<span class="ident" id="1534373">h</span><span class="op" id="1534374">.</span><span class="ident" id="1534375">oldbuckets</span><span class="op" id="1534385">;</span>&nbsp;<span class="ident" id="1534387">c</span>&nbsp;<span class="op" id="1534389">!=</span>&nbsp;<span class="ident" id="1534392">nil</span>&nbsp;<span class="op" id="1534396">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534400">oldb</span>&nbsp;<span class="op" id="1534405">:=</span>&nbsp;<span class="op" id="1534408">(</span><span class="op" id="1534409">*</span><span class="ident" id="1534410">bmap</span><span class="op" id="1534414">)</span><span class="op" id="1534415">(</span><span class="ident" id="1534416">unsafe</span><span class="op" id="1534422">.</span><span class="ident" id="1534423">Pointer</span><span class="op" id="1534430">(</span><span class="builtintype" id="1534431">uintptr</span><span class="op" id="1534438">(</span><span class="ident" id="1534439">c</span><span class="op" id="1534440">)</span>&nbsp;<span class="op" id="1534442">+</span>&nbsp;<span class="op" id="1534444">(</span><span class="ident" id="1534445">hash</span><span class="op" id="1534449">&amp;</span><span class="op" id="1534450">(</span><span class="ident" id="1534451">m</span><span class="op" id="1534452">&gt;&gt;</span><span class="num" id="1534454">1</span><span class="op" id="1534455">)</span><span class="op" id="1534456">)</span><span class="op" id="1534457">*</span><span class="builtintype" id="1534458">uintptr</span><span class="op" id="1534465">(</span><span class="ident" id="1534466">t</span><span class="op" id="1534467">.</span><span class="ident" id="1534468">bucketsize</span><span class="op" id="1534478">)</span><span class="op" id="1534479">)</span><span class="op" id="1534480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534484">if</span>&nbsp;<span class="op" id="1534487">!</span><span class="ident" id="1534488">evacuated</span><span class="op" id="1534497">(</span><span class="ident" id="1534498">oldb</span><span class="op" id="1534502">)</span>&nbsp;<span class="op" id="1534504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534509">b</span>&nbsp;<span class="op" id="1534511">=</span>&nbsp;<span class="ident" id="1534513">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534523">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534526">top</span>&nbsp;<span class="op" id="1534530">:=</span>&nbsp;<span class="builtintype" id="1534533">uint8</span><span class="op" id="1534538">(</span><span class="ident" id="1534539">hash</span>&nbsp;<span class="op" id="1534544">&gt;&gt;</span>&nbsp;<span class="op" id="1534547">(</span><span class="ident" id="1534548">ptrSize</span><span class="op" id="1534555">*</span><span class="num" id="1534556">8</span>&nbsp;<span class="op" id="1534558">-</span>&nbsp;<span class="num" id="1534560">8</span><span class="op" id="1534561">)</span><span class="op" id="1534562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534565">if</span>&nbsp;<span class="ident" id="1534568">top</span>&nbsp;<span class="op" id="1534572">&lt;</span>&nbsp;<span class="ident" id="1534574">minTopHash</span>&nbsp;<span class="op" id="1534585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534589">top</span>&nbsp;<span class="op" id="1534593">+=</span>&nbsp;<span class="ident" id="1534596">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534611">for</span>&nbsp;<span class="op" id="1534615">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534619">for</span>&nbsp;<span class="ident" id="1534623">i</span>&nbsp;<span class="op" id="1534625">:=</span>&nbsp;<span class="builtintype" id="1534628">uintptr</span><span class="op" id="1534635">(</span><span class="num" id="1534636">0</span><span class="op" id="1534637">)</span><span class="op" id="1534638">;</span>&nbsp;<span class="ident" id="1534640">i</span>&nbsp;<span class="op" id="1534642">&lt;</span>&nbsp;<span class="ident" id="1534644">bucketCnt</span><span class="op" id="1534653">;</span>&nbsp;<span class="ident" id="1534655">i</span><span class="op" id="1534656">++</span>&nbsp;<span class="op" id="1534659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534664">if</span>&nbsp;<span class="ident" id="1534667">b</span><span class="op" id="1534668">.</span><span class="ident" id="1534669">tophash</span><span class="op" id="1534676">[</span><span class="ident" id="1534677">i</span><span class="op" id="1534678">]</span>&nbsp;<span class="op" id="1534680">!=</span>&nbsp;<span class="ident" id="1534683">top</span>&nbsp;<span class="op" id="1534687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534693">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534710">k</span>&nbsp;<span class="op" id="1534712">:=</span>&nbsp;<span class="ident" id="1534715">add</span><span class="op" id="1534718">(</span><span class="ident" id="1534719">unsafe</span><span class="op" id="1534725">.</span><span class="ident" id="1534726">Pointer</span><span class="op" id="1534733">(</span><span class="ident" id="1534734">b</span><span class="op" id="1534735">)</span><span class="op" id="1534736">,</span>&nbsp;<span class="ident" id="1534738">dataOffset</span><span class="op" id="1534748">+</span><span class="ident" id="1534749">i</span><span class="op" id="1534750">*</span><span class="builtintype" id="1534751">uintptr</span><span class="op" id="1534758">(</span><span class="ident" id="1534759">t</span><span class="op" id="1534760">.</span><span class="ident" id="1534761">keysize</span><span class="op" id="1534768">)</span><span class="op" id="1534769">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534774">if</span>&nbsp;<span class="ident" id="1534777">t</span><span class="op" id="1534778">.</span><span class="ident" id="1534779">indirectkey</span>&nbsp;<span class="op" id="1534791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534797">k</span>&nbsp;<span class="op" id="1534799">=</span>&nbsp;<span class="op" id="1534801">*</span><span class="op" id="1534802">(</span><span class="op" id="1534803">(</span><span class="op" id="1534804">*</span><span class="ident" id="1534805">unsafe</span><span class="op" id="1534811">.</span><span class="ident" id="1534812">Pointer</span><span class="op" id="1534819">)</span><span class="op" id="1534820">(</span><span class="ident" id="1534821">k</span><span class="op" id="1534822">)</span><span class="op" id="1534823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534833">if</span>&nbsp;<span class="ident" id="1534836">alg</span><span class="op" id="1534839">.</span><span class="ident" id="1534840">equal</span><span class="op" id="1534845">(</span><span class="ident" id="1534846">key</span><span class="op" id="1534849">,</span>&nbsp;<span class="ident" id="1534851">k</span><span class="op" id="1534852">,</span>&nbsp;<span class="builtintype" id="1534854">uintptr</span><span class="op" id="1534861">(</span><span class="ident" id="1534862">t</span><span class="op" id="1534863">.</span><span class="ident" id="1534864">key</span><span class="op" id="1534867">.</span><span class="ident" id="1534868">size</span><span class="op" id="1534872">)</span><span class="op" id="1534873">)</span>&nbsp;<span class="op" id="1534875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534881">v</span>&nbsp;<span class="op" id="1534883">:=</span>&nbsp;<span class="ident" id="1534886">add</span><span class="op" id="1534889">(</span><span class="ident" id="1534890">unsafe</span><span class="op" id="1534896">.</span><span class="ident" id="1534897">Pointer</span><span class="op" id="1534904">(</span><span class="ident" id="1534905">b</span><span class="op" id="1534906">)</span><span class="op" id="1534907">,</span>&nbsp;<span class="ident" id="1534909">dataOffset</span><span class="op" id="1534919">+</span><span class="ident" id="1534920">bucketCnt</span><span class="op" id="1534929">*</span><span class="builtintype" id="1534930">uintptr</span><span class="op" id="1534937">(</span><span class="ident" id="1534938">t</span><span class="op" id="1534939">.</span><span class="ident" id="1534940">keysize</span><span class="op" id="1534947">)</span><span class="op" id="1534948">+</span><span class="ident" id="1534949">i</span><span class="op" id="1534950">*</span><span class="builtintype" id="1534951">uintptr</span><span class="op" id="1534958">(</span><span class="ident" id="1534959">t</span><span class="op" id="1534960">.</span><span class="ident" id="1534961">valuesize</span><span class="op" id="1534970">)</span><span class="op" id="1534971">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534977">if</span>&nbsp;<span class="ident" id="1534980">t</span><span class="op" id="1534981">.</span><span class="ident" id="1534982">indirectvalue</span>&nbsp;<span class="op" id="1534996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535003">v</span>&nbsp;<span class="op" id="1535005">=</span>&nbsp;<span class="op" id="1535007">*</span><span class="op" id="1535008">(</span><span class="op" id="1535009">(</span><span class="op" id="1535010">*</span><span class="ident" id="1535011">unsafe</span><span class="op" id="1535017">.</span><span class="ident" id="1535018">Pointer</span><span class="op" id="1535025">)</span><span class="op" id="1535026">(</span><span class="ident" id="1535027">v</span><span class="op" id="1535028">)</span><span class="op" id="1535029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535041">return</span>&nbsp;<span class="ident" id="1535048">v</span><span class="op" id="1535049">,</span>&nbsp;<span class="builtintype" id="1535051">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535059">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535067">b</span>&nbsp;<span class="op" id="1535069">=</span>&nbsp;<span class="ident" id="1535071">b</span><span class="op" id="1535072">.</span><span class="ident" id="1535073">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535084">if</span>&nbsp;<span class="ident" id="1535087">b</span>&nbsp;<span class="op" id="1535089">==</span>&nbsp;<span class="ident" id="1535092">nil</span>&nbsp;<span class="op" id="1535096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535101">return</span>&nbsp;<span class="ident" id="1535108">unsafe</span><span class="op" id="1535114">.</span><span class="ident" id="1535115">Pointer</span><span class="op" id="1535122">(</span><span class="ident" id="1535123">t</span><span class="op" id="1535124">.</span><span class="ident" id="1535125">elem</span><span class="op" id="1535129">.</span><span class="ident" id="1535130">zero</span><span class="op" id="1535134">)</span><span class="op" id="1535135">,</span>&nbsp;<span class="builtintype" id="1535137">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535145">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535148">}</span><br>
<span class="lineno"></span><span class="op" id="1535150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535153">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1535206">func</span>&nbsp;<span class="ident" id="1535211">mapaccessK</span><span class="op" id="1535221">(</span><span class="ident" id="1535222">t</span>&nbsp;<span class="op" id="1535224">*</span><span class="ident" id="1535225">maptype</span><span class="op" id="1535232">,</span>&nbsp;<span class="ident" id="1535234">h</span>&nbsp;<span class="op" id="1535236">*</span><span class="ident" id="1535237">hmap</span><span class="op" id="1535241">,</span>&nbsp;<span class="ident" id="1535243">key</span>&nbsp;<span class="ident" id="1535247">unsafe</span><span class="op" id="1535253">.</span><span class="ident" id="1535254">Pointer</span><span class="op" id="1535261">)</span>&nbsp;<span class="op" id="1535263">(</span><span class="ident" id="1535264">unsafe</span><span class="op" id="1535270">.</span><span class="ident" id="1535271">Pointer</span><span class="op" id="1535278">,</span>&nbsp;<span class="ident" id="1535280">unsafe</span><span class="op" id="1535286">.</span><span class="ident" id="1535287">Pointer</span><span class="op" id="1535294">)</span>&nbsp;<span class="op" id="1535296">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535299">if</span>&nbsp;<span class="ident" id="1535302">h</span>&nbsp;<span class="op" id="1535304">==</span>&nbsp;<span class="ident" id="1535307">nil</span>&nbsp;<span class="op" id="1535311">||</span>&nbsp;<span class="ident" id="1535314">h</span><span class="op" id="1535315">.</span><span class="ident" id="1535316">count</span>&nbsp;<span class="op" id="1535322">==</span>&nbsp;<span class="num" id="1535325">0</span>&nbsp;<span class="op" id="1535327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535331">return</span>&nbsp;<span class="ident" id="1535338">nil</span><span class="op" id="1535341">,</span>&nbsp;<span class="ident" id="1535343">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535351">alg</span>&nbsp;<span class="op" id="1535355">:=</span>&nbsp;<span class="ident" id="1535358">goalg</span><span class="op" id="1535363">(</span><span class="ident" id="1535364">t</span><span class="op" id="1535365">.</span><span class="ident" id="1535366">key</span><span class="op" id="1535369">.</span><span class="ident" id="1535370">alg</span><span class="op" id="1535373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535376">hash</span>&nbsp;<span class="op" id="1535381">:=</span>&nbsp;<span class="ident" id="1535384">alg</span><span class="op" id="1535387">.</span><span class="ident" id="1535388">hash</span><span class="op" id="1535392">(</span><span class="ident" id="1535393">key</span><span class="op" id="1535396">,</span>&nbsp;<span class="builtintype" id="1535398">uintptr</span><span class="op" id="1535405">(</span><span class="ident" id="1535406">t</span><span class="op" id="1535407">.</span><span class="ident" id="1535408">key</span><span class="op" id="1535411">.</span><span class="ident" id="1535412">size</span><span class="op" id="1535416">)</span><span class="op" id="1535417">,</span>&nbsp;<span class="builtintype" id="1535419">uintptr</span><span class="op" id="1535426">(</span><span class="ident" id="1535427">h</span><span class="op" id="1535428">.</span><span class="ident" id="1535429">hash0</span><span class="op" id="1535434">)</span><span class="op" id="1535435">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535438">m</span>&nbsp;<span class="op" id="1535440">:=</span>&nbsp;<span class="builtintype" id="1535443">uintptr</span><span class="op" id="1535450">(</span><span class="num" id="1535451">1</span><span class="op" id="1535452">)</span><span class="op" id="1535453">&lt;&lt;</span><span class="ident" id="1535455">h</span><span class="op" id="1535456">.</span><span class="ident" id="1535457">B</span>&nbsp;<span class="op" id="1535459">-</span>&nbsp;<span class="num" id="1535461">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535464">b</span>&nbsp;<span class="op" id="1535466">:=</span>&nbsp;<span class="op" id="1535469">(</span><span class="op" id="1535470">*</span><span class="ident" id="1535471">bmap</span><span class="op" id="1535475">)</span><span class="op" id="1535476">(</span><span class="ident" id="1535477">unsafe</span><span class="op" id="1535483">.</span><span class="ident" id="1535484">Pointer</span><span class="op" id="1535491">(</span><span class="builtintype" id="1535492">uintptr</span><span class="op" id="1535499">(</span><span class="ident" id="1535500">h</span><span class="op" id="1535501">.</span><span class="ident" id="1535502">buckets</span><span class="op" id="1535509">)</span>&nbsp;<span class="op" id="1535511">+</span>&nbsp;<span class="op" id="1535513">(</span><span class="ident" id="1535514">hash</span><span class="op" id="1535518">&amp;</span><span class="ident" id="1535519">m</span><span class="op" id="1535520">)</span><span class="op" id="1535521">*</span><span class="builtintype" id="1535522">uintptr</span><span class="op" id="1535529">(</span><span class="ident" id="1535530">t</span><span class="op" id="1535531">.</span><span class="ident" id="1535532">bucketsize</span><span class="op" id="1535542">)</span><span class="op" id="1535543">)</span><span class="op" id="1535544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535547">if</span>&nbsp;<span class="ident" id="1535550">c</span>&nbsp;<span class="op" id="1535552">:=</span>&nbsp;<span class="ident" id="1535555">h</span><span class="op" id="1535556">.</span><span class="ident" id="1535557">oldbuckets</span><span class="op" id="1535567">;</span>&nbsp;<span class="ident" id="1535569">c</span>&nbsp;<span class="op" id="1535571">!=</span>&nbsp;<span class="ident" id="1535574">nil</span>&nbsp;<span class="op" id="1535578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535582">oldb</span>&nbsp;<span class="op" id="1535587">:=</span>&nbsp;<span class="op" id="1535590">(</span><span class="op" id="1535591">*</span><span class="ident" id="1535592">bmap</span><span class="op" id="1535596">)</span><span class="op" id="1535597">(</span><span class="ident" id="1535598">unsafe</span><span class="op" id="1535604">.</span><span class="ident" id="1535605">Pointer</span><span class="op" id="1535612">(</span><span class="builtintype" id="1535613">uintptr</span><span class="op" id="1535620">(</span><span class="ident" id="1535621">c</span><span class="op" id="1535622">)</span>&nbsp;<span class="op" id="1535624">+</span>&nbsp;<span class="op" id="1535626">(</span><span class="ident" id="1535627">hash</span><span class="op" id="1535631">&amp;</span><span class="op" id="1535632">(</span><span class="ident" id="1535633">m</span><span class="op" id="1535634">&gt;&gt;</span><span class="num" id="1535636">1</span><span class="op" id="1535637">)</span><span class="op" id="1535638">)</span><span class="op" id="1535639">*</span><span class="builtintype" id="1535640">uintptr</span><span class="op" id="1535647">(</span><span class="ident" id="1535648">t</span><span class="op" id="1535649">.</span><span class="ident" id="1535650">bucketsize</span><span class="op" id="1535660">)</span><span class="op" id="1535661">)</span><span class="op" id="1535662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535666">if</span>&nbsp;<span class="op" id="1535669">!</span><span class="ident" id="1535670">evacuated</span><span class="op" id="1535679">(</span><span class="ident" id="1535680">oldb</span><span class="op" id="1535684">)</span>&nbsp;<span class="op" id="1535686">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535691">b</span>&nbsp;<span class="op" id="1535693">=</span>&nbsp;<span class="ident" id="1535695">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535708">top</span>&nbsp;<span class="op" id="1535712">:=</span>&nbsp;<span class="builtintype" id="1535715">uint8</span><span class="op" id="1535720">(</span><span class="ident" id="1535721">hash</span>&nbsp;<span class="op" id="1535726">&gt;&gt;</span>&nbsp;<span class="op" id="1535729">(</span><span class="ident" id="1535730">ptrSize</span><span class="op" id="1535737">*</span><span class="num" id="1535738">8</span>&nbsp;<span class="op" id="1535740">-</span>&nbsp;<span class="num" id="1535742">8</span><span class="op" id="1535743">)</span><span class="op" id="1535744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535747">if</span>&nbsp;<span class="ident" id="1535750">top</span>&nbsp;<span class="op" id="1535754">&lt;</span>&nbsp;<span class="ident" id="1535756">minTopHash</span>&nbsp;<span class="op" id="1535767">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535771">top</span>&nbsp;<span class="op" id="1535775">+=</span>&nbsp;<span class="ident" id="1535778">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535793">for</span>&nbsp;<span class="op" id="1535797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535801">for</span>&nbsp;<span class="ident" id="1535805">i</span>&nbsp;<span class="op" id="1535807">:=</span>&nbsp;<span class="builtintype" id="1535810">uintptr</span><span class="op" id="1535817">(</span><span class="num" id="1535818">0</span><span class="op" id="1535819">)</span><span class="op" id="1535820">;</span>&nbsp;<span class="ident" id="1535822">i</span>&nbsp;<span class="op" id="1535824">&lt;</span>&nbsp;<span class="ident" id="1535826">bucketCnt</span><span class="op" id="1535835">;</span>&nbsp;<span class="ident" id="1535837">i</span><span class="op" id="1535838">++</span>&nbsp;<span class="op" id="1535841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535846">if</span>&nbsp;<span class="ident" id="1535849">b</span><span class="op" id="1535850">.</span><span class="ident" id="1535851">tophash</span><span class="op" id="1535858">[</span><span class="ident" id="1535859">i</span><span class="op" id="1535860">]</span>&nbsp;<span class="op" id="1535862">!=</span>&nbsp;<span class="ident" id="1535865">top</span>&nbsp;<span class="op" id="1535869">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535875">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535892">k</span>&nbsp;<span class="op" id="1535894">:=</span>&nbsp;<span class="ident" id="1535897">add</span><span class="op" id="1535900">(</span><span class="ident" id="1535901">unsafe</span><span class="op" id="1535907">.</span><span class="ident" id="1535908">Pointer</span><span class="op" id="1535915">(</span><span class="ident" id="1535916">b</span><span class="op" id="1535917">)</span><span class="op" id="1535918">,</span>&nbsp;<span class="ident" id="1535920">dataOffset</span><span class="op" id="1535930">+</span><span class="ident" id="1535931">i</span><span class="op" id="1535932">*</span><span class="builtintype" id="1535933">uintptr</span><span class="op" id="1535940">(</span><span class="ident" id="1535941">t</span><span class="op" id="1535942">.</span><span class="ident" id="1535943">keysize</span><span class="op" id="1535950">)</span><span class="op" id="1535951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535956">if</span>&nbsp;<span class="ident" id="1535959">t</span><span class="op" id="1535960">.</span><span class="ident" id="1535961">indirectkey</span>&nbsp;<span class="op" id="1535973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1535979">k</span>&nbsp;<span class="op" id="1535981">=</span>&nbsp;<span class="op" id="1535983">*</span><span class="op" id="1535984">(</span><span class="op" id="1535985">(</span><span class="op" id="1535986">*</span><span class="ident" id="1535987">unsafe</span><span class="op" id="1535993">.</span><span class="ident" id="1535994">Pointer</span><span class="op" id="1536001">)</span><span class="op" id="1536002">(</span><span class="ident" id="1536003">k</span><span class="op" id="1536004">)</span><span class="op" id="1536005">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536015">if</span>&nbsp;<span class="ident" id="1536018">alg</span><span class="op" id="1536021">.</span><span class="ident" id="1536022">equal</span><span class="op" id="1536027">(</span><span class="ident" id="1536028">key</span><span class="op" id="1536031">,</span>&nbsp;<span class="ident" id="1536033">k</span><span class="op" id="1536034">,</span>&nbsp;<span class="builtintype" id="1536036">uintptr</span><span class="op" id="1536043">(</span><span class="ident" id="1536044">t</span><span class="op" id="1536045">.</span><span class="ident" id="1536046">key</span><span class="op" id="1536049">.</span><span class="ident" id="1536050">size</span><span class="op" id="1536054">)</span><span class="op" id="1536055">)</span>&nbsp;<span class="op" id="1536057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536063">v</span>&nbsp;<span class="op" id="1536065">:=</span>&nbsp;<span class="ident" id="1536068">add</span><span class="op" id="1536071">(</span><span class="ident" id="1536072">unsafe</span><span class="op" id="1536078">.</span><span class="ident" id="1536079">Pointer</span><span class="op" id="1536086">(</span><span class="ident" id="1536087">b</span><span class="op" id="1536088">)</span><span class="op" id="1536089">,</span>&nbsp;<span class="ident" id="1536091">dataOffset</span><span class="op" id="1536101">+</span><span class="ident" id="1536102">bucketCnt</span><span class="op" id="1536111">*</span><span class="builtintype" id="1536112">uintptr</span><span class="op" id="1536119">(</span><span class="ident" id="1536120">t</span><span class="op" id="1536121">.</span><span class="ident" id="1536122">keysize</span><span class="op" id="1536129">)</span><span class="op" id="1536130">+</span><span class="ident" id="1536131">i</span><span class="op" id="1536132">*</span><span class="builtintype" id="1536133">uintptr</span><span class="op" id="1536140">(</span><span class="ident" id="1536141">t</span><span class="op" id="1536142">.</span><span class="ident" id="1536143">valuesize</span><span class="op" id="1536152">)</span><span class="op" id="1536153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536159">if</span>&nbsp;<span class="ident" id="1536162">t</span><span class="op" id="1536163">.</span><span class="ident" id="1536164">indirectvalue</span>&nbsp;<span class="op" id="1536178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536185">v</span>&nbsp;<span class="op" id="1536187">=</span>&nbsp;<span class="op" id="1536189">*</span><span class="op" id="1536190">(</span><span class="op" id="1536191">(</span><span class="op" id="1536192">*</span><span class="ident" id="1536193">unsafe</span><span class="op" id="1536199">.</span><span class="ident" id="1536200">Pointer</span><span class="op" id="1536207">)</span><span class="op" id="1536208">(</span><span class="ident" id="1536209">v</span><span class="op" id="1536210">)</span><span class="op" id="1536211">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536223">return</span>&nbsp;<span class="ident" id="1536230">k</span><span class="op" id="1536231">,</span>&nbsp;<span class="ident" id="1536233">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536246">b</span>&nbsp;<span class="op" id="1536248">=</span>&nbsp;<span class="ident" id="1536250">b</span><span class="op" id="1536251">.</span><span class="ident" id="1536252">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536263">if</span>&nbsp;<span class="ident" id="1536266">b</span>&nbsp;<span class="op" id="1536268">==</span>&nbsp;<span class="ident" id="1536271">nil</span>&nbsp;<span class="op" id="1536275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536280">return</span>&nbsp;<span class="ident" id="1536287">nil</span><span class="op" id="1536290">,</span>&nbsp;<span class="ident" id="1536292">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536301">}</span><br>
<span class="lineno"></span><span class="op" id="1536303">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1536306">func</span>&nbsp;<span class="ident" id="1536311">mapassign1</span><span class="op" id="1536321">(</span><span class="ident" id="1536322">t</span>&nbsp;<span class="op" id="1536324">*</span><span class="ident" id="1536325">maptype</span><span class="op" id="1536332">,</span>&nbsp;<span class="ident" id="1536334">h</span>&nbsp;<span class="op" id="1536336">*</span><span class="ident" id="1536337">hmap</span><span class="op" id="1536341">,</span>&nbsp;<span class="ident" id="1536343">key</span>&nbsp;<span class="ident" id="1536347">unsafe</span><span class="op" id="1536353">.</span><span class="ident" id="1536354">Pointer</span><span class="op" id="1536361">,</span>&nbsp;<span class="ident" id="1536363">val</span>&nbsp;<span class="ident" id="1536367">unsafe</span><span class="op" id="1536373">.</span><span class="ident" id="1536374">Pointer</span><span class="op" id="1536381">)</span>&nbsp;<span class="op" id="1536383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536386">if</span>&nbsp;<span class="ident" id="1536389">h</span>&nbsp;<span class="op" id="1536391">==</span>&nbsp;<span class="ident" id="1536394">nil</span>&nbsp;<span class="op" id="1536398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1536402">panic</span><span class="op" id="1536407">(</span><span class="string" id="1536408">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1536440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536443">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536446">if</span>&nbsp;<span class="ident" id="1536449">raceenabled</span>&nbsp;<span class="op" id="1536461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536465">callerpc</span>&nbsp;<span class="op" id="1536474">:=</span>&nbsp;<span class="ident" id="1536477">getcallerpc</span><span class="op" id="1536488">(</span><span class="ident" id="1536489">unsafe</span><span class="op" id="1536495">.</span><span class="ident" id="1536496">Pointer</span><span class="op" id="1536503">(</span><span class="op" id="1536504">&amp;</span><span class="ident" id="1536505">t</span><span class="op" id="1536506">)</span><span class="op" id="1536507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536511">pc</span>&nbsp;<span class="op" id="1536514">:=</span>&nbsp;<span class="ident" id="1536517">funcPC</span><span class="op" id="1536523">(</span><span class="ident" id="1536524">mapassign1</span><span class="op" id="1536534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536538">racewritepc</span><span class="op" id="1536549">(</span><span class="ident" id="1536550">unsafe</span><span class="op" id="1536556">.</span><span class="ident" id="1536557">Pointer</span><span class="op" id="1536564">(</span><span class="ident" id="1536565">h</span><span class="op" id="1536566">)</span><span class="op" id="1536567">,</span>&nbsp;<span class="ident" id="1536569">callerpc</span><span class="op" id="1536577">,</span>&nbsp;<span class="ident" id="1536579">pc</span><span class="op" id="1536581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536585">raceReadObjectPC</span><span class="op" id="1536601">(</span><span class="ident" id="1536602">t</span><span class="op" id="1536603">.</span><span class="ident" id="1536604">key</span><span class="op" id="1536607">,</span>&nbsp;<span class="ident" id="1536609">key</span><span class="op" id="1536612">,</span>&nbsp;<span class="ident" id="1536614">callerpc</span><span class="op" id="1536622">,</span>&nbsp;<span class="ident" id="1536624">pc</span><span class="op" id="1536626">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536630">raceReadObjectPC</span><span class="op" id="1536646">(</span><span class="ident" id="1536647">t</span><span class="op" id="1536648">.</span><span class="ident" id="1536649">elem</span><span class="op" id="1536653">,</span>&nbsp;<span class="ident" id="1536655">val</span><span class="op" id="1536658">,</span>&nbsp;<span class="ident" id="1536660">callerpc</span><span class="op" id="1536668">,</span>&nbsp;<span class="ident" id="1536670">pc</span><span class="op" id="1536672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536679">alg</span>&nbsp;<span class="op" id="1536683">:=</span>&nbsp;<span class="ident" id="1536686">goalg</span><span class="op" id="1536691">(</span><span class="ident" id="1536692">t</span><span class="op" id="1536693">.</span><span class="ident" id="1536694">key</span><span class="op" id="1536697">.</span><span class="ident" id="1536698">alg</span><span class="op" id="1536701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536704">hash</span>&nbsp;<span class="op" id="1536709">:=</span>&nbsp;<span class="ident" id="1536712">alg</span><span class="op" id="1536715">.</span><span class="ident" id="1536716">hash</span><span class="op" id="1536720">(</span><span class="ident" id="1536721">key</span><span class="op" id="1536724">,</span>&nbsp;<span class="builtintype" id="1536726">uintptr</span><span class="op" id="1536733">(</span><span class="ident" id="1536734">t</span><span class="op" id="1536735">.</span><span class="ident" id="1536736">key</span><span class="op" id="1536739">.</span><span class="ident" id="1536740">size</span><span class="op" id="1536744">)</span><span class="op" id="1536745">,</span>&nbsp;<span class="builtintype" id="1536747">uintptr</span><span class="op" id="1536754">(</span><span class="ident" id="1536755">h</span><span class="op" id="1536756">.</span><span class="ident" id="1536757">hash0</span><span class="op" id="1536762">)</span><span class="op" id="1536763">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536767">if</span>&nbsp;<span class="ident" id="1536770">h</span><span class="op" id="1536771">.</span><span class="ident" id="1536772">buckets</span>&nbsp;<span class="op" id="1536780">==</span>&nbsp;<span class="ident" id="1536783">nil</span>&nbsp;<span class="op" id="1536787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536791">if</span>&nbsp;<span class="ident" id="1536794">checkgc</span>&nbsp;<span class="op" id="1536802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536807">memstats</span><span class="op" id="1536815">.</span><span class="ident" id="1536816">next_gc</span>&nbsp;<span class="op" id="1536824">=</span>&nbsp;<span class="ident" id="1536826">memstats</span><span class="op" id="1536834">.</span><span class="ident" id="1536835">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536848">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536852">h</span><span class="op" id="1536853">.</span><span class="ident" id="1536854">buckets</span>&nbsp;<span class="op" id="1536862">=</span>&nbsp;<span class="ident" id="1536864">newarray</span><span class="op" id="1536872">(</span><span class="ident" id="1536873">t</span><span class="op" id="1536874">.</span><span class="ident" id="1536875">bucket</span><span class="op" id="1536881">,</span>&nbsp;<span class="num" id="1536883">1</span><span class="op" id="1536884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1536890">again</span><span class="op" id="1536895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536898">bucket</span>&nbsp;<span class="op" id="1536905">:=</span>&nbsp;<span class="ident" id="1536908">hash</span>&nbsp;<span class="op" id="1536913">&amp;</span>&nbsp;<span class="op" id="1536915">(</span><span class="builtintype" id="1536916">uintptr</span><span class="op" id="1536923">(</span><span class="num" id="1536924">1</span><span class="op" id="1536925">)</span><span class="op" id="1536926">&lt;&lt;</span><span class="ident" id="1536928">h</span><span class="op" id="1536929">.</span><span class="ident" id="1536930">B</span>&nbsp;<span class="op" id="1536932">-</span>&nbsp;<span class="num" id="1536934">1</span><span class="op" id="1536935">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536938">if</span>&nbsp;<span class="ident" id="1536941">h</span><span class="op" id="1536942">.</span><span class="ident" id="1536943">oldbuckets</span>&nbsp;<span class="op" id="1536954">!=</span>&nbsp;<span class="ident" id="1536957">nil</span>&nbsp;<span class="op" id="1536961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536965">growWork</span><span class="op" id="1536973">(</span><span class="ident" id="1536974">t</span><span class="op" id="1536975">,</span>&nbsp;<span class="ident" id="1536977">h</span><span class="op" id="1536978">,</span>&nbsp;<span class="ident" id="1536980">bucket</span><span class="op" id="1536986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536992">b</span>&nbsp;<span class="op" id="1536994">:=</span>&nbsp;<span class="op" id="1536997">(</span><span class="op" id="1536998">*</span><span class="ident" id="1536999">bmap</span><span class="op" id="1537003">)</span><span class="op" id="1537004">(</span><span class="ident" id="1537005">unsafe</span><span class="op" id="1537011">.</span><span class="ident" id="1537012">Pointer</span><span class="op" id="1537019">(</span><span class="builtintype" id="1537020">uintptr</span><span class="op" id="1537027">(</span><span class="ident" id="1537028">h</span><span class="op" id="1537029">.</span><span class="ident" id="1537030">buckets</span><span class="op" id="1537037">)</span>&nbsp;<span class="op" id="1537039">+</span>&nbsp;<span class="ident" id="1537041">bucket</span><span class="op" id="1537047">*</span><span class="builtintype" id="1537048">uintptr</span><span class="op" id="1537055">(</span><span class="ident" id="1537056">t</span><span class="op" id="1537057">.</span><span class="ident" id="1537058">bucketsize</span><span class="op" id="1537068">)</span><span class="op" id="1537069">)</span><span class="op" id="1537070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537073">top</span>&nbsp;<span class="op" id="1537077">:=</span>&nbsp;<span class="builtintype" id="1537080">uint8</span><span class="op" id="1537085">(</span><span class="ident" id="1537086">hash</span>&nbsp;<span class="op" id="1537091">&gt;&gt;</span>&nbsp;<span class="op" id="1537094">(</span><span class="ident" id="1537095">ptrSize</span><span class="op" id="1537102">*</span><span class="num" id="1537103">8</span>&nbsp;<span class="op" id="1537105">-</span>&nbsp;<span class="num" id="1537107">8</span><span class="op" id="1537108">)</span><span class="op" id="1537109">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537112">if</span>&nbsp;<span class="ident" id="1537115">top</span>&nbsp;<span class="op" id="1537119">&lt;</span>&nbsp;<span class="ident" id="1537121">minTopHash</span>&nbsp;<span class="op" id="1537132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537136">top</span>&nbsp;<span class="op" id="1537140">+=</span>&nbsp;<span class="ident" id="1537143">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537159">var</span>&nbsp;<span class="ident" id="1537163">inserti</span>&nbsp;<span class="op" id="1537171">*</span><span class="builtintype" id="1537172">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537179">var</span>&nbsp;<span class="ident" id="1537183">insertk</span>&nbsp;<span class="ident" id="1537191">unsafe</span><span class="op" id="1537197">.</span><span class="ident" id="1537198">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537207">var</span>&nbsp;<span class="ident" id="1537211">insertv</span>&nbsp;<span class="ident" id="1537219">unsafe</span><span class="op" id="1537225">.</span><span class="ident" id="1537226">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537235">for</span>&nbsp;<span class="op" id="1537239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537243">for</span>&nbsp;<span class="ident" id="1537247">i</span>&nbsp;<span class="op" id="1537249">:=</span>&nbsp;<span class="builtintype" id="1537252">uintptr</span><span class="op" id="1537259">(</span><span class="num" id="1537260">0</span><span class="op" id="1537261">)</span><span class="op" id="1537262">;</span>&nbsp;<span class="ident" id="1537264">i</span>&nbsp;<span class="op" id="1537266">&lt;</span>&nbsp;<span class="ident" id="1537268">bucketCnt</span><span class="op" id="1537277">;</span>&nbsp;<span class="ident" id="1537279">i</span><span class="op" id="1537280">++</span>&nbsp;<span class="op" id="1537283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537288">if</span>&nbsp;<span class="ident" id="1537291">b</span><span class="op" id="1537292">.</span><span class="ident" id="1537293">tophash</span><span class="op" id="1537300">[</span><span class="ident" id="1537301">i</span><span class="op" id="1537302">]</span>&nbsp;<span class="op" id="1537304">!=</span>&nbsp;<span class="ident" id="1537307">top</span>&nbsp;<span class="op" id="1537311">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537317">if</span>&nbsp;<span class="ident" id="1537320">b</span><span class="op" id="1537321">.</span><span class="ident" id="1537322">tophash</span><span class="op" id="1537329">[</span><span class="ident" id="1537330">i</span><span class="op" id="1537331">]</span>&nbsp;<span class="op" id="1537333">==</span>&nbsp;<span class="ident" id="1537336">empty</span>&nbsp;<span class="op" id="1537342">&amp;&amp;</span>&nbsp;<span class="ident" id="1537345">inserti</span>&nbsp;<span class="op" id="1537353">==</span>&nbsp;<span class="ident" id="1537356">nil</span>&nbsp;<span class="op" id="1537360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537367">inserti</span>&nbsp;<span class="op" id="1537375">=</span>&nbsp;<span class="op" id="1537377">&amp;</span><span class="ident" id="1537378">b</span><span class="op" id="1537379">.</span><span class="ident" id="1537380">tophash</span><span class="op" id="1537387">[</span><span class="ident" id="1537388">i</span><span class="op" id="1537389">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537396">insertk</span>&nbsp;<span class="op" id="1537404">=</span>&nbsp;<span class="ident" id="1537406">add</span><span class="op" id="1537409">(</span><span class="ident" id="1537410">unsafe</span><span class="op" id="1537416">.</span><span class="ident" id="1537417">Pointer</span><span class="op" id="1537424">(</span><span class="ident" id="1537425">b</span><span class="op" id="1537426">)</span><span class="op" id="1537427">,</span>&nbsp;<span class="ident" id="1537429">dataOffset</span><span class="op" id="1537439">+</span><span class="ident" id="1537440">i</span><span class="op" id="1537441">*</span><span class="builtintype" id="1537442">uintptr</span><span class="op" id="1537449">(</span><span class="ident" id="1537450">t</span><span class="op" id="1537451">.</span><span class="ident" id="1537452">keysize</span><span class="op" id="1537459">)</span><span class="op" id="1537460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537467">insertv</span>&nbsp;<span class="op" id="1537475">=</span>&nbsp;<span class="ident" id="1537477">add</span><span class="op" id="1537480">(</span><span class="ident" id="1537481">unsafe</span><span class="op" id="1537487">.</span><span class="ident" id="1537488">Pointer</span><span class="op" id="1537495">(</span><span class="ident" id="1537496">b</span><span class="op" id="1537497">)</span><span class="op" id="1537498">,</span>&nbsp;<span class="ident" id="1537500">dataOffset</span><span class="op" id="1537510">+</span><span class="ident" id="1537511">bucketCnt</span><span class="op" id="1537520">*</span><span class="builtintype" id="1537521">uintptr</span><span class="op" id="1537528">(</span><span class="ident" id="1537529">t</span><span class="op" id="1537530">.</span><span class="ident" id="1537531">keysize</span><span class="op" id="1537538">)</span><span class="op" id="1537539">+</span><span class="ident" id="1537540">i</span><span class="op" id="1537541">*</span><span class="builtintype" id="1537542">uintptr</span><span class="op" id="1537549">(</span><span class="ident" id="1537550">t</span><span class="op" id="1537551">.</span><span class="ident" id="1537552">valuesize</span><span class="op" id="1537561">)</span><span class="op" id="1537562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537568">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537574">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537591">k</span>&nbsp;<span class="op" id="1537593">:=</span>&nbsp;<span class="ident" id="1537596">add</span><span class="op" id="1537599">(</span><span class="ident" id="1537600">unsafe</span><span class="op" id="1537606">.</span><span class="ident" id="1537607">Pointer</span><span class="op" id="1537614">(</span><span class="ident" id="1537615">b</span><span class="op" id="1537616">)</span><span class="op" id="1537617">,</span>&nbsp;<span class="ident" id="1537619">dataOffset</span><span class="op" id="1537629">+</span><span class="ident" id="1537630">i</span><span class="op" id="1537631">*</span><span class="builtintype" id="1537632">uintptr</span><span class="op" id="1537639">(</span><span class="ident" id="1537640">t</span><span class="op" id="1537641">.</span><span class="ident" id="1537642">keysize</span><span class="op" id="1537649">)</span><span class="op" id="1537650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537655">k2</span>&nbsp;<span class="op" id="1537658">:=</span>&nbsp;<span class="ident" id="1537661">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537666">if</span>&nbsp;<span class="ident" id="1537669">t</span><span class="op" id="1537670">.</span><span class="ident" id="1537671">indirectkey</span>&nbsp;<span class="op" id="1537683">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537689">k2</span>&nbsp;<span class="op" id="1537692">=</span>&nbsp;<span class="op" id="1537694">*</span><span class="op" id="1537695">(</span><span class="op" id="1537696">(</span><span class="op" id="1537697">*</span><span class="ident" id="1537698">unsafe</span><span class="op" id="1537704">.</span><span class="ident" id="1537705">Pointer</span><span class="op" id="1537712">)</span><span class="op" id="1537713">(</span><span class="ident" id="1537714">k2</span><span class="op" id="1537716">)</span><span class="op" id="1537717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537727">if</span>&nbsp;<span class="op" id="1537730">!</span><span class="ident" id="1537731">alg</span><span class="op" id="1537734">.</span><span class="ident" id="1537735">equal</span><span class="op" id="1537740">(</span><span class="ident" id="1537741">key</span><span class="op" id="1537744">,</span>&nbsp;<span class="ident" id="1537746">k2</span><span class="op" id="1537748">,</span>&nbsp;<span class="builtintype" id="1537750">uintptr</span><span class="op" id="1537757">(</span><span class="ident" id="1537758">t</span><span class="op" id="1537759">.</span><span class="ident" id="1537760">key</span><span class="op" id="1537763">.</span><span class="ident" id="1537764">size</span><span class="op" id="1537768">)</span><span class="op" id="1537769">)</span>&nbsp;<span class="op" id="1537771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537777">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537789">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537794">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537844">memmove</span><span class="op" id="1537851">(</span><span class="ident" id="1537852">k2</span><span class="op" id="1537854">,</span>&nbsp;<span class="ident" id="1537856">key</span><span class="op" id="1537859">,</span>&nbsp;<span class="builtintype" id="1537861">uintptr</span><span class="op" id="1537868">(</span><span class="ident" id="1537869">t</span><span class="op" id="1537870">.</span><span class="ident" id="1537871">key</span><span class="op" id="1537874">.</span><span class="ident" id="1537875">size</span><span class="op" id="1537879">)</span><span class="op" id="1537880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537885">v</span>&nbsp;<span class="op" id="1537887">:=</span>&nbsp;<span class="ident" id="1537890">add</span><span class="op" id="1537893">(</span><span class="ident" id="1537894">unsafe</span><span class="op" id="1537900">.</span><span class="ident" id="1537901">Pointer</span><span class="op" id="1537908">(</span><span class="ident" id="1537909">b</span><span class="op" id="1537910">)</span><span class="op" id="1537911">,</span>&nbsp;<span class="ident" id="1537913">dataOffset</span><span class="op" id="1537923">+</span><span class="ident" id="1537924">bucketCnt</span><span class="op" id="1537933">*</span><span class="builtintype" id="1537934">uintptr</span><span class="op" id="1537941">(</span><span class="ident" id="1537942">t</span><span class="op" id="1537943">.</span><span class="ident" id="1537944">keysize</span><span class="op" id="1537951">)</span><span class="op" id="1537952">+</span><span class="ident" id="1537953">i</span><span class="op" id="1537954">*</span><span class="builtintype" id="1537955">uintptr</span><span class="op" id="1537962">(</span><span class="ident" id="1537963">t</span><span class="op" id="1537964">.</span><span class="ident" id="1537965">valuesize</span><span class="op" id="1537974">)</span><span class="op" id="1537975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537980">v2</span>&nbsp;<span class="op" id="1537983">:=</span>&nbsp;<span class="ident" id="1537986">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537991">if</span>&nbsp;<span class="ident" id="1537994">t</span><span class="op" id="1537995">.</span><span class="ident" id="1537996">indirectvalue</span>&nbsp;<span class="op" id="1538010">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538016">v2</span>&nbsp;<span class="op" id="1538019">=</span>&nbsp;<span class="op" id="1538021">*</span><span class="op" id="1538022">(</span><span class="op" id="1538023">(</span><span class="op" id="1538024">*</span><span class="ident" id="1538025">unsafe</span><span class="op" id="1538031">.</span><span class="ident" id="1538032">Pointer</span><span class="op" id="1538039">)</span><span class="op" id="1538040">(</span><span class="ident" id="1538041">v2</span><span class="op" id="1538043">)</span><span class="op" id="1538044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538054">memmove</span><span class="op" id="1538061">(</span><span class="ident" id="1538062">v2</span><span class="op" id="1538064">,</span>&nbsp;<span class="ident" id="1538066">val</span><span class="op" id="1538069">,</span>&nbsp;<span class="builtintype" id="1538071">uintptr</span><span class="op" id="1538078">(</span><span class="ident" id="1538079">t</span><span class="op" id="1538080">.</span><span class="ident" id="1538081">elem</span><span class="op" id="1538085">.</span><span class="ident" id="1538086">size</span><span class="op" id="1538090">)</span><span class="op" id="1538091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538096">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538105">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538109">if</span>&nbsp;<span class="ident" id="1538112">b</span><span class="op" id="1538113">.</span><span class="ident" id="1538114">overflow</span>&nbsp;<span class="op" id="1538123">==</span>&nbsp;<span class="ident" id="1538126">nil</span>&nbsp;<span class="op" id="1538130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538135">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538147">b</span>&nbsp;<span class="op" id="1538149">=</span>&nbsp;<span class="ident" id="1538151">b</span><span class="op" id="1538152">.</span><span class="ident" id="1538153">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538163">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538167">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538233">if</span>&nbsp;<span class="builtintype" id="1538236">float32</span><span class="op" id="1538243">(</span><span class="ident" id="1538244">h</span><span class="op" id="1538245">.</span><span class="ident" id="1538246">count</span><span class="op" id="1538251">)</span>&nbsp;<span class="op" id="1538253">&gt;=</span>&nbsp;<span class="ident" id="1538256">loadFactor</span><span class="op" id="1538266">*</span><span class="builtintype" id="1538267">float32</span><span class="op" id="1538274">(</span><span class="op" id="1538275">(</span><span class="builtintype" id="1538276">uintptr</span><span class="op" id="1538283">(</span><span class="num" id="1538284">1</span><span class="op" id="1538285">)</span><span class="op" id="1538286">&lt;&lt;</span><span class="ident" id="1538288">h</span><span class="op" id="1538289">.</span><span class="ident" id="1538290">B</span><span class="op" id="1538291">)</span><span class="op" id="1538292">)</span>&nbsp;<span class="op" id="1538294">&amp;&amp;</span>&nbsp;<span class="ident" id="1538297">h</span><span class="op" id="1538298">.</span><span class="ident" id="1538299">count</span>&nbsp;<span class="op" id="1538305">&gt;=</span>&nbsp;<span class="ident" id="1538308">bucketCnt</span>&nbsp;<span class="op" id="1538318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538322">hashGrow</span><span class="op" id="1538330">(</span><span class="ident" id="1538331">t</span><span class="op" id="1538332">,</span>&nbsp;<span class="ident" id="1538334">h</span><span class="op" id="1538335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538339">goto</span>&nbsp;<span class="ident" id="1538344">again</span>&nbsp;<span class="comment" id="1538350">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538413">if</span>&nbsp;<span class="ident" id="1538416">inserti</span>&nbsp;<span class="op" id="1538424">==</span>&nbsp;<span class="ident" id="1538427">nil</span>&nbsp;<span class="op" id="1538431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538435">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538490">if</span>&nbsp;<span class="ident" id="1538493">checkgc</span>&nbsp;<span class="op" id="1538501">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538506">memstats</span><span class="op" id="1538514">.</span><span class="ident" id="1538515">next_gc</span>&nbsp;<span class="op" id="1538523">=</span>&nbsp;<span class="ident" id="1538525">memstats</span><span class="op" id="1538533">.</span><span class="ident" id="1538534">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538551">newb</span>&nbsp;<span class="op" id="1538556">:=</span>&nbsp;<span class="op" id="1538559">(</span><span class="op" id="1538560">*</span><span class="ident" id="1538561">bmap</span><span class="op" id="1538565">)</span><span class="op" id="1538566">(</span><span class="ident" id="1538567">newobject</span><span class="op" id="1538576">(</span><span class="ident" id="1538577">t</span><span class="op" id="1538578">.</span><span class="ident" id="1538579">bucket</span><span class="op" id="1538585">)</span><span class="op" id="1538586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538590">b</span><span class="op" id="1538591">.</span><span class="ident" id="1538592">overflow</span>&nbsp;<span class="op" id="1538601">=</span>&nbsp;<span class="ident" id="1538603">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538610">inserti</span>&nbsp;<span class="op" id="1538618">=</span>&nbsp;<span class="op" id="1538620">&amp;</span><span class="ident" id="1538621">newb</span><span class="op" id="1538625">.</span><span class="ident" id="1538626">tophash</span><span class="op" id="1538633">[</span><span class="num" id="1538634">0</span><span class="op" id="1538635">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538639">insertk</span>&nbsp;<span class="op" id="1538647">=</span>&nbsp;<span class="ident" id="1538649">add</span><span class="op" id="1538652">(</span><span class="ident" id="1538653">unsafe</span><span class="op" id="1538659">.</span><span class="ident" id="1538660">Pointer</span><span class="op" id="1538667">(</span><span class="ident" id="1538668">newb</span><span class="op" id="1538672">)</span><span class="op" id="1538673">,</span>&nbsp;<span class="ident" id="1538675">dataOffset</span><span class="op" id="1538685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538689">insertv</span>&nbsp;<span class="op" id="1538697">=</span>&nbsp;<span class="ident" id="1538699">add</span><span class="op" id="1538702">(</span><span class="ident" id="1538703">insertk</span><span class="op" id="1538710">,</span>&nbsp;<span class="ident" id="1538712">bucketCnt</span><span class="op" id="1538721">*</span><span class="builtintype" id="1538722">uintptr</span><span class="op" id="1538729">(</span><span class="ident" id="1538730">t</span><span class="op" id="1538731">.</span><span class="ident" id="1538732">keysize</span><span class="op" id="1538739">)</span><span class="op" id="1538740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538747">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538790">if</span>&nbsp;<span class="ident" id="1538793">t</span><span class="op" id="1538794">.</span><span class="ident" id="1538795">indirectkey</span>&nbsp;<span class="op" id="1538807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538811">if</span>&nbsp;<span class="ident" id="1538814">checkgc</span>&nbsp;<span class="op" id="1538822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538827">memstats</span><span class="op" id="1538835">.</span><span class="ident" id="1538836">next_gc</span>&nbsp;<span class="op" id="1538844">=</span>&nbsp;<span class="ident" id="1538846">memstats</span><span class="op" id="1538854">.</span><span class="ident" id="1538855">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538872">kmem</span>&nbsp;<span class="op" id="1538877">:=</span>&nbsp;<span class="ident" id="1538880">newobject</span><span class="op" id="1538889">(</span><span class="ident" id="1538890">t</span><span class="op" id="1538891">.</span><span class="ident" id="1538892">key</span><span class="op" id="1538895">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538899">*</span><span class="op" id="1538900">(</span><span class="op" id="1538901">*</span><span class="ident" id="1538902">unsafe</span><span class="op" id="1538908">.</span><span class="ident" id="1538909">Pointer</span><span class="op" id="1538916">)</span><span class="op" id="1538917">(</span><span class="ident" id="1538918">insertk</span><span class="op" id="1538925">)</span>&nbsp;<span class="op" id="1538927">=</span>&nbsp;<span class="ident" id="1538929">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538936">insertk</span>&nbsp;<span class="op" id="1538944">=</span>&nbsp;<span class="ident" id="1538946">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538955">if</span>&nbsp;<span class="ident" id="1538958">t</span><span class="op" id="1538959">.</span><span class="ident" id="1538960">indirectvalue</span>&nbsp;<span class="op" id="1538974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538978">if</span>&nbsp;<span class="ident" id="1538981">checkgc</span>&nbsp;<span class="op" id="1538989">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538994">memstats</span><span class="op" id="1539002">.</span><span class="ident" id="1539003">next_gc</span>&nbsp;<span class="op" id="1539011">=</span>&nbsp;<span class="ident" id="1539013">memstats</span><span class="op" id="1539021">.</span><span class="ident" id="1539022">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539039">vmem</span>&nbsp;<span class="op" id="1539044">:=</span>&nbsp;<span class="ident" id="1539047">newobject</span><span class="op" id="1539056">(</span><span class="ident" id="1539057">t</span><span class="op" id="1539058">.</span><span class="ident" id="1539059">elem</span><span class="op" id="1539063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539067">*</span><span class="op" id="1539068">(</span><span class="op" id="1539069">*</span><span class="ident" id="1539070">unsafe</span><span class="op" id="1539076">.</span><span class="ident" id="1539077">Pointer</span><span class="op" id="1539084">)</span><span class="op" id="1539085">(</span><span class="ident" id="1539086">insertv</span><span class="op" id="1539093">)</span>&nbsp;<span class="op" id="1539095">=</span>&nbsp;<span class="ident" id="1539097">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539104">insertv</span>&nbsp;<span class="op" id="1539112">=</span>&nbsp;<span class="ident" id="1539114">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539123">memmove</span><span class="op" id="1539130">(</span><span class="ident" id="1539131">insertk</span><span class="op" id="1539138">,</span>&nbsp;<span class="ident" id="1539140">key</span><span class="op" id="1539143">,</span>&nbsp;<span class="builtintype" id="1539145">uintptr</span><span class="op" id="1539152">(</span><span class="ident" id="1539153">t</span><span class="op" id="1539154">.</span><span class="ident" id="1539155">key</span><span class="op" id="1539158">.</span><span class="ident" id="1539159">size</span><span class="op" id="1539163">)</span><span class="op" id="1539164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539167">memmove</span><span class="op" id="1539174">(</span><span class="ident" id="1539175">insertv</span><span class="op" id="1539182">,</span>&nbsp;<span class="ident" id="1539184">val</span><span class="op" id="1539187">,</span>&nbsp;<span class="builtintype" id="1539189">uintptr</span><span class="op" id="1539196">(</span><span class="ident" id="1539197">t</span><span class="op" id="1539198">.</span><span class="ident" id="1539199">elem</span><span class="op" id="1539203">.</span><span class="ident" id="1539204">size</span><span class="op" id="1539208">)</span><span class="op" id="1539209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539212">*</span><span class="ident" id="1539213">inserti</span>&nbsp;<span class="op" id="1539221">=</span>&nbsp;<span class="ident" id="1539223">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539228">h</span><span class="op" id="1539229">.</span><span class="ident" id="1539230">count</span><span class="op" id="1539235">++</span><br>
<span class="lineno">485</span><span class="op" id="1539238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1539241">func</span>&nbsp;<span class="ident" id="1539246">mapdelete</span><span class="op" id="1539255">(</span><span class="ident" id="1539256">t</span>&nbsp;<span class="op" id="1539258">*</span><span class="ident" id="1539259">maptype</span><span class="op" id="1539266">,</span>&nbsp;<span class="ident" id="1539268">h</span>&nbsp;<span class="op" id="1539270">*</span><span class="ident" id="1539271">hmap</span><span class="op" id="1539275">,</span>&nbsp;<span class="ident" id="1539277">key</span>&nbsp;<span class="ident" id="1539281">unsafe</span><span class="op" id="1539287">.</span><span class="ident" id="1539288">Pointer</span><span class="op" id="1539295">)</span>&nbsp;<span class="op" id="1539297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539300">if</span>&nbsp;<span class="ident" id="1539303">raceenabled</span>&nbsp;<span class="op" id="1539315">&amp;&amp;</span>&nbsp;<span class="ident" id="1539318">h</span>&nbsp;<span class="op" id="1539320">!=</span>&nbsp;<span class="ident" id="1539323">nil</span>&nbsp;<span class="op" id="1539327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539331">callerpc</span>&nbsp;<span class="op" id="1539340">:=</span>&nbsp;<span class="ident" id="1539343">getcallerpc</span><span class="op" id="1539354">(</span><span class="ident" id="1539355">unsafe</span><span class="op" id="1539361">.</span><span class="ident" id="1539362">Pointer</span><span class="op" id="1539369">(</span><span class="op" id="1539370">&amp;</span><span class="ident" id="1539371">t</span><span class="op" id="1539372">)</span><span class="op" id="1539373">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539377">pc</span>&nbsp;<span class="op" id="1539380">:=</span>&nbsp;<span class="ident" id="1539383">funcPC</span><span class="op" id="1539389">(</span><span class="ident" id="1539390">mapdelete</span><span class="op" id="1539399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539403">racewritepc</span><span class="op" id="1539414">(</span><span class="ident" id="1539415">unsafe</span><span class="op" id="1539421">.</span><span class="ident" id="1539422">Pointer</span><span class="op" id="1539429">(</span><span class="ident" id="1539430">h</span><span class="op" id="1539431">)</span><span class="op" id="1539432">,</span>&nbsp;<span class="ident" id="1539434">callerpc</span><span class="op" id="1539442">,</span>&nbsp;<span class="ident" id="1539444">pc</span><span class="op" id="1539446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539450">raceReadObjectPC</span><span class="op" id="1539466">(</span><span class="ident" id="1539467">t</span><span class="op" id="1539468">.</span><span class="ident" id="1539469">key</span><span class="op" id="1539472">,</span>&nbsp;<span class="ident" id="1539474">key</span><span class="op" id="1539477">,</span>&nbsp;<span class="ident" id="1539479">callerpc</span><span class="op" id="1539487">,</span>&nbsp;<span class="ident" id="1539489">pc</span><span class="op" id="1539491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539497">if</span>&nbsp;<span class="ident" id="1539500">h</span>&nbsp;<span class="op" id="1539502">==</span>&nbsp;<span class="ident" id="1539505">nil</span>&nbsp;<span class="op" id="1539509">||</span>&nbsp;<span class="ident" id="1539512">h</span><span class="op" id="1539513">.</span><span class="ident" id="1539514">count</span>&nbsp;<span class="op" id="1539520">==</span>&nbsp;<span class="num" id="1539523">0</span>&nbsp;<span class="op" id="1539525">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539529">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539540">alg</span>&nbsp;<span class="op" id="1539544">:=</span>&nbsp;<span class="ident" id="1539547">goalg</span><span class="op" id="1539552">(</span><span class="ident" id="1539553">t</span><span class="op" id="1539554">.</span><span class="ident" id="1539555">key</span><span class="op" id="1539558">.</span><span class="ident" id="1539559">alg</span><span class="op" id="1539562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539565">hash</span>&nbsp;<span class="op" id="1539570">:=</span>&nbsp;<span class="ident" id="1539573">alg</span><span class="op" id="1539576">.</span><span class="ident" id="1539577">hash</span><span class="op" id="1539581">(</span><span class="ident" id="1539582">key</span><span class="op" id="1539585">,</span>&nbsp;<span class="builtintype" id="1539587">uintptr</span><span class="op" id="1539594">(</span><span class="ident" id="1539595">t</span><span class="op" id="1539596">.</span><span class="ident" id="1539597">key</span><span class="op" id="1539600">.</span><span class="ident" id="1539601">size</span><span class="op" id="1539605">)</span><span class="op" id="1539606">,</span>&nbsp;<span class="builtintype" id="1539608">uintptr</span><span class="op" id="1539615">(</span><span class="ident" id="1539616">h</span><span class="op" id="1539617">.</span><span class="ident" id="1539618">hash0</span><span class="op" id="1539623">)</span><span class="op" id="1539624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539627">bucket</span>&nbsp;<span class="op" id="1539634">:=</span>&nbsp;<span class="ident" id="1539637">hash</span>&nbsp;<span class="op" id="1539642">&amp;</span>&nbsp;<span class="op" id="1539644">(</span><span class="builtintype" id="1539645">uintptr</span><span class="op" id="1539652">(</span><span class="num" id="1539653">1</span><span class="op" id="1539654">)</span><span class="op" id="1539655">&lt;&lt;</span><span class="ident" id="1539657">h</span><span class="op" id="1539658">.</span><span class="ident" id="1539659">B</span>&nbsp;<span class="op" id="1539661">-</span>&nbsp;<span class="num" id="1539663">1</span><span class="op" id="1539664">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539667">if</span>&nbsp;<span class="ident" id="1539670">h</span><span class="op" id="1539671">.</span><span class="ident" id="1539672">oldbuckets</span>&nbsp;<span class="op" id="1539683">!=</span>&nbsp;<span class="ident" id="1539686">nil</span>&nbsp;<span class="op" id="1539690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539694">growWork</span><span class="op" id="1539702">(</span><span class="ident" id="1539703">t</span><span class="op" id="1539704">,</span>&nbsp;<span class="ident" id="1539706">h</span><span class="op" id="1539707">,</span>&nbsp;<span class="ident" id="1539709">bucket</span><span class="op" id="1539715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539721">b</span>&nbsp;<span class="op" id="1539723">:=</span>&nbsp;<span class="op" id="1539726">(</span><span class="op" id="1539727">*</span><span class="ident" id="1539728">bmap</span><span class="op" id="1539732">)</span><span class="op" id="1539733">(</span><span class="ident" id="1539734">unsafe</span><span class="op" id="1539740">.</span><span class="ident" id="1539741">Pointer</span><span class="op" id="1539748">(</span><span class="builtintype" id="1539749">uintptr</span><span class="op" id="1539756">(</span><span class="ident" id="1539757">h</span><span class="op" id="1539758">.</span><span class="ident" id="1539759">buckets</span><span class="op" id="1539766">)</span>&nbsp;<span class="op" id="1539768">+</span>&nbsp;<span class="ident" id="1539770">bucket</span><span class="op" id="1539776">*</span><span class="builtintype" id="1539777">uintptr</span><span class="op" id="1539784">(</span><span class="ident" id="1539785">t</span><span class="op" id="1539786">.</span><span class="ident" id="1539787">bucketsize</span><span class="op" id="1539797">)</span><span class="op" id="1539798">)</span><span class="op" id="1539799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539802">top</span>&nbsp;<span class="op" id="1539806">:=</span>&nbsp;<span class="builtintype" id="1539809">uint8</span><span class="op" id="1539814">(</span><span class="ident" id="1539815">hash</span>&nbsp;<span class="op" id="1539820">&gt;&gt;</span>&nbsp;<span class="op" id="1539823">(</span><span class="ident" id="1539824">ptrSize</span><span class="op" id="1539831">*</span><span class="num" id="1539832">8</span>&nbsp;<span class="op" id="1539834">-</span>&nbsp;<span class="num" id="1539836">8</span><span class="op" id="1539837">)</span><span class="op" id="1539838">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539841">if</span>&nbsp;<span class="ident" id="1539844">top</span>&nbsp;<span class="op" id="1539848">&lt;</span>&nbsp;<span class="ident" id="1539850">minTopHash</span>&nbsp;<span class="op" id="1539861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539865">top</span>&nbsp;<span class="op" id="1539869">+=</span>&nbsp;<span class="ident" id="1539872">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539887">for</span>&nbsp;<span class="op" id="1539891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539895">for</span>&nbsp;<span class="ident" id="1539899">i</span>&nbsp;<span class="op" id="1539901">:=</span>&nbsp;<span class="builtintype" id="1539904">uintptr</span><span class="op" id="1539911">(</span><span class="num" id="1539912">0</span><span class="op" id="1539913">)</span><span class="op" id="1539914">;</span>&nbsp;<span class="ident" id="1539916">i</span>&nbsp;<span class="op" id="1539918">&lt;</span>&nbsp;<span class="ident" id="1539920">bucketCnt</span><span class="op" id="1539929">;</span>&nbsp;<span class="ident" id="1539931">i</span><span class="op" id="1539932">++</span>&nbsp;<span class="op" id="1539935">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539940">if</span>&nbsp;<span class="ident" id="1539943">b</span><span class="op" id="1539944">.</span><span class="ident" id="1539945">tophash</span><span class="op" id="1539952">[</span><span class="ident" id="1539953">i</span><span class="op" id="1539954">]</span>&nbsp;<span class="op" id="1539956">!=</span>&nbsp;<span class="ident" id="1539959">top</span>&nbsp;<span class="op" id="1539963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539969">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539986">k</span>&nbsp;<span class="op" id="1539988">:=</span>&nbsp;<span class="ident" id="1539991">add</span><span class="op" id="1539994">(</span><span class="ident" id="1539995">unsafe</span><span class="op" id="1540001">.</span><span class="ident" id="1540002">Pointer</span><span class="op" id="1540009">(</span><span class="ident" id="1540010">b</span><span class="op" id="1540011">)</span><span class="op" id="1540012">,</span>&nbsp;<span class="ident" id="1540014">dataOffset</span><span class="op" id="1540024">+</span><span class="ident" id="1540025">i</span><span class="op" id="1540026">*</span><span class="builtintype" id="1540027">uintptr</span><span class="op" id="1540034">(</span><span class="ident" id="1540035">t</span><span class="op" id="1540036">.</span><span class="ident" id="1540037">keysize</span><span class="op" id="1540044">)</span><span class="op" id="1540045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540050">k2</span>&nbsp;<span class="op" id="1540053">:=</span>&nbsp;<span class="ident" id="1540056">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540061">if</span>&nbsp;<span class="ident" id="1540064">t</span><span class="op" id="1540065">.</span><span class="ident" id="1540066">indirectkey</span>&nbsp;<span class="op" id="1540078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540084">k2</span>&nbsp;<span class="op" id="1540087">=</span>&nbsp;<span class="op" id="1540089">*</span><span class="op" id="1540090">(</span><span class="op" id="1540091">(</span><span class="op" id="1540092">*</span><span class="ident" id="1540093">unsafe</span><span class="op" id="1540099">.</span><span class="ident" id="1540100">Pointer</span><span class="op" id="1540107">)</span><span class="op" id="1540108">(</span><span class="ident" id="1540109">k2</span><span class="op" id="1540111">)</span><span class="op" id="1540112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540122">if</span>&nbsp;<span class="op" id="1540125">!</span><span class="ident" id="1540126">alg</span><span class="op" id="1540129">.</span><span class="ident" id="1540130">equal</span><span class="op" id="1540135">(</span><span class="ident" id="1540136">key</span><span class="op" id="1540139">,</span>&nbsp;<span class="ident" id="1540141">k2</span><span class="op" id="1540143">,</span>&nbsp;<span class="builtintype" id="1540145">uintptr</span><span class="op" id="1540152">(</span><span class="ident" id="1540153">t</span><span class="op" id="1540154">.</span><span class="ident" id="1540155">key</span><span class="op" id="1540158">.</span><span class="ident" id="1540159">size</span><span class="op" id="1540163">)</span><span class="op" id="1540164">)</span>&nbsp;<span class="op" id="1540166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540172">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540189">memclr</span><span class="op" id="1540195">(</span><span class="ident" id="1540196">k</span><span class="op" id="1540197">,</span>&nbsp;<span class="builtintype" id="1540199">uintptr</span><span class="op" id="1540206">(</span><span class="ident" id="1540207">t</span><span class="op" id="1540208">.</span><span class="ident" id="1540209">keysize</span><span class="op" id="1540216">)</span><span class="op" id="1540217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540222">v</span>&nbsp;<span class="op" id="1540224">:=</span>&nbsp;<span class="ident" id="1540227">unsafe</span><span class="op" id="1540233">.</span><span class="ident" id="1540234">Pointer</span><span class="op" id="1540241">(</span><span class="builtintype" id="1540242">uintptr</span><span class="op" id="1540249">(</span><span class="ident" id="1540250">unsafe</span><span class="op" id="1540256">.</span><span class="ident" id="1540257">Pointer</span><span class="op" id="1540264">(</span><span class="ident" id="1540265">b</span><span class="op" id="1540266">)</span><span class="op" id="1540267">)</span>&nbsp;<span class="op" id="1540269">+</span>&nbsp;<span class="ident" id="1540271">dataOffset</span>&nbsp;<span class="op" id="1540282">+</span>&nbsp;<span class="ident" id="1540284">bucketCnt</span><span class="op" id="1540293">*</span><span class="builtintype" id="1540294">uintptr</span><span class="op" id="1540301">(</span><span class="ident" id="1540302">t</span><span class="op" id="1540303">.</span><span class="ident" id="1540304">keysize</span><span class="op" id="1540311">)</span>&nbsp;<span class="op" id="1540313">+</span>&nbsp;<span class="ident" id="1540315">i</span><span class="op" id="1540316">*</span><span class="builtintype" id="1540317">uintptr</span><span class="op" id="1540324">(</span><span class="ident" id="1540325">t</span><span class="op" id="1540326">.</span><span class="ident" id="1540327">valuesize</span><span class="op" id="1540336">)</span><span class="op" id="1540337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540342">memclr</span><span class="op" id="1540348">(</span><span class="ident" id="1540349">v</span><span class="op" id="1540350">,</span>&nbsp;<span class="builtintype" id="1540352">uintptr</span><span class="op" id="1540359">(</span><span class="ident" id="1540360">t</span><span class="op" id="1540361">.</span><span class="ident" id="1540362">valuesize</span><span class="op" id="1540371">)</span><span class="op" id="1540372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540377">b</span><span class="op" id="1540378">.</span><span class="ident" id="1540379">tophash</span><span class="op" id="1540386">[</span><span class="ident" id="1540387">i</span><span class="op" id="1540388">]</span>&nbsp;<span class="op" id="1540390">=</span>&nbsp;<span class="ident" id="1540392">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540401">h</span><span class="op" id="1540402">.</span><span class="ident" id="1540403">count</span><span class="op" id="1540408">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540414">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540427">b</span>&nbsp;<span class="op" id="1540429">=</span>&nbsp;<span class="ident" id="1540431">b</span><span class="op" id="1540432">.</span><span class="ident" id="1540433">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540444">if</span>&nbsp;<span class="ident" id="1540447">b</span>&nbsp;<span class="op" id="1540449">==</span>&nbsp;<span class="ident" id="1540452">nil</span>&nbsp;<span class="op" id="1540456">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540461">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540473">}</span><br>
<span class="lineno"></span><span class="op" id="1540475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1540478">func</span>&nbsp;<span class="ident" id="1540483">mapiterinit</span><span class="op" id="1540494">(</span><span class="ident" id="1540495">t</span>&nbsp;<span class="op" id="1540497">*</span><span class="ident" id="1540498">maptype</span><span class="op" id="1540505">,</span>&nbsp;<span class="ident" id="1540507">h</span>&nbsp;<span class="op" id="1540509">*</span><span class="ident" id="1540510">hmap</span><span class="op" id="1540514">,</span>&nbsp;<span class="ident" id="1540516">it</span>&nbsp;<span class="op" id="1540519">*</span><span class="ident" id="1540520">hiter</span><span class="op" id="1540525">)</span>&nbsp;<span class="op" id="1540527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1540530">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540595">it</span><span class="op" id="1540597">.</span><span class="ident" id="1540598">key</span>&nbsp;<span class="op" id="1540602">=</span>&nbsp;<span class="ident" id="1540604">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540609">it</span><span class="op" id="1540611">.</span><span class="ident" id="1540612">value</span>&nbsp;<span class="op" id="1540618">=</span>&nbsp;<span class="ident" id="1540620">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540625">it</span><span class="op" id="1540627">.</span><span class="ident" id="1540628">t</span>&nbsp;<span class="op" id="1540630">=</span>&nbsp;<span class="ident" id="1540632">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540637">it</span><span class="op" id="1540639">.</span><span class="ident" id="1540640">h</span>&nbsp;<span class="op" id="1540642">=</span>&nbsp;<span class="ident" id="1540644">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540649">it</span><span class="op" id="1540651">.</span><span class="ident" id="1540652">buckets</span>&nbsp;<span class="op" id="1540660">=</span>&nbsp;<span class="ident" id="1540662">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540667">it</span><span class="op" id="1540669">.</span><span class="ident" id="1540670">bptr</span>&nbsp;<span class="op" id="1540675">=</span>&nbsp;<span class="ident" id="1540677">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540683">if</span>&nbsp;<span class="ident" id="1540686">raceenabled</span>&nbsp;<span class="op" id="1540698">&amp;&amp;</span>&nbsp;<span class="ident" id="1540701">h</span>&nbsp;<span class="op" id="1540703">!=</span>&nbsp;<span class="ident" id="1540706">nil</span>&nbsp;<span class="op" id="1540710">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540714">callerpc</span>&nbsp;<span class="op" id="1540723">:=</span>&nbsp;<span class="ident" id="1540726">getcallerpc</span><span class="op" id="1540737">(</span><span class="ident" id="1540738">unsafe</span><span class="op" id="1540744">.</span><span class="ident" id="1540745">Pointer</span><span class="op" id="1540752">(</span><span class="op" id="1540753">&amp;</span><span class="ident" id="1540754">t</span><span class="op" id="1540755">)</span><span class="op" id="1540756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540760">racereadpc</span><span class="op" id="1540770">(</span><span class="ident" id="1540771">unsafe</span><span class="op" id="1540777">.</span><span class="ident" id="1540778">Pointer</span><span class="op" id="1540785">(</span><span class="ident" id="1540786">h</span><span class="op" id="1540787">)</span><span class="op" id="1540788">,</span>&nbsp;<span class="ident" id="1540790">callerpc</span><span class="op" id="1540798">,</span>&nbsp;<span class="ident" id="1540800">funcPC</span><span class="op" id="1540806">(</span><span class="ident" id="1540807">mapiterinit</span><span class="op" id="1540818">)</span><span class="op" id="1540819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540826">if</span>&nbsp;<span class="ident" id="1540829">h</span>&nbsp;<span class="op" id="1540831">==</span>&nbsp;<span class="ident" id="1540834">nil</span>&nbsp;<span class="op" id="1540838">||</span>&nbsp;<span class="ident" id="1540841">h</span><span class="op" id="1540842">.</span><span class="ident" id="1540843">count</span>&nbsp;<span class="op" id="1540849">==</span>&nbsp;<span class="num" id="1540852">0</span>&nbsp;<span class="op" id="1540854">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540858">it</span><span class="op" id="1540860">.</span><span class="ident" id="1540861">key</span>&nbsp;<span class="op" id="1540865">=</span>&nbsp;<span class="ident" id="1540867">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540873">it</span><span class="op" id="1540875">.</span><span class="ident" id="1540876">value</span>&nbsp;<span class="op" id="1540882">=</span>&nbsp;<span class="ident" id="1540884">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540890">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540902">if</span>&nbsp;<span class="ident" id="1540905">unsafe</span><span class="op" id="1540911">.</span><span class="ident" id="1540912">Sizeof</span><span class="op" id="1540918">(</span><span class="ident" id="1540919">hiter</span><span class="op" id="1540924">{</span><span class="op" id="1540925">}</span><span class="op" id="1540926">)</span><span class="op" id="1540927">/</span><span class="ident" id="1540928">ptrSize</span>&nbsp;<span class="op" id="1540936">!=</span>&nbsp;<span class="num" id="1540939">10</span>&nbsp;<span class="op" id="1540942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540946">gothrow</span><span class="op" id="1540953">(</span><span class="string" id="1540954">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1540980">)</span>&nbsp;<span class="comment" id="1540982">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541016">it</span><span class="op" id="1541018">.</span><span class="ident" id="1541019">t</span>&nbsp;<span class="op" id="1541021">=</span>&nbsp;<span class="ident" id="1541023">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541026">it</span><span class="op" id="1541028">.</span><span class="ident" id="1541029">h</span>&nbsp;<span class="op" id="1541031">=</span>&nbsp;<span class="ident" id="1541033">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541037">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541071">it</span><span class="op" id="1541073">.</span><span class="ident" id="1541074">B</span>&nbsp;<span class="op" id="1541076">=</span>&nbsp;<span class="ident" id="1541078">h</span><span class="op" id="1541079">.</span><span class="ident" id="1541080">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541083">it</span><span class="op" id="1541085">.</span><span class="ident" id="1541086">buckets</span>&nbsp;<span class="op" id="1541094">=</span>&nbsp;<span class="ident" id="1541096">h</span><span class="op" id="1541097">.</span><span class="ident" id="1541098">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541108">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541134">r</span>&nbsp;<span class="op" id="1541136">:=</span>&nbsp;<span class="builtintype" id="1541139">uintptr</span><span class="op" id="1541146">(</span><span class="ident" id="1541147">fastrand1</span><span class="op" id="1541156">(</span><span class="op" id="1541157">)</span><span class="op" id="1541158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541161">if</span>&nbsp;<span class="ident" id="1541164">h</span><span class="op" id="1541165">.</span><span class="ident" id="1541166">B</span>&nbsp;<span class="op" id="1541168">&gt;</span>&nbsp;<span class="num" id="1541170">31</span><span class="op" id="1541172">-</span><span class="ident" id="1541173">bucketCntBits</span>&nbsp;<span class="op" id="1541187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541191">r</span>&nbsp;<span class="op" id="1541193">+=</span>&nbsp;<span class="builtintype" id="1541196">uintptr</span><span class="op" id="1541203">(</span><span class="ident" id="1541204">fastrand1</span><span class="op" id="1541213">(</span><span class="op" id="1541214">)</span><span class="op" id="1541215">)</span>&nbsp;<span class="op" id="1541217">&lt;&lt;</span>&nbsp;<span class="num" id="1541220">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541224">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541227">it</span><span class="op" id="1541229">.</span><span class="ident" id="1541230">startBucket</span>&nbsp;<span class="op" id="1541242">=</span>&nbsp;<span class="ident" id="1541244">r</span>&nbsp;<span class="op" id="1541246">&amp;</span>&nbsp;<span class="op" id="1541248">(</span><span class="builtintype" id="1541249">uintptr</span><span class="op" id="1541256">(</span><span class="num" id="1541257">1</span><span class="op" id="1541258">)</span><span class="op" id="1541259">&lt;&lt;</span><span class="ident" id="1541261">h</span><span class="op" id="1541262">.</span><span class="ident" id="1541263">B</span>&nbsp;<span class="op" id="1541265">-</span>&nbsp;<span class="num" id="1541267">1</span><span class="op" id="1541268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541271">it</span><span class="op" id="1541273">.</span><span class="ident" id="1541274">offset</span>&nbsp;<span class="op" id="1541281">=</span>&nbsp;<span class="builtintype" id="1541283">uint8</span><span class="op" id="1541288">(</span><span class="ident" id="1541289">r</span>&nbsp;<span class="op" id="1541291">&gt;&gt;</span>&nbsp;<span class="ident" id="1541294">h</span><span class="op" id="1541295">.</span><span class="ident" id="1541296">B</span>&nbsp;<span class="op" id="1541298">&amp;</span>&nbsp;<span class="op" id="1541300">(</span><span class="ident" id="1541301">bucketCnt</span>&nbsp;<span class="op" id="1541311">-</span>&nbsp;<span class="num" id="1541313">1</span><span class="op" id="1541314">)</span><span class="op" id="1541315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541319">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541338">it</span><span class="op" id="1541340">.</span><span class="ident" id="1541341">bucket</span>&nbsp;<span class="op" id="1541348">=</span>&nbsp;<span class="ident" id="1541350">it</span><span class="op" id="1541352">.</span><span class="ident" id="1541353">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541366">it</span><span class="op" id="1541368">.</span><span class="ident" id="1541369">wrapped</span>&nbsp;<span class="op" id="1541377">=</span>&nbsp;<span class="builtintype" id="1541379">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541386">it</span><span class="op" id="1541388">.</span><span class="ident" id="1541389">bptr</span>&nbsp;<span class="op" id="1541394">=</span>&nbsp;<span class="ident" id="1541396">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541402">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541436">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541492">for</span>&nbsp;<span class="op" id="1541496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541500">old</span>&nbsp;<span class="op" id="1541504">:=</span>&nbsp;<span class="ident" id="1541507">h</span><span class="op" id="1541508">.</span><span class="ident" id="1541509">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541517">if</span>&nbsp;<span class="ident" id="1541520">old</span>&nbsp;<span class="op" id="1541524">==</span>&nbsp;<span class="ident" id="1541527">old</span><span class="op" id="1541530">|</span><span class="ident" id="1541531">iterator</span><span class="op" id="1541539">|</span><span class="ident" id="1541540">oldIterator</span>&nbsp;<span class="op" id="1541552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541557">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541565">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541569">if</span>&nbsp;<span class="ident" id="1541572">cas</span><span class="op" id="1541575">(</span><span class="op" id="1541576">&amp;</span><span class="ident" id="1541577">h</span><span class="op" id="1541578">.</span><span class="ident" id="1541579">flags</span><span class="op" id="1541584">,</span>&nbsp;<span class="ident" id="1541586">old</span><span class="op" id="1541589">,</span>&nbsp;<span class="ident" id="1541591">old</span><span class="op" id="1541594">|</span><span class="ident" id="1541595">iterator</span><span class="op" id="1541603">|</span><span class="ident" id="1541604">oldIterator</span><span class="op" id="1541615">)</span>&nbsp;<span class="op" id="1541617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541622">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541637">mapiternext</span><span class="op" id="1541648">(</span><span class="ident" id="1541649">it</span><span class="op" id="1541651">)</span><br>
<span class="lineno"></span><span class="op" id="1541653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1541656">func</span>&nbsp;<span class="ident" id="1541661">mapiternext</span><span class="op" id="1541672">(</span><span class="ident" id="1541673">it</span>&nbsp;<span class="op" id="1541676">*</span><span class="ident" id="1541677">hiter</span><span class="op" id="1541682">)</span>&nbsp;<span class="op" id="1541684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541687">h</span>&nbsp;<span class="op" id="1541689">:=</span>&nbsp;<span class="ident" id="1541692">it</span><span class="op" id="1541694">.</span><span class="ident" id="1541695">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541698">if</span>&nbsp;<span class="ident" id="1541701">raceenabled</span>&nbsp;<span class="op" id="1541713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541717">callerpc</span>&nbsp;<span class="op" id="1541726">:=</span>&nbsp;<span class="ident" id="1541729">getcallerpc</span><span class="op" id="1541740">(</span><span class="ident" id="1541741">unsafe</span><span class="op" id="1541747">.</span><span class="ident" id="1541748">Pointer</span><span class="op" id="1541755">(</span><span class="op" id="1541756">&amp;</span><span class="ident" id="1541757">it</span><span class="op" id="1541759">)</span><span class="op" id="1541760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541764">racereadpc</span><span class="op" id="1541774">(</span><span class="ident" id="1541775">unsafe</span><span class="op" id="1541781">.</span><span class="ident" id="1541782">Pointer</span><span class="op" id="1541789">(</span><span class="ident" id="1541790">h</span><span class="op" id="1541791">)</span><span class="op" id="1541792">,</span>&nbsp;<span class="ident" id="1541794">callerpc</span><span class="op" id="1541802">,</span>&nbsp;<span class="ident" id="1541804">funcPC</span><span class="op" id="1541810">(</span><span class="ident" id="1541811">mapiternext</span><span class="op" id="1541822">)</span><span class="op" id="1541823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541829">t</span>&nbsp;<span class="op" id="1541831">:=</span>&nbsp;<span class="ident" id="1541834">it</span><span class="op" id="1541836">.</span><span class="ident" id="1541837">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541840">bucket</span>&nbsp;<span class="op" id="1541847">:=</span>&nbsp;<span class="ident" id="1541850">it</span><span class="op" id="1541852">.</span><span class="ident" id="1541853">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541861">b</span>&nbsp;<span class="op" id="1541863">:=</span>&nbsp;<span class="ident" id="1541866">it</span><span class="op" id="1541868">.</span><span class="ident" id="1541869">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541875">i</span>&nbsp;<span class="op" id="1541877">:=</span>&nbsp;<span class="ident" id="1541880">it</span><span class="op" id="1541882">.</span><span class="ident" id="1541883">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541886">checkBucket</span>&nbsp;<span class="op" id="1541898">:=</span>&nbsp;<span class="ident" id="1541901">it</span><span class="op" id="1541903">.</span><span class="ident" id="1541904">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541917">alg</span>&nbsp;<span class="op" id="1541921">:=</span>&nbsp;<span class="ident" id="1541924">goalg</span><span class="op" id="1541929">(</span><span class="ident" id="1541930">t</span><span class="op" id="1541931">.</span><span class="ident" id="1541932">key</span><span class="op" id="1541935">.</span><span class="ident" id="1541936">alg</span><span class="op" id="1541939">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1541942">next</span><span class="op" id="1541946">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541949">if</span>&nbsp;<span class="ident" id="1541952">b</span>&nbsp;<span class="op" id="1541954">==</span>&nbsp;<span class="ident" id="1541957">nil</span>&nbsp;<span class="op" id="1541961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541965">if</span>&nbsp;<span class="ident" id="1541968">bucket</span>&nbsp;<span class="op" id="1541975">==</span>&nbsp;<span class="ident" id="1541978">it</span><span class="op" id="1541980">.</span><span class="ident" id="1541981">startBucket</span>&nbsp;<span class="op" id="1541993">&amp;&amp;</span>&nbsp;<span class="ident" id="1541996">it</span><span class="op" id="1541998">.</span><span class="ident" id="1541999">wrapped</span>&nbsp;<span class="op" id="1542007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542012">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542035">it</span><span class="op" id="1542037">.</span><span class="ident" id="1542038">key</span>&nbsp;<span class="op" id="1542042">=</span>&nbsp;<span class="ident" id="1542044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542051">it</span><span class="op" id="1542053">.</span><span class="ident" id="1542054">value</span>&nbsp;<span class="op" id="1542060">=</span>&nbsp;<span class="ident" id="1542062">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542069">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542082">if</span>&nbsp;<span class="ident" id="1542085">h</span><span class="op" id="1542086">.</span><span class="ident" id="1542087">oldbuckets</span>&nbsp;<span class="op" id="1542098">!=</span>&nbsp;<span class="ident" id="1542101">nil</span>&nbsp;<span class="op" id="1542105">&amp;&amp;</span>&nbsp;<span class="ident" id="1542108">it</span><span class="op" id="1542110">.</span><span class="ident" id="1542111">B</span>&nbsp;<span class="op" id="1542113">==</span>&nbsp;<span class="ident" id="1542116">h</span><span class="op" id="1542117">.</span><span class="ident" id="1542118">B</span>&nbsp;<span class="op" id="1542120">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542125">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542206">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542283">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542359">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542435">oldbucket</span>&nbsp;<span class="op" id="1542445">:=</span>&nbsp;<span class="ident" id="1542448">bucket</span>&nbsp;<span class="op" id="1542455">&amp;</span>&nbsp;<span class="op" id="1542457">(</span><span class="builtintype" id="1542458">uintptr</span><span class="op" id="1542465">(</span><span class="num" id="1542466">1</span><span class="op" id="1542467">)</span><span class="op" id="1542468">&lt;&lt;</span><span class="op" id="1542470">(</span><span class="ident" id="1542471">it</span><span class="op" id="1542473">.</span><span class="ident" id="1542474">B</span><span class="op" id="1542475">-</span><span class="num" id="1542476">1</span><span class="op" id="1542477">)</span>&nbsp;<span class="op" id="1542479">-</span>&nbsp;<span class="num" id="1542481">1</span><span class="op" id="1542482">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542487">b</span>&nbsp;<span class="op" id="1542489">=</span>&nbsp;<span class="op" id="1542491">(</span><span class="op" id="1542492">*</span><span class="ident" id="1542493">bmap</span><span class="op" id="1542497">)</span><span class="op" id="1542498">(</span><span class="ident" id="1542499">add</span><span class="op" id="1542502">(</span><span class="ident" id="1542503">h</span><span class="op" id="1542504">.</span><span class="ident" id="1542505">oldbuckets</span><span class="op" id="1542515">,</span>&nbsp;<span class="ident" id="1542517">oldbucket</span><span class="op" id="1542526">*</span><span class="builtintype" id="1542527">uintptr</span><span class="op" id="1542534">(</span><span class="ident" id="1542535">t</span><span class="op" id="1542536">.</span><span class="ident" id="1542537">bucketsize</span><span class="op" id="1542547">)</span><span class="op" id="1542548">)</span><span class="op" id="1542549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542554">if</span>&nbsp;<span class="op" id="1542557">!</span><span class="ident" id="1542558">evacuated</span><span class="op" id="1542567">(</span><span class="ident" id="1542568">b</span><span class="op" id="1542569">)</span>&nbsp;<span class="op" id="1542571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542577">checkBucket</span>&nbsp;<span class="op" id="1542589">=</span>&nbsp;<span class="ident" id="1542591">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542601">}</span>&nbsp;<span class="keyword" id="1542603">else</span>&nbsp;<span class="op" id="1542608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542614">b</span>&nbsp;<span class="op" id="1542616">=</span>&nbsp;<span class="op" id="1542618">(</span><span class="op" id="1542619">*</span><span class="ident" id="1542620">bmap</span><span class="op" id="1542624">)</span><span class="op" id="1542625">(</span><span class="ident" id="1542626">add</span><span class="op" id="1542629">(</span><span class="ident" id="1542630">it</span><span class="op" id="1542632">.</span><span class="ident" id="1542633">buckets</span><span class="op" id="1542640">,</span>&nbsp;<span class="ident" id="1542642">bucket</span><span class="op" id="1542648">*</span><span class="builtintype" id="1542649">uintptr</span><span class="op" id="1542656">(</span><span class="ident" id="1542657">t</span><span class="op" id="1542658">.</span><span class="ident" id="1542659">bucketsize</span><span class="op" id="1542669">)</span><span class="op" id="1542670">)</span><span class="op" id="1542671">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542677">checkBucket</span>&nbsp;<span class="op" id="1542689">=</span>&nbsp;<span class="ident" id="1542691">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542706">}</span>&nbsp;<span class="keyword" id="1542708">else</span>&nbsp;<span class="op" id="1542713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542718">b</span>&nbsp;<span class="op" id="1542720">=</span>&nbsp;<span class="op" id="1542722">(</span><span class="op" id="1542723">*</span><span class="ident" id="1542724">bmap</span><span class="op" id="1542728">)</span><span class="op" id="1542729">(</span><span class="ident" id="1542730">add</span><span class="op" id="1542733">(</span><span class="ident" id="1542734">it</span><span class="op" id="1542736">.</span><span class="ident" id="1542737">buckets</span><span class="op" id="1542744">,</span>&nbsp;<span class="ident" id="1542746">bucket</span><span class="op" id="1542752">*</span><span class="builtintype" id="1542753">uintptr</span><span class="op" id="1542760">(</span><span class="ident" id="1542761">t</span><span class="op" id="1542762">.</span><span class="ident" id="1542763">bucketsize</span><span class="op" id="1542773">)</span><span class="op" id="1542774">)</span><span class="op" id="1542775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542780">checkBucket</span>&nbsp;<span class="op" id="1542792">=</span>&nbsp;<span class="ident" id="1542794">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542808">bucket</span><span class="op" id="1542814">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542819">if</span>&nbsp;<span class="ident" id="1542822">bucket</span>&nbsp;<span class="op" id="1542829">==</span>&nbsp;<span class="builtintype" id="1542832">uintptr</span><span class="op" id="1542839">(</span><span class="num" id="1542840">1</span><span class="op" id="1542841">)</span><span class="op" id="1542842">&lt;&lt;</span><span class="ident" id="1542844">it</span><span class="op" id="1542846">.</span><span class="ident" id="1542847">B</span>&nbsp;<span class="op" id="1542849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542854">bucket</span>&nbsp;<span class="op" id="1542861">=</span>&nbsp;<span class="num" id="1542863">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542868">it</span><span class="op" id="1542870">.</span><span class="ident" id="1542871">wrapped</span>&nbsp;<span class="op" id="1542879">=</span>&nbsp;<span class="builtintype" id="1542881">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542892">i</span>&nbsp;<span class="op" id="1542894">=</span>&nbsp;<span class="num" id="1542896">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542902">for</span>&nbsp;<span class="op" id="1542906">;</span>&nbsp;<span class="ident" id="1542908">i</span>&nbsp;<span class="op" id="1542910">&lt;</span>&nbsp;<span class="ident" id="1542912">bucketCnt</span><span class="op" id="1542921">;</span>&nbsp;<span class="ident" id="1542923">i</span><span class="op" id="1542924">++</span>&nbsp;<span class="op" id="1542927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542931">offi</span>&nbsp;<span class="op" id="1542936">:=</span>&nbsp;<span class="op" id="1542939">(</span><span class="ident" id="1542940">i</span>&nbsp;<span class="op" id="1542942">+</span>&nbsp;<span class="ident" id="1542944">it</span><span class="op" id="1542946">.</span><span class="ident" id="1542947">offset</span><span class="op" id="1542953">)</span>&nbsp;<span class="op" id="1542955">&amp;</span>&nbsp;<span class="op" id="1542957">(</span><span class="ident" id="1542958">bucketCnt</span>&nbsp;<span class="op" id="1542968">-</span>&nbsp;<span class="num" id="1542970">1</span><span class="op" id="1542971">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542975">k</span>&nbsp;<span class="op" id="1542977">:=</span>&nbsp;<span class="ident" id="1542980">add</span><span class="op" id="1542983">(</span><span class="ident" id="1542984">unsafe</span><span class="op" id="1542990">.</span><span class="ident" id="1542991">Pointer</span><span class="op" id="1542998">(</span><span class="ident" id="1542999">b</span><span class="op" id="1543000">)</span><span class="op" id="1543001">,</span>&nbsp;<span class="ident" id="1543003">dataOffset</span><span class="op" id="1543013">+</span><span class="builtintype" id="1543014">uintptr</span><span class="op" id="1543021">(</span><span class="ident" id="1543022">offi</span><span class="op" id="1543026">)</span><span class="op" id="1543027">*</span><span class="builtintype" id="1543028">uintptr</span><span class="op" id="1543035">(</span><span class="ident" id="1543036">t</span><span class="op" id="1543037">.</span><span class="ident" id="1543038">keysize</span><span class="op" id="1543045">)</span><span class="op" id="1543046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543050">v</span>&nbsp;<span class="op" id="1543052">:=</span>&nbsp;<span class="ident" id="1543055">add</span><span class="op" id="1543058">(</span><span class="ident" id="1543059">unsafe</span><span class="op" id="1543065">.</span><span class="ident" id="1543066">Pointer</span><span class="op" id="1543073">(</span><span class="ident" id="1543074">b</span><span class="op" id="1543075">)</span><span class="op" id="1543076">,</span>&nbsp;<span class="ident" id="1543078">dataOffset</span><span class="op" id="1543088">+</span><span class="ident" id="1543089">bucketCnt</span><span class="op" id="1543098">*</span><span class="builtintype" id="1543099">uintptr</span><span class="op" id="1543106">(</span><span class="ident" id="1543107">t</span><span class="op" id="1543108">.</span><span class="ident" id="1543109">keysize</span><span class="op" id="1543116">)</span><span class="op" id="1543117">+</span><span class="builtintype" id="1543118">uintptr</span><span class="op" id="1543125">(</span><span class="ident" id="1543126">offi</span><span class="op" id="1543130">)</span><span class="op" id="1543131">*</span><span class="builtintype" id="1543132">uintptr</span><span class="op" id="1543139">(</span><span class="ident" id="1543140">t</span><span class="op" id="1543141">.</span><span class="ident" id="1543142">valuesize</span><span class="op" id="1543151">)</span><span class="op" id="1543152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543156">if</span>&nbsp;<span class="ident" id="1543159">b</span><span class="op" id="1543160">.</span><span class="ident" id="1543161">tophash</span><span class="op" id="1543168">[</span><span class="ident" id="1543169">offi</span><span class="op" id="1543173">]</span>&nbsp;<span class="op" id="1543175">!=</span>&nbsp;<span class="ident" id="1543178">empty</span>&nbsp;<span class="op" id="1543184">&amp;&amp;</span>&nbsp;<span class="ident" id="1543187">b</span><span class="op" id="1543188">.</span><span class="ident" id="1543189">tophash</span><span class="op" id="1543196">[</span><span class="ident" id="1543197">offi</span><span class="op" id="1543201">]</span>&nbsp;<span class="op" id="1543203">!=</span>&nbsp;<span class="ident" id="1543206">evacuatedEmpty</span>&nbsp;<span class="op" id="1543221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543226">if</span>&nbsp;<span class="ident" id="1543229">checkBucket</span>&nbsp;<span class="op" id="1543241">!=</span>&nbsp;<span class="ident" id="1543244">noCheck</span>&nbsp;<span class="op" id="1543252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543258">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543322">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543384">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543453">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543518">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543579">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543641">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543672">k2</span>&nbsp;<span class="op" id="1543675">:=</span>&nbsp;<span class="ident" id="1543678">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543684">if</span>&nbsp;<span class="ident" id="1543687">t</span><span class="op" id="1543688">.</span><span class="ident" id="1543689">indirectkey</span>&nbsp;<span class="op" id="1543701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543708">k2</span>&nbsp;<span class="op" id="1543711">=</span>&nbsp;<span class="op" id="1543713">*</span><span class="op" id="1543714">(</span><span class="op" id="1543715">(</span><span class="op" id="1543716">*</span><span class="ident" id="1543717">unsafe</span><span class="op" id="1543723">.</span><span class="ident" id="1543724">Pointer</span><span class="op" id="1543731">)</span><span class="op" id="1543732">(</span><span class="ident" id="1543733">k2</span><span class="op" id="1543735">)</span><span class="op" id="1543736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543742">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543748">if</span>&nbsp;<span class="ident" id="1543751">alg</span><span class="op" id="1543754">.</span><span class="ident" id="1543755">equal</span><span class="op" id="1543760">(</span><span class="ident" id="1543761">k2</span><span class="op" id="1543763">,</span>&nbsp;<span class="ident" id="1543765">k2</span><span class="op" id="1543767">,</span>&nbsp;<span class="builtintype" id="1543769">uintptr</span><span class="op" id="1543776">(</span><span class="ident" id="1543777">t</span><span class="op" id="1543778">.</span><span class="ident" id="1543779">key</span><span class="op" id="1543782">.</span><span class="ident" id="1543783">size</span><span class="op" id="1543787">)</span><span class="op" id="1543788">)</span>&nbsp;<span class="op" id="1543790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543797">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543854">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543912">hash</span>&nbsp;<span class="op" id="1543917">:=</span>&nbsp;<span class="ident" id="1543920">alg</span><span class="op" id="1543923">.</span><span class="ident" id="1543924">hash</span><span class="op" id="1543928">(</span><span class="ident" id="1543929">k2</span><span class="op" id="1543931">,</span>&nbsp;<span class="builtintype" id="1543933">uintptr</span><span class="op" id="1543940">(</span><span class="ident" id="1543941">t</span><span class="op" id="1543942">.</span><span class="ident" id="1543943">key</span><span class="op" id="1543946">.</span><span class="ident" id="1543947">size</span><span class="op" id="1543951">)</span><span class="op" id="1543952">,</span>&nbsp;<span class="builtintype" id="1543954">uintptr</span><span class="op" id="1543961">(</span><span class="ident" id="1543962">h</span><span class="op" id="1543963">.</span><span class="ident" id="1543964">hash0</span><span class="op" id="1543969">)</span><span class="op" id="1543970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543977">if</span>&nbsp;<span class="ident" id="1543980">hash</span><span class="op" id="1543984">&amp;</span><span class="op" id="1543985">(</span><span class="builtintype" id="1543986">uintptr</span><span class="op" id="1543993">(</span><span class="num" id="1543994">1</span><span class="op" id="1543995">)</span><span class="op" id="1543996">&lt;&lt;</span><span class="ident" id="1543998">it</span><span class="op" id="1544000">.</span><span class="ident" id="1544001">B</span><span class="op" id="1544002">-</span><span class="num" id="1544003">1</span><span class="op" id="1544004">)</span>&nbsp;<span class="op" id="1544006">!=</span>&nbsp;<span class="ident" id="1544009">checkBucket</span>&nbsp;<span class="op" id="1544021">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544029">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544049">}</span>&nbsp;<span class="keyword" id="1544051">else</span>&nbsp;<span class="op" id="1544056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544063">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544122">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544181">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544240">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544292">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544352">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544410">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544433">if</span>&nbsp;<span class="ident" id="1544436">checkBucket</span><span class="op" id="1544447">&gt;&gt;</span><span class="op" id="1544449">(</span><span class="ident" id="1544450">it</span><span class="op" id="1544452">.</span><span class="ident" id="1544453">B</span><span class="op" id="1544454">-</span><span class="num" id="1544455">1</span><span class="op" id="1544456">)</span>&nbsp;<span class="op" id="1544458">!=</span>&nbsp;<span class="builtintype" id="1544461">uintptr</span><span class="op" id="1544468">(</span><span class="ident" id="1544469">b</span><span class="op" id="1544470">.</span><span class="ident" id="1544471">tophash</span><span class="op" id="1544478">[</span><span class="ident" id="1544479">offi</span><span class="op" id="1544483">]</span><span class="op" id="1544484">&amp;</span><span class="num" id="1544485">1</span><span class="op" id="1544486">)</span>&nbsp;<span class="op" id="1544488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544496">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544521">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544526">if</span>&nbsp;<span class="ident" id="1544529">b</span><span class="op" id="1544530">.</span><span class="ident" id="1544531">tophash</span><span class="op" id="1544538">[</span><span class="ident" id="1544539">offi</span><span class="op" id="1544543">]</span>&nbsp;<span class="op" id="1544545">!=</span>&nbsp;<span class="ident" id="1544548">evacuatedX</span>&nbsp;<span class="op" id="1544559">&amp;&amp;</span>&nbsp;<span class="ident" id="1544562">b</span><span class="op" id="1544563">.</span><span class="ident" id="1544564">tophash</span><span class="op" id="1544571">[</span><span class="ident" id="1544572">offi</span><span class="op" id="1544576">]</span>&nbsp;<span class="op" id="1544578">!=</span>&nbsp;<span class="ident" id="1544581">evacuatedY</span>&nbsp;<span class="op" id="1544592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544598">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544648">if</span>&nbsp;<span class="ident" id="1544651">t</span><span class="op" id="1544652">.</span><span class="ident" id="1544653">indirectkey</span>&nbsp;<span class="op" id="1544665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544672">k</span>&nbsp;<span class="op" id="1544674">=</span>&nbsp;<span class="op" id="1544676">*</span><span class="op" id="1544677">(</span><span class="op" id="1544678">(</span><span class="op" id="1544679">*</span><span class="ident" id="1544680">unsafe</span><span class="op" id="1544686">.</span><span class="ident" id="1544687">Pointer</span><span class="op" id="1544694">)</span><span class="op" id="1544695">(</span><span class="ident" id="1544696">k</span><span class="op" id="1544697">)</span><span class="op" id="1544698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544704">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544710">it</span><span class="op" id="1544712">.</span><span class="ident" id="1544713">key</span>&nbsp;<span class="op" id="1544717">=</span>&nbsp;<span class="ident" id="1544719">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544725">if</span>&nbsp;<span class="ident" id="1544728">t</span><span class="op" id="1544729">.</span><span class="ident" id="1544730">indirectvalue</span>&nbsp;<span class="op" id="1544744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544751">v</span>&nbsp;<span class="op" id="1544753">=</span>&nbsp;<span class="op" id="1544755">*</span><span class="op" id="1544756">(</span><span class="op" id="1544757">(</span><span class="op" id="1544758">*</span><span class="ident" id="1544759">unsafe</span><span class="op" id="1544765">.</span><span class="ident" id="1544766">Pointer</span><span class="op" id="1544773">)</span><span class="op" id="1544774">(</span><span class="ident" id="1544775">v</span><span class="op" id="1544776">)</span><span class="op" id="1544777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544789">it</span><span class="op" id="1544791">.</span><span class="ident" id="1544792">value</span>&nbsp;<span class="op" id="1544798">=</span>&nbsp;<span class="ident" id="1544800">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544805">}</span>&nbsp;<span class="keyword" id="1544807">else</span>&nbsp;<span class="op" id="1544812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544818">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1544882">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544941">k2</span>&nbsp;<span class="op" id="1544944">:=</span>&nbsp;<span class="ident" id="1544947">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544953">if</span>&nbsp;<span class="ident" id="1544956">t</span><span class="op" id="1544957">.</span><span class="ident" id="1544958">indirectkey</span>&nbsp;<span class="op" id="1544970">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544977">k2</span>&nbsp;<span class="op" id="1544980">=</span>&nbsp;<span class="op" id="1544982">*</span><span class="op" id="1544983">(</span><span class="op" id="1544984">(</span><span class="op" id="1544985">*</span><span class="ident" id="1544986">unsafe</span><span class="op" id="1544992">.</span><span class="ident" id="1544993">Pointer</span><span class="op" id="1545000">)</span><span class="op" id="1545001">(</span><span class="ident" id="1545002">k2</span><span class="op" id="1545004">)</span><span class="op" id="1545005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545017">if</span>&nbsp;<span class="ident" id="1545020">alg</span><span class="op" id="1545023">.</span><span class="ident" id="1545024">equal</span><span class="op" id="1545029">(</span><span class="ident" id="1545030">k2</span><span class="op" id="1545032">,</span>&nbsp;<span class="ident" id="1545034">k2</span><span class="op" id="1545036">,</span>&nbsp;<span class="builtintype" id="1545038">uintptr</span><span class="op" id="1545045">(</span><span class="ident" id="1545046">t</span><span class="op" id="1545047">.</span><span class="ident" id="1545048">key</span><span class="op" id="1545051">.</span><span class="ident" id="1545052">size</span><span class="op" id="1545056">)</span><span class="op" id="1545057">)</span>&nbsp;<span class="op" id="1545059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545066">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545117">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545166">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545228">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545295">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545368">rk</span><span class="op" id="1545370">,</span>&nbsp;<span class="ident" id="1545372">rv</span>&nbsp;<span class="op" id="1545375">:=</span>&nbsp;<span class="ident" id="1545378">mapaccessK</span><span class="op" id="1545388">(</span><span class="ident" id="1545389">t</span><span class="op" id="1545390">,</span>&nbsp;<span class="ident" id="1545392">h</span><span class="op" id="1545393">,</span>&nbsp;<span class="ident" id="1545395">k2</span><span class="op" id="1545397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545404">if</span>&nbsp;<span class="ident" id="1545407">rk</span>&nbsp;<span class="op" id="1545410">==</span>&nbsp;<span class="ident" id="1545413">nil</span>&nbsp;<span class="op" id="1545417">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545425">continue</span>&nbsp;<span class="comment" id="1545434">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545470">it</span><span class="op" id="1545472">.</span><span class="ident" id="1545473">key</span>&nbsp;<span class="op" id="1545477">=</span>&nbsp;<span class="ident" id="1545479">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545487">it</span><span class="op" id="1545489">.</span><span class="ident" id="1545490">value</span>&nbsp;<span class="op" id="1545496">=</span>&nbsp;<span class="ident" id="1545498">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545505">}</span>&nbsp;<span class="keyword" id="1545507">else</span>&nbsp;<span class="op" id="1545512">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545519">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545574">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545635">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545688">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545731">it</span><span class="op" id="1545733">.</span><span class="ident" id="1545734">key</span>&nbsp;<span class="op" id="1545738">=</span>&nbsp;<span class="ident" id="1545740">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545748">if</span>&nbsp;<span class="ident" id="1545751">t</span><span class="op" id="1545752">.</span><span class="ident" id="1545753">indirectvalue</span>&nbsp;<span class="op" id="1545767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545775">v</span>&nbsp;<span class="op" id="1545777">=</span>&nbsp;<span class="op" id="1545779">*</span><span class="op" id="1545780">(</span><span class="op" id="1545781">(</span><span class="op" id="1545782">*</span><span class="ident" id="1545783">unsafe</span><span class="op" id="1545789">.</span><span class="ident" id="1545790">Pointer</span><span class="op" id="1545797">)</span><span class="op" id="1545798">(</span><span class="ident" id="1545799">v</span><span class="op" id="1545800">)</span><span class="op" id="1545801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545815">it</span><span class="op" id="1545817">.</span><span class="ident" id="1545818">value</span>&nbsp;<span class="op" id="1545824">=</span>&nbsp;<span class="ident" id="1545826">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545832">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545842">it</span><span class="op" id="1545844">.</span><span class="ident" id="1545845">bucket</span>&nbsp;<span class="op" id="1545852">=</span>&nbsp;<span class="ident" id="1545854">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545864">it</span><span class="op" id="1545866">.</span><span class="ident" id="1545867">bptr</span>&nbsp;<span class="op" id="1545872">=</span>&nbsp;<span class="ident" id="1545874">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545879">it</span><span class="op" id="1545881">.</span><span class="ident" id="1545882">i</span>&nbsp;<span class="op" id="1545884">=</span>&nbsp;<span class="ident" id="1545886">i</span>&nbsp;<span class="op" id="1545888">+</span>&nbsp;<span class="num" id="1545890">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545895">it</span><span class="op" id="1545897">.</span><span class="ident" id="1545898">checkBucket</span>&nbsp;<span class="op" id="1545910">=</span>&nbsp;<span class="ident" id="1545912">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545927">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545942">b</span>&nbsp;<span class="op" id="1545944">=</span>&nbsp;<span class="ident" id="1545946">b</span><span class="op" id="1545947">.</span><span class="ident" id="1545948">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545958">i</span>&nbsp;<span class="op" id="1545960">=</span>&nbsp;<span class="num" id="1545962">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545965">goto</span>&nbsp;<span class="ident" id="1545970">next</span><br>
<span class="lineno"></span><span class="op" id="1545975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1545978">func</span>&nbsp;<span class="ident" id="1545983">hashGrow</span><span class="op" id="1545991">(</span><span class="ident" id="1545992">t</span>&nbsp;<span class="op" id="1545994">*</span><span class="ident" id="1545995">maptype</span><span class="op" id="1546002">,</span>&nbsp;<span class="ident" id="1546004">h</span>&nbsp;<span class="op" id="1546006">*</span><span class="ident" id="1546007">hmap</span><span class="op" id="1546011">)</span>&nbsp;<span class="op" id="1546013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546016">if</span>&nbsp;<span class="ident" id="1546019">h</span><span class="op" id="1546020">.</span><span class="ident" id="1546021">oldbuckets</span>&nbsp;<span class="op" id="1546032">!=</span>&nbsp;<span class="ident" id="1546035">nil</span>&nbsp;<span class="op" id="1546039">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546043">gothrow</span><span class="op" id="1546050">(</span><span class="string" id="1546051">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1546080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546086">oldbuckets</span>&nbsp;<span class="op" id="1546097">:=</span>&nbsp;<span class="ident" id="1546100">h</span><span class="op" id="1546101">.</span><span class="ident" id="1546102">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546111">if</span>&nbsp;<span class="ident" id="1546114">checkgc</span>&nbsp;<span class="op" id="1546122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546126">memstats</span><span class="op" id="1546134">.</span><span class="ident" id="1546135">next_gc</span>&nbsp;<span class="op" id="1546143">=</span>&nbsp;<span class="ident" id="1546145">memstats</span><span class="op" id="1546153">.</span><span class="ident" id="1546154">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546169">newbuckets</span>&nbsp;<span class="op" id="1546180">:=</span>&nbsp;<span class="ident" id="1546183">newarray</span><span class="op" id="1546191">(</span><span class="ident" id="1546192">t</span><span class="op" id="1546193">.</span><span class="ident" id="1546194">bucket</span><span class="op" id="1546200">,</span>&nbsp;<span class="builtintype" id="1546202">uintptr</span><span class="op" id="1546209">(</span><span class="num" id="1546210">1</span><span class="op" id="1546211">)</span><span class="op" id="1546212">&lt;&lt;</span><span class="op" id="1546214">(</span><span class="ident" id="1546215">h</span><span class="op" id="1546216">.</span><span class="ident" id="1546217">B</span><span class="op" id="1546218">+</span><span class="num" id="1546219">1</span><span class="op" id="1546220">)</span><span class="op" id="1546221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546224">flags</span>&nbsp;<span class="op" id="1546230">:=</span>&nbsp;<span class="ident" id="1546233">h</span><span class="op" id="1546234">.</span><span class="ident" id="1546235">flags</span>&nbsp;<span class="op" id="1546241">&amp;^</span>&nbsp;<span class="op" id="1546244">(</span><span class="ident" id="1546245">iterator</span>&nbsp;<span class="op" id="1546254">|</span>&nbsp;<span class="ident" id="1546256">oldIterator</span><span class="op" id="1546267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546270">if</span>&nbsp;<span class="ident" id="1546273">h</span><span class="op" id="1546274">.</span><span class="ident" id="1546275">flags</span><span class="op" id="1546280">&amp;</span><span class="ident" id="1546281">iterator</span>&nbsp;<span class="op" id="1546290">!=</span>&nbsp;<span class="num" id="1546293">0</span>&nbsp;<span class="op" id="1546295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546299">flags</span>&nbsp;<span class="op" id="1546305">|=</span>&nbsp;<span class="ident" id="1546308">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546324">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546360">h</span><span class="op" id="1546361">.</span><span class="ident" id="1546362">B</span><span class="op" id="1546363">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546367">h</span><span class="op" id="1546368">.</span><span class="ident" id="1546369">flags</span>&nbsp;<span class="op" id="1546375">=</span>&nbsp;<span class="ident" id="1546377">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546384">h</span><span class="op" id="1546385">.</span><span class="ident" id="1546386">oldbuckets</span>&nbsp;<span class="op" id="1546397">=</span>&nbsp;<span class="ident" id="1546399">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546411">h</span><span class="op" id="1546412">.</span><span class="ident" id="1546413">buckets</span>&nbsp;<span class="op" id="1546421">=</span>&nbsp;<span class="ident" id="1546423">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546435">h</span><span class="op" id="1546436">.</span><span class="ident" id="1546437">nevacuate</span>&nbsp;<span class="op" id="1546447">=</span>&nbsp;<span class="num" id="1546449">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546453">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546521">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1546554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546557">func</span>&nbsp;<span class="ident" id="1546562">growWork</span><span class="op" id="1546570">(</span><span class="ident" id="1546571">t</span>&nbsp;<span class="op" id="1546573">*</span><span class="ident" id="1546574">maptype</span><span class="op" id="1546581">,</span>&nbsp;<span class="ident" id="1546583">h</span>&nbsp;<span class="op" id="1546585">*</span><span class="ident" id="1546586">hmap</span><span class="op" id="1546590">,</span>&nbsp;<span class="ident" id="1546592">bucket</span>&nbsp;<span class="builtintype" id="1546599">uintptr</span><span class="op" id="1546606">)</span>&nbsp;<span class="op" id="1546608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546611">noldbuckets</span>&nbsp;<span class="op" id="1546623">:=</span>&nbsp;<span class="builtintype" id="1546626">uintptr</span><span class="op" id="1546633">(</span><span class="num" id="1546634">1</span><span class="op" id="1546635">)</span>&nbsp;<span class="op" id="1546637">&lt;&lt;</span>&nbsp;<span class="op" id="1546640">(</span><span class="ident" id="1546641">h</span><span class="op" id="1546642">.</span><span class="ident" id="1546643">B</span>&nbsp;<span class="op" id="1546645">-</span>&nbsp;<span class="num" id="1546647">1</span><span class="op" id="1546648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546652">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546706">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546743">evacuate</span><span class="op" id="1546751">(</span><span class="ident" id="1546752">t</span><span class="op" id="1546753">,</span>&nbsp;<span class="ident" id="1546755">h</span><span class="op" id="1546756">,</span>&nbsp;<span class="ident" id="1546758">bucket</span><span class="op" id="1546764">&amp;</span><span class="op" id="1546765">(</span><span class="ident" id="1546766">noldbuckets</span><span class="op" id="1546777">-</span><span class="num" id="1546778">1</span><span class="op" id="1546779">)</span><span class="op" id="1546780">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546784">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546844">if</span>&nbsp;<span class="ident" id="1546847">h</span><span class="op" id="1546848">.</span><span class="ident" id="1546849">oldbuckets</span>&nbsp;<span class="op" id="1546860">!=</span>&nbsp;<span class="ident" id="1546863">nil</span>&nbsp;<span class="op" id="1546867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546871">evacuate</span><span class="op" id="1546879">(</span><span class="ident" id="1546880">t</span><span class="op" id="1546881">,</span>&nbsp;<span class="ident" id="1546883">h</span><span class="op" id="1546884">,</span>&nbsp;<span class="ident" id="1546886">h</span><span class="op" id="1546887">.</span><span class="ident" id="1546888">nevacuate</span><span class="op" id="1546897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546900">}</span><br>
<span class="lineno"></span><span class="op" id="1546902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1546905">func</span>&nbsp;<span class="ident" id="1546910">evacuate</span><span class="op" id="1546918">(</span><span class="ident" id="1546919">t</span>&nbsp;<span class="op" id="1546921">*</span><span class="ident" id="1546922">maptype</span><span class="op" id="1546929">,</span>&nbsp;<span class="ident" id="1546931">h</span>&nbsp;<span class="op" id="1546933">*</span><span class="ident" id="1546934">hmap</span><span class="op" id="1546938">,</span>&nbsp;<span class="ident" id="1546940">oldbucket</span>&nbsp;<span class="builtintype" id="1546950">uintptr</span><span class="op" id="1546957">)</span>&nbsp;<span class="op" id="1546959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546962">b</span>&nbsp;<span class="op" id="1546964">:=</span>&nbsp;<span class="op" id="1546967">(</span><span class="op" id="1546968">*</span><span class="ident" id="1546969">bmap</span><span class="op" id="1546973">)</span><span class="op" id="1546974">(</span><span class="ident" id="1546975">add</span><span class="op" id="1546978">(</span><span class="ident" id="1546979">h</span><span class="op" id="1546980">.</span><span class="ident" id="1546981">oldbuckets</span><span class="op" id="1546991">,</span>&nbsp;<span class="ident" id="1546993">oldbucket</span><span class="op" id="1547002">*</span><span class="builtintype" id="1547003">uintptr</span><span class="op" id="1547010">(</span><span class="ident" id="1547011">t</span><span class="op" id="1547012">.</span><span class="ident" id="1547013">bucketsize</span><span class="op" id="1547023">)</span><span class="op" id="1547024">)</span><span class="op" id="1547025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547028">newbit</span>&nbsp;<span class="op" id="1547035">:=</span>&nbsp;<span class="builtintype" id="1547038">uintptr</span><span class="op" id="1547045">(</span><span class="num" id="1547046">1</span><span class="op" id="1547047">)</span>&nbsp;<span class="op" id="1547049">&lt;&lt;</span>&nbsp;<span class="op" id="1547052">(</span><span class="ident" id="1547053">h</span><span class="op" id="1547054">.</span><span class="ident" id="1547055">B</span>&nbsp;<span class="op" id="1547057">-</span>&nbsp;<span class="num" id="1547059">1</span><span class="op" id="1547060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547063">alg</span>&nbsp;<span class="op" id="1547067">:=</span>&nbsp;<span class="ident" id="1547070">goalg</span><span class="op" id="1547075">(</span><span class="ident" id="1547076">t</span><span class="op" id="1547077">.</span><span class="ident" id="1547078">key</span><span class="op" id="1547081">.</span><span class="ident" id="1547082">alg</span><span class="op" id="1547085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547088">if</span>&nbsp;<span class="op" id="1547091">!</span><span class="ident" id="1547092">evacuated</span><span class="op" id="1547101">(</span><span class="ident" id="1547102">b</span><span class="op" id="1547103">)</span>&nbsp;<span class="op" id="1547105">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547109">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547179">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547243">x</span>&nbsp;<span class="op" id="1547245">:=</span>&nbsp;<span class="op" id="1547248">(</span><span class="op" id="1547249">*</span><span class="ident" id="1547250">bmap</span><span class="op" id="1547254">)</span><span class="op" id="1547255">(</span><span class="ident" id="1547256">add</span><span class="op" id="1547259">(</span><span class="ident" id="1547260">h</span><span class="op" id="1547261">.</span><span class="ident" id="1547262">buckets</span><span class="op" id="1547269">,</span>&nbsp;<span class="ident" id="1547271">oldbucket</span><span class="op" id="1547280">*</span><span class="builtintype" id="1547281">uintptr</span><span class="op" id="1547288">(</span><span class="ident" id="1547289">t</span><span class="op" id="1547290">.</span><span class="ident" id="1547291">bucketsize</span><span class="op" id="1547301">)</span><span class="op" id="1547302">)</span><span class="op" id="1547303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547307">y</span>&nbsp;<span class="op" id="1547309">:=</span>&nbsp;<span class="op" id="1547312">(</span><span class="op" id="1547313">*</span><span class="ident" id="1547314">bmap</span><span class="op" id="1547318">)</span><span class="op" id="1547319">(</span><span class="ident" id="1547320">add</span><span class="op" id="1547323">(</span><span class="ident" id="1547324">h</span><span class="op" id="1547325">.</span><span class="ident" id="1547326">buckets</span><span class="op" id="1547333">,</span>&nbsp;<span class="op" id="1547335">(</span><span class="ident" id="1547336">oldbucket</span><span class="op" id="1547345">+</span><span class="ident" id="1547346">newbit</span><span class="op" id="1547352">)</span><span class="op" id="1547353">*</span><span class="builtintype" id="1547354">uintptr</span><span class="op" id="1547361">(</span><span class="ident" id="1547362">t</span><span class="op" id="1547363">.</span><span class="ident" id="1547364">bucketsize</span><span class="op" id="1547374">)</span><span class="op" id="1547375">)</span><span class="op" id="1547376">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547380">xi</span>&nbsp;<span class="op" id="1547383">:=</span>&nbsp;<span class="num" id="1547386">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547390">yi</span>&nbsp;<span class="op" id="1547393">:=</span>&nbsp;<span class="num" id="1547396">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547400">xk</span>&nbsp;<span class="op" id="1547403">:=</span>&nbsp;<span class="ident" id="1547406">add</span><span class="op" id="1547409">(</span><span class="ident" id="1547410">unsafe</span><span class="op" id="1547416">.</span><span class="ident" id="1547417">Pointer</span><span class="op" id="1547424">(</span><span class="ident" id="1547425">x</span><span class="op" id="1547426">)</span><span class="op" id="1547427">,</span>&nbsp;<span class="ident" id="1547429">dataOffset</span><span class="op" id="1547439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547443">yk</span>&nbsp;<span class="op" id="1547446">:=</span>&nbsp;<span class="ident" id="1547449">add</span><span class="op" id="1547452">(</span><span class="ident" id="1547453">unsafe</span><span class="op" id="1547459">.</span><span class="ident" id="1547460">Pointer</span><span class="op" id="1547467">(</span><span class="ident" id="1547468">y</span><span class="op" id="1547469">)</span><span class="op" id="1547470">,</span>&nbsp;<span class="ident" id="1547472">dataOffset</span><span class="op" id="1547482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547486">xv</span>&nbsp;<span class="op" id="1547489">:=</span>&nbsp;<span class="ident" id="1547492">add</span><span class="op" id="1547495">(</span><span class="ident" id="1547496">xk</span><span class="op" id="1547498">,</span>&nbsp;<span class="ident" id="1547500">bucketCnt</span><span class="op" id="1547509">*</span><span class="builtintype" id="1547510">uintptr</span><span class="op" id="1547517">(</span><span class="ident" id="1547518">t</span><span class="op" id="1547519">.</span><span class="ident" id="1547520">keysize</span><span class="op" id="1547527">)</span><span class="op" id="1547528">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547532">yv</span>&nbsp;<span class="op" id="1547535">:=</span>&nbsp;<span class="ident" id="1547538">add</span><span class="op" id="1547541">(</span><span class="ident" id="1547542">yk</span><span class="op" id="1547544">,</span>&nbsp;<span class="ident" id="1547546">bucketCnt</span><span class="op" id="1547555">*</span><span class="builtintype" id="1547556">uintptr</span><span class="op" id="1547563">(</span><span class="ident" id="1547564">t</span><span class="op" id="1547565">.</span><span class="ident" id="1547566">keysize</span><span class="op" id="1547573">)</span><span class="op" id="1547574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547578">for</span>&nbsp;<span class="op" id="1547582">;</span>&nbsp;<span class="ident" id="1547584">b</span>&nbsp;<span class="op" id="1547586">!=</span>&nbsp;<span class="ident" id="1547589">nil</span><span class="op" id="1547592">;</span>&nbsp;<span class="ident" id="1547594">b</span>&nbsp;<span class="op" id="1547596">=</span>&nbsp;<span class="ident" id="1547598">b</span><span class="op" id="1547599">.</span><span class="ident" id="1547600">overflow</span>&nbsp;<span class="op" id="1547609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547614">k</span>&nbsp;<span class="op" id="1547616">:=</span>&nbsp;<span class="ident" id="1547619">add</span><span class="op" id="1547622">(</span><span class="ident" id="1547623">unsafe</span><span class="op" id="1547629">.</span><span class="ident" id="1547630">Pointer</span><span class="op" id="1547637">(</span><span class="ident" id="1547638">b</span><span class="op" id="1547639">)</span><span class="op" id="1547640">,</span>&nbsp;<span class="ident" id="1547642">dataOffset</span><span class="op" id="1547652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547657">v</span>&nbsp;<span class="op" id="1547659">:=</span>&nbsp;<span class="ident" id="1547662">add</span><span class="op" id="1547665">(</span><span class="ident" id="1547666">k</span><span class="op" id="1547667">,</span>&nbsp;<span class="ident" id="1547669">bucketCnt</span><span class="op" id="1547678">*</span><span class="builtintype" id="1547679">uintptr</span><span class="op" id="1547686">(</span><span class="ident" id="1547687">t</span><span class="op" id="1547688">.</span><span class="ident" id="1547689">keysize</span><span class="op" id="1547696">)</span><span class="op" id="1547697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547702">for</span>&nbsp;<span class="ident" id="1547706">i</span>&nbsp;<span class="op" id="1547708">:=</span>&nbsp;<span class="num" id="1547711">0</span><span class="op" id="1547712">;</span>&nbsp;<span class="ident" id="1547714">i</span>&nbsp;<span class="op" id="1547716">&lt;</span>&nbsp;<span class="ident" id="1547718">bucketCnt</span><span class="op" id="1547727">;</span>&nbsp;<span class="ident" id="1547729">i</span><span class="op" id="1547730">,</span>&nbsp;<span class="ident" id="1547732">k</span><span class="op" id="1547733">,</span>&nbsp;<span class="ident" id="1547735">v</span>&nbsp;<span class="op" id="1547737">=</span>&nbsp;<span class="ident" id="1547739">i</span><span class="op" id="1547740">+</span><span class="num" id="1547741">1</span><span class="op" id="1547742">,</span>&nbsp;<span class="ident" id="1547744">add</span><span class="op" id="1547747">(</span><span class="ident" id="1547748">k</span><span class="op" id="1547749">,</span>&nbsp;<span class="builtintype" id="1547751">uintptr</span><span class="op" id="1547758">(</span><span class="ident" id="1547759">t</span><span class="op" id="1547760">.</span><span class="ident" id="1547761">keysize</span><span class="op" id="1547768">)</span><span class="op" id="1547769">)</span><span class="op" id="1547770">,</span>&nbsp;<span class="ident" id="1547772">add</span><span class="op" id="1547775">(</span><span class="ident" id="1547776">v</span><span class="op" id="1547777">,</span>&nbsp;<span class="builtintype" id="1547779">uintptr</span><span class="op" id="1547786">(</span><span class="ident" id="1547787">t</span><span class="op" id="1547788">.</span><span class="ident" id="1547789">valuesize</span><span class="op" id="1547798">)</span><span class="op" id="1547799">)</span>&nbsp;<span class="op" id="1547801">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547807">top</span>&nbsp;<span class="op" id="1547811">:=</span>&nbsp;<span class="ident" id="1547814">b</span><span class="op" id="1547815">.</span><span class="ident" id="1547816">tophash</span><span class="op" id="1547823">[</span><span class="ident" id="1547824">i</span><span class="op" id="1547825">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547831">if</span>&nbsp;<span class="ident" id="1547834">top</span>&nbsp;<span class="op" id="1547838">==</span>&nbsp;<span class="ident" id="1547841">empty</span>&nbsp;<span class="op" id="1547847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547854">b</span><span class="op" id="1547855">.</span><span class="ident" id="1547856">tophash</span><span class="op" id="1547863">[</span><span class="ident" id="1547864">i</span><span class="op" id="1547865">]</span>&nbsp;<span class="op" id="1547867">=</span>&nbsp;<span class="ident" id="1547869">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547889">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547902">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547908">if</span>&nbsp;<span class="ident" id="1547911">top</span>&nbsp;<span class="op" id="1547915">&lt;</span>&nbsp;<span class="ident" id="1547917">minTopHash</span>&nbsp;<span class="op" id="1547928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547935">gothrow</span><span class="op" id="1547942">(</span><span class="string" id="1547943">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1547958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547970">k2</span>&nbsp;<span class="op" id="1547973">:=</span>&nbsp;<span class="ident" id="1547976">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547982">if</span>&nbsp;<span class="ident" id="1547985">t</span><span class="op" id="1547986">.</span><span class="ident" id="1547987">indirectkey</span>&nbsp;<span class="op" id="1547999">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548006">k2</span>&nbsp;<span class="op" id="1548009">=</span>&nbsp;<span class="op" id="1548011">*</span><span class="op" id="1548012">(</span><span class="op" id="1548013">(</span><span class="op" id="1548014">*</span><span class="ident" id="1548015">unsafe</span><span class="op" id="1548021">.</span><span class="ident" id="1548022">Pointer</span><span class="op" id="1548029">)</span><span class="op" id="1548030">(</span><span class="ident" id="1548031">k2</span><span class="op" id="1548033">)</span><span class="op" id="1548034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548046">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548115">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548171">hash</span>&nbsp;<span class="op" id="1548176">:=</span>&nbsp;<span class="ident" id="1548179">alg</span><span class="op" id="1548182">.</span><span class="ident" id="1548183">hash</span><span class="op" id="1548187">(</span><span class="ident" id="1548188">k2</span><span class="op" id="1548190">,</span>&nbsp;<span class="builtintype" id="1548192">uintptr</span><span class="op" id="1548199">(</span><span class="ident" id="1548200">t</span><span class="op" id="1548201">.</span><span class="ident" id="1548202">key</span><span class="op" id="1548205">.</span><span class="ident" id="1548206">size</span><span class="op" id="1548210">)</span><span class="op" id="1548211">,</span>&nbsp;<span class="builtintype" id="1548213">uintptr</span><span class="op" id="1548220">(</span><span class="ident" id="1548221">h</span><span class="op" id="1548222">.</span><span class="ident" id="1548223">hash0</span><span class="op" id="1548228">)</span><span class="op" id="1548229">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548235">if</span>&nbsp;<span class="ident" id="1548238">h</span><span class="op" id="1548239">.</span><span class="ident" id="1548240">flags</span><span class="op" id="1548245">&amp;</span><span class="ident" id="1548246">iterator</span>&nbsp;<span class="op" id="1548255">!=</span>&nbsp;<span class="num" id="1548258">0</span>&nbsp;<span class="op" id="1548260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548267">if</span>&nbsp;<span class="op" id="1548270">!</span><span class="ident" id="1548271">alg</span><span class="op" id="1548274">.</span><span class="ident" id="1548275">equal</span><span class="op" id="1548280">(</span><span class="ident" id="1548281">k2</span><span class="op" id="1548283">,</span>&nbsp;<span class="ident" id="1548285">k2</span><span class="op" id="1548287">,</span>&nbsp;<span class="builtintype" id="1548289">uintptr</span><span class="op" id="1548296">(</span><span class="ident" id="1548297">t</span><span class="op" id="1548298">.</span><span class="ident" id="1548299">key</span><span class="op" id="1548302">.</span><span class="ident" id="1548303">size</span><span class="op" id="1548307">)</span><span class="op" id="1548308">)</span>&nbsp;<span class="op" id="1548310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548318">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548386">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548453">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548521">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548585">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548637">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548705">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548774">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548844">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548909">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548976">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549007">if</span>&nbsp;<span class="op" id="1549010">(</span><span class="ident" id="1549011">top</span>&nbsp;<span class="op" id="1549015">&amp;</span>&nbsp;<span class="num" id="1549017">1</span><span class="op" id="1549018">)</span>&nbsp;<span class="op" id="1549020">!=</span>&nbsp;<span class="num" id="1549023">0</span>&nbsp;<span class="op" id="1549025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549034">hash</span>&nbsp;<span class="op" id="1549039">|=</span>&nbsp;<span class="ident" id="1549042">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549055">}</span>&nbsp;<span class="keyword" id="1549057">else</span>&nbsp;<span class="op" id="1549062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549071">hash</span>&nbsp;<span class="op" id="1549076">&amp;^=</span>&nbsp;<span class="ident" id="1549080">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549101">top</span>&nbsp;<span class="op" id="1549105">=</span>&nbsp;<span class="builtintype" id="1549107">uint8</span><span class="op" id="1549112">(</span><span class="ident" id="1549113">hash</span>&nbsp;<span class="op" id="1549118">&gt;&gt;</span>&nbsp;<span class="op" id="1549121">(</span><span class="ident" id="1549122">ptrSize</span><span class="op" id="1549129">*</span><span class="num" id="1549130">8</span>&nbsp;<span class="op" id="1549132">-</span>&nbsp;<span class="num" id="1549134">8</span><span class="op" id="1549135">)</span><span class="op" id="1549136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549144">if</span>&nbsp;<span class="ident" id="1549147">top</span>&nbsp;<span class="op" id="1549151">&lt;</span>&nbsp;<span class="ident" id="1549153">minTopHash</span>&nbsp;<span class="op" id="1549164">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549173">top</span>&nbsp;<span class="op" id="1549177">+=</span>&nbsp;<span class="ident" id="1549180">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549216">if</span>&nbsp;<span class="op" id="1549219">(</span><span class="ident" id="1549220">hash</span>&nbsp;<span class="op" id="1549225">&amp;</span>&nbsp;<span class="ident" id="1549227">newbit</span><span class="op" id="1549233">)</span>&nbsp;<span class="op" id="1549235">==</span>&nbsp;<span class="num" id="1549238">0</span>&nbsp;<span class="op" id="1549240">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549247">b</span><span class="op" id="1549248">.</span><span class="ident" id="1549249">tophash</span><span class="op" id="1549256">[</span><span class="ident" id="1549257">i</span><span class="op" id="1549258">]</span>&nbsp;<span class="op" id="1549260">=</span>&nbsp;<span class="ident" id="1549262">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549278">if</span>&nbsp;<span class="ident" id="1549281">xi</span>&nbsp;<span class="op" id="1549284">==</span>&nbsp;<span class="ident" id="1549287">bucketCnt</span>&nbsp;<span class="op" id="1549297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549305">if</span>&nbsp;<span class="ident" id="1549308">checkgc</span>&nbsp;<span class="op" id="1549316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549325">memstats</span><span class="op" id="1549333">.</span><span class="ident" id="1549334">next_gc</span>&nbsp;<span class="op" id="1549342">=</span>&nbsp;<span class="ident" id="1549344">memstats</span><span class="op" id="1549352">.</span><span class="ident" id="1549353">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549370">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549378">newx</span>&nbsp;<span class="op" id="1549383">:=</span>&nbsp;<span class="op" id="1549386">(</span><span class="op" id="1549387">*</span><span class="ident" id="1549388">bmap</span><span class="op" id="1549392">)</span><span class="op" id="1549393">(</span><span class="ident" id="1549394">newobject</span><span class="op" id="1549403">(</span><span class="ident" id="1549404">t</span><span class="op" id="1549405">.</span><span class="ident" id="1549406">bucket</span><span class="op" id="1549412">)</span><span class="op" id="1549413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549421">x</span><span class="op" id="1549422">.</span><span class="ident" id="1549423">overflow</span>&nbsp;<span class="op" id="1549432">=</span>&nbsp;<span class="ident" id="1549434">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549445">x</span>&nbsp;<span class="op" id="1549447">=</span>&nbsp;<span class="ident" id="1549449">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549460">xi</span>&nbsp;<span class="op" id="1549463">=</span>&nbsp;<span class="num" id="1549465">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549473">xk</span>&nbsp;<span class="op" id="1549476">=</span>&nbsp;<span class="ident" id="1549478">add</span><span class="op" id="1549481">(</span><span class="ident" id="1549482">unsafe</span><span class="op" id="1549488">.</span><span class="ident" id="1549489">Pointer</span><span class="op" id="1549496">(</span><span class="ident" id="1549497">x</span><span class="op" id="1549498">)</span><span class="op" id="1549499">,</span>&nbsp;<span class="ident" id="1549501">dataOffset</span><span class="op" id="1549511">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549519">xv</span>&nbsp;<span class="op" id="1549522">=</span>&nbsp;<span class="ident" id="1549524">add</span><span class="op" id="1549527">(</span><span class="ident" id="1549528">xk</span><span class="op" id="1549530">,</span>&nbsp;<span class="ident" id="1549532">bucketCnt</span><span class="op" id="1549541">*</span><span class="builtintype" id="1549542">uintptr</span><span class="op" id="1549549">(</span><span class="ident" id="1549550">t</span><span class="op" id="1549551">.</span><span class="ident" id="1549552">keysize</span><span class="op" id="1549559">)</span><span class="op" id="1549560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549574">x</span><span class="op" id="1549575">.</span><span class="ident" id="1549576">tophash</span><span class="op" id="1549583">[</span><span class="ident" id="1549584">xi</span><span class="op" id="1549586">]</span>&nbsp;<span class="op" id="1549588">=</span>&nbsp;<span class="ident" id="1549590">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549599">if</span>&nbsp;<span class="ident" id="1549602">t</span><span class="op" id="1549603">.</span><span class="ident" id="1549604">indirectkey</span>&nbsp;<span class="op" id="1549616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549624">*</span><span class="op" id="1549625">(</span><span class="op" id="1549626">*</span><span class="ident" id="1549627">unsafe</span><span class="op" id="1549633">.</span><span class="ident" id="1549634">Pointer</span><span class="op" id="1549641">)</span><span class="op" id="1549642">(</span><span class="ident" id="1549643">xk</span><span class="op" id="1549645">)</span>&nbsp;<span class="op" id="1549647">=</span>&nbsp;<span class="ident" id="1549649">k2</span>&nbsp;<span class="comment" id="1549652">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549673">}</span>&nbsp;<span class="keyword" id="1549675">else</span>&nbsp;<span class="op" id="1549680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549688">memmove</span><span class="op" id="1549695">(</span><span class="ident" id="1549696">xk</span><span class="op" id="1549698">,</span>&nbsp;<span class="ident" id="1549700">k</span><span class="op" id="1549701">,</span>&nbsp;<span class="builtintype" id="1549703">uintptr</span><span class="op" id="1549710">(</span><span class="ident" id="1549711">t</span><span class="op" id="1549712">.</span><span class="ident" id="1549713">key</span><span class="op" id="1549716">.</span><span class="ident" id="1549717">size</span><span class="op" id="1549721">)</span><span class="op" id="1549722">)</span>&nbsp;<span class="comment" id="1549724">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549750">if</span>&nbsp;<span class="ident" id="1549753">t</span><span class="op" id="1549754">.</span><span class="ident" id="1549755">indirectvalue</span>&nbsp;<span class="op" id="1549769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549777">*</span><span class="op" id="1549778">(</span><span class="op" id="1549779">*</span><span class="ident" id="1549780">unsafe</span><span class="op" id="1549786">.</span><span class="ident" id="1549787">Pointer</span><span class="op" id="1549794">)</span><span class="op" id="1549795">(</span><span class="ident" id="1549796">xv</span><span class="op" id="1549798">)</span>&nbsp;<span class="op" id="1549800">=</span>&nbsp;<span class="op" id="1549802">*</span><span class="op" id="1549803">(</span><span class="op" id="1549804">*</span><span class="ident" id="1549805">unsafe</span><span class="op" id="1549811">.</span><span class="ident" id="1549812">Pointer</span><span class="op" id="1549819">)</span><span class="op" id="1549820">(</span><span class="ident" id="1549821">v</span><span class="op" id="1549822">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549829">}</span>&nbsp;<span class="keyword" id="1549831">else</span>&nbsp;<span class="op" id="1549836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549844">memmove</span><span class="op" id="1549851">(</span><span class="ident" id="1549852">xv</span><span class="op" id="1549854">,</span>&nbsp;<span class="ident" id="1549856">v</span><span class="op" id="1549857">,</span>&nbsp;<span class="builtintype" id="1549859">uintptr</span><span class="op" id="1549866">(</span><span class="ident" id="1549867">t</span><span class="op" id="1549868">.</span><span class="ident" id="1549869">elem</span><span class="op" id="1549873">.</span><span class="ident" id="1549874">size</span><span class="op" id="1549878">)</span><span class="op" id="1549879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549893">xi</span><span class="op" id="1549895">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549903">xk</span>&nbsp;<span class="op" id="1549906">=</span>&nbsp;<span class="ident" id="1549908">add</span><span class="op" id="1549911">(</span><span class="ident" id="1549912">xk</span><span class="op" id="1549914">,</span>&nbsp;<span class="builtintype" id="1549916">uintptr</span><span class="op" id="1549923">(</span><span class="ident" id="1549924">t</span><span class="op" id="1549925">.</span><span class="ident" id="1549926">keysize</span><span class="op" id="1549933">)</span><span class="op" id="1549934">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549941">xv</span>&nbsp;<span class="op" id="1549944">=</span>&nbsp;<span class="ident" id="1549946">add</span><span class="op" id="1549949">(</span><span class="ident" id="1549950">xv</span><span class="op" id="1549952">,</span>&nbsp;<span class="builtintype" id="1549954">uintptr</span><span class="op" id="1549961">(</span><span class="ident" id="1549962">t</span><span class="op" id="1549963">.</span><span class="ident" id="1549964">valuesize</span><span class="op" id="1549973">)</span><span class="op" id="1549974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549980">}</span>&nbsp;<span class="keyword" id="1549982">else</span>&nbsp;<span class="op" id="1549987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549994">b</span><span class="op" id="1549995">.</span><span class="ident" id="1549996">tophash</span><span class="op" id="1550003">[</span><span class="ident" id="1550004">i</span><span class="op" id="1550005">]</span>&nbsp;<span class="op" id="1550007">=</span>&nbsp;<span class="ident" id="1550009">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550025">if</span>&nbsp;<span class="ident" id="1550028">yi</span>&nbsp;<span class="op" id="1550031">==</span>&nbsp;<span class="ident" id="1550034">bucketCnt</span>&nbsp;<span class="op" id="1550044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550052">if</span>&nbsp;<span class="ident" id="1550055">checkgc</span>&nbsp;<span class="op" id="1550063">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550072">memstats</span><span class="op" id="1550080">.</span><span class="ident" id="1550081">next_gc</span>&nbsp;<span class="op" id="1550089">=</span>&nbsp;<span class="ident" id="1550091">memstats</span><span class="op" id="1550099">.</span><span class="ident" id="1550100">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550125">newy</span>&nbsp;<span class="op" id="1550130">:=</span>&nbsp;<span class="op" id="1550133">(</span><span class="op" id="1550134">*</span><span class="ident" id="1550135">bmap</span><span class="op" id="1550139">)</span><span class="op" id="1550140">(</span><span class="ident" id="1550141">newobject</span><span class="op" id="1550150">(</span><span class="ident" id="1550151">t</span><span class="op" id="1550152">.</span><span class="ident" id="1550153">bucket</span><span class="op" id="1550159">)</span><span class="op" id="1550160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550168">y</span><span class="op" id="1550169">.</span><span class="ident" id="1550170">overflow</span>&nbsp;<span class="op" id="1550179">=</span>&nbsp;<span class="ident" id="1550181">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550192">y</span>&nbsp;<span class="op" id="1550194">=</span>&nbsp;<span class="ident" id="1550196">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550207">yi</span>&nbsp;<span class="op" id="1550210">=</span>&nbsp;<span class="num" id="1550212">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550220">yk</span>&nbsp;<span class="op" id="1550223">=</span>&nbsp;<span class="ident" id="1550225">add</span><span class="op" id="1550228">(</span><span class="ident" id="1550229">unsafe</span><span class="op" id="1550235">.</span><span class="ident" id="1550236">Pointer</span><span class="op" id="1550243">(</span><span class="ident" id="1550244">y</span><span class="op" id="1550245">)</span><span class="op" id="1550246">,</span>&nbsp;<span class="ident" id="1550248">dataOffset</span><span class="op" id="1550258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550266">yv</span>&nbsp;<span class="op" id="1550269">=</span>&nbsp;<span class="ident" id="1550271">add</span><span class="op" id="1550274">(</span><span class="ident" id="1550275">yk</span><span class="op" id="1550277">,</span>&nbsp;<span class="ident" id="1550279">bucketCnt</span><span class="op" id="1550288">*</span><span class="builtintype" id="1550289">uintptr</span><span class="op" id="1550296">(</span><span class="ident" id="1550297">t</span><span class="op" id="1550298">.</span><span class="ident" id="1550299">keysize</span><span class="op" id="1550306">)</span><span class="op" id="1550307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550321">y</span><span class="op" id="1550322">.</span><span class="ident" id="1550323">tophash</span><span class="op" id="1550330">[</span><span class="ident" id="1550331">yi</span><span class="op" id="1550333">]</span>&nbsp;<span class="op" id="1550335">=</span>&nbsp;<span class="ident" id="1550337">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550346">if</span>&nbsp;<span class="ident" id="1550349">t</span><span class="op" id="1550350">.</span><span class="ident" id="1550351">indirectkey</span>&nbsp;<span class="op" id="1550363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550371">*</span><span class="op" id="1550372">(</span><span class="op" id="1550373">*</span><span class="ident" id="1550374">unsafe</span><span class="op" id="1550380">.</span><span class="ident" id="1550381">Pointer</span><span class="op" id="1550388">)</span><span class="op" id="1550389">(</span><span class="ident" id="1550390">yk</span><span class="op" id="1550392">)</span>&nbsp;<span class="op" id="1550394">=</span>&nbsp;<span class="ident" id="1550396">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550404">}</span>&nbsp;<span class="keyword" id="1550406">else</span>&nbsp;<span class="op" id="1550411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550419">memmove</span><span class="op" id="1550426">(</span><span class="ident" id="1550427">yk</span><span class="op" id="1550429">,</span>&nbsp;<span class="ident" id="1550431">k</span><span class="op" id="1550432">,</span>&nbsp;<span class="builtintype" id="1550434">uintptr</span><span class="op" id="1550441">(</span><span class="ident" id="1550442">t</span><span class="op" id="1550443">.</span><span class="ident" id="1550444">key</span><span class="op" id="1550447">.</span><span class="ident" id="1550448">size</span><span class="op" id="1550452">)</span><span class="op" id="1550453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550460">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550467">if</span>&nbsp;<span class="ident" id="1550470">t</span><span class="op" id="1550471">.</span><span class="ident" id="1550472">indirectvalue</span>&nbsp;<span class="op" id="1550486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550494">*</span><span class="op" id="1550495">(</span><span class="op" id="1550496">*</span><span class="ident" id="1550497">unsafe</span><span class="op" id="1550503">.</span><span class="ident" id="1550504">Pointer</span><span class="op" id="1550511">)</span><span class="op" id="1550512">(</span><span class="ident" id="1550513">yv</span><span class="op" id="1550515">)</span>&nbsp;<span class="op" id="1550517">=</span>&nbsp;<span class="op" id="1550519">*</span><span class="op" id="1550520">(</span><span class="op" id="1550521">*</span><span class="ident" id="1550522">unsafe</span><span class="op" id="1550528">.</span><span class="ident" id="1550529">Pointer</span><span class="op" id="1550536">)</span><span class="op" id="1550537">(</span><span class="ident" id="1550538">v</span><span class="op" id="1550539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550546">}</span>&nbsp;<span class="keyword" id="1550548">else</span>&nbsp;<span class="op" id="1550553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550561">memmove</span><span class="op" id="1550568">(</span><span class="ident" id="1550569">yv</span><span class="op" id="1550571">,</span>&nbsp;<span class="ident" id="1550573">v</span><span class="op" id="1550574">,</span>&nbsp;<span class="builtintype" id="1550576">uintptr</span><span class="op" id="1550583">(</span><span class="ident" id="1550584">t</span><span class="op" id="1550585">.</span><span class="ident" id="1550586">elem</span><span class="op" id="1550590">.</span><span class="ident" id="1550591">size</span><span class="op" id="1550595">)</span><span class="op" id="1550596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550603">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550610">yi</span><span class="op" id="1550612">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550620">yk</span>&nbsp;<span class="op" id="1550623">=</span>&nbsp;<span class="ident" id="1550625">add</span><span class="op" id="1550628">(</span><span class="ident" id="1550629">yk</span><span class="op" id="1550631">,</span>&nbsp;<span class="builtintype" id="1550633">uintptr</span><span class="op" id="1550640">(</span><span class="ident" id="1550641">t</span><span class="op" id="1550642">.</span><span class="ident" id="1550643">keysize</span><span class="op" id="1550650">)</span><span class="op" id="1550651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550658">yv</span>&nbsp;<span class="op" id="1550661">=</span>&nbsp;<span class="ident" id="1550663">add</span><span class="op" id="1550666">(</span><span class="ident" id="1550667">yv</span><span class="op" id="1550669">,</span>&nbsp;<span class="builtintype" id="1550671">uintptr</span><span class="op" id="1550678">(</span><span class="ident" id="1550679">t</span><span class="op" id="1550680">.</span><span class="ident" id="1550681">valuesize</span><span class="op" id="1550690">)</span><span class="op" id="1550691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550702">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550710">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550773">if</span>&nbsp;<span class="ident" id="1550776">h</span><span class="op" id="1550777">.</span><span class="ident" id="1550778">flags</span><span class="op" id="1550783">&amp;</span><span class="ident" id="1550784">oldIterator</span>&nbsp;<span class="op" id="1550796">==</span>&nbsp;<span class="num" id="1550799">0</span>&nbsp;<span class="op" id="1550801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550806">b</span>&nbsp;<span class="op" id="1550808">=</span>&nbsp;<span class="op" id="1550810">(</span><span class="op" id="1550811">*</span><span class="ident" id="1550812">bmap</span><span class="op" id="1550816">)</span><span class="op" id="1550817">(</span><span class="ident" id="1550818">add</span><span class="op" id="1550821">(</span><span class="ident" id="1550822">h</span><span class="op" id="1550823">.</span><span class="ident" id="1550824">oldbuckets</span><span class="op" id="1550834">,</span>&nbsp;<span class="ident" id="1550836">oldbucket</span><span class="op" id="1550845">*</span><span class="builtintype" id="1550846">uintptr</span><span class="op" id="1550853">(</span><span class="ident" id="1550854">t</span><span class="op" id="1550855">.</span><span class="ident" id="1550856">bucketsize</span><span class="op" id="1550866">)</span><span class="op" id="1550867">)</span><span class="op" id="1550868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550873">b</span><span class="op" id="1550874">.</span><span class="ident" id="1550875">overflow</span>&nbsp;<span class="op" id="1550884">=</span>&nbsp;<span class="ident" id="1550886">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550893">memclr</span><span class="op" id="1550899">(</span><span class="ident" id="1550900">add</span><span class="op" id="1550903">(</span><span class="ident" id="1550904">unsafe</span><span class="op" id="1550910">.</span><span class="ident" id="1550911">Pointer</span><span class="op" id="1550918">(</span><span class="ident" id="1550919">b</span><span class="op" id="1550920">)</span><span class="op" id="1550921">,</span>&nbsp;<span class="ident" id="1550923">dataOffset</span><span class="op" id="1550933">)</span><span class="op" id="1550934">,</span>&nbsp;<span class="builtintype" id="1550936">uintptr</span><span class="op" id="1550943">(</span><span class="ident" id="1550944">t</span><span class="op" id="1550945">.</span><span class="ident" id="1550946">bucketsize</span><span class="op" id="1550956">)</span><span class="op" id="1550957">-</span><span class="ident" id="1550958">dataOffset</span><span class="op" id="1550968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550979">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551007">if</span>&nbsp;<span class="ident" id="1551010">oldbucket</span>&nbsp;<span class="op" id="1551020">==</span>&nbsp;<span class="ident" id="1551023">h</span><span class="op" id="1551024">.</span><span class="ident" id="1551025">nevacuate</span>&nbsp;<span class="op" id="1551035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551039">h</span><span class="op" id="1551040">.</span><span class="ident" id="1551041">nevacuate</span>&nbsp;<span class="op" id="1551051">=</span>&nbsp;<span class="ident" id="1551053">oldbucket</span>&nbsp;<span class="op" id="1551063">+</span>&nbsp;<span class="num" id="1551065">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551069">if</span>&nbsp;<span class="ident" id="1551072">oldbucket</span><span class="op" id="1551081">+</span><span class="num" id="1551082">1</span>&nbsp;<span class="op" id="1551084">==</span>&nbsp;<span class="ident" id="1551087">newbit</span>&nbsp;<span class="op" id="1551094">{</span>&nbsp;<span class="comment" id="1551096">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551128">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551184">h</span><span class="op" id="1551185">.</span><span class="ident" id="1551186">oldbuckets</span>&nbsp;<span class="op" id="1551197">=</span>&nbsp;<span class="ident" id="1551199">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551208">}</span><br>
<span class="lineno"></span><span class="op" id="1551210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1551213">func</span>&nbsp;<span class="ident" id="1551218">ismapkey</span><span class="op" id="1551226">(</span><span class="ident" id="1551227">t</span>&nbsp;<span class="op" id="1551229">*</span><span class="ident" id="1551230">_type</span><span class="op" id="1551235">)</span>&nbsp;<span class="builtintype" id="1551237">bool</span>&nbsp;<span class="op" id="1551242">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551245">return</span>&nbsp;<span class="ident" id="1551252">goalg</span><span class="op" id="1551257">(</span><span class="ident" id="1551258">t</span><span class="op" id="1551259">.</span><span class="ident" id="1551260">alg</span><span class="op" id="1551263">)</span><span class="op" id="1551264">.</span><span class="ident" id="1551265">hash</span>&nbsp;<span class="op" id="1551270">!=</span>&nbsp;<span class="ident" id="1551273">nil</span><br>
<span class="lineno"></span><span class="op" id="1551277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1551280">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1551331">func</span>&nbsp;<span class="ident" id="1551336">reflect_makemap</span><span class="op" id="1551351">(</span><span class="ident" id="1551352">t</span>&nbsp;<span class="op" id="1551354">*</span><span class="ident" id="1551355">maptype</span><span class="op" id="1551362">)</span>&nbsp;<span class="op" id="1551364">*</span><span class="ident" id="1551365">hmap</span>&nbsp;<span class="op" id="1551370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551373">return</span>&nbsp;<span class="ident" id="1551380">makemap</span><span class="op" id="1551387">(</span><span class="ident" id="1551388">t</span><span class="op" id="1551389">,</span>&nbsp;<span class="num" id="1551391">0</span><span class="op" id="1551392">)</span><br>
<span class="lineno"></span><span class="op" id="1551394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1551397">func</span>&nbsp;<span class="ident" id="1551402">reflect_mapaccess</span><span class="op" id="1551419">(</span><span class="ident" id="1551420">t</span>&nbsp;<span class="op" id="1551422">*</span><span class="ident" id="1551423">maptype</span><span class="op" id="1551430">,</span>&nbsp;<span class="ident" id="1551432">h</span>&nbsp;<span class="op" id="1551434">*</span><span class="ident" id="1551435">hmap</span><span class="op" id="1551439">,</span>&nbsp;<span class="ident" id="1551441">key</span>&nbsp;<span class="ident" id="1551445">unsafe</span><span class="op" id="1551451">.</span><span class="ident" id="1551452">Pointer</span><span class="op" id="1551459">)</span>&nbsp;<span class="ident" id="1551461">unsafe</span><span class="op" id="1551467">.</span><span class="ident" id="1551468">Pointer</span>&nbsp;<span class="op" id="1551476">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551479">val</span><span class="op" id="1551482">,</span>&nbsp;<span class="ident" id="1551484">ok</span>&nbsp;<span class="op" id="1551487">:=</span>&nbsp;<span class="ident" id="1551490">mapaccess2</span><span class="op" id="1551500">(</span><span class="ident" id="1551501">t</span><span class="op" id="1551502">,</span>&nbsp;<span class="ident" id="1551504">h</span><span class="op" id="1551505">,</span>&nbsp;<span class="ident" id="1551507">key</span><span class="op" id="1551510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551513">if</span>&nbsp;<span class="op" id="1551516">!</span><span class="ident" id="1551517">ok</span>&nbsp;<span class="op" id="1551520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551524">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551569">val</span>&nbsp;<span class="op" id="1551573">=</span>&nbsp;<span class="ident" id="1551575">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551580">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551583">return</span>&nbsp;<span class="ident" id="1551590">val</span><br>
<span class="lineno"></span><span class="op" id="1551594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1551597">func</span>&nbsp;<span class="ident" id="1551602">reflect_mapassign</span><span class="op" id="1551619">(</span><span class="ident" id="1551620">t</span>&nbsp;<span class="op" id="1551622">*</span><span class="ident" id="1551623">maptype</span><span class="op" id="1551630">,</span>&nbsp;<span class="ident" id="1551632">h</span>&nbsp;<span class="op" id="1551634">*</span><span class="ident" id="1551635">hmap</span><span class="op" id="1551639">,</span>&nbsp;<span class="ident" id="1551641">key</span>&nbsp;<span class="ident" id="1551645">unsafe</span><span class="op" id="1551651">.</span><span class="ident" id="1551652">Pointer</span><span class="op" id="1551659">,</span>&nbsp;<span class="ident" id="1551661">val</span>&nbsp;<span class="ident" id="1551665">unsafe</span><span class="op" id="1551671">.</span><span class="ident" id="1551672">Pointer</span><span class="op" id="1551679">)</span>&nbsp;<span class="op" id="1551681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551684">mapassign1</span><span class="op" id="1551694">(</span><span class="ident" id="1551695">t</span><span class="op" id="1551696">,</span>&nbsp;<span class="ident" id="1551698">h</span><span class="op" id="1551699">,</span>&nbsp;<span class="ident" id="1551701">key</span><span class="op" id="1551704">,</span>&nbsp;<span class="ident" id="1551706">val</span><span class="op" id="1551709">)</span><br>
<span class="lineno">920</span><span class="op" id="1551711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1551714">func</span>&nbsp;<span class="ident" id="1551719">reflect_mapdelete</span><span class="op" id="1551736">(</span><span class="ident" id="1551737">t</span>&nbsp;<span class="op" id="1551739">*</span><span class="ident" id="1551740">maptype</span><span class="op" id="1551747">,</span>&nbsp;<span class="ident" id="1551749">h</span>&nbsp;<span class="op" id="1551751">*</span><span class="ident" id="1551752">hmap</span><span class="op" id="1551756">,</span>&nbsp;<span class="ident" id="1551758">key</span>&nbsp;<span class="ident" id="1551762">unsafe</span><span class="op" id="1551768">.</span><span class="ident" id="1551769">Pointer</span><span class="op" id="1551776">)</span>&nbsp;<span class="op" id="1551778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551781">mapdelete</span><span class="op" id="1551790">(</span><span class="ident" id="1551791">t</span><span class="op" id="1551792">,</span>&nbsp;<span class="ident" id="1551794">h</span><span class="op" id="1551795">,</span>&nbsp;<span class="ident" id="1551797">key</span><span class="op" id="1551800">)</span><br>
<span class="lineno"></span><span class="op" id="1551802">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1551805">func</span>&nbsp;<span class="ident" id="1551810">reflect_mapiterinit</span><span class="op" id="1551829">(</span><span class="ident" id="1551830">t</span>&nbsp;<span class="op" id="1551832">*</span><span class="ident" id="1551833">maptype</span><span class="op" id="1551840">,</span>&nbsp;<span class="ident" id="1551842">h</span>&nbsp;<span class="op" id="1551844">*</span><span class="ident" id="1551845">hmap</span><span class="op" id="1551849">)</span>&nbsp;<span class="op" id="1551851">*</span><span class="ident" id="1551852">hiter</span>&nbsp;<span class="op" id="1551858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551861">it</span>&nbsp;<span class="op" id="1551864">:=</span>&nbsp;<span class="builtinfunc" id="1551867">new</span><span class="op" id="1551870">(</span><span class="ident" id="1551871">hiter</span><span class="op" id="1551876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551879">mapiterinit</span><span class="op" id="1551890">(</span><span class="ident" id="1551891">t</span><span class="op" id="1551892">,</span>&nbsp;<span class="ident" id="1551894">h</span><span class="op" id="1551895">,</span>&nbsp;<span class="ident" id="1551897">it</span><span class="op" id="1551899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551902">return</span>&nbsp;<span class="ident" id="1551909">it</span><br>
<span class="lineno">930</span><span class="op" id="1551912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1551915">func</span>&nbsp;<span class="ident" id="1551920">reflect_mapiternext</span><span class="op" id="1551939">(</span><span class="ident" id="1551940">it</span>&nbsp;<span class="op" id="1551943">*</span><span class="ident" id="1551944">hiter</span><span class="op" id="1551949">)</span>&nbsp;<span class="op" id="1551951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551954">mapiternext</span><span class="op" id="1551965">(</span><span class="ident" id="1551966">it</span><span class="op" id="1551968">)</span><br>
<span class="lineno"></span><span class="op" id="1551970">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1551973">func</span>&nbsp;<span class="ident" id="1551978">reflect_mapiterkey</span><span class="op" id="1551996">(</span><span class="ident" id="1551997">it</span>&nbsp;<span class="op" id="1552000">*</span><span class="ident" id="1552001">hiter</span><span class="op" id="1552006">)</span>&nbsp;<span class="ident" id="1552008">unsafe</span><span class="op" id="1552014">.</span><span class="ident" id="1552015">Pointer</span>&nbsp;<span class="op" id="1552023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552026">return</span>&nbsp;<span class="ident" id="1552033">it</span><span class="op" id="1552035">.</span><span class="ident" id="1552036">key</span><br>
<span class="lineno"></span><span class="op" id="1552040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1552043">func</span>&nbsp;<span class="ident" id="1552048">reflect_maplen</span><span class="op" id="1552062">(</span><span class="ident" id="1552063">h</span>&nbsp;<span class="op" id="1552065">*</span><span class="ident" id="1552066">hmap</span><span class="op" id="1552070">)</span>&nbsp;<span class="builtintype" id="1552072">int</span>&nbsp;<span class="op" id="1552076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552079">if</span>&nbsp;<span class="ident" id="1552082">h</span>&nbsp;<span class="op" id="1552084">==</span>&nbsp;<span class="ident" id="1552087">nil</span>&nbsp;<span class="op" id="1552091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552095">return</span>&nbsp;<span class="num" id="1552102">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552108">if</span>&nbsp;<span class="ident" id="1552111">raceenabled</span>&nbsp;<span class="op" id="1552123">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552127">callerpc</span>&nbsp;<span class="op" id="1552136">:=</span>&nbsp;<span class="ident" id="1552139">getcallerpc</span><span class="op" id="1552150">(</span><span class="ident" id="1552151">unsafe</span><span class="op" id="1552157">.</span><span class="ident" id="1552158">Pointer</span><span class="op" id="1552165">(</span><span class="op" id="1552166">&amp;</span><span class="ident" id="1552167">h</span><span class="op" id="1552168">)</span><span class="op" id="1552169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552173">racereadpc</span><span class="op" id="1552183">(</span><span class="ident" id="1552184">unsafe</span><span class="op" id="1552190">.</span><span class="ident" id="1552191">Pointer</span><span class="op" id="1552198">(</span><span class="ident" id="1552199">h</span><span class="op" id="1552200">)</span><span class="op" id="1552201">,</span>&nbsp;<span class="ident" id="1552203">callerpc</span><span class="op" id="1552211">,</span>&nbsp;<span class="ident" id="1552213">funcPC</span><span class="op" id="1552219">(</span><span class="ident" id="1552220">reflect_maplen</span><span class="op" id="1552234">)</span><span class="op" id="1552235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552241">return</span>&nbsp;<span class="ident" id="1552248">h</span><span class="op" id="1552249">.</span><span class="ident" id="1552250">count</span><br>
<span class="lineno"></span><span class="op" id="1552256">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1552259">func</span>&nbsp;<span class="ident" id="1552264">reflect_ismapkey</span><span class="op" id="1552280">(</span><span class="ident" id="1552281">t</span>&nbsp;<span class="op" id="1552283">*</span><span class="ident" id="1552284">_type</span><span class="op" id="1552289">)</span>&nbsp;<span class="builtintype" id="1552291">bool</span>&nbsp;<span class="op" id="1552296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552299">return</span>&nbsp;<span class="ident" id="1552306">ismapkey</span><span class="op" id="1552314">(</span><span class="ident" id="1552315">t</span><span class="op" id="1552316">)</span><br>
<span class="lineno"></span><span class="op" id="1552318">}</span>
</div>
</body>
</html>
